<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScenarioLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.server</a> &gt; <span class="el_source">ScenarioLoader.java</span></div><h1>ScenarioLoader.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
 * ScenarioLoader - Copyright (C) 2002 Josh Yockey
 * Copyright Â© 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */
package megamek.server;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.IllegalFormatException;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Queue;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import megamek.MegaMek;
import megamek.client.generator.RandomGenderGenerator;
import megamek.common.AmmoType;
import megamek.common.BattleArmor;
import megamek.common.Board;
import megamek.common.Compute;
import megamek.common.Configuration;
import megamek.common.Coords;
import megamek.common.Crew;
import megamek.common.CriticalSlot;
import megamek.common.Entity;
import megamek.common.EquipmentType;
import megamek.common.Game;
import megamek.common.HitData;
import megamek.common.IAero;
import megamek.common.IArmorState;
import megamek.common.IBoard;
import megamek.common.IGame;
import megamek.common.IPlayer;
import megamek.common.IStartingPositions;
import megamek.common.MapSettings;
import megamek.common.Mech;
import megamek.common.MechFileParser;
import megamek.common.MechSummary;
import megamek.common.MechSummaryCache;
import megamek.common.Mounted;
import megamek.common.Player;
import megamek.common.Protomech;
import megamek.common.SimpleTechLevel;
import megamek.common.Tank;
import megamek.common.TechConstants;
import megamek.common.ToHitData;
import megamek.common.WeaponType;
import megamek.common.annotations.Nullable;
import megamek.common.enums.Gender;
import megamek.common.icons.Camouflage;
import megamek.common.loaders.EntityLoadingException;
import megamek.common.options.IOption;
import megamek.common.options.OptionsConstants;
import megamek.common.util.BoardUtilities;
import megamek.common.util.fileUtils.MegaMekFile;

public class ScenarioLoader {
    private static final String COMMENT_MARK = &quot;#&quot;;
    
    private static final String SEPARATOR_PROPERTY = &quot;=&quot;;
    private static final String SEPARATOR_COMMA = &quot;,&quot;;
    private static final String SEPARATOR_SPACE = &quot; &quot;;
    private static final String SEPARATOR_COLON = &quot;:&quot;;
    private static final String SEPARATOR_UNDERSCORE = &quot;_&quot;;

    private static final String FILE_SUFFIX_BOARD = &quot;.board&quot;;

    private static final String PARAM_MMSVERSION = &quot;MMSVersion&quot;;
    private static final String PARAM_GAME_OPTIONS_FILE = &quot;GameOptionsFile&quot;;
    private static final String PARAM_GAME_EXTERNAL_ID = &quot;ExternalId&quot;;
    private static final String PARAM_FACTIONS = &quot;Factions&quot;;

    private static final String PARAM_MAP_WIDTH = &quot;MapWidth&quot;;
    private static final String PARAM_MAP_HEIGHT = &quot;MapHeight&quot;;
    private static final String PARAM_BOARD_WIDTH = &quot;BoardWidth&quot;;
    private static final String PARAM_BOARD_HEIGHT = &quot;BoardHeight&quot;;
    private static final String PARAM_BRIDGE_CF = &quot;BridgeCF&quot;;
    private static final String PARAM_MAPS = &quot;Maps&quot;;
    private static final String PARAM_MAP_DIRECTORIES = &quot;RandomDirs&quot;;

    private static final String PARAM_TEAM = &quot;Team&quot;;
    private static final String PARAM_LOCATION = &quot;Location&quot;;
    private static final String PARAM_MINEFIELDS = &quot;Minefields&quot;;
    private static final String PARAM_DAMAGE = &quot;Damage&quot;;
    private static final String PARAM_SPECIFIC_DAMAGE = &quot;DamageSpecific&quot;;
    private static final String PARAM_CRITICAL_HIT = &quot;CritHit&quot;;
    private static final String PARAM_AMMO_AMOUNT = &quot;SetAmmoTo&quot;;
    private static final String PARAM_AMMO_TYPE = &quot;SetAmmoType&quot;;
    private static final String PARAM_PILOT_HITS = &quot;PilotHits&quot;;
    private static final String PARAM_EXTERNAL_ID = &quot;ExternalID&quot;;
    private static final String PARAM_ADVANTAGES = &quot;Advantages&quot;;
    private static final String PARAM_AUTO_EJECT = &quot;AutoEject&quot;;
    private static final String PARAM_COMMANDER = &quot;Commander&quot;;
    private static final String PARAM_DEPLOYMENT_ROUND = &quot;DeploymentRound&quot;;
    private static final String PARAM_CAMO = &quot;Camo&quot;;
    private static final String PARAM_ALTITUDE = &quot;Altitude&quot;;

    private static final String MAP_RANDOM = &quot;RANDOM&quot;;

    private final File scenarioFile;
    // copied from ChatLounge.java
<span class="nc" id="L124">    private final List&lt;DamagePlan&gt; damagePlans = new ArrayList&lt;&gt;();</span>
    // Used to store Crit Hits
<span class="nc" id="L126">    private final List&lt;CritHitPlan&gt; critHitPlans = new ArrayList&lt;&gt;();</span>
    // Used to set ammo Spec Ammounts
<span class="nc" id="L128">    private final List&lt;SetAmmoPlan&gt; ammoPlans = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L130">    public ScenarioLoader(File f) {</span>
<span class="nc" id="L131">        scenarioFile = f;</span>
<span class="nc" id="L132">    }</span>
    
    // TODO: legal/valid ammo type handling and game options, since they are set at this point
    private AmmoType getValidAmmoType(IGame game, Mounted mounted, String ammoString) {
<span class="nc" id="L136">        final Entity e = mounted.getEntity();</span>
<span class="nc" id="L137">        final int year = game.getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</span>
<span class="nc" id="L138">        final EquipmentType currentAmmoType = mounted.getType();</span>
<span class="nc" id="L139">        final Mounted currentWeapon = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        final EquipmentType currentWeaponType = (null != currentWeapon) ? currentWeapon.getType() : null;</span>
<span class="nc" id="L141">        final EquipmentType newAmmoType = EquipmentType.get(ammoString);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (newAmmoType == null) {</span>
<span class="nc" id="L143">            MegaMek.getLogger().error(String.format(&quot;Ammo type '%s' not found&quot;, ammoString));</span>
<span class="nc" id="L144">            return null;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        } else if (!(newAmmoType instanceof AmmoType)) {</span>
<span class="nc" id="L146">            MegaMek.getLogger().error(String.format(&quot;Equipment %s is not an ammo type&quot;, newAmmoType.getName()));</span>
<span class="nc" id="L147">            return null;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        } else if (!newAmmoType.isLegal(year, SimpleTechLevel.getGameTechLevel(game), e.isClan(), e.isMixedTech())) {</span>
<span class="nc" id="L149">            MegaMek.getLogger().warning(String.format(&quot;Ammo %s (TL %d) is not legal for year %d (TL %d)&quot;,</span>
<span class="nc" id="L150">                    newAmmoType.getName(), newAmmoType.getTechLevel(year), year,</span>
<span class="nc" id="L151">                    TechConstants.getGameTechLevel(game, e.isClan())));</span>
<span class="nc" id="L152">            return null;</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">        } else if (e.isClan() &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ALLOWED_CLAN_IGNORE_EQ_LIMITS)) {</span>
            // Check for clan weapon restrictions
<span class="nc" id="L155">            final long muniType = ((AmmoType) newAmmoType).getMunitionType() &amp; ~AmmoType.M_INCENDIARY_LRM;</span>
<span class="nc bnc" id="L156" title="All 24 branches missed.">            if ((muniType == AmmoType.M_SEMIGUIDED) || (muniType == AmmoType.M_SWARM_I)</span>
                || (muniType == AmmoType.M_THUNDER_AUGMENTED) || (muniType == AmmoType.M_THUNDER_INFERNO)
                || (muniType == AmmoType.M_THUNDER_VIBRABOMB) || (muniType == AmmoType.M_THUNDER_ACTIVE)
                || (muniType == AmmoType.M_INFERNO_IV) || (muniType == AmmoType.M_VIBRABOMB_IV)
                || (muniType == AmmoType.M_LISTEN_KILL) || (muniType == AmmoType.M_ANTI_TSM)
                || (muniType == AmmoType.M_DEAD_FIRE) || (muniType == AmmoType.M_MINE_CLEARANCE)) {
<span class="nc" id="L162">                MegaMek.getLogger().warning(String.format(&quot;Ammo type %s not allowed by Clan rules&quot;, newAmmoType.getName()));</span>
<span class="nc" id="L163">                return null;</span>
            }
        }

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (AmmoType.canDeliverMinefield((AmmoType) newAmmoType)</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_MINEFIELDS)) {</span>
<span class="nc" id="L169">            MegaMek.getLogger().warning(String.format(&quot;Minefield-creating ammo type %s forbidden by game rules&quot;,</span>
<span class="nc" id="L170">                    newAmmoType.getName()));</span>
<span class="nc" id="L171">            return null;</span>
        }

<span class="nc bnc" id="L174" title="All 2 branches missed.">        int weaponAmmoType = (currentWeaponType instanceof WeaponType) ? ((WeaponType) currentWeaponType).getAmmoType() : 0;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if ((((AmmoType) newAmmoType).getRackSize() == ((AmmoType) currentAmmoType).getRackSize())</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">                &amp;&amp; (newAmmoType.hasFlag(AmmoType.F_BATTLEARMOR) == currentAmmoType.hasFlag(AmmoType.F_BATTLEARMOR))</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                &amp;&amp; (newAmmoType.hasFlag(AmmoType.F_ENCUMBERING) == currentAmmoType.hasFlag(AmmoType.F_ENCUMBERING))</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                &amp;&amp; (newAmmoType.getTonnage(e) == currentAmmoType.getTonnage(e))</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) newAmmoType).getAmmoType() == weaponAmmoType)) {</span>
<span class="nc" id="L180">            return (AmmoType) newAmmoType;</span>
        } else {
<span class="nc" id="L182">            return null;</span>
        }
    }

    /**
     * The damage procedures are built into a server object, so we delay dealing
     * the random damage until a server is made available to us.
     */
    public void applyDamage(Server s) {
<span class="nc bnc" id="L191" title="All 2 branches missed.">        for (DamagePlan damagePlan : damagePlans) {</span>
<span class="nc" id="L192">            MegaMek.getLogger().debug(String.format(&quot;Applying damage to %s&quot;, damagePlan.entity.getShortName()));</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            for (int y = 0; y &lt; damagePlan.nBlocks; ++ y) {</span>
<span class="nc" id="L194">                HitData hit = damagePlan.entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L195">                MegaMek.getLogger().debug(&quot;[s.damageEntity(dp.entity, hit, 5)]&quot;);</span>
<span class="nc" id="L196">                s.damageEntity(damagePlan.entity, hit, 5);</span>
            }

            // Apply Spec Damage
<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (SpecDam specDamage : damagePlan.specificDammage) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                if (damagePlan.entity.locations() &lt;= specDamage.loc) {</span>
                    // location is valid
<span class="nc" id="L203">                    MegaMek.getLogger().error(String.format(&quot;\tInvalid location specified %d&quot;, specDamage.loc));</span>
                } else {
                    // Infantry only take damage to &quot;internal&quot;
<span class="nc bnc" id="L206" title="All 4 branches missed.">                    if (specDamage.internal || damagePlan.entity.isConventionalInfantry()) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        if (damagePlan.entity.getOInternal(specDamage.loc) &gt; specDamage.setArmorTo) {</span>
<span class="nc" id="L208">                            damagePlan.entity.setInternal(specDamage.setArmorTo, specDamage.loc);</span>
<span class="nc" id="L209">                            MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (internal %s) to %d&quot;,</span>
<span class="nc" id="L210">                                    damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                            if (specDamage.setArmorTo == 0) {</span>
<span class="nc" id="L212">                                MegaMek.getLogger().debug(String.format(&quot;\tSection destoyed %s&quot;,</span>
<span class="nc" id="L213">                                        damagePlan.entity.getLocationName(specDamage.loc)));</span>
<span class="nc" id="L214">                                damagePlan.entity.destroyLocation(specDamage.loc);</span>
                            }
                        }
                    } else {
<span class="nc bnc" id="L218" title="All 4 branches missed.">                        if (specDamage.rear &amp;&amp; damagePlan.entity.hasRearArmor(specDamage.loc)) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                            if (damagePlan.entity.getOArmor(specDamage.loc, true) &gt; specDamage.setArmorTo) {</span>
<span class="nc" id="L220">                                MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (rear %s) to %d&quot;,</span>
<span class="nc" id="L221">                                        damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</span>
<span class="nc" id="L222">                                damagePlan.entity.setArmor(specDamage.setArmorTo, specDamage.loc, true);</span>
                            }
                        } else {
<span class="nc bnc" id="L225" title="All 2 branches missed.">                            if (damagePlan.entity.getOArmor(specDamage.loc, false) &gt; specDamage.setArmorTo) {</span>
<span class="nc" id="L226">                                MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (%s) to %d&quot;,</span>
<span class="nc" id="L227">                                        damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</span>

                                // Battle Armor Handled Differently
                                // If armor set to Zero kill the Armor sport
                                // which represents one member of the squad
<span class="nc bnc" id="L232" title="All 2 branches missed.">                                if (damagePlan.entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                                    if (specDamage.setArmorTo == 0) {</span>
<span class="nc" id="L234">                                        damagePlan.entity.setArmor(IArmorState.ARMOR_DOOMED, specDamage.loc, false);</span>
<span class="nc" id="L235">                                        damagePlan.entity.setInternal(IArmorState.ARMOR_DOOMED, specDamage.loc);</span>
                                    } else {
                                        // For some reason setting armor to 1 will result in 2 armor points
                                        // left on the GUI. Dont know why but adjust here!
<span class="nc" id="L239">                                        damagePlan.entity.setArmor(specDamage.setArmorTo - 1, specDamage.loc);</span>
                                    }
                                } else {
<span class="nc" id="L242">                                    damagePlan.entity.setArmor(specDamage.setArmorTo, specDamage.loc);</span>
                                }
                            }
                        }
                    }
                }
<span class="nc" id="L248">            }</span>
<span class="nc" id="L249">        }</span>

        // Loop throught Crit Hits
<span class="nc bnc" id="L252" title="All 2 branches missed.">        for (CritHitPlan chp : critHitPlans) {</span>
<span class="nc" id="L253">            MegaMek.getLogger().debug(&quot;Applying critical hits to &quot; + chp.entity.getShortName());</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            for (CritHit critHit : chp.critHits) {</span>
                // Apply a critical hit to the indicated slot.
<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (chp.entity.locations() &lt;= critHit.loc) {</span>
<span class="nc" id="L257">                    MegaMek.getLogger().error(&quot;Invalid location specified &quot; + critHit.loc);</span>
                } else {
                    // Make sure that we have crit spot to hit
<span class="nc bnc" id="L260" title="All 4 branches missed.">                    if ((chp.entity instanceof Mech) || (chp.entity instanceof Protomech)) {</span>
                        // Is this a torso weapon slot?
<span class="nc" id="L262">                        CriticalSlot cs = null;</span>
<span class="nc bnc" id="L263" title="All 8 branches missed.">                        if ((chp.entity instanceof Protomech)</span>
                                &amp;&amp; (Protomech.LOC_TORSO == critHit.loc)
                                &amp;&amp; ((Protomech.SYSTEM_TORSO_WEAPON_A == critHit.slot) || (Protomech.SYSTEM_TORSO_WEAPON_B == critHit.slot))) {
<span class="nc" id="L266">                            cs = new CriticalSlot(CriticalSlot.TYPE_SYSTEM, critHit.slot);</span>
                        }
                        // Is this a valid slot number?
<span class="nc bnc" id="L269" title="All 2 branches missed.">                        else if ((critHit.slot &lt; 0)</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                                || (critHit.slot &gt; chp.entity.getNumberOfCriticals(critHit.loc))) {</span>
<span class="nc" id="L271">                            MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L272">                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</span>
                        }
                        // Get the slot from the entity.
                        else {
<span class="nc" id="L276">                            cs = chp.entity.getCritical(critHit.loc, critHit.slot);</span>
                        }

                        // Ignore invalid, unhittable, and damaged slots.
<span class="nc bnc" id="L280" title="All 4 branches missed.">                        if ((null == cs) || !cs.isHittable()) {</span>
<span class="nc" id="L281">                            MegaMek.getLogger().error(String.format(&quot;%s - slot not hittable %d: %d&quot;,</span>
<span class="nc" id="L282">                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</span>
                        } else {
<span class="nc" id="L284">                            MegaMek.getLogger().debug(&quot;[s.applyCriticalHit(chp.entity, ch.loc, cs, false)]&quot;);</span>
<span class="nc" id="L285">                            s.applyCriticalHit(chp.entity, critHit.loc, cs, false, 0, false);</span>
                        }
<span class="nc" id="L287">                    }</span>
                    // Handle Tanks differently.
<span class="nc bnc" id="L289" title="All 2 branches missed.">                    else if (chp.entity instanceof Tank) {</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">                        if ((critHit.slot &lt; 0) || (critHit.slot &gt;= 6)) {</span>
<span class="nc" id="L291">                            MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L292">                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</span>
                        } else {
<span class="nc" id="L294">                            CriticalSlot cs = new CriticalSlot(CriticalSlot.TYPE_SYSTEM, critHit.slot + 1);</span>
<span class="nc" id="L295">                            MegaMek.getLogger().debug(&quot;[s.applyCriticalHit(chp.entity, ch.loc, cs, false)]&quot;);</span>
<span class="nc" id="L296">                            s.applyCriticalHit(chp.entity, Entity.NONE, cs, false, 0, false);</span>
                        }
                    }
                }
<span class="nc" id="L300">            }</span>
<span class="nc" id="L301">        }</span>

        // Loop throught Set Ammo To
<span class="nc bnc" id="L304" title="All 2 branches missed.">        for (SetAmmoPlan sap : ammoPlans) {</span>
<span class="nc" id="L305">            MegaMek.getLogger().debug(&quot;Applying ammo adjustment to &quot; + sap.entity.getShortName());</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            for (SetAmmoType sa : sap.ammoSetType) {</span>
                // Limit to 'Mechs for now (needs to be extended later)
<span class="nc bnc" id="L308" title="All 2 branches missed.">                if (sap.entity instanceof Mech) {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                    if (sa.slot &lt; sap.entity.getNumberOfCriticals(sa.loc)) {</span>
<span class="nc" id="L310">                        CriticalSlot cs = sap.entity.getCritical(sa.loc, sa.slot);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                        if (cs != null) {</span>
<span class="nc" id="L312">                            Mounted ammo = sap.entity.getCritical(sa.loc, sa.slot).getMount();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                            if (ammo == null) {</span>
<span class="nc" id="L314">                                MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L315">                                        sap.entity.getShortName(), sa.loc, sa.slot + 1));</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                            } else if (ammo.getType() instanceof AmmoType) {</span>
<span class="nc" id="L317">                                AmmoType newAmmoType = getValidAmmoType(s.getGame(), ammo, sa.type);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                                if (newAmmoType != null) {</span>
<span class="nc" id="L319">                                    ammo.changeAmmoType(newAmmoType);</span>
                                } else {
<span class="nc" id="L321">                                    MegaMek.getLogger().warning(String.format(&quot;Illegal ammo type '%s' for unit %s, slot %s&quot;,</span>
<span class="nc" id="L322">                                            sa.type, sap.entity.getDisplayName(), ammo.getName()));</span>
                                }
                            }
                        }
                    }
                }
<span class="nc" id="L328">            }</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">            for (SetAmmoTo sa : sap.ammoSetTo) {</span>
                // Only can be done against Mechs
<span class="nc bnc" id="L332" title="All 2 branches missed.">                if (sap.entity instanceof Mech) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                    if (sa.slot &lt; sap.entity.getNumberOfCriticals(sa.loc)) {</span>
                        // Get the piece of equipment and check to make sure it
                        // is a ammo item then set its amount!
<span class="nc" id="L336">                        CriticalSlot cs = sap.entity.getCritical(sa.loc, sa.slot);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                        if (cs != null) {</span>
<span class="nc" id="L338">                            Mounted ammo = sap.entity.getCritical(sa.loc, sa.slot).getMount();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                            if (ammo == null) {</span>
<span class="nc" id="L340">                                MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L341">                                        sap.entity.getShortName(), sa.loc, sa.slot + 1));</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                            } else if (ammo.getType() instanceof AmmoType) {</span>
                                // Also make sure we dont exceed the max allowed
<span class="nc" id="L344">                                ammo.setShotsLeft(Math.min(sa.setAmmoTo, ammo.getBaseShotsLeft()));</span>
                            }
                        }
                    }
                }
<span class="nc" id="L349">            }</span>
<span class="nc" id="L350">        }</span>
<span class="nc" id="L351">    }</span>

    public IGame createGame() throws Exception {
<span class="nc" id="L354">        MegaMek.getLogger().info(&quot;Loading scenario from &quot; + scenarioFile);</span>
<span class="nc" id="L355">        StringMultiMap p = load();</span>

<span class="nc" id="L357">        String sCheck = p.getString(PARAM_MMSVERSION);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (sCheck == null) {</span>
<span class="nc" id="L359">            throw new ScenarioLoaderException(&quot;missingMMSVersion&quot;);</span>
        }

<span class="nc" id="L362">        Game g = new Game();</span>

        // build the board
<span class="nc" id="L365">        g.board = createBoard(p);</span>

        // build the faction players
<span class="nc" id="L368">        Collection&lt;Player&gt; players = createPlayers(p);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L370">            g.addPlayer(player.getId(), player);</span>
<span class="nc" id="L371">        }</span>

        // build the entities
<span class="nc" id="L374">        int entityId = 0;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L376">            Collection&lt;Entity&gt; entities = buildFactionEntities(p, player);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            for (Entity entity : entities) {</span>
<span class="nc" id="L378">                entity.setOwner(player);</span>
<span class="nc" id="L379">                entity.setId(entityId);</span>
<span class="nc" id="L380">                ++ entityId;</span>
<span class="nc" id="L381">                g.addEntity(entity);</span>
<span class="nc" id="L382">            }</span>
<span class="nc" id="L383">        }</span>
        // game's ready
<span class="nc" id="L385">        g.getOptions().initialize();</span>
<span class="nc" id="L386">        String optionFile = p.getString(PARAM_GAME_OPTIONS_FILE);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (optionFile == null) {</span>
<span class="nc" id="L388">            g.getOptions().loadOptions();</span>
        } else {
<span class="nc" id="L390">            g.getOptions().loadOptions(new MegaMekFile(scenarioFile.getParentFile(), optionFile).getFile(), true);</span>
        }

        // set wind
<span class="nc" id="L394">        g.getPlanetaryConditions().determineWind();</span>

        // Set up the teams (for initiative)
<span class="nc" id="L397">        g.setupTeams();</span>

<span class="nc" id="L399">        g.setPhase(IGame.Phase.PHASE_STARTING_SCENARIO);</span>

<span class="nc" id="L401">        g.setupRoundDeployment();</span>

        // Read the external game id from the scenario file
<span class="nc" id="L404">        g.setExternalGameId(parseExternalGameId(p));</span>

<span class="nc" id="L406">        g.setVictoryContext(new HashMap&lt;&gt;());</span>
<span class="nc" id="L407">        g.createVictoryConditions();</span>

<span class="nc" id="L409">        return g;</span>
    }

    private Collection&lt;Entity&gt; buildFactionEntities(StringMultiMap p, IPlayer player) throws ScenarioLoaderException {
<span class="nc" id="L413">        String faction = player.getName();</span>
<span class="nc" id="L414">        Pattern unitPattern = Pattern.compile(String.format(&quot;^Unit_\\Q%s\\E_[^_]+$&quot;, faction));</span>
<span class="nc" id="L415">        Pattern unitDataPattern = Pattern.compile(String.format(&quot;^(Unit_\\Q%s\\E_[^_]+)_([A-Z][^_]+)$&quot;, faction));</span>

<span class="nc" id="L417">        Map&lt;String, Entity&gt; entities = new HashMap&lt;&gt;();</span>
        
        // Gather all defined units
<span class="nc bnc" id="L420" title="All 2 branches missed.">        for (String key : p.keySet()) {</span>
<span class="nc bnc" id="L421" title="All 4 branches missed.">            if (unitPattern.matcher(key).matches() &amp;&amp; (p.getNumValues(key) &gt; 0)) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                if (p.getNumValues(key) &gt; 1) {</span>
<span class="nc" id="L423">                    MegaMek.getLogger().error(String.format(&quot;Scenario loading: Unit declaration %s found %d times&quot;,</span>
<span class="nc" id="L424">                            key, p.getNumValues(key)));</span>
<span class="nc" id="L425">                    throw new ScenarioLoaderException(&quot;multipleUnitDeclarations&quot;, key);</span>
                }
<span class="nc" id="L427">                entities.put(key, parseEntityLine(p.getString(key)));</span>
            }
<span class="nc" id="L429">        }</span>
        
        // Add other information
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (String key: p.keySet()) {</span>
<span class="nc" id="L433">            Matcher dataMatcher = unitDataPattern.matcher(key);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (dataMatcher.matches()) {</span>
<span class="nc" id="L435">                String unitKey = dataMatcher.group(1);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                if (!entities.containsKey(unitKey)) {</span>
<span class="nc" id="L437">                    MegaMek.getLogger().warning(&quot;Scenario loading: Data for undeclared unit encountered, ignoring: &quot; + key);</span>
<span class="nc" id="L438">                    continue;</span>
                }
<span class="nc" id="L440">                Entity e = entities.get(unitKey);</span>
<span class="nc bnc" id="L441" title="All 14 branches missed.">                switch (dataMatcher.group(2)) {</span>
                    case PARAM_DAMAGE:
<span class="nc bnc" id="L443" title="All 2 branches missed.">                        for (String val : p.get(key)) {</span>
<span class="nc" id="L444">                            damagePlans.add(new DamagePlan(e, Integer.parseInt(val)));</span>
<span class="nc" id="L445">                        }</span>
<span class="nc" id="L446">                        break;</span>
                    case PARAM_SPECIFIC_DAMAGE:
<span class="nc" id="L448">                        DamagePlan dp = new DamagePlan(e);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L450">                            dp.addSpecificDamage(val);</span>
                        }
<span class="nc" id="L452">                        damagePlans.add(dp);</span>
<span class="nc" id="L453">                        break;</span>
                    case PARAM_CRITICAL_HIT:
<span class="nc" id="L455">                        CritHitPlan chp = new CritHitPlan(e);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L457">                            chp.addCritHit(val);</span>
                        }
<span class="nc" id="L459">                        critHitPlans.add(chp);</span>
<span class="nc" id="L460">                        break;</span>
                    case PARAM_AMMO_AMOUNT:
<span class="nc" id="L462">                        SetAmmoPlan amountSap = new SetAmmoPlan(e);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L464">                            amountSap.addSetAmmoTo(val);</span>
                        }
<span class="nc" id="L466">                        ammoPlans.add(amountSap);</span>
<span class="nc" id="L467">                        break;</span>
                    case PARAM_AMMO_TYPE:
<span class="nc" id="L469">                        SetAmmoPlan typeSap = new SetAmmoPlan(e);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L471">                            typeSap.addSetAmmoType(val);</span>
                        }
<span class="nc" id="L473">                        ammoPlans.add(typeSap);</span>
<span class="nc" id="L474">                        break;</span>
                    case PARAM_PILOT_HITS:
<span class="nc" id="L476">                        int hits = Integer.parseInt(p.getString(key));</span>
<span class="nc" id="L477">                        e.getCrew().setHits(Math.min(hits, 5), 0);</span>
<span class="nc" id="L478">                        break;</span>
                    case PARAM_EXTERNAL_ID:
<span class="nc" id="L480">                        e.setExternalIdAsString(p.getString(key));</span>
<span class="nc" id="L481">                        break;</span>
                    case PARAM_ADVANTAGES:
<span class="nc" id="L483">                        parseAdvantages(e, p.getString(key, SEPARATOR_SPACE));</span>
<span class="nc" id="L484">                        break;</span>
                    case PARAM_AUTO_EJECT:
<span class="nc" id="L486">                        parseAutoEject(e, p.getString(key));</span>
<span class="nc" id="L487">                        break;</span>
                    case PARAM_COMMANDER:
<span class="nc" id="L489">                        parseCommander(e, p.getString(key));</span>
<span class="nc" id="L490">                        break;</span>
                    case PARAM_DEPLOYMENT_ROUND:
<span class="nc" id="L492">                        int round = Integer.parseInt(p.getString(key));</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                        if (round &gt; 0) {</span>
<span class="nc" id="L494">                            MegaMek.getLogger().debug(String.format(&quot;%s will be deployed before round %d&quot;,</span>
<span class="nc" id="L495">                                e.getDisplayName(), round));</span>
<span class="nc" id="L496">                            e.setDeployRound(round);</span>
<span class="nc" id="L497">                            e.setDeployed(false);</span>
<span class="nc" id="L498">                            e.setNeverDeployed(false);</span>
<span class="nc" id="L499">                            e.setPosition(null);</span>
                        }
                        break;
                    case PARAM_CAMO:
<span class="nc" id="L503">                        final Camouflage camouflage = parseCamouflage(p.getString(key));</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                        if (!camouflage.isDefault()) {</span>
<span class="nc" id="L505">                            e.setCamouflage(camouflage);</span>
                        }
                        break;
                    case PARAM_ALTITUDE:
<span class="nc" id="L509">                        int altitude = Math.min(Integer.parseInt(p.getString(key)), 10);</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                        if (e.isAero()) {</span>
<span class="nc" id="L511">                            e.setAltitude(altitude);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                            if (altitude &lt;= 0) {</span>
<span class="nc" id="L513">                                ((IAero) e).land();</span>
                            }
                        } else {
<span class="nc" id="L516">                            MegaMek.getLogger().warning(String.format(&quot;Altitude setting for a non-aerospace unit %s; ignoring&quot;,</span>
<span class="nc" id="L517">                                    e.getShortName()));</span>
                        }
<span class="nc" id="L519">                        break;</span>
                    default:
<span class="nc" id="L521">                        MegaMek.getLogger().error(&quot;Scenario loading: Unknown unit data key &quot; + key);</span>
                }
            }
<span class="nc" id="L524">        }</span>
        
<span class="nc" id="L526">        return entities.values();</span>
    }

    private Entity parseEntityLine(String s) throws ScenarioLoaderException {
        try {
<span class="nc" id="L531">            String[] parts = s.split(SEPARATOR_COMMA, -1);</span>
            int i;
<span class="nc" id="L533">            MechSummary ms = MechSummaryCache.getInstance().getMech(parts[0]);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (ms == null) {</span>
<span class="nc" id="L535">                throw new ScenarioLoaderException(&quot;missingRequiredEntity&quot;, parts[0]);</span>
            }
<span class="nc" id="L537">            MegaMek.getLogger().debug(String.format(&quot;Loading %s&quot;, ms.getName()));</span>
<span class="nc" id="L538">            Entity e = new MechFileParser(ms.getSourceFile(), ms.getEntryName()).getEntity();</span>

            // The following section is used to determine if part 4 of the string includes gender or not
            // The regex is used to match a number that might be negative. As the direction is never
            // a number, if a number is found it must be gender.
            // The i value must be included to ensure that the correct indexes are used for the
            // direction calculation below.
<span class="nc bnc" id="L545" title="All 4 branches missed.">            if ((parts.length &gt; 4) &amp;&amp; parts[4].matches(&quot;-?\\d+&quot;)) {</span>
<span class="nc" id="L546">                e.setCrew(new Crew(e.getCrew().getCrewType(), parts[1], 1,</span>
<span class="nc" id="L547">                        Integer.parseInt(parts[2]), Integer.parseInt(parts[3]),</span>
<span class="nc" id="L548">                        Gender.parseFromString(parts[4]), null));</span>
<span class="nc" id="L549">                i = 5; // direction will be part 5, as the scenario has the gender of its pilots included</span>
            } else {
<span class="nc" id="L551">                e.setCrew(new Crew(e.getCrew().getCrewType(), parts[1], 1,</span>
<span class="nc" id="L552">                        Integer.parseInt(parts[2]), Integer.parseInt(parts[3]),</span>
<span class="nc" id="L553">                        RandomGenderGenerator.generate(), null));</span>
<span class="nc" id="L554">                i = 4; // direction will be part 4, as the scenario does not contain gender</span>
            }

            // This uses the i value to ensure it is calculated correctly
<span class="nc bnc" id="L558" title="All 2 branches missed.">            if (parts.length &gt;= 7) {</span>
<span class="nc" id="L559">                String direction = parts[i++].toUpperCase(Locale.ROOT); //grab value at i, then increment</span>
<span class="nc bnc" id="L560" title="All 7 branches missed.">                switch (direction) {</span>
                    case &quot;N&quot;:
<span class="nc" id="L562">                        e.setFacing(0);</span>
<span class="nc" id="L563">                        break;</span>
                    case &quot;NW&quot;:
<span class="nc" id="L565">                        e.setFacing(5);</span>
<span class="nc" id="L566">                        break;</span>
                    case &quot;SW&quot;:
<span class="nc" id="L568">                        e.setFacing(4);</span>
<span class="nc" id="L569">                        break;</span>
                    case &quot;S&quot;:
<span class="nc" id="L571">                        e.setFacing(3);</span>
<span class="nc" id="L572">                        break;</span>
                    case &quot;SE&quot;:
<span class="nc" id="L574">                        e.setFacing(2);</span>
<span class="nc" id="L575">                        break;</span>
                    case &quot;NE&quot;:
<span class="nc" id="L577">                        e.setFacing(1);</span>
<span class="nc" id="L578">                        break;</span>
                    default:
                        break;
                }
<span class="nc" id="L582">                int x = Integer.parseInt(parts[i++]) - 1;</span>
<span class="nc" id="L583">                int y = Integer.parseInt(parts[i]) - 1;</span>
<span class="nc" id="L584">                e.setPosition(new Coords(x, y));</span>
<span class="nc" id="L585">                e.setDeployed(true);</span>
            }
<span class="nc" id="L587">            return e;</span>
<span class="nc" id="L588">        } catch (NumberFormatException | IndexOutOfBoundsException | EntityLoadingException ex) {</span>
<span class="nc" id="L589">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L590">            throw new ScenarioLoaderException(&quot;unparsableEntityLine&quot;, s);</span>
        }
    }

    private void parseAdvantages(Entity entity, String adv) {
<span class="nc" id="L595">        String[] advantages = adv.split(SEPARATOR_SPACE, -1);</span>

<span class="nc bnc" id="L597" title="All 2 branches missed.">        for (String curAdv : advantages) {</span>
<span class="nc" id="L598">            String[] advantageData = curAdv.split(SEPARATOR_COLON, -1);</span>
<span class="nc" id="L599">            IOption option = entity.getCrew().getOptions().getOption(advantageData[0]);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            if (option == null) {</span>
<span class="nc" id="L601">                MegaMek.getLogger().error(String.format(&quot;Ignoring invalid pilot advantage '%s'&quot;, curAdv));</span>
            } else {
<span class="nc" id="L603">                MegaMek.getLogger().debug(String.format(&quot;Adding pilot advantage '%s' to %s&quot;,</span>
<span class="nc" id="L604">                        curAdv, entity.getDisplayName()));</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                if (advantageData.length &gt; 1) {</span>
<span class="nc" id="L606">                    option.setValue(advantageData[1]);</span>
                } else {
<span class="nc" id="L608">                    option.setValue(true);</span>
                }
            }
        }
<span class="nc" id="L612">    }</span>

    private void parseAutoEject(Entity entity, String eject) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L616">            Mech mech = (Mech) entity;</span>
<span class="nc" id="L617">            mech.setAutoEject(Boolean.parseBoolean(eject));</span>
        }
<span class="nc" id="L619">    }</span>

    private void parseCommander(Entity entity, String commander) {
<span class="nc" id="L622">        entity.setCommander(Boolean.parseBoolean(commander));</span>
<span class="nc" id="L623">    }</span>

    private Camouflage parseCamouflage(final @Nullable String camouflage) {
<span class="nc bnc" id="L626" title="All 4 branches missed.">        if ((camouflage == null) || camouflage.isBlank()) {</span>
<span class="nc" id="L627">            return new Camouflage();</span>
        }
<span class="nc" id="L629">        final String[] camouflageParameters = camouflage.split(SEPARATOR_COMMA, -1);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (camouflageParameters.length == 2) {</span>
<span class="nc" id="L631">            return new Camouflage(camouflageParameters[0], camouflageParameters[1]);</span>
        } else {
<span class="nc" id="L633">            MegaMek.getLogger().error(&quot;Attempted to parse illegal camouflage parameter array of size &quot; + camouflageParameters.length + &quot; from &quot; + camouflage);</span>
<span class="nc" id="L634">            return new Camouflage();</span>
        }
    }

    private int findIndex(String[] sa, String s) {
<span class="nc bnc" id="L639" title="All 2 branches missed.">        for (int x = 0; x &lt; sa.length; x++) {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">            if (sa[x].equalsIgnoreCase(s)) {</span>
<span class="nc" id="L641">                return x;</span>
            }
        }
<span class="nc" id="L644">        return -1;</span>
    }

    private String getFactionParam(String faction, String param) {
<span class="nc" id="L648">        return param + SEPARATOR_UNDERSCORE + faction;</span>
    }
    
    private Collection&lt;Player&gt; createPlayers(StringMultiMap p) throws ScenarioLoaderException {
<span class="nc" id="L652">        String sFactions = p.getString(PARAM_FACTIONS);</span>
<span class="nc bnc" id="L653" title="All 4 branches missed.">        if ((sFactions == null) || sFactions.isEmpty()) {</span>
<span class="nc" id="L654">            throw new ScenarioLoaderException(&quot;missingFactions&quot;);</span>
        }
<span class="nc" id="L656">        String[] factions = sFactions.split(SEPARATOR_COMMA, -1);</span>
<span class="nc" id="L657">        List&lt;Player&gt; result = new ArrayList&lt;&gt;(factions.length);</span>

<span class="nc" id="L659">        int playerId = 0;</span>
<span class="nc" id="L660">        int teamId = 0;</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">        for (String faction : factions) {</span>
<span class="nc" id="L662">            Player player = new Player(playerId, faction);</span>
<span class="nc" id="L663">            result.add(player);</span>
<span class="nc" id="L664">            playerId++;</span>

            // scenario players start out as ghosts to be logged into
<span class="nc" id="L667">            player.setGhost(true);</span>
            
<span class="nc" id="L669">            String loc = p.getString(getFactionParam(faction, PARAM_LOCATION));</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">            if (loc == null) {</span>
<span class="nc" id="L671">                loc = &quot;Any&quot;;</span>
            }
<span class="nc" id="L673">            int dir = Math.max(findIndex(IStartingPositions.START_LOCATION_NAMES, loc), 0);</span>
<span class="nc" id="L674">            player.setStartingPos(dir);</span>
            
<span class="nc" id="L676">            final Camouflage camouflage = parseCamouflage(p.getString(getFactionParam(faction, PARAM_CAMO)));</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            if (!camouflage.isDefault()) {</span>
<span class="nc" id="L678">                player.setCamouflage(camouflage);</span>
            }
            
<span class="nc" id="L681">            String team = p.getString(getFactionParam(faction, PARAM_TEAM));</span>
<span class="nc bnc" id="L682" title="All 4 branches missed.">            if ((team != null) &amp;&amp; !team.isEmpty()) {</span>
                try {
<span class="nc" id="L684">                    teamId = Integer.parseInt(team);</span>
<span class="nc" id="L685">                } catch(NumberFormatException ignored) {</span>
<span class="nc" id="L686">                    teamId++;</span>
<span class="nc" id="L687">                }</span>
            } else {
<span class="nc" id="L689">                teamId++;</span>
            }
<span class="nc" id="L691">            player.setTeam(Math.min(teamId, IPlayer.MAX_TEAMS - 1));</span>
            
<span class="nc" id="L693">            String minefields = p.getString(getFactionParam(faction, PARAM_MINEFIELDS));</span>
<span class="nc bnc" id="L694" title="All 4 branches missed.">            if ((minefields != null) &amp;&amp; !minefields.isEmpty()) {</span>
<span class="nc" id="L695">                String[] mines = minefields.split(SEPARATOR_COMMA, -1);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                if (mines.length &gt;= 3) {</span>
                    try {
<span class="nc" id="L698">                        int minesConventional = Integer.parseInt(mines[0]);</span>
<span class="nc" id="L699">                        int minesCommand = Integer.parseInt(mines[1]);</span>
<span class="nc" id="L700">                        int minesVibra = Integer.parseInt(mines[2]);</span>
<span class="nc" id="L701">                        player.setNbrMFConventional(minesConventional);</span>
<span class="nc" id="L702">                        player.setNbrMFCommand(minesCommand);</span>
<span class="nc" id="L703">                        player.setNbrMFVibra(minesVibra);</span>
<span class="nc" id="L704">                    } catch (NumberFormatException nfex) {</span>
<span class="nc" id="L705">                        MegaMek.getLogger().error(String.format(&quot;Format error with minefields string '%s' for %s&quot;,</span>
                                minefields, faction));
<span class="nc" id="L707">                    }</span>
                }
            }
        }
        
<span class="nc" id="L712">        return result;</span>
    }

    /**
     * Load board files and create the megaboard.
     */
    private IBoard createBoard(StringMultiMap p) throws ScenarioLoaderException {
<span class="nc" id="L719">        int mapWidth = 16, mapHeight = 17;</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">        if (p.getString(PARAM_MAP_WIDTH) == null) {</span>
<span class="nc" id="L721">            MegaMek.getLogger().info(&quot;No map width specified; using &quot; + mapWidth);</span>
        } else {
<span class="nc" id="L723">            mapWidth = Integer.parseInt(p.getString(PARAM_MAP_WIDTH));</span>
        }

<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (p.getString(PARAM_MAP_HEIGHT) == null) {</span>
<span class="nc" id="L727">            MegaMek.getLogger().info(&quot;No map height specified; using &quot; + mapHeight);</span>
        } else {
<span class="nc" id="L729">            mapHeight = Integer.parseInt(p.getString(PARAM_MAP_HEIGHT));</span>
        }

<span class="nc" id="L732">        int nWidth = 1, nHeight = 1;</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">        if (p.getString(PARAM_BOARD_WIDTH) == null) {</span>
<span class="nc" id="L734">            MegaMek.getLogger().info(&quot;No board width specified; using &quot; + nWidth);</span>
        } else {
<span class="nc" id="L736">            nWidth = Integer.parseInt(p.getString(PARAM_BOARD_WIDTH));</span>
        }

<span class="nc bnc" id="L739" title="All 2 branches missed.">        if (p.getString(PARAM_BOARD_HEIGHT) == null) {</span>
<span class="nc" id="L740">            MegaMek.getLogger().info(&quot;No board height specified; using &quot; + nHeight);</span>
        } else {
<span class="nc" id="L742">            nHeight = Integer.parseInt(p.getString(PARAM_BOARD_HEIGHT));</span>
        }

<span class="nc" id="L745">        MegaMek.getLogger().debug(String.format(&quot;Mapsheets are %d by %d hexes.&quot;, mapWidth, mapHeight));</span>
<span class="nc" id="L746">        MegaMek.getLogger().debug(String.format(&quot;Constructing %d by %d board.&quot;, nWidth, nHeight));</span>
<span class="nc" id="L747">        int cf = 0;</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">        if (p.getString(PARAM_BRIDGE_CF) == null) {</span>
<span class="nc" id="L749">            MegaMek.getLogger().debug(&quot;No CF for bridges defined. Using map file defaults.&quot;);</span>
        } else {
<span class="nc" id="L751">            cf = Integer.parseInt(p.getString(PARAM_BRIDGE_CF));</span>
<span class="nc" id="L752">            MegaMek.getLogger().debug(&quot;Overriding map-defined bridge CFs with &quot; + cf);</span>
        }
        // load available boards
        // basically copied from Server.java. Should get moved somewhere neutral
<span class="nc" id="L756">        List&lt;String&gt; boards = new ArrayList&lt;&gt;();</span>

        // Find subdirectories given in the scenario file
<span class="nc" id="L759">        List&lt;String&gt; allDirs = new LinkedList&lt;&gt;();</span>
        // &quot;&quot; entry stands for the boards base directory 
<span class="nc" id="L761">        allDirs.add(&quot;&quot;);</span>

<span class="nc bnc" id="L763" title="All 2 branches missed.">        if (p.getString(PARAM_MAP_DIRECTORIES) != null) {</span>
<span class="nc" id="L764">            allDirs = Arrays.asList(p.getString(PARAM_MAP_DIRECTORIES)</span>
<span class="nc" id="L765">                    .split(SEPARATOR_COMMA, -1));</span>
        }

<span class="nc bnc" id="L768" title="All 2 branches missed.">        for (String dir: allDirs) {</span>
<span class="nc" id="L769">            File curDir = new File(Configuration.boardsDir(), dir);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">            if (curDir.exists()) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">                for (String file : curDir.list()) {</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                    if (file.toLowerCase(Locale.ROOT).endsWith(FILE_SUFFIX_BOARD)) {</span>
<span class="nc" id="L773">                        boards.add(dir+&quot;/&quot;+file.substring(0, file.length() - FILE_SUFFIX_BOARD.length()));</span>
                    }
                }
            }
<span class="nc" id="L777">        }</span>

<span class="nc" id="L779">        IBoard[] ba = new IBoard[nWidth * nHeight];</span>
<span class="nc" id="L780">        Queue&lt;String&gt; maps = new LinkedList&lt;&gt;(</span>
<span class="nc" id="L781">            Arrays.asList(p.getString(PARAM_MAPS).split(SEPARATOR_COMMA, -1)));</span>
<span class="nc" id="L782">        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">        for (int x = 0; x &lt; nWidth; x++) {</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">            for (int y = 0; y &lt; nHeight; y++) {</span>
<span class="nc" id="L785">                int n = (y * nWidth) + x;</span>
<span class="nc" id="L786">                String board = MAP_RANDOM;</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                if (!maps.isEmpty()) {</span>
<span class="nc" id="L788">                    board = maps.poll();</span>
                }
<span class="nc" id="L790">                MegaMek.getLogger().debug(String.format(&quot;(%d,%d) %s&quot;, x, y, board));</span>

<span class="nc" id="L792">                boolean isRotated = false;</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                if (board.startsWith(Board.BOARD_REQUEST_ROTATION)) {</span>
<span class="nc" id="L794">                    isRotated = true;</span>
<span class="nc" id="L795">                    board = board.substring(Board.BOARD_REQUEST_ROTATION.length());</span>
                }

                String sBoardFile;
<span class="nc bnc" id="L799" title="All 2 branches missed.">                if (board.equals(MAP_RANDOM)) {</span>
<span class="nc" id="L800">                    sBoardFile = (boards.get(Compute.randomInt(boards.size()))) + FILE_SUFFIX_BOARD;</span>
                } else {
<span class="nc" id="L802">                    sBoardFile = board + FILE_SUFFIX_BOARD;</span>
                }
<span class="nc" id="L804">                File fBoard = new MegaMekFile(Configuration.boardsDir(), sBoardFile).getFile();</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">                if (!fBoard.exists()) {</span>
<span class="nc" id="L806">                    throw new ScenarioLoaderException(&quot;nonexistantBoard&quot;, board);</span>
                }
<span class="nc" id="L808">                ba[n] = new Board();</span>
<span class="nc" id="L809">                ba[n].load(new MegaMekFile(Configuration.boardsDir(), sBoardFile).getFile());</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">                if (cf &gt; 0) {</span>
<span class="nc" id="L811">                    ba[n].setBridgeCF(cf);</span>
                }
<span class="nc" id="L813">                BoardUtilities.flip(ba[n], isRotated, isRotated);</span>
<span class="nc" id="L814">                rotateBoard.add(isRotated);</span>
            }
        }

        // if only one board just return it.
<span class="nc bnc" id="L819" title="All 2 branches missed.">        if (ba.length == 1) {</span>
<span class="nc" id="L820">            return ba[0];</span>
        }
        // construct the big board
<span class="nc" id="L823">        return BoardUtilities.combine(mapWidth, mapHeight, nWidth, nHeight, ba, rotateBoard, MapSettings.MEDIUM_GROUND);</span>
    }

    private StringMultiMap load() throws ScenarioLoaderException {
<span class="nc" id="L827">        StringMultiMap props = new StringMultiMap();</span>
<span class="nc" id="L828">        try (BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(scenarioFile), StandardCharsets.UTF_8))) {</span>
            String line;
<span class="nc" id="L830">            int lineNum = 0;</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">            while ((line = reader.readLine()) != null) {</span>
<span class="nc" id="L832">                lineNum++;</span>
<span class="nc" id="L833">                line = line.trim();</span>
<span class="nc bnc" id="L834" title="All 4 branches missed.">                if (line.startsWith(COMMENT_MARK) || (line.length() == 0)) {</span>
<span class="nc" id="L835">                    continue;</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                } else if (!line.contains(SEPARATOR_PROPERTY)) {</span>
<span class="nc" id="L837">                    MegaMek.getLogger().error(String.format(&quot;Equality sign in scenario file %s on line %d missing; ignoring&quot;,</span>
<span class="nc" id="L838">                            scenarioFile, lineNum));</span>
<span class="nc" id="L839">                    continue;</span>
                }
<span class="nc" id="L841">                String[] elements = line.split(SEPARATOR_PROPERTY, -1);</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                if (elements.length &gt; 2) {</span>
<span class="nc" id="L843">                    MegaMek.getLogger().error(String.format(&quot;Multiple equality signs in scenario file %s on line %d; ignoring&quot;,</span>
<span class="nc" id="L844">                            scenarioFile, lineNum));</span>
<span class="nc" id="L845">                    continue;</span>
                }
<span class="nc" id="L847">                props.put(elements[0].trim(), elements[1].trim());</span>
<span class="nc" id="L848">            }</span>
<span class="nc" id="L849">        } catch (IOException e) {</span>
<span class="nc" id="L850">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L851">            throw new ScenarioLoaderException(&quot;exceptionReadingFile&quot;, scenarioFile);</span>
<span class="nc" id="L852">        }</span>
<span class="nc" id="L853">        return props;</span>
    }

    /**
     * Parses out the external game id from the scenario file
     */
    private int parseExternalGameId(StringMultiMap p) {
<span class="nc" id="L860">        String sExternalId = p.getString(PARAM_GAME_EXTERNAL_ID);</span>
<span class="nc" id="L861">        int ExternalGameId = 0;</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">        if (sExternalId != null) {</span>
<span class="nc" id="L863">            ExternalGameId = Integer.parseInt(sExternalId);</span>
        }
<span class="nc" id="L865">        return ExternalGameId;</span>
    }

    public static void main(String[] saArgs) throws Exception {
<span class="nc" id="L869">        ScenarioLoader sl = new ScenarioLoader(new File(saArgs[0]));</span>
<span class="nc" id="L870">        IGame g = sl.createGame();</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (g != null) {</span>
<span class="nc" id="L872">            MegaMek.getLogger().info(&quot;Successfully loaded.&quot;);</span>
        }
<span class="nc" id="L874">    }</span>

    /**
     * This is used specify the critical hit location
     */
    private static class CritHit {
        public int loc;
        public int slot;

<span class="nc" id="L883">        public CritHit(int l, int s) {</span>
<span class="nc" id="L884">            loc = l;</span>
<span class="nc" id="L885">            slot = s;</span>
<span class="nc" id="L886">        }</span>
    }

    /**
     * This class is used to store the critical hit plan for a entity it is
     * loaded from the scenario file. It contains a vector of CritHit.
     */
    private class CritHitPlan {
        public Entity entity;
<span class="nc" id="L895">        List&lt;CritHit&gt; critHits = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L897">        public CritHitPlan(Entity e) {</span>
<span class="nc" id="L898">            entity = e;</span>
<span class="nc" id="L899">        }</span>

        public void addCritHit(String s) {
<span class="nc" id="L902">            int ewSpot = s.indexOf(':');</span>
<span class="nc" id="L903">            int loc = Integer.parseInt(s.substring(0, ewSpot));</span>
<span class="nc" id="L904">            int slot = Integer.parseInt(s.substring(ewSpot + 1));</span>
            
<span class="nc" id="L906">            critHits.add(new CritHit(loc, slot - 1));</span>
<span class="nc" id="L907">        }</span>
    }

    /**
     * This is used to store the armor to change ammo at a given location
     */
    private static class SetAmmoTo {
        public final int loc;
        public final int slot;
        public final int setAmmoTo;

<span class="nc" id="L918">        public SetAmmoTo(int loc, int slot, int setAmmoTo) {</span>
<span class="nc" id="L919">            this.loc = loc;</span>
<span class="nc" id="L920">            this.slot = slot;</span>
<span class="nc" id="L921">            this.setAmmoTo = setAmmoTo;</span>
<span class="nc" id="L922">        }</span>
    }
    
    private static class SetAmmoType {
        public final int loc;
        public final int slot;
        public final String type;
        
<span class="nc" id="L930">        public SetAmmoType(int loc, int slot, String type) {</span>
<span class="nc" id="L931">            this.loc = loc;</span>
<span class="nc" id="L932">            this.slot = slot;</span>
<span class="nc" id="L933">            this.type = type;</span>
<span class="nc" id="L934">        }</span>
    }

    /**
     * This class is used to store the ammo Adjustments it is loaded from the
     * scenario file. It contains a vector of SetAmmoTo.
     */
    private class SetAmmoPlan {
        public final Entity entity;
<span class="nc" id="L943">        public final List&lt;SetAmmoTo&gt; ammoSetTo = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L944">        public final List&lt;SetAmmoType&gt; ammoSetType = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L946">        public SetAmmoPlan(Entity e) {</span>
<span class="nc" id="L947">            entity = e;</span>
<span class="nc" id="L948">        }</span>

        /**
         * Converts 2:1-34 to Location 2 Slot 1 set Ammo to 34
         */
        public void addSetAmmoTo(String s) {
<span class="nc" id="L954">            int ewSpot = s.indexOf(':');</span>
<span class="nc" id="L955">            int amSpot = s.indexOf('-');</span>
<span class="nc bnc" id="L956" title="All 6 branches missed.">            if (s.isEmpty() || (ewSpot &lt; 1) || (amSpot &lt; ewSpot)) {</span>
<span class="nc" id="L957">                return;</span>
            }
<span class="nc" id="L959">            int loc = Integer.parseInt(s.substring(0, ewSpot));</span>
<span class="nc" id="L960">            int slot = Integer.parseInt(s.substring(ewSpot + 1, amSpot));</span>
<span class="nc" id="L961">            int setTo = Integer.parseInt(s.substring(amSpot + 1));</span>

<span class="nc" id="L963">            ammoSetTo.add(new SetAmmoTo(loc, slot - 1, setTo));</span>
<span class="nc" id="L964">        }</span>
        
        public void addSetAmmoType(String s) {
<span class="nc" id="L967">            int ewSpot = s.indexOf(':');</span>
<span class="nc" id="L968">            int atSpot = s.indexOf('-');</span>
<span class="nc bnc" id="L969" title="All 6 branches missed.">            if (s.isEmpty() || (ewSpot &lt; 1) || (atSpot &lt; ewSpot)) {</span>
<span class="nc" id="L970">                return;</span>
            }
<span class="nc" id="L972">            int loc = Integer.parseInt(s.substring(0, ewSpot));</span>
<span class="nc" id="L973">            int slot = Integer.parseInt(s.substring(ewSpot + 1, atSpot));</span>
            
<span class="nc" id="L975">            ammoSetType.add(new SetAmmoType(loc, slot - 1, s.substring(atSpot + 1)));</span>
<span class="nc" id="L976">        }</span>
    }

    /**
     * This is used specify the one damage location
     */
    private static class SpecDam {
        public final int loc;
        public final int setArmorTo;
        public final boolean rear;
        public final boolean internal;

<span class="nc" id="L988">        public SpecDam(int Location, int SetArmorTo, boolean RearHit, boolean Internal) {</span>
<span class="nc" id="L989">            loc = Location;</span>
<span class="nc" id="L990">            setArmorTo = SetArmorTo;</span>
<span class="nc" id="L991">            rear = RearHit;</span>
<span class="nc" id="L992">            internal = Internal;</span>
<span class="nc" id="L993">        }</span>
    }

    /**
     * This class is used to store the damage plan for a entity it is loaded
     * from the scenario file. It contains a vector of SpecDam.
     */
    private class DamagePlan {
        public final Entity entity;
        public final int nBlocks;
<span class="nc" id="L1003">        public final List&lt;SpecDam&gt; specificDammage = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1005">        public DamagePlan(Entity e, int n) {</span>
<span class="nc" id="L1006">            entity = e;</span>
<span class="nc" id="L1007">            nBlocks = n;</span>
<span class="nc" id="L1008">        }</span>

<span class="nc" id="L1010">        public DamagePlan(Entity e) {</span>
<span class="nc" id="L1011">            entity = e;</span>
<span class="nc" id="L1012">            nBlocks = 0;</span>
<span class="nc" id="L1013">        }</span>

        /**
         * Converts N2:1 to Nornam hit to location 2 set armor to 1!
         */
        public void addSpecificDamage(String s) {
<span class="nc" id="L1019">            int ewSpot = s.indexOf(':');</span>
<span class="nc bnc" id="L1020" title="All 4 branches missed.">            if (s.isEmpty() || (ewSpot &lt; 1)) {</span>
<span class="nc" id="L1021">                return;</span>
            }
<span class="nc" id="L1023">            int loc = Integer.parseInt(s.substring(1, ewSpot));</span>
<span class="nc" id="L1024">            int setTo = Integer.parseInt(s.substring(ewSpot + 1));</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">            boolean rear = (s.charAt(0) == 'R');</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">            boolean internal = (s.charAt(0) == 'I');</span>
            
<span class="nc" id="L1028">            specificDammage.add(new SpecDam(loc, setTo, rear, internal));</span>
<span class="nc" id="L1029">        }</span>
    }
    
    private static class ScenarioLoaderException extends Exception {
        private static final long serialVersionUID = 8622648319531348199L;
        
        private final Object[] params;

        public ScenarioLoaderException(String errorKey) {
<span class="nc" id="L1038">            super(errorKey);</span>
<span class="nc" id="L1039">            this.params = null;</span>
<span class="nc" id="L1040">        }</span>
        
        public ScenarioLoaderException(String errorKey, Object... params) {
<span class="nc" id="L1043">            super(errorKey);</span>
<span class="nc" id="L1044">            this.params = params;</span>
<span class="nc" id="L1045">        }</span>
        
        @Override
        public String getMessage() {
<span class="nc" id="L1049">            String result = Messages.getString(&quot;ScenarioLoaderException.&quot; + super.getMessage());</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">            if (params != null) {</span>
                try {
<span class="nc" id="L1052">                    return String.format(result, params);</span>
<span class="nc" id="L1053">                } catch (IllegalFormatException ignored) {</span>
                    // Ignore, return the base translation instead
                }
            }
<span class="nc" id="L1057">            return result;</span>
        }
    }
    
    private static class StringMultiMap extends HashMap&lt;String, Collection&lt;String&gt;&gt; {
        private static final long serialVersionUID = 2171662843329151622L;

        public void put(String key, String value) {
<span class="nc" id="L1065">            Collection&lt;String&gt; values = get(key);</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">            if (values == null) {</span>
<span class="nc" id="L1067">                values = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1068">                put(key, values);</span>
            }
<span class="nc" id="L1070">            values.add(value);</span>
<span class="nc" id="L1071">        }</span>

        public String getString(String key) {
<span class="nc" id="L1074">            return getString(key, SEPARATOR_COMMA);</span>
        }

        public String getString(String key, String separator) {
<span class="nc" id="L1078">            Collection&lt;String&gt; values = get(key);</span>
<span class="nc bnc" id="L1079" title="All 4 branches missed.">            if ((values == null) || (values.size() == 0)) {</span>
<span class="nc" id="L1080">                return null;</span>
            }
            
<span class="nc" id="L1083">            boolean firstElement = true;</span>
<span class="nc" id="L1084">            StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">            for (String val : values) {</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                if (firstElement) {</span>
<span class="nc" id="L1087">                    firstElement = false;</span>
                } else {
<span class="nc" id="L1089">                    sb.append(separator);</span>
                }
<span class="nc" id="L1091">                sb.append(val);</span>
<span class="nc" id="L1092">            }</span>
<span class="nc" id="L1093">            return sb.toString();</span>
        }
        
        /** @return the number of values for this key in the file */
        public int getNumValues(String key) {
<span class="nc" id="L1098">            Collection&lt;String&gt; values = get(key);</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">            return (values == null) ? 0 : values.size();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>