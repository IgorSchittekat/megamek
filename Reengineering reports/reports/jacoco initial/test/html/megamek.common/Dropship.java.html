<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Dropship.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Dropship.java</span></div><h1>Dropship.java</h1><pre class="source lang-java linenums">/*
 * MegaAero - Copyright (C) 2007 Jay Lawson This program is free software; you
 * can redistribute it and/or modify it under the terms of the GNU General
 * Public License as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */
/*
 * Created on Jun 17, 2007
 */
package megamek.common;

import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.TreeMap;
import java.util.Vector;

import megamek.common.options.OptionsConstants;
import megamek.common.weapons.bayweapons.BayWeapon;

/**
 * @author Jay Lawson
 */
<span class="nc" id="L31">public class Dropship extends SmallCraft {</span>

    /**
     *
     */
    private static final long serialVersionUID = 1528728632696989565L;
    
    
    //ASEW Missile Effects, per location
    //Values correspond to Locations: NOS,Left,Right,AFT
<span class="nc" id="L41">    private int asewAffectedTurns[] = {0,0,0,0};</span>
    
    /*
     * Sets the number of rounds a specified firing arc is affected by an ASEW missile
     * @param arc - integer representing the desired firing arc
     * @param turns - integer specifying the number of end phases that the effects last through
     * Technically, about 1.5 turns elapse per the rules for ASEW missiles in TO
     */
    public void setASEWAffected(int arc, int turns) {
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (arc &lt; asewAffectedTurns.length) {</span>
<span class="nc" id="L51">            asewAffectedTurns[arc] = turns;</span>
        }
<span class="nc" id="L53">    }</span>
    
    /*
     * Returns the number of rounds a specified firing arc is affected by an ASEW missile
     * @param arc - integer representing the desired firing arc
     */
    public int getASEWAffected(int arc) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (arc &lt; asewAffectedTurns.length) {</span>
<span class="nc" id="L61">            return asewAffectedTurns[arc];            </span>
        }
<span class="nc" id="L63">        return 0;</span>
    }

    /**
     * Primitive Dropships may be constructed with no docking collar, or with a pre-boom collar. 
     * 
     */
    public static final int COLLAR_STANDARD  = 0;
    public static final int COLLAR_PROTOTYPE = 1;
    public static final int COLLAR_NO_BOOM   = 2;
    
<span class="fc" id="L74">    private static final String[] COLLAR_NAMES = {</span>
            &quot;KF-Boom&quot;, &quot;Prototype KF-Boom&quot;, &quot;No Boom&quot;
    };
    
    //Likewise, you can have a prototype or standard K-F Boom
    public static final int BOOM_STANDARD  = 0;
    public static final int BOOM_PROTOTYPE = 1;
    
    // what needs to go here?
    // loading and unloading of units?
<span class="nc" id="L84">    private boolean dockCollarDamaged = false;</span>
<span class="nc" id="L85">    private boolean kfBoomDamaged = false;</span>
<span class="nc" id="L86">    private int collarType = COLLAR_STANDARD;</span>
<span class="nc" id="L87">    private int boomType = BOOM_STANDARD;</span>

    @Override
    public boolean tracksHeat() {
        // While large craft perform heat calculations, they are not considered heat-tracking units
        // because they cannot generate more heat than they can dissipate in the same turn.
<span class="nc" id="L93">        return false;</span>
    }

    @Override
    public int getUnitType() {
<span class="nc" id="L98">        return UnitType.DROPSHIP;</span>
    }

    public CrewType defaultCrewType() {
<span class="nc" id="L102">        return CrewType.VESSEL;</span>
    }

    //Docking Collar Stuff
    public boolean isDockCollarDamaged() {
<span class="nc" id="L107">        return dockCollarDamaged;</span>
    }
    
    public int getCollarType() {
<span class="nc" id="L111">        return collarType;</span>
    }
    
    public void setCollarType(int collarType) {
<span class="nc" id="L115">        this.collarType = collarType;</span>
<span class="nc" id="L116">    }</span>
    
    public String getCollarName() {
<span class="nc" id="L119">        return COLLAR_NAMES[collarType];</span>
    }
    
    public static String getCollarName(int type) {
<span class="nc" id="L123">        return COLLAR_NAMES[type];</span>
    }
    
    public static TechAdvancement getCollarTA() {
<span class="nc" id="L127">        return new TechAdvancement(TECH_BASE_ALL).setAdvancement(2458, 2470, 2500)</span>
<span class="nc" id="L128">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH).setTechRating(RATING_C)</span>
<span class="nc" id="L129">                .setAvailability(RATING_C, RATING_C, RATING_C, RATING_C)</span>
<span class="nc" id="L130">                .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
    }
    
    //KF Boom Stuff
    public boolean isKFBoomDamaged() {
<span class="nc" id="L135">        return kfBoomDamaged;</span>
    }
    
    public int getBoomType() {
<span class="nc" id="L139">        return boomType;</span>
    }
    
    public void setBoomType(int boomType) {
<span class="nc" id="L143">        this.boomType = boomType;</span>
<span class="nc" id="L144">    }</span>

    public String getCritDamageString() {
<span class="nc" id="L147">        StringBuilder toReturn = new StringBuilder(super.getCritDamageString());</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        boolean first = toReturn.length() == 0;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (isDockCollarDamaged()) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L151">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L153">            toReturn.append(Messages.getString(&quot;Dropship.collarDamageString&quot;));</span>
<span class="nc" id="L154">            first = false;</span>
        }
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (isKFBoomDamaged()) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L158">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L160">            toReturn.append(Messages.getString(&quot;Dropship.kfBoomDamageString&quot;));</span>
<span class="nc" id="L161">            first = false;</span>
        }
<span class="nc" id="L163">        return toReturn.toString();</span>
    }

    @Override
    public boolean isLocationProhibited(Coords c, int currElevation) {
<span class="nc" id="L168">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.IMPASSABLE)) {</span>
<span class="nc" id="L171">                return true;</span>
            }
<span class="nc" id="L173">            return false;</span>
        }
        // Check prohibited terrain
        // treat grounded Dropships like wheeled tanks,
        // plus buildings are prohibited
<span class="nc" id="L178">        boolean isProhibited = hexContainsProhibitedTerrain(hex);</span>

<span class="nc" id="L180">        HashMap&lt;Integer, Integer&gt; elevations = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L181">        elevations.put(hex.getLevel(), 1);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L183">            Coords secondaryCoord = c.translated(dir);</span>
<span class="nc" id="L184">            IHex secondaryHex = game.getBoard().getHex(secondaryCoord);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (secondaryHex == null) {</span>
                // Don't allow landed dropships to hang off the board
<span class="nc" id="L187">                isProhibited = true;</span>
            } else {
<span class="nc" id="L189">                isProhibited |= hexContainsProhibitedTerrain(secondaryHex);</span>

<span class="nc" id="L191">                int elev = secondaryHex.getLevel();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                if (elevations.containsKey(elev)) {</span>
<span class="nc" id="L193">                    elevations.put(elev, elevations.get(elev) + 1);</span>
                } else {
<span class="nc" id="L195">                    elevations.put(elev, 1);</span>
                }
            }
        }
        /*
         * As of 8/2013 there aren't clear restrictions for landed dropships. We
         * are going to assume that Dropships need to be on fairly level
         * terrain. This means, it can only be on at most 2 different elevations
         * that are at most 1 elevation apart. Additionally, at least half of
         * the dropships hexes round down must be on one elevation
         */
        // Whole DS is on one elevation
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (elevations.size() == 1) {</span>
<span class="nc" id="L208">            return isProhibited;</span>
        }
        // DS on more than 2 different elevations
        // or not on an elevation, what?
<span class="nc bnc" id="L212" title="All 4 branches missed.">        if ((elevations.size() &gt; 2) || (elevations.size() == 0)) {</span>
<span class="nc" id="L213">            return true;</span>
        }

<span class="nc" id="L216">        Object elevs[] = elevations.keySet().toArray();</span>
<span class="nc" id="L217">        int elev1 = (Integer) elevs[0];</span>
<span class="nc" id="L218">        int elev2 = (Integer) elevs[1];</span>
<span class="nc" id="L219">        int elevDifference = Math.abs(elev1 - elev2);</span>
<span class="nc" id="L220">        int elevMinCount = 2;</span>
        // Check elevation difference and make sure that the counts of different
        // elevations will allow for a legal deployment to exist
<span class="nc bnc" id="L223" title="All 4 branches missed.">        if ((elevDifference &gt; 1) || (elevations.get(elevs[0]) &lt; elevMinCount)</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                || (elevations.get(elevs[1]) &lt; elevMinCount)) {</span>
<span class="nc" id="L225">            return true;</span>
        }

        // It's still possible we have a legal deployment, we now have to check
        // the arrangement of hexes
        // The way this is done is we start at the hex directly above the
        // central hex and then move around clockwise and compare the two hexes
        // to see if they share an elevation. We need to have a number of these
        // adjacencies equal to the number of secondary elevation hexes - 1.
<span class="nc" id="L234">        int numAdjacencies = 0;</span>
<span class="nc" id="L235">        int centralElev = hex.getLevel();</span>
<span class="nc" id="L236">        int secondElev = centralElev;</span>
<span class="nc" id="L237">        IHex currHex = game.getBoard().getHex(c.translated(5));</span>
        // Ensure we aren't trying to deploy off the board
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (currHex == null) {</span>
<span class="nc" id="L240">            return true;</span>
        }
<span class="nc bnc" id="L242" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (currHex.getLevel() != centralElev) {</span>
<span class="nc" id="L244">                secondElev = currHex.getLevel();</span>
            }
<span class="nc" id="L246">            IHex nextHex = game.getBoard().getHex(c.translated(dir));</span>
            // Ensure we aren't trying to deploy off the board
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (nextHex == null) {</span>
<span class="nc" id="L249">                return true;</span>
            }
<span class="nc bnc" id="L251" title="All 4 branches missed.">            if ((currHex.getLevel() != centralElev) &amp;&amp; (currHex.getLevel() == nextHex.getLevel())) {</span>
<span class="nc" id="L252">                numAdjacencies++;</span>
            }
<span class="nc" id="L254">            currHex = nextHex;</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (numAdjacencies &lt; (elevations.get(secondElev) - 1)) {</span>
<span class="nc" id="L257">            return true;</span>
        }

<span class="nc" id="L260">        return isProhibited;</span>
    }
    
    /**
     * Worker function that checks if a given hex contains terrain onto which a grounded dropship
     * cannot deploy. 
     */
    private boolean hexContainsProhibitedTerrain(IHex hex) {
<span class="nc bnc" id="L268" title="All 4 branches missed.">        return hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L269" title="All 4 branches missed.">                || ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.RUBBLE) || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.JUNGLE) || (hex.terrainLevel(Terrains.SNOW) &gt; 1)</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                || (hex.terrainLevel(Terrains.GEYSER) == 2) </span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.BUILDING) || hex.containsTerrain(Terrains.IMPASSABLE) </span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                || hex.containsTerrain(Terrains.BRIDGE);</span>
                
    }

    public void setDamageDockCollar(boolean b) {
<span class="nc" id="L279">        dockCollarDamaged = b;</span>
<span class="nc" id="L280">    }</span>
    
    public void setDamageKFBoom(boolean b) {
<span class="nc" id="L283">        kfBoomDamaged = b;</span>
<span class="nc" id="L284">    }</span>

    @Override
    public double getFuelPointsPerTon() {
        double ppt;
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (getWeight() &lt; 400) {</span>
<span class="nc" id="L290">            ppt = 80;</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        } else if (getWeight() &lt; 800) {</span>
<span class="nc" id="L292">            ppt = 70;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        } else if (getWeight() &lt; 1200) {</span>
<span class="nc" id="L294">            ppt = 60;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        } else if (getWeight() &lt; 1900) {</span>
<span class="nc" id="L296">            ppt = 50;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">        } else if (getWeight() &lt; 3000) {</span>
<span class="nc" id="L298">            ppt = 40;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">        } else if (getWeight() &lt; 20000) {</span>
<span class="nc" id="L300">            ppt = 30;</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        } else if (getWeight() &lt; 40000) {</span>
<span class="nc" id="L302">            ppt = 20;</span>
        } else {
<span class="nc" id="L304">            ppt = 10;</span>
        }
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (isPrimitive()) {</span>
<span class="nc" id="L307">            return ppt / primitiveFuelFactor();</span>
        }
<span class="nc" id="L309">        return ppt;</span>
    }

    @Override
    public double getStrategicFuelUse() {
<span class="nc" id="L314">        double fuelUse = 1.84; // default for military designs and civilian &lt; 1000</span>
<span class="nc bnc" id="L315" title="All 4 branches missed.">        if ((getDesignType() == CIVILIAN) || isPrimitive()) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (getWeight() &gt;= 70000) {</span>
<span class="nc" id="L317">                fuelUse = 8.83;</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            } else if (getWeight() &gt;= 50000) {</span>
<span class="nc" id="L319">                fuelUse = 8.37;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            } else if (getWeight() &gt;= 40000) {</span>
<span class="nc" id="L321">                fuelUse = 7.71;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            } else if (getWeight() &gt;= 30000) {</span>
<span class="nc" id="L323">                fuelUse = 6.52;</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            } else if (getWeight() &gt;= 20000) {</span>
<span class="nc" id="L325">                fuelUse = 5.19;</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">            } else if (getWeight() &gt;= 9000) {</span>
<span class="nc" id="L327">                fuelUse = 4.22;</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">            } else if (getWeight() &gt;= 4000) {</span>
<span class="nc" id="L329">                fuelUse = 2.82;</span>
            }
        }
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (isPrimitive()) {</span>
<span class="nc" id="L333">            return fuelUse * primitiveFuelFactor();</span>
        }
<span class="nc" id="L335">        return fuelUse;</span>
    }
    
    @Override
    public double primitiveFuelFactor() {
<span class="nc" id="L340">        int year = getOriginalBuildYear();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (year &gt;= 2500) {</span>
<span class="nc" id="L342">            return 1.0;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        } else if (year &gt;= 2400) {</span>
<span class="nc" id="L344">            return 1.1;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">        } else if (year &gt;= 2351) {</span>
<span class="nc" id="L346">            return 1.3;</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        } else if (year &gt;= 2251) {</span>
<span class="nc" id="L348">            return 1.4;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">        } else if (year &gt;= 2201) {</span>
<span class="nc" id="L350">            return 1.6;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">        } else if (year &gt;= 2151) {</span>
<span class="nc" id="L352">            return 1.8;</span>
        } else {
<span class="nc" id="L354">            return 2.0;</span>
        }
    }

<span class="fc" id="L358">    protected static final TechAdvancement TA_DROPSHIP = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="fc" id="L359">            .setAdvancement(DATE_NONE, 2470, 2490).setISApproximate(false, true, false)</span>
<span class="fc" id="L360">            .setProductionFactions(F_TH).setTechRating(RATING_D)</span>
<span class="fc" id="L361">            .setAvailability(RATING_D, RATING_E, RATING_D, RATING_D)</span>
<span class="fc" id="L362">            .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
<span class="fc" id="L363">    protected static final TechAdvancement TA_DROPSHIP_PRIMITIVE = new TechAdvancement(TECH_BASE_IS)</span>
<span class="fc" id="L364">            .setISAdvancement(DATE_ES, 2200, DATE_NONE, 2500)</span>
<span class="fc" id="L365">            .setISApproximate(false, true, false, false)</span>
<span class="fc" id="L366">            .setProductionFactions(F_TA).setTechRating(RATING_D)</span>
<span class="fc" id="L367">            .setAvailability(RATING_D, RATING_X, RATING_X, RATING_X)</span>
<span class="fc" id="L368">            .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
    
    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="nc bnc" id="L372" title="All 2 branches missed.">        return isPrimitive()? TA_DROPSHIP_PRIMITIVE : TA_DROPSHIP;</span>
    }
    
    @Override
    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<span class="nc" id="L377">        super.addSystemTechAdvancement(ctl);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (collarType != COLLAR_NO_BOOM) {</span>
<span class="nc" id="L379">            ctl.addComponent(getCollarTA());</span>
        }
<span class="nc" id="L381">    }</span>
    
    @Override
    public double getCost(boolean ignoreAmmo) {
<span class="nc" id="L385">        double[] costs = new double[20];</span>
<span class="nc" id="L386">        int costIdx = 0;</span>
<span class="nc" id="L387">        double cost = 0;</span>

        // Control Systems
        // Bridge
<span class="nc" id="L391">        costs[costIdx++] += 200000 + (10 * weight);</span>
        // Computer
<span class="nc" id="L393">        costs[costIdx++] += 200000;</span>
        // Life Support
<span class="nc" id="L395">        costs[costIdx++] += 5000 * (getNCrew() + getNPassenger());</span>
        // Sensors
<span class="nc" id="L397">        costs[costIdx++] += 80000;</span>
        // Fire Control Computer
<span class="nc" id="L399">        costs[costIdx++] += 100000;</span>
        // Gunnery Control Systems
<span class="nc" id="L401">        costs[costIdx++] += 10000 * getArcswGuns();</span>

        // Structural Integrity
<span class="nc" id="L404">        costs[costIdx++] += 100000 * getSI();</span>

        // Additional Flight Systems
        // Attitude Thruster
<span class="nc" id="L408">        costs[costIdx++] += 25000;</span>
        // Landing Gear
<span class="nc" id="L410">        costs[costIdx++] += 10 * getWeight();</span>
        // Docking Collar
<span class="nc bnc" id="L412" title="All 2 branches missed.">        if (collarType == COLLAR_STANDARD) {</span>
<span class="nc" id="L413">            costs[costIdx++] += 10000;</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">        } else if (collarType == COLLAR_PROTOTYPE) {</span>
<span class="nc" id="L415">            costs[costIdx++] += 1010000;</span>
        }

        // Engine
<span class="nc" id="L419">        double engineMultiplier = 0.065;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (isClan()) {</span>
<span class="nc" id="L421">            engineMultiplier = 0.061;</span>
        }
<span class="nc" id="L423">        double engineWeight = getOriginalWalkMP() * weight * engineMultiplier;</span>
<span class="nc" id="L424">        costs[costIdx++] += engineWeight * 1000;</span>
        // Drive Unit
<span class="nc" id="L426">        costs[costIdx++] += (500 * getOriginalWalkMP() * weight) / 100.0;</span>

        // Fuel Tanks
<span class="nc" id="L429">        costs[costIdx++] += (200 * getFuel()) / getFuelPointsPerTon() * 1.02;</span>

        // Armor
<span class="nc" id="L432">        costs[costIdx++] += getArmorWeight() * EquipmentType.getArmorCost(armorType[0]);</span>

        // Heat Sinks
<span class="nc" id="L435">        int sinkCost = 2000 + (4000 * getHeatType());// == HEAT_DOUBLE ? 6000:</span>
        // 2000;
<span class="nc" id="L437">        costs[costIdx++] += sinkCost * getHeatSinks();</span>

        // Weapons and Equipment
<span class="nc" id="L440">        costs[costIdx++] += getWeaponsAndEquipmentCost(ignoreAmmo);</span>

        // Transport Bays
<span class="nc" id="L443">        int baydoors = 0;</span>
<span class="nc" id="L444">        long bayCost = 0;</span>
<span class="nc" id="L445">        long quartersCost = 0;</span>
        // Passenger and crew quarters and infantry bays are considered part of the structure
        // and don't add to the cost
<span class="nc bnc" id="L448" title="All 2 branches missed.">        for (Bay next : getTransportBays()) {</span>
<span class="nc" id="L449">            baydoors += next.getDoors();</span>
<span class="nc bnc" id="L450" title="All 6 branches missed.">            if (!next.isQuarters() &amp;&amp; !(next instanceof InfantryBay) &amp;&amp; !(next instanceof BattleArmorBay)) {</span>
<span class="nc" id="L451">                bayCost += next.getCost();</span>
            }
<span class="nc" id="L453">        }</span>

<span class="nc" id="L455">        costs[costIdx++] += bayCost + (baydoors * 1000L);</span>
<span class="nc" id="L456">        costs[costIdx++] = quartersCost;</span>

        // Life Boats and Escape Pods
<span class="nc" id="L459">        costs[costIdx++] += 5000 * (getLifeBoats() + getEscapePods());</span>

        // TODO Decouple cost calculation from addCostDetails and eliminate duplicate code in getPriceMultiplier
<span class="nc" id="L462">        double weightMultiplier = 36.0;</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (isSpheroid()) {</span>
<span class="nc" id="L464">            weightMultiplier = 28.0;</span>
        }

        // Sum Costs
<span class="nc bnc" id="L468" title="All 2 branches missed.">        for (int i = 0; i &lt; costIdx; i++) {</span>
<span class="nc" id="L469">            cost += costs[i];</span>
        }

<span class="nc" id="L472">        costs[costIdx++] = -weightMultiplier; // Negative indicates multiplier</span>
<span class="nc" id="L473">        cost = Math.round(cost * weightMultiplier);</span>
<span class="nc" id="L474">        addCostDetails(cost, costs);</span>
<span class="nc" id="L475">        return cost;</span>
    }

    @Override
    public double getPriceMultiplier() {
<span class="nc bnc" id="L480" title="All 2 branches missed.">        return isSpheroid() ? 28.0 : 36.0;</span>
    }

    private void addCostDetails(double cost, double[] costs) {
<span class="nc" id="L484">        bvText = new StringBuffer();</span>
<span class="nc" id="L485">        String[] left = { &quot;Bridge&quot;, &quot;Computer&quot;, &quot;Life Support&quot;, &quot;Sensors&quot;, &quot;FCS&quot;, &quot;Gunnery Control Systems&quot;,</span>
                &quot;Structural Integrity&quot;, &quot;Attitude Thruster&quot;, &quot;Landing Gear&quot;, &quot;Docking Collar&quot;,
                &quot;Engine&quot;, &quot;Drive Unit&quot;, &quot;Fuel Tanks&quot;, &quot;Armor&quot;, &quot;Heat Sinks&quot;, &quot;Weapons/Equipment&quot;, &quot;Bays&quot;,
                &quot;Quarters&quot;, &quot;Life Boats/Escape Pods&quot;, &quot;Weight Multiplier&quot; };

<span class="nc" id="L490">        NumberFormat commafy = NumberFormat.getInstance();</span>

<span class="nc" id="L492">        bvText.append(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Cost Calculations For &quot;);</span>
<span class="nc" id="L493">        bvText.append(getChassis());</span>
<span class="nc" id="L494">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L495">        bvText.append(getModel());</span>
<span class="nc" id="L496">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L497">        bvText.append(nl);</span>

<span class="nc" id="L499">        bvText.append(startTable);</span>
        // find the maximum length of the columns.
<span class="nc bnc" id="L501" title="All 2 branches missed.">        for (int l = 0; l &lt; left.length; l++) {</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">            if (l == 14) {</span>
<span class="nc" id="L504">                getWeaponsAndEquipmentCost(true);</span>
            } else {
<span class="nc" id="L506">                bvText.append(startRow);</span>
<span class="nc" id="L507">                bvText.append(startColumn);</span>
<span class="nc" id="L508">                bvText.append(left[l]);</span>
<span class="nc" id="L509">                bvText.append(endColumn);</span>
<span class="nc" id="L510">                bvText.append(startColumn);</span>

<span class="nc bnc" id="L512" title="All 2 branches missed.">                if (costs[l] == 0) {</span>
<span class="nc" id="L513">                    bvText.append(&quot;N/A&quot;);</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                } else if (costs[l] &lt; 0) {</span>
<span class="nc" id="L515">                    bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L516">                    bvText.append(commafy.format(-costs[l]));</span>
                } else {
<span class="nc" id="L518">                    bvText.append(commafy.format(costs[l]));</span>

                }
<span class="nc" id="L521">                bvText.append(endColumn);</span>
<span class="nc" id="L522">                bvText.append(endRow);</span>
            }
        }
<span class="nc" id="L525">        bvText.append(startRow);</span>
<span class="nc" id="L526">        bvText.append(startColumn);</span>
<span class="nc" id="L527">        bvText.append(endColumn);</span>
<span class="nc" id="L528">        bvText.append(startColumn);</span>
<span class="nc" id="L529">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L530">        bvText.append(endColumn);</span>
<span class="nc" id="L531">        bvText.append(endRow);</span>

<span class="nc" id="L533">        bvText.append(startRow);</span>
<span class="nc" id="L534">        bvText.append(startColumn);</span>
<span class="nc" id="L535">        bvText.append(&quot;Total Cost:&quot;);</span>
<span class="nc" id="L536">        bvText.append(endColumn);</span>
<span class="nc" id="L537">        bvText.append(startColumn);</span>
<span class="nc" id="L538">        bvText.append(commafy.format(cost));</span>
<span class="nc" id="L539">        bvText.append(endColumn);</span>
<span class="nc" id="L540">        bvText.append(endRow);</span>

<span class="nc" id="L542">        bvText.append(endTable);</span>
<span class="nc" id="L543">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>
<span class="nc" id="L544">    }</span>

    private String getArcName(int loc) {
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (loc &lt; locations()) {</span>
<span class="nc" id="L548">            return getLocationName(loc);</span>
        }
<span class="nc" id="L550">        return getLocationName(loc - 3) + &quot; (R)&quot;;</span>
    }

    @Override
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L556">            return manualBV;</span>
        }

<span class="nc" id="L559">        bvText = new StringBuffer(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Battle Value Calculations For &quot;);</span>

<span class="nc" id="L561">        bvText.append(getChassis());</span>
<span class="nc" id="L562">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L563">        bvText.append(getModel());</span>
<span class="nc" id="L564">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L565">        bvText.append(nl);</span>

<span class="nc" id="L567">        bvText.append(&quot;&lt;b&gt;Defensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L568">        bvText.append(nl);</span>

<span class="nc" id="L570">        double dbv = 0; // defensive battle value</span>
<span class="nc" id="L571">        double obv = 0; // offensive bv</span>

<span class="nc" id="L573">        int modularArmor = 0;</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L575" title="All 4 branches missed.">            if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_MODULAR_ARMOR)) {</span>
<span class="nc" id="L576">                modularArmor += mounted.getBaseDamageCapacity() - mounted.getDamageTaken();</span>
            }
<span class="nc" id="L578">        }</span>

        // no use for armor mods right now but in case we need one later
<span class="nc" id="L581">        double armorMod = 1.0;</span>

<span class="nc" id="L583">        bvText.append(startTable);</span>
<span class="nc" id="L584">        bvText.append(startRow);</span>
<span class="nc" id="L585">        bvText.append(startColumn);</span>

<span class="nc" id="L587">        bvText.append(&quot;Total Armor Factor x 2.5 x&quot;);</span>
<span class="nc" id="L588">        bvText.append(armorMod);</span>
<span class="nc" id="L589">        bvText.append(endColumn);</span>
<span class="nc" id="L590">        bvText.append(startColumn);</span>

<span class="nc" id="L592">        dbv += (getTotalArmor() + modularArmor);</span>

<span class="nc" id="L594">        bvText.append(dbv);</span>
<span class="nc" id="L595">        bvText.append(&quot; x 2.5 x &quot;);</span>
<span class="nc" id="L596">        bvText.append(armorMod);</span>
<span class="nc" id="L597">        bvText.append(endColumn);</span>
<span class="nc" id="L598">        bvText.append(startColumn);</span>
<span class="nc" id="L599">        bvText.append(&quot;= &quot;);</span>

<span class="nc" id="L601">        dbv *= 2.5 * armorMod;</span>

<span class="nc" id="L603">        bvText.append(dbv);</span>
<span class="nc" id="L604">        bvText.append(endColumn);</span>
<span class="nc" id="L605">        bvText.append(endRow);</span>

<span class="nc" id="L607">        bvText.append(startRow);</span>
<span class="nc" id="L608">        bvText.append(startColumn);</span>

<span class="nc" id="L610">        bvText.append(&quot;Total SI x 2&quot;);</span>
<span class="nc" id="L611">        bvText.append(endColumn);</span>
<span class="nc" id="L612">        bvText.append(startColumn);</span>

<span class="nc" id="L614">        double dbvSI = getSI() * 2.0;</span>
<span class="nc" id="L615">        dbv += dbvSI;</span>

<span class="nc" id="L617">        bvText.append(getSI());</span>
<span class="nc" id="L618">        bvText.append(&quot; x 2&quot;);</span>
<span class="nc" id="L619">        bvText.append(endColumn);</span>
<span class="nc" id="L620">        bvText.append(startColumn);</span>
<span class="nc" id="L621">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L622">        bvText.append(dbvSI);</span>
<span class="nc" id="L623">        bvText.append(endColumn);</span>
<span class="nc" id="L624">        bvText.append(endRow);</span>

        // add defensive equipment
<span class="nc" id="L627">        double amsBV = 0;</span>
<span class="nc" id="L628">        double amsAmmoBV = 0;</span>
<span class="nc" id="L629">        double screenBV = 0;</span>
<span class="nc" id="L630">        double screenAmmoBV = 0;</span>
<span class="nc" id="L631">        double defEqBV = 0;</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L633">            EquipmentType etype = mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L637">                continue;</span>
            }
<span class="nc bnc" id="L639" title="All 2 branches missed.">            if (etype instanceof BayWeapon) {</span>
<span class="nc" id="L640">                continue;</span>
            }
<span class="nc bnc" id="L642" title="All 4 branches missed.">            if (((etype instanceof WeaponType) &amp;&amp; (etype.hasFlag(WeaponType.F_AMS)))) {</span>
<span class="nc" id="L643">                amsBV += etype.getBV(this);</span>
<span class="nc" id="L644">                bvText.append(startRow);</span>
<span class="nc" id="L645">                bvText.append(startColumn);</span>
<span class="nc" id="L646">                bvText.append(etype.getName());</span>
<span class="nc" id="L647">                bvText.append(endColumn);</span>
<span class="nc" id="L648">                bvText.append(startColumn);</span>
<span class="nc" id="L649">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L650">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L651">                bvText.append(endColumn);</span>
<span class="nc" id="L652">                bvText.append(startColumn);</span>
<span class="nc" id="L653">                bvText.append(endColumn);</span>
<span class="nc" id="L654">                bvText.append(endRow);</span>
<span class="nc bnc" id="L655" title="All 4 branches missed.">            } else if ((etype instanceof AmmoType) &amp;&amp; (((AmmoType) etype).getAmmoType() == AmmoType.T_AMS)) {</span>
                // we need to deal with cases where ammo is loaded in multi-ton
                // increments
                // (on dropships and jumpships) - lets take the ratio of shots
                // to shots left
<span class="nc" id="L660">                double ratio = mounted.getUsableShotsLeft() / ((AmmoType) etype).getShots();</span>

                // if the ratio is less than one, we will treat as a full ton
                // since
                // we don't make that adjustment elsewhere
<span class="nc bnc" id="L665" title="All 2 branches missed.">                if (ratio &lt; 1.0) {</span>
<span class="nc" id="L666">                    ratio = 1.0;</span>
                }
<span class="nc" id="L668">                amsAmmoBV += ratio * etype.getBV(this);</span>
<span class="nc" id="L669">                bvText.append(startRow);</span>
<span class="nc" id="L670">                bvText.append(startColumn);</span>
<span class="nc" id="L671">                bvText.append(etype.getName());</span>
<span class="nc" id="L672">                bvText.append(endColumn);</span>
<span class="nc" id="L673">                bvText.append(startColumn);</span>
<span class="nc" id="L674">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L675">                bvText.append(ratio * etype.getBV(this));</span>
<span class="nc" id="L676">                bvText.append(endColumn);</span>
<span class="nc" id="L677">                bvText.append(startColumn);</span>
<span class="nc" id="L678">                bvText.append(endColumn);</span>
<span class="nc" id="L679">                bvText.append(endRow);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">            } else if ((etype instanceof AmmoType)</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                    &amp;&amp; (((AmmoType) etype).getAmmoType() == AmmoType.T_SCREEN_LAUNCHER)) {</span>
                // we need to deal with cases where ammo is loaded in multi-ton
                // increments
                // (on dropships and jumpships) - lets take the ratio of shots
                // to shots left
<span class="nc" id="L686">                double ratio = mounted.getUsableShotsLeft() / ((AmmoType) etype).getShots();</span>

                // if the ratio is less than one, we will treat as a full ton
                // since
                // we don't make that adjustment elsewhere
<span class="nc bnc" id="L691" title="All 2 branches missed.">                if (ratio &lt; 1.0) {</span>
<span class="nc" id="L692">                    ratio = 1.0;</span>
                }
<span class="nc" id="L694">                screenAmmoBV += ratio * etype.getBV(this);</span>
<span class="nc" id="L695">                bvText.append(startRow);</span>
<span class="nc" id="L696">                bvText.append(startColumn);</span>
<span class="nc" id="L697">                bvText.append(etype.getName());</span>
<span class="nc" id="L698">                bvText.append(endColumn);</span>
<span class="nc" id="L699">                bvText.append(startColumn);</span>
<span class="nc" id="L700">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L701">                bvText.append(ratio * etype.getBV(this));</span>
<span class="nc" id="L702">                bvText.append(endColumn);</span>
<span class="nc" id="L703">                bvText.append(startColumn);</span>
<span class="nc" id="L704">                bvText.append(endColumn);</span>
<span class="nc" id="L705">                bvText.append(endRow);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">            } else if ((etype instanceof WeaponType)</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                    &amp;&amp; (((WeaponType) etype).getAtClass() == WeaponType.CLASS_SCREEN)) {</span>
<span class="nc" id="L708">                screenBV += etype.getBV(this);</span>
<span class="nc" id="L709">                bvText.append(startRow);</span>
<span class="nc" id="L710">                bvText.append(startColumn);</span>
<span class="nc" id="L711">                bvText.append(etype.getName());</span>
<span class="nc" id="L712">                bvText.append(endColumn);</span>
<span class="nc" id="L713">                bvText.append(startColumn);</span>
<span class="nc" id="L714">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L715">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L716">                bvText.append(endColumn);</span>
<span class="nc" id="L717">                bvText.append(startColumn);</span>
<span class="nc" id="L718">                bvText.append(endColumn);</span>
<span class="nc" id="L719">                bvText.append(endRow);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">            } else if ((etype instanceof MiscType)</span>
<span class="nc bnc" id="L721" title="All 4 branches missed.">                    &amp;&amp; (etype.hasFlag(MiscType.F_ECM) || etype.hasFlag(MiscType.F_BAP))) {</span>
<span class="nc" id="L722">                defEqBV += etype.getBV(this);</span>
<span class="nc" id="L723">                bvText.append(startRow);</span>
<span class="nc" id="L724">                bvText.append(startColumn);</span>
<span class="nc" id="L725">                bvText.append(mounted.getName());</span>
<span class="nc" id="L726">                bvText.append(endColumn);</span>
<span class="nc" id="L727">                bvText.append(startColumn);</span>
<span class="nc" id="L728">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L729">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L730">                bvText.append(endColumn);</span>
<span class="nc" id="L731">                bvText.append(startColumn);</span>
<span class="nc" id="L732">                bvText.append(endColumn);</span>
<span class="nc" id="L733">                bvText.append(endRow);</span>
            }
<span class="nc" id="L735">        }</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (amsBV &gt; 0) {</span>
<span class="nc" id="L737">            bvText.append(startRow);</span>
<span class="nc" id="L738">            bvText.append(startColumn);</span>
<span class="nc" id="L739">            bvText.append(&quot;Total AMS BV:&quot;);</span>
<span class="nc" id="L740">            bvText.append(endColumn);</span>
<span class="nc" id="L741">            bvText.append(startColumn);</span>
<span class="nc" id="L742">            bvText.append(endColumn);</span>
<span class="nc" id="L743">            bvText.append(startColumn);</span>
<span class="nc" id="L744">            bvText.append(amsBV);</span>
<span class="nc" id="L745">            dbv += amsBV;</span>
<span class="nc" id="L746">            bvText.append(endColumn);</span>
<span class="nc" id="L747">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (screenBV &gt; 0) {</span>
<span class="nc" id="L750">            bvText.append(startRow);</span>
<span class="nc" id="L751">            bvText.append(startColumn);</span>
<span class="nc" id="L752">            bvText.append(&quot;Total Screen BV:&quot;);</span>
<span class="nc" id="L753">            bvText.append(endColumn);</span>
<span class="nc" id="L754">            bvText.append(startColumn);</span>
<span class="nc" id="L755">            bvText.append(endColumn);</span>
<span class="nc" id="L756">            bvText.append(startColumn);</span>
<span class="nc" id="L757">            bvText.append(screenBV);</span>
<span class="nc" id="L758">            dbv += screenBV;</span>
<span class="nc" id="L759">            bvText.append(endColumn);</span>
<span class="nc" id="L760">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (amsAmmoBV &gt; 0) {</span>
<span class="nc" id="L763">            bvText.append(startRow);</span>
<span class="nc" id="L764">            bvText.append(startColumn);</span>
<span class="nc" id="L765">            bvText.append(&quot;Total AMS Ammo BV (to a maximum of AMS BV):&quot;);</span>
<span class="nc" id="L766">            bvText.append(endColumn);</span>
<span class="nc" id="L767">            bvText.append(startColumn);</span>
<span class="nc" id="L768">            bvText.append(endColumn);</span>
<span class="nc" id="L769">            bvText.append(startColumn);</span>
<span class="nc" id="L770">            bvText.append(Math.min(amsBV, amsAmmoBV));</span>
<span class="nc" id="L771">            dbv += Math.min(amsBV, amsAmmoBV);</span>
<span class="nc" id="L772">            bvText.append(endColumn);</span>
<span class="nc" id="L773">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L775" title="All 2 branches missed.">        if (screenAmmoBV &gt; 0) {</span>
<span class="nc" id="L776">            bvText.append(startRow);</span>
<span class="nc" id="L777">            bvText.append(startColumn);</span>
<span class="nc" id="L778">            bvText.append(&quot;Total Screen Ammo BV (to a maximum of Screen BV):&quot;);</span>
<span class="nc" id="L779">            bvText.append(endColumn);</span>
<span class="nc" id="L780">            bvText.append(startColumn);</span>
<span class="nc" id="L781">            bvText.append(endColumn);</span>
<span class="nc" id="L782">            bvText.append(startColumn);</span>
<span class="nc" id="L783">            bvText.append(Math.min(screenBV, screenAmmoBV));</span>
<span class="nc" id="L784">            dbv += Math.min(screenBV, screenAmmoBV);</span>
<span class="nc" id="L785">            bvText.append(endColumn);</span>
<span class="nc" id="L786">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L788" title="All 2 branches missed.">        if (defEqBV &gt; 0) {</span>
<span class="nc" id="L789">            bvText.append(startRow);</span>
<span class="nc" id="L790">            bvText.append(startColumn);</span>
<span class="nc" id="L791">            bvText.append(&quot;Total misc defensive equipment BV:&quot;);</span>
<span class="nc" id="L792">            bvText.append(endColumn);</span>
<span class="nc" id="L793">            bvText.append(startColumn);</span>
<span class="nc" id="L794">            bvText.append(endColumn);</span>
<span class="nc" id="L795">            bvText.append(startColumn);</span>
<span class="nc" id="L796">            bvText.append(defEqBV);</span>
<span class="nc" id="L797">            dbv += defEqBV;</span>
<span class="nc" id="L798">            bvText.append(endColumn);</span>
<span class="nc" id="L799">            bvText.append(endRow);</span>
        }

<span class="nc" id="L802">        bvText.append(startRow);</span>
<span class="nc" id="L803">        bvText.append(startColumn);</span>
<span class="nc" id="L804">        bvText.append(endColumn);</span>
<span class="nc" id="L805">        bvText.append(startColumn);</span>
<span class="nc" id="L806">        bvText.append(endColumn);</span>
<span class="nc" id="L807">        bvText.append(startColumn);</span>
<span class="nc" id="L808">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L809">        bvText.append(endColumn);</span>
<span class="nc" id="L810">        bvText.append(endRow);</span>

<span class="nc" id="L812">        bvText.append(startRow);</span>
<span class="nc" id="L813">        bvText.append(startColumn);</span>
<span class="nc" id="L814">        bvText.append(endColumn);</span>
<span class="nc" id="L815">        bvText.append(startColumn);</span>
<span class="nc" id="L816">        bvText.append(endColumn);</span>
<span class="nc" id="L817">        bvText.append(startColumn);</span>
<span class="nc" id="L818">        bvText.append(dbv);</span>
<span class="nc" id="L819">        bvText.append(endColumn);</span>
<span class="nc" id="L820">        bvText.append(endRow);</span>

        // unit type multiplier
<span class="nc" id="L823">        bvText.append(startRow);</span>
<span class="nc" id="L824">        bvText.append(startColumn);</span>
<span class="nc" id="L825">        bvText.append(&quot;Multiply by Unit type Modifier&quot;);</span>
<span class="nc" id="L826">        bvText.append(endColumn);</span>
<span class="nc" id="L827">        bvText.append(startColumn);</span>
<span class="nc" id="L828">        bvText.append(getBVTypeModifier());</span>
<span class="nc" id="L829">        dbv *= getBVTypeModifier();</span>
<span class="nc" id="L830">        bvText.append(endColumn);</span>
<span class="nc" id="L831">        bvText.append(startColumn);</span>
<span class="nc" id="L832">        bvText.append(&quot;x&quot; + getBVTypeModifier());</span>
<span class="nc" id="L833">        bvText.append(endColumn);</span>
<span class="nc" id="L834">        bvText.append(endRow);</span>

<span class="nc" id="L836">        bvText.append(startRow);</span>
<span class="nc" id="L837">        bvText.append(startColumn);</span>
<span class="nc" id="L838">        bvText.append(endColumn);</span>
<span class="nc" id="L839">        bvText.append(startColumn);</span>
<span class="nc" id="L840">        bvText.append(endColumn);</span>
<span class="nc" id="L841">        bvText.append(startColumn);</span>
<span class="nc" id="L842">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L843">        bvText.append(endColumn);</span>
<span class="nc" id="L844">        bvText.append(endRow);</span>

<span class="nc" id="L846">        bvText.append(startRow);</span>
<span class="nc" id="L847">        bvText.append(startColumn);</span>
<span class="nc" id="L848">        bvText.append(endColumn);</span>
<span class="nc" id="L849">        bvText.append(startColumn);</span>
<span class="nc" id="L850">        bvText.append(endColumn);</span>
<span class="nc" id="L851">        bvText.append(startColumn);</span>
<span class="nc" id="L852">        bvText.append(dbv);</span>
<span class="nc" id="L853">        bvText.append(endColumn);</span>
<span class="nc" id="L854">        bvText.append(endRow);</span>

<span class="nc" id="L856">        bvText.append(startRow);</span>
<span class="nc" id="L857">        bvText.append(startColumn);</span>

<span class="nc" id="L859">        bvText.append(&quot;&lt;b&gt;Offensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L860">        bvText.append(endColumn);</span>
<span class="nc" id="L861">        bvText.append(startColumn);</span>
<span class="nc" id="L862">        bvText.append(endColumn);</span>
<span class="nc" id="L863">        bvText.append(startColumn);</span>
<span class="nc" id="L864">        bvText.append(endColumn);</span>
<span class="nc" id="L865">        bvText.append(endRow);</span>

        // calculate heat efficiency
<span class="nc" id="L868">        int aeroHeatEfficiency = getHeatCapacity();</span>

<span class="nc" id="L870">        bvText.append(startRow);</span>
<span class="nc" id="L871">        bvText.append(startColumn);</span>

<span class="nc" id="L873">        bvText.append(&quot;Base Heat Efficiency &quot;);</span>

<span class="nc" id="L875">        bvText.append(endColumn);</span>
<span class="nc" id="L876">        bvText.append(startColumn);</span>
<span class="nc" id="L877">        bvText.append(aeroHeatEfficiency);</span>

<span class="nc" id="L879">        bvText.append(endColumn);</span>
<span class="nc" id="L880">        bvText.append(endRow);</span>

        // get arc BV and heat
        // I am going to redo how I do this to cycle through locations, so I can
        // spit it out
        // to bvText. It will require a little trickery for rear LS/RS since
        // those technically are not
        // locations
<span class="nc" id="L888">        double[] arcBVs = new double[locations() + 2];</span>
<span class="nc" id="L889">        double[] arcHeats = new double[locations() + 2];</span>
<span class="nc" id="L890">        double[] ammoBVs = new double[locations() + 2];</span>

<span class="nc" id="L892">        bvText.append(startRow);</span>
<span class="nc" id="L893">        bvText.append(startColumn);</span>
<span class="nc" id="L894">        bvText.append(&quot;Arc BV and Heat&quot;);</span>
<span class="nc" id="L895">        bvText.append(endColumn);</span>
<span class="nc" id="L896">        bvText.append(endRow);</span>

        // cycle through locations
<span class="nc bnc" id="L899" title="All 2 branches missed.">        for (int loc = 0; loc &lt; (locations() + 2); loc++) {</span>
<span class="nc" id="L900">            int l = loc;</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">            boolean isRear = (loc &gt;= locations());</span>
<span class="nc" id="L902">            String rear = &quot;&quot;;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">            if (isRear) {</span>
<span class="nc" id="L904">                l = l - 3;</span>
<span class="nc" id="L905">                rear = &quot; (R)&quot;;</span>
            }
<span class="nc" id="L907">            this.getLocationName(l);</span>

<span class="nc" id="L909">            bvText.append(startRow);</span>
<span class="nc" id="L910">            bvText.append(startColumn);</span>
<span class="nc" id="L911">            bvText.append(&quot;&lt;i&gt;&quot; + getLocationName(l) + rear + &quot;&lt;/i&gt;&quot;);</span>
<span class="nc" id="L912">            bvText.append(endColumn);</span>
<span class="nc" id="L913">            bvText.append(startColumn);</span>
<span class="nc" id="L914">            bvText.append(&quot;&lt;i&gt;BV&lt;/i&gt;&quot;);</span>
<span class="nc" id="L915">            bvText.append(endColumn);</span>
<span class="nc" id="L916">            bvText.append(startColumn);</span>
<span class="nc" id="L917">            bvText.append(&quot;&lt;i&gt;Heat&lt;/i&gt;&quot;);</span>
<span class="nc" id="L918">            bvText.append(endColumn);</span>
<span class="nc" id="L919">            bvText.append(endRow);</span>
<span class="nc" id="L920">            double arcBV = 0.0;</span>
<span class="nc" id="L921">            double arcHeat = 0.0;</span>
<span class="nc" id="L922">            double arcAmmoBV = 0.0;</span>
<span class="nc" id="L923">            TreeMap&lt;String, Double&gt; weaponsForExcessiveAmmo = new TreeMap&lt;String, Double&gt;();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">            for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">                if (mounted.getLocation() != l) {</span>
<span class="nc" id="L926">                    continue;</span>
                }
<span class="nc bnc" id="L928" title="All 2 branches missed.">                if (mounted.isRearMounted() != isRear) {</span>
<span class="nc" id="L929">                    continue;</span>
                }
                // only count non-damaged equipment
<span class="nc bnc" id="L932" title="All 8 branches missed.">                if (mounted.isMissing() || mounted.isHit() || mounted.isDestroyed() || mounted.isBreached()) {</span>
<span class="nc" id="L933">                    continue;</span>
                }
<span class="nc" id="L935">                WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L936">                double weaponHeat = wtype.getHeat();</span>
<span class="nc" id="L937">                double dBV = wtype.getBV(this);</span>
                // skip bays
<span class="nc bnc" id="L939" title="All 2 branches missed.">                if (wtype instanceof BayWeapon) {</span>
<span class="nc" id="L940">                    continue;</span>
                }
                // don't count defensive weapons
<span class="nc bnc" id="L943" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L944">                    continue;</span>
                }
                // don't count screen launchers, they are defensive
<span class="nc bnc" id="L947" title="All 2 branches missed.">                if (wtype.getAtClass() == WeaponType.CLASS_SCREEN) {</span>
<span class="nc" id="L948">                    continue;</span>
                }
                // double heat for ultras
<span class="nc bnc" id="L951" title="All 4 branches missed.">                if ((wtype.getAmmoType() == AmmoType.T_AC_ULTRA) || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)) {</span>
<span class="nc" id="L952">                    weaponHeat *= 2;</span>
                }
                // Six times heat for RAC
<span class="nc bnc" id="L955" title="All 2 branches missed.">                if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L956">                    weaponHeat *= 6;</span>
                }
                // calc MG Array here:
<span class="nc bnc" id="L959" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L960">                    double mgBV = 0;</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">                    for (int eqNum : mounted.getBayWeapons()) {</span>
<span class="nc" id="L962">                        Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L963" title="All 4 branches missed.">                        if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L964">                            mgBV += mg.getType().getBV(this);</span>
                        }
<span class="nc" id="L966">                    }</span>
<span class="nc" id="L967">                    dBV = mgBV * 0.67;</span>
                }
                // and we'll add the tcomp here too
<span class="nc bnc" id="L970" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_DIRECT_FIRE)) {</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                    if (hasTargComp()) {</span>
<span class="nc" id="L972">                        dBV *= 1.25;</span>
                    }
                }
                // artemis bumps up the value
<span class="nc bnc" id="L976" title="All 2 branches missed.">                if (mounted.getLinkedBy() != null) {</span>
<span class="nc" id="L977">                    Mounted mLinker = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L978" title="All 4 branches missed.">                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</span>
<span class="nc" id="L979">                        dBV *= 1.2;</span>
                    }
<span class="nc bnc" id="L981" title="All 4 branches missed.">                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_PROTO)) {</span>
<span class="nc" id="L982">                        dBV *= 1.1;</span>
                    }
                    
<span class="nc bnc" id="L985" title="All 4 branches missed.">                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</span>
<span class="nc" id="L986">                        dBV *= 1.3;</span>
                    }
<span class="nc bnc" id="L988" title="All 4 branches missed.">                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</span>
<span class="nc" id="L989">                        dBV *= 1.15;</span>
                    }
<span class="nc bnc" id="L991" title="All 2 branches missed.">                    if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">                            &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L993">                        dBV *= 1.15;</span>
                    }
                }
                // add up BV of ammo-using weapons for each type of weapon,
                // to compare with ammo BV later for excessive ammo BV rule
<span class="nc bnc" id="L998" title="All 4 branches missed.">                if (!((wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !(wtype.getAmmoType() == AmmoType.T_PLASMA))</span>
<span class="nc bnc" id="L999" title="All 4 branches missed.">                        || wtype.hasFlag(WeaponType.F_ONESHOT) || wtype.hasFlag(WeaponType.F_INFANTRY)</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_NA))) {</span>
<span class="nc" id="L1001">                    String key = wtype.getAmmoType() + &quot;:&quot; + wtype.getRackSize();</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                    if (!weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L1003">                        weaponsForExcessiveAmmo.put(key, wtype.getBV(this));</span>
                    } else {
<span class="nc" id="L1005">                        weaponsForExcessiveAmmo.put(key, wtype.getBV(this) + weaponsForExcessiveAmmo.get(key));</span>
                    }
                }
<span class="nc" id="L1008">                bvText.append(startRow);</span>
<span class="nc" id="L1009">                bvText.append(startColumn);</span>
<span class="nc" id="L1010">                bvText.append(wtype.getName());</span>
<span class="nc" id="L1011">                bvText.append(endColumn);</span>
<span class="nc" id="L1012">                bvText.append(startColumn);</span>
<span class="nc" id="L1013">                bvText.append(&quot;+&quot; + dBV);</span>
<span class="nc" id="L1014">                bvText.append(endColumn);</span>
<span class="nc" id="L1015">                bvText.append(startColumn);</span>
<span class="nc" id="L1016">                bvText.append(&quot;+&quot; + weaponHeat);</span>
<span class="nc" id="L1017">                bvText.append(endColumn);</span>
<span class="nc" id="L1018">                bvText.append(endRow);</span>
<span class="nc" id="L1019">                arcBV += dBV;</span>
<span class="nc" id="L1020">                arcHeat += weaponHeat;</span>
<span class="nc" id="L1021">            }</span>
            // now ammo
<span class="nc" id="L1023">            Map&lt;String, Double&gt; ammo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L1024">            ArrayList&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">            for (Mounted mounted : getAmmo()) {</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">                if (mounted.getLocation() != l) {</span>
<span class="nc" id="L1027">                    continue;</span>
                }
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                if (mounted.isRearMounted() != isRear) {</span>
<span class="nc" id="L1030">                    continue;</span>
                }
<span class="nc" id="L1032">                AmmoType atype = (AmmoType) mounted.getType();</span>
                // we need to deal with cases where ammo is loaded in multi-ton
                // increments
                // (on dropships and jumpships) - lets take the ratio of shots
                // to
                // shots left
<span class="nc" id="L1038">                double ratio = mounted.getUsableShotsLeft() / atype.getShots();</span>

                // if the ratio is less than one, we will treat as a full ton
                // since
                // we don't make that adjustment elsewhere
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                if (ratio &lt; 1.0) {</span>
<span class="nc" id="L1044">                    ratio = 1.0;</span>
                }

                // don't count depleted ammo
<span class="nc bnc" id="L1048" title="All 2 branches missed.">                if (mounted.getUsableShotsLeft() == 0) {</span>
<span class="nc" id="L1049">                    continue;</span>
                }

                // don't count AMS, it's defensive
<span class="nc bnc" id="L1053" title="All 2 branches missed.">                if (atype.getAmmoType() == AmmoType.T_AMS) {</span>
<span class="nc" id="L1054">                    continue;</span>
                }
                // don't count screen launchers, they are defensive
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                if (atype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER) {</span>
<span class="nc" id="L1058">                    continue;</span>
                }

                // don't count oneshot ammo, it's considered part of the
                // launcher.
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                if (mounted.getLocation() == Entity.LOC_NONE) {</span>
                    // assumption: ammo without a location is for a oneshot
                    // weapon
<span class="nc" id="L1066">                    continue;</span>
                }
<span class="nc" id="L1068">                double abv = ratio * atype.getBV(this);</span>
<span class="nc" id="L1069">                String key = atype.getAmmoType() + &quot;:&quot; + atype.getRackSize();</span>
<span class="nc" id="L1070">                String key2 = atype.getName() + &quot;;&quot; + key;</span>
                // MML needs special casing so they don't count double
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                if (atype.getAmmoType() == AmmoType.T_MML) {</span>
<span class="nc" id="L1073">                    key2 = &quot;MML &quot; + atype.getRackSize() + &quot; Ammo;&quot; + key;</span>
                }
                // same for the different AR10 ammos
<span class="nc bnc" id="L1076" title="All 2 branches missed.">                if (atype.getAmmoType() == AmmoType.T_AR10) {</span>
<span class="nc" id="L1077">                    key2 = &quot;AR10 Ammo;&quot; + key;</span>
                }
<span class="nc bnc" id="L1079" title="All 2 branches missed.">                if (!keys.contains(key2)) {</span>
<span class="nc" id="L1080">                    keys.add(key2);</span>
                }
<span class="nc bnc" id="L1082" title="All 2 branches missed.">                if (!ammo.containsKey(key)) {</span>
<span class="nc" id="L1083">                    ammo.put(key, abv);</span>
                } else {
<span class="nc" id="L1085">                    ammo.put(key, abv + ammo.get(key));</span>
                }
<span class="nc" id="L1087">            }</span>
            // now cycle through ammo hash and deal with excessive ammo issues
<span class="nc bnc" id="L1089" title="All 2 branches missed.">            for (String fullkey : keys) {</span>
<span class="nc" id="L1090">                String[] k = fullkey.split(&quot;;&quot;);</span>
<span class="nc" id="L1091">                String key = k[1];</span>
<span class="nc" id="L1092">                bvText.append(startRow);</span>
<span class="nc" id="L1093">                bvText.append(startColumn);</span>
<span class="nc" id="L1094">                bvText.append(k[0]);</span>
<span class="nc" id="L1095">                bvText.append(endColumn);</span>
<span class="nc" id="L1096">                bvText.append(startColumn);</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">                if (weaponsForExcessiveAmmo.get(key) != null) {</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">                    if (ammo.get(key) &gt; weaponsForExcessiveAmmo.get(key)) {</span>
<span class="nc" id="L1099">                        bvText.append(&quot;+&quot; + weaponsForExcessiveAmmo.get(key) + &quot;*&quot;);</span>
<span class="nc" id="L1100">                        arcAmmoBV += weaponsForExcessiveAmmo.get(key);</span>
                    } else {
<span class="nc" id="L1102">                        bvText.append(&quot;+&quot; + ammo.get(key));</span>
<span class="nc" id="L1103">                        arcAmmoBV += ammo.get(key);</span>
                    }
                }
<span class="nc" id="L1106">                bvText.append(endColumn);</span>
<span class="nc" id="L1107">                bvText.append(startColumn);</span>
<span class="nc" id="L1108">                bvText.append(&quot;&quot;);</span>
<span class="nc" id="L1109">                bvText.append(endColumn);</span>
<span class="nc" id="L1110">                bvText.append(endRow);</span>
<span class="nc" id="L1111">            }</span>
<span class="nc" id="L1112">            bvText.append(startRow);</span>
<span class="nc" id="L1113">            bvText.append(startColumn);</span>
<span class="nc" id="L1114">            bvText.append(&quot;&lt;b&gt;&quot; + getLocationName(l) + rear + &quot; Weapon Totals&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1115">            bvText.append(endColumn);</span>
<span class="nc" id="L1116">            bvText.append(startColumn);</span>
<span class="nc" id="L1117">            bvText.append(&quot;&lt;b&gt;&quot; + arcBV + &quot;&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1118">            bvText.append(endColumn);</span>
<span class="nc" id="L1119">            bvText.append(startColumn);</span>
<span class="nc" id="L1120">            bvText.append(&quot;&lt;b&gt;&quot; + arcHeat + &quot;&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1121">            bvText.append(endColumn);</span>
<span class="nc" id="L1122">            bvText.append(endRow);</span>
<span class="nc" id="L1123">            bvText.append(startRow);</span>
<span class="nc" id="L1124">            bvText.append(startColumn);</span>
<span class="nc" id="L1125">            bvText.append(&quot;&lt;b&gt;&quot; + getLocationName(l) + rear + &quot; Ammo Totals&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1126">            bvText.append(endColumn);</span>
<span class="nc" id="L1127">            bvText.append(startColumn);</span>
<span class="nc" id="L1128">            bvText.append(&quot;&lt;b&gt;&quot; + arcAmmoBV + &quot;&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1129">            bvText.append(endColumn);</span>
<span class="nc" id="L1130">            bvText.append(startColumn);</span>
<span class="nc" id="L1131">            bvText.append(&quot;&quot;);</span>
<span class="nc" id="L1132">            bvText.append(endColumn);</span>
<span class="nc" id="L1133">            bvText.append(endRow);</span>
<span class="nc" id="L1134">            bvText.append(startRow);</span>
<span class="nc" id="L1135">            bvText.append(startColumn);</span>
<span class="nc" id="L1136">            bvText.append(&quot;&lt;b&gt;&quot; + getLocationName(l) + rear + &quot; Totals&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1137">            bvText.append(endColumn);</span>
<span class="nc" id="L1138">            bvText.append(startColumn);</span>
<span class="nc" id="L1139">            double tempBV = arcBV + arcAmmoBV;</span>
<span class="nc" id="L1140">            bvText.append(&quot;&lt;b&gt;&quot; + tempBV + &quot;&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1141">            bvText.append(endColumn);</span>
<span class="nc" id="L1142">            bvText.append(startColumn);</span>
<span class="nc" id="L1143">            bvText.append(&quot;&quot;);</span>
<span class="nc" id="L1144">            bvText.append(endColumn);</span>
<span class="nc" id="L1145">            bvText.append(endRow);</span>
<span class="nc" id="L1146">            arcBVs[loc] = arcBV;</span>
<span class="nc" id="L1147">            arcHeats[loc] = arcHeat;</span>
<span class="nc" id="L1148">            ammoBVs[loc] = arcAmmoBV;</span>
        }

<span class="nc" id="L1151">        double weaponBV = 0.0;</span>
        // ok, now lets loop through the arcs and find the highest value BV arc
<span class="nc" id="L1153">        int highArc = Integer.MIN_VALUE;</span>
<span class="nc" id="L1154">        int adjArcH = Integer.MIN_VALUE;</span>
<span class="nc" id="L1155">        int adjArcL = Integer.MIN_VALUE;</span>
<span class="nc" id="L1156">        double adjArcHMult = 1.0;</span>
<span class="nc" id="L1157">        double adjArcLMult = 0.5;</span>
<span class="nc" id="L1158">        double highBV = 0.0;</span>
<span class="nc" id="L1159">        double heatUsed = 0.0;</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">        for (int loc = 0; loc &lt; arcBVs.length; loc++) {</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">            if (arcBVs[loc] &gt; highBV) {</span>
<span class="nc" id="L1162">                highArc = loc;</span>
<span class="nc" id="L1163">                highBV = arcBVs[loc];</span>
            }
        }
        // now lets identify the adjacent arcs
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (highArc &gt; Integer.MIN_VALUE) {</span>
<span class="nc" id="L1168">            heatUsed += arcHeats[highArc];</span>
            // now get the BV and heat for the two adjacent arcs
<span class="nc" id="L1170">            int adjArcCW = getAdjacentLocCW(highArc);</span>
<span class="nc" id="L1171">            int adjArcCCW = getAdjacentLocCCW(highArc);</span>
<span class="nc" id="L1172">            double adjArcCWBV = 0.0;</span>
<span class="nc" id="L1173">            double adjArcCWHeat = 0.0;</span>
<span class="nc bnc" id="L1174" title="All 2 branches missed.">            if (adjArcCW &gt; Integer.MIN_VALUE) {</span>
<span class="nc" id="L1175">                adjArcCWBV = arcBVs[adjArcCW];</span>
<span class="nc" id="L1176">                adjArcCWHeat = arcHeats[adjArcCW];</span>
            }
<span class="nc" id="L1178">            double adjArcCCWBV = 0.0;</span>
<span class="nc" id="L1179">            double adjArcCCWHeat = 0.0;</span>
<span class="nc bnc" id="L1180" title="All 2 branches missed.">            if (adjArcCCW &gt; Integer.MIN_VALUE) {</span>
<span class="nc" id="L1181">                adjArcCCWBV = arcBVs[adjArcCCW];</span>
<span class="nc" id="L1182">                adjArcCCWHeat = arcHeats[adjArcCCW];</span>
            }
<span class="nc bnc" id="L1184" title="All 2 branches missed.">            if (adjArcCWBV &gt; adjArcCCWBV) {</span>
<span class="nc" id="L1185">                adjArcH = adjArcCW;</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">                if ((heatUsed + adjArcCWHeat) &gt; aeroHeatEfficiency) {</span>
<span class="nc" id="L1187">                    adjArcHMult = 0.5;</span>
                }
<span class="nc" id="L1189">                heatUsed += adjArcCWHeat;</span>
<span class="nc" id="L1190">                adjArcL = adjArcCCW;</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">                if ((heatUsed + adjArcCCWHeat) &gt; aeroHeatEfficiency) {</span>
<span class="nc" id="L1192">                    adjArcLMult = 0.25;</span>
                }
<span class="nc" id="L1194">                heatUsed += adjArcCCWHeat;</span>
            } else {
<span class="nc" id="L1196">                adjArcH = adjArcCCW;</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">                if ((heatUsed + adjArcCCWHeat) &gt; aeroHeatEfficiency) {</span>
<span class="nc" id="L1198">                    adjArcHMult = 0.5;</span>
                }
<span class="nc" id="L1200">                heatUsed += adjArcCCWHeat;</span>
<span class="nc" id="L1201">                adjArcL = adjArcCW;</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">                if ((heatUsed + adjArcCWHeat) &gt; aeroHeatEfficiency) {</span>
<span class="nc" id="L1203">                    adjArcLMult = 0.25;</span>
                }
<span class="nc" id="L1205">                heatUsed += adjArcCWHeat;</span>
            }
        }

        // ok now add in ammo to arc bvs
<span class="nc bnc" id="L1210" title="All 2 branches missed.">        for (int i = 0; i &lt; arcBVs.length; i++) {</span>
<span class="nc" id="L1211">            arcBVs[i] = arcBVs[i] + ammoBVs[i];</span>
        }

        // ok now lets go in and add the arcs
<span class="nc" id="L1215">        double totalHeat = 0.0;</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        if (highArc &gt; Integer.MIN_VALUE) {</span>
            // ok now add the BV from this arc and reset to zero
<span class="nc" id="L1218">            bvText.append(startRow);</span>
<span class="nc" id="L1219">            bvText.append(startColumn);</span>
<span class="nc" id="L1220">            bvText.append(&quot;Highest BV Arc (&quot; + getArcName(highArc) + &quot;)&quot; + arcBVs[highArc] + &quot;*1.0&quot;);</span>
<span class="nc" id="L1221">            bvText.append(endColumn);</span>
<span class="nc" id="L1222">            bvText.append(startColumn);</span>
<span class="nc" id="L1223">            bvText.append(&quot;+&quot; + arcBVs[highArc]);</span>
<span class="nc" id="L1224">            bvText.append(endColumn);</span>
<span class="nc" id="L1225">            bvText.append(endRow);</span>
<span class="nc" id="L1226">            bvText.append(startColumn);</span>
<span class="nc" id="L1227">            totalHeat = arcHeats[highArc];</span>
<span class="nc" id="L1228">            bvText.append(&quot;Total Heat: &quot; + totalHeat);</span>
<span class="nc" id="L1229">            bvText.append(endColumn);</span>
<span class="nc" id="L1230">            bvText.append(endRow);</span>
<span class="nc" id="L1231">            weaponBV += arcBVs[highArc];</span>
<span class="nc" id="L1232">            arcBVs[highArc] = 0.0;</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">            if (adjArcH &gt; Integer.MIN_VALUE) {</span>
<span class="nc" id="L1234">                bvText.append(startRow);</span>
<span class="nc" id="L1235">                bvText.append(startColumn);</span>
<span class="nc" id="L1236">                bvText.append(</span>
<span class="nc" id="L1237">                        &quot;Adjacent High BV Arc (&quot; + getArcName(adjArcH) + &quot;) &quot; + arcBVs[adjArcH] + &quot;*&quot; + adjArcHMult);</span>
<span class="nc" id="L1238">                bvText.append(endColumn);</span>
<span class="nc" id="L1239">                bvText.append(startColumn);</span>
<span class="nc" id="L1240">                bvText.append(&quot;+&quot; + (arcBVs[adjArcH] * adjArcHMult));</span>
<span class="nc" id="L1241">                bvText.append(endColumn);</span>
<span class="nc" id="L1242">                bvText.append(endRow);</span>
<span class="nc" id="L1243">                bvText.append(startRow);</span>
<span class="nc" id="L1244">                bvText.append(startColumn);</span>
<span class="nc" id="L1245">                totalHeat += arcHeats[adjArcH];</span>
<span class="nc" id="L1246">                String over = &quot;&quot;;</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                if (totalHeat &gt; aeroHeatEfficiency) {</span>
<span class="nc" id="L1248">                    over = &quot; (Greater than heat efficiency)&quot;;</span>
                }
<span class="nc" id="L1250">                bvText.append(&quot;Total Heat: &quot; + totalHeat + over);</span>
<span class="nc" id="L1251">                bvText.append(endColumn);</span>
<span class="nc" id="L1252">                bvText.append(endRow);</span>
<span class="nc" id="L1253">                weaponBV += adjArcHMult * arcBVs[adjArcH];</span>
<span class="nc" id="L1254">                arcBVs[adjArcH] = 0.0;</span>
            }
<span class="nc bnc" id="L1256" title="All 2 branches missed.">            if (adjArcL &gt; Integer.MIN_VALUE) {</span>
<span class="nc" id="L1257">                bvText.append(startRow);</span>
<span class="nc" id="L1258">                bvText.append(startColumn);</span>
<span class="nc" id="L1259">                bvText.append(</span>
<span class="nc" id="L1260">                        &quot;Adjacent Low BV Arc (&quot; + getArcName(adjArcL) + &quot;) &quot; + arcBVs[adjArcL] + &quot;*&quot; + adjArcLMult);</span>
<span class="nc" id="L1261">                bvText.append(endColumn);</span>
<span class="nc" id="L1262">                bvText.append(startColumn);</span>
<span class="nc" id="L1263">                bvText.append(&quot;+&quot; + (adjArcLMult * arcBVs[adjArcL]));</span>
<span class="nc" id="L1264">                bvText.append(endColumn);</span>
<span class="nc" id="L1265">                bvText.append(endRow);</span>
<span class="nc" id="L1266">                bvText.append(startRow);</span>
<span class="nc" id="L1267">                bvText.append(startColumn);</span>
<span class="nc" id="L1268">                totalHeat += arcHeats[adjArcL];</span>
<span class="nc" id="L1269">                String over = &quot;&quot;;</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">                if (totalHeat &gt; aeroHeatEfficiency) {</span>
<span class="nc" id="L1271">                    over = &quot; (Greater than heat efficiency)&quot;;</span>
                }
<span class="nc" id="L1273">                bvText.append(&quot;Total Heat: &quot; + totalHeat + over);</span>
<span class="nc" id="L1274">                bvText.append(endColumn);</span>
<span class="nc" id="L1275">                bvText.append(endRow);</span>
<span class="nc" id="L1276">                weaponBV += adjArcLMult * arcBVs[adjArcL];</span>
<span class="nc" id="L1277">                arcBVs[adjArcL] = 0.0;</span>
            }
            // ok now we can cycle through the rest and add 25%
<span class="nc" id="L1280">            bvText.append(startRow);</span>
<span class="nc" id="L1281">            bvText.append(startColumn);</span>
<span class="nc" id="L1282">            bvText.append(&quot;Remaining Arcs&quot;);</span>
<span class="nc" id="L1283">            bvText.append(endColumn);</span>
<span class="nc" id="L1284">            bvText.append(endRow);</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">            for (int loc = 0; loc &lt; arcBVs.length; loc++) {</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">                if (arcBVs[loc] &lt;= 0) {</span>
<span class="nc" id="L1287">                    continue;</span>
                }
<span class="nc" id="L1289">                bvText.append(startRow);</span>
<span class="nc" id="L1290">                bvText.append(startColumn);</span>
<span class="nc" id="L1291">                bvText.append(getArcName(loc) + &quot; &quot; + arcBVs[loc] + &quot;*0.25&quot;);</span>
<span class="nc" id="L1292">                bvText.append(endColumn);</span>
<span class="nc" id="L1293">                bvText.append(startColumn);</span>
<span class="nc" id="L1294">                bvText.append(&quot;+&quot; + (0.25 * arcBVs[loc]));</span>
<span class="nc" id="L1295">                bvText.append(endColumn);</span>
<span class="nc" id="L1296">                bvText.append(endRow);</span>
<span class="nc" id="L1297">                weaponBV += (0.25 * arcBVs[loc]);</span>
            }
        }

<span class="nc" id="L1301">        bvText.append(&quot;Total Weapons BV Adjusted For Heat:&quot;);</span>
<span class="nc" id="L1302">        bvText.append(endColumn);</span>
<span class="nc" id="L1303">        bvText.append(startColumn);</span>
<span class="nc" id="L1304">        bvText.append(endColumn);</span>
<span class="nc" id="L1305">        bvText.append(startColumn);</span>
<span class="nc" id="L1306">        bvText.append(weaponBV);</span>
<span class="nc" id="L1307">        bvText.append(endColumn);</span>
<span class="nc" id="L1308">        bvText.append(endRow);</span>

        // add offensive misc. equipment BV
<span class="nc" id="L1311">        double oEquipmentBV = 0;</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L1313">            MiscType mtype = (MiscType) mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1316" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1317">                continue;</span>
            }

<span class="nc bnc" id="L1320" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_TARGCOMP)) {</span>
<span class="nc" id="L1321">                continue;</span>
            }
<span class="nc" id="L1323">            double bv = mtype.getBV(this);</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">            if (bv &gt; 0) {</span>
<span class="nc" id="L1325">                bvText.append(startRow);</span>
<span class="nc" id="L1326">                bvText.append(startColumn);</span>

<span class="nc" id="L1328">                bvText.append(mounted.getName());</span>
<span class="nc" id="L1329">                bvText.append(endColumn);</span>
<span class="nc" id="L1330">                bvText.append(startColumn);</span>
<span class="nc" id="L1331">                bvText.append(endColumn);</span>
<span class="nc" id="L1332">                bvText.append(startColumn);</span>
<span class="nc" id="L1333">                bvText.append(bv);</span>
<span class="nc" id="L1334">                bvText.append(endColumn);</span>
<span class="nc" id="L1335">                bvText.append(endRow);</span>
            }
<span class="nc" id="L1337">            oEquipmentBV += bv;</span>
<span class="nc" id="L1338">        }</span>
<span class="nc" id="L1339">        bvText.append(startRow);</span>
<span class="nc" id="L1340">        bvText.append(startColumn);</span>

<span class="nc" id="L1342">        bvText.append(&quot;Total Misc Offensive Equipment BV: &quot;);</span>
<span class="nc" id="L1343">        bvText.append(endColumn);</span>
<span class="nc" id="L1344">        bvText.append(startColumn);</span>
<span class="nc" id="L1345">        bvText.append(endColumn);</span>
<span class="nc" id="L1346">        bvText.append(startColumn);</span>
<span class="nc" id="L1347">        bvText.append(oEquipmentBV);</span>
<span class="nc" id="L1348">        bvText.append(endColumn);</span>
<span class="nc" id="L1349">        bvText.append(endRow);</span>
<span class="nc" id="L1350">        weaponBV += oEquipmentBV;</span>

        // adjust

        // adjust further for speed factor
<span class="nc" id="L1355">        double speedFactor = Math.pow(1 + (((double) getRunMP() - 5) / 10), 1.2);</span>
<span class="nc" id="L1356">        speedFactor = Math.round(speedFactor * 100) / 100.0;</span>

<span class="nc" id="L1358">        bvText.append(startRow);</span>
<span class="nc" id="L1359">        bvText.append(startColumn);</span>

<span class="nc" id="L1361">        bvText.append(&quot;Final Speed Factor: &quot;);</span>
<span class="nc" id="L1362">        bvText.append(endColumn);</span>
<span class="nc" id="L1363">        bvText.append(startColumn);</span>
<span class="nc" id="L1364">        bvText.append(endColumn);</span>
<span class="nc" id="L1365">        bvText.append(startColumn);</span>
<span class="nc" id="L1366">        bvText.append(speedFactor);</span>
<span class="nc" id="L1367">        bvText.append(endColumn);</span>
<span class="nc" id="L1368">        bvText.append(endRow);</span>

<span class="nc" id="L1370">        obv = weaponBV * speedFactor;</span>

<span class="nc" id="L1372">        bvText.append(startRow);</span>
<span class="nc" id="L1373">        bvText.append(startColumn);</span>

<span class="nc" id="L1375">        bvText.append(&quot;Weapons BV * Speed Factor &quot;);</span>
<span class="nc" id="L1376">        bvText.append(endColumn);</span>
<span class="nc" id="L1377">        bvText.append(startColumn);</span>

<span class="nc" id="L1379">        bvText.append(weaponBV);</span>
<span class="nc" id="L1380">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L1381">        bvText.append(speedFactor);</span>
<span class="nc" id="L1382">        bvText.append(endColumn);</span>
<span class="nc" id="L1383">        bvText.append(startColumn);</span>
<span class="nc" id="L1384">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L1385">        bvText.append(obv);</span>
<span class="nc" id="L1386">        bvText.append(endColumn);</span>
<span class="nc" id="L1387">        bvText.append(endRow);</span>

<span class="nc" id="L1389">        bvText.append(startRow);</span>
<span class="nc" id="L1390">        bvText.append(startColumn);</span>

<span class="nc bnc" id="L1392" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L1393">            bvText.append(&quot;2 * sqrt(Offensive BV * Defensive BV&quot;);</span>
        } else {
<span class="nc" id="L1395">            bvText.append(&quot;Offensive BV + Defensive BV&quot;);</span>
        }
<span class="nc" id="L1397">        bvText.append(endColumn);</span>
<span class="nc" id="L1398">        bvText.append(startColumn);</span>

        double finalBV;
<span class="nc bnc" id="L1401" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L1402">            finalBV = 2 * Math.sqrt(obv * dbv);</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">            if (finalBV == 0) {</span>
<span class="nc" id="L1404">                finalBV = dbv + obv;</span>
            }
<span class="nc" id="L1406">            bvText.append(&quot;2 * sqrt(&quot;);</span>
<span class="nc" id="L1407">            bvText.append(obv);</span>
<span class="nc" id="L1408">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L1409">            bvText.append(dbv);</span>
<span class="nc" id="L1410">            bvText.append(&quot;)&quot;);</span>
        } else {
<span class="nc" id="L1412">            finalBV = dbv + obv;</span>
<span class="nc" id="L1413">            bvText.append(dbv);</span>
<span class="nc" id="L1414">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L1415">            bvText.append(obv);</span>
        }

<span class="nc" id="L1418">        bvText.append(endColumn);</span>
<span class="nc" id="L1419">        bvText.append(startColumn);</span>
<span class="nc" id="L1420">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L1421">        bvText.append(finalBV);</span>
<span class="nc" id="L1422">        bvText.append(endColumn);</span>
<span class="nc" id="L1423">        bvText.append(endRow);</span>

<span class="nc" id="L1425">        finalBV = Math.round(finalBV);</span>

<span class="nc" id="L1427">        bvText.append(startRow);</span>
<span class="nc" id="L1428">        bvText.append(startColumn);</span>
<span class="nc" id="L1429">        bvText.append(endColumn);</span>
<span class="nc" id="L1430">        bvText.append(startColumn);</span>
<span class="nc" id="L1431">        bvText.append(endColumn);</span>
<span class="nc" id="L1432">        bvText.append(startColumn);</span>

<span class="nc" id="L1434">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L1435">        bvText.append(endColumn);</span>
<span class="nc" id="L1436">        bvText.append(endRow);</span>

<span class="nc" id="L1438">        bvText.append(startRow);</span>
<span class="nc" id="L1439">        bvText.append(startColumn);</span>
<span class="nc" id="L1440">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L1441">        bvText.append(endColumn);</span>
<span class="nc" id="L1442">        bvText.append(startColumn);</span>
<span class="nc" id="L1443">        bvText.append(endColumn);</span>
<span class="nc" id="L1444">        bvText.append(startColumn);</span>

<span class="nc" id="L1446">        bvText.append(finalBV);</span>
<span class="nc" id="L1447">        bvText.append(endColumn);</span>
<span class="nc" id="L1448">        bvText.append(endRow);</span>

<span class="nc" id="L1450">        bvText.append(endTable);</span>
<span class="nc" id="L1451">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>

        // we get extra bv from some stuff
<span class="nc" id="L1454">        double xbv = 0.0;</span>

        // extra from c3 networks. a valid network requires at least 2 members
        // some hackery and magic numbers here. could be better
        // also, each 'has' loops through all equipment. inefficient to do it 3
        // times
<span class="nc bnc" id="L1460" title="All 4 branches missed.">        if (!ignoreC3 &amp;&amp; (game != null)) {</span>
<span class="nc" id="L1461">            xbv += getExtraC3BV((int) Math.round(finalBV));</span>
        }
<span class="nc" id="L1463">        finalBV += xbv;</span>

        // and then factor in pilot
<span class="nc" id="L1466">        double pilotFactor = 1;</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">        if (!ignorePilot) {</span>
<span class="nc" id="L1468">            pilotFactor = getCrew().getBVSkillMultiplier(game);</span>
        }

<span class="nc" id="L1471">        int retVal = (int) Math.round((finalBV) * pilotFactor);</span>

<span class="nc" id="L1473">        return retVal;</span>

    }

    /**
     * need to check bay location before loading ammo
     */
    @Override
    public boolean loadWeapon(Mounted mounted, Mounted mountedAmmo) {
<span class="nc" id="L1482">        boolean success = false;</span>
<span class="nc" id="L1483">        WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L1484">        AmmoType atype = (AmmoType) mountedAmmo.getType();</span>

<span class="nc bnc" id="L1486" title="All 2 branches missed.">        if (mounted.getLocation() != mountedAmmo.getLocation()) {</span>
<span class="nc" id="L1487">            return success;</span>
        }

        // for large craft, ammo must be in the same bay
<span class="nc" id="L1491">        Mounted bay = whichBay(getEquipmentNum(mounted));</span>
<span class="nc bnc" id="L1492" title="All 4 branches missed.">        if ((bay != null) &amp;&amp; !bay.ammoInBay(getEquipmentNum(mountedAmmo))) {</span>
<span class="nc" id="L1493">            return success;</span>
        }

<span class="nc bnc" id="L1496" title="All 4 branches missed.">        if (mountedAmmo.isAmmoUsable() &amp;&amp; !wtype.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L1497" title="All 4 branches missed.">                &amp;&amp; (atype.getAmmoType() == wtype.getAmmoType()) &amp;&amp; (atype.getRackSize() == wtype.getRackSize())) {</span>
<span class="nc" id="L1498">            mounted.setLinked(mountedAmmo);</span>
<span class="nc" id="L1499">            success = true;</span>
        }
<span class="nc" id="L1501">        return success;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getIniBonus()
     */
    @Override
    public int getHQIniBonus() {
        // large craft are considered to have &gt; 7 tons comm equipment
        // hence they get +2 ini bonus as a mobile hq
<span class="nc" id="L1513">        return 2;</span>
    }

    /**
     * find the adjacent firing arc on this vessel clockwise
     */
    public int getAdjacentArcCW(int arc) {
<span class="nc bnc" id="L1520" title="All 11 branches missed.">        switch (arc) {</span>
        case Compute.ARC_NOSE:
<span class="nc bnc" id="L1522" title="All 2 branches missed.">            if (isSpheroid()) {</span>
<span class="nc" id="L1523">                return Compute.ARC_RIGHTSIDE_SPHERE;</span>
            }
<span class="nc" id="L1525">            return Compute.ARC_RWING;</span>
        case Compute.ARC_LWING:
<span class="nc" id="L1527">            return Compute.ARC_NOSE;</span>
        case Compute.ARC_RWING:
<span class="nc" id="L1529">            return Compute.ARC_RWINGA;</span>
        case Compute.ARC_LWINGA:
<span class="nc" id="L1531">            return Compute.ARC_LWING;</span>
        case Compute.ARC_RWINGA:
<span class="nc" id="L1533">            return Compute.ARC_AFT;</span>
        case Compute.ARC_LEFTSIDE_SPHERE:
<span class="nc" id="L1535">            return Compute.ARC_NOSE;</span>
        case Compute.ARC_RIGHTSIDE_SPHERE:
<span class="nc" id="L1537">            return Compute.ARC_RIGHTSIDEA_SPHERE;</span>
        case Compute.ARC_LEFTSIDEA_SPHERE:
<span class="nc" id="L1539">            return Compute.ARC_LEFTSIDE_SPHERE;</span>
        case Compute.ARC_RIGHTSIDEA_SPHERE:
<span class="nc" id="L1541">            return Compute.ARC_AFT;</span>
        case Compute.ARC_AFT:
<span class="nc bnc" id="L1543" title="All 2 branches missed.">            if (isSpheroid()) {</span>
<span class="nc" id="L1544">                return Compute.ARC_LEFTSIDEA_SPHERE;</span>
            }
<span class="nc" id="L1546">            return Compute.ARC_LWINGA;</span>
        default:
<span class="nc" id="L1548">            return Integer.MIN_VALUE;</span>
        }
    }

    /**
     * find the adjacent firing arc on this vessel counter-clockwise
     */
    public int getAdjacentArcCCW(int arc) {
<span class="nc bnc" id="L1556" title="All 11 branches missed.">        switch (arc) {</span>
        case Compute.ARC_NOSE:
<span class="nc bnc" id="L1558" title="All 2 branches missed.">            if (isSpheroid()) {</span>
<span class="nc" id="L1559">                return Compute.ARC_LEFTSIDE_SPHERE;</span>
            }
<span class="nc" id="L1561">            return Compute.ARC_LWING;</span>
        case Compute.ARC_LWING:
<span class="nc" id="L1563">            return Compute.ARC_LWINGA;</span>
        case Compute.ARC_RWING:
<span class="nc" id="L1565">            return Compute.ARC_NOSE;</span>
        case Compute.ARC_LWINGA:
<span class="nc" id="L1567">            return Compute.ARC_AFT;</span>
        case Compute.ARC_RWINGA:
<span class="nc" id="L1569">            return Compute.ARC_RWING;</span>
        case Compute.ARC_LEFTSIDE_SPHERE:
<span class="nc" id="L1571">            return Compute.ARC_LEFTSIDEA_SPHERE;</span>
        case Compute.ARC_RIGHTSIDE_SPHERE:
<span class="nc" id="L1573">            return Compute.ARC_NOSE;</span>
        case Compute.ARC_LEFTSIDEA_SPHERE:
<span class="nc" id="L1575">            return Compute.ARC_AFT;</span>
        case Compute.ARC_RIGHTSIDEA_SPHERE:
<span class="nc" id="L1577">            return Compute.ARC_RWING;</span>
        case Compute.ARC_AFT:
<span class="nc bnc" id="L1579" title="All 2 branches missed.">            if (isSpheroid()) {</span>
<span class="nc" id="L1580">                return Compute.ARC_RIGHTSIDEA_SPHERE;</span>
            }
<span class="nc" id="L1582">            return Compute.ARC_RWINGA;</span>
        default:
<span class="nc" id="L1584">            return Integer.MIN_VALUE;</span>
        }
    }

    /**
     * find the adjacent firing arc location on this vessel clockwise
     */
    public int getAdjacentLocCW(int loc) {
<span class="nc bnc" id="L1592" title="All 7 branches missed.">        switch (loc) {</span>
        case LOC_NOSE:
<span class="nc" id="L1594">            return LOC_RWING;</span>
        case LOC_LWING:
<span class="nc" id="L1596">            return LOC_NOSE;</span>
        case LOC_RWING:
<span class="nc" id="L1598">            return (LOC_RWING + 3);</span>
        case LOC_AFT:
<span class="nc" id="L1600">            return (LOC_LWING + 3);</span>
        case 4:
<span class="nc" id="L1602">            return LOC_LWING;</span>
        case 5:
<span class="nc" id="L1604">            return LOC_AFT;</span>
        default:
<span class="nc" id="L1606">            return Integer.MIN_VALUE;</span>
        }
    }

    /**
     * find the adjacent firing arc on this vessel counter-clockwise
     */
    public int getAdjacentLocCCW(int loc) {
<span class="nc bnc" id="L1614" title="All 7 branches missed.">        switch (loc) {</span>
        case LOC_NOSE:
<span class="nc" id="L1616">            return LOC_LWING;</span>
        case LOC_LWING:
<span class="nc" id="L1618">            return (LOC_LWING + 3);</span>
        case LOC_RWING:
<span class="nc" id="L1620">            return LOC_NOSE;</span>
        case LOC_AFT:
<span class="nc" id="L1622">            return (LOC_RWING + 3);</span>
        case 4:
<span class="nc" id="L1624">            return LOC_AFT;</span>
        case 5:
<span class="nc" id="L1626">            return LOC_RWING;</span>
        default:
<span class="nc" id="L1628">            return Integer.MIN_VALUE;</span>
        }
    }

    /**
     * find the adjacent firing arc location on this vessel clockwise
     */
    public int getOppositeLoc(int loc) {
<span class="nc bnc" id="L1636" title="All 7 branches missed.">        switch (loc) {</span>
        case LOC_NOSE:
<span class="nc" id="L1638">            return LOC_AFT;</span>
        case LOC_LWING:
<span class="nc" id="L1640">            return (LOC_RWING + 3);</span>
        case LOC_RWING:
<span class="nc" id="L1642">            return (LOC_LWING + 3);</span>
        case LOC_AFT:
<span class="nc" id="L1644">            return LOC_NOSE;</span>
        case 4:
<span class="nc" id="L1646">            return LOC_RWING;</span>
        case 5:
<span class="nc" id="L1648">            return LOC_LWING;</span>
        default:
<span class="nc" id="L1650">            return Integer.MIN_VALUE;</span>
        }
    }

    /**
     * All military dropships automatically have ECM if in space
     */
    @Override
    public boolean hasActiveECM() {
<span class="nc bnc" id="L1659" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</span>
<span class="nc bnc" id="L1660" title="All 2 branches missed.">                || !game.getBoard().inSpace()) {</span>
<span class="nc" id="L1661">            return super.hasActiveECM();</span>
        }
<span class="nc bnc" id="L1663" title="All 2 branches missed.">        return getECMRange() &gt; Entity.NONE;</span>
    }

    /**
     * What's the range of the ECM equipment?
     *
     * @return the &lt;code&gt;int&lt;/code&gt; range of this unit's ECM. This value will be
     *         &lt;code&gt;Entity.NONE&lt;/code&gt; if no ECM is active.
     */
    @Override
    public int getECMRange() {
<span class="nc bnc" id="L1674" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">                || !game.getBoard().inSpace()) {</span>
<span class="nc" id="L1676">            return super.getECMRange();</span>
        }
<span class="nc bnc" id="L1678" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L1679">            return Entity.NONE;</span>
        }
<span class="nc" id="L1681">        int range = 1;</span>
        // the range might be affected by sensor/FCS damage
<span class="nc" id="L1683">        range = range - getFCSHits() - getSensorHits();</span>
<span class="nc" id="L1684">        return range;</span>
    }

    /**
     * Return the height of this dropship above the terrain.
     */
    @Override
    public int height() {
<span class="nc bnc" id="L1692" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc" id="L1693">            return 0;</span>
        }
<span class="nc bnc" id="L1695" title="All 2 branches missed.">        if (isSpheroid()) {</span>
<span class="nc" id="L1696">            return 9;</span>
        }
<span class="nc" id="L1698">        return 4;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#setPosition(megamek.common.Coords)
     */
    @Override

    public void setPosition(Coords position) {
<span class="nc" id="L1709">        HashSet&lt;Coords&gt; oldPositions = getOccupiedCoords();</span>
<span class="nc" id="L1710">        super.setPosition(position, false);</span>
<span class="nc bnc" id="L1711" title="All 8 branches missed.">        if ((getAltitude() == 0) &amp;&amp; (null != game) &amp;&amp; !game.getBoard().inSpace() &amp;&amp; (position != null)) {</span>
<span class="nc" id="L1712">            secondaryPositions.put(0, position);</span>
<span class="nc" id="L1713">            secondaryPositions.put(1, position.translated(getFacing()));</span>
<span class="nc" id="L1714">            secondaryPositions.put(2, position.translated((getFacing() + 1) % 6));</span>
<span class="nc" id="L1715">            secondaryPositions.put(3, position.translated((getFacing() + 2) % 6));</span>
<span class="nc" id="L1716">            secondaryPositions.put(4, position.translated((getFacing() + 3) % 6));</span>
<span class="nc" id="L1717">            secondaryPositions.put(5, position.translated((getFacing() + 4) % 6));</span>
<span class="nc" id="L1718">            secondaryPositions.put(6, position.translated((getFacing() + 5) % 6));</span>
        }
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        if (game != null) {</span>
<span class="nc" id="L1721">            game.updateEntityPositionLookup(this, oldPositions);</span>
        }
<span class="nc" id="L1723">    }</span>

    @Override
    public void setAltitude(int altitude) {
<span class="nc" id="L1727">        super.setAltitude(altitude);</span>
<span class="nc bnc" id="L1728" title="All 8 branches missed.">        if ((getAltitude() == 0) &amp;&amp; (game != null) &amp;&amp; !game.getBoard().inSpace() &amp;&amp; (getPosition() != null)) {</span>
<span class="nc" id="L1729">            secondaryPositions.put(0, getPosition());</span>
<span class="nc" id="L1730">            secondaryPositions.put(1, getPosition().translated(getFacing()));</span>
<span class="nc" id="L1731">            secondaryPositions.put(2, getPosition().translated((getFacing() + 1) % 6));</span>
<span class="nc" id="L1732">            secondaryPositions.put(3, getPosition().translated((getFacing() + 2) % 6));</span>
<span class="nc" id="L1733">            secondaryPositions.put(4, getPosition().translated((getFacing() + 3) % 6));</span>
<span class="nc" id="L1734">            secondaryPositions.put(5, getPosition().translated((getFacing() + 4) % 6));</span>
<span class="nc" id="L1735">            secondaryPositions.put(6, getPosition().translated((getFacing() + 5) % 6));</span>
        }
<span class="nc" id="L1737">    }</span>

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#setFacing(int)
     */
    @Override
    public void setFacing(int facing) {
<span class="nc" id="L1746">        super.setFacing(facing);</span>
<span class="nc" id="L1747">        setPosition(getPosition());</span>
<span class="nc" id="L1748">    }</span>

    @Override
    public int getLandingLength() {
<span class="nc" id="L1752">        return 15;</span>
    }

    @Override
    public String hasRoomForVerticalLanding() {
        // dropships can land just about anywhere they want, unless it is off
        // the map
<span class="nc" id="L1759">        Vector&lt;Coords&gt; positions = new Vector&lt;Coords&gt;();</span>
<span class="nc" id="L1760">        positions.add(getPosition());</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L1762">            positions.add(getPosition().translated(i));</span>
        }
<span class="nc bnc" id="L1764" title="All 2 branches missed.">        for (Coords pos : positions) {</span>
<span class="nc" id="L1765">            IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L1766">            hex = game.getBoard().getHex(pos);</span>
            // if the hex is null, then we are offboard. Don't let units
            // land offboard.
<span class="nc bnc" id="L1769" title="All 2 branches missed.">            if (null == hex) {</span>
<span class="nc" id="L1770">                return &quot;landing area not on the map&quot;;</span>
            }
<span class="nc bnc" id="L1772" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L1773">                return &quot;cannot land on water&quot;;</span>
            }
<span class="nc" id="L1775">        }</span>
        // TODO: what about other terrain (like jungles)?
<span class="nc" id="L1777">        return null;</span>
    }

    @Override
    public boolean usesWeaponBays() {
<span class="nc bnc" id="L1782" title="All 2 branches missed.">        if (null == game) {</span>
<span class="nc" id="L1783">            return true;</span>
        }
<span class="nc bnc" id="L1785" title="All 6 branches missed.">        return (isAirborne() || isSpaceborne() || game.getPhase() == IGame.Phase.PHASE_LOUNGE);</span>
    }

    @Override
    public HitData rollHitLocation(int table, int side) {
<span class="nc bnc" id="L1790" title="All 4 branches missed.">        if ((table == ToHitData.HIT_KICK) || (table == ToHitData.HIT_PUNCH)) {</span>
            // we don't really have any good rules on how to apply this,
            // I have a rules question posted about it:
            // http://bg.battletech.com/forums/index.php/topic,24077.new.html#new
            // in the meantime lets make up our own hit table (fun!)
<span class="nc" id="L1795">            int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L1796" title="All 2 branches missed.">            if (side == ToHitData.SIDE_LEFT) {</span>
                // normal left-side hits
<span class="nc bnc" id="L1798" title="All 12 branches missed.">                switch (roll) {</span>
                case 2:
<span class="nc" id="L1800">                    setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1801">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 3:
<span class="nc" id="L1803">                    setPotCrit(CRIT_LIFE_SUPPORT);</span>
<span class="nc" id="L1804">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 4:
<span class="nc" id="L1806">                    setPotCrit(CRIT_DOCK_COLLAR);</span>
<span class="nc" id="L1807">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 5:
<span class="nc" id="L1809">                    setPotCrit(CRIT_LEFT_THRUSTER);</span>
<span class="nc" id="L1810">                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
                case 6:
<span class="nc" id="L1812">                    setPotCrit(CRIT_CARGO);</span>
<span class="nc" id="L1813">                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
                case 7:
<span class="nc" id="L1815">                    setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1816">                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
                case 8:
<span class="nc" id="L1818">                    setPotCrit(CRIT_DOOR);</span>
<span class="nc" id="L1819">                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
                case 9:
<span class="nc" id="L1821">                    setPotCrit(CRIT_LEFT_THRUSTER);</span>
<span class="nc" id="L1822">                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
                case 10:
<span class="nc" id="L1824">                    setPotCrit(CRIT_AVIONICS);</span>
<span class="nc" id="L1825">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 11:
<span class="nc" id="L1827">                    setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1828">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 12:
<span class="nc" id="L1830">                    setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1831">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                }
            } else {
<span class="nc bnc" id="L1834" title="All 12 branches missed.">                switch (roll) {</span>
                case 2:
<span class="nc" id="L1836">                    setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1837">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 3:
<span class="nc" id="L1839">                    setPotCrit(CRIT_LIFE_SUPPORT);</span>
<span class="nc" id="L1840">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 4:
<span class="nc" id="L1842">                    setPotCrit(CRIT_DOCK_COLLAR);</span>
<span class="nc" id="L1843">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 5:
<span class="nc" id="L1845">                    setPotCrit(CRIT_RIGHT_THRUSTER);</span>
<span class="nc" id="L1846">                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
                case 6:
<span class="nc" id="L1848">                    setPotCrit(CRIT_CARGO);</span>
<span class="nc" id="L1849">                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
                case 7:
<span class="nc" id="L1851">                    setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1852">                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
                case 8:
<span class="nc" id="L1854">                    setPotCrit(CRIT_DOOR);</span>
<span class="nc" id="L1855">                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
                case 9:
<span class="nc" id="L1857">                    setPotCrit(CRIT_RIGHT_THRUSTER);</span>
<span class="nc" id="L1858">                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
                case 10:
<span class="nc" id="L1860">                    setPotCrit(CRIT_AVIONICS);</span>
<span class="nc" id="L1861">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 11:
<span class="nc" id="L1863">                    setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1864">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                case 12:
<span class="nc" id="L1866">                    setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1867">                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
                }
            }
<span class="nc" id="L1870">            return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
        } else {
<span class="nc" id="L1872">            return super.rollHitLocation(table, side);</span>
        }
    }

    @Override
    public String getLocationAbbr(int loc) {
<span class="nc bnc" id="L1878" title="All 2 branches missed.">        if (loc == Entity.LOC_NONE) {</span>
<span class="nc" id="L1879">            return &quot;System Wide&quot;;</span>
        } else {
<span class="nc" id="L1881">            return super.getLocationAbbr(loc);</span>
        }
    }

    @Override
    public long getEntityType() {
<span class="nc" id="L1887">        return Entity.ETYPE_AERO | Entity.ETYPE_SMALL_CRAFT | Entity.ETYPE_DROPSHIP;</span>
    }
    
    @Override
    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA,Integer&gt; specialAbilities) {
<span class="nc" id="L1892">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        if (getNCrew() &gt;= 30) {</span>
<span class="nc" id="L1894">            specialAbilities.put(BattleForceSPA.CRW, (int)Math.round(getNCrew() / 60.0));</span>
        }
<span class="nc" id="L1896">    }</span>
    
    @Override
    public boolean canChangeSecondaryFacing() {
        // flying dropships can execute the &quot;ECHO&quot; maneuver (stratops 113), aka a torso twist, 
        // if they have the MP for it
<span class="nc bnc" id="L1902" title="All 6 branches missed.">        return isAirborne() &amp;&amp; !isEvading() &amp;&amp; (mpUsed &lt;= getRunMP() - 2);</span>
    }
    
    /**
     * Can this dropship &quot;torso twist&quot; in the given direction?
     */
    @Override
    public boolean isValidSecondaryFacing(int dir) {
<span class="nc" id="L1910">        int rotate = dir - getFacing();</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        if (canChangeSecondaryFacing()) {</span>
<span class="nc bnc" id="L1912" title="All 10 branches missed.">            return (rotate == 0) || (rotate == 1) || (rotate == -1)</span>
                    || (rotate == -5) || (rotate == 5);
        }
<span class="nc bnc" id="L1915" title="All 2 branches missed.">        return rotate == 0;</span>
    }
    
    /**
     * Return the nearest valid direction to &quot;torso twist&quot; in
     */
    @Override
    public int clipSecondaryFacing(int dir) {
<span class="nc bnc" id="L1923" title="All 2 branches missed.">        if (isValidSecondaryFacing(dir)) {</span>
<span class="nc" id="L1924">            return dir;</span>
        }
        
        // can't twist without enough MP
<span class="nc bnc" id="L1928" title="All 2 branches missed.">        if (!canChangeSecondaryFacing()) {</span>
<span class="nc" id="L1929">            return getFacing();</span>
        }
        
        // otherwise, twist once in the appropriate direction
<span class="nc" id="L1933">        final int rotate = (dir + (6 - getFacing())) % 6;</span>
        
<span class="nc bnc" id="L1935" title="All 2 branches missed.">        return rotate &gt;= 3 ? (getFacing() + 5) % 6 : (getFacing() + 1) % 6;</span>
    }
    
    @Override
    public void newRound(int roundNumber) {
<span class="nc" id="L1940">        super.newRound(roundNumber);</span>
        
<span class="nc bnc" id="L1942" title="All 2 branches missed.">        if (getGame().useVectorMove()) {</span>
<span class="nc" id="L1943">            setFacing(getSecondaryFacing());</span>
        }
        
<span class="nc" id="L1946">        setSecondaryFacing(getFacing());</span>
<span class="nc" id="L1947">    }</span>
    
    /**
     * Utility function that handles situations where a facing change
     * has some kind of permanent effect on the entity.
     */
    @Override
    public void postProcessFacingChange() {
<span class="nc" id="L1955">        mpUsed += 2;</span>
<span class="nc" id="L1956">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>