<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LandAirMech.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">LandAirMech.java</span></div><h1>LandAirMech.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000-2003 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */
package megamek.common;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Vector;

import megamek.common.options.OptionsConstants;

public class LandAirMech extends BipedMech implements IAero, IBomber {

    /**
     *
     */
    private static final long serialVersionUID = -8118673802295814548L;

    public static final int CONV_MODE_MECH = 0;
    public static final int CONV_MODE_AIRMECH = 1;
    public static final int CONV_MODE_FIGHTER = 2;

    public static final int LAM_AVIONICS = 15;

    public static final int LAM_LANDING_GEAR = 16;

<span class="nc" id="L40">    public static final String systemNames[] = { &quot;Life Support&quot;, &quot;Sensors&quot;, &quot;Cockpit&quot;, &quot;Engine&quot;, &quot;Gyro&quot;, null, null,</span>
            &quot;Shoulder&quot;, &quot;Upper Arm&quot;, &quot;Lower Arm&quot;, &quot;Hand&quot;, &quot;Hip&quot;, &quot;Upper Leg&quot;, &quot;Lower Leg&quot;, &quot;Foot&quot;, &quot;Avionics&quot;,
            &quot;Landing Gear&quot; };

    public static final int LAM_UNKNOWN = -1;
    public static final int LAM_STANDARD = 0;
    public static final int LAM_BIMODAL = 1;

<span class="nc" id="L48">    public static final String[] LAM_STRING = { &quot;Standard&quot;, &quot;Bimodal&quot; };</span>

    /** Locations for capital fighter weapons groups */
    public static final int LOC_CAPITAL_NOSE = 8;
    public static final int LOC_CAPITAL_AFT = 9;
    public static final int LOC_CAPITAL_WINGS = 10;

    /**
     * Translate a 'Mech location to the equivalent Aero location.
     */
    public static int getAeroLocation(int loc) {
<span class="nc bnc" id="L59" title="All 6 branches missed.">        switch (loc) {</span>
        case LOC_HEAD:
        case LOC_CT:
        case LOC_CAPITAL_NOSE:
<span class="nc" id="L63">            return Aero.LOC_NOSE;</span>
        case LOC_RT:
        case LOC_RARM:
<span class="nc" id="L66">            return Aero.LOC_RWING;</span>
        case LOC_LT:
        case LOC_LARM:
<span class="nc" id="L69">            return Aero.LOC_LWING;</span>
        case LOC_RLEG:
        case LOC_LLEG:
        case LOC_CAPITAL_AFT:
<span class="nc" id="L73">            return Aero.LOC_AFT;</span>
        case LOC_CAPITAL_WINGS:
<span class="nc" id="L75">            return Aero.LOC_WINGS;</span>
        }
<span class="nc" id="L77">        return LOC_NONE;</span>
    }

<span class="nc" id="L80">    private static final String[] LOCATION_NAMES = { &quot;Head&quot;, &quot;Center Torso&quot;, &quot;Right Torso&quot;, &quot;Left Torso&quot;, &quot;Right Arm&quot;,</span>
            &quot;Left Arm&quot;, &quot;Right Leg&quot;, &quot;Left Leg&quot;, &quot;Nose&quot;, &quot;Aft&quot;, &quot;Wings&quot; };

<span class="nc" id="L83">    private static final String[] LOCATION_ABBRS = { &quot;HD&quot;, &quot;CT&quot;, &quot;RT&quot;, &quot;LT&quot;, &quot;RA&quot;, &quot;LA&quot;, &quot;RL&quot;, &quot;LL&quot;, &quot;NOS&quot;, &quot;AFT&quot;,</span>
            &quot;WNG&quot; };

<span class="nc" id="L86">    private static final int[] NUM_OF_SLOTS = { 6, 12, 12, 12, 12, 12, 6, 6, 100, 100, 100 };</span>

    /**
     * Returns a vector of slot counts for all locations
     */
    @Override
    protected int[] getNoOfSlots() {
<span class="nc" id="L93">        return NUM_OF_SLOTS;</span>
    }

    /**
     * Returns a vector of names for all locations
     */
    @Override
    public String[] getLocationNames() {
<span class="nc" id="L101">        return LOCATION_NAMES;</span>
    }

    /**
     * Returns a vector of abbreviations for all locations
     */
    @Override
    public String[] getLocationAbbrs() {
<span class="nc" id="L109">        return LOCATION_ABBRS;</span>
    }

    private int lamType;

    /** Fighter mode **/
    // out of control
<span class="nc" id="L116">    private boolean outControl = false;</span>
<span class="nc" id="L117">    private boolean outCtrlHeat = false;</span>
<span class="nc" id="L118">    private boolean randomMove = false;</span>

    // set up movement
<span class="nc" id="L121">    private int currentVelocity = 0;</span>
<span class="nc" id="L122">    private int nextVelocity = currentVelocity;</span>
<span class="nc" id="L123">    private boolean accLast = false;</span>
<span class="nc" id="L124">    private boolean rolled = false;</span>
<span class="nc" id="L125">    private boolean failedManeuver = false;</span>
<span class="nc" id="L126">    private boolean accDecNow = false;</span>
<span class="nc" id="L127">    private int straightMoves = 0;</span>
<span class="nc" id="L128">    private int altLoss = 0;</span>
<span class="nc" id="L129">    private int altLossThisRound = 0;</span>
    
    //Autoejection
<span class="nc" id="L132">    private boolean critThresh = false;</span>

<span class="nc" id="L134">    private int[] bombChoices = new int[BombType.B_NUM];</span>
<span class="nc" id="L135">    private Targetable airmechBombTarget = null;</span>

    private int fuel;
    private int currentfuel;
    private int whoFirst;

    // Capital Fighter stuff
<span class="nc" id="L142">    private int capitalArmor = 0;</span>
<span class="nc" id="L143">    private int capitalArmor_orig = 2;</span>
<span class="nc" id="L144">    private int fatalThresh = 0;</span>
<span class="nc" id="L145">    private int currentDamage = 0;</span>
<span class="nc" id="L146">    private Map&lt;String, Integer&gt; weaponGroups = new HashMap&lt;String, Integer&gt;();</span>

    public LandAirMech(int inGyroType, int inCockpitType, int inLAMType) {
<span class="nc" id="L149">        super(inGyroType, inCockpitType);</span>
<span class="nc" id="L150">        lamType = inLAMType;</span>

<span class="nc" id="L152">        setTechLevel(TechConstants.T_IS_ADVANCED);</span>
<span class="nc" id="L153">        setCritical(Mech.LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LAM_AVIONICS));</span>
<span class="nc" id="L154">        setCritical(Mech.LOC_LT, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LAM_AVIONICS));</span>
<span class="nc" id="L155">        setCritical(Mech.LOC_RT, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LAM_AVIONICS));</span>
<span class="nc" id="L156">        setCritical(Mech.LOC_LT, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LAM_LANDING_GEAR));</span>
<span class="nc" id="L157">        setCritical(Mech.LOC_RT, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LAM_LANDING_GEAR));</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(Mech.LOC_CT); i++) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (null == getCritical(Mech.LOC_CT, i)) {</span>
<span class="nc" id="L160">                setCritical(Mech.LOC_CT, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LAM_LANDING_GEAR));</span>
<span class="nc" id="L161">                break;</span>
            }
        }

<span class="nc" id="L165">        previousMovementMode = movementMode;</span>
<span class="nc" id="L166">        setFuel(80);</span>

<span class="nc" id="L168">        setCrew(new LAMPilot(this));</span>
<span class="nc" id="L169">    }</span>

    @Override
    public void setCrew(Crew newCrew) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (newCrew instanceof LAMPilot) {</span>
<span class="nc" id="L174">            super.setCrew(newCrew);</span>
        } else {
<span class="nc" id="L176">            super.setCrew(LAMPilot.convertToLAMPilot(this, newCrew));</span>
        }
<span class="nc" id="L178">    }</span>

    @Override
    public String getSystemName(int index) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (index == SYSTEM_GYRO) {</span>
<span class="nc" id="L183">            return Mech.getGyroDisplayString(gyroType);</span>
        }
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (index == SYSTEM_COCKPIT) {</span>
<span class="nc" id="L186">            return Mech.getCockpitDisplayString(cockpitType);</span>
        }
<span class="nc" id="L188">        return systemNames[index];</span>
    }

    @Override
    public String getRawSystemName(int index) {
<span class="nc" id="L193">        return systemNames[index];</span>
    }

    public int getLAMType() {
<span class="nc" id="L197">        return lamType;</span>
    }

    public void setLAMType(int lamType) {
<span class="nc" id="L201">        this.lamType = lamType;</span>
<span class="nc" id="L202">    }</span>

    public String getLAMTypeString(int lamType) {
<span class="nc bnc" id="L205" title="All 4 branches missed.">        if (lamType &lt; 0 || lamType &gt;= LAM_STRING.length) {</span>
<span class="nc" id="L206">            return LAM_STRING[LAM_UNKNOWN];</span>
        }
<span class="nc" id="L208">        return LAM_STRING[lamType];</span>
    }

    public String getLAMTypeString() {
<span class="nc" id="L212">        return getLAMTypeString(getLAMType());</span>
    }

    public static int getLAMTypeForString(String inType) {
<span class="nc bnc" id="L216" title="All 4 branches missed.">        if ((inType == null) || (inType.length() &lt; 1)) {</span>
<span class="nc" id="L217">            return LAM_UNKNOWN;</span>
        }
<span class="nc bnc" id="L219" title="All 2 branches missed.">        for (int x = 0; x &lt; LAM_STRING.length; x++) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (inType.equals(LAM_STRING[x])) {</span>
<span class="nc" id="L221">                return x;</span>
            }
        }
<span class="nc" id="L224">        return LAM_UNKNOWN;</span>
    }

    @Override
    public boolean doomedInAtmosphere() {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        return getConversionMode() != CONV_MODE_FIGHTER;</span>
    }

    @Override
    public boolean doomedInSpace() {
<span class="nc bnc" id="L234" title="All 2 branches missed.">        return getConversionMode() != CONV_MODE_FIGHTER;</span>
    }

    /**
     * Current MP is calculated differently depending on the LAM's mode. AirMech
     * mode returns cruise/flank; walk/run is treated as a special case of WiGE
     * ground movement.
     */
    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
        int mp;
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L246">            mp = getFighterModeWalkMP(gravity, ignoremodulararmor);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L248">            mp = getAirMechCruiseMP(gravity, ignoremodulararmor);</span>
        } else {
<span class="nc" id="L250">            mp = super.getWalkMP(gravity, ignoreheat, ignoremodulararmor);</span>
        }
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (convertingNow) {</span>
<span class="nc" id="L253">            mp /= 2;</span>
        }
<span class="nc" id="L255">        return mp;</span>
    }
    
    // Use Mech mode to determine walk MP for BV calculations
    public int getBVWalkMP() {
<span class="nc" id="L260">        return super.getWalkMP(false, true, true);</span>
    }

    @Override
    public int getRunMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
        int mp;
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L267">            mp = getFighterModeRunMP(gravity, ignoremodulararmor);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L269">            mp = getAirMechFlankMP(gravity, ignoremodulararmor);</span>
        } else {
            // conversion reduction has already been done at this point
<span class="nc" id="L272">            return super.getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
        }
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (convertingNow) {</span>
<span class="nc" id="L275">            mp /= 2;</span>
        }
<span class="nc" id="L277">        return mp;</span>
    }

    @Override
    public int getRunMPwithoutMASC(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
        int mp;
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L284">            mp = getFighterModeRunMP(gravity, ignoremodulararmor);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L286">            mp = getAirMechFlankMP(gravity, ignoremodulararmor);</span>
        } else {
<span class="nc" id="L288">            return super.getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
        }
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (convertingNow) {</span>
<span class="nc" id="L291">            mp /= 2;</span>
        }
<span class="nc" id="L293">        return mp;</span>
    }

    /**
     * This value should only be used for biped and airmech ground movement.
     */
    @Override
    public int getSprintMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L302">            return getRunMP();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (hasHipCrit()) {</span>
<span class="nc" id="L305">                return getAirMechRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
            }
<span class="nc" id="L307">            return (int) Math</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                    .ceil(getAirMechWalkMP(gravity, ignoreheat, ignoremodulararmor) * (hasArmedMASC() ? 2.5 : 2.0));</span>
        }
<span class="nc" id="L310">        return super.getSprintMP(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /**
     * This value should only be used for biped and airmech ground movement.
     */
    @Override
    public int getSprintMPwithoutMASC(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L319">            return getRunMP();</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if (hasHipCrit()) {</span>
<span class="nc" id="L322">                return getAirMechRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
            }
<span class="nc" id="L324">            return getAirMechWalkMP(gravity, ignoreheat, ignoremodulararmor) * 2;</span>
        }
<span class="nc" id="L326">        return super.getSprintMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    @Override
    public int getOriginalSprintMPwithoutMASC() {
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_MECH) {</span>
<span class="nc" id="L332">            return (int) Math.ceil(getOriginalWalkMP() * 2.0);</span>
        } else {
<span class="nc" id="L334">            return getOriginalRunMP();</span>
        }
    }

    public int getAirMechCruiseMP(boolean gravity, boolean ignoremodulararmor) {
<span class="nc bnc" id="L339" title="All 4 branches missed.">        if (game != null &amp;&amp; game.getBoard().inAtmosphere()</span>
<span class="nc bnc" id="L340" title="All 4 branches missed.">                &amp;&amp; (isLocationBad(Mech.LOC_LT) || isLocationBad(Mech.LOC_RT))) {</span>
<span class="nc" id="L341">            return 0;</span>
        }
<span class="nc" id="L343">        return getJumpMP(gravity, ignoremodulararmor) * 3;</span>
    }

    public int getAirMechFlankMP(boolean gravity, boolean ignoremodulararmor) {
<span class="nc bnc" id="L347" title="All 4 branches missed.">        if (game != null &amp;&amp; game.getBoard().inAtmosphere()</span>
<span class="nc bnc" id="L348" title="All 4 branches missed.">                &amp;&amp; (isLocationBad(Mech.LOC_LT) || isLocationBad(Mech.LOC_RT))) {</span>
<span class="nc" id="L349">            return 0;</span>
        }
<span class="nc" id="L351">        return (int) Math.ceil(getAirMechCruiseMP(gravity, ignoremodulararmor) * 1.5);</span>
    }

    public int getAirMechWalkMP() {
<span class="nc" id="L355">        return getAirMechWalkMP(true, false, false);</span>
    }

    public int getAirMechWalkMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
<span class="nc" id="L359">        int mp = (int) Math.ceil(super.getWalkMP(gravity, ignoreheat, ignoremodulararmor) * 0.33);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (convertingNow) {</span>
<span class="nc" id="L361">            mp /= 2;</span>
        }
<span class="nc" id="L363">        return mp;</span>
    }

    public int getAirMechRunMP() {
<span class="nc" id="L367">        return getAirMechRunMP(true, false, false);</span>
    }

    public int getAirMechRunMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
<span class="nc" id="L371">        int mp = (int) Math.ceil(getAirMechWalkMP(gravity, ignoreheat, ignoremodulararmor) * 1.5);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (convertingNow) {</span>
<span class="nc" id="L373">            mp /= 2;</span>
        }
<span class="nc" id="L375">        return mp;</span>
    }

    public int getFighterModeWalkMP(boolean gravity, boolean ignoremodulararmor) {
<span class="nc" id="L379">        int thrust = getCurrentThrust();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (!isAirborne()) {</span>
<span class="nc" id="L381">            thrust /= 2;</span>
        }
<span class="nc" id="L383">        return thrust;</span>
    }

    public int getFighterModeRunMP(boolean gravity, boolean ignoremodulararmor) {
<span class="nc" id="L387">        int walk = getFighterModeWalkMP(gravity, ignoremodulararmor);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc" id="L389">            return (int) Math.ceil(walk * 1.5);</span>
        } else {
<span class="nc" id="L391">            return walk; // Grounded asfs cannot use flanking movement</span>
        }
    }

    @Override
    public int getCurrentThrust() {
        // Cannot fly in atmosphere with missing side torso
<span class="nc bnc" id="L398" title="All 6 branches missed.">        if (!isSpaceborne() &amp;&amp; (isLocationBad(LOC_RT) || isLocationBad(LOC_LT))) {</span>
<span class="nc" id="L399">            return 0;</span>
        }
<span class="nc" id="L401">        int j = getJumpMP();</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L403">            int weatherMod = game.getPlanetaryConditions().getMovementMods(this);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L405">                j = Math.max(j + weatherMod, 0);</span>
            }
        }
<span class="nc" id="L408">        return j;</span>
    }

    public int getAirMechCruiseMP() {
<span class="nc" id="L412">        return getAirMechCruiseMP(true, false);</span>
    }

    public int getAirMechFlankMP() {
<span class="nc" id="L416">        return getAirMechFlankMP(true, false);</span>
    }

    public int getFighterModeWalkMP() {
<span class="nc" id="L420">        return getFighterModeWalkMP(true, false);</span>
    }

    public int getFighterModeRunMP() {
<span class="nc" id="L424">        return getFighterModeRunMP(true, false);</span>
    }

    /**
     * LAMs cannot benefit from MASC in AirMech or fighter mode and cannot mount
     * a supercharger.
     */
    @Override
    public boolean hasArmedMASC() {
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_MECH) {</span>
<span class="nc" id="L434">            return super.hasArmedMASC();</span>
        } else {
<span class="nc" id="L436">            return false;</span>
        }
    }

    @Override
    public boolean isImmobile() {
<span class="nc bnc" id="L442" title="All 6 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER &amp;&amp; (isAirborne() || isSpaceborne())) {</span>
<span class="nc" id="L443">            return false;</span>
        }
<span class="nc" id="L445">        return super.isImmobile();</span>
    }

    @Override
    public int getWalkHeat() {
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (moved == EntityMovementType.MOVE_VTOL_WALK) {</span>
<span class="nc" id="L451">            return getAirMechHeat();</span>
        }
<span class="nc" id="L453">        return super.getWalkHeat();</span>
    }

    @Override
    public int getRunHeat() {
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (moved == EntityMovementType.MOVE_VTOL_RUN) {</span>
<span class="nc" id="L459">            return getAirMechHeat();</span>
        }
<span class="nc" id="L461">        return super.getRunHeat();</span>
    }

    public int getAirMechHeat() {
<span class="nc bnc" id="L465" title="All 2 branches missed.">        int mod = bDamagedCoolantSystem ? 1 : 0;</span>
<span class="nc" id="L466">        return mod + (int) Math.round(getJumpHeat(mpUsed) / 3.0);</span>
    }

    @Override
    public int getEngineCritHeat() {
        // Engine crit heat follows ASF rules in fighter mode.
<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L473">            return 2 * getEngineHits();</span>
        } else {
<span class="nc" id="L475">            return super.getEngineCritHeat();</span>
        }
    }

    @Override
    public int getHeatSinks() {
<span class="nc" id="L481">        return getActiveSinks();</span>
    }

    @Override
    public boolean usesTurnMode() {
        // Turn mode rule is not optional for LAMs in AirMech mode.
<span class="nc bnc" id="L487" title="All 2 branches missed.">        return getConversionMode() == CONV_MODE_AIRMECH;</span>
    }

    /**
     * When cycling through possible movement modes, we need to know if we've
     * returned to the previous mode, which means that no conversion is actually
     * going to take place.
     *
     * @return The movement mode on the previous turn.
     */
    public EntityMovementMode getPreviousMovementMode() {
<span class="nc" id="L498">        return previousMovementMode;</span>
    }

    public int getPreviousConversionMode() {
<span class="nc bnc" id="L502" title="All 3 branches missed.">        switch (previousMovementMode) {</span>
        case AERODYNE:
        case WHEELED:
<span class="nc" id="L505">            return CONV_MODE_FIGHTER;</span>
        case WIGE:
<span class="nc" id="L507">            return CONV_MODE_AIRMECH;</span>
        case BIPED:
        default:
<span class="nc" id="L510">            return CONV_MODE_MECH;</span>
        }
    }

    @Override
    public void setMovementMode(EntityMovementMode mode) {
<span class="nc" id="L516">        int prevMode = getConversionMode();</span>
<span class="nc bnc" id="L517" title="All 4 branches missed.">        if (mode == EntityMovementMode.AERODYNE || mode == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L518">            setConversionMode(CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">        } else if (mode == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L520">            setConversionMode(CONV_MODE_AIRMECH);</span>
        } else {
<span class="nc" id="L522">            setConversionMode(CONV_MODE_MECH);</span>
        }
<span class="nc" id="L524">        super.setMovementMode(mode);</span>

<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (getConversionMode() != prevMode) {</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">            if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L528">                setRapidFire();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">            } else if (prevMode == CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                for (Mounted m : getTotalWeaponList()) {</span>
<span class="nc" id="L531">                    WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                    if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L533">                        m.setMode(&quot;&quot;);</span>
<span class="nc" id="L534">                        m.setModeSwitchable(true);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    } else if (wtype.getAmmoType() == AmmoType.T_AC_ULTRA) {</span>
<span class="nc" id="L536">                        m.setMode(&quot;&quot;);</span>
<span class="nc" id="L537">                        m.setModeSwitchable(true);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                    } else if (wtype.hasIndirectFire()) {</span>
<span class="nc" id="L539">                        m.setModeSwitchable(true);</span>
                    }
<span class="nc" id="L541">                }</span>
            }

<span class="nc" id="L544">            resetBombAttacks();</span>
        }
<span class="nc" id="L546">    }</span>

    @Override
    public void setConversionMode(int mode) {
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (mode == getConversionMode()) {</span>
<span class="nc" id="L551">            return;</span>
        }
<span class="nc bnc" id="L553" title="All 2 branches missed.">        if (mode == CONV_MODE_MECH) {</span>
<span class="nc" id="L554">            super.setMovementMode(EntityMovementMode.BIPED);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">        } else if (mode == CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L556">            super.setMovementMode(EntityMovementMode.WIGE);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">        } else if (mode == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L558">            super.setMovementMode(EntityMovementMode.AERODYNE);</span>
        } else {
<span class="nc" id="L560">            return;</span>
        }
<span class="nc" id="L562">        super.setConversionMode(mode);</span>
<span class="nc" id="L563">    }</span>

    @Override
    public boolean canAssaultDrop() {
<span class="nc bnc" id="L567" title="All 2 branches missed.">        return getConversionMode() != CONV_MODE_FIGHTER;</span>
    }

    @Override
    public boolean isLocationProhibited(Coords c, int currElevation) {
        // Fighter mode has the same terrain restrictions as ASFs.
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">            if (isAirborne()) {</span>
<span class="nc" id="L575">                return false;</span>
            }
<span class="nc" id="L577">            IHex hex = game.getBoard().getHex(c);</span>

            // Additional restrictions for hidden units
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (isHidden()) {</span>
                // Can't deploy in paved hexes
<span class="nc bnc" id="L582" title="All 4 branches missed.">                if (hex.containsTerrain(Terrains.PAVEMENT) || hex.containsTerrain(Terrains.ROAD)) {</span>
<span class="nc" id="L583">                    return true;</span>
                }
                // Can't deploy on a bridge
<span class="nc bnc" id="L586" title="All 4 branches missed.">                if ((hex.terrainLevel(Terrains.BRIDGE_ELEV) == currElevation) &amp;&amp; hex.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L587">                    return true;</span>
                }
                // Can't deploy on the surface of water
<span class="nc bnc" id="L590" title="All 4 branches missed.">                if (hex.containsTerrain(Terrains.WATER) &amp;&amp; (currElevation == 0)) {</span>
<span class="nc" id="L591">                    return true;</span>
                }
            }

            // grounded aeros have the same prohibitions as wheeled tanks
<span class="nc bnc" id="L596" title="All 4 branches missed.">            return hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L597" title="All 4 branches missed.">                    || ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L598" title="All 4 branches missed.">                    || hex.containsTerrain(Terrains.RUBBLE) || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L599" title="All 4 branches missed.">                    || hex.containsTerrain(Terrains.JUNGLE) || (hex.terrainLevel(Terrains.SNOW) &gt; 1)</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                    || (hex.terrainLevel(Terrains.GEYSER) == 2);</span>
<span class="nc bnc" id="L601" title="All 4 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH &amp;&amp; currElevation &gt; 0) {</span>
            // Cannot enter woods or a building hex in AirMech mode unless using
            // ground movement
            // or flying over the terrain.
<span class="nc" id="L605">            IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L606" title="All 4 branches missed.">            return (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">                    || hex.containsTerrain(Terrains.BLDG_ELEV)) &amp;&amp; hex.ceiling() &gt; currElevation;</span>
        } else {
            // Mech mode or AirMech mode using ground MP have the same
            // restrictions as Biped Mech.
<span class="nc" id="L611">            return super.isLocationProhibited(c, currElevation);</span>
        }
    }

    @Override
    public String getMovementString(EntityMovementType mtype) {
<span class="nc bnc" id="L617" title="All 7 branches missed.">        switch (mtype) {</span>
        case MOVE_WALK:
<span class="nc bnc" id="L619" title="All 2 branches missed.">            if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L620">                return &quot;Cruised&quot;;</span>
            } else {
<span class="nc" id="L622">                return &quot;Walked&quot;;</span>
            }
        case MOVE_RUN:
<span class="nc bnc" id="L625" title="All 2 branches missed.">            if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L626">                return &quot;Flanked&quot;;</span>
            } else {
<span class="nc" id="L628">                return &quot;Ran&quot;;</span>
            }
        case MOVE_VTOL_WALK:
<span class="nc" id="L631">            return &quot;Cruised&quot;;</span>
        case MOVE_VTOL_RUN:
<span class="nc" id="L633">            return &quot;Flanked&quot;;</span>
        case MOVE_SAFE_THRUST:
<span class="nc" id="L635">            return &quot;Safe Thrust&quot;;</span>
        case MOVE_OVER_THRUST:
<span class="nc" id="L637">            return &quot;Over Thrust&quot;;</span>
        default:
<span class="nc" id="L639">            return super.getMovementString(mtype);</span>
        }
    }

    @Override
    public String getMovementAbbr(EntityMovementType mtype) {
<span class="nc bnc" id="L645" title="All 8 branches missed.">        switch (mtype) {</span>
        case MOVE_WALK:
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L648">                return &quot;C&quot;;</span>
            } else {
<span class="nc" id="L650">                return &quot;W&quot;;</span>
            }
        case MOVE_RUN:
<span class="nc bnc" id="L653" title="All 2 branches missed.">            if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L654">                return &quot;F&quot;;</span>
            } else {
<span class="nc" id="L656">                return &quot;R&quot;;</span>
            }
        case MOVE_VTOL_WALK:
<span class="nc" id="L659">            return &quot;C&quot;;</span>
        case MOVE_VTOL_RUN:
<span class="nc" id="L661">            return &quot;F&quot;;</span>
        case MOVE_NONE:
<span class="nc" id="L663">            return &quot;N&quot;;</span>
        case MOVE_SAFE_THRUST:
<span class="nc" id="L665">            return &quot;S&quot;;</span>
        case MOVE_OVER_THRUST:
<span class="nc" id="L667">            return &quot;O&quot;;</span>
        default:
<span class="nc" id="L669">            return super.getMovementAbbr(mtype);</span>
        }
    }

    /**
     * Add in any piloting skill mods
     */
    @Override
    public PilotingRollData addEntityBonuses(PilotingRollData roll) {
        // Modifier for pilot hits applies in all modes.
<span class="nc bnc" id="L679" title="All 2 branches missed.">        if (getCrew().getHits(0) &gt; 0) {</span>
<span class="nc" id="L680">            roll.addModifier(getCrew().getHits(0), &quot;pilot hits&quot;);</span>
        }

<span class="nc bnc" id="L683" title="All 4 branches missed.">        if (getConversionMode() != CONV_MODE_FIGHTER &amp;&amp; !isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L684">            return super.addEntityBonuses(roll);</span>
        }

        // In fighter mode a destroyed gyro gives +6 to the control roll.
<span class="nc" id="L688">        int gyroHits = getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, Mech.LOC_CT);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (gyroHits &gt; 0) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (getGyroType() == Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">                if (gyroHits == 1) {</span>
<span class="nc" id="L692">                    roll.addModifier(1, &quot;HD Gyro damaged once&quot;);</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                } else if (gyroHits == 2) {</span>
<span class="nc" id="L694">                    roll.addModifier(3, &quot;HD Gyro damaged twice&quot;);</span>
                } else {
<span class="nc" id="L696">                    roll.addModifier(6, &quot;Gyro destroyed&quot;);</span>
                }
            } else {
<span class="nc bnc" id="L699" title="All 2 branches missed.">                if (gyroHits == 1) {</span>
<span class="nc" id="L700">                    roll.addModifier(3, &quot;Gyro damaged&quot;);</span>
                } else {
<span class="nc" id="L702">                    roll.addModifier(6, &quot;Gyro destroyed&quot;);</span>
                }
            }
        }

        // EI bonus?
<span class="nc bnc" id="L708" title="All 2 branches missed.">        if (hasActiveEiCockpit()) {</span>
<span class="nc" id="L709">            roll.addModifier(-1, &quot;Enhanced Imaging&quot;);</span>
        }

        // VDNI bonus?
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L715">            roll.addModifier(-1, &quot;VDNI&quot;);</span>
        }

        // Small/torso-mounted cockpit penalty?
<span class="nc bnc" id="L719" title="All 2 branches missed.">        if ((getCockpitType() == Mech.COCKPIT_SMALL)</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.UNOFF_SMALL_PILOT)) {</span>
<span class="nc" id="L722">            roll.addModifier(1, &quot;Small Cockpit&quot;);</span>
        }

<span class="nc bnc" id="L725" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_CRAMPED_COCKPIT) &amp;&amp; !hasAbility(OptionsConstants.UNOFF_SMALL_PILOT)) {</span>
<span class="nc" id="L726">            roll.addModifier(1, &quot;cramped cockpit&quot;);</span>
        }

<span class="nc" id="L729">        int avionicsHits = getAvionicsHits();</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">        if (avionicsHits &gt; 2) {</span>
<span class="nc" id="L731">            roll.addModifier(5, &quot;avionics destroyed&quot;);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">        } else if (avionicsHits &gt; 0) {</span>
<span class="nc" id="L733">            roll.addModifier(avionicsHits, &quot;avionics damage&quot;);</span>
        }

<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (moved == EntityMovementType.MOVE_OVER_THRUST) {</span>
<span class="nc" id="L738">                roll.addModifier(+1, &quot;Used more than safe thrust&quot;);</span>
            }
            
<span class="nc" id="L741">            int vel = getCurrentVelocity();</span>
<span class="nc" id="L742">            int vmod = vel - (2 * getWalkMP());</span>
<span class="nc bnc" id="L743" title="All 4 branches missed.">            if (!getGame().getBoard().inSpace() &amp;&amp; (vmod &gt; 0)) {</span>
<span class="nc" id="L744">                roll.addModifier(vmod, &quot;Velocity greater than 2x safe thrust&quot;);</span>
            }

<span class="nc" id="L747">            int atmoCond = game.getPlanetaryConditions().getAtmosphere();</span>
            // add in atmospheric effects later
<span class="nc bnc" id="L749" title="All 6 branches missed.">            if (!(game.getBoard().inSpace() || (atmoCond == PlanetaryConditions.ATMO_VACUUM)) &amp;&amp; isAirborne()) {</span>
<span class="nc" id="L750">                roll.addModifier(+1, &quot;Atmospheric operations&quot;);</span>
            }

<span class="nc bnc" id="L753" title="All 4 branches missed.">            if (hasQuirk(OptionsConstants.QUIRK_POS_ATMO_FLYER) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L754">                roll.addModifier(-1, &quot;atmospheric flyer&quot;);</span>
            }
<span class="nc bnc" id="L756" title="All 4 branches missed.">            if (hasQuirk(OptionsConstants.QUIRK_NEG_ATMO_INSTABILITY) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L757">                roll.addModifier(+1, &quot;atmospheric flight instability&quot;);</span>
            }
        }

<span class="nc" id="L761">        return roll;</span>
    }

    /**
     * Landing in AirMech mode requires a control roll only if the gyro or any
     * of the hip or leg actuators are damaged.
     *
     * @return The control roll that must be passed to land safely.
     */
    public PilotingRollData checkAirMechLanding() {
        // Base piloting skill
<span class="nc" id="L772">        PilotingRollData roll = new PilotingRollData(getId(), getCrew().getPiloting(), &quot;Base piloting skill&quot;);</span>

<span class="nc" id="L774">        addEntityBonuses(roll);</span>

        // Landing in AirMech mode only requires a roll if gyro or hip/leg
        // actuators are damaged.
<span class="nc" id="L778">        int gyroHits = getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, Mech.LOC_CT);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (getGyroType() == Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L780">            gyroHits--;</span>
        }

<span class="nc bnc" id="L783" title="All 2 branches missed.">        boolean required = gyroHits &gt; 0;</span>

<span class="nc bnc" id="L785" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">            if (locationIsLeg(loc)) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                if (isLocationBad(loc)) {</span>
<span class="nc" id="L788">                    roll.addModifier(5, getLocationName(loc) + &quot; destroyed&quot;);</span>
<span class="nc" id="L789">                    required = true;</span>
                } else {
                    // check for damaged hip actuators
<span class="nc bnc" id="L792" title="All 2 branches missed.">                    if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_HIP, loc) &gt; 0) {</span>
<span class="nc" id="L793">                        roll.addModifier(2, getLocationName(loc) + &quot; Hip Actuator destroyed&quot;);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                        if (!game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_LEG_DAMAGE)) {</span>
<span class="nc" id="L795">                            continue;</span>
                        }
<span class="nc" id="L797">                        required = true;</span>
                    }
                    // upper leg actuators?
<span class="nc bnc" id="L800" title="All 2 branches missed.">                    if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_UPPER_LEG, loc) &gt; 0) {</span>
<span class="nc" id="L801">                        roll.addModifier(1, getLocationName(loc) + &quot; Upper Leg Actuator destroyed&quot;);</span>
<span class="nc" id="L802">                        required = true;</span>
                    }
                    // lower leg actuators?
<span class="nc bnc" id="L805" title="All 2 branches missed.">                    if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_LOWER_LEG, loc) &gt; 0) {</span>
<span class="nc" id="L806">                        roll.addModifier(1, getLocationName(loc) + &quot; Lower Leg Actuator destroyed&quot;);</span>
<span class="nc" id="L807">                        required = true;</span>
                    }
                    // foot actuators?
<span class="nc bnc" id="L810" title="All 2 branches missed.">                    if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_FOOT, loc) &gt; 0) {</span>
<span class="nc" id="L811">                        roll.addModifier(1, getLocationName(loc) + &quot; Foot Actuator destroyed&quot;);</span>
<span class="nc" id="L812">                        required = true;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L817" title="All 2 branches missed.">        if (required) {</span>
<span class="nc" id="L818">            roll.addModifier(0, &quot;landing with gyro or leg damage&quot;);</span>
        } else {
<span class="nc" id="L820">            roll.addModifier(TargetRoll.CHECK_FALSE, &quot;Check not required for landing&quot;);</span>
        }
<span class="nc" id="L822">        return roll;</span>
    }

    @Override
    public int getMaxElevationDown(int currElevation) {
        // Cannot spend AirMech MP above altitude 3 (level 30) so we use that as
        // max descent.
<span class="nc bnc" id="L829" title="All 4 branches missed.">        if ((currElevation &gt; 0) &amp;&amp; (getConversionMode() == CONV_MODE_AIRMECH)) {</span>
<span class="nc" id="L830">            return 30;</span>
        }
<span class="nc" id="L832">        return super.getMaxElevationDown(currElevation);</span>
    }

    @Override
    public boolean canChangeSecondaryFacing() {
<span class="nc bnc" id="L837" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_MECH) {</span>
<span class="nc" id="L838">            return super.canChangeSecondaryFacing();</span>
        } else {
<span class="nc" id="L840">            return false;</span>
        }
    }

    /**
     * Start a new round
     *
     * @param roundNumber
     *            the &lt;code&gt;int&lt;/code&gt; number of the new round
     */
    @Override
    public void newRound(int roundNumber) {
<span class="nc" id="L852">        super.newRound(roundNumber);</span>
<span class="nc" id="L853">        previousMovementMode = movementMode;</span>

        // reset threshold critted
<span class="nc" id="L856">        setCritThresh(false);</span>

        // reset maneuver status
<span class="nc" id="L859">        setFailedManeuver(false);</span>
        // reset acc/dec this turn
<span class="nc" id="L861">        setAccDecNow(false);</span>

<span class="nc" id="L863">        updateBays();</span>

        // update recovery turn if in recovery
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if (getRecoveryTurn() &gt; 0) {</span>
<span class="nc" id="L867">            setRecoveryTurn(getRecoveryTurn() - 1);</span>
        }

<span class="nc" id="L870">        airmechBombTarget = null;</span>

<span class="nc bnc" id="L872" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
            // if in atmosphere, then halve next turn's velocity
<span class="nc bnc" id="L874" title="All 6 branches missed.">            if (!game.getBoard().inSpace() &amp;&amp; isDeployed() &amp;&amp; (roundNumber &gt; 0)) {</span>
<span class="nc" id="L875">                setNextVelocity((int) Math.floor(getNextVelocity() / 2.0));</span>
            }

            // update velocity
<span class="nc" id="L879">            setCurrentVelocity(getNextVelocity());</span>

            // if they are out of control due to heat, then apply this and reset
<span class="nc bnc" id="L882" title="All 2 branches missed.">            if (isOutCtrlHeat()) {</span>
<span class="nc" id="L883">                setOutControl(true);</span>
<span class="nc" id="L884">                setOutCtrlHeat(false);</span>
            }

            // get new random whofirst
<span class="nc" id="L888">            setWhoFirst();</span>

<span class="nc" id="L890">            resetAltLossThisRound();</span>
        }
<span class="nc" id="L892">    }</span>

    /**
     * Cannot make any physical attacks in fighter mode except ramming, which is
     * handled in the movement phase.
     */
    @Override
    public boolean isEligibleForPhysical() {
<span class="nc bnc" id="L900" title="All 4 branches missed.">        return getConversionMode() != CONV_MODE_FIGHTER &amp;&amp; super.isEligibleForPhysical();</span>
    }

    @Override
    public boolean canCharge() {
<span class="nc bnc" id="L905" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER</span>
<span class="nc bnc" id="L906" title="All 4 branches missed.">                || ((getConversionMode() == CONV_MODE_AIRMECH) &amp;&amp; isAirborneVTOLorWIGE())) {</span>
<span class="nc" id="L907">            return false;</span>
        } else {
<span class="nc" id="L909">            return super.canCharge();</span>
        }
    }

    @Override
    public boolean canRam() {
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L916" title="All 4 branches missed.">            return !isImmobile() &amp;&amp; (getWalkMP() &gt; 0);</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L918">            return isAirborneVTOLorWIGE();</span>
        } else {
<span class="nc" id="L920">            return false;</span>
        }
    }

    /*
     * Cycling through conversion modes for LAMs in 'Mech or fighter mode is
     * simple toggling between two states. LAMs in AirMech mode have three
     * possible states.
     */
    @Override
    public EntityMovementMode nextConversionMode(EntityMovementMode afterMode) {
<span class="nc bnc" id="L931" title="All 4 branches missed.">        boolean inSpace = game != null &amp;&amp; game.getBoard().inSpace();</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (previousMovementMode == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">            if (afterMode == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L934">                return EntityMovementMode.AERODYNE;</span>
<span class="nc bnc" id="L935" title="All 4 branches missed.">            } else if (afterMode == EntityMovementMode.AERODYNE || afterMode == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L936">                return originalMovementMode;</span>
            } else {
<span class="nc" id="L938">                return EntityMovementMode.WIGE;</span>
            }
<span class="nc bnc" id="L940" title="All 2 branches missed.">        } else if (afterMode == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">            return inSpace ? EntityMovementMode.AERODYNE : previousMovementMode;</span>
<span class="nc bnc" id="L942" title="All 4 branches missed.">        } else if (afterMode == EntityMovementMode.AERODYNE || afterMode == EntityMovementMode.WHEELED) {</span>
<span class="nc bnc" id="L943" title="All 4 branches missed.">            return (inSpace || lamType == LAM_BIMODAL) ? originalMovementMode : EntityMovementMode.WIGE;</span>
        } else {
<span class="nc bnc" id="L945" title="All 2 branches missed.">            return lamType == LAM_BIMODAL ? EntityMovementMode.AERODYNE : EntityMovementMode.WIGE;</span>
        }
    }

    public boolean canConvertTo(EntityMovementMode toMode) {
<span class="nc" id="L950">        return canConvertTo(getConversionMode(), getConversionModeFor(toMode));</span>
    }

    public boolean canConvertTo(int fromMode, EntityMovementMode toMode) {
<span class="nc" id="L954">        return canConvertTo(fromMode, getConversionModeFor(toMode));</span>
    }

    /**
     * Determines whether it is possible to assume a particular mode based on
     * damage and type of map.
     *
     * @param fromMode
     *            The mode to convert from (one of CONV_MODE_MECH,
     *            CONV_MODE_AIRMECH, or CONV_MODE_FIGHTER)
     * @param toMode
     *            The mode to convert to (one of CONV_MODE_MECH,
     *            CONV_MODE_AIRMECH, or CONV_MODE_FIGHTER)
     * @return true if it is possible for the LAM to convert to the given mode.
     */
    public boolean canConvertTo(int fromMode, int toMode) {
        // Cannot convert with any gyro damage
<span class="nc" id="L971">        int gyroHits = getBadCriticals(CriticalSlot.TYPE_SYSTEM, SYSTEM_GYRO, LOC_CT);</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">        if (getGyroType() == Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L973">            gyroHits--;</span>
        }
<span class="nc bnc" id="L975" title="All 2 branches missed.">        if (gyroHits &gt; 0) {</span>
<span class="nc" id="L976">            return false;</span>
        }

        // Cannot convert to or from mech mode with damage shoulder or arm
        // actuators
<span class="nc bnc" id="L981" title="All 4 branches missed.">        if ((toMode == CONV_MODE_MECH || fromMode == CONV_MODE_MECH)</span>
<span class="nc" id="L982">                &amp;&amp; (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_SHOULDER, LOC_RARM)</span>
<span class="nc" id="L983">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_UPPER_ARM, LOC_RARM)</span>
<span class="nc" id="L984">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_LOWER_ARM, LOC_RARM)</span>
<span class="nc" id="L985">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_SHOULDER, LOC_LARM)</span>
<span class="nc" id="L986">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_UPPER_ARM, LOC_LARM)</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_LOWER_ARM, LOC_LARM) &gt; 0)) {</span>
<span class="nc" id="L988">            return false;</span>
        }

        // Cannot convert to or from fighter mode with damage hip or leg
        // actuators
<span class="nc bnc" id="L993" title="All 4 branches missed.">        if ((toMode == CONV_MODE_FIGHTER || fromMode == CONV_MODE_FIGHTER)</span>
<span class="nc" id="L994">                &amp;&amp; (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_HIP, LOC_RLEG)</span>
<span class="nc" id="L995">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_UPPER_LEG, LOC_RLEG)</span>
<span class="nc" id="L996">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_LOWER_LEG, LOC_RLEG)</span>
<span class="nc" id="L997">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_HIP, LOC_LLEG)</span>
<span class="nc" id="L998">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_UPPER_LEG, LOC_LLEG)</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">                        + getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_LOWER_LEG, LOC_LLEG) &gt; 0)) {</span>
<span class="nc" id="L1000">            return false;</span>
        }

<span class="nc bnc" id="L1003" title="All 2 branches missed.">        if (toMode == CONV_MODE_AIRMECH) {</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            if (getLAMType() == LAM_BIMODAL) {</span>
<span class="nc" id="L1005">                return false;</span>
            }
<span class="nc bnc" id="L1007" title="All 2 branches missed.">        } else if (toMode == CONV_MODE_FIGHTER) {</span>
            // Standard LAMs can convert from mech to fighter mode in a single
            // round on a space map
<span class="nc bnc" id="L1010" title="All 2 branches missed.">            if (fromMode == CONV_MODE_MECH) {</span>
<span class="nc bnc" id="L1011" title="All 4 branches missed.">                return getLAMType() == LAM_BIMODAL || game.getBoard().inSpace();</span>
            }
<span class="nc bnc" id="L1013" title="All 2 branches missed.">        } else if (toMode == CONV_MODE_MECH) {</span>
            // Standard LAMs can convert from fighter to mech mode in a single
            // round on a space map
<span class="nc bnc" id="L1016" title="All 2 branches missed.">            if (fromMode == CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L1017" title="All 4 branches missed.">                return getLAMType() == LAM_BIMODAL || game.getBoard().inSpace();</span>
            }
        }
<span class="nc" id="L1020">        return true;</span>
    }

    public int getConversionModeFor(EntityMovementMode mmode) {
<span class="nc bnc" id="L1024" title="All 4 branches missed.">        if (mmode == EntityMovementMode.AERODYNE || mmode == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L1025">            return CONV_MODE_FIGHTER;</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">        } else if (mmode == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L1027">            return CONV_MODE_AIRMECH;</span>
        } else {
<span class="nc" id="L1029">            return CONV_MODE_MECH;</span>
        }
    }

    @Override
    public boolean canFall(boolean gyroLegDamage) {
<span class="nc bnc" id="L1035" title="All 6 branches missed.">        return getConversionMode() != CONV_MODE_FIGHTER &amp;&amp; !isAirborneVTOLorWIGE() &amp;&amp; super.canFall(gyroLegDamage);</span>
    }
    
<span class="nc" id="L1038">    private static final TechAdvancement[] TA_LAM = {</span>
<span class="nc" id="L1039">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(2683, 2688, DATE_NONE, 3085)</span>
<span class="nc" id="L1040">                .setClanAdvancement(DATE_NONE, 2688, DATE_NONE, 2825)</span>
<span class="nc" id="L1041">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="nc" id="L1042">                .setTechRating(RATING_D).setAvailability(RATING_D, RATING_E, RATING_F, RATING_F)</span>
<span class="nc" id="L1043">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL), //standard</span>
<span class="nc" id="L1044">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(2680, 2684, DATE_NONE, 2781)</span>
<span class="nc" id="L1045">                .setClanAdvancement(DATE_NONE, 2684, DATE_NONE, 2801)</span>
<span class="nc" id="L1046">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="nc" id="L1047">                .setTechRating(RATING_E).setAvailability(RATING_E, RATING_F, RATING_X, RATING_X)</span>
<span class="nc" id="L1048">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL) //bimodal</span>
    };
    
    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="nc" id="L1053">        return TA_LAM[lamType];</span>
    }
    
    public int height() {
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_MECH) {</span>
<span class="nc" id="L1058">            return super.height();</span>
        }
<span class="nc" id="L1060">        return 0;</span>
    }

    /**
     * LAMs can only carry mechanized BA in mech mode
     * 
     * @return
     */
    @Override
    public boolean canLoad(Entity unit, boolean checkElev) {
<span class="nc bnc" id="L1070" title="All 4 branches missed.">        return (getConversionMode() == CONV_MODE_MECH) &amp;&amp; super.canLoad(unit, checkElev);</span>
    }

    /**
     * Bomb ordnance is treated as inferno ammo for purposes of avoiding
     * explosion due to heat.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the unit is still loaded with inferno rounds
     *         or bomb ordnance.
     */
    @Override
    public boolean hasInfernoAmmo() {
<span class="nc bnc" id="L1082" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L1083" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_BOMB_BAY) &amp;&amp; m.getLinked() != null) {</span>
<span class="nc" id="L1084">                Mounted bomb = m.getLinked();</span>
                // We may have to go through a launcher to get to the ordnance
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                if (bomb.getLinked() != null) {</span>
<span class="nc" id="L1087">                    bomb = bomb.getLinked();</span>
                }
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                if (bomb.getExplosionDamage() &gt; 0) {</span>
<span class="nc" id="L1090">                    return true;</span>
                }
            }
<span class="nc" id="L1093">        }</span>
<span class="nc" id="L1094">        return super.hasInfernoAmmo();</span>
    }

    /** Fighter Mode **/

    public void setWhoFirst() {
<span class="nc" id="L1100">        whoFirst = Compute.randomInt(500);</span>
<span class="nc" id="L1101">    }</span>

    public int getWhoFirst() {
<span class="nc" id="L1104">        return whoFirst;</span>
    }

    @Override
    public int getMaxBombPoints() {
<span class="nc" id="L1109">        return countWorkingMisc(MiscType.F_BOMB_BAY);</span>
    }

    @Override
    public int getMaxBombSize() {
<span class="nc" id="L1114">        return Math.max(emptyBaysInLoc(LOC_CT), Math.max(emptyBaysInLoc(LOC_RT), emptyBaysInLoc(LOC_LT)));</span>
    }

    @Override
    public int[] getBombChoices() {
<span class="nc" id="L1119">        return bombChoices.clone();</span>
    }

    @Override
    public void setBombChoices(int[] bc) {
<span class="nc bnc" id="L1124" title="All 2 branches missed.">        if (bc.length == bombChoices.length) {</span>
<span class="nc" id="L1125">            bombChoices = bc;</span>
        }
<span class="nc" id="L1127">    }</span>

    @Override
    public void clearBombChoices() {
<span class="nc" id="L1131">        Arrays.fill(bombChoices, 0);</span>
<span class="nc" id="L1132">    }</span>

    @Override
    public Targetable getVTOLBombTarget() {
<span class="nc" id="L1136">        return airmechBombTarget;</span>
    }

    @Override
    public void setVTOLBombTarget(Targetable t) {
<span class="nc" id="L1141">        airmechBombTarget = t;</span>
<span class="nc" id="L1142">    }</span>

    @Override
    public boolean isMakingVTOLGroundAttack() {
<span class="nc bnc" id="L1146" title="All 2 branches missed.">        return airmechBombTarget != null;</span>
    }

    @Override
    public int getCurrentVelocity() {
        // if using advanced movement then I just want to sum up
        // the different vectors
<span class="nc bnc" id="L1153" title="All 4 branches missed.">        if ((game != null) &amp;&amp; game.useVectorMove()) {</span>
<span class="nc" id="L1154">            return getVelocity();</span>
        }
<span class="nc" id="L1156">        return currentVelocity;</span>
    }

    @Override
    public void setCurrentVelocity(int velocity) {
<span class="nc" id="L1161">        currentVelocity = velocity;</span>
<span class="nc" id="L1162">    }</span>

    @Override
    public int getNextVelocity() {
<span class="nc" id="L1166">        return nextVelocity;</span>
    }

    @Override
    public void setNextVelocity(int velocity) {
<span class="nc" id="L1171">        nextVelocity = velocity;</span>
<span class="nc" id="L1172">    }</span>

    @Override
    public int getCurrentVelocityActual() {
<span class="nc" id="L1176">        return currentVelocity;</span>
    }

    @Override
    public boolean isRolled() {
<span class="nc" id="L1181">        return rolled;</span>
    }

    @Override
    public boolean isOutControlTotal() {
<span class="nc bnc" id="L1186" title="All 6 branches missed.">        return outControl || shutDown || getCrew().isUnconscious();</span>
    }

    @Override
    public boolean isOutControl() {
<span class="nc" id="L1191">        return outControl;</span>
    }

    @Override
    public void setOutControl(boolean ocontrol) {
<span class="nc" id="L1196">        outControl = ocontrol;</span>
<span class="nc" id="L1197">    }</span>

    @Override
    public boolean isOutCtrlHeat() {
<span class="nc" id="L1201">        return outCtrlHeat;</span>
    }

    @Override
    public void setOutCtrlHeat(boolean octrlheat) {
<span class="nc" id="L1206">        outCtrlHeat = octrlheat;</span>
<span class="nc" id="L1207">    }</span>

    @Override
    public boolean isRandomMove() {
<span class="nc" id="L1211">        return randomMove;</span>
    }

    @Override
    public void setRandomMove(boolean randmove) {
<span class="nc" id="L1216">        randomMove = randmove;</span>
<span class="nc" id="L1217">    }</span>

    @Override
    public void setRolled(boolean roll) {
<span class="nc" id="L1221">        rolled = roll;</span>
<span class="nc" id="L1222">    }</span>

    @Override
    public boolean didAccLast() {
<span class="nc" id="L1226">        return accLast;</span>
    }

    @Override
    public void setAccLast(boolean b) {
<span class="nc" id="L1231">        accLast = b;</span>
<span class="nc" id="L1232">    }</span>

    @Override
    public void setSI(int si) {
<span class="nc" id="L1236">        setInternal(si, LOC_CT);</span>
<span class="nc" id="L1237">    }</span>

    @Override
    public int getSI() {
<span class="nc" id="L1241">        return getInternal(LOC_CT);</span>
    }

    @Override
    public int get0SI() {
<span class="nc" id="L1246">        return getOInternal(LOC_CT);</span>
    }

    @Override
    public boolean hasLifeSupport() {
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        return getGoodCriticals(CriticalSlot.TYPE_SYSTEM, SYSTEM_LIFE_SUPPORT, LOC_HEAD) &gt; 0;</span>
    }

    /**
     * Used to determine modifier for landing.
     */
    @Override
    public int getNoseArmor() {
<span class="nc" id="L1259">        return getArmor(LOC_CT);</span>
    }

    /**
     * returns exposure or breached flag for location
     */
    @Override
    public int getLocationStatus(int loc) {
<span class="nc bnc" id="L1267" title="All 4 branches missed.">        switch (loc) {</span>
        case LOC_CAPITAL_NOSE:
<span class="nc" id="L1269">            return Math.max(super.getLocationStatus(LOC_HEAD), super.getLocationStatus(LOC_CT));</span>
        case LOC_CAPITAL_AFT:
<span class="nc" id="L1271">            return Math.max(super.getLocationStatus(LOC_RLEG), super.getLocationStatus(LOC_LLEG));</span>
        case LOC_CAPITAL_WINGS:
<span class="nc" id="L1273">            return Math.max(Math.max(super.getLocationStatus(LOC_RT), super.getLocationStatus(LOC_RARM)),</span>
<span class="nc" id="L1274">                    Math.max(super.getLocationStatus(LOC_LT), super.getLocationStatus(LOC_LARM)));</span>
        default:
<span class="nc" id="L1276">            return super.getLocationStatus(loc);</span>
        }
    }

    @Override
    public int getAvionicsHits() {
<span class="nc" id="L1282">        int hits = 0;</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L1284">            hits += getBadCriticals(CriticalSlot.TYPE_SYSTEM, LAM_AVIONICS, loc);</span>
        }
<span class="nc" id="L1286">        return hits;</span>
    }

    @Override
    public int getSensorHits() {
<span class="nc" id="L1291">        return getBadCriticals(CriticalSlot.TYPE_SYSTEM, SYSTEM_SENSORS, LOC_HEAD);</span>
    }

    @Override
    public int getFCSHits() {
<span class="nc" id="L1296">        return 0;</span>
    }

    @Override
    public int getLeftThrustHits() {
<span class="nc" id="L1301">        return 0;</span>
    }

    @Override
    public int getRightThrustHits() {
<span class="nc" id="L1306">        return 0;</span>
    }

    @Override
    public void setGearHit(boolean hit) {
<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (hit) {</span>
<span class="nc" id="L1312">            List&lt;CriticalSlot&gt; gearSlots = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">                for (int i = 0; i &lt; crits[loc].length; i++) {</span>
<span class="nc" id="L1315">                    final CriticalSlot slot = crits[loc][i];</span>
<span class="nc bnc" id="L1316" title="All 4 branches missed.">                    if (slot != null &amp;&amp; slot.getType() == CriticalSlot.TYPE_SYSTEM</span>
<span class="nc bnc" id="L1317" title="All 4 branches missed.">                            &amp;&amp; slot.getIndex() == LAM_LANDING_GEAR &amp;&amp; !slot.isDestroyed()) {</span>
<span class="nc" id="L1318">                        gearSlots.add(slot);</span>
                    }
                }
            }
<span class="nc bnc" id="L1322" title="All 2 branches missed.">            if (gearSlots.size() &gt; 0) {</span>
<span class="nc" id="L1323">                int index = Compute.randomInt(gearSlots.size());</span>
<span class="nc" id="L1324">                gearSlots.get(index).setDestroyed(true);</span>
            }
        }
<span class="nc" id="L1327">    }</span>

    /**
     * Modifier to landing or vertical takeoff roll for landing gear damage.
     *
     * @param vTakeoff
     *            true if this is for a vertical takeoff, false if for a landing
     * @return the control roll modifier
     */
    @Override
    public int getLandingGearMod(boolean vTakeoff) {
<span class="nc" id="L1338">        int hits = 0;</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L1340">            hits += getBadCriticals(CriticalSlot.TYPE_SYSTEM, LAM_LANDING_GEAR, loc);</span>
        }
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        if (vTakeoff) {</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">            return hits &gt; 0 ? 1 : 0;</span>
        } else {
<span class="nc bnc" id="L1345" title="All 2 branches missed.">            return hits &gt; 3 ? 5 : hits;</span>
        }
    }
    
    //Landing mods for partial repairs
    public int getLandingGearPartialRepairs() {
<span class="nc bnc" id="L1351" title="All 2 branches missed.">    	if (getPartialRepairs().booleanOption(&quot;aero_gear_crit&quot;)) {</span>
<span class="nc" id="L1352">        return 2;</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">    	} else if (getPartialRepairs().booleanOption(&quot;aero_gear_replace&quot;)) {</span>
<span class="nc" id="L1354">        return 1;</span>
    	} else {
<span class="nc" id="L1356">    	return 0;</span>
    	}
    }
    
    //Avionics mods for partial repairs
    public int getAvionicsMisreplaced() {
<span class="nc bnc" id="L1362" title="All 2 branches missed.">    	if (getPartialRepairs().booleanOption(&quot;aero_avionics_replace&quot;)) {</span>
<span class="nc" id="L1363">        return 1;</span>
    	} else {
<span class="nc" id="L1365">    	return 0;</span>
    	}
    }
    
    public int getAvionicsMisrepaired() {
<span class="nc bnc" id="L1370" title="All 2 branches missed.">    	if (getPartialRepairs().booleanOption(&quot;aero_avionics_crit&quot;)) {</span>
<span class="nc" id="L1371">        return 1;</span>
    	} else {
<span class="nc" id="L1373">    	return 0;</span>
    	}
    }    

    /**
     * In fighter mode the weapon arcs need to be translated to Aero arcs.
     */
    @Override
    public int getWeaponArc(int wn) {
<span class="nc bnc" id="L1382" title="All 2 branches missed.">        if (getConversionMode() != CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L1383">            return super.getWeaponArc(wn);</span>
        }
<span class="nc" id="L1385">        final Mounted mounted = getEquipment(wn);</span>
<span class="nc bnc" id="L1386" title="All 4 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_SPACE_BOMB) || mounted.getType().hasFlag(WeaponType.F_DIVE_BOMB)</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">                || mounted.getType().hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L1388">            return Compute.ARC_360;</span>
        }
        // We use Aero locations for weapon groups for fighter squadron
        // compatibility
<span class="nc bnc" id="L1392" title="All 2 branches missed.">        if (mounted.isWeaponGroup()) {</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">            return (mounted.getLocation() == Aero.LOC_AFT) ? Compute.ARC_AFT : Compute.ARC_NOSE;</span>
        }
<span class="nc" id="L1395">        int arc = Compute.ARC_NOSE;</span>
<span class="nc bnc" id="L1396" title="All 8 branches missed.">        switch (mounted.getLocation()) {</span>
        case LOC_HEAD:
<span class="nc" id="L1398">            arc = Compute.ARC_NOSE;</span>
<span class="nc" id="L1399">            break;</span>
        case LOC_CT:
<span class="nc bnc" id="L1401" title="All 2 branches missed.">            if (mounted.isRearMounted()) {</span>
<span class="nc" id="L1402">                arc = Compute.ARC_AFT;</span>
            } else {
<span class="nc" id="L1404">                arc = Compute.ARC_NOSE;</span>
            }
<span class="nc" id="L1406">            break;</span>
        case LOC_RT:
<span class="nc bnc" id="L1408" title="All 2 branches missed.">            if (mounted.isRearMounted()) {</span>
<span class="nc" id="L1409">                arc = Compute.ARC_RWINGA;</span>
            } else {
<span class="nc" id="L1411">                arc = Compute.ARC_RWING;</span>
            }
<span class="nc" id="L1413">            break;</span>
        case LOC_LT:
<span class="nc bnc" id="L1415" title="All 2 branches missed.">            if (mounted.isRearMounted()) {</span>
<span class="nc" id="L1416">                arc = Compute.ARC_LWINGA;</span>
            } else {
<span class="nc" id="L1418">                arc = Compute.ARC_LWING;</span>
            }
<span class="nc" id="L1420">            break;</span>
        case LOC_RARM:
<span class="nc" id="L1422">            arc = Compute.ARC_RWING;</span>
<span class="nc" id="L1423">            break;</span>
        case LOC_LARM:
<span class="nc" id="L1425">            arc = Compute.ARC_LWING;</span>
<span class="nc" id="L1426">            break;</span>
        case LOC_RLEG:
        case LOC_LLEG:
<span class="nc" id="L1429">            arc = Compute.ARC_AFT;</span>
<span class="nc" id="L1430">            break;</span>
        default:
<span class="nc" id="L1432">            arc = Compute.ARC_360;</span>
        }

<span class="nc" id="L1435">        return rollArcs(arc);</span>
    }

    /**
     * Hit location table for fighter mode
     */
    @Override
    public HitData rollHitLocation(int table, int side) {
<span class="nc bnc" id="L1443" title="All 2 branches missed.">        if (getConversionMode() != CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L1444">            return super.rollHitLocation(table, side);</span>
        }

<span class="nc" id="L1447">        int roll = Compute.d6(2);</span>

        // first check for above/below
<span class="nc bnc" id="L1450" title="All 4 branches missed.">        if ((table == ToHitData.HIT_ABOVE) || (table == ToHitData.HIT_BELOW)) {</span>

            // have to decide which arm/leg
<span class="nc" id="L1453">            int armloc = LOC_RARM;</span>
<span class="nc" id="L1454">            int legloc = LOC_RLEG;</span>
<span class="nc" id="L1455">            int wingroll = Compute.d6(1);</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">            if (wingroll &gt; 3) {</span>
<span class="nc" id="L1457">                armloc = LOC_LARM;</span>
<span class="nc" id="L1458">                legloc = LOC_LLEG;</span>
            }
<span class="nc bnc" id="L1460" title="All 6 branches missed.">            switch (roll) {</span>
            case 2:
            case 6:
<span class="nc" id="L1463">                return new HitData(LOC_RT, false, HitData.EFFECT_NONE);</span>
            case 3:
            case 4:
            case 10:
            case 11:
<span class="nc" id="L1468">                return new HitData(armloc, false, HitData.EFFECT_NONE);</span>
            case 5:
            case 9:
<span class="nc" id="L1471">                return new HitData(legloc, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1473">                return new HitData(LOC_CT, false, HitData.EFFECT_NONE);</span>
            case 8:
            case 12:
<span class="nc" id="L1476">                return new HitData(LOC_LT, false, HitData.EFFECT_NONE);</span>
            }
        }

<span class="nc bnc" id="L1480" title="All 2 branches missed.">        if (side == ToHitData.SIDE_FRONT) {</span>
            // normal front hits
<span class="nc bnc" id="L1482" title="All 7 branches missed.">            switch (roll) {</span>
            case 2:
            case 12:
<span class="nc" id="L1485">                return new HitData(LOC_CT, false, HitData.EFFECT_NONE);</span>
            case 3:
            case 6:
<span class="nc" id="L1488">                return new HitData(LOC_RT, false, HitData.EFFECT_NONE);</span>
            case 4:
            case 5:
<span class="nc" id="L1491">                return new HitData(LOC_RARM, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1493">                return new HitData(LOC_CT, false, HitData.EFFECT_NONE);</span>
            case 8:
            case 11:
<span class="nc" id="L1496">                return new HitData(LOC_LT, false, HitData.EFFECT_NONE);</span>
            case 9:
            case 10:
<span class="nc" id="L1499">                return new HitData(LOC_LARM, false, HitData.EFFECT_NONE);</span>
            }
<span class="nc bnc" id="L1501" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_LEFT) {</span>
            // normal left-side hits
<span class="nc bnc" id="L1503" title="All 6 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1505">                return new HitData(LOC_HEAD, false, HitData.EFFECT_NONE);</span>
            case 3:
            case 7:
            case 11:
<span class="nc" id="L1509">                return new HitData(LOC_LARM, false, HitData.EFFECT_NONE);</span>
            case 4:
            case 5:
<span class="nc" id="L1512">                return new HitData(LOC_CT, false, HitData.EFFECT_NONE);</span>
            case 6:
            case 8:
<span class="nc" id="L1515">                return new HitData(LOC_LT, false, HitData.EFFECT_NONE);</span>
            case 9:
            case 10:
            case 12:
<span class="nc" id="L1519">                return new HitData(LOC_LLEG, false, HitData.EFFECT_NONE);</span>
            }
<span class="nc bnc" id="L1521" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_RIGHT) {</span>
            // normal right-side hits
<span class="nc bnc" id="L1523" title="All 6 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1525">                return new HitData(LOC_HEAD, false, HitData.EFFECT_NONE);</span>
            case 3:
            case 7:
            case 11:
<span class="nc" id="L1529">                return new HitData(LOC_RARM, false, HitData.EFFECT_NONE);</span>
            case 4:
            case 5:
<span class="nc" id="L1532">                return new HitData(LOC_CT, false, HitData.EFFECT_NONE);</span>
            case 6:
            case 8:
<span class="nc" id="L1535">                return new HitData(LOC_RT, false, HitData.EFFECT_NONE);</span>
            case 9:
            case 10:
            case 12:
<span class="nc" id="L1539">                return new HitData(LOC_RLEG, false, HitData.EFFECT_NONE);</span>
            }
<span class="nc bnc" id="L1541" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_REAR) {</span>
            // rear torso locations are only hit on a roll of 5-6 on d6
<span class="nc bnc" id="L1543" title="All 2 branches missed.">            boolean rear = Compute.d6() &gt; 4;</span>
<span class="nc bnc" id="L1544" title="All 9 branches missed.">            switch (roll) {</span>
            case 2:
            case 12:
<span class="nc" id="L1547">                return new HitData(LOC_CT, rear, HitData.EFFECT_NONE);</span>
            case 3:
            case 4:
<span class="nc" id="L1550">                return new HitData(LOC_RT, rear, HitData.EFFECT_NONE);</span>
            case 5:
<span class="nc" id="L1552">                return new HitData(LOC_RARM, rear, HitData.EFFECT_NONE);</span>
            case 6:
<span class="nc" id="L1554">                return new HitData(LOC_RLEG, rear, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc bnc" id="L1556" title="All 2 branches missed.">                if (Compute.d6() &gt; 3) {</span>
<span class="nc" id="L1557">                    return new HitData(LOC_LLEG, rear, HitData.EFFECT_NONE);</span>
                } else {
<span class="nc" id="L1559">                    return new HitData(LOC_RLEG, rear, HitData.EFFECT_NONE);</span>
                }
            case 8:
<span class="nc" id="L1562">                return new HitData(LOC_LLEG, rear, HitData.EFFECT_NONE);</span>
            case 9:
<span class="nc" id="L1564">                return new HitData(LOC_LARM, rear, HitData.EFFECT_NONE);</span>
            case 10:
            case 11:
<span class="nc" id="L1567">                return new HitData(LOC_LT, rear, HitData.EFFECT_NONE);</span>
            }
        }
<span class="nc" id="L1570">        return new HitData(LOC_CT, false, HitData.EFFECT_NONE);</span>
    }

    @Override
    public int getFuel() {
<span class="nc bnc" id="L1575" title="All 2 branches missed.">        if ((getPartialRepairs().booleanOption(&quot;aero_asf_fueltank_crit&quot;))</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">        	|| (getPartialRepairs().booleanOption(&quot;aero_fueltank_crit&quot;))) {</span>
<span class="nc" id="L1577">        	return (int) (fuel * 0.9);</span>
        } else {
<span class="nc" id="L1579">        return fuel;</span>
        }
    }
    
    public int getCurrentFuel() {
<span class="nc bnc" id="L1584" title="All 2 branches missed.">        if ((getPartialRepairs().booleanOption(&quot;aero_asf_fueltank_crit&quot;))</span>
<span class="nc bnc" id="L1585" title="All 2 branches missed.">            	|| (getPartialRepairs().booleanOption(&quot;aero_fueltank_crit&quot;))) {</span>
<span class="nc" id="L1586">            	return (int) (currentfuel * 0.9);</span>
        } else {
<span class="nc" id="L1588">        return currentfuel;</span>
        }
    }

    /**
     * Sets the number of fuel points.
     * 
     * @param gas
     *            Number of fuel points.
     */
    @Override
    public void setFuel(int gas) {
<span class="nc" id="L1600">        fuel = gas;</span>
<span class="nc" id="L1601">        currentfuel = gas;</span>
<span class="nc" id="L1602">    }</span>
    
    public void setCurrentFuel(int gas) {
<span class="nc" id="L1605">    	currentfuel = gas;</span>
<span class="nc" id="L1606">    }</span>

    @Override
    public double getFuelPointsPerTon() {
<span class="nc" id="L1610">        return 80;</span>
    }

    /**
     * Set number of fuel points based on fuel tonnage.
     *
     * @param fuelTons
     *            The number of tons of fuel
     */
    @Override
    public void setFuelTonnage(double fuelTons) {
<span class="nc" id="L1621">        double pointsPerTon = getFuelPointsPerTon();</span>
<span class="nc" id="L1622">        fuel = (int) Math.ceil(pointsPerTon * fuelTons);</span>
<span class="nc" id="L1623">    }</span>

    /**
     * Gets the fuel for this Aero in terms of tonnage.
     *
     * @return The number of tons of fuel on this Aero.
     */
    @Override
    public double getFuelTonnage() {
<span class="nc" id="L1632">        return fuel / getFuelPointsPerTon();</span>
    }

    /**
     * Exceeding damage threshold does not result in critical, but requires
     * control roll.
     */
    @Override
    public int getThresh(int loc) {
<span class="nc" id="L1641">        return getInternal(loc);</span>
    }

    @Override
    public boolean wasCritThresh() {
<span class="nc" id="L1646">        return critThresh;</span>
    }

    @Override
    public void setCritThresh(boolean b) {
<span class="nc" id="L1651">        critThresh = b;</span>
<span class="nc" id="L1652">    }</span>

    @Override
    public boolean isSpheroid() {
<span class="nc" id="L1656">        return false;</span>
    }

    @Override
    public int getStraightMoves() {
<span class="nc" id="L1661">        return straightMoves;</span>
    }

    @Override
    public void setStraightMoves(int i) {
<span class="nc" id="L1666">        straightMoves = i;</span>
<span class="nc" id="L1667">    }</span>

    @Override
    public int getAltLoss() {
<span class="nc" id="L1671">        return altLoss;</span>
    }

    @Override
    public void setAltLoss(int i) {
<span class="nc" id="L1676">        altLoss = i;</span>
<span class="nc" id="L1677">    }</span>

    @Override
    public void resetAltLoss() {
<span class="nc" id="L1681">        altLoss = 0;</span>
<span class="nc" id="L1682">    }</span>

    @Override
    public int getAltLossThisRound() {
<span class="nc" id="L1686">        return altLossThisRound;</span>
    }

    @Override
    public void setAltLossThisRound(int i) {
<span class="nc" id="L1691">        altLossThisRound = i;</span>
<span class="nc" id="L1692">    }</span>

    @Override
    public void resetAltLossThisRound() {
<span class="nc" id="L1696">        altLossThisRound = 0;</span>
<span class="nc" id="L1697">    }</span>

    @Override
    public boolean isVSTOL() {
<span class="nc" id="L1701">        return true;</span>
    }

    @Override
    public boolean isSTOL() {
<span class="nc" id="L1706">        return false;</span>
    }

    @Override
    public int getElevation() {
<span class="nc bnc" id="L1711" title="All 4 branches missed.">        if ((game != null) &amp;&amp; game.getBoard().inSpace()) {</span>
<span class="nc" id="L1712">            return 0;</span>
        }
        // Altitude is not the same as elevation. If an aero is at 0 altitude,
        // then it is
        // grounded and uses elevation normally. Otherwise, just set elevation
        // to a very
        // large number so that a flying aero won't interact with the ground
        // maps in any way
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc" id="L1721">            return 999;</span>
        }
<span class="nc" id="L1723">        return super.getElevation();</span>
    }

    @Override
    public int getFuelUsed(int thrust) {
<span class="nc" id="L1728">        int overThrust = Math.max(thrust - getWalkMP(), 0);</span>
<span class="nc" id="L1729">        int safeThrust = thrust - overThrust;</span>
<span class="nc" id="L1730">        int used = safeThrust + (2 * overThrust);</span>
<span class="nc" id="L1731">        return used;</span>
    }

    @Override
    public boolean didFailManeuver() {
<span class="nc" id="L1736">        return failedManeuver;</span>
    }

    @Override
    public void setFailedManeuver(boolean b) {
<span class="nc" id="L1741">        failedManeuver = b;</span>
<span class="nc" id="L1742">    }</span>

    @Override
    public void setAccDecNow(boolean b) {
<span class="nc" id="L1746">        accDecNow = b;</span>
<span class="nc" id="L1747">    }</span>

    @Override
    public boolean didAccDecNow() {
<span class="nc" id="L1751">        return accDecNow;</span>
    }

    @Override
    public int getCapArmor() {
<span class="nc" id="L1756">        return capitalArmor;</span>
    }

    @Override
    public void setCapArmor(int i) {
<span class="nc" id="L1761">        capitalArmor = i;</span>
<span class="nc" id="L1762">    }</span>

    @Override
    public int getCap0Armor() {
<span class="nc" id="L1766">        return capitalArmor_orig;</span>
    }

    @Override
    public int getFatalThresh() {
<span class="nc" id="L1771">        return fatalThresh;</span>
    }

    @Override
    public void autoSetCapArmor() {
<span class="nc" id="L1776">        double divisor = 10.0;</span>
<span class="nc bnc" id="L1777" title="All 4 branches missed.">        if ((null != game) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L1778">            divisor = 1.0;</span>
        }
<span class="nc" id="L1780">        capitalArmor_orig = (int) Math.round(getTotalOArmor() / divisor);</span>
<span class="nc" id="L1781">        capitalArmor = (int) Math.round(getTotalArmor() / divisor);</span>
<span class="nc" id="L1782">    }</span>

    @Override
    public void autoSetFatalThresh() {
<span class="nc" id="L1786">        int baseThresh = 2;</span>
<span class="nc bnc" id="L1787" title="All 4 branches missed.">        if ((null != game) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L1788">            baseThresh = 20;</span>
        }
<span class="nc" id="L1790">        fatalThresh = Math.max(baseThresh, (int) Math.ceil(capitalArmor / 4.0));</span>
<span class="nc" id="L1791">    }</span>

    @Override
    public int getCurrentDamage() {
<span class="nc" id="L1795">        return currentDamage;</span>
    }

    @Override
    public void setCurrentDamage(int i) {
<span class="nc" id="L1800">        currentDamage = i;</span>
<span class="nc" id="L1801">    }</span>

    @Override
    public Map&lt;String, Integer&gt; getWeaponGroups() {
<span class="nc" id="L1805">        return weaponGroups;</span>
    }

    /**
     * Provide weapon groups for capital fighters. For capital fighter purposes
     * we use Aero locations.
     */
    @Override
    public Map&lt;String, Integer&gt; groupWeaponsByLocation() {
<span class="nc" id="L1814">        Map&lt;String, Integer&gt; groups = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc" id="L1816">            int loc = LOC_CAPITAL_WINGS;</span>
<span class="nc bnc" id="L1817" title="All 4 branches missed.">            if ((loc == Mech.LOC_CT) || (loc == Mech.LOC_HEAD)) {</span>
<span class="nc" id="L1818">                loc = LOC_CAPITAL_NOSE;</span>
            }
<span class="nc bnc" id="L1820" title="All 6 branches missed.">            if (mounted.isRearMounted() || (loc == Mech.LOC_LLEG) || (loc == Mech.LOC_RLEG)) {</span>
<span class="nc" id="L1821">                loc = LOC_CAPITAL_AFT;</span>
            }
<span class="nc" id="L1823">            String key = mounted.getType().getInternalName() + &quot;:&quot; + loc;</span>
<span class="nc bnc" id="L1824" title="All 2 branches missed.">            if (null == groups.get(key)) {</span>
<span class="nc" id="L1825">                groups.put(key, mounted.getNWeapons());</span>
            } else {
<span class="nc" id="L1827">                groups.put(key, groups.get(key) + mounted.getNWeapons());</span>
            }
<span class="nc" id="L1829">        }</span>
<span class="nc" id="L1830">        return groups;</span>
    }

    // Damage a fighter that was part of a squadron when splitting it. Per
    // StratOps pg. 32 &amp; 34
    @Override
    public void doDisbandDamage() {

<span class="nc" id="L1838">        int dealt = 0;</span>
        // Check for critical threshold and if so damage one facing of the
        // fighter completely.
<span class="nc bnc" id="L1841" title="All 4 branches missed.">        if (isDestroyed() || isDoomed()) {</span>
            // Note starting armor + internal so we can compute how many damage
            // points were allocated
            // in this step.
<span class="nc" id="L1845">            int start = getTotalArmor() + getTotalInternal();</span>
<span class="nc" id="L1846">            int side = Compute.randomInt(4);</span>
<span class="nc bnc" id="L1847" title="All 5 branches missed.">            switch (side) {</span>
            case 0: // Nose
<span class="nc" id="L1849">                destroyLocation(LOC_HEAD);</span>
<span class="nc" id="L1850">                destroyLocation(LOC_CT);</span>
<span class="nc" id="L1851">                break;</span>
            case 1: // Left wing
<span class="nc" id="L1853">                destroyLocation(LOC_LT);</span>
<span class="nc" id="L1854">                destroyLocation(LOC_LARM);</span>
<span class="nc" id="L1855">                break;</span>
            case 2: // Right wing
<span class="nc" id="L1857">                destroyLocation(LOC_RT);</span>
<span class="nc" id="L1858">                destroyLocation(LOC_RARM);</span>
<span class="nc" id="L1859">                break;</span>
            case 3: // Aft
<span class="nc" id="L1861">                destroyLocation(LOC_LLEG);</span>
<span class="nc" id="L1862">                destroyLocation(LOC_RLEG);</span>
                break;
            }
            // Also apply three engine hits
<span class="nc" id="L1866">            int i = 0;</span>
<span class="nc" id="L1867">            int engineHits = getEngineHits();</span>
<span class="nc bnc" id="L1868" title="All 4 branches missed.">            while (engineHits &lt; 3 &amp;&amp; i &lt; getNumberOfCriticals(LOC_CT)) {</span>
<span class="nc" id="L1869">                final CriticalSlot slot = getCritical(LOC_CT, i);</span>
<span class="nc bnc" id="L1870" title="All 6 branches missed.">                if (slot != null &amp;&amp; slot.getType() == CriticalSlot.TYPE_SYSTEM &amp;&amp; slot.getIndex() == SYSTEM_ENGINE</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">                        &amp;&amp; !slot.isDamaged()) {</span>
<span class="nc" id="L1872">                    slot.setHit(true);</span>
<span class="nc" id="L1873">                    engineHits++;</span>
                }
<span class="nc" id="L1875">                i++;</span>
<span class="nc" id="L1876">            }</span>

<span class="nc" id="L1878">            dealt = start - getTotalArmor() - getTotalInternal();</span>
        }

        // Move on to actual damage...
<span class="nc" id="L1882">        int damage = getCap0Armor() - getCapArmor();</span>
<span class="nc bnc" id="L1883" title="All 4 branches missed.">        if ((null != game) || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L1884">            damage *= 10;</span>
        }
<span class="nc" id="L1886">        damage -= dealt;</span>

<span class="nc bnc" id="L1888" title="All 2 branches missed.">        if (damage &gt;= 0) {</span>
<span class="nc" id="L1889">            int hits = (int) Math.ceil(damage / 5.0);</span>
<span class="nc" id="L1890">            int damPerHit = 5;</span>
<span class="nc bnc" id="L1891" title="All 2 branches missed.">            for (int i = 0; i &lt; hits; i++) {</span>
<span class="nc" id="L1892">                int loc = rollHitLocation(ToHitData.HIT_ABOVE, ToHitData.SIDE_RANDOM).getLocation();</span>
<span class="nc" id="L1893">                setArmor(getArmor(loc) - Math.max(damPerHit, damage), loc);</span>
                // We did too much damage, so we need to damage the internal
                // structure
<span class="nc bnc" id="L1896" title="All 2 branches missed.">                if (getArmor(loc) &lt; 0) {</span>
<span class="nc bnc" id="L1897" title="All 2 branches missed.">                    if (getInternal(loc) &gt; 1) {</span>
<span class="nc" id="L1898">                        int internal = getInternal(loc) + getArmor(loc);</span>
<span class="nc bnc" id="L1899" title="All 2 branches missed.">                        if (internal &lt;= 0) {</span>
<span class="nc bnc" id="L1900" title="All 8 branches missed.">                            if ((loc == LOC_CT || loc == LOC_HEAD) &amp;&amp; !isDestroyed() &amp;&amp; !isDoomed()) {</span>
<span class="nc" id="L1901">                                setInternal(1, loc);// We don't want to destroy</span>
                                                    // the fighter if it didn't
                                                    // pass the fatal threshold
                            } else {
<span class="nc" id="L1905">                                destroyLocation(loc);</span>
                            }
                        }
                    }
<span class="nc" id="L1909">                    setArmor(0, loc);</span>
                }
<span class="nc" id="L1911">                damage -= damPerHit;</span>
            }
        }
<span class="nc" id="L1914">        applyDamage();</span>
<span class="nc" id="L1915">    }</span>

    @Override
    public void setBattleForceMovement(Map&lt;String, Integer&gt; movement) {
<span class="nc" id="L1919">        super.setBattleForceMovement(movement);</span>
<span class="nc" id="L1920">        movement.put(&quot;g&quot;, getAirMechCruiseMP(true, false));</span>
<span class="nc" id="L1921">        movement.put(&quot;a&quot;, getFighterModeWalkMP(true, false));</span>
<span class="nc" id="L1922">    }</span>

    @Override
    public void setAlphaStrikeMovement(Map&lt;String, Integer&gt; movement) {
<span class="nc" id="L1926">        super.setBattleForceMovement(movement);</span>
<span class="nc" id="L1927">        movement.put(&quot;g&quot;, getAirMechCruiseMP(true, false) * 2);</span>
<span class="nc" id="L1928">        movement.put(&quot;a&quot;, getFighterModeWalkMP(true, false));</span>
<span class="nc" id="L1929">    }</span>

    @Override
    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA, Integer&gt; specialAbilities) {
<span class="nc" id="L1933">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc" id="L1934">        int bombs = (int) getEquipment().stream().filter(m -&gt; m.getType().hasFlag(MiscType.F_BOMB_BAY)).count();</span>
<span class="nc bnc" id="L1935" title="All 2 branches missed.">        if (bombs &gt; 0) {</span>
<span class="nc" id="L1936">            specialAbilities.put(BattleForceSPA.BOMB, bombs / 5);</span>
        }
<span class="nc bnc" id="L1938" title="All 2 branches missed.">        if (lamType == LAM_BIMODAL) {</span>
<span class="nc" id="L1939">            specialAbilities.put(BattleForceSPA.BIM, null);</span>
        } else {
<span class="nc" id="L1941">            specialAbilities.put(BattleForceSPA.LAM, null);</span>
        }
<span class="nc" id="L1943">    }</span>

    @Override
    public String getTilesetModeString() {
<span class="nc bnc" id="L1947" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L1948">            return &quot;_FIGHTER&quot;;</span>
<span class="nc bnc" id="L1949" title="All 2 branches missed.">        } else if (getConversionMode() == CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L1950">            return &quot;_AIRMECH&quot;;</span>
        } else {
<span class="nc" id="L1952">            return &quot;&quot;;</span>
        }
    }

    @Override
    public boolean isAero() {
<span class="nc bnc" id="L1958" title="All 2 branches missed.">        return getConversionMode() == CONV_MODE_FIGHTER;</span>
    }

    @Override
    public boolean isBomber() {
<span class="nc" id="L1963">        return true;</span>
    }

    /**
     * Try to find a location that has enough empty bomb bays to accommodate the
     * bomb size
     */
    @Override
    public int availableBombLocation(int cost) {
<span class="nc bnc" id="L1972" title="All 2 branches missed.">        if (emptyBaysInLoc(LOC_RT) &gt;= cost) {</span>
<span class="nc" id="L1973">            return LOC_RT;</span>
<span class="nc bnc" id="L1974" title="All 2 branches missed.">        } else if (emptyBaysInLoc(LOC_LT) &gt;= cost) {</span>
<span class="nc" id="L1975">            return LOC_LT;</span>
<span class="nc bnc" id="L1976" title="All 2 branches missed.">        } else if (emptyBaysInLoc(LOC_CT) &gt;= cost) {</span>
<span class="nc" id="L1977">            return LOC_CT;</span>
        } else {
<span class="nc" id="L1979">            return LOC_NONE;</span>
        }
    }

    private int emptyBaysInLoc(int loc) {
<span class="nc" id="L1984">        int bays = 0;</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">        for (CriticalSlot slot : crits[loc]) {</span>
<span class="nc bnc" id="L1986" title="All 6 branches missed.">            if ((slot != null) &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; slot.getMount2() == null</span>
<span class="nc bnc" id="L1987" title="All 2 branches missed.">                    &amp;&amp; slot.getMount().getType() instanceof MiscType</span>
<span class="nc bnc" id="L1988" title="All 2 branches missed.">                    &amp;&amp; slot.getMount().getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc" id="L1989">                bays++;</span>
            }
        }
<span class="nc" id="L1992">        return bays;</span>
    }

    @Override
    protected void addBomb(Mounted mounted, int loc) throws LocationFullException {
<span class="nc" id="L1997">        mounted.setLocation(loc, false);</span>
<span class="nc" id="L1998">        int slots = 1;</span>
<span class="nc bnc" id="L1999" title="All 2 branches missed.">        if (mounted.getType() instanceof BombType) {</span>
<span class="nc" id="L2000">            slots = BombType.getBombCost(((BombType) mounted.getType()).getBombType());</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">        } else if (mounted.getType() instanceof WeaponType) {</span>
<span class="nc" id="L2002">            int type = BombType.getBombTypeForWeapon(mounted.getType());</span>
<span class="nc bnc" id="L2003" title="All 2 branches missed.">            if (type &gt;= 0) {</span>
<span class="nc" id="L2004">                slots = BombType.getBombCost(type);</span>
            } else {
<span class="nc" id="L2006">                slots = mounted.getCriticals();</span>
            }
        }
<span class="nc bnc" id="L2009" title="All 2 branches missed.">        for (int i = 0; i &lt; crits[loc].length; i++) {</span>
<span class="nc" id="L2010">            final CriticalSlot slot = crits[loc][i];</span>
<span class="nc bnc" id="L2011" title="All 4 branches missed.">            if (slot != null &amp;&amp; slot.getType() == CriticalSlot.TYPE_EQUIPMENT</span>
<span class="nc bnc" id="L2012" title="All 2 branches missed.">                    &amp;&amp; (slot.getMount().getType() instanceof MiscType)</span>
<span class="nc bnc" id="L2013" title="All 4 branches missed.">                    &amp;&amp; slot.getMount().getType().hasFlag(MiscType.F_BOMB_BAY) &amp;&amp; (slot.getMount2() == null)) {</span>
<span class="nc" id="L2014">                slot.setMount2(mounted);</span>
<span class="nc" id="L2015">                slots--;</span>
                // Link the bay to the slot so we can find the bomb to explode
                // when the slot is hit.
<span class="nc" id="L2018">                slot.getMount().setLinked(mounted);</span>
<span class="nc bnc" id="L2019" title="All 2 branches missed.">                if (slots == 0) {</span>
<span class="nc" id="L2020">                    break;</span>
                }
            }
        }
<span class="nc bnc" id="L2024" title="All 2 branches missed.">        if (slots &gt; 0) {</span>
<span class="nc" id="L2025">            throw new LocationFullException();</span>
        }
<span class="nc" id="L2027">        mounted.setBombMounted(true);</span>
<span class="nc bnc" id="L2028" title="All 2 branches missed.">        if (mounted.getType() instanceof BombType) {</span>
<span class="nc" id="L2029">            bombList.add(mounted);</span>
        }
<span class="nc bnc" id="L2031" title="All 2 branches missed.">        if (mounted.getType() instanceof WeaponType) {</span>
<span class="nc" id="L2032">            totalWeaponList.add(mounted);</span>
<span class="nc" id="L2033">            weaponList.add(mounted);</span>
<span class="nc bnc" id="L2034" title="All 2 branches missed.">            if (mounted.getType().hasFlag(WeaponType.F_ARTILLERY)) {</span>
<span class="nc" id="L2035">                aTracker.addWeapon(mounted);</span>
            }
<span class="nc bnc" id="L2037" title="All 4 branches missed.">            if (mounted.getType().hasFlag(WeaponType.F_ONESHOT) &amp;&amp; (AmmoType.getOneshotAmmo(mounted) != null)) {</span>
<span class="nc" id="L2038">                Mounted m = new Mounted(this, AmmoType.getOneshotAmmo(mounted));</span>
<span class="nc" id="L2039">                m.setShotsLeft(1);</span>
<span class="nc" id="L2040">                mounted.setLinked(m);</span>
                // Oneshot ammo will be identified by having a location
                // of null. Other areas in the code will rely on this.
<span class="nc" id="L2043">                addEquipment(m, Entity.LOC_NONE, false);</span>
            }
        }
<span class="nc bnc" id="L2046" title="All 2 branches missed.">        if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc" id="L2047">            ammoList.add(mounted);</span>
        }
<span class="nc bnc" id="L2049" title="All 2 branches missed.">        if (mounted.getType() instanceof MiscType) {</span>
<span class="nc" id="L2050">            miscList.add(mounted);</span>
        }
<span class="nc" id="L2052">        equipmentList.add(mounted);</span>
<span class="nc" id="L2053">    }</span>

    @Override
    public Mounted addEquipment(EquipmentType etype, int loc, boolean rearMounted) throws LocationFullException {
<span class="nc bnc" id="L2057" title="All 2 branches missed.">        if (etype instanceof BombType) {</span>
<span class="nc" id="L2058">            Mounted mounted = new Mounted(this, etype);</span>
<span class="nc" id="L2059">            addBomb(mounted, loc);</span>
<span class="nc" id="L2060">            return mounted;</span>
        } else {
<span class="nc" id="L2062">            return super.addEquipment(etype, loc, rearMounted);</span>
        }
    }

    @Override
    public boolean canSpot() {
<span class="nc bnc" id="L2068" title="All 2 branches missed.">        if (getConversionMode() == CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L2069" title="All 4 branches missed.">            return !isAirborne() || hasWorkingMisc(MiscType.F_RECON_CAMERA)</span>
<span class="nc bnc" id="L2070" title="All 4 branches missed.">                    || hasWorkingMisc(MiscType.F_INFRARED_IMAGER) || hasWorkingMisc(MiscType.F_HYPERSPECTRAL_IMAGER)</span>
<span class="nc bnc" id="L2071" title="All 2 branches missed.">                    || (hasWorkingMisc(MiscType.F_HIRES_IMAGER)</span>
<span class="nc bnc" id="L2072" title="All 2 branches missed.">                            &amp;&amp; ((game.getPlanetaryConditions().getLight() == PlanetaryConditions.L_DAY)</span>
<span class="nc bnc" id="L2073" title="All 2 branches missed.">                                    || (game.getPlanetaryConditions().getLight() == PlanetaryConditions.L_DUSK)));</span>
        } else {
<span class="nc" id="L2075">            return super.canSpot();</span>
        }
    }

    @Override
    public long getEntityType() {
<span class="nc" id="L2081">        return Entity.ETYPE_MECH | Entity.ETYPE_BIPED_MECH | Entity.ETYPE_LAND_AIR_MECH;</span>
    }
    
    /**
     * A method to add/remove sensors that only work in space as we transition in and out of an atmosphere
     */
    @Override
    public void updateSensorOptions() {
        //Remove everything but Radar if we're not in space
<span class="nc bnc" id="L2090" title="All 2 branches missed.">        if (!isSpaceborne()) {</span>
<span class="nc" id="L2091">            Vector&lt;Sensor&gt; sensorsToRemove = new Vector&lt;Sensor&gt;();</span>
<span class="nc bnc" id="L2092" title="All 2 branches missed.">            if (isAero()) {</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">                for (Sensor sensor : getSensors()) {</span>
<span class="nc bnc" id="L2094" title="All 2 branches missed.">                    if (sensor.getType() == Sensor.TYPE_AERO_THERMAL) {</span>
<span class="nc" id="L2095">                        sensorsToRemove.add(sensor);</span>
                    }
<span class="nc" id="L2097">                }</span>
            }
<span class="nc" id="L2099">            getSensors().removeAll(sensorsToRemove);</span>
<span class="nc bnc" id="L2100" title="All 2 branches missed.">            if (sensorsToRemove.size() &gt;= 1) {</span>
<span class="nc" id="L2101">            setNextSensor(getSensors().firstElement());</span>
            }
        }
        //If we are in space, add them back...
<span class="nc bnc" id="L2105" title="All 2 branches missed.">        if (isSpaceborne()) {</span>
<span class="nc bnc" id="L2106" title="All 2 branches missed.">            if (isAero()) {</span>
                //ASFs and small craft get thermal/optical sensors
<span class="nc" id="L2108">                getSensors().add(new Sensor(Sensor.TYPE_AERO_THERMAL));</span>
<span class="nc" id="L2109">                setNextSensor(getSensors().firstElement());</span>
            }
        }
<span class="nc" id="L2112">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>