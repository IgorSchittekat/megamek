<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtfFile.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.loaders</a> &gt; <span class="el_source">MtfFile.java</span></div><h1>MtfFile.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000-2002 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */

/*
 * MtfFile.java
 *
 * Created on April 7, 2002, 8:47 PM
 */

package megamek.common.loaders;

import java.io.*;
import java.util.*;

import megamek.common.*;

/**
 * @author Ben
 */
public class MtfFile implements IMechLoader {

    private String name;
    private String model;

    private String chassisConfig;
    private String techBase;
    private String techYear;
    private String rulesLevel;
<span class="fc" id="L40">    private String source = &quot;Source:&quot;;</span>

    private String tonnage;
    private String engine;
    private String internalType;
    private String gyroType;
    private String cockpitType;
    private String lamType;
    private String motiveType;
    private String ejectionType;

    private String heatSinks;
    private String jumpMP;
<span class="fc" id="L53">    private String baseChassieHeatSinks = &quot;base chassis heat sinks:-1&quot;;</span>

    private String armorType;
<span class="fc" id="L56">    private String[] armorValues = new String[12];</span>

    private String[][] critData;
<span class="fc" id="L59">    private List&lt;String&gt; noCritEquipment = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L61">    private String capabilities = &quot;&quot;;</span>
<span class="fc" id="L62">    private String deployment = &quot;&quot;;</span>
<span class="fc" id="L63">    private String overview = &quot;&quot;;</span>
<span class="fc" id="L64">    private String history = &quot;&quot;;</span>
<span class="fc" id="L65">    private String manufacturer = &quot;&quot;;</span>
<span class="fc" id="L66">    private String primaryFactory = &quot;&quot;;</span>
<span class="fc" id="L67">    private Map&lt;EntityFluff.System, String&gt; systemManufacturers = new EnumMap&lt;&gt;(EntityFluff.System.class);</span>
<span class="fc" id="L68">    private Map&lt;EntityFluff.System, String&gt; systemModels = new EnumMap&lt;&gt;(EntityFluff.System.class);</span>
<span class="fc" id="L69">    private String notes = &quot;&quot;;</span>
<span class="fc" id="L70">    private String imagePath = &quot;&quot;;</span>

<span class="fc" id="L72">    private int bv = 0;</span>

<span class="fc" id="L74">    private Map&lt;EquipmentType, Mounted&gt; hSharedEquip = new HashMap&lt;&gt;();</span>
<span class="fc" id="L75">    private List&lt;Mounted&gt; vSplitWeapons = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L77">    public static final int[] locationOrder =</span>
            {Mech.LOC_LARM, Mech.LOC_RARM, Mech.LOC_LT, Mech.LOC_RT, Mech.LOC_CT, Mech.LOC_HEAD, Mech.LOC_LLEG, Mech.LOC_RLEG, Mech.LOC_CLEG};
<span class="fc" id="L79">    public static final int[] rearLocationOrder =</span>
            {Mech.LOC_LT, Mech.LOC_RT, Mech.LOC_CT};

    public static final String COCKPIT = &quot;cockpit:&quot;;
    public static final String GYRO = &quot;gyro:&quot;;
    public static final String MOTIVE = &quot;motive:&quot;;
    public static final String EJECTION = &quot;ejection:&quot;;
    public static final String MASS = &quot;mass:&quot;;
    public static final String ENGINE = &quot;engine:&quot;;
    public static final String STRUCTURE = &quot;structure:&quot;;
    public static final String MYOMER = &quot;myomer:&quot;;
    public static final String LAM = &quot;lam:&quot;;
    public static final String CONFIG = &quot;config:&quot;;
    public static final String TECH_BASE = &quot;techbase:&quot;;
    public static final String ERA = &quot;era:&quot;;
    public static final String SOURCE = &quot;source:&quot;;
    public static final String RULES_LEVEL = &quot;rules level:&quot;;
    public static final String HEAT_SINKS = &quot;heat sinks:&quot;;
    public static final String BASE_CHASSIS_HEAT_SINKS = &quot;base chassis heat sinks:&quot;;
    public static final String HS_SINGLE = &quot;Single&quot;;
    public static final String HS_DOUBLE = &quot;Double&quot;;
    public static final String HS_LASER = &quot;Laser&quot;;
    public static final String HS_COMPACT = &quot;Compact&quot;;
    public static final String TECH_BASE_IS = &quot;IS&quot;;
    public static final String TECH_BASE_CLAN = &quot;Clan&quot;;
    public static final String WALK_MP = &quot;walk mp:&quot;;
    public static final String JUMP_MP = &quot;jump mp:&quot;;
    public static final String ARMOR = &quot;armor:&quot;;
    public static final String OVERVIEW = &quot;overview:&quot;;
    public static final String CAPABILITIES = &quot;capabilities:&quot;;
    public static final String DEPLOYMENT = &quot;deployment:&quot;;
    public static final String HISTORY = &quot;history:&quot;;
    public static final String MANUFACTURER = &quot;manufacturer:&quot;;
    public static final String PRIMARY_FACTORY = &quot;primaryfactory:&quot;;
    public static final String SYSTEM_MANUFACTURER = &quot;systemmanufacturer:&quot;;
    public static final String SYSTEM_MODEL = &quot;systemmode:&quot;;
    public static final String NOTES = &quot;notes:&quot;;
    public static final String IMAGE_FILE = &quot;imagefile:&quot;;
    public static final String BV = &quot;bv:&quot;;
    public static final String WEAPONS = &quot;weapons:&quot;;
    public static final String EMPTY = &quot;-Empty-&quot;;
    public static final String ARMORED = &quot;(ARMORED)&quot;;
    public static final String OMNIPOD = &quot;(OMNIPOD)&quot;;
    public static final String NO_CRIT = &quot;nocrit:&quot;;
    public static final String SIZE = &quot;:SIZE:&quot;;

    /**
     * Creates new MtfFile
     */
<span class="fc" id="L128">    public MtfFile(InputStream is) throws EntityLoadingException {</span>
<span class="fc" id="L129">        try (BufferedReader r = new BufferedReader(new InputStreamReader(is))) {</span>
<span class="fc" id="L130">            String version = r.readLine();</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (version == null) {</span>
<span class="nc" id="L132">                throw new EntityLoadingException(&quot;MTF File empty!&quot;);</span>
            }
            // Version 1.0: Initial version.
            // Version 1.1: Added level 3 cockpit and gyro options.
            // version 1.2: added full head ejection
<span class="pc bpc" id="L137" title="5 of 6 branches missed.">            if (!version.trim().equalsIgnoreCase(&quot;Version:1.0&quot;) &amp;&amp; !version.trim().equalsIgnoreCase(&quot;Version:1.1&quot;) &amp;&amp; !version.trim().equalsIgnoreCase(&quot;Version:1.2&quot;)) {</span>
<span class="nc" id="L138">                throw new EntityLoadingException(&quot;Wrong MTF file version.&quot;);</span>
            }

<span class="fc" id="L141">            name = r.readLine();</span>
<span class="fc" id="L142">            model = r.readLine();</span>

<span class="fc" id="L144">            critData = new String[9][12];</span>

<span class="fc" id="L146">            readCrits(r);</span>
<span class="nc" id="L147">        } catch (IOException ex) {</span>
<span class="nc" id="L148">            ex.printStackTrace();</span>
<span class="nc" id="L149">            throw new EntityLoadingException(&quot;I/O Error reading file&quot;);</span>
<span class="nc" id="L150">        } catch (StringIndexOutOfBoundsException ex) {</span>
<span class="nc" id="L151">            ex.printStackTrace();</span>
<span class="nc" id="L152">            throw new EntityLoadingException(&quot;StringIndexOutOfBoundsException reading file (format error)&quot;);</span>
<span class="nc" id="L153">        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L154">            ex.printStackTrace();</span>
<span class="nc" id="L155">            throw new EntityLoadingException(&quot;NumberFormatException reading file (format error)&quot;);</span>
<span class="fc" id="L156">        }</span>
<span class="fc" id="L157">    }</span>

    private void readCrits(BufferedReader r) throws IOException {
<span class="fc" id="L160">        int slot = 0;</span>
<span class="fc" id="L161">        int loc = 0;</span>
        String crit;
        int weaponsCount;
        int armorLocation;
<span class="fc bfc" id="L165" title="All 2 branches covered.">        while (r.ready()) {</span>
<span class="fc" id="L166">            crit = r.readLine().trim();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">            if (crit.isEmpty()) {</span>
<span class="fc" id="L168">                continue;</span>
            }

<span class="fc bfc" id="L171" title="All 2 branches covered.">            if (isValidLocation(crit)) {</span>
<span class="fc" id="L172">                loc = getLocation(crit);</span>
<span class="fc" id="L173">                slot = 0;</span>
<span class="fc" id="L174">                continue;</span>
            }

<span class="fc bfc" id="L177" title="All 2 branches covered.">            if (isProcessedComponent(crit)) {</span>
<span class="fc" id="L178">                continue;</span>
            }

<span class="fc" id="L181">            weaponsCount = weaponsList(crit);</span>

<span class="fc bfc" id="L183" title="All 2 branches covered.">            if (weaponsCount &gt; 0) {</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">                for (int count = 0; count &lt; weaponsCount; count++) {</span>
<span class="fc" id="L185">                    r.readLine();</span>
                }
<span class="fc" id="L187">                continue;</span>
            }

<span class="fc" id="L190">            armorLocation = getArmorLocation(crit);</span>

<span class="fc bfc" id="L192" title="All 2 branches covered.">            if (armorLocation &gt;= 0) {</span>
<span class="fc" id="L193">                armorValues[armorLocation] = crit;</span>
<span class="fc" id="L194">                continue;</span>
            }
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">            if (critData.length &lt;= loc) {</span>
<span class="nc" id="L197">                continue;</span>
            }
<span class="fc bfc" id="L199" title="All 2 branches covered.">            if (critData[loc].length &lt;= slot) {</span>
<span class="fc" id="L200">                continue;</span>
            }
<span class="fc" id="L202">            critData[loc][slot++] = crit.trim();</span>

        }
<span class="fc" id="L205">    }</span>

    public Entity getEntity() throws EntityLoadingException {
        try {
            Mech mech;

            int iGyroType;
            try {
<span class="nc" id="L213">                iGyroType = Mech.getGyroTypeForString(gyroType.substring(5));</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (iGyroType == Mech.GYRO_UNKNOWN) {</span>
<span class="nc" id="L215">                    iGyroType = Mech.GYRO_STANDARD;</span>
                }
<span class="fc" id="L217">            } catch (Exception e) {</span>
<span class="fc" id="L218">                iGyroType = Mech.GYRO_STANDARD;</span>
<span class="nc" id="L219">            }</span>
            int iCockpitType;
            try {
<span class="nc" id="L222">                iCockpitType = Mech.getCockpitTypeForString(cockpitType.substring(8));</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                if (iCockpitType == Mech.COCKPIT_UNKNOWN) {</span>
<span class="nc" id="L224">                    iCockpitType = Mech.COCKPIT_STANDARD;</span>
                }
<span class="fc" id="L226">            } catch (Exception e) {</span>
<span class="fc" id="L227">                iCockpitType = Mech.COCKPIT_STANDARD;</span>
<span class="nc" id="L228">            }</span>
            boolean fullHead;
            try {
<span class="nc" id="L231">                fullHead = ejectionType.substring(9).equals(Mech.FULL_HEAD_EJECT_STRING);</span>
<span class="fc" id="L232">            } catch (Exception e) {</span>
<span class="fc" id="L233">                fullHead = false;</span>
<span class="nc" id="L234">            }</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            if (chassisConfig.contains(&quot;QuadVee&quot;)) {</span>
                int iMotiveType;
                try {
<span class="nc" id="L238">                    iMotiveType = QuadVee.getMotiveTypeForString(motiveType.substring(7));</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    if (iMotiveType == QuadVee.MOTIVE_UNKNOWN) {</span>
<span class="nc" id="L240">                        iMotiveType = QuadVee.MOTIVE_TRACK;</span>
                    }
<span class="nc" id="L242">                } catch (Exception e) {</span>
<span class="nc" id="L243">                    iMotiveType = QuadVee.MOTIVE_TRACK;</span>
<span class="nc" id="L244">                }</span>
<span class="nc" id="L245">                mech = new QuadVee(iGyroType, iMotiveType);</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">            } else if (chassisConfig.contains(&quot;Quad&quot;)) {</span>
<span class="nc" id="L247">                mech = new QuadMech(iGyroType, iCockpitType);</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            } else if (chassisConfig.contains(&quot;LAM&quot;)) {</span>
                int iLAMType;
                try {
<span class="nc" id="L251">                    iLAMType = LandAirMech.getLAMTypeForString(lamType.substring(4));</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                    if (iLAMType == LandAirMech.LAM_UNKNOWN) {</span>
<span class="nc" id="L253">                        iLAMType = LandAirMech.LAM_STANDARD;</span>
                    }
<span class="nc" id="L255">                } catch (Exception e) {</span>
<span class="nc" id="L256">                    iLAMType = LandAirMech.LAM_STANDARD;</span>
<span class="nc" id="L257">                }</span>
<span class="nc" id="L258">                mech = new LandAirMech(iGyroType, iCockpitType, iLAMType);</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">            } else if (chassisConfig.contains(&quot;Tripod&quot;)) {</span>
<span class="nc" id="L260">                mech = new TripodMech(iGyroType, iCockpitType);</span>
            } else {
<span class="fc" id="L262">                mech = new BipedMech(iGyroType, iCockpitType);</span>
            }
<span class="fc" id="L264">            mech.setFullHeadEject(fullHead);</span>
<span class="fc" id="L265">            mech.setChassis(name.trim());</span>
<span class="fc" id="L266">            mech.setModel(model.trim());</span>
<span class="fc" id="L267">            mech.setYear(Integer.parseInt(techYear.substring(4).trim()));</span>
<span class="fc" id="L268">            mech.setSource(source.substring(&quot;Source:&quot;.length()).trim());</span>

<span class="pc bpc" id="L270" title="1 of 2 branches missed.">            if (chassisConfig.contains(&quot;Omni&quot;)) {</span>
<span class="nc" id="L271">                mech.setOmni(true);</span>
            }
<span class="fc" id="L273">            setTechLevel(mech);</span>
<span class="fc" id="L274">            mech.setWeight(Integer.parseInt(tonnage.substring(5)));</span>

<span class="fc" id="L276">            int engineFlags = 0;</span>
<span class="pc bpc" id="L277" title="13 of 16 branches missed.">            if ((mech.isClan() &amp;&amp; !mech.isMixedTech()) || (mech.isMixedTech() &amp;&amp; mech.isClan() &amp;&amp; !mech.itemOppositeTech(engine)) || (mech.isMixedTech() &amp;&amp; !mech.isClan() &amp;&amp; mech.itemOppositeTech(engine))) {</span>
<span class="nc" id="L278">                engineFlags = Engine.CLAN_ENGINE;</span>
            }
<span class="fc bfc" id="L280" title="All 2 branches covered.">            if (mech.isSuperHeavy()) {</span>
<span class="fc" id="L281">                engineFlags |= Engine.SUPERHEAVY_ENGINE;</span>
            }

<span class="fc" id="L284">            int engineRating = Integer.parseInt(engine.substring(engine.indexOf(&quot;:&quot;) + 1, engine.indexOf(&quot; &quot;)));</span>
<span class="fc" id="L285">            mech.setEngine(new Engine(engineRating, Engine.getEngineTypeByString(engine), engineFlags));</span>

<span class="fc" id="L287">            mech.setOriginalJumpMP(Integer.parseInt(jumpMP.substring(8)));</span>

<span class="fc" id="L289">            boolean dblSinks = heatSinks.contains(HS_DOUBLE);</span>
<span class="fc" id="L290">            boolean laserSinks = heatSinks.contains(HS_LASER);</span>
<span class="fc" id="L291">            boolean compactSinks = heatSinks.contains(HS_COMPACT);</span>
<span class="fc" id="L292">            int expectedSinks = Integer.parseInt(heatSinks.substring(11, 13).trim());</span>
<span class="fc" id="L293">            int baseHeatSinks = Integer.parseInt(baseChassieHeatSinks.substring(&quot;base chassis heat sinks:&quot;.length()).trim());</span>
            // For mixed tech units with double heat sinks we want to install the correct type. Legacy files
            // don't specify, so we'll use TECH_BASE_ALL to indicate unknown and check for heat sinks on the
            // critical table.
            int heatSinkBase;
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">            if (heatSinks.contains(TECH_BASE_CLAN)) {</span>
<span class="nc" id="L299">                heatSinkBase = ITechnology.TECH_BASE_CLAN;</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            } else if (heatSinks.contains(TECH_BASE_IS)) {</span>
<span class="nc" id="L301">                heatSinkBase = ITechnology.TECH_BASE_IS;</span>
            } else {
<span class="fc" id="L303">                heatSinkBase = ITechnology.TECH_BASE_ALL;</span>
            }

<span class="fc" id="L306">            String thisStructureType = internalType.substring(internalType.indexOf(':') + 1);</span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">            if (thisStructureType.length() &gt; 0) {</span>
<span class="fc" id="L308">                mech.setStructureType(thisStructureType);</span>
            } else {
<span class="nc" id="L310">                mech.setStructureType(EquipmentType.T_STRUCTURE_STANDARD);</span>
            }
<span class="fc" id="L312">            mech.autoSetInternal();</span>

<span class="fc" id="L314">            String thisArmorType = armorType.substring(armorType.indexOf(':') + 1);</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">            if (thisArmorType.indexOf('(') != -1) {</span>
<span class="fc" id="L316">                boolean clan = thisArmorType.toLowerCase().contains(&quot;clan&quot;);</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">                if (clan) {</span>
<span class="nc bnc" id="L318" title="All 5 branches missed.">                    switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                        case 2:
<span class="nc" id="L320">                            mech.setArmorTechLevel(TechConstants.T_CLAN_TW);</span>
<span class="nc" id="L321">                            break;</span>
                        case 3:
<span class="nc" id="L323">                            mech.setArmorTechLevel(TechConstants.T_CLAN_ADVANCED);</span>
<span class="nc" id="L324">                            break;</span>
                        case 4:
<span class="nc" id="L326">                            mech.setArmorTechLevel(TechConstants.T_CLAN_EXPERIMENTAL);</span>
<span class="nc" id="L327">                            break;</span>
                        case 5:
<span class="nc" id="L329">                            mech.setArmorTechLevel(TechConstants.T_CLAN_UNOFFICIAL);</span>
<span class="nc" id="L330">                            break;</span>
                        default:
<span class="nc" id="L332">                            throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
                    }
                } else {
<span class="pc bpc" id="L335" title="5 of 6 branches missed.">                    switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                        case 1:
<span class="fc" id="L337">                            mech.setArmorTechLevel(TechConstants.T_INTRO_BOXSET);</span>
<span class="fc" id="L338">                            break;</span>
                        case 2:
<span class="nc" id="L340">                            mech.setArmorTechLevel(TechConstants.T_IS_TW_NON_BOX);</span>
<span class="nc" id="L341">                            break;</span>
                        case 3:
<span class="nc" id="L343">                            mech.setArmorTechLevel(TechConstants.T_IS_ADVANCED);</span>
<span class="nc" id="L344">                            break;</span>
                        case 4:
<span class="nc" id="L346">                            mech.setArmorTechLevel(TechConstants.T_IS_EXPERIMENTAL);</span>
<span class="nc" id="L347">                            break;</span>
                        case 5:
<span class="nc" id="L349">                            mech.setArmorTechLevel(TechConstants.T_IS_UNOFFICIAL);</span>
<span class="nc" id="L350">                            break;</span>
                        default:
<span class="nc" id="L352">                            throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
                    }
                }
<span class="fc" id="L355">                thisArmorType = thisArmorType.substring(0, thisArmorType.indexOf('(')).trim();</span>
<span class="fc" id="L356">                mech.setArmorType(thisArmorType);</span>
<span class="pc bnc" id="L357" title="All 2 branches missed.">            } else if (!thisArmorType.equals(EquipmentType.getArmorTypeName(EquipmentType.T_ARMOR_PATCHWORK))) {</span>
<span class="nc" id="L358">                mech.setArmorTechLevel(mech.getTechLevel());</span>
<span class="nc" id="L359">                mech.setArmorType(thisArmorType);</span>
            }
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">            if (!(thisArmorType.length() &gt; 0)) {</span>
<span class="nc" id="L362">                mech.setArmorType(EquipmentType.T_ARMOR_STANDARD);</span>
            }
<span class="fc" id="L364">            mech.recalculateTechAdvancement();</span>

<span class="fc bfc" id="L366" title="All 2 branches covered.">            for (int x = 0; x &lt; locationOrder.length; x++) {</span>
<span class="pc bpc" id="L367" title="1 of 4 branches missed.">                if ((locationOrder[x] == Mech.LOC_CLEG) &amp;&amp; !(mech instanceof TripodMech)) {</span>
<span class="fc" id="L368">                    continue;</span>
                }
<span class="fc" id="L370">                mech.initializeArmor(Integer.parseInt(armorValues[x].substring(armorValues[x].lastIndexOf(':') + 1)), locationOrder[x]);</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">                if (thisArmorType.equals(EquipmentType.getArmorTypeName(EquipmentType.T_ARMOR_PATCHWORK))) {</span>
<span class="nc" id="L372">                    boolean clan = false;</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                    if (armorValues[x].contains(&quot;Clan&quot;)) {</span>
<span class="nc" id="L374">                        clan = true;</span>
                    }
<span class="nc" id="L376">                    String armorName = armorValues[x].substring(armorValues[x].indexOf(':') + 1, armorValues[x].indexOf('('));</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                    if (!armorName.contains(&quot;Clan&quot;)</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                        &amp;&amp; !armorName.contains(&quot;IS&quot;)) {</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                        if (clan) {</span>
<span class="nc" id="L380">                            armorName = &quot;Clan &quot; + armorName;</span>
                        } else {
<span class="nc" id="L382">                            armorName = &quot;IS &quot; + armorName;</span>
                        }
                    }
<span class="nc" id="L385">                    mech.setArmorType(EquipmentType.getArmorType(EquipmentType.get(armorName)), locationOrder[x]);</span>

<span class="nc" id="L387">                    String armorValue = armorValues[x].toLowerCase();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                    if (armorValue.contains(&quot;clan&quot;)) {</span>
<span class="nc bnc" id="L389" title="All 5 branches missed.">                        switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                            case 2:
<span class="nc" id="L391">                                mech.setArmorTechLevel(TechConstants.T_CLAN_TW, locationOrder[x]);</span>
<span class="nc" id="L392">                                break;</span>
                            case 3:
<span class="nc" id="L394">                                mech.setArmorTechLevel(TechConstants.T_CLAN_ADVANCED, locationOrder[x]);</span>
<span class="nc" id="L395">                                break;</span>
                            case 4:
<span class="nc" id="L397">                                mech.setArmorTechLevel(TechConstants.T_CLAN_EXPERIMENTAL, locationOrder[x]);</span>
<span class="nc" id="L398">                                break;</span>
                            case 5:
<span class="nc" id="L400">                                mech.setArmorTechLevel(TechConstants.T_CLAN_UNOFFICIAL, locationOrder[x]);</span>
<span class="nc" id="L401">                                break;</span>
                            default:
<span class="nc" id="L403">                                throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
                        }
<span class="nc bnc" id="L405" title="All 2 branches missed.">                    } else if (armorValue.contains(&quot;inner sphere&quot;)) {</span>
<span class="nc bnc" id="L406" title="All 6 branches missed.">                        switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                            case 1:
<span class="nc" id="L408">                                mech.setArmorTechLevel(TechConstants.T_INTRO_BOXSET, locationOrder[x]);</span>
<span class="nc" id="L409">                                break;</span>
                            case 2:
<span class="nc" id="L411">                                mech.setArmorTechLevel(TechConstants.T_IS_TW_NON_BOX, locationOrder[x]);</span>
<span class="nc" id="L412">                                break;</span>
                            case 3:
<span class="nc" id="L414">                                mech.setArmorTechLevel(TechConstants.T_IS_ADVANCED, locationOrder[x]);</span>
<span class="nc" id="L415">                                break;</span>
                            case 4:
<span class="nc" id="L417">                                mech.setArmorTechLevel(TechConstants.T_IS_EXPERIMENTAL, locationOrder[x]);</span>
<span class="nc" id="L418">                                break;</span>
                            case 5:
<span class="nc" id="L420">                                mech.setArmorTechLevel(TechConstants.T_IS_UNOFFICIAL, locationOrder[x]);</span>
<span class="nc" id="L421">                                break;</span>
                            default:
<span class="nc" id="L423">                                throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
                        }
                    }
                }
            }
<span class="fc bfc" id="L428" title="All 2 branches covered.">            for (int x = 0; x &lt; rearLocationOrder.length; x++) {</span>
<span class="fc" id="L429">                mech.initializeRearArmor(Integer.parseInt(armorValues[x + locationOrder.length].substring(10)), rearLocationOrder[x]);</span>
            }
            
            // Set capital fighter stats for LAMs
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">            if (mech instanceof LandAirMech) {</span>
<span class="nc" id="L434">                ((LandAirMech)mech).autoSetCapArmor();</span>
<span class="nc" id="L435">                ((LandAirMech)mech).autoSetFatalThresh();</span>
            }

            // oog, crits.
<span class="fc" id="L439">            compactCriticals(mech);</span>
            // we do these in reverse order to get the outermost
            // locations first, which is necessary for split crits to work
<span class="fc bfc" id="L442" title="All 2 branches covered.">            for (int i = mech.locations() - 1; i &gt;= 0; i--) {</span>
<span class="fc" id="L443">                parseCrits(mech, i);</span>
            }
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">            for (String equipment : noCritEquipment) {</span>
<span class="nc" id="L446">                parseNoCritEquipment(mech, equipment);</span>
<span class="nc" id="L447">            }</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">            if (mech.isClan()) {</span>
<span class="nc" id="L449">                mech.addClanCase();</span>
            }

            // add any heat sinks not allocated
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">            if (laserSinks) {</span>
<span class="nc" id="L454">                mech.addEngineSinks(expectedSinks - mech.heatSinks(), MiscType.F_LASER_HEAT_SINK);</span>
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">            } else if (dblSinks) {</span>
                // If the heat sink entry didn't specify Clan or IS double, check for sinks that take
                // critical slots. If none are found, default to the overall tech base of the unit.
<span class="nc bnc" id="L458" title="All 2 branches missed.">                if (heatSinkBase == ITechnology.TECH_BASE_ALL) {</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                    for (Mounted mounted : mech.getMisc()) {</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                        if (mounted.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)) {</span>
<span class="nc" id="L461">                            heatSinkBase = mounted.getType().getTechBase();</span>
                        }
<span class="nc" id="L463">                    }</span>
                }
                boolean clan;
<span class="nc bnc" id="L466" title="All 3 branches missed.">                switch (heatSinkBase) {</span>
                    case ITechnology.TECH_BASE_IS:
<span class="nc" id="L468">                        clan = false;</span>
<span class="nc" id="L469">                        break;</span>
                    case ITechnology.TECH_BASE_CLAN:
<span class="nc" id="L471">                        clan = true;</span>
<span class="nc" id="L472">                        break;</span>
                    default:
<span class="nc" id="L474">                        clan = mech.isClan();</span>
                }
<span class="nc" id="L476">                mech.addEngineSinks(expectedSinks - mech.heatSinks(), MiscType.F_DOUBLE_HEAT_SINK, clan);</span>
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">            } else if (compactSinks) {</span>
<span class="nc" id="L478">                mech.addEngineSinks(expectedSinks - mech.heatSinks(), MiscType.F_COMPACT_HEAT_SINK);</span>
            } else {
<span class="fc" id="L480">                mech.addEngineSinks(expectedSinks - mech.heatSinks(), MiscType.F_HEAT_SINK);</span>
            }

<span class="pc bpc" id="L483" title="3 of 4 branches missed.">            if (mech.isOmni() &amp;&amp; mech.hasEngine()) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                if (baseHeatSinks &gt;= 10) {</span>
<span class="nc" id="L485">                    mech.getEngine().setBaseChassisHeatSinks(baseHeatSinks);</span>
                } else {
<span class="nc" id="L487">                    mech.getEngine().setBaseChassisHeatSinks(expectedSinks);</span>
                }
            }

<span class="fc" id="L491">            mech.getFluff().setCapabilities(capabilities);</span>
<span class="fc" id="L492">            mech.getFluff().setOverview(overview);</span>
<span class="fc" id="L493">            mech.getFluff().setDeployment(deployment);</span>
<span class="fc" id="L494">            mech.getFluff().setHistory(history);</span>
<span class="fc" id="L495">            mech.getFluff().setManufacturer(manufacturer);</span>
<span class="fc" id="L496">            mech.getFluff().setPrimaryFactory(primaryFactory);</span>
<span class="fc" id="L497">            mech.getFluff().setNotes(notes);</span>
<span class="fc" id="L498">            systemManufacturers.forEach((k, v) -&gt; mech.getFluff().setSystemManufacturer(k, v));</span>
<span class="fc" id="L499">            systemModels.forEach((k, v) -&gt; mech.getFluff().setSystemModel(k, v));</span>
<span class="fc" id="L500">            mech.getFluff().setMMLImagePath(imagePath);</span>

<span class="fc" id="L502">            mech.setArmorTonnage(mech.getArmorWeight());</span>

<span class="pc bpc" id="L504" title="1 of 2 branches missed.">            if (bv != 0) {</span>
<span class="nc" id="L505">                mech.setUseManualBV(true);</span>
<span class="nc" id="L506">                mech.setManualBV(bv);</span>
            }
<span class="fc" id="L508">            return mech;</span>
<span class="nc" id="L509">        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L510">            ex.printStackTrace();</span>
<span class="nc" id="L511">            throw new EntityLoadingException(&quot;NumberFormatException parsing file&quot;);</span>
<span class="nc" id="L512">        } catch (NullPointerException ex) {</span>
<span class="nc" id="L513">            ex.printStackTrace();</span>
<span class="nc" id="L514">            throw new EntityLoadingException(&quot;NullPointerException parsing file&quot;);</span>
<span class="nc" id="L515">        } catch (StringIndexOutOfBoundsException ex) {</span>
<span class="nc" id="L516">            ex.printStackTrace();</span>
<span class="nc" id="L517">            throw new EntityLoadingException(&quot;StringIndexOutOfBoundsException parsing file&quot;);</span>
        }
    }

    private void setTechLevel(Mech mech) throws EntityLoadingException {
<span class="fc" id="L522">        String techBase = this.techBase.substring(9).trim();</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">        if (techBase.equalsIgnoreCase(&quot;Inner Sphere&quot;)) {</span>
<span class="pc bpc" id="L524" title="5 of 6 branches missed.">            switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                case 1:
<span class="fc" id="L526">                    mech.setTechLevel(TechConstants.T_INTRO_BOXSET);</span>
<span class="fc" id="L527">                    break;</span>
                case 2:
<span class="nc" id="L529">                    mech.setTechLevel(TechConstants.T_IS_TW_NON_BOX);</span>
<span class="nc" id="L530">                    break;</span>
                case 3:
<span class="nc" id="L532">                    mech.setTechLevel(TechConstants.T_IS_ADVANCED);</span>
<span class="nc" id="L533">                    break;</span>
                case 4:
<span class="nc" id="L535">                    mech.setTechLevel(TechConstants.T_IS_EXPERIMENTAL);</span>
<span class="nc" id="L536">                    break;</span>
                case 5:
<span class="nc" id="L538">                    mech.setTechLevel(TechConstants.T_IS_UNOFFICIAL);</span>
<span class="nc" id="L539">                    break;</span>
                default:
<span class="nc" id="L541">                    throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
            }
<span class="nc bnc" id="L543" title="All 2 branches missed.">        } else if (techBase.equalsIgnoreCase(&quot;Clan&quot;)) {</span>
<span class="nc bnc" id="L544" title="All 5 branches missed.">            switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                case 2:
<span class="nc" id="L546">                    mech.setTechLevel(TechConstants.T_CLAN_TW);</span>
<span class="nc" id="L547">                    break;</span>
                case 3:
<span class="nc" id="L549">                    mech.setTechLevel(TechConstants.T_CLAN_ADVANCED);</span>
<span class="nc" id="L550">                    break;</span>
                case 4:
<span class="nc" id="L552">                    mech.setTechLevel(TechConstants.T_CLAN_EXPERIMENTAL);</span>
<span class="nc" id="L553">                    break;</span>
                case 5:
<span class="nc" id="L555">                    mech.setTechLevel(TechConstants.T_CLAN_UNOFFICIAL);</span>
<span class="nc" id="L556">                    break;</span>
                default:
<span class="nc" id="L558">                    throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
            }
<span class="nc bnc" id="L560" title="All 2 branches missed.">        } else if (techBase.equalsIgnoreCase(&quot;Mixed (IS Chassis)&quot;)) {</span>
<span class="nc bnc" id="L561" title="All 5 branches missed.">            switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                case 2:
<span class="nc" id="L563">                    mech.setTechLevel(TechConstants.T_IS_TW_NON_BOX);</span>
<span class="nc" id="L564">                    break;</span>
                case 3:
<span class="nc" id="L566">                    mech.setTechLevel(TechConstants.T_IS_ADVANCED);</span>
<span class="nc" id="L567">                    break;</span>
                case 4:
<span class="nc" id="L569">                    mech.setTechLevel(TechConstants.T_IS_EXPERIMENTAL);</span>
<span class="nc" id="L570">                    break;</span>
                case 5:
<span class="nc" id="L572">                    mech.setTechLevel(TechConstants.T_IS_UNOFFICIAL);</span>
<span class="nc" id="L573">                    break;</span>
                default:
<span class="nc" id="L575">                    throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
            }
<span class="nc" id="L577">            mech.setMixedTech(true);</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">        } else if (techBase.equalsIgnoreCase(&quot;Mixed (Clan Chassis)&quot;)) {</span>
<span class="nc bnc" id="L579" title="All 5 branches missed.">            switch (Integer.parseInt(rulesLevel.substring(12).trim())) {</span>
                case 2:
<span class="nc" id="L581">                    mech.setTechLevel(TechConstants.T_CLAN_TW);</span>
<span class="nc" id="L582">                    break;</span>
                case 3:
<span class="nc" id="L584">                    mech.setTechLevel(TechConstants.T_CLAN_ADVANCED);</span>
<span class="nc" id="L585">                    break;</span>
                case 4:
<span class="nc" id="L587">                    mech.setTechLevel(TechConstants.T_CLAN_EXPERIMENTAL);</span>
<span class="nc" id="L588">                    break;</span>
                case 5:
<span class="nc" id="L590">                    mech.setTechLevel(TechConstants.T_CLAN_UNOFFICIAL);</span>
<span class="nc" id="L591">                    break;</span>
                default:
<span class="nc" id="L593">                    throw new EntityLoadingException(&quot;Unsupported tech level: &quot; + rulesLevel.substring(12).trim());</span>
            }
<span class="nc" id="L595">            mech.setMixedTech(true);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">        } else if (techBase.equalsIgnoreCase(&quot;Mixed&quot;)) {</span>
<span class="nc" id="L597">            throw new EntityLoadingException(&quot;Unsupported tech base: \&quot;Mixed\&quot; is no longer allowed by itself.  You must specify \&quot;Mixed (IS Chassis)\&quot; or \&quot;Mixed (Clan Chassis)\&quot;.&quot;);</span>
        } else {
<span class="nc" id="L599">            throw new EntityLoadingException(&quot;Unsupported tech base: &quot; + techBase);</span>
        }
<span class="fc" id="L601">    }</span>

    private void parseCrits(Mech mech, int loc) throws EntityLoadingException {
        // check for removed arm actuators
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">        if (!(mech instanceof QuadMech)) {</span>
<span class="fc bfc" id="L606" title="All 4 branches covered.">            if ((loc == Mech.LOC_LARM) || (loc == Mech.LOC_RARM)) {</span>
<span class="fc" id="L607">                String toCheck = critData[loc][3].toUpperCase().trim();</span>
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">                if (toCheck.endsWith(ARMORED)) {</span>
<span class="nc" id="L609">                    toCheck = toCheck.substring(0, toCheck.length() - ARMORED.length()).trim();</span>
                }
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">                if (!toCheck.equalsIgnoreCase(&quot;Hand Actuator&quot;)) {</span>
<span class="nc" id="L612">                    mech.setCritical(loc, 3, null);</span>
                }
<span class="fc" id="L614">                toCheck = critData[loc][2].toUpperCase().trim();</span>
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">                if (toCheck.endsWith(ARMORED)) {</span>
<span class="nc" id="L616">                    toCheck = toCheck.substring(0, toCheck.length() - ARMORED.length()).trim();</span>
                }
<span class="pc bpc" id="L618" title="1 of 2 branches missed.">                if (!toCheck.equalsIgnoreCase(&quot;Lower Arm Actuator&quot;)) {</span>
<span class="nc" id="L619">                    mech.setCritical(loc, 2, null);</span>
                }
            }
        }

        // go thru file, add weapons
<span class="fc bfc" id="L625" title="All 2 branches covered.">        for (int i = 0; i &lt; mech.getNumberOfCriticals(loc); i++) {</span>

            // parse out and add the critical
<span class="fc" id="L628">            String critName = critData[loc][i];</span>

<span class="fc" id="L630">            critName = critName.trim();</span>
<span class="fc" id="L631">            String critNameUpper = critName.toUpperCase();</span>
<span class="fc" id="L632">            boolean rearMounted = false;</span>
<span class="fc" id="L633">            boolean isArmored = false;</span>
<span class="fc" id="L634">            boolean isTurreted = false;</span>
<span class="fc" id="L635">            boolean isOmniPod = false;</span>
<span class="fc" id="L636">            double size = 0.0;</span>

            // Check for Armored Actuators
<span class="fc bfc" id="L639" title="All 2 branches covered.">            if (critNameUpper.endsWith(ARMORED)) {</span>
<span class="fc" id="L640">                critName = critName.substring(0, critName.length() - ARMORED.length()).trim();</span>
<span class="fc" id="L641">                isArmored = true;</span>
<span class="fc" id="L642">                critNameUpper = critName.toUpperCase();</span>
            }

<span class="pc bpc" id="L645" title="1 of 4 branches missed.">            if (critName.equalsIgnoreCase(&quot;Fusion Engine&quot;) || critName.equalsIgnoreCase(&quot;Engine&quot;)) {</span>
<span class="fc" id="L646">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, true, isArmored));</span>
<span class="fc" id="L647">                continue;</span>
<span class="fc bfc" id="L648" title="All 2 branches covered.">            } else if (critName.equalsIgnoreCase(&quot;Life Support&quot;)) {</span>
<span class="fc" id="L649">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_LIFE_SUPPORT, true, isArmored));</span>
<span class="fc" id="L650">                continue;</span>
<span class="fc bfc" id="L651" title="All 2 branches covered.">            } else if (critName.equalsIgnoreCase(&quot;Sensors&quot;)) {</span>
<span class="fc" id="L652">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_SENSORS, true, isArmored));</span>
<span class="fc" id="L653">                continue;</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">            } else if (critName.equalsIgnoreCase(&quot;Cockpit&quot;)) {</span>
<span class="fc" id="L655">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_COCKPIT, true, isArmored));</span>
<span class="fc" id="L656">                continue;</span>
<span class="fc bfc" id="L657" title="All 2 branches covered.">            } else if (critName.equalsIgnoreCase(&quot;Gyro&quot;)) {</span>
<span class="fc" id="L658">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, true, isArmored));</span>
<span class="fc" id="L659">                continue;</span>
<span class="fc bfc" id="L660" title="All 6 branches covered.">            } else if ((critName.contains(&quot;Actuator&quot;)) || critName.equalsIgnoreCase(&quot;Shoulder&quot;) || critName.equalsIgnoreCase(&quot;Hip&quot;)) {</span>
<span class="fc" id="L661">                mech.getCritical(loc, i).setArmored(isArmored);</span>
<span class="fc" id="L662">                continue;</span>
<span class="pc bpc" id="L663" title="1 of 2 branches missed.">            } else if (critName.equalsIgnoreCase(&quot;Landing Gear&quot;)) {</span>
<span class="nc" id="L664">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LandAirMech.LAM_LANDING_GEAR, true, isArmored));</span>
<span class="nc" id="L665">                continue;</span>
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">            } else if (critName.equalsIgnoreCase(&quot;Avionics&quot;)) {</span>
<span class="nc" id="L667">                mech.setCritical(loc, i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM, LandAirMech.LAM_AVIONICS, true, isArmored));</span>
<span class="nc" id="L668">                continue;</span>
            }
            // if the slot's full already, skip it.
<span class="fc bfc" id="L671" title="All 2 branches covered.">            if (mech.getCritical(loc, i) != null) {</span>
<span class="fc" id="L672">                continue;</span>
            }

<span class="fc" id="L675">            int sizeIndex = critNameUpper.indexOf(SIZE);</span>
<span class="pc bpc" id="L676" title="1 of 2 branches missed.">            if (sizeIndex &gt; 0) {</span>
<span class="nc" id="L677">                size = Double.parseDouble(critName.substring(sizeIndex + SIZE.length()));</span>
<span class="nc" id="L678">                critNameUpper = critNameUpper.substring(0, sizeIndex);</span>
            }
<span class="fc bfc" id="L680" title="All 2 branches covered.">            if (critNameUpper.endsWith(OMNIPOD)) {</span>
<span class="fc" id="L681">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - OMNIPOD.length()).trim();</span>
<span class="fc" id="L682">                isOmniPod = true;</span>
            }
<span class="fc bfc" id="L684" title="All 2 branches covered.">            if (critNameUpper.endsWith(&quot;(T)&quot;)) {</span>
<span class="fc" id="L685">                isTurreted = true;</span>
<span class="fc" id="L686">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 3).trim();</span>
            }
<span class="fc bfc" id="L688" title="All 2 branches covered.">            if (critNameUpper.endsWith(&quot;(R)&quot;)) {</span>
<span class="fc" id="L689">                rearMounted = true;</span>
<span class="fc" id="L690">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 3).trim();</span>
            }
<span class="pc bpc" id="L692" title="1 of 2 branches missed.">            if (critNameUpper.endsWith(&quot;(SPLIT)&quot;)) {</span>
<span class="nc" id="L693">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 7).trim();</span>
            }
            // keep track of facing for vehicular grenade launchers
<span class="fc" id="L696">            int facing = -1;</span>
<span class="fc bfc" id="L697" title="All 2 branches covered.">            if (critNameUpper.endsWith(&quot;(FL)&quot;)) {</span>
<span class="fc" id="L698">                facing = 5;</span>
<span class="fc" id="L699">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 4).trim();</span>
            }
<span class="fc bfc" id="L701" title="All 2 branches covered.">            if (critNameUpper.endsWith(&quot;(FR)&quot;)) {</span>
<span class="fc" id="L702">                facing = 1;</span>
<span class="fc" id="L703">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 4).trim();</span>
            }
<span class="fc bfc" id="L705" title="All 2 branches covered.">            if (critNameUpper.endsWith(&quot;(RL)&quot;)) {</span>
<span class="fc" id="L706">                facing = 4;</span>
<span class="fc" id="L707">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 4).trim();</span>
            }
<span class="fc bfc" id="L709" title="All 2 branches covered.">            if (critNameUpper.endsWith(&quot;(RR)&quot;)) {</span>
<span class="fc" id="L710">                facing = 2;</span>
<span class="fc" id="L711">                critNameUpper = critNameUpper.substring(0, critNameUpper.length() - 4).trim();</span>
            }
<span class="fc" id="L713">            critName = critName.substring(0, critNameUpper.length());</span>
<span class="fc" id="L714">            EquipmentType etype2 = null;</span>
<span class="fc bfc" id="L715" title="All 2 branches covered.">            if (critName.contains(&quot;|&quot;)) {</span>
<span class="fc" id="L716">                String critName2 = critName.substring(critName.indexOf(&quot;|&quot;) + 1);</span>
<span class="fc" id="L717">                etype2 = EquipmentType.get(critName2);</span>
<span class="pc bpc" id="L718" title="1 of 2 branches missed.">                if (etype2 == null) {</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                    etype2 = EquipmentType.get(mech.isClan() ? &quot;Clan &quot; + critName2 : &quot;IS &quot; + critName2);</span>
                }
<span class="fc" id="L721">                critName = critName.substring(0, critName.indexOf(&quot;|&quot;));</span>
            }

            try {
<span class="fc" id="L725">                EquipmentType etype = EquipmentType.get(critName);</span>
<span class="fc bfc" id="L726" title="All 2 branches covered.">                if (etype == null) {</span>
<span class="pc bpc" id="L727" title="1 of 2 branches missed.">                    etype = EquipmentType.get(mech.isClan() ? &quot;Clan &quot; + critName : &quot;IS &quot; + critName);</span>
                }
<span class="fc bfc" id="L729" title="All 2 branches covered.">                if (etype != null) {</span>
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">                    if (etype.isSpreadable()) {</span>
                        // do we already have one of these? Key on Type
<span class="nc" id="L732">                        Mounted m = hSharedEquip.get(etype);</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">                        if (m != null) {</span>
                            // use the existing one
<span class="nc" id="L735">                            mech.addCritical(loc, new CriticalSlot(m));</span>
<span class="nc" id="L736">                            continue;</span>
                        }
<span class="nc" id="L738">                        m = mech.addEquipment(etype, loc, rearMounted,</span>
                                              BattleArmor.MOUNT_LOC_NONE, isArmored,
                                              isTurreted);
<span class="nc" id="L741">                        m.setOmniPodMounted(isOmniPod);</span>
<span class="nc" id="L742">                        hSharedEquip.put(etype, m);</span>
<span class="pc bpc" id="L743" title="2 of 8 branches missed.">                    } else if (((etype instanceof WeaponType) &amp;&amp; ((WeaponType) etype).isSplitable()) || ((etype instanceof MiscType) &amp;&amp; etype.hasFlag(MiscType.F_SPLITABLE))) {</span>
                        // do we already have this one in this or an outer
                        // location?
<span class="nc" id="L746">                        Mounted m = null;</span>
<span class="nc" id="L747">                        boolean bFound = false;</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">                        for (Mounted vSplitWeapon : vSplitWeapons) {</span>
<span class="nc" id="L749">                            m = vSplitWeapon;</span>
<span class="nc" id="L750">                            int nLoc = m.getLocation();</span>
<span class="nc bnc" id="L751" title="All 6 branches missed.">                            if (((nLoc == loc) || (loc == Mech.getInnerLocation(nLoc))) &amp;&amp; (m.getType() == etype)) {</span>
<span class="nc" id="L752">                                bFound = true;</span>
<span class="nc" id="L753">                                break;</span>
                            }
<span class="nc" id="L755">                        }</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                        if (bFound) {</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">                            m.setFoundCrits(m.getFoundCrits() + (mech.isSuperHeavy()? 2 : 1));</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">                            if (m.getFoundCrits() &gt;= m.getCriticals()) {</span>
<span class="nc" id="L759">                                vSplitWeapons.remove(m);</span>
                            }
                            // if we're in a new location, set the weapon as
                            // split
<span class="nc bnc" id="L763" title="All 2 branches missed.">                            if (loc != m.getLocation()) {</span>
<span class="nc" id="L764">                                m.setSplit(true);</span>
                            }
                            // give the most restrictive location for arcs
<span class="nc" id="L767">                            int help = m.getLocation();</span>
<span class="nc" id="L768">                            m.setLocation(Mech.mostRestrictiveLoc(loc, help));</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">                            if (loc != help) {</span>
<span class="nc" id="L770">                                m.setSecondLocation(Mech.leastRestrictiveLoc(loc, help));</span>
                            }
<span class="nc" id="L772">                        } else {</span>
                            // make a new one
<span class="nc" id="L774">                            m = new Mounted(mech, etype);</span>
<span class="nc" id="L775">                            m.setFoundCrits(1);</span>
<span class="nc" id="L776">                            m.setArmored(isArmored);</span>
<span class="nc" id="L777">                            m.setMechTurretMounted(isTurreted);</span>
<span class="nc" id="L778">                            vSplitWeapons.add(m);</span>
                        }
<span class="nc" id="L780">                        m.setArmored(isArmored);</span>
<span class="nc" id="L781">                        m.setMechTurretMounted(isTurreted);</span>
<span class="nc" id="L782">                        m.setOmniPodMounted(isOmniPod);</span>
<span class="nc" id="L783">                        mech.addEquipment(m, loc, rearMounted);</span>
<span class="nc" id="L784">                    } else {</span>
                        Mounted mount;
<span class="fc bfc" id="L786" title="All 2 branches covered.">                        if (etype2 == null) {</span>
<span class="fc" id="L787">                            mount = mech.addEquipment(etype, loc, rearMounted,</span>
                                                      BattleArmor.MOUNT_LOC_NONE, isArmored,
                                                      isTurreted, false, false, isOmniPod);
                        } else {
<span class="pc bpc" id="L791" title="1 of 2 branches missed.">                            if (etype instanceof AmmoType) {</span>
<span class="nc bnc" id="L792" title="All 4 branches missed.">                                if (!(etype2 instanceof AmmoType) || (((AmmoType) etype).getAmmoType() != ((AmmoType) etype2).getAmmoType())) {</span>
<span class="nc" id="L793">                                    throw new EntityLoadingException(&quot;Can't combine ammo for different weapons in one slot&quot;);</span>
                                }
                            } else {
<span class="pc bpc" id="L796" title="5 of 8 branches missed.">                                if (!(etype.equals(etype2)) || ((etype instanceof MiscType) &amp;&amp; (!etype.hasFlag(MiscType.F_HEAT_SINK) &amp;&amp; !etype.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)))) {</span>
<span class="nc" id="L797">                                    throw new EntityLoadingException(&quot;must combine ammo or heatsinks in one slot&quot;);</span>
                                }
                            }
<span class="fc" id="L800">                            mount = mech.addEquipment(etype, etype2, loc, isOmniPod, isArmored);</span>
                        }
<span class="pc bpc" id="L802" title="1 of 2 branches missed.">                        if (etype.isVariableSize()) {</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                            if (size == 0.0) {</span>
<span class="nc" id="L804">                                size = BLKFile.getLegacyVariableSize(critName);</span>
                            }
<span class="nc" id="L806">                            mount.setSize(size);</span>
                            // THe size may require additional critical slots
<span class="nc bnc" id="L808" title="All 2 branches missed.">                            for (int c = 1; c &lt; mount.getCriticals(); c++) {</span>
<span class="nc" id="L809">                                CriticalSlot cs = new CriticalSlot(mount);</span>
<span class="nc" id="L810">                                mech.addCritical(loc, cs, i + c);</span>
                            }
                        }

                        // vehicular grenade launchers need to have their facing
                        // set
<span class="fc bfc" id="L816" title="All 4 branches covered.">                        if ((etype instanceof WeaponType) &amp;&amp; etype.hasFlag(WeaponType.F_VGL)) {</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">                            if (facing == -1) {</span>
                                // if facing has not been set earlier, we are
                                // front or rear mounted
<span class="fc bfc" id="L820" title="All 2 branches covered.">                                if (rearMounted) {</span>
<span class="fc" id="L821">                                    mount.setFacing(3);</span>
                                } else {
<span class="fc" id="L823">                                    mount.setFacing(0);</span>
                                }
                            } else {
<span class="fc" id="L826">                                mount.setFacing(facing);</span>
                            }
                        }
<span class="fc" id="L829">                    }</span>
                } else {
<span class="pc bpc" id="L831" title="1 of 2 branches missed.">                    if (!critName.equals(MtfFile.EMPTY)) {</span>
                        // Can't load this piece of equipment!
                        // Add it to the list so we can show the user.
<span class="nc" id="L834">                        mech.addFailedEquipment(critName);</span>
                        // Make the failed equipment an empty slot
<span class="nc" id="L836">                        critData[loc][i] = MtfFile.EMPTY;</span>
                        // Compact criticals again
<span class="nc" id="L838">                        compactCriticals(mech, loc);</span>
                        // Re-parse the same slot, since the compacting
                        // could have moved new equipment to this slot
<span class="nc" id="L841">                        i--;</span>
                    }

                }
<span class="nc" id="L845">            } catch (LocationFullException ex) {</span>
<span class="nc" id="L846">                throw new EntityLoadingException(ex.getMessage());</span>
<span class="fc" id="L847">            }</span>
        }
<span class="fc" id="L849">    }</span>

    private void parseNoCritEquipment(Mech mech, String name) throws EntityLoadingException {
<span class="nc" id="L852">        int loc = Mech.LOC_NONE;</span>
<span class="nc" id="L853">        int splitIndex = name.indexOf(&quot;:&quot;);</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">        if (splitIndex &gt; 0) {</span>
<span class="nc" id="L855">            loc = mech.getLocationFromAbbr(name.substring(splitIndex + 1));</span>
<span class="nc" id="L856">            name = name.substring(0, splitIndex);</span>
        }
<span class="nc" id="L858">        EquipmentType eq = EquipmentType.get(name);</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">        if (eq != null) {</span>
            try {
<span class="nc" id="L861">                Mounted mount = mech.addEquipment(eq, loc);</span>
<span class="nc" id="L862">            } catch (LocationFullException ex) {</span>
<span class="nc" id="L863">                throw new EntityLoadingException(ex.getMessage());</span>
<span class="nc" id="L864">            }</span>
        } else {
<span class="nc" id="L866">            mech.addFailedEquipment(name);</span>
        }
<span class="nc" id="L868">    }</span>

    /**
     * This function moves all &quot;empty&quot; slots to the end of a location's critical
     * list. MegaMek adds equipment to the first empty slot available in a
     * location. This means that any &quot;holes&quot; (empty slots not at the end of a
     * location), will cause the file crits and MegaMek's crits to become out of
     * sync.
     */
    private void compactCriticals(Mech mech) {
<span class="fc bfc" id="L878" title="All 2 branches covered.">        for (int loc = 0; loc &lt; mech.locations(); loc++) {</span>
<span class="fc" id="L879">            compactCriticals(mech, loc);</span>
        }
<span class="fc" id="L881">    }</span>

    private void compactCriticals(Mech mech, int loc) {
<span class="fc bfc" id="L884" title="All 2 branches covered.">        if (loc == Mech.LOC_HEAD) {</span>
            // This location has an empty slot inbetween systems crits
            // which will mess up parsing if compacted.
<span class="fc" id="L887">            return;</span>
        }
<span class="fc" id="L889">        int firstEmpty = -1;</span>
<span class="fc bfc" id="L890" title="All 2 branches covered.">        for (int slot = 0; slot &lt; mech.getNumberOfCriticals(loc); slot++) {</span>
<span class="pc bpc" id="L891" title="1 of 2 branches missed.">            if (critData[loc][slot] == null) {</span>
<span class="nc" id="L892">                critData[loc][slot] = MtfFile.EMPTY;</span>
            }

<span class="fc bfc" id="L895" title="All 4 branches covered.">            if (critData[loc][slot].equals(MtfFile.EMPTY) &amp;&amp; (firstEmpty == -1)) {</span>
<span class="fc" id="L896">                firstEmpty = slot;</span>
            }
<span class="pc bpc" id="L898" title="1 of 4 branches missed.">            if ((firstEmpty != -1) &amp;&amp; !critData[loc][slot].equals(MtfFile.EMPTY)) {</span>
                // move this to the first empty slot
<span class="nc" id="L900">                critData[loc][firstEmpty] = critData[loc][slot];</span>
                // mark the old slot empty
<span class="nc" id="L902">                critData[loc][slot] = MtfFile.EMPTY;</span>
                // restart just after the moved slot's new location
<span class="nc" id="L904">                slot = firstEmpty;</span>
<span class="nc" id="L905">                firstEmpty = -1;</span>
            }
        }
<span class="fc" id="L908">    }</span>

    private int getLocation(String location) {
<span class="pc bpc" id="L911" title="1 of 4 branches missed.">        if (location.equalsIgnoreCase(&quot;Left Arm:&quot;) || location.equalsIgnoreCase(&quot;Front Left Leg:&quot;)) {</span>
<span class="fc" id="L912">            return Mech.LOC_LARM;</span>
        }

<span class="pc bpc" id="L915" title="1 of 4 branches missed.">        if (location.equalsIgnoreCase(&quot;Right Arm:&quot;) || location.equalsIgnoreCase(&quot;Front Right Leg:&quot;)) {</span>
<span class="fc" id="L916">            return Mech.LOC_RARM;</span>
        }

<span class="pc bpc" id="L919" title="1 of 4 branches missed.">        if (location.equalsIgnoreCase(&quot;Left Leg:&quot;) || location.equalsIgnoreCase(&quot;Rear Left Leg:&quot;)) {</span>
<span class="fc" id="L920">            return Mech.LOC_LLEG;</span>
        }

<span class="pc bpc" id="L923" title="1 of 4 branches missed.">        if (location.equalsIgnoreCase(&quot;Right Leg:&quot;) || location.equalsIgnoreCase(&quot;Rear Right Leg:&quot;)) {</span>
<span class="fc" id="L924">            return Mech.LOC_RLEG;</span>
        }

<span class="pc bpc" id="L927" title="1 of 2 branches missed.">        if (location.equalsIgnoreCase(&quot;Center Leg:&quot;)) {</span>
<span class="nc" id="L928">            return Mech.LOC_CLEG;</span>
        }

<span class="fc bfc" id="L931" title="All 2 branches covered.">        if (location.equalsIgnoreCase(&quot;Left Torso:&quot;)) {</span>
<span class="fc" id="L932">            return Mech.LOC_LT;</span>
        }

<span class="fc bfc" id="L935" title="All 2 branches covered.">        if (location.equalsIgnoreCase(&quot;Right Torso:&quot;)) {</span>
<span class="fc" id="L936">            return Mech.LOC_RT;</span>
        }

<span class="fc bfc" id="L939" title="All 2 branches covered.">        if (location.equalsIgnoreCase(&quot;Center Torso:&quot;)) {</span>
<span class="fc" id="L940">            return Mech.LOC_CT;</span>
        }

        // else
<span class="fc" id="L944">        return Mech.LOC_HEAD;</span>
    }

    private int getArmorLocation(String location) {

<span class="fc" id="L949">        int loc = -1;</span>
<span class="fc" id="L950">        boolean rear = false;</span>
<span class="fc" id="L951">        String locationName = location.toLowerCase();</span>
<span class="pc bpc" id="L952" title="1 of 4 branches missed.">        if (locationName.startsWith(&quot;la armor:&quot;) || locationName.startsWith(&quot;fll armor:&quot;)) {</span>
<span class="fc" id="L953">            loc = Mech.LOC_LARM;</span>
<span class="pc bpc" id="L954" title="1 of 4 branches missed.">        } else if (locationName.startsWith(&quot;ra armor:&quot;) || locationName.startsWith(&quot;frl armor:&quot;)) {</span>
<span class="fc" id="L955">            loc = Mech.LOC_RARM;</span>
<span class="fc bfc" id="L956" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;lt armor:&quot;)) {</span>
<span class="fc" id="L957">            loc = Mech.LOC_LT;</span>
<span class="fc bfc" id="L958" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;rt armor:&quot;)) {</span>
<span class="fc" id="L959">            loc = Mech.LOC_RT;</span>
<span class="fc bfc" id="L960" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;ct armor:&quot;)) {</span>
<span class="fc" id="L961">            loc = Mech.LOC_CT;</span>
<span class="fc bfc" id="L962" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;hd armor:&quot;)) {</span>
<span class="fc" id="L963">            loc = Mech.LOC_HEAD;</span>
<span class="pc bpc" id="L964" title="1 of 4 branches missed.">        } else if (locationName.startsWith(&quot;ll armor:&quot;) || locationName.startsWith(&quot;rll armor:&quot;)) {</span>
<span class="fc" id="L965">            loc = Mech.LOC_LLEG;</span>
<span class="pc bpc" id="L966" title="1 of 4 branches missed.">        } else if (locationName.startsWith(&quot;rl armor:&quot;) || locationName.startsWith(&quot;rrl armor:&quot;)) {</span>
<span class="fc" id="L967">            loc = Mech.LOC_RLEG;</span>
<span class="fc bfc" id="L968" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;rtl armor:&quot;)) {</span>
<span class="fc" id="L969">            loc = Mech.LOC_LT;</span>
<span class="fc" id="L970">            rear = true;</span>
<span class="fc bfc" id="L971" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;rtr armor:&quot;)) {</span>
<span class="fc" id="L972">            loc = Mech.LOC_RT;</span>
<span class="fc" id="L973">            rear = true;</span>
<span class="fc bfc" id="L974" title="All 2 branches covered.">        } else if (locationName.startsWith(&quot;rtc armor:&quot;)) {</span>
<span class="fc" id="L975">            loc = Mech.LOC_CT;</span>
<span class="fc" id="L976">            rear = true;</span>
<span class="pc bpc" id="L977" title="1 of 2 branches missed.">        } else if (locationName.startsWith(&quot;cl armor:&quot;)) {</span>
<span class="nc" id="L978">            loc = Mech.LOC_CLEG;</span>
        }

<span class="fc bfc" id="L981" title="All 2 branches covered.">        if (!rear) {</span>
<span class="fc bfc" id="L982" title="All 2 branches covered.">            for (int pos = 0; pos &lt; locationOrder.length; pos++) {</span>
<span class="fc bfc" id="L983" title="All 2 branches covered.">                if (locationOrder[pos] == loc) {</span>
<span class="fc" id="L984">                    loc = pos;</span>
<span class="fc" id="L985">                    break;</span>
                }
            }
        } else {
<span class="pc bpc" id="L989" title="1 of 2 branches missed.">            for (int pos = 0; pos &lt; rearLocationOrder.length; pos++) {</span>
<span class="fc bfc" id="L990" title="All 2 branches covered.">                if (rearLocationOrder[pos] == loc) {</span>
<span class="fc" id="L991">                    loc = pos + locationOrder.length;</span>
<span class="fc" id="L992">                    break;</span>
                }
            }
        }
<span class="fc" id="L996">        return loc;</span>
    }

    private boolean isValidLocation(String location) {
<span class="fc bfc" id="L1000" title="All 2 branches covered.">        return location.equalsIgnoreCase(&quot;Left Arm:&quot;)</span>
<span class="fc bfc" id="L1001" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Right Arm:&quot;)</span>
<span class="fc bfc" id="L1002" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Left Leg:&quot;)</span>
<span class="fc bfc" id="L1003" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Right Leg:&quot;)</span>
<span class="pc bpc" id="L1004" title="1 of 2 branches missed.">                || location.equalsIgnoreCase(&quot;Center Leg:&quot;)</span>
<span class="pc bpc" id="L1005" title="1 of 2 branches missed.">                || location.equalsIgnoreCase(&quot;Front Left Leg:&quot;)</span>
<span class="pc bpc" id="L1006" title="1 of 2 branches missed.">                || location.equalsIgnoreCase(&quot;Front Right Leg:&quot;)</span>
<span class="pc bpc" id="L1007" title="1 of 2 branches missed.">                || location.equalsIgnoreCase(&quot;Rear Left Leg:&quot;)</span>
<span class="pc bpc" id="L1008" title="1 of 2 branches missed.">                || location.equalsIgnoreCase(&quot;Rear Right Leg:&quot;)</span>
<span class="fc bfc" id="L1009" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Left Torso:&quot;)</span>
<span class="fc bfc" id="L1010" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Right Torso:&quot;)</span>
<span class="fc bfc" id="L1011" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Center Torso:&quot;)</span>
<span class="fc bfc" id="L1012" title="All 2 branches covered.">                || location.equalsIgnoreCase(&quot;Head:&quot;);</span>
    }

    private boolean isProcessedComponent(String line) {
<span class="fc" id="L1016">        String lineLower = line.toLowerCase();</span>
<span class="pc bpc" id="L1017" title="1 of 2 branches missed.">        if (lineLower.startsWith(COCKPIT)) {</span>
<span class="nc" id="L1018">            cockpitType = line;</span>
<span class="nc" id="L1019">            return true;</span>
        }

<span class="pc bpc" id="L1022" title="1 of 2 branches missed.">        if (lineLower.startsWith(GYRO)) {</span>
<span class="nc" id="L1023">            gyroType = line;</span>
<span class="nc" id="L1024">            return true;</span>
        }
        
<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">        if (lineLower.startsWith(MOTIVE)) {</span>
<span class="nc" id="L1028">            motiveType = line;</span>
<span class="nc" id="L1029">            return true;</span>
        }

<span class="pc bpc" id="L1032" title="1 of 2 branches missed.">        if (lineLower.startsWith(EJECTION)) {</span>
<span class="nc" id="L1033">            ejectionType = line;</span>
<span class="nc" id="L1034">            return true;</span>
        }

<span class="fc bfc" id="L1037" title="All 2 branches covered.">        if (lineLower.startsWith(MASS)) {</span>
<span class="fc" id="L1038">            tonnage = line;</span>
<span class="fc" id="L1039">            return true;</span>
        }

<span class="fc bfc" id="L1042" title="All 2 branches covered.">        if (lineLower.startsWith(ENGINE)) {</span>
<span class="fc" id="L1043">            engine = line;</span>
<span class="fc" id="L1044">            return true;</span>
        }

<span class="fc bfc" id="L1047" title="All 2 branches covered.">        if (lineLower.startsWith(STRUCTURE)) {</span>
<span class="fc" id="L1048">            internalType = line;</span>
<span class="fc" id="L1049">            return true;</span>
        }

<span class="fc bfc" id="L1052" title="All 2 branches covered.">        if (lineLower.startsWith(MYOMER)) {</span>
<span class="fc" id="L1053">            return true;</span>
        }
        
<span class="pc bpc" id="L1056" title="1 of 2 branches missed.">        if (lineLower.startsWith(LAM)) {</span>
<span class="nc" id="L1057">            lamType = line;</span>
<span class="nc" id="L1058">            return true;</span>
        }

<span class="fc bfc" id="L1061" title="All 2 branches covered.">        if (lineLower.startsWith(CONFIG)) {</span>
<span class="fc" id="L1062">            chassisConfig = line;</span>
<span class="fc" id="L1063">            return true;</span>
        }

<span class="fc bfc" id="L1066" title="All 2 branches covered.">        if (lineLower.startsWith(TECH_BASE)) {</span>
<span class="fc" id="L1067">            techBase = line;</span>
<span class="fc" id="L1068">            return true;</span>
        }

<span class="fc bfc" id="L1071" title="All 2 branches covered.">        if (lineLower.startsWith(ERA)) {</span>
<span class="fc" id="L1072">            techYear = line;</span>
<span class="fc" id="L1073">            return true;</span>
        }

<span class="fc bfc" id="L1076" title="All 2 branches covered.">        if (lineLower.startsWith(SOURCE)) {</span>
<span class="fc" id="L1077">            source = line;</span>
<span class="fc" id="L1078">            return true;</span>
        }

<span class="fc bfc" id="L1081" title="All 2 branches covered.">        if (lineLower.startsWith(RULES_LEVEL)) {</span>
<span class="fc" id="L1082">            rulesLevel = line;</span>
<span class="fc" id="L1083">            return true;</span>
        }

<span class="fc bfc" id="L1086" title="All 2 branches covered.">        if (lineLower.startsWith(HEAT_SINKS)) {</span>
<span class="fc" id="L1087">            heatSinks = line;</span>
<span class="fc" id="L1088">            return true;</span>
        }

<span class="pc bpc" id="L1091" title="1 of 2 branches missed.">        if (lineLower.startsWith(BASE_CHASSIS_HEAT_SINKS)) {</span>
<span class="nc" id="L1092">            baseChassieHeatSinks = line;</span>
<span class="nc" id="L1093">            return true;</span>
        }

<span class="fc bfc" id="L1096" title="All 2 branches covered.">        if (lineLower.startsWith(WALK_MP)) {</span>
<span class="fc" id="L1097">            return true;</span>
        }
<span class="fc bfc" id="L1099" title="All 2 branches covered.">        if (lineLower.startsWith(JUMP_MP)) {</span>
<span class="fc" id="L1100">            jumpMP = line;</span>
<span class="fc" id="L1101">            return true;</span>
        }

<span class="fc bfc" id="L1104" title="All 2 branches covered.">        if (lineLower.startsWith(ARMOR)) {</span>
<span class="fc" id="L1105">            armorType = line;</span>
<span class="fc" id="L1106">            return true;</span>
        }

<span class="pc bpc" id="L1109" title="1 of 2 branches missed.">        if (lineLower.startsWith(NO_CRIT)) {</span>
<span class="nc" id="L1110">            noCritEquipment.add(line.substring(NO_CRIT.length()));</span>
<span class="nc" id="L1111">            return true;</span>
        }
        
<span class="fc bfc" id="L1114" title="All 2 branches covered.">        if (lineLower.startsWith(OVERVIEW)) {</span>
<span class="fc" id="L1115">            overview = line.substring(OVERVIEW.length());</span>
<span class="fc" id="L1116">            return true;</span>
        }

<span class="fc bfc" id="L1119" title="All 2 branches covered.">        if (lineLower.startsWith(CAPABILITIES)) {</span>
<span class="fc" id="L1120">            capabilities = line.substring(CAPABILITIES.length());</span>
<span class="fc" id="L1121">            return true;</span>
        }
                
<span class="fc bfc" id="L1124" title="All 2 branches covered.">        if (lineLower.startsWith(DEPLOYMENT)) {</span>
<span class="fc" id="L1125">            deployment = line.substring(DEPLOYMENT.length());</span>
<span class="fc" id="L1126">            return true;</span>
        }
        
<span class="pc bpc" id="L1129" title="1 of 2 branches missed.">        if (lineLower.startsWith(HISTORY)) {</span>
<span class="nc" id="L1130">            history = line.substring(HISTORY.length());</span>
<span class="nc" id="L1131">            return true;</span>
        }

<span class="pc bpc" id="L1134" title="1 of 2 branches missed.">        if (lineLower.startsWith(MANUFACTURER)) {</span>
<span class="nc" id="L1135">        	manufacturer = line.substring(MANUFACTURER.length());</span>
<span class="nc" id="L1136">        	return true;</span>
        }

<span class="pc bpc" id="L1139" title="1 of 2 branches missed.">        if (lineLower.startsWith(PRIMARY_FACTORY)) {</span>
<span class="nc" id="L1140">        	primaryFactory = line.substring(PRIMARY_FACTORY.length());</span>
<span class="nc" id="L1141">        	return true;</span>
        }

<span class="fc bfc" id="L1144" title="All 2 branches covered.">        if (lineLower.startsWith(SYSTEM_MANUFACTURER)) {</span>
<span class="fc" id="L1145">        	String[] fields = line.split(&quot;:&quot;);</span>
<span class="pc bpc" id="L1146" title="1 of 2 branches missed.">        	if (fields.length &gt; 2) {</span>
<span class="fc" id="L1147">        		EntityFluff.System system = EntityFluff.System.parse(fields[1]);</span>
<span class="pc bpc" id="L1148" title="1 of 2 branches missed.">        		if (null != system) {</span>
<span class="fc" id="L1149">        			systemManufacturers.put(system, fields[2].trim());</span>
        		}
        	}
<span class="fc" id="L1152">        	return true;</span>
        }

<span class="fc bfc" id="L1155" title="All 2 branches covered.">        if (lineLower.startsWith(SYSTEM_MODEL)) {</span>
<span class="fc" id="L1156">        	String[] fields = line.split(&quot;:&quot;);</span>
<span class="pc bpc" id="L1157" title="1 of 2 branches missed.">        	if (fields.length &gt; 2) {</span>
<span class="fc" id="L1158">        		EntityFluff.System system = EntityFluff.System.parse(fields[1]);</span>
<span class="pc bpc" id="L1159" title="1 of 2 branches missed.">        		if (null != system) {</span>
<span class="fc" id="L1160">        			systemModels.put(system, fields[2].trim());</span>
        		}
        	}
<span class="fc" id="L1163">        	return true;</span>
        }

<span class="pc bpc" id="L1166" title="1 of 2 branches missed.">        if (lineLower.startsWith(NOTES)) {</span>
<span class="nc" id="L1167">            notes = line.substring(NOTES.length());</span>
<span class="nc" id="L1168">            return true;</span>
        }

<span class="pc bpc" id="L1171" title="1 of 2 branches missed.">        if (lineLower.startsWith(IMAGE_FILE)) {</span>
<span class="nc" id="L1172">            imagePath = line.substring(IMAGE_FILE.length());</span>
<span class="nc" id="L1173">            return true;</span>
        }

<span class="pc bpc" id="L1176" title="1 of 2 branches missed.">        if (lineLower.startsWith(BV)) {</span>
<span class="nc" id="L1177">            bv = Integer.parseInt(line.substring(BV.length()));</span>
<span class="nc" id="L1178">            return true;</span>
        }

<span class="fc" id="L1181">        return false;</span>
    }

    private int weaponsList(String line) {
<span class="fc bfc" id="L1185" title="All 2 branches covered.">        if (line.toLowerCase().startsWith(WEAPONS)) {</span>
<span class="fc" id="L1186">            return Integer.parseInt(line.substring(WEAPONS.length()));</span>
        }

<span class="fc" id="L1189">        return -1;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>