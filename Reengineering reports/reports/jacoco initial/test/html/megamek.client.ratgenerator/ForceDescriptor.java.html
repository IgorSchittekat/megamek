<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ForceDescriptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ratgenerator</a> &gt; <span class="el_source">ForceDescriptor.java</span></div><h1>ForceDescriptor.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2016 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/

package megamek.client.ratgenerator;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

import megamek.MegaMek;
import megamek.common.Compute;
import megamek.common.Entity;
import megamek.common.EntityMovementMode;
import megamek.common.EntityWeightClass;
import megamek.common.MechFileParser;
import megamek.common.MechSummary;
import megamek.common.MechSummaryCache;
import megamek.common.UnitType;
import megamek.common.loaders.EntityLoadingException;
import megamek.common.logging.LogLevel;

/**
 * Describes the characteristics of a force. May be changed during generation.
 *
 * @author Neoancient
 *
 */
public class ForceDescriptor {

    public static final int REINFORCED = 1;
    public static final int UNDERSTRENGTH = -1;

    public static final int EXP_GREEN = 0;
    public static final int EXP_REGULAR = 1;
    public static final int EXP_VETERAN = 2;

<span class="nc" id="L57">    public static final String[] ORDINALS = {</span>
            &quot;First&quot;, &quot;Second&quot;, &quot;Third&quot;, &quot;Fourth&quot;, &quot;Fifth&quot;,
            &quot;Sixth&quot;, &quot;Seventh&quot;, &quot;Eighth&quot;, &quot;Ninth&quot;, &quot;Tenth&quot;
    };

<span class="nc" id="L62">    public static final String[] PHONETIC = {</span>
            &quot;Alpha&quot;, &quot;Bravo&quot;, &quot;Charlie&quot;, &quot;Delta&quot;, &quot;Echo&quot;,
            &quot;Foxtrot&quot;, &quot;Golf&quot;, &quot;Hotel&quot;, &quot;India&quot;, &quot;Juliett&quot;,
            &quot;Kilo&quot;, &quot;Lima&quot;, &quot;Mike&quot;, &quot;November&quot;, &quot;Oscar&quot;,
            &quot;Papa&quot;, &quot;Quebec&quot;, &quot;Romeo&quot;, &quot;Sierra&quot;, &quot;Tango&quot;,
            &quot;Uniform&quot;, &quot;Victor&quot;, &quot;Whiskey&quot;, &quot;X-ray&quot;, &quot;Yankee&quot;,
            &quot;Zulu&quot;
    };

<span class="nc" id="L71">    public static final String[] GREEK = {</span>
            &quot;Alpha&quot;, &quot;Beta&quot;, &quot;Gamma&quot;, &quot;Delta&quot;, &quot;Epsilon&quot;,
            &quot;Zeta&quot;, &quot;Eta&quot;, &quot;Theta&quot;, &quot;Iota&quot;, &quot;Kappa&quot;,
            &quot;Lambda&quot;, &quot;Mu&quot;, &quot;Nu&quot;, &quot;Xi&quot;, &quot;Omicron&quot;, &quot;Pi&quot;,
            &quot;Rho&quot;, &quot;Sigma&quot;, &quot;Tau&quot;, &quot;Upsilon&quot;, &quot;Phi&quot;,
            &quot;Chi&quot;, &quot;Psi&quot;, &quot;Omega&quot;
    };

<span class="nc" id="L79">    public static final String[] LATIN = {</span>
            &quot;Prima&quot;, &quot;Secunda&quot;, &quot;Tertia&quot;, &quot;Quarta&quot;, &quot;Quinta&quot;,
            &quot;Sexta&quot;, &quot;Septima&quot;, &quot;Octava&quot;, &quot;Nona&quot;, &quot;Decima&quot;
    };

<span class="nc" id="L84">    public static final String[] ROMAN = {</span>
            &quot;I&quot;, &quot;II&quot;, &quot;III&quot;, &quot;IV&quot;, &quot;V&quot;, &quot;VI&quot;, &quot;VII&quot;, &quot;VIII&quot;, &quot;IX&quot;, &quot;X&quot;,
            &quot;XI&quot;, &quot;XII&quot;, &quot;XIII&quot;, &quot;XIV&quot;, &quot;XV&quot;, &quot;XVI&quot;, &quot;XVII&quot;, &quot;XVIII&quot;, &quot;XIX&quot;, &quot;XX&quot;
    };

    private int index;
    private String name;
    private String faction;
    private Integer year;
    private Integer eschelon;
    private int sizeMod;
    private boolean augmented;
    private Integer weightClass;
    private Integer unitType;
    private HashSet&lt;EntityMovementMode&gt; movementModes;
    private HashSet&lt;MissionRole&gt; roles;
    private String rating;
    private Integer experience;
    private Integer rankSystem;
    private Integer coRank;
    private HashSet&lt;String&gt; models;
    private HashSet&lt;String&gt; chassis;
    private HashSet&lt;String&gt; variants;
    private CrewDescriptor co;
    private CrewDescriptor xo;
    private String camo;

    private HashSet&lt;String&gt; flags;

    private FormationType formationType;
    private String generationRule;
    private boolean topLevel;
    private boolean element;
    private int positionIndex;
    private int nameIndex;
    private String fluffName;
    private Entity entity;
    private List&lt;ValueNode&gt; nameNodes;

    private boolean generateAttachments;
    private ForceDescriptor parent;
    private ArrayList&lt;ForceDescriptor&gt; subforces;
    private ArrayList&lt;ForceDescriptor&gt; attached;
<span class="nc" id="L127">    private double dropshipPct = 0.0;</span>
<span class="nc" id="L128">    private double jumpshipPct = 0.0;</span>
<span class="nc" id="L129">    private double cargo = 0.0;</span>

<span class="nc" id="L131">    public ForceDescriptor() {</span>
<span class="nc" id="L132">        faction = &quot;IS&quot;;</span>
<span class="nc" id="L133">        year = 3067;</span>
<span class="nc" id="L134">        movementModes = new HashSet&lt;EntityMovementMode&gt;();</span>
<span class="nc" id="L135">        roles = new HashSet&lt;MissionRole&gt;();</span>
<span class="nc" id="L136">        formationType = null;</span>
<span class="nc" id="L137">        experience = EXP_REGULAR;</span>
<span class="nc" id="L138">        models = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L139">        chassis = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L140">        variants = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L141">        parent = null;</span>
<span class="nc" id="L142">        subforces = new ArrayList&lt;ForceDescriptor&gt;();</span>
<span class="nc" id="L143">        attached = new ArrayList&lt;ForceDescriptor&gt;();</span>
<span class="nc" id="L144">        flags = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L145">        topLevel = false;</span>
<span class="nc" id="L146">        element = false;</span>
<span class="nc" id="L147">        positionIndex = -1;</span>
<span class="nc" id="L148">        nameIndex = -1;</span>
<span class="nc" id="L149">        fluffName = null;</span>
<span class="nc" id="L150">    }</span>

    /**
     * Checks whether the chassis matches the unit type for this node of the force tree.
     * If a list of acceptable chassis has been assigned, checks whether the chassis is in the list.
     * unit type.
     *
     * @param cRec A unit chassis record
     * @return     Whether the chassis is of the correct unit type and is on the list of acceptable
     *             chassis if it exists.
     *
     */
    public boolean matches(ChassisRecord cRec) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (cRec.getUnitType() != unitType) {</span>
<span class="nc" id="L164">            return false;</span>
        }
<span class="nc bnc" id="L166" title="All 4 branches missed.">        if (chassis.size() &gt; 0 &amp;&amp; !chassis.contains(cRec.getChassis())) {</span>
<span class="nc" id="L167">            return false;</span>
        }
<span class="nc" id="L169">        return true;</span>
    }

    /**
     * If a list of acceptable chassis, models, or variants has been assigned, checks whether
     * the model is among them.
     *
     * @param mRec A unit model record
     * @return     Whether the model is on the list of acceptable chassis, variants, or models.
     *
     */
    public boolean matches(ModelRecord mRec) {
<span class="nc bnc" id="L181" title="All 4 branches missed.">        if (chassis.size() &gt; 0 &amp;&amp; !chassis.contains(mRec.getChassis())) {</span>
<span class="nc" id="L182">            return false;</span>
        }
<span class="nc bnc" id="L184" title="All 4 branches missed.">        if (variants.size() &gt; 0 &amp;&amp; !variants.contains(mRec.getModel())) {</span>
<span class="nc" id="L185">            return false;</span>
        }
<span class="nc bnc" id="L187" title="All 4 branches missed.">        if (models.size() &gt; 0 &amp;&amp; !models.contains(mRec.getKey())) {</span>
<span class="nc" id="L188">            return false;</span>
        }
<span class="nc" id="L190">        return true;</span>
    }

    /**
     * Goes through the force tree structure and generates units for all leaf nodes.
     */
    public void generateUnits(Ruleset.ProgressListener l, double progress) {
        //If the parent node has a chassis or model assigned, it carries through to the children.
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (null != parent) {</span>
<span class="nc" id="L199">            chassis.addAll(parent.getChassis());</span>
<span class="nc" id="L200">            models.addAll(parent.getModels());</span>
        }
        //First see if a formation has been assigned. If unable to fulfill the formation requirements, generate using default parameters.
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (subforces.isEmpty()) {</span>
<span class="nc" id="L204">            ModelRecord mr = generate();</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">            if (null == mr &amp;&amp; !models.isEmpty()) {</span>
<span class="nc" id="L206">                mr = RATGenerator.getInstance().getModelRecord(getModelName());</span>
            }
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if (null != mr) {</span>
<span class="nc" id="L209">                setUnit(mr);</span>
            } else {
<span class="nc" id="L211">                MegaMek.getLogger().error(&quot;Could not generate unit&quot;);</span>
            }
<span class="nc" id="L213">        } else {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (null != formationType) {</span>
                //Simple leaf node (Lance, Star, etc.
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (null != generationRule) {</span>
                    //In cases like Novas and air lances the formation rules only apply to some of the units
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (!generateAndAssignFormation(subforces, generationRule.equals(&quot;chassis&quot;), 0)) {</span>
<span class="nc" id="L219">                        generateLance(subforces);</span>
<span class="nc" id="L220">                        formationType = null;</span>
                    }
                } else {
                    //If group generation is not set, then either this is a compound formation (e.g. squadron,
                    //aero/vehicle Point) or we are generating uniform subforces such as companies in SL line units
                    try {
<span class="nc" id="L226">                        Map&lt;String,List&lt;ForceDescriptor&gt;&gt; byGenRule = subforces.stream()</span>
<span class="nc" id="L227">                                .collect(Collectors.groupingBy(ForceDescriptor::getGenerationRule));</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                        if (byGenRule.containsKey(&quot;group&quot;)) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                            if (!generateAndAssignFormation(byGenRule.get(&quot;group&quot;).stream()</span>
<span class="nc" id="L230">                                    .map(fd -&gt; fd.getSubforces()).flatMap(sf -&gt; sf.stream())</span>
<span class="nc" id="L231">                                    .collect(Collectors.toList()), false, byGenRule.get(&quot;group&quot;).size())) {</span>
<span class="nc" id="L232">                                formationType = null;</span>
                            }
<span class="nc bnc" id="L234" title="All 2 branches missed.">                        } else if (byGenRule.containsKey(&quot;model&quot;)) {</span>
<span class="nc" id="L235">                            generateAndAssignFormation(byGenRule.get(&quot;model&quot;), false, 0);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                        } else if (byGenRule.containsKey(&quot;chassis&quot;)) {</span>
<span class="nc" id="L237">                            generateAndAssignFormation(byGenRule.get(&quot;chassis&quot;), true, 0);</span>
                        }
<span class="nc" id="L239">                    } catch (NullPointerException ex) {</span>
<span class="nc" id="L240">                        MegaMek.getLogger().error(&quot;Found null generation rule in force node with formation set.&quot;);</span>
<span class="nc" id="L241">                    }</span>
                }
            } else {
<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (null != generationRule) {</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">                    switch(generationRule) {</span>
                        case &quot;chassis&quot;:
<span class="nc bnc" id="L247" title="All 2 branches missed.">                            if (getChassis().isEmpty()) {</span>
<span class="nc" id="L248">                                generate(generationRule);</span>
                            }
                            break;
                        case &quot;model&quot;:
<span class="nc bnc" id="L252" title="All 2 branches missed.">                            if (getModels().isEmpty()) {</span>
<span class="nc" id="L253">                                generate(generationRule);</span>
                            }
                            break;
                        case &quot;group&quot;:
<span class="nc" id="L257">                            generateLance(subforces);</span>
                            break;
                    }
                }
            }
        }
<span class="nc" id="L263">        int count = subforces.size() + attached.size();</span>
<span class="nc" id="L264">        subforces.forEach(fd -&gt; fd.generateUnits(l, progress / count));</span>
<span class="nc" id="L265">        attached.forEach(fd -&gt; fd.generateUnits(l, progress / count));</span>
<span class="nc bnc" id="L266" title="All 4 branches missed.">        if (count == 0 &amp;&amp; null != l) {</span>
<span class="nc" id="L267">            l.updateProgress(progress, &quot;Populating force tree&quot;);</span>
        }
<span class="nc" id="L269">    }</span>

    /**
     * Sorts out all subforce nodes eligible for the &lt;code&gt;FormationType&lt;/code&gt; and attempts to generate
     * a formation based on their parameters. If the formation is successfully generated, it is distributed
     * to the subforces in the order provided. For leaf node, the unit is set. For non-final nodes,
     * the unit is added to either the model or chassis list depending on the provided grouping rule.
     * Any subforces that are not eligible for the formation are then generated.
     *
     * @param subs             The subforces to generate unit for. These need not be direct children of
     *                         &lt;code&gt;this&lt;/code&gt;.
     * @param chassis          If true, any non-final subforce node will have the generated unit added to the
     *                         chassis list instead of the model list.
     * @param numGroups        The number of groups to pass on to formation generation; used to override
     *                         standard grouping constraints (e.g. matched pairs in fighter squadrons).
     * @return                 Whether the formation was successfully generated.
     */
    private boolean generateAndAssignFormation(List&lt;ForceDescriptor&gt; subs, boolean chassis, int numGroups) {
<span class="nc" id="L287">        Map&lt;Boolean,List&lt;ForceDescriptor&gt;&gt; eligibleSubs = subs.stream()</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">                .collect(Collectors.groupingBy(fd -&gt; null != fd.getUnitType()</span>
<span class="nc bnc" id="L289" title="All 4 branches missed.">                &amp;&amp; (formationType.isAllowedUnitType(fd.getUnitType()))</span>
                || (augmented
<span class="nc bnc" id="L291" title="All 2 branches missed.">                        &amp;&amp; (fd.getUnitType() == UnitType.BATTLE_ARMOR)</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                        || fd.getUnitType() == UnitType.INFANTRY)));</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (eligibleSubs.containsKey(true)) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (eligibleSubs.get(true).isEmpty()) {</span>
<span class="nc" id="L295">                return false;</span>
            } else {
<span class="nc" id="L297">                List&lt;ModelRecord&gt; list = null;</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (augmented) {</span>
<span class="nc" id="L299">                    list = generateNovaFormation(eligibleSubs.get(true), ModelRecord.NETWORK_NONE, numGroups);</span>
                } else {
<span class="nc" id="L301">                    list = generateFormation(eligibleSubs.get(true), ModelRecord.NETWORK_NONE, numGroups);</span>
                }
<span class="nc bnc" id="L303" title="All 2 branches missed.">                if (list.isEmpty()) {</span>
<span class="nc" id="L304">                    return false;</span>
                } else {
<span class="nc bnc" id="L306" title="All 2 branches missed.">                    for (int i = 0; i &lt; list.size(); i++) {</span>
                        //The formation requirements do not apply to the infantry part of a nova, and
                        //those units have already been generated by generateNovaFormation.
<span class="nc bnc" id="L309" title="All 2 branches missed.">                        if (augmented</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                                &amp;&amp; (eligibleSubs.get(true).get(i).getUnitType() == UnitType.BATTLE_ARMOR</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                                || eligibleSubs.get(true).get(i).getUnitType() == UnitType.INFANTRY)) {</span>
<span class="nc" id="L312">                            continue;</span>
                        }
<span class="nc bnc" id="L314" title="All 2 branches missed.">                        if (eligibleSubs.get(true).get(i).getSubforces().isEmpty()) {</span>
<span class="nc" id="L315">                            eligibleSubs.get(true).get(i).setUnit(list.get(i));</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                        } else if (chassis) {</span>
<span class="nc" id="L317">                            eligibleSubs.get(true).get(i).getChassis().add(list.get(i).getChassis());</span>
                        } else {
<span class="nc" id="L319">                            eligibleSubs.get(true).get(i).getModels().add(list.get(i).getKey());</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (eligibleSubs.containsKey(false)) {</span>
<span class="nc" id="L325">                generateLance(eligibleSubs.get(false));</span>
            }
        }
<span class="nc" id="L328">        return true;</span>
    }

    /**
     * Translates &lt;code&gt;ForceDescriptor&lt;/code&gt; list into parameters to pass to the formation builder.
     *
     * @param subs         A list of &lt;ForceDescriptor&lt;/code&gt; nodes.
     * @param networkMask  The type of C3 network that should be used in generating the formation.
     * @param numGroups    Overrides the default value for formation grouping constraints (e.g. some
     *                     Capellan squadrons have two groups of three instead of the standard three groups
     *                     of two).
     * @return             The list of units that make up the formation, or an empty list if a formation
     *                     could not be generated with the given parameters.
     */
    private List&lt;ModelRecord&gt; generateFormation (List&lt;ForceDescriptor&gt; subs, int networkMask, int numGroups) {
<span class="nc" id="L343">        Map&lt;UnitTable.Parameters, Integer&gt; paramCount = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        for (ForceDescriptor sub : subs) {</span>
<span class="nc" id="L345">            paramCount.merge(new UnitTable.Parameters(sub.getFactionRec(),</span>
<span class="nc" id="L346">                    sub.getUnitType(), sub.getYear(), sub.ratGeneratorRating(), null, networkMask,</span>
<span class="nc" id="L347">                    sub.getMovementModes(), sub.getRoles(), 0, sub.getFactionRec()), 1, Integer::sum);</span>
<span class="nc" id="L348">        }</span>

<span class="nc" id="L350">        List&lt;UnitTable.Parameters&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L351">        List&lt;Integer&gt; numUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">        for (Map.Entry&lt;UnitTable.Parameters, Integer&gt; e : paramCount.entrySet()) {</span>
<span class="nc" id="L353">            params.add(e.getKey());</span>
<span class="nc" id="L354">            numUnits.add(e.getValue());</span>
<span class="nc" id="L355">        }</span>
        // Check for amount of C3 equipment generated and if certain thresholds are met regenerate the unit
        // with a valid network.
<span class="nc" id="L358">        List&lt;MechSummary&gt; unitList = formationType.generateFormation(params, numUnits, networkMask, false, 0, numGroups);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (networkMask == ModelRecord.NETWORK_NONE) {</span>
<span class="nc" id="L360">            int c3m = 0;</span>
<span class="nc" id="L361">            int c3s = 0;</span>
<span class="nc" id="L362">            int c3i = 0;</span>
<span class="nc" id="L363">            int nova = 0;</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">            for (MechSummary ms : unitList) {</span>
<span class="nc" id="L365">                ModelRecord mRec = RATGenerator.getInstance().getModelRecord(ms.getName());</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                int mask = mRec == null? ModelRecord.NETWORK_NONE : mRec.getNetworkMask();</span>

<span class="nc bnc" id="L368" title="All 2 branches missed.">                if ((mask &amp; ModelRecord.NETWORK_C3_MASTER) != 0) {</span>
<span class="nc" id="L369">                    c3m++;</span>
                }
<span class="nc bnc" id="L371" title="All 2 branches missed.">                if ((mask &amp; ModelRecord.NETWORK_C3_SLAVE) != 0) {</span>
<span class="nc" id="L372">                    c3s++;</span>
                }
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if ((mask &amp; ModelRecord.NETWORK_C3I) != 0) {</span>
<span class="nc" id="L375">                    c3i++;</span>
                }
<span class="nc bnc" id="L377" title="All 2 branches missed.">                if ((mask &amp; ModelRecord.NETWORK_NOVA) != 0) {</span>
<span class="nc" id="L378">                    nova++;</span>
                }
<span class="nc" id="L380">            }</span>
            // Any lance with a C3 master should have three slave units (or the remainder of the unit, if smaller)
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (c3m &gt; 0) {</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">                if ((c3m &gt; 1) || (c3s &lt; Math.max(3, unitList.size() - 1))) {</span>
<span class="nc" id="L384">                    networkMask = ModelRecord.NETWORK_C3_MASTER;</span>
                } else {
<span class="nc" id="L386">                    flags.add(&quot;c3&quot;);</span>
                }
            } else {
                // If no master was generated, each slave unit gives a cumulative 1/3 chance of a network. Isolated
                // C3 slaves will be encountered, but not usually more than one or maybe two in a lance.
<span class="nc bnc" id="L391" title="All 2 branches missed.">                if (c3s &gt; Compute.randomInt(3)) {</span>
<span class="nc" id="L392">                    networkMask = ModelRecord.NETWORK_C3_MASTER;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                } else if (c3i &gt; Compute.randomInt(5)) {</span>
                    // Each C3i gives a 1/5 chance of a full C3i network. A network is still useful if not full.
<span class="nc" id="L395">                    networkMask = ModelRecord.NETWORK_C3I;</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                } else if (nova &gt; 0) {</span>
                    // The Nova CEWS is specialized enough to add a complete network if any is present.
<span class="nc" id="L398">                    networkMask = ModelRecord.NETWORK_NOVA;</span>
                }
            }
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (networkMask != ModelRecord.NETWORK_NONE) {</span>
<span class="nc" id="L402">                List&lt;MechSummary&gt; netList = formationType.generateFormation(params, numUnits, networkMask, false, 0, numGroups);</span>
                // Attempt to create the type of network indicated. If no unit can be created that fits the
                // criteria, fall back on the unit that was originally generated.
<span class="nc bnc" id="L405" title="All 2 branches missed.">                if (!netList.isEmpty()) {</span>
<span class="nc" id="L406">                    unitList = netList;</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                    if (networkMask == ModelRecord.NETWORK_C3I) {</span>
<span class="nc" id="L408">                        flags.add(&quot;c3i&quot;);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                    } else if (networkMask == ModelRecord.NETWORK_NOVA) {</span>
<span class="nc" id="L410">                        flags.add(&quot;novacews&quot;);</span>
                    } else {
<span class="nc" id="L412">                        flags.add(&quot;c3&quot;);</span>
                    }
                }
            }
        }
<span class="nc" id="L417">        return unitList.stream().map(ms -&gt; RATGenerator.getInstance().getModelRecord(ms.getName()))</span>
<span class="nc" id="L418">                .collect(Collectors.toList());</span>
    }

    /**
     * The Nova formation is a composite of base type and battle armor. The formationType only applies to the
     * base unit type (Mek, vehicle, fighter). The BA must be eligible for mechanized and have at least
     * one omni among the base units per BA squad/point, excepting any BA with magnetic clamps.
     *
     * Though the rules in Campaign Operations only cover BA novas, the Hell's Horses vehicle/conventional infantry
     * nova formations require an adapted version of the Nova formation rules to work.
     *
     * This method generates and assigns infantry elements and returns the list of base elements.
     *
     * @param subs         A list of &lt;ForceDescriptor&lt;/code&gt; nodes.
     * @param networkMask  The type of C3 network that should be used in generating the formation.
     * @param numGroups    Overrides the default value for formation grouping constraints (e.g. some
     *                     Capellan squadrons have two groups of three instead of the standard three groups
     *                     of two).
     * @return             The list of units that make up the base formation, or an empty list if a formation
     *                     could not be generated with the given parameters.
     */
    private List&lt;ModelRecord&gt; generateNovaFormation(List&lt;ForceDescriptor&gt; subs, int networkMask, int numGroups) {
        //Split base and infantry units
<span class="nc" id="L441">        List&lt;ForceDescriptor&gt; baseSubs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L442">        List&lt;ForceDescriptor&gt; baSubs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L443">        List&lt;ForceDescriptor&gt; infSubs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        for (ForceDescriptor sub : subs) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">            if (sub.getUnitType() == UnitType.BATTLE_ARMOR) {</span>
<span class="nc" id="L446">                baSubs.add(sub);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            } else if (sub.getUnitType() == UnitType.INFANTRY) {</span>
<span class="nc" id="L448">                infSubs.add(sub);</span>
            } else {
<span class="nc" id="L450">                baseSubs.add(sub);</span>
            }
<span class="nc" id="L452">        }</span>
        //If there is any conventional infantry we'll generate it first, then assign the APC role
        //to as many vehicles (if any) in the base units as we have foot infantry. Any remaining vehicles
        //will get the infantry support role.
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (infSubs.size() &gt; 0) {</span>
<span class="nc" id="L457">            generateLance(infSubs);</span>
<span class="nc" id="L458">            int footCount = (int)infSubs.stream().filter(fd -&gt; fd.getMovementModes()</span>
<span class="nc" id="L459">                    .contains(EntityMovementMode.INF_LEG)).count();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            for (int i = 0; i &lt; baseSubs.size(); i++) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                if (baseSubs.get(i).getUnitType() == UnitType.TANK</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                        || baseSubs.get(i).getUnitType() == UnitType.VTOL) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                    if (footCount &gt; 0) {</span>
<span class="nc" id="L464">                        baseSubs.get(i).getRoles().add(MissionRole.APC);</span>
<span class="nc" id="L465">                        footCount--;</span>
                    } else {
<span class="nc" id="L467">                        baseSubs.get(i).getRoles().add(MissionRole.INF_SUPPORT);</span>
                    }
                }
            }
        }
        //Generate the base units according to the formation type.
<span class="nc" id="L473">        List&lt;ModelRecord&gt; baseUnitList = null;</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if (!baseSubs.isEmpty()) {</span>
<span class="nc" id="L475">            baseUnitList = generateFormation(baseSubs, networkMask, numGroups);</span>
        }
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (null == baseUnitList) {</span>
<span class="nc" id="L478">            generateLance(baseSubs);</span>
<span class="nc" id="L479">            baseUnitList = baseSubs.stream().map(ForceDescriptor::getModelName)</span>
<span class="nc" id="L480">                    .map(m -&gt; RATGenerator.getInstance().getModelRecord(m))</span>
<span class="nc" id="L481">                    .filter(Objects::nonNull).collect(Collectors.toList());</span>
        }

        //Any BA in exceess of the number of omni base units will require mag clamps, up to the number of base units.
<span class="nc" id="L485">        int magReq = Math.min((int)(baSubs.size() - baseUnitList.stream().filter(mr -&gt; mr.isOmni()).count()),</span>
<span class="nc" id="L486">                baSubs.size());</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">        for (int i = 0; i &lt; baSubs.size(); i++) {</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">            if (i &lt; magReq) {</span>
<span class="nc" id="L489">                baSubs.get(i).getRoles().add(MissionRole.MAG_CLAMP);</span>
            } else {
<span class="nc" id="L491">                baSubs.get(i).getRoles().add(MissionRole.MECHANIZED_BA);</span>
            }
        }
<span class="nc" id="L494">        generateLance(baSubs);</span>

<span class="nc" id="L496">        return baseUnitList;</span>
    }

    /**
     * Generates a lance or other end-level unit (star, level ii) by individual units rather than
     * as an entire formation. Some unit cohesion is attempted for certain unit types, such as building
     * vehicle lances out of the same model or pairing fighter chassis. The equipment rating has an
     * effect on unit cohesion, such that lower rated units are more likely to have mismatched equipment.
     *
     * @param subs The subforces that describe the indiviual elements of the lance
     */
    public void generateLance(List&lt;ForceDescriptor&gt; subs) {
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (subs.size() == 0) {</span>
<span class="nc" id="L509">            return;</span>
        }
<span class="nc" id="L511">        ModelRecord unit = null;</span>
<span class="nc bnc" id="L512" title="All 4 branches missed.">        if (chassis.size() &gt; 0 || models.size() &gt; 0) {</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">            for (ForceDescriptor sub : subs) {</span>
<span class="nc" id="L514">                unit = sub.generate();</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                if (unit != null) {</span>
<span class="nc" id="L516">                    sub.setUnit(unit);</span>
                }
<span class="nc" id="L518">            }</span>
<span class="nc" id="L519">            return;</span>
        }

        /* This method can be used to generate pieces of a combined arms
         * unit, so we need to get the unit type from one of the subforces
         * rather than the current. */

<span class="nc" id="L526">        Integer ut = subs.get(0).getUnitType();</span>

<span class="nc" id="L528">        boolean useWeights = useWeightClass(ut);</span>
<span class="nc" id="L529">        ArrayList&lt;Integer&gt; weights = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (useWeights) {</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">            for (ForceDescriptor sub : subs) {</span>
<span class="nc" id="L532">                weights.add(sub.getWeightClass());</span>
<span class="nc" id="L533">            }</span>
        } else {
<span class="nc" id="L535">            weights.add(-1);</span>
<span class="nc" id="L536">            weights.add(0);</span>
<span class="nc" id="L537">            weights.add(1);</span>
<span class="nc" id="L538">            weights.add(2);</span>
<span class="nc" id="L539">            weights.add(3);</span>
<span class="nc" id="L540">            weights.add(4);</span>
<span class="nc" id="L541">            weights.add(5);</span>
<span class="nc" id="L542">            weights.add(null);</span>
        }
<span class="nc" id="L544">        int ratingLevel = getRatingLevel();</span>
<span class="nc" id="L545">        int totalLevels = 5;</span>
        /*
         * 		Using the rating level relative to the total number of levels throws the results
         * 		off for ComStar, which should behave as A-B out of A-F rather than A-B out of A-B.
         *
         * 		int totalLevels = RATGenerator.getInstance().getFaction(faction.split(&quot;,&quot;)[0]).getRatingLevels().size();
         */
<span class="nc" id="L552">        int target = 12 - ratingLevel;</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">        if (ratingLevel &lt; 0) {</span>
<span class="nc" id="L554">            target = 10;</span>
        }
<span class="nc" id="L556">        Integer era = RATGenerator.getInstance().eraForYear(getYear());</span>
<span class="nc" id="L557">        AvailabilityRating av = null;</span>
<span class="nc" id="L558">        ModelRecord baseModel = null;</span>
        /* Generate base model using weight class of entire formation */
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (ut != null) {</span>
<span class="nc bnc" id="L561" title="All 6 branches missed.">            if (!(ut == UnitType.MEK || (ut == UnitType.AERO &amp;&amp; subs.size() &gt; 3))) {</span>
<span class="nc" id="L562">                baseModel = subs.get(0).generate();</span>
            }
<span class="nc bnc" id="L564" title="All 4 branches missed.">            if (ut == UnitType.AERO || ut == UnitType.CONV_FIGHTER) {</span>
<span class="nc" id="L565">                target -= 3;</span>
            }
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (roles.contains(MissionRole.ARTILLERY)) {</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (baseModel != null &amp;&amp;</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                        baseModel.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</span>
<span class="nc" id="L570">                    roles.remove(MissionRole.ARTILLERY);</span>
<span class="nc" id="L571">                    roles.add(MissionRole.MISSILE_ARTILLERY);</span>
                } else {
<span class="nc" id="L573">                    target -= 4;</span>
                }
            }
        }
<span class="nc bnc" id="L577" title="All 2 branches missed.">        for (ForceDescriptor sub : subs) {</span>
<span class="nc" id="L578">            boolean foundUnit = false;</span>
<span class="nc bnc" id="L579" title="All 6 branches missed.">            if (baseModel == null || (ut != null &amp;&amp; !ut.equals(sub.getUnitType()))) {</span>
<span class="nc" id="L580">                unit = sub.generate();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                if (unit != null) {</span>
<span class="nc" id="L582">                    sub.setUnit(unit);</span>
<span class="nc" id="L583">                    baseModel = unit;</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                    if (useWeights) {</span>
<span class="nc" id="L585">                        weights.remove(sub.getWeightClass());</span>
                    }
<span class="nc" id="L587">                    foundUnit = true;</span>
                }
            } else {
<span class="nc bnc" id="L590" title="All 2 branches missed.">                for (String model : baseModel.getDeployedWith()) {</span>
<span class="nc" id="L591">                    String chassisKey = model + &quot;[&quot; + ut + &quot;]&quot;;</span>
<span class="nc" id="L592">                    ChassisRecord cRec = RATGenerator.getInstance().getChassisRecord(chassisKey);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">                    if (cRec == null) {</span>
<span class="nc" id="L594">                        cRec = RATGenerator.getInstance().getChassisRecord(chassisKey + &quot;Omni&quot;);</span>
                    }
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    if (cRec != null) {</span>
<span class="nc" id="L597">                        av = RATGenerator.getInstance().</span>
<span class="nc" id="L598">                                findChassisAvailabilityRecord(era, model, faction, getYear());</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                        if (av == null) {</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                            for (String alt : RATGenerator.getInstance().getFaction(faction).getParentFactions()) {</span>
<span class="nc" id="L601">                                av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, model, alt, getYear());</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                                if (av != null) {</span>
<span class="nc" id="L603">                                    break;</span>
                                }
<span class="nc" id="L605">                            }</span>
                        }
<span class="nc bnc" id="L607" title="All 4 branches missed.">                        if (Compute.d6(2) &gt;= target - ((av == null)?0:av.adjustForRating(ratingLevel, totalLevels))) {</span>
<span class="nc" id="L608">                            sub.getChassis().clear();</span>
<span class="nc" id="L609">                            sub.getChassis().add(model);</span>
<span class="nc" id="L610">                            int oldWt = sub.getWeightClass();</span>
<span class="nc" id="L611">                            sub.setWeightClass(-1);</span>
<span class="nc" id="L612">                            unit = sub.generate();</span>
<span class="nc bnc" id="L613" title="All 4 branches missed.">                            if (unit != null &amp;&amp; weights.contains(unit.getWeightClass())) {</span>
<span class="nc" id="L614">                                sub.setUnit(unit);</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                                if (useWeights) {</span>
<span class="nc" id="L616">                                    weights.remove(sub.getWeightClass());</span>
                                }
<span class="nc" id="L618">                                foundUnit = true;</span>
<span class="nc" id="L619">                                break;</span>
                            } else {
<span class="nc" id="L621">                                sub.setWeightClass(oldWt);</span>
                            }
<span class="nc" id="L623">                        }</span>
                    } else {
<span class="nc" id="L625">                        ModelRecord mRec = RATGenerator.getInstance().getModelRecord(model);</span>
<span class="nc bnc" id="L626" title="All 4 branches missed.">                        if (mRec != null &amp;&amp; weights.contains(mRec.getWeightClass())</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                                &amp;&amp; RATGenerator.getInstance().findModelAvailabilityRecord(era, model, faction) != null) {</span>
<span class="nc" id="L628">                            av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, mRec.getChassisKey(), faction, getYear());</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                            if (av == null) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">                                for (String alt : RATGenerator.getInstance().getFaction(faction).getParentFactions()) {</span>
<span class="nc" id="L631">                                    av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, mRec.getChassisKey(), alt, getYear());</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                                    if (av != null) {</span>
<span class="nc" id="L633">                                        break;</span>
                                    }
<span class="nc" id="L635">                                }</span>
                            }
<span class="nc bnc" id="L637" title="All 4 branches missed.">                            if (Compute.d6(2) &gt;= target - ((av == null)?0:av.adjustForRating(ratingLevel, totalLevels))) {</span>
<span class="nc" id="L638">                                sub.setUnit(mRec);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                                if (useWeights) {</span>
<span class="nc" id="L640">                                    weights.remove((Object)mRec.getWeightClass());</span>
                                }
<span class="nc" id="L642">                                foundUnit = true;</span>
<span class="nc" id="L643">                                break;</span>
                            }
                        }
                    }
<span class="nc" id="L647">                }</span>
<span class="nc bnc" id="L648" title="All 4 branches missed.">                if (!foundUnit &amp;&amp; weights.contains(baseModel.getWeightClass())) {</span>
<span class="nc" id="L649">                    av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, baseModel.getChassisKey(), faction, getYear());</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                    if (av == null) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                        for (String alt : RATGenerator.getInstance().getFaction(faction).getParentFactions()) {</span>
<span class="nc" id="L652">                            av = RATGenerator.getInstance().findChassisAvailabilityRecord(era, baseModel.getChassisKey(), alt, getYear());</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                            if (av != null) {</span>
<span class="nc" id="L654">                                break;</span>
                            }
<span class="nc" id="L656">                        }</span>
                    }
<span class="nc bnc" id="L658" title="All 4 branches missed.">                    if (Compute.d6(2) &gt;= target - ((av == null)?0:av.adjustForRating(ratingLevel, totalLevels))) {</span>
<span class="nc" id="L659">                        sub.getChassis().add(baseModel.getChassis());</span>
<span class="nc" id="L660">                        sub.setWeightClass(-1);</span>
<span class="nc" id="L661">                        unit = sub.generate();</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">                        if (unit != null) {</span>
<span class="nc" id="L663">                            sub.setUnit(unit);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                            if (useWeights) {</span>
<span class="nc" id="L665">                                weights.remove(sub.getWeightClass());</span>
                            }
<span class="nc" id="L667">                            foundUnit = true;</span>
                        }
<span class="nc bnc" id="L669" title="All 4 branches missed.">                    } else if (ut == UnitType.TANK &amp;&amp; Compute.d6(2) &gt;= target - 6) {</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                        if (useWeights) {</span>
<span class="nc bnc" id="L671" title="All 3 branches missed.">                            switch (baseModel.getMechSummary().getUnitSubType()) {</span>
                                case &quot;Hover&quot;:
<span class="nc bnc" id="L673" title="All 2 branches missed.">                                    if (weights.contains(EntityWeightClass.WEIGHT_HEAVY)) {</span>
<span class="nc" id="L674">                                        break;</span>
                                    }
                                    /* fall through */
                                case &quot;Wheeled&quot;:
<span class="nc bnc" id="L678" title="All 2 branches missed.">                                    if (weights.contains(EntityWeightClass.WEIGHT_ASSAULT)) {</span>
<span class="nc" id="L679">                                        break;</span>
                                    }
<span class="nc" id="L681">                                    sub.getMovementModes().add(baseModel.getMovementMode());</span>
                            }
                        }
<span class="nc bnc" id="L684" title="All 2 branches missed.">                    } else if (ut == UnitType.INFANTRY) {</span>
<span class="nc" id="L685">                        sub.getMovementModes().add(baseModel.getMovementMode());</span>
                    }
                }
            }
<span class="nc bnc" id="L689" title="All 2 branches missed.">            if (!foundUnit) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                if (!weights.contains(sub.getWeightClass())) {</span>
<span class="nc" id="L691">                    sub.setWeightClass(weights.get(0));</span>
                }
<span class="nc" id="L693">                unit = sub.generate();</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">                if (unit == null) {</span>
<span class="nc" id="L695">                    sub.getMovementModes().clear();</span>
<span class="nc" id="L696">                    unit = sub.generate();</span>
                }
<span class="nc bnc" id="L698" title="All 2 branches missed.">                if (unit != null) {</span>
<span class="nc" id="L699">                    sub.setUnit(unit);</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">                    if (useWeights) {</span>
<span class="nc" id="L701">                        weights.remove(sub.getWeightClass());</span>
                    }
                }
            }
<span class="nc bnc" id="L705" title="All 4 branches missed.">            if (ut == null || ut == UnitType.MEK) {</span>
<span class="nc" id="L706">                baseModel = null;</span>
            }
<span class="nc" id="L708">        }</span>
<span class="nc" id="L709">    }</span>

    /**
     * Assigns a specific model to this node of the force tree. If this is a leaf node it will be flagged
     * as an element. If it has child nodes, they will all be made up of the same model unless changed by
     * a rule at a lower level of organization.
     *
     * @param unit The unit to assign to this node.
     */
    public void setUnit(ModelRecord unit) {
<span class="nc" id="L719">        chassis.clear();</span>
<span class="nc" id="L720">        variants.clear();</span>
<span class="nc" id="L721">        models.clear();</span>
<span class="nc" id="L722">        models.add(unit.getKey());</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (useWeightClass()) {</span>
<span class="nc" id="L724">            weightClass = unit.getWeightClass();</span>
        }
<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (subforces.isEmpty()) {</span>
<span class="nc" id="L727">            element = true;</span>
<span class="nc" id="L728">            movementModes.clear();</span>
<span class="nc" id="L729">            movementModes.add(unit.getMovementMode());</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">            if (null == unitType) {</span>
<span class="nc" id="L731">                unitType = unit.getUnitType();</span>
            }
<span class="nc bnc" id="L733" title="All 4 branches missed.">            if (((unitType == UnitType.MEK) || (unitType == UnitType.AERO)</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">                    || (unitType == UnitType.TANK))</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                    &amp;&amp; unit.isOmni()) {</span>
<span class="nc" id="L736">                flags.add(&quot;omni&quot;);</span>
            }
<span class="nc bnc" id="L738" title="All 2 branches missed.">            if (unit.getRoles().contains(MissionRole.ARTILLERY)) {</span>
<span class="nc" id="L739">                roles.add(MissionRole.ARTILLERY);</span>
            }
<span class="nc bnc" id="L741" title="All 2 branches missed.">            if (unit.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</span>
<span class="nc" id="L742">                roles.add(MissionRole.MISSILE_ARTILLERY);</span>
            }
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (unit.getRoles().contains(MissionRole.ANTI_MEK)) {</span>
<span class="nc" id="L745">                roles.add(MissionRole.ANTI_MEK);</span>
            }
<span class="nc bnc" id="L747" title="All 2 branches missed.">            if (unit.getRoles().contains(MissionRole.FIELD_GUN)) {</span>
<span class="nc" id="L748">                roles.add(MissionRole.FIELD_GUN);</span>
            }
        }
<span class="nc" id="L751">    }</span>

    public void generate(String level) {
<span class="nc" id="L754">        ModelRecord mRec = generate();</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">        if (mRec != null) {</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">            if (level.equals(&quot;chassis&quot;)) {</span>
<span class="nc" id="L757">                getChassis().add(mRec.getChassis());</span>
            } else {
<span class="nc" id="L759">                getModels().add(mRec.getKey());</span>
            }
        }
<span class="nc" id="L762">    }</span>

    public ModelRecord generate() {
        /* If the criteria cannot be matched, first try the next closest weight class,
         * then ignore mission role, then the next weight class, then ignore motive types,
         * then remaining weight classes.
         */
<span class="nc" id="L769">        final int[][] altWeights = {</span>
                {1, 2, 3, 4, 5}, //UL
                {2, 0, 3, 4, 5}, //L
                {3, 1, 4, 0, 5}, //M
                {2, 4, 1, 5, 0}, //H
                {3, 2, 5, 1, 0}, //A
                {4, 3, 2, 1, 0}  //SH
        };
        /* Work with a copy */
<span class="nc" id="L778">        ForceDescriptor fd = createChild(index);</span>
<span class="nc" id="L779">        fd.setEschelon(eschelon);</span>
<span class="nc" id="L780">        fd.setCoRank(coRank);</span>
<span class="nc" id="L781">        fd.getRoles().clear();</span>
<span class="nc" id="L782">        fd.getRoles().addAll(roles.stream().filter(r -&gt; r.fitsUnitType(unitType)).collect(Collectors.toList()));</span>

<span class="nc bnc" id="L784" title="All 6 branches missed.">        int wtIndex = (useWeightClass() &amp;&amp; weightClass != null &amp;&amp; weightClass != -1)?0:4;</span>

<span class="nc bnc" id="L786" title="All 2 branches missed.">        while (wtIndex &lt; 5) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">            for (int roleStrictness = 3; roleStrictness &gt;= 0; roleStrictness--) {</span>
<span class="nc" id="L788">                List&lt;Integer&gt; wcs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L789" title="All 6 branches missed.">                if (useWeightClass() &amp;&amp; null != fd.getWeightClass() &amp;&amp; fd.getWeightClass() &gt;= 0) {</span>
<span class="nc" id="L790">                    wcs.add(fd.getWeightClass());</span>
                }
<span class="nc" id="L792">                String ratGenRating = ratGeneratorRating();</span>
<span class="nc" id="L793">                UnitTable table = UnitTable.findTable(fd.getFactionRec(), fd.getUnitType(),</span>
<span class="nc" id="L794">                        fd.getYear(), ratGenRating, wcs, ModelRecord.NETWORK_NONE,</span>
<span class="nc" id="L795">                        fd.getMovementModes(), fd.getRoles(), roleStrictness);</span>
<span class="nc" id="L796">                MechSummary ms = null;</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                if (!fd.getModels().isEmpty()) {</span>
<span class="nc" id="L798">                    ms = table.generateUnit(u -&gt; fd.getModels().contains(u.getName()));</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">                } else if (!fd.getChassis().isEmpty()) {</span>
<span class="nc" id="L800">                    ms = table.generateUnit(u -&gt; fd.getChassis().contains(u.getChassis()));</span>
                } else {
<span class="nc" id="L802">                    ms = table.generateUnit();</span>
                }
<span class="nc bnc" id="L804" title="All 4 branches missed.">                if (ms != null &amp;&amp; RATGenerator.getInstance().getModelRecord(ms.getName()) != null) {</span>
<span class="nc" id="L805">                    return RATGenerator.getInstance().getModelRecord(ms.getName());</span>
                }

<span class="nc bnc" id="L808" title="All 6 branches missed.">                if ((!useWeightClass() || wtIndex == 2) &amp;&amp; fd.getRoles().size() &gt; 0) {</span>
<span class="nc" id="L809">                    fd.getRoles().clear();</span>
<span class="nc bnc" id="L810" title="All 4 branches missed.">                } else if ((!useWeightClass() || wtIndex == 1)</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">                        &amp;&amp; fd.getMovementModes().size() &gt; 0) {</span>
<span class="nc" id="L812">                    fd.getMovementModes().clear();</span>
                } else {
<span class="nc bnc" id="L814" title="All 10 branches missed.">                    if (useWeightClass() &amp;&amp; null != weightClass &amp;&amp; weightClass != -1 &amp;&amp; weightClass &lt; altWeights.length &amp;&amp; wtIndex &lt; altWeights[weightClass].length) {</span>
<span class="nc" id="L815">                        fd.setWeightClass(altWeights[weightClass][wtIndex]);</span>
                    }
<span class="nc" id="L817">                    wtIndex++;</span>
                }
            }
        };

<span class="nc" id="L822">        MegaMek.getLogger().debug(&quot;Could not find unit for &quot; + UnitType.getTypeDisplayableName(unitType));</span>
<span class="nc" id="L823">        return null;</span>
    }

    public void loadEntities(Ruleset.ProgressListener l, double progress) {
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (element) {</span>
<span class="nc" id="L828">            MechSummary ms = MechSummaryCache.getInstance().getMech(getModelName());</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">            if (ms != null) {</span>
                try {
<span class="nc" id="L831">                    entity = new MechFileParser(ms.getSourceFile(), ms.getEntryName()).getEntity();</span>
<span class="nc" id="L832">                    entity.setCrew(getCo().createCrew(entity.defaultCrewType()));</span>
<span class="nc" id="L833">                    entity.setExternalIdAsString(UUID.randomUUID().toString());</span>
<span class="nc" id="L834">                } catch (EntityLoadingException ex) {</span>
<span class="nc" id="L835">                    MegaMek.getLogger().error(&quot;Error loading &quot; + ms.getName() + &quot; from file &quot; + ms.getSourceFile().getPath(), ex);</span>
<span class="nc" id="L836">                }</span>
            }
        }
<span class="nc" id="L839">        int count = subforces.size() + attached.size();</span>
<span class="nc" id="L840">        subforces.forEach(fd -&gt; fd.loadEntities(l, progress / count));</span>
<span class="nc" id="L841">        attached.forEach(fd -&gt; fd.loadEntities(l, progress / count));</span>
<span class="nc bnc" id="L842" title="All 4 branches missed.">        if (count == 0 &amp;&amp; null != l) {</span>
<span class="nc" id="L843">            l.updateProgress(progress, &quot;Loading entities&quot;);</span>
        }
<span class="nc" id="L845">    }</span>

    public void assignCommanders() {
<span class="nc" id="L848">        subforces.forEach(ForceDescriptor::assignCommanders);</span>

<span class="nc" id="L850">        Ruleset rules = Ruleset.findRuleset(this);</span>
<span class="nc" id="L851">        CommanderNode coNode = null;</span>
<span class="nc" id="L852">        CommanderNode xoNode = null;</span>

<span class="nc bnc" id="L854" title="All 4 branches missed.">        while (coNode == null &amp;&amp; rules != null) {</span>
<span class="nc" id="L855">            coNode = rules.getCoNode(this);</span>
<span class="nc" id="L856">            xoNode = rules.getXoNode(this);</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">            if (coNode == null) {</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                if (rules.getParent() == null) {</span>
<span class="nc" id="L859">                    setCo(new CrewDescriptor(this));</span>
<span class="nc" id="L860">                    return;</span>
                }
<span class="nc" id="L862">                rules = Ruleset.findRuleset(rules.getParent());</span>
            }
        }
        //If none is found, assign crew without assigning rank or title.
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if (coNode == null) {</span>
<span class="nc" id="L867">            setCo(new CrewDescriptor(this));</span>
<span class="nc" id="L868">            return;</span>
        }

<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (subforces.size() &gt; 0) {</span>
<span class="nc" id="L872">            int coPos = 0;</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">            if (coNode != null) {</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">                coPos = (coNode.getPosition() == null)?1:</span>
<span class="nc" id="L875">                    Math.min(coNode.getPosition(), 1);</span>
            }
<span class="nc" id="L877">            int xoPos = 0;</span>
<span class="nc bnc" id="L878" title="All 6 branches missed.">            if (xoNode != null &amp;&amp; (xoNode.getPosition() == null || xoNode.getPosition() &gt; 0)) {</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">                xoPos = (xoNode.getPosition() == null)?coPos + 1:</span>
<span class="nc" id="L880">                    Math.max(coPos, xoNode.getPosition());</span>
            }
<span class="nc bnc" id="L882" title="All 2 branches missed.">            if (coPos + xoPos &gt; 0) {</span>
<span class="nc" id="L883">                ForceDescriptor [] forces = subforces.toArray(new ForceDescriptor[subforces.size()]);</span>
<span class="nc" id="L884">                Arrays.sort(forces, forceSorter);</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">                if (coPos != 0) {</span>
<span class="nc" id="L886">                    ForceDescriptor coFound = null;</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">                    if (coNode.getUnitType() != null) {</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">                        for (ForceDescriptor fd : forces) {</span>
<span class="nc bnc" id="L889" title="All 4 branches missed.">                            if (fd.getUnitType() != null &amp;&amp; fd.getUnitTypeName().equals(coNode.getUnitType())) {</span>
<span class="nc" id="L890">                                coFound = fd;</span>
                            }
                        }
                    }
<span class="nc bnc" id="L894" title="All 2 branches missed.">                    if (coFound == null) {</span>
<span class="nc" id="L895">                        coFound = forces[0];</span>
                    }
<span class="nc" id="L897">                    setCo(coFound.getCo());</span>
<span class="nc" id="L898">                    subforces.remove(coFound);</span>
<span class="nc" id="L899">                    subforces.add(0, coFound);</span>
                }
<span class="nc bnc" id="L901" title="All 2 branches missed.">                if (xoPos != 0) {</span>
                    /* If the XO is a field officer, the position is assigned to the first subforce that doesn't contain the CO
                     * (which is the first if the CO is not a field officer). If the CO and XO positions are the same, the
                     * XO is assigned to the same subforce as the CO, but the second subforce of that one.
                     */
<span class="nc" id="L906">                    ForceDescriptor xoFound = null;</span>
<span class="nc" id="L907">                    ArrayList&lt;ForceDescriptor&gt; subforces = this.subforces;</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                    if (coPos == xoPos) {</span>
<span class="nc" id="L909">                        subforces = this.subforces.get(0).getSubforces();</span>
                    }
<span class="nc bnc" id="L911" title="All 2 branches missed.">                    if (subforces.size() &gt; coPos) {</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">                        if (xoNode.getUnitType() != null) {</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">                            for (int i = coPos; i &lt; subforces.size(); i++) {</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">                                if (subforces.get(i).getUnitType() != null &amp;&amp;</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">                                        (xoNode.getUnitType().equals(subforces.get(i).getUnitTypeName())</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">                                                || (xoNode.getUnitType().equals(&quot;other&quot;)</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">                                                        &amp;&amp; !subforces.get(i).getUnitType().equals(co.getAssignment().getUnitType())))) {</span>
<span class="nc" id="L918">                                    xoFound = subforces.get(i);</span>
<span class="nc" id="L919">                                    break;</span>
                                }
                            }
                        }
<span class="nc bnc" id="L923" title="All 2 branches missed.">                        if (xoFound == null) {</span>
<span class="nc" id="L924">                            xoFound = subforces.get(1);</span>
                        }
                    }

<span class="nc bnc" id="L928" title="All 2 branches missed.">                    if (xoFound != null) {</span>
<span class="nc" id="L929">                        setXo(xoFound.getCo());</span>
<span class="nc" id="L930">                        getXo().setRank(xoNode.getRank());</span>
                    }
                }
            }
        }

<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (getCo() == null) {</span>
<span class="nc" id="L937">            setCo(new CrewDescriptor(this));</span>
        }
<span class="nc" id="L939">        getCo().setRank(coNode.getRank());</span>
<span class="nc" id="L940">        getCo().setTitle(coNode.getTitle());</span>

<span class="nc bnc" id="L942" title="All 2 branches missed.">        if (xoNode != null) {</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">            if (getXo() == null) {</span>
<span class="nc" id="L944">                setXo(new CrewDescriptor(this));</span>
            }
<span class="nc" id="L946">            getXo().setRank(xoNode.getRank());</span>
<span class="nc" id="L947">            getXo().setTitle(xoNode.getTitle());</span>
        }
<span class="nc bnc" id="L949" title="All 2 branches missed.">        if (!element) {</span>
<span class="nc" id="L950">            movementModes.clear();</span>
<span class="nc" id="L951">            boolean isOmni = true;</span>
<span class="nc" id="L952">            boolean isArtillery = true;</span>
<span class="nc" id="L953">            boolean isMissileArtillery = true;</span>
<span class="nc" id="L954">            boolean isFieldGun = true;</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">            for (ForceDescriptor fd : subforces) {</span>
<span class="nc" id="L956">                movementModes.addAll(fd.getMovementModes());</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                if ((fd.getUnitType() == null ||</span>
<span class="nc bnc" id="L958" title="All 4 branches missed.">                        !((UnitType.MEK == fd.getUnitType()) || (UnitType.AERO == fd.getUnitType())</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">                                || (UnitType.TANK == fd.getUnitType()))) ||</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">                        !fd.getFlags().contains(&quot;omni&quot;)) {</span>
<span class="nc" id="L961">                    isOmni = false;</span>
                }
<span class="nc bnc" id="L963" title="All 2 branches missed.">                if (!fd.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</span>
<span class="nc" id="L964">                    isMissileArtillery = false;</span>
                }
<span class="nc bnc" id="L966" title="All 2 branches missed.">                if (!fd.getRoles().contains(MissionRole.ARTILLERY)</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">                        &amp;&amp; !fd.getRoles().contains(MissionRole.MISSILE_ARTILLERY)) {</span>
<span class="nc" id="L968">                    isArtillery = false;</span>
                }
<span class="nc bnc" id="L970" title="All 2 branches missed.">                if (!fd.getRoles().contains(MissionRole.FIELD_GUN)) {</span>
<span class="nc" id="L971">                    isFieldGun = false;</span>
                }
<span class="nc" id="L973">            }</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">            if (isOmni) {</span>
<span class="nc" id="L975">                flags.add(&quot;omni&quot;);</span>
            }
<span class="nc bnc" id="L977" title="All 2 branches missed.">            if (isArtillery) {</span>
<span class="nc" id="L978">                roles.add(MissionRole.ARTILLERY);</span>
            }
<span class="nc bnc" id="L980" title="All 2 branches missed.">            if (isMissileArtillery) {</span>
<span class="nc" id="L981">                roles.add(MissionRole.MISSILE_ARTILLERY);</span>
            }
<span class="nc bnc" id="L983" title="All 2 branches missed.">            if (isFieldGun) {</span>
<span class="nc" id="L984">                roles.add(MissionRole.FIELD_GUN);</span>
            }

<span class="nc" id="L987">            float wt = 0;</span>
<span class="nc" id="L988">            int c = 0;</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">            for (ForceDescriptor sub : subforces) {</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">                if (sub.useWeightClass()) {</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">                    if (sub.getWeightClass() == null) {</span>
<span class="nc" id="L992">                        MegaMek.getLogger().error(&quot;Weight class == null for &quot; </span>
<span class="nc" id="L993">                                + sub.getUnitType() + &quot; with &quot; + sub.getSubforces().size() + &quot; subforces.&quot;);</span>
                    } else {
<span class="nc" id="L995">                        wt += sub.getWeightClass();</span>
<span class="nc" id="L996">                        c++;</span>
                    }
                }
<span class="nc" id="L999">            }</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (c &gt; 0) {</span>
<span class="nc" id="L1001">                weightClass = (int)(wt / c + 0.5);</span>
            }
        }

<span class="nc" id="L1005">        attached.forEach(ForceDescriptor::assignCommanders);</span>

        //		setIcon();
<span class="nc" id="L1008">    }</span>

    public void assignPositions() {
<span class="nc" id="L1011">        int index = 0;</span>
<span class="nc" id="L1012">        HashMap&lt;String,Integer&gt; uniqueCount = new HashMap&lt;String,Integer&gt;();</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">        for (int i = 0; i &lt; subforces.size(); i++) {</span>
<span class="nc" id="L1014">            subforces.get(i).positionIndex = i + 1;</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">            if (subforces.get(i).name == null) {</span>
<span class="nc" id="L1016">                continue;</span>
            }
<span class="nc bnc" id="L1018" title="All 2 branches missed.">            if (subforces.get(i).name.contains(&quot;:distinct}&quot;)) {</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">                if (uniqueCount.containsKey(subforces.get(i).name)) {</span>
<span class="nc" id="L1020">                    uniqueCount.put(subforces.get(i).name, uniqueCount.get(subforces.get(i).name) + 1);</span>
                } else {
<span class="nc" id="L1022">                    uniqueCount.put(subforces.get(i).name, 1);</span>
                }
<span class="nc bnc" id="L1024" title="All 2 branches missed.">            } else if (subforces.get(i).name.matches(&quot;.*\\{[^:]*\\}.*&quot;)) {</span>
<span class="nc" id="L1025">                subforces.get(i).nameIndex = index++;</span>
            }
        }
<span class="nc" id="L1028">        HashMap&lt;String,Integer&gt; indexCount = new HashMap&lt;String,Integer&gt;();</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        for (ForceDescriptor sub : subforces) {</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (uniqueCount.containsKey(sub.name)) {</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">                if (uniqueCount.get(sub.name) &gt; 1) {</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">                    if (indexCount.containsKey(sub.name)) {</span>
<span class="nc" id="L1033">                        indexCount.put(sub.name, indexCount.get(sub.name) + 1);</span>
                    } else {
<span class="nc" id="L1035">                        indexCount.put(sub.name, 1);</span>
                    }
<span class="nc" id="L1037">                    sub.nameIndex = indexCount.get(sub.name) - 1;</span>
                } else {
<span class="nc" id="L1039">                    sub.nameIndex = -1;</span>
                }
<span class="nc" id="L1041">                sub.name = sub.name.replace(&quot;:distinct&quot;, &quot;&quot;);</span>
            }
<span class="nc" id="L1043">            sub.assignPositions();</span>
<span class="nc" id="L1044">        }</span>
<span class="nc" id="L1045">        attached.forEach(ForceDescriptor::assignPositions);</span>
<span class="nc" id="L1046">    }</span>

<span class="nc" id="L1048">    private Comparator&lt;? super ForceDescriptor&gt; forceSorter = new Comparator&lt;ForceDescriptor&gt;() {</span>
        /* Rank by difference in experience + difference in unit/eschelon weights */
        private int rank(ForceDescriptor fd) {
<span class="nc" id="L1051">            int retVal = 0;</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">            if (fd.getWeightClass() != null) {</span>
<span class="nc" id="L1053">                retVal += fd.getWeightClass();</span>
            }
<span class="nc bnc" id="L1055" title="All 2 branches missed.">            if (fd.getUnitType() != null) {</span>
<span class="nc bnc" id="L1056" title="All 3 branches missed.">                switch (fd.getUnitType()) {</span>
                    case UnitType.MEK:
<span class="nc" id="L1058">                        retVal += 2;</span>
<span class="nc" id="L1059">                        break;</span>
                    case UnitType.INFANTRY:
<span class="nc" id="L1061">                        retVal -= 2;</span>
                }
            }
<span class="nc bnc" id="L1064" title="All 2 branches missed.">            if (fd.getCo() != null) {</span>
<span class="nc" id="L1065">                retVal -= fd.getCo().getGunnery() + fd.getCo().getPiloting();</span>
<span class="nc" id="L1066">                ModelRecord mRec = RATGenerator.getInstance().getModelRecord(fd.getCo().getAssignment().getModelName());</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">                if (mRec != null) {</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">                    if (mRec.isSL()) {</span>
<span class="nc" id="L1069">                        retVal += 2;</span>
                    }
<span class="nc bnc" id="L1071" title="All 2 branches missed.">                    if (mRec.isClan()) {</span>
<span class="nc" id="L1072">                        retVal += 5;</span>
                    }
                }
            }
<span class="nc" id="L1076">            return retVal;</span>
        }

        @Override
        public int compare(ForceDescriptor arg0, ForceDescriptor arg1) {
<span class="nc bnc" id="L1081" title="All 4 branches missed.">            if (arg0.getRoles().contains(MissionRole.COMMAND) &amp;&amp; !arg1.getRoles().contains(MissionRole.COMMAND)) {</span>
<span class="nc" id="L1082">                return -1;</span>
            }
<span class="nc bnc" id="L1084" title="All 4 branches missed.">            if (!arg0.getRoles().contains(MissionRole.COMMAND) &amp;&amp; arg1.getRoles().contains(MissionRole.COMMAND)) {</span>
<span class="nc" id="L1085">                return 1;</span>
            }
<span class="nc bnc" id="L1087" title="All 2 branches missed.">            if (arg0.getRatingLevel() != arg1.getRatingLevel()) {</span>
<span class="nc" id="L1088">                return arg1.getRatingLevel() - arg0.getRatingLevel();</span>
            }
<span class="nc" id="L1090">            return rank(arg1) - rank(arg0);</span>
        }
    };

    /**
     * Calculates transport needs of the unit and generates enough dropships and jumpships to carry
     * the indicated portion of the unit.
     */
    public ForceDescriptor assignTransport() {
<span class="nc bnc" id="L1099" title="All 6 branches missed.">        if ((getDropshipPct() &lt;= 0) &amp;&amp; (getJumpshipPct() &lt;= 0) &amp;&amp; (getCargo() &lt;= 0)) {</span>
<span class="nc" id="L1100">            return null;</span>
        }
<span class="nc" id="L1102">        TransportCalculator tp = new TransportCalculator(this);</span>
<span class="nc" id="L1103">        List&lt;MechSummary&gt; dropships = tp.calcDropships(getDropshipPct());</span>
<span class="nc" id="L1104">        ForceDescriptor transports = createChild(subforces.size() + attached.size());</span>
<span class="nc" id="L1105">        transports.setUnitType(null);</span>
<span class="nc" id="L1106">        transports.setName(&quot;Transport&quot;);</span>
        // TODO: put this in the faction files
<span class="nc" id="L1108">        transports.setEschelon(3);</span>
<span class="nc" id="L1109">        transports.setCoRank(35);</span>

<span class="nc" id="L1111">        List&lt;MechSummary&gt; shipList = tp.calcJumpships(getJumpshipPct(), dropships.size());</span>
<span class="nc" id="L1112">        shipList.addAll(dropships);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        for (MechSummary ms : shipList) {</span>
<span class="nc" id="L1114">            ForceDescriptor sub = transports.createChild(transports.getSubforces().size());</span>
<span class="nc" id="L1115">            sub.setUnit(RATGenerator.getInstance().getModelRecord(ms.getName()));</span>
<span class="nc" id="L1116">            sub.setEschelon(1);</span>
<span class="nc" id="L1117">            sub.setCoRank(34);</span>
<span class="nc" id="L1118">            transports.addSubforce(sub);</span>
<span class="nc" id="L1119">        }</span>
<span class="nc" id="L1120">        transports.assignCommanders();</span>
<span class="nc" id="L1121">        transports.assignPositions();</span>

<span class="nc" id="L1123">        return transports;</span>
    }

    /*
	public void assignBloodnames() {
		assignBloodnames(getFactionRec());
	}

	public void assignBloodnames(FactionRecord fRec) {
		if (fRec != null &amp;&amp; fRec.isClan()) {
			for (ForceDescriptor fd : subforces) {
				fd.assignBloodnames();
			}
			for (ForceDescriptor fd : attached) {
				fd.assignBloodnames();
			}

			if (co != null &amp;&amp; (element || !(co.getAssignment() != null &amp;&amp; co.getAssignment().isElement()))) {
				co.assignBloodname();
			}
			if (xo != null &amp;&amp; !(xo.getAssignment() != null &amp;&amp; xo.getAssignment().isElement())) {
				xo.assignBloodname();
			}
		}
	}
     */

    public static int decodeWeightClass(String code) {
<span class="nc bnc" id="L1151" title="All 7 branches missed.">        switch (code) {</span>
<span class="nc" id="L1152">            case &quot;UL&quot;:return EntityWeightClass.WEIGHT_ULTRA_LIGHT;</span>
<span class="nc" id="L1153">            case &quot;L&quot;:return EntityWeightClass.WEIGHT_LIGHT;</span>
<span class="nc" id="L1154">            case &quot;M&quot;:return EntityWeightClass.WEIGHT_MEDIUM;</span>
<span class="nc" id="L1155">            case &quot;H&quot;:return EntityWeightClass.WEIGHT_HEAVY;</span>
<span class="nc" id="L1156">            case &quot;A&quot;:return EntityWeightClass.WEIGHT_ASSAULT;</span>
<span class="nc" id="L1157">            case &quot;SH&quot;:case &quot;C&quot;:return EntityWeightClass.WEIGHT_COLOSSAL;</span>
        }
<span class="nc" id="L1159">        return -1;</span>
    }

    public String getWeightClassCode() {
<span class="nc" id="L1163">        final String[] codes = {&quot;UL&quot;, &quot;L&quot;, &quot;M&quot;, &quot;H&quot;, &quot;A&quot;, &quot;SH&quot;};</span>
<span class="nc bnc" id="L1164" title="All 4 branches missed.">        if (weightClass == null || weightClass == -1) {</span>
<span class="nc" id="L1165">            return &quot;&quot;;</span>
        }
<span class="nc" id="L1167">        return codes[weightClass];</span>
    }
    // AeroSpace Units
    public static final int WEIGHT_SMALL_CRAFT = 6; // Only a single weight class for Small Craft
    public static final int WEIGHT_SMALL_DROP = 7;
    public static final int WEIGHT_MEDIUM_DROP = 8;
    public static final int WEIGHT_LARGE_DROP = 9;
    public static final int WEIGHT_SMALL_WAR = 10;
    public static final int WEIGHT_LARGE_WAR = 11;

    // Support Vehicles
    public static final int WEIGHT_SMALL_SUPPORT = 12;
    public static final int WEIGHT_MEDIUM_SUPPORT = 13;
    public static final int WEIGHT_LARGE_SUPPORT = 14;

    public boolean useWeightClass() {
<span class="nc" id="L1183">        return useWeightClass(unitType);</span>
    }

    private boolean useWeightClass(Integer ut) {
<span class="nc bnc" id="L1187" title="All 2 branches missed.">        return ut != null &amp;&amp;</span>
<span class="nc bnc" id="L1188" title="All 4 branches missed.">                !(roles.contains(MissionRole.ARTILLERY) || roles.contains(MissionRole.MISSILE_ARTILLERY)) &amp;&amp;</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                (ut == UnitType.MEK ||</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">                ut == UnitType.AERO ||</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">                ut == UnitType.TANK ||</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">                ut == UnitType.BATTLE_ARMOR);</span>
    }

    /**
     * Weight class can differ from the target once units are generated. Weight class is recalculated
     * based on actual units present and eschelon name is set.
     *
     * @return The weight class of this force node
     */
    public double recalcWeightClass() {
        double wc;
<span class="nc bnc" id="L1203" title="All 2 branches missed.">        if (subforces.size() &gt; 0) {</span>
<span class="nc" id="L1204">            wc = subforces.stream().mapToDouble(ForceDescriptor::recalcWeightClass)</span>
<span class="nc" id="L1205">                    .sum() / subforces.size();</span>
<span class="nc bnc" id="L1206" title="All 4 branches missed.">        } else if (null != weightClass &amp;&amp; weightClass &gt;= 0) {</span>
<span class="nc" id="L1207">            wc = weightClass;</span>
        } else {
<span class="nc" id="L1209">            wc = EntityWeightClass.WEIGHT_MEDIUM;</span>
        }
<span class="nc" id="L1211">        weightClass = (int)Math.round(wc);</span>

        //Some names require knowing the weight class first.
<span class="nc bnc" id="L1214" title="All 2 branches missed.">        if (null != nameNodes) {</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">            for (ValueNode n : nameNodes) {</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                if (n.matches(this)) {</span>
<span class="nc" id="L1217">                    setName(n.getContent());</span>
<span class="nc" id="L1218">                    break;</span>
                }
<span class="nc" id="L1220">            }</span>
        }
<span class="nc" id="L1222">        attached.forEach(ForceDescriptor::recalcWeightClass);</span>

<span class="nc" id="L1224">        return wc;</span>
    }

    public ArrayList&lt;Object&gt; getAllChildren() {
<span class="nc" id="L1228">        ArrayList&lt;Object&gt; retVal = new ArrayList&lt;Object&gt;();</span>
<span class="nc" id="L1229">        retVal.addAll(subforces);</span>
<span class="nc" id="L1230">        retVal.addAll(attached);</span>
<span class="nc" id="L1231">        return retVal;</span>
    }

    public int getIndex() {
<span class="nc" id="L1235">        return index;</span>
    }

    public void setIndex(int index) {
<span class="nc" id="L1239">        this.index = index;</span>
<span class="nc" id="L1240">    }</span>

    public String getName() {
<span class="nc" id="L1243">        return name;</span>
    }

    public String parseName() {
<span class="nc" id="L1247">        String retVal = name;</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">        if (name == null) {</span>
<span class="nc" id="L1249">            String eschName = Ruleset.findRuleset(this).getEschelonName(this);</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">            if (eschName == null) {</span>
<span class="nc" id="L1251">                return &quot;&quot;;</span>
            }
<span class="nc" id="L1253">            retVal = &quot;{ordinal} &quot; + eschName;</span>
        }
<span class="nc bnc" id="L1255" title="All 4 branches missed.">        if (getParent() != null &amp;&amp; getParent().getNameIndex() &gt;= 0) {</span>
<span class="nc" id="L1256">            retVal = retVal.replace(&quot;{ordinal:parent}&quot;, ORDINALS[getParent().getNameIndex()]);</span>
<span class="nc" id="L1257">            retVal = retVal.replace(&quot;{greek:parent}&quot;, GREEK[getParent().getNameIndex()]);</span>
<span class="nc" id="L1258">            retVal = retVal.replace(&quot;{phonetic:parent}&quot;, PHONETIC[getParent().getNameIndex()]);</span>
<span class="nc" id="L1259">            retVal = retVal.replace(&quot;{latin:parent}&quot;, LATIN[getParent().getNameIndex()]);</span>
<span class="nc" id="L1260">            retVal = retVal.replace(&quot;{roman:parent}&quot;, ROMAN[getParent().getNameIndex()]);</span>
<span class="nc" id="L1261">            retVal = retVal.replace(&quot;{cardinal:parent}&quot;, Integer.toString(getParent().getNameIndex() + 1));</span>
<span class="nc" id="L1262">            retVal = retVal.replace(&quot;{alpha:parent}&quot;, Character.toString((char)(getParent().getNameIndex() + 'A')));</span>
        }
<span class="nc bnc" id="L1264" title="All 4 branches missed.">        if (getParent() != null &amp;&amp; retVal.contains(&quot;{name:parent}&quot;)) {</span>
<span class="nc" id="L1265">            String parentName = getParent().getName().replaceAll(&quot;.*\\[&quot;, &quot;&quot;).replaceAll(&quot;\\].*&quot;, &quot;&quot;);</span>
<span class="nc" id="L1266">            retVal = retVal.replace(&quot;{name:parent}&quot;, parentName);</span>
        }
<span class="nc bnc" id="L1268" title="All 2 branches missed.">        if (nameIndex &lt; 0) {</span>
<span class="nc" id="L1269">            retVal = retVal.replaceAll(&quot;\\{.*?\\}\\s?&quot;, &quot;&quot;);</span>
        } else {
<span class="nc" id="L1271">            retVal = retVal.replace(&quot;{ordinal}&quot;, ORDINALS[getNameIndex()]);</span>
<span class="nc" id="L1272">            retVal = retVal.replace(&quot;{greek}&quot;, GREEK[getNameIndex()]);</span>
<span class="nc" id="L1273">            retVal = retVal.replace(&quot;{phonetic}&quot;, PHONETIC[getNameIndex()]);</span>
<span class="nc" id="L1274">            retVal = retVal.replace(&quot;{latin}&quot;, LATIN[getNameIndex()]);</span>
<span class="nc" id="L1275">            retVal = retVal.replace(&quot;{roman}&quot;, ROMAN[getNameIndex()]);</span>
<span class="nc" id="L1276">            retVal = retVal.replace(&quot;{cardinal}&quot;, Integer.toString(getNameIndex() + 1));</span>
<span class="nc" id="L1277">            retVal = retVal.replace(&quot;{alpha}&quot;, Character.toString((char)(getNameIndex() + 'A')));</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">            if (retVal.contains(&quot;{formation}&quot;)) {</span>
<span class="nc bnc" id="L1279" title="All 4 branches missed.">                if (null != formationType &amp;&amp; null != formationType.getCategory()) {</span>
<span class="nc" id="L1280">                    retVal = retVal.replace(&quot;{formation}&quot;, formationType.getCategory()</span>
<span class="nc" id="L1281">                            .replace(&quot;Striker/Cavalry&quot;, &quot;Striker&quot;).replaceAll(&quot; Squadron&quot;, &quot;&quot;));</span>
                } else {
<span class="nc" id="L1283">                    retVal = retVal.replace(&quot;{formation} &quot;, &quot;&quot;);</span>
                }
            }
        }
<span class="nc" id="L1287">        retVal = retVal.replaceAll(&quot;\\{.*?\\}&quot;, &quot;&quot;);</span>
<span class="nc" id="L1288">        retVal = retVal.replaceAll(&quot;[\\[\\]]&quot;, &quot;&quot;).replaceAll(&quot;\\s+&quot;, &quot; &quot;);</span>
<span class="nc" id="L1289">        return retVal.trim();</span>
    }

    public String getDescription() {
<span class="nc" id="L1293">        StringBuilder retVal = new StringBuilder();</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">        if (unitType != null) {</span>
            //			if (useWeightClass() &amp;&amp; weightClass != null &amp;&amp; weightClass &gt;= 0) {
<span class="nc bnc" id="L1296" title="All 4 branches missed.">            if (weightClass != null &amp;&amp; weightClass &gt;= 0) {</span>
<span class="nc" id="L1297">                retVal.append(EntityWeightClass.getClassName(weightClass)).append(&quot; &quot;);</span>
            }

<span class="nc bnc" id="L1300" title="All 4 branches missed.">            if (roles.contains(MissionRole.ARTILLERY) || roles.contains(MissionRole.MISSILE_ARTILLERY)) {</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">                retVal.append(getUnitTypeName().equals(&quot;Infantry&quot;)?&quot;Field&quot;:&quot;Mobile&quot;).append(&quot; &quot;);</span>
            } else {
<span class="nc" id="L1303">                retVal.append(UnitType.getTypeName(unitType)).append(&quot; &quot;);</span>
            }
        }

<span class="nc bnc" id="L1307" title="All 2 branches missed.">        if (roles.contains(MissionRole.RECON)) {</span>
<span class="nc" id="L1308">            retVal.append(&quot;Recon&quot;);</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        } else if (roles.contains(MissionRole.FIRE_SUPPORT)) {</span>
<span class="nc" id="L1310">            retVal.append(&quot;Fire Support&quot;);</span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">        } else if (roles.contains(MissionRole.ARTILLERY)) {</span>
<span class="nc" id="L1312">            retVal.append(&quot;Artillery&quot;);</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">        } else if (roles.contains(MissionRole.URBAN)) {</span>
<span class="nc" id="L1314">            retVal.append(&quot;Urban&quot;);</span>
        }
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        if (flags.contains(&quot;c3&quot;)) {</span>
<span class="nc" id="L1317">            retVal.append(&quot; (C3)&quot;);</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">        } else if (flags.contains(&quot;c3i&quot;)) {</span>
<span class="nc" id="L1319">            retVal.append(&quot; (C3I)&quot;);</span>
        }
<span class="nc" id="L1321">        Ruleset rules = Ruleset.findRuleset(this);</span>
<span class="nc" id="L1322">        String eschName = null;</span>

<span class="nc bnc" id="L1324" title="All 4 branches missed.">        while (eschName == null &amp;&amp; rules != null) {</span>
<span class="nc" id="L1325">            eschName = rules.getEschelonName(this);</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">            if (eschName == null) {</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">                if (rules.getParent() == null) {</span>
<span class="nc" id="L1328">                    rules = null;</span>
                } else {
<span class="nc" id="L1330">                    rules = Ruleset.findRuleset(rules.getParent());</span>
                }
            }
        }

<span class="nc bnc" id="L1335" title="All 2 branches missed.">        if (eschName != null) {</span>
<span class="nc" id="L1336">            retVal.append(&quot; &quot;).append(eschName);</span>
        }
<span class="nc bnc" id="L1338" title="All 2 branches missed.">        if (null != formationType) {</span>
<span class="nc" id="L1339">            retVal.append(&quot; (&quot;).append(formationType.getName()).append(&quot;)&quot;);</span>
        }
<span class="nc" id="L1341">        return retVal.toString();</span>
    }

    public void setName(String name) {
<span class="nc" id="L1345">        this.name = name;</span>
<span class="nc" id="L1346">    }</span>

    public String getFaction() {
<span class="nc" id="L1349">        return faction;</span>
    }

    public void setFaction(String faction) {
<span class="nc" id="L1353">        this.faction = faction;</span>
<span class="nc" id="L1354">    }</span>

    public FactionRecord getFactionRec() {
<span class="nc" id="L1357">        return RATGenerator.getInstance().getFaction(faction.split(&quot;,&quot;)[0]);</span>
    }

    public Integer getYear() {
<span class="nc" id="L1361">        return year;</span>
    }

    public void setYear(Integer year) {
<span class="nc" id="L1365">        this.year = year;</span>
<span class="nc" id="L1366">    }</span>

    public Integer getEschelon() {
<span class="nc" id="L1369">        return eschelon;</span>
    }

    public String getEschelonCode() {
<span class="nc" id="L1373">        String retVal = eschelon.toString();</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (augmented) {</span>
<span class="nc" id="L1375">            retVal += &quot;^&quot;;</span>
        }
<span class="nc" id="L1377">        return retVal;</span>
    }

    public void setEschelon(Integer eschelon) {
<span class="nc" id="L1381">        this.eschelon = eschelon;</span>
<span class="nc" id="L1382">    }</span>

    public int getSizeMod() {
<span class="nc" id="L1385">        return sizeMod;</span>
    }

    public void setSizeMod(int sizeMod) {
<span class="nc" id="L1389">        this.sizeMod = sizeMod;</span>
<span class="nc" id="L1390">    }</span>

    public boolean isAugmented() {
<span class="nc" id="L1393">        return augmented;</span>
    }

    public void setAugmented(boolean augmented) {
<span class="nc" id="L1397">        this.augmented = augmented;</span>
<span class="nc" id="L1398">    }</span>

    public Integer getWeightClass() {
<span class="nc" id="L1401">        return weightClass;</span>
    }

    public void setWeightClass(Integer weightClass) {
<span class="nc" id="L1405">        this.weightClass = weightClass;</span>
<span class="nc" id="L1406">    }</span>

    public Integer getUnitType() {
<span class="nc" id="L1409">        return unitType;</span>
    }

    public void setUnitType(Integer unitType) {
<span class="nc" id="L1413">        this.unitType = unitType;</span>
<span class="nc" id="L1414">    }</span>

    public String getUnitTypeName() {
<span class="nc bnc" id="L1417" title="All 2 branches missed.">        if (null != unitType) {</span>
<span class="nc" id="L1418">            return UnitType.getTypeDisplayableName(unitType);</span>
        }
<span class="nc" id="L1420">        return &quot;&quot;;</span>
    }

    public HashSet&lt;EntityMovementMode&gt; getMovementModes() {
<span class="nc" id="L1424">        return movementModes;</span>
    }

    public String getRating() {
<span class="nc" id="L1428">        return rating;</span>
    }

    public void setRating(String rating) {
<span class="nc" id="L1432">        this.rating = rating;</span>
<span class="nc" id="L1433">    }</span>

    /**
     * Translates between the rating codes used by the force generator and those used by the
     * RAT Generator. The force generator uses abbreviations to make the formation rules more
     * concise.
     *
     * @return The RATGenerator rating code corresponding to the same index as the force generator
     *         rating code.
     */
    public String ratGeneratorRating() {
<span class="nc" id="L1444">        FactionRecord fRec = getFactionRec();</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">        if ((null != fRec)</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">                &amp;&amp; !fRec.getRatingLevels().contains(rating)</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">                &amp;&amp; (getRatingLevel() &gt;= 0)</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">                &amp;&amp; !fRec.getRatingLevels().isEmpty()) {</span>
<span class="nc" id="L1449">            return fRec.getRatingLevels().get(Math.min(getRatingLevel(), fRec.getRatingLevels().size() - 1));</span>
        }
<span class="nc" id="L1451">        return rating;</span>
    }

    public int getRatingLevel() {
<span class="nc bnc" id="L1455" title="All 2 branches missed.">        if (rating != null) {</span>
<span class="nc" id="L1456">            Ruleset rs = Ruleset.findRuleset(this);</span>
<span class="nc bnc" id="L1457" title="All 2 branches missed.">            if (rs != null) {</span>
<span class="nc" id="L1458">                return rs.getRatingIndex(rating);</span>
            }
        }
<span class="nc" id="L1461">        return -1;</span>
    }

    public FormationType getFormation() {
<span class="nc" id="L1465">        return formationType;</span>
    }

    public void setFormationType(FormationType ft) {
<span class="nc" id="L1469">        formationType = ft;</span>
<span class="nc" id="L1470">    }</span>

    public String getGenerationRule() {
<span class="nc" id="L1473">        return generationRule;</span>
    }

    public void setGenerationRule(String rule) {
<span class="nc" id="L1477">        generationRule = rule;</span>
<span class="nc" id="L1478">    }</span>

    public Set&lt;MissionRole&gt; getRoles() {
<span class="nc" id="L1481">        return roles;</span>
    }

    public Set&lt;String&gt; getModels() {
<span class="nc" id="L1485">        return models;</span>
    }

    public String getModelName() {
<span class="nc bnc" id="L1489" title="All 2 branches missed.">        if (models.size() != 1) {</span>
<span class="nc" id="L1490">            return &quot;&quot;;</span>
        }
<span class="nc" id="L1492">        return models.iterator().next();</span>
    }

    public Set&lt;String&gt; getChassis() {
<span class="nc" id="L1496">        return chassis;</span>
    }

    public Set&lt;String&gt; getVariants() {
<span class="nc" id="L1500">        return variants;</span>
    }

    public Integer getExperience() {
<span class="nc" id="L1504">        return experience;</span>
    }

    public void setExperience(Integer experience) {
<span class="nc" id="L1508">        this.experience = experience;</span>
<span class="nc" id="L1509">    }</span>

    public Integer getCoRank() {
<span class="nc" id="L1512">        return coRank;</span>
    }

    public void setCoRank(Integer coRank) {
<span class="nc" id="L1516">        this.coRank = coRank;</span>
<span class="nc" id="L1517">    }</span>

    public Integer getRankSystem() {
<span class="nc" id="L1520">        return rankSystem;</span>
    }

    public void setRankSystem(Integer rankSystem) {
<span class="nc" id="L1524">        this.rankSystem = rankSystem;</span>
<span class="nc" id="L1525">    }</span>

    public CrewDescriptor getCo() {
<span class="nc" id="L1528">        return co;</span>
    }

    public void setCo(CrewDescriptor co) {
<span class="nc" id="L1532">        this.co = co;</span>
<span class="nc" id="L1533">    }</span>

    public CrewDescriptor getXo() {
<span class="nc" id="L1536">        return xo;</span>
    }

    public void setXo(CrewDescriptor xo) {
<span class="nc" id="L1540">        this.xo = xo;</span>
<span class="nc" id="L1541">    }</span>

    public String getCamo() {
<span class="nc" id="L1544">        return camo;</span>
    }

    public void setCamo(String camo) {
<span class="nc" id="L1548">        this.camo = camo;</span>
<span class="nc" id="L1549">    }</span>

    /**
     * Because some eschelon names depend on knowing the actual weight class, we save a copy
     * of the possibilities for this node and defer selection until after the final weight class
     * determination.
     *
     * @param nameNodes
     */
    public void setNameNodes(List&lt;ValueNode&gt; nameNodes) {
<span class="nc" id="L1559">        this.nameNodes = nameNodes;</span>
<span class="nc" id="L1560">    }</span>

    public ForceDescriptor getParent() {
<span class="nc" id="L1563">        return parent;</span>
    }

    public void setParent(ForceDescriptor parent) {
<span class="nc" id="L1567">        this.parent = parent;</span>
<span class="nc" id="L1568">    }</span>

    public boolean shouldGenerateAttachments() {
<span class="nc" id="L1571">        return generateAttachments;</span>
    }

    public void setAttachments(boolean attachments) {
<span class="nc" id="L1575">        generateAttachments = attachments;</span>
<span class="nc" id="L1576">    }</span>

    public ArrayList&lt;ForceDescriptor&gt; getSubforces() {
<span class="nc" id="L1579">        return subforces;</span>
    }

    public void setSubforces(ArrayList&lt;ForceDescriptor&gt; subforces) {
<span class="nc" id="L1583">        this.subforces = subforces;</span>
<span class="nc" id="L1584">    }</span>

    public void addSubforce(ForceDescriptor fd) {
<span class="nc" id="L1587">        subforces.add(fd);</span>
<span class="nc" id="L1588">        fd.setParent(this);</span>
<span class="nc" id="L1589">    }</span>

    public ArrayList&lt;ForceDescriptor&gt; getAttached() {
<span class="nc" id="L1592">        return attached;</span>
    }

    public void setAttached(ArrayList&lt;ForceDescriptor&gt; attached) {
<span class="nc" id="L1596">        this.attached = attached;</span>
<span class="nc" id="L1597">    }</span>

    public void addAttached(ForceDescriptor fd) {
<span class="nc" id="L1600">        attached.add(fd);</span>
<span class="nc" id="L1601">    }</span>

    public double getDropshipPct() {
<span class="nc" id="L1604">        return dropshipPct;</span>
    }

    public void setDropshipPct(double dropshipPct) {
<span class="nc" id="L1608">        this.dropshipPct = dropshipPct;</span>
<span class="nc" id="L1609">    }</span>

    public double getJumpshipPct() {
<span class="nc" id="L1612">        return jumpshipPct;</span>
    }

    public void setJumpshipPct(double jumpshipPct) {
<span class="nc" id="L1616">        this.jumpshipPct = jumpshipPct;</span>
<span class="nc" id="L1617">    }</span>

    public double getCargo() {
<span class="nc" id="L1620">        return cargo;</span>
    }

    public void setCargo(double cargo) {
<span class="nc" id="L1624">        this.cargo = cargo;</span>
<span class="nc" id="L1625">    }</span>

    public Set&lt;String&gt; getFlags() {
<span class="nc" id="L1628">        return flags;</span>
    }

    public boolean isTopLevel() {
<span class="nc" id="L1632">        return topLevel;</span>
    }

    public void setTopLevel(boolean topLevel) {
<span class="nc" id="L1636">        this.topLevel = topLevel;</span>
<span class="nc" id="L1637">    }</span>

    public boolean isElement() {
<span class="nc" id="L1640">        return element;</span>
    }

    public void setElement(boolean element) {
<span class="nc" id="L1644">        this.element = element;</span>
<span class="nc" id="L1645">    }</span>

    public int getPositionIndex() {
<span class="nc" id="L1648">        return positionIndex;</span>
    }

    public int getNameIndex() {
<span class="nc" id="L1652">        return nameIndex;</span>
    }

    public String getFluffName() {
<span class="nc" id="L1656">        return fluffName;</span>
    }

    public void setFluffName(String fluffName) {
<span class="nc" id="L1660">        this.fluffName = fluffName;</span>
<span class="nc" id="L1661">    }</span>

    public Entity getEntity() {
<span class="nc" id="L1664">        return entity;</span>
    }

    public void addAllEntities(List&lt;Entity&gt; list) {
<span class="nc bnc" id="L1668" title="All 2 branches missed.">        if (isElement()) {</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L1670">                list.add(entity);</span>
            }
        }
<span class="nc" id="L1673">        subforces.stream().forEach(sf -&gt; sf.addAllEntities(list));</span>
<span class="nc" id="L1674">        attached.stream().forEach(sf -&gt; sf.addAllEntities(list));</span>
<span class="nc" id="L1675">    }</span>

    public ForceDescriptor createChild(int index) {
<span class="nc" id="L1678">        ForceDescriptor retVal = new ForceDescriptor();</span>
<span class="nc" id="L1679">        retVal.index = index;</span>
<span class="nc" id="L1680">        retVal.name = null;</span>
<span class="nc" id="L1681">        retVal.faction = faction;</span>
<span class="nc" id="L1682">        retVal.year = year;</span>
<span class="nc" id="L1683">        retVal.weightClass = weightClass;</span>
<span class="nc" id="L1684">        retVal.unitType = unitType;</span>
<span class="nc" id="L1685">        retVal.movementModes.addAll(movementModes);</span>
<span class="nc" id="L1686">        retVal.roles.addAll(roles);</span>
<span class="nc" id="L1687">        retVal.roles.remove(MissionRole.COMMAND);</span>
<span class="nc" id="L1688">        retVal.models.addAll(models);</span>
<span class="nc" id="L1689">        retVal.chassis.addAll(chassis);</span>
<span class="nc" id="L1690">        retVal.variants.addAll(variants);</span>
<span class="nc" id="L1691">        retVal.augmented = augmented;</span>
<span class="nc" id="L1692">        retVal.rating = rating;</span>
<span class="nc" id="L1693">        retVal.experience = experience;</span>
<span class="nc" id="L1694">        retVal.camo = camo;</span>
<span class="nc" id="L1695">        retVal.flags.addAll(flags);</span>
<span class="nc" id="L1696">        retVal.topLevel = false;</span>
<span class="nc" id="L1697">        retVal.rankSystem = rankSystem;</span>
<span class="nc" id="L1698">        retVal.generateAttachments = generateAttachments;</span>

<span class="nc" id="L1700">        return retVal;</span>
    }

    /**
     * Intended for debugging output. Shows description of current eschelon and all subforces
     *
     * @param indent   Prefix for the current eschelon
     * @param logLevel The level to pass to the logging utility
     */
    public void show(String indent, LogLevel logLevel) {
<span class="nc" id="L1710">        final String[] eschelonNames = {</span>
                &quot;Element&quot;, &quot;Squad&quot;, &quot;(2)&quot;, &quot;Lance&quot;, &quot;Company&quot;, &quot;Battalion&quot;,
                &quot;Regiment&quot;, &quot;Brigade&quot;, &quot;Division&quot;, &quot;Corps&quot;, &quot;Army&quot;
        };
<span class="nc" id="L1714">        final String[] airEschelonNames = {</span>
                &quot;Element&quot;, &quot;(1)&quot;, &quot;(2)&quot;, &quot;Flight&quot;, &quot;Squadron&quot;, &quot;Group&quot;, &quot;Wing&quot;, &quot;Regiment&quot;
        };

<span class="nc" id="L1718">        MegaMek.getLogger().log(logLevel, indent + weightClass + &quot; &quot; + unitType + &quot; &quot;</span>
<span class="nc bnc" id="L1719" title="All 4 branches missed.">                        + (((unitType == UnitType.AERO) || (unitType == UnitType.CONV_FIGHTER)) ? airEschelonNames[eschelon] : eschelonNames[eschelon]), null);</span>
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        for (ForceDescriptor sub : subforces) {</span>
<span class="nc" id="L1721">            sub.show(indent + &quot;  &quot;, logLevel);</span>
<span class="nc" id="L1722">        }</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">        for (ForceDescriptor sub : attached) {</span>
<span class="nc" id="L1724">            sub.show(indent + &quot; +&quot;, logLevel);</span>
<span class="nc" id="L1725">        }</span>
<span class="nc" id="L1726">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>