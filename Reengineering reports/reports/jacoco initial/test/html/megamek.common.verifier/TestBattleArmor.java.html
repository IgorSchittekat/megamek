<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestBattleArmor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.verifier</a> &gt; <span class="el_source">TestBattleArmor.java</span></div><h1>TestBattleArmor.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

/*
 * Author: Jay Lawson (Taharqa)
 */

package megamek.common.verifier;

import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

import megamek.common.*;
import megamek.common.annotations.Nullable;
import megamek.common.util.StringUtil;
import megamek.common.weapons.infantry.InfantryWeapon;

public class TestBattleArmor extends TestEntity {

    /**
     * Keeps track of the number of free MP a Bipedal BA gets.
     */
<span class="nc" id="L36">    public static int BIPED_FREE_MP = 1;</span>

    /**
     * Keeps track of the number of free MP a Quad BA gets.
     */
<span class="nc" id="L41">    public static int QUAD_FREE_MP = 2;</span>
    
    /**
     * Base chassis weight by suit weight class for Inner Sphere suits
     */
<span class="nc" id="L46">    public static double CHASSIS_WEIGHT_IS[] = { 0.08, 0.1, 0.175, 0.3, 0.55 };</span>
    /**
     * Base chassis weight by suit weight class for Clan suits
     */
<span class="nc" id="L50">    public static double CHASSIS_WEIGHT_CLAN[] = { 0.13, 0.15, 0.25, 0.4, 0.7 };</span>
    /**
     * Weight for additional ground MP by suit weight class
     */
<span class="nc" id="L54">    public static double ADDITIONAL_GROUND_MP_WEIGHT[] = { 0.025, 0.03, 0.04, 0.08, 0.16 };</span>

    /**
     * BattleArmor can have a variable number of shots per slot of ammo, this
     * variable defines the maximum number of shots per slot they can have.
     */
<span class="nc" id="L60">    public static int NUM_SHOTS_PER_CRIT = 4;</span>

    /**
     * BA Tube Artillery gets to be special and has 8 shots per-crit and comes
     * in 2-shot clips.
     */
<span class="nc" id="L66">    public static int NUM_SHOTS_PER_CRIT_TA = 8;</span>

    /**
     * An enumeration that keeps track of the legal armors for BattleArmor. Each
     * entry consists of the type, which corresponds to the types defined in
     * &lt;code&gt;EquipmentType&lt;/code&gt;.
     *
     * @author arlith
     *
     */
<span class="nc" id="L76">    public static enum BAArmor {</span>
<span class="nc" id="L77">        STANDARD(EquipmentType.T_ARMOR_BA_STANDARD,0,false),</span>
<span class="nc" id="L78">        CLAN_STANDARD(EquipmentType.T_ARMOR_BA_STANDARD,0,true),</span>
<span class="nc" id="L79">        STANDARD_PROTOTYPE(EquipmentType.T_ARMOR_BA_STANDARD_PROTOTYPE,4,false),</span>
<span class="nc" id="L80">        STANDARD_ADVANCED(EquipmentType.T_ARMOR_BA_STANDARD_ADVANCED,5,false),</span>
<span class="nc" id="L81">        STEALTH_BASIC(EquipmentType.T_ARMOR_BA_STEALTH_BASIC,3,false),</span>
<span class="nc" id="L82">        CLAN_STEALTH_BASIC(EquipmentType.T_ARMOR_BA_STEALTH_BASIC,3,true),</span>
<span class="nc" id="L83">        STEALTH(EquipmentType.T_ARMOR_BA_STEALTH,4,false),</span>
<span class="nc" id="L84">        CLAN_STEALTH(EquipmentType.T_ARMOR_BA_STEALTH,4,true),</span>
<span class="nc" id="L85">        STEALTH_IMPROVED(EquipmentType.T_ARMOR_BA_STEALTH_IMP,5,false),</span>
<span class="nc" id="L86">        CLAN_STEALTH_IMPROVED(EquipmentType.T_ARMOR_BA_STEALTH_IMP,5,true),</span>
<span class="nc" id="L87">        STEALTH_PROTOTYPE(EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE,4,false),</span>
<span class="nc" id="L88">        FIRE_RESISTANT(EquipmentType.T_ARMOR_BA_FIRE_RESIST,5,false),</span>
<span class="nc" id="L89">        CLAN_FIRE_RESISTANT(EquipmentType.T_ARMOR_BA_FIRE_RESIST,5,true),</span>
<span class="nc" id="L90">        MIMETIC(EquipmentType.T_ARMOR_BA_MIMETIC,7,false),</span>
<span class="nc" id="L91">        CLAN_MIMETIC(EquipmentType.T_ARMOR_BA_MIMETIC,7,true),</span>
<span class="nc" id="L92">        REFLECTIVE(EquipmentType.T_ARMOR_BA_REFLECTIVE,7,false),</span>
<span class="nc" id="L93">        CLAN_REFLECTIVE(EquipmentType.T_ARMOR_BA_REFLECTIVE,7,true),</span>
<span class="nc" id="L94">        REACTIVE(EquipmentType.T_ARMOR_BA_REACTIVE,7,false),</span>
<span class="nc" id="L95">        CLAN_REACTIVE(EquipmentType.T_ARMOR_BA_REACTIVE,7,true);</span>

        /**
         * The type, corresponding to types defined in
         * &lt;code&gt;EquipmentType&lt;/code&gt;.
         */
        public int type;

        /**
         * The number of spaces occupied by the armor type.
         */
        public int space;

        /**
         * Denotes whether this armor is Clan or not.
         */
        public boolean isClan;

<span class="nc" id="L113">        BAArmor(int t, int s, boolean c) {</span>
<span class="nc" id="L114">            type = t;</span>
<span class="nc" id="L115">            space = s;</span>
<span class="nc" id="L116">            isClan = c;</span>
<span class="nc" id="L117">        }</span>

        public static int getNumBAArmors() {
<span class="nc" id="L120">            return values().length;</span>
        }

        /**
         * Given an armor type, return the &lt;code&gt;BAArmor&lt;/code&gt; instance that
         * represents that type.
         *
         * @param t
         *            The armor type.
         * @param c
         *            Whether this armor type is Clan or not.
         * @return The &lt;code&gt;BAArmor&lt;/code&gt; that correspondes to the given type
         *         or null if no match was found.
         */
        public static BAArmor getArmor(int t, boolean c) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">            for (BAArmor a : values()) {</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">                if ((a.type == t) &amp;&amp; (a.isClan == c)) {</span>
<span class="nc" id="L137">                    return a;</span>
                }
            }
<span class="nc" id="L140">            return null;</span>
        }
        
        /**
         * @return The &lt;code&gt;MiscType&lt;/code&gt; for this armor.
         */
        public EquipmentType getArmorEqType() {
<span class="nc" id="L147">            String name = EquipmentType.getArmorTypeName(type, isClan);</span>
<span class="nc" id="L148">            return EquipmentType.get(name);</span>
        }
    }

    /**
     * Filters all ba armor according to given tech constraints
     * 
     * @param techManager
     * @return A list of all armors that meet the tech constraints
     */
    public static List&lt;EquipmentType&gt; legalArmorsFor(ITechManager techManager) {
<span class="nc" id="L159">        List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        for (BAArmor armor : BAArmor.values()) {</span>
<span class="nc" id="L161">            final EquipmentType eq = armor.getArmorEqType();</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">            if ((null != eq) &amp;&amp; techManager.isLegal(eq)) {</span>
<span class="nc" id="L163">                retVal.add(eq);</span>
            }
        }
<span class="nc" id="L166">        return retVal;</span>
    }
    
    /**
     * An enumeration that keeps track of the legal manipulators for
     * BattleArmor.
     *
     * @author arlith
     *
     */
<span class="nc" id="L176">    public static enum BAManipulator {</span>
<span class="nc" id="L177">        NONE(BattleArmor.MANIPULATOR_NONE,false),</span>
<span class="nc" id="L178">        ARMORED_GLOVE(BattleArmor.MANIPULATOR_ARMORED_GLOVE,false),</span>
<span class="nc" id="L179">        BASIC(BattleArmor.MANIPULATOR_BASIC,false),</span>
<span class="nc" id="L180">        BASIC_MINE_CLEARANCE(BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE,true),</span>
<span class="nc" id="L181">        BATTLE(BattleArmor.MANIPULATOR_BATTLE,false),</span>
<span class="nc" id="L182">        BATTLE_MAGNET(BattleArmor.MANIPULATOR_BATTLE_MAGNET,true),</span>
<span class="nc" id="L183">        BATTLE_VIBRO(BattleArmor.MANIPULATOR_BATTLE_VIBRO,false),</span>
<span class="nc" id="L184">        CARGO_LIFTER(BattleArmor.MANIPULATOR_CARGO_LIFTER,true),</span>
<span class="nc" id="L185">        HEAVY_BATTLE(BattleArmor.MANIPULATOR_HEAVY_BATTLE,false),</span>
<span class="nc" id="L186">        HEAVY_BATTLE_MAGNET(BattleArmor.MANIPULATOR_HEAVY_BATTLE_MAGNET,true),</span>
<span class="nc" id="L187">        HEAVY_BATTLE_VIBRO(BattleArmor.MANIPULATOR_HEAVY_BATTLE_VIBRO,false),</span>
<span class="nc" id="L188">        SALVAGE_ARM(BattleArmor.MANIPULATOR_SALVAGE_ARM,false),</span>
<span class="nc" id="L189">        DRILL(BattleArmor.MANIPULATOR_INDUSTRIAL_DRILL,false);</span>

        /**
         * The type, corresponding to types defined in
         * &lt;code&gt;EquipmentType&lt;/code&gt;.
         */
        public int type;

        /**
         * The name of this manipulator
         */
        public String internalName;

        public String displayName;

        /**
         * Denotes whether this armor is Clan or not.
         */
        public boolean pairMounted;

<span class="nc" id="L209">        BAManipulator(int t, boolean p) {</span>
<span class="nc" id="L210">            type = t;</span>
<span class="nc" id="L211">            internalName = BattleArmor.MANIPULATOR_TYPE_STRINGS[t];</span>
<span class="nc" id="L212">            displayName = BattleArmor.MANIPULATOR_NAME_STRINGS[t];</span>
<span class="nc" id="L213">            pairMounted = p;</span>
<span class="nc" id="L214">        }</span>

        public static int getNumBAArmors() {
<span class="nc" id="L217">            return values().length;</span>
        }

        /**
         * Given an manipulator internal name, return the
         * &lt;code&gt;BAManipulator&lt;/code&gt; instance that represents that internal
         * name.
         *
         * @param name
         *            The internal name.
         * @return The &lt;code&gt;BAManipulator&lt;/code&gt; that correspondes to the given
         *         internal name or null if no match was found.
         */
        public static BAManipulator getManipulator(String name) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">            for (BAManipulator m : values()) {</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">                if (m.internalName.equals(name) || m.displayName.equals(name)) {</span>
<span class="nc" id="L233">                    return m;</span>
                }
            }
<span class="nc" id="L236">            return null;</span>
        }
    }

<span class="nc" id="L240">    public enum BAMotiveSystems {</span>
<span class="nc" id="L241">        BA_JUMP (EquipmentTypeLookup.BA_JUMP_JET, EntityMovementMode.INF_JUMP, new int[] { 25, 25, 50, 125, 250 }),</span>
<span class="nc" id="L242">        BA_VTOL (EquipmentTypeLookup.BA_VTOL, EntityMovementMode.VTOL, new int[] { 30, 40, 60 }),</span>
<span class="nc" id="L243">        BA_UMU (EquipmentTypeLookup.BA_UMU, EntityMovementMode.INF_UMU, new int[] { 45, 45, 85, 160, 250});</span>

        private final String internalName;
        private final EntityMovementMode mode;
        private final int[] weightsKg;
        
<span class="nc" id="L249">        BAMotiveSystems(String internalName, EntityMovementMode mode, int[] weights) {</span>
<span class="nc" id="L250">            this.internalName = internalName;</span>
<span class="nc" id="L251">            this.mode = mode;</span>
<span class="nc" id="L252">            this.weightsKg = weights;</span>
<span class="nc" id="L253">        }</span>
        
        public String getName() {
<span class="nc" id="L256">            return internalName;</span>
        }
        
        public EntityMovementMode getMovementMode() {
<span class="nc" id="L260">            return mode;</span>
        }

        public static List&lt;EquipmentType&gt; allSystems() {
<span class="nc" id="L264">            List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            for (BAMotiveSystems ms : values()) {</span>
<span class="nc" id="L266">                retVal.add(EquipmentType.get(ms.internalName));</span>
            }
<span class="nc" id="L268">            return retVal;</span>
        }
        
        public static EquipmentType getEquipment(EntityMovementMode mode) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">            for (BAMotiveSystems ms : values()) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (ms.getMovementMode() == mode) {</span>
<span class="nc" id="L274">                    return EquipmentType.get(ms.internalName);</span>
                }
            }
<span class="nc" id="L277">            return null;</span>
        }
        
        /**
         * @param weightClass The EntityWeightClass index for the suit
         * @return            The mass of the motive system per MP
         * @throws IndexOutOfBoundsException if the weight class is not in the range allowed by the suit 
         */
        public double getWeight(int weightClass) {
<span class="nc" id="L286">        	return weightsKg[weightClass] / 1000.0;</span>
        }

    }
    
    /**
     * Checks to see if the supplied &lt;code&gt;Mounted&lt;/code&gt; is valid to be mounted
     * in the given location on the supplied &lt;code&gt;BattleArmor&lt;/code&gt;.
     *
     * This method will check that there is available space in the given
     * location make sure that weapon mounting restrictions hold.
     *
     * @param ba
     * @param newMount
     * @param loc
     * @return
     */
    public static boolean isMountLegal(BattleArmor ba, Mounted newMount, int loc) {
<span class="nc" id="L304">        return isMountLegal(ba, newMount, loc, BattleArmor.LOC_SQUAD);</span>
    }

    /**
     * Checks to see if the supplied &lt;code&gt;Mounted&lt;/code&gt; is valid to be mounted
     * in the given location on the supplied &lt;code&gt;BattleArmor&lt;/code&gt; for the
     * specified suit in the squad.
     *
     * This method will check that there is available space in the given
     * location make sure that weapon mounting restrictions hold.
     *
     * @param ba
     * @param newMount
     * @param loc
     * @param trooper
     * @return
     */
    public static boolean isMountLegal(BattleArmor ba, Mounted newMount,
            int loc, int trooper) {
<span class="nc" id="L323">        int numUsedCrits = 0;</span>
<span class="nc" id="L324">        int numAntiMechWeapons = 0;</span>
<span class="nc" id="L325">        int numAntiPersonnelWeapons = 0;</span>
<span class="nc bnc" id="L326" title="All 6 branches missed.">        if ((ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD)</span>
                &amp;&amp; ((loc == BattleArmor.MOUNT_LOC_LARM) || (loc == BattleArmor.MOUNT_LOC_RARM))) {
<span class="nc" id="L328">            return false;</span>
        }
<span class="nc bnc" id="L330" title="All 4 branches missed.">        if ((loc == BattleArmor.MOUNT_LOC_TURRET) &amp;&amp; (ba.getTurretCapacity() == 0)) {</span>
<span class="nc" id="L331">            return false;</span>
        }
<span class="nc bnc" id="L333" title="All 2 branches missed.">        for (Mounted m : ba.getEquipment()) {</span>
            // Manipulators don't take up slots in BA
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)) {</span>
<span class="nc" id="L336">                continue;</span>
            }
            
            // AP weapons don't take up slots in BA (the AP Mount does)
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (m.getType().hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L341">                continue;</span>
            }
            
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (m.getBaMountLoc() == loc </span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                    &amp;&amp; (m.getLocation() == trooper </span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                        || m.getLocation() == BattleArmor.LOC_SQUAD)) {</span>
                
<span class="nc bnc" id="L348" title="All 2 branches missed.">                if ((m.getType() instanceof WeaponType) </span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                        &amp;&amp; !(m.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L350">                    numAntiMechWeapons++;</span>
                }
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_AP_MOUNT)) {</span>
<span class="nc" id="L353">                    numAntiPersonnelWeapons++;</span>
                }             
<span class="nc bnc" id="L355" title="All 2 branches missed.">                if (m.getType().isSpreadable()) {</span>
<span class="nc" id="L356">                    numUsedCrits++;</span>
                } else {
<span class="nc" id="L358">                    numUsedCrits += m.getCriticals();</span>
                }
            }
<span class="nc" id="L361">        }</span>
        
        // In the case of quads with turrets, we need to apply the total of body + turret to the limitation
<span class="nc bnc" id="L364" title="All 4 branches missed.">        if ((loc == BattleArmor.MOUNT_LOC_TURRET)</span>
                || ((loc == BattleArmor.MOUNT_LOC_BODY)
<span class="nc bnc" id="L366" title="All 2 branches missed.">                        &amp;&amp; (ba.getTurretCapacity() &gt; 0))) {</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            int otherLoc = (loc == BattleArmor.MOUNT_LOC_BODY)?</span>
<span class="nc" id="L368">                    BattleArmor.MOUNT_LOC_TURRET : BattleArmor.MOUNT_LOC_BODY;</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            for (Mounted m : ba.getEquipment()) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                if (m.getBaMountLoc() == otherLoc </span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                        &amp;&amp; (m.getLocation() == trooper </span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">                            || m.getLocation() == BattleArmor.LOC_SQUAD)) {</span>
                    
<span class="nc bnc" id="L374" title="All 2 branches missed.">                    if ((m.getType() instanceof WeaponType) </span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                            &amp;&amp; !(m.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L376">                        numAntiMechWeapons++;</span>
                    }
<span class="nc bnc" id="L378" title="All 2 branches missed.">                    if (m.getType().hasFlag(MiscType.F_AP_MOUNT)) {</span>
<span class="nc" id="L379">                        numAntiPersonnelWeapons++;</span>
                    }             
                }
<span class="nc" id="L382">            }</span>
        }

        // Do we have free space to mount this equipment?
        int newCrits;
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (newMount.getType().isSpreadable()) {</span>
<span class="nc" id="L388">            newCrits = 1;</span>
        } else {
<span class="nc" id="L390">            newCrits = newMount.getCriticals();</span>
        }
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if ((numUsedCrits + newCrits) &lt;= ba.getNumCrits(loc)) {</span>
            // Weapons require extra criticism
<span class="nc bnc" id="L394" title="All 2 branches missed.">            if (newMount.getType() instanceof WeaponType) {</span>
<span class="nc" id="L395">                if ((numAntiMechWeapons + 1) &lt;= </span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                        ba.getNumAllowedAntiMechWeapons(loc)) {</span>
<span class="nc" id="L397">                    return true;</span>
                } else {
<span class="nc" id="L399">                    return false;</span>
                }
<span class="nc bnc" id="L401" title="All 2 branches missed.">            } else if (newMount.getType().hasFlag(MiscType.F_AP_MOUNT)) {</span>
<span class="nc" id="L402">                if ((numAntiPersonnelWeapons + 1) &lt;= </span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                        ba.getNumAllowedAntiPersonnelWeapons(loc,trooper)) {</span>
<span class="nc" id="L404">                    return true;</span>
                } else {
<span class="nc" id="L406">                    return false;</span>
                }
            } else {
<span class="nc" id="L409">                return true;</span>
            }
        } else {
<span class="nc" id="L412">            return false;</span>
        }
    }
    
    public static int maxWalkMP(BattleArmor ba) {
<span class="nc" id="L417">        int max = 3;</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (ba.getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY) {</span>
<span class="nc" id="L419">            max--;</span>
        }
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L422">            max += 2;</span>
        }
<span class="nc" id="L424">        return max;</span>
    }
    
    public static int maxJumpMP(BattleArmor ba) {
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L429">            return 0;</span>
        } else {
<span class="nc" id="L431">            return maxWalkMP(ba);</span>
        }
    }
    
    public static int maxVtolMP(BattleArmor ba) {
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if ((ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD)</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                || (ba.getWeightClass() &gt; EntityWeightClass.WEIGHT_MEDIUM)) {</span>
<span class="nc" id="L438">            return 0;</span>
        } else {
<span class="nc" id="L440">            return 7 - ba.getWeightClass() + EntityWeightClass.WEIGHT_ULTRA_LIGHT;</span>
        }
    }
    
    public static int maxUmuMP(BattleArmor ba) {
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L446">            return 0;</span>
        } else {
<span class="nc" id="L448">            return Math.min(5, 5 - ba.getWeightClass() + EntityWeightClass.WEIGHT_LIGHT);</span>
        }
    }
    
    private BattleArmor ba;

    public TestBattleArmor(BattleArmor armor, TestEntityOption option,
            String fileString) {
<span class="nc" id="L456">        super(option, null, null, null);</span>
<span class="nc" id="L457">        ba = armor;</span>
<span class="nc" id="L458">        this.fileString = fileString;</span>
<span class="nc" id="L459">    }</span>

    @Override
    public Entity getEntity() {
<span class="nc" id="L463">        return ba;</span>
    }

    @Override
    public boolean isTank() {
<span class="nc" id="L468">        return false;</span>
    }

    @Override
    public boolean isMech() {
<span class="nc" id="L473">        return false;</span>
    }

    @Override
    public boolean isAero() {
<span class="nc" id="L478">        return false;</span>
    }
    
    @Override
    public boolean isSmallCraft() {
<span class="nc" id="L483">        return false;</span>
    }
    
    @Override
    public boolean isAdvancedAerospace() {
<span class="nc" id="L488">        return false;</span>
    }
    
    @Override
    public boolean isProtomech() {
<span class="nc" id="L493">        return false;</span>
    }

    @Override
    public double getWeightControls() {
<span class="nc" id="L498">        return 0;</span>
    }

    /**
     * @return The weight of the turret mount, or zero if there isn't one.
     */
    public double getWeightTurret() {
<span class="nc" id="L505">        int turret = ba.getTurretCapacity();</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (turret &gt; 0) {</span>
<span class="nc" id="L507">            double weight = turret * 0.01 + 0.03;</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">            if (ba.hasModularTurretMount()) {</span>
                // modular turret has the same base weight as a standard turret with one more slot,
                // plus another 10 kg for being modular
<span class="nc" id="L511">                weight += 0.02;</span>
            }
<span class="nc" id="L513">            return weight;</span>
        }
<span class="nc" id="L515">        return 0;</span>
    }

    @Override
    public double getWeightMisc() {
<span class="nc" id="L520">    	return getWeightTurret();</span>
    }

    @Override
    public double getWeightHeatSinks() {
<span class="nc" id="L525">        return 0;</span>
    }

    @Override
    public double getWeightEngine() {
<span class="nc" id="L530">        return 0;</span>
    }
    
    public double getWeightChassis() {
<span class="nc bnc" id="L534" title="All 2 branches missed.">    	if (ba.isClan()</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">    			&amp;&amp; !((ba.getWeightClass() &gt; EntityWeightClass.WEIGHT_ULTRA_LIGHT)</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">    					&amp;&amp; (ba.isClanExoWithoutHarjel()))) {</span>
<span class="nc" id="L537">    		return CHASSIS_WEIGHT_CLAN[ba.getWeightClass()];</span>
    	} else {
<span class="nc" id="L539">    		return CHASSIS_WEIGHT_IS[ba.getWeightClass()];</span>
    	}
    }
    
    public double getWeightGroundMP() {
<span class="nc" id="L544">        int walkMP = ba.getOriginalWalkMP();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L546">            walkMP -= QUAD_FREE_MP;</span>
        } else {
<span class="nc" id="L548">            walkMP -= BIPED_FREE_MP;</span>
        }
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (walkMP &gt; 0) {</span>
<span class="nc" id="L551">        	return ADDITIONAL_GROUND_MP_WEIGHT[ba.getWeightClass()] * walkMP;</span>
        } else {
<span class="nc" id="L553">        	return 0;</span>
        }
    }
    
    public double getWeightSecondaryMotiveSystem() {
<span class="nc" id="L558">    	int jumpMP = ba.getOriginalJumpMP();</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">    	if (ba.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L560">    		return jumpMP * BAMotiveSystems.BA_VTOL.getWeight(ba.getWeightClass());</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">    	} else if (ba.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc" id="L562">    		return jumpMP * BAMotiveSystems.BA_UMU.getWeight(ba.getWeightClass());</span>
    	} else {
<span class="nc" id="L564">    		return jumpMP * BAMotiveSystems.BA_JUMP.getWeight(ba.getWeightClass());</span>
    	}
    }

    @Override
    public double getWeightStructure() {
<span class="nc" id="L570">    	return getWeightChassis() + getWeightGroundMP() + getWeightSecondaryMotiveSystem();</span>
    }

    @Override
    public double getWeightArmor() {
<span class="nc" id="L575">        return ba.getOArmor(1)</span>
<span class="nc" id="L576">                * EquipmentType.getBaArmorWeightPerPoint(ba.getArmorType(1),</span>
<span class="nc" id="L577">                        TechConstants.isClan(ba.getArmorTechLevel(1)));</span>
    }

    @Override
    public boolean hasDoubleHeatSinks() {
<span class="nc" id="L582">        return false;</span>
    }

    @Override
    public int getCountHeatSinks() {
<span class="nc" id="L587">        return 0;</span>
    }

    @Override
    public double getWeight() {
<span class="nc" id="L592">        return ba.getTrooperWeight() * ba.getTroopers();</span>
    }

    @Override
    public String printWeightMisc() {
<span class="nc" id="L597">        return &quot;&quot;;</span>
    }

    @Override
    public String printWeightControls() {
<span class="nc" id="L602">        return &quot;&quot;;</span>
    }

    @Override
    public String printWeightStructure() {
<span class="nc" id="L607">        return StringUtil.makeLength(&quot;Structure: &quot;, getPrintSize() + 9)</span>
<span class="nc" id="L608">                + TestEntity.makeWeightString(getWeightStructure(), true) + &quot;\n&quot;;</span>
    }

    @Override
    public String printWeightArmor() {
<span class="nc" id="L613">        String armorName = EquipmentType.getArmorTypeName(ba</span>
<span class="nc" id="L614">                .getArmorType(BattleArmor.LOC_SQUAD), TechConstants.isClan(ba</span>
<span class="nc" id="L615">                .getArmorTechLevel(BattleArmor.LOC_SQUAD)));</span>

<span class="nc" id="L617">        return StringUtil.makeLength(</span>
<span class="nc" id="L618">                &quot;Armor: &quot; + Integer.toString(getTotalOArmor()) + &quot; &quot;</span>
<span class="nc" id="L619">                        + armorName, getPrintSize() - 5)</span>
<span class="nc" id="L620">                + TestEntity.makeWeightString(getWeightArmor(), true) + &quot;\n&quot;;</span>
    }

    @Override
    public String printArmorPlacement() {
<span class="nc" id="L625">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L626">        buff.append(&quot;Armor Placement:\n&quot;);</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">        for (int loc = 1; loc &lt; getEntity().locations(); loc++) {</span>
<span class="nc" id="L628">            buff.append(printArmorLocation(loc)).append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L630">        return buff.toString();</span>
    }

    @Override
    public String printArmorLocation(int loc) {
<span class="nc" id="L635">        return StringUtil</span>
<span class="nc" id="L636">                .makeLength(getEntity().getLocationAbbr(loc) + &quot;:&quot;, 10)</span>
<span class="nc" id="L637">                + StringUtil.makeLength(getEntity().getOInternal(loc), 4)</span>
<span class="nc" id="L638">                + StringUtil.makeLength(getEntity().getOArmor(loc), 6) + &quot;  &quot;;</span>
    }

    /**
     * Checks to see if this unit has valid armor assignment.
     *
     * @param buff
     * @return
     */
    public boolean correctArmor(StringBuffer buff) {
<span class="nc" id="L648">        boolean correct = true;</span>
<span class="nc" id="L649">        int maxArmorPoints = ba.getMaximumArmorPoints();</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">        for (int loc = 0; loc &lt; ba.locations(); loc++) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (ba.getOArmor(loc) &gt; maxArmorPoints) {</span>
<span class="nc" id="L652">                buff.append(printArmorLocation(loc))</span>
<span class="nc" id="L653">                        .append(printArmorLocProp(loc, maxArmorPoints))</span>
<span class="nc" id="L654">                        .append(&quot;\n&quot;);</span>
<span class="nc" id="L655">                correct = false;</span>
            }
        }
<span class="nc" id="L658">        return correct;</span>
    }

    public String printArmorLocProp(int loc, int wert) {
<span class="nc" id="L662">        return &quot; is greater than &quot; + Integer.toString(wert) + &quot;!&quot;;</span>
    }

    public boolean correctMovement(StringBuffer buff) {
<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (ba.getOriginalWalkMP() &gt; ba.getMaximumWalkMP()) {</span>
<span class="nc" id="L667">            buff.append(&quot;Walk MP is &quot; + ba.getOriginalWalkMP()</span>
<span class="nc" id="L668">                    + &quot; but maximum is &quot; + ba.getMaximumWalkMP() + &quot;!&quot;);</span>
<span class="nc" id="L669">            return false;</span>
        }

<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (ba.getOriginalJumpMP() &gt; ba.getMaximumJumpMP()) {</span>
<span class="nc" id="L673">            buff.append(&quot;Jump MP is &quot; + ba.getOriginalWalkMP()</span>
<span class="nc" id="L674">                    + &quot; but maximum is &quot; + ba.getMaximumWalkMP() + &quot;!&quot;);</span>
<span class="nc" id="L675">            return false;</span>
        }

<span class="nc bnc" id="L678" title="All 2 branches missed.">        if (ba.hasWorkingMisc(MiscType.F_JUMP_BOOSTER)</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                &amp;&amp; ((ba.getMovementMode() != EntityMovementMode.INF_JUMP) || (ba</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                        .getJumpMP() &lt; 1))) {</span>
<span class="nc" id="L681">            buff.append(&quot;BattleArmor with jump boosters &quot;</span>
                    + &quot;must have jump jets with a least 1MP!&quot;);
<span class="nc" id="L683">            return false;</span>
        }

<span class="nc bnc" id="L686" title="All 2 branches missed.">        if (ba.hasWorkingMisc(MiscType.F_PARTIAL_WING)</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                &amp;&amp; ((ba.getMovementMode() != EntityMovementMode.INF_JUMP) || (ba</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">                        .getJumpMP() &lt; 1))) {</span>
<span class="nc" id="L689">            buff.append(&quot;BattleArmor with a partial wing &quot;</span>
                    + &quot;must have jump jets with a least 1MP!&quot;);
<span class="nc" id="L691">            return false;</span>
        }

<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (ba.hasWorkingMisc(MiscType.F_JUMP_BOOSTER)</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                &amp;&amp; ba.hasWorkingMisc(MiscType.F_PARTIAL_WING)) {</span>
<span class="nc" id="L696">            buff.append(&quot;BattleArmor may not mount a jump booster &quot;</span>
                    + &quot;and a partial wing!&quot;);
<span class="nc" id="L698">            return false;</span>
        }

<span class="nc bnc" id="L701" title="All 2 branches missed.">        if (ba.hasWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER)</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">                &amp;&amp; ba.hasMyomerBooster()) {</span>
<span class="nc" id="L703">            buff.append(&quot;BattleArmor may not mount a mechanical jump booster &quot;</span>
                    + &quot;and a myomer booster!&quot;);
<span class="nc" id="L705">            return false;</span>
        }

<span class="nc bnc" id="L708" title="All 2 branches missed.">        if (ba.hasMyomerBooster()</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                &amp;&amp; (ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_MIMETIC)) {</span>
<span class="nc" id="L710">            buff.append(&quot;BattleArmor may not mount a myomer booster &quot;</span>
                    + &quot;and mimetic armor!&quot;);
<span class="nc" id="L712">            return false;</span>
        }

<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (ba.hasMyomerBooster()</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                &amp;&amp; ((ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH)</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                        || (ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH_BASIC)</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                        || (ba.getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH_IMP) || (ba</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                        .getArmorType(BattleArmor.LOC_SQUAD) == EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE))) {</span>
<span class="nc" id="L720">            buff.append(&quot;BattleArmor may not mount a myomer booster &quot;</span>
                    + &quot;and stealth armor!&quot;);
<span class="nc" id="L722">            return false;</span>
        }

<span class="nc bnc" id="L725" title="All 2 branches missed.">        if (ba.countWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER) &gt; 1) {</span>
<span class="nc" id="L726">            buff.append(&quot;BattleArmor may only mount 1 &quot;</span>
                    + &quot;mechanical jump booster!&quot;);
<span class="nc" id="L728">            return false;</span>
        }
<span class="nc" id="L730">        EquipmentType boosterType = EquipmentType.get(EquipmentTypeLookup.BA_MYOMER_BOOSTER);</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">        if (ba.countWorkingMisc(MiscType.F_MASC) &gt; boosterType.getCriticals(ba)) {</span>
<span class="nc" id="L732">            buff.append(&quot;BattleArmor may only mount 1 &quot; + &quot;myomer booster!&quot;);</span>
<span class="nc" id="L733">            return false;</span>
        }

<span class="nc" id="L736">        return true;</span>
    }

    public boolean correctCriticals(StringBuffer buff) {
<span class="nc" id="L740">        Vector&lt;Mounted&gt; unallocated = new Vector&lt;Mounted&gt;();</span>
<span class="nc" id="L741">        getUnallocatedEquipment(ba, unallocated);</span>
<span class="nc" id="L742">        boolean correct = true;</span>

<span class="nc bnc" id="L744" title="All 2 branches missed.">        if (!unallocated.isEmpty()) {</span>
<span class="nc" id="L745">            buff.append(&quot;Unallocated Equipment:\n&quot;);</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">            for (Mounted mount : unallocated) {</span>
<span class="nc" id="L747">                buff.append(mount.getType().getInternalName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L748">            }</span>
<span class="nc" id="L749">            correct = false;</span>
        }

<span class="nc" id="L752">        int critsUsed[][] = new int[ba.getTroopers() + 1]</span>
                [BattleArmor.MOUNT_NUM_LOCS];
<span class="nc" id="L754">        int numAPWeapons[][] = new int[ba.getTroopers() + 1]</span>
                [BattleArmor.MOUNT_NUM_LOCS];
<span class="nc" id="L756">        int numAMWeapons[][] = new int[ba.getTroopers() + 1]</span>
                [BattleArmor.MOUNT_NUM_LOCS];
<span class="nc" id="L758">        int numSSWMs = 0;</span>
<span class="nc" id="L759">        int numGloveMountedAPWeapons = 0;</span>
<span class="nc" id="L760">        Mounted squadSupportWeapon = null;</span>
        // Count used crits, AM/AP weaps for each squad member and location
<span class="nc bnc" id="L762" title="All 2 branches missed.">        for (Mounted m : ba.getEquipment()) {</span>
            // BA Tasers should be mounted individually
<span class="nc bnc" id="L764" title="All 2 branches missed.">            if (m.getType().hasFlag(WeaponType.F_TASER)</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">                    &amp;&amp; m.getLocation() == BattleArmor.LOC_SQUAD){</span>
<span class="nc" id="L766">                buff.append(&quot;BA Tasers should be mounted individually &quot; +</span>
                        &quot;instead of as a squad weapon!&quot;);
<span class="nc" id="L768">                return false;</span>
            }
            
            // BA NARC should be mounted individually
<span class="nc bnc" id="L772" title="All 2 branches missed.">            if ((m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">                    &amp;&amp; ((WeaponType)m.getType()).getAmmoType() </span>
                        == AmmoType.T_NARC
<span class="nc bnc" id="L775" title="All 2 branches missed.">                    &amp;&amp; m.getLocation() == BattleArmor.LOC_SQUAD){</span>
<span class="nc" id="L776">                buff.append(&quot;BA NARC should be mounted individually &quot; +</span>
                        &quot;instead of as a squad weapon!&quot;);
<span class="nc" id="L778">                return false;</span>
            }
            
            // Ignore unmounted equipment, we'll deal with that elsewhere
<span class="nc bnc" id="L782" title="All 2 branches missed.">            if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE) {</span>
<span class="nc" id="L783">                continue;</span>
            }

            int critSize;
<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (m.getType().isSpreadable()) {</span>
<span class="nc" id="L788">                critSize = 1;</span>
            } else {
<span class="nc" id="L790">                critSize = m.getCriticals();</span>
            }
            
            // Manipulators don't take up slots in BA
<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)) {</span>
<span class="nc" id="L795">                critSize = 0;</span>
            }

            // AP Weapons that are mounted in an AP Mount don't take up slots
<span class="nc bnc" id="L799" title="All 4 branches missed.">            if (m.isAPMMounted() &amp;&amp; (m.getLinkedBy() != null)</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">                    &amp;&amp; m.getLinkedBy().getType().hasFlag(MiscType.F_AP_MOUNT)) {</span>
<span class="nc" id="L801">                critSize = 0;</span>
            }
            
<span class="nc bnc" id="L804" title="All 2 branches missed.">            if ((m.getType() instanceof WeaponType) </span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">                    &amp;&amp; m.isSquadSupportWeapon()) {</span>
<span class="nc" id="L806">                numSSWMs++;</span>
<span class="nc" id="L807">                squadSupportWeapon = m;</span>
            }

            // Check for valid BA weapon
<span class="nc bnc" id="L811" title="All 2 branches missed.">            if ((m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                    &amp;&amp; !m.getType().hasFlag(WeaponType.F_BA_WEAPON)</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">                    &amp;&amp; !m.getType().hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L814">                buff.append(m.getName() + &quot; is not a BattleArmor weapon!\n&quot;);</span>
<span class="nc" id="L815">                correct = false;</span>
            }

            // Special considerations for AP weapons
<span class="nc bnc" id="L819" title="All 2 branches missed.">            if ((m.getType() instanceof WeaponType) </span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L821">                Mounted link = m.getLinkedBy();</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">                if (link == null) {</span>
<span class="nc" id="L823">                    correct = false;</span>
<span class="nc" id="L824">                    buff.append(m.getName() + &quot; is an infantry weapon but &quot; +</span>
                            &quot;has no mount point!\n&quot;);
<span class="nc" id="L826">                    continue;</span>
                }
                // No AP melee weapons
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (m.getType().hasFlag(WeaponType.F_INF_POINT_BLANK)) {</span>
<span class="nc" id="L830">                    buff.append(m.getName() + &quot; is a melee AP weapon and &quot; +</span>
                            &quot;BattleArmor cannot mount melee AP weapons!\n&quot;);
<span class="nc" id="L832">                    correct = false;   </span>
                }
                // Special considerations for AP mounts
<span class="nc bnc" id="L835" title="All 2 branches missed.">                if (link.getType().hasFlag(MiscType.F_AP_MOUNT)) {</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                    if (m.getType().hasFlag(WeaponType.F_INF_SUPPORT)) {</span>
<span class="nc" id="L837">                        buff.append(m.getName() + &quot; is a support weapon and &quot; +</span>
                            &quot;BattleArmor AP mounts cannot mount &quot; +
                            &quot;support weapons!\n&quot;);
<span class="nc" id="L840">                        correct = false; </span>
                    }
                // Special considerations for armored gloves
<span class="nc bnc" id="L843" title="All 2 branches missed.">                } else if (link.getType().hasFlag(MiscType.F_ARMORED_GLOVE)) {</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                    if (m.getType().hasFlag(WeaponType.F_INF_SUPPORT)){</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                        if ((m.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L846">                            int crew = ((InfantryWeapon)m.getType()).getCrew();</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">                            if (crew &gt; 1) {</span>
<span class="nc" id="L848">                                buff.append(m.getName()</span>
                                        + &quot; has a crew size of &quot; + crew
                                        + &quot; but size can be no greater &quot;
                                        + &quot;than 1E!\n&quot;);
<span class="nc" id="L852">                                correct = false;</span>
                            }
<span class="nc bnc" id="L854" title="All 2 branches missed.">                        } else if (!(m.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L855">                            buff.append(m.getName() + &quot; has the INF_SUPPORT &quot; +</span>
                                    &quot;flag but is not an InfantryWeapon!\n&quot;);
<span class="nc" id="L857">                            correct = false;   </span>
                        }
                    }
                }
            }

            // Check for valid BA equipment
<span class="nc bnc" id="L864" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">                    &amp;&amp; !m.getType().hasFlag(MiscType.F_BA_EQUIPMENT)) {</span>
<span class="nc" id="L866">                buff.append(m.getName() + &quot; is not BattleArmor equipment!\n&quot;);</span>
<span class="nc" id="L867">                correct = false;</span>
            }

<span class="nc bnc" id="L870" title="All 2 branches missed.">            if (m.getType() instanceof AmmoType) {</span>
                final int maxShots;
<span class="nc bnc" id="L872" title="All 2 branches missed.">                if (((AmmoType) m.getType()).getAmmoType() != AmmoType.T_BA_TUBE) {</span>
<span class="nc" id="L873">                    maxShots = NUM_SHOTS_PER_CRIT;</span>
                } else {
<span class="nc" id="L875">                    maxShots = NUM_SHOTS_PER_CRIT_TA;</span>
                }
<span class="nc bnc" id="L877" title="All 2 branches missed.">                if (m.getBaseShotsLeft() &gt; maxShots) {</span>
<span class="nc" id="L878">                    buff.append(m.getName()).append(&quot; has &quot;).append(m.getBaseShotsLeft())</span>
<span class="nc" id="L879">                        .append(&quot; shots, but BattleArmor may only have at most &quot;)</span>
<span class="nc" id="L880">                        .append(maxShots).append(&quot; shots per slot.\n&quot;);</span>
<span class="nc" id="L881">                    correct = false;</span>
                }
            }

            // Ensure that jump boosters are mounted in the body
<span class="nc bnc" id="L886" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_JUMP_BOOSTER)</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_BODY)) {</span>
<span class="nc" id="L888">                buff.append(&quot;Jump Boosters must be mounted in the body!\n&quot;);</span>
            }

            // Ensure partial wing are mounted in the body
<span class="nc bnc" id="L892" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_PARTIAL_WING)</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_BODY)) {</span>
<span class="nc" id="L894">                buff.append(&quot;Partial wing must be mounted in the body!\n&quot;);</span>
            }

<span class="nc bnc" id="L897" title="All 2 branches missed.">            if (m.getLocation() != BattleArmor.LOC_SQUAD) {</span>
<span class="nc" id="L898">                critsUsed[m.getLocation()][m.getBaMountLoc()] += critSize;</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">                if ((m.getType() instanceof WeaponType)){</span>
<span class="nc" id="L900">                    numAMWeapons[m.getLocation()][m.getBaMountLoc()]++;</span>
                }
<span class="nc bnc" id="L902" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_AP_MOUNT)){</span>
<span class="nc" id="L903">                    numAPWeapons[m.getLocation()][m.getBaMountLoc()]++;</span>
                }
            } else {
<span class="nc bnc" id="L906" title="All 2 branches missed.">                for (int t = 0; t &lt;= ba.getTroopers(); t++) {</span>
<span class="nc" id="L907">                    critsUsed[t][m.getBaMountLoc()] += critSize;</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                    if ((m.getType() instanceof WeaponType) </span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">                            &amp;&amp; !(m.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L910">                        numAMWeapons[t][m.getBaMountLoc()]++;</span>
                    }
<span class="nc bnc" id="L912" title="All 2 branches missed.">                    if (m.getType().hasFlag(MiscType.F_AP_MOUNT)) {</span>
<span class="nc" id="L913">                        numAPWeapons[t][m.getBaMountLoc()]++;</span>
                    }
                }
            }
                        
<span class="nc bnc" id="L918" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ARMORED_GLOVE)) {</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                if ((m.getLinked() != null) </span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">                        &amp;&amp; (m.getLinked().getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L921">                    numGloveMountedAPWeapons++;</span>
                }
            }
<span class="nc" id="L924">        }</span>
        
<span class="nc bnc" id="L926" title="All 2 branches missed.">        if (numSSWMs &gt; 1){</span>
<span class="nc" id="L927">            buff.append(&quot;Squad has &quot; + numSSWMs + &quot; squad support &quot; +</span>
                    &quot;weapon mounts, but only 1 is allowed!\n&quot;);
<span class="nc" id="L929">            correct = false;</span>
        }
        
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (numSSWMs &gt; 0 </span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">                &amp;&amp; ba.getChassisType() == BattleArmor.CHASSIS_TYPE_QUAD){</span>
<span class="nc" id="L934">            buff.append(&quot;Quad BattleArmor cannot use squad support &quot; +</span>
                    &quot;weapon mounts!\n&quot;);
<span class="nc" id="L936">            correct = false;</span>
        }
        
<span class="nc bnc" id="L939" title="All 2 branches missed.">        if (numGloveMountedAPWeapons &gt; 1) {</span>
<span class="nc" id="L940">            buff.append(&quot;Batle Armor with armored gloves may only mount 1 &quot; +</span>
                    &quot;additional AP weapon, but &quot; + numGloveMountedAPWeapons 
                    + &quot; are mounted!\n&quot;);
<span class="nc" id="L943">            correct = false;</span>
        }
        
<span class="nc bnc" id="L946" title="All 2 branches missed.">        if (squadSupportWeapon != null){</span>
<span class="nc" id="L947">            WeaponType sswType = (WeaponType)squadSupportWeapon.getType();</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">            for (Mounted ammo : ba.getAmmo()){</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                if (ammo.isSquadSupportWeapon() &amp;&amp; </span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                        !AmmoType.isAmmoValid(ammo, sswType)){</span>
<span class="nc" id="L951">                    buff.append(ammo.getName() + &quot; is squad support weapon &quot; +</span>
                            &quot;mounted, but it is not a legal ammo type for &quot; +
                            &quot;the squad support weapon!\n&quot;);
<span class="nc" id="L954">                    correct = false;</span>
                }
<span class="nc" id="L956">            }</span>
        }

        // Turret-mounted weapons on quad BA count against the body weapon limits
<span class="nc bnc" id="L960" title="All 2 branches missed.">        for (int t = 0; t &lt; ba.locations(); t++) {</span>
<span class="nc" id="L961">            numAMWeapons[t][BattleArmor.MOUNT_LOC_BODY] += numAMWeapons[t][BattleArmor.MOUNT_LOC_TURRET];</span>
<span class="nc" id="L962">            numAPWeapons[t][BattleArmor.MOUNT_LOC_BODY] += numAPWeapons[t][BattleArmor.MOUNT_LOC_TURRET];</span>
        }

        // Now check to make sure the counts are valid
<span class="nc bnc" id="L966" title="All 2 branches missed.">        for (int t = 0; t &lt;= ba.getTroopers(); t++) {</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">            for (int loc = 0; loc &lt; BattleArmor.MOUNT_NUM_LOCS; loc++) {</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">                if (critsUsed[t][loc] &gt; ba.getNumCrits(loc)) {</span>
<span class="nc" id="L969">                    buff.append(BattleArmor.getBaMountLocAbbr(loc) + &quot; of &quot;</span>
<span class="nc" id="L970">                            + ba.getLocationAbbr(t) + &quot; has &quot;</span>
                            + critsUsed[t][loc]
                            + &quot; used criticals, but only has &quot;
<span class="nc" id="L973">                            + ba.getNumCrits(loc) + &quot; available criticsl!\n&quot;);</span>
<span class="nc" id="L974">                    correct = false;</span>
                }
<span class="nc bnc" id="L976" title="All 2 branches missed.">                if (BattleArmor.MOUNT_LOC_TURRET == loc) {</span>
<span class="nc" id="L977">                    continue;</span>
                }
<span class="nc" id="L979">                if (numAMWeapons[t][loc] &gt; </span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">                        ba.getNumAllowedAntiMechWeapons(loc)) {</span>
<span class="nc" id="L981">                    buff.append(BattleArmor.getBaMountLocAbbr(loc) + &quot; of &quot;</span>
<span class="nc" id="L982">                            + ba.getLocationAbbr(t) + &quot; has &quot;</span>
                            + numAMWeapons[t][loc]
                            + &quot; anti-mech weapons, but only &quot;
<span class="nc" id="L985">                            + ba.getNumAllowedAntiMechWeapons(loc)</span>
                            + &quot; are allowed!\n&quot;);
<span class="nc" id="L987">                    correct = false;</span>
                }
<span class="nc" id="L989">                if (numAPWeapons[t][loc] &gt; ba</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">                        .getNumAllowedAntiPersonnelWeapons(loc, t)) {</span>
<span class="nc" id="L991">                    buff.append(BattleArmor.getBaMountLocAbbr(loc) + &quot; of &quot;</span>
<span class="nc" id="L992">                            + ba.getLocationAbbr(t) + &quot; has &quot;</span>
                            + numAPWeapons[t][loc]
                            + &quot; anti-personnel weapons, but only &quot;
<span class="nc" id="L995">                            + ba.getNumAllowedAntiPersonnelWeapons(loc, t)</span>
                            + &quot; are allowed!\n&quot;);
<span class="nc" id="L997">                    correct = false;</span>
                }
            }
        }

<span class="nc" id="L1002">        return correct;</span>
    }

    public void getUnallocatedEquipment(Entity entity,
            Vector&lt;Mounted&gt; unallocated) {
<span class="nc bnc" id="L1007" title="All 2 branches missed.">        for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">            if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE) {</span>
                // OS-launcher ammo doesn't take up a slot
<span class="nc bnc" id="L1010" title="All 2 branches missed.">                if ((m.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                        &amp;&amp; (m.getLinkedBy() != null)</span>
<span class="nc" id="L1012">                        &amp;&amp; m.getLinkedBy().getType()</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                                .hasFlag(WeaponType.F_ONESHOT)) {</span>
<span class="nc" id="L1014">                    continue;</span>
                }

                // Equipment taking up no slots doesn't need to be mounted
<span class="nc bnc" id="L1018" title="All 2 branches missed.">                if ((m.getCriticals() == 0)</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">                        &amp;&amp; !((m.getType() instanceof InfantryWeapon) </span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">                                &amp;&amp; !m.isAPMMounted())) {</span>
<span class="nc" id="L1021">                    continue;</span>
                }

                // Weapons mounted in a DWP don't get assigned a location
<span class="nc bnc" id="L1025" title="All 2 branches missed.">                if (((m.getLinked() != null) &amp;&amp; m.getLinked().getType()</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">                        .hasFlag(MiscType.F_DETACHABLE_WEAPON_PACK))</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                        || ((m.getLinkedBy() != null) &amp;&amp; m.getLinkedBy()</span>
<span class="nc" id="L1028">                                .getType()</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                                .hasFlag(MiscType.F_DETACHABLE_WEAPON_PACK))) {</span>
<span class="nc" id="L1030">                    continue;</span>
                }
                
                // Ammo mounted in a DWP doesn't get assigned a location
<span class="nc bnc" id="L1034" title="All 2 branches missed.">                if ((m.getType() instanceof AmmoType) </span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                        &amp;&amp; (m.getLinkedBy() != null) </span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">                        &amp;&amp; m.getLinkedBy().isDWPMounted() ) {</span>
<span class="nc" id="L1037">                    continue;</span>
                }

                // Anything else is unassigned equipment
<span class="nc" id="L1041">                unallocated.addElement(m);</span>
            }
<span class="nc" id="L1043">        }</span>
<span class="nc" id="L1044">    }</span>

    public boolean correctManipulators(StringBuffer buff) {
<span class="nc" id="L1047">        boolean correct = true;</span>
<span class="nc" id="L1048">        int numLAManipulators = 0;</span>
<span class="nc" id="L1049">        int numRAManipulators = 0;</span>
<span class="nc" id="L1050">        BAManipulator laManipType = BAManipulator.NONE;</span>
<span class="nc" id="L1051">        BAManipulator raManipType = BAManipulator.NONE;</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">        for (Mounted m : ba.getEquipment()) {</span>
<span class="nc bnc" id="L1053" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)) {</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">                if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_LARM) {</span>
<span class="nc" id="L1055">                    numLAManipulators++;</span>
<span class="nc" id="L1056">                    laManipType = BAManipulator.getManipulator(m.getType().getInternalName());</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                } else if (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_RARM) {</span>
<span class="nc" id="L1058">                    numRAManipulators++;</span>
<span class="nc" id="L1059">                    raManipType = BAManipulator.getManipulator(m.getType().getInternalName());</span>
                } else {
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                    if (m.getBaMountLoc() != BattleArmor.MOUNT_LOC_NONE) {</span>
<span class="nc" id="L1062">                        buff.append(m.getName()</span>
                                + &quot;mounted in &quot;
<span class="nc" id="L1064">                                + BattleArmor.MOUNT_LOC_NAMES[m.getBaMountLoc()]</span>
                                + &quot;, but manipulators must be mounted in arms!&quot;);
                    } else {
<span class="nc" id="L1067">                        buff.append(m.getName()</span>
                                + &quot; not allocated!\n&quot;);  
                    }
<span class="nc" id="L1070">                    correct = false;</span>
                }
            }
<span class="nc" id="L1073">        }</span>

<span class="nc bnc" id="L1075" title="All 2 branches missed.">        if (numLAManipulators &gt; 1) {</span>
<span class="nc" id="L1076">            buff.append(&quot;Found more than 1 manipulator in the left arm!&quot;);</span>
<span class="nc" id="L1077">            correct = false;</span>
        }

<span class="nc bnc" id="L1080" title="All 2 branches missed.">        if (numRAManipulators &gt; 1) {</span>
<span class="nc" id="L1081">            buff.append(&quot;Found more than 1 manipulator in the right arm!&quot;);</span>
<span class="nc" id="L1082">            correct = false;</span>
        }

<span class="nc bnc" id="L1085" title="All 6 branches missed.">        if ((laManipType.pairMounted || raManipType.pairMounted)</span>
                &amp;&amp; (laManipType.type != raManipType.type)) {
<span class="nc bnc" id="L1087" title="All 2 branches missed.">            if (laManipType.pairMounted) {</span>
<span class="nc" id="L1088">                buff.append(&quot;Left Arm manipulator must be mounted as a &quot;</span>
                        + &quot;pair, but the right arm manipulator doesn't match! &quot;);
            } else {
<span class="nc" id="L1091">                buff.append(&quot;Right Arm manipulator must be mounted as a &quot;</span>
                        + &quot;pair, but the left arm manipulator doesn't match! &quot;);
            }
<span class="nc" id="L1094">            correct = false;</span>
        }
<span class="nc" id="L1096">        return correct;</span>
    }

    @Override
    public boolean correctWeight(StringBuffer buff, boolean showO, boolean showU) {
<span class="nc" id="L1101">        double weightSum = calculateWeight();</span>
<span class="nc" id="L1102">        double weight = getWeight();</span>
<span class="nc" id="L1103">        boolean correct = true;</span>
<span class="nc" id="L1104">        String baDesig = ba.getLocationAbbr(BattleArmor.LOC_SQUAD);</span>
<span class="nc bnc" id="L1105" title="All 4 branches missed.">        if (showO &amp;&amp; ((weight + getMaxOverweight()) &lt; weightSum)) {</span>
<span class="nc" id="L1106">            buff.append(baDesig + &quot;Weight: &quot;).append(calculateWeight())</span>
<span class="nc" id="L1107">                    .append(&quot; is greater than &quot;).append(getWeight())</span>
<span class="nc" id="L1108">                    .append(&quot;\n&quot;);</span>
<span class="nc" id="L1109">            correct = false;</span>
        }
<span class="nc bnc" id="L1111" title="All 4 branches missed.">        if (showU &amp;&amp; ((weight - getMinUnderweight()) &gt; weightSum)) {</span>
<span class="nc" id="L1112">            buff.append(&quot;Weight: &quot;).append(calculateWeight())</span>
<span class="nc" id="L1113">                    .append(&quot; is less than &quot;).append(getWeight()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1114">            correct = false;</span>
        }

<span class="nc bnc" id="L1117" title="All 2 branches missed.">        for (int t = 1; t &lt; ba.getTroopers(); t++) {</span>
<span class="nc" id="L1118">            double trooperWeight = calculateWeight(t);</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">            if (trooperWeight &gt; ba.getTrooperWeight()) {</span>
<span class="nc" id="L1120">                buff.append(&quot;Trooper &quot; + t + &quot; Weight: &quot; + trooperWeight</span>
<span class="nc" id="L1121">                        + &quot; is greater than &quot; + ba.getTrooperWeight() + &quot;\n&quot;);</span>
<span class="nc" id="L1122">                correct = false;</span>
            }
        }
<span class="nc" id="L1125">        return correct;</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff) {
<span class="nc" id="L1130">        return correctEntity(buff, getEntity().getTechLevel());</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {
<span class="nc" id="L1135">        boolean correct = true;</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        if (skip()) {</span>
<span class="nc" id="L1137">            return true;</span>
        }
<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if (!correctWeight(buff)) {</span>
<span class="nc" id="L1140">            buff.insert(0, printTechLevel() + printShortMovement());</span>
<span class="nc" id="L1141">            buff.append(printWeightCalculation());</span>
<span class="nc" id="L1142">            correct = false;</span>
        }

<span class="nc bnc" id="L1145" title="All 4 branches missed.">        if (showCorrectArmor() &amp;&amp; !correctArmor(buff)) {</span>
<span class="nc" id="L1146">            correct = false;</span>
        }
<span class="nc bnc" id="L1148" title="All 4 branches missed.">        if (showCorrectCritical() &amp;&amp; !correctCriticals(buff)) {</span>
<span class="nc" id="L1149">            correct = false;</span>
        }
<span class="nc bnc" id="L1151" title="All 4 branches missed.">        if (showFailedEquip() &amp;&amp; hasFailedEquipment(buff)) {</span>
<span class="nc" id="L1152">            correct = false;</span>
        }
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (hasIllegalTechLevels(buff, ammoTechLvl)) {</span>
<span class="nc" id="L1155">            correct = false;</span>
        }
<span class="nc bnc" id="L1157" title="All 4 branches missed.">        if (showIncorrectIntroYear() &amp;&amp; hasIncorrectIntroYear(buff)) {</span>
<span class="nc" id="L1158">            correct = false;</span>
        }
<span class="nc bnc" id="L1160" title="All 2 branches missed.">        if (hasIllegalEquipmentCombinations(buff)) {</span>
<span class="nc" id="L1161">            correct = false;</span>
        }

<span class="nc" id="L1164">        correct &amp;= correctManipulators(buff);</span>

<span class="nc" id="L1166">        correct &amp;= correctMovement(buff);</span>

<span class="nc" id="L1168">        return correct;</span>
    }

    /**
     * @param eq        The equipment
     * @param buffer    If non-null and the location is invalid, will be appended with an explanation
     * @return          Whether the equipment can be mounted in the BattleArmor suit
     */
    public static boolean isValidBALocation(EquipmentType eq, @Nullable StringBuffer buffer) {
        // Infantry weapons can only be mounted in armored gloves/APMs
<span class="nc bnc" id="L1178" title="All 4 branches missed.">        if ((eq instanceof WeaponType) &amp;&amp; eq.hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">            if (buffer != null) {</span>
<span class="nc" id="L1180">                buffer.append(eq.getName())</span>
<span class="nc" id="L1181">                        .append(&quot; can only be mounted in an anti-personnel mount or an armored glove.\n&quot;);</span>
            }
<span class="nc" id="L1183">            return false;</span>
        }
<span class="nc" id="L1185">        return true;</span>
    }

    @Override
    public StringBuffer printEntity() {
<span class="nc" id="L1190">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L1191">        buff.append(&quot;BattleArmor: &quot;).append(ba.getDisplayName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1192">        buff.append(&quot;Found in: &quot;).append(fileString).append(&quot;\n&quot;);</span>
<span class="nc" id="L1193">        buff.append(printTechLevel());</span>
<span class="nc" id="L1194">        buff.append(&quot;Intro year: &quot;).append(ba.getYear()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1195">        buff.append(printSource());</span>
<span class="nc" id="L1196">        buff.append(printShortMovement());</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">        if (correctWeight(buff, true, true)) {</span>
<span class="nc" id="L1198">            buff.append(&quot;Weight: &quot;).append(getWeight() * 1000).append(&quot; kg (&quot;)</span>
<span class="nc" id="L1199">                    .append(calculateWeight() * 1000).append(&quot; kg)\n&quot;);</span>
        }
<span class="nc" id="L1201">        buff.append(printWeightCalculation()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1202">        buff.append(printArmorPlacement());</span>
<span class="nc" id="L1203">        correctArmor(buff);</span>
<span class="nc" id="L1204">        buff.append(printLocations());</span>
<span class="nc" id="L1205">        correctCriticals(buff);</span>
<span class="nc" id="L1206">        printFailedEquipment(buff);</span>
<span class="nc" id="L1207">        return buff;</span>
    }

    @Override
    public String printWeightCalculation() {
<span class="nc" id="L1212">        return printWeightStructure() + printWeightArmor() + &quot;Equipment:\n&quot;</span>
<span class="nc" id="L1213">                + printWeapon() + printAmmo() + printMiscEquip();</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L1218">        return &quot;Battle Armor: &quot; + ba.getDisplayName();</span>
    }

    @Override
    public double getWeightPowerAmp() {
<span class="nc" id="L1223">        return 0;</span>
    }

    /**
     * Performs the same functionality as &lt;code&gt;TestEntity.getWeightMiscEquip
     * &lt;/code&gt; but only considers equipment mounted on the specified trooper.
     * That is, only misc equipment that is squad mounted or on the specific
     * trooper is added.
     *
     * @param trooper
     * @return
     */
    public double getWeightMiscEquip(int trooper) {
<span class="nc" id="L1236">        double weightSum = 0.0;</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">        for (Mounted m : getEntity().getMisc()) {</span>
<span class="nc" id="L1238">            MiscType mt = (MiscType) m.getType();</span>
            // If this equipment isn't mounted on the squad or this particular
            // trooper, skip it
<span class="nc bnc" id="L1241" title="All 2 branches missed.">            if ((m.getLocation() != BattleArmor.LOC_SQUAD)</span>
<span class="nc bnc" id="L1242" title="All 4 branches missed.">                    &amp;&amp; ((m.getLocation() != trooper) || (trooper == BattleArmor.LOC_SQUAD))) {</span>
<span class="nc" id="L1243">                continue;</span>
            }

            // Equipment assigned to this trooper but not mounted shouldn't be
            // counted, unless it's squad-level equipment
<span class="nc bnc" id="L1248" title="All 4 branches missed.">            if ((m.getLocation() == trooper) &amp;&amp; (trooper != BattleArmor.LOC_SQUAD)</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE)) {</span>
<span class="nc" id="L1250">                continue;</span>
            }

<span class="nc bnc" id="L1253" title="All 2 branches missed.">            if (mt.hasFlag(MiscType.F_ENDO_STEEL)</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_COMPOSITE)</span>
<span class="nc bnc" id="L1258" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_INDUSTRIAL_STRUCTURE)</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REINFORCED)</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS)</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS_PROTO)</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_LAMELLOR)</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_LIGHT_FERRO)</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAVY_FERRO)</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REACTIVE)</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REFLECTIVE)</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HARDENED_ARMOR)</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_PRIMITIVE_ARMOR)</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_COMMERCIAL_ARMOR)</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_INDUSTRIAL_ARMOR)</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAVY_INDUSTRIAL_ARMOR)</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ANTI_PENETRATIVE_ABLATIVE)</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAT_DISSIPATING)</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_IMPACT_RESISTANT)</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_BALLISTIC_REINFORCED)</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAT_SINK)</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {</span>
<span class="nc" id="L1279">                continue;</span>
            }
<span class="nc" id="L1281">            weightSum += m.getTonnage();</span>
<span class="nc" id="L1282">        }</span>
<span class="nc" id="L1283">        return weightSum;</span>
    }

    public double getWeightWeapon(int trooper) {
<span class="nc" id="L1287">        double weight = 0.0;</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">        for (Mounted m : getEntity().getWeaponList()) {</span>
            // If this equipment isn't mounted on the squad or this particular
            // trooper, skip it
<span class="nc bnc" id="L1291" title="All 2 branches missed.">            if ((m.getLocation() != BattleArmor.LOC_SQUAD)</span>
<span class="nc bnc" id="L1292" title="All 4 branches missed.">                    &amp;&amp; ((m.getLocation() != trooper) || (trooper == BattleArmor.LOC_SQUAD))) {</span>
<span class="nc" id="L1293">                continue;</span>
            }

            // Equipment assigned to this trooper but not mounted shouldn't be
            // counted, unless it's squad-level equipment
<span class="nc bnc" id="L1298" title="All 4 branches missed.">            if ((m.getLocation() == trooper) &amp;&amp; (trooper != BattleArmor.LOC_SQUAD)</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE)) {</span>
<span class="nc" id="L1300">                continue;</span>
            }
            
            // The weight of an anti-personnel weapon in an AP mount or armored glove manipulator doesn't
            // count toward suit weight limit.
<span class="nc bnc" id="L1305" title="All 2 branches missed.">            if (m.isAPMMounted()) {</span>
<span class="nc" id="L1306">                continue;</span>
            }

<span class="nc" id="L1309">            weight += m.getTonnage();</span>
<span class="nc" id="L1310">        }</span>
        // Round weight to prevent odd behavior
<span class="nc" id="L1312">        return Math.round(weight * 1000) / 1000.0;</span>
    }

    public double getWeightAmmo(int trooper) {
<span class="nc" id="L1316">        double weight = 0.0;</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        for (Mounted m : getEntity().getAmmo()) {</span>

            // If this equipment isn't mounted on the squad or this particular
            // trooper, skip it
<span class="nc bnc" id="L1321" title="All 2 branches missed.">            if ((m.getLocation() != BattleArmor.LOC_SQUAD)</span>
<span class="nc bnc" id="L1322" title="All 4 branches missed.">                    &amp;&amp; ((m.getLocation() != trooper) </span>
                            || (trooper == BattleArmor.LOC_SQUAD))) {
<span class="nc" id="L1324">                continue;</span>
            }

            // Equipment assigned to this trooper but not mounted shouldn't be
            // counted, unless it's squad-level equipment
<span class="nc bnc" id="L1329" title="All 4 branches missed.">            if ((m.getLocation() == trooper) </span>
                    &amp;&amp; (trooper != BattleArmor.LOC_SQUAD)
<span class="nc bnc" id="L1331" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() == BattleArmor.MOUNT_LOC_NONE)) {</span>
<span class="nc" id="L1332">                continue;</span>
            }
<span class="nc" id="L1334">            double modifier = 1;</span>
            // Ammo mounted in a DWP has its weight reduced by 25%
<span class="nc bnc" id="L1336" title="All 4 branches missed.">            if (m.getLinkedBy() != null &amp;&amp; m.getLinkedBy().isDWPMounted()){</span>
<span class="nc" id="L1337">                modifier = 0.75f;</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">            } else if (m.isSquadSupportWeapon()) {</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">                if (ba.isClan()){</span>
<span class="nc" id="L1340">                    modifier = 0.4;</span>
                } else {
<span class="nc" id="L1342">                    modifier = 0.5;</span>
                }
            }
<span class="nc" id="L1345">            AmmoType mt = (AmmoType) m.getType();</span>
<span class="nc" id="L1346">            weight += (mt.getKgPerShot() * m.getBaseShotsLeft()) / 1000.0</span>
                    * modifier;
<span class="nc" id="L1348">        }</span>
<span class="nc" id="L1349">        return weight;</span>
    }

    /**
     * There are some cases where we need to know the weight of an individual
     * trooper in the BattleArmor squad, this method provides that.
     *
     * @param trooper
     * @return
     */
    public double calculateWeight(int trooper) {
<span class="nc" id="L1360">        double weight = 0;</span>
<span class="nc" id="L1361">        weight += getWeightStructure();</span>
<span class="nc" id="L1362">        weight += getWeightArmor();</span>
<span class="nc" id="L1363">        weight += getWeightMisc();</span>

<span class="nc" id="L1365">        weight += getWeightMiscEquip(trooper);</span>
<span class="nc" id="L1366">        weight += getWeightWeapon(trooper);</span>
<span class="nc" id="L1367">        weight += getWeightAmmo(trooper);</span>

        // Round weight to prevent odd behavior
<span class="nc" id="L1370">        return Math.round(weight*1000) / 1000.0;</span>
    }

    @Override
    public double calculateWeight() {
<span class="nc" id="L1375">        double totalWeight = 0.0;</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">        for (int i = 0; i &lt; ba.getTroopers(); i++) {</span>
<span class="nc" id="L1377">            totalWeight += calculateWeight(i);</span>
        }
<span class="nc" id="L1379">        return totalWeight;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>