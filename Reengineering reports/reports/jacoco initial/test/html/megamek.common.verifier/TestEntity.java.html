<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestEntity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.verifier</a> &gt; <span class="el_source">TestEntity.java</span></div><h1>TestEntity.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

/*
 * Author: Reinhard Vicinus
 */

package megamek.common.verifier;

import java.text.DecimalFormat;
import java.util.*;
import java.util.stream.Collectors;

import megamek.common.*;
import megamek.common.annotations.Nullable;
import megamek.common.util.StringUtil;

/**
 * Abstract parent class for testing and validating instantiations of &lt;code&gt;
 * Entity&lt;/code&gt; subclasses.
 *
 */
public abstract class TestEntity implements TestEntityOption {
<span class="fc" id="L36">    public static enum Ceil {</span>
<span class="fc" id="L37">        TON(1.0), HALFTON(2.0), QUARTERTON(4.0), TENTHTON(10.0), KILO(1000.0);</span>
        
        public final double mult;
        
<span class="fc" id="L41">        private Ceil(double mult) {</span>
<span class="fc" id="L42">            this.mult = mult;</span>
<span class="fc" id="L43">        }</span>
    }
    
<span class="fc" id="L46">    protected Engine engine = null;</span>
<span class="fc" id="L47">    protected Armor[] armor = null;</span>
<span class="fc" id="L48">    protected Structure structure = null;</span>
<span class="fc" id="L49">    private TestEntityOption options = null;</span>

    public abstract Entity getEntity();

    public abstract boolean isTank();

    public abstract boolean isMech();

    public abstract boolean isAero();
    
    public abstract boolean isSmallCraft();
    
    public abstract boolean isAdvancedAerospace();
    
    public abstract boolean isProtomech();

    public abstract double getWeightControls();

    public abstract double getWeightMisc();

    public abstract double getWeightHeatSinks();

    public abstract boolean hasDoubleHeatSinks();

    public abstract int getCountHeatSinks();

    public abstract String printWeightMisc();

    public abstract String printWeightControls();

    public abstract boolean correctEntity(StringBuffer buff);

    public abstract boolean correctEntity(StringBuffer buff, int ammoTechLvl);

    public abstract StringBuffer printEntity();

    public abstract String getName();

<span class="fc" id="L87">    public String fileString = null; // where the unit came from</span>

    public TestEntity(TestEntityOption options, Engine engine, Armor[] armor,
<span class="fc" id="L90">            Structure structure) {</span>
<span class="fc" id="L91">        this.options = options;</span>
<span class="fc" id="L92">        this.engine = engine;</span>
<span class="fc" id="L93">        this.armor = armor;</span>
<span class="fc" id="L94">        this.structure = structure;</span>
<span class="fc" id="L95">    }</span>

    public boolean isClan() {
<span class="nc" id="L98">        return getEntity().isClan();</span>
    }

    public boolean isClanArmor() {
<span class="nc bnc" id="L102" title="All 4 branches missed.">        return getEntity().isClanArmor(0) &amp;&amp; !getEntity().hasPatchworkArmor();</span>
    }

    public double getWeight() {
<span class="fc" id="L106">        return getEntity().getWeight();</span>
    }

    public int getTotalOArmor() {
<span class="nc" id="L110">        return getEntity().getTotalOArmor();</span>
    }

    public String getLocationAbbr(int location) {
<span class="nc" id="L114">        return getEntity().getLocationAbbr(location);</span>
    }

    @Override
    public Ceil getWeightCeilingEngine() {
<span class="nc" id="L119">        return options.getWeightCeilingEngine();</span>
    }

    @Override
    public Ceil getWeightCeilingStructure() {
<span class="nc" id="L124">        return options.getWeightCeilingStructure();</span>
    }

    @Override
    public Ceil getWeightCeilingArmor() {
<span class="nc" id="L129">        return options.getWeightCeilingArmor();</span>
    }

    @Override
    public Ceil getWeightCeilingControls() {
<span class="nc" id="L134">        return options.getWeightCeilingControls();</span>
    }

    @Override
    public Ceil getWeightCeilingWeapons() {
<span class="nc" id="L139">        return options.getWeightCeilingWeapons();</span>
    }

    @Override
    public Ceil getWeightCeilingTargComp() {
<span class="nc" id="L144">        return options.getWeightCeilingTargComp();</span>
    }

    @Override
    public Ceil getWeightCeilingGyro() {
<span class="nc" id="L149">        return options.getWeightCeilingGyro();</span>
    }

    @Override
    public Ceil getWeightCeilingTurret() {
<span class="nc" id="L154">        return options.getWeightCeilingTurret();</span>
    }

    @Override
    public Ceil getWeightCeilingLifting() {
<span class="nc" id="L159">        return options.getWeightCeilingLifting();</span>
    }

    @Override
    public Ceil getWeightCeilingPowerAmp() {
<span class="nc" id="L164">        return options.getWeightCeilingPowerAmp();</span>
    }

    @Override
    public double getMaxOverweight() {
<span class="fc" id="L169">        return options.getMaxOverweight();</span>
    }

    @Override
    public boolean showOverweightedEntity() {
<span class="fc" id="L174">        return options.showOverweightedEntity();</span>
    }

    @Override
    public double getMinUnderweight() {
<span class="nc" id="L179">        return options.getMinUnderweight();</span>
    }

    @Override
    public boolean showUnderweightedEntity() {
<span class="fc" id="L184">        return options.showUnderweightedEntity();</span>
    }

    public boolean showCorrectArmor() {
<span class="nc" id="L188">        return options.showCorrectArmor();</span>
    }

    public boolean showCorrectCritical() {
<span class="nc" id="L192">        return options.showCorrectCritical();</span>
    }

    public boolean showFailedEquip() {
<span class="nc" id="L196">        return options.showFailedEquip();</span>
    }

    public boolean ignoreFailedEquip(String name) {
<span class="nc" id="L200">        return options.ignoreFailedEquip(name);</span>
    }
    
    public boolean showIncorrectIntroYear() {
<span class="nc" id="L204">        return options.showIncorrectIntroYear();</span>
    }
    
    public int getIntroYearMargin() {
<span class="nc" id="L208">        return options.getIntroYearMargin();</span>
    }

    public boolean skip() {
<span class="nc" id="L212">        return options.skip();</span>
    }

    public int getTargCompCrits() {
<span class="nc" id="L216">        return options.getTargCompCrits();</span>
    }

    public int getPrintSize() {
<span class="nc" id="L220">        return options.getPrintSize();</span>
    }

    /**
     * Used to round values up based on the specified type.
     *
     * @param f     Value to round
     * @param type  Specifies the number of decimals to round to, see
     *              TestEntity.CEIL_TON, etc.
     * @return      Rounded value
     */
    public static double ceil(double f, Ceil type) {
<span class="fc" id="L232">        return Math.ceil(f * type.mult) / type.mult;</span>
    }

    public static double ceilMaxHalf(double f, Ceil type) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (type == Ceil.TON) {</span>
<span class="nc" id="L237">            return TestEntity.ceil(f, Ceil.HALFTON);</span>
        }
<span class="nc" id="L239">        return TestEntity.ceil(f, type);</span>
    }

    public static double floor(double f, Ceil type) {
<span class="nc" id="L243">        return Math.floor(f * type.mult) / type.mult;</span>
    }

    public static double round(double f, Ceil type) {
<span class="fc" id="L247">        return Math.round(f * type.mult) / type.mult;</span>
    }

    static String makeWeightString(double weight) {
<span class="nc" id="L251">        return makeWeightString(weight, false);</span>
    }

    static String makeWeightString(double weight, boolean kg) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (kg) {</span>
<span class="nc" id="L256">            weight *= 1000;</span>
        }
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (weight &lt; 0.5) {</span>
            // For small equipment show as many decimal places as needed.
<span class="nc" id="L260">            return DecimalFormat.getInstance().format(weight);</span>
        } else {
<span class="nc bnc" id="L262" title="All 2 branches missed.">            return String.format(&quot;%3.1f%s&quot;, weight, (kg ? &quot; kg&quot; : &quot;&quot;));</span>
        }
    }

    /**
     * Allows a value to be truncuated to an arbitrary number of decimal places.
     *
     * @param value
     *            The input value
     * @param precision
     *            The number of decimals to truncate at
     *
     * @return The input value truncated to the number of decimal places
     *         supplied
     */
    public static double setPrecision(double value, int precision) {
<span class="nc" id="L278">        return Math.round(value * Math.pow(10, precision))</span>
<span class="nc" id="L279">                / Math.pow(10, precision);</span>
    }
    
    /**
     * Filters all armor according to given tech constraints
     *
     * @param etype         The entity type bit mask
     * @param industrial    For mechs; industrial mechs can only use certain armor types
     *                      unless allowing experimental rules
     * @param primitive     Whether the unit is primitive/retrotech
     * @param movementMode  For vehicles; hardened armor is illegal for some movement modes 
     * @param techManager   The constraints used to filter the armor types
     * @return A list of all armors that meet the tech constraints
     */
    public static List&lt;EquipmentType&gt; legalArmorsFor(long etype, boolean industrial, boolean primitive,
            EntityMovementMode movementMode, ITechManager techManager) {
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if ((etype &amp; Entity.ETYPE_BATTLEARMOR) != 0) {</span>
<span class="nc" id="L296">            return TestBattleArmor.legalArmorsFor(techManager);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">        } else if ((etype &amp; Entity.ETYPE_SMALL_CRAFT) != 0) {</span>
<span class="nc" id="L298">            return TestSmallCraft.legalArmorsFor(techManager);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">        } else if ((etype &amp; Entity.ETYPE_JUMPSHIP) != 0) {</span>
<span class="nc" id="L300">            return TestAdvancedAerospace.legalArmorsFor(techManager, primitive);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        } else if ((etype &amp; (Entity.ETYPE_FIXED_WING_SUPPORT | Entity.ETYPE_SUPPORT_TANK | Entity.ETYPE_SUPPORT_VTOL)) != 0) {</span>
<span class="nc" id="L302">            return TestSupportVehicle.legalArmorsFor(techManager);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        } else if ((etype &amp; Entity.ETYPE_AERO) != 0) {</span>
<span class="nc" id="L304">            return TestAero.legalArmorsFor(techManager);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        } else if ((etype &amp; Entity.ETYPE_TANK) != 0) {</span>
<span class="nc" id="L306">            return TestTank.legalArmorsFor(movementMode, techManager);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        } else if ((etype &amp; Entity.ETYPE_MECH) != 0) {</span>
<span class="nc" id="L308">            return TestMech.legalArmorsFor(etype, industrial, techManager);</span>
        } else {
<span class="nc" id="L310">            return Collections.emptyList();</span>
        }
    }
    
    public static List&lt;EquipmentType&gt; validJumpJets(long entitytype, boolean industrial) {
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if ((entitytype &amp; Entity.ETYPE_MECH) != 0) {</span>
<span class="nc" id="L316">            return TestMech.MechJumpJets.allJJs(industrial);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        } else if ((entitytype &amp; Entity.ETYPE_TANK) != 0) {</span>
<span class="nc" id="L318">            return Collections.singletonList(EquipmentType.get(EquipmentTypeLookup.VEHICLE_JUMP_JET));</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        } else if ((entitytype &amp; Entity.ETYPE_BATTLEARMOR) != 0) {</span>
<span class="nc" id="L320">            return TestBattleArmor.BAMotiveSystems.allSystems();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        } else if ((entitytype &amp; Entity.ETYPE_PROTOMECH) != 0) {</span>
            // Until we have a TestProtomech
<span class="nc" id="L323">            return Arrays.asList(new EquipmentType[] {</span>
<span class="nc" id="L324">                EquipmentType.get(EquipmentTypeLookup.PROTOMECH_JUMP_JET),</span>
<span class="nc" id="L325">                EquipmentType.get(EquipmentTypeLookup.EXTENDED_JUMP_JET_SYSTEM),</span>
<span class="nc" id="L326">                EquipmentType.get(EquipmentTypeLookup.PROTOMECH_UMU)});</span>
        } else {
<span class="nc" id="L328">            return Collections.emptyList();</span>
        }
    }
    
    /**
     * Additional crew requirements for vehicles and aerospace vessels for certain types of
     * equipment.
     */
    public static int equipmentCrewRequirements(Mounted mounted) {
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (mounted.getType() instanceof MiscType) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_MOBILE_FIELD_BASE)) {</span>
<span class="nc" id="L339">                return 5;</span>
            }
<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_MASH)) {</span>
<span class="nc" id="L342">                return 5 * (int) mounted.getSize();</span>
            }
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_FIELD_KITCHEN)) {</span>
<span class="nc" id="L345">                return 3;</span>
            }
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_COMMUNICATIONS)) {</span>
<span class="nc" id="L348">                return (int) mounted.getTonnage();</span>
            }
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_MOBILE_HPG)) {</span>
                // Mobile HPG has crew requirement of 10; ground-mobile has requirement of 1.
<span class="nc bnc" id="L352" title="All 2 branches missed.">                return mounted.getType().hasFlag(MiscType.F_TANK_EQUIPMENT)? 1 : 10;</span>
            }
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_SMALL_COMM_SCANNER_SUITE)) {</span>
<span class="nc" id="L355">                return 6;</span>
            }
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_LARGE_COMM_SCANNER_SUITE)) {</span>
<span class="nc" id="L358">                return 12;</span>
            }
        }
<span class="nc" id="L361">        return 0;</span>
    }
    
    /**
     * Determines whether a type of equipment requires a particular location on an {@link Entity}.
     * What this means depends on the type of unit, but typically it does not take up a slot or
     * is not assigned a firing arc.
     * 
     * @param entity The Entity the equipment is to be placed on
     * @param eq     The equipment to place on the Entity
     * @return       Whether the equipment requires a location
     * @see #getSystemWideLocation(Entity)
     */
    public static boolean eqRequiresLocation(Entity entity, EquipmentType eq) {
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (entity.hasETypeFlag(Entity.ETYPE_AERO)) {</span>
<span class="nc" id="L376">            return TestAero.eqRequiresLocation(eq, entity.isFighter());</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L378">            return TestProtomech.requiresSlot(eq);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_TANK)) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            return !TestTank.isBodyEquipment(eq);</span>
        }
<span class="nc" id="L382">        return true;</span>
    }

    /**
     * Determines where to place equipment that does not require a specific location. What
     * this means varies by {@link Entity} type.
     * 
     * @param entity  The Entity to place the equipment in
     * @return        The location to place equipment that is not required to be assigned a location,
     *                defaulting to Entity.LOC_NONE for unit types that do not have such a location.
     */
    public static int getSystemWideLocation(Entity entity) {
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L395">            return Jumpship.LOC_HULL;</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L397">            return SmallCraft.LOC_HULL;</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_AERO)) {</span>
<span class="nc" id="L399">            return Aero.LOC_FUSELAGE;</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_TANK)) {</span>
<span class="nc" id="L401">            return Tank.LOC_BODY;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L403">            return Protomech.LOC_BODY;</span>
        }
<span class="nc" id="L405">        return Entity.LOC_NONE;</span>
    }

    private boolean hasMASC() {
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (getEntity() instanceof Mech) {</span>
<span class="nc" id="L410">            return ((Mech) getEntity()).hasMASC();</span>
        }
<span class="nc" id="L412">        return false;</span>
    }
    
    public String printShortMovement() {
<span class="nc" id="L416">        return &quot;Movement: &quot;</span>
<span class="nc" id="L417">                + Integer.toString(getEntity().getOriginalWalkMP())</span>
                + &quot;/&quot;
<span class="nc" id="L419">                + Integer.toString((int) Math.ceil(getEntity()</span>
<span class="nc" id="L420">                        .getOriginalWalkMP() * 1.5))</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                + (hasMASC() ? &quot;(&quot;</span>
<span class="nc" id="L422">                        + Integer.toString(getEntity().getOriginalWalkMP() * 2)</span>
<span class="nc" id="L423">                        + &quot;)&quot; : &quot;&quot;)</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">                + (getEntity().getOriginalJumpMP() != 0 ? &quot;/&quot;</span>
<span class="nc" id="L425">                        + Integer.toString(getEntity().getOriginalJumpMP())</span>
<span class="nc" id="L426">                        : &quot;&quot;) + &quot;\n&quot;;</span>
    }

    public String printWeightHeatSinks() {
<span class="nc" id="L430">        return StringUtil.makeLength(</span>
                &quot;Heat Sinks: &quot;
<span class="nc" id="L432">                        + Integer.toString(getCountHeatSinks())</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">                        + (hasDoubleHeatSinks() ? &quot; [&quot;</span>
<span class="nc" id="L434">                                + Integer.toString(2 * getCountHeatSinks())</span>
<span class="nc" id="L435">                                + &quot;]&quot; : &quot;&quot;), getPrintSize() - 5)</span>
<span class="nc" id="L436">                + TestEntity.makeWeightString(getWeightHeatSinks(), usesKgStandard()) + &quot;\n&quot;;</span>
    }

    public String printWeightEngine() {
<span class="nc bnc" id="L440" title="All 2 branches missed.">        return StringUtil.makeLength(&quot;Engine: &quot; + ((null != engine) ? engine.getEngineName() : &quot;---&quot;),</span>
<span class="nc" id="L441">                getPrintSize() - 5)</span>
<span class="nc" id="L442">                + TestEntity.makeWeightString(getWeightEngine(), usesKgStandard()) + &quot;\n&quot;;</span>
    }

    public double getWeightEngine() {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        return ((null != engine) ? engine.getWeightEngine(getEntity()) : 0);</span>
    }

    public String printWeightStructure() {
<span class="nc" id="L450">        return StringUtil.makeLength(</span>
                &quot;Structure: &quot;
<span class="nc" id="L452">                        + Integer.toString(getEntity().getTotalOInternal())</span>
<span class="nc" id="L453">                        + &quot; &quot; + structure.getShortName(), getPrintSize() - 5)</span>
<span class="nc" id="L454">                + TestEntity.makeWeightString(getWeightStructure(), usesKgStandard()) + &quot;\n&quot;;</span>
    }

    public double getWeightStructure() {
<span class="nc" id="L458">        return structure.getWeightStructure(getWeight(),</span>
<span class="nc" id="L459">                getWeightCeilingStructure());</span>
    }

    public String printWeightArmor() {
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (!getEntity().hasPatchworkArmor()) {</span>
<span class="nc" id="L464">            return StringUtil.makeLength(</span>
<span class="nc" id="L465">                    &quot;Armor: &quot; + Integer.toString(getTotalOArmor()) + &quot; &quot;</span>
<span class="nc" id="L466">                            + armor[0].getShortName(), getPrintSize() - 5)</span>
<span class="nc" id="L467">                    + TestEntity.makeWeightString(getWeightArmor(), usesKgStandard()) + &quot;\n&quot;;</span>
        } else {
<span class="nc" id="L469">            return StringUtil.makeLength(</span>
<span class="nc" id="L470">                    &quot;Armor: &quot; + Integer.toString(getTotalOArmor()) + &quot; &quot;</span>
<span class="nc" id="L471">                            + &quot;Patchwork&quot;, getPrintSize() - 5)</span>
<span class="nc" id="L472">                    + TestEntity.makeWeightString(getWeightArmor(), usesKgStandard()) + &quot;\n&quot;;</span>
        }

    }

    public double getWeightArmor() {
<span class="fc" id="L478">        return getEntity().getLabArmorTonnage();</span>
    }

    public double getWeightAllocatedArmor() {
<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (!getEntity().hasPatchworkArmor()) {</span>
<span class="nc" id="L483">            return (armor[0].getWeightArmor(getTotalOArmor(), getWeightCeilingArmor()));</span>
        } else {
<span class="nc" id="L485">            double armorWeight = 0;</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">            for (int i = 0; i &lt; armor.length; i++) {</span>
<span class="nc" id="L487">                int points = getEntity().getOArmor(i);</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                if (getEntity().hasRearArmor(i) &amp;&amp;</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                        (getEntity().getOArmor(i, true) &gt; 0)) {</span>
<span class="nc" id="L490">                    points += getEntity().getOArmor(i, true);</span>
                }
<span class="nc" id="L492">                armorWeight += armor[i].getRawWeightArmor(points);</span>
            }
<span class="nc" id="L494">            return TestEntity.ceilMaxHalf(armorWeight, getWeightCeilingArmor());</span>
        }
    }

    /**
     * Gives subclasses a chance to exclude certain misc equipment if it is accounted for in a different
     * category.
     *
     * @param misc The misc equipment type
     * @return     Whether to include the equipment in the misc equipment category
     * @see #getWeightMiscEquip()
     */
    protected boolean includeMiscEquip(MiscType misc) {
<span class="nc" id="L507">        return true;</span>
    }

    public double getWeightMiscEquip() {
<span class="fc" id="L511">        double weightSum = 0.0;</span>
<span class="pc bpc" id="L512" title="1 of 2 branches missed.">        for (Mounted m : getEntity().getMisc()) {</span>
<span class="nc" id="L513">            MiscType mt = (MiscType) m.getType();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">            if (!includeMiscEquip(mt)</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_STEEL)</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_COMPOSITE)</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_INDUSTRIAL_STRUCTURE)</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REINFORCED)</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS)</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS_PROTO)</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_LAMELLOR)</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_LIGHT_FERRO)</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAVY_FERRO)</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REACTIVE)</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REFLECTIVE)</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HARDENED_ARMOR)</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_PRIMITIVE_ARMOR)</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_COMMERCIAL_ARMOR)</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_INDUSTRIAL_ARMOR)</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAVY_INDUSTRIAL_ARMOR)</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ANTI_PENETRATIVE_ABLATIVE)</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAT_DISSIPATING)</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_IMPACT_RESISTANT)</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_BALLISTIC_REINFORCED)</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ELECTRIC_DISCHARGE_ARMOR)</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAT_SINK)</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {</span>
<span class="nc" id="L542">                continue;</span>
            }
<span class="nc" id="L544">            weightSum += m.getTonnage();</span>
<span class="nc" id="L545">        }</span>
<span class="fc" id="L546">        return weightSum;</span>
    }

    public StringBuffer printMiscEquip() {
<span class="nc" id="L550">        return printMiscEquip(new StringBuffer());</span>
    }

    public StringBuffer printMiscEquip(StringBuffer buff) {
<span class="nc" id="L554">        return printMiscEquip(buff, 20, getPrintSize());</span>
    }

    public StringBuffer printMiscEquip(StringBuffer buff, int posLoc,
            int posWeight) {
<span class="nc bnc" id="L559" title="All 2 branches missed.">        for (Mounted m : getEntity().getMisc()) {</span>
<span class="nc" id="L560">            MiscType mt = (MiscType) m.getType();</span>

<span class="nc bnc" id="L562" title="All 2 branches missed.">            if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L563">                continue;</span>
            }
<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (mt.hasFlag(MiscType.F_ENDO_COMPOSITE)</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_STEEL)</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REINFORCED)</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS)</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_FIBROUS_PROTO)</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_LIGHT_FERRO)</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_HEAVY_FERRO)</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REACTIVE)</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_REFLECTIVE)</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_FERRO_LAMELLOR)</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                    || mt.hasFlag(MiscType.F_INDUSTRIAL_STRUCTURE)) {</span>
<span class="nc" id="L577">                continue;</span>
            }

<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (m.getTonnage() == 0f) {</span>
<span class="nc" id="L581">                continue;</span>
            }

<span class="nc" id="L584">            buff.append(StringUtil.makeLength(m.getName(), 20));</span>
<span class="nc" id="L585">            buff.append(</span>
<span class="nc" id="L586">                    StringUtil.makeLength(getLocationAbbr(m.getLocation()),</span>
<span class="nc" id="L587">                            getPrintSize() - 5 - 20)).append(</span>
<span class="nc" id="L588">                    TestEntity.makeWeightString(m.getTonnage(), usesKgStandard()));</span>
<span class="nc" id="L589">            buff.append(&quot;\n&quot;);</span>
<span class="nc" id="L590">        }</span>
<span class="nc" id="L591">        return buff;</span>
    }

    public double getWeightWeapon() {
<span class="fc" id="L595">        double weight = 0.0;</span>
<span class="pc bpc" id="L596" title="1 of 2 branches missed.">        for (Mounted m : getEntity().getTotalWeaponList()) {</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">            if (m.isWeaponGroup()) {</span>
<span class="nc" id="L598">                continue;</span>
            }
<span class="nc" id="L600">            weight += m.getTonnage();</span>
<span class="nc" id="L601">        }</span>
<span class="fc" id="L602">        return weight;</span>
    }

    public StringBuffer printWeapon() {
<span class="nc" id="L606">        return printWeapon(new StringBuffer());</span>
    }

    public StringBuffer printWeapon(StringBuffer buff) {
<span class="nc" id="L610">        return printWeapon(buff, 20, getPrintSize());</span>
    }

    public StringBuffer printWeapon(StringBuffer buff, int posLoc, int posWeight) {
<span class="nc bnc" id="L614" title="All 2 branches missed.">        for (Mounted m : getEntity().getWeaponList()) {</span>
<span class="nc" id="L615">            WeaponType mt = (WeaponType) m.getType();</span>

            // Don't think this can happen, but ...
<span class="nc bnc" id="L618" title="All 2 branches missed.">            if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L619">                continue;</span>
            }

<span class="nc" id="L622">            buff.append(StringUtil.makeLength(mt.getName(), 20));</span>
<span class="nc" id="L623">            buff.append(</span>
<span class="nc" id="L624">                    StringUtil.makeLength(getLocationAbbr(m.getLocation()),</span>
<span class="nc" id="L625">                            getPrintSize() - 5 - 20))</span>
<span class="nc" id="L626">                    .append(TestEntity.makeWeightString(m.getTonnage(), usesKgStandard())).append(&quot;\n&quot;);</span>
<span class="nc" id="L627">        }</span>
<span class="nc" id="L628">        return buff;</span>
    }

    public double getWeightAmmo() {
<span class="nc" id="L632">        double weight = 0.0;</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">        for (Mounted m : getEntity().getAmmo()) {</span>

            // One Shot Ammo
<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L637">                continue;</span>
            }

            // Bombs on ASF don't count!
<span class="nc bnc" id="L641" title="All 4 branches missed.">            if ((getEntity() instanceof Aero) &amp;&amp; (m.getType() instanceof BombType)) {</span>
<span class="nc" id="L642">                continue;</span>
            }

<span class="nc" id="L645">            weight += m.getTonnage();</span>
<span class="nc" id="L646">        }</span>
<span class="nc" id="L647">        return weight;</span>
    }

    public abstract double getWeightPowerAmp();

    public StringBuffer printAmmo() {
<span class="nc" id="L653">        return printAmmo(new StringBuffer());</span>
    }

    public StringBuffer printAmmo(StringBuffer buff) {
<span class="nc" id="L657">        return printAmmo(buff, 20, getPrintSize());</span>
    }

    public StringBuffer printAmmo(StringBuffer buff, int posLoc, int posWeight) {
<span class="nc bnc" id="L661" title="All 2 branches missed.">        for (Mounted m : getEntity().getAmmo()) {</span>
<span class="nc" id="L662">            AmmoType mt = (AmmoType) m.getType();</span>

            // Don't think this can happen, but ...
<span class="nc bnc" id="L665" title="All 2 branches missed.">            if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L666">                continue;</span>
            }

<span class="nc" id="L669">            buff.append(StringUtil.makeLength(mt.getName(), 20));</span>
<span class="nc" id="L670">            buff.append(&quot; &quot;).append(</span>
<span class="nc" id="L671">                    StringUtil.makeLength(getLocationAbbr(m.getLocation()),</span>
<span class="nc" id="L672">                            getPrintSize() - 5 - 20))</span>
<span class="nc" id="L673">                    .append(TestEntity.makeWeightString(m.getTonnage(), usesKgStandard())).append(&quot;\n&quot;);</span>
<span class="nc" id="L674">        }</span>
<span class="nc" id="L675">        return buff;</span>
    }

    public String printLocations() {
<span class="nc" id="L679">        StringBuffer buff = new StringBuffer();</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">        for (int i = 0; i &lt; getEntity().locations(); i++) {</span>
<span class="nc" id="L681">            String locationName = getEntity().getLocationName(i);</span>
<span class="nc" id="L682">            buff.append(locationName + &quot;:&quot;);</span>
<span class="nc" id="L683">            buff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">            for (int j = 0; j &lt; getEntity().getNumberOfCriticals(i); j++) {</span>
<span class="nc" id="L685">                CriticalSlot slot = getEntity().getCritical(i, j);</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">                if (slot == null) {</span>
<span class="nc" id="L687">                    buff.append(Integer.toString(j) + &quot;. -Emtpy-&quot;);</span>
<span class="nc" id="L688">                    buff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">                } else if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                    if (isMech()) {</span>
<span class="nc" id="L691">                        buff.append(Integer.toString(j));</span>
<span class="nc" id="L692">                        buff.append(&quot;. &quot;);</span>
<span class="nc" id="L693">                        buff.append(((Mech) getEntity()).getSystemName(slot</span>
<span class="nc" id="L694">                                .getIndex()));</span>
<span class="nc" id="L695">                        buff.append(&quot;\n&quot;);</span>
                    } else {
<span class="nc" id="L697">                        buff.append(Integer.toString(j)</span>
                                + &quot;. UNKNOWN SYSTEM NAME&quot;);
<span class="nc" id="L699">                        buff.append(&quot;\n&quot;);</span>
                    }
<span class="nc bnc" id="L701" title="All 2 branches missed.">                } else if (slot.getType() == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L702">                    EquipmentType e = getEntity().getEquipmentType(slot);</span>
<span class="nc" id="L703">                    buff.append(Integer.toString(j) + &quot;. &quot;</span>
<span class="nc" id="L704">                            + e.getInternalName());</span>
<span class="nc" id="L705">                    buff.append(&quot;\n&quot;);</span>
                }
            }
        }
<span class="nc" id="L709">        return buff.toString();</span>
    }

    public int calcMiscCrits(MiscType mt, double size) {
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                &amp;&amp; (mt.hasSubType(MiscType.S_HATCHET)</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">                        || mt.hasSubType(MiscType.S_SWORD)</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                        || mt.hasSubType(MiscType.S_CHAIN_WHIP) || mt</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                            .hasSubType(MiscType.S_MACE_THB))) {</span>
<span class="nc" id="L718">            return (int) Math.ceil(getWeight() / 15.0);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                &amp;&amp; mt.hasSubType(MiscType.S_MACE)) {</span>
<span class="nc" id="L721">            return (int) Math.ceil(getWeight() / 10.0);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                &amp;&amp; mt.hasSubType(MiscType.S_RETRACTABLE_BLADE)) {</span>
<span class="nc" id="L724">            return 1 + (int) Math.ceil(getWeight() / 20.0);</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                &amp;&amp; mt.hasSubType(MiscType.S_PILE_DRIVER)) {</span>
<span class="nc" id="L727">            return 8;</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                &amp;&amp; mt.hasSubType(MiscType.S_CHAINSAW)) {</span>
<span class="nc" id="L730">            return 5;</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">                &amp;&amp; mt.hasSubType(MiscType.S_DUAL_SAW)) {</span>
<span class="nc" id="L733">            return 7;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                &amp;&amp; mt.hasSubType(MiscType.S_BACKHOE)) {</span>
<span class="nc" id="L736">            return 6;</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_MASC)) {</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">            if (mt.getInternalName().equals(&quot;ISMASC&quot;)) {</span>
<span class="nc" id="L739">                return (int) Math.round(getWeight() / 20.0);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">            } else if (mt.getInternalName().equals(&quot;CLMASC&quot;)) {</span>
<span class="nc" id="L741">                return (int) Math.round(getWeight() / 25.0);</span>
            }
<span class="nc bnc" id="L743" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_TARGCOMP)) {</span>
<span class="nc" id="L744">            double fTons = 0.0f;</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">            for (Mounted mo : getEntity().getWeaponList()) {</span>
<span class="nc" id="L746">                WeaponType wt = (WeaponType) mo.getType();</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">                if (wt.hasFlag(WeaponType.F_DIRECT_FIRE)) {</span>
<span class="nc" id="L748">                    fTons += mo.getTonnage();</span>
                }
<span class="nc" id="L750">            }</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            for (Mounted mo : getEntity().getMisc()) {</span>
<span class="nc" id="L752">                MiscType mt2 = (MiscType) mo.getType();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">                if (mt2.hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L754">                    fTons += mo.getTonnage();</span>
                }
<span class="nc" id="L756">            }</span>
<span class="nc" id="L757">            double weight = 0.0f;</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (mt.getInternalName().equals(&quot;ISTargeting Computer&quot;)) {</span>
<span class="nc" id="L759">                weight = TestEntity.ceil(fTons / 4.0f,</span>
<span class="nc" id="L760">                        getWeightCeilingTargComp());</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">            } else if (mt.getInternalName().equals(&quot;CLTargeting Computer&quot;)) {</span>
<span class="nc" id="L762">                weight = TestEntity.ceil(fTons / 5.0f,</span>
<span class="nc" id="L763">                        getWeightCeilingTargComp());</span>
            }
<span class="nc bnc" id="L765" title="All 4 branches missed.">            switch (getTargCompCrits()) {</span>
                case CEIL_TARGCOMP_CRITS:
<span class="nc" id="L767">                    return (int) Math.ceil(weight);</span>
                case ROUND_TARGCOMP_CRITS:
<span class="nc" id="L769">                    return (int) Math.round(weight);</span>
                case FLOOR_TARGCOMP_CRITS:
<span class="nc" id="L771">                    return (int) Math.floor(weight);</span>
            }
<span class="nc" id="L773">        } else if (EquipmentType.getArmorTypeName(</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">                EquipmentType.T_ARMOR_FERRO_FIBROUS).equals(</span>
<span class="nc" id="L775">                mt.getInternalName())) {</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">            if (isClanArmor()) {</span>
<span class="nc" id="L777">                return 7;</span>
            }
<span class="nc" id="L779">            return 14;</span>
<span class="nc" id="L780">        } else if (EquipmentType.getArmorTypeName(</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">                EquipmentType.T_ARMOR_FERRO_FIBROUS_PROTO).equals(</span>
<span class="nc" id="L782">                mt.getInternalName())) {</span>
<span class="nc" id="L783">            return 16;</span>
<span class="nc" id="L784">        } else if (EquipmentType.getArmorTypeName(</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">                EquipmentType.T_ARMOR_LIGHT_FERRO).equals(mt.getInternalName())) {</span>
<span class="nc" id="L786">            return 7;</span>
<span class="nc" id="L787">        } else if (EquipmentType.getArmorTypeName(</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                EquipmentType.T_ARMOR_HEAVY_FERRO).equals(mt.getInternalName())) {</span>
<span class="nc" id="L789">            return 21;</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_ENDO_STEEL)) {</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">            if (isClan()</span>
<span class="nc" id="L792">                    || mt.getInternalName()</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                            .equals(&quot;Clan &quot;</span>
                                    + EquipmentType
<span class="nc" id="L795">                                            .getStructureTypeName(EquipmentType.T_STRUCTURE_ENDO_STEEL))) {</span>
<span class="nc" id="L796">                return 7;</span>
            }
<span class="nc" id="L798">            return 14;</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_ENDO_STEEL_PROTO)) {</span>
<span class="nc" id="L800">            return 16;</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_ENDO_COMPOSITE)) {</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">            if (isClan()</span>
<span class="nc" id="L803">                    || mt.getInternalName()</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">                            .equals(&quot;Clan &quot;</span>
                                    + EquipmentType
<span class="nc" id="L806">                                            .getStructureTypeName(EquipmentType.T_STRUCTURE_ENDO_COMPOSITE))) {</span>
<span class="nc" id="L807">                return 4;</span>
            }
<span class="nc" id="L809">            return 7;</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">            if (isClanArmor()) {</span>
<span class="nc" id="L812">                return 7;</span>
            }
<span class="nc" id="L814">            return 14;</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">        } else if (mt.hasFlag(MiscType.F_REFLECTIVE)) {</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">            if (isClanArmor()) {</span>
<span class="nc" id="L817">                return 5;</span>
            }
<span class="nc" id="L819">            return 10;</span>
        }
<span class="nc" id="L821">        return mt.getCriticals(getEntity(), size);</span>
    }

    /**
     * Computes heat sink requirement for heat-neutral units (vehicles, conventional fighters,
     * protomechs). This is a total of energy weapons that don't use ammo and some other miscellaneous
     * equipment.
     * 
     * @return The number of heat sinks required in construction
     */
    protected int heatNeutralHSRequirement() {
<span class="fc" id="L832">        return calcHeatNeutralHSRequirement(getEntity());</span>
    }

    /**
     * Computes heat sink requirement for heat-neutral units (vehicles, conventional fighters,
     * protomechs). This is a total of energy weapons that don't use ammo and some other miscellaneous
     * equipment.
     *
     * @return The number of heat sinks required in construction
     */
    public static int calcHeatNeutralHSRequirement(Entity entity) {
<span class="fc" id="L843">        int heat = 0;</span>
<span class="fc bfc" id="L844" title="All 2 branches covered.">        for (Mounted m : entity.getWeaponList()) {</span>
<span class="fc" id="L845">            WeaponType wt = (WeaponType) m.getType();</span>
<span class="pc bpc" id="L846" title="1 of 4 branches missed.">            if ((wt.hasFlag(WeaponType.F_LASER) &amp;&amp; (wt.getAmmoType() == AmmoType.T_NA))</span>
<span class="pc bpc" id="L847" title="1 of 2 branches missed.">                    || wt.hasFlag(WeaponType.F_PPC)</span>
<span class="pc bpc" id="L848" title="1 of 2 branches missed.">                    || wt.hasFlag(WeaponType.F_PLASMA)</span>
<span class="pc bpc" id="L849" title="1 of 2 branches missed.">                    || wt.hasFlag(WeaponType.F_PLASMA_MFUK)</span>
<span class="pc bpc" id="L850" title="3 of 4 branches missed.">                    || (wt.hasFlag(WeaponType.F_FLAMER) &amp;&amp; (wt.getAmmoType() == AmmoType.T_NA))) {</span>
<span class="fc" id="L851">                heat += wt.getHeat();</span>
            }
            // laser insulator reduce heat by 1, to a minimum of 1
<span class="pc bpc" id="L854" title="1 of 4 branches missed.">            if (wt.hasFlag(WeaponType.F_LASER) &amp;&amp; (m.getLinkedBy() != null)</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">                    &amp;&amp; !m.getLinkedBy().isInoperable()</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">                    &amp;&amp; m.getLinkedBy().getType().hasFlag(MiscType.F_LASER_INSULATOR)) {</span>
<span class="nc" id="L857">                heat -= 1;</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                if (heat == 0) {</span>
<span class="nc" id="L859">                    heat++;</span>
                }
            }

<span class="pc bpc" id="L863" title="3 of 4 branches missed.">            if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof</span>
<span class="nc" id="L864">                    MiscType) &amp;&amp; m.getLinkedBy().getType().</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">                    hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc" id="L866">                heat += 5;</span>
            }
<span class="fc" id="L868">        }</span>
<span class="pc bpc" id="L869" title="1 of 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
            // Spot welders are treated as energy weapons on units that don't have a fusion or fission engine
<span class="nc bnc" id="L871" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; m.getType().hasSubType(MiscType.S_SPOT_WELDER)</span>
<span class="nc bnc" id="L872" title="All 4 branches missed.">                &amp;&amp; entity.hasEngine() &amp;&amp; (entity.getEngine().isFusion()</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">                                                || (entity.getEngine().getEngineType() == Engine.FISSION))) {</span>
<span class="nc" id="L874">                continue;</span>
            }
<span class="nc" id="L876">            heat += m.getType().getHeat();</span>
<span class="nc" id="L877">        }</span>
<span class="pc bpc" id="L878" title="1 of 2 branches missed.">        if (entity.hasStealth()) {</span>
<span class="nc" id="L879">            heat += 10;</span>
        }
<span class="fc" id="L881">        return heat;</span>
    }

    public double calculateWeight() {
<span class="fc" id="L885">        double weight = 0;</span>
<span class="fc" id="L886">        weight += getWeightEngine();</span>
<span class="fc" id="L887">        weight += getWeightStructure();</span>
<span class="fc" id="L888">        weight += getWeightControls();</span>
<span class="fc" id="L889">        weight += getWeightHeatSinks();</span>
<span class="fc" id="L890">        weight += getWeightArmor();</span>
<span class="fc" id="L891">        weight += getWeightMisc();</span>

<span class="fc" id="L893">        weight += getWeightMiscEquip();</span>
<span class="fc" id="L894">        weight += getWeightWeapon();</span>
<span class="fc" id="L895">        weight += getWeightAmmo();</span>
<span class="fc" id="L896">        weight += getWeightPowerAmp();</span>

<span class="fc" id="L898">        weight += getWeightCarryingSpace();</span>

<span class="fc" id="L900">        weight += getArmoredComponentWeight();</span>
        // If the unit used kg standard, we just need to get rid of floating-point math anomalies.
        // Otherwise accumulated kg-scale equipment needs to be rounded up to the nearest half-ton.
<span class="fc" id="L903">        weight = round(weight, Ceil.KILO);</span>
<span class="pc bpc" id="L904" title="1 of 2 branches missed.">        if (usesKgStandard()) {</span>
<span class="nc" id="L905">            return weight;</span>
        } else {
<span class="fc" id="L907">            return ceil(weight, Ceil.HALFTON);</span>
        }
    }

    public String printWeightCalculation() {
<span class="nc" id="L912">        return printWeightEngine() + printWeightStructure()</span>
<span class="nc" id="L913">                + printWeightControls() + printWeightHeatSinks()</span>
<span class="nc" id="L914">                + printWeightArmor() + printWeightMisc()</span>
<span class="nc" id="L915">                + printWeightCarryingSpace() + &quot;Equipment:\n&quot;</span>
<span class="nc" id="L916">                + printMiscEquip() + printWeapon() + printAmmo();</span>
    }

    public boolean correctWeight(StringBuffer buff) {
<span class="fc" id="L920">        return correctWeight(buff, showOverweightedEntity(),</span>
<span class="fc" id="L921">                showUnderweightedEntity());</span>
    }

    public boolean correctWeight(StringBuffer buff, boolean showO, boolean showU) {
<span class="fc" id="L925">        double weightSum = calculateWeight();</span>
<span class="fc" id="L926">        double weight = getWeight();</span>

<span class="pc bpc" id="L928" title="1 of 4 branches missed.">        if (showO &amp;&amp; ((weight + getMaxOverweight()) &lt; weightSum)) {</span>
<span class="fc" id="L929">            buff.append(&quot;Weight: &quot;).append(calculateWeight())</span>
<span class="fc" id="L930">                    .append(&quot; is greater than &quot;).append(getWeight())</span>
<span class="fc" id="L931">                    .append(&quot;\n&quot;);</span>
            // buff.append(printWeightCalculation()).append(&quot;\n&quot;);
<span class="fc" id="L933">            return false;</span>
        }
<span class="pc bpc" id="L935" title="3 of 4 branches missed.">        if (showU &amp;&amp; ((weight - getMinUnderweight()) &gt; weightSum)) {</span>
<span class="nc" id="L936">            buff.append(&quot;Weight: &quot;).append(calculateWeight())</span>
<span class="nc" id="L937">                    .append(&quot; is less than &quot;).append(getWeight()).append(&quot;\n&quot;);</span>
            // buff.append(printWeightCalculation()).append(&quot;\n&quot;);
<span class="nc" id="L939">            return false;</span>
        }
<span class="fc" id="L941">        return true;</span>
    }

    public boolean hasIllegalTechLevels(StringBuffer buff) {
<span class="nc" id="L945">        return hasIllegalTechLevels(buff, getEntity().getTechLevel());</span>
    }

    public boolean hasIllegalTechLevels(StringBuffer buff, int ammoTechLvl) {
        /* A large number of units have official tech levels lower than their components at the
         * intro date. We test instead whether the stated tech level is ever possible based on the
         * equipment. We also test for mixed IS/Clan tech in units that are not designated as mixed.
         */
<span class="nc" id="L953">        boolean retVal = false;</span>
<span class="nc" id="L954">        int eTechLevel = SimpleTechLevel.convertCompoundToSimple(getEntity().getTechLevel()).ordinal();</span>
<span class="nc" id="L955">        int ammoRulesLevel = SimpleTechLevel.convertCompoundToSimple(ammoTechLvl).ordinal();</span>
<span class="nc" id="L956">        int eRulesLevel = getEntity().findMinimumRulesLevel().ordinal();</span>
<span class="nc bnc" id="L957" title="All 4 branches missed.">        if ((eTechLevel &gt;= eRulesLevel) &amp;&amp; (getEntity().getEarliestTechDate() &lt;= getEntity().getYear())) {</span>
<span class="nc" id="L958">            return false;</span>
        }
        
<span class="nc" id="L961">        int eTLYear = getEntity().getTechLevelYear();</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">        for (Mounted mounted : getEntity().getEquipment()) {</span>
<span class="nc" id="L963">            EquipmentType nextE = mounted.getType();</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">            int eqRulesLevel = getEntity().isMixedTech()?</span>
<span class="nc" id="L965">                    nextE.findMinimumRulesLevel().ordinal() : nextE.findMinimumRulesLevel(getEntity().isClan()).ordinal();</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">            boolean illegal = eqRulesLevel &gt; eRulesLevel;</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">            if (!getEntity().isMixedTech()) {</span>
<span class="nc bnc" id="L968" title="All 4 branches missed.">                illegal |= getEntity().isClan() &amp;&amp; nextE.getTechBase() == ITechnology.TECH_BASE_IS;</span>
<span class="nc bnc" id="L969" title="All 4 branches missed.">                illegal |= !getEntity().isClan() &amp;&amp; nextE.getTechBase() == ITechnology.TECH_BASE_CLAN;</span>
            }
<span class="nc" id="L971">            int eqTechLevel = TechConstants.convertFromSimplelevel(eqRulesLevel, nextE.isClan());</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">            if (nextE instanceof AmmoType) {</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">                if (eqRulesLevel &gt; ammoRulesLevel) {</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                    if (!retVal) {</span>
<span class="nc" id="L975">                        buff.append(&quot;Ammo illegal at unit's tech level (&quot;);</span>
<span class="nc" id="L976">                        buff.append(TechConstants</span>
<span class="nc" id="L977">                                .getLevelDisplayableName(ammoTechLvl));</span>
<span class="nc" id="L978">                        buff.append(&quot;, &quot;);</span>
<span class="nc" id="L979">                        buff.append(eTLYear);</span>
<span class="nc" id="L980">                        buff.append(&quot;):\n&quot;);</span>
                    }
<span class="nc" id="L982">                    retVal = true;</span>
<span class="nc" id="L983">                    buff.append(nextE.getName());</span>
<span class="nc" id="L984">                    buff.append(&quot;, (&quot;);</span>
<span class="nc" id="L985">                    buff.append(TechConstants</span>
<span class="nc" id="L986">                            .getLevelDisplayableName(eqTechLevel));</span>
<span class="nc" id="L987">                    buff.append(&quot;)\n&quot;);</span>
                }
<span class="nc bnc" id="L989" title="All 2 branches missed.">            } else if (illegal) {</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">                if (!retVal) {</span>
<span class="nc" id="L991">                    buff.append(&quot;Equipment illegal at unit's tech level &quot;);</span>
<span class="nc" id="L992">                    buff.append(TechConstants</span>
<span class="nc" id="L993">                            .getLevelDisplayableName(ammoTechLvl));</span>
<span class="nc" id="L994">                    buff.append(&quot;, &quot;);</span>
<span class="nc" id="L995">                    buff.append(eTLYear);</span>
<span class="nc" id="L996">                    buff.append(&quot;):\n&quot;);</span>
                }
<span class="nc" id="L998">                retVal = true;</span>
<span class="nc" id="L999">                buff.append(nextE.getName());</span>
<span class="nc" id="L1000">                buff.append(&quot;, (&quot;);</span>
<span class="nc" id="L1001">                buff.append(TechConstants</span>
<span class="nc" id="L1002">                        .getLevelDisplayableName(eqTechLevel));</span>
<span class="nc" id="L1003">                buff.append(&quot;)\n&quot;);</span>
            }
<span class="nc" id="L1005">        }</span>
        // Check cockpit TL
<span class="nc" id="L1007">        ITechnology cockpit = null;</span>
<span class="nc" id="L1008">        String cockpitName = null;</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">        if (getEntity().getEntityType() == Entity.ETYPE_AERO) {</span>
<span class="nc" id="L1010">            cockpit = ((Aero)getEntity()).getCockpitTechAdvancement();</span>
<span class="nc" id="L1011">            cockpitName = ((Aero)getEntity()).getCockpitTypeString();</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">        } else if (getEntity() instanceof Mech) {</span>
<span class="nc" id="L1013">            cockpit = ((Mech)getEntity()).getCockpitTechAdvancement();</span>
<span class="nc" id="L1014">            cockpitName = ((Mech)getEntity()).getCockpitTypeString();</span>
        }
<span class="nc bnc" id="L1016" title="All 2 branches missed.">        if (cockpit != null) {</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">            int eqRulesLevel = getEntity().isMixedTech()?</span>
<span class="nc" id="L1018">                    cockpit.findMinimumRulesLevel().ordinal() : cockpit.findMinimumRulesLevel(getEntity().isClan()).ordinal();</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">            boolean illegal = eqRulesLevel &gt; eRulesLevel;</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            if (!getEntity().isMixedTech()) {</span>
<span class="nc bnc" id="L1021" title="All 4 branches missed.">                illegal |= getEntity().isClan() &amp;&amp; cockpit.getTechBase() == ITechnology.TECH_BASE_IS;</span>
<span class="nc bnc" id="L1022" title="All 4 branches missed.">                illegal |= !getEntity().isClan() &amp;&amp; cockpit.getTechBase() == ITechnology.TECH_BASE_CLAN;                </span>
            }
<span class="nc bnc" id="L1024" title="All 2 branches missed.">            if (illegal) {</span>
<span class="nc" id="L1025">                buff.append(&quot;Cockpit is illegal at unit's tech level (&quot;);</span>
<span class="nc" id="L1026">                buff.append(TechConstants</span>
<span class="nc" id="L1027">                        .getLevelDisplayableName(eTechLevel));</span>
<span class="nc" id="L1028">                buff.append(&quot;, &quot;);</span>
<span class="nc" id="L1029">                buff.append(eTLYear);</span>
<span class="nc" id="L1030">                buff.append(&quot;): &quot;);</span>
<span class="nc" id="L1031">                buff.append(cockpitName);</span>
<span class="nc" id="L1032">                buff.append(&quot; (&quot;);</span>
<span class="nc" id="L1033">                buff.append(TechConstants</span>
<span class="nc" id="L1034">                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel, cockpit.isClan())));</span>
<span class="nc" id="L1035">                buff.append(&quot;)\n&quot;);</span>
<span class="nc" id="L1036">                retVal = true;</span>
            }
        }
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        if (getEntity() instanceof Mech) {</span>
<span class="nc" id="L1040">            ITechnology gyro = ((Mech)getEntity()).getGyroTechAdvancement();</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">            if (gyro != null) {</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">                int eqRulesLevel = getEntity().isMixedTech()?</span>
<span class="nc" id="L1043">                        gyro.findMinimumRulesLevel().ordinal() : gyro.findMinimumRulesLevel(getEntity().isClan()).ordinal();</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">                boolean illegal = eqRulesLevel &gt; eRulesLevel;</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">                if (!getEntity().isMixedTech()) {</span>
<span class="nc bnc" id="L1046" title="All 4 branches missed.">                    illegal |= getEntity().isClan() &amp;&amp; gyro.getTechBase() == ITechnology.TECH_BASE_IS;</span>
<span class="nc bnc" id="L1047" title="All 4 branches missed.">                    illegal |= !getEntity().isClan() &amp;&amp; gyro.getTechBase() == ITechnology.TECH_BASE_CLAN;                </span>
                }
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                if (illegal) {</span>
<span class="nc" id="L1050">                    buff.append(&quot;Gyro is illegal at unit's tech level (&quot;);</span>
<span class="nc" id="L1051">                    buff.append(TechConstants</span>
<span class="nc" id="L1052">                            .getLevelDisplayableName(eTechLevel));</span>
<span class="nc" id="L1053">                    buff.append(&quot;, &quot;);</span>
<span class="nc" id="L1054">                    buff.append(eTLYear);</span>
<span class="nc" id="L1055">                    buff.append(&quot;): &quot;);</span>
<span class="nc" id="L1056">                    buff.append(((Mech)getEntity()).getGyroTypeString());</span>
<span class="nc" id="L1057">                    buff.append(&quot; (&quot;);</span>
<span class="nc" id="L1058">                    buff.append(TechConstants</span>
<span class="nc" id="L1059">                            .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</span>
<span class="nc" id="L1060">                                    gyro.isClan())));</span>
<span class="nc" id="L1061">                    buff.append(&quot;)\n&quot;);</span>
<span class="nc" id="L1062">                    retVal = true;</span>
                }
            }
        }
<span class="nc bnc" id="L1066" title="All 2 branches missed.">        if (getEntity().hasEngine()) {</span>
<span class="nc" id="L1067">            ITechnology engine = getEntity().getEngine().getTechAdvancement();</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">            int eqRulesLevel = getEntity().isMixedTech()?</span>
<span class="nc" id="L1069">                    engine.findMinimumRulesLevel().ordinal() : engine.findMinimumRulesLevel(getEntity().isClan()).ordinal();</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">            boolean illegal = eqRulesLevel &gt; eRulesLevel;</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">            if (!getEntity().isMixedTech()) {</span>
<span class="nc bnc" id="L1072" title="All 4 branches missed.">                illegal |= getEntity().isClan() &amp;&amp; engine.getTechBase() == ITechnology.TECH_BASE_IS;</span>
<span class="nc bnc" id="L1073" title="All 4 branches missed.">                illegal |= !getEntity().isClan() &amp;&amp; engine.getTechBase() == ITechnology.TECH_BASE_CLAN;                </span>
            }
<span class="nc bnc" id="L1075" title="All 2 branches missed.">            if (illegal) {</span>
<span class="nc" id="L1076">                buff.append(&quot;Engine is illegal at unit's tech level (&quot;);</span>
<span class="nc" id="L1077">                buff.append(TechConstants</span>
<span class="nc" id="L1078">                        .getLevelDisplayableName(eTechLevel));</span>
<span class="nc" id="L1079">                buff.append(&quot;, &quot;);</span>
<span class="nc" id="L1080">                buff.append(eTLYear);</span>
<span class="nc" id="L1081">                buff.append(&quot;): &quot;);</span>
<span class="nc" id="L1082">                buff.append(getEntity().getEngine().getShortEngineName());</span>
<span class="nc" id="L1083">                buff.append(&quot; (&quot;);</span>
<span class="nc" id="L1084">                buff.append(TechConstants</span>
<span class="nc" id="L1085">                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</span>
<span class="nc" id="L1086">                                engine.isClan())));</span>
<span class="nc" id="L1087">                buff.append(&quot;)\n&quot;);</span>
<span class="nc" id="L1088">                buff.append(&quot;\n&quot;);</span>
<span class="nc" id="L1089">                retVal = true;</span>
            }
        }
        Set&lt;String&gt; armors;
<span class="nc bnc" id="L1093" title="All 2 branches missed.">        if (!getEntity().hasPatchworkArmor()) {</span>
<span class="nc" id="L1094">            armors = Collections.singleton(EquipmentType.getArmorTypeName(getEntity().getArmorType(1),</span>
<span class="nc" id="L1095">                    TechConstants.isClan(getEntity().getArmorTechLevel(1))));</span>
        } else {
<span class="nc bnc" id="L1097" title="All 2 branches missed.">            int eqRulesLevel = getEntity().isMixedTech()?</span>
<span class="nc" id="L1098">                    Entity.getPatchworkArmorAdvancement().findMinimumRulesLevel().ordinal() :</span>
<span class="nc" id="L1099">                        Entity.getPatchworkArmorAdvancement().findMinimumRulesLevel(getEntity().isClan()).ordinal();</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">            if (eqRulesLevel &gt; eRulesLevel) {</span>
<span class="nc" id="L1101">                buff.append(&quot;Armor is illegal at unit's tech level (&quot;);</span>
<span class="nc" id="L1102">                buff.append(TechConstants</span>
<span class="nc" id="L1103">                        .getLevelDisplayableName(eTechLevel));</span>
<span class="nc" id="L1104">                buff.append(&quot;, &quot;);</span>
<span class="nc" id="L1105">                buff.append(eTLYear);</span>
<span class="nc" id="L1106">                buff.append(&quot;): Patchwork (&quot;);</span>
<span class="nc" id="L1107">                buff.append(TechConstants</span>
<span class="nc" id="L1108">                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</span>
<span class="nc" id="L1109">                                getEntity().isClan())));</span>
<span class="nc" id="L1110">                buff.append(&quot;)\n&quot;);</span>
<span class="nc" id="L1111">                buff.append(&quot;\n&quot;);</span>
<span class="nc" id="L1112">                retVal = true;</span>
            }
            
<span class="nc" id="L1115">            armors = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            for (int loc = 0; loc &lt; getEntity().locations(); loc++) {</span>
<span class="nc" id="L1117">                armors.add(EquipmentType.getArmorTypeName(getEntity().getArmorType(loc),</span>
<span class="nc" id="L1118">                        TechConstants.isClan(getEntity().getArmorTechLevel(loc))));</span>
            }
        }
<span class="nc bnc" id="L1121" title="All 2 branches missed.">        for (String atName : armors) {</span>
<span class="nc" id="L1122">            EquipmentType at = EquipmentType.get(atName);</span>
            // Can be null in the case of vehicle body or asf wings.   
<span class="nc bnc" id="L1124" title="All 2 branches missed.">            if (null ==  at) {</span>
<span class="nc" id="L1125">                continue;</span>
            }
<span class="nc bnc" id="L1127" title="All 2 branches missed.">            int eqRulesLevel = getEntity().isMixedTech()?</span>
<span class="nc" id="L1128">                    at.findMinimumRulesLevel().ordinal() : at.findMinimumRulesLevel(getEntity().isClan()).ordinal();</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">            boolean illegal = eqRulesLevel &gt; eRulesLevel;</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">            if (!getEntity().isMixedTech()) {</span>
<span class="nc bnc" id="L1131" title="All 4 branches missed.">                illegal |= getEntity().isClan() &amp;&amp; at.getTechBase() == ITechnology.TECH_BASE_IS;</span>
<span class="nc bnc" id="L1132" title="All 4 branches missed.">                illegal |= !getEntity().isClan() &amp;&amp; at.getTechBase() == ITechnology.TECH_BASE_CLAN;                </span>
            }
<span class="nc bnc" id="L1134" title="All 2 branches missed.">            if (illegal) {</span>
<span class="nc" id="L1135">                buff.append(&quot;Armor is illegal at unit's tech level (&quot;);</span>
<span class="nc" id="L1136">                buff.append(TechConstants</span>
<span class="nc" id="L1137">                        .getLevelDisplayableName(eTechLevel));</span>
<span class="nc" id="L1138">                buff.append(&quot;, &quot;);</span>
<span class="nc" id="L1139">                buff.append(eTLYear);</span>
<span class="nc" id="L1140">                buff.append(&quot;): &quot;);</span>
<span class="nc" id="L1141">                buff.append(atName);</span>
<span class="nc" id="L1142">                buff.append(&quot; (&quot;);</span>
<span class="nc" id="L1143">                buff.append(TechConstants</span>
<span class="nc" id="L1144">                        .getLevelDisplayableName(TechConstants.convertFromSimplelevel(eqRulesLevel,</span>
<span class="nc" id="L1145">                                at.isClan())));</span>
<span class="nc" id="L1146">                buff.append(&quot;)\n&quot;);</span>
<span class="nc" id="L1147">                buff.append(&quot;\n&quot;);</span>
<span class="nc" id="L1148">                retVal = true;</span>
            }
<span class="nc" id="L1150">        }</span>

<span class="nc" id="L1152">        return retVal;</span>
    }

    /**
     * Compares intro dates of all components to the unit intro year.
     * 
     * @param buff Descriptions of problems will be added to the buffer.
     * @return     Whether the unit has an intro year equal to or later than all the components.
     */
    public boolean hasIncorrectIntroYear(StringBuffer buff) {
<span class="nc" id="L1162">        boolean retVal = false;</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">        if (getEntity().getEarliestTechDate() &lt;= getEntity().getYear() + getIntroYearMargin()) {</span>
<span class="nc" id="L1164">            return false;</span>
        }
<span class="nc" id="L1166">        int useIntroYear = getEntity().getYear() + getIntroYearMargin();</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (getEntity().isOmni()) {</span>
<span class="nc" id="L1168">            int introDate = Entity.getOmniAdvancement(getEntity())</span>
<span class="nc bnc" id="L1169" title="All 4 branches missed.">                    .getIntroductionDate(getEntity().isClan() || getEntity().isMixedTech());</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">            if (useIntroYear &lt; introDate) {</span>
<span class="nc" id="L1171">                retVal = true;</span>
<span class="nc" id="L1172">                buff.append(&quot;Omni technology has intro date of &quot;);</span>
<span class="nc" id="L1173">                buff.append(introDate);</span>
<span class="nc" id="L1174">                buff.append(&quot;\n&quot;);</span>
            }
        }
<span class="nc" id="L1177">        Set&lt;EquipmentType&gt; checked = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">        for (Mounted mounted : getEntity().getEquipment()) {</span>
<span class="nc" id="L1179">            final EquipmentType nextE = mounted.getType();</span>
<span class="nc bnc" id="L1180" title="All 4 branches missed.">            if (checked.contains(nextE) || (nextE instanceof AmmoType)) {</span>
<span class="nc" id="L1181">                continue;</span>
            }
<span class="nc" id="L1183">            checked.add(nextE);</span>
<span class="nc" id="L1184">            int introDate = nextE.getIntroductionDate(getEntity().isClan());</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">            if (getEntity().isMixedTech()) {</span>
<span class="nc" id="L1186">                introDate = nextE.getIntroductionDate();</span>
            }
<span class="nc bnc" id="L1188" title="All 2 branches missed.">            if (introDate &gt; useIntroYear) {</span>
<span class="nc" id="L1189">                retVal = true;</span>
<span class="nc" id="L1190">                buff.append(nextE.getName());</span>
<span class="nc" id="L1191">                buff.append(&quot; has intro date of &quot;);</span>
<span class="nc" id="L1192">                buff.append(introDate);</span>
<span class="nc" id="L1193">                buff.append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L1195">        }</span>
        Set&lt;String&gt; armors;
<span class="nc bnc" id="L1197" title="All 2 branches missed.">        if (!getEntity().hasPatchworkArmor()) {</span>
<span class="nc" id="L1198">            armors = Collections.singleton(EquipmentType.getArmorTypeName(getEntity().getArmorType(1),</span>
<span class="nc" id="L1199">                    TechConstants.isClan(getEntity().getArmorTechLevel(1))));</span>
        } else {
<span class="nc bnc" id="L1201" title="All 2 branches missed.">            int intro = getEntity().isMixedTech()?</span>
<span class="nc" id="L1202">                    Entity.getPatchworkArmorAdvancement().getIntroductionDate() :</span>
<span class="nc" id="L1203">                        Entity.getPatchworkArmorAdvancement().getIntroductionDate(getEntity().isClan());</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">            if (useIntroYear &lt; intro) {</span>
<span class="nc" id="L1205">                retVal = true;</span>
<span class="nc" id="L1206">                buff.append(&quot;Patchwork armor has intro date of &quot;);</span>
<span class="nc" id="L1207">                buff.append(intro);</span>
<span class="nc" id="L1208">                buff.append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L1210">            armors = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">            for (int loc = 0; loc &lt; getEntity().locations(); loc++) {</span>
<span class="nc" id="L1212">                armors.add(EquipmentType.getArmorTypeName(getEntity().getArmorType(loc),</span>
<span class="nc" id="L1213">                        TechConstants.isClan(getEntity().getArmorTechLevel(loc))));</span>
            }
        }
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        for (String atName : armors) {</span>
<span class="nc" id="L1217">            EquipmentType at = EquipmentType.get(atName);</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">            if (checked.contains(at)) {</span>
<span class="nc" id="L1219">                continue;</span>
            }
<span class="nc" id="L1221">            checked.add(at);</span>
            // Can be null in the case of vehicle body or asf wings.   
<span class="nc bnc" id="L1223" title="All 2 branches missed.">            if (null ==  at) {</span>
<span class="nc" id="L1224">                continue;</span>
            }
<span class="nc" id="L1226">            int introDate = at.getIntroductionDate(getEntity().isClan());</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">            if (getEntity().isMixedTech()) {</span>
<span class="nc" id="L1228">                introDate = at.getIntroductionDate();</span>
            }
<span class="nc bnc" id="L1230" title="All 2 branches missed.">            if (introDate &gt; useIntroYear) {</span>
<span class="nc" id="L1231">                retVal = true;</span>
<span class="nc" id="L1232">                buff.append(at.getName());</span>
<span class="nc" id="L1233">                buff.append(&quot; armor has intro date of &quot;);</span>
<span class="nc" id="L1234">                buff.append(introDate);</span>
<span class="nc" id="L1235">                buff.append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L1237">        }</span>
        // Check cockpit TL
<span class="nc" id="L1239">        ITechnology cockpit = null;</span>
<span class="nc" id="L1240">        String cockpitName = null;</span>
<span class="nc bnc" id="L1241" title="All 4 branches missed.">        if ((getEntity() instanceof Aero) &amp;&amp; !getEntity().isSupportVehicle()) {</span>
<span class="nc" id="L1242">            cockpit = ((Aero)getEntity()).getCockpitTechAdvancement();</span>
<span class="nc" id="L1243">            cockpitName = ((Aero)getEntity()).getCockpitTypeString();</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">        } else if (getEntity() instanceof Mech) {</span>
<span class="nc" id="L1245">            cockpit = ((Mech)getEntity()).getCockpitTechAdvancement();</span>
<span class="nc" id="L1246">            cockpitName = ((Mech)getEntity()).getCockpitTypeString();</span>
        }
<span class="nc bnc" id="L1248" title="All 2 branches missed.">        if (null != cockpit) {</span>
<span class="nc" id="L1249">            int introDate = cockpit.getIntroductionDate(getEntity().isClan());</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">            if (getEntity().isMixedTech()) {</span>
<span class="nc" id="L1251">                introDate = cockpit.getIntroductionDate();</span>
            }
<span class="nc bnc" id="L1253" title="All 2 branches missed.">            if (introDate &gt; useIntroYear) {</span>
<span class="nc" id="L1254">                retVal = true;</span>
<span class="nc" id="L1255">                buff.append(cockpitName);</span>
<span class="nc" id="L1256">                buff.append(&quot; has intro date of &quot;);</span>
<span class="nc" id="L1257">                buff.append(introDate);</span>
<span class="nc" id="L1258">                buff.append(&quot;\n&quot;);</span>
            }
        }
<span class="nc bnc" id="L1261" title="All 2 branches missed.">        if (getEntity() instanceof Mech) {</span>
<span class="nc" id="L1262">            ITechnology gyro = ((Mech)getEntity()).getGyroTechAdvancement();</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">            if (null != gyro) {</span>
<span class="nc" id="L1264">                int introDate = gyro.getIntroductionDate(getEntity().isClan());</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">                if (getEntity().isMixedTech()) {</span>
<span class="nc" id="L1266">                    introDate = gyro.getIntroductionDate();</span>
                }
<span class="nc bnc" id="L1268" title="All 2 branches missed.">                if (introDate &gt; useIntroYear) {</span>
<span class="nc" id="L1269">                    retVal = true;</span>
<span class="nc" id="L1270">                    buff.append(((Mech)getEntity()).getGyroTypeString());</span>
<span class="nc" id="L1271">                    buff.append(&quot; has intro date of &quot;);</span>
<span class="nc" id="L1272">                    buff.append(introDate);</span>
<span class="nc" id="L1273">                    buff.append(&quot;\n&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L1277" title="All 2 branches missed.">        if (getEntity().hasEngine()) {</span>
<span class="nc" id="L1278">            ITechnology engine = getEntity().getEngine().getTechAdvancement();</span>
<span class="nc" id="L1279">            int introDate = engine.getIntroductionDate(getEntity().isClan());</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">            if (getEntity().isMixedTech()) {</span>
<span class="nc" id="L1281">                introDate = engine.getIntroductionDate();</span>
            }
<span class="nc bnc" id="L1283" title="All 2 branches missed.">            if (introDate &gt; useIntroYear) {</span>
<span class="nc" id="L1284">                retVal = true;</span>
<span class="nc" id="L1285">                buff.append(getEntity().getEngine().getShortEngineName());</span>
<span class="nc" id="L1286">                buff.append(&quot; has intro date of &quot;);</span>
<span class="nc" id="L1287">                buff.append(introDate);</span>
<span class="nc" id="L1288">                buff.append(&quot;\n&quot;);</span>
            }
        }

<span class="nc" id="L1292">        return retVal;</span>
    }

    public boolean hasFailedEquipment(StringBuffer buff) {
<span class="nc" id="L1296">        boolean hasFailedEquipment = false;</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        for (Iterator&lt;String&gt; e = getEntity().getFailedEquipment(); e.hasNext();) {</span>
<span class="nc" id="L1298">            String name = e.next();</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">            if (!ignoreFailedEquip(name)) {</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">                if (!hasFailedEquipment) {</span>
<span class="nc" id="L1301">                    buff.append(&quot;Equipment that Failed to Load:\n&quot;);</span>
                }
<span class="nc" id="L1303">                buff.append(name).append(&quot;\n&quot;);</span>
<span class="nc" id="L1304">                hasFailedEquipment = true;</span>
            }
<span class="nc" id="L1306">        }</span>

<span class="nc" id="L1308">        return hasFailedEquipment;</span>
    }

    /**
     * Check if the unit has combinations of equipment which are not allowed in
     * the construction rules.
     *
     * @param buff
     *            diagnostics are appended to this
     * @return true if the entity is illegal
     */
    public boolean hasIllegalEquipmentCombinations(StringBuffer buff) {
<span class="nc" id="L1320">        boolean illegal = false;</span>
<span class="nc" id="L1321">        int fieldKitchenCount = 0;</span>
<span class="nc" id="L1322">        int minesweeperCount = 0;</span>
<span class="nc" id="L1323">        boolean hasHarjelII = false;</span>
<span class="nc" id="L1324">        boolean hasHarjelIII = false;</span>
<span class="nc" id="L1325">        boolean hasCoolantPod = false;</span>
<span class="nc" id="L1326">        int emergencyCoolantCount = 0;</span>
<span class="nc" id="L1327">        int networks = 0;</span>
<span class="nc" id="L1328">        boolean countedC3 = false;</span>
<span class="nc" id="L1329">        int robotics = 0;</span>
<span class="nc" id="L1330">        boolean hasExternalFuelTank = false;</span>
<span class="nc" id="L1331">        int liftHoists = 0;</span>
<span class="nc" id="L1332">        Map&lt;Integer, Integer&gt; bridgeLayersByLocation = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1333">        Map&lt;Integer, List&lt;EquipmentType&gt;&gt; physicalWeaponsByLocation = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L1335" title="All 2 branches missed.">        for (Mounted m : getEntity().getAmmo()) {</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">            if (((AmmoType)m.getType()).getAmmoType() == AmmoType.T_COOLANT_POD) {</span>
<span class="nc" id="L1337">                hasCoolantPod = true;</span>
            }
<span class="nc" id="L1339">        }</span>
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        for (Mounted m : getEntity().getMisc()) {</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L1342">                emergencyCoolantCount++;</span>
            }
<span class="nc bnc" id="L1344" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_FIELD_KITCHEN)) {</span>
<span class="nc" id="L1345">                fieldKitchenCount++;</span>
            }
<span class="nc bnc" id="L1347" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L1348">                minesweeperCount++;</span>
            }

<span class="nc bnc" id="L1351" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_LIGHT_FLUID_SUCTION_SYSTEM)) {</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">                if (getEntity() instanceof Protomech) {</span>
<span class="nc" id="L1353">                    illegal = true;</span>
<span class="nc" id="L1354">                    buff.append(&quot;ProtoMech can't mount light fluid suction system\n&quot;);</span>
                }
            }
<span class="nc bnc" id="L1357" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_VOIDSIG)</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">                    &amp;&amp; !getEntity().hasWorkingMisc(MiscType.F_ECM)) {</span>
<span class="nc" id="L1359">                illegal = true;</span>
<span class="nc" id="L1360">                buff.append(&quot;void signature system needs ECM suite\n&quot;);</span>
            }
<span class="nc bnc" id="L1362" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_HARJEL_II)) {</span>
<span class="nc" id="L1363">                hasHarjelII = true;</span>
            }
<span class="nc bnc" id="L1365" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_HARJEL_III)) {</span>
<span class="nc" id="L1366">                hasHarjelIII = true;</span>
            }
<span class="nc bnc" id="L1368" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_FUEL)) {</span>
<span class="nc" id="L1369">                hasExternalFuelTank = true;</span>
            }
<span class="nc bnc" id="L1371" title="All 6 branches missed.">            if ((m.getType().hasFlag(MiscType.F_C3S) || m.getType().hasFlag(MiscType.F_C3SBS)) &amp;&amp; !countedC3) {</span>
<span class="nc" id="L1372">                networks++;</span>
<span class="nc" id="L1373">                countedC3 = true;</span>
            }
<span class="nc bnc" id="L1375" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_C3I) || m.getType().hasFlag(MiscType.F_NOVA)) {</span>
<span class="nc" id="L1376">                networks++;</span>
            }
<span class="nc bnc" id="L1378" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_SRCS) || m.getType().hasFlag(MiscType.F_SASRCS)</span>
<span class="nc bnc" id="L1379" title="All 4 branches missed.">                    || m.getType().hasFlag(MiscType.F_CASPAR) || m.getType().hasFlag(MiscType.F_CASPARII)) {</span>
<span class="nc" id="L1380">                robotics++;</span>
            }
<span class="nc bnc" id="L1382" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_LIFTHOIST)) {</span>
<span class="nc" id="L1383">                liftHoists++;</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">            } else if ((m.getLocation() &gt; 0)</span>
<span class="nc bnc" id="L1385" title="All 4 branches missed.">                    &amp;&amp; ((m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; !((MiscType) m.getType()).isShield())</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_BULLDOZER)</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_HAND_WEAPON))) {</span>
<span class="nc" id="L1388">                physicalWeaponsByLocation.computeIfAbsent(m.getLocation(), ArrayList::new).add(m.getType());</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)) {</span>
<span class="nc" id="L1392">                bridgeLayersByLocation.merge(m.getLocation(), 1, Integer::sum);</span>
            }
<span class="nc" id="L1394">        }</span>
<span class="nc bnc" id="L1395" title="All 4 branches missed.">        if ((networks &gt; 0) &amp;&amp; !countedC3) {</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">            for (Mounted m : getEntity().getIndividualWeaponList()) {</span>
<span class="nc bnc" id="L1397" title="All 4 branches missed.">                if (m.getType().hasFlag(WeaponType.F_C3M) || m.getType().hasFlag(WeaponType.F_C3MBS)) {</span>
<span class="nc" id="L1398">                    networks++;</span>
                }
<span class="nc" id="L1400">            }</span>
        }
<span class="nc bnc" id="L1402" title="All 6 branches missed.">        if ((isMech() || isTank() || isAero())</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">                &amp;&amp; (!getEntity().hasEngine()</span>
<span class="nc bnc" id="L1404" title="All 2 branches missed.">                        || (!getEntity().getEngine().isFusion()</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">                                &amp;&amp; (getEntity().getEngine().getEngineType() != Engine.FISSION)))) {</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            for (Mounted m : getEntity().getWeaponList()) {</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">                if (((WeaponType) m.getType()).getAmmoType() == AmmoType.T_IGAUSS_HEAVY) {</span>
<span class="nc" id="L1408">                    buff.append(&quot;Improved Heavy Gauss requires a fusion or fission engine.\n&quot;);</span>
<span class="nc" id="L1409">                    illegal = true;</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">                } else if (m.getType().hasFlag(WeaponType.F_FLAMER)</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">                        &amp;&amp; (((WeaponType) m.getType()).getAmmoType() == AmmoType.T_NA)</span>
<span class="nc bnc" id="L1412" title="All 4 branches missed.">                        &amp;&amp; (!getEntity().hasEngine() || (!getEntity().getEngine().isFusion()</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">                                &amp;&amp; (getEntity().getEngine().getEngineType() != Engine.FISSION)))) {</span>
<span class="nc" id="L1414">                    buff.append(&quot;Standard flamers require a fusion or fission engine.\n&quot;);</span>
<span class="nc" id="L1415">                    illegal = true;</span>
                }
<span class="nc" id="L1417">            }</span>
        }
<span class="nc bnc" id="L1419" title="All 2 branches missed.">        if (hasExternalFuelTank</span>
<span class="nc bnc" id="L1420" title="All 4 branches missed.">                &amp;&amp; (!getEntity().hasEngine() ||((getEntity().getEngine().getEngineType() != Engine.COMBUSTION_ENGINE)</span>
<span class="nc bnc" id="L1421" title="All 2 branches missed.">                &amp;&amp; (getEntity().getEngine().getEngineType() != Engine.FUEL_CELL)))) {</span>
<span class="nc" id="L1422">            illegal = true;</span>
<span class="nc" id="L1423">            buff.append(&quot;Extended fuel tanks can only be used with internal combustion or fuel cell engines.\n&quot;);</span>
        }

<span class="nc bnc" id="L1426" title="All 2 branches missed.">        if (minesweeperCount &gt; 1) {</span>
<span class="nc" id="L1427">            buff.append(&quot;Unit has more than one minesweeper!\n&quot;);</span>
<span class="nc" id="L1428">            illegal = true;</span>
        }
<span class="nc bnc" id="L1430" title="All 2 branches missed.">        if (fieldKitchenCount &gt; 3) {</span>
<span class="nc" id="L1431">            buff.append(&quot;Unit has more than three Field Kitchens\n&quot;);</span>
<span class="nc" id="L1432">            illegal = true;</span>
        }

<span class="nc bnc" id="L1435" title="All 4 branches missed.">        if (hasCoolantPod &amp;&amp; (emergencyCoolantCount &gt; 0)) {</span>
<span class="nc" id="L1436">            buff.append(&quot;Unit has coolant pod and RISC emergency coolant system\n&quot;);</span>
<span class="nc" id="L1437">            illegal = true;</span>
        }
<span class="nc bnc" id="L1439" title="All 2 branches missed.">        if (emergencyCoolantCount &gt; 1) {</span>
<span class="nc" id="L1440">            buff.append(&quot;Unit has more than one RISC emergency coolant system\n&quot;);</span>
<span class="nc" id="L1441">            illegal = true;</span>
        }
<span class="nc bnc" id="L1443" title="All 6 branches missed.">        if (!(getEntity() instanceof Mech) &amp;&amp; (hasHarjelII || hasHarjelIII)) {</span>
<span class="nc" id="L1444">            buff.append(&quot;Cannot mount HarJel repair system on non-Mech\n&quot;);</span>
<span class="nc" id="L1445">            illegal = true;</span>
        }
<span class="nc bnc" id="L1447" title="All 2 branches missed.">        if (networks &gt; 1) {</span>
<span class="nc" id="L1448">            buff.append(&quot;Cannot have multiple network types on the same unit.\n&quot;);</span>
<span class="nc" id="L1449">            illegal = true;</span>
        }
<span class="nc bnc" id="L1451" title="All 2 branches missed.">        if (robotics &gt; 1) {</span>
<span class="nc" id="L1452">            buff.append(&quot;Unit has multiple drone control systems.\n&quot;);</span>
<span class="nc" id="L1453">            illegal = true;</span>
        }
<span class="nc bnc" id="L1455" title="All 4 branches missed.">        if (getEntity().hasStealth() &amp;&amp; !getEntity().hasWorkingMisc(MiscType.F_ECM)) {</span>
<span class="nc" id="L1456">            buff.append(&quot;Stealth armor requires an ECM generator.\n&quot;);</span>
<span class="nc" id="L1457">            illegal = true;</span>
        }
<span class="nc bnc" id="L1459" title="All 4 branches missed.">        if ((getEntity() instanceof Mech) &amp;&amp; (liftHoists &gt; 2)) {</span>
<span class="nc" id="L1460">            illegal = true;</span>
<span class="nc" id="L1461">            buff.append(&quot;Can mount a maximum of two lift hoists.\n&quot;);</span>
<span class="nc bnc" id="L1462" title="All 6 branches missed.">        } else if ((getEntity().isSupportVehicle() || (getEntity() instanceof Tank)) &amp;&amp; (liftHoists &gt; 4)) {</span>
<span class="nc" id="L1463">            illegal = true;</span>
<span class="nc" id="L1464">            buff.append(&quot;Can mount a maximum of four lift hoists.\n&quot;);</span>
        }
<span class="nc bnc" id="L1466" title="All 2 branches missed.">        for (List&lt;EquipmentType&gt; list : physicalWeaponsByLocation.values()) {</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">            if (list.size() &gt; 1) {</span>
<span class="nc" id="L1468">                illegal = true;</span>
<span class="nc" id="L1469">                buff.append(list.stream().map(EquipmentType::getName).collect(Collectors.joining(&quot;, &quot;)))</span>
<span class="nc" id="L1470">                        .append(&quot; cannot be mounted in the same location.\n&quot;);</span>
            }
<span class="nc" id="L1472">        }</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">        for (int count : bridgeLayersByLocation.values()) {</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">            if (count &gt; 1) {</span>
<span class="nc" id="L1475">                illegal = true;</span>
<span class="nc" id="L1476">                buff.append(&quot;Cannot mount more than one bridge builder in the same location.\n&quot;);</span>
            }
<span class="nc" id="L1478">        }</span>

<span class="nc bnc" id="L1480" title="All 2 branches missed.">        if (getEntity().isOmni()) {</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">            for (Mounted m : getEntity().getEquipment()) {</span>
<span class="nc bnc" id="L1482" title="All 4 branches missed.">                if (m.isOmniPodMounted() &amp;&amp; m.getType().isOmniFixedOnly()) {</span>
<span class="nc" id="L1483">                    illegal = true;</span>
<span class="nc" id="L1484">                    buff.append(m.getType().getName()).append(&quot; cannot be pod mounted.&quot;);</span>
                }
<span class="nc" id="L1486">            }</span>
        } else {
<span class="nc bnc" id="L1488" title="All 2 branches missed.">            for (Mounted m : getEntity().getEquipment()) {</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">                if (m.isOmniPodMounted()) {</span>
<span class="nc" id="L1490">                    buff.append(m.getType().getName()).append(&quot; is pod mounted in non-omni unit\n&quot;);</span>
<span class="nc" id="L1491">                    illegal = true;</span>
                }
<span class="nc" id="L1493">            }</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">            for (Transporter t : getEntity().getTransports()) {</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">                if (getEntity().isPodMountedTransport(t)) {</span>
<span class="nc" id="L1496">                    buff.append(&quot;Pod mounted troop space in non-omni unit\n&quot;);</span>
<span class="nc" id="L1497">                    illegal = true;</span>
                }
<span class="nc" id="L1499">            }</span>
        }
<span class="nc bnc" id="L1501" title="All 2 branches missed.">        for (Mounted mounted : getEntity().getEquipment()) {</span>
<span class="nc bnc" id="L1502" title="All 2 branches missed.">            if (mounted.getLocation() &gt; Entity.LOC_NONE) {</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">                illegal |= !isValidLocation(getEntity(), mounted.getType(), mounted.getLocation(), buff);</span>
            }
<span class="nc" id="L1505">        }</span>
<span class="nc" id="L1506">        return illegal;</span>
    }

    /**
     * @param entity    The entity
     * @param eq        The equipment
     * @param location  A location index on the Entity
     * @param buffer    If non-null and the location is invalid, will be appended with an explanation
     * @return          Whether the equipment can be mounted in the location on the Entity
     */
    public static boolean isValidLocation(Entity entity, EquipmentType eq, int location,
                                          @Nullable StringBuffer buffer) {
<span class="nc bnc" id="L1518" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L1519">            return TestMech.isValidMechLocation((Mech) entity, eq, location, buffer);</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">        } else if (entity instanceof Tank) {</span>
<span class="nc" id="L1521">            return TestTank.isValidTankLocation((Tank) entity, eq, location, buffer);</span>
<span class="nc bnc" id="L1522" title="All 2 branches missed.">        } else if (entity instanceof Protomech) {</span>
<span class="nc" id="L1523">            return TestProtomech.isValidProtomechLocation((Protomech) entity, eq, location, buffer);</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">        } else if (entity.isFighter()) {</span>
<span class="nc" id="L1525">            return TestAero.isValidAeroLocation(eq, location, buffer);</span>
        }
<span class="nc" id="L1527">        return true;</span>
    }

    public StringBuffer printFailedEquipment(StringBuffer buff) {
<span class="nc bnc" id="L1531" title="All 2 branches missed.">        if (getEntity().getFailedEquipment().hasNext()) {</span>
<span class="nc" id="L1532">            buff.append(&quot;Equipment that Failed to Load:\n&quot;);</span>
        }
<span class="nc bnc" id="L1534" title="All 2 branches missed.">        for (Iterator&lt;String&gt; e = getEntity().getFailedEquipment(); e.hasNext();) {</span>
<span class="nc" id="L1535">            buff.append(e.next()).append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L1537">        return buff;</span>
    }

    public double getWeightCarryingSpace() {
<span class="nc" id="L1541">        double weight = getEntity().getTroopCarryingSpace();</span>
<span class="nc bnc" id="L1542" title="All 2 branches missed.">        for (Bay bay : getEntity().getTransportBays()) {</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">            if (!bay.isQuarters()) {</span>
<span class="nc" id="L1544">                TestEntity.ceil(weight += bay.getWeight(), Ceil.KILO);</span>
            }
<span class="nc" id="L1546">        }</span>
<span class="nc" id="L1547">        return weight;</span>
    }

    public String printWeightCarryingSpace() {
<span class="nc" id="L1551">        String carryingSpace = &quot;&quot;;</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">        if (getEntity().getTroopCarryingSpace() != 0) {</span>
<span class="nc" id="L1553">            carryingSpace = StringUtil.makeLength(&quot;Carrying Capacity:&quot;,</span>
<span class="nc" id="L1554">                    getPrintSize() - 5)</span>
<span class="nc" id="L1555">                    + TestEntity.makeWeightString(getEntity()</span>
<span class="nc" id="L1556">                            .getTroopCarryingSpace(), usesKgStandard()) + &quot;\n&quot;;</span>
        }
<span class="nc" id="L1558">        String cargoWeightString = &quot;&quot;;</span>
<span class="nc" id="L1559">        double cargoWeight = 0;</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">        for (Bay bay : getEntity().getTransportBays()) {</span>
<span class="nc" id="L1561">            cargoWeight += bay.getWeight();</span>
<span class="nc" id="L1562">        }</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">        if (cargoWeight &gt; 0) {</span>
<span class="nc" id="L1564">            cargoWeightString = StringUtil.makeLength(&quot;Cargo Weight:&quot;,</span>
<span class="nc" id="L1565">                    getPrintSize() - 5)</span>
<span class="nc" id="L1566">                    + TestEntity.makeWeightString(cargoWeight, usesKgStandard()) + &quot;\n&quot;;</span>
        }
<span class="nc" id="L1568">        return carryingSpace + cargoWeightString;</span>
    }

    public String printArmorLocation(int loc) {
<span class="nc bnc" id="L1572" title="All 2 branches missed.">        if (getEntity().hasRearArmor(loc)) {</span>
<span class="nc" id="L1573">            return StringUtil.makeLength(</span>
<span class="nc" id="L1574">                    getEntity().getLocationAbbr(loc) + &quot;:&quot;, 5)</span>
<span class="nc" id="L1575">                    + StringUtil.makeLength(getEntity().getOInternal(loc), 4)</span>
<span class="nc" id="L1576">                    + StringUtil.makeLength(getEntity().getOArmor(loc), 3)</span>
                    + &quot; / &quot;
                    + StringUtil
<span class="nc" id="L1579">                            .makeLength(getEntity().getOArmor(loc, true), 2);</span>
        }
<span class="nc" id="L1581">        return StringUtil.makeLength(getEntity().getLocationAbbr(loc) + &quot;:&quot;, 5)</span>
<span class="nc" id="L1582">                + StringUtil.makeLength(getEntity().getOInternal(loc), 4)</span>
<span class="nc" id="L1583">                + StringUtil.makeLength(getEntity().getOArmor(loc), 6) + &quot;  &quot;;</span>
    }

    public String printArmorPlacement() {
<span class="nc" id="L1587">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L1588">        buff.append(&quot;Armor Placement:\n&quot;);</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">        for (int loc = 0; loc &lt; getEntity().locations(); loc++) {</span>
<span class="nc" id="L1590">            buff.append(printArmorLocation(loc)).append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L1592">        return buff.toString();</span>
    }

    public String printSource(){
<span class="nc" id="L1596">        return &quot;Source: &quot; + getEntity().getSource() + &quot;\n&quot;;</span>
    }

    public String printTechLevel() {
<span class="nc" id="L1600">        return &quot;Chassis: &quot; + getEntity().getDisplayName() + &quot; - &quot;</span>
<span class="nc" id="L1601">                + TechConstants.getLevelName(getEntity().getTechLevel()) + &quot; (&quot;</span>
<span class="nc" id="L1602">                + getEntity().getYear() + &quot;)\n&quot;;</span>
    }

    public double getArmoredComponentWeight() {
<span class="fc" id="L1606">        return 0.0;</span>
    }

    public static boolean usesKgStandard(Entity entity) {
<span class="pc bpc" id="L1610" title="1 of 2 branches missed.">        return entity.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)</span>
<span class="pc bpc" id="L1611" title="1 of 2 branches missed.">                || entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="pc bpc" id="L1612" title="1 of 2 branches missed.">                || (EntityWeightClass.getWeightClass(entity.getWeight(), entity)</span>
                        == EntityWeightClass.WEIGHT_SMALL_SUPPORT);
    }

    boolean usesKgStandard() {
<span class="fc" id="L1617">        return usesKgStandard(getEntity());</span>
    }

} // End class TestEntity

class Armor {
    public static final int CLAN_ARMOR = 0x01;

    private int armorType;

    private int armorFlags;

<span class="fc" id="L1629">    public Armor(int armorType, int armorFlags) {</span>
<span class="fc" id="L1630">        this.armorType = armorType;</span>
<span class="fc" id="L1631">        this.armorFlags = armorFlags;</span>
<span class="fc" id="L1632">    }</span>
    
    public double getWeightArmor(int totalOArmor, TestEntity.Ceil roundWeight) {
<span class="nc" id="L1635">        return Armor.getWeightArmor(armorType, armorFlags, totalOArmor,</span>
                roundWeight);
    }
    
    public double getRawWeightArmor(int totalOArmor) {
<span class="nc" id="L1640">        return Armor.getRawWeightArmor(armorType, armorFlags, totalOArmor);</span>
    }
    
    public static double getRawWeightArmor(int armorType, int armorFlags,
            int totalOArmor) {
<span class="nc" id="L1645">        double points = totalOArmor;</span>
        int techLevel;
<span class="nc bnc" id="L1647" title="All 2 branches missed.">        if ((armorFlags &amp; CLAN_ARMOR) != 0) {</span>
<span class="nc" id="L1648">            techLevel = TechConstants.T_CLAN_TW;</span>
        } else {
<span class="nc" id="L1650">            techLevel = TechConstants.T_IS_TW_NON_BOX;</span>
        }
<span class="nc" id="L1652">        double multiplier = EquipmentType.getArmorPointMultiplier(armorType,</span>
                techLevel);
<span class="nc" id="L1654">        points /= multiplier;</span>
<span class="nc" id="L1655">        double pointsPerTon = 16.0f;</span>
<span class="nc" id="L1656">        return points / pointsPerTon;</span>
    }

    public static double getWeightArmor(int armorType, int armorFlags,
            int totalOArmor, TestEntity.Ceil roundWeight) {
<span class="nc" id="L1661">        return TestEntity.ceilMaxHalf(getRawWeightArmor(armorType, armorFlags, totalOArmor), roundWeight);</span>
    }

    public String getShortName() {
<span class="nc" id="L1665">        return &quot;(&quot; + EquipmentType.getArmorTypeName(armorType) + &quot;)&quot;;</span>
    }

} // end class Armor

class Structure {

    private int structureType;
    private boolean isSuperHeavy;
    private EntityMovementMode movementmode;

<span class="nc" id="L1676">    public Structure() {</span>
<span class="nc" id="L1677">    }</span>

    public Structure(int structureType, boolean superHeavy,
<span class="fc" id="L1680">            EntityMovementMode movementMode) {</span>
<span class="fc" id="L1681">        this.structureType = structureType;</span>
<span class="fc" id="L1682">        isSuperHeavy = superHeavy;</span>
<span class="fc" id="L1683">        movementmode = movementMode;</span>
<span class="fc" id="L1684">    }</span>

    public double getWeightStructure(double weight, TestEntity.Ceil roundWeight) {
<span class="nc" id="L1687">        return Structure.getWeightStructure(structureType, weight, roundWeight,</span>
                isSuperHeavy, movementmode);
    }

    public static double getWeightStructure(int structureType, double weight,
            TestEntity.Ceil roundWeight, boolean isSuperHeavy,
            EntityMovementMode movementmode) {
<span class="nc" id="L1694">        double multiplier = 1.0;</span>
<span class="nc bnc" id="L1695" title="All 2 branches missed.">        if (movementmode == EntityMovementMode.TRIPOD) {</span>
<span class="nc" id="L1696">            multiplier = 1.1;</span>
        }
<span class="nc bnc" id="L1698" title="All 2 branches missed.">        if (structureType == EquipmentType.T_STRUCTURE_ENDO_STEEL) {</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">            if (isSuperHeavy) {</span>
<span class="nc" id="L1700">                return TestEntity.ceilMaxHalf((weight / 10.0f) * multiplier,</span>
                        roundWeight);
            } else {
<span class="nc" id="L1703">                return TestEntity.ceilMaxHalf((weight / 20.0f) * multiplier,</span>
                        roundWeight);
            }
<span class="nc bnc" id="L1706" title="All 2 branches missed.">        } else if (structureType == EquipmentType.T_STRUCTURE_ENDO_PROTOTYPE) {</span>
<span class="nc" id="L1707">            return TestEntity.ceilMaxHalf((weight / 20.0f) * multiplier,</span>
                    roundWeight);
<span class="nc bnc" id="L1709" title="All 2 branches missed.">        } else if (structureType == EquipmentType.T_STRUCTURE_REINFORCED) {</span>
<span class="nc" id="L1710">            return TestEntity.ceilMaxHalf((weight / 5.0f) * multiplier,</span>
                    roundWeight);
<span class="nc bnc" id="L1712" title="All 2 branches missed.">        } else if (structureType == EquipmentType.T_STRUCTURE_COMPOSITE) {</span>
<span class="nc" id="L1713">            return TestEntity.ceilMaxHalf((weight / 20.0f) * multiplier,</span>
                    roundWeight);
<span class="nc bnc" id="L1715" title="All 2 branches missed.">        } else if (structureType == EquipmentType.T_STRUCTURE_INDUSTRIAL) {</span>
<span class="nc bnc" id="L1716" title="All 2 branches missed.">            if (isSuperHeavy) {</span>
<span class="nc" id="L1717">                return TestEntity.ceilMaxHalf((weight / 2.5f) * multiplier,</span>
                        roundWeight);
            } else {
<span class="nc" id="L1720">                return TestEntity.ceilMaxHalf((weight / 5.0f) * multiplier,</span>
                        roundWeight);
            }

<span class="nc bnc" id="L1724" title="All 2 branches missed.">        } else if (structureType == EquipmentType.T_STRUCTURE_ENDO_COMPOSITE) {</span>
<span class="nc bnc" id="L1725" title="All 2 branches missed.">            if (isSuperHeavy) {</span>
<span class="nc" id="L1726">                return TestEntity.ceilMaxHalf((weight / 10.0f) * 1.5f</span>
                        * multiplier, roundWeight);
            } else {
<span class="nc" id="L1729">                return TestEntity.ceilMaxHalf((weight / 10.0f) * 0.75f</span>
                        * multiplier, roundWeight);
            }
        }
<span class="nc bnc" id="L1733" title="All 6 branches missed.">        if (isSuperHeavy</span>
                &amp;&amp; ((movementmode != EntityMovementMode.NAVAL)
                        &amp;&amp; (movementmode != EntityMovementMode.SUBMARINE))) {
<span class="nc" id="L1736">            return TestEntity.ceilMaxHalf((weight / 5.0f) * multiplier,</span>
                    roundWeight);
        } else {
<span class="nc" id="L1739">            return TestEntity.ceilMaxHalf((weight / 10.0f) * multiplier,</span>
                    roundWeight);
        }
    }

    public String getShortName() {
<span class="nc" id="L1745">        return &quot;(&quot; + EquipmentType.getStructureTypeName(structureType) + &quot;)&quot;;</span>
    }

} // End class Structure
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>