<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.server</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
* Copyright (C) 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
* Copyright (C) 2018, 2020 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/
package megamek.server;

import java.io.*;
import java.net.HttpURLConnection;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.URL;
import java.net.URLEncoder;
import java.net.UnknownHostException;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.Timer;
import java.util.TimerTask;
import java.util.TreeMap;
import java.util.TreeSet;
import java.util.Vector;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.stream.Collectors;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

import com.thoughtworks.xstream.XStream;

import megamek.MegaMek;
import megamek.client.ui.swing.util.PlayerColour;
import megamek.common.*;
import megamek.common.Building.BasementType;
import megamek.common.Building.DemolitionCharge;
import megamek.common.IGame.Phase;
import megamek.common.MovePath.MoveStepType;
import megamek.common.actions.*;
import megamek.common.containers.PlayerIDandList;
import megamek.common.event.GameListener;
import megamek.common.event.GameVictoryEvent;
import megamek.common.icons.Camouflage;
import megamek.common.net.ConnectionFactory;
import megamek.common.net.ConnectionListenerAdapter;
import megamek.common.net.DisconnectedEvent;
import megamek.common.net.IConnection;
import megamek.common.net.Packet;
import megamek.common.net.PacketReceivedEvent;
import megamek.common.options.GameOptions;
import megamek.common.options.IBasicOption;
import megamek.common.options.IOption;
import megamek.common.options.OptionsConstants;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.BoardUtilities;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.util.SerializationHelper;
import megamek.common.util.StringUtil;
import megamek.common.verifier.EntityVerifier;
import megamek.common.verifier.TestAero;
import megamek.common.verifier.TestBattleArmor;
import megamek.common.verifier.TestEntity;
import megamek.common.verifier.TestMech;
import megamek.common.verifier.TestSupportVehicle;
import megamek.common.verifier.TestTank;
import megamek.common.weapons.AreaEffectHelper;
import megamek.common.weapons.AreaEffectHelper.DamageFalloff;
import megamek.common.weapons.AreaEffectHelper.NukeStats;
import megamek.common.weapons.ArtilleryBayWeaponIndirectHomingHandler;
import megamek.common.weapons.ArtilleryWeaponIndirectHomingHandler;
import megamek.common.weapons.AttackHandler;
import megamek.common.weapons.CapitalMissileBearingsOnlyHandler;
import megamek.common.weapons.TAGHandler;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.WeaponHandler;
import megamek.common.weapons.infantry.InfantryWeapon;
import megamek.common.weapons.other.TSEMPWeapon;
import megamek.server.commands.AddBotCommand;
import megamek.server.commands.AllowTeamChangeCommand;
import megamek.server.commands.AssignNovaNetServerCommand;
import megamek.server.commands.CheckBVCommand;
import megamek.server.commands.CheckBVTeamCommand;
import megamek.server.commands.DefeatCommand;
import megamek.server.commands.ExportListCommand;
import megamek.server.commands.FixElevationCommand;
import megamek.server.commands.HelpCommand;
import megamek.server.commands.JoinTeamCommand;
import megamek.server.commands.KickCommand;
import megamek.server.commands.ListEntitiesCommand;
import megamek.server.commands.ListSavesCommand;
import megamek.server.commands.LoadGameCommand;
import megamek.server.commands.LocalLoadGameCommand;
import megamek.server.commands.LocalSaveGameCommand;
import megamek.server.commands.NukeCommand;
import megamek.server.commands.ResetCommand;
import megamek.server.commands.RollCommand;
import megamek.server.commands.RulerCommand;
import megamek.server.commands.SaveGameCommand;
import megamek.server.commands.SeeAllCommand;
import megamek.server.commands.ServerCommand;
import megamek.server.commands.ShowEntityCommand;
import megamek.server.commands.ShowTileCommand;
import megamek.server.commands.ShowValidTargetsCommand;
import megamek.server.commands.SkipCommand;
import megamek.server.commands.TeamCommand;
import megamek.server.commands.TraitorCommand;
import megamek.server.commands.VictoryCommand;
import megamek.server.commands.WhoCommand;
import megamek.server.victory.VictoryResult;

/**
 * @author Ben Mazur
 */
public class Server implements Runnable {
    private static class EntityTargetPair {
        Entity ent;

        Targetable target;

<span class="nc" id="L146">        EntityTargetPair (Entity e, Targetable t) {</span>
<span class="nc" id="L147">            ent = e;</span>
<span class="nc" id="L148">            target = t;</span>
<span class="nc" id="L149">        }</span>

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (this == o) {</span>
<span class="nc" id="L154">                return true;</span>
            }
<span class="nc bnc" id="L156" title="All 4 branches missed.">            if ((null == o) || (getClass() != o.getClass())) {</span>
<span class="nc" id="L157">                return false;</span>
            }
<span class="nc" id="L159">            final EntityTargetPair other = (EntityTargetPair) o;</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">            return Objects.equals(ent, other.ent) &amp;&amp; Objects.equals(target, other.target);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L165">            return Objects.hash(ent, target);</span>
        }

    }
    /**
     * The DamageType enumeration is used for the damageEntity function.
     */
<span class="nc" id="L172">    public enum DamageType {</span>
<span class="nc" id="L173">        NONE, FRAGMENTATION, FLECHETTE, ACID, INCENDIARY, IGNORE_PASSENGER, ANTI_TSM, ANTI_INFANTRY, NAIL_RIVET,</span>
<span class="nc" id="L174">        NONPENETRATING</span>
    }

    // public static final String LEGAL_CHARS =
    // &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-&quot;;
    private static final String DEFAULT_BOARD = MapSettings.BOARD_SURPRISE;

    // server setup
    private String password;

    private final String metaServerUrl;

    private ServerSocket serverSocket;

    private String motd;

    private static class ReceivedPacket {
        public int connId;
        public Packet packet;

<span class="nc" id="L194">        ReceivedPacket(int cid, Packet p) {</span>
<span class="nc" id="L195">            packet = p;</span>
<span class="nc" id="L196">            connId = cid;</span>
<span class="nc" id="L197">        }</span>

    }

    private class PacketPump implements Runnable {

        boolean shouldStop;

<span class="nc" id="L205">        PacketPump() {</span>
<span class="nc" id="L206">            shouldStop = false;</span>
<span class="nc" id="L207">        }</span>

        void signalEnd() {
<span class="nc" id="L210">            shouldStop = true;</span>
<span class="nc" id="L211">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L215" title="All 2 branches missed.">            while (!shouldStop) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                while (!packetQueue.isEmpty()) {</span>
<span class="nc" id="L217">                    ReceivedPacket rp = packetQueue.poll();</span>
<span class="nc" id="L218">                    synchronized (serverLock) {</span>
<span class="nc" id="L219">                        handle(rp.connId, rp.packet);</span>
<span class="nc" id="L220">                    }</span>
<span class="nc" id="L221">                }</span>
                try {
<span class="nc" id="L223">                    synchronized (packetQueue) {</span>
<span class="nc" id="L224">                        packetQueue.wait();</span>
<span class="nc" id="L225">                    }</span>
<span class="nc" id="L226">                } catch (InterruptedException e) {</span>
                    // If we are interrupted, just keep going, generally
                    // this happens after we are signalled to stop.
<span class="nc" id="L229">                }</span>
            }
<span class="nc" id="L231">        }</span>

    }

    // game info
<span class="nc" id="L236">    private Vector&lt;IConnection&gt; connections = new Vector&lt;&gt;(4);</span>

<span class="nc" id="L238">    private Hashtable&lt;Integer, ConnectionHandler&gt; connectionHandlers = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L240">    private final ConcurrentLinkedQueue&lt;ReceivedPacket&gt; packetQueue = new ConcurrentLinkedQueue&lt;&gt;();</span>

    /**
     * Special packet queue for client feedback requests.
     */
<span class="nc" id="L245">    private final ConcurrentLinkedQueue&lt;ReceivedPacket&gt; cfrPacketQueue = new ConcurrentLinkedQueue&lt;&gt;();</span>

<span class="nc" id="L247">    private Vector&lt;IConnection&gt; connectionsPending = new Vector&lt;&gt;(4);</span>

<span class="nc" id="L249">    private Hashtable&lt;Integer, IConnection&gt; connectionIds = new Hashtable&lt;&gt;();</span>

    private int connectionCounter;

<span class="nc" id="L253">    private IGame game = new Game();</span>

<span class="nc" id="L255">    private Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>

    public Vector&lt;Report&gt; getvPhaseReport() {
<span class="nc" id="L258">        return vPhaseReport;</span>
    }

<span class="nc" id="L261">    private MapSettings mapSettings = MapSettings.getInstance();</span>

    // commands
<span class="nc" id="L264">    private Hashtable&lt;String, ServerCommand&gt; commandsHash = new Hashtable&lt;&gt;();</span>

    // listens for and connects players
    private Thread connector;

    private PacketPump packetPump;
    private Thread packetPumpThread;

    // Track buildings that are affected by an entity's movement.
<span class="nc" id="L273">    private Hashtable&lt;Building, Boolean&gt; affectedBldgs = new Hashtable&lt;&gt;();</span>

    // Track Physical Action results, HACK to deal with opposing pushes
    // canceling each other
<span class="nc" id="L277">    private Vector&lt;PhysicalResult&gt; physicalResults = new Vector&lt;&gt;();</span>

<span class="nc" id="L279">    private Vector&lt;DynamicTerrainProcessor&gt; terrainProcessors = new Vector&lt;&gt;();</span>

<span class="nc" id="L281">    private Timer watchdogTimer = new Timer(&quot;Watchdog Timer&quot;);</span>

    private static EntityVerifier entityVerifier;

<span class="nc" id="L285">    private ArrayList&lt;int[]&gt; scheduledNukes = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L287">    private static Server serverInstance = null;</span>

<span class="nc" id="L289">    private String serverAccessKey = null;</span>

<span class="nc" id="L291">    private Timer serverBrowserUpdateTimer = null;</span>

    /**
     * Keeps track of what team a player requested to join.
     */
<span class="nc" id="L296">    private int requestedTeam = IPlayer.TEAM_NONE;</span>

    /**
     * Keeps track of what player made a request to change teams.
     */
<span class="nc" id="L301">    private IPlayer playerChangingTeam = null;</span>

    /**
     * Flag that is set to true when all players have voted to allow another
     * player to change teams.
     */
<span class="nc" id="L307">    private boolean changePlayersTeam = false;</span>

    /**
     * Stores a set of &lt;code&gt;Coords&lt;/code&gt; that have changed during this phase.
     */
<span class="nc" id="L312">    private Set&lt;Coords&gt; hexUpdateSet = new LinkedHashSet&lt;&gt;();</span>

<span class="nc" id="L314">    private List&lt;DemolitionCharge&gt; explodingCharges = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L316">    private ConnectionListenerAdapter connectionListener = new ConnectionListenerAdapter() {</span>

        /**
         * Called when it is sensed that a connection has terminated.
         */
        @Override
        public void disconnected(DisconnectedEvent e) {
<span class="nc" id="L323">            synchronized (serverLock) {</span>
<span class="nc" id="L324">                IConnection conn = e.getConnection();</span>

                // write something in the log
<span class="nc" id="L327">                MegaMek.getLogger().info(&quot;s: connection &quot; + conn.getId() + &quot; disconnected&quot;);</span>

<span class="nc" id="L329">                connections.removeElement(conn);</span>
<span class="nc" id="L330">                connectionsPending.removeElement(conn);</span>
<span class="nc" id="L331">                connectionIds.remove(conn.getId());</span>
<span class="nc" id="L332">                ConnectionHandler ch = connectionHandlers.get(conn.getId());</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if (ch != null) {</span>
<span class="nc" id="L334">                    ch.signalStop();</span>
<span class="nc" id="L335">                    connectionHandlers.remove(conn.getId());</span>
                }

                // if there's a player for this connection, remove it too
<span class="nc" id="L339">                IPlayer player = getPlayer(conn.getId());</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (null != player) {</span>
<span class="nc" id="L341">                    Server.this.disconnected(player);</span>
                }
<span class="nc" id="L343">            }</span>
<span class="nc" id="L344">        }</span>

        @Override
        public void packetReceived(PacketReceivedEvent e) {
<span class="nc" id="L348">            ReceivedPacket rp = new ReceivedPacket(e.getConnection().getId(),</span>
<span class="nc" id="L349">                    e.getPacket());</span>
<span class="nc" id="L350">            int cmd = e.getPacket().getCommand();</span>
            // Handled CFR packets specially
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (cmd == Packet.COMMAND_CLIENT_FEEDBACK_REQUEST) {</span>
<span class="nc" id="L353">                synchronized (cfrPacketQueue) {</span>
<span class="nc" id="L354">                    cfrPacketQueue.add(rp);</span>
<span class="nc" id="L355">                    cfrPacketQueue.notifyAll();</span>
<span class="nc" id="L356">                }</span>
            // Some packets should be handled immediately
<span class="nc bnc" id="L358" title="All 8 branches missed.">            } else if ((cmd == Packet.COMMAND_CLOSE_CONNECTION)</span>
                    || (cmd == Packet.COMMAND_CLIENT_NAME)
                    || (cmd == Packet.COMMAND_CLIENT_VERSIONS)
                    || (cmd == Packet.COMMAND_CHAT)) {
<span class="nc" id="L362">                handle(rp.connId, rp.packet);</span>
            } else {
<span class="nc" id="L364">                synchronized (packetQueue) {</span>
<span class="nc" id="L365">                    packetQueue.add(rp);</span>
<span class="nc" id="L366">                    packetQueue.notifyAll();</span>
<span class="nc" id="L367">                }</span>
            }
<span class="nc" id="L369">        }</span>

    };

    /**
     * Used to ensure only one thread at a time is accessing this particular
     * instance of the server.
     */
<span class="nc" id="L377">    private final Object serverLock = new Object();</span>

    public Server(String password, int port) throws IOException {
<span class="nc" id="L380">        this(password, port, false, &quot;&quot;);</span>
<span class="nc" id="L381">    }</span>

    /**
     * Construct a new GameHost and begin listening for incoming clients.
     *
     * @param password                  the &lt;code&gt;String&lt;/code&gt; that is set as a password
     * @param port                      the &lt;code&gt;int&lt;/code&gt; value that specifies the port that is
     *                                  used
     * @param registerWithServerBrowser a &lt;code&gt;boolean&lt;/code&gt; indicating whether we should register
     *                                  with the master server browser on megamek.info
     */
    public Server(String password, int port, boolean registerWithServerBrowser,
<span class="nc" id="L393">                  String metaServerUrl) throws IOException {</span>
<span class="nc" id="L394">        this.metaServerUrl = metaServerUrl;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        this.password = password.length() &gt; 0 ? password : null;</span>
        // initialize server socket
<span class="nc" id="L397">        serverSocket = new ServerSocket(port);</span>

<span class="nc" id="L399">        motd = createMotd();</span>

<span class="nc" id="L401">        game.getOptions().initialize();</span>
<span class="nc" id="L402">        game.getOptions().loadOptions();</span>

<span class="nc" id="L404">        changePhase(IGame.Phase.PHASE_LOUNGE);</span>

        // display server start text
<span class="nc" id="L407">        MegaMek.getLogger().info(&quot;s: starting a new server...&quot;);</span>

        try {
<span class="nc" id="L410">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L411">            String host = InetAddress.getLocalHost().getHostName();</span>
<span class="nc" id="L412">            sb.append(&quot;s: hostname = '&quot;);</span>
<span class="nc" id="L413">            sb.append(host);</span>
<span class="nc" id="L414">            sb.append(&quot;' port = &quot;);</span>
<span class="nc" id="L415">            sb.append(serverSocket.getLocalPort());</span>
<span class="nc" id="L416">            sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L417">            InetAddress[] addresses = InetAddress.getAllByName(host);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">            for (InetAddress address : addresses) {</span>
<span class="nc" id="L419">                sb.append(&quot;s: hosting on address = &quot;);</span>
<span class="nc" id="L420">                sb.append(address.getHostAddress());</span>
<span class="nc" id="L421">                sb.append(&quot;\n&quot;);</span>
            }

<span class="nc" id="L424">            MegaMek.getLogger().info(sb.toString());</span>
<span class="nc" id="L425">        } catch (UnknownHostException ignored) {</span>
            // oh well.
<span class="nc" id="L427">        }</span>

<span class="nc" id="L429">        MegaMek.getLogger().info(&quot;s: password = &quot; + this.password);</span>

        // register commands
<span class="nc" id="L432">        registerCommand(new DefeatCommand(this));</span>
<span class="nc" id="L433">        registerCommand(new ExportListCommand(this));</span>
<span class="nc" id="L434">        registerCommand(new FixElevationCommand(this));</span>
<span class="nc" id="L435">        registerCommand(new HelpCommand(this));</span>
<span class="nc" id="L436">        registerCommand(new KickCommand(this));</span>
<span class="nc" id="L437">        registerCommand(new ListSavesCommand(this));</span>
<span class="nc" id="L438">        registerCommand(new LocalSaveGameCommand(this));</span>
<span class="nc" id="L439">        registerCommand(new LocalLoadGameCommand(this));</span>
<span class="nc" id="L440">        registerCommand(new ResetCommand(this));</span>
<span class="nc" id="L441">        registerCommand(new RollCommand(this));</span>
<span class="nc" id="L442">        registerCommand(new SaveGameCommand(this));</span>
<span class="nc" id="L443">        registerCommand(new LoadGameCommand(this));</span>
<span class="nc" id="L444">        registerCommand(new SeeAllCommand(this));</span>
<span class="nc" id="L445">        registerCommand(new SkipCommand(this));</span>
<span class="nc" id="L446">        registerCommand(new VictoryCommand(this));</span>
<span class="nc" id="L447">        registerCommand(new WhoCommand(this));</span>
<span class="nc" id="L448">        registerCommand(new TeamCommand(this));</span>
<span class="nc" id="L449">        registerCommand(new ShowTileCommand(this));</span>
<span class="nc" id="L450">        registerCommand(new ShowEntityCommand(this));</span>
<span class="nc" id="L451">        registerCommand(new RulerCommand(this));</span>
<span class="nc" id="L452">        registerCommand(new ShowValidTargetsCommand(this));</span>
<span class="nc" id="L453">        registerCommand(new AddBotCommand(this));</span>
<span class="nc" id="L454">        registerCommand(new CheckBVCommand(this));</span>
<span class="nc" id="L455">        registerCommand(new CheckBVTeamCommand(this));</span>
<span class="nc" id="L456">        registerCommand(new NukeCommand(this));</span>
<span class="nc" id="L457">        registerCommand(new TraitorCommand(this));</span>
<span class="nc" id="L458">        registerCommand(new ListEntitiesCommand(this));</span>
<span class="nc" id="L459">        registerCommand(new AssignNovaNetServerCommand(this));</span>
<span class="nc" id="L460">        registerCommand(new AllowTeamChangeCommand(this));</span>
<span class="nc" id="L461">        registerCommand(new JoinTeamCommand(this));</span>

        // register terrain processors
<span class="nc" id="L464">        terrainProcessors.add(new FireProcessor(this));</span>
<span class="nc" id="L465">        terrainProcessors.add(new SmokeProcessor(this));</span>
<span class="nc" id="L466">        terrainProcessors.add(new GeyserProcessor(this));</span>
<span class="nc" id="L467">        terrainProcessors.add(new ElevatorProcessor(this));</span>
<span class="nc" id="L468">        terrainProcessors.add(new ScreenProcessor(this));</span>
<span class="nc" id="L469">        terrainProcessors.add(new WeatherProcessor(this));</span>
<span class="nc" id="L470">        terrainProcessors.add(new QuicksandProcessor(this));</span>

<span class="nc" id="L472">        packetPump = new PacketPump();</span>
<span class="nc" id="L473">        packetPumpThread = new Thread(packetPump, &quot;Packet Pump&quot;);</span>
<span class="nc" id="L474">        packetPumpThread.start();</span>

<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (registerWithServerBrowser) {</span>

<span class="nc" id="L478">            final TimerTask register = new TimerTask() {</span>
                @Override
                public void run() {
<span class="nc" id="L481">                    registerWithServerBrowser(true,</span>
<span class="nc" id="L482">                                              Server.getServerInstance().metaServerUrl);</span>
<span class="nc" id="L483">                }</span>
            };
<span class="nc" id="L485">            serverBrowserUpdateTimer = new Timer(</span>
                    &quot;Server Browser Register Timer&quot;, true);
<span class="nc" id="L487">            serverBrowserUpdateTimer.schedule(register, 1, 40000);</span>
        }

        // Fully initialised, now accept connections
<span class="nc" id="L491">        connector = new Thread(this, &quot;Connection Listener&quot;);</span>
<span class="nc" id="L492">        connector.start();</span>

<span class="nc" id="L494">        serverInstance = this;</span>
<span class="nc" id="L495">    }</span>

    /**
     * Sets the game for this server. Restores any transient fields, and sets
     * all players as ghosts. This should only be called during server
     * initialization before any players have connected.
     */
    public void setGame(IGame g) {
        // game listeners are transient so we need to save and restore them
<span class="nc" id="L504">        Vector&lt;GameListener&gt; gameListenersClone = new Vector&lt;&gt;(getGame().getGameListeners());</span>

<span class="nc" id="L506">        game = g;</span>

<span class="nc bnc" id="L508" title="All 2 branches missed.">        for (GameListener listener : gameListenersClone) {</span>
<span class="nc" id="L509">            getGame().addGameListener(listener);</span>
<span class="nc" id="L510">        }</span>

<span class="nc" id="L512">        List&lt;Integer&gt; orphanEntities = new ArrayList&lt;&gt;();</span>
                
        // reattach the transient fields and ghost the players
<span class="nc bnc" id="L515" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L516">            Entity ent = e.next();</span>
<span class="nc" id="L517">            ent.setGame(game);</span>
            
<span class="nc bnc" id="L519" title="All 2 branches missed.">            if(ent.getOwner() == null) {</span>
<span class="nc" id="L520">                orphanEntities.add(ent.getId());</span>
<span class="nc" id="L521">                continue;</span>
            }
            
<span class="nc bnc" id="L524" title="All 2 branches missed.">            if (ent instanceof Mech) {</span>
<span class="nc" id="L525">                ((Mech) ent).setBAGrabBars();</span>
<span class="nc" id="L526">                ((Mech) ent).setProtomechClampMounts();</span>
            }
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (ent instanceof Tank) {</span>
<span class="nc" id="L529">                ((Tank) ent).setBAGrabBars();</span>
            }
<span class="nc" id="L531">        }</span>
        
<span class="nc" id="L533">        game.removeEntities(orphanEntities, IEntityRemovalConditions.REMOVE_UNKNOWN);</span>
        
<span class="nc" id="L535">        game.setOutOfGameEntitiesVector(game.getOutOfGameEntitiesVector());</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; e = game.getPlayers(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L537">            IPlayer p = e.nextElement();</span>
<span class="nc" id="L538">            p.setGame(game);</span>
<span class="nc" id="L539">            p.setGhost(true);</span>
<span class="nc" id="L540">        }</span>
        // might need to restore weapon type for some attacks that take multiple
        // turns (like artillery)
<span class="nc" id="L543">        for (Enumeration&lt;AttackHandler&gt; a = game.getAttacks(); a</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L545">            AttackHandler handler = a.nextElement();</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">            if (handler instanceof WeaponHandler) {</span>
<span class="nc" id="L547">                ((WeaponHandler) handler).restore();</span>
            }
<span class="nc" id="L549">        }</span>

<span class="nc" id="L551">    }</span>

    /**
     * Returns the current game object
     */
    public IGame getGame() {
<span class="nc" id="L557">        return game;</span>
    }

    /**
     * Make a default message o' the day containing the version string, and if
     * it was found, the build timestamp
     */
    private String createMotd() {
<span class="nc" id="L565">        StringBuilder motd = new StringBuilder();</span>
<span class="nc" id="L566">        motd.append(&quot;Welcome to MegaMek.  Server is running version &quot;).append(MegaMek.VERSION)</span>
<span class="nc" id="L567">                .append(&quot;, build date &quot;);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (MegaMek.TIMESTAMP &gt; 0L) {</span>
<span class="nc" id="L569">            motd.append(new Date(MegaMek.TIMESTAMP).toString());</span>
        } else {
<span class="nc" id="L571">            motd.append(&quot;unknown&quot;);</span>
        }
<span class="nc" id="L573">        motd.append('.');</span>

<span class="nc" id="L575">        return motd.toString();</span>
    }

    /**
     * @return true if the server has a password
     */
    public boolean isPassworded() {
<span class="nc bnc" id="L582" title="All 2 branches missed.">        return password != null;</span>
    }

    /**
     * @return true if the password matches
     */
    public boolean isPassword(Object guess) {
<span class="nc" id="L589">        return password.equals(guess);</span>
    }

    /**
     * Registers a new command in the server command table
     */
    private void registerCommand(ServerCommand command) {
<span class="nc" id="L596">        commandsHash.put(command.getName(), command);</span>
<span class="nc" id="L597">    }</span>

    /**
     * Returns the command associated with the specified name
     */
    public ServerCommand getCommand(String name) {
<span class="nc" id="L603">        return commandsHash.get(name);</span>
    }

    /**
     * Shuts down the server.
     */
    public void die() {
<span class="nc" id="L610">        watchdogTimer.cancel();</span>

        // kill thread accepting new connections
<span class="nc" id="L613">        connector = null;</span>
<span class="nc" id="L614">        packetPump.signalEnd();</span>
<span class="nc" id="L615">        packetPumpThread.interrupt();</span>
<span class="nc" id="L616">        packetPumpThread = null;</span>

        // close socket
        try {
<span class="nc" id="L620">            serverSocket.close();</span>
<span class="nc" id="L621">        } catch (IOException ignored) {</span>
<span class="nc" id="L622">        }</span>

        // kill pending connections
<span class="nc" id="L625">        for (Enumeration&lt;IConnection&gt; connEnum = connectionsPending.elements(); connEnum</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L627">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L628">            conn.close();</span>
<span class="nc" id="L629">        }</span>
<span class="nc" id="L630">        connectionsPending.removeAllElements();</span>

        // Send &quot;kill&quot; commands to all connections
        // N.B. I may be starting a race here.
<span class="nc bnc" id="L634" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L635">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L636">            send(conn.getId(), new Packet(Packet.COMMAND_CLOSE_CONNECTION));</span>
<span class="nc" id="L637">        }</span>

        // kill active connections
<span class="nc bnc" id="L640" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L641">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L642">            conn.close();</span>
<span class="nc" id="L643">        }</span>

<span class="nc" id="L645">        connections.removeAllElements();</span>
<span class="nc" id="L646">        connectionIds.clear();</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (serverBrowserUpdateTimer != null) {</span>
<span class="nc" id="L648">            serverBrowserUpdateTimer.cancel();</span>
        }
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (!metaServerUrl.equals(&quot;&quot;)) {</span>
<span class="nc" id="L651">            registerWithServerBrowser(false, metaServerUrl);</span>
        }

        // TODO : Not sure that this still needs to be here after updating to the new logging methods.
<span class="nc" id="L655">        System.out.flush();</span>
<span class="nc" id="L656">    }</span>

    /**
     * Returns an enumeration of all the command names
     */
    public Enumeration&lt;String&gt; getAllCommandNames() {
<span class="nc" id="L662">        return commandsHash.keys();</span>
    }

    /**
     * Sent when a client attempts to connect.
     */
    void greeting(int cn) {
        // send server greeting -- client should reply with client info.
<span class="nc" id="L670">        sendToPending(cn, new Packet(Packet.COMMAND_SERVER_GREETING));</span>
<span class="nc" id="L671">    }</span>

    /**
     * Returns a free connection id.
     */
    public int getFreeConnectionId() {
<span class="nc bnc" id="L677" title="All 2 branches missed.">        while ((getPendingConnection(connectionCounter) != null)</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">               || (getConnection(connectionCounter) != null)</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">               || (getPlayer(connectionCounter) != null)) {</span>
<span class="nc" id="L680">            connectionCounter++;</span>
        }
<span class="nc" id="L682">        return connectionCounter;</span>
    }

    /**
     * Returns a free entity id. Perhaps this should be in Game instead.
     */
    public int getFreeEntityId() {
<span class="nc" id="L689">        return game.getNextEntityId();</span>
    }

    /**
     * Allow the player to set whatever parameters he is able to
     */
    private void receivePlayerInfo(Packet packet, int connId) {
<span class="nc" id="L696">        IPlayer player = (IPlayer) packet.getObject(0);</span>
<span class="nc" id="L697">        IPlayer gamePlayer = game.getPlayer(connId);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">        if (null != gamePlayer) {</span>
<span class="nc" id="L699">            gamePlayer.setColour(player.getColour());</span>
<span class="nc" id="L700">            gamePlayer.setStartingPos(player.getStartingPos());</span>
<span class="nc" id="L701">            gamePlayer.setTeam(player.getTeam());</span>
<span class="nc" id="L702">            gamePlayer.setCamouflage(player.getCamouflage().clone());</span>
<span class="nc" id="L703">            gamePlayer.setNbrMFConventional(player.getNbrMFConventional());</span>
<span class="nc" id="L704">            gamePlayer.setNbrMFCommand(player.getNbrMFCommand());</span>
<span class="nc" id="L705">            gamePlayer.setNbrMFVibra(player.getNbrMFVibra());</span>
<span class="nc" id="L706">            gamePlayer.setNbrMFActive(player.getNbrMFActive());</span>
<span class="nc" id="L707">            gamePlayer.setNbrMFInferno(player.getNbrMFInferno());</span>
<span class="nc" id="L708">            if (gamePlayer.getConstantInitBonus()</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                != player.getConstantInitBonus()) {</span>
<span class="nc" id="L710">                sendServerChat(&quot;Player &quot; + gamePlayer.getName()</span>
                               + &quot; changed their initiative bonus from &quot;
<span class="nc" id="L712">                               + gamePlayer.getConstantInitBonus()</span>
<span class="nc" id="L713">                               + &quot; to &quot; + player.getConstantInitBonus() + &quot;.&quot;);</span>
            }
<span class="nc" id="L715">            gamePlayer.setConstantInitBonus(player.getConstantInitBonus());</span>
        }
<span class="nc" id="L717">    }</span>

    /**
     * Correct a duplicate player name
     *
     * @param oldName the &lt;code&gt;String&lt;/code&gt; old player name, that is a duplicate
     * @return the &lt;code&gt;String&lt;/code&gt; new player name
     */
    private String correctDupeName(String oldName) {
<span class="nc bnc" id="L726" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L727">            IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            if (player.getName().equals(oldName)) {</span>
                // We need to correct it.
<span class="nc" id="L730">                String newName = oldName;</span>
                int dupNum;
                try {
<span class="nc" id="L733">                    dupNum = Integer.parseInt(oldName.substring(oldName.lastIndexOf(&quot;.&quot;) + 1));</span>
<span class="nc" id="L734">                    dupNum++;</span>
<span class="nc" id="L735">                    newName = oldName.substring(0, oldName.lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L736">                } catch (Exception e) {</span>
                    // If this fails, we don't care much.
                    // Just assume it's the first time for this name.
<span class="nc" id="L739">                    dupNum = 2;</span>
<span class="nc" id="L740">                }</span>
<span class="nc" id="L741">                newName = newName.concat(&quot;.&quot;).concat(Integer.toString(dupNum));</span>
<span class="nc" id="L742">                return correctDupeName(newName);</span>
            }
<span class="nc" id="L744">        }</span>
<span class="nc" id="L745">        return oldName;</span>
    }

    private void receivePlayerVersion(Packet packet, int connId) {
<span class="nc" id="L749">        String version = (String) packet.getObject(0);</span>
<span class="nc" id="L750">        String clientChecksum = (String) packet.getObject(1);</span>
<span class="nc" id="L751">        String serverChecksum = MegaMek.getMegaMekSHA256();</span>
<span class="nc" id="L752">        StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L753">        boolean needs = false;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">        if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L755">            buf.append(&quot;Client/Server version mismatch. Server reports: &quot;).append(MegaMek.VERSION)</span>
<span class="nc" id="L756">                    .append(&quot;, Client reports: &quot;).append(version);</span>
<span class="nc" id="L757">            MegaMek.getLogger().error(&quot;Client/Server Version Mismatch -- Client: &quot; </span>
                    + version + &quot; Server: &quot; + MegaMek.VERSION);
<span class="nc" id="L759">            needs = true;</span>
        }
        // print a message indicating client doesn't have jar file
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (clientChecksum == null) {</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L764">                buf.append(System.lineSeparator()).append(System.lineSeparator());</span>
            }
<span class="nc" id="L766">            buf.append(&quot;Client Checksum is null. Client may not have a jar file&quot;);</span>
<span class="nc" id="L767">            MegaMek.getLogger().info(&quot;Client does not have a jar file&quot;);</span>
<span class="nc" id="L768">            needs = true;</span>
        // print message indicating server doesn't have jar file
<span class="nc bnc" id="L770" title="All 2 branches missed.">        } else if (serverChecksum == null) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L772">                buf.append(System.lineSeparator()).append(System.lineSeparator());</span>
            }
<span class="nc" id="L774">            buf.append(&quot;Server Checksum is null. Server may not have a jar file&quot;);</span>
<span class="nc" id="L775">            MegaMek.getLogger().info(&quot;Server does not have a jar file&quot;);</span>
<span class="nc" id="L776">            needs = true;</span>
        // print message indicating a client/server checksum mismatch
<span class="nc bnc" id="L778" title="All 2 branches missed.">        } else if (!clientChecksum.equals(serverChecksum)) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L780">                buf.append(System.lineSeparator());</span>
<span class="nc" id="L781">                buf.append(System.lineSeparator());</span>
            }
<span class="nc" id="L783">            buf.append(&quot;Client/Server checksum mismatch. Server reports: &quot;).append(serverChecksum)</span>
<span class="nc" id="L784">                    .append(&quot;, Client reports: &quot;).append(clientChecksum);</span>
<span class="nc" id="L785">            MegaMek.getLogger().error(&quot;Client/Server Checksum Mismatch -- Client: &quot; + clientChecksum </span>
                    + &quot; Server: &quot; + serverChecksum);

<span class="nc" id="L788">            needs = true;</span>
        }

        // Now, if we need to, send message!
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if (needs) {</span>
<span class="nc" id="L793">            IPlayer player = getPlayer(connId);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (null != player) {</span>
<span class="nc" id="L795">                sendServerChat(&quot;For &quot; + player.getName() + &quot; Server reports:&quot;</span>
<span class="nc" id="L796">                        + System.lineSeparator()</span>
<span class="nc" id="L797">                        + buf.toString());</span>
            }
<span class="nc" id="L799">        } else {</span>
<span class="nc" id="L800">            MegaMek.getLogger().info(&quot;SUCCESS: Client/Server Version (&quot; + version + &quot;) and Checksum (&quot; </span>
                    + clientChecksum + &quot;) matched&quot;);
        }
<span class="nc" id="L803">    }</span>

    /**
     * Receives a player name, sent from a pending connection, and connects that
     * connection.
     */
    private void receivePlayerName(Packet packet, int connId) {
<span class="nc" id="L810">        final IConnection conn = getPendingConnection(connId);</span>
<span class="nc" id="L811">        String name = (String) packet.getObject(0);</span>
<span class="nc" id="L812">        boolean returning = false;</span>

        // this had better be from a pending connection
<span class="nc bnc" id="L815" title="All 2 branches missed.">        if (conn == null) {</span>
<span class="nc" id="L816">            MegaMek.getLogger().warning(&quot;Got a client name from a non-pending connection&quot;);</span>
<span class="nc" id="L817">            return;</span>
        }

        // check if they're connecting with the same name as a ghost player
<span class="nc bnc" id="L821" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L822">            IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">            if (player.getName().equals(name)) {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                if (player.isGhost()) {</span>
<span class="nc" id="L825">                    returning = true;</span>
<span class="nc" id="L826">                    player.setGhost(false);</span>
                    // switch id
<span class="nc" id="L828">                    connId = player.getId();</span>
<span class="nc" id="L829">                    conn.setId(connId);</span>
                }
            }
<span class="nc" id="L832">        }</span>

<span class="nc bnc" id="L834" title="All 2 branches missed.">        if (!returning) {</span>
            // Check to avoid duplicate names...
<span class="nc" id="L836">            name = correctDupeName(name);</span>
<span class="nc" id="L837">            sendToPending(connId, new Packet(Packet.COMMAND_SERVER_CORRECT_NAME, name));</span>
        }

        // right, switch the connection into the &quot;active&quot; bin
<span class="nc" id="L841">        connectionsPending.removeElement(conn);</span>
<span class="nc" id="L842">        connections.addElement(conn);</span>
<span class="nc" id="L843">        connectionIds.put(conn.getId(), conn);</span>

        // add and validate the player info
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (!returning) {</span>
<span class="nc" id="L847">            addNewPlayer(connId, name);</span>
        }

        // if it is not the lounge phase, this player becomes an observer
<span class="nc" id="L851">        IPlayer player = getPlayer(connId);</span>
<span class="nc bnc" id="L852" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; (null != player)</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">            &amp;&amp; (game.getEntitiesOwnedBy(player) &lt; 1)) {</span>
<span class="nc" id="L854">            player.setObserver(true);</span>
        }

        // send the player the motd
<span class="nc" id="L858">        sendServerChat(connId, motd);</span>

        // send info that the player has connected
<span class="nc" id="L861">        send(createPlayerConnectPacket(connId));</span>

        // tell them their local playerId
<span class="nc" id="L864">        send(connId, new Packet(Packet.COMMAND_LOCAL_PN, connId));</span>

        // send current game info
<span class="nc" id="L867">        sendCurrentInfo(connId);</span>

<span class="nc" id="L869">        final boolean showIPAddressesInChat = PreferenceManager.getClientPreferences().getShowIPAddressesInChat();</span>

        try {
<span class="nc" id="L872">            InetAddress[] addresses = InetAddress.getAllByName(InetAddress</span>
<span class="nc" id="L873">                    .getLocalHost().getHostName());</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">            for (InetAddress address : addresses) {</span>
<span class="nc" id="L875">                MegaMek.getLogger().info(&quot;s: machine IP &quot; + address.getHostAddress());</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                if (showIPAddressesInChat) {</span>
<span class="nc" id="L877">                    sendServerChat(connId,</span>
<span class="nc" id="L878">                            &quot;Machine IP is &quot; + address.getHostAddress());</span>
                }
            }
<span class="nc" id="L881">        } catch (UnknownHostException e) {</span>
            // oh well.
<span class="nc" id="L883">        }</span>

<span class="nc" id="L885">        MegaMek.getLogger().info(&quot;s: listening on port &quot; + serverSocket.getLocalPort());</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">        if (showIPAddressesInChat) {</span>
            // Send the port we're listening on. Only useful for the player
            // on the server machine to check.
<span class="nc" id="L889">            sendServerChat(connId,</span>
<span class="nc" id="L890">                        &quot;Listening on port &quot; + serverSocket.getLocalPort());</span>
        }

        // Get the player *again*, because they may have disconnected.
<span class="nc" id="L894">        player = getPlayer(connId);</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L896">            String who = player.getName() + &quot; connected from &quot; + getClient(connId).getInetAddress();</span>
<span class="nc" id="L897">            MegaMek.getLogger().info(&quot;s: player #&quot; + connId + &quot;, &quot; + who);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">            if (showIPAddressesInChat) {</span>
<span class="nc" id="L899">                sendServerChat(who);</span>
            }

        } // Found the player

<span class="nc" id="L904">    }</span>

    /**
     * Sends a player the info they need to look at the current phase. This is
     * triggered when a player first connects to the server.
     */
    public void sendCurrentInfo(int connId) {
        // why are these two outside the player != null check below?
<span class="nc" id="L912">        transmitAllPlayerConnects(connId);</span>
<span class="nc" id="L913">        send(connId, createGameSettingsPacket());</span>
<span class="nc" id="L914">        send(connId, createPlanetaryConditionsPacket());</span>

<span class="nc" id="L916">        IPlayer player = game.getPlayer(connId);</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L918">            send(connId,</span>
                 new Packet(Packet.COMMAND_SENDING_MINEFIELDS, player
<span class="nc" id="L920">                         .getMinefields()));</span>

<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L923">                send(connId, createMapSettingsPacket());</span>
<span class="nc" id="L924">                send(createMapSizesPacket());</span>
                // Send Entities *after* the Lounge Phase Change
<span class="nc" id="L926">                send(connId,</span>
<span class="nc" id="L927">                        new Packet(Packet.COMMAND_PHASE_CHANGE, game.getPhase()));</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L929">                    send(connId, createFilteredFullEntitiesPacket(player));</span>
                } else {
<span class="nc" id="L931">                    send(connId, createFullEntitiesPacket());</span>
                }
            } else {
<span class="nc" id="L934">                send(connId, new Packet(Packet.COMMAND_ROUND_UPDATE, game.getRoundCount()));</span>
<span class="nc" id="L935">                send(connId, createBoardPacket());</span>
<span class="nc" id="L936">                send(connId, createAllReportsPacket(player));</span>

                // Send entities *before* other phase changes.
<span class="nc bnc" id="L939" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L940">                    send(connId, createFilteredFullEntitiesPacket(player));</span>
                } else {
<span class="nc" id="L942">                    send(connId, createFullEntitiesPacket());</span>
                }
<span class="nc bnc" id="L944" title="All 2 branches missed.">                player.setDone(game.getEntitiesOwnedBy(player) &lt;= 0);</span>
<span class="nc" id="L945">                send(connId, new Packet(Packet.COMMAND_PHASE_CHANGE, game.getPhase()));</span>
            }
<span class="nc bnc" id="L947" title="All 2 branches missed.">            if ((game.getPhase() == IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD)</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_PHYSICAL)) {</span>
                // can't go above, need board to have been sent
<span class="nc" id="L952">                send(connId, createAttackPacket(game.getActionsVector(), 0));</span>
<span class="nc" id="L953">                send(connId, createAttackPacket(game.getChargesVector(), 1));</span>
<span class="nc" id="L954">                send(connId, createAttackPacket(game.getRamsVector(), 1));</span>
<span class="nc" id="L955">                send(connId, createAttackPacket(game.getTeleMissileAttacksVector(), 1));</span>
            }
            
<span class="nc bnc" id="L958" title="All 4 branches missed.">            if (game.phaseHasTurns(game.getPhase()) &amp;&amp; game.hasMoreTurns()) {</span>
<span class="nc" id="L959">                send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L960">                send(connId, createTurnIndexPacket(connId));</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">            } else if (game.getPhase() != IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L962">                endCurrentPhase();</span>
            }

<span class="nc" id="L965">            send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L966">            send(connId, createFlarePacket());</span>
<span class="nc" id="L967">            send(connId, createSpecialHexDisplayPacket(connId));</span>

        } // Found the player.

<span class="nc" id="L971">    }</span>

    /**
     * Resend entities to the player called by SeeAll command
     */
    public void sendEntities(int connId) {
<span class="nc bnc" id="L977" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L978">            send(connId, createFilteredEntitiesPacket(getPlayer(connId), null));</span>
        } else {
<span class="nc" id="L980">            send(connId, createEntitiesPacket());</span>
        }
<span class="nc" id="L982">    }</span>

    /**
     * Adds a new player to the game
     */
    private IPlayer addNewPlayer(int connId, String name) {
<span class="nc" id="L988">        int team = IPlayer.TEAM_UNASSIGNED;</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">        if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L990">            team = IPlayer.TEAM_NONE;</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">            for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">                if (p.getTeam() &gt; team) {</span>
<span class="nc" id="L993">                    team = p.getTeam();</span>
                }
<span class="nc" id="L995">            }</span>
<span class="nc" id="L996">            team++;</span>
        }
<span class="nc" id="L998">        IPlayer newPlayer = new Player(connId, name);</span>
<span class="nc" id="L999">        PlayerColour colour = newPlayer.getColour();</span>
<span class="nc" id="L1000">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc" id="L1001">        final PlayerColour[] colours = PlayerColour.values();</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L1003">            final IPlayer p = players.nextElement();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            if (p.getId() == newPlayer.getId()) {</span>
<span class="nc" id="L1005">                continue;</span>
            }

<span class="nc bnc" id="L1008" title="All 4 branches missed.">            if ((p.getColour() == colour) &amp;&amp; (colours.length &gt; (colour.ordinal() + 1))) {</span>
<span class="nc" id="L1009">                colour = colours[colour.ordinal() + 1];</span>
            }
<span class="nc" id="L1011">        }</span>
<span class="nc" id="L1012">        newPlayer.setColour(colour);</span>
<span class="nc" id="L1013">        newPlayer.setCamouflage(new Camouflage(Camouflage.COLOUR_CAMOUFLAGE, colour.name()));</span>
<span class="nc" id="L1014">        newPlayer.setTeam(Math.min(team, 5));</span>
<span class="nc" id="L1015">        game.addPlayer(connId, newPlayer);</span>
<span class="nc" id="L1016">        validatePlayerInfo(connId);</span>
<span class="nc" id="L1017">        return newPlayer;</span>
    }

    /**
     * Validates the player info.
     */
    public void validatePlayerInfo(int playerId) {
<span class="nc" id="L1024">        final IPlayer player = getPlayer(playerId);</span>

<span class="nc bnc" id="L1026" title="All 2 branches missed.">        if (player != null) {</span>
            // TODO : check for duplicate or reserved names

            // Colour Assignment
<span class="nc" id="L1030">            final PlayerColour[] playerColours = PlayerColour.values();</span>
<span class="nc" id="L1031">            boolean allUsed = true;</span>
<span class="nc" id="L1032">            Set&lt;PlayerColour&gt; colourUtilization = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">            for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1034">                final IPlayer otherPlayer = i.nextElement();</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (otherPlayer.getId() != playerId) {</span>
<span class="nc" id="L1036">                    colourUtilization.add(otherPlayer.getColour());</span>
                } else {
<span class="nc" id="L1038">                    allUsed = false;</span>
                }
<span class="nc" id="L1040">            }</span>

<span class="nc bnc" id="L1042" title="All 4 branches missed.">            if (!allUsed &amp;&amp; colourUtilization.contains(player.getColour())) {</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                for (PlayerColour colour : playerColours) {</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">                    if (!colourUtilization.contains(colour)) {</span>
<span class="nc" id="L1045">                        player.setColour(colour);</span>
<span class="nc" id="L1046">                        break;</span>
                    }
                }
            }
        }
<span class="nc" id="L1051">    }</span>

    /**
     * Called when it's been determined that an actual player disconnected.
     * Notifies the other players and does the appropriate housekeeping.
     */
    void disconnected(IPlayer player) {
<span class="nc" id="L1058">        IGame.Phase phase = game.getPhase();</span>

        // in the lounge, just remove all entities for that player
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        if (phase == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1062">            removeAllEntitiesOwnedBy(player);</span>
        }

        // if a player has active entities, he becomes a ghost
        // except the VICTORY_PHASE when the disconnected
        // player is most likely the Bot disconnected after receiving
        // the COMMAND_END_OF_GAME command
        // see the Bug 1225949.
        // Ghost players (Bots mostly) are now removed during the
        // resetGame(), so we don't need to do it here.
        // This fixes Bug 3399000 without reintroducing 1225949
<span class="nc bnc" id="L1073" title="All 4 branches missed.">        if ((phase == IGame.Phase.PHASE_VICTORY)</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            || (phase == IGame.Phase.PHASE_LOUNGE) || player.isObserver()) {</span>
<span class="nc" id="L1075">            game.removePlayer(player.getId());</span>
<span class="nc" id="L1076">            send(new Packet(Packet.COMMAND_PLAYER_REMOVE, player.getId()));</span>
            // Prevent situation where all players but the disconnected one
            // are done, and the disconnecting player causes the game to start
<span class="nc bnc" id="L1079" title="All 2 branches missed.">            if (phase == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1080">                resetActivePlayersDone();</span>
            }
        } else {
<span class="nc" id="L1083">            player.setGhost(true);</span>
<span class="nc" id="L1084">            player.setDone(true);</span>
<span class="nc" id="L1085">            send(createPlayerUpdatePacket(player.getId()));</span>
        }

        // make sure the game advances
<span class="nc bnc" id="L1089" title="All 4 branches missed.">        if (game.phaseHasTurns(game.getPhase()) &amp;&amp; (null != game.getTurn())) {</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">            if (game.getTurn().isValid(player.getId(), game)) {</span>
<span class="nc" id="L1091">                sendGhostSkipMessage(player);</span>
            }
        } else {
<span class="nc" id="L1094">            checkReady();</span>
        }

        // notify other players
<span class="nc" id="L1098">        sendServerChat(player.getName() + &quot; disconnected.&quot;);</span>

        // log it
<span class="nc" id="L1101">        MegaMek.getLogger().info(&quot;s: removed player &quot; + player.getName());</span>

        // Reset the game after Elvis has left the building.
<span class="nc bnc" id="L1104" title="All 2 branches missed.">        if (0 == game.getNoOfPlayers()) {</span>
<span class="nc" id="L1105">            resetGame();</span>
        }
<span class="nc" id="L1107">    }</span>

    /**
     * Checks each player to see if he has no entities, and if true, sets the
     * observer flag for that player. An exception is that there are no
     * observers during the lounge phase.
     */
    public void checkForObservers() {
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; e = game.getPlayers(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1116">            IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            p.setObserver((game.getEntitiesOwnedBy(p) &lt; 1)</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">                          &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_LOUNGE));</span>
<span class="nc" id="L1119">        }</span>
<span class="nc" id="L1120">    }</span>

    /**
     * Reset the game back to the lounge.
     * TODO : couldn't this be a hazard if there are other things executing at the same time?
     */
    public void resetGame() {
        // remove all entities
<span class="nc" id="L1128">        game.reset();</span>
<span class="nc" id="L1129">        send(createEntitiesPacket());</span>
<span class="nc" id="L1130">        send(new Packet(Packet.COMMAND_SENDING_MINEFIELDS, new Vector&lt;&gt;()));</span>

        // remove ghosts
<span class="nc" id="L1133">        List&lt;IPlayer&gt; ghosts = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; players = game.getPlayers(); players.hasMoreElements(); ) {</span>
<span class="nc" id="L1135">            IPlayer p = players.nextElement();</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            if (p.isGhost()) {</span>
<span class="nc" id="L1137">                ghosts.add(p);</span>
            } else {
                // non-ghosts set their starting positions to any
<span class="nc" id="L1140">                p.setStartingPos(Board.START_ANY);</span>
<span class="nc" id="L1141">                send(createPlayerUpdatePacket(p.getId()));</span>
            }
<span class="nc" id="L1143">        }</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">        for (IPlayer p : ghosts) {</span>
<span class="nc" id="L1145">            game.removePlayer(p.getId());</span>
<span class="nc" id="L1146">            send(new Packet(Packet.COMMAND_PLAYER_REMOVE, p.getId()));</span>
<span class="nc" id="L1147">        }</span>

        // reset all players
<span class="nc" id="L1150">        resetPlayersDone();</span>
<span class="nc" id="L1151">        transmitAllPlayerDones();</span>

        // Write end of game to stdout so controlling scripts can rotate logs.
<span class="nc" id="L1154">        SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss z&quot;);</span>
<span class="nc" id="L1155">        MegaMek.getLogger().info(format.format(new Date()) + &quot; END OF GAME&quot;);</span>

<span class="nc" id="L1157">        changePhase(IGame.Phase.PHASE_LOUNGE);</span>
<span class="nc" id="L1158">    }</span>

    /**
     * automatically save the game
     */
    public void autoSave() {
<span class="nc" id="L1164">        String fileName = &quot;autosave&quot;;</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">        if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L1166">            fileName = StringUtil.addDateTimeStamp(fileName);</span>
        }
<span class="nc" id="L1168">        saveGame(fileName, game.getOptions().booleanOption(OptionsConstants.BASE_AUTOSAVE_MSG));</span>
<span class="nc" id="L1169">    }</span>

    /**
     * save the game and send it to the specified connection
     *
     * @param connId     The &lt;code&gt;int&lt;/code&gt; connection id to send to
     * @param sFile      The &lt;code&gt;String&lt;/code&gt; filename to use
     * @param sLocalPath The &lt;code&gt;String&lt;/code&gt; path to the file to be used on the
     *                   client
     */
    public void sendSaveGame(int connId, String sFile, String sLocalPath) {
<span class="nc" id="L1180">        saveGame(sFile, false);</span>
<span class="nc" id="L1181">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav.gz&quot;)) {</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">            if (sFinalFile.endsWith(&quot;.sav&quot;)) {</span>
<span class="nc" id="L1184">                sFinalFile = sFile + &quot;.gz&quot;;</span>
            } else {
<span class="nc" id="L1186">                sFinalFile = sFile + &quot;.sav.gz&quot;;</span>
            }
        }
<span class="nc" id="L1189">        sLocalPath = sLocalPath.replaceAll(&quot;\\|&quot;, &quot; &quot;);</span>
<span class="nc" id="L1190">        String localFile = &quot;savegames&quot; + File.separator + sFinalFile;</span>
<span class="nc" id="L1191">        try (InputStream in = new FileInputStream(localFile); InputStream bin = new BufferedInputStream(in)) {</span>
<span class="nc" id="L1192">            List&lt;Integer&gt; data = new ArrayList&lt;&gt;();</span>
            int input;
<span class="nc bnc" id="L1194" title="All 2 branches missed.">            while ((input = bin.read()) != -1) {</span>
<span class="nc" id="L1195">                data.add(input);</span>
            }
<span class="nc" id="L1197">            send(connId, new Packet(Packet.COMMAND_SEND_SAVEGAME, new Object[]{</span>
                    sFinalFile, data, sLocalPath}));
<span class="nc" id="L1199">            sendChat(connId, &quot;***Server&quot;, &quot;Save game has been sent to you.&quot;);</span>
<span class="nc" id="L1200">        } catch (Exception e) {</span>
<span class="nc" id="L1201">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + localFile, e);</span>
<span class="nc" id="L1202">        }</span>
<span class="nc" id="L1203">    }</span>

    /**
     * save the game
     *
     * @param sFile    The &lt;code&gt;String&lt;/code&gt; filename to use
     * @param sendChat A &lt;code&gt;boolean&lt;/code&gt; value whether or not to announce the
     *                 saving to the server chat.
     */
    public void saveGame(String sFile, boolean sendChat) {
        // We need to strip the .gz if it exists,
        // otherwise we'll double up on it.
<span class="nc bnc" id="L1215" title="All 2 branches missed.">        if (sFile.endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1216">            sFile = sFile.replace(&quot;.gz&quot;, &quot;&quot;);</span>
        }
<span class="nc" id="L1218">        XStream xstream = new XStream();</span>

        // This will make save games much smaller
        // by using a more efficient means of referencing
        // objects in the XML graph
<span class="nc" id="L1223">        xstream.setMode(XStream.ID_REFERENCES);</span>

<span class="nc" id="L1225">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav&quot;)) {</span>
<span class="nc" id="L1227">            sFinalFile = sFile + &quot;.sav&quot;;</span>
        }
<span class="nc" id="L1229">        File sDir = new File(&quot;savegames&quot;);</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">        if (!sDir.exists()) {</span>
<span class="nc" id="L1231">            sDir.mkdir();</span>
        }

<span class="nc" id="L1234">        sFinalFile = sDir + File.separator + sFinalFile;</span>

<span class="nc" id="L1236">        try (OutputStream os = new FileOutputStream(sFinalFile + &quot;.gz&quot;);</span>
<span class="nc" id="L1237">             OutputStream gzo = new GZIPOutputStream(os);</span>
<span class="nc" id="L1238">             Writer writer = new OutputStreamWriter(gzo, StandardCharsets.UTF_8)) {</span>

<span class="nc" id="L1240">            xstream.toXML(game, writer);</span>
<span class="nc" id="L1241">        } catch (Exception e) {</span>
<span class="nc" id="L1242">            MegaMek.getLogger().error(&quot;Unable to save file: &quot; + sFinalFile, e);</span>
<span class="nc" id="L1243">        }</span>

<span class="nc bnc" id="L1245" title="All 2 branches missed.">        if (sendChat) {</span>
<span class="nc" id="L1246">            sendChat(&quot;MegaMek&quot;, &quot;Game saved to &quot; + sFinalFile);</span>
        }
<span class="nc" id="L1248">    }</span>

    /**
     * save the game
     *
     * @param sFile The &lt;code&gt;String&lt;/code&gt; filename to use
     */
    public void saveGame(String sFile) {
<span class="nc" id="L1256">        saveGame(sFile, true);</span>
<span class="nc" id="L1257">    }</span>

    /**
     * send a packet to the connection tells it load a locally saved game
     *
     * @param connId The &lt;code&gt;int&lt;/code&gt; connection id to send to
     * @param sFile  The &lt;code&gt;String&lt;/code&gt; filename to use
     */
    public void sendLoadGame(int connId, String sFile) {
<span class="nc" id="L1266">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1267" title="All 4 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav&quot;) &amp;&amp; !sFinalFile.endsWith(&quot;.sav.gz&quot;)) {</span>
<span class="nc" id="L1268">            sFinalFile = sFile + &quot;.sav&quot;;</span>
        }
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1271">            sFinalFile = sFinalFile + &quot;.gz&quot;;</span>
        }
<span class="nc" id="L1273">        send(connId, new Packet(Packet.COMMAND_LOAD_SAVEGAME, new Object[]{sFinalFile}));</span>
<span class="nc" id="L1274">    }</span>

    /**
     * load the game
     *
     * @param f The &lt;code&gt;File&lt;/code&gt; to load
     * @return A &lt;code&gt;boolean&lt;/code&gt; value whether or not the loading was successful
     */
    public boolean loadGame(File f) {
<span class="nc" id="L1283">        return loadGame(f, true);</span>
    }

    /**
     * load the game
     *
     * @param f
     *            The &lt;code&gt;File&lt;/code&gt; to load
     * @param sendInfo
     *            Determines whether the connections should be updated with
     *            current info. This may be false if some reconnection remapping
     *            needs to be done first.
     * @return A &lt;code&gt;boolean&lt;/code&gt; value whether or not the loading was successful
     */
    public boolean loadGame(File f, boolean sendInfo) {
<span class="nc" id="L1298">        MegaMek.getLogger().info(&quot;s: loading saved game file '&quot; + f + &quot;'&quot;);</span>

        IGame newGame;
<span class="nc" id="L1301">        try (InputStream is = new FileInputStream(f); InputStream gzi = new GZIPInputStream(is)) {</span>
<span class="nc" id="L1302">            XStream xstream = SerializationHelper.getXStream();</span>
<span class="nc" id="L1303">            newGame = (IGame) xstream.fromXML(gzi);</span>
<span class="nc" id="L1304">        } catch (Exception e) {</span>
<span class="nc" id="L1305">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + f, e);</span>
<span class="nc" id="L1306">            return false;</span>
<span class="nc" id="L1307">        }</span>

<span class="nc" id="L1309">        setGame(newGame);</span>

<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (!sendInfo) {</span>
<span class="nc" id="L1312">            return true;</span>
        }

        // update all the clients with the new game info
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        for (IConnection conn : connections) {</span>
<span class="nc" id="L1317">            sendCurrentInfo(conn.getId());</span>
<span class="nc" id="L1318">        }</span>
<span class="nc" id="L1319">        return true;</span>
    }

    /**
     * When the load command is used, there is a list of already connected
     * players which have assigned names and player id numbers with the id
     * numbers matching the connection numbers. When a new game is loaded, this
     * mapping may need to be updated. This method takes a map of player names
     * to their current ids, and uses the list of players to figure out what the
     * current ids should change to.
     *
     * @param nameToIdMap
     *            This maps a player name to the current connection ID
     * @param idToNameMap
     *            This maps a current conn ID to a player name, and is just the
     *            inverse mapping from nameToIdMap
     */
    public void remapConnIds(Map&lt;String, Integer&gt; nameToIdMap, Map&lt;Integer, String&gt; idToNameMap) {
        // Keeps track of connections without Ids
<span class="nc" id="L1338">        List&lt;IConnection&gt; unassignedConns = new ArrayList&lt;&gt;();</span>
       // Keep track of which ids are used
<span class="nc" id="L1340">        Set&lt;Integer&gt; usedPlayerIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1341">        Set&lt;String&gt; currentPlayerNames = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc" id="L1343">            currentPlayerNames.add(p.getName());</span>
<span class="nc" id="L1344">        }</span>
        // Map the old connection Id to new value
<span class="nc" id="L1346">        Map&lt;Integer,Integer&gt; connIdRemapping = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">        for (IPlayer p : game.getPlayersVector()) {</span>
            // Check to see if this player was already connected
<span class="nc" id="L1349">            Integer oldId = nameToIdMap.get(p.getName());</span>
<span class="nc bnc" id="L1350" title="All 4 branches missed.">            if ((oldId != null) &amp;&amp; (oldId != p.getId())) {</span>
<span class="nc" id="L1351">                connIdRemapping.put(oldId, p.getId());</span>
            }
            // If the old and new Ids match, make sure we remove ghost status
<span class="nc bnc" id="L1354" title="All 4 branches missed.">            if ((oldId != null) &amp;&amp; (oldId == p.getId())) {</span>
<span class="nc" id="L1355">                p.setGhost(false);</span>
            }
            // Check to see if this player's Id is taken
<span class="nc" id="L1358">            String oldName = idToNameMap.get(p.getId());</span>
<span class="nc bnc" id="L1359" title="All 4 branches missed.">            if ((oldName != null) &amp;&amp; !oldName.equals(p.getName())) {</span>
                // If this name doesn't belong to a current player, unassign it
<span class="nc bnc" id="L1361" title="All 2 branches missed.">                if (!currentPlayerNames.contains(oldName)) {</span>
<span class="nc" id="L1362">                    unassignedConns.add(connectionIds.get(p.getId()));</span>
                    // Make sure we don't add this to unassigned connections twice
<span class="nc" id="L1364">                    connectionIds.remove(p.getId());</span>
                }
                // If it does belong to a current player, it'll get handled
                // when that player comes up
            }
            // Keep track of what Ids are used
<span class="nc" id="L1370">            usedPlayerIds.add(p.getId());</span>
<span class="nc" id="L1371">        }</span>

        // Remap old connection Ids to new ones
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        for (Integer currConnId : connIdRemapping.keySet()) {</span>
<span class="nc" id="L1375">            Integer newId = connIdRemapping.get(currConnId);</span>
<span class="nc" id="L1376">            IConnection conn = connectionIds.get(currConnId);</span>
<span class="nc" id="L1377">            conn.setId(newId);</span>
            // If this Id is used, make sure we reassign that connection
<span class="nc bnc" id="L1379" title="All 2 branches missed.">            if (connectionIds.containsKey(newId)) {</span>
<span class="nc" id="L1380">                unassignedConns.add(connectionIds.get(newId));</span>
            }
            // Map the new Id
<span class="nc" id="L1383">            connectionIds.put(newId, conn);</span>

<span class="nc" id="L1385">            game.getPlayer(newId).setGhost(false);</span>
<span class="nc" id="L1386">            send(newId, new Packet(Packet.COMMAND_LOCAL_PN, newId));</span>
<span class="nc" id="L1387">        }</span>

        // It's possible we have players not in the saved game, add 'em
<span class="nc bnc" id="L1390" title="All 2 branches missed.">        for (IConnection conn : unassignedConns) {</span>
<span class="nc" id="L1391">            int newId = 0;</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">            while (usedPlayerIds.contains(newId)) {</span>
<span class="nc" id="L1393">                newId++;</span>
            }
<span class="nc" id="L1395">            String name = idToNameMap.get(conn.getId());</span>
<span class="nc" id="L1396">            conn.setId(newId);</span>
<span class="nc" id="L1397">            IPlayer newPlayer = addNewPlayer(newId, name);</span>
<span class="nc" id="L1398">            newPlayer.setObserver(true);</span>
<span class="nc" id="L1399">            connectionIds.put(newId,  conn);</span>
<span class="nc" id="L1400">            send(newId, new Packet(Packet.COMMAND_LOCAL_PN, newId));</span>
<span class="nc" id="L1401">        }</span>

        // Ensure all clients are up-to-date on player info
<span class="nc" id="L1404">        transmitAllPlayerUpdates();</span>
<span class="nc" id="L1405">    }</span>

    /**
     * Shortcut to game.getPlayer(id)
     */
    public IPlayer getPlayer(int id) {
<span class="nc" id="L1411">        return game.getPlayer(id);</span>
    }

    /**
     * Removes all entities owned by a player. Should only be called when it
     * won't cause trouble (the lounge, for instance, or between phases.)
     *
     * @param player whose entities are to be removed
     */
    private void removeAllEntitiesOwnedBy(IPlayer player) {
<span class="nc" id="L1421">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L1423" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1424">            final Entity entity = e.next();</span>

<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (entity.getOwner().equals(player)) {</span>
<span class="nc" id="L1427">                toRemove.addElement(entity);</span>
            }
<span class="nc" id="L1429">        }</span>

<span class="nc bnc" id="L1431" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1432">            int id = entity.getId();</span>
<span class="nc" id="L1433">            game.removeEntity(id, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
<span class="nc" id="L1434">            send(createRemoveEntityPacket(id, IEntityRemovalConditions.REMOVE_NEVER_JOINED));</span>
<span class="nc" id="L1435">        }</span>
<span class="nc" id="L1436">    }</span>

    /**
     * a shorter name for getConnection()
     */
    private IConnection getClient(int connId) {
<span class="nc" id="L1442">        return getConnection(connId);</span>
    }

    /**
     * Returns a connection, indexed by id
     */
    public Enumeration&lt;IConnection&gt; getConnections() {
<span class="nc" id="L1449">        return connections.elements();</span>
    }

    /**
     * Returns a connection, indexed by id
     */
    public IConnection getConnection(int connId) {
<span class="nc" id="L1456">        return connectionIds.get(connId);</span>
    }

    /**
     * Returns a pending connection
     */
    IConnection getPendingConnection(int connId) {
<span class="nc bnc" id="L1463" title="All 2 branches missed.">        for (IConnection conn : connectionsPending) {</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">            if (conn.getId() == connId) {</span>
<span class="nc" id="L1465">                return conn;</span>
            }
<span class="nc" id="L1467">        }</span>
<span class="nc" id="L1468">        return null;</span>
    }

    /**
     * Called at the beginning of each game round to reset values on this entity
     * that are reset every round
     */
    private void resetEntityRound() {
<span class="nc bnc" id="L1476" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1477">            Entity entity = e.next();</span>

<span class="nc" id="L1479">            entity.newRound(game.getRoundCount());</span>
<span class="nc" id="L1480">        }</span>
<span class="nc" id="L1481">    }</span>

    /**
     * Check a list of entity Ids for doomed entities and destroy those.
     */
    private void destroyDoomedEntities(Vector&lt;Integer&gt; entityIds) {
<span class="nc" id="L1487">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;(0, 10);</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">        for (Integer entityId : entityIds) {</span>
<span class="nc" id="L1489">            Entity entity = game.getEntity(entityId);</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L1491">                entity.setDestroyed(true);</span>

                // Is this unit swarming somebody? Better let go before
                // it's too late.
<span class="nc" id="L1495">                final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">                if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L1497">                    final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L1498">                    swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L1499">                    entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L1500">                    Report r = new Report(5165);</span>
<span class="nc" id="L1501">                    r.subject = swarmedId;</span>
<span class="nc" id="L1502">                    r.addDesc(swarmed);</span>
<span class="nc" id="L1503">                    addReport(r);</span>
<span class="nc" id="L1504">                    entityUpdate(swarmedId);</span>
                }
            }

<span class="nc bnc" id="L1508" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc" id="L1509">                toRemove.addElement(entity);</span>
            }
<span class="nc" id="L1511">        }</span>

        // actually remove all flagged entities
<span class="nc bnc" id="L1514" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1515">            int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L1516" title="All 2 branches missed.">            if (!entity.isSalvage()) {</span>
<span class="nc" id="L1517">                condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
            }
            // If we removed a unit during the movement phase that hasn't moved,
            // remove its turn.
<span class="nc bnc" id="L1521" title="All 4 branches missed.">            if ((game.getPhase() == Phase.PHASE_MOVEMENT) &amp;&amp; entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L1522">                game.removeTurnFor(entity);</span>
<span class="nc" id="L1523">                send(createTurnVectorPacket());</span>
            }
<span class="nc" id="L1525">            entityUpdate(entity.getId());</span>
<span class="nc" id="L1526">            game.removeEntity(entity.getId(), condition);</span>
<span class="nc" id="L1527">            send(createRemoveEntityPacket(entity.getId(), condition));</span>
<span class="nc" id="L1528">        }</span>
<span class="nc" id="L1529">    }</span>

    /**
     * Deploys elligible offboard entities.
     */
    private void deployOffBoardEntities() {
        // place off board entities actually off-board
<span class="nc" id="L1536">        Iterator&lt;Entity&gt; entities = game.getEntities();</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">        while (entities.hasNext()) {</span>
<span class="nc" id="L1538">            Entity en = entities.next();</span>
<span class="nc bnc" id="L1539" title="All 4 branches missed.">            if (en.isOffBoard() &amp;&amp; !en.isDeployed()) {</span>
<span class="nc" id="L1540">                en.deployOffBoard(game.getRoundCount());</span>
            }
<span class="nc" id="L1542">        }</span>
<span class="nc" id="L1543">    }</span>

    /**
     * Called at the beginning of each phase. Sets and resets any entity
     * parameters that need to be reset.
     */
    private void resetEntityPhase(IGame.Phase phase) {
        // first, mark doomed entities as destroyed and flag them
<span class="nc" id="L1551">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;(0, 10);</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1553">            final Entity entity = e.next();</span>
<span class="nc" id="L1554">            entity.newPhase(phase);</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L1556">                entity.setDestroyed(true);</span>

                // Is this unit swarming somebody? Better let go before
                // it's too late.
<span class="nc" id="L1560">                final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">                if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L1562">                    final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L1563">                    swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L1564">                    entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L1565">                    Report r = new Report(5165);</span>
<span class="nc" id="L1566">                    r.subject = swarmedId;</span>
<span class="nc" id="L1567">                    r.addDesc(swarmed);</span>
<span class="nc" id="L1568">                    addReport(r);</span>
<span class="nc" id="L1569">                    entityUpdate(swarmedId);</span>
                }
            }

<span class="nc bnc" id="L1573" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                if (game.getEntity(entity.getTransportId()) != null</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">                        &amp;&amp; game.getEntity(entity.getTransportId()).isLargeCraft()) {</span>
                    //Leaving destroyed entities in dropship bays alone here
                } else {
<span class="nc" id="L1578">                    toRemove.addElement(entity);</span>
                }
            }
<span class="nc" id="L1581">        }</span>

        // actually remove all flagged entities
<span class="nc bnc" id="L1584" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1585">            int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">            if (!entity.isSalvage()) {</span>
<span class="nc" id="L1587">                condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
            }

<span class="nc" id="L1590">            entityUpdate(entity.getId());</span>
<span class="nc" id="L1591">            game.removeEntity(entity.getId(), condition);</span>
<span class="nc" id="L1592">            send(createRemoveEntityPacket(entity.getId(), condition));</span>
<span class="nc" id="L1593">        }</span>

        // do some housekeeping on all the remaining
<span class="nc bnc" id="L1596" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1597">            final Entity entity = e.next();</span>

<span class="nc" id="L1599">            entity.applyDamage();</span>

<span class="nc" id="L1601">            entity.reloadEmptyWeapons();</span>

            // reset damage this phase
            // telemissiles need a record of damage last phase
<span class="nc" id="L1605">            entity.damageThisRound += entity.damageThisPhase;</span>
<span class="nc" id="L1606">            entity.damageThisPhase = 0;</span>
<span class="nc" id="L1607">            entity.engineHitsThisPhase = 0;</span>
<span class="nc" id="L1608">            entity.rolledForEngineExplosion = false;</span>
<span class="nc" id="L1609">            entity.dodging = false;</span>
<span class="nc" id="L1610">            entity.setShutDownThisPhase(false);</span>
<span class="nc" id="L1611">            entity.setStartupThisPhase(false);</span>

            // reset done to false

<span class="nc bnc" id="L1615" title="All 2 branches missed.">            if (phase == IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">                entity.setDone(!entity.shouldDeploy(game.getRoundCount()));</span>
            } else {
<span class="nc" id="L1618">                entity.setDone(false);</span>
            }

            // reset spotlights
<span class="nc" id="L1622">            entity.setIlluminated(false);</span>
<span class="nc" id="L1623">            entity.setUsedSearchlight(false);</span>
<span class="nc" id="L1624">            entity.setCarefulStand(false);</span>
<span class="nc" id="L1625">            entity.setNetworkBAP(false);</span>

<span class="nc bnc" id="L1627" title="All 2 branches missed.">            if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L1628">                ((MechWarrior) entity).setLanded(true);</span>
            }
<span class="nc" id="L1630">        }</span>
<span class="nc" id="L1631">        game.clearIlluminatedPositions();</span>
<span class="nc" id="L1632">        send(new Packet(Packet.COMMAND_CLEAR_ILLUM_HEXES));</span>
<span class="nc" id="L1633">    }</span>

    /*
     *  Called during the end phase. Checks each entity for ASEW effects counters and decrements them by 1 if &gt; 0
     */

    public void decrementASEWTurns() {
<span class="nc bnc" id="L1640" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1641">            final Entity entity = e.next();</span>
            // Decrement ASEW effects
<span class="nc bnc" id="L1643" title="All 2 branches missed.">            if ((entity.getEntityType() &amp; Entity.ETYPE_DROPSHIP) == Entity.ETYPE_DROPSHIP) {</span>
<span class="nc" id="L1644">                Dropship d = (Dropship) entity;</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">                for (int loc = 0; loc &lt; d.locations(); loc++) {</span>
<span class="nc bnc" id="L1646" title="All 2 branches missed.">                    if (d.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L1647">                        d.setASEWAffected(loc, d.getASEWAffected(loc) - 1);</span>
                    }
                }
<span class="nc bnc" id="L1650" title="All 2 branches missed.">            } else if ((entity.getEntityType() &amp; Entity.ETYPE_JUMPSHIP) != 0) {</span>
<span class="nc" id="L1651">                Jumpship j = (Jumpship) entity;</span>
<span class="nc bnc" id="L1652" title="All 2 branches missed.">                for (int loc = 0; loc &lt; j.locations(); loc++) {</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                    if (j.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L1654">                        j.setASEWAffected(loc, j.getASEWAffected(loc) - 1);</span>
                    }
                }
<span class="nc" id="L1657">            } else {</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">                if (entity.getASEWAffected() &gt; 0) {</span>
<span class="nc" id="L1659">                    entity.setASEWAffected(entity.getASEWAffected() - 1);</span>
                }
            }
<span class="nc" id="L1662">        }</span>
<span class="nc" id="L1663">    }</span>


    /**
     * are we currently in a reporting phase
     *
     * @return &lt;code&gt;true&lt;/code&gt; if we are or &lt;code&gt;false&lt;/code&gt; if not.
     */
    private boolean isReportingPhase() {
<span class="nc bnc" id="L1672" title="All 2 branches missed.">        return (game.getPhase() == IGame.Phase.PHASE_FIRING_REPORT)</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_INITIATIVE_REPORT)</span>
<span class="nc bnc" id="L1674" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_MOVEMENT_REPORT)</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD_REPORT)</span>
<span class="nc bnc" id="L1676" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_PHYSICAL_REPORT);</span>
    }

    /**
     * Called at the beginning of certain phases to make every player not ready.
     */
    private void resetPlayersDone() {
<span class="nc bnc" id="L1683" title="All 2 branches missed.">        if (isReportingPhase()) {</span>
<span class="nc" id="L1684">            return;</span>
        }
<span class="nc bnc" id="L1686" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1687">            final IPlayer player = i.nextElement();</span>
<span class="nc" id="L1688">            player.setDone(false);</span>
<span class="nc" id="L1689">        }</span>
<span class="nc" id="L1690">        transmitAllPlayerDones();</span>
<span class="nc" id="L1691">    }</span>

    /**
     * Called at the beginning of certain phases to make every active player not
     * ready.
     */
    private void resetActivePlayersDone() {
        /*
         * if (isReportingPhase()) { return; }
         */
<span class="nc bnc" id="L1701" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1702">            final IPlayer player = i.nextElement();</span>

<span class="nc bnc" id="L1704" title="All 2 branches missed.">            player.setDone(game.getEntitiesOwnedBy(player) &lt;= 0);</span>

<span class="nc" id="L1706">        }</span>
<span class="nc" id="L1707">        transmitAllPlayerDones();</span>
<span class="nc" id="L1708">    }</span>

    /**
     * Writes the victory report
     */
    private void prepareVictoryReport() {
        Report r;

        // remove carcasses to the graveyard
<span class="nc" id="L1717">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L1718" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L1719" title="All 4 branches missed.">            if (e.isCarcass() &amp;&amp; !e.isDestroyed()) {</span>
<span class="nc" id="L1720">                toRemove.add(e);</span>
            }
<span class="nc" id="L1722">        }</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">        for (Entity e : toRemove) {</span>
<span class="nc" id="L1724">            destroyEntity(e, &quot;crew death&quot;, false, true);</span>
<span class="nc" id="L1725">            game.removeEntity(e.getId(), IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
<span class="nc" id="L1726">            e.setDestroyed(true);</span>
<span class="nc" id="L1727">        }</span>

<span class="nc" id="L1729">        addReport(new Report(7000, Report.PUBLIC));</span>

        // Declare the victor
<span class="nc" id="L1732">        r = new Report(1210);</span>
<span class="nc" id="L1733">        r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L1734" title="All 2 branches missed.">        if (game.getVictoryTeam() == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1735">            IPlayer player = getPlayer(game.getVictoryPlayerId());</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L1737">                r.messageId = 7005;</span>
            } else {
<span class="nc" id="L1739">                r.messageId = 7010;</span>
<span class="nc" id="L1740">                r.add(Server.getColorForPlayer(player));</span>
            }
<span class="nc" id="L1742">        } else {</span>
            // Team victory
<span class="nc" id="L1744">            r.messageId = 7015;</span>
<span class="nc" id="L1745">            r.add(game.getVictoryTeam());</span>
        }
<span class="nc" id="L1747">        addReport(r);</span>

        // Show player BVs
<span class="nc" id="L1750">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L1752">            IPlayer player = players.nextElement();</span>
            // Observers without initial entities get ignored
<span class="nc bnc" id="L1754" title="All 4 branches missed.">            if (player.isObserver() &amp;&amp; (player.getInitialEntityCount() == 0)) {</span>
<span class="nc" id="L1755">                continue;</span>
            }
<span class="nc" id="L1757">            r = new Report(7016, Report.PUBLIC);</span>
<span class="nc" id="L1758">            r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L1759">            r.add(player.getBV());</span>
<span class="nc" id="L1760">            r.add(player.getInitialBV());</span>
<span class="nc" id="L1761">            r.add(Double.toString(Math.round(((double) player.getBV() / player.getInitialBV()) * 10000.0) / 100.0));</span>
<span class="nc" id="L1762">            r.add(player.getFledBV());</span>
<span class="nc" id="L1763">            r.add(player.getEntityCount());</span>
<span class="nc" id="L1764">            r.add(player.getInitialEntityCount());</span>
<span class="nc" id="L1765">            r.add(Double.toString(Math.round(((double) player.getEntityCount() / player.getInitialEntityCount()) * 10000.0) / 100.0));</span>
<span class="nc" id="L1766">            addReport(r);</span>
<span class="nc" id="L1767">        }</span>

        // List the survivors
<span class="nc" id="L1770">        Iterator&lt;Entity&gt; survivors = game.getEntities();</span>
<span class="nc bnc" id="L1771" title="All 2 branches missed.">        if (survivors.hasNext()) {</span>
<span class="nc" id="L1772">            addReport(new Report(7020, Report.PUBLIC));</span>
<span class="nc bnc" id="L1773" title="All 2 branches missed.">            while (survivors.hasNext()) {</span>
<span class="nc" id="L1774">                Entity entity = survivors.next();</span>

<span class="nc bnc" id="L1776" title="All 2 branches missed.">                if (!entity.isDeployed()) {</span>
<span class="nc" id="L1777">                    continue;</span>
                }

<span class="nc" id="L1780">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1781">            }</span>
        }
        // List units that never deployed
<span class="nc" id="L1784">        Iterator&lt;Entity&gt; undeployed = game.getEntities();</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">        if (undeployed.hasNext()) {</span>
<span class="nc" id="L1786">            boolean wroteHeader = false;</span>

<span class="nc bnc" id="L1788" title="All 2 branches missed.">            while (undeployed.hasNext()) {</span>
<span class="nc" id="L1789">                Entity entity = undeployed.next();</span>

<span class="nc bnc" id="L1791" title="All 2 branches missed.">                if (entity.isDeployed()) {</span>
<span class="nc" id="L1792">                    continue;</span>
                }

<span class="nc bnc" id="L1795" title="All 2 branches missed.">                if (!wroteHeader) {</span>
<span class="nc" id="L1796">                    addReport(new Report(7075, Report.PUBLIC));</span>
<span class="nc" id="L1797">                    wroteHeader = true;</span>
                }

<span class="nc" id="L1800">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1801">            }</span>
        }
        // List units that retreated
<span class="nc" id="L1804">        Enumeration&lt;Entity&gt; retreat = game.getRetreatedEntities();</span>
<span class="nc bnc" id="L1805" title="All 2 branches missed.">        if (retreat.hasMoreElements()) {</span>
<span class="nc" id="L1806">            addReport(new Report(7080, Report.PUBLIC));</span>
<span class="nc bnc" id="L1807" title="All 2 branches missed.">            while (retreat.hasMoreElements()) {</span>
<span class="nc" id="L1808">                Entity entity = retreat.nextElement();</span>
<span class="nc" id="L1809">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1810">            }</span>
        }
        // List destroyed units
<span class="nc" id="L1813">        Enumeration&lt;Entity&gt; graveyard = game.getGraveyardEntities();</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">        if (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1815">            addReport(new Report(7085, Report.PUBLIC));</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1817">                Entity entity = graveyard.nextElement();</span>
<span class="nc" id="L1818">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1819">            }</span>
        }
        // List devastated units (not salvageable)
<span class="nc" id="L1822">        Enumeration&lt;Entity&gt; devastated = game.getDevastatedEntities();</span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">        if (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1824">            addReport(new Report(7090, Report.PUBLIC));</span>

<span class="nc bnc" id="L1826" title="All 2 branches missed.">            while (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1827">                Entity entity = devastated.nextElement();</span>
<span class="nc" id="L1828">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1829">            }</span>
        }
        // Let player know about entitystatus.txt file
<span class="nc" id="L1832">        addReport(new Report(7095, Report.PUBLIC));</span>
<span class="nc" id="L1833">    }</span>

    /**
     * Generates a detailed report for campaign use
     */
    private String getDetailedVictoryReport() {
<span class="nc" id="L1839">        StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L1841">        Vector&lt;Entity&gt; vAllUnits = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L1842" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L1843">            vAllUnits.addElement(i.next());</span>
        }

<span class="nc bnc" id="L1846" title="All 2 branches missed.">        for (Enumeration&lt;Entity&gt; i = game.getRetreatedEntities(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1847">            vAllUnits.addElement(i.nextElement());</span>
        }

<span class="nc bnc" id="L1850" title="All 2 branches missed.">        for (Enumeration&lt;Entity&gt; i = game.getGraveyardEntities(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1851">            vAllUnits.addElement(i.nextElement());</span>
        }

<span class="nc bnc" id="L1854" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
            // Record the player.
<span class="nc" id="L1856">            IPlayer p = i.nextElement();</span>
<span class="nc" id="L1857">            sb.append(&quot;++++++++++ &quot;).append(p.getName()).append(&quot; ++++++++++&quot;);</span>
<span class="nc" id="L1858">            sb.append(CommonConstants.NL);</span>

            // Record the player's alive, retreated, or salvageable units.
<span class="nc bnc" id="L1861" title="All 2 branches missed.">            for (int x = 0; x &lt; vAllUnits.size(); x++) {</span>
<span class="nc" id="L1862">                Entity e = vAllUnits.elementAt(x);</span>
<span class="nc bnc" id="L1863" title="All 2 branches missed.">                if (e.getOwner() == p) {</span>
<span class="nc" id="L1864">                    sb.append(UnitStatusFormatter.format(e));</span>
                }
            }

            // Record the player's devastated units.
<span class="nc" id="L1869">            Enumeration&lt;Entity&gt; devastated = game.getDevastatedEntities();</span>
<span class="nc bnc" id="L1870" title="All 2 branches missed.">            if (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1871">                sb.append(&quot;=============================================================&quot;);</span>
<span class="nc" id="L1872">                sb.append(CommonConstants.NL);</span>
<span class="nc" id="L1873">                sb.append(&quot;The following utterly destroyed units are not available for salvage:&quot;);</span>
<span class="nc" id="L1874">                sb.append(CommonConstants.NL);</span>
<span class="nc bnc" id="L1875" title="All 2 branches missed.">                while (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1876">                    Entity e = devastated.nextElement();</span>
<span class="nc bnc" id="L1877" title="All 2 branches missed.">                    if (e.getOwner() == p) {</span>
<span class="nc" id="L1878">                        sb.append(e.getShortName());</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">                        for (int pos = 0; pos &lt; e.getCrew().getSlotCount(); pos++) {</span>
<span class="nc" id="L1880">                            sb.append(&quot;, &quot;).append(e.getCrew().getNameAndRole(pos)).append(&quot; (&quot;)</span>
<span class="nc" id="L1881">                                .append(e.getCrew().getGunnery()).append('/')</span>
<span class="nc" id="L1882">                                .append(e.getCrew().getPiloting()).append(')');</span>
<span class="nc" id="L1883">                            sb.append(CommonConstants.NL);</span>
                        }
                    }
<span class="nc" id="L1886">                } // Handle the next non-salvageable unit for the player</span>
<span class="nc" id="L1887">                sb.append(&quot;=============================================================&quot;);</span>
<span class="nc" id="L1888">                sb.append(CommonConstants.NL);</span>
            }

<span class="nc" id="L1891">        } // Handle the next player</span>

<span class="nc" id="L1893">        return sb.toString();</span>
    }

    /**
     * Forces victory for the specified player, or his/her team at the end of
     * the round.
     */
    public void forceVictory(IPlayer victor) {
<span class="nc" id="L1901">        game.setForceVictory(true);</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">        if (victor.getTeam() == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1903">            game.setVictoryPlayerId(victor.getId());</span>
<span class="nc" id="L1904">            game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
        } else {
<span class="nc" id="L1906">            game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L1907">            game.setVictoryTeam(victor.getTeam());</span>
        }

<span class="nc" id="L1910">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        for (int i = 0; i &lt; playersVector.size(); i++) {</span>
<span class="nc" id="L1912">            IPlayer player = playersVector.elementAt(i);</span>
<span class="nc" id="L1913">            player.setAdmitsDefeat(false);</span>
        }
<span class="nc" id="L1915">    }</span>

    /**
     * Cancels the force victory
     */
    public void cancelVictory() {
<span class="nc" id="L1921">        game.setForceVictory(false);</span>
<span class="nc" id="L1922">        game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L1923">        game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
<span class="nc" id="L1924">    }</span>

    public void requestTeamChange(int team, IPlayer player) {
<span class="nc" id="L1927">        requestedTeam = team;</span>
<span class="nc" id="L1928">        playerChangingTeam = player;</span>
<span class="nc" id="L1929">        changePlayersTeam = false;</span>
<span class="nc" id="L1930">    }</span>

    public void allowTeamChange() {
<span class="nc" id="L1933">        changePlayersTeam = true;</span>
<span class="nc" id="L1934">    }</span>

    public boolean isTeamChangeRequestInProgress() {
<span class="nc bnc" id="L1937" title="All 2 branches missed.">        return playerChangingTeam != null;</span>
    }

    public IPlayer getPlayerRequestingTeamChange() {
<span class="nc" id="L1941">        return playerChangingTeam;</span>
    }

    public int getRequestedTeam() {
<span class="nc" id="L1945">        return requestedTeam;</span>
    }

    private void processTeamChange() {
<span class="nc bnc" id="L1949" title="All 2 branches missed.">        if (playerChangingTeam != null) {</span>
<span class="nc" id="L1950">            playerChangingTeam.setTeam(requestedTeam);</span>
<span class="nc" id="L1951">            game.setupTeams();</span>
<span class="nc" id="L1952">            send(createPlayerUpdatePacket(playerChangingTeam.getId()));</span>
<span class="nc" id="L1953">            String teamString = &quot;Team &quot; + requestedTeam + &quot;!&quot;;</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">            if (requestedTeam == IPlayer.TEAM_UNASSIGNED) {</span>
<span class="nc" id="L1955">                teamString = &quot; unassigned!&quot;;</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">            } else if (requestedTeam == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1957">                teamString = &quot; lone wolf!&quot;;</span>
            }
<span class="nc" id="L1959">            sendServerChat(playerChangingTeam.getName() + &quot; has changed teams to &quot; + teamString);</span>
<span class="nc" id="L1960">            playerChangingTeam = null;</span>
        }
<span class="nc" id="L1962">        changePlayersTeam = false;</span>
<span class="nc" id="L1963">    }</span>

    /**
     * Called when a player declares that he is &quot;done.&quot; Checks to see if all
     * players are done, and if so, moves on to the next phase.
     */
    private void checkReady() {
        // check if all active players are done
<span class="nc bnc" id="L1971" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1972">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L1973" title="All 6 branches missed.">            if (!player.isGhost() &amp;&amp; !player.isObserver() &amp;&amp; !player.isDone()) {</span>
<span class="nc" id="L1974">                return;</span>
            }
<span class="nc" id="L1976">        }</span>

        // Tactical Genius pilot special ability (lvl 3)
<span class="nc bnc" id="L1979" title="All 2 branches missed.">        if (game.getNoOfInitiativeRerollRequests() &gt; 0) {</span>
<span class="nc" id="L1980">            resetActivePlayersDone();</span>
<span class="nc" id="L1981">            game.rollInitAndResolveTies();</span>

<span class="nc" id="L1983">            determineTurnOrder(IGame.Phase.PHASE_INITIATIVE);</span>
<span class="nc" id="L1984">            clearReports();</span>
<span class="nc" id="L1985">            writeInitiativeReport(true);</span>
<span class="nc" id="L1986">            sendReport(true);</span>
<span class="nc" id="L1987">            return; // don't end the phase yet, players need to see new report</span>
        }

        // need at least one entity in the game for the lounge phase to end
<span class="nc bnc" id="L1991" title="All 4 branches missed.">        if (!game.phaseHasTurns(game.getPhase()) &amp;&amp; ((game.getPhase() != IGame.Phase.PHASE_LOUNGE)</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">                || (game.getNoOfEntities() &gt; 0))) {</span>
<span class="nc" id="L1993">            endCurrentPhase();</span>
        }
<span class="nc" id="L1995">    }</span>

    /**
     * Called when the current player has done his current turn and the turn
     * counter needs to be advanced. Also enforces the &quot;protos_move_multi&quot; and
     * the &quot;protos_move_multi&quot; option. If the player has just moved
     * infantry/protos with a &quot;normal&quot; turn, adds up to
     * Game.INF_AND_PROTOS_MOVE_MULTI - 1 more infantry/proto-specific turns
     * after the current turn.
     */
    private void endCurrentTurn(Entity entityUsed) {
        // Enforce &quot;inf_move_multi&quot; and &quot;protos_move_multi&quot; options.
        // The &quot;isNormalTurn&quot; flag is checking to see if any non-Infantry
        // or non-ProtoMech units can move during the current turn.
<span class="nc" id="L2009">        boolean turnsChanged = false;</span>
<span class="nc" id="L2010">        boolean outOfOrder = false;</span>
<span class="nc" id="L2011">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L2012" title="All 4 branches missed.">        if (game.isPhaseSimultaneous()</span>
            &amp;&amp; (entityUsed != null)
<span class="nc bnc" id="L2014" title="All 2 branches missed.">            &amp;&amp; !turn.isValid(entityUsed.getOwnerId(), game)) {</span>
            // turn played out of order
<span class="nc" id="L2016">            outOfOrder = true;</span>
<span class="nc" id="L2017">            entityUsed.setDone(false);</span>
<span class="nc" id="L2018">            GameTurn removed = game.removeFirstTurnFor(entityUsed);</span>
<span class="nc" id="L2019">            entityUsed.setDone(true);</span>
<span class="nc" id="L2020">            turnsChanged = true;</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">            if (removed != null) {</span>
<span class="nc" id="L2022">                turn = removed;</span>
            }
        }
<span class="nc" id="L2025">        final Phase currPhase = game.getPhase();</span>
<span class="nc" id="L2026">        final GameOptions gameOpts = game.getOptions();</span>
<span class="nc bnc" id="L2027" title="All 2 branches missed.">        final int playerId = null == entityUsed ? IPlayer.PLAYER_NONE : entityUsed.getOwnerId();</span>
<span class="nc" id="L2028">        boolean infMoved = entityUsed instanceof Infantry;</span>
<span class="nc bnc" id="L2029" title="All 8 branches missed.">        boolean infMoveMulti = gameOpts.booleanOption(OptionsConstants.INIT_INF_MOVE_MULTI)</span>
               &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                   || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                   || (currPhase == IGame.Phase.PHASE_INITIATIVE));
<span class="nc" id="L2033">        boolean protosMoved = entityUsed instanceof Protomech;</span>
<span class="nc" id="L2034">        boolean protosMoveMulti = gameOpts.booleanOption(OptionsConstants.INIT_PROTOS_MOVE_MULTI);</span>
<span class="nc" id="L2035">        boolean tanksMoved = entityUsed instanceof Tank;</span>
<span class="nc bnc" id="L2036" title="All 8 branches missed.">        boolean tanksMoveMulti = gameOpts.booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT)
                &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                    || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                    || (currPhase == IGame.Phase.PHASE_INITIATIVE));
<span class="nc" id="L2041">        boolean meksMoved = entityUsed instanceof Mech;</span>
<span class="nc bnc" id="L2042" title="All 8 branches missed.">        boolean meksMoveMulti = gameOpts.booleanOption(OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT)</span>
                &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                    || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                    || (currPhase == IGame.Phase.PHASE_INITIATIVE));

        // If infantry or protos move multi see if any
        // other unit types can move in the current turn.
<span class="nc" id="L2049">        int multiMask = 0;</span>
<span class="nc bnc" id="L2050" title="All 4 branches missed.">        if (infMoveMulti &amp;&amp; infMoved) {</span>
<span class="nc" id="L2051">            multiMask = GameTurn.CLASS_INFANTRY;</span>
<span class="nc bnc" id="L2052" title="All 4 branches missed.">        } else if (protosMoveMulti &amp;&amp; protosMoved) {</span>
<span class="nc" id="L2053">            multiMask = GameTurn.CLASS_PROTOMECH;</span>
<span class="nc bnc" id="L2054" title="All 4 branches missed.">        } else if (tanksMoveMulti &amp;&amp; tanksMoved) {</span>
<span class="nc" id="L2055">            multiMask = GameTurn.CLASS_TANK;</span>
<span class="nc bnc" id="L2056" title="All 4 branches missed.">        } else if (meksMoveMulti &amp;&amp; meksMoved) {</span>
<span class="nc" id="L2057">            multiMask = GameTurn.CLASS_MECH;</span>
        }

        // In certain cases, a new SpecificEntityTurn could have been added for
        // the Entity whose turn we are ending as the next turn. If this has
        // happened, the remaining entity count will be off and we must ensure
        // that the SpecificEntityTurn for this unit remains the next turn
<span class="nc" id="L2064">        List&lt;GameTurn&gt; turnVector = game.getTurnVector();</span>
<span class="nc" id="L2065">        int turnIndex = game.getTurnIndex();</span>
<span class="nc" id="L2066">        boolean usedEntityNotDone = false;</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">        if ((turnIndex + 1) &lt; turnVector.size()) {</span>
<span class="nc" id="L2068">            GameTurn nextTurn = turnVector.get(turnIndex + 1);</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">            if (nextTurn instanceof GameTurn.SpecificEntityTurn) {</span>
<span class="nc" id="L2070">                GameTurn.SpecificEntityTurn seTurn = (GameTurn.SpecificEntityTurn) nextTurn;</span>
<span class="nc bnc" id="L2071" title="All 4 branches missed.">                if ((entityUsed != null) &amp;&amp; (seTurn.getEntityNum() == entityUsed.getId())) {</span>
<span class="nc" id="L2072">                    turnIndex++;</span>
<span class="nc" id="L2073">                    usedEntityNotDone = true;</span>
                }
            }
        }

        // Was the turn we just took added as part of a multi-turn?
        //  This determines if we should add more multi-turns
<span class="nc" id="L2080">        boolean isMultiTurn = turn.isMultiTurn();</span>

        // Unless overridden by the &quot;protos_move_multi&quot; option, all ProtoMechs
        // in a unit declare fire, and they don't mix with infantry.
<span class="nc bnc" id="L2084" title="All 8 branches missed.">        if (protosMoved &amp;&amp; !protosMoveMulti &amp;&amp; !isMultiTurn &amp;&amp; (entityUsed != null)) {</span>

            // What's the unit number and ID of the entity used?
<span class="nc" id="L2087">            final short movingUnit = entityUsed.getUnitNumber();</span>
<span class="nc" id="L2088">            final int movingId = entityUsed.getId();</span>

            // How many other ProtoMechs are in the unit that can fire?
<span class="nc" id="L2091">            int protoTurns = game.getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L2092">                private final int ownerId = playerId;</span>

<span class="nc" id="L2094">                private final int entityId = movingId;</span>

<span class="nc" id="L2096">                private final short unitNum = movingUnit;</span>

                public boolean accept(Entity entity) {
<span class="nc bnc" id="L2099" title="All 2 branches missed.">                    return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L2100" title="All 2 branches missed.">                            &amp;&amp; entity.isSelectableThisTurn()</span>
<span class="nc bnc" id="L2101" title="All 2 branches missed.">                            &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L2102" title="All 2 branches missed.">                            &amp;&amp; (entityId != entity.getId())</span>
<span class="nc bnc" id="L2103" title="All 2 branches missed.">                            &amp;&amp; (unitNum == entity.getUnitNumber());</span>
                }
            });

            // Add the correct number of turns for the ProtoMech unit number.
<span class="nc bnc" id="L2108" title="All 2 branches missed.">            for (int i = 0; i &lt; protoTurns; i++) {</span>
<span class="nc" id="L2109">                GameTurn newTurn = new GameTurn.UnitNumberTurn(playerId, movingUnit);</span>
<span class="nc" id="L2110">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2111">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2112">                turnsChanged = true;</span>
            }
<span class="nc" id="L2114">        }</span>
        // Otherwise, we may need to add turns for the &quot;*_move_multi&quot; options.
<span class="nc bnc" id="L2116" title="All 10 branches missed.">        else if (((infMoved &amp;&amp; infMoveMulti) || (protosMoved &amp;&amp; protosMoveMulti)) &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2117">            int remaining = 0;</span>

            // Calculate the number of EntityClassTurns need to be added.
<span class="nc bnc" id="L2120" title="All 4 branches missed.">            if (infMoveMulti &amp;&amp; infMoved) {</span>
<span class="nc" id="L2121">                remaining += game.getInfantryLeft(playerId);</span>
            }
<span class="nc bnc" id="L2123" title="All 4 branches missed.">            if (protosMoveMulti &amp;&amp; protosMoved) {</span>
<span class="nc" id="L2124">                remaining += game.getProtomechsLeft(playerId);</span>
            }
<span class="nc bnc" id="L2126" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2127">                remaining--;</span>
            }
<span class="nc" id="L2129">            int moreInfAndProtoTurns = Math.min(</span>
<span class="nc" id="L2130">                    gameOpts.intOption(OptionsConstants.INIT_INF_PROTO_MOVE_MULTI) - 1, remaining);</span>

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2133" title="All 2 branches missed.">            for (int i = 0; i &lt; moreInfAndProtoTurns; i++) {</span>
<span class="nc" id="L2134">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2135">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2136">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2137">                turnsChanged = true;</span>
            }
        }

<span class="nc bnc" id="L2141" title="All 6 branches missed.">        if (tanksMoved &amp;&amp; tanksMoveMulti &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2142">            int remaining = game.getVehiclesLeft(playerId);</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2144">                remaining--;</span>
            }
<span class="nc" id="L2146">            int moreVeeTurns = Math.min(</span>
<span class="nc" id="L2147">                    gameOpts.intOption(OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT_NUMBER) - 1,</span>
                    remaining);

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2151" title="All 2 branches missed.">            for (int i = 0; i &lt; moreVeeTurns; i++) {</span>
<span class="nc" id="L2152">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2153">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2154">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2155">                turnsChanged = true;</span>
            }
        }

<span class="nc bnc" id="L2159" title="All 6 branches missed.">        if (meksMoved &amp;&amp; meksMoveMulti &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2160">            int remaining = game.getMechsLeft(playerId);</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2162">                remaining--;</span>
            }
<span class="nc" id="L2164">            int moreMekTurns = Math.min(</span>
<span class="nc" id="L2165">                    gameOpts.intOption(OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT_NUMBER) - 1,</span>
                    remaining);

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2169" title="All 2 branches missed.">            for (int i = 0; i &lt; moreMekTurns; i++) {</span>
<span class="nc" id="L2170">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2171">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2172">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2173">                turnsChanged = true;</span>
            }
        }

        // brief everybody on the turn update, if they changed
<span class="nc bnc" id="L2178" title="All 2 branches missed.">        if (turnsChanged) {</span>
<span class="nc" id="L2179">            send(createTurnVectorPacket());</span>
        }

        // move along
<span class="nc bnc" id="L2183" title="All 2 branches missed.">        if (outOfOrder) {</span>
<span class="nc" id="L2184">            send(createTurnIndexPacket(playerId));</span>
        } else {
<span class="nc" id="L2186">            changeToNextTurn(playerId);</span>
        }
<span class="nc" id="L2188">    }</span>

    /**
     * Changes the current phase, does some bookkeeping and then tells the
     * players.
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase to change to
     */
    private void changePhase(IGame.Phase phase) {
<span class="nc" id="L2197">        game.setLastPhase(game.getPhase());</span>
<span class="nc" id="L2198">        game.setPhase(phase);</span>

        // prepare for the phase
<span class="nc" id="L2201">        prepareForPhase(phase);</span>

<span class="nc bnc" id="L2203" title="All 2 branches missed.">        if (isPhasePlayable(phase)) {</span>
            // tell the players about the new phase
<span class="nc" id="L2205">            send(new Packet(Packet.COMMAND_PHASE_CHANGE, phase));</span>

            // post phase change stuff
<span class="nc" id="L2208">            executePhase(phase);</span>
        } else {
<span class="nc" id="L2210">            endCurrentPhase();</span>
        }
<span class="nc" id="L2212">    }</span>

    /**
     * Prepares for, presumably, the next phase. This typically involves
     * resetting the states of entities in the game and making sure the client
     * has the information it needs for the new phase.
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase to prepare for
     */
    private void prepareForPhase(IGame.Phase phase) {
<span class="nc bnc" id="L2222" title="All 10 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L2224">                clearReports();</span>
<span class="nc" id="L2225">                mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L2226">                        mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L2227">                mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L2228">                send(createMapSettingsPacket());</span>
<span class="nc" id="L2229">                send(createMapSizesPacket());</span>
<span class="nc" id="L2230">                checkForObservers();</span>
<span class="nc" id="L2231">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2232">                break;</span>
            case PHASE_INITIATIVE:
                // remove the last traces of last round
<span class="nc" id="L2235">                game.handleInitiativeCompensation();</span>
<span class="nc" id="L2236">                game.resetActions();</span>
<span class="nc" id="L2237">                game.resetTagInfo();</span>
<span class="nc" id="L2238">                sendTagInfoReset();</span>
<span class="nc" id="L2239">                clearReports();</span>
<span class="nc" id="L2240">                resetEntityRound();</span>
<span class="nc" id="L2241">                resetEntityPhase(phase);</span>
<span class="nc" id="L2242">                checkForObservers();</span>
<span class="nc" id="L2243">                transmitAllPlayerUpdates();</span>

                // roll 'em
<span class="nc" id="L2246">                resetActivePlayersDone();</span>
<span class="nc" id="L2247">                rollInitiative();</span>
                //Cockpit command consoles that switched crew on the previous round are ineligible for force
                //commander initiative bonus. Now that initiative is rolled, clear the flag.
<span class="nc" id="L2250">                game.getEntities().forEachRemaining(e -&gt; e.getCrew().resetActedFlag());</span>

<span class="nc bnc" id="L2252" title="All 2 branches missed.">                if (!game.shouldDeployThisRound()) {</span>
<span class="nc" id="L2253">                    incrementAndSendGameRound();</span>
                }

                // setIneligible(phase);
<span class="nc" id="L2257">                determineTurnOrder(phase);</span>
<span class="nc" id="L2258">                writeInitiativeReport(false);</span>

                // checks for environmental survival
<span class="nc" id="L2261">                checkForConditionDeath();</span>

<span class="nc" id="L2263">                checkForBlueShieldDamage();</span>
<span class="nc bnc" id="L2264" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L2265">                    checkForAtmosphereDeath();</span>
                }
<span class="nc bnc" id="L2267" title="All 2 branches missed.">                if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L2268">                    checkForSpaceDeath();</span>
                }

<span class="nc" id="L2271">                MegaMek.getLogger().info(&quot;Round &quot; + game.getRoundCount() + &quot; memory usage: &quot; + MegaMek.getMemoryUsed());</span>
<span class="nc" id="L2272">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L2274">                checkForObservers();</span>
<span class="nc" id="L2275">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2276">                resetActivePlayersDone();</span>
<span class="nc" id="L2277">                setIneligible(phase);</span>

<span class="nc" id="L2279">                Enumeration&lt;IPlayer&gt; e = game.getPlayers();</span>
<span class="nc" id="L2280">                Vector&lt;GameTurn&gt; turns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L2281" title="All 2 branches missed.">                while (e.hasMoreElements()) {</span>
<span class="nc" id="L2282">                    IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L2283" title="All 4 branches missed.">                    if (p.hasMinefields() &amp;&amp; game.getBoard().onGround()) {</span>
<span class="nc" id="L2284">                        GameTurn gt = new GameTurn(p.getId());</span>
<span class="nc" id="L2285">                        turns.addElement(gt);</span>
                    }
<span class="nc" id="L2287">                }</span>
<span class="nc" id="L2288">                game.setTurnVector(turns);</span>
<span class="nc" id="L2289">                game.resetTurnIndex();</span>

                // send turns to all players
<span class="nc" id="L2292">                send(createTurnVectorPacket());</span>
<span class="nc" id="L2293">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L2295">                deployOffBoardEntities();</span>
<span class="nc" id="L2296">                checkForObservers();</span>
<span class="nc" id="L2297">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2298">                resetActivePlayersDone();</span>
<span class="nc" id="L2299">                setIneligible(phase);</span>

<span class="nc" id="L2301">                Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc" id="L2302">                Vector&lt;GameTurn&gt; turn = new Vector&lt;&gt;();</span>

                // Walk through the players of the game, and add
                // a turn for all players with artillery weapons.
<span class="nc bnc" id="L2306" title="All 2 branches missed.">                while (players.hasMoreElements()) {</span>

                    // Get the next player.
<span class="nc" id="L2309">                    final IPlayer p = players.nextElement();</span>

                    // Does the player have any artillery-equipped units?
<span class="nc" id="L2312">                    EntitySelector playerArtySelector = new EntitySelector() {</span>
<span class="nc" id="L2313">                        private IPlayer owner = p;</span>

                        public boolean accept(Entity entity) {
<span class="nc bnc" id="L2316" title="All 4 branches missed.">                            return owner.equals(entity.getOwner()) &amp;&amp; entity.isEligibleForArtyAutoHitHexes();</span>
                        }
                    };
<span class="nc bnc" id="L2319" title="All 2 branches missed.">                    if (game.getSelectedEntities(playerArtySelector).hasNext()) {</span>
                        // Yes, the player has arty-equipped units.
<span class="nc" id="L2321">                        GameTurn gt = new GameTurn(p.getId());</span>
<span class="nc" id="L2322">                        turn.addElement(gt);</span>
                    }
<span class="nc" id="L2324">                }</span>
<span class="nc" id="L2325">                game.setTurnVector(turn);</span>
<span class="nc" id="L2326">                game.resetTurnIndex();</span>

                // send turns to all players
<span class="nc" id="L2329">                send(createTurnVectorPacket());</span>
<span class="nc" id="L2330">                break;</span>
            case PHASE_MOVEMENT:
            case PHASE_DEPLOYMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc" id="L2337">                deployOffBoardEntities();</span>

                // Check for activating hidden units
<span class="nc bnc" id="L2340" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L2341" title="All 2 branches missed.">                    for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L2342" title="All 2 branches missed.">                        if (ent.getHiddenActivationPhase() == phase) {</span>
<span class="nc" id="L2343">                            ent.setHidden(false);</span>
                        }
<span class="nc" id="L2345">                    }</span>
                }
                // Update visibility indications if using double blind.
<span class="nc bnc" id="L2348" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L2349">                    updateVisibilityIndicator(null);</span>
                }
<span class="nc" id="L2351">                resetEntityPhase(phase);</span>
<span class="nc" id="L2352">                checkForObservers();</span>
<span class="nc" id="L2353">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2354">                resetActivePlayersDone();</span>
<span class="nc" id="L2355">                setIneligible(phase);</span>
<span class="nc" id="L2356">                determineTurnOrder(phase);</span>
                // send(createEntitiesPacket());
<span class="nc" id="L2358">                entityAllUpdate();</span>
<span class="nc" id="L2359">                clearReports();</span>
<span class="nc" id="L2360">                doTryUnstuck();</span>
<span class="nc" id="L2361">                break;</span>
            case PHASE_END:
<span class="nc" id="L2363">                resetEntityPhase(phase);</span>
<span class="nc" id="L2364">                clearReports();</span>
<span class="nc" id="L2365">                resolveHeat();</span>
<span class="nc bnc" id="L2366" title="All 2 branches missed.">                if (game.getPlanetaryConditions().isSandBlowing()</span>
<span class="nc bnc" id="L2367" title="All 2 branches missed.">                    &amp;&amp; (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_LIGHT_GALE)) {</span>
<span class="nc" id="L2368">                    addReport(resolveBlowingSandDamage());</span>
                }
<span class="nc" id="L2370">                addReport(resolveControlRolls());</span>
<span class="nc" id="L2371">                addReport(checkForTraitors());</span>
                // write End Phase header
<span class="nc" id="L2373">                addReport(new Report(5005, Report.PUBLIC));</span>
<span class="nc" id="L2374">                checkLayExplosives();</span>
<span class="nc" id="L2375">                resolveHarJelRepairs();</span>
<span class="nc" id="L2376">                resolveEmergencyCoolantSystem();</span>
<span class="nc" id="L2377">                checkForSuffocation();</span>
<span class="nc" id="L2378">                game.getPlanetaryConditions().determineWind();</span>
<span class="nc" id="L2379">                send(createPlanetaryConditionsPacket());</span>

<span class="nc" id="L2381">                applyBuildingDamage();</span>
<span class="nc" id="L2382">                addReport(game.ageFlares());</span>
<span class="nc" id="L2383">                send(createFlarePacket());</span>
<span class="nc" id="L2384">                resolveAmmoDumps();</span>
<span class="nc" id="L2385">                resolveCrewWakeUp();</span>
<span class="nc" id="L2386">                resolveConsoleCrewSwaps();</span>
<span class="nc" id="L2387">                resolveSelfDestruct();</span>
<span class="nc" id="L2388">                resolveShutdownCrashes();</span>
<span class="nc" id="L2389">                checkForIndustrialEndOfTurn();</span>
<span class="nc" id="L2390">                resolveMechWarriorPickUp();</span>
<span class="nc" id="L2391">                resolveVeeINarcPodRemoval();</span>
<span class="nc" id="L2392">                resolveFortify();</span>

                // Moved this to the very end because it makes it difficult to see
                // more important updates when you have 300+ messages of smoke filling
                // whatever hex. Please don't move it above the other things again.
                // Thanks! Ralgith - 2018/03/15
<span class="nc" id="L2398">                hexUpdateSet.clear();</span>
<span class="nc bnc" id="L2399" title="All 2 branches missed.">                for (DynamicTerrainProcessor tp : terrainProcessors) {</span>
<span class="nc" id="L2400">                    tp.doEndPhaseChanges(vPhaseReport);</span>
<span class="nc" id="L2401">                }</span>
<span class="nc" id="L2402">                sendChangedHexes(hexUpdateSet);</span>

<span class="nc" id="L2404">                checkForObservers();</span>
<span class="nc" id="L2405">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2406">                entityAllUpdate();</span>
<span class="nc" id="L2407">                break;</span>
            case PHASE_INITIATIVE_REPORT: {
<span class="nc" id="L2409">                autoSave();</span>
                // Show player BVs
<span class="nc" id="L2411">                Enumeration&lt;IPlayer&gt; players2 = game.getPlayers();</span>
<span class="nc bnc" id="L2412" title="All 2 branches missed.">                while (players2.hasMoreElements()) {</span>
<span class="nc" id="L2413">                    IPlayer player = players2.nextElement();</span>
                    // Observers without initial entities get ignored
<span class="nc bnc" id="L2415" title="All 4 branches missed.">                    if (player.isObserver() &amp;&amp; (player.getInitialEntityCount() == 0)) {</span>
<span class="nc" id="L2416">                        continue;</span>
                    }
<span class="nc" id="L2418">                    Report r = new Report(7016, Report.PUBLIC);</span>
<span class="nc bnc" id="L2419" title="All 4 branches missed.">                    if (doBlind() &amp;&amp; suppressBlindBV()) {</span>
<span class="nc" id="L2420">                        r.type = Report.PLAYER;</span>
<span class="nc" id="L2421">                        r.player = player.getId();</span>
                    }
<span class="nc" id="L2423">                    r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L2424">                    r.add(player.getBV());</span>
<span class="nc" id="L2425">                    r.add(player.getInitialBV());</span>
<span class="nc" id="L2426">                    r.add(Double.toString(Math.round(((double) player.getBV() / player.getInitialBV()) * 10000.0) / 100.0));</span>
<span class="nc" id="L2427">                    r.add(player.getFledBV());</span>
<span class="nc" id="L2428">                    r.add(player.getEntityCount());</span>
<span class="nc" id="L2429">                    r.add(player.getInitialEntityCount());</span>
<span class="nc" id="L2430">                    r.add(Double.toString(Math.round(((double) player.getEntityCount() / player.getInitialEntityCount()) * 10000.0) / 100.0));</span>
<span class="nc" id="L2431">                    addReport(r);</span>
<span class="nc" id="L2432">                }</span>
            }
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
<span class="nc" id="L2440">                resetActivePlayersDone();</span>
<span class="nc" id="L2441">                sendReport();</span>
<span class="nc bnc" id="L2442" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PARANOID_AUTOSAVE)) {</span>
<span class="nc" id="L2443">                    autoSave();</span>
                }
                break;
            case PHASE_VICTORY:
<span class="nc" id="L2447">                resetPlayersDone();</span>
<span class="nc" id="L2448">                clearReports();</span>
<span class="nc" id="L2449">                prepareVictoryReport();</span>
<span class="nc" id="L2450">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2451">                RatingSystem.calculate(game);</span>
                // Before we send the full entities packet we need to loop
                // through the fighters in squadrons and damage them.
<span class="nc bnc" id="L2454" title="All 2 branches missed.">                for (Iterator&lt;Entity&gt; ents = game.getEntities(); ents.hasNext(); ) {</span>
<span class="nc" id="L2455">                    Entity entity = ents.next();</span>
<span class="nc bnc" id="L2456" title="All 4 branches missed.">                    if ((entity.isFighter()) &amp;&amp; !(entity instanceof FighterSquadron)) {</span>
<span class="nc bnc" id="L2457" title="All 4 branches missed.">                        if (entity.isPartOfFighterSquadron() || entity.isCapitalFighter()) {</span>
<span class="nc" id="L2458">                            ((IAero) entity).doDisbandDamage();</span>
                        }
                    }
                // fix the armor and SI of aeros if using aero sanity rules for
                // the MUL
<span class="nc bnc" id="L2463" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)</span>
                        &amp;&amp; (entity instanceof Aero)) {
                    // need to rescale SI and armor
<span class="nc" id="L2466">                    int scale = 1;</span>
<span class="nc bnc" id="L2467" title="All 2 branches missed.">                    if (entity.isCapitalScale()) {</span>
<span class="nc" id="L2468">                        scale = 10;</span>
                    }
<span class="nc" id="L2470">                    Aero a = (Aero) entity;</span>
<span class="nc" id="L2471">                    int currentSI = a.getSI() / (2 * scale);</span>
<span class="nc" id="L2472">                    a.set0SI(a.get0SI() / (2 * scale));</span>
<span class="nc bnc" id="L2473" title="All 2 branches missed.">                    if (currentSI &gt; 0) {</span>
<span class="nc" id="L2474">                        a.setSI(currentSI);</span>
                    }
                    //Fix for #587. MHQ tracks fighters at standard scale and doesn't (currently)
                    //track squadrons. Squadrons don't save to MUL either, so... only convert armor for JS/WS/SS?
                    //Do we ever need to save capital fighter armor to the final MUL or entityStatus?
<span class="nc bnc" id="L2479" title="All 2 branches missed.">                    if (!entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L2480">                        scale = 1;</span>
                    }
<span class="nc bnc" id="L2482" title="All 2 branches missed.">                    if (scale &gt; 1) {</span>
<span class="nc bnc" id="L2483" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc" id="L2484">                            int currentArmor = entity.getArmor(loc) / scale;</span>
<span class="nc bnc" id="L2485" title="All 2 branches missed.">                            if (entity.getOArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2486">                                entity.initializeArmor(entity.getOArmor(loc) / scale, loc);</span>
                            }
<span class="nc bnc" id="L2488" title="All 2 branches missed.">                            if (entity.getArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2489">                                entity.setArmor(currentArmor, loc);</span>
                            }
                        }
                    }
                }
<span class="nc" id="L2494">            }</span>
<span class="nc" id="L2495">                send(createFullEntitiesPacket());</span>
<span class="nc" id="L2496">                send(createReportPacket(null));</span>
<span class="nc" id="L2497">                send(createEndOfGamePacket());</span>
<span class="nc" id="L2498">                break;</span>
            default:
        }
<span class="nc" id="L2501">    }</span>

    /**
     * Should we play this phase or skip it?
     */
    private boolean isPhasePlayable(IGame.Phase phase) {
<span class="nc bnc" id="L2507" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_INITIATIVE:
            case PHASE_END:
<span class="nc" id="L2510">                return false;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_MOVEMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
<span class="nc" id="L2518">                return game.hasMoreTurns();</span>
            case PHASE_OFFBOARD:
<span class="nc" id="L2520">                return isOffboardPlayable();</span>
            default:
<span class="nc" id="L2522">                return true;</span>
        }
    }

    /**
     * Skip offboard phase, if there is no homing / semiguided ammo in play
     */
    private boolean isOffboardPlayable() {
<span class="nc bnc" id="L2530" title="All 2 branches missed.">        if (!game.hasMoreTurns()) {</span>
<span class="nc" id="L2531">            return false;</span>
        }
        
<span class="nc bnc" id="L2534" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext();) {</span>
<span class="nc" id="L2535">            Entity entity = e.next();</span>
<span class="nc bnc" id="L2536" title="All 2 branches missed.">            for (Mounted mounted : entity.getAmmo()) {</span>
<span class="nc" id="L2537">                AmmoType ammoType = (AmmoType) mounted.getType();</span>
                
                // per errata, TAG will spot for LRMs and such
<span class="nc bnc" id="L2540" title="All 2 branches missed.">                if ((ammoType.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L2541" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_NLRM)</span>
<span class="nc bnc" id="L2544" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MEK_MORTAR)) {</span>
<span class="nc" id="L2545">                    return true;</span>
                }
                
<span class="nc bnc" id="L2548" title="All 2 branches missed.">                if (((ammoType.getAmmoType() == AmmoType.T_ARROW_IV)</span>
<span class="nc bnc" id="L2549" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LONG_TOM)</span>
<span class="nc bnc" id="L2550" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_SNIPER)</span>
<span class="nc bnc" id="L2551" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_THUMPER))</span>
<span class="nc bnc" id="L2552" title="All 2 branches missed.">                        &amp;&amp; (ammoType.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L2553">                    return true;</span>
                }
<span class="nc" id="L2555">            }</span>
            
<span class="nc bnc" id="L2557" title="All 2 branches missed.">            for (Mounted b : entity.getBombs()) {</span>
<span class="nc bnc" id="L2558" title="All 4 branches missed.">                if (!b.isDestroyed() &amp;&amp; (b.getUsableShotsLeft() &gt; 0)</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">                    &amp;&amp; (((BombType) b.getType()).getBombType() == BombType.B_LG)) {</span>
<span class="nc" id="L2560">                    return true;</span>
                }
<span class="nc" id="L2562">            }</span>
<span class="nc" id="L2563">        }</span>
        
        // loop through all current attacks
        // if there are any that use homing ammo, we are playable
        // we need to do this because we might have a homing arty shot in flight
        // when the unit that mounted that ammo is no longer on the field
<span class="nc bnc" id="L2569" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; attacks = game.getAttacks(); attacks.hasMoreElements(); ) {</span>
<span class="nc" id="L2570">            AttackHandler attackHandler = attacks.nextElement();</span>
<span class="nc" id="L2571">            Mounted ammo = attackHandler.getWaa().getEntity(game)</span>
<span class="nc" id="L2572">                    .getEquipment(attackHandler.getWaa().getAmmoId());</span>
<span class="nc bnc" id="L2573" title="All 2 branches missed.">            if (ammo != null) {</span>
<span class="nc" id="L2574">                AmmoType ammoType = (AmmoType) ammo.getType();</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                if (ammoType.getMunitionType() == AmmoType.M_HOMING) {</span>
<span class="nc" id="L2576">                    return true;</span>
                }
            }
<span class="nc" id="L2579">        }</span>
<span class="nc" id="L2580">        return false;</span>
    }

    /**
     * Do anything we seed to start the new phase, such as give a turn to the
     * first player to play.
     */
    private void executePhase(IGame.Phase phase) {
<span class="nc bnc" id="L2588" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_EXCHANGE:
<span class="nc" id="L2590">                resetPlayersDone();</span>
                // Update initial BVs, as things may have been modified in lounge
<span class="nc bnc" id="L2592" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc" id="L2593">                    e.setInitialBV(e.calculateBattleValue(false, false));</span>
<span class="nc" id="L2594">                }</span>
<span class="nc" id="L2595">                calculatePlayerInitialCounts();</span>
                // Build teams vector
<span class="nc" id="L2597">                game.setupTeams();</span>
<span class="nc" id="L2598">                applyBoardSettings();</span>
<span class="nc" id="L2599">                game.getPlanetaryConditions().determineWind();</span>
<span class="nc" id="L2600">                send(createPlanetaryConditionsPacket());</span>
                // transmit the board to everybody
<span class="nc" id="L2602">                send(createBoardPacket());</span>
<span class="nc" id="L2603">                game.setupRoundDeployment();</span>
<span class="nc" id="L2604">                game.setVictoryContext(new HashMap&lt;&gt;());</span>
<span class="nc" id="L2605">                game.createVictoryConditions();</span>
                // some entities may need to be checked and updated
<span class="nc" id="L2607">                checkEntityExchange();</span>
<span class="nc" id="L2608">                break;</span>
            case PHASE_MOVEMENT:
                // write Movement Phase header to report
<span class="nc" id="L2611">                addReport(new Report(2000, Report.PUBLIC));</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc" id="L2619">                changeToNextTurn(-1);</span>
<span class="nc bnc" id="L2620" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PARANOID_AUTOSAVE)) {</span>
<span class="nc" id="L2621">                    autoSave();</span>
                }
                break;
            default:
        }
<span class="nc" id="L2626">    }</span>

    /**
     * Calculates the initial count and BV for all players, and thus should only be called at the
     * start of a game
     */
    public void calculatePlayerInitialCounts() {
<span class="nc bnc" id="L2633" title="All 2 branches missed.">        for (final Enumeration&lt;IPlayer&gt; players = game.getPlayers(); players.hasMoreElements(); ) {</span>
<span class="nc" id="L2634">            final IPlayer player = players.nextElement();</span>
<span class="nc" id="L2635">            player.setInitialEntityCount(player.getEntityCount());</span>
<span class="nc" id="L2636">            player.setInitialBV(player.getBV());</span>
<span class="nc" id="L2637">        }</span>
<span class="nc" id="L2638">    }</span>

    /**
     * loop through entities in the exchange phase (i.e. after leaving
     * chat lounge) and do any actions that need to be done
     */
    public void checkEntityExchange() {
<span class="nc bnc" id="L2645" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; entities = game.getEntities(); entities.hasNext(); ) {</span>
<span class="nc" id="L2646">            Entity entity = entities.next();</span>
            // apply bombs
<span class="nc bnc" id="L2648" title="All 2 branches missed.">            if (entity.isBomber()) {</span>
<span class="nc" id="L2649">                ((IBomber)entity).applyBombs();</span>
            }

<span class="nc bnc" id="L2652" title="All 2 branches missed.">            if (entity.isAero()) {</span>
<span class="nc" id="L2653">                IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L2654" title="All 2 branches missed.">                if (a.isSpaceborne()) {</span>
                    // altitude and elevation don't matter in space
<span class="nc" id="L2656">                    a.liftOff(0);</span>
                } else {
                    // check for grounding
<span class="nc bnc" id="L2659" title="All 4 branches missed.">                    if (game.getBoard().inAtmosphere() &amp;&amp; !entity.isAirborne()) {</span>
                        // you have to be airborne on the atmospheric map
<span class="nc" id="L2661">                        a.liftOff(entity.getAltitude());</span>
                    }
                }

<span class="nc bnc" id="L2665" title="All 2 branches missed.">                if (entity.isFighter()) {</span>
<span class="nc" id="L2666">                    a.updateWeaponGroups();</span>
<span class="nc" id="L2667">                    entity.loadAllWeapons();</span>
                }
            }

            // if units were loaded in the chat lounge, I need to keep track of
            // it here because they can get dumped in the deployment phase
<span class="nc bnc" id="L2673" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L2674">                Vector&lt;Integer&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L2675" title="All 2 branches missed.">                for (Entity en : entity.getLoadedUnits()) {</span>
<span class="nc" id="L2676">                    v.add(en.getId());</span>
<span class="nc" id="L2677">                }</span>
<span class="nc" id="L2678">                entity.setLoadedKeepers(v);</span>
            }

<span class="nc bnc" id="L2681" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)</span>
<span class="nc bnc" id="L2682" title="All 2 branches missed.">                    &amp;&amp; (entity.isAero())) {</span>
<span class="nc" id="L2683">                Aero a = null;</span>
<span class="nc bnc" id="L2684" title="All 2 branches missed.">                if (entity instanceof Aero) {</span>
<span class="nc" id="L2685">                    a = (Aero) entity;</span>
                }
<span class="nc bnc" id="L2687" title="All 2 branches missed.">                if (entity.isCapitalScale()) {</span>
<span class="nc bnc" id="L2688" title="All 2 branches missed.">                    if (a != null) {</span>
<span class="nc" id="L2689">                        int currentSI = a.getSI() * 20;</span>
<span class="nc" id="L2690">                        a.initializeSI(a.get0SI() * 20);</span>
<span class="nc" id="L2691">                        a.setSI(currentSI);</span>
                    }
<span class="nc bnc" id="L2693" title="All 2 branches missed.">                    if (entity.isCapitalFighter()) {</span>
<span class="nc" id="L2694">                        ((IAero)entity).autoSetCapArmor();</span>
<span class="nc" id="L2695">                        ((IAero)entity).autoSetFatalThresh();</span>
                    } else {
                        // all armor and SI is going to be at standard scale, so
                        // we need to adjust
<span class="nc bnc" id="L2699" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc bnc" id="L2700" title="All 2 branches missed.">                            if (entity.getArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2701">                                int currentArmor = entity.getArmor(loc) * 10;</span>
<span class="nc" id="L2702">                                entity.initializeArmor(entity.getOArmor(loc) * 10, loc);</span>
<span class="nc" id="L2703">                                entity.setArmor(currentArmor, loc);</span>

                            }
                        }
                    }
<span class="nc bnc" id="L2708" title="All 2 branches missed.">                } else if (a != null) {</span>
<span class="nc" id="L2709">                    int currentSI = a.getSI() * 2;</span>
<span class="nc" id="L2710">                    a.initializeSI(a.get0SI() * 2);</span>
<span class="nc" id="L2711">                    a.setSI(currentSI);</span>
                }
            }
            // Give the unit a spotlight, if it has the spotlight quirk
<span class="nc bnc" id="L2715" title="All 2 branches missed.">            entity.setExternalSpotlight(entity.hasExternaSpotlight()</span>
<span class="nc bnc" id="L2716" title="All 2 branches missed.">                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</span>
<span class="nc" id="L2717">            entityUpdate(entity.getId());</span>

            // Remove hot-loading some from LRMs for meks
<span class="nc bnc" id="L2720" title="All 2 branches missed.">            if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_HOTLOAD_IN_GAME)) {</span>
<span class="nc bnc" id="L2721" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
                    // Vehicles are allowed to hot load, just meks cannot
<span class="nc bnc" id="L2723" title="All 2 branches missed.">                    if (!(e instanceof Mech)) {</span>
<span class="nc" id="L2724">                        continue;</span>
                    }
<span class="nc bnc" id="L2726" title="All 2 branches missed.">                    for (Mounted weapon : e.getWeaponList()) {</span>
<span class="nc" id="L2727">                        weapon.getType().removeMode(&quot;HotLoad&quot;);</span>
<span class="nc" id="L2728">                    }</span>
<span class="nc bnc" id="L2729" title="All 2 branches missed.">                    for (Mounted ammo : e.getAmmo()) {</span>
<span class="nc" id="L2730">                        ammo.getType().removeMode(&quot;HotLoad&quot;);</span>
<span class="nc" id="L2731">                    }</span>
<span class="nc" id="L2732">                }</span>
            }
<span class="nc" id="L2734">        }</span>
<span class="nc" id="L2735">    }</span>

    /**
     * Ends this phase and moves on to the next.
     */
    private void endCurrentPhase() {
<span class="nc bnc" id="L2741" title="All 21 branches missed.">        switch (game.getPhase()) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L2743">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2744">                changePhase(IGame.Phase.PHASE_EXCHANGE);</span>
<span class="nc" id="L2745">                break;</span>
            case PHASE_EXCHANGE:
            case PHASE_STARTING_SCENARIO:
<span class="nc" id="L2748">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2749">                changePhase(IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES);</span>
<span class="nc" id="L2750">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L2752">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2753">                Enumeration&lt;IPlayer&gt; e = game.getPlayers();</span>
<span class="nc" id="L2754">                boolean mines = false;</span>
<span class="nc bnc" id="L2755" title="All 4 branches missed.">                while (e.hasMoreElements() &amp;&amp; !mines) {</span>
<span class="nc" id="L2756">                    IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L2757" title="All 2 branches missed.">                    if (p.hasMinefields()) {</span>
<span class="nc" id="L2758">                        mines = true;</span>
                    }
<span class="nc" id="L2760">                }</span>
<span class="nc" id="L2761">                game.addReports(vPhaseReport);</span>
<span class="nc bnc" id="L2762" title="All 2 branches missed.">                if (mines) {</span>
<span class="nc" id="L2763">                    changePhase(IGame.Phase.PHASE_DEPLOY_MINEFIELDS);</span>
                } else {
<span class="nc" id="L2765">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                }
<span class="nc" id="L2767">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L2769">                changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
<span class="nc" id="L2770">                break;</span>
            case PHASE_DEPLOYMENT:
<span class="nc" id="L2772">                game.clearDeploymentThisRound();</span>
<span class="nc" id="L2773">                game.checkForCompleteDeployment();</span>
<span class="nc" id="L2774">                Enumeration&lt;IPlayer&gt; pls = game.getPlayers();</span>
<span class="nc bnc" id="L2775" title="All 2 branches missed.">                while (pls.hasMoreElements()) {</span>
<span class="nc" id="L2776">                    IPlayer p = pls.nextElement();</span>
<span class="nc" id="L2777">                    p.adjustStartingPosForReinforcements();</span>
<span class="nc" id="L2778">                }</span>

<span class="nc bnc" id="L2780" title="All 2 branches missed.">                if (game.getRoundCount() &lt; 1) {</span>
<span class="nc" id="L2781">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                } else {
<span class="nc" id="L2783">                    changePhase(IGame.Phase.PHASE_TARGETING);</span>
                }
<span class="nc" id="L2785">                break;</span>
            case PHASE_INITIATIVE:
<span class="nc" id="L2787">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2788">                detectSpacecraft();</span>
<span class="nc" id="L2789">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2790">                changePhase(IGame.Phase.PHASE_INITIATIVE_REPORT);</span>
<span class="nc" id="L2791">                break;</span>
            case PHASE_INITIATIVE_REPORT:
                // NOTE: now that aeros can come and go from the battlefield, I
                // need
                // to update the
                // deployment table every round. I think this it is OK to go
                // here.
                // (Taharqa)
<span class="nc" id="L2799">                game.setupRoundDeployment();</span>
                // boolean doDeploy = game.shouldDeployThisRound() &amp;&amp;
                // (game.getLastPhase() != IGame.Phase.PHASE_DEPLOYMENT);
<span class="nc bnc" id="L2802" title="All 2 branches missed.">                if (game.shouldDeployThisRound()) {</span>
<span class="nc" id="L2803">                    changePhase(IGame.Phase.PHASE_DEPLOYMENT);</span>
                } else {
<span class="nc" id="L2805">                    changePhase(IGame.Phase.PHASE_TARGETING);</span>
                }
<span class="nc" id="L2807">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc" id="L2809">                detectHiddenUnits();</span>
<span class="nc" id="L2810">                updateSpacecraftDetection();</span>
<span class="nc" id="L2811">                detectSpacecraft();</span>
<span class="nc" id="L2812">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2813">                doAllAssaultDrops();</span>
<span class="nc" id="L2814">                addMovementHeat();</span>
<span class="nc" id="L2815">                applyBuildingDamage();</span>
<span class="nc" id="L2816">                checkForPSRFromDamage();</span>
<span class="nc" id="L2817">                addReport(resolvePilotingRolls()); // Skids cause damage in</span>
                // movement phase
<span class="nc" id="L2819">                checkForFlamingDamage();</span>
<span class="nc" id="L2820">                checkForTeleMissileAttacks();</span>
<span class="nc" id="L2821">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2822">                checkForFlawedCooling();</span>
<span class="nc" id="L2823">                resolveCallSupport();</span>
                // check phase report
<span class="nc bnc" id="L2825" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2826">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2827">                    changePhase(IGame.Phase.PHASE_MOVEMENT_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2830">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2831">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2832">                    sendReport();</span>
<span class="nc" id="L2833">                    changePhase(IGame.Phase.PHASE_OFFBOARD);</span>
                }
<span class="nc" id="L2835">                break;</span>
            case PHASE_MOVEMENT_REPORT:
<span class="nc" id="L2837">                changePhase(IGame.Phase.PHASE_OFFBOARD);</span>
<span class="nc" id="L2838">                break;</span>
            case PHASE_FIRING:
                // write Weapon Attack Phase header
<span class="nc" id="L2841">                addReport(new Report(3000, Report.PUBLIC));</span>
<span class="nc" id="L2842">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2843">                resolveAllButWeaponAttacks();</span>
<span class="nc" id="L2844">                resolveSelfDestructions();</span>
<span class="nc" id="L2845">                reportGhostTargetRolls();</span>
<span class="nc" id="L2846">                reportLargeCraftECCMRolls();</span>
<span class="nc" id="L2847">                resolveOnlyWeaponAttacks();</span>
<span class="nc" id="L2848">                assignAMS();</span>
<span class="nc" id="L2849">                handleAttacks();</span>
<span class="nc" id="L2850">                resolveScheduledNukes();</span>
<span class="nc" id="L2851">                applyBuildingDamage();</span>
<span class="nc" id="L2852">                checkForPSRFromDamage();</span>
<span class="nc" id="L2853">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2854">                addReport(resolvePilotingRolls());</span>
<span class="nc" id="L2855">                checkForFlawedCooling();</span>
                // check phase report
<span class="nc bnc" id="L2857" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2858">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2859">                    changePhase(IGame.Phase.PHASE_FIRING_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2862">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2863">                    sendReport();</span>
<span class="nc" id="L2864">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2865">                    changePhase(IGame.Phase.PHASE_PHYSICAL);</span>
                }
<span class="nc" id="L2867">                break;</span>
            case PHASE_FIRING_REPORT:
<span class="nc" id="L2869">                changePhase(IGame.Phase.PHASE_PHYSICAL);</span>
<span class="nc" id="L2870">                break;</span>
            case PHASE_PHYSICAL:
<span class="nc" id="L2872">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2873">                resolvePhysicalAttacks();</span>
<span class="nc" id="L2874">                applyBuildingDamage();</span>
<span class="nc" id="L2875">                checkForPSRFromDamage();</span>
<span class="nc" id="L2876">                addReport(resolvePilotingRolls());</span>
<span class="nc" id="L2877">                resolveSinkVees();</span>
<span class="nc" id="L2878">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2879">                checkForFlawedCooling();</span>
<span class="nc" id="L2880">                checkForChainWhipGrappleChecks();</span>
                // check phase report
<span class="nc bnc" id="L2882" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2883">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2884">                    changePhase(IGame.Phase.PHASE_PHYSICAL_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2887">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2888">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2889">                    sendReport();</span>
<span class="nc" id="L2890">                    changePhase(IGame.Phase.PHASE_END);</span>
                }
<span class="nc" id="L2892">                break;</span>
            case PHASE_PHYSICAL_REPORT:
<span class="nc" id="L2894">                changePhase(IGame.Phase.PHASE_END);</span>
<span class="nc" id="L2895">                break;</span>
            case PHASE_TARGETING:
<span class="nc" id="L2897">                vPhaseReport.addElement(new Report(1035, Report.PUBLIC));</span>
<span class="nc" id="L2898">                resolveAllButWeaponAttacks();</span>
<span class="nc" id="L2899">                resolveOnlyWeaponAttacks();</span>
<span class="nc" id="L2900">                handleAttacks();</span>
                // check reports
<span class="nc bnc" id="L2902" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2903">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2904">                    changePhase(IGame.Phase.PHASE_TARGETING_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2907">                    vPhaseReport.addElement(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2908">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2909">                    sendReport();</span>
<span class="nc" id="L2910">                    changePhase(IGame.Phase.PHASE_MOVEMENT);</span>
                }

<span class="nc" id="L2913">                sendSpecialHexDisplayPackets();</span>
<span class="nc bnc" id="L2914" title="All 2 branches missed.">                for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L2915">                    IPlayer player = i.nextElement();</span>
<span class="nc" id="L2916">                    int connId = player.getId();</span>
<span class="nc" id="L2917">                    send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L2918">                }</span>

<span class="nc" id="L2920">                break;</span>
            case PHASE_OFFBOARD:
                // write Offboard Attack Phase header
<span class="nc" id="L2923">                addReport(new Report(1100, Report.PUBLIC));</span>
<span class="nc" id="L2924">                resolveAllButWeaponAttacks(); // torso twist or flip arms</span>
                // possible
<span class="nc" id="L2926">                resolveOnlyWeaponAttacks(); // should only be TAG at this point</span>
<span class="nc" id="L2927">                handleAttacks();</span>
<span class="nc bnc" id="L2928" title="All 2 branches missed.">                for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L2929">                    IPlayer player = i.nextElement();</span>
<span class="nc" id="L2930">                    int connId = player.getId();</span>
<span class="nc" id="L2931">                    send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L2932">                }</span>
<span class="nc" id="L2933">                applyBuildingDamage();</span>
<span class="nc" id="L2934">                checkForPSRFromDamage();</span>
<span class="nc" id="L2935">                addReport(resolvePilotingRolls());</span>

<span class="nc" id="L2937">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2938">                checkForFlawedCooling();</span>

<span class="nc" id="L2940">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2941">                sendTagInfoUpdates();</span>

                // check reports
<span class="nc bnc" id="L2944" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2945">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2946">                    changePhase(IGame.Phase.PHASE_OFFBOARD_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2949">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2950">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2951">                    sendReport();</span>
<span class="nc" id="L2952">                    changePhase(IGame.Phase.PHASE_FIRING);</span>
                }
<span class="nc" id="L2954">                break;</span>
            case PHASE_OFFBOARD_REPORT:
<span class="nc" id="L2956">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2957">                changePhase(IGame.Phase.PHASE_FIRING);</span>
<span class="nc" id="L2958">                break;</span>
            case PHASE_TARGETING_REPORT:
<span class="nc" id="L2960">                changePhase(IGame.Phase.PHASE_MOVEMENT);</span>
<span class="nc" id="L2961">                break;</span>
            case PHASE_END:
                // remove any entities that died in the heat/end phase before
                // checking for victory
<span class="nc" id="L2965">                resetEntityPhase(IGame.Phase.PHASE_END);</span>
<span class="nc" id="L2966">                boolean victory = victory(); // note this may add reports</span>
                // check phase report
                // HACK: hardcoded message ID check
<span class="nc bnc" id="L2969" title="All 4 branches missed.">                if ((vPhaseReport.size() &gt; 3) || ((vPhaseReport.size() &gt; 1)</span>
<span class="nc bnc" id="L2970" title="All 2 branches missed.">                        &amp;&amp; (vPhaseReport.elementAt(1).messageId != 1205))) {</span>
<span class="nc" id="L2971">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2972">                    changePhase(IGame.Phase.PHASE_END_REPORT);</span>
                } else {
                    // just the heat and end headers, so we'll add
                    // the &lt;nothing&gt; label
<span class="nc" id="L2976">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2977">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2978">                    sendReport();</span>
<span class="nc bnc" id="L2979" title="All 2 branches missed.">                    if (victory) {</span>
<span class="nc" id="L2980">                        changePhase(IGame.Phase.PHASE_VICTORY);</span>
                    } else {
<span class="nc" id="L2982">                        changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                    }
                }
                // Decrement the ASEWAffected counter
<span class="nc" id="L2986">                decrementASEWTurns();</span>

<span class="nc" id="L2988">                break;</span>
            case PHASE_END_REPORT:
<span class="nc bnc" id="L2990" title="All 2 branches missed.">                if (changePlayersTeam) {</span>
<span class="nc" id="L2991">                    processTeamChange();</span>
                }
<span class="nc bnc" id="L2993" title="All 2 branches missed.">                if (victory()) {</span>
<span class="nc" id="L2994">                    changePhase(IGame.Phase.PHASE_VICTORY);</span>
                } else {
<span class="nc" id="L2996">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                }
<span class="nc" id="L2998">                break;</span>
            case PHASE_VICTORY:
<span class="nc" id="L3000">                GameVictoryEvent gve = new GameVictoryEvent(this, game);</span>
<span class="nc" id="L3001">                game.processGameEvent(gve);</span>
<span class="nc" id="L3002">                transmitGameVictoryEventToAll();</span>
<span class="nc" id="L3003">                resetGame();</span>
<span class="nc" id="L3004">                break;</span>
            default:
        }

        // Any hidden units that activated this phase, should clear their
        // activating phase
<span class="nc bnc" id="L3010" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L3011" title="All 2 branches missed.">            if (ent.getHiddenActivationPhase() == game.getPhase()) {</span>
<span class="nc" id="L3012">                ent.setHiddeActivationPhase(null);</span>
            }
<span class="nc" id="L3014">        }</span>
<span class="nc" id="L3015">    }</span>

    private void sendSpecialHexDisplayPackets() {
<span class="nc bnc" id="L3018" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3019">            return;</span>
        }
<span class="nc bnc" id="L3021" title="All 2 branches missed.">        for (int i = 0; i &lt; connections.size(); i++) {</span>
<span class="nc bnc" id="L3022" title="All 2 branches missed.">            if (connections.get(i) != null) {</span>
<span class="nc" id="L3023">                connections.get(i).send(createSpecialHexDisplayPacket(i));</span>
            }
        }
<span class="nc" id="L3026">    }</span>

    private void sendTagInfoUpdates() {
<span class="nc bnc" id="L3029" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3030">            return;</span>
        }
<span class="nc bnc" id="L3032" title="All 2 branches missed.">        for (IConnection connection : connections) {</span>
<span class="nc bnc" id="L3033" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L3034">                connection.send(createTagInfoUpdatesPacket());</span>
            }
<span class="nc" id="L3036">        }</span>
<span class="nc" id="L3037">    }</span>

    public void sendTagInfoReset() {
<span class="nc bnc" id="L3040" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3041">            return;</span>
        }
<span class="nc bnc" id="L3043" title="All 2 branches missed.">        for (IConnection connection : connections) {</span>
<span class="nc bnc" id="L3044" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L3045">                connection.send(new Packet(Packet.COMMAND_RESET_TAGINFO));</span>
            }
<span class="nc" id="L3047">        }</span>
<span class="nc" id="L3048">    }</span>

    /**
     * Increment's the server's game round and send it to all the clients
     */
    private void incrementAndSendGameRound() {
<span class="nc" id="L3054">        game.incrementRoundCount();</span>
<span class="nc" id="L3055">        send(new Packet(Packet.COMMAND_ROUND_UPDATE, game.getRoundCount()));</span>
<span class="nc" id="L3056">    }</span>

    /**
     * Hand over a turn to the next player. This is only possible if you haven't
     * yet started your turn (i.e. not yet moved anything like infantry where
     * you have to move multiple units)
     *
     * @param connectionId - connection id of the player sending the packet
     */
    private void receiveForwardIni(int connectionId) {
        // this is the player sending the packet
<span class="nc" id="L3067">        IPlayer current = getPlayer(connectionId);</span>

<span class="nc bnc" id="L3069" title="All 2 branches missed.">        if (game.getTurn().getPlayerNum() != current.getId()) {</span>
            // this player is not the current player, so just ignore this
            // command!
<span class="nc" id="L3072">            return;</span>
        }
        // if individual initiative is active we cannot forward our initiative
        // ever!
<span class="nc bnc" id="L3076" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3077">            return;</span>
        }
        
        // if the player isn't on a team, there is no next team by definition. Skip the rest.
<span class="nc" id="L3081">        Team currentPlayerTeam = game.getTeamForPlayer(current);</span>
<span class="nc bnc" id="L3082" title="All 2 branches missed.">        if (currentPlayerTeam == null) {</span>
<span class="nc" id="L3083">            return;</span>
        }
        
        // get the next player from the team this player is on.
<span class="nc" id="L3087">        IPlayer next = currentPlayerTeam.getNextValidPlayer(current, game);</span>
        
<span class="nc bnc" id="L3089" title="All 2 branches missed.">        while (!next.equals(current)) {</span>
            // if the chosen player is a valid player, we change the turn order and
            // inform the clients.
<span class="nc bnc" id="L3092" title="All 4 branches missed.">            if ((next != null) &amp;&amp; (game.getEntitiesOwnedBy(next) != 0)</span>
<span class="nc bnc" id="L3093" title="All 2 branches missed.">                    &amp;&amp; (game.getTurnForPlayer(next.getId()) != null)) {</span>
    
<span class="nc" id="L3095">                int currentTurnIndex = game.getTurnIndex();</span>
                // now look for the next occurrence of player next in the turn order
<span class="nc" id="L3097">                List&lt;GameTurn&gt; turns = game.getTurnVector();</span>
<span class="nc" id="L3098">                GameTurn turn = game.getTurn();</span>
                // not entirely necessary. As we will also check this for the
                // activity of the button but to be sure do it on the server too.
<span class="nc bnc" id="L3101" title="All 6 branches missed.">                boolean isGeneralMoveTurn = !(turn instanceof GameTurn.SpecificEntityTurn)</span>
                        &amp;&amp; !(turn instanceof GameTurn.UnitNumberTurn)
                        &amp;&amp; !(turn instanceof GameTurn.UnloadStrandedTurn);
<span class="nc bnc" id="L3104" title="All 2 branches missed.">                if (!isGeneralMoveTurn) {</span>
                    // if this is not a general turn the player cannot forward his turn.
<span class="nc" id="L3106">                    return;</span>
                }
    
                // if it is an EntityClassTurn we have to check make sure, that the
                // turn it is exchanged with is the same kind of turn!
                // in fact this requires an access function to the mask of an
                // EntityClassTurn.
<span class="nc" id="L3113">                boolean isEntityClassTurn = (turn instanceof GameTurn.EntityClassTurn);</span>
<span class="nc" id="L3114">                int classMask = 0;</span>
<span class="nc bnc" id="L3115" title="All 2 branches missed.">                if (isEntityClassTurn) {</span>
<span class="nc" id="L3116">                    classMask = ((GameTurn.EntityClassTurn) turn).getTurnCode();</span>
                }
    
<span class="nc" id="L3119">                boolean switched = false;</span>
<span class="nc" id="L3120">                int nextTurnId = 0;</span>
<span class="nc bnc" id="L3121" title="All 2 branches missed.">                for (int i = currentTurnIndex; i &lt; turns.size(); i++) {</span>
                    // if we find a turn for the specific player, swap the current
                    // player with the player noted there
                    // and stop
<span class="nc bnc" id="L3125" title="All 2 branches missed.">                    if (turns.get(i).isValid(next.getId(), game)) {</span>
<span class="nc" id="L3126">                        nextTurnId = i;</span>
<span class="nc bnc" id="L3127" title="All 2 branches missed.">                        if (isEntityClassTurn) {</span>
                            // if we had an EntityClassTurn
<span class="nc bnc" id="L3129" title="All 2 branches missed.">                            if ((turns.get(i) instanceof GameTurn.EntityClassTurn)) {</span>
                                // and found another EntityClassTurn
<span class="nc bnc" id="L3131" title="All 2 branches missed.">                                if (!(((GameTurn.EntityClassTurn) turns.get(i)).getTurnCode() == classMask)) {</span>
                                    // both have to refer to the SAME class(es) or
                                    // they need to be rejected.
<span class="nc" id="L3134">                                    continue;</span>
                                }
                            } else {
                                continue;
                            }
                        }
<span class="nc" id="L3140">                        switched = true;</span>
<span class="nc" id="L3141">                        break;</span>
                    }
                }
    
                // update turn order
<span class="nc bnc" id="L3146" title="All 2 branches missed.">                if (switched) {</span>
<span class="nc" id="L3147">                    game.swapTurnOrder(currentTurnIndex, nextTurnId);</span>
                    // update the turn packages for all players.
<span class="nc" id="L3149">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L3150">                    send(createTurnIndexPacket(connectionId));</span>
<span class="nc" id="L3151">                    return;</span>
                }
                // if nothing changed return without doing anything
            }
            
<span class="nc" id="L3156">            next = currentPlayerTeam.getNextValidPlayer(next, game);</span>
        }
<span class="nc" id="L3158">    }</span>

    /**
     * Tries to change to the next turn. If there are no more turns, ends the
     * current phase. If the player whose turn it is next is not connected, we
     * allow the other players to skip that player.
     */
    private void changeToNextTurn(int prevPlayerId) {
<span class="nc bnc" id="L3166" title="All 2 branches missed.">        boolean minefieldPhase = game.getPhase() == IGame.Phase.PHASE_DEPLOY_MINEFIELDS;</span>
<span class="nc bnc" id="L3167" title="All 2 branches missed.">        boolean artyPhase = game.getPhase() == IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES;</span>
        
<span class="nc" id="L3169">        GameTurn nextTurn = null;</span>
<span class="nc" id="L3170">        Entity nextEntity = null;</span>
<span class="nc bnc" id="L3171" title="All 4 branches missed.">        while (game.hasMoreTurns() &amp;&amp; (null == nextEntity)) {</span>
<span class="nc" id="L3172">            nextTurn = game.changeToNextTurn();</span>
<span class="nc" id="L3173">            nextEntity = game.getEntity(game.getFirstEntityNum(nextTurn));</span>
<span class="nc bnc" id="L3174" title="All 4 branches missed.">            if (minefieldPhase || artyPhase) {</span>
<span class="nc" id="L3175">                break;</span>
            }
        }
   
        // if there aren't any more valid turns, end the phase
        // note that some phases don't use entities
<span class="nc bnc" id="L3181" title="All 8 branches missed.">        if (((null == nextEntity) &amp;&amp; !minefieldPhase) || ((null == nextTurn) &amp;&amp; minefieldPhase)) {</span>
<span class="nc" id="L3182">            endCurrentPhase();</span>
<span class="nc" id="L3183">            return;</span>
        }

<span class="nc" id="L3186">        IPlayer player = getPlayer(nextTurn.getPlayerNum());</span>

<span class="nc bnc" id="L3188" title="All 4 branches missed.">        if ((player != null) &amp;&amp; (game.getEntitiesOwnedBy(player) == 0)) {</span>
<span class="nc" id="L3189">            endCurrentTurn(null);</span>
<span class="nc" id="L3190">            return;</span>
        }

<span class="nc bnc" id="L3193" title="All 2 branches missed.">        if (prevPlayerId != -1) {</span>
<span class="nc" id="L3194">            send(createTurnIndexPacket(prevPlayerId));</span>
        } else {
<span class="nc bnc" id="L3196" title="All 2 branches missed.">            send(createTurnIndexPacket(player != null ? player.getId() : IPlayer.PLAYER_NONE));</span>
        }

<span class="nc bnc" id="L3199" title="All 4 branches missed.">        if ((null != player) &amp;&amp; player.isGhost()) {</span>
<span class="nc" id="L3200">            sendGhostSkipMessage(player);</span>
<span class="nc bnc" id="L3201" title="All 8 branches missed.">        } else if ((null == game.getFirstEntity()) &amp;&amp; (null != player) &amp;&amp; !minefieldPhase &amp;&amp; !artyPhase) {</span>
<span class="nc" id="L3202">            sendTurnErrorSkipMessage(player);</span>
        }
<span class="nc" id="L3204">    }</span>

    /**
     * Sends out a notification message indicating that a ghost player may be
     * skipped.
     *
     * @param ghost - the &lt;code&gt;Player&lt;/code&gt; who is ghosted. This value must not
     *              be &lt;code&gt;null&lt;/code&gt;.
     */
    private void sendGhostSkipMessage(IPlayer ghost) {
<span class="nc" id="L3214">        String message = &quot;Player '&quot; + ghost.getName() +</span>
                &quot;' is disconnected.  You may skip his/her current turn with the /skip command.&quot;;
<span class="nc" id="L3216">        sendServerChat(message);</span>
<span class="nc" id="L3217">    }</span>

    /**
     * Sends out a notification message indicating that the current turn is an
     * error and should be skipped.
     *
     * @param skip - the &lt;code&gt;Player&lt;/code&gt; who is to be skipped. This value
     *             must not be &lt;code&gt;null&lt;/code&gt;.
     */
    private void sendTurnErrorSkipMessage(IPlayer skip) {
<span class="nc" id="L3227">        String message = &quot;Player '&quot; + skip.getName() +</span>
                &quot;' has no units to move.  You should skip his/her/your current turn with the /skip command. &quot; +
                &quot;You may want to report this error at https://github.com/MegaMek/megamek/issues&quot;;
<span class="nc" id="L3230">        sendServerChat(message);</span>
<span class="nc" id="L3231">    }</span>

    /**
     * Skips the current turn. This only makes sense in phases that have turns.
     * Operates by finding an entity to move and then doing nothing with it.
     */
    public void skipCurrentTurn() {
        // find an entity to skip...
<span class="nc" id="L3239">        Entity toSkip = game.getFirstEntity();</span>

<span class="nc bnc" id="L3241" title="All 4 branches missed.">        switch (game.getPhase()) {</span>
            case PHASE_DEPLOYMENT:
                // allow skipping during deployment,
                // we need that when someone removes a unit.
<span class="nc" id="L3245">                endCurrentTurn(null);</span>
<span class="nc" id="L3246">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc bnc" id="L3248" title="All 2 branches missed.">                if (toSkip != null) {</span>
<span class="nc" id="L3249">                    processMovement(toSkip, new MovePath(game, toSkip), null);</span>
                }
<span class="nc" id="L3251">                endCurrentTurn(toSkip);</span>
<span class="nc" id="L3252">                break;</span>
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc bnc" id="L3257" title="All 2 branches missed.">                if (toSkip != null) {</span>
<span class="nc" id="L3258">                    processAttack(toSkip, new Vector&lt;&gt;(0));</span>
                }
<span class="nc" id="L3260">                endCurrentTurn(toSkip);</span>
<span class="nc" id="L3261">                break;</span>
            default:
        }
<span class="nc" id="L3264">    }</span>

    /**
     * Returns true if the current turn may be skipped. Ghost players' turns are
     * skippable, and a turn should be skipped if there's nothing to move.
     */
    public boolean isTurnSkippable() {
<span class="nc" id="L3271">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L3272" title="All 2 branches missed.">        if (null == turn) {</span>
<span class="nc" id="L3273">            return false;</span>
        }
<span class="nc" id="L3275">        IPlayer player = getPlayer(turn.getPlayerNum());</span>
<span class="nc bnc" id="L3276" title="All 6 branches missed.">        return (null == player) || player.isGhost() || (game.getFirstEntity() == null);</span>
    }

    /**
     * Returns true if victory conditions have been met. Victory conditions are
     * when there is only one player left with mechs or only one team. will also
     * add some reports to reporting
     */
    public boolean victory() {
<span class="nc" id="L3285">        VictoryResult vr = game.getVictory().checkForVictory(game, game.getVictoryContext());</span>
<span class="nc bnc" id="L3286" title="All 2 branches missed.">        for (Report r : vr.getReports()) {</span>
<span class="nc" id="L3287">            addReport(r);</span>
<span class="nc" id="L3288">        }</span>

<span class="nc bnc" id="L3290" title="All 2 branches missed.">        if (vr.victory()) {</span>
<span class="nc" id="L3291">            boolean draw = vr.isDraw();</span>
<span class="nc" id="L3292">            int wonPlayer = vr.getWinningPlayer();</span>
<span class="nc" id="L3293">            int wonTeam = vr.getWinningTeam();</span>

<span class="nc bnc" id="L3295" title="All 2 branches missed.">            if (wonPlayer != IPlayer.PLAYER_NONE) {</span>
<span class="nc" id="L3296">                Report r = new Report(7200, Report.PUBLIC);</span>
<span class="nc" id="L3297">                r.add(Server.getColorForPlayer(game.getPlayer(wonPlayer)));</span>
<span class="nc" id="L3298">                addReport(r);</span>
            }
<span class="nc bnc" id="L3300" title="All 2 branches missed.">            if (wonTeam != IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L3301">                Report r = new Report(7200, Report.PUBLIC);</span>
<span class="nc" id="L3302">                r.add(&quot;Team &quot; + wonTeam);</span>
<span class="nc" id="L3303">                addReport(r);</span>
            }
<span class="nc bnc" id="L3305" title="All 2 branches missed.">            if (draw) {</span>
                // multiple-won draw
<span class="nc" id="L3307">                game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L3308">                game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
            } else {
                // nobody-won draw or
                // single player won or
                // single team won
<span class="nc" id="L3313">                game.setVictoryPlayerId(wonPlayer);</span>
<span class="nc" id="L3314">                game.setVictoryTeam(wonTeam);</span>
            }
<span class="nc" id="L3316">        } else {</span>
<span class="nc" id="L3317">            game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L3318">            game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
<span class="nc bnc" id="L3319" title="All 2 branches missed.">            if (game.isForceVictory()) {</span>
<span class="nc" id="L3320">                cancelVictory();</span>
            }
        }
<span class="nc" id="L3323">        return vr.victory();</span>
    }// end victory

    private boolean isPlayerForcedVictory() {
        // check game options
<span class="nc bnc" id="L3328" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.VICTORY_SKIP_FORCED_VICTORY)) {</span>
<span class="nc" id="L3329">            return false;</span>
        }

<span class="nc bnc" id="L3332" title="All 2 branches missed.">        if (!game.isForceVictory()) {</span>
<span class="nc" id="L3333">            return false;</span>
        }

<span class="nc bnc" id="L3336" title="All 2 branches missed.">        for (IPlayer player : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L3337" title="All 4 branches missed.">            if ((player.getId() == game.getVictoryPlayerId()) || ((player.getTeam() == game.getVictoryTeam())</span>
<span class="nc bnc" id="L3338" title="All 2 branches missed.">                    &amp;&amp; (game.getVictoryTeam() != IPlayer.TEAM_NONE))) {</span>
<span class="nc" id="L3339">                continue;</span>
            }

<span class="nc bnc" id="L3342" title="All 2 branches missed.">            if (!player.admitsDefeat()) {</span>
<span class="nc" id="L3343">                return false;</span>
            }
<span class="nc" id="L3345">        }</span>

<span class="nc" id="L3347">        return true;</span>
    }

    /**
     * Applies board settings. This loads and combines all the boards that were
     * specified into one mega-board and sets that board as current.
     */
    public void applyBoardSettings() {
<span class="nc" id="L3355">        mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L3356">        mapSettings.replaceBoardWithRandom(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L3357">        IBoard[] sheetBoards = new IBoard[mapSettings.getMapWidth()</span>
<span class="nc" id="L3358">                * mapSettings.getMapHeight()];</span>
<span class="nc" id="L3359">        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3360">        for (int i = 0; i &lt; (mapSettings.getMapWidth() * mapSettings</span>
<span class="nc bnc" id="L3361" title="All 2 branches missed.">                .getMapHeight()); i++) {</span>
<span class="nc" id="L3362">            sheetBoards[i] = new Board();</span>
<span class="nc" id="L3363">            String name = mapSettings.getBoardsSelectedVector().get(i);</span>
<span class="nc" id="L3364">            boolean isRotated = false;</span>
<span class="nc bnc" id="L3365" title="All 2 branches missed.">            if (name.startsWith(Board.BOARD_REQUEST_ROTATION)) {</span>
                // only rotate boards with an even width
<span class="nc bnc" id="L3367" title="All 2 branches missed.">                if ((mapSettings.getBoardWidth() % 2) == 0) {</span>
<span class="nc" id="L3368">                    isRotated = true;</span>
                }
<span class="nc" id="L3370">                name = name.substring(Board.BOARD_REQUEST_ROTATION.length());</span>
            }
<span class="nc bnc" id="L3372" title="All 2 branches missed.">            if (name.startsWith(MapSettings.BOARD_GENERATED)</span>
<span class="nc bnc" id="L3373" title="All 2 branches missed.">                    || (mapSettings.getMedium() == MapSettings.MEDIUM_SPACE)) {</span>
<span class="nc" id="L3374">                sheetBoards[i] = BoardUtilities.generateRandom(mapSettings);</span>
            } else {
<span class="nc" id="L3376">                sheetBoards[i].load(new MegaMekFile(Configuration.boardsDir(), name</span>
<span class="nc" id="L3377">                        + &quot;.board&quot;).getFile());</span>
<span class="nc" id="L3378">                BoardUtilities.flip(sheetBoards[i], isRotated, isRotated);</span>
            }
<span class="nc" id="L3380">            rotateBoard.add(isRotated);</span>
        }
<span class="nc" id="L3382">        IBoard newBoard = BoardUtilities.combine(mapSettings.getBoardWidth(),</span>
<span class="nc" id="L3383">                mapSettings.getBoardHeight(), mapSettings.getMapWidth(),</span>
<span class="nc" id="L3384">                mapSettings.getMapHeight(), sheetBoards, rotateBoard,</span>
<span class="nc" id="L3385">                mapSettings.getMedium());</span>
<span class="nc bnc" id="L3386" title="All 2 branches missed.">        if (game.getOptions().getOption(OptionsConstants.BASE_BRIDGECF).intValue() &gt; 0) {</span>
<span class="nc" id="L3387">            newBoard.setBridgeCF(game.getOptions().getOption(OptionsConstants.BASE_BRIDGECF).intValue());</span>
        }
<span class="nc bnc" id="L3389" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_RANDOM_BASEMENTS)) {</span>
<span class="nc" id="L3390">            newBoard.setRandomBasementsOff();</span>
        }
<span class="nc bnc" id="L3392" title="All 2 branches missed.">        if (game.getPlanetaryConditions().isTerrainAffected()) {</span>
<span class="nc" id="L3393">            BoardUtilities.addWeatherConditions(newBoard, game.getPlanetaryConditions().getWeather(),</span>
<span class="nc" id="L3394">                    game.getPlanetaryConditions().getWindStrength());</span>
        }
<span class="nc" id="L3396">        game.setBoard(newBoard);</span>
<span class="nc" id="L3397">    }</span>

    /**
     * Rolls initiative for all the players.
     */
    private void rollInitiative() {
<span class="nc bnc" id="L3403" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3404">            TurnOrdered.rollInitiative(game.getEntitiesVector(), false);</span>
        } else {
            // Roll for initiative on the teams.
<span class="nc" id="L3407">            TurnOrdered.rollInitiative(game.getTeamsVector(),</span>
<span class="nc bnc" id="L3408" title="All 2 branches missed.">                    game.getOptions().booleanOption(OptionsConstants.INIT_INITIATIVE_STREAK_COMPENSATION)</span>
<span class="nc bnc" id="L3409" title="All 2 branches missed.">                    &amp;&amp; !game.shouldDeployThisRound());</span>
        }

<span class="nc" id="L3412">        transmitAllPlayerUpdates();</span>
<span class="nc" id="L3413">    }</span>

    private Vector&lt;GameTurn&gt; checkTurnOrderStranded(TurnVectors team_order) {
<span class="nc" id="L3416">        Vector&lt;GameTurn&gt; turns = new Vector&lt;&gt;(team_order.getTotalTurns()</span>
<span class="nc" id="L3417">                + team_order.getEvenTurns());</span>
        // Stranded units only during movement phases, rebuild the turns vector
<span class="nc bnc" id="L3419" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_MOVEMENT) {</span>
            // See if there are any loaded units stranded on immobile transports.
<span class="nc" id="L3421">            Iterator&lt;Entity&gt; strandedUnits = game.getSelectedEntities(</span>
<span class="nc" id="L3422">                    entity -&gt; game.isEntityStranded(entity));</span>
<span class="nc bnc" id="L3423" title="All 2 branches missed.">            if (strandedUnits.hasNext()) {</span>
                // Add a game turn to unload stranded units, if this
                // is the movement phase.
<span class="nc" id="L3426">                turns = new Vector&lt;&gt;(team_order.getTotalTurns()</span>
<span class="nc" id="L3427">                        + team_order.getEvenTurns() + 1);</span>
<span class="nc" id="L3428">                turns.addElement(new GameTurn.UnloadStrandedTurn(strandedUnits));</span>
            }
        }
<span class="nc" id="L3431">        return turns;</span>
    }

    /**
     * Determines the turn oder for a given phase (with individual init)
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase
     */
    private void determineTurnOrderIUI(IGame.Phase phase) {
<span class="nc bnc" id="L3440" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; loop = game.getEntities(); loop.hasNext();) {</span>
<span class="nc" id="L3441">            final Entity entity = loop.next();</span>
<span class="nc" id="L3442">            entity.resetOtherTurns();</span>
<span class="nc bnc" id="L3443" title="All 2 branches missed.">            if (entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L3444">                entity.incrementOtherTurns();</span>
            }
<span class="nc" id="L3446">        }</span>

        List&lt;Entity&gt; entities;
        // If the protos move multi option isn't on, protos move as a unit
        // Need to adjust entities vector otherwise we'll have too many turns
        // when first proto in a unit moves, new turns get added so rest of the
        // unit will move
<span class="nc" id="L3453">        boolean protosMoveMulti = game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_MULTI);
<span class="nc bnc" id="L3455" title="All 2 branches missed.">        if (!protosMoveMulti) {</span>
<span class="nc" id="L3456">            entities = new ArrayList&lt;&gt;(game.getEntitiesVector().size());</span>
<span class="nc" id="L3457">            Set&lt;Short&gt; movedUnits = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3458" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
                // This only effects Protos for the time being
<span class="nc bnc" id="L3460" title="All 2 branches missed.">                if (!(e instanceof Protomech)) {</span>
<span class="nc" id="L3461">                    entities.add(e);</span>
<span class="nc" id="L3462">                    continue;</span>
                }
<span class="nc" id="L3464">                short unitNumber = e.getUnitNumber();</span>
<span class="nc bnc" id="L3465" title="All 2 branches missed.">                if ((unitNumber == Entity.NONE)</span>
<span class="nc bnc" id="L3466" title="All 2 branches missed.">                        || !movedUnits.contains(unitNumber)) {</span>
<span class="nc" id="L3467">                    entities.add(e);</span>
<span class="nc bnc" id="L3468" title="All 2 branches missed.">                    if (unitNumber != Entity.NONE) {</span>
<span class="nc" id="L3469">                        movedUnits.add(unitNumber);</span>
                    }
                }
<span class="nc" id="L3472">            }</span>
<span class="nc" id="L3473">        } else {</span>
<span class="nc" id="L3474">            entities = game.getEntitiesVector();</span>
        }
        // Now, generate the global order of all teams' turns.
<span class="nc" id="L3477">        TurnVectors team_order = TurnOrdered.generateTurnOrder(entities, game);</span>

        // Now, we collect everything into a single vector.
<span class="nc" id="L3480">        Vector&lt;GameTurn&gt; turns = checkTurnOrderStranded(team_order);</span>

        // add the turns (this is easy)
<span class="nc bnc" id="L3483" title="All 2 branches missed.">        while (team_order.hasMoreElements()) {</span>
<span class="nc" id="L3484">            Entity e = (Entity) team_order.nextElement();</span>
<span class="nc bnc" id="L3485" title="All 2 branches missed.">            if (e.isSelectableThisTurn()) {</span>
<span class="nc bnc" id="L3486" title="All 6 branches missed.">                if (!protosMoveMulti &amp;&amp; (e instanceof Protomech) &amp;&amp; (e.getUnitNumber() != Entity.NONE)) {</span>
<span class="nc" id="L3487">                    turns.addElement(new GameTurn.UnitNumberTurn(e.getOwnerId(), e.getUnitNumber()));</span>
                } else {
<span class="nc" id="L3489">                    turns.addElement(new GameTurn.SpecificEntityTurn(e.getOwnerId(), e.getId()));</span>
                }
            }
<span class="nc" id="L3492">        }</span>

        // set fields in game
<span class="nc" id="L3495">        game.setTurnVector(turns);</span>
<span class="nc" id="L3496">        game.resetTurnIndex();</span>

        // send turns to all players
<span class="nc" id="L3499">        send(createTurnVectorPacket());</span>
<span class="nc" id="L3500">    }</span>

    /**
     * Determines the turn order for a given phase
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase
     */
    private void determineTurnOrder(IGame.Phase phase) {
<span class="nc bnc" id="L3508" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3509">            determineTurnOrderIUI(phase);</span>
<span class="nc" id="L3510">            return;</span>
        }
        // and/or deploy even according to game options.
<span class="nc bnc" id="L3513" title="All 2 branches missed.">        boolean infMoveEven = (game.getOptions().booleanOption(OptionsConstants.INIT_INF_MOVE_EVEN)</span>
<span class="nc bnc" id="L3514" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3515" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_MOVEMENT)))</span>
<span class="nc bnc" id="L3516" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.INIT_INF_DEPLOY_EVEN)</span>
<span class="nc bnc" id="L3517" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT));</span>
<span class="nc" id="L3518">        boolean infMoveMulti = game.getOptions()</span>
<span class="nc bnc" id="L3519" title="All 2 branches missed.">                .booleanOption(OptionsConstants.INIT_INF_MOVE_MULTI)</span>
<span class="nc bnc" id="L3520" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3521" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3522" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>
<span class="nc bnc" id="L3523" title="All 2 branches missed.">        boolean protosMoveEven = (game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_EVEN)
<span class="nc bnc" id="L3525" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3526" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3527" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))))</span>
<span class="nc bnc" id="L3528" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.INIT_PROTOS_MOVE_EVEN)</span>
<span class="nc bnc" id="L3529" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT));</span>
<span class="nc" id="L3530">        boolean protosMoveMulti = game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_MULTI);
<span class="nc bnc" id="L3532" title="All 2 branches missed.">        boolean protosMoveByPoint = !protosMoveMulti;</span>
<span class="nc bnc" id="L3533" title="All 2 branches missed.">        boolean tankMoveByLance = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT)
<span class="nc bnc" id="L3535" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3536" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3537" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>
<span class="nc bnc" id="L3538" title="All 2 branches missed.">        boolean mekMoveByLance = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT)
<span class="nc bnc" id="L3540" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3541" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3542" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>

<span class="nc" id="L3544">        int evenMask = 0;</span>
<span class="nc bnc" id="L3545" title="All 2 branches missed.">        if (infMoveEven) {</span>
<span class="nc" id="L3546">            evenMask += GameTurn.CLASS_INFANTRY;</span>
        }
<span class="nc bnc" id="L3548" title="All 2 branches missed.">        if (protosMoveEven) {</span>
<span class="nc" id="L3549">            evenMask += GameTurn.CLASS_PROTOMECH;</span>
        }
        // Reset all of the Players' turn category counts
<span class="nc bnc" id="L3552" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; loop = game.getPlayers(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L3553">            final IPlayer player = loop.nextElement();</span>
<span class="nc" id="L3554">            player.resetEvenTurns();</span>
<span class="nc" id="L3555">            player.resetMultiTurns();</span>
<span class="nc" id="L3556">            player.resetOtherTurns();</span>
<span class="nc" id="L3557">            player.resetSpaceStationTurns();</span>
<span class="nc" id="L3558">            player.resetJumpshipTurns();</span>
<span class="nc" id="L3559">            player.resetWarshipTurns();</span>
<span class="nc" id="L3560">            player.resetDropshipTurns();</span>
<span class="nc" id="L3561">            player.resetSmallCraftTurns();</span>
<span class="nc" id="L3562">            player.resetAeroTurns();</span>

            // Add turns for ProtoMechs weapons declaration.
<span class="nc bnc" id="L3565" title="All 2 branches missed.">            if (protosMoveByPoint) {</span>

                // How many ProtoMechs does the player have?
<span class="nc" id="L3568">                Iterator&lt;Entity&gt; playerProtos = game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L3569">                            private final int ownerId = player.getId();</span>

                            public boolean accept(Entity entity) {
<span class="nc bnc" id="L3572" title="All 2 branches missed.">                                return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L3573" title="All 2 branches missed.">                                        &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L3574" title="All 2 branches missed.">                                        &amp;&amp; entity.isSelectableThisTurn();</span>
                            }
                        });
<span class="nc" id="L3577">                HashSet&lt;Integer&gt; points = new HashSet&lt;&gt;();</span>
<span class="nc" id="L3578">                int numPlayerProtos = 0;</span>
<span class="nc bnc" id="L3579" title="All 2 branches missed.">                for (; playerProtos.hasNext(); ) {</span>
<span class="nc" id="L3580">                    Entity proto = playerProtos.next();</span>
<span class="nc" id="L3581">                    numPlayerProtos++;</span>
<span class="nc" id="L3582">                    points.add((int) proto.getUnitNumber());</span>
<span class="nc" id="L3583">                }</span>
<span class="nc" id="L3584">                int numProtoUnits = (int) Math.ceil(numPlayerProtos / 5.0);</span>
<span class="nc bnc" id="L3585" title="All 2 branches missed.">                if (!protosMoveEven) {</span>
<span class="nc" id="L3586">                    numProtoUnits = points.size();</span>
                }
<span class="nc bnc" id="L3588" title="All 2 branches missed.">                for (int unit = 0; unit &lt; numProtoUnits; unit++) {</span>
<span class="nc bnc" id="L3589" title="All 2 branches missed.">                    if (protosMoveEven) {</span>
<span class="nc" id="L3590">                        player.incrementEvenTurns();</span>
                    } else {
<span class="nc" id="L3592">                        player.incrementOtherTurns();</span>
                    }
                }

            } // End handle-proto-firing-turns

<span class="nc" id="L3598">        } // Handle the next player</span>

        // Go through all entities, and update the turn categories of the
        // entity's player. The teams get their totals from their players.
        // N.B. ProtoMechs declare weapons fire based on their point.
<span class="nc bnc" id="L3603" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; loop = game.getEntities(); loop.hasNext();) {</span>
<span class="nc" id="L3604">            final Entity entity = loop.next();</span>
<span class="nc bnc" id="L3605" title="All 2 branches missed.">            if (entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L3606">                final IPlayer player = entity.getOwner();</span>
<span class="nc bnc" id="L3607" title="All 2 branches missed.">                if ((entity instanceof SpaceStation)</span>
<span class="nc bnc" id="L3608" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3609" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3610">                    player.incrementSpaceStationTurns();</span>
<span class="nc bnc" id="L3611" title="All 2 branches missed.">                } else if ((entity instanceof Warship)</span>
<span class="nc bnc" id="L3612" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3613" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3614">                    player.incrementWarshipTurns();</span>
<span class="nc bnc" id="L3615" title="All 2 branches missed.">                } else if ((entity instanceof Jumpship)</span>
<span class="nc bnc" id="L3616" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3617" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3618">                    player.incrementJumpshipTurns();</span>
<span class="nc bnc" id="L3619" title="All 4 branches missed.">                } else if ((entity instanceof Dropship) &amp;&amp; entity.isAirborne()</span>
<span class="nc bnc" id="L3620" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3621" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3622">                    player.incrementDropshipTurns();</span>
<span class="nc bnc" id="L3623" title="All 4 branches missed.">                } else if ((entity instanceof SmallCraft) &amp;&amp; entity.isAirborne()</span>
<span class="nc bnc" id="L3624" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3625" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3626">                    player.incrementSmallCraftTurns();</span>
<span class="nc bnc" id="L3627" title="All 2 branches missed.">                } else if (entity.isAirborne()</span>
<span class="nc bnc" id="L3628" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3629" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3630">                    player.incrementAeroTurns();</span>
<span class="nc bnc" id="L3631" title="All 2 branches missed.">                } else if ((entity instanceof Infantry)) {</span>
<span class="nc bnc" id="L3632" title="All 2 branches missed.">                    if (infMoveEven) {</span>
<span class="nc" id="L3633">                        player.incrementEvenTurns();</span>
<span class="nc bnc" id="L3634" title="All 2 branches missed.">                    } else if (infMoveMulti) {</span>
<span class="nc" id="L3635">                        player.incrementMultiTurns(GameTurn.CLASS_INFANTRY);</span>
                    } else {
<span class="nc" id="L3637">                        player.incrementOtherTurns();</span>
                    }
<span class="nc bnc" id="L3639" title="All 2 branches missed.">                } else if (entity instanceof Protomech) {</span>
<span class="nc bnc" id="L3640" title="All 2 branches missed.">                    if (!protosMoveByPoint) {</span>
<span class="nc bnc" id="L3641" title="All 2 branches missed.">                        if (protosMoveEven) {</span>
<span class="nc" id="L3642">                            player.incrementEvenTurns();</span>
<span class="nc bnc" id="L3643" title="All 2 branches missed.">                        } else if (protosMoveMulti) {</span>
<span class="nc" id="L3644">                            player.incrementMultiTurns(GameTurn.CLASS_PROTOMECH);</span>
                        } else {
<span class="nc" id="L3646">                            player.incrementOtherTurns();</span>
                        }
                    }
<span class="nc bnc" id="L3649" title="All 4 branches missed.">                } else if ((entity instanceof Tank) &amp;&amp; tankMoveByLance) {</span>
<span class="nc" id="L3650">                    player.incrementMultiTurns(GameTurn.CLASS_TANK);</span>
<span class="nc bnc" id="L3651" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; mekMoveByLance) {</span>
<span class="nc" id="L3652">                    player.incrementMultiTurns(GameTurn.CLASS_MECH);</span>
                } else {
<span class="nc" id="L3654">                    player.incrementOtherTurns();</span>
                }
            }
<span class="nc" id="L3657">        }</span>

        // Generate the turn order for the Players *within*
        // each Team. Map the teams to their turn orders.
        // Count the number of teams moving this turn.
<span class="nc" id="L3662">        int nTeams = game.getNoOfTeams();</span>
<span class="nc" id="L3663">        Hashtable&lt;Team, TurnVectors&gt; allTeamTurns = new Hashtable&lt;&gt;(nTeams);</span>
<span class="nc" id="L3664">        Hashtable&lt;Team, int[]&gt; evenTrackers = new Hashtable&lt;&gt;(nTeams);</span>
<span class="nc" id="L3665">        int numTeamsMoving = 0;</span>
<span class="nc bnc" id="L3666" title="All 2 branches missed.">        for (Enumeration&lt;Team&gt; loop = game.getTeams(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L3667">            final Team team = loop.nextElement();</span>
<span class="nc" id="L3668">            allTeamTurns.put(team, team.determineTeamOrder(game));</span>

            // Track both the number of times we've checked the team for
            // &quot;leftover&quot; turns, and the number of &quot;leftover&quot; turns placed.
<span class="nc" id="L3672">            int[] evenTracker = new int[2];</span>
<span class="nc" id="L3673">            evenTrackers.put(team, evenTracker);</span>

            // Count this team if it has any &quot;normal&quot; moves.
<span class="nc bnc" id="L3676" title="All 2 branches missed.">            if (team.getNormalTurns(game) &gt; 0) {</span>
<span class="nc" id="L3677">                numTeamsMoving++;</span>
            }
<span class="nc" id="L3679">        }</span>

        // Now, generate the global order of all teams' turns.
<span class="nc" id="L3682">        TurnVectors team_order = TurnOrdered.generateTurnOrder(game.getTeamsVector(), game);</span>

        // Now, we collect everything into a single vector.
<span class="nc" id="L3685">        Vector&lt;GameTurn&gt; turns = checkTurnOrderStranded(team_order);</span>

        // Walk through the global order, assigning turns
        // for individual players to the single vector.
        // Keep track of how many turns we've added to the vector.
<span class="nc" id="L3690">        Team prevTeam = null;</span>
<span class="nc" id="L3691">        int min = team_order.getMin();</span>
<span class="nc bnc" id="L3692" title="All 2 branches missed.">        for (int numTurn = 0; team_order.hasMoreElements(); numTurn++) {</span>
<span class="nc" id="L3693">            Team team = (Team) team_order.nextElement();</span>
<span class="nc" id="L3694">            TurnVectors withinTeamTurns = allTeamTurns.get(team);</span>

<span class="nc" id="L3696">            int[] evenTracker = evenTrackers.get(team);</span>
<span class="nc" id="L3697">            float teamEvenTurns = team.getEvenTurns();</span>

            // Calculate the number of &quot;even&quot; turns to add for this team.
<span class="nc" id="L3700">            int numEven = 0;</span>
<span class="nc bnc" id="L3701" title="All 2 branches missed.">            if (1 == numTeamsMoving) {</span>
                // If there's only one team moving, we don't need to bother
                // with the evenTracker, just make sure the even turns are
                // evenly distributed
<span class="nc" id="L3705">                numEven += (int) Math.round(teamEvenTurns / min);</span>
<span class="nc bnc" id="L3706" title="All 2 branches missed.">            } else if (prevTeam == null) {</span>
                // Increment the number of times we've checked for &quot;leftovers&quot;.
<span class="nc" id="L3708">                evenTracker[0]++;</span>

                // The first team to move just adds the &quot;baseline&quot; turns.
<span class="nc" id="L3711">                numEven += Math.round(teamEvenTurns / min);</span>
<span class="nc bnc" id="L3712" title="All 2 branches missed.">            } else if (!team.equals(prevTeam)) {</span>
                // Increment the number of times we've checked for &quot;leftovers&quot;.
<span class="nc" id="L3714">                evenTracker[0]++;</span>

                // This weird equation attempts to spread the &quot;leftover&quot;
                // turns across the turn's moves in a &quot;fair&quot; manner.
                // It's based on the number of times we've checked for
                // &quot;leftovers&quot; the number of &quot;leftovers&quot; we started with,
                // the number of times we've added a turn for a &quot;leftover&quot;,
                // and the total number of times we're going to check.
<span class="nc" id="L3722">                numEven += (int) Math.ceil(((evenTracker[0] * (teamEvenTurns % min)) / min) - 0.5)</span>
                           - evenTracker[1];

                // Update the number of turns actually added for &quot;leftovers&quot;.
<span class="nc" id="L3726">                evenTracker[1] += numEven;</span>

                // Add the &quot;baseline&quot; number of turns.
<span class="nc" id="L3729">                numEven += Math.round(teamEvenTurns / min);</span>
            }

            // Record this team for the next move.
<span class="nc" id="L3733">            prevTeam = team;</span>

<span class="nc" id="L3735">            int aeroMask = GameTurn.CLASS_AERO + GameTurn.CLASS_SMALL_CRAFT</span>
                           + GameTurn.CLASS_DROPSHIP + GameTurn.CLASS_JUMPSHIP
                           + GameTurn.CLASS_WARSHIP + GameTurn.CLASS_SPACE_STATION;
            GameTurn turn;
            IPlayer player;
<span class="nc bnc" id="L3740" title="All 2 branches missed.">            if (withinTeamTurns.hasMoreNormalElements()) {</span>
                // Not a placeholder... get the player who moves next.
<span class="nc" id="L3742">                player = (IPlayer) withinTeamTurns.nextNormalElement();</span>

                // If we've added all &quot;normal&quot; turns, allocate turns
                // for the infantry and/or ProtoMechs moving even.
<span class="nc bnc" id="L3746" title="All 2 branches missed.">                if (numTurn &gt;= team_order.getTotalTurns()) {</span>
<span class="nc" id="L3747">                    turn = new GameTurn.EntityClassTurn(player.getId(), evenMask);</span>
                }
                // If either Infantry or ProtoMechs move even, only allow
                // the other classes to move during the &quot;normal&quot; turn.
<span class="nc bnc" id="L3751" title="All 4 branches missed.">                else if (infMoveEven || protosMoveEven) {</span>
<span class="nc" id="L3752">                    int newMask = evenMask;</span>
                    // if this is the movement phase, then don't allow Aeros on
                    // normal turns
<span class="nc bnc" id="L3755" title="All 2 branches missed.">                    if ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3756" title="All 2 branches missed.">                            || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3757">                        newMask += aeroMask;</span>
                    }
<span class="nc" id="L3759">                    turn = new GameTurn.EntityClassTurn(player.getId(), ~newMask);</span>
<span class="nc" id="L3760">                }</span>
                // Otherwise, let *anybody* move.
                else {
                    // well, almost anybody; Aero don't get normal turns during
                    // the movement phase
<span class="nc bnc" id="L3765" title="All 2 branches missed.">                    if ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3766" title="All 2 branches missed.">                            || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3767">                        turn = new GameTurn.EntityClassTurn(player.getId(), ~aeroMask);</span>
                    } else {
<span class="nc" id="L3769">                        turn = new GameTurn(player.getId());</span>
                    }
                }
<span class="nc" id="L3772">                turns.addElement(turn);</span>
            } // End team-has-&quot;normal&quot;-turns
<span class="nc bnc" id="L3774" title="All 2 branches missed.">            else if (withinTeamTurns.hasMoreSpaceStationElements()) {</span>
<span class="nc" id="L3775">                player = (IPlayer) withinTeamTurns.nextSpaceStationElement();</span>
<span class="nc" id="L3776">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_SPACE_STATION);</span>
<span class="nc" id="L3777">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3778" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreJumpshipElements()) {</span>
<span class="nc" id="L3779">                player = (IPlayer) withinTeamTurns.nextJumpshipElement();</span>
<span class="nc" id="L3780">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_JUMPSHIP);</span>
<span class="nc" id="L3781">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3782" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreWarshipElements()) {</span>
<span class="nc" id="L3783">                player = (IPlayer) withinTeamTurns.nextWarshipElement();</span>
<span class="nc" id="L3784">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_WARSHIP);</span>
<span class="nc" id="L3785">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3786" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreDropshipElements()) {</span>
<span class="nc" id="L3787">                player = (IPlayer) withinTeamTurns.nextDropshipElement();</span>
<span class="nc" id="L3788">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_DROPSHIP);</span>
<span class="nc" id="L3789">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3790" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreSmallCraftElements()) {</span>
<span class="nc" id="L3791">                player = (IPlayer) withinTeamTurns.nextSmallCraftElement();</span>
<span class="nc" id="L3792">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_SMALL_CRAFT);</span>
<span class="nc" id="L3793">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3794" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreAeroElements()) {</span>
<span class="nc" id="L3795">                player = (IPlayer) withinTeamTurns.nextAeroElement();</span>
<span class="nc" id="L3796">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_AERO);</span>
<span class="nc" id="L3797">                turns.addElement(turn);</span>
            }

            // Add the calculated number of &quot;even&quot; turns.
            // Allow the player at least one &quot;normal&quot; turn before the
            // &quot;even&quot; turns to help with loading infantry in deployment.
<span class="nc bnc" id="L3803" title="All 4 branches missed.">            while ((numEven &gt; 0) &amp;&amp; withinTeamTurns.hasMoreEvenElements()) {</span>
<span class="nc" id="L3804">                IPlayer evenPlayer = (IPlayer) withinTeamTurns.nextEvenElement();</span>
<span class="nc" id="L3805">                turns.addElement(new GameTurn.EntityClassTurn(evenPlayer.getId(), evenMask));</span>
<span class="nc" id="L3806">                numEven--;</span>
<span class="nc" id="L3807">            }</span>
        }

        // set fields in game
<span class="nc" id="L3811">        game.setTurnVector(turns);</span>
<span class="nc" id="L3812">        game.resetTurnIndex();</span>

        // send turns to all players
<span class="nc" id="L3815">        send(createTurnVectorPacket());</span>
<span class="nc" id="L3816">    }</span>

    private static String getColorForPlayer(IPlayer p) {
<span class="nc" id="L3819">        return &quot;&lt;B&gt;&lt;font color='&quot; + p.getColour().getHexString(0x00F0F0F0) + &quot;'&gt;&quot; + p.getName() + &quot;&lt;/font&gt;&lt;/B&gt;&quot;;</span>
    }

    /**
     * Write the initiative results to the report
     */
    private void writeInitiativeReport(boolean abbreviatedReport) {
        // write to report
        Report r;
<span class="nc" id="L3828">        boolean deployment = false;</span>
<span class="nc bnc" id="L3829" title="All 2 branches missed.">        if (!abbreviatedReport) {</span>
<span class="nc" id="L3830">            r = new Report(1210);</span>
<span class="nc" id="L3831">            r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L3832" title="All 4 branches missed.">            if ((game.getLastPhase() == IGame.Phase.PHASE_DEPLOYMENT) || game.isDeploymentComplete()</span>
<span class="nc bnc" id="L3833" title="All 2 branches missed.">                    || !game.shouldDeployThisRound()) {</span>
<span class="nc" id="L3834">                r.messageId = 1000;</span>
<span class="nc" id="L3835">                r.add(game.getRoundCount());</span>
            } else {
<span class="nc" id="L3837">                deployment = true;</span>
<span class="nc bnc" id="L3838" title="All 2 branches missed.">                if (game.getRoundCount() == 0) {</span>
<span class="nc" id="L3839">                    r.messageId = 1005;</span>
                } else {
<span class="nc" id="L3841">                    r.messageId = 1010;</span>
<span class="nc" id="L3842">                    r.add(game.getRoundCount());</span>
                }
            }
<span class="nc" id="L3845">            addReport(r);</span>
            // write separator
<span class="nc" id="L3847">            addReport(new Report(1200, Report.PUBLIC));</span>
        } else {
<span class="nc" id="L3849">            addReport(new Report(1210, Report.PUBLIC));</span>
        }

<span class="nc bnc" id="L3852" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3853">            r = new Report(1040, Report.PUBLIC);</span>
<span class="nc" id="L3854">            addReport(r);</span>
<span class="nc bnc" id="L3855" title="All 2 branches missed.">            for (Enumeration&lt;GameTurn&gt; e = game.getTurns(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L3856">                GameTurn t = e.nextElement();</span>
<span class="nc bnc" id="L3857" title="All 2 branches missed.">                if (t instanceof GameTurn.SpecificEntityTurn) {</span>
<span class="nc" id="L3858">                    Entity entity = game.getEntity(((GameTurn.SpecificEntityTurn) t).getEntityNum());</span>
<span class="nc" id="L3859">                    r = new Report(1045);</span>
<span class="nc" id="L3860">                    r.subject = entity.getId();</span>
<span class="nc" id="L3861">                    r.addDesc(entity);</span>
<span class="nc" id="L3862">                    r.add(entity.getInitiative().toString());</span>
<span class="nc" id="L3863">                    addReport(r);</span>
<span class="nc" id="L3864">                } else {</span>
<span class="nc" id="L3865">                    IPlayer player = getPlayer(t.getPlayerNum());</span>
<span class="nc bnc" id="L3866" title="All 2 branches missed.">                    if (null != player) {</span>
<span class="nc" id="L3867">                        r = new Report(1050, Report.PUBLIC);</span>
<span class="nc" id="L3868">                        r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L3869">                        addReport(r);</span>
                    }
                }
<span class="nc" id="L3872">            }</span>
        } else {
<span class="nc bnc" id="L3874" title="All 2 branches missed.">            for (Enumeration&lt;Team&gt; i = game.getTeams(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L3875">                final Team team = i.nextElement();</span>

                // Teams with no active players can be ignored
<span class="nc bnc" id="L3878" title="All 2 branches missed.">                if (team.isObserverTeam()) {</span>
<span class="nc" id="L3879">                    continue;</span>
                }

                // If there is only one non-observer player, list
                // them as the 'team', and use the team initiative
<span class="nc bnc" id="L3884" title="All 2 branches missed.">                if (team.getNonObserverSize() == 1) {</span>
<span class="nc" id="L3885">                    final IPlayer player = team.getNonObserverPlayers().nextElement();</span>
<span class="nc" id="L3886">                    r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3887">                    r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L3888">                    r.add(team.getInitiative().toString());</span>
<span class="nc" id="L3889">                    addReport(r);</span>
<span class="nc" id="L3890">                } else {</span>
                    // Multiple players. List the team, then break it down.
<span class="nc" id="L3892">                    r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3893">                    r.add(IPlayer.teamNames[team.getId()]);</span>
<span class="nc" id="L3894">                    r.add(team.getInitiative().toString());</span>
<span class="nc" id="L3895">                    addReport(r);</span>
<span class="nc bnc" id="L3896" title="All 2 branches missed.">                    for (Enumeration&lt;IPlayer&gt; j = team.getNonObserverPlayers(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L3897">                        final IPlayer player = j.nextElement();</span>
<span class="nc" id="L3898">                        r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3899">                        r.indent();</span>
<span class="nc" id="L3900">                        r.add(player.getName());</span>
<span class="nc" id="L3901">                        r.add(player.getInitiative().toString());</span>
<span class="nc" id="L3902">                        addReport(r);</span>
<span class="nc" id="L3903">                    }</span>
                }
<span class="nc" id="L3905">            }</span>

<span class="nc bnc" id="L3907" title="All 2 branches missed.">            if (!doBlind()) {</span>

                // The turn order is different in movement phase
                // if a player has any &quot;even&quot; moving units.
<span class="nc" id="L3911">                r = new Report(1020, Report.PUBLIC);</span>

<span class="nc" id="L3913">                boolean hasEven = false;</span>
<span class="nc bnc" id="L3914" title="All 2 branches missed.">                for (Enumeration&lt;GameTurn&gt; i = game.getTurns(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L3915">                    GameTurn turn = i.nextElement();</span>
<span class="nc" id="L3916">                    IPlayer player = getPlayer(turn.getPlayerNum());</span>
<span class="nc bnc" id="L3917" title="All 2 branches missed.">                    if (null != player) {</span>
<span class="nc" id="L3918">                        r.add(player.getName());</span>
<span class="nc bnc" id="L3919" title="All 2 branches missed.">                        if (player.getEvenTurns() &gt; 0) {</span>
<span class="nc" id="L3920">                            hasEven = true;</span>
                        }
                    }
<span class="nc" id="L3923">                }</span>
<span class="nc" id="L3924">                r.newlines = 2;</span>
<span class="nc" id="L3925">                addReport(r);</span>
<span class="nc bnc" id="L3926" title="All 2 branches missed.">                if (hasEven) {</span>
<span class="nc" id="L3927">                    r = new Report(1021, Report.PUBLIC);</span>
<span class="nc bnc" id="L3928" title="All 2 branches missed.">                    if ((game.getOptions().booleanOption(OptionsConstants.INIT_INF_DEPLOY_EVEN)</span>
<span class="nc bnc" id="L3929" title="All 2 branches missed.">                            || game.getOptions().booleanOption(OptionsConstants.INIT_PROTOS_MOVE_EVEN))</span>
<span class="nc bnc" id="L3930" title="All 2 branches missed.">                            &amp;&amp; !(game.getLastPhase() == IGame.Phase.PHASE_END_REPORT)) {</span>
<span class="nc" id="L3931">                        r.choose(true);</span>
                    } else {
<span class="nc" id="L3933">                        r.choose(false);</span>
                    }
<span class="nc" id="L3935">                    r.indent();</span>
<span class="nc" id="L3936">                    r.newlines = 2;</span>
<span class="nc" id="L3937">                    addReport(r);</span>
                }
            }

        }
<span class="nc bnc" id="L3942" title="All 2 branches missed.">        if (!abbreviatedReport) {</span>
            // we don't much care about wind direction and such in a hard vacuum
<span class="nc bnc" id="L3944" title="All 2 branches missed.">            if(!game.getBoard().inSpace()) {</span>
                // Wind direction and strength
<span class="nc" id="L3946">                Report rWindDir = new Report(1025, Report.PUBLIC);</span>
<span class="nc" id="L3947">                rWindDir.add(game.getPlanetaryConditions().getWindDirDisplayableName());</span>
<span class="nc" id="L3948">                rWindDir.newlines = 0;</span>
<span class="nc" id="L3949">                Report rWindStr = new Report(1030, Report.PUBLIC);</span>
<span class="nc" id="L3950">                rWindStr.add(game.getPlanetaryConditions().getWindDisplayableName());</span>
<span class="nc" id="L3951">                rWindStr.newlines = 0;</span>
<span class="nc" id="L3952">                Report rWeather = new Report(1031, Report.PUBLIC);</span>
<span class="nc" id="L3953">                rWeather.add(game.getPlanetaryConditions().getWeatherDisplayableName());</span>
<span class="nc" id="L3954">                rWeather.newlines = 0;</span>
<span class="nc" id="L3955">                Report rLight = new Report(1032, Report.PUBLIC);</span>
<span class="nc" id="L3956">                rLight.add(game.getPlanetaryConditions().getLightDisplayableName());</span>
<span class="nc" id="L3957">                Report rVis = new Report(1033, Report.PUBLIC);</span>
<span class="nc" id="L3958">                rVis.add(game.getPlanetaryConditions().getFogDisplayableName());</span>
<span class="nc" id="L3959">                addReport(rWindDir);</span>
<span class="nc" id="L3960">                addReport(rWindStr);</span>
<span class="nc" id="L3961">                addReport(rWeather);</span>
<span class="nc" id="L3962">                addReport(rLight);</span>
<span class="nc" id="L3963">                addReport(rVis);</span>
            }

<span class="nc bnc" id="L3966" title="All 2 branches missed.">            if (deployment) {</span>
<span class="nc" id="L3967">                addNewLines();</span>
            }
        }
<span class="nc" id="L3970">    }</span>

    private void applyDropShipLandingDamage(Coords centralPos, Entity killer) {
        // first cycle through hexes to figure out final elevation
<span class="nc" id="L3974">        IHex centralHex = game.getBoard().getHex(centralPos);</span>
<span class="nc bnc" id="L3975" title="All 2 branches missed.">        if (null == centralHex) {</span>
            // shouldn't happen
<span class="nc" id="L3977">            return;</span>
        }
<span class="nc" id="L3979">        int finalElev = centralHex.getLevel();</span>
<span class="nc bnc" id="L3980" title="All 2 branches missed.">        if (!centralHex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L3981" title="All 2 branches missed.">            &amp;&amp; !centralHex.containsTerrain(Terrains.ROAD)) {</span>
<span class="nc" id="L3982">            finalElev--;</span>
        }
<span class="nc" id="L3984">        Vector&lt;Coords&gt; positions = new Vector&lt;&gt;();</span>
<span class="nc" id="L3985">        positions.add(centralPos);</span>
<span class="nc bnc" id="L3986" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L3987">            Coords pos = centralPos.translated(i);</span>
<span class="nc" id="L3988">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L3989" title="All 2 branches missed.">            if (null == hex) {</span>
<span class="nc" id="L3990">                continue;</span>
            }
<span class="nc bnc" id="L3992" title="All 2 branches missed.">            if (hex.getLevel() &lt; finalElev) {</span>
<span class="nc" id="L3993">                finalElev = hex.getLevel();</span>
            }
<span class="nc" id="L3995">            positions.add(pos);</span>
        }
        // ok now cycle through hexes and make all changes
<span class="nc bnc" id="L3998" title="All 2 branches missed.">        for (Coords pos : positions) {</span>
<span class="nc" id="L3999">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc" id="L4000">            hex.setLevel(finalElev);</span>
            // get rid of woods and replace with rough
<span class="nc bnc" id="L4002" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L4003">                hex.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L4004">                hex.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L4005">                hex.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L4006">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.ROUGH, 1));</span>
            }
<span class="nc" id="L4008">            sendChangedHex(pos);</span>
<span class="nc" id="L4009">        }</span>

<span class="nc" id="L4011">        applyDropShipProximityDamage(centralPos, killer);</span>
<span class="nc" id="L4012">    }</span>

    private void applyDropShipProximityDamage(Coords centralPos, Entity killer) {
<span class="nc" id="L4015">        applyDropShipProximityDamage(centralPos, false, 0, killer);</span>
<span class="nc" id="L4016">    }</span>

    /**
     * apply damage to units and buildings within a certain radius of a landing
     * or lifting off DropShip
     *
     * @param centralPos - the Coords for the central position of the DropShip
     */
    private void applyDropShipProximityDamage(Coords centralPos, boolean rearArc, int facing,
                                              Entity killer) {

<span class="nc" id="L4027">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>

        // anything in the central hex or adjacent hexes is destroyed
<span class="nc" id="L4030">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>
<span class="nc bnc" id="L4031" title="All 2 branches missed.">        for (Entity en : game.getEntitiesVector(centralPos)) {</span>
<span class="nc bnc" id="L4032" title="All 2 branches missed.">            if (!en.isAirborne()) {</span>
<span class="nc" id="L4033">                addReport(destroyEntity(en, &quot;DropShip proximity damage&quot;, false,</span>
                                        false));
<span class="nc" id="L4035">                alreadyHit.add(en.getId());</span>
            }
<span class="nc" id="L4037">        }</span>
<span class="nc" id="L4038">        Building bldg = game.getBoard().getBuildingAt(centralPos);</span>
<span class="nc bnc" id="L4039" title="All 2 branches missed.">        if (null != bldg) {</span>
<span class="nc" id="L4040">            collapseBuilding(bldg, positionMap, centralPos, vPhaseReport);</span>
        }
<span class="nc bnc" id="L4042" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4043">            Coords pos = centralPos.translated(i);</span>
<span class="nc bnc" id="L4044" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector(pos)) {</span>
<span class="nc bnc" id="L4045" title="All 2 branches missed.">                if (!en.isAirborne()) {</span>
<span class="nc" id="L4046">                    addReport(destroyEntity(en, &quot;DropShip proximity damage&quot;,</span>
                                            false, false));
                }
<span class="nc" id="L4049">                alreadyHit.add(en.getId());</span>
<span class="nc" id="L4050">            }</span>
<span class="nc" id="L4051">            bldg = game.getBoard().getBuildingAt(pos);</span>
<span class="nc bnc" id="L4052" title="All 2 branches missed.">            if (null != bldg) {</span>
<span class="nc" id="L4053">                collapseBuilding(bldg, positionMap, pos, vPhaseReport);</span>
            }
        }

        // Report r;
        // ok now I need to look at the damage rings - start at 2 and go to 7
<span class="nc bnc" id="L4059" title="All 2 branches missed.">        for (int i = 2; i &lt; 8; i++) {</span>
<span class="nc" id="L4060">            int damageDice = (8 - i) * 2;</span>
<span class="nc" id="L4061">            List&lt;Coords&gt; ring = centralPos.allAtDistance(i);</span>
<span class="nc bnc" id="L4062" title="All 2 branches missed.">            for (Coords pos : ring) {</span>
<span class="nc bnc" id="L4063" title="All 4 branches missed.">                if (rearArc &amp;&amp; !Compute.isInArc(centralPos, facing, pos, Compute.ARC_AFT)) {</span>
<span class="nc" id="L4064">                    continue;</span>
                }

<span class="nc" id="L4067">                alreadyHit = artilleryDamageHex(pos, centralPos, damageDice, null, killer.getId(),</span>
                        killer, null, false, 0, vPhaseReport, false,
                        alreadyHit, true);
<span class="nc" id="L4070">            }</span>
        }
<span class="nc" id="L4072">        destroyDoomedEntities(alreadyHit);</span>
<span class="nc" id="L4073">    }</span>

    /**
     * Marks ineligible entities as not ready for this phase
     */
    private void setIneligible(IGame.Phase phase) {
<span class="nc" id="L4079">        Vector&lt;Entity&gt; assistants = new Vector&lt;&gt;();</span>
<span class="nc" id="L4080">        boolean assistable = false;</span>

<span class="nc bnc" id="L4082" title="All 2 branches missed.">        if (isPlayerForcedVictory()) {</span>
<span class="nc" id="L4083">            assistants.addAll(game.getEntitiesVector());</span>
        } else {
<span class="nc bnc" id="L4085" title="All 2 branches missed.">            for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L4086" title="All 2 branches missed.">                if (entity.isEligibleFor(phase)) {</span>
<span class="nc" id="L4087">                    assistable = true;</span>
                } else {
<span class="nc" id="L4089">                    assistants.addElement(entity);</span>
                }
<span class="nc" id="L4091">            }</span>
        }
<span class="nc bnc" id="L4093" title="All 2 branches missed.">        for (Entity assistant : assistants) {</span>
<span class="nc bnc" id="L4094" title="All 4 branches missed.">            if (!assistable || !assistant.canAssist(phase)) {</span>
<span class="nc" id="L4095">                assistant.setDone(true);</span>
            }
<span class="nc" id="L4097">        }</span>
<span class="nc" id="L4098">    }</span>

    /**
     * Have the loader load the indicated unit. The unit being loaded loses its
     * turn.
     *
     * @param loader - the &lt;code&gt;Entity&lt;/code&gt; that is loading the unit.
     * @param unit   - the &lt;code&gt;Entity&lt;/code&gt; being loaded.
     */
    private void loadUnit(Entity loader, Entity unit, int bayNumber) {
        // ProtoMechs share a single turn for a Point. When loading one we don't remove its turn
        // unless it's the last unit in the Point to act.
<span class="nc" id="L4110">        int remainingProtos = 0;</span>
<span class="nc bnc" id="L4111" title="All 2 branches missed.">        if (unit.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc bnc" id="L4112" title="All 2 branches missed.">            remainingProtos = game.getSelectedEntityCount(en -&gt; en.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="nc bnc" id="L4113" title="All 2 branches missed.">                    &amp;&amp; en.getId() != unit.getId()</span>
<span class="nc bnc" id="L4114" title="All 2 branches missed.">                    &amp;&amp; en.isSelectableThisTurn()</span>
<span class="nc bnc" id="L4115" title="All 2 branches missed.">                    &amp;&amp; en.getOwnerId() == unit.getOwnerId()</span>
<span class="nc bnc" id="L4116" title="All 2 branches missed.">                    &amp;&amp; en.getUnitNumber() == unit.getUnitNumber());</span>
        }

<span class="nc bnc" id="L4119" title="All 6 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; !unit.isDone()</span>
                &amp;&amp; (remainingProtos == 0)) {
            // Remove the *last* friendly turn (removing the *first* penalizes
            // the opponent too much, and re-calculating moves is too hard).
<span class="nc" id="L4123">            game.removeTurnFor(unit);</span>
<span class="nc" id="L4124">            send(createTurnVectorPacket());</span>
        }

        // When loading an Aero into a squadron in the lounge, make sure the
        // loaded aero has the same bomb loadout as the squadron
        // We want to do this before the fighter is loaded: when the fighter
        // is loaded into the squadron, the squadrons bombing attacks are
        // adjusted based on the bomb-loadout on the fighter.
<span class="nc bnc" id="L4132" title="All 4 branches missed.">        if ((game.getPhase() == Phase.PHASE_LOUNGE)</span>
            &amp;&amp; (loader instanceof FighterSquadron)) {
<span class="nc" id="L4134">            ((IBomber) unit).setBombChoices(((FighterSquadron) loader)</span>
<span class="nc" id="L4135">                                                 .getBombChoices());</span>
        }

        // Load the unit. Do not check for elevation during deployment
<span class="nc bnc" id="L4139" title="All 2 branches missed.">        boolean checkElevation = (game.getPhase() != Phase.PHASE_DEPLOYMENT)</span>
<span class="nc bnc" id="L4140" title="All 2 branches missed.">                                 &amp;&amp; (game.getPhase() != Phase.PHASE_LOUNGE);</span>
<span class="nc bnc" id="L4141" title="All 2 branches missed.">        if (bayNumber == -1) {</span>
<span class="nc" id="L4142">            loader.load(unit, checkElevation);</span>
        } else {
<span class="nc" id="L4144">            loader.load(unit, checkElevation, bayNumber);</span>
        }

        // The loaded unit is being carried by the loader.
<span class="nc" id="L4148">        unit.setTransportId(loader.getId());</span>

        // Remove the loaded unit from the screen.
<span class="nc" id="L4151">        unit.setPosition(null);</span>

        // set deployment round of the loadee to equal that of the loader
<span class="nc" id="L4154">        unit.setDeployRound(loader.getDeployRound());</span>
        
        //Update the loading unit's passenger count, if it's a large craft
<span class="nc bnc" id="L4157" title="All 4 branches missed.">        if (loader instanceof SmallCraft || loader instanceof Jumpship) {</span>
            //Don't add dropship crew to a jumpship or station's passenger list
<span class="nc bnc" id="L4159" title="All 2 branches missed.">            if (!unit.isLargeCraft()) {</span>
<span class="nc" id="L4160">                loader.setNPassenger(loader.getNPassenger() + unit.getCrew().getSize());</span>
            }
        }

        // Update the loaded unit.
<span class="nc" id="L4165">        entityUpdate(unit.getId());</span>

        // Taharqa (2/28/13): I am not sure why the loader is not getting
        // updated too - not updating it
        // is causing problem in the chat lounge loading, so I am going to do it
        // here, but if we get
        // weird results for other loading, then the reason is probably this
<span class="nc" id="L4172">        entityUpdate(loader.getId());</span>
<span class="nc" id="L4173">    }</span>

    /**
     * Have the loader tow the indicated unit. The unit being towed loses its
     * turn.
     *
     * @param loader - the &lt;code&gt;Entity&lt;/code&gt; that is towing the unit.
     * @param unit   - the &lt;code&gt;Entity&lt;/code&gt; being towed.
     */
    private void towUnit(Entity loader, Entity unit) {
<span class="nc bnc" id="L4183" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; !unit.isDone()) {</span>
            // Remove the *last* friendly turn (removing the *first* penalizes
            // the opponent too much, and re-calculating moves is too hard).
<span class="nc" id="L4186">            game.removeTurnFor(unit);</span>
<span class="nc" id="L4187">            send(createTurnVectorPacket());</span>
        }

<span class="nc" id="L4190">        loader.towUnit(unit.getId());</span>

        // set deployment round of the loadee to equal that of the loader
<span class="nc" id="L4193">        unit.setDeployRound(loader.getDeployRound());</span>

        // Update the loader and towed units.
<span class="nc" id="L4196">        entityUpdate(unit.getId());</span>
<span class="nc" id="L4197">        entityUpdate(loader.getId());</span>
<span class="nc" id="L4198">    }</span>

    /**
     * Have the tractor drop the indicated trailer. This will also disconnect all
     * trailers that follow the one dropped.
     *
     * @param tractor
     *            - the &lt;code&gt;Entity&lt;/code&gt; that is disconnecting the trailer.
     * @param unloaded
     *            - the &lt;code&gt;Targetable&lt;/code&gt; unit being unloaded.
     * @param pos
     *            - the &lt;code&gt;Coords&lt;/code&gt; for the unloaded unit.
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was successfully unloaded,
     *         &lt;code&gt;false&lt;/code&gt; if the trailer isn't carried by tractor.
     */
    private boolean disconnectUnit(Entity tractor, Targetable unloaded, Coords pos) {

        // We can only unload Entities.
        Entity trailer;
<span class="nc bnc" id="L4217" title="All 2 branches missed.">        if (unloaded instanceof Entity) {</span>
<span class="nc" id="L4218">            trailer = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4220">            return false;</span>
        }
        // disconnectUnit() updates anything behind 'trailer' too, so copy
        // the list of trailers before we alter it so entityUpdate() can be
        // run on all of them. Also, add the entity towing Trailer to the list
<span class="nc" id="L4225">        List&lt;Integer&gt; trailerList = new ArrayList&lt;&gt;(trailer.getConnectedUnits());</span>
<span class="nc" id="L4226">        trailerList.add(trailer.getTowedBy());</span>

        // Unload the unit.
<span class="nc" id="L4229">        tractor.disconnectUnit(trailer.getId());</span>

        // Update the tractor and all affected trailers.
<span class="nc bnc" id="L4232" title="All 2 branches missed.">        for (int id : trailerList) {</span>
<span class="nc" id="L4233">            entityUpdate(id);</span>
<span class="nc" id="L4234">        }</span>
<span class="nc" id="L4235">        entityUpdate(trailer.getId());</span>
<span class="nc" id="L4236">        entityUpdate(tractor.getId());</span>

        // Unloaded successfully.
<span class="nc" id="L4239">        return true;</span>
    }

    private boolean unloadUnit(Entity unloader, Targetable unloaded,
                               Coords pos, int facing, int elevation) {
<span class="nc" id="L4244">        return unloadUnit(unloader, unloaded, pos, facing, elevation, false,</span>
                false);
    }

    /**
     * Have the unloader unload the indicated unit. The unit being unloaded may
     * or may not gain a turn
     *
     * @param unloader
     *            - the &lt;code&gt;Entity&lt;/code&gt; that is unloading the unit.
     * @param unloaded
     *            - the &lt;code&gt;Targetable&lt;/code&gt; unit being unloaded.
     * @param pos
     *            - the &lt;code&gt;Coords&lt;/code&gt; for the unloaded unit.
     * @param facing
     *            - the &lt;code&gt;int&lt;/code&gt; facing for the unloaded unit.
     * @param elevation
     *            - the &lt;code&gt;int&lt;/code&gt; elevation at which to unload, if both
     *            loader and loaded units use VTOL movement.
     * @param evacuation
     *            - a &lt;code&gt;boolean&lt;/code&gt; indicating whether this unit is being
     *            unloaded as a result of its carrying units destruction
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was successfully unloaded,
     *         &lt;code&gt;false&lt;/code&gt; if the unit isn't carried in unloader.
     */
    private boolean unloadUnit(Entity unloader, Targetable unloaded,
            Coords pos, int facing, int elevation, boolean evacuation,
            boolean duringDeployment) {

        // We can only unload Entities.
        Entity unit;
<span class="nc bnc" id="L4275" title="All 2 branches missed.">        if (unloaded instanceof Entity) {</span>
<span class="nc" id="L4276">            unit = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4278">            return false;</span>
        }

        // Unload the unit.
<span class="nc bnc" id="L4282" title="All 2 branches missed.">        if (!unloader.unload(unit)) {</span>
<span class="nc" id="L4283">            return false;</span>
        }

        // The unloaded unit is no longer being carried.
<span class="nc" id="L4287">        unit.setTransportId(Entity.NONE);</span>

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4290">        unit.setPosition(pos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4293" title="All 2 branches missed.">        if (pos != null) {</span>
<span class="nc" id="L4294">            unit.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4298">        unit.setFacing(facing);</span>
<span class="nc" id="L4299">        unit.setSecondaryFacing(facing);</span>

<span class="nc" id="L4301">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L4302" title="All 2 branches missed.">        boolean isBridge = (hex != null)</span>
<span class="nc bnc" id="L4303" title="All 2 branches missed.">                &amp;&amp; hex.containsTerrain(Terrains.PAVEMENT);</span>

<span class="nc bnc" id="L4305" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L4306">            unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4307" title="All 2 branches missed.">        } else if (unloader.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L4308" title="All 2 branches missed.">            if (unit.getMovementMode() == EntityMovementMode.VTOL) {</span>
                // Flying units unload to the same elevation as the flying
                // transport
<span class="nc" id="L4311">                unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4312" title="All 2 branches missed.">            } else if (game.getBoard().getBuildingAt(pos) != null) {</span>
                // non-flying unit unloaded from a flying onto a building
                // -&gt; sit on the roof
<span class="nc" id="L4315">                unit.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
            } else {
<span class="nc bnc" id="L4317" title="All 2 branches missed.">                while (elevation &gt;= -hex.depth()) {</span>
<span class="nc bnc" id="L4318" title="All 2 branches missed.">                    if (unit.isElevationValid(elevation, hex)) {</span>
<span class="nc" id="L4319">                        unit.setElevation(elevation);</span>
<span class="nc" id="L4320">                        break;</span>
                    }
<span class="nc" id="L4322">                    elevation--;</span>
                    // If unit is landed, the while loop breaks before here
                    // And unit.moved will be MOVE_NONE
                    // If we can jump, use jump
<span class="nc bnc" id="L4326" title="All 2 branches missed.">                    if (unit.getJumpMP() &gt; 0) {</span>
<span class="nc" id="L4327">                        unit.moved = EntityMovementType.MOVE_JUMP;</span>
                    } else { // Otherwise, use walk trigger check for ziplines
<span class="nc" id="L4329">                        unit.moved = EntityMovementType.MOVE_WALK;</span>
                    }
                }
<span class="nc bnc" id="L4332" title="All 2 branches missed.">                if (!unit.isElevationValid(elevation, hex)) {</span>
<span class="nc" id="L4333">                    return false;</span>
                }
            }
<span class="nc bnc" id="L4336" title="All 2 branches missed.">        } else if (game.getBoard().getBuildingAt(pos) != null) {</span>
            // non flying unit unloading units into a building
            // -&gt; sit in the building at the same elevation
<span class="nc" id="L4339">            unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4340" title="All 2 branches missed.">        } else if (hex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
<span class="nc bnc" id="L4341" title="All 2 branches missed.">            if ((unit.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L4342" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L4343" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L4344" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L4345" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L4346" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L4347" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.ICE) || isBridge) {</span>
                // units that can float stay on the surface, or we go on the
                // bridge
                // this means elevation 0, because elevation is relative to the
                // surface
<span class="nc" id="L4352">                unit.setElevation(0);</span>
            }
        } else {
            // default to the floor of the hex.
            // unit elevation is relative to the surface
<span class="nc" id="L4357">            unit.setElevation(hex.floor() - hex.surface());</span>
        }

        // Check for zip lines PSR -- MOVE_WALK implies ziplines
<span class="nc bnc" id="L4361" title="All 2 branches missed.">        if (unit.moved == EntityMovementType.MOVE_WALK) {</span>
<span class="nc bnc" id="L4362" title="All 4 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_ZIPLINES)</span>
                    &amp;&amp; (unit instanceof Infantry)
<span class="nc bnc" id="L4364" title="All 2 branches missed.">                    &amp;&amp; !((Infantry) unit).isMechanized()) {</span>

               // Handle zip lines
<span class="nc" id="L4367">                PilotingRollData psr = getEjectModifiers(game, unit, 0, false,</span>
<span class="nc" id="L4368">                        unit.getPosition(), &quot;Anti-mek skill&quot;);</span>
                // Factor in Elevation
<span class="nc bnc" id="L4370" title="All 2 branches missed.">                if (unloader.getElevation() &gt; 0) {</span>
<span class="nc" id="L4371">                    psr.addModifier(unloader.getElevation(), &quot;elevation&quot;);</span>
                }
<span class="nc" id="L4373">                int roll = Compute.d6(2);</span>

                // Report ziplining
<span class="nc" id="L4376">                Report r = new Report(9920);</span>
<span class="nc" id="L4377">                r.subject = unit.getId();</span>
<span class="nc" id="L4378">                r.addDesc(unit);</span>
<span class="nc" id="L4379">                r.newlines = 0;</span>
<span class="nc" id="L4380">                addReport(r);</span>

                // Report TN
<span class="nc" id="L4383">                r = new Report(9921);</span>
<span class="nc" id="L4384">                r.subject = unit.getId();</span>
<span class="nc" id="L4385">                r.add(psr.getValue());</span>
<span class="nc" id="L4386">                r.add(psr.getDesc());</span>
<span class="nc" id="L4387">                r.add(roll);</span>
<span class="nc" id="L4388">                r.newlines = 0;</span>
<span class="nc" id="L4389">                addReport(r);</span>

<span class="nc bnc" id="L4391" title="All 2 branches missed.">                if (roll &lt; psr.getValue()) { // Failure!</span>
<span class="nc" id="L4392">                    r = new Report(9923);</span>
<span class="nc" id="L4393">                    r.subject = unit.getId();</span>
<span class="nc" id="L4394">                    r.add(psr.getValue());</span>
<span class="nc" id="L4395">                    r.add(roll);</span>
<span class="nc" id="L4396">                    addReport(r);</span>

<span class="nc" id="L4398">                    HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4399">                    hit.setIgnoreInfantryDoubleDamage(true);</span>
<span class="nc" id="L4400">                    addReport(damageEntity(unit, hit, 5));</span>
<span class="nc" id="L4401">                } else { //  Report success</span>
<span class="nc" id="L4402">                    r = new Report(9922);</span>
<span class="nc" id="L4403">                    r.subject = unit.getId();</span>
<span class="nc" id="L4404">                    r.add(psr.getValue());</span>
<span class="nc" id="L4405">                    r.add(roll);</span>
<span class="nc" id="L4406">                    addReport(r);</span>
                }
<span class="nc" id="L4408">                addNewLines();</span>
<span class="nc" id="L4409">            } else {</span>
<span class="nc" id="L4410">                return false;</span>
            }
        }

<span class="nc" id="L4414">        addReport(doSetLocationsExposure(unit, hex, false, unit.getElevation()));</span>

        // unlike other unloaders, entities unloaded from droppers can still
        // move (unless infantry)
<span class="nc bnc" id="L4418" title="All 6 branches missed.">        if (!evacuation &amp;&amp; (unloader instanceof SmallCraft)</span>
            &amp;&amp; !(unit instanceof Infantry)) {
<span class="nc" id="L4420">            unit.setUnloaded(false);</span>
<span class="nc" id="L4421">            unit.setDone(false);</span>

            // unit uses half of walk mp and is treated as moving one hex
<span class="nc" id="L4424">            unit.mpUsed = unit.getOriginalWalkMP() / 2;</span>
<span class="nc" id="L4425">            unit.delta_distance = 1;</span>
        }

        // If we unloaded during deployment, allow a turn
<span class="nc bnc" id="L4429" title="All 2 branches missed.">        if (duringDeployment) {</span>
<span class="nc" id="L4430">            unit.setUnloaded(false);</span>
<span class="nc" id="L4431">            unit.setDone(false);</span>
        }
        
        //Update the transport unit's passenger count, if it's a large craft
<span class="nc bnc" id="L4435" title="All 4 branches missed.">        if (unloader instanceof SmallCraft || unloader instanceof Jumpship) {</span>
            //Don't add dropship crew to a jumpship or station's passenger list
<span class="nc bnc" id="L4437" title="All 2 branches missed.">            if (!unit.isLargeCraft()) {</span>
<span class="nc" id="L4438">                unloader.setNPassenger(Math.max(0, unloader.getNPassenger() - unit.getCrew().getSize()));</span>
            }
        }

        // Update the unloaded unit.
<span class="nc" id="L4443">        entityUpdate(unit.getId());</span>

        // Unloaded successfully.
<span class="nc" id="L4446">        return true;</span>
    }

    /**
     * Do a piloting skill check to attempt landing
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is landing
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this landing.
     */
    private void attemptLanding(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L4456" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L4457">            return;</span>
        }

        // okay, print the info
<span class="nc" id="L4461">        Report r = new Report(9605);</span>
<span class="nc" id="L4462">        r.subject = entity.getId();</span>
<span class="nc" id="L4463">        r.addDesc(entity);</span>
<span class="nc" id="L4464">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L4465">        addReport(r);</span>

        // roll
<span class="nc" id="L4468">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L4469">        r = new Report(9606);</span>
<span class="nc" id="L4470">        r.subject = entity.getId();</span>
<span class="nc" id="L4471">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L4472">        r.add(roll.getDesc());</span>
<span class="nc" id="L4473">        r.add(diceRoll);</span>
        // boolean suc;
<span class="nc bnc" id="L4475" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L4476">            r.choose(false);</span>
<span class="nc" id="L4477">            addReport(r);</span>
<span class="nc" id="L4478">            int mof = roll.getValue() - diceRoll;</span>
<span class="nc" id="L4479">            int damage = 10 * (mof);</span>
            // Report damage taken
<span class="nc" id="L4481">            r = new Report(9609);</span>
<span class="nc" id="L4482">            r.indent();</span>
<span class="nc" id="L4483">            r.addDesc(entity);</span>
<span class="nc" id="L4484">            r.add(damage);</span>
<span class="nc" id="L4485">            r.add(mof);</span>
<span class="nc" id="L4486">            addReport(r);</span>

<span class="nc" id="L4488">            int side = ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L4489" title="All 4 branches missed.">            if ((entity instanceof Aero) &amp;&amp; ((Aero) entity).isSpheroid()) {</span>
<span class="nc" id="L4490">                side = ToHitData.SIDE_REAR;</span>
            }
<span class="nc bnc" id="L4492" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L4493">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc" id="L4494">                addReport(damageEntity(entity, hit, 10));</span>
<span class="nc" id="L4495">                damage -= 10;</span>
<span class="nc" id="L4496">            }</span>
            // suc = false;
<span class="nc" id="L4498">        } else {</span>
<span class="nc" id="L4499">            r.choose(true);</span>
<span class="nc" id="L4500">            addReport(r);</span>
            // suc = true;
        }
<span class="nc" id="L4503">    }</span>

    private boolean launchUnit(Entity unloader, Targetable unloaded,
                               Coords pos, int facing, int velocity, int altitude, int[] moveVec,
                               int bonus) {

        Entity unit;
<span class="nc bnc" id="L4510" title="All 4 branches missed.">        if (unloaded instanceof Entity &amp;&amp; unloader instanceof Aero) {</span>
<span class="nc" id="L4511">            unit = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4513">            return false;</span>
        }

        // must be an ASF, Small Craft, or DropShip
<span class="nc bnc" id="L4517" title="All 4 branches missed.">        if (!unit.isAero() || unit instanceof Jumpship) {</span>
<span class="nc" id="L4518">            return false;</span>
        }
<span class="nc" id="L4520">        IAero a = (IAero) unit;</span>

        Report r;

        // Unload the unit.
<span class="nc bnc" id="L4525" title="All 2 branches missed.">        if (!unloader.unload(unit)) {</span>
<span class="nc" id="L4526">            return false;</span>
        }

        // The unloaded unit is no longer being carried.
<span class="nc" id="L4530">        unit.setTransportId(Entity.NONE);</span>

        // pg. 86 of TW: launched fighters can move in fire in the turn they are
        // unloaded
<span class="nc" id="L4534">        unit.setUnloaded(false);</span>

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4537">        unit.setPosition(pos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4540" title="All 2 branches missed.">        if (pos != null) {</span>
<span class="nc" id="L4541">            unit.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4545">        unit.setFacing(facing);</span>
<span class="nc" id="L4546">        unit.setSecondaryFacing(facing);</span>

        // the velocity of the unloaded unit is the same as the loader
<span class="nc" id="L4549">        a.setCurrentVelocity(velocity);</span>
<span class="nc" id="L4550">        a.setNextVelocity(velocity);</span>

        // if using advanced movement then set vectors
<span class="nc" id="L4553">        unit.setVectors(moveVec);</span>

<span class="nc" id="L4555">        unit.setAltitude(altitude);</span>

        // it seems that the done button is still being set and I can't figure
        // out where
<span class="nc" id="L4559">        unit.setDone(false);</span>

        // if the bonus was greater than zero then too many fighters were
        // launched and they
        // must all make control rolls
<span class="nc bnc" id="L4564" title="All 2 branches missed.">        if (bonus &gt; 0) {</span>
<span class="nc" id="L4565">            PilotingRollData psr = unit.getBasePilotingRoll();</span>
<span class="nc" id="L4566">            psr.addModifier(bonus, &quot;safe launch rate exceeded&quot;);</span>
<span class="nc" id="L4567">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L4568">            r = new Report(9375);</span>
<span class="nc" id="L4569">            r.subject = unit.getId();</span>
<span class="nc" id="L4570">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4571">            r.add(psr);</span>
<span class="nc" id="L4572">            r.add(ctrlroll);</span>
<span class="nc" id="L4573">            r.indent(1);</span>
<span class="nc bnc" id="L4574" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L4575">                r.choose(false);</span>
<span class="nc" id="L4576">                addReport(r);</span>
                // damage the unit
<span class="nc" id="L4578">                int damage = 10 * (psr.getValue() - ctrlroll);</span>
<span class="nc" id="L4579">                HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4580">                Vector&lt;Report&gt; rep = damageEntity(unit, hit, damage);</span>
<span class="nc" id="L4581">                Report.indentAll(rep, 1);</span>
<span class="nc" id="L4582">                rep.lastElement().newlines++;</span>
<span class="nc" id="L4583">                addReport(rep);</span>
                // did we destroy the unit?
<span class="nc bnc" id="L4585" title="All 2 branches missed.">                if (unit.isDoomed()) {</span>
                    // Clean out the entity.
<span class="nc" id="L4587">                    unit.setDestroyed(true);</span>
<span class="nc" id="L4588">                    game.moveToGraveyard(unit.getId());</span>
<span class="nc" id="L4589">                    send(createRemoveEntityPacket(unit.getId()));</span>
                }
<span class="nc" id="L4591">            } else {</span>
                // avoided damage
<span class="nc" id="L4593">                r.choose(true);</span>
<span class="nc" id="L4594">                r.newlines++;</span>
<span class="nc" id="L4595">                addReport(r);</span>
            }
<span class="nc" id="L4597">        } else {</span>
<span class="nc" id="L4598">            r = new Report(9374);</span>
<span class="nc" id="L4599">            r.subject = unit.getId();</span>
<span class="nc" id="L4600">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4601">            r.indent(1);</span>
<span class="nc" id="L4602">            r.newlines++;</span>
<span class="nc" id="L4603">            addReport(r);</span>
        }

        // launching from an OOC vessel causes damage
        // same thing if faster than 2 velocity in atmosphere
<span class="nc bnc" id="L4608" title="All 4 branches missed.">        if ((((Aero) unloader).isOutControlTotal() &amp;&amp; !unit.isDoomed())</span>
<span class="nc bnc" id="L4609" title="All 2 branches missed.">            || ((((Aero)unloader).getCurrentVelocity() &gt; 2) &amp;&amp; !game</span>
<span class="nc bnc" id="L4610" title="All 2 branches missed.">                .getBoard().inSpace())) {</span>
<span class="nc" id="L4611">            int damageRoll = Compute.d6(2);</span>
<span class="nc" id="L4612">            int damage = damageRoll * 10;</span>
<span class="nc" id="L4613">            r = new Report(9385);</span>
<span class="nc" id="L4614">            r.subject = unit.getId();</span>
<span class="nc" id="L4615">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4616">            r.add(damage);</span>
<span class="nc" id="L4617">            addReport(r);</span>
<span class="nc" id="L4618">            HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4619">            addReport(damageEntity(unit, hit, damage));</span>
            // did we destroy the unit?
<span class="nc bnc" id="L4621" title="All 2 branches missed.">            if (unit.isDoomed()) {</span>
                // Clean out the entity.
<span class="nc" id="L4623">                unit.setDestroyed(true);</span>
<span class="nc" id="L4624">                game.moveToGraveyard(unit.getId());</span>
<span class="nc" id="L4625">                send(createRemoveEntityPacket(unit.getId()));</span>
            }
        }

        // Update the unloaded unit.
<span class="nc" id="L4630">        entityUpdate(unit.getId());</span>

        // Set the turn mask. We need to be specific otherwise we run the risk
        // of having a unit of another class consume the turn and leave the
        // unloaded unit without a turn
        int turnMask;
<span class="nc" id="L4636">        List&lt;GameTurn&gt; turnVector = game.getTurnVector();</span>
<span class="nc bnc" id="L4637" title="All 2 branches missed.">        if (unit instanceof Dropship) {</span>
<span class="nc" id="L4638">            turnMask = GameTurn.CLASS_DROPSHIP;</span>
<span class="nc bnc" id="L4639" title="All 2 branches missed.">        } else if (unit instanceof SmallCraft) {</span>
<span class="nc" id="L4640">            turnMask = GameTurn.CLASS_SMALL_CRAFT;</span>
        } else {
<span class="nc" id="L4642">            turnMask = GameTurn.CLASS_AERO;</span>
        }
        // Add one, otherwise we consider the turn we're currently processing
<span class="nc" id="L4645">        int turnInsertIdx = game.getTurnIndex() + 1;</span>
        // We have to figure out where to insert this turn, to maintain proper
        // space turn order (JumpShips, Small Craft, DropShips, Aeros)
<span class="nc bnc" id="L4648" title="All 2 branches missed.">        for (; turnInsertIdx &lt; turnVector.size(); turnInsertIdx++) {</span>
<span class="nc" id="L4649">            GameTurn turn = turnVector.get(turnInsertIdx);</span>
<span class="nc bnc" id="L4650" title="All 2 branches missed.">            if (turn.isValidEntity(unit, game)) {</span>
<span class="nc" id="L4651">                break;</span>
            }
        }

        // ok add another turn for the unloaded entity so that it can move
<span class="nc" id="L4656">        GameTurn newTurn = new GameTurn.EntityClassTurn(unit.getOwner().getId(), turnMask);</span>
<span class="nc" id="L4657">        game.insertTurnAfter(newTurn, turnInsertIdx);</span>
        // brief everybody on the turn update
<span class="nc" id="L4659">        send(createTurnVectorPacket());</span>

<span class="nc" id="L4661">        return true;</span>
    }

    public void dropUnit(Entity drop, Entity entity, Coords curPos, int altitude) {
        // Unload the unit.
<span class="nc" id="L4666">        entity.unload(drop);</span>
        // The unloaded unit is no longer being carried.
<span class="nc" id="L4668">        drop.setTransportId(Entity.NONE);</span>

        // OK according to Welshman's pending ruling, when on the ground map
        // units should be deployed in the ring two hexes away from the DropShip
        // optimally, we should let people choose here, but that would be
        // complicated
        // so for now I am just going to distribute them. I will give each unit
        // the first
        // emptiest hex that has no water or magma in it.
        // I will start the circle based on the facing of the dropper
        // Spheroid - facing
        // Aerodyne - opposite of facing
        // http://www.classicbattletech.com/forums/index.php?topic=65600.msg1568089#new
<span class="nc bnc" id="L4681" title="All 4 branches missed.">        if (game.getBoard().onGround() &amp;&amp; (null != curPos)) {</span>
<span class="nc" id="L4682">            boolean selected = false;</span>
            int count;
<span class="nc" id="L4684">            int max = 0;</span>
<span class="nc" id="L4685">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L4686" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
                // no real rule for this but it seems to make sense that units
                // would drop behind an
                // aerodyne rather than in front of it
<span class="nc" id="L4690">                facing = (facing + 3) % 6;</span>
            }
<span class="nc" id="L4692">            boolean checkDanger = true;</span>
<span class="nc bnc" id="L4693" title="All 2 branches missed.">            while (!selected) {</span>
                // we can get caught in an infinite loop if all available hexes
                // are dangerous, so check for this
<span class="nc" id="L4696">                boolean allDanger = true;</span>
<span class="nc bnc" id="L4697" title="All 2 branches missed.">                for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4698">                    int dir = (facing + i) % 6;</span>
<span class="nc" id="L4699">                    Coords newPos = curPos.translated(dir, 2);</span>
<span class="nc" id="L4700">                    count = 0;</span>
<span class="nc bnc" id="L4701" title="All 2 branches missed.">                    if (game.getBoard().contains(newPos)) {</span>
<span class="nc" id="L4702">                        IHex newHex = game.getBoard().getHex(newPos);</span>
<span class="nc" id="L4703">                        Building bldg = game.getBoard().getBuildingAt(newPos);</span>
<span class="nc bnc" id="L4704" title="All 2 branches missed.">                        boolean danger = newHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4705" title="All 4 branches missed.">                                         || newHex.containsTerrain(Terrains.MAGMA)</span>
                                         || (null != bldg);
<span class="nc bnc" id="L4707" title="All 2 branches missed.">                        for (Entity unit : game.getEntitiesVector(newPos)) {</span>
<span class="nc bnc" id="L4708" title="All 2 branches missed.">                            if ((unit.getAltitude() == altitude)</span>
<span class="nc bnc" id="L4709" title="All 2 branches missed.">                                &amp;&amp; !unit.isAero()) {</span>
<span class="nc" id="L4710">                                count++;</span>
                            }
<span class="nc" id="L4712">                        }</span>
<span class="nc bnc" id="L4713" title="All 6 branches missed.">                        if ((count &lt;= max) &amp;&amp; (!danger || !checkDanger)) {</span>
<span class="nc" id="L4714">                            selected = true;</span>
<span class="nc" id="L4715">                            curPos = newPos;</span>
<span class="nc" id="L4716">                            break;</span>
                        }
<span class="nc bnc" id="L4718" title="All 2 branches missed.">                        if (!danger) {</span>
<span class="nc" id="L4719">                            allDanger = false;</span>
                        }
                    }
<span class="nc" id="L4722">                    newPos = newPos.translated((dir + 2) % 6);</span>
<span class="nc" id="L4723">                    count = 0;</span>
<span class="nc bnc" id="L4724" title="All 2 branches missed.">                    if (game.getBoard().contains(newPos)) {</span>
<span class="nc" id="L4725">                        IHex newHex = game.getBoard().getHex(newPos);</span>
<span class="nc" id="L4726">                        Building bldg = game.getBoard().getBuildingAt(newPos);</span>
<span class="nc bnc" id="L4727" title="All 2 branches missed.">                        boolean danger = newHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4728" title="All 4 branches missed.">                                         || newHex.containsTerrain(Terrains.MAGMA)</span>
                                         || (null != bldg);
<span class="nc bnc" id="L4730" title="All 2 branches missed.">                        for (Entity unit : game.getEntitiesVector(newPos)) {</span>
<span class="nc bnc" id="L4731" title="All 4 branches missed.">                            if ((unit.getAltitude() == altitude) &amp;&amp; !unit.isAero()) {</span>
<span class="nc" id="L4732">                                count++;</span>
                            }
<span class="nc" id="L4734">                        }</span>
<span class="nc bnc" id="L4735" title="All 6 branches missed.">                        if ((count &lt;= max) &amp;&amp; (!danger || !checkDanger)) {</span>
<span class="nc" id="L4736">                            selected = true;</span>
<span class="nc" id="L4737">                            curPos = newPos;</span>
<span class="nc" id="L4738">                            break;</span>
                        }
<span class="nc bnc" id="L4740" title="All 2 branches missed.">                        if (!danger) {</span>
<span class="nc" id="L4741">                            allDanger = false;</span>
                        }
                    }
                }
<span class="nc bnc" id="L4745" title="All 4 branches missed.">                if (allDanger &amp;&amp; checkDanger) {</span>
<span class="nc" id="L4746">                    checkDanger = false;</span>
                } else {
<span class="nc" id="L4748">                    max++;</span>
                }
<span class="nc" id="L4750">            }</span>
        }

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4754">        drop.setPosition(curPos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4757" title="All 2 branches missed.">        if (curPos != null) {</span>
<span class="nc" id="L4758">            drop.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4762">        drop.setFacing(entity.getFacing());</span>
<span class="nc" id="L4763">        drop.setSecondaryFacing(entity.getFacing());</span>

<span class="nc" id="L4765">        drop.setAltitude(altitude);</span>
<span class="nc" id="L4766">        entityUpdate(drop.getId());</span>
<span class="nc" id="L4767">    }</span>

    /**
     * Record that the given building has been affected by the current entity's
     * movement. At the end of the entity's movement, notify the clients about
     * the updates.
     *
     * @param bldg     - the &lt;code&gt;Building&lt;/code&gt; that has been affected.
     * @param collapse - a &lt;code&gt;boolean&lt;/code&gt; value that specifies that the
     *                 building collapsed (when &lt;code&gt;true&lt;/code&gt;).
     */
    private void addAffectedBldg(Building bldg, boolean collapse) {
        // If the building collapsed, then the clients have already
        // been notified, so remove it from the notification list.
<span class="nc bnc" id="L4781" title="All 2 branches missed.">        if (collapse) {</span>
<span class="nc" id="L4782">            affectedBldgs.remove(bldg);</span>
        } else { // Otherwise, make sure that this building is tracked.
<span class="nc" id="L4784">            affectedBldgs.put(bldg, Boolean.FALSE);</span>
        }
<span class="nc" id="L4786">    }</span>

    /**
     * Walk through the building hexes that were affected by the recent entity's
     * movement. Notify the clients about the updates to all affected entities
     * and non-collapsed buildings. The affected hexes is then cleared for the
     * next entity's movement.
     */
    private void applyAffectedBldgs() {
        // Build a list of Building updates.
<span class="nc" id="L4796">        Vector&lt;Building&gt; bldgUpdates = new Vector&lt;&gt;();</span>

        // Only send a single turn update.
<span class="nc" id="L4799">        boolean bTurnsChanged = false;</span>

        // Walk the set of buildings.
<span class="nc" id="L4802">        Enumeration&lt;Building&gt; bldgs = affectedBldgs.keys();</span>
<span class="nc bnc" id="L4803" title="All 2 branches missed.">        while (bldgs.hasMoreElements()) {</span>
<span class="nc" id="L4804">            final Building bldg = bldgs.nextElement();</span>

            // Walk through the building's coordinates.
<span class="nc" id="L4807">            Enumeration&lt;Coords&gt; bldgCoords = bldg.getCoords();</span>
<span class="nc bnc" id="L4808" title="All 2 branches missed.">            while (bldgCoords.hasMoreElements()) {</span>
<span class="nc" id="L4809">                final Coords coords = bldgCoords.nextElement();</span>
                // Walk through the entities at these coordinates.
<span class="nc bnc" id="L4811" title="All 2 branches missed.">                for (Entity entity : game.getEntitiesVector(coords)) {</span>
                    // Is the entity infantry?
<span class="nc bnc" id="L4813" title="All 2 branches missed.">                    if (entity instanceof Infantry) {</span>
                        // Is the infantry dead?
<span class="nc bnc" id="L4815" title="All 4 branches missed.">                        if (entity.isDoomed() || entity.isDestroyed()) {</span>
                            // Has the entity taken a turn?
<span class="nc bnc" id="L4817" title="All 2 branches missed.">                            if (!entity.isDone()) {</span>
                                // Dead entities don't take turns.
<span class="nc" id="L4819">                                game.removeTurnFor(entity);</span>
<span class="nc" id="L4820">                                bTurnsChanged = true;</span>
                            } // End entity-still-to-move

                            // Clean out the dead entity.
<span class="nc" id="L4824">                            entity.setDestroyed(true);</span>
<span class="nc" id="L4825">                            game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L4826">                            send(createRemoveEntityPacket(entity.getId()));</span>
                        } else { // Infantry that aren't dead are damaged.
<span class="nc" id="L4828">                            entityUpdate(entity.getId());</span>
                        }
                    } // End entity-is-infantry
<span class="nc" id="L4831">                } // Check the next entity.</span>
<span class="nc" id="L4832">            } // Handle the next hex in this building.</span>
            // Add this building to the report.
<span class="nc" id="L4834">            bldgUpdates.addElement(bldg);</span>
<span class="nc" id="L4835">        } // Handle the next affected building.</span>

        // Did we update the turns?
<span class="nc bnc" id="L4838" title="All 2 branches missed.">        if (bTurnsChanged) {</span>
<span class="nc" id="L4839">            send(createTurnVectorPacket());</span>
        }

        // Are there any building updates?
<span class="nc bnc" id="L4843" title="All 2 branches missed.">        if (!bldgUpdates.isEmpty()) {</span>
            // Send the building updates to the clients.
<span class="nc" id="L4845">            sendChangedBuildings(bldgUpdates);</span>

            // Clear the list of affected buildings.
<span class="nc" id="L4848">            affectedBldgs.clear();</span>
        }

        // And we're done.
<span class="nc" id="L4852">    } // End private void applyAffectedBldgs()</span>

    /**
     * Receives an entity movement packet, and if valid, executes it and ends
     * the current turn.
     */
    private void receiveMovement(Packet packet, int connId) {
<span class="nc" id="L4859">        Map&lt;EntityTargetPair, LosEffects&gt; losCache = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4860">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L4861">        MovePath md = (MovePath) packet.getObject(1);</span>
<span class="nc" id="L4862">        md.setGame(getGame());</span>
<span class="nc" id="L4863">        md.setEntity(entity);</span>

        // is this the right phase?
<span class="nc bnc" id="L4866" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L4867">            MegaMek.getLogger().error(&quot;Server got movement packet in wrong phase&quot;);</span>
<span class="nc" id="L4868">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L4872">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L4873" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L4874">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L4876" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)) {</span>
<span class="nc" id="L4877">            String msg = &quot;error: server got invalid movement packet from &quot; + &quot;connection &quot; + connId;</span>
<span class="nc bnc" id="L4878" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L4879">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L4881">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L4883">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L4884">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L4888">        processMovement(entity, md, losCache);</span>

        // The attacker may choose to break a chain whip grapple by expending MP
<span class="nc bnc" id="L4891" title="All 2 branches missed.">        if ((entity.getGrappled() != Entity.NONE)</span>
<span class="nc bnc" id="L4892" title="All 4 branches missed.">                &amp;&amp; entity.isChainWhipGrappled() &amp;&amp; entity.isGrappleAttacker()</span>
<span class="nc bnc" id="L4893" title="All 2 branches missed.">                &amp;&amp; (md.getMpUsed() &gt; 0)) {</span>

<span class="nc" id="L4895">            Entity te = game.getEntity(entity.getGrappled());</span>
<span class="nc" id="L4896">            Report r = new Report(4316);</span>
<span class="nc" id="L4897">            r.subject = entity.getId();</span>
<span class="nc" id="L4898">            r.addDesc(entity);</span>
<span class="nc" id="L4899">            r.addDesc(te);</span>
<span class="nc" id="L4900">            addReport(r);</span>

<span class="nc" id="L4902">            entity.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L4903">            te.setGrappled(Entity.NONE, false);</span>

<span class="nc" id="L4905">            entityUpdate(entity.getId());</span>
<span class="nc" id="L4906">            entityUpdate(te.getId());</span>
        }

        // check the LOS of any telemissiles owned by this entity
<span class="nc bnc" id="L4910" title="All 2 branches missed.">        for (int missileId : entity.getTMTracker().getMissiles()) {</span>
<span class="nc" id="L4911">            Entity tm = game.getEntity(missileId);</span>
<span class="nc bnc" id="L4912" title="All 6 branches missed.">            if ((null != tm) &amp;&amp; !tm.isDestroyed()</span>
                &amp;&amp; (tm instanceof TeleMissile)) {
<span class="nc bnc" id="L4914" title="All 2 branches missed.">                if (LosEffects.calculateLos(game, entity.getId(), tm).canSee()) {</span>
<span class="nc" id="L4915">                    ((TeleMissile) tm).setOutContact(false);</span>
                } else {
<span class="nc" id="L4917">                    ((TeleMissile) tm).setOutContact(true);</span>
                }
<span class="nc" id="L4919">                entityUpdate(tm.getId());</span>
            }
<span class="nc" id="L4921">        }</span>

        // Notify the clients about any building updates.
<span class="nc" id="L4924">        applyAffectedBldgs();</span>

        // Unit movement may detect hidden units
<span class="nc" id="L4927">        detectHiddenUnits();</span>

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L4930" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L4931">            updateVisibilityIndicator(losCache);</span>
        }

        // This entity's turn is over.
        // N.B. if the entity fell, a *new* turn has already been added.
<span class="nc" id="L4936">        endCurrentTurn(entity);</span>
<span class="nc" id="L4937">    }</span>

    /**
     * makes a unit skid or sideslip on the board
     *
     * @param entity    the unit which should skid
     * @param start     the coordinates of the hex the unit was in prior to skidding
     * @param elevation the elevation of the unit
     * @param direction the direction of the skid
     * @param distance  the number of hexes skidded
     * @param step      the MoveStep which caused the skid
     * @return true if the entity was removed from play
     */
    private boolean processSkid(Entity entity, Coords start, int elevation,
            int direction, int distance, MoveStep step,
            EntityMovementType moveType) {
<span class="nc" id="L4953">        return processSkid(entity, start, elevation, direction, distance, step, moveType, false);</span>
    }

    /**
     * makes a unit skid or sideslip on the board
     *
     * @param entity    the unit which should skid
     * @param start     the coordinates of the hex the unit was in prior to skidding
     * @param elevation the elevation of the unit
     * @param direction the direction of the skid
     * @param distance  the number of hexes skidded
     * @param step      the MoveStep which caused the skid
     * @param flip      whether the skid resulted from a failure maneuver result of major skid
     * @return true if the entity was removed from play
     */
    private boolean processSkid(Entity entity, Coords start, int elevation,
            int direction, int distance, MoveStep step,
            EntityMovementType moveType, boolean flip) {
<span class="nc" id="L4971">        Coords nextPos = start;</span>
<span class="nc" id="L4972">        Coords curPos = nextPos;</span>
<span class="nc" id="L4973">        IHex curHex = game.getBoard().getHex(start);</span>
        Report r;
<span class="nc" id="L4975">        int skidDistance = 0; // actual distance moved</span>
        // Flipping vehicles take tonnage/10 points of damage for every hex they enter.
<span class="nc" id="L4977">        int flipDamage = (int) Math.ceil(entity.getWeight() / 10.0);</span>
<span class="nc bnc" id="L4978" title="All 4 branches missed.">        while (!entity.isDoomed() &amp;&amp; (distance &gt; 0)) {</span>
<span class="nc" id="L4979">            nextPos = curPos.translated(direction);</span>
            // Is the next hex off the board?
<span class="nc bnc" id="L4981" title="All 2 branches missed.">            if (!game.getBoard().contains(nextPos)) {</span>

                // Can the entity skid off the map?
<span class="nc bnc" id="L4984" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PUSH_OFF_BOARD)) {</span>
                    // Yup. One dead entity.
<span class="nc" id="L4986">                    game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L4987">                    send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
<span class="nc" id="L4988">                    r = new Report(2030, Report.PUBLIC);</span>
<span class="nc" id="L4989">                    r.addDesc(entity);</span>
<span class="nc" id="L4990">                    addReport(r);</span>

<span class="nc bnc" id="L4992" title="All 2 branches missed.">                    for (Entity e : entity.getLoadedUnits()) {</span>
<span class="nc" id="L4993">                        game.removeEntity(e.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L4994">                        send(createRemoveEntityPacket(e.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
<span class="nc" id="L4995">                    }</span>
<span class="nc" id="L4996">                    Entity swarmer = game.getEntity(entity.getSwarmAttackerId());</span>
<span class="nc bnc" id="L4997" title="All 2 branches missed.">                    if (swarmer != null) {</span>
<span class="nc bnc" id="L4998" title="All 2 branches missed.">                        if (!swarmer.isDone()) {</span>
<span class="nc" id="L4999">                            game.removeTurnFor(swarmer);</span>
<span class="nc" id="L5000">                            swarmer.setDone(true);</span>
<span class="nc" id="L5001">                            send(createTurnVectorPacket());</span>
                        }
<span class="nc" id="L5003">                        game.removeEntity(swarmer.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L5004">                        send(createRemoveEntityPacket(swarmer.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
                    }
                    // The entity's movement is completed.
<span class="nc" id="L5007">                    return true;</span>

                }
                // Nope. Update the report.
<span class="nc" id="L5011">                r = new Report(2035);</span>
<span class="nc" id="L5012">                r.subject = entity.getId();</span>
<span class="nc" id="L5013">                r.indent();</span>
<span class="nc" id="L5014">                addReport(r);</span>
                // Stay in the current hex and stop skidding.
<span class="nc" id="L5016">                break;</span>
            }

<span class="nc" id="L5019">            IHex nextHex = game.getBoard().getHex(nextPos);</span>
<span class="nc" id="L5020">            distance -= nextHex.movementCost(entity) + 1;</span>
            // By default, the unit is going to fall to the floor of the next
            // hex
<span class="nc" id="L5023">            int curAltitude = elevation + curHex.getLevel();</span>
<span class="nc" id="L5024">            int nextAltitude = nextHex.floor();</span>

            // but VTOL keep altitude
<span class="nc bnc" id="L5027" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L5028">                nextAltitude = Math.max(nextAltitude, curAltitude);</span>
            } else {
                // Is there a building to &quot;catch&quot; the unit?
<span class="nc bnc" id="L5031" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
                    // unit will land on the roof, if at a higher level,
                    // otherwise it will skid through the wall onto the same
                    // floor.
                    // don't change this if the building starts at an elevation
                    // higher than the unit
                    // (e.g. the building is on a hill). Otherwise, we skid into
                    // solid earth.
<span class="nc bnc" id="L5039" title="All 2 branches missed.">                    if (curAltitude &gt;= nextHex.floor()) {</span>
<span class="nc" id="L5040">                        nextAltitude = Math.min(curAltitude,</span>
<span class="nc" id="L5041">                                nextHex.getLevel() + nextHex.terrainLevel(Terrains.BLDG_ELEV));</span>
                    }
                }
                // Is there a bridge to &quot;catch&quot; the unit?
<span class="nc bnc" id="L5045" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BRIDGE)) {</span>
                    // unit will land on the bridge, if at a higher level,
                    // and the bridge exits towards the current hex,
                    // otherwise the bridge has no effect
<span class="nc" id="L5049">                    int exitDir = (direction + 3) % 6;</span>
<span class="nc" id="L5050">                    exitDir = 1 &lt;&lt; exitDir;</span>
<span class="nc bnc" id="L5051" title="All 2 branches missed.">                    if ((nextHex.getTerrain(Terrains.BRIDGE).getExits() &amp; exitDir) == exitDir) {</span>
<span class="nc" id="L5052">                        nextAltitude = Math.min(curAltitude,</span>
<span class="nc" id="L5053">                                     Math.max(nextAltitude,</span>
<span class="nc" id="L5054">                                             nextHex.getLevel() + nextHex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
                    }
                }
<span class="nc bnc" id="L5057" title="All 2 branches missed.">                if ((nextAltitude &lt;= nextHex.surface())</span>
<span class="nc bnc" id="L5058" title="All 2 branches missed.">                    &amp;&amp; (curAltitude &gt;= curHex.surface())) {</span>
                    // Hovercraft and WiGEs can &quot;skid&quot; over water.
                    // all units can skid over ice.
<span class="nc bnc" id="L5061" title="All 2 branches missed.">                    if ((entity.getMovementMode().equals(EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5062" title="All 2 branches missed.">                                || entity.getMovementMode().equals(EntityMovementMode.WIGE))</span>
<span class="nc bnc" id="L5063" title="All 2 branches missed.">                            &amp;&amp; nextHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L5064">                        nextAltitude = nextHex.surface();</span>
                    } else {
<span class="nc bnc" id="L5066" title="All 2 branches missed.">                        if (nextHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L5067">                            nextAltitude = nextHex.surface();</span>
                        }
                    }
                }
<span class="nc bnc" id="L5071" title="All 6 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WIGE</span>
                        &amp;&amp; elevation &gt; 0 &amp;&amp; nextAltitude &lt; curAltitude) {
                    // Airborne WiGEs drop to one level above the surface
<span class="nc bnc" id="L5074" title="All 2 branches missed.">                    if (entity.climbMode()) {</span>
<span class="nc" id="L5075">                        nextAltitude = curAltitude;</span>
                    } else {
<span class="nc" id="L5077">                        nextAltitude++;</span>
                    }
                }
            }

            // The elevation the skidding unit will occupy in next hex
<span class="nc" id="L5083">            int nextElevation = nextAltitude - nextHex.surface();</span>

<span class="nc bnc" id="L5085" title="All 2 branches missed.">            boolean crashedIntoTerrain = curAltitude &lt; nextAltitude;</span>
<span class="nc bnc" id="L5086" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L5087" title="All 2 branches missed.">                &amp;&amp; (nextHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L5088" title="All 2 branches missed.">                        || nextHex.containsTerrain(Terrains.JUNGLE)) </span>
<span class="nc bnc" id="L5089" title="All 2 branches missed.">                &amp;&amp; nextElevation &lt;= nextHex.terrainLevel(Terrains.FOLIAGE_ELEV)) {</span>
<span class="nc" id="L5090">                    crashedIntoTerrain = true;</span>
                
            }

<span class="nc bnc" id="L5094" title="All 2 branches missed.">            if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5095">                Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

<span class="nc bnc" id="L5097" title="All 2 branches missed.">                if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5098">                    crashedIntoTerrain = true;</span>
                }

<span class="nc bnc" id="L5101" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5102">                    crashedIntoTerrain = true;</span>
                }
            }

            // however WiGE can gain 1 level to avoid crashing into the terrain.
<span class="nc bnc" id="L5107" title="All 4 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; (elevation &gt; 0)) {</span>
<span class="nc bnc" id="L5108" title="All 2 branches missed.">                if (curAltitude == nextHex.floor()) {</span>
<span class="nc" id="L5109">                    nextElevation = 1;</span>
<span class="nc" id="L5110">                    crashedIntoTerrain = false;</span>
<span class="nc bnc" id="L5111" title="All 4 branches missed.">                } else if ((entity instanceof LandAirMech) &amp;&amp; (curAltitude + 1 == nextHex.floor())) {</span>
                    // LAMs in AirMech mode skid across terrain that is two levels higher rather than crashing,
                    // Reset the skid distance for skid damage calculations.
<span class="nc" id="L5114">                    nextElevation = 0;</span>
<span class="nc" id="L5115">                    skidDistance = 0;</span>
<span class="nc" id="L5116">                    crashedIntoTerrain = false;</span>
<span class="nc" id="L5117">                    r = new Report(2102);</span>
<span class="nc" id="L5118">                    r.subject = entity.getId();</span>
<span class="nc" id="L5119">                    r.indent();</span>
<span class="nc" id="L5120">                    addReport(r);</span>
                }
            }

<span class="nc" id="L5124">            Entity crashDropShip = null;</span>
<span class="nc bnc" id="L5125" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector(nextPos)) {</span>
<span class="nc bnc" id="L5126" title="All 4 branches missed.">                if ((en instanceof Dropship) &amp;&amp; !en.isAirborne()</span>
<span class="nc bnc" id="L5127" title="All 2 branches missed.">                    &amp;&amp; (nextAltitude &lt;= (en.relHeight()))) {</span>
<span class="nc" id="L5128">                    crashDropShip = en;</span>
                }
<span class="nc" id="L5130">            }</span>

<span class="nc bnc" id="L5132" title="All 2 branches missed.">            if (crashedIntoTerrain) {</span>
<span class="nc bnc" id="L5133" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5134">                    Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

                    // If you crash into a wall you want to stop in the hex
                    // before the wall not in the wall
                    // Like a building.
<span class="nc bnc" id="L5139" title="All 2 branches missed.">                    if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5140">                        r = new Report(2047);</span>
<span class="nc bnc" id="L5141" title="All 2 branches missed.">                    } else if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5142">                        r = new Report(2049);</span>
                    } else {
<span class="nc" id="L5144">                        r = new Report(2045);</span>
                    }

<span class="nc" id="L5147">                } else {</span>
<span class="nc" id="L5148">                    r = new Report(2045);</span>
                }

<span class="nc" id="L5151">                r.subject = entity.getId();</span>
<span class="nc" id="L5152">                r.indent();</span>
<span class="nc" id="L5153">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5154">                addReport(r);</span>

<span class="nc bnc" id="L5156" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L5157" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L5158">                    int hitSide = (step.getFacing() - direction) + 6;</span>
<span class="nc" id="L5159">                    hitSide %= 6;</span>
<span class="nc" id="L5160">                    int table = 0;</span>
<span class="nc bnc" id="L5161" title="All 5 branches missed.">                    switch (hitSide) {// quite hackish...I think it ought to</span>
                        // work, though.
                        case 0:// can this happen?
<span class="nc" id="L5164">                            table = ToHitData.SIDE_FRONT;</span>
<span class="nc" id="L5165">                            break;</span>
                        case 1:
                        case 2:
<span class="nc" id="L5168">                            table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L5169">                            break;</span>
                        case 3:
<span class="nc" id="L5171">                            table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L5172">                            break;</span>
                        case 4:
                        case 5:
<span class="nc" id="L5175">                            table = ToHitData.SIDE_RIGHT;</span>
                            break;
                    }
<span class="nc" id="L5178">                    elevation = nextElevation;</span>
<span class="nc bnc" id="L5179" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc" id="L5180">                        addReport(crashVTOLorWiGE((Tank) entity, false, true,</span>
                                distance, curPos, elevation, table));
                    }

<span class="nc bnc" id="L5184" title="All 2 branches missed.">                    if ((nextHex.containsTerrain(Terrains.WATER) &amp;&amp; !nextHex</span>
<span class="nc bnc" id="L5185" title="All 2 branches missed.">                            .containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L5186" title="All 2 branches missed.">                            || nextHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L5187" title="All 2 branches missed.">                            || nextHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L5188">                        addReport(destroyEntity(entity, &quot;could not land in crash site&quot;));</span>
<span class="nc bnc" id="L5189" title="All 2 branches missed.">                    } else if (elevation &lt; nextHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5190">                        Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

                        // If you crash into a wall you want to stop in the hex
                        // before the wall not in the wall
                        // Like a building.
<span class="nc bnc" id="L5195" title="All 2 branches missed.">                        if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5196">                            addReport(destroyEntity(entity, &quot;crashed into a wall&quot;));</span>
<span class="nc" id="L5197">                            break;</span>
                        }
<span class="nc bnc" id="L5199" title="All 2 branches missed.">                        if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5200">                            addReport(destroyEntity(entity, &quot;crashed into a gun emplacement&quot;));</span>
<span class="nc" id="L5201">                            break;</span>
                        }

<span class="nc" id="L5204">                        addReport(destroyEntity(entity, &quot;crashed into building&quot;));</span>
<span class="nc" id="L5205">                    } else {</span>
<span class="nc" id="L5206">                        entity.setPosition(nextPos);</span>
<span class="nc" id="L5207">                        entity.setElevation(0);</span>
<span class="nc" id="L5208">                        addReport(doEntityDisplacementMinefieldCheck(entity,</span>
                                curPos, nextPos, nextElevation));
                    }
<span class="nc" id="L5211">                    break;</span>

                }
                // skidding into higher terrain does weight/20
                // damage in 5pt clusters to front.
<span class="nc" id="L5216">                int damage = ((int) entity.getWeight() + 19) / 20;</span>
<span class="nc bnc" id="L5217" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L5218">                    int table = ToHitData.HIT_NORMAL;</span>
<span class="nc" id="L5219">                    int side = entity.sideTable(nextPos);</span>
<span class="nc bnc" id="L5220" title="All 2 branches missed.">                    if (entity instanceof Protomech) {</span>
<span class="nc" id="L5221">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
                    }
<span class="nc" id="L5223">                    HitData hitData = entity.rollHitLocation(table, side);</span>
<span class="nc" id="L5224">                    hitData.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5225">                    addReport(damageEntity(entity, hitData, Math.min(5, damage)));</span>
<span class="nc" id="L5226">                    damage -= 5;</span>
<span class="nc" id="L5227">                }</span>
                // Stay in the current hex and stop skidding.
                break;
            }

            // did we hit a DropShip. Oww!
            // Taharqa: The rules on how to handle this are completely missing, so I am assuming
            // we assign damage as per an accidental charge, but do not displace
            // the DropShip and end the skid
<span class="nc bnc" id="L5236" title="All 2 branches missed.">            else if (null != crashDropShip) {</span>
<span class="nc" id="L5237">                r = new Report(2050);</span>
<span class="nc" id="L5238">                r.subject = entity.getId();</span>
<span class="nc" id="L5239">                r.indent();</span>
<span class="nc" id="L5240">                r.add(crashDropShip.getShortName(), true);</span>
<span class="nc" id="L5241">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5242">                addReport(r);</span>
<span class="nc" id="L5243">                ChargeAttackAction caa = new ChargeAttackAction(entity.getId(),</span>
<span class="nc" id="L5244">                        crashDropShip.getTargetType(),</span>
<span class="nc" id="L5245">                        crashDropShip.getTargetId(),</span>
<span class="nc" id="L5246">                        crashDropShip.getPosition());</span>
<span class="nc" id="L5247">                ToHitData toHit = caa.toHit(game, true);</span>
<span class="nc" id="L5248">                resolveChargeDamage(entity, crashDropShip, toHit, direction);</span>
<span class="nc bnc" id="L5249" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L5250" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L5251">                    int hitSide = (step.getFacing() - direction) + 6;</span>
<span class="nc" id="L5252">                    hitSide %= 6;</span>
<span class="nc" id="L5253">                    int table = 0;</span>
<span class="nc bnc" id="L5254" title="All 5 branches missed.">                    switch (hitSide) {// quite hackish...I think it ought to work, though.</span>
                        case 0:// can this happen?
<span class="nc" id="L5256">                            table = ToHitData.SIDE_FRONT;</span>
<span class="nc" id="L5257">                            break;</span>
                        case 1:
                        case 2:
<span class="nc" id="L5260">                            table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L5261">                            break;</span>
                        case 3:
<span class="nc" id="L5263">                            table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L5264">                            break;</span>
                        case 4:
                        case 5:
<span class="nc" id="L5267">                            table = ToHitData.SIDE_RIGHT;</span>
                            break;
                    }
<span class="nc" id="L5270">                    elevation = nextElevation;</span>
<span class="nc" id="L5271">                    addReport(crashVTOLorWiGE((VTOL) entity, false, true,</span>
                            distance, curPos, elevation, table));
<span class="nc" id="L5273">                    break;</span>
                }
<span class="nc bnc" id="L5275" title="All 4 branches missed.">                if (!crashDropShip.isDoomed() &amp;&amp; !crashDropShip.isDestroyed()</span>
<span class="nc bnc" id="L5276" title="All 2 branches missed.">                        &amp;&amp; !game.isOutOfGame(crashDropShip)) {</span>
<span class="nc" id="L5277">                    break;</span>
                }
<span class="nc" id="L5279">            }</span>

            // Have skidding units suffer falls (off a cliff).
<span class="nc bnc" id="L5282" title="All 2 branches missed.">            else if ( (curAltitude &gt; (nextAltitude + entity.getMaxElevationChange())</span>
<span class="nc bnc" id="L5283" title="All 4 branches missed.">                    || (curHex.hasCliffTopTowards(nextHex) &amp;&amp; curAltitude &gt; nextAltitude) )</span>
<span class="nc bnc" id="L5284" title="All 4 branches missed.">                    &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; elevation &gt; curHex.ceiling())) {</span>
<span class="nc" id="L5285">                addReport(doEntityFallsInto(entity, entity.getElevation(), curPos, nextPos,</span>
<span class="nc" id="L5286">                        entity.getBasePilotingRoll(moveType), true));</span>
<span class="nc" id="L5287">                addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
                // Stay in the current hex and stop skidding.
<span class="nc" id="L5289">                break;</span>
            }

            // Get any building in the hex.
<span class="nc" id="L5293">            Building bldg = null;</span>
<span class="nc bnc" id="L5294" title="All 2 branches missed.">            if (nextElevation &lt; nextHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
                // We will only run into the building if its at a higher level,
                // otherwise we skid over the roof
<span class="nc" id="L5297">                bldg = game.getBoard().getBuildingAt(nextPos);</span>
            }
<span class="nc" id="L5299">            boolean bldgSuffered = false;</span>
<span class="nc" id="L5300">            boolean stopTheSkid = false;</span>
            // Does the next hex contain an entities?
            // ASSUMPTION: hurt EVERYONE in the hex.
<span class="nc" id="L5303">            Iterator&lt;Entity&gt; targets = game.getEntities(nextPos);</span>
<span class="nc bnc" id="L5304" title="All 2 branches missed.">            if (targets.hasNext()) {</span>
<span class="nc" id="L5305">                List&lt;Entity&gt; avoidedChargeUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L5306">                boolean skidChargeHit = false;</span>
<span class="nc bnc" id="L5307" title="All 2 branches missed.">                while (targets.hasNext()) {</span>
<span class="nc" id="L5308">                    Entity target = targets.next();</span>

<span class="nc bnc" id="L5310" title="All 2 branches missed.">                    if ((target.getElevation() &gt; (nextElevation + entity.getHeight()))</span>
<span class="nc bnc" id="L5311" title="All 2 branches missed.">                            || (target.relHeight() &lt; nextElevation)) {</span>
                        // target is not in the way
<span class="nc" id="L5313">                        continue;</span>
                    }

                    // Can the target avoid the skid?
<span class="nc bnc" id="L5317" title="All 2 branches missed.">                    if (!target.isDone()) {</span>
<span class="nc bnc" id="L5318" title="All 2 branches missed.">                        if (target instanceof Infantry) {</span>
<span class="nc" id="L5319">                            r = new Report(2420);</span>
<span class="nc" id="L5320">                            r.subject = target.getId();</span>
<span class="nc" id="L5321">                            r.addDesc(target);</span>
<span class="nc" id="L5322">                            addReport(r);</span>
<span class="nc" id="L5323">                            continue;</span>
<span class="nc bnc" id="L5324" title="All 2 branches missed.">                        } else if (target instanceof Protomech) {</span>
<span class="nc bnc" id="L5325" title="All 2 branches missed.">                            if (target != Compute.stackingViolation(game, entity, nextPos, null)) {</span>
<span class="nc" id="L5326">                                r = new Report(2420);</span>
<span class="nc" id="L5327">                                r.subject = target.getId();</span>
<span class="nc" id="L5328">                                r.addDesc(target);</span>
<span class="nc" id="L5329">                                addReport(r);</span>
<span class="nc" id="L5330">                                continue;</span>
                            }
                        } else {
<span class="nc" id="L5333">                            PilotingRollData psr = target.getBasePilotingRoll();</span>
<span class="nc" id="L5334">                            psr.addModifier(0, &quot;avoiding collision&quot;);</span>
<span class="nc bnc" id="L5335" title="All 2 branches missed.">                            if (psr.getValue() == TargetRoll.AUTOMATIC_FAIL</span>
<span class="nc bnc" id="L5336" title="All 2 branches missed.">                                    || psr.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L5337">                                r = new Report(2426);</span>
<span class="nc" id="L5338">                                r.subject = target.getId();</span>
<span class="nc" id="L5339">                                r.addDesc(target);</span>
<span class="nc" id="L5340">                                r.add(psr.getDesc());</span>
<span class="nc" id="L5341">                                addReport(r);</span>
                            } else {
<span class="nc" id="L5343">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L5344">                                r = new Report(2425);</span>
<span class="nc" id="L5345">                                r.subject = target.getId();</span>
<span class="nc" id="L5346">                                r.addDesc(target);</span>
<span class="nc" id="L5347">                                r.add(psr);</span>
<span class="nc" id="L5348">                                r.add(psr.getDesc());</span>
<span class="nc" id="L5349">                                r.add(roll);</span>
<span class="nc" id="L5350">                                addReport(r);</span>
<span class="nc bnc" id="L5351" title="All 2 branches missed.">                                if (roll &gt;= psr.getValue()) {</span>
<span class="nc" id="L5352">                                    game.removeTurnFor(target);</span>
<span class="nc" id="L5353">                                    avoidedChargeUnits.add(target);</span>
<span class="nc" id="L5354">                                    continue;</span>
                                    // TODO : the charge should really be suspended
                                    // and resumed after the target moved.
                                }
                            }
                        }
                    }

                    // Mechs and vehicles get charged,
                    // but need to make a to-hit roll
<span class="nc bnc" id="L5364" title="All 6 branches missed.">                    if ((target instanceof Mech) || (target instanceof Tank)</span>
                            || (target instanceof Aero)) {
<span class="nc" id="L5366">                        ChargeAttackAction caa = new ChargeAttackAction(</span>
<span class="nc" id="L5367">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L5368">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L5369">                        ToHitData toHit = caa.toHit(game, true);</span>

                        // roll
<span class="nc" id="L5372">                        int roll = Compute.d6(2);</span>
                        // Update report.
<span class="nc" id="L5374">                        r = new Report(2050);</span>
<span class="nc" id="L5375">                        r.subject = entity.getId();</span>
<span class="nc" id="L5376">                        r.indent();</span>
<span class="nc" id="L5377">                        r.add(target.getShortName(), true);</span>
<span class="nc" id="L5378">                        r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5379">                        r.newlines = 0;</span>
<span class="nc" id="L5380">                        addReport(r);</span>
<span class="nc bnc" id="L5381" title="All 2 branches missed.">                        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L5382">                            roll = -12;</span>
<span class="nc" id="L5383">                            r = new Report(2055);</span>
<span class="nc" id="L5384">                            r.subject = entity.getId();</span>
<span class="nc" id="L5385">                            r.add(toHit.getDesc());</span>
<span class="nc" id="L5386">                            r.newlines = 0;</span>
<span class="nc" id="L5387">                            addReport(r);</span>
<span class="nc bnc" id="L5388" title="All 2 branches missed.">                        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L5389">                            r = new Report(2060);</span>
<span class="nc" id="L5390">                            r.subject = entity.getId();</span>
<span class="nc" id="L5391">                            r.add(toHit.getDesc());</span>
<span class="nc" id="L5392">                            r.newlines = 0;</span>
<span class="nc" id="L5393">                            addReport(r);</span>
<span class="nc" id="L5394">                            roll = Integer.MAX_VALUE;</span>
                        } else {
                            // report the roll
<span class="nc" id="L5397">                            r = new Report(2065);</span>
<span class="nc" id="L5398">                            r.subject = entity.getId();</span>
<span class="nc" id="L5399">                            r.add(toHit);</span>
<span class="nc" id="L5400">                            r.add(roll);</span>
<span class="nc" id="L5401">                            r.newlines = 0;</span>
<span class="nc" id="L5402">                            addReport(r);</span>
                        }

                        // Resolve a charge against the target.
                        // ASSUMPTION: buildings block damage for
                        // *EACH* entity charged.
<span class="nc bnc" id="L5408" title="All 2 branches missed.">                        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L5409">                            r = new Report(2070);</span>
<span class="nc" id="L5410">                            r.subject = entity.getId();</span>
<span class="nc" id="L5411">                            addReport(r);</span>
                        } else {
                            // Resolve the charge.
<span class="nc" id="L5414">                            resolveChargeDamage(entity, target, toHit, direction);</span>
                            // HACK: set the entity's location
                            // to the original hex again, for the other targets
<span class="nc bnc" id="L5417" title="All 2 branches missed.">                            if (targets.hasNext()) {</span>
<span class="nc" id="L5418">                                entity.setPosition(curPos);</span>
                            }
<span class="nc" id="L5420">                            bldgSuffered = true;</span>
<span class="nc" id="L5421">                            skidChargeHit = true;</span>
                            // The skid ends here if the target lives.
<span class="nc bnc" id="L5423" title="All 4 branches missed.">                            if (!target.isDoomed() &amp;&amp; !target.isDestroyed()</span>
<span class="nc bnc" id="L5424" title="All 2 branches missed.">                                    &amp;&amp; !game.isOutOfGame(target)) {</span>
<span class="nc" id="L5425">                                stopTheSkid = true;</span>
                            }
                        }

                        // if we don't do this here,
                        // we can have a mech without a leg
                        // standing on the field and moving
                        // as if it still had his leg after
                        // getting skid-charged.
<span class="nc bnc" id="L5434" title="All 2 branches missed.">                        if (!target.isDone()) {</span>
<span class="nc" id="L5435">                            addReport(resolvePilotingRolls(target));</span>
<span class="nc" id="L5436">                            game.resetPSRs(target);</span>
<span class="nc" id="L5437">                            target.applyDamage();</span>
<span class="nc" id="L5438">                            addNewLines();</span>
                        }

<span class="nc" id="L5441">                    }</span>

                    // Resolve &quot;move-through&quot; damage on infantry.
                    // Infantry inside of a building don't get a
                    // move-through, but suffer &quot;bleed through&quot;
                    // from the building.
<span class="nc bnc" id="L5447" title="All 4 branches missed.">                    else if ((target instanceof Infantry) &amp;&amp; (bldg != null)) {</span>
                        // Update report.
<span class="nc" id="L5449">                        r = new Report(2075);</span>
<span class="nc" id="L5450">                        r.subject = entity.getId();</span>
<span class="nc" id="L5451">                        r.indent();</span>
<span class="nc" id="L5452">                        r.add(target.getShortName(), true);</span>
<span class="nc" id="L5453">                        r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5454">                        r.newlines = 0;</span>
<span class="nc" id="L5455">                        addReport(r);</span>

                        // Infantry don't have different
                        // tables for punches and kicks
<span class="nc" id="L5459">                        HitData hit = target.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L5460">                                Compute.targetSideTable(entity, target));</span>
<span class="nc" id="L5461">                        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
                        // Damage equals tonnage, divided by 5.
                        // ASSUMPTION: damage is applied in one hit.
<span class="nc" id="L5464">                        addReport(damageEntity(target, hit, (int) Math.round(entity.getWeight() / 5)));</span>
<span class="nc" id="L5465">                        addNewLines();</span>
                    }

                    // Has the target been destroyed?
<span class="nc bnc" id="L5469" title="All 2 branches missed.">                    if (target.isDoomed()) {</span>
                        // Has the target taken a turn?
<span class="nc bnc" id="L5471" title="All 2 branches missed.">                        if (!target.isDone()) {</span>
                            // Dead entities don't take turns.
<span class="nc" id="L5473">                            game.removeTurnFor(target);</span>
<span class="nc" id="L5474">                            send(createTurnVectorPacket());</span>
                        } // End target-still-to-move

                        // Clean out the entity.
<span class="nc" id="L5478">                        target.setDestroyed(true);</span>
<span class="nc" id="L5479">                        game.moveToGraveyard(target.getId());</span>
<span class="nc" id="L5480">                        send(createRemoveEntityPacket(target.getId()));</span>
                    }
                    // Update the target's position,
                    // unless it is off the game map.
<span class="nc bnc" id="L5484" title="All 2 branches missed.">                    if (!game.isOutOfGame(target)) {</span>
<span class="nc" id="L5485">                        entityUpdate(target.getId());</span>
                    }
<span class="nc" id="L5487">                } // Check the next entity in the hex.</span>

<span class="nc bnc" id="L5489" title="All 2 branches missed.">                if (skidChargeHit) {</span>
                    // HACK: set the entities position to that
                    // hex's coords, because we had to move the entity
                    // back earlier for the other targets
<span class="nc" id="L5493">                    entity.setPosition(nextPos);</span>
                }
<span class="nc bnc" id="L5495" title="All 2 branches missed.">                for (Entity e : avoidedChargeUnits) {</span>
<span class="nc" id="L5496">                    GameTurn newTurn = new GameTurn.SpecificEntityTurn(e.getOwner().getId(), e.getId());</span>
                    // Prevents adding extra turns for multi-turns
<span class="nc" id="L5498">                    newTurn.setMultiTurn(true);</span>
<span class="nc" id="L5499">                    game.insertNextTurn(newTurn);</span>
<span class="nc" id="L5500">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L5501">                }</span>
            }

            // Handle the building in the hex.
<span class="nc bnc" id="L5505" title="All 2 branches missed.">            if (bldg != null) {</span>
                // Report that the entity has entered the bldg.
<span class="nc" id="L5507">                r = new Report(2080);</span>
<span class="nc" id="L5508">                r.subject = entity.getId();</span>
<span class="nc" id="L5509">                r.indent();</span>
<span class="nc" id="L5510">                r.add(bldg.getName());</span>
<span class="nc" id="L5511">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5512">                addReport(r);</span>

                // If the building hasn't already suffered
                // damage, then apply charge damage to the
                // building and displace the entity inside.
                // ASSUMPTION: you don't charge the building
                // if Tanks or Mechs were charged.
<span class="nc" id="L5519">                int chargeDamage = ChargeAttackAction.getDamageFor(entity, game</span>
<span class="nc" id="L5520">                        .getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
                        entity.delta_distance);
<span class="nc bnc" id="L5522" title="All 2 branches missed.">                if (!bldgSuffered) {</span>
<span class="nc" id="L5523">                    Vector&lt;Report&gt; reports = damageBuilding(bldg, chargeDamage, nextPos);</span>
<span class="nc bnc" id="L5524" title="All 2 branches missed.">                    for (Report report : reports) {</span>
<span class="nc" id="L5525">                        report.subject = entity.getId();</span>
<span class="nc" id="L5526">                    }</span>
<span class="nc" id="L5527">                    addReport(reports);</span>

                    // Apply damage to the attacker.
<span class="nc" id="L5530">                    int toAttacker = ChargeAttackAction.getDamageTakenBy(entity, bldg, nextPos);</span>
<span class="nc" id="L5531">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(nextPos));</span>
<span class="nc" id="L5532">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5533">                    addReport(damageEntity(entity, hit, toAttacker));</span>
<span class="nc" id="L5534">                    addNewLines();</span>

<span class="nc" id="L5536">                    entity.setPosition(nextPos);</span>
<span class="nc" id="L5537">                    entity.setElevation(nextElevation);</span>
<span class="nc" id="L5538">                    addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
<span class="nc" id="L5539">                    curPos = nextPos;</span>
                } // End buildings-suffer-too

                // Any infantry in the building take damage
                // equal to the building being charged.
                // ASSUMPTION: infantry take no damage from the
                // building absorbing damage from
                // Tanks and Mechs being charged.
<span class="nc" id="L5547">                addReport(damageInfantryIn(bldg, chargeDamage, nextPos));</span>

                // If a building still stands, then end the skid,
                // and add it to the list of affected buildings.
<span class="nc bnc" id="L5551" title="All 2 branches missed.">                if (bldg.getCurrentCF(nextPos) &gt; 0) {</span>
<span class="nc" id="L5552">                    stopTheSkid = true;</span>
<span class="nc bnc" id="L5553" title="All 2 branches missed.">                    if (bldg.rollBasement(nextPos, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L5554">                        sendChangedHex(nextPos);</span>
<span class="nc" id="L5555">                        Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L5556">                        buildings.add(bldg);</span>
<span class="nc" id="L5557">                        sendChangedBuildings(buildings);</span>
                    }
<span class="nc" id="L5559">                    addAffectedBldg(bldg, checkBuildingCollapseWhileMoving(bldg, entity, nextPos));</span>
                } else {
                    // otherwise it collapses immediately on our head
<span class="nc" id="L5562">                    checkForCollapse(bldg, game.getPositionMap(), nextPos, true, vPhaseReport);</span>
                }
            } // End handle-building.

            // Do we stay in the current hex and stop skidding?
<span class="nc bnc" id="L5567" title="All 2 branches missed.">            if (stopTheSkid) {</span>
<span class="nc" id="L5568">                break;</span>
            }

            // Update entity position and elevation
<span class="nc" id="L5572">            entity.setPosition(nextPos);</span>
<span class="nc" id="L5573">            entity.setElevation(nextElevation);</span>
<span class="nc" id="L5574">            addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
<span class="nc" id="L5575">            skidDistance++;</span>

            // Check for collapse of any building the entity might be on
<span class="nc" id="L5578">            Building roof = game.getBoard().getBuildingAt(nextPos);</span>
<span class="nc bnc" id="L5579" title="All 2 branches missed.">            if (roof != null) {</span>
<span class="nc bnc" id="L5580" title="All 2 branches missed.">                if (checkForCollapse(roof, game.getPositionMap(), nextPos, true, vPhaseReport)) {</span>
<span class="nc" id="L5581">                    break; // stop skidding if the building collapsed</span>
                }
            }

            // Can the skidding entity enter the next hex from this?
            // N.B. can skid along roads.
<span class="nc bnc" id="L5587" title="All 4 branches missed.">            if ((entity.isLocationProhibited(start) || entity.isLocationProhibited(nextPos))</span>
<span class="nc bnc" id="L5588" title="All 2 branches missed.">                    &amp;&amp; !Compute.canMoveOnPavement(game, curPos, nextPos, step)) {</span>
                // Update report.
<span class="nc" id="L5590">                r = new Report(2040);</span>
<span class="nc" id="L5591">                r.subject = entity.getId();</span>
<span class="nc" id="L5592">                r.indent();</span>
<span class="nc" id="L5593">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5594">                addReport(r);</span>

                // If the prohibited terrain is water, entity is destroyed
<span class="nc bnc" id="L5597" title="All 4 branches missed.">                if ((nextHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
                        &amp;&amp; (entity instanceof Tank)
<span class="nc bnc" id="L5599" title="All 2 branches missed.">                        &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5600" title="All 2 branches missed.">                        &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L5601">                    addReport(destroyEntity(entity,</span>
                            &quot;skidded into a watery grave&quot;, false, true));
                }

                // otherwise, damage is weight/5 in 5pt clusters
<span class="nc" id="L5606">                int damage = ((int) entity.getWeight() + 4) / 5;</span>
<span class="nc bnc" id="L5607" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L5608">                    addReport(damageEntity(entity, entity.rollHitLocation(</span>
                            ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),
<span class="nc" id="L5610">                            Math.min(5, damage)));</span>
<span class="nc" id="L5611">                    damage -= 5;</span>
                }
                // and unit is immobile
<span class="nc bnc" id="L5614" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L5615">                    ((Tank) entity).immobilize();</span>
                }

                // Stay in the current hex and stop skidding.
                break;
            }

<span class="nc bnc" id="L5622" title="All 2 branches missed.">            if ((nextHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L5623" title="All 2 branches missed.">                    &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5624" title="All 2 branches missed.">                    &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)) {</span>
                // water ends the skid
<span class="nc" id="L5626">                break;</span>
            }

            // check for breaking magma crust
            // note that this must sequentially occur before the next 'entering liquid magma' check
            // otherwise, magma crust won't have a chance to break
<span class="nc" id="L5632">            ServerHelper.checkAndApplyMagmaCrust(nextHex, nextElevation, entity, curPos, false, vPhaseReport, this);</span>

            // is the next hex a swamp?
<span class="nc" id="L5635">            PilotingRollData rollTarget = entity.checkBogDown(step, moveType, nextHex, curPos, nextPos,</span>
<span class="nc" id="L5636">                    step.getElevation(), Compute.canMoveOnPavement(game, curPos, nextPos, step));</span>

<span class="nc bnc" id="L5638" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Taharqa: According to TacOps, you automatically stick if you
                // are skidding, (pg. 63)
                // if (0 &lt; doSkillCheckWhileMoving(entity, curPos, nextPos,
                // rollTarget, false)) {
<span class="nc" id="L5643">                entity.setStuck(true);</span>
<span class="nc" id="L5644">                r = new Report(2081);</span>
<span class="nc" id="L5645">                r.subject = entity.getId();</span>
<span class="nc" id="L5646">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L5647">                addReport(r);</span>
                // check for quicksand
<span class="nc" id="L5649">                addReport(checkQuickSand(nextPos));</span>
                // check for accidental stacking violation
<span class="nc" id="L5651">                Entity violation = Compute.stackingViolation(game, entity.getId(), curPos);</span>
<span class="nc bnc" id="L5652" title="All 2 branches missed.">                if (violation != null) {</span>
                    // target gets displaced, because of low elevation
<span class="nc" id="L5654">                    Coords targetDest = Compute.getValidDisplacement(game, entity.getId(), curPos,</span>
                            direction);
<span class="nc" id="L5656">                    addReport(doEntityDisplacement(violation, curPos, targetDest,</span>
<span class="nc" id="L5657">                            new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;)));</span>
                    // Update the violating entity's position on the client.
<span class="nc" id="L5659">                    entityUpdate(violation.getId());</span>
<span class="nc" id="L5660">                }</span>
                // stay here and stop skidding, see bug 1115608
                break;
            }

            // Update the position and keep skidding.
<span class="nc" id="L5666">            curPos = nextPos;</span>
<span class="nc" id="L5667">            curHex = nextHex;</span>
<span class="nc" id="L5668">            elevation = nextElevation;</span>
<span class="nc" id="L5669">            r = new Report(2085);</span>
<span class="nc" id="L5670">            r.subject = entity.getId();</span>
<span class="nc" id="L5671">            r.indent();</span>
<span class="nc" id="L5672">            r.add(curPos.getBoardNum(), true);</span>
<span class="nc" id="L5673">            addReport(r);</span>

<span class="nc bnc" id="L5675" title="All 4 branches missed.">            if (flip &amp;&amp; entity instanceof Tank) {</span>
<span class="nc bnc" id="L5676" title="All 2 branches missed.">                doVehicleFlipDamage((Tank)entity, flipDamage, direction &lt; 3, skidDistance - 1);</span>
            }

<span class="nc" id="L5679">        } // Handle the next skid hex.</span>

        // If the skidding entity violates stacking,
        // displace targets until it doesn't.
<span class="nc" id="L5683">        curPos = entity.getPosition();</span>
<span class="nc" id="L5684">        Entity target = Compute.stackingViolation(game, entity.getId(), curPos);</span>
<span class="nc bnc" id="L5685" title="All 2 branches missed.">        while (target != null) {</span>
<span class="nc" id="L5686">            nextPos = Compute.getValidDisplacement(game, target.getId(), target.getPosition(), direction);</span>
            // ASSUMPTION
            // There should always be *somewhere* that
            // the target can go... last skid hex if
            // nothing else is available.
<span class="nc bnc" id="L5691" title="All 2 branches missed.">            if (null == nextPos) {</span>
                // But I don't trust the assumption fully.
                // Report the error and try to continue.
<span class="nc" id="L5694">                MegaMek.getLogger().error(&quot;The skid of &quot; + entity.getShortName()</span>
<span class="nc" id="L5695">                                + &quot; should displace &quot; + target.getShortName()</span>
<span class="nc" id="L5696">                                + &quot; in hex &quot; + curPos.getBoardNum()</span>
                                + &quot; but there is nowhere to go.&quot;);
<span class="nc" id="L5698">                break;</span>
            }
            // indent displacement
<span class="nc" id="L5701">            r = new Report(1210, Report.PUBLIC);</span>
<span class="nc" id="L5702">            r.indent();</span>
<span class="nc" id="L5703">            r.newlines = 0;</span>
<span class="nc" id="L5704">            addReport(r);</span>
<span class="nc" id="L5705">            addReport(doEntityDisplacement(target, curPos, nextPos, null));</span>
<span class="nc" id="L5706">            addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, entity.getElevation()));</span>
<span class="nc" id="L5707">            target = Compute.stackingViolation(game, entity.getId(), curPos);</span>
        }

        // Mechs suffer damage for every hex skidded.
        // For QuadVees in vehicle mode, apply
        // damage only if flipping.
<span class="nc bnc" id="L5713" title="All 2 branches missed.">        boolean mechDamage = ((entity instanceof Mech)</span>
<span class="nc bnc" id="L5714" title="All 4 branches missed.">                &amp;&amp; !((entity.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (entity.getElevation() &gt; 0)));</span>
<span class="nc bnc" id="L5715" title="All 4 branches missed.">        if (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
<span class="nc" id="L5716">            mechDamage = flip;</span>
        }
<span class="nc bnc" id="L5718" title="All 2 branches missed.">        if (mechDamage) {</span>
            // Calculate one half falling damage times skid length.
<span class="nc" id="L5720">            int damage = skidDistance * (int) Math.ceil(Math.round(entity.getWeight() / 10.0) / 2.0);</span>

            // report skid damage
<span class="nc" id="L5723">            r = new Report(2090);</span>
<span class="nc" id="L5724">            r.subject = entity.getId();</span>
<span class="nc" id="L5725">            r.indent();</span>
<span class="nc" id="L5726">            r.addDesc(entity);</span>
<span class="nc" id="L5727">            r.add(damage);</span>
<span class="nc" id="L5728">            addReport(r);</span>

            // standard damage loop
            // All skid damage is to the front.
<span class="nc bnc" id="L5732" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L5733">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L5734">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L5735">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5736">                addReport(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L5737">                damage -= cluster;</span>
<span class="nc" id="L5738">            }</span>
<span class="nc" id="L5739">            addNewLines();</span>
        }

<span class="nc bnc" id="L5742" title="All 4 branches missed.">        if (flip &amp;&amp; entity instanceof Tank) {</span>
<span class="nc" id="L5743">            addReport(applyCriticalHit(entity, Entity.NONE, new CriticalSlot(0, Tank.CRIT_CREW_STUNNED),</span>
                    true, 0, false));
<span class="nc bnc" id="L5745" title="All 6 branches missed.">        } else if (flip &amp;&amp; entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
            // QuadVees don't suffer stunned crew criticals; require PSR to avoid damage instead.
<span class="nc" id="L5747">            PilotingRollData prd = entity.getBasePilotingRoll();</span>
<span class="nc" id="L5748">            addReport(checkPilotAvoidFallDamage(entity, 1, prd));</span>
        }

        // Clean up the entity if it has been destroyed.
<span class="nc bnc" id="L5752" title="All 2 branches missed.">        if (entity.isDoomed()) {</span>
<span class="nc" id="L5753">            entity.setDestroyed(true);</span>
<span class="nc" id="L5754">            game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L5755">            send(createRemoveEntityPacket(entity.getId()));</span>

            // The entity's movement is completed.
<span class="nc" id="L5758">            return true;</span>
        }

        // Let the player know the ordeal is over.
<span class="nc" id="L5762">        r = new Report(2095);</span>
<span class="nc" id="L5763">        r.subject = entity.getId();</span>
<span class="nc" id="L5764">        r.indent();</span>
<span class="nc" id="L5765">        addReport(r);</span>

<span class="nc" id="L5767">        return false;</span>
    }

    /**
     * Roll on the failed vehicle maneuver table.
     *
     * @param entity    The vehicle that failed the maneuver.
     * @param curPos    The coordinates of the hex in which the maneuver was attempted.
     * @param turnDirection The difference between the intended final facing and the starting facing
     *                      (-1 for left turn, 1 for right turn, 0 for not turning).
     * @param prevStep  The &lt;code&gt;MoveStep&lt;/code&gt; immediately preceding the one being processed.
     *                  Cannot be null; if the check is made for the first step of the path,
     *                  use the current step.
     * @param lastStepMoveType  The &lt;code&gt;EntityMovementType&lt;/code&gt; of the last step in the path.
     * @param distance  The distance moved so far during the phase; used to calculate any potential skid.
     * @param modifier  The modifier to the maneuver failure roll.
     * @return          true if the maneuver failure result ends the unit's turn.
     */
    private boolean processFailedVehicleManeuver(Entity entity, Coords curPos, int turnDirection,
            MoveStep prevStep, boolean isBackwards, EntityMovementType lastStepMoveType, int distance,
            int modifier, int marginOfFailure) {
<span class="nc" id="L5788">        IHex curHex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L5789" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WHEELED</span>
<span class="nc bnc" id="L5790" title="All 2 branches missed.">                &amp;&amp; !curHex.containsTerrain(Terrains.PAVEMENT)) {</span>
<span class="nc" id="L5791">            modifier += 2;</span>
        }
<span class="nc bnc" id="L5793" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L5794">            modifier += 2;</span>
<span class="nc bnc" id="L5795" title="All 2 branches missed.">        } else if (entity.getMovementMode() == EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L5796" title="All 4 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; entity instanceof Tank)</span>
<span class="nc bnc" id="L5797" title="All 2 branches missed.">                || entity.getMovementMode() == EntityMovementMode.HYDROFOIL) {</span>
<span class="nc" id="L5798">            modifier += 4;</span>
        }
<span class="nc bnc" id="L5800" title="All 2 branches missed.">        if (entity.getWeightClass() &lt; EntityWeightClass.WEIGHT_MEDIUM</span>
<span class="nc bnc" id="L5801" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</span>
<span class="nc" id="L5802">            modifier++;</span>
<span class="nc bnc" id="L5803" title="All 2 branches missed.">        } else if (entity.getWeightClass() == EntityWeightClass.WEIGHT_HEAVY</span>
<span class="nc bnc" id="L5804" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_LARGE_SUPPORT) {</span>
<span class="nc" id="L5805">            modifier--;</span>
<span class="nc bnc" id="L5806" title="All 2 branches missed.">        } else if (entity.getWeightClass() == EntityWeightClass.WEIGHT_ASSAULT</span>
<span class="nc bnc" id="L5807" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY) {</span>
<span class="nc" id="L5808">            modifier -= 2;</span>
        }
<span class="nc" id="L5810">        boolean turnEnds = false;</span>
<span class="nc" id="L5811">        boolean motiveDamage = false;</span>
<span class="nc" id="L5812">        int motiveDamageMod = 0;</span>
<span class="nc" id="L5813">        boolean skid = false;</span>
<span class="nc" id="L5814">        boolean flip = false;</span>
<span class="nc bnc" id="L5815" title="All 2 branches missed.">        boolean isGroundVehicle = ((entity instanceof Tank)</span>
<span class="nc bnc" id="L5816" title="All 2 branches missed.">                &amp;&amp; ((entity.getMovementMode() == EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L5817" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WHEELED)));</span>

<span class="nc" id="L5819">        int roll = Compute.d6(2);</span>

<span class="nc" id="L5821">        Report r = new Report(2505);</span>
<span class="nc" id="L5822">        r.subject = entity.getId();</span>
<span class="nc" id="L5823">        r.newlines = 0;</span>
<span class="nc" id="L5824">        r.indent(2);</span>
<span class="nc" id="L5825">        addReport(r);</span>
<span class="nc" id="L5826">        r = new Report(6310);</span>
<span class="nc" id="L5827">        r.subject = entity.getId();</span>
<span class="nc" id="L5828">        r.add(roll);</span>
<span class="nc" id="L5829">        r.newlines = 0;</span>
<span class="nc" id="L5830">        addReport(r);</span>
<span class="nc" id="L5831">        r = new Report(3340);</span>
<span class="nc" id="L5832">        r.add(modifier);</span>
<span class="nc" id="L5833">        r.subject = entity.getId();</span>
<span class="nc" id="L5834">        r.newlines = 0;</span>
<span class="nc" id="L5835">        addReport(r);</span>

<span class="nc" id="L5837">        r = new Report(1210);</span>
<span class="nc" id="L5838">        r.subject = entity.getId();</span>
<span class="nc" id="L5839">        roll += modifier;</span>
<span class="nc bnc" id="L5840" title="All 2 branches missed.">        if (roll &lt; 8) {</span>
<span class="nc" id="L5841">            r.messageId = 2506;</span>
            // minor fishtail, fail to turn
<span class="nc" id="L5843">            turnDirection = 0;</span>
<span class="nc bnc" id="L5844" title="All 2 branches missed.">        } else if (roll &lt; 10) {</span>
<span class="nc" id="L5845">            r.messageId = 2507;</span>
            // moderate fishtail, turn an extra hexside and roll for motive damage at -1.
<span class="nc bnc" id="L5847" title="All 2 branches missed.">            if (turnDirection == 0) {</span>
<span class="nc bnc" id="L5848" title="All 2 branches missed.">                turnDirection = Compute.d6() &lt; 4? -1 : 1;</span>
            } else {
<span class="nc" id="L5850">                turnDirection *= 2;</span>
            }
<span class="nc" id="L5852">            motiveDamage = true;</span>
<span class="nc" id="L5853">            motiveDamageMod = -1;</span>
<span class="nc bnc" id="L5854" title="All 2 branches missed.">        } else if (roll &lt; 12) {</span>
<span class="nc" id="L5855">            r.messageId = 2508;</span>
            // serious fishtail, turn an extra hexside and roll for motive damage. Turn ends.
<span class="nc bnc" id="L5857" title="All 2 branches missed.">            if (turnDirection == 0) {</span>
<span class="nc bnc" id="L5858" title="All 2 branches missed.">                turnDirection = Compute.d6() &lt; 4? -1 : 1;</span>
            } else {
<span class="nc" id="L5860">                turnDirection *= 2;</span>
            }
<span class="nc" id="L5862">            motiveDamage = true;</span>
<span class="nc" id="L5863">            turnEnds = true;</span>
        } else {
<span class="nc" id="L5865">            r.messageId = 2509;</span>
            // Turn fails and vehicle skids
            // Wheeled and naval vehicles start to flip if the roll is high enough.
<span class="nc bnc" id="L5868" title="All 2 branches missed.">            if (roll &gt; 13) {</span>
<span class="nc bnc" id="L5869" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L5870">                    r.messageId = 2510;</span>
<span class="nc" id="L5871">                    flip = true;</span>
<span class="nc bnc" id="L5872" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.NAVAL</span>
<span class="nc bnc" id="L5873" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.HYDROFOIL) {</span>
<span class="nc" id="L5874">                    entity.setDoomed(true);</span>
<span class="nc" id="L5875">                    r.messageId = 2511;</span>
                }
            }
<span class="nc" id="L5878">            skid = true;</span>
<span class="nc" id="L5879">            turnEnds = true;</span>
        }
<span class="nc" id="L5881">        addReport(r);</span>
<span class="nc" id="L5882">        entity.setFacing((entity.getFacing() + turnDirection + 6) % 6);</span>
<span class="nc" id="L5883">        entity.setSecondaryFacing(entity.getFacing());</span>
<span class="nc bnc" id="L5884" title="All 4 branches missed.">        if (motiveDamage &amp;&amp; isGroundVehicle) {</span>
<span class="nc" id="L5885">            addReport(vehicleMotiveDamage((Tank)entity, motiveDamageMod));</span>
        }
<span class="nc bnc" id="L5887" title="All 4 branches missed.">        if (skid &amp;&amp; !entity.isDoomed()) {</span>
<span class="nc bnc" id="L5888" title="All 4 branches missed.">            if (!flip &amp;&amp; isGroundVehicle) {</span>
<span class="nc" id="L5889">                addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
            }

<span class="nc" id="L5892">            int skidDistance = (int)Math.round((double) (distance - 1) / 2);</span>
<span class="nc bnc" id="L5893" title="All 4 branches missed.">            if (flip &amp;&amp; entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
                // Wheeled vehicles that start to flip reduce the skid distance by one hex.
<span class="nc" id="L5895">                skidDistance--;</span>
<span class="nc bnc" id="L5896" title="All 2 branches missed.">            } else if (entity.getMovementMode() == EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L5897" title="All 2 branches missed.">                    || entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L5898" title="All 2 branches missed.">                    || entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L5899">                skidDistance = Math.min(marginOfFailure, distance);</span>
            }
<span class="nc bnc" id="L5901" title="All 2 branches missed.">            if (skidDistance &gt; 0) {</span>
<span class="nc" id="L5902">                int skidDirection = prevStep.getFacing();</span>
<span class="nc bnc" id="L5903" title="All 2 branches missed.">                if (isBackwards) {</span>
<span class="nc" id="L5904">                    skidDirection = (skidDirection + 3) % 6;</span>
                }
<span class="nc" id="L5906">                processSkid(entity, curPos, prevStep.getElevation(), skidDirection, skidDistance,</span>
                        prevStep, lastStepMoveType, flip);
            }
        }
<span class="nc" id="L5910">        return turnEnds;</span>
    }

    private void doVehicleFlipDamage(Tank entity, int damage, boolean startRight, int flipCount) {
        HitData hit;

<span class="nc" id="L5916">        int index = flipCount % 4;</span>
        // If there is no turret, we do side-side-bottom
<span class="nc bnc" id="L5918" title="All 2 branches missed.">        if (entity.hasNoTurret()) {</span>
<span class="nc" id="L5919">            index = flipCount % 3;</span>
<span class="nc bnc" id="L5920" title="All 2 branches missed.">            if (index &gt; 0) {</span>
<span class="nc" id="L5921">                index++;</span>
            }
        }
<span class="nc bnc" id="L5924" title="All 4 branches missed.">        switch (index) {</span>
            case 0:
<span class="nc bnc" id="L5926" title="All 2 branches missed.">                hit = new HitData(startRight ? Tank.LOC_RIGHT : Tank.LOC_LEFT);</span>
<span class="nc" id="L5927">                break;</span>
            case 1:
<span class="nc" id="L5929">                hit = new HitData(Tank.LOC_TURRET);</span>
<span class="nc" id="L5930">                break;</span>
            case 2:
<span class="nc bnc" id="L5932" title="All 2 branches missed.">                hit = new HitData(startRight ? Tank.LOC_LEFT : Tank.LOC_RIGHT);</span>
<span class="nc" id="L5933">                break;</span>
            default:
<span class="nc" id="L5935">                hit = null; //Motive damage instead</span>
        }
<span class="nc bnc" id="L5937" title="All 2 branches missed.">        if (hit != null) {</span>
<span class="nc" id="L5938">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5939">            addReport(damageEntity(entity, hit, damage));</span>
            // If the vehicle has two turrets, they both take full damage.
<span class="nc bnc" id="L5941" title="All 4 branches missed.">            if ((hit.getLocation() == Tank.LOC_TURRET) &amp;&amp; !(entity.hasNoDualTurret())) {</span>
<span class="nc" id="L5942">                hit = new HitData(Tank.LOC_TURRET_2);</span>
<span class="nc" id="L5943">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5944">                addReport(damageEntity(entity, hit, damage));</span>
            }
        } else {
<span class="nc" id="L5947">            addReport(vehicleMotiveDamage(entity, 1));</span>
        }
<span class="nc" id="L5949">    }</span>

    /**
     * processes a potential collision
     *
     * @param entity
     * @param target
     * @param src
     * @return
     */
    private boolean processCollision(Entity entity, Entity target, Coords src) {
        Report r;

<span class="nc" id="L5962">        r = new Report(9035);</span>
<span class="nc" id="L5963">        r.subject = entity.getId();</span>
<span class="nc" id="L5964">        r.add(entity.getDisplayName());</span>
<span class="nc" id="L5965">        r.add(target.getDisplayName());</span>
<span class="nc" id="L5966">        addReport(r);</span>
<span class="nc bnc" id="L5967" title="All 2 branches missed.">        boolean partial = (Compute.d6() == 6);</span>
        // if aero chance to avoid
<span class="nc bnc" id="L5969" title="All 2 branches missed.">        if ((target.isAero())</span>
<span class="nc bnc" id="L5970" title="All 2 branches missed.">            &amp;&amp; (target.mpUsed &lt; target.getRunMPwithoutMASC())</span>
<span class="nc bnc" id="L5971" title="All 4 branches missed.">            &amp;&amp; !((IAero) target).isOutControlTotal() &amp;&amp; !target.isImmobile()) {</span>
            // give them a control roll to avoid the collision
            // TODO : I should make this voluntary really
<span class="nc" id="L5974">            IAero ta = (IAero) target;</span>
<span class="nc" id="L5975">            PilotingRollData psr = target.getBasePilotingRoll();</span>
<span class="nc" id="L5976">            psr.addModifier(0, &quot;avoiding collision&quot;);</span>
<span class="nc" id="L5977">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L5978">            r = new Report(9045);</span>
<span class="nc" id="L5979">            r.subject = target.getId();</span>
<span class="nc" id="L5980">            r.add(target.getDisplayName());</span>
<span class="nc" id="L5981">            r.add(psr);</span>
<span class="nc" id="L5982">            r.add(ctrlroll);</span>
<span class="nc" id="L5983">            r.newlines = 0;</span>
<span class="nc" id="L5984">            r.indent(2);</span>
<span class="nc bnc" id="L5985" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L5986">                r.choose(false);</span>
<span class="nc" id="L5987">                addReport(r);</span>
            } else {
                // avoided collision
<span class="nc" id="L5990">                r.choose(true);</span>
<span class="nc" id="L5991">                addReport(r);</span>
                // two possibilities:
                // 1) the target already moved, but had MP left - check for
                // control roll conditions
                // 2) the target had not yet moved, move them in straight line
<span class="nc bnc" id="L5996" title="All 2 branches missed.">                if (!target.isDone()) {</span>
<span class="nc" id="L5997">                    int vel = ta.getCurrentVelocity();</span>
<span class="nc" id="L5998">                    MovePath md = new MovePath(game, target);</span>
<span class="nc bnc" id="L5999" title="All 2 branches missed.">                    while (vel &gt; 0) {</span>
<span class="nc" id="L6000">                        md.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L6001">                        vel--;</span>
                    }
<span class="nc" id="L6003">                    game.removeTurnFor(target);</span>
<span class="nc" id="L6004">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L6005">                    processMovement(target, md, null);</span>
                    // for some reason it is not clearing out turn
<span class="nc" id="L6007">                } else {</span>
                    // what needs to get checked?
                    // this move puts them at over-thrust
<span class="nc" id="L6010">                    target.moved = EntityMovementType.MOVE_OVER_THRUST;</span>
                    // they may have exceeded SI, only add if they hadn't
                    // exceeded it before
<span class="nc bnc" id="L6013" title="All 2 branches missed.">                    if (target.mpUsed &lt;= ta.getSI()) {</span>
<span class="nc" id="L6014">                        PilotingRollData rollTarget = ta.checkThrustSITotal(</span>
<span class="nc" id="L6015">                                target.getRunMPwithoutMASC(), target.moved);</span>
<span class="nc bnc" id="L6016" title="All 2 branches missed.">                        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6017">                            game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L6018">                                    target.getId(), 0,</span>
                                    &quot;Thrust spent during turn exceeds SI&quot;));
                        }
                    }
<span class="nc" id="L6022">                    target.mpUsed = target.getRunMPwithoutMASC();</span>
                }
<span class="nc" id="L6024">                return false;</span>
            }
<span class="nc" id="L6026">        } else {</span>
            // can't avoid collision - write report
<span class="nc" id="L6028">            r = new Report(9040);</span>
<span class="nc" id="L6029">            r.subject = entity.getId();</span>
<span class="nc" id="L6030">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L6031">            r.indent(2);</span>
<span class="nc" id="L6032">            addReport(r);</span>
        }

        // if we are still here, then collide
<span class="nc" id="L6036">        ToHitData toHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, &quot;Its a collision&quot;);</span>
<span class="nc" id="L6037">        toHit.setSideTable(target.sideTable(src));</span>
<span class="nc" id="L6038">        resolveRamDamage((IAero)entity, target, toHit, partial, false);</span>

        // Has the target been destroyed?
<span class="nc bnc" id="L6041" title="All 2 branches missed.">        if (target.isDoomed()) {</span>
            // Has the target taken a turn?
<span class="nc bnc" id="L6043" title="All 2 branches missed.">            if (!target.isDone()) {</span>
                // Dead entities don't take turns.
<span class="nc" id="L6045">                game.removeTurnFor(target);</span>
<span class="nc" id="L6046">                send(createTurnVectorPacket());</span>
            } // End target-still-to-move
            // Clean out the entity.
<span class="nc" id="L6049">            target.setDestroyed(true);</span>
<span class="nc" id="L6050">            game.moveToGraveyard(target.getId());</span>
<span class="nc" id="L6051">            send(createRemoveEntityPacket(target.getId()));</span>
        }
        // Update the target's position,
        // unless it is off the game map.
<span class="nc bnc" id="L6055" title="All 2 branches missed.">        if (!game.isOutOfGame(target)) {</span>
<span class="nc" id="L6056">            entityUpdate(target.getId());</span>
        }

<span class="nc" id="L6059">        return true;</span>
    }

    private boolean checkCrash(Entity entity, Coords pos, int altitude) {
        // only Aeros can crash
<span class="nc bnc" id="L6064" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L6065">            return false;</span>
        }
        // no crashing in space
<span class="nc bnc" id="L6068" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L6069">            return false;</span>
        }
        // if aero on the ground map, then only crash if elevation is zero
<span class="nc bnc" id="L6072" title="All 2 branches missed.">        else if (game.getBoard().onGround()) {</span>
<span class="nc bnc" id="L6073" title="All 2 branches missed.">            return altitude &lt;= 0;</span>
        }
        // we must be in atmosphere
        // if we're off the map, assume hex ceiling 0
        // Hexes with elevations &lt; 0 are treated as 0 altitude
<span class="nc" id="L6078">        int ceiling = 0;</span>
<span class="nc bnc" id="L6079" title="All 2 branches missed.">        if (game.getBoard().getHex(pos) != null) {</span>
<span class="nc" id="L6080">            ceiling = Math.max(0, game.getBoard().getHex(pos).ceiling(true));</span>
        }
<span class="nc bnc" id="L6082" title="All 2 branches missed.">        return ceiling &gt;= altitude;</span>
    }

    private Vector&lt;Report&gt; processCrash(Entity entity, int vel, Coords c) {
<span class="nc" id="L6086">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L6088" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L6089">            r = new Report(9701);</span>
<span class="nc" id="L6090">            r.subject = entity.getId();</span>
<span class="nc" id="L6091">            vReport.add(r);</span>
<span class="nc" id="L6092">            vReport.addAll(destroyEntity(entity, &quot;crashed off the map&quot;, true, true));</span>
<span class="nc" id="L6093">            return vReport;</span>
        }

<span class="nc bnc" id="L6096" title="All 2 branches missed.">        if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L6097">            r = new Report(9393, Report.PUBLIC);</span>
<span class="nc" id="L6098">            r.indent();</span>
<span class="nc" id="L6099">            r.addDesc(entity);</span>
<span class="nc" id="L6100">            vReport.add(r);</span>
<span class="nc" id="L6101">            entity.setDoomed(true);</span>
        } else {
<span class="nc" id="L6103">            ((IAero) entity).land();</span>
        }

        // we might hit multiple hexes, if we're a DropShip, so we do some
        // checks for all of them
<span class="nc" id="L6108">        List&lt;Coords&gt; coords = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L6109">        coords.add(c);</span>
<span class="nc" id="L6110">        IHex h = game.getBoard().getHex(c);</span>
        int crateredElevation;
<span class="nc" id="L6112">        boolean containsWater = false;</span>
<span class="nc bnc" id="L6113" title="All 2 branches missed.">        if (h.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L6114">            crateredElevation = Math.min(2, h.depth() + 1);</span>
<span class="nc" id="L6115">            containsWater = true;</span>
        } else {
<span class="nc" id="L6117">            crateredElevation = h.getLevel() - 2;</span>
        }
<span class="nc bnc" id="L6119" title="All 2 branches missed.">        if (entity instanceof Dropship) {</span>
<span class="nc bnc" id="L6120" title="All 2 branches missed.">            for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L6121">                Coords adjCoords = c.translated(i);</span>
<span class="nc bnc" id="L6122" title="All 2 branches missed.">                if (!game.getBoard().contains(adjCoords)) {</span>
<span class="nc" id="L6123">                    continue;</span>
                }
<span class="nc" id="L6125">                IHex adjHex = game.getBoard().getHex(adjCoords);</span>
<span class="nc" id="L6126">                coords.add(adjCoords);</span>
<span class="nc bnc" id="L6127" title="All 2 branches missed.">                if (adjHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L6128" title="All 2 branches missed.">                    if (containsWater) {</span>
<span class="nc" id="L6129">                        int newDepth = Math.min(2, adjHex.depth() + 1);</span>
<span class="nc bnc" id="L6130" title="All 2 branches missed.">                        if (newDepth &gt; crateredElevation) {</span>
<span class="nc" id="L6131">                            crateredElevation = newDepth;</span>
                        }
<span class="nc" id="L6133">                    } else {</span>
<span class="nc" id="L6134">                        crateredElevation = Math.min(2, adjHex.depth() + 1);</span>
<span class="nc" id="L6135">                        containsWater = true;</span>
                    }
<span class="nc bnc" id="L6137" title="All 4 branches missed.">                } else if (!containsWater &amp;&amp; (adjHex.getLevel() &lt; crateredElevation)) {</span>
<span class="nc" id="L6138">                    crateredElevation = adjHex.getLevel();</span>
                }
            }
        }
        // Units with velocity zero are treated like that had velocity two
<span class="nc bnc" id="L6143" title="All 2 branches missed.">        if (vel &lt; 1) {</span>
<span class="nc" id="L6144">            vel = 2;</span>
        }

        // deal crash damage only once
<span class="nc" id="L6148">        boolean damageDealt = false;</span>
<span class="nc bnc" id="L6149" title="All 2 branches missed.">        for (Coords hitCoords : coords) {</span>
<span class="nc" id="L6150">            int orig_crash_damage = Compute.d6(2) * 10 * vel;</span>
<span class="nc" id="L6151">            int crash_damage = orig_crash_damage;</span>
<span class="nc" id="L6152">            int direction = entity.getFacing();</span>
            // first check for buildings
<span class="nc" id="L6154">            Building bldg = game.getBoard().getBuildingAt(hitCoords);</span>
<span class="nc bnc" id="L6155" title="All 4 branches missed.">            if ((null != bldg) &amp;&amp; (bldg.getType() == Building.HARDENED)) {</span>
<span class="nc" id="L6156">                crash_damage *= 2;</span>
            }
<span class="nc bnc" id="L6158" title="All 2 branches missed.">            if (null != bldg) {</span>
<span class="nc" id="L6159">                collapseBuilding(bldg, game.getPositionMap(), hitCoords, true, vReport);</span>
            }
<span class="nc bnc" id="L6161" title="All 2 branches missed.">            if (!damageDealt) {</span>
<span class="nc" id="L6162">                r = new Report(9700, Report.PUBLIC);</span>
<span class="nc" id="L6163">                r.indent();</span>
<span class="nc" id="L6164">                r.addDesc(entity);</span>
<span class="nc" id="L6165">                r.add(crash_damage);</span>
<span class="nc" id="L6166">                vReport.add(r);</span>
<span class="nc bnc" id="L6167" title="All 2 branches missed.">                while (crash_damage &gt; 0) {</span>
                    HitData hit;
<span class="nc bnc" id="L6169" title="All 4 branches missed.">                    if ((entity instanceof SmallCraft) &amp;&amp; ((SmallCraft) entity).isSpheroid()) {</span>
<span class="nc" id="L6170">                        hit = entity.rollHitLocation(ToHitData.HIT_SPHEROID_CRASH, ToHitData.SIDE_REAR);</span>
                    } else {
<span class="nc" id="L6172">                        hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
                    }

<span class="nc bnc" id="L6175" title="All 2 branches missed.">                    if (crash_damage &gt; 10) {</span>
<span class="nc" id="L6176">                        vReport.addAll(damageEntity(entity, hit, 10));</span>
                    } else {
<span class="nc" id="L6178">                        vReport.addAll(damageEntity(entity, hit, crash_damage));</span>
                    }
<span class="nc" id="L6180">                    crash_damage -= 10;</span>
<span class="nc" id="L6181">                }</span>
<span class="nc" id="L6182">                damageDealt = true;</span>
            }

            // ok, now lets cycle through the entities in this spot and
            // potentially
            // damage them
<span class="nc bnc" id="L6188" title="All 2 branches missed.">            for (Entity victim : game.getEntitiesVector(hitCoords)) {</span>
<span class="nc bnc" id="L6189" title="All 2 branches missed.">                if (victim.getId() == entity.getId()) {</span>
<span class="nc" id="L6190">                    continue;</span>
                }
<span class="nc bnc" id="L6192" title="All 2 branches missed.">                if (((victim.getElevation() &gt; 0) &amp;&amp; victim</span>
<span class="nc bnc" id="L6193" title="All 4 branches missed.">                        .isAirborneVTOLorWIGE()) || (victim.getAltitude() &gt; 0)) {</span>
<span class="nc" id="L6194">                    continue;</span>
                }
                // if the crasher is a DropShip and the victim is not a mech,
                // then it is automatically destroyed
<span class="nc bnc" id="L6198" title="All 4 branches missed.">                if ((entity instanceof Dropship) &amp;&amp; !(victim instanceof Mech)) {</span>
<span class="nc" id="L6199">                    vReport.addAll(destroyEntity(victim, &quot;hit by crashing DropShip&quot;));</span>
                } else {
<span class="nc" id="L6201">                    crash_damage = orig_crash_damage / 2;</span>
                    // roll dice to see if they got hit
<span class="nc" id="L6203">                    int target = 2;</span>
<span class="nc bnc" id="L6204" title="All 2 branches missed.">                    if (victim instanceof Infantry) {</span>
<span class="nc" id="L6205">                        target = 3;</span>
                    }
<span class="nc" id="L6207">                    int roll = Compute.d6();</span>
<span class="nc" id="L6208">                    r = new Report(9705, Report.PUBLIC);</span>
<span class="nc" id="L6209">                    r.indent();</span>
<span class="nc" id="L6210">                    r.addDesc(victim);</span>
<span class="nc" id="L6211">                    r.add(target);</span>
<span class="nc" id="L6212">                    r.add(crash_damage);</span>
<span class="nc" id="L6213">                    r.add(roll);</span>
<span class="nc bnc" id="L6214" title="All 2 branches missed.">                    if (roll &gt; target) {</span>
<span class="nc" id="L6215">                        r.choose(true);</span>
<span class="nc" id="L6216">                        vReport.add(r);</span>
                        // apply half the crash damage in 5 point clusters
                        // (check
                        // hit tables)
<span class="nc bnc" id="L6220" title="All 2 branches missed.">                        while (crash_damage &gt; 0) {</span>
<span class="nc" id="L6221">                            HitData hit = victim.rollHitLocation(</span>
                                    ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);
<span class="nc bnc" id="L6223" title="All 2 branches missed.">                            if (victim instanceof Mech) {</span>
<span class="nc" id="L6224">                                hit = victim.rollHitLocation(</span>
                                        ToHitData.HIT_PUNCH, ToHitData.SIDE_FRONT);
                            }
<span class="nc bnc" id="L6227" title="All 2 branches missed.">                            if (victim instanceof Protomech) {</span>
<span class="nc" id="L6228">                                hit = victim.rollHitLocation(</span>
                                        ToHitData.HIT_SPECIAL_PROTO, ToHitData.SIDE_FRONT);
                            }
<span class="nc bnc" id="L6231" title="All 2 branches missed.">                            if (crash_damage &gt; 5) {</span>
<span class="nc" id="L6232">                                vReport.addAll(damageEntity(victim, hit, 5));</span>
                            } else {
<span class="nc" id="L6234">                                vReport.addAll(damageEntity(victim, hit, crash_damage));</span>
                            }
<span class="nc" id="L6236">                            crash_damage -= 5;</span>
<span class="nc" id="L6237">                        }</span>

                    } else {
<span class="nc" id="L6240">                        r.choose(false);</span>
<span class="nc" id="L6241">                        vReport.add(r);</span>
                    }
                }

<span class="nc bnc" id="L6245" title="All 4 branches missed.">                if (!victim.isDoomed() &amp;&amp; !victim.isDestroyed()) {</span>
                    // entity displacement
<span class="nc" id="L6247">                    Coords dest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L6248">                                                               victim.getId(), hitCoords, direction);</span>
<span class="nc bnc" id="L6249" title="All 2 branches missed.">                    if (null != dest) {</span>
<span class="nc" id="L6250">                        doEntityDisplacement(</span>
                                victim,
                                hitCoords,
                                dest,
<span class="nc" id="L6254">                                new PilotingRollData(victim.getId(), 0, &quot;crash&quot;));</span>
<span class="nc bnc" id="L6255" title="All 2 branches missed.">                    } else if (!(victim instanceof Dropship)) {</span>
                        // destroy entity - but not dropships which are
                        // immovable
<span class="nc" id="L6258">                        addReport(destroyEntity(victim,</span>
                                                &quot;impossible displacement&quot;,
                                                victim instanceof Mech, victim instanceof Mech));
                    }
                }

<span class="nc" id="L6264">            }</span>

            // reduce woods
<span class="nc" id="L6267">            h = game.getBoard().getHex(hitCoords);</span>
<span class="nc bnc" id="L6268" title="All 2 branches missed.">            if (h.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc bnc" id="L6269" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6270">                    h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L6271">                    h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6272">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.ROUGH, 1));
                } else {
<span class="nc" id="L6275">                    int level = h.terrainLevel(Terrains.WOODS) - 1;</span>
<span class="nc" id="L6276">                    int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6277">                    h.removeTerrain(Terrains.WOODS);</span>
<span class="nc bnc" id="L6278" title="All 2 branches missed.">                    if (level &gt; 0) {</span>
<span class="nc" id="L6279">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6280">                                .createTerrain(Terrains.WOODS, level));</span>
<span class="nc" id="L6281">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc bnc" id="L6282" title="All 2 branches missed.">                                .createTerrain(Terrains.FOLIAGE_ELEV, folEl == 1 ? 1 : 2));</span>
                    } else {
<span class="nc" id="L6284">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6285">                                             .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L6286">                        h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                    }
                }
            }
            // do the same for jungles
<span class="nc bnc" id="L6291" title="All 2 branches missed.">            if (h.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc bnc" id="L6292" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6293">                    h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L6294">                    h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6295">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.ROUGH, 1));
                } else {
<span class="nc" id="L6298">                    int level = h.terrainLevel(Terrains.JUNGLE) - 1;</span>
<span class="nc" id="L6299">                    int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6300">                    h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc bnc" id="L6301" title="All 2 branches missed.">                    if (level &gt; 0) {</span>
<span class="nc" id="L6302">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6303">                                .createTerrain(Terrains.JUNGLE, level));</span>
<span class="nc" id="L6304">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc bnc" id="L6305" title="All 2 branches missed.">                                .createTerrain(Terrains.FOLIAGE_ELEV, folEl == 1 ? 1 : 2));</span>
                    } else {
<span class="nc" id="L6307">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6308">                                             .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L6309">                        h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                    }
                }
            }
<span class="nc bnc" id="L6313" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc bnc" id="L6314" title="All 2 branches missed.">                if (!containsWater) {</span>
<span class="nc" id="L6315">                    h.setLevel(crateredElevation);</span>
                } else {
<span class="nc bnc" id="L6317" title="All 2 branches missed.">                    if (!h.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L6318">                        h.removeAllTerrains();</span>
                    }
<span class="nc" id="L6320">                    h.addTerrain(new Terrain(Terrains.WATER, crateredElevation,</span>
                                             false, 0));
                }
            }
<span class="nc" id="L6324">            sendChangedHex(hitCoords);</span>
<span class="nc" id="L6325">        }</span>

        // check for a stacking violation - which should only happen in the
        // case of grounded dropships, because they are not movable
<span class="nc bnc" id="L6329" title="All 2 branches missed.">        if (null != Compute.stackingViolation(game, entity.getId(), c)) {</span>
<span class="nc" id="L6330">            Coords dest = Compute.getValidDisplacement(game, entity.getId(), c,</span>
<span class="nc" id="L6331">                                                       Compute.d6() - 1);</span>
<span class="nc bnc" id="L6332" title="All 2 branches missed.">            if (null != dest) {</span>
<span class="nc" id="L6333">                doEntityDisplacement(entity, c, dest, null);</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L6338">                vPhaseReport.addAll(destroyEntity(entity,</span>
                                                  &quot;impossible displacement&quot;, entity instanceof Mech,
                                                  entity instanceof Mech));
            }
        }

        // Check for watery death
<span class="nc" id="L6345">        h = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L6346" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.WATER) &amp;&amp; !entity.isDestroyed()</span>
<span class="nc bnc" id="L6347" title="All 2 branches missed.">            &amp;&amp; !entity.isDoomed()) {</span>
            int lethalDepth;
<span class="nc bnc" id="L6349" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6350">                lethalDepth = 2;</span>
            } else {
<span class="nc" id="L6352">                lethalDepth = 1;</span>
            }

<span class="nc bnc" id="L6355" title="All 2 branches missed.">            if (h.depth() &gt;= lethalDepth) {</span>
                // Oh snap... we is dead
<span class="nc" id="L6357">                vReport.addAll(destroyEntity(entity,</span>
                                             &quot;crashing into deep water&quot;, true, true));
            }
        }

<span class="nc" id="L6362">        return vReport;</span>
    }

    /**
     * Process any flee movement actions, including flying off the map
     *
     * @param movePath   The move path which resulted in an entity leaving the map.
     * @param flewOff    whether this fleeing is a result of accidentally flying off the
     *                   map
     * @param returnable the number of rounds until the unit can return to the map (-1
     *                   if it can't return)
     * @return Vector of turn reports.
     */
    private Vector&lt;Report&gt; processLeaveMap(MovePath movePath, boolean flewOff, int returnable) {
<span class="nc" id="L6376">        Entity entity = movePath.getEntity();</span>
<span class="nc" id="L6377">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
        // Unit has fled the battlefield.
<span class="nc" id="L6380">        r = new Report(2005, Report.PUBLIC);</span>
<span class="nc bnc" id="L6381" title="All 2 branches missed.">        if (flewOff) {</span>
<span class="nc" id="L6382">            r = new Report(9370, Report.PUBLIC);</span>
        }
<span class="nc" id="L6384">        r.addDesc(entity);</span>
<span class="nc" id="L6385">        addReport(r);</span>
        OffBoardDirection fleeDirection;
<span class="nc bnc" id="L6387" title="All 2 branches missed.">        if (movePath.getFinalCoords().getY() &lt;= 0) {</span>
<span class="nc" id="L6388">            fleeDirection = OffBoardDirection.NORTH;</span>
<span class="nc bnc" id="L6389" title="All 2 branches missed.">        } else if (movePath.getFinalCoords().getY() &gt;= (getGame().getBoard().getHeight() - 1)) {</span>
<span class="nc" id="L6390">            fleeDirection = OffBoardDirection.SOUTH;</span>
<span class="nc bnc" id="L6391" title="All 2 branches missed.">        } else if (movePath.getFinalCoords().getX() &lt;= 0) {</span>
<span class="nc" id="L6392">            fleeDirection = OffBoardDirection.WEST;</span>
        } else {
<span class="nc" id="L6394">            fleeDirection = OffBoardDirection.EAST;</span>
        }

<span class="nc bnc" id="L6397" title="All 2 branches missed.">        if (returnable &gt; -1) {</span>

<span class="nc" id="L6399">            entity.setDeployed(false);</span>
<span class="nc" id="L6400">            entity.setDeployRound(1 + game.getRoundCount() + returnable);</span>
<span class="nc" id="L6401">            entity.setPosition(null);</span>
<span class="nc" id="L6402">            entity.setDone(true);</span>
<span class="nc bnc" id="L6403" title="All 2 branches missed.">            if (entity.isAero()) {</span>
                // If we're flying off because we're OOC, when we come back we
                // should no longer be OOC
                // If we don't, this causes a major problem as aeros tend to
                // return, re-deploy then
                // fly off again instantly.
<span class="nc" id="L6409">                ((IAero) entity).setOutControl(false);</span>
            }
<span class="nc bnc" id="L6411" title="All 5 branches missed.">            switch (fleeDirection) {</span>
                case WEST:
<span class="nc" id="L6413">                    entity.setStartingPos(Board.START_W);</span>
<span class="nc" id="L6414">                    break;</span>
                case NORTH:
<span class="nc" id="L6416">                    entity.setStartingPos(Board.START_N);</span>
<span class="nc" id="L6417">                    break;</span>
                case EAST:
<span class="nc" id="L6419">                    entity.setStartingPos(Board.START_E);</span>
<span class="nc" id="L6420">                    break;</span>
                case SOUTH:
<span class="nc" id="L6422">                    entity.setStartingPos(Board.START_S);</span>
<span class="nc" id="L6423">                    break;</span>
                default:
<span class="nc" id="L6425">                    entity.setStartingPos(Board.START_EDGE);</span>
            }
<span class="nc" id="L6427">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6428">            return vReport;</span>
        }

        // Is the unit carrying passengers or trailers?
<span class="nc" id="L6432">        final List&lt;Entity&gt; passengers = new ArrayList&lt;&gt;(entity.getLoadedUnits());</span>
<span class="nc bnc" id="L6433" title="All 2 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()) {</span>
<span class="nc bnc" id="L6434" title="All 2 branches missed.">            for (int id : entity.getAllTowedUnits()) {</span>
<span class="nc" id="L6435">                Entity towed = game.getEntity(id);</span>
<span class="nc" id="L6436">                passengers.add(towed);</span>
<span class="nc" id="L6437">            }</span>
        }
<span class="nc bnc" id="L6439" title="All 2 branches missed.">        if (!passengers.isEmpty()) {</span>
<span class="nc bnc" id="L6440" title="All 2 branches missed.">            for (Entity passenger : passengers) {</span>
                // Unit has fled the battlefield.
<span class="nc" id="L6442">                r = new Report(2010, Report.PUBLIC);</span>
<span class="nc" id="L6443">                r.indent();</span>
<span class="nc" id="L6444">                r.addDesc(passenger);</span>
<span class="nc" id="L6445">                addReport(r);</span>
<span class="nc" id="L6446">                passenger.setRetreatedDirection(fleeDirection);</span>
<span class="nc" id="L6447">                game.removeEntity(passenger.getId(),</span>
                                  IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L6449">                send(createRemoveEntityPacket(passenger.getId(),</span>
                                              IEntityRemovalConditions.REMOVE_IN_RETREAT));
<span class="nc" id="L6451">            }</span>
        }

        // Handle any picked up MechWarriors
<span class="nc bnc" id="L6455" title="All 2 branches missed.">        for (Integer mechWarriorId : entity.getPickedUpMechWarriors()) {</span>
<span class="nc" id="L6456">            Entity mw = game.getEntity(mechWarriorId);</span>
            
<span class="nc bnc" id="L6458" title="All 2 branches missed.">            if(mw == null) {</span>
<span class="nc" id="L6459">                continue;</span>
            }

            // Is the MechWarrior an enemy?
<span class="nc" id="L6463">            int condition = IEntityRemovalConditions.REMOVE_IN_RETREAT;</span>
<span class="nc" id="L6464">            r = new Report(2010);</span>
<span class="nc bnc" id="L6465" title="All 2 branches missed.">            if (mw.isCaptured()) {</span>
<span class="nc" id="L6466">                r = new Report(2015);</span>
<span class="nc" id="L6467">                condition = IEntityRemovalConditions.REMOVE_CAPTURED;</span>
            } else {
<span class="nc" id="L6469">                mw.setRetreatedDirection(fleeDirection);</span>
            }
<span class="nc" id="L6471">            game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L6472">            send(createRemoveEntityPacket(mw.getId(), condition));</span>
<span class="nc" id="L6473">            r.addDesc(mw);</span>
<span class="nc" id="L6474">            r.indent();</span>
<span class="nc" id="L6475">            addReport(r);</span>
<span class="nc" id="L6476">        }</span>
        // Is the unit being swarmed?
<span class="nc" id="L6478">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L6479" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L6480">            final Entity swarmer = game.getEntity(swarmerId);</span>

            // Has the swarmer taken a turn?
<span class="nc bnc" id="L6483" title="All 2 branches missed.">            if (!swarmer.isDone()) {</span>
                // Dead entities don't take turns.
<span class="nc" id="L6485">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L6486">                send(createTurnVectorPacket());</span>

            } // End swarmer-still-to-move

            // Unit has fled the battlefield.
<span class="nc" id="L6491">            swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L6492">            entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L6493">            r = new Report(2015, Report.PUBLIC);</span>
<span class="nc" id="L6494">            r.indent();</span>
<span class="nc" id="L6495">            r.addDesc(swarmer);</span>
<span class="nc" id="L6496">            addReport(r);</span>
<span class="nc" id="L6497">            game.removeEntity(swarmerId, IEntityRemovalConditions.REMOVE_CAPTURED);</span>
<span class="nc" id="L6498">            send(createRemoveEntityPacket(swarmerId, IEntityRemovalConditions.REMOVE_CAPTURED));</span>
        }
<span class="nc" id="L6500">        entity.setRetreatedDirection(fleeDirection);</span>
<span class="nc" id="L6501">        game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L6502">        send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
<span class="nc" id="L6503">        return vReport;</span>
    }

    /**
     * Steps through an entity movement packet, executing it.
     *
     * @param entity   The Entity that is moving
     * @param md       The MovePath that defines how the Entity moves
     * @param losCache A cache that stores Los between various Entities and
     *                 targets.  In double blind games, we may need to compute a
     *                 lot of LosEffects, so caching them can really speed
     *                 things up.
     */
    private void processMovement(Entity entity, MovePath md, Map&lt;EntityTargetPair,
            LosEffects&gt; losCache) {
        // Make sure the cache isn't null
<span class="nc bnc" id="L6519" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L6520">            losCache = new HashMap&lt;&gt;();</span>
        }
        Report r;
<span class="nc" id="L6523">        boolean sideslipped = false; // for VTOL side slipping</span>
        PilotingRollData rollTarget;

        // check for fleeing
<span class="nc bnc" id="L6527" title="All 2 branches missed.">        if (md.contains(MoveStepType.FLEE)) {</span>
<span class="nc" id="L6528">            addReport(processLeaveMap(md, false, -1));</span>
<span class="nc" id="L6529">            return;</span>
        }

<span class="nc bnc" id="L6532" title="All 2 branches missed.">        if (md.contains(MoveStepType.EJECT)) {</span>
<span class="nc bnc" id="L6533" title="All 4 branches missed.">            if (entity.isLargeCraft() &amp;&amp; !entity.isCarcass()) {</span>
<span class="nc" id="L6534">                r = new Report(2026);</span>
<span class="nc" id="L6535">                r.subject = entity.getId();</span>
<span class="nc" id="L6536">                r.addDesc(entity);</span>
<span class="nc" id="L6537">                addReport(r);</span>
<span class="nc" id="L6538">                Aero ship = (Aero) entity;</span>
<span class="nc" id="L6539">                ship.setEjecting(true);</span>
<span class="nc" id="L6540">                entityUpdate(ship.getId());</span>
<span class="nc" id="L6541">                Coords legalPos = entity.getPosition();</span>
                //Get the step so we can pass it in and get the abandon coords from it
<span class="nc" id="L6543">                for (final Enumeration&lt;MoveStep&gt; i = md.getSteps(); i</span>
<span class="nc bnc" id="L6544" title="All 2 branches missed.">                        .hasMoreElements();) {</span>
<span class="nc" id="L6545">                    final MoveStep step = i.nextElement();</span>
<span class="nc bnc" id="L6546" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.EJECT) {</span>
<span class="nc" id="L6547">                        legalPos = step.getTargetPosition();</span>
                    }
<span class="nc" id="L6549">                }</span>
<span class="nc bnc" id="L6550" title="All 4 branches missed.">                addReport(ejectSpacecraft(ship, ship.isSpaceborne(), (ship.isAirborne() &amp;&amp; !ship.isSpaceborne()),legalPos));</span>
                //If we're grounded or destroyed by crew loss, end movement
<span class="nc bnc" id="L6552" title="All 6 branches missed.">                if (entity.isDoomed() || (!entity.isSpaceborne() &amp;&amp; !entity.isAirborne())) {</span>
<span class="nc" id="L6553">                    return;</span>
                }
<span class="nc bnc" id="L6555" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Aero)) {</span>
<span class="nc" id="L6556">                r = new Report(2020);</span>
<span class="nc" id="L6557">                r.subject = entity.getId();</span>
<span class="nc" id="L6558">                r.add(entity.getCrew().getName());</span>
<span class="nc" id="L6559">                r.addDesc(entity);</span>
<span class="nc" id="L6560">                addReport(r);</span>
<span class="nc" id="L6561">                addReport(ejectEntity(entity, false));</span>
<span class="nc" id="L6562">                return;</span>
<span class="nc bnc" id="L6563" title="All 4 branches missed.">            } else if ((entity instanceof Tank) &amp;&amp; !entity.isCarcass()) {</span>
<span class="nc" id="L6564">                r = new Report(2025);</span>
<span class="nc" id="L6565">                r.subject = entity.getId();</span>
<span class="nc" id="L6566">                r.addDesc(entity);</span>
<span class="nc" id="L6567">                addReport(r);</span>
<span class="nc" id="L6568">                addReport(ejectEntity(entity, false));</span>
<span class="nc" id="L6569">                return;</span>
            }
        }

<span class="nc bnc" id="L6573" title="All 2 branches missed.">        if (md.contains(MoveStepType.CAREFUL_STAND)) {</span>
<span class="nc" id="L6574">            entity.setCarefulStand(true);</span>
        }
<span class="nc bnc" id="L6576" title="All 2 branches missed.">        if (md.contains(MoveStepType.BACKWARDS)) {</span>
<span class="nc" id="L6577">            entity.setMovedBackwards(true);</span>
<span class="nc bnc" id="L6578" title="All 2 branches missed.">            if (md.getMpUsed() &gt; entity.getWalkMP()) {</span>
<span class="nc" id="L6579">                entity.setPowerReverse(true);</span>
            }
        }

<span class="nc bnc" id="L6583" title="All 4 branches missed.">        if (md.contains(MoveStepType.TAKEOFF) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6584">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6585">            a.setCurrentVelocity(1);</span>
<span class="nc" id="L6586">            a.liftOff(1);</span>
<span class="nc bnc" id="L6587" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6588">                applyDropShipProximityDamage(md.getFinalCoords(), true, md.getFinalFacing(), entity);</span>
            }
<span class="nc" id="L6590">            checkForTakeoffDamage(a);</span>
<span class="nc" id="L6591">            entity.setPosition(entity.getPosition().translated(entity.getFacing(), a.getTakeOffLength()));</span>
<span class="nc" id="L6592">            entity.setDone(true);</span>
<span class="nc" id="L6593">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6594">            return;</span>
        }

<span class="nc bnc" id="L6597" title="All 4 branches missed.">        if (md.contains(MoveStepType.VTAKEOFF) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6598">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6599">            rollTarget = a.checkVerticalTakeOff();</span>
<span class="nc bnc" id="L6600" title="All 2 branches missed.">            if (doVerticalTakeOffCheck(entity, rollTarget)) {</span>
<span class="nc" id="L6601">                a.setCurrentVelocity(0);</span>
<span class="nc" id="L6602">                a.liftOff(1);</span>
<span class="nc bnc" id="L6603" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6604">                    applyDropShipProximityDamage(md.getFinalCoords(), (Dropship)a);</span>
                }
<span class="nc" id="L6606">                checkForTakeoffDamage(a);</span>
            }
<span class="nc" id="L6608">            entity.setDone(true);</span>
<span class="nc" id="L6609">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6610">            return;</span>
        }

<span class="nc bnc" id="L6613" title="All 4 branches missed.">        if (md.contains(MoveStepType.LAND) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6614">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6615">            rollTarget = a.checkLanding(md.getLastStepMovementType(), md.getFinalVelocity(),</span>
<span class="nc" id="L6616">                    md.getFinalCoords(), md.getFinalFacing(), false);</span>
<span class="nc" id="L6617">            attemptLanding(entity, rollTarget);</span>
<span class="nc" id="L6618">            a.land();</span>
<span class="nc" id="L6619">            entity.setPosition(md.getFinalCoords().translated(md.getFinalFacing(),</span>
<span class="nc" id="L6620">                    a.getLandingLength()));</span>
<span class="nc" id="L6621">            entity.setDone(true);</span>
<span class="nc" id="L6622">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6623">            return;</span>
        }

<span class="nc bnc" id="L6626" title="All 4 branches missed.">        if (md.contains(MoveStepType.VLAND) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6627">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6628">            rollTarget = a.checkLanding(md.getLastStepMovementType(),</span>
<span class="nc" id="L6629">                    md.getFinalVelocity(), md.getFinalCoords(),</span>
<span class="nc" id="L6630">                    md.getFinalFacing(), true);</span>
<span class="nc" id="L6631">            attemptLanding(entity, rollTarget);</span>
<span class="nc bnc" id="L6632" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6633">                applyDropShipLandingDamage(md.getFinalCoords(), (Dropship)a);</span>
            }
<span class="nc" id="L6635">            a.land();</span>
<span class="nc" id="L6636">            entity.setPosition(md.getFinalCoords());</span>
<span class="nc" id="L6637">            entity.setDone(true);</span>
<span class="nc" id="L6638">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6639">            return;</span>
        }

        // okay, proceed with movement calculations
<span class="nc" id="L6643">        Coords lastPos = entity.getPosition();</span>
<span class="nc" id="L6644">        Coords curPos = entity.getPosition();</span>
<span class="nc" id="L6645">        int curFacing = entity.getFacing();</span>
<span class="nc" id="L6646">        int curVTOLElevation = entity.getElevation();</span>
        int curElevation;
<span class="nc" id="L6648">        int lastElevation = entity.getElevation();</span>
<span class="nc" id="L6649">        int curAltitude = entity.getAltitude();</span>
<span class="nc" id="L6650">        boolean curClimbMode = entity.climbMode();</span>
        // if the entity already used some MPs,
        // it previously tried to get up and fell,
        // and then got another turn. set moveType
        // and overallMoveType accordingly
        // (these are all cleared by Entity.newRound)
<span class="nc" id="L6656">        int distance = entity.delta_distance;</span>
<span class="nc" id="L6657">        int mpUsed = entity.mpUsed;</span>
<span class="nc" id="L6658">        EntityMovementType moveType = entity.moved;</span>
        EntityMovementType overallMoveType;
        boolean firstStep;
<span class="nc" id="L6661">        boolean wasProne = entity.isProne();</span>
<span class="nc" id="L6662">        boolean fellDuringMovement = false;</span>
<span class="nc" id="L6663">        boolean crashedDuringMovement = false;</span>
<span class="nc" id="L6664">        boolean dropshipStillUnloading = false;</span>
        boolean turnOver;
<span class="nc" id="L6666">        int prevFacing = curFacing;</span>
<span class="nc" id="L6667">        IHex prevHex = game.getBoard().getHex(curPos);</span>
<span class="nc" id="L6668">        final boolean isInfantry = entity instanceof Infantry;</span>
<span class="nc" id="L6669">        AttackAction charge = null;</span>
<span class="nc" id="L6670">        RamAttackAction ram = null;</span>
        // cache this here, otherwise changing MP in the turn causes
        // erroneous gravity PSRs
<span class="nc" id="L6673">        int cachedGravityLimit = -1;</span>
<span class="nc" id="L6674">        int thrustUsed = 0;</span>
<span class="nc" id="L6675">        int j = 0;</span>
        boolean didMove;
<span class="nc" id="L6677">        boolean recovered = false;</span>
<span class="nc" id="L6678">        Entity loader = null;</span>
<span class="nc" id="L6679">        boolean continueTurnFromPBS = false;</span>
<span class="nc" id="L6680">        boolean continueTurnFromFishtail = false;</span>
<span class="nc" id="L6681">        boolean continueTurnFromLevelDrop = false;</span>
<span class="nc" id="L6682">        boolean continueTurnFromCliffAscent = false;</span>

        // get a list of coordinates that the unit passed through this turn
        // so that I can later recover potential bombing targets
        // it may already have some values
<span class="nc" id="L6687">        Vector&lt;Coords&gt; passedThrough = entity.getPassedThrough();</span>
<span class="nc" id="L6688">        passedThrough.add(curPos);</span>
<span class="nc" id="L6689">        List&lt;Integer&gt; passedThroughFacing = entity.getPassedThroughFacing();</span>
<span class="nc" id="L6690">        passedThroughFacing.add(curFacing);</span>

        // Compile the move - don't clip
        // Clipping could affect hidden units; illegal steps aren't processed
<span class="nc" id="L6694">        md.compile(game, entity, false);</span>

        // if advanced movement is being used then set the new vectors based on
        // move path
<span class="nc" id="L6698">        entity.setVectors(md.getFinalVectors());</span>

<span class="nc" id="L6700">        overallMoveType = md.getLastStepMovementType();</span>

        // check for starting in liquid magma
<span class="nc" id="L6703">        if ((game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L6704" title="All 2 branches missed.">                .terrainLevel(Terrains.MAGMA) == 2)</span>
<span class="nc bnc" id="L6705" title="All 2 branches missed.">                &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L6706">            doMagmaDamage(entity, false);</span>
        }

        // set acceleration used to default
<span class="nc bnc" id="L6710" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L6711">            ((IAero)entity).setAccLast(false);</span>
        }

        // check for dropping troops and drop them
<span class="nc bnc" id="L6715" title="All 4 branches missed.">        if (entity.isDropping() &amp;&amp; !md.contains(MoveStepType.HOVER)) {</span>
<span class="nc" id="L6716">            entity.setAltitude(entity.getAltitude() - game.getPlanetaryConditions().getDropRate());</span>
            // they may have changed their facing
<span class="nc bnc" id="L6718" title="All 2 branches missed.">            if (md.length() &gt; 0) {</span>
<span class="nc" id="L6719">                entity.setFacing(md.getFinalFacing());</span>
            }
<span class="nc" id="L6721">            passedThrough.add(entity.getPosition());</span>
<span class="nc" id="L6722">            entity.setPassedThrough(passedThrough);</span>
<span class="nc" id="L6723">            passedThroughFacing.add(entity.getFacing());</span>
<span class="nc" id="L6724">            entity.setPassedThroughFacing(passedThroughFacing);</span>
            // We may still need to process any conversions for dropping LAMs
<span class="nc bnc" id="L6726" title="All 4 branches missed.">            if (entity instanceof LandAirMech &amp;&amp; md.contains(MoveStepType.CONVERT_MODE)) {</span>
<span class="nc" id="L6727">                entity.setMovementMode(md.getFinalConversionMode());</span>
<span class="nc" id="L6728">                entity.setConvertingNow(true);</span>
<span class="nc" id="L6729">                r = new Report(1210);</span>
<span class="nc" id="L6730">                r.subject = entity.getId();</span>
<span class="nc" id="L6731">                r.addDesc(entity);</span>
<span class="nc bnc" id="L6732" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L6733">                    r.messageId = 2452;</span>
<span class="nc bnc" id="L6734" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L6735">                    r.messageId = 2453;</span>
                } else {
<span class="nc" id="L6737">                    r.messageId = 2450;</span>
                }
<span class="nc" id="L6739">                addReport(r);</span>
            }
<span class="nc" id="L6741">            entity.setDone(true);</span>
<span class="nc" id="L6742">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6743">            return;</span>
        }
        
        // iterate through steps
<span class="nc" id="L6747">        firstStep = true;</span>
<span class="nc" id="L6748">        turnOver = false;</span>
        /* Bug 754610: Revert fix for bug 702735. */
<span class="nc" id="L6750">        MoveStep prevStep = null;</span>

<span class="nc" id="L6752">        List&lt;Entity&gt; hiddenEnemies = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L6753" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L6754" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L6755" title="All 6 branches missed.">                if (e.isHidden() &amp;&amp; e.isEnemyOf(entity) &amp;&amp; (e.getPosition() != null)) {</span>
<span class="nc" id="L6756">                    hiddenEnemies.add(e);</span>
                }
<span class="nc" id="L6758">            }</span>
        }

<span class="nc" id="L6761">        Vector&lt;UnitLocation&gt; movePath = new Vector&lt;&gt;();</span>
<span class="nc" id="L6762">        EntityMovementType lastStepMoveType = md.getLastStepMovementType();</span>
<span class="nc bnc" id="L6763" title="All 2 branches missed.">        for (final Enumeration&lt;MoveStep&gt; i = md.getSteps(); i.hasMoreElements();) {</span>
<span class="nc" id="L6764">            final MoveStep step = i.nextElement();</span>
<span class="nc" id="L6765">            EntityMovementType stepMoveType = step.getMovementType(md.isEndStep(step));</span>
<span class="nc" id="L6766">            wasProne = entity.isProne();</span>
<span class="nc" id="L6767">            boolean isPavementStep = step.isPavementStep();</span>
<span class="nc" id="L6768">            entity.inReverse = step.isThisStepBackwards();</span>
<span class="nc" id="L6769">            boolean entityFellWhileAttemptingToStand = false;</span>
<span class="nc bnc" id="L6770" title="All 2 branches missed.">            boolean isOnGround = !i.hasMoreElements();</span>
<span class="nc bnc" id="L6771" title="All 2 branches missed.">            isOnGround |= stepMoveType != EntityMovementType.MOVE_JUMP;</span>
<span class="nc bnc" id="L6772" title="All 2 branches missed.">            isOnGround &amp;= step.getElevation() &lt; 1;</span>

            // Check for hidden units point blank shots
<span class="nc bnc" id="L6775" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L6776" title="All 2 branches missed.">                for (Entity e : hiddenEnemies) {</span>
<span class="nc" id="L6777">                    int dist = e.getPosition().distance(step.getPosition());</span>
                    // Checking for same hex and stacking violation
<span class="nc bnc" id="L6779" title="All 4 branches missed.">                    if ((dist == 0) &amp;&amp; !continueTurnFromPBS</span>
<span class="nc bnc" id="L6780" title="All 2 branches missed.">                            &amp;&amp; (Compute.stackingViolation(game, entity.getId(),</span>
<span class="nc" id="L6781">                                    step.getPosition()) != null)) {</span>
                        // Moving into hex of a hidden unit detects the unit
<span class="nc" id="L6783">                        e.setHidden(false);</span>
<span class="nc" id="L6784">                        entityUpdate(e.getId());</span>
<span class="nc" id="L6785">                        r = new Report(9960);</span>
<span class="nc" id="L6786">                        r.addDesc(entity);</span>
<span class="nc" id="L6787">                        r.subject = entity.getId();</span>
<span class="nc" id="L6788">                        r.add(e.getPosition().getBoardNum());</span>
<span class="nc" id="L6789">                        vPhaseReport.addElement(r);</span>
                        // Report the block
<span class="nc bnc" id="L6791" title="All 2 branches missed.">                        if (doBlind()) {</span>
<span class="nc" id="L6792">                            r = new Report(9961);</span>
<span class="nc" id="L6793">                            r.subject = e.getId();</span>
<span class="nc" id="L6794">                            r.addDesc(e);</span>
<span class="nc" id="L6795">                            r.addDesc(entity);</span>
<span class="nc" id="L6796">                            r.add(step.getPosition().getBoardNum());</span>
<span class="nc" id="L6797">                            addReport(r);</span>
                        }
                        // Report halted movement
<span class="nc" id="L6800">                        r = new Report(9962);</span>
<span class="nc" id="L6801">                        r.subject = entity.getId();</span>
<span class="nc" id="L6802">                        r.addDesc(entity);</span>
<span class="nc" id="L6803">                        r.add(step.getPosition().getBoardNum());</span>
<span class="nc" id="L6804">                        addReport(r);</span>
<span class="nc" id="L6805">                        addNewLines();</span>
<span class="nc" id="L6806">                        Report.addNewline(vPhaseReport);</span>
                        // If we aren't at the end, send a special report
<span class="nc bnc" id="L6808" title="All 2 branches missed.">                        if ((game.getTurnIndex() + 1) &lt; game.getTurnVector().size()) {</span>
<span class="nc" id="L6809">                            send(e.getOwner().getId(), createSpecialReportPacket());</span>
<span class="nc" id="L6810">                            send(entity.getOwner().getId(), createSpecialReportPacket());</span>
                        }
<span class="nc" id="L6812">                        entity.setDone(true);</span>
<span class="nc" id="L6813">                        entityUpdate(entity.getId(), movePath, true, losCache);</span>
<span class="nc" id="L6814">                        return;</span>
                        // Potential point-blank shot
<span class="nc bnc" id="L6816" title="All 4 branches missed.">                    } else if ((dist == 1) &amp;&amp; !e.madePointblankShot()) {</span>
<span class="nc" id="L6817">                        entity.setPosition(step.getPosition());</span>
<span class="nc" id="L6818">                        entity.setFacing(step.getFacing());</span>
                        // If not set, BV icons could have wrong facing
<span class="nc" id="L6820">                        entity.setSecondaryFacing(step.getFacing());</span>
                        // Update entity position on client
<span class="nc" id="L6822">                        send(e.getOwnerId(), createEntityPacket(entity.getId(), null));</span>
<span class="nc" id="L6823">                        boolean tookPBS = processPointblankShotCFR(e, entity);</span>
                        // Movement should be interrupted
<span class="nc bnc" id="L6825" title="All 2 branches missed.">                        if (tookPBS) {</span>
                            // Attacking reveals hidden unit
<span class="nc" id="L6827">                            e.setHidden(false);</span>
<span class="nc" id="L6828">                            entityUpdate(e.getId());</span>
<span class="nc" id="L6829">                            r = new Report(9960);</span>
<span class="nc" id="L6830">                            r.addDesc(entity);</span>
<span class="nc" id="L6831">                            r.subject = entity.getId();</span>
<span class="nc" id="L6832">                            r.add(e.getPosition().getBoardNum());</span>
<span class="nc" id="L6833">                            vPhaseReport.addElement(r);</span>
<span class="nc" id="L6834">                            continueTurnFromPBS = true;</span>

<span class="nc" id="L6836">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6837">                            curPos = entity.getPosition();</span>
<span class="nc" id="L6838">                            mpUsed = step.getMpUsed();</span>
<span class="nc" id="L6839">                            break;</span>
                        }
                    }
<span class="nc" id="L6842">                }</span>
            }

            // stop for illegal movement
<span class="nc bnc" id="L6846" title="All 2 branches missed.">            if (stepMoveType == EntityMovementType.MOVE_ILLEGAL) {</span>
<span class="nc" id="L6847">                break;</span>
            }

            // stop if the entity already killed itself
<span class="nc bnc" id="L6851" title="All 4 branches missed.">            if (entity.isDestroyed() || entity.isDoomed()) {</span>
<span class="nc" id="L6852">                break;</span>
            }

<span class="nc bnc" id="L6855" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L6856" title="All 4 branches missed.">                if (step.getType() == MoveStepType.UP &amp;&amp; !entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L6857">                    entity.setWigeLiftoffHover(true);</span>
<span class="nc bnc" id="L6858" title="All 2 branches missed.">                } else if (step.getType() == MoveStepType.HOVER) {</span>
<span class="nc" id="L6859">                    entity.setWigeLiftoffHover(true);</span>
<span class="nc" id="L6860">                    entity.setAssaultDropInProgress(false);</span>
<span class="nc bnc" id="L6861" title="All 4 branches missed.">                } else if (step.getType() == MoveStepType.DOWN &amp;&amp; step.getClearance() == 0) {</span>
                    // If this is the first step, use the Entity's starting elevation
<span class="nc bnc" id="L6863" title="All 2 branches missed.">                    int elevation = (prevStep == null) ? entity.getElevation() : prevStep.getElevation();</span>
<span class="nc bnc" id="L6864" title="All 2 branches missed.">                    if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L6865">                        addReport(landAirMech((LandAirMech) entity, step.getPosition(), elevation,</span>
                                distance));
<span class="nc bnc" id="L6867" title="All 2 branches missed.">                    } else if (entity instanceof Protomech) {</span>
<span class="nc" id="L6868">                        addReport(landGliderPM((Protomech) entity, step.getPosition(), elevation,</span>
                                distance));
                    }
                    // landing always ends movement whether successful or not
                }
            }

            // check for MASC failure on first step
            // also check Tanks because they can have superchargers that act
            // like MASc
<span class="nc bnc" id="L6878" title="All 6 branches missed.">            if (firstStep &amp;&amp; ((entity instanceof Mech) || (entity instanceof Tank))) {</span>
                // Not necessarily a fall, but we need to give them a new turn to plot movement with
                // likely reduced MP.
<span class="nc" id="L6881">                fellDuringMovement = checkMASCFailure(entity, md);</span>
            }

<span class="nc bnc" id="L6884" title="All 2 branches missed.">            if (firstStep) {</span>
<span class="nc" id="L6885">                rollTarget = entity.checkGunningIt(overallMoveType);</span>
<span class="nc bnc" id="L6886" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6887">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L6889" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
                        // Since this is the first step, we don't have a previous step so we'll pass
                        // this one in case it's needed to process a skid.
<span class="nc bnc" id="L6892" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos, 0, step,</span>
<span class="nc" id="L6893">                                step.isThisStepBackwards(), lastStepMoveType, distance, 2, mof)) {</span>
<span class="nc bnc" id="L6894" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L6895">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L6897">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L6900">                            turnOver = true;</span>
<span class="nc" id="L6901">                            distance = entity.delta_distance;</span>
<span class="nc" id="L6902">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6903">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6904">                            break;</span>
<span class="nc bnc" id="L6905" title="All 2 branches missed.">                        } else if (entity.getFacing() != curFacing) {</span>
                            // If the facing doesn't change we had a minor fishtail that doesn't require
                            // stopping movement.
<span class="nc" id="L6908">                            continueTurnFromFishtail = true;</span>
<span class="nc" id="L6909">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6910">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6911">                            break;</span>
                        }
                    }
                }
            }

            // Check for failed maneuver for overdrive on first step. The rules for overdrive do not
            // state this explicitly, but since combining overdrive with gunning it requires two rolls
            // and gunning does state explicitly that the roll is made before movement, this
            // implies the same for overdrive.
<span class="nc bnc" id="L6921" title="All 6 branches missed.">            if (firstStep &amp;&amp; (overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                    || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L6923">                rollTarget = entity.checkUsingOverdrive(EntityMovementType.MOVE_SPRINT);</span>
<span class="nc bnc" id="L6924" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6925">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L6927" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
<span class="nc bnc" id="L6928" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos, 0, step, step.isThisStepBackwards(),</span>
                                lastStepMoveType, distance, 2, mof)) {
<span class="nc bnc" id="L6930" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L6931">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L6933">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L6936">                            turnOver = true;</span>
<span class="nc" id="L6937">                            distance = entity.delta_distance;</span>
<span class="nc" id="L6938">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6939">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6940">                            break;</span>
<span class="nc bnc" id="L6941" title="All 2 branches missed.">                        } else if (entity.getFacing() != curFacing) {</span>
                            // If the facing doesn't change we had a minor fishtail that doesn't require
                            // stopping movement.
<span class="nc" id="L6944">                            continueTurnFromFishtail = true;</span>
<span class="nc" id="L6945">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6946">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6947">                            break;</span>
                        }
                    }
                }
            }

<span class="nc bnc" id="L6953" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L6954">                entity.setConvertingNow(true);</span>

                // Non-omni QuadVees converting to vehicle mode dump any riding BA in the
                // starting hex if they fail to make an anti-mech check.
                // http://bg.battletech.com/forums/index.php?topic=55263.msg1271423#msg1271423
<span class="nc bnc" id="L6959" title="All 4 branches missed.">                if (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_MECH</span>
<span class="nc bnc" id="L6960" title="All 2 branches missed.">                        &amp;&amp; !entity.isOmni()) {</span>
<span class="nc bnc" id="L6961" title="All 2 branches missed.">                    for (Entity rider : entity.getExternalUnits()) {</span>
<span class="nc" id="L6962">                        addReport(checkDropBAFromConverting(entity, rider, curPos, curFacing,</span>
                                false, false, false));
<span class="nc" id="L6964">                    }</span>
<span class="nc bnc" id="L6965" title="All 2 branches missed.">                } else if ((entity.getEntityType() &amp; Entity.ETYPE_LAND_AIR_MECH) != 0) {</span>
                    //External units on LAMs, including swarmers, fall automatically and take damage,
                    //and the LAM itself may take one or more criticals.
<span class="nc bnc" id="L6968" title="All 2 branches missed.">                    for (Entity rider : entity.getExternalUnits()) {</span>
<span class="nc" id="L6969">                        addReport(checkDropBAFromConverting(entity, rider, curPos, curFacing, true, true, true));</span>
<span class="nc" id="L6970">                    }</span>
<span class="nc" id="L6971">                    final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L6972" title="All 2 branches missed.">                    if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L6973">                        addReport(checkDropBAFromConverting(entity, game.getEntity(swarmerId),</span>
                                curPos, curFacing, true, true, true));
                    }
<span class="nc" id="L6976">                }</span>

                continue;
            }

            // did the entity move?
<span class="nc bnc" id="L6982" title="All 2 branches missed.">            didMove = step.getDistance() &gt; distance;</span>

            // check for aero stuff
<span class="nc bnc" id="L6985" title="All 4 branches missed.">            if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6986">                IAero a = (IAero) entity;</span>
<span class="nc" id="L6987">                j++;</span>

                // increment straight moves (can't do it at end, because not all
                // steps may be processed)
<span class="nc" id="L6991">                a.setStraightMoves(step.getNStraight());</span>

                // TODO : change the way this check is made
<span class="nc bnc" id="L6994" title="All 4 branches missed.">                if (!didMove &amp;&amp; (md.length() != j)) {</span>
<span class="nc" id="L6995">                    thrustUsed += step.getMp();</span>
                } else {
                    // if this was the last move and distance was zero, then add
                    // thrust
<span class="nc bnc" id="L6999" title="All 4 branches missed.">                    if (!didMove &amp;&amp; (md.length() == j)) {</span>
<span class="nc" id="L7000">                        thrustUsed += step.getMp();</span>
                    }
                    // then we moved to a new hex or the last step so check
                    // conditions
                    // structural damage
<span class="nc" id="L7005">                    rollTarget = a.checkThrustSI(thrustUsed, overallMoveType);</span>
<span class="nc bnc" id="L7006" title="All 4 branches missed.">                    if ((rollTarget.getValue() != TargetRoll.CHECK_FALSE)</span>
<span class="nc bnc" id="L7007" title="All 2 branches missed.">                            &amp;&amp; !(entity instanceof FighterSquadron) &amp;&amp; !game.useVectorMove()) {</span>
<span class="nc bnc" id="L7008" title="All 2 branches missed.">                        if (!doSkillCheckInSpace(entity, rollTarget)) {</span>
<span class="nc" id="L7009">                            a.setSI(a.getSI() - 1);</span>
<span class="nc bnc" id="L7010" title="All 2 branches missed.">                            if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L7011">                                addReport(criticalEntity(entity, Mech.LOC_CT, false, 0, 1));</span>
                            }
                            // check for destruction
<span class="nc bnc" id="L7014" title="All 2 branches missed.">                            if (a.getSI() == 0) {</span>
                                // Lets auto-eject if we can!
<span class="nc bnc" id="L7016" title="All 2 branches missed.">                                if (a instanceof LandAirMech) {</span>
                                    // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L7018">                                    LandAirMech lam = (LandAirMech) a;</span>
<span class="nc bnc" id="L7019" title="All 2 branches missed.">                                    if (lam.isAutoEject()</span>
<span class="nc bnc" id="L7020" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7021" title="All 2 branches missed.">                                                || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7022" title="All 2 branches missed.">                                                        &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L7023">                                        addReport(ejectEntity(entity, true, false));</span>
                                    }
<span class="nc" id="L7025">                                } else {</span>
                                    // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L7027">                                    Aero aero = (Aero) a;</span>
<span class="nc bnc" id="L7028" title="All 2 branches missed.">                                    if (aero.isAutoEject()</span>
<span class="nc bnc" id="L7029" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7030" title="All 2 branches missed.">                                                || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7031" title="All 2 branches missed.">                                                        &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L7032">                                        addReport(ejectEntity(entity, true, false));</span>
                                    }
                                }
<span class="nc" id="L7035">                                addReport(destroyEntity(entity, &quot;Structural Integrity Collapse&quot;,</span>
                                        false));
                            }
                        }
                    }

                    // check for pilot damage
<span class="nc" id="L7042">                    int hits = entity.getCrew().getHits();</span>
<span class="nc" id="L7043">                    int health = 6 - hits;</span>

<span class="nc bnc" id="L7045" title="All 6 branches missed.">                    if ((thrustUsed &gt; (2 * health)) &amp;&amp; !game.useVectorMove()</span>
                            &amp;&amp; !(entity instanceof TeleMissile)) {
<span class="nc" id="L7047">                        int targetRoll = 2 + (thrustUsed - (2 * health))</span>
                                + (2 * hits);
<span class="nc" id="L7049">                        resistGForce(entity, targetRoll);</span>
                    }

<span class="nc" id="L7052">                    thrustUsed = 0;</span>
                }

<span class="nc bnc" id="L7055" title="All 2 branches missed.">                if (step.getType() == MoveStepType.RETURN) {</span>
<span class="nc" id="L7056">                    a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7057">                    entity.setAltitude(curAltitude);</span>
<span class="nc" id="L7058">                    processLeaveMap(md, true, Compute.roundsUntilReturn(game, entity));</span>
<span class="nc" id="L7059">                    return;</span>
                }

<span class="nc bnc" id="L7062" title="All 2 branches missed.">                if (step.getType() == MoveStepType.OFF) {</span>
<span class="nc" id="L7063">                    a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7064">                    entity.setAltitude(curAltitude);</span>
<span class="nc" id="L7065">                    processLeaveMap(md, true, -1);</span>
<span class="nc" id="L7066">                    return;</span>
                }

<span class="nc" id="L7069">                rollTarget = a.checkRolls(step, overallMoveType);</span>
<span class="nc bnc" id="L7070" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7071">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0, &quot;excess roll&quot;));</span>
                }

<span class="nc" id="L7074">                rollTarget = a.checkManeuver(step, overallMoveType);</span>
<span class="nc bnc" id="L7075" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L7076" title="All 2 branches missed.">                    if (!doSkillCheckManeuver(entity, rollTarget)) {</span>
<span class="nc" id="L7077">                        a.setFailedManeuver(true);</span>
<span class="nc" id="L7078">                        int forward = Math.max(step.getVelocityLeft() / 2, 1);</span>
<span class="nc bnc" id="L7079" title="All 2 branches missed.">                        if (forward &lt; step.getVelocityLeft()) {</span>
<span class="nc" id="L7080">                            fellDuringMovement = true;</span>
                        }
                        // multiply forward by 16 when on ground hexes
<span class="nc bnc" id="L7083" title="All 2 branches missed.">                        if (game.getBoard().onGround()) {</span>
<span class="nc" id="L7084">                            forward *= 16;</span>
                        }
<span class="nc bnc" id="L7086" title="All 2 branches missed.">                        while (forward &gt; 0) {</span>
<span class="nc" id="L7087">                            curPos = curPos.translated(step.getFacing());</span>
<span class="nc" id="L7088">                            forward--;</span>
<span class="nc" id="L7089">                            distance++;</span>
<span class="nc" id="L7090">                            a.setStraightMoves(a.getStraightMoves() + 1);</span>
                            // make sure it didn't fly off the map
<span class="nc bnc" id="L7092" title="All 2 branches missed.">                            if (!game.getBoard().contains(curPos)) {</span>
<span class="nc" id="L7093">                                a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7094">                                processLeaveMap(md, true, Compute.roundsUntilReturn(game, entity));</span>
<span class="nc" id="L7095">                                return;</span>
                                // make sure it didn't crash
<span class="nc bnc" id="L7097" title="All 2 branches missed.">                            } else if (checkCrash(entity, curPos, step.getAltitude())) {</span>
<span class="nc" id="L7098">                                addReport(processCrash(entity, step.getVelocity(), curPos));</span>
<span class="nc" id="L7099">                                forward = 0;</span>
<span class="nc" id="L7100">                                fellDuringMovement = false;</span>
<span class="nc" id="L7101">                                crashedDuringMovement = true;</span>
                            }
                        }
                        break;
                    }
                }

                // if out of control, check for possible collision
<span class="nc bnc" id="L7109" title="All 4 branches missed.">                if (didMove &amp;&amp; a.isOutControlTotal()) {</span>
<span class="nc" id="L7110">                    Iterator&lt;Entity&gt; targets = game.getEntities(step.getPosition());</span>
<span class="nc bnc" id="L7111" title="All 2 branches missed.">                    if (targets.hasNext()) {</span>
                        // Somebody here so check to see if there is a collision
<span class="nc" id="L7113">                        int checkRoll = Compute.d6(2);</span>
                        // TODO : change this to 11 for Large Craft
<span class="nc" id="L7115">                        int targetRoll = 11;</span>
<span class="nc bnc" id="L7116" title="All 4 branches missed.">                        if ((a instanceof Dropship) || (entity instanceof Jumpship)) {</span>
<span class="nc" id="L7117">                            targetRoll = 10;</span>
                        }
<span class="nc bnc" id="L7119" title="All 2 branches missed.">                        if (checkRoll &gt;= targetRoll) {</span>
                            // this gets complicated, I need to check for each
                            // unit type
                            // by order of movement sub-phase
<span class="nc" id="L7123">                            Vector&lt;Integer&gt; potentialSpaceStation = new Vector&lt;&gt;();</span>
<span class="nc" id="L7124">                            Vector&lt;Integer&gt; potentialWarShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7125">                            Vector&lt;Integer&gt; potentialJumpShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7126">                            Vector&lt;Integer&gt; potentialDropShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7127">                            Vector&lt;Integer&gt; potentialSmallCraft = new Vector&lt;&gt;();</span>
<span class="nc" id="L7128">                            Vector&lt;Integer&gt; potentialASF = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L7130" title="All 2 branches missed.">                            while (targets.hasNext()) {</span>
<span class="nc" id="L7131">                                int id = targets.next().getId();</span>
<span class="nc" id="L7132">                                Entity ce = game.getEntity(id);</span>
                                // if we are in atmosphere and not the same altitude
                                // then skip
<span class="nc bnc" id="L7135" title="All 4 branches missed.">                                if (!game.getBoard().inSpace() &amp;&amp; (ce.getAltitude() != curAltitude)) {</span>
<span class="nc" id="L7136">                                    continue;</span>
                                }
                                // you can't collide with yourself
<span class="nc bnc" id="L7139" title="All 2 branches missed.">                                if (ce.equals(a)) {</span>
<span class="nc" id="L7140">                                    continue;</span>
                                }
<span class="nc bnc" id="L7142" title="All 2 branches missed.">                                if (ce instanceof SpaceStation) {</span>
<span class="nc" id="L7143">                                    potentialSpaceStation.addElement(id);</span>
<span class="nc bnc" id="L7144" title="All 2 branches missed.">                                } else if (ce instanceof Warship) {</span>
<span class="nc" id="L7145">                                    potentialWarShip.addElement(id);</span>
<span class="nc bnc" id="L7146" title="All 2 branches missed.">                                } else if (ce instanceof Jumpship) {</span>
<span class="nc" id="L7147">                                    potentialJumpShip.addElement(id);</span>
<span class="nc bnc" id="L7148" title="All 2 branches missed.">                                } else if (ce instanceof Dropship) {</span>
<span class="nc" id="L7149">                                    potentialDropShip.addElement(id);</span>
<span class="nc bnc" id="L7150" title="All 2 branches missed.">                                } else if (ce instanceof SmallCraft) {</span>
<span class="nc" id="L7151">                                    potentialSmallCraft.addElement(id);</span>
                                } else {
                                    // ASF can actually include anything,
                                    // because we might
                                    // have combat dropping troops
<span class="nc" id="L7156">                                    potentialASF.addElement(id);</span>
                                }
<span class="nc" id="L7158">                            }</span>

                            // ok now go through and see if these have anybody in them
                            int chosen;
                            Entity target;
                            Coords destination;

<span class="nc bnc" id="L7165" title="All 2 branches missed.">                            if (potentialSpaceStation.size() &gt; 0) {</span>
<span class="nc" id="L7166">                                chosen = Compute.randomInt(potentialSpaceStation.size());</span>
<span class="nc" id="L7167">                                target = game.getEntity(potentialSpaceStation.elementAt(chosen));</span>
<span class="nc" id="L7168">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7169" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7170">                                    curPos = destination;</span>
<span class="nc" id="L7171">                                    break;</span>
                                }
<span class="nc bnc" id="L7173" title="All 2 branches missed.">                            } else if (potentialWarShip.size() &gt; 0) {</span>
<span class="nc" id="L7174">                                chosen = Compute.randomInt(potentialWarShip.size());</span>
<span class="nc" id="L7175">                                target = game.getEntity(potentialWarShip.elementAt(chosen));</span>
<span class="nc" id="L7176">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7177" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7178">                                    curPos = destination;</span>
<span class="nc" id="L7179">                                    break;</span>
                                }
<span class="nc bnc" id="L7181" title="All 2 branches missed.">                            } else if (potentialJumpShip.size() &gt; 0) {</span>
<span class="nc" id="L7182">                                chosen = Compute.randomInt(potentialJumpShip.size());</span>
<span class="nc" id="L7183">                                target = game.getEntity(potentialJumpShip.elementAt(chosen));</span>
<span class="nc" id="L7184">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7185" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7186">                                    curPos = destination;</span>
<span class="nc" id="L7187">                                    break;</span>
                                }
<span class="nc bnc" id="L7189" title="All 2 branches missed.">                            } else if (potentialDropShip.size() &gt; 0) {</span>
<span class="nc" id="L7190">                                chosen = Compute.randomInt(potentialDropShip.size());</span>
<span class="nc" id="L7191">                                target = game.getEntity(potentialDropShip.elementAt(chosen));</span>
<span class="nc" id="L7192">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7193" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7194">                                    curPos = destination;</span>
<span class="nc" id="L7195">                                    break;</span>
                                }
<span class="nc bnc" id="L7197" title="All 2 branches missed.">                            } else if (potentialSmallCraft.size() &gt; 0) {</span>
<span class="nc" id="L7198">                                chosen = Compute.randomInt(potentialSmallCraft.size());</span>
<span class="nc" id="L7199">                                target = game.getEntity(potentialSmallCraft.elementAt(chosen));</span>
<span class="nc" id="L7200">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7201" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7202">                                    curPos = destination;</span>
<span class="nc" id="L7203">                                    break;</span>
                                }
<span class="nc bnc" id="L7205" title="All 2 branches missed.">                            } else if (potentialASF.size() &gt; 0) {</span>
<span class="nc" id="L7206">                                chosen = Compute.randomInt(potentialASF.size());</span>
<span class="nc" id="L7207">                                target = game.getEntity(potentialASF.elementAt(chosen));</span>
<span class="nc" id="L7208">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7209" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7210">                                    curPos = destination;</span>
<span class="nc" id="L7211">                                    break;</span>
                                }
                            }

                        }
                    }
                }

                // if in the atmosphere, check for a potential crash

<span class="nc bnc" id="L7221" title="All 2 branches missed.">                if (checkCrash(entity, step.getPosition(), step.getAltitude())) {</span>
<span class="nc" id="L7222">                    addReport(processCrash(entity, md.getFinalVelocity(), curPos));</span>
<span class="nc" id="L7223">                    crashedDuringMovement = true;</span>
                    // don't do the rest
<span class="nc" id="L7225">                    break;</span>
                }

                // handle fighter launching
<span class="nc bnc" id="L7229" title="All 2 branches missed.">                if (step.getType() == MoveStepType.LAUNCH) {</span>
<span class="nc" id="L7230">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = step.getLaunched();</span>
<span class="nc" id="L7231">                    Set&lt;Integer&gt; bays = launched.keySet();</span>
<span class="nc" id="L7232">                    Iterator&lt;Integer&gt; bayIter = bays.iterator();</span>
                    Bay currentBay;
<span class="nc bnc" id="L7234" title="All 2 branches missed.">                    while (bayIter.hasNext()) {</span>
<span class="nc" id="L7235">                        int bayId = bayIter.next();</span>
<span class="nc" id="L7236">                        currentBay = entity.getFighterBays().elementAt(bayId);</span>
<span class="nc" id="L7237">                        Vector&lt;Integer&gt; launches = launched.get(bayId);</span>
<span class="nc" id="L7238">                        int nLaunched = launches.size();</span>
                        // need to make some decisions about how to handle the
                        // distribution
                        // of fighters to doors beyond the launch rate. The most
                        // sensible thing
                        // is probably to distribute them evenly.
<span class="nc" id="L7244">                        int doors = currentBay.getCurrentDoors();</span>
<span class="nc" id="L7245">                        int[] distribution = new int[doors];</span>
<span class="nc bnc" id="L7246" title="All 2 branches missed.">                        for (int l = 0; l &lt; nLaunched; l++) {</span>
<span class="nc" id="L7247">                            distribution[l % doors] = distribution[l % doors] + 1;</span>
                        }
                        // ok, now lets launch them
<span class="nc" id="L7250">                        r = new Report(9380);</span>
<span class="nc" id="L7251">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7252">                        r.subject = entity.getId();</span>
<span class="nc" id="L7253">                        r.add(nLaunched);</span>
<span class="nc" id="L7254">                        r.add(&quot;bay &quot; + currentBay.getBayNumber() + &quot; (&quot; + doors + &quot; doors)&quot;);</span>
<span class="nc" id="L7255">                        addReport(r);</span>
<span class="nc" id="L7256">                        int currentDoor = 0;</span>
<span class="nc" id="L7257">                        int fighterCount = 0;</span>
<span class="nc" id="L7258">                        boolean doorDamage = false;</span>
<span class="nc bnc" id="L7259" title="All 2 branches missed.">                        for (int fighterId : launches) {</span>
                            // check to see if we are in the same door
<span class="nc" id="L7261">                            fighterCount++;</span>

                            // check for door damage
<span class="nc" id="L7264">                            Report doorReport = null;</span>
<span class="nc bnc" id="L7265" title="All 6 branches missed.">                            if (!doorDamage &amp;&amp; (distribution[currentDoor] &gt; 2) &amp;&amp; (fighterCount &gt; 2)) {</span>
<span class="nc" id="L7266">                                doorReport = new Report(9378);</span>
<span class="nc" id="L7267">                                doorReport.subject = entity.getId();</span>
<span class="nc" id="L7268">                                doorReport.indent(2);</span>
<span class="nc" id="L7269">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L7270">                                doorReport.add(roll);</span>
<span class="nc bnc" id="L7271" title="All 2 branches missed.">                                if (roll == 2) {</span>
<span class="nc" id="L7272">                                    doorDamage = true;</span>
<span class="nc" id="L7273">                                    doorReport.choose(true);</span>
<span class="nc" id="L7274">                                    currentBay.destroyDoorNext();</span>
                                } else {
<span class="nc" id="L7276">                                    doorReport.choose(false);</span>
                                }
<span class="nc" id="L7278">                                doorReport.newlines++;</span>
                            }

<span class="nc bnc" id="L7281" title="All 2 branches missed.">                            if (fighterCount &gt; distribution[currentDoor]) {</span>
                                // move to a new door
<span class="nc" id="L7283">                                currentDoor++;</span>
<span class="nc" id="L7284">                                fighterCount = 0;</span>
<span class="nc" id="L7285">                                doorDamage = false;</span>
                            }
<span class="nc" id="L7287">                            int bonus = Math.max(0,</span>
                                    distribution[currentDoor] - 2);

<span class="nc" id="L7290">                            Entity fighter = game.getEntity(fighterId);</span>
<span class="nc bnc" id="L7291" title="All 2 branches missed.">                            if (!launchUnit(entity, fighter, curPos, curFacing, step.getVelocity(),</span>
<span class="nc" id="L7292">                                    step.getAltitude(), step.getVectors(), bonus)) {</span>
<span class="nc" id="L7293">                                MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L7294">                                        + fighter.getDisplayName() + &quot; from &quot; + entity.getDisplayName()</span>
<span class="nc" id="L7295">                                        + &quot; into &quot; + curPos.getBoardNum());</span>
                            }
<span class="nc bnc" id="L7297" title="All 2 branches missed.">                            if (doorReport != null) {</span>
<span class="nc" id="L7298">                                addReport(doorReport);</span>
                            }
<span class="nc" id="L7300">                        }</span>
<span class="nc" id="L7301">                    }</span>
                    // now apply any damage to bay doors
<span class="nc" id="L7303">                    entity.resetBayDoors();</span>
                }

                // handle DropShip undocking
<span class="nc bnc" id="L7307" title="All 2 branches missed.">                if (step.getType() == MoveStepType.UNDOCK) {</span>
<span class="nc" id="L7308">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = step.getLaunched();</span>
<span class="nc" id="L7309">                    Set&lt;Integer&gt; collars = launched.keySet();</span>
<span class="nc" id="L7310">                    Iterator&lt;Integer&gt; collarIter = collars.iterator();</span>
<span class="nc bnc" id="L7311" title="All 2 branches missed.">                    while (collarIter.hasNext()) {</span>
<span class="nc" id="L7312">                        int collarId = collarIter.next();</span>
<span class="nc" id="L7313">                        Vector&lt;Integer&gt; launches = launched.get(collarId);</span>
<span class="nc" id="L7314">                        int nLaunched = launches.size();</span>
                        // ok, now lets launch them
<span class="nc" id="L7316">                        r = new Report(9380);</span>
<span class="nc" id="L7317">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7318">                        r.subject = entity.getId();</span>
<span class="nc" id="L7319">                        r.add(nLaunched);</span>
<span class="nc" id="L7320">                        r.add(&quot;collar &quot; + collarId);</span>
<span class="nc" id="L7321">                        addReport(r);</span>
<span class="nc bnc" id="L7322" title="All 2 branches missed.">                        for (int dropShipId : launches) {</span>
                            // check to see if we are in the same door
<span class="nc" id="L7324">                            Entity ds = game.getEntity(dropShipId);</span>
<span class="nc bnc" id="L7325" title="All 2 branches missed.">                            if (!launchUnit(entity, ds, curPos, curFacing,</span>
<span class="nc" id="L7326">                                    step.getVelocity(), step.getAltitude(),</span>
<span class="nc" id="L7327">                                    step.getVectors(), 0)) {</span>
<span class="nc" id="L7328">                                MegaMek.getLogger().error(&quot;Error! Server was told to unload &quot;</span>
<span class="nc" id="L7329">                                                + ds.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L7330">                                                + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L7331">                                                + curPos.getBoardNum());</span>
                            }
<span class="nc" id="L7333">                        }</span>
<span class="nc" id="L7334">                    }</span>
                }

                // handle combat drops
<span class="nc bnc" id="L7338" title="All 2 branches missed.">                if (step.getType() == MoveStepType.DROP) {</span>
<span class="nc" id="L7339">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; dropped = step.getLaunched();</span>
<span class="nc" id="L7340">                    Set&lt;Integer&gt; bays = dropped.keySet();</span>
<span class="nc" id="L7341">                    Iterator&lt;Integer&gt; bayIter = bays.iterator();</span>
                    Bay currentBay;
<span class="nc bnc" id="L7343" title="All 2 branches missed.">                    while (bayIter.hasNext()) {</span>
<span class="nc" id="L7344">                        int bayId = bayIter.next();</span>
<span class="nc" id="L7345">                        currentBay = entity.getTransportBays().elementAt(bayId);</span>
<span class="nc" id="L7346">                        Vector&lt;Integer&gt; drops = dropped.get(bayId);</span>
<span class="nc" id="L7347">                        int nDropped = drops.size();</span>
                        // ok, now lets drop them
<span class="nc" id="L7349">                        r = new Report(9386);</span>
<span class="nc" id="L7350">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7351">                        r.subject = entity.getId();</span>
<span class="nc" id="L7352">                        r.add(nDropped);</span>
<span class="nc" id="L7353">                        addReport(r);</span>
<span class="nc bnc" id="L7354" title="All 2 branches missed.">                        for (int unitId : drops) {</span>
<span class="nc bnc" id="L7355" title="All 2 branches missed.">                            if (Compute.d6(2) == 2) {</span>
<span class="nc" id="L7356">                                r = new Report(9390);</span>
<span class="nc" id="L7357">                                r.subject = entity.getId();</span>
<span class="nc" id="L7358">                                r.indent(1);</span>
<span class="nc" id="L7359">                                r.add(currentBay.getType());</span>
<span class="nc" id="L7360">                                addReport(r);</span>
<span class="nc" id="L7361">                                currentBay.destroyDoorNext();</span>
                            }
<span class="nc" id="L7363">                            Entity drop = game.getEntity(unitId);</span>
<span class="nc" id="L7364">                            dropUnit(drop, entity, curPos, step.getAltitude());</span>
<span class="nc" id="L7365">                        }</span>
<span class="nc" id="L7366">                    }</span>
                    // now apply any damage to bay doors
<span class="nc" id="L7368">                    entity.resetBayDoors();</span>
                }
            }

            // check piloting skill for getting up
<span class="nc" id="L7373">            rollTarget = entity.checkGetUp(step, overallMoveType);</span>

<span class="nc bnc" id="L7375" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Unless we're an ICE- or fuel cell-powered IndustrialMech,
                // standing up builds heat.
<span class="nc bnc" id="L7378" title="All 6 branches missed.">                if ((entity instanceof Mech) &amp;&amp; entity.hasEngine() &amp;&amp; !(((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L7379" title="All 2 branches missed.">                        &amp;&amp; ((entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)</span>
<span class="nc bnc" id="L7380" title="All 2 branches missed.">                                || (entity.getEngine().getEngineType() == Engine.FUEL_CELL)))) {</span>
<span class="nc" id="L7381">                    entity.heatBuildup += 1;</span>
                }
<span class="nc" id="L7383">                entity.setProne(false);</span>
                // entity.setHullDown(false);
<span class="nc" id="L7385">                wasProne = false;</span>
<span class="nc" id="L7386">                game.resetPSRs(entity);</span>
<span class="nc bnc" id="L7387" title="All 2 branches missed.">                entityFellWhileAttemptingToStand = !doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // did the entity just fall?
<span class="nc bnc" id="L7390" title="All 2 branches missed.">            if (entityFellWhileAttemptingToStand) {</span>
<span class="nc" id="L7391">                moveType = stepMoveType;</span>
<span class="nc" id="L7392">                curFacing = entity.getFacing();</span>
<span class="nc" id="L7393">                curPos = entity.getPosition();</span>
<span class="nc" id="L7394">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L7395">                fellDuringMovement = true;</span>
<span class="nc bnc" id="L7396" title="All 2 branches missed.">                if (!entity.isCarefulStand()) {</span>
<span class="nc" id="L7397">                    break;</span>
                }
<span class="nc bnc" id="L7399" title="All 2 branches missed.">            } else if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7400">                entity.setHullDown(false);</span>
            }

<span class="nc bnc" id="L7403" title="All 2 branches missed.">            if (step.getType() == MoveStepType.UNJAM_RAC) {</span>
<span class="nc" id="L7404">                entity.setUnjammingRAC(true);</span>
<span class="nc" id="L7405">                game.addAction(new UnjamAction(entity.getId()));</span>

                // for Aeros this will end movement prematurely
                // if we break
<span class="nc bnc" id="L7409" title="All 2 branches missed.">                if (!(entity.isAirborne())) {</span>
<span class="nc" id="L7410">                    break;</span>
                }
            }

<span class="nc bnc" id="L7414" title="All 2 branches missed.">            if (step.getType() == MoveStepType.LAY_MINE) {</span>
<span class="nc" id="L7415">                layMine(entity, step.getMineToLay(), step.getPosition());</span>
<span class="nc" id="L7416">                continue;</span>
            }

<span class="nc bnc" id="L7419" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CLEAR_MINEFIELD) {</span>
<span class="nc" id="L7420">                ClearMinefieldAction cma = new ClearMinefieldAction(entity.getId(), step.getMinefield());</span>
<span class="nc" id="L7421">                entity.setClearingMinefield(true);</span>
<span class="nc" id="L7422">                game.addAction(cma);</span>
<span class="nc" id="L7423">                break;</span>
            }

<span class="nc bnc" id="L7426" title="All 2 branches missed.">            if ((step.getType() == MoveStepType.SEARCHLIGHT)</span>
<span class="nc bnc" id="L7427" title="All 2 branches missed.">                    &amp;&amp; entity.hasSpotlight()) {</span>
<span class="nc bnc" id="L7428" title="All 2 branches missed.">                final boolean SearchOn = !entity.isUsingSpotlight();</span>
<span class="nc" id="L7429">                entity.setSpotlightState(SearchOn);</span>
<span class="nc bnc" id="L7430" title="All 2 branches missed.">                if (doBlind()) { // if double blind, we may need to filter the</span>
                    // players that receive this message
<span class="nc" id="L7432">                    Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc" id="L7433">                    Vector&lt;IPlayer&gt; vCanSee = whoCanSee(entity);</span>
<span class="nc bnc" id="L7434" title="All 2 branches missed.">                    for (IPlayer p : playersVector) {</span>
<span class="nc bnc" id="L7435" title="All 2 branches missed.">                        if (vCanSee.contains(p)) { // Player sees the unit</span>
<span class="nc" id="L7436">                            sendServerChat(p.getId(),</span>
<span class="nc" id="L7437">                                    entity.getDisplayName()</span>
                                            + &quot; switched searchlight &quot;
<span class="nc bnc" id="L7439" title="All 2 branches missed.">                                            + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                        } else {
<span class="nc" id="L7441">                            sendServerChat(p.getId(),</span>
                                    &quot;An unseen unit&quot; + &quot; switched searchlight &quot;
<span class="nc bnc" id="L7443" title="All 2 branches missed.">                                            + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                        }
<span class="nc" id="L7445">                    }</span>
<span class="nc" id="L7446">                } else { // No double blind, everyone can see this</span>
<span class="nc" id="L7447">                    sendServerChat(</span>
<span class="nc" id="L7448">                            entity.getDisplayName() + &quot; switched searchlight &quot;</span>
<span class="nc bnc" id="L7449" title="All 2 branches missed.">                                    + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                }
            }

            // set most step parameters
<span class="nc" id="L7454">            moveType = stepMoveType;</span>
<span class="nc" id="L7455">            distance = step.getDistance();</span>
<span class="nc" id="L7456">            mpUsed = step.getMpUsed();</span>

<span class="nc bnc" id="L7458" title="All 2 branches missed.">            if (cachedGravityLimit &lt; 0) {</span>
<span class="nc bnc" id="L7459" title="All 2 branches missed.">                cachedGravityLimit = EntityMovementType.MOVE_JUMP == moveType</span>
<span class="nc" id="L7460">                        ? entity.getJumpMP(false)</span>
<span class="nc" id="L7461">                        : entity.getRunningGravityLimit();</span>
            }
            // check for charge
<span class="nc bnc" id="L7464" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CHARGE) {</span>
<span class="nc bnc" id="L7465" title="All 2 branches missed.">                if (entity.canCharge()) {</span>
<span class="nc" id="L7466">                    checkExtremeGravityMovement(entity, step, lastStepMoveType,</span>
                            curPos, cachedGravityLimit);
<span class="nc" id="L7468">                    Targetable target = step.getTarget(game);</span>
<span class="nc bnc" id="L7469" title="All 2 branches missed.">                    if (target != null) {</span>
<span class="nc" id="L7470">                        ChargeAttackAction caa = new ChargeAttackAction(</span>
<span class="nc" id="L7471">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L7472">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L7473">                        entity.setDisplacementAttack(caa);</span>
<span class="nc" id="L7474">                        game.addCharge(caa);</span>
<span class="nc" id="L7475">                        charge = caa;</span>
<span class="nc" id="L7476">                    } else {</span>
<span class="nc" id="L7477">                        String message = &quot;Illegal charge!! &quot; + entity.getDisplayName() +</span>
                                &quot; is attempting to charge a null target!&quot;;
<span class="nc" id="L7479">                        MegaMek.getLogger().info(message);</span>
<span class="nc" id="L7480">                        sendServerChat(message);</span>
<span class="nc" id="L7481">                        return;</span>
                    }
<span class="nc bnc" id="L7483" title="All 4 branches missed.">                } else if (entity.isAirborneVTOLorWIGE() &amp;&amp; entity.canRam()) {</span>
<span class="nc" id="L7484">                    checkExtremeGravityMovement(entity, step, lastStepMoveType,</span>
                            curPos, cachedGravityLimit);
<span class="nc" id="L7486">                    Targetable target = step.getTarget(game);</span>
<span class="nc bnc" id="L7487" title="All 2 branches missed.">                    if (target != null) {</span>
<span class="nc" id="L7488">                        AirmechRamAttackAction raa = new AirmechRamAttackAction(</span>
<span class="nc" id="L7489">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L7490">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L7491">                        entity.setDisplacementAttack(raa);</span>
<span class="nc" id="L7492">                        entity.setRamming(true);</span>
<span class="nc" id="L7493">                        game.addCharge(raa);</span>
<span class="nc" id="L7494">                        charge = raa;</span>
<span class="nc" id="L7495">                    } else {</span>
<span class="nc" id="L7496">                        String message = &quot;Illegal charge!! &quot; + entity.getDisplayName() + &quot; is attempting to charge a null target!&quot;;</span>
<span class="nc" id="L7497">                        MegaMek.getLogger().info(message);</span>
<span class="nc" id="L7498">                        sendServerChat(message);</span>
<span class="nc" id="L7499">                        return;</span>
                    }
<span class="nc" id="L7501">                } else {</span>
<span class="nc" id="L7502">                    sendServerChat(&quot;Illegal charge!! I don't think &quot;</span>
<span class="nc" id="L7503">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to charge,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7506">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7507">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7508">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7511">                    return;</span>
                }
                break;
            }

            // check for dfa
<span class="nc bnc" id="L7517" title="All 2 branches missed.">            if (step.getType() == MoveStepType.DFA) {</span>
<span class="nc bnc" id="L7518" title="All 2 branches missed.">                if (entity.canDFA()) {</span>
<span class="nc" id="L7519">                    checkExtremeGravityMovement(entity, step, lastStepMoveType, curPos, cachedGravityLimit);</span>
<span class="nc" id="L7520">                    Targetable target = step.getTarget(game);</span>
                    
                    int targetType;
                    int targetID;
                    
                    // if it's a valid target, then simply pass along the type and ID
<span class="nc bnc" id="L7526" title="All 2 branches missed.">                    if (target != null) {    </span>
<span class="nc" id="L7527">                        targetID = target.getTargetId();</span>
<span class="nc" id="L7528">                        targetType = target.getTargetType();</span>
                    // if the target has become invalid somehow, or was incorrectly declared in the first place
                    // log the error, then put some defaults in for the DFA and proceed as if the target had been moved/destroyed
                    } else {
<span class="nc" id="L7532">                        String errorMessage = &quot;Illegal DFA by &quot; + entity.getDisplayName() + &quot; against non-existent entity at &quot; + step.getTargetPosition(); </span>
<span class="nc" id="L7533">                        sendServerChat(errorMessage);</span>
<span class="nc" id="L7534">                        MegaMek.getLogger().error(errorMessage);</span>
<span class="nc" id="L7535">                        targetID = Entity.NONE; </span>
                        // doesn't really matter, DFA processing will cut out early if target resolves as null
<span class="nc" id="L7537">                        targetType = Targetable.TYPE_ENTITY; </span>
                    }
                    
<span class="nc" id="L7540">                    DfaAttackAction daa = new DfaAttackAction(entity.getId(),</span>
                            targetType, targetID,
<span class="nc" id="L7542">                            step.getPosition());</span>
<span class="nc" id="L7543">                    entity.setDisplacementAttack(daa);</span>
<span class="nc" id="L7544">                    entity.setElevation(step.getElevation());</span>
<span class="nc" id="L7545">                    game.addCharge(daa);</span>
<span class="nc" id="L7546">                    charge = daa;</span>
                    
<span class="nc" id="L7548">                } else {</span>
<span class="nc" id="L7549">                    sendServerChat(&quot;Illegal DFA!! I don't think &quot;</span>
<span class="nc" id="L7550">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to DFA,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7553">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7554">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7555">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7558">                    return;</span>
                }
                
                break;
            }

            // check for ram
<span class="nc bnc" id="L7565" title="All 2 branches missed.">            if (step.getType() == MoveStepType.RAM) {</span>
<span class="nc bnc" id="L7566" title="All 2 branches missed.">                if (entity.canRam()) {</span>
<span class="nc" id="L7567">                    Targetable target = step.getTarget(game);</span>
<span class="nc" id="L7568">                    RamAttackAction raa = new RamAttackAction(entity.getId(),</span>
<span class="nc" id="L7569">                            target.getTargetType(), target.getTargetId(),</span>
<span class="nc" id="L7570">                            target.getPosition());</span>
<span class="nc" id="L7571">                    entity.setRamming(true);</span>
<span class="nc" id="L7572">                    game.addRam(raa);</span>
<span class="nc" id="L7573">                    ram = raa;</span>
<span class="nc" id="L7574">                } else {</span>
<span class="nc" id="L7575">                    sendServerChat(&quot;Illegal ram!! I don't think &quot;</span>
<span class="nc" id="L7576">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to charge,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7579">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7580">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7581">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7584">                    return;</span>
                }
                break;
            }

<span class="nc bnc" id="L7589" title="All 2 branches missed.">            if (step.isVTOLBombingStep()) {</span>
<span class="nc" id="L7590">                ((IBomber) entity).setVTOLBombTarget(step.getTarget(game));</span>
<span class="nc bnc" id="L7591" title="All 4 branches missed.">            } else if (step.isStrafingStep() &amp;&amp; (entity instanceof VTOL)) {</span>
<span class="nc" id="L7592">                ((VTOL) entity).getStrafingCoords().add(step.getPosition());</span>
            }

<span class="nc bnc" id="L7595" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.ACC) || (step.getType() == MoveStepType.ACCN)) {</span>
<span class="nc bnc" id="L7596" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7597">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7598" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.ACCN) {</span>
<span class="nc" id="L7599">                        a.setAccLast(true);</span>
                    } else {
<span class="nc" id="L7601">                        a.setAccDecNow(true);</span>
<span class="nc" id="L7602">                        a.setCurrentVelocity(a.getCurrentVelocity() + 1);</span>
                    }
<span class="nc" id="L7604">                    a.setNextVelocity(a.getNextVelocity() + 1);</span>
                }
            }

<span class="nc bnc" id="L7608" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.DEC) || (step.getType() == MoveStepType.DECN)) {</span>
<span class="nc bnc" id="L7609" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7610">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7611" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.DECN) {</span>
<span class="nc" id="L7612">                        a.setAccLast(true);</span>
                    } else {
<span class="nc" id="L7614">                        a.setAccDecNow(true);</span>
<span class="nc" id="L7615">                        a.setCurrentVelocity(a.getCurrentVelocity() - 1);</span>
                    }
<span class="nc" id="L7617">                    a.setNextVelocity(a.getNextVelocity() - 1);</span>
                }
            }

<span class="nc bnc" id="L7621" title="All 2 branches missed.">            if (step.getType() == MoveStepType.EVADE) {</span>
<span class="nc" id="L7622">                entity.setEvading(true);</span>
            }

<span class="nc bnc" id="L7625" title="All 2 branches missed.">            if (step.getType() == MoveStepType.SHUTDOWN) {</span>
<span class="nc" id="L7626">                entity.performManualShutdown();</span>
<span class="nc" id="L7627">                sendServerChat(entity.getDisplayName() + &quot; has shutdown.&quot;);</span>
            }

<span class="nc bnc" id="L7630" title="All 2 branches missed.">            if (step.getType() == MoveStepType.STARTUP) {</span>
<span class="nc" id="L7631">                entity.performManualStartup();</span>
<span class="nc" id="L7632">                sendServerChat(entity.getDisplayName() + &quot; has started up.&quot;);</span>
            }

<span class="nc bnc" id="L7635" title="All 2 branches missed.">            if (step.getType() == MoveStepType.SELF_DESTRUCT) {</span>
<span class="nc" id="L7636">                entity.setSelfDestructing(true);</span>
            }

<span class="nc bnc" id="L7639" title="All 2 branches missed.">            if (step.getType() == MoveStepType.ROLL) {</span>
<span class="nc bnc" id="L7640" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7641">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7642" title="All 2 branches missed.">                    a.setRolled(!a.isRolled());</span>
                }
            }

            // check for dig in or fortify
<span class="nc bnc" id="L7647" title="All 2 branches missed.">            if (entity instanceof Infantry) {</span>
<span class="nc" id="L7648">                Infantry inf = (Infantry) entity;</span>
<span class="nc bnc" id="L7649" title="All 2 branches missed.">                if (step.getType() == MoveStepType.DIG_IN) {</span>
<span class="nc" id="L7650">                    inf.setDugIn(Infantry.DUG_IN_WORKING);</span>
<span class="nc" id="L7651">                    continue;</span>
<span class="nc bnc" id="L7652" title="All 2 branches missed.">                } else if (step.getType() == MoveStepType.FORTIFY) {</span>
<span class="nc bnc" id="L7653" title="All 2 branches missed.">                    if (!entity.hasWorkingMisc(MiscType.F_TOOLS,</span>
                            MiscType.S_VIBROSHOVEL)) {
<span class="nc" id="L7655">                        sendServerChat(entity.getDisplayName()</span>
                                + &quot; failed to fortify because it is missing suitable equipment&quot;);
                    }
<span class="nc" id="L7658">                    inf.setDugIn(Infantry.DUG_IN_FORTIFYING1);</span>
<span class="nc" id="L7659">                    continue;</span>
<span class="nc bnc" id="L7660" title="All 2 branches missed.">                } else if ((step.getType() != MoveStepType.TURN_LEFT)</span>
<span class="nc bnc" id="L7661" title="All 2 branches missed.">                        &amp;&amp; (step.getType() != MoveStepType.TURN_RIGHT)) {</span>
                    // other movement clears dug in status
<span class="nc" id="L7663">                    inf.setDugIn(Infantry.DUG_IN_NONE);</span>
                }

<span class="nc bnc" id="L7666" title="All 2 branches missed.">                if (step.getType() == MoveStepType.TAKE_COVER) {</span>
<span class="nc bnc" id="L7667" title="All 2 branches missed.">                    if (Infantry.hasValidCover(game, step.getPosition(),</span>
<span class="nc" id="L7668">                            step.getElevation())) {</span>
<span class="nc" id="L7669">                        inf.setTakingCover(true);</span>
                    } else {
<span class="nc" id="L7671">                        sendServerChat(entity.getDisplayName()</span>
                                + &quot; failed to take cover: &quot;
                                + &quot;no valid unit found in &quot;
<span class="nc" id="L7674">                                + step.getPosition());</span>
                    }
                }
            }

            // If we have turned, check whether we have fulfilled any turn mode requirements.
<span class="nc bnc" id="L7680" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.TURN_LEFT || step.getType() == MoveStepType.TURN_RIGHT)</span>
<span class="nc bnc" id="L7681" title="All 2 branches missed.">                    &amp;&amp; entity.usesTurnMode()) {</span>
<span class="nc" id="L7682">                int straight = 0;</span>
<span class="nc bnc" id="L7683" title="All 2 branches missed.">                if (prevStep != null) {</span>
<span class="nc" id="L7684">                    straight = prevStep.getNStraight();</span>
                }
<span class="nc" id="L7686">                rollTarget = entity.checkTurnModeFailure(overallMoveType, straight,</span>
<span class="nc" id="L7687">                        md.getMpUsed(), step.getPosition());</span>
<span class="nc bnc" id="L7688" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7689">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L7691" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
<span class="nc bnc" id="L7692" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos,</span>
<span class="nc" id="L7693">                                step.getFacing() - curFacing,</span>
<span class="nc bnc" id="L7694" title="All 2 branches missed.">                                (null == prevStep)?step : prevStep,</span>
<span class="nc" id="L7695">                                        step.isThisStepBackwards(),</span>
                                        lastStepMoveType, distance, mof, mof)) {
<span class="nc bnc" id="L7697" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L7698">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L7700">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L7703">                            turnOver = true;</span>
<span class="nc" id="L7704">                            distance = entity.delta_distance;</span>
                        } else {
<span class="nc" id="L7706">                            continueTurnFromFishtail = true;</span>
                        }
<span class="nc" id="L7708">                        curFacing = entity.getFacing();</span>
<span class="nc" id="L7709">                        curPos = entity.getPosition();</span>
<span class="nc" id="L7710">                        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L7711">                        break;</span>
                    }
                }
            }

<span class="nc bnc" id="L7716" title="All 2 branches missed.">            if (step.getType() == MoveStepType.BOOTLEGGER) {</span>
<span class="nc" id="L7717">                rollTarget = entity.getBasePilotingRoll();</span>
<span class="nc" id="L7718">                entity.addPilotingModifierForTerrain(rollTarget);</span>
<span class="nc" id="L7719">                rollTarget.addModifier(0, &quot;bootlegger maneuver&quot;);</span>
<span class="nc" id="L7720">                int mof = doSkillCheckWhileMoving(entity, lastElevation,</span>
                        curPos, curPos, rollTarget, false);
<span class="nc bnc" id="L7722" title="All 2 branches missed.">                if (mof &gt; 0) {</span>
                    // If the bootlegger maneuver fails, we treat it as a turn in a random direction.
<span class="nc bnc" id="L7724" title="All 2 branches missed.">                    processFailedVehicleManeuver(entity, curPos, Compute.d6() &lt; 4 ? -1 : 1,</span>
<span class="nc bnc" id="L7725" title="All 2 branches missed.">                            (null == prevStep)? step : prevStep,</span>
<span class="nc" id="L7726">                            step.isThisStepBackwards(), lastStepMoveType, distance, 2, mof);</span>
<span class="nc" id="L7727">                    curFacing = entity.getFacing();</span>
<span class="nc" id="L7728">                    curPos = entity.getPosition();</span>
<span class="nc" id="L7729">                    break;</span>
                }
            }

            // set last step parameters
<span class="nc" id="L7734">            curPos = step.getPosition();</span>
<span class="nc bnc" id="L7735" title="All 4 branches missed.">            if (!((entity.getJumpType() == Mech.JUMP_BOOSTER) &amp;&amp; step.isJumping())) {</span>
<span class="nc" id="L7736">                curFacing = step.getFacing();</span>
            }
            // check if a building PSR will be needed later, before setting the
            // new elevation
<span class="nc" id="L7740">            int buildingMove = entity.checkMovementInBuilding(step, prevStep, curPos, lastPos);</span>
<span class="nc" id="L7741">            curVTOLElevation = step.getElevation();</span>
<span class="nc" id="L7742">            curAltitude = step.getAltitude();</span>
<span class="nc" id="L7743">            curElevation = step.getElevation();</span>
<span class="nc" id="L7744">            curClimbMode = step.climbMode();</span>
            // set elevation in case of collapses
<span class="nc" id="L7746">            entity.setElevation(step.getElevation());</span>
            // set climb mode in case of skid
<span class="nc" id="L7748">            entity.setClimbMode(curClimbMode);</span>

<span class="nc" id="L7750">            IHex curHex = game.getBoard().getHex(curPos);</span>

            // when first entering a building, we need to roll what type
            // of basement it has
<span class="nc bnc" id="L7754" title="All 4 branches missed.">            if (isOnGround &amp;&amp; curHex.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L7755">                Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L7756" title="All 2 branches missed.">                if (bldg.rollBasement(curPos, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L7757">                    sendChangedHex(curPos);</span>
<span class="nc" id="L7758">                    Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L7759">                    buildings.add(bldg);</span>
<span class="nc" id="L7760">                    sendChangedBuildings(buildings);</span>
                }
            }

            // check for automatic unstick
<span class="nc bnc" id="L7765" title="All 6 branches missed.">            if (entity.canUnstickByJumping() &amp;&amp; entity.isStuck()</span>
                    &amp;&amp; (moveType == EntityMovementType.MOVE_JUMP)) {
<span class="nc" id="L7767">                entity.setStuck(false);</span>
<span class="nc" id="L7768">                entity.setCanUnstickByJumping(false);</span>
            }

            // check for leap
<span class="nc bnc" id="L7772" title="All 6 branches missed.">            if (!lastPos.equals(curPos)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP) &amp;&amp; (entity instanceof Mech)
<span class="nc bnc" id="L7774" title="All 4 branches missed.">                    &amp;&amp; !entity.isAirborne() &amp;&amp; (step.getClearance() &lt;= 0)  // Don't check airborne LAMs</span>
<span class="nc bnc" id="L7775" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_LEAPING)) {</span>
<span class="nc" id="L7776">                int leapDistance = (lastElevation</span>
<span class="nc" id="L7777">                        + game.getBoard().getHex(lastPos).getLevel())</span>
<span class="nc" id="L7778">                        - (curElevation + curHex.getLevel());</span>
<span class="nc bnc" id="L7779" title="All 2 branches missed.">                if (leapDistance &gt; 2) {</span>
                    // skill check for leg damage
<span class="nc" id="L7781">                    rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L7782">                    entity.addPilotingModifierForTerrain(rollTarget, curPos);</span>
<span class="nc" id="L7783">                    rollTarget.append(new PilotingRollData(entity.getId(),</span>
                            2 * leapDistance, &quot;leaping (leg damage)&quot;));
<span class="nc bnc" id="L7785" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
                        // do leg damage
<span class="nc" id="L7788">                        addReport(damageEntity(entity, new HitData(Mech.LOC_LLEG), leapDistance));</span>
<span class="nc" id="L7789">                        addReport(damageEntity(entity, new HitData(Mech.LOC_RLEG), leapDistance));</span>
<span class="nc" id="L7790">                        addNewLines();</span>
<span class="nc" id="L7791">                        addReport(criticalEntity(entity, Mech.LOC_LLEG, false, 0, 0));</span>
<span class="nc" id="L7792">                        addNewLines();</span>
<span class="nc" id="L7793">                        addReport(criticalEntity(entity, Mech.LOC_RLEG, false, 0, 0));</span>
<span class="nc bnc" id="L7794" title="All 2 branches missed.">                        if (entity instanceof QuadMech) {</span>
<span class="nc" id="L7795">                            addReport(damageEntity(entity, new HitData(Mech.LOC_LARM), leapDistance));</span>
<span class="nc" id="L7796">                            addReport(damageEntity(entity, new HitData(Mech.LOC_RARM), leapDistance));</span>
<span class="nc" id="L7797">                            addNewLines();</span>
<span class="nc" id="L7798">                            addReport(criticalEntity(entity, Mech.LOC_LARM, false, 0, 0));</span>
<span class="nc" id="L7799">                            addNewLines();</span>
<span class="nc" id="L7800">                            addReport(criticalEntity(entity, Mech.LOC_RARM, false, 0, 0));</span>
                        }
                    }
                    // skill check for fall
<span class="nc" id="L7804">                    rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L7805">                    entity.addPilotingModifierForTerrain(rollTarget, curPos);</span>
<span class="nc" id="L7806">                    rollTarget.append(new PilotingRollData(entity.getId(),</span>
                            leapDistance, &quot;leaping (fall)&quot;));
<span class="nc bnc" id="L7808" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
<span class="nc" id="L7810">                        entity.setElevation(lastElevation);</span>
<span class="nc" id="L7811">                        addReport(doEntityFallsInto(entity, lastElevation,</span>
                                lastPos, curPos,
<span class="nc" id="L7813">                                entity.getBasePilotingRoll(overallMoveType), false));</span>
                    }
                }
            }
            
            // Check for skid.
<span class="nc" id="L7819">            rollTarget = entity.checkSkid(moveType, prevHex, overallMoveType,</span>
                    prevStep, step, prevFacing, curFacing, lastPos, curPos,
                    isInfantry, distance - 1);
<span class="nc bnc" id="L7822" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Have an entity-meaningful PSR message.
                boolean psrFailed;
<span class="nc" id="L7825">                int startingFacing = entity.getFacing();</span>
<span class="nc bnc" id="L7826" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
                    // We need to ensure that falls will happen from the proper
                    // facing
<span class="nc" id="L7829">                    entity.setFacing(curFacing);</span>
<span class="nc bnc" id="L7830" title="All 2 branches missed.">                    psrFailed = (0 &lt; doSkillCheckWhileMoving(entity,</span>
                            lastElevation, lastPos, lastPos, rollTarget, true));
                } else {
<span class="nc bnc" id="L7833" title="All 2 branches missed.">                    psrFailed = (0 &lt; doSkillCheckWhileMoving(entity,</span>
                            lastElevation, lastPos, lastPos, rollTarget, false));
                }

                // Does the entity skid?
<span class="nc bnc" id="L7838" title="All 2 branches missed.">                if (psrFailed) {</span>

<span class="nc bnc" id="L7840" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc" id="L7841">                        addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
                    }

<span class="nc" id="L7844">                    curPos = lastPos;</span>
<span class="nc" id="L7845">                    int skidDistance = (int) Math.round((double) (distance - 1) / 2);</span>
<span class="nc" id="L7846">                    int skidDirection = prevFacing;</span>

                    // All charge damage is based upon
                    // the pre-skid move distance.
<span class="nc" id="L7850">                    entity.delta_distance = distance - 1;</span>

                    // Attacks against a skidding target have additional +2.
<span class="nc" id="L7853">                    moveType = EntityMovementType.MOVE_SKID;</span>

                    // What is the first hex in the skid?
<span class="nc bnc" id="L7856" title="All 2 branches missed.">                    if (step.isThisStepBackwards()) {</span>
<span class="nc" id="L7857">                        skidDirection = (skidDirection + 3) % 6;</span>
                    }

<span class="nc bnc" id="L7860" title="All 2 branches missed.">                    if (processSkid(entity, curPos, prevStep.getElevation(),</span>
                            skidDirection, skidDistance, prevStep,
                            lastStepMoveType)) {
<span class="nc" id="L7863">                        return;</span>
                    }

                    // set entity parameters
<span class="nc" id="L7867">                    curFacing = entity.getFacing();</span>
<span class="nc" id="L7868">                    curPos = entity.getPosition();</span>
<span class="nc" id="L7869">                    entity.setSecondaryFacing(curFacing);</span>

                    // skid consumes all movement
<span class="nc bnc" id="L7872" title="All 2 branches missed.">                    if (md.hasActiveMASC()) {</span>
<span class="nc" id="L7873">                        mpUsed = entity.getRunMP();</span>
                    } else {
<span class="nc" id="L7875">                        mpUsed = entity.getRunMPwithoutMASC();</span>
                    }

<span class="nc" id="L7878">                    entity.moved = moveType;</span>
<span class="nc" id="L7879">                    fellDuringMovement = true;</span>
<span class="nc" id="L7880">                    turnOver = true;</span>
<span class="nc" id="L7881">                    distance = entity.delta_distance;</span>
<span class="nc" id="L7882">                    break;</span>

                } else { // End failed-skid-psr
                    // If the check succeeded, restore the facing we had before
                    // if it failed, the fall will have changed facing
<span class="nc" id="L7887">                    entity.setFacing(startingFacing);</span>
                }

            } // End need-skid-psr

            // check sideslip
<span class="nc bnc" id="L7893" title="All 2 branches missed.">            if ((entity instanceof VTOL)</span>
<span class="nc bnc" id="L7894" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L7895" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L7896" title="All 2 branches missed.">                            &amp;&amp; step.getClearance() &gt; 0)) {</span>
<span class="nc" id="L7897">                rollTarget = entity.checkSideSlip(moveType, prevHex,</span>
                        overallMoveType, prevStep, prevFacing, curFacing,
                        lastPos, curPos, distance);
<span class="nc bnc" id="L7900" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7901">                    int moF = doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false);
<span class="nc bnc" id="L7903" title="All 2 branches missed.">                    if (moF &gt; 0) {</span>
                        int elev;
                        int sideslipDistance;
                        int skidDirection;
                        Coords start;
<span class="nc bnc" id="L7908" title="All 2 branches missed.">                        if (step.getType() == MoveStepType.LATERAL_LEFT</span>
<span class="nc bnc" id="L7909" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_RIGHT</span>
<span class="nc bnc" id="L7910" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_LEFT_BACKWARDS</span>
<span class="nc bnc" id="L7911" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_RIGHT_BACKWARDS) {</span>
                            // A failed controlled sideslip always results in moving one additional hex
                            // in the direction of the intentional sideslip.
<span class="nc" id="L7914">                            elev = step.getElevation();</span>
<span class="nc" id="L7915">                            sideslipDistance = 1;</span>
<span class="nc" id="L7916">                            skidDirection = lastPos.direction(curPos);</span>
<span class="nc" id="L7917">                            start = curPos;</span>
                        } else {
<span class="nc bnc" id="L7919" title="All 2 branches missed.">                            elev = (null == prevStep)? curElevation : prevStep.getElevation();</span>
                            // maximum distance is hexes moved / 2
<span class="nc" id="L7921">                            sideslipDistance = Math.min(moF, distance / 2);</span>
<span class="nc" id="L7922">                            skidDirection = prevFacing;</span>
<span class="nc" id="L7923">                            start = lastPos;</span>
                        }
<span class="nc bnc" id="L7925" title="All 2 branches missed.">                        if (sideslipDistance &gt; 0) {</span>
<span class="nc" id="L7926">                            sideslipped = true;</span>
<span class="nc" id="L7927">                            r = new Report(2100);</span>
<span class="nc" id="L7928">                            r.subject = entity.getId();</span>
<span class="nc" id="L7929">                            r.addDesc(entity);</span>
<span class="nc" id="L7930">                            r.add(sideslipDistance);</span>
<span class="nc" id="L7931">                            addReport(r);</span>

<span class="nc bnc" id="L7933" title="All 2 branches missed.">                            if (processSkid(entity, start, elev, skidDirection,</span>
<span class="nc bnc" id="L7934" title="All 2 branches missed.">                                    sideslipDistance, (null == prevStep)? step : prevStep,</span>
                                    lastStepMoveType)) {
<span class="nc" id="L7936">                                return;</span>
                            }

<span class="nc bnc" id="L7939" title="All 4 branches missed.">                            if (!entity.isDestroyed() &amp;&amp; !entity.isDoomed()</span>
<span class="nc bnc" id="L7940" title="All 2 branches missed.">                                    &amp;&amp; (mpUsed &lt; entity.getRunMP())) {</span>
<span class="nc" id="L7941">                                fellDuringMovement = true; // No, but it should</span>
                                // work...
                            }

<span class="nc bnc" id="L7945" title="All 2 branches missed.">                            if ((entity.getElevation() == 0)</span>
<span class="nc bnc" id="L7946" title="All 2 branches missed.">                                    &amp;&amp; ((entity.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L7947" title="All 2 branches missed.">                                        || (entity.getMovementMode() == EntityMovementMode.WIGE))) {</span>
<span class="nc" id="L7948">                                turnOver = true;</span>
                            }
                            // set entity parameters
<span class="nc" id="L7951">                            curFacing = step.getFacing();</span>
<span class="nc" id="L7952">                            curPos = entity.getPosition();</span>
<span class="nc" id="L7953">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L7954">                            break;</span>
                        }
                    }
                }
            }

            // check if we've moved into rubble
<span class="nc" id="L7961">            boolean isLastStep = step.equals(md.getLastStep());</span>
<span class="nc" id="L7962">            rollTarget = entity.checkRubbleMove(step, overallMoveType, curHex,</span>
                    lastPos, curPos, isLastStep, isPavementStep);
<span class="nc bnc" id="L7964" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7965">                doSkillCheckWhileMoving(entity, lastElevation, lastPos, curPos,</span>
                        rollTarget, true);
            }

            // check if we are using reckless movement
<span class="nc" id="L7970">            rollTarget = entity.checkRecklessMove(step, overallMoveType, curHex,</span>
                    lastPos, curPos, prevHex);
<span class="nc bnc" id="L7972" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L7973" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L7974">                    doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, true);
<span class="nc bnc" id="L7976" title="All 2 branches missed.">                } else if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L7977" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
                        // assume VTOLs in flight are always in clear terrain
<span class="nc bnc" id="L7980" title="All 2 branches missed.">                        if ((0 == curHex.terrainsPresent())</span>
<span class="nc bnc" id="L7981" title="All 2 branches missed.">                                || (step.getClearance() &gt; 0)) {</span>
<span class="nc bnc" id="L7982" title="All 2 branches missed.">                            if (entity instanceof VTOL) {</span>
<span class="nc" id="L7983">                                r = new Report(2208);</span>
                            } else {
<span class="nc" id="L7985">                                r = new Report(2206);</span>
                            }
<span class="nc" id="L7987">                            r.addDesc(entity);</span>
<span class="nc" id="L7988">                            r.subject = entity.getId();</span>
<span class="nc" id="L7989">                            addReport(r);</span>
<span class="nc" id="L7990">                            mpUsed = step.getMpUsed() + 1;</span>
<span class="nc" id="L7991">                            fellDuringMovement = true;</span>
<span class="nc" id="L7992">                            break;</span>
                        }
<span class="nc" id="L7994">                        r = new Report(2207);</span>
<span class="nc" id="L7995">                        r.addDesc(entity);</span>
<span class="nc" id="L7996">                        r.subject = entity.getId();</span>
<span class="nc" id="L7997">                        addReport(r);</span>
                        // until we get a rules clarification assume that the
                        // entity is both giver and taker
                        // for charge damage
<span class="nc" id="L8001">                        HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8002">                        addReport(damageEntity(entity, hit, ChargeAttackAction</span>
<span class="nc" id="L8003">                                .getDamageTakenBy(entity, entity)));</span>
<span class="nc" id="L8004">                        turnOver = true;</span>
<span class="nc" id="L8005">                        break;</span>
                    }
                }
            }

            // check for breaking magma crust unless we are jumping over the hex
<span class="nc bnc" id="L8011" title="All 2 branches missed.">            if (stepMoveType != EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L8012">                ServerHelper.checkAndApplyMagmaCrust(curHex, step.getElevation(), entity, curPos, false, vPhaseReport, this);</span>
            }

            // check if we've moved into a swamp
<span class="nc" id="L8016">            rollTarget = entity.checkBogDown(step, lastStepMoveType, curHex,</span>
                    lastPos, curPos, lastElevation, isPavementStep);
<span class="nc bnc" id="L8018" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L8019" title="All 2 branches missed.">                if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                        curPos, rollTarget, false)) {
<span class="nc" id="L8021">                    entity.setStuck(true);</span>
<span class="nc" id="L8022">                    entity.setCanUnstickByJumping(true);</span>
<span class="nc" id="L8023">                    r = new Report(2081);</span>
<span class="nc" id="L8024">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L8025">                    r.subject = entity.getId();</span>
<span class="nc" id="L8026">                    addReport(r);</span>
                    // check for quicksand
<span class="nc" id="L8028">                    addReport(checkQuickSand(curPos));</span>
                    // check for accidental stacking violation
<span class="nc" id="L8030">                    Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L8031">                            entity.getId(), curPos);</span>
<span class="nc bnc" id="L8032" title="All 2 branches missed.">                    if (violation != null) {</span>
                        // target gets displaced, because of low elevation
<span class="nc" id="L8034">                        int direction = lastPos.direction(curPos);</span>
<span class="nc" id="L8035">                        Coords targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L8036">                                entity.getId(), curPos, direction);</span>
<span class="nc" id="L8037">                        addReport(doEntityDisplacement(violation, curPos,</span>
                                targetDest,
<span class="nc" id="L8039">                                new PilotingRollData(violation.getId(), 0,</span>
                                        &quot;domino effect&quot;)));
                        // Update the violating entity's position on the client.
<span class="nc" id="L8042">                        entityUpdate(violation.getId());</span>
<span class="nc" id="L8043">                    }</span>
                    break;
                }
            }

            // check to see if we are a mech and we've moved OUT of fire
<span class="nc" id="L8049">            IHex lastHex = game.getBoard().getHex(lastPos);</span>
<span class="nc bnc" id="L8050" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc bnc" id="L8051" title="All 4 branches missed.">                if (!lastPos.equals(curPos) &amp;&amp; (prevStep != null)</span>
<span class="nc bnc" id="L8052" title="All 2 branches missed.">                        &amp;&amp; ((lastHex.containsTerrain(Terrains.FIRE)</span>
<span class="nc bnc" id="L8053" title="All 2 branches missed.">                                &amp;&amp; (prevStep.getElevation() &lt;= 1))</span>
<span class="nc bnc" id="L8054" title="All 2 branches missed.">                                || (lastHex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L8055" title="All 4 branches missed.">                                        &amp;&amp; (prevStep.getElevation() == 0)))</span>
                        &amp;&amp; ((stepMoveType != EntityMovementType.MOVE_JUMP)
                                // Bug #828741 -- jumping bypasses fire, but not
                                // on the
                                // first step
                                // getMpUsed -- total MP used to this step
                                // getMp -- MP used in this step
                                // the difference will always be 0 on the &quot;first
                                // step&quot;
                                // of a jump,
                                // and &gt;0 on a step in the midst of a jump
<span class="nc bnc" id="L8066" title="All 2 branches missed.">                                || (0 == (step.getMpUsed() - step.getMp())))) {</span>
<span class="nc" id="L8067">                    int heat = 0;</span>
<span class="nc bnc" id="L8068" title="All 2 branches missed.">                    if (lastHex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L8069">                        heat += 2;</span>
                    }
<span class="nc bnc" id="L8071" title="All 2 branches missed.">                    if (lastHex.terrainLevel(Terrains.MAGMA) == 1) {</span>
<span class="nc" id="L8072">                        heat += 2;</span>
<span class="nc bnc" id="L8073" title="All 2 branches missed.">                    } else if (lastHex.terrainLevel(Terrains.MAGMA) == 2) {</span>
<span class="nc" id="L8074">                        heat += 5;</span>
                    }
<span class="nc bnc" id="L8076" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L8077">                        heat /= 2;</span>
                    }
<span class="nc" id="L8079">                    entity.heatFromExternal += heat;</span>
<span class="nc" id="L8080">                    r = new Report(2115);</span>
<span class="nc" id="L8081">                    r.subject = entity.getId();</span>
<span class="nc" id="L8082">                    r.addDesc(entity);</span>
<span class="nc" id="L8083">                    r.add(heat);</span>
<span class="nc" id="L8084">                    addReport(r);</span>
<span class="nc bnc" id="L8085" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L8086">                        r = new Report(5550);</span>
<span class="nc" id="L8087">                        addReport(r);</span>
                    }
                }
            }

            // check to see if we are not a mech and we've moved INTO fire
<span class="nc bnc" id="L8093" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L8094">                boolean underwater = game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L8095" title="All 2 branches missed.">                        .containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L8096" title="All 2 branches missed.">                        &amp;&amp; (game.getBoard().getHex(curPos).depth() &gt; 0)</span>
<span class="nc bnc" id="L8097" title="All 2 branches missed.">                        &amp;&amp; (step.getElevation() &lt; game.getBoard().getHex(curPos).surface());</span>
<span class="nc bnc" id="L8098" title="All 2 branches missed.">                if (game.getBoard().getHex(curPos).containsTerrain(</span>
<span class="nc bnc" id="L8099" title="All 4 branches missed.">                        Terrains.FIRE) &amp;&amp; !lastPos.equals(curPos)</span>
                        &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8101" title="All 4 branches missed.">                        &amp;&amp; (step.getElevation() &lt;= 1) &amp;&amp; !underwater) {</span>
<span class="nc" id="L8102">                    doFlamingDamage(entity);</span>
                }
            }
            // check for extreme gravity movement
<span class="nc bnc" id="L8106" title="All 4 branches missed.">            if (!i.hasMoreElements() &amp;&amp; !firstStep) {</span>
<span class="nc" id="L8107">                checkExtremeGravityMovement(entity, step, lastStepMoveType, curPos, cachedGravityLimit);</span>
            }
            // check for minefields. have to check both new hex and new
            // elevation
            // VTOLs may land and submarines may rise or lower into a minefield
<span class="nc bnc" id="L8112" title="All 4 branches missed.">            if (!lastPos.equals(curPos) || (lastElevation != curElevation)) {</span>
<span class="nc" id="L8113">                boolean boom = false;</span>
<span class="nc bnc" id="L8114" title="All 2 branches missed.">                if (isOnGround) {</span>
<span class="nc" id="L8115">                    boom = checkVibrabombs(entity, curPos, false, lastPos, curPos, vPhaseReport);</span>
                }
<span class="nc bnc" id="L8117" title="All 2 branches missed.">                if (game.containsMinefield(curPos)) {</span>
                    // set the new position temporarily, because
                    // infantry otherwise would get double damage
                    // when moving from clear into mined woods
<span class="nc" id="L8121">                    entity.setPosition(curPos);</span>
<span class="nc bnc" id="L8122" title="All 2 branches missed.">                    if (enterMinefield(entity, curPos, step.getElevation(),</span>
                            isOnGround, vPhaseReport)) {
                        // resolve any piloting rolls from damage unless unit
                        // was jumping
<span class="nc bnc" id="L8126" title="All 2 branches missed.">                        if (stepMoveType != EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L8127">                            addReport(resolvePilotingRolls(entity));</span>
<span class="nc" id="L8128">                            game.resetPSRs(entity);</span>
                        }
<span class="nc" id="L8130">                        boom = true;</span>
                    }
<span class="nc bnc" id="L8132" title="All 4 branches missed.">                    if (wasProne || !entity.isProne()) {</span>
<span class="nc" id="L8133">                        entity.setPosition(lastPos);</span>
                    }
                }
                // did anything go boom?
<span class="nc bnc" id="L8137" title="All 2 branches missed.">                if (boom) {</span>
                    // set fell during movement so that entity will get another
                    // chance to move with any motive damage
                    // taken account of (functions the same as MASC failure)
                    // only do this if they had more steps (and they were not
                    // jumping
<span class="nc bnc" id="L8143" title="All 4 branches missed.">                    if (i.hasMoreElements() &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)) {</span>
<span class="nc" id="L8144">                        md.clear();</span>
<span class="nc" id="L8145">                        fellDuringMovement = true;</span>
                    }
                    // reset mines if anything detonated
<span class="nc" id="L8148">                    resetMines();</span>
                }
            }

            // infantry discovers minefields if they end their move
            // in a minefield.
<span class="nc bnc" id="L8154" title="All 6 branches missed.">            if (!lastPos.equals(curPos) &amp;&amp; !i.hasMoreElements() &amp;&amp; isInfantry) {</span>
<span class="nc bnc" id="L8155" title="All 2 branches missed.">                if (game.containsMinefield(curPos)) {</span>
<span class="nc" id="L8156">                    IPlayer owner = entity.getOwner();</span>
<span class="nc bnc" id="L8157" title="All 2 branches missed.">                    for (Minefield mf : game.getMinefields(curPos)) {</span>
<span class="nc bnc" id="L8158" title="All 2 branches missed.">                        if (!owner.containsMinefield(mf)) {</span>
<span class="nc" id="L8159">                            r = new Report(2120);</span>
<span class="nc" id="L8160">                            r.subject = entity.getId();</span>
<span class="nc" id="L8161">                            r.add(entity.getShortName(), true);</span>
<span class="nc" id="L8162">                            addReport(r);</span>
<span class="nc" id="L8163">                            revealMinefield(game.getTeamForPlayer(owner), mf);</span>
                        }
<span class="nc" id="L8165">                    }</span>
                }
            }

            // check if we've moved into water
<span class="nc" id="L8170">            rollTarget = entity.checkWaterMove(step, lastStepMoveType, curHex,</span>
                    lastPos, curPos, isPavementStep);
<span class="nc bnc" id="L8172" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Swarmers need special handling.
<span class="nc" id="L8174">                final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc" id="L8175">                boolean swarmerDone = true;</span>
<span class="nc" id="L8176">                Entity swarmer = null;</span>
<span class="nc bnc" id="L8177" title="All 2 branches missed.">                if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L8178">                    swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L8179">                    swarmerDone = swarmer.isDone();</span>
                }

                // Now do the skill check.
<span class="nc" id="L8183">                entity.setFacing(curFacing);</span>
<span class="nc" id="L8184">                doSkillCheckWhileMoving(entity, lastElevation, lastPos, curPos, rollTarget, true);</span>

                // Swarming infantry platoons may drown.
<span class="nc bnc" id="L8187" title="All 2 branches missed.">                if (curHex.terrainLevel(Terrains.WATER) &gt; 1) {</span>
<span class="nc" id="L8188">                    drownSwarmer(entity, curPos);</span>
                }

                // Do we need to remove a game turn for the swarmer
<span class="nc bnc" id="L8192" title="All 4 branches missed.">                if (!swarmerDone &amp;&amp; (swarmer != null)</span>
<span class="nc bnc" id="L8193" title="All 4 branches missed.">                        &amp;&amp; (swarmer.isDoomed() || swarmer.isDestroyed())) {</span>
                    // We have to diddle with the swarmer's
                    // status to get its turn removed.
<span class="nc" id="L8196">                    swarmer.setDone(false);</span>
<span class="nc" id="L8197">                    swarmer.setUnloaded(false);</span>

                    // Dead entities don't take turns.
<span class="nc" id="L8200">                    game.removeTurnFor(swarmer);</span>
<span class="nc" id="L8201">                    send(createTurnVectorPacket());</span>

                    // Return the original status.
<span class="nc" id="L8204">                    swarmer.setDone(true);</span>
<span class="nc" id="L8205">                    swarmer.setUnloaded(true);</span>
                }

                // check for inferno wash-off
<span class="nc" id="L8209">                checkForWashedInfernos(entity, curPos);</span>
            }

            // In water, may or may not be a new hex, necessary to
            // check during movement, for breach damage, and always
            // set dry if appropriate
            // TODO : possibly make the locations local and set later
<span class="nc bnc" id="L8216" title="All 2 branches missed.">            addReport(doSetLocationsExposure(entity, curHex,</span>
                    stepMoveType == EntityMovementType.MOVE_JUMP,
<span class="nc" id="L8218">                    step.getElevation()));</span>

            // check for breaking ice by breaking through from below
<span class="nc bnc" id="L8221" title="All 4 branches missed.">            if ((lastElevation &lt; 0) &amp;&amp; (step.getElevation() == 0)</span>
<span class="nc bnc" id="L8222" title="All 2 branches missed.">                    &amp;&amp; lastHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L8223" title="All 4 branches missed.">                    &amp;&amp; lastHex.containsTerrain(Terrains.WATER)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8225" title="All 2 branches missed.">                    &amp;&amp; !lastPos.equals(curPos)) {</span>
                // need to temporarily reset entity's position so it doesn't
                // fall in the ice
<span class="nc" id="L8228">                entity.setPosition(curPos);</span>
<span class="nc" id="L8229">                r = new Report(2410);</span>
<span class="nc" id="L8230">                r.addDesc(entity);</span>
<span class="nc" id="L8231">                addReport(r);</span>
<span class="nc" id="L8232">                addReport(resolveIceBroken(lastPos));</span>
                // ok now set back
<span class="nc" id="L8234">                entity.setPosition(lastPos);</span>
            }
            // check for breaking ice by stepping on it
<span class="nc bnc" id="L8237" title="All 2 branches missed.">            if (curHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L8238" title="All 4 branches missed.">                    &amp;&amp; curHex.containsTerrain(Terrains.WATER)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8240" title="All 6 branches missed.">                    &amp;&amp; !lastPos.equals(curPos) &amp;&amp; !(entity instanceof Infantry)</span>
<span class="nc bnc" id="L8241" title="All 2 branches missed.">                    &amp;&amp; !(isPavementStep &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE))) {</span>
<span class="nc bnc" id="L8242" title="All 2 branches missed.">                if (step.getElevation() == 0) {</span>
<span class="nc" id="L8243">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L8244">                    r = new Report(2118);</span>
<span class="nc" id="L8245">                    r.addDesc(entity);</span>
<span class="nc" id="L8246">                    r.add(roll);</span>
<span class="nc" id="L8247">                    r.subject = entity.getId();</span>
<span class="nc" id="L8248">                    addReport(r);</span>
<span class="nc bnc" id="L8249" title="All 2 branches missed.">                    if (roll == 6) {</span>
<span class="nc" id="L8250">                        entity.setPosition(curPos);</span>
<span class="nc" id="L8251">                        addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L8252">                        curPos = entity.getPosition();</span>
                    }
<span class="nc" id="L8254">                }</span>
                // or intersecting it
<span class="nc bnc" id="L8256" title="All 2 branches missed.">                else if ((step.getElevation() + entity.height()) == 0) {</span>
<span class="nc" id="L8257">                    r = new Report(2410);</span>
<span class="nc" id="L8258">                    r.addDesc(entity);</span>
<span class="nc" id="L8259">                    addReport(r);</span>
<span class="nc" id="L8260">                    addReport(resolveIceBroken(curPos));</span>
                }
            }

            // Handle loading units.
<span class="nc bnc" id="L8265" title="All 2 branches missed.">            if (step.getType() == MoveStepType.LOAD) {</span>

                // Find the unit being loaded.
<span class="nc" id="L8268">                Entity loaded = null;</span>
<span class="nc" id="L8269">                Iterator&lt;Entity&gt; entities = game.getEntities(curPos);</span>
<span class="nc bnc" id="L8270" title="All 2 branches missed.">                while (entities.hasNext()) {</span>

                    // Is the other unit friendly and not the current entity?
<span class="nc" id="L8273">                    loaded = entities.next();</span>

                    // This should never ever happen, but just in case...
<span class="nc bnc" id="L8276" title="All 2 branches missed.">                    if (loaded.equals(null)) {</span>
<span class="nc" id="L8277">                        continue;</span>
                    }

<span class="nc bnc" id="L8280" title="All 4 branches missed.">                    if (!entity.isEnemyOf(loaded) &amp;&amp; !entity.equals(loaded)) {</span>
                        // The moving unit should be able to load the other
                        // unit and the other should be able to have a turn.
<span class="nc bnc" id="L8283" title="All 4 branches missed.">                        if (!entity.canLoad(loaded) || !loaded.isLoadableThisTurn()) {</span>
                            // Something is fishy in Denmark.
<span class="nc" id="L8285">                            MegaMek.getLogger().error(entity.getShortName() + &quot; can not load &quot; + loaded.getShortName());</span>
<span class="nc" id="L8286">                            loaded = null;</span>
                        } else {
                            // Have the deployed unit load the indicated unit.
<span class="nc" id="L8289">                            loadUnit(entity, loaded, loaded.getTargetBay());</span>

                            // Stop looking.
<span class="nc" id="L8292">                            break;</span>
                        }

                    } else {
                        // Nope. Discard it.
<span class="nc" id="L8297">                        loaded = null;</span>
                    }

                } // Handle the next entity in this hex.

                // We were supposed to find someone to load.
<span class="nc bnc" id="L8303" title="All 2 branches missed.">                if (loaded == null) {</span>
<span class="nc" id="L8304">                    MegaMek.getLogger().error(&quot;Could not find unit for &quot; + entity.getShortName() + &quot; to load in &quot; + curPos);</span>
                }

            } // End STEP_LOAD

         // Handle towing units.
<span class="nc bnc" id="L8310" title="All 2 branches missed.">            if (step.getType() == MoveStepType.TOW) {</span>

                // Find the unit being loaded.
                Entity loaded;
<span class="nc" id="L8314">                loaded = game.getEntity(entity.getTowing());</span>

                // This should never ever happen, but just in case...
<span class="nc bnc" id="L8317" title="All 2 branches missed.">                if (loaded == null) {</span>
<span class="nc" id="L8318">                    MegaMek.getLogger().error(&quot;Could not find unit for &quot; + entity.getShortName() + &quot; to tow.&quot;);</span>
<span class="nc" id="L8319">                    continue;</span>
                }

                // The moving unit should be able to tow the other
                // unit and the other should be able to have a turn.
                //FIXME: I know this check duplicates functions already performed when enabling the Tow button.
                //This code made more sense as borrowed from &quot;Load&quot; where we actually rechecked the hex for the target unit.
                //Do we need it here for safety, client/server sync or can this be further streamlined?
<span class="nc bnc" id="L8327" title="All 2 branches missed.">                if (!entity.canTow(loaded.getId())) {</span>
                    // Something is fishy in Denmark.
<span class="nc" id="L8329">                    MegaMek.getLogger().error(entity.getShortName() + &quot; can not tow &quot; + loaded.getShortName());</span>
                } else {
                    // Have the deployed unit load the indicated unit.
<span class="nc" id="L8332">                    towUnit(entity, loaded);</span>
                }
            } // End STEP_TOW

            // Handle mounting units to small craft/DropShip
<span class="nc bnc" id="L8337" title="All 2 branches missed.">            if (step.getType() == MoveStepType.MOUNT) {</span>
<span class="nc" id="L8338">                Targetable mountee = step.getTarget(game);</span>
<span class="nc bnc" id="L8339" title="All 2 branches missed.">                if (mountee instanceof Entity) {</span>
<span class="nc" id="L8340">                    Entity dropShip = (Entity) mountee;</span>
<span class="nc bnc" id="L8341" title="All 2 branches missed.">                    if (!dropShip.canLoad(entity)) {</span>
                        // Something is fishy in Denmark.
<span class="nc" id="L8343">                        MegaMek.getLogger().error(dropShip.getShortName() + &quot; can not load &quot; + entity.getShortName());</span>
                    } else {
                        // Have the indicated unit load this unit.
<span class="nc" id="L8346">                        entity.setDone(true);</span>
<span class="nc" id="L8347">                        loadUnit(dropShip, entity, entity.getTargetBay());</span>
<span class="nc" id="L8348">                        Bay currentBay = dropShip.getBay(entity);</span>
<span class="nc bnc" id="L8349" title="All 4 branches missed.">                        if ((null != currentBay) &amp;&amp; (Compute.d6(2) == 2)) {</span>
<span class="nc" id="L8350">                            r = new Report(9390);</span>
<span class="nc" id="L8351">                            r.subject = entity.getId();</span>
<span class="nc" id="L8352">                            r.indent(1);</span>
<span class="nc" id="L8353">                            r.add(currentBay.getType());</span>
<span class="nc" id="L8354">                            addReport(r);</span>
<span class="nc" id="L8355">                            currentBay.destroyDoorNext();</span>
                        }
                        // Stop looking.
<span class="nc" id="L8358">                        entityUpdate(dropShip.getId());</span>
<span class="nc" id="L8359">                        return;</span>
                    }
                }
            } // End STEP_MOUNT

            // handle fighter recovery, and also DropShip docking with another large craft
<span class="nc bnc" id="L8365" title="All 2 branches missed.">            if (step.getType() == MoveStepType.RECOVER) {</span>

<span class="nc" id="L8367">                loader = game.getEntity(step.getRecoveryUnit());</span>
<span class="nc" id="L8368">                boolean isDS = (entity instanceof Dropship);</span>

<span class="nc" id="L8370">                rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc bnc" id="L8371" title="All 2 branches missed.">                if (loader.mpUsed &gt; 0) {</span>
<span class="nc" id="L8372">                    rollTarget.addModifier(5, &quot;carrier used thrust&quot;);</span>
                }
<span class="nc bnc" id="L8374" title="All 2 branches missed.">                if (entity.getPartialRepairs().booleanOption(&quot;aero_collar_crit&quot;)) {</span>
<span class="nc" id="L8375">                    rollTarget.addModifier(2, &quot;misrepaired docking collar&quot;);</span>
                }
<span class="nc bnc" id="L8377" title="All 4 branches missed.">                if (isDS &amp;&amp; (((Dropship)entity).getCollarType() == Dropship.COLLAR_PROTOTYPE)) {</span>
<span class="nc" id="L8378">                    rollTarget.addModifier(2, &quot;prototype kf-boom&quot;);</span>
                }
<span class="nc" id="L8380">                int ctrlroll = Compute.d6(2);</span>
<span class="nc bnc" id="L8381" title="All 2 branches missed.">                if (isDS) {</span>
<span class="nc" id="L8382">                    r = new Report(9388);</span>
                } else {
<span class="nc" id="L8384">                    r = new Report(9381);</span>
                }
<span class="nc" id="L8386">                r.subject = entity.getId();</span>
<span class="nc" id="L8387">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L8388">                r.add(loader.getDisplayName());</span>
<span class="nc" id="L8389">                r.add(rollTarget);</span>
<span class="nc" id="L8390">                r.add(ctrlroll);</span>
<span class="nc" id="L8391">                r.newlines = 0;</span>
<span class="nc" id="L8392">                r.indent(1);</span>
<span class="nc bnc" id="L8393" title="All 2 branches missed.">                if (ctrlroll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L8394">                    r.choose(false);</span>
<span class="nc" id="L8395">                    addReport(r);</span>
                    // damage unit
<span class="nc" id="L8397">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8398">                    addReport(damageEntity(entity, hit, 2 * (rollTarget.getValue() - ctrlroll)));</span>
<span class="nc" id="L8399">                } else {</span>
<span class="nc" id="L8400">                    r.choose(true);</span>
<span class="nc" id="L8401">                    addReport(r);</span>
<span class="nc" id="L8402">                    recovered = true;</span>
                }
                // check for door damage
<span class="nc bnc" id="L8405" title="All 2 branches missed.">                if (ctrlroll == 2) {</span>
<span class="nc" id="L8406">                    loader.damageDoorRecovery(entity);</span>
<span class="nc" id="L8407">                    r = new Report(9384);</span>
<span class="nc" id="L8408">                    r.subject = entity.getId();</span>
<span class="nc" id="L8409">                    r.indent(0);</span>
<span class="nc" id="L8410">                    r.add(loader.getDisplayName());</span>
<span class="nc" id="L8411">                    addReport(r);</span>
                }
            }

            // handle fighter squadron joining
<span class="nc bnc" id="L8416" title="All 2 branches missed.">            if (step.getType() == MoveStepType.JOIN) {</span>
<span class="nc" id="L8417">                loader = game.getEntity(step.getRecoveryUnit());</span>
<span class="nc" id="L8418">                recovered = true;</span>
            }

            // Handle unloading units.
<span class="nc bnc" id="L8422" title="All 2 branches missed.">            if (step.getType() == MoveStepType.UNLOAD) {</span>
<span class="nc" id="L8423">                Targetable unloaded = step.getTarget(game);</span>
<span class="nc" id="L8424">                Coords unloadPos = curPos;</span>
<span class="nc" id="L8425">                int unloadFacing = curFacing;</span>
<span class="nc bnc" id="L8426" title="All 2 branches missed.">                if (null != step.getTargetPosition()) {</span>
<span class="nc" id="L8427">                    unloadPos = step.getTargetPosition();</span>
<span class="nc" id="L8428">                    unloadFacing = curPos.direction(unloadPos);</span>
                }
<span class="nc bnc" id="L8430" title="All 2 branches missed.">                if (!unloadUnit(entity, unloaded, unloadPos, unloadFacing,</span>
<span class="nc" id="L8431">                        step.getElevation())) {</span>
<span class="nc" id="L8432">                    MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L8433">                                    + unloaded.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L8434">                                    + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L8435">                                    + curPos.getBoardNum());</span>
                }
                // some additional stuff to take care of for small
                // craft/DropShip unloading
<span class="nc bnc" id="L8439" title="All 4 branches missed.">                if ((entity instanceof SmallCraft) &amp;&amp; (unloaded instanceof Entity)) {</span>
<span class="nc" id="L8440">                    Bay currentBay = entity.getBay((Entity) unloaded);</span>
<span class="nc bnc" id="L8441" title="All 4 branches missed.">                    if ((null != currentBay) &amp;&amp; (Compute.d6(2) == 2)) {</span>
<span class="nc" id="L8442">                        r = new Report(9390);</span>
<span class="nc" id="L8443">                        r.subject = entity.getId();</span>
<span class="nc" id="L8444">                        r.indent(1);</span>
<span class="nc" id="L8445">                        r.add(currentBay.getType());</span>
<span class="nc" id="L8446">                        addReport(r);</span>
<span class="nc" id="L8447">                        currentBay.destroyDoorNext();</span>
                    }
                    // now apply any damage to bay doors
<span class="nc" id="L8450">                    entity.resetBayDoors();</span>
<span class="nc" id="L8451">                    entityUpdate(entity.getId());</span>
                    // ok now add another turn for the transport so it can
                    // continue to unload units
<span class="nc bnc" id="L8454" title="All 2 branches missed.">                    if (entity.getUnitsUnloadableFromBays().size() &gt; 0) {</span>
<span class="nc" id="L8455">                        dropshipStillUnloading = true;</span>
<span class="nc" id="L8456">                        GameTurn newTurn = new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L8457">                                entity.getOwner().getId(), entity.getId());</span>
                        // Need to set the new turn's multiTurn state
<span class="nc" id="L8459">                        newTurn.setMultiTurn(true);</span>
<span class="nc" id="L8460">                        game.insertNextTurn(newTurn);</span>
                    }
                    // ok add another turn for the unloaded entity so that it
                    // can move
<span class="nc bnc" id="L8464" title="All 2 branches missed.">                    if (!(unloaded instanceof Infantry)) {</span>
<span class="nc" id="L8465">                        GameTurn newTurn = new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L8466">                                ((Entity) unloaded).getOwner().getId(),</span>
<span class="nc" id="L8467">                                ((Entity) unloaded).getId());</span>
                        // Need to set the new turn's multiTurn state
<span class="nc" id="L8469">                        newTurn.setMultiTurn(true);</span>
<span class="nc" id="L8470">                        game.insertNextTurn(newTurn);</span>
                    }
                    // brief everybody on the turn update
<span class="nc" id="L8473">                    send(createTurnVectorPacket());</span>
                }
            }

            // Handle disconnecting trailers.
<span class="nc bnc" id="L8478" title="All 2 branches missed.">            if (step.getType() == MoveStepType.DISCONNECT) {</span>
<span class="nc" id="L8479">                Targetable unloaded = step.getTarget(game);</span>
<span class="nc" id="L8480">                Coords unloadPos = curPos;</span>
<span class="nc bnc" id="L8481" title="All 2 branches missed.">                if (null != step.getTargetPosition()) {</span>
<span class="nc" id="L8482">                    unloadPos = step.getTargetPosition();</span>
                }
<span class="nc bnc" id="L8484" title="All 2 branches missed.">                if (!disconnectUnit(entity, unloaded, unloadPos)) {</span>
<span class="nc" id="L8485">                    MegaMek.getLogger().error(&quot;Server was told to disconnect &quot;</span>
<span class="nc" id="L8486">                                    + unloaded.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L8487">                                    + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L8488">                                    + curPos.getBoardNum());</span>
                }
            }

            // moving backwards over elevation change
<span class="nc bnc" id="L8493" title="All 2 branches missed.">            if (((step.getType() == MoveStepType.BACKWARDS)</span>
<span class="nc bnc" id="L8494" title="All 2 branches missed.">                    || (step.getType() == MoveStepType.LATERAL_LEFT_BACKWARDS)</span>
<span class="nc bnc" id="L8495" title="All 2 branches missed.">                    || (step.getType() == MoveStepType.LATERAL_RIGHT_BACKWARDS))</span>
<span class="nc bnc" id="L8496" title="All 2 branches missed.">                    &amp;&amp; !(md.isJumping()</span>
<span class="nc bnc" id="L8497" title="All 2 branches missed.">                            &amp;&amp; (entity.getJumpType() == Mech.JUMP_BOOSTER))</span>
<span class="nc bnc" id="L8498" title="All 6 branches missed.">                    &amp;&amp; (lastHex.getLevel() + lastElevation != curHex.getLevel() + step.getElevation())</span>
                    &amp;&amp; !(entity instanceof VTOL)
                    &amp;&amp; !(curClimbMode
<span class="nc bnc" id="L8501" title="All 2 branches missed.">                            &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc" id="L8502">                            &amp;&amp; ((curHex.terrainLevel(Terrains.BRIDGE_ELEV)</span>
<span class="nc" id="L8503">                                    + curHex.getLevel()) == (prevHex.getLevel()</span>
<span class="nc bnc" id="L8504" title="All 2 branches missed.">                                            + (prevHex.containsTerrain(</span>
                                                    Terrains.BRIDGE)
                                                            ? prevHex
<span class="nc" id="L8507">                                                                    .terrainLevel(</span>
                                                                            Terrains.BRIDGE_ELEV)
<span class="nc bnc" id="L8509" title="All 2 branches missed.">                                                            : 0))))) {</span>

                // per TacOps, if the mech is walking backwards over an elevation change and falls
                // it falls into the lower hex. The caveat is if it already fell from some other PSR in this 
                // invocation of processMovement, then it can't fall again. 
<span class="nc bnc" id="L8514" title="All 2 branches missed.">                if ((entity instanceof Mech) &amp;&amp; (curHex.getLevel() &lt; game</span>
<span class="nc bnc" id="L8515" title="All 4 branches missed.">                        .getBoard().getHex(lastPos).getLevel()) &amp;&amp; !entity.hasFallen()) {</span>
<span class="nc" id="L8516">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8517">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc" id="L8519">                    doSkillCheckWhileMoving(entity, entity.getElevation(),</span>
                            curPos, curPos, rollTarget, true);
<span class="nc bnc" id="L8521" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; !entity.hasFallen()) {</span>
<span class="nc" id="L8522">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8523">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc" id="L8525">                    doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            lastPos, rollTarget, true);
<span class="nc bnc" id="L8527" title="All 2 branches missed.">                } else if (entity instanceof Tank) {</span>
<span class="nc" id="L8528">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8529">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc bnc" id="L8531" title="All 2 branches missed.">                    if (doSkillCheckWhileMoving(entity, entity.getElevation(),</span>
                            curPos, lastPos, rollTarget, false) &lt; 0) {
<span class="nc" id="L8533">                        curPos = lastPos;</span>
                    }
                }

            }

            // Handle non-infantry moving into a building.
<span class="nc bnc" id="L8540" title="All 2 branches missed.">            if (buildingMove &gt; 0) {</span>

                // Get the building being exited.
<span class="nc" id="L8543">                Building bldgExited = null;</span>
<span class="nc bnc" id="L8544" title="All 2 branches missed.">                if ((buildingMove &amp; 1) == 1) {</span>
<span class="nc" id="L8545">                    bldgExited = game.getBoard().getBuildingAt(lastPos);</span>
                }

                // Get the building being entered.
<span class="nc" id="L8549">                Building bldgEntered = null;</span>
<span class="nc bnc" id="L8550" title="All 2 branches missed.">                if ((buildingMove &amp; 2) == 2) {</span>
<span class="nc" id="L8551">                    bldgEntered = game.getBoard().getBuildingAt(curPos);</span>
                }

                // ProtoMechs changing levels within a building cause damage
<span class="nc bnc" id="L8555" title="All 4 branches missed.">                if (((buildingMove &amp; 8) == 8) &amp;&amp; (entity instanceof Protomech)) {</span>
<span class="nc" id="L8556">                    Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc" id="L8557">                    Vector&lt;Report&gt; vBuildingReport = damageBuilding(bldg, 1, curPos);</span>
<span class="nc bnc" id="L8558" title="All 2 branches missed.">                    for (Report report : vBuildingReport) {</span>
<span class="nc" id="L8559">                        report.subject = entity.getId();</span>
<span class="nc" id="L8560">                    }</span>
<span class="nc" id="L8561">                    addReport(vBuildingReport);</span>
                }

<span class="nc" id="L8564">                boolean collapsed = false;</span>
<span class="nc bnc" id="L8565" title="All 2 branches missed.">                if ((bldgEntered != null)) {</span>
                    // If we're not leaving a building, just handle the
                    // &quot;entered&quot;.
                    String reason;
<span class="nc bnc" id="L8569" title="All 2 branches missed.">                    if (bldgExited == null) {</span>
<span class="nc" id="L8570">                        reason = &quot;entering&quot;;</span>
                    }
                    // If we're moving within the same building, just handle
                    // the &quot;within&quot;.
<span class="nc bnc" id="L8574" title="All 6 branches missed.">                    else if (bldgExited.equals(bldgEntered)</span>
                            &amp;&amp; !(entity instanceof Protomech)
                            &amp;&amp; !(entity instanceof Infantry)) {
<span class="nc" id="L8577">                        reason = &quot;moving in&quot;;</span>
                    }
                    // If we have different buildings, roll for each.
                    else {
<span class="nc" id="L8581">                        reason = &quot;entering&quot;;</span>
                    }
<span class="nc" id="L8583">                    passBuildingWall(entity, bldgEntered, lastPos, curPos,</span>
<span class="nc" id="L8584">                            distance, reason, step.isThisStepBackwards(),</span>
                            lastStepMoveType, true);
<span class="nc" id="L8586">                    addAffectedBldg(bldgEntered, collapsed);</span>
                }

                // Clean up the entity if it has been destroyed.
<span class="nc bnc" id="L8590" title="All 2 branches missed.">                if (entity.isDoomed()) {</span>
<span class="nc" id="L8591">                    entity.setDestroyed(true);</span>
<span class="nc" id="L8592">                    game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L8593">                    send(createRemoveEntityPacket(entity.getId()));</span>

                    // The entity's movement is completed.
<span class="nc" id="L8596">                    return;</span>
                }

                // TODO : what if a building collapses into rubble?
            }

<span class="nc bnc" id="L8602" title="All 2 branches missed.">            if (stepMoveType != EntityMovementType.MOVE_JUMP</span>
<span class="nc bnc" id="L8603" title="All 2 branches missed.">                    &amp;&amp; (step.getClearance() == 0</span>
<span class="nc bnc" id="L8604" title="All 4 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; step.getClearance() == 1)</span>
<span class="nc bnc" id="L8605" title="All 2 branches missed.">                        || curElevation == curHex.terrainLevel(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L8606" title="All 2 branches missed.">                        || curElevation == curHex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L8607">                Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L8608" title="All 4 branches missed.">                if ((bldg != null) &amp;&amp; (entity.getElevation() &gt;= 0)) {</span>
<span class="nc bnc" id="L8609" title="All 2 branches missed.">                    boolean wigeFlyingOver = entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L8610" title="All 2 branches missed.">                            &amp;&amp; ((curHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L8611" title="All 2 branches missed.">                                    &amp;&amp; curElevation &gt; curHex.terrainLevel(Terrains.BLDG_ELEV)) ||</span>
<span class="nc bnc" id="L8612" title="All 2 branches missed.">                            (curHex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc bnc" id="L8613" title="All 2 branches missed.">                                    &amp;&amp; curElevation &gt; curHex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
<span class="nc" id="L8614">                    boolean collapse = checkBuildingCollapseWhileMoving(bldg, entity, curPos);</span>
<span class="nc" id="L8615">                    addAffectedBldg(bldg, collapse);</span>
                    // If the building is collapsed by a WiGE flying over it, the WiGE drops one level of elevation.
                    // This could invalidate the remainder of the movement path, so we will send it back to the client.
<span class="nc bnc" id="L8618" title="All 4 branches missed.">                    if (collapse &amp;&amp; wigeFlyingOver) {</span>
<span class="nc" id="L8619">                        curElevation--;</span>
<span class="nc" id="L8620">                        r = new Report(2378);</span>
<span class="nc" id="L8621">                        r.subject = entity.getId();</span>
<span class="nc" id="L8622">                        r.addDesc(entity);</span>
<span class="nc" id="L8623">                        addReport(r);</span>
<span class="nc" id="L8624">                        continueTurnFromLevelDrop = true;</span>
<span class="nc" id="L8625">                        entity.setPosition(curPos);</span>
<span class="nc" id="L8626">                        entity.setFacing(curFacing);</span>
<span class="nc" id="L8627">                        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L8628">                        entity.setElevation(curElevation);</span>
<span class="nc" id="L8629">                        break;</span>
                    }
                }
            }
            
            // Sheer Cliffs, TO p.39
<span class="nc bnc" id="L8635" title="All 2 branches missed.">            boolean vehicleAffectedByCliff = entity instanceof Tank </span>
<span class="nc bnc" id="L8636" title="All 2 branches missed.">                    &amp;&amp; !entity.isAirborneVTOLorWIGE();</span>
<span class="nc bnc" id="L8637" title="All 2 branches missed.">            boolean quadveeVehMode = entity instanceof QuadVee</span>
<span class="nc bnc" id="L8638" title="All 2 branches missed.">                    &amp;&amp; ((QuadVee)entity).getConversionMode() == QuadVee.CONV_MODE_VEHICLE;</span>
<span class="nc bnc" id="L8639" title="All 6 branches missed.">            boolean mechAffectedByCliff = (entity instanceof Mech || entity instanceof Protomech)</span>
                    &amp;&amp; moveType != EntityMovementType.MOVE_JUMP
<span class="nc bnc" id="L8641" title="All 2 branches missed.">                    &amp;&amp; !entity.isAero();</span>
            // Cliffs should only exist towards 1 or 2 level drops, check just to make sure
            // Everything that does not have a 1 or 2 level drop shouldn't be handled as a cliff
<span class="nc" id="L8644">            int stepHeight = curElevation + curHex.getLevel() </span>
<span class="nc" id="L8645">                    - (lastElevation + prevHex.getLevel());</span>
<span class="nc bnc" id="L8646" title="All 2 branches missed.">            boolean isUpCliff = !lastPos.equals(curPos) </span>
<span class="nc bnc" id="L8647" title="All 6 branches missed.">                    &amp;&amp; curHex.hasCliffTopTowards(prevHex)</span>
                    &amp;&amp; (stepHeight == 1 || stepHeight == 2);
<span class="nc bnc" id="L8649" title="All 2 branches missed.">            boolean isDownCliff = !lastPos.equals(curPos) </span>
<span class="nc bnc" id="L8650" title="All 6 branches missed.">                    &amp;&amp; prevHex.hasCliffTopTowards(curHex)</span>
                    &amp;&amp; (stepHeight == -1 || stepHeight == -2);

            // Vehicles (exc. WIGE/VTOL) moving down a cliff
<span class="nc bnc" id="L8654" title="All 6 branches missed.">            if (vehicleAffectedByCliff &amp;&amp; isDownCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8655">                rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L8656">                rollTarget.append(new PilotingRollData(entity.getId(), 0, &quot;moving down a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8657" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, curPos, rollTarget, false) &gt; 0) {
<span class="nc" id="L8659">                    addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
<span class="nc" id="L8660">                    addNewLines();</span>
<span class="nc" id="L8661">                    turnOver = true;</span>
<span class="nc" id="L8662">                    break;</span>
                }
            }

            // Mechs and Protomechs moving down a cliff
            // Quadvees in vee mode ignore PSRs to avoid falls, IO p.133
<span class="nc bnc" id="L8668" title="All 8 branches missed.">            if (mechAffectedByCliff &amp;&amp; !quadveeVehMode &amp;&amp; isDownCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8669">                rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L8670">                rollTarget.append(new PilotingRollData(entity.getId(), -stepHeight - 1, &quot;moving down a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8671" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, curPos, rollTarget, true) &gt; 0) {
<span class="nc" id="L8673">                    addNewLines();</span>
<span class="nc" id="L8674">                    turnOver = true;</span>
<span class="nc" id="L8675">                    break;</span>
                }
            }

            // Mechs moving up a cliff
<span class="nc bnc" id="L8680" title="All 8 branches missed.">            if (mechAffectedByCliff &amp;&amp; !quadveeVehMode &amp;&amp; isUpCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8681">                rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L8682">                rollTarget.append(new PilotingRollData(entity.getId(), stepHeight, &quot;moving up a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8683" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, lastPos, rollTarget, false) &gt; 0) {
<span class="nc" id="L8685">                    r = new Report(2209);</span>
<span class="nc" id="L8686">                    r.addDesc(entity);</span>
<span class="nc" id="L8687">                    r.subject = entity.getId();</span>
<span class="nc" id="L8688">                    addReport(r);</span>
<span class="nc" id="L8689">                    addNewLines();</span>
<span class="nc" id="L8690">                    curPos = entity.getPosition();</span>
<span class="nc" id="L8691">                    mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8692">                    continueTurnFromCliffAscent = true;</span>
<span class="nc" id="L8693">                    break;</span>
                }
            }

            // did the entity just fall?
<span class="nc bnc" id="L8698" title="All 4 branches missed.">            if (!wasProne &amp;&amp; entity.isProne()) {</span>
<span class="nc" id="L8699">                curFacing = entity.getFacing();</span>
<span class="nc" id="L8700">                curPos = entity.getPosition();</span>
<span class="nc" id="L8701">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8702">                fellDuringMovement = true;</span>
<span class="nc" id="L8703">                break;</span>
            }

            // dropping prone intentionally?
<span class="nc bnc" id="L8707" title="All 2 branches missed.">            if (step.getType() == MoveStepType.GO_PRONE) {</span>
<span class="nc" id="L8708">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8709">                rollTarget = entity.checkDislodgeSwarmers(step, overallMoveType);</span>
<span class="nc bnc" id="L8710" title="All 2 branches missed.">                if (rollTarget.getValue() == TargetRoll.CHECK_FALSE) {</span>
                    // Not being swarmed
<span class="nc" id="L8712">                    entity.setProne(true);</span>
                    // check to see if we washed off infernos
<span class="nc" id="L8714">                    checkForWashedInfernos(entity, curPos);</span>
                } else {
                    // Being swarmed
<span class="nc" id="L8717">                    entity.setPosition(curPos);</span>
<span class="nc bnc" id="L8718" title="All 2 branches missed.">                    if (doDislodgeSwarmerSkillCheck(entity, rollTarget, curPos)) {</span>
                        // Entity falls
<span class="nc" id="L8720">                        curFacing = entity.getFacing();</span>
<span class="nc" id="L8721">                        curPos = entity.getPosition();</span>
<span class="nc" id="L8722">                        fellDuringMovement = true;</span>
<span class="nc" id="L8723">                        break;</span>
                    }
                    // roll failed, go prone but don't dislodge swarmers
<span class="nc" id="L8726">                    entity.setProne(true);</span>
                    // check to see if we washed off infernos
<span class="nc" id="L8728">                    checkForWashedInfernos(entity, curPos);</span>
<span class="nc" id="L8729">                    break;</span>
                }
            }

            // going hull down
<span class="nc bnc" id="L8734" title="All 2 branches missed.">            if (step.getType() == MoveStepType.HULL_DOWN) {</span>
<span class="nc" id="L8735">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8736">                entity.setHullDown(true);</span>
            }

            // Check for crushing buildings by Dropships/Mobile Structures
<span class="nc bnc" id="L8740" title="All 2 branches missed.">            for (Coords pos : step.getCrushedBuildingLocs()) {</span>
<span class="nc" id="L8741">                Building bldg = game.getBoard().getBuildingAt(pos);</span>
<span class="nc" id="L8742">                IHex hex = game.getBoard().getHex(pos);</span>

<span class="nc" id="L8744">                r = new Report(3443);</span>
<span class="nc" id="L8745">                r.subject = entity.getId();</span>
<span class="nc" id="L8746">                r.addDesc(entity);</span>
<span class="nc" id="L8747">                r.add(bldg.getName());</span>
<span class="nc" id="L8748">                vPhaseReport.add(r);</span>

<span class="nc" id="L8750">                final int cf = bldg.getCurrentCF(pos);</span>
<span class="nc" id="L8751">                final int numFloors = Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L8752">                vPhaseReport.addAll(damageBuilding(bldg, 150, &quot; is crushed for &quot;, pos));</span>
<span class="nc" id="L8753">                int damage = (int) Math.round((cf / 10.0) * numFloors);</span>
<span class="nc" id="L8754">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8755">                vPhaseReport.addAll(damageEntity(entity, hit, damage));</span>
<span class="nc" id="L8756">            }</span>

            // Track this step's location.
<span class="nc" id="L8759">            movePath.addElement(new UnitLocation(entity.getId(), curPos,</span>
<span class="nc" id="L8760">                    curFacing, step.getElevation()));</span>

            // if the lastpos is not the same as the current position
            // then add the current position to the list of places passed
            // through
<span class="nc bnc" id="L8765" title="All 2 branches missed.">            if (!curPos.equals(lastPos)) {</span>
<span class="nc" id="L8766">                passedThrough.add(curPos);</span>
<span class="nc" id="L8767">                passedThroughFacing.add(curFacing);</span>
            }

            // update lastPos, prevStep, prevFacing &amp; prevHex
<span class="nc bnc" id="L8771" title="All 2 branches missed.">            if (!curPos.equals(lastPos)) {</span>
<span class="nc" id="L8772">                prevFacing = curFacing;</span>
            }
<span class="nc" id="L8774">            lastPos = curPos;</span>
<span class="nc" id="L8775">            lastElevation = curElevation;</span>
<span class="nc" id="L8776">            prevStep = step;</span>
<span class="nc" id="L8777">            prevHex = curHex;</span>

<span class="nc" id="L8779">            firstStep = false;</span>
<span class="nc" id="L8780">        }</span>

        // set entity parameters
<span class="nc" id="L8783">        entity.setPosition(curPos);</span>
<span class="nc" id="L8784">        entity.setFacing(curFacing);</span>
<span class="nc" id="L8785">        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L8786">        entity.delta_distance = distance;</span>
<span class="nc" id="L8787">        entity.moved = moveType;</span>
<span class="nc" id="L8788">        entity.mpUsed = mpUsed;</span>
<span class="nc" id="L8789">        entity.setClimbMode(curClimbMode);</span>
<span class="nc bnc" id="L8790" title="All 6 branches missed.">        if (!sideslipped &amp;&amp; !fellDuringMovement &amp;&amp; !crashedDuringMovement</span>
<span class="nc bnc" id="L8791" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L8792">            entity.setElevation(curVTOLElevation);</span>
        }
<span class="nc" id="L8794">        entity.setAltitude(curAltitude);</span>
<span class="nc" id="L8795">        entity.setClimbMode(curClimbMode);</span>

        // add a list of places passed through
<span class="nc" id="L8798">        entity.setPassedThrough(passedThrough);</span>
<span class="nc" id="L8799">        entity.setPassedThroughFacing(passedThroughFacing);</span>

        // if we ran with destroyed hip or gyro, we need a psr
<span class="nc" id="L8802">        rollTarget = entity.checkRunningWithDamage(overallMoveType);</span>
<span class="nc bnc" id="L8803" title="All 4 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8804">            doSkillCheckInPlace(entity, rollTarget);</span>
        }

        // if we sprinted with MASC or a supercharger, then we need a PSR
<span class="nc" id="L8808">        rollTarget = entity.checkSprintingWithMASC(overallMoveType,</span>
                entity.mpUsed);
<span class="nc bnc" id="L8810" title="All 4 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8811">            doSkillCheckInPlace(entity, rollTarget);</span>
        }

        // if we used ProtoMech myomer booster, roll 2d6
        // pilot damage on a 2
<span class="nc bnc" id="L8816" title="All 4 branches missed.">        if ((entity instanceof Protomech) &amp;&amp; ((Protomech) entity).hasMyomerBooster()</span>
<span class="nc" id="L8817">                &amp;&amp; (md.getMpUsed() &gt; ((Protomech) entity)</span>
<span class="nc bnc" id="L8818" title="All 2 branches missed.">                        .getRunMPwithoutMyomerBooster(true, false, false))) {</span>
<span class="nc" id="L8819">            r = new Report(2373);</span>
<span class="nc" id="L8820">            r.addDesc(entity);</span>
<span class="nc" id="L8821">            r.subject = entity.getId();</span>
<span class="nc" id="L8822">            int roll = Compute.d6(2);</span>
<span class="nc" id="L8823">            r.add(roll);</span>
<span class="nc bnc" id="L8824" title="All 2 branches missed.">            if (roll &gt; 2) {</span>
<span class="nc" id="L8825">                r.choose(true);</span>
<span class="nc" id="L8826">                addReport(r);</span>
            } else {
<span class="nc" id="L8828">                r.choose(false);</span>
<span class="nc" id="L8829">                addReport(r);</span>
<span class="nc" id="L8830">                addReport(damageCrew(entity, 1));</span>
            }
        }

<span class="nc" id="L8834">        rollTarget = entity.checkSprintingWithSupercharger(overallMoveType, entity.mpUsed);</span>
<span class="nc bnc" id="L8835" title="All 2 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8836">            doSkillCheckInPlace(entity, rollTarget);</span>
        }
<span class="nc bnc" id="L8838" title="All 2 branches missed.">        if ((md.getLastStepMovementType() == EntityMovementType.MOVE_SPRINT)</span>
<span class="nc bnc" id="L8839" title="All 4 branches missed.">                &amp;&amp; md.hasActiveMASC() &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8840">            doSkillCheckInPlace(entity, entity.getBasePilotingRoll(EntityMovementType.MOVE_SPRINT));</span>
        }

<span class="nc bnc" id="L8843" title="All 4 branches missed.">        if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>

<span class="nc" id="L8845">            IAero a = (IAero) entity;</span>
<span class="nc" id="L8846">            int thrust = md.getMpUsed();</span>

            // consume fuel
<span class="nc bnc" id="L8849" title="All 2 branches missed.">            if (((entity.isAero())</span>
<span class="nc bnc" id="L8850" title="All 4 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_FUEL_CONSUMPTION))</span>
                    || (entity instanceof TeleMissile)) {
<span class="nc" id="L8852">                int fuelUsed = ((IAero) entity).getFuelUsed(thrust);</span>
<span class="nc" id="L8853">                a.useFuel(fuelUsed);</span>
            }

            // JumpShips and space stations need to reduce accumulated thrust if
            // they spend some
<span class="nc bnc" id="L8858" title="All 2 branches missed.">            if (entity instanceof Jumpship) {</span>
<span class="nc" id="L8859">                Jumpship js = (Jumpship) entity;</span>
<span class="nc" id="L8860">                double penalty = 0.0;</span>
                // JumpShips do not accumulate thrust when they make a turn or
                // change velocity
<span class="nc bnc" id="L8863" title="All 4 branches missed.">                if (md.contains(MoveStepType.TURN_LEFT) || md.contains(MoveStepType.TURN_RIGHT)) {</span>
                    // I need to subtract the station keeping thrust from their
                    // accumulated thrust
                    // because they did not actually use it
<span class="nc" id="L8867">                    penalty = js.getStationKeepingThrust();</span>
                }
<span class="nc bnc" id="L8869" title="All 2 branches missed.">                if (thrust &gt; 0) {</span>
<span class="nc" id="L8870">                    penalty = thrust;</span>
                }
<span class="nc bnc" id="L8872" title="All 2 branches missed.">                if (penalty &gt; 0.0) {</span>
<span class="nc" id="L8873">                    js.setAccumulatedThrust(Math.max(0, js.getAccumulatedThrust() - penalty));</span>
                }
            }

            // check to see if thrust exceeded SI

<span class="nc" id="L8879">            rollTarget = a.checkThrustSITotal(thrust, overallMoveType);</span>
<span class="nc bnc" id="L8880" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8881">                game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                        &quot;Thrust spent during turn exceeds SI&quot;));
            }

<span class="nc bnc" id="L8885" title="All 2 branches missed.">            if (!game.getBoard().inSpace()) {</span>
<span class="nc" id="L8886">                rollTarget = a.checkVelocityDouble(md.getFinalVelocity(),</span>
                        overallMoveType);
<span class="nc bnc" id="L8888" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8889">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                            &quot;Velocity greater than 2x safe thrust&quot;));
                }

<span class="nc" id="L8893">                rollTarget = a.checkDown(md.getFinalNDown(), overallMoveType);</span>
<span class="nc bnc" id="L8894" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8895">                    game.addControlRoll(</span>
<span class="nc" id="L8896">                            new PilotingRollData(entity.getId(), md.getFinalNDown(),</span>
                                    &quot;descended more than two altitudes&quot;));
                }

                // check for hovering
<span class="nc" id="L8901">                rollTarget = a.checkHover(md);</span>
<span class="nc bnc" id="L8902" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8903">                    game.addControlRoll(</span>
<span class="nc" id="L8904">                            new PilotingRollData(entity.getId(), 0, &quot;hovering&quot;));</span>
                }

                // check for aero stall
<span class="nc" id="L8908">                rollTarget = a.checkStall(md);</span>
<span class="nc bnc" id="L8909" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8910">                    r = new Report(9391);</span>
<span class="nc" id="L8911">                    r.subject = entity.getId();</span>
<span class="nc" id="L8912">                    r.addDesc(entity);</span>
<span class="nc" id="L8913">                    addReport(r);</span>
<span class="nc" id="L8914">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                            &quot;stalled out&quot;));
<span class="nc" id="L8916">                    entity.setAltitude(entity.getAltitude() - 1);</span>
                    // check for crash
<span class="nc bnc" id="L8918" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L8919">                        addReport(processCrash(entity, 0, entity.getPosition()));</span>
                    }
                }

                // check to see if spheroids should lose one altitude
<span class="nc bnc" id="L8924" title="All 4 branches missed.">                if (a.isSpheroid() &amp;&amp; !a.isSpaceborne()</span>
<span class="nc bnc" id="L8925" title="All 6 branches missed.">                        &amp;&amp; a.isAirborne() &amp;&amp; (md.getFinalNDown() == 0) &amp;&amp; (md.getMpUsed() == 0)) {</span>
<span class="nc" id="L8926">                    r = new Report(9392);</span>
<span class="nc" id="L8927">                    r.subject = entity.getId();</span>
<span class="nc" id="L8928">                    r.addDesc(entity);</span>
<span class="nc" id="L8929">                    addReport(r);</span>
<span class="nc" id="L8930">                    entity.setAltitude(entity.getAltitude() - 1);</span>
                    // check for crash
<span class="nc bnc" id="L8932" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L8933">                        addReport(processCrash(entity, 0, entity.getPosition()));</span>
                    }
<span class="nc bnc" id="L8935" title="All 6 branches missed.">                } else if (entity instanceof EscapePods &amp;&amp; entity.isAirborne() &amp;&amp; md.getFinalVelocity() &lt; 2) {</span>
                    //Atmospheric Escape Pods that drop below velocity 2 lose altitude as dropping units
<span class="nc" id="L8937">                    entity.setAltitude(entity.getAltitude()</span>
<span class="nc" id="L8938">                            - game.getPlanetaryConditions().getDropRate());</span>
<span class="nc" id="L8939">                    r = new Report(6676);</span>
<span class="nc" id="L8940">                    r.subject = entity.getId();</span>
<span class="nc" id="L8941">                    r.addDesc(entity);</span>
<span class="nc" id="L8942">                    r.add(game.getPlanetaryConditions().getDropRate());</span>
<span class="nc" id="L8943">                    addReport(r);</span>
                }
            }
        }

        // We need to check for the removal of hull-down for tanks.
        // Tanks can just drive out of hull-down: if the tank was hull-down
        // and doesn't end hull-down we can remove the hull-down status
<span class="nc bnc" id="L8951" title="All 8 branches missed.">        if (entity.isHullDown() &amp;&amp; !md.getFinalHullDown()</span>
                &amp;&amp; (entity instanceof Tank
<span class="nc bnc" id="L8953" title="All 2 branches missed.">                || (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE))) {</span>
<span class="nc" id="L8954">            entity.setHullDown(false);</span>
        }

        // If the entity is being swarmed, erratic movement may dislodge the
        // fleas.
<span class="nc" id="L8959">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L8960" title="All 4 branches missed.">        if ((Entity.NONE != swarmerId) &amp;&amp; md.contains(MoveStepType.SHAKE_OFF_SWARMERS)) {</span>
<span class="nc" id="L8961">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L8962">            rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L8964">            entity.addPilotingModifierForTerrain(rollTarget);</span>

            // Add a +4 modifier.
<span class="nc bnc" id="L8967" title="All 2 branches missed.">            if (md.getLastStepMovementType() == EntityMovementType.MOVE_VTOL_RUN) {</span>
<span class="nc" id="L8968">                rollTarget.addModifier(2,</span>
                        &quot;dislodge swarming infantry with VTOL movement&quot;);
            } else {
<span class="nc" id="L8971">                rollTarget.addModifier(4, &quot;dislodge swarming infantry&quot;);</span>
            }

            // If the swarmer has Assault claws, give a 1 modifier.
            // We can stop looking when we find our first match.
<span class="nc bnc" id="L8976" title="All 2 branches missed.">            for (Mounted mount : swarmer.getMisc()) {</span>
<span class="nc" id="L8977">                EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L8978" title="All 2 branches missed.">                if (equip.hasFlag(MiscType.F_MAGNET_CLAW)) {</span>
<span class="nc" id="L8979">                    rollTarget.addModifier(1, &quot;swarmer has magnetic claws&quot;);</span>
<span class="nc" id="L8980">                    break;</span>
                }
<span class="nc" id="L8982">            }</span>

            // okay, print the info
<span class="nc" id="L8985">            r = new Report(2125);</span>
<span class="nc" id="L8986">            r.subject = entity.getId();</span>
<span class="nc" id="L8987">            r.addDesc(entity);</span>
<span class="nc" id="L8988">            addReport(r);</span>

            // roll
<span class="nc" id="L8991">            final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L8992">            r = new Report(2130);</span>
<span class="nc" id="L8993">            r.subject = entity.getId();</span>
<span class="nc" id="L8994">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L8995">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L8996">            r.add(diceRoll);</span>
<span class="nc bnc" id="L8997" title="All 2 branches missed.">            if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L8998">                r.choose(false);</span>
<span class="nc" id="L8999">                addReport(r);</span>
            } else {
                // Dislodged swarmers don't get turns.
<span class="nc" id="L9002">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L9003">                send(createTurnVectorPacket());</span>

                // Update the report and the swarmer's status.
<span class="nc" id="L9006">                r.choose(true);</span>
<span class="nc" id="L9007">                addReport(r);</span>
<span class="nc" id="L9008">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9009">                swarmer.setSwarmTargetId(Entity.NONE);</span>

<span class="nc" id="L9011">                IHex curHex = game.getBoard().getHex(curPos);</span>

                // Did the infantry fall into water?
<span class="nc bnc" id="L9014" title="All 2 branches missed.">                if (curHex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
                    // Swarming infantry die.
<span class="nc" id="L9016">                    swarmer.setPosition(curPos);</span>
<span class="nc" id="L9017">                    r = new Report(2135);</span>
<span class="nc" id="L9018">                    r.subject = entity.getId();</span>
<span class="nc" id="L9019">                    r.indent();</span>
<span class="nc" id="L9020">                    r.addDesc(swarmer);</span>
<span class="nc" id="L9021">                    addReport(r);</span>
<span class="nc" id="L9022">                    addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
                } else {
                    // Swarming infantry take a 3d6 point hit.
                    // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L9026">                    r = new Report(2140);</span>
<span class="nc" id="L9027">                    r.subject = entity.getId();</span>
<span class="nc" id="L9028">                    r.indent();</span>
<span class="nc" id="L9029">                    r.addDesc(swarmer);</span>
<span class="nc" id="L9030">                    r.add(&quot;3d6&quot;);</span>
<span class="nc" id="L9031">                    addReport(r);</span>
<span class="nc" id="L9032">                    addReport(damageEntity(swarmer,</span>
<span class="nc" id="L9033">                            swarmer.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),</span>
<span class="nc" id="L9034">                            Compute.d6(3)));</span>
<span class="nc" id="L9035">                    addNewLines();</span>
<span class="nc" id="L9036">                    swarmer.setPosition(curPos);</span>
                }
<span class="nc" id="L9038">                entityUpdate(swarmerId);</span>
            } // End successful-PSR

        } // End try-to-dislodge-swarmers

        // but the danger isn't over yet! landing from a jump can be risky!
<span class="nc bnc" id="L9044" title="All 4 branches missed.">        if ((overallMoveType == EntityMovementType.MOVE_JUMP) &amp;&amp; !entity.isMakingDfa()) {</span>
<span class="nc" id="L9045">            final IHex curHex = game.getBoard().getHex(curPos);</span>
            // check for damaged criticals
<span class="nc" id="L9047">            rollTarget = entity.checkLandingWithDamage(overallMoveType);</span>
<span class="nc bnc" id="L9048" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9049">                doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // check for prototype JJs
<span class="nc" id="L9052">            rollTarget = entity.checkLandingWithPrototypeJJ(overallMoveType);</span>
<span class="nc bnc" id="L9053" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9054">                doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // check for jumping into heavy woods
<span class="nc bnc" id="L9057" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_PSR_JUMP_HEAVY_WOODS)) {</span>
<span class="nc" id="L9058">                rollTarget = entity.checkLandingInHeavyWoods(overallMoveType, curHex);</span>
<span class="nc bnc" id="L9059" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9060">                    doSkillCheckInPlace(entity, rollTarget);</span>
                }
            }
            // Mechanical jump boosters fall damage
<span class="nc bnc" id="L9064" title="All 2 branches missed.">            if (md.shouldMechanicalJumpCauseFallDamage()) {</span>
<span class="nc" id="L9065">                vPhaseReport.addAll(doEntityFallsInto(entity,</span>
<span class="nc" id="L9066">                        entity.getElevation(), md.getJumpPathHighestPoint(),</span>
<span class="nc" id="L9067">                        curPos, entity.getBasePilotingRoll(overallMoveType),</span>
<span class="nc" id="L9068">                        false, entity.getJumpMP()));</span>
            }
            // jumped into water?
<span class="nc" id="L9071">            int waterLevel = curHex.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L9072" title="All 4 branches missed.">            if (curHex.containsTerrain(Terrains.ICE) &amp;&amp; (waterLevel &gt; 0)) {</span>
<span class="nc bnc" id="L9073" title="All 2 branches missed.">                if (!(entity instanceof Infantry)) {</span>
                    // check for breaking ice
<span class="nc" id="L9075">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L9076">                    r = new Report(2122);</span>
<span class="nc" id="L9077">                    r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L9078">                    r.add(roll);</span>
<span class="nc" id="L9079">                    r.subject = entity.getId();</span>
<span class="nc" id="L9080">                    addReport(r);</span>
<span class="nc bnc" id="L9081" title="All 2 branches missed.">                    if (roll &gt;= 4) {</span>
                        // oops!
<span class="nc" id="L9083">                        entity.setPosition(curPos);</span>
<span class="nc" id="L9084">                        addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L9085">                        curPos = entity.getPosition();</span>
                    } else {
                        // TacOps: immediate PSR with +4 for terrain. If you
                        // fall then may break the ice after all
<span class="nc" id="L9089">                        rollTarget = entity.checkLandingOnIce(overallMoveType, curHex);</span>
<span class="nc bnc" id="L9090" title="All 2 branches missed.">                        if (!doSkillCheckInPlace(entity, rollTarget)) {</span>
                            // apply damage now, or it will show up as a
                            // possible breach, if ice is broken
<span class="nc" id="L9093">                            entity.applyDamage();</span>
<span class="nc" id="L9094">                            roll = Compute.d6(1);</span>
<span class="nc" id="L9095">                            r = new Report(2118);</span>
<span class="nc" id="L9096">                            r.addDesc(entity);</span>
<span class="nc" id="L9097">                            r.add(roll);</span>
<span class="nc" id="L9098">                            r.subject = entity.getId();</span>
<span class="nc" id="L9099">                            addReport(r);</span>
<span class="nc bnc" id="L9100" title="All 2 branches missed.">                            if (roll == 6) {</span>
<span class="nc" id="L9101">                                entity.setPosition(curPos);</span>
<span class="nc" id="L9102">                                addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L9103">                                curPos = entity.getPosition();</span>
                            }
                        }
                    }
<span class="nc" id="L9107">                }</span>
<span class="nc bnc" id="L9108" title="All 4 branches missed.">            } else if (!(prevStep.climbMode() &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE))</span>
<span class="nc bnc" id="L9109" title="All 2 branches missed.">                    &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L9110">                rollTarget = entity.checkWaterMove(waterLevel, overallMoveType);</span>
<span class="nc bnc" id="L9111" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                    // For falling elevation, Entity must not on hex surface
<span class="nc" id="L9113">                    int currElevation = entity.getElevation();</span>
<span class="nc" id="L9114">                    entity.setElevation(0);</span>
<span class="nc" id="L9115">                    boolean success = doSkillCheckInPlace(entity, rollTarget);</span>
<span class="nc bnc" id="L9116" title="All 2 branches missed.">                    if (success) {</span>
<span class="nc" id="L9117">                        entity.setElevation(currElevation);</span>
                    }
                }
<span class="nc bnc" id="L9120" title="All 2 branches missed.">                if (waterLevel &gt; 1) {</span>
                    // Any swarming infantry will be destroyed.
<span class="nc" id="L9122">                    drownSwarmer(entity, curPos);</span>
                }
            }

            // check for building collapse
<span class="nc" id="L9127">            Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L9128" title="All 2 branches missed.">            if (bldg != null) {</span>
<span class="nc" id="L9129">                checkForCollapse(bldg, game.getPositionMap(), curPos, true,</span>
                        vPhaseReport);
            }

            // Don't interact with terrain when jumping onto a building or a bridge
<span class="nc bnc" id="L9134" title="All 2 branches missed.">            if (entity.getElevation() == 0) {</span>
<span class="nc" id="L9135">                ServerHelper.checkAndApplyMagmaCrust(curHex, entity.getElevation(), entity, curPos, true, vPhaseReport, this);</span>

                // jumped into swamp? maybe stuck!
<span class="nc bnc" id="L9138" title="All 2 branches missed.">                if (curHex.getBogDownModifier(entity.getMovementMode(),</span>
                        entity instanceof LargeSupportTank) != TargetRoll.AUTOMATIC_SUCCESS) {
<span class="nc bnc" id="L9140" title="All 2 branches missed.">                    if (entity instanceof Mech) {</span>
<span class="nc" id="L9141">                        entity.setStuck(true);</span>
<span class="nc" id="L9142">                        r = new Report(2121);</span>
<span class="nc" id="L9143">                        r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L9144">                        r.subject = entity.getId();</span>
<span class="nc" id="L9145">                        addReport(r);</span>
                        // check for quicksand
<span class="nc" id="L9147">                        addReport(checkQuickSand(curPos));</span>
<span class="nc bnc" id="L9148" title="All 2 branches missed.">                    } else if (!entity.hasETypeFlag(Entity.ETYPE_INFANTRY)) {</span>
<span class="nc" id="L9149">                        rollTarget = new PilotingRollData(entity.getId(),</span>
                                5, &quot;entering boggy terrain&quot;);
<span class="nc" id="L9151">                        rollTarget.append(new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L9152">                                curHex.getBogDownModifier(entity.getMovementMode(),</span>
                                        entity instanceof LargeSupportTank),
                                &quot;avoid bogging down&quot;));
<span class="nc bnc" id="L9155" title="All 2 branches missed.">                        if (0 &lt; doSkillCheckWhileMoving(entity, entity.getElevation(), curPos, curPos,</span>
                                rollTarget, false)) {
<span class="nc" id="L9157">                            entity.setStuck(true);</span>
<span class="nc" id="L9158">                            r = new Report(2081);</span>
<span class="nc" id="L9159">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L9160">                            r.subject = entity.getId();</span>
<span class="nc" id="L9161">                            addReport(r);</span>
                            // check for quicksand
<span class="nc" id="L9163">                            addReport(checkQuickSand(curPos));</span>
                        }
                    }
                }
            }
            // If the entity is being swarmed, jumping may dislodge the fleas.
<span class="nc bnc" id="L9169" title="All 2 branches missed.">            if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L9170">                final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L9171">                rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L9173">                entity.addPilotingModifierForTerrain(rollTarget);</span>

                // Add a +4 modifier.
<span class="nc" id="L9176">                rollTarget.addModifier(4, &quot;dislodge swarming infantry&quot;);</span>

                // If the swarmer has Assault claws, give a 1 modifier.
                // We can stop looking when we find our first match.
<span class="nc bnc" id="L9180" title="All 2 branches missed.">                if (swarmer.hasWorkingMisc(MiscType.F_MAGNET_CLAW, -1)) {</span>
<span class="nc" id="L9181">                    rollTarget.addModifier(1, &quot;swarmer has magnetic claws&quot;);</span>
                }

                // okay, print the info
<span class="nc" id="L9185">                r = new Report(2125);</span>
<span class="nc" id="L9186">                r.subject = entity.getId();</span>
<span class="nc" id="L9187">                r.addDesc(entity);</span>
<span class="nc" id="L9188">                addReport(r);</span>

                // roll
<span class="nc" id="L9191">                final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L9192">                r = new Report(2130);</span>
<span class="nc" id="L9193">                r.subject = entity.getId();</span>
<span class="nc" id="L9194">                r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L9195">                r.add(rollTarget.getDesc());</span>
<span class="nc" id="L9196">                r.add(diceRoll);</span>
<span class="nc bnc" id="L9197" title="All 2 branches missed.">                if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L9198">                    r.choose(false);</span>
<span class="nc" id="L9199">                    addReport(r);</span>
                } else {
                    // Dislodged swarmers don't get turns.
<span class="nc" id="L9202">                    game.removeTurnFor(swarmer);</span>
<span class="nc" id="L9203">                    send(createTurnVectorPacket());</span>

                    // Update the report and the swarmer's status.
<span class="nc" id="L9206">                    r.choose(true);</span>
<span class="nc" id="L9207">                    addReport(r);</span>
<span class="nc" id="L9208">                    entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9209">                    swarmer.setSwarmTargetId(Entity.NONE);</span>

                    // Did the infantry fall into water?
<span class="nc bnc" id="L9212" title="All 2 branches missed.">                    if (curHex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
                        // Swarming infantry die.
<span class="nc" id="L9214">                        swarmer.setPosition(curPos);</span>
<span class="nc" id="L9215">                        r = new Report(2135);</span>
<span class="nc" id="L9216">                        r.subject = entity.getId();</span>
<span class="nc" id="L9217">                        r.indent();</span>
<span class="nc" id="L9218">                        r.addDesc(swarmer);</span>
<span class="nc" id="L9219">                        addReport(r);</span>
<span class="nc" id="L9220">                        addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
                    } else {
                        // Swarming infantry take a 3d6 point hit.
                        // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L9224">                        r = new Report(2140);</span>
<span class="nc" id="L9225">                        r.subject = entity.getId();</span>
<span class="nc" id="L9226">                        r.indent();</span>
<span class="nc" id="L9227">                        r.addDesc(swarmer);</span>
<span class="nc" id="L9228">                        r.add(&quot;3d6&quot;);</span>
<span class="nc" id="L9229">                        addReport(r);</span>
<span class="nc" id="L9230">                        addReport(damageEntity(swarmer,</span>
<span class="nc" id="L9231">                                swarmer.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),</span>
<span class="nc" id="L9232">                                Compute.d6(3)));</span>
<span class="nc" id="L9233">                        addNewLines();</span>
<span class="nc" id="L9234">                        swarmer.setPosition(curPos);</span>
                    }
<span class="nc" id="L9236">                    entityUpdate(swarmerId);</span>
                } // End successful-PSR

            } // End try-to-dislodge-swarmers

            // one more check for inferno wash-off
<span class="nc" id="L9242">            checkForWashedInfernos(entity, curPos);</span>

            // a jumping tank needs to roll for movement damage
<span class="nc bnc" id="L9245" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L9246">                int modifier = 0;</span>
<span class="nc bnc" id="L9247" title="All 2 branches missed.">                if (curHex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L9248" title="All 2 branches missed.">                        || curHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L9249" title="All 2 branches missed.">                        || curHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L9250">                    modifier = 1;</span>
                }
<span class="nc" id="L9252">                r = new Report(2126);</span>
<span class="nc" id="L9253">                r.subject = entity.getId();</span>
<span class="nc" id="L9254">                r.addDesc(entity);</span>
<span class="nc" id="L9255">                vPhaseReport.add(r);</span>
<span class="nc" id="L9256">                vPhaseReport.addAll(vehicleMotiveDamage((Tank)entity, modifier,</span>
                        false, -1, true));
<span class="nc" id="L9258">                Report.addNewline(vPhaseReport);</span>
            }

        } // End entity-is-jumping

        //If converting to another mode, set the final movement mode and report it
<span class="nc bnc" id="L9264" title="All 2 branches missed.">        if (entity.isConvertingNow()) {</span>
<span class="nc" id="L9265">            r = new Report(1210);</span>
<span class="nc" id="L9266">            r.subject = entity.getId();</span>
<span class="nc" id="L9267">            r.addDesc(entity);</span>
<span class="nc bnc" id="L9268" title="All 4 branches missed.">            if (entity instanceof QuadVee &amp;&amp; entity.isProne()</span>
<span class="nc bnc" id="L9269" title="All 2 branches missed.">                    &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_MECH) {</span>
                //Fall while converting to vehicle mode cancels conversion.
<span class="nc" id="L9271">                entity.setConvertingNow(false);</span>
<span class="nc" id="L9272">                r.messageId = 2454;</span>
            } else {
                // LAMs converting from fighter mode need to have the elevation set properly.
<span class="nc bnc" id="L9275" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc bnc" id="L9276" title="All 2 branches missed.">                    if (md.getFinalConversionMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L9277" title="All 4 branches missed.">                            &amp;&amp; entity.getAltitude() &gt; 0 &amp;&amp; entity.getAltitude() &lt;= 3) {</span>
<span class="nc" id="L9278">                        entity.setElevation(entity.getAltitude() * 10);</span>
<span class="nc" id="L9279">                        entity.setAltitude(0);</span>
                    } else {
<span class="nc" id="L9281">                        IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L9282" title="All 2 branches missed.">                        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L9283">                            entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
                        } else {
<span class="nc" id="L9285">                            entity.setElevation(0);</span>
                        }
                    }
                }
<span class="nc" id="L9289">                entity.setMovementMode(md.getFinalConversionMode());</span>
<span class="nc bnc" id="L9290" title="All 4 branches missed.">                if (entity instanceof Mech &amp;&amp; ((Mech)entity).hasTracks()) {</span>
<span class="nc" id="L9291">                    r.messageId = 2455;</span>
<span class="nc bnc" id="L9292" title="All 2 branches missed.">                    r.choose(entity.getMovementMode() == EntityMovementMode.TRACKED);</span>
<span class="nc bnc" id="L9293" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.TRACKED</span>
<span class="nc bnc" id="L9294" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L9295">                    r.messageId = 2451;</span>
<span class="nc bnc" id="L9296" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L9297">                    r.messageId = 2452;</span>
<span class="nc bnc" id="L9298" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L9299">                    r.messageId = 2453;</span>
                } else {
<span class="nc" id="L9301">                    r.messageId = 2450;</span>
                }
<span class="nc bnc" id="L9303" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L9304">                    int altitude = entity.getAltitude();</span>
<span class="nc bnc" id="L9305" title="All 4 branches missed.">                    if (altitude == 0 &amp;&amp; md.getFinalElevation() &gt;= 8) {</span>
<span class="nc" id="L9306">                        altitude = 1;</span>
                    }
<span class="nc bnc" id="L9308" title="All 2 branches missed.">                    if (altitude == 0) {</span>
<span class="nc" id="L9309">                        ((IAero)entity).land();</span>
                    } else {
<span class="nc" id="L9311">                        ((IAero)entity).liftOff(altitude);</span>
                    }
                }
            }
<span class="nc" id="L9315">            addReport(r);</span>
        }

          // update entity's locations' exposure
<span class="nc" id="L9319">        vPhaseReport.addAll(doSetLocationsExposure(entity,</span>
<span class="nc" id="L9320">                game.getBoard().getHex(curPos), false, entity.getElevation()));</span>

        // Check the falls_end_movement option to see if it should be able to
        // move on.
        // Need to check here if the 'Mech actually went from non-prone to prone
        // here because 'fellDuringMovement' is sometimes abused just to force
        // another turn and so doesn't reliably tell us.
<span class="nc bnc" id="L9327" title="All 6 branches missed.">        boolean continueTurnFromFall = !(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_FALLS_END_MOVEMENT)</span>
<span class="nc bnc" id="L9328" title="All 4 branches missed.">                    &amp;&amp; (entity instanceof Mech) &amp;&amp; !wasProne &amp;&amp; entity.isProne())</span>
<span class="nc bnc" id="L9329" title="All 4 branches missed.">                &amp;&amp; (fellDuringMovement &amp;&amp; !entity.isCarefulStand()) // Careful standing takes up the whole turn</span>
<span class="nc bnc" id="L9330" title="All 4 branches missed.">                &amp;&amp; !turnOver &amp;&amp; (entity.mpUsed &lt; entity.getRunMP())</span>
                &amp;&amp; (overallMoveType != EntityMovementType.MOVE_JUMP);
<span class="nc bnc" id="L9332" title="All 10 branches missed.">        if ((continueTurnFromFall || continueTurnFromPBS || continueTurnFromFishtail || continueTurnFromLevelDrop || continueTurnFromCliffAscent)</span>
<span class="nc bnc" id="L9333" title="All 4 branches missed.">                &amp;&amp; entity.isSelectableThisTurn() &amp;&amp; !entity.isDoomed()) {</span>
<span class="nc" id="L9334">            entity.applyDamage();</span>
<span class="nc" id="L9335">            entity.setDone(false);</span>
<span class="nc" id="L9336">            GameTurn newTurn = new GameTurn.SpecificEntityTurn(entity.getOwner().getId(), entity.getId());</span>
            // Need to set the new turn's multiTurn state
<span class="nc" id="L9338">            newTurn.setMultiTurn(true);</span>
<span class="nc" id="L9339">            game.insertNextTurn(newTurn);</span>
            // brief everybody on the turn update
<span class="nc" id="L9341">            send(createTurnVectorPacket());</span>
            // let everyone know about what just happened
<span class="nc bnc" id="L9343" title="All 2 branches missed.">            if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L9344">                send(entity.getOwner().getId(), createSpecialReportPacket());</span>
            }
<span class="nc" id="L9346">        } else {</span>
<span class="nc bnc" id="L9347" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L9348">                IHex hex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L9349" title="All 2 branches missed.">                if (md.automaticWiGELanding(false)) {</span>
                    // try to land safely; LAMs require a psr when landing with gyro or leg actuator
                    // damage and ProtoMechs always require a roll
<span class="nc bnc" id="L9352" title="All 2 branches missed.">                    int elevation = (null == prevStep)? entity.getElevation() : prevStep.getElevation();</span>
<span class="nc bnc" id="L9353" title="All 2 branches missed.">                    if (entity.hasETypeFlag(Entity.ETYPE_LAND_AIR_MECH)) {</span>
<span class="nc" id="L9354">                        addReport(landAirMech((LandAirMech) entity, entity.getPosition(), elevation,</span>
                                entity.delta_distance));
<span class="nc bnc" id="L9356" title="All 2 branches missed.">                    } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L9357">                        vPhaseReport.addAll(landGliderPM((Protomech) entity, entity.getPosition(),</span>
                                elevation, entity.delta_distance));
                    } else {
<span class="nc" id="L9360">                        r = new Report(2123);</span>
<span class="nc" id="L9361">                        r.addDesc(entity);</span>
<span class="nc" id="L9362">                        r.subject = entity.getId();</span>
<span class="nc" id="L9363">                        vPhaseReport.add(r);</span>
                    }

<span class="nc bnc" id="L9366" title="All 2 branches missed.">                    if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L9367">                        Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc" id="L9368">                        entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L9369">                        addAffectedBldg(bldg, checkBuildingCollapseWhileMoving(bldg,</span>
<span class="nc" id="L9370">                                entity, entity.getPosition()));</span>
<span class="nc bnc" id="L9371" title="All 2 branches missed.">                    } else if (entity.isLocationProhibited(entity.getPosition(), 0)</span>
<span class="nc bnc" id="L9372" title="All 2 branches missed.">                            &amp;&amp; !hex.hasPavement()){</span>
                        // crash
<span class="nc" id="L9374">                        r = new Report(2124);</span>
<span class="nc" id="L9375">                        r.addDesc(entity);</span>
<span class="nc" id="L9376">                        r.subject = entity.getId();</span>
<span class="nc" id="L9377">                        vPhaseReport.add(r);</span>
<span class="nc" id="L9378">                        vPhaseReport.addAll(crashVTOLorWiGE((Tank) entity));</span>
                    } else {
<span class="nc" id="L9380">                        entity.setElevation(0);</span>
                    }

                    // Check for stacking violations in the target hex
<span class="nc" id="L9384">                    Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L9385">                            entity.getId(), entity.getPosition());</span>
<span class="nc bnc" id="L9386" title="All 2 branches missed.">                    if (violation != null) {</span>
<span class="nc" id="L9387">                        PilotingRollData prd = new PilotingRollData(</span>
<span class="nc" id="L9388">                                violation.getId(), 2, &quot;fallen on&quot;);</span>
<span class="nc bnc" id="L9389" title="All 2 branches missed.">                        if (violation instanceof Dropship) {</span>
<span class="nc" id="L9390">                            violation = entity;</span>
<span class="nc" id="L9391">                            prd = null;</span>
                        }
<span class="nc" id="L9393">                        Coords targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L9394">                                violation.getId(), entity.getPosition(), 0);</span>
<span class="nc bnc" id="L9395" title="All 2 branches missed.">                        if (targetDest != null) {</span>
<span class="nc" id="L9396">                            vPhaseReport.addAll(doEntityDisplacement(violation,</span>
<span class="nc" id="L9397">                                    entity.getPosition(), targetDest, prd));</span>
                            // Update the violating entity's position on the
                            // client.
<span class="nc" id="L9400">                            entityUpdate(violation.getId());</span>
                        } else {
                            // ack! automatic death! Tanks
                            // suffer an ammo/power plant hit.
                            // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L9405">                            vPhaseReport.addAll(destroyEntity(violation,</span>
                                    &quot;impossible displacement&quot;,
                                    violation instanceof Mech,
                                    violation instanceof Mech));
                        }
                    }
<span class="nc bnc" id="L9411" title="All 2 branches missed.">                } else if (!entity.hasETypeFlag(Entity.ETYPE_LAND_AIR_MECH)</span>
<span class="nc bnc" id="L9412" title="All 2 branches missed.">                        &amp;&amp; !entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>

                    // we didn't land, so we go to elevation 1 above the terrain
                    // features
                    // it might have been higher than one due to the extra MPs
                    // it can spend to stay higher during movement, but should
                    // end up at one

<span class="nc" id="L9420">                    entity.setElevation(Math.min(entity.getElevation(),</span>
<span class="nc" id="L9421">                            1 + hex.maxTerrainFeatureElevation(</span>
<span class="nc" id="L9422">                            game.getBoard().inAtmosphere())));</span>
                }
            }

            // If we've somehow gotten here as an airborne LAM with a destroyed side torso
            // (such as conversion while dropping), crash now.
<span class="nc bnc" id="L9428" title="All 2 branches missed.">            if (entity instanceof LandAirMech</span>
<span class="nc bnc" id="L9429" title="All 4 branches missed.">                    &amp;&amp; (entity.isLocationBad(Mech.LOC_RT) || entity.isLocationBad(Mech.LOC_LT))) {</span>
<span class="nc" id="L9430">                r = new Report(9710);</span>
<span class="nc" id="L9431">                r.subject = entity.getId();</span>
<span class="nc" id="L9432">                r.addDesc(entity);</span>
<span class="nc bnc" id="L9433" title="All 2 branches missed.">                if (entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L9434">                    addReport(r);</span>
<span class="nc" id="L9435">                    crashAirMech(entity, new PilotingRollData(entity.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                            &quot;side torso destroyed&quot;), vPhaseReport);
<span class="nc bnc" id="L9437" title="All 4 branches missed.">                } else if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L9438">                    addReport(r);</span>
<span class="nc" id="L9439">                    addReport(processCrash(entity, ((IAero)entity).getCurrentVelocity(), entity.getPosition()));</span>
                }
            }

<span class="nc" id="L9443">            entity.setDone(true);</span>
        }

<span class="nc bnc" id="L9446" title="All 2 branches missed.">        if (dropshipStillUnloading) {</span>
            // turns should have already been inserted but we need to set the
            // entity as not done
<span class="nc" id="L9449">            entity.setDone(false);</span>
        }

        // If the entity is being swarmed, update the attacker's position.
<span class="nc bnc" id="L9453" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L9454">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L9455">            swarmer.setPosition(curPos);</span>
            // If the hex is on fire, and the swarming infantry is
            // *not* Battle Armor, it drops off.
<span class="nc bnc" id="L9458" title="All 2 branches missed.">            if (!(swarmer instanceof BattleArmor) &amp;&amp; game.getBoard()</span>
<span class="nc bnc" id="L9459" title="All 2 branches missed.">                    .getHex(curPos).containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L9460">                swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L9461">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9462">                r = new Report(2145);</span>
<span class="nc" id="L9463">                r.subject = entity.getId();</span>
<span class="nc" id="L9464">                r.indent();</span>
<span class="nc" id="L9465">                r.add(swarmer.getShortName(), true);</span>
<span class="nc" id="L9466">                addReport(r);</span>
            }
<span class="nc" id="L9468">            entityUpdate(swarmerId);</span>
        }

        // Update the entity's position,
        // unless it is off the game map.
<span class="nc bnc" id="L9473" title="All 2 branches missed.">        if (!game.isOutOfGame(entity)) {</span>
<span class="nc" id="L9474">            entityUpdate(entity.getId(), movePath, true, losCache);</span>
<span class="nc bnc" id="L9475" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L9476">                send(createRemoveEntityPacket(entity.getId(),</span>
<span class="nc" id="L9477">                        entity.getRemovalCondition()));</span>
            }
        }

        //If the entity is towing trailers, update the position of those trailers
<span class="nc bnc" id="L9482" title="All 2 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L9483">            List&lt;Integer&gt; reversedTrailers = new ArrayList&lt;&gt;(entity.getAllTowedUnits()); // initialize with a copy (no need to initialize to an empty list first)</span>
<span class="nc" id="L9484">            Collections.reverse(reversedTrailers); // reverse in-place</span>
<span class="nc" id="L9485">            List&lt;Coords&gt; trailerPath = initializeTrailerCoordinates(entity, reversedTrailers); // no need to initialize to an empty list first</span>
<span class="nc" id="L9486">            processTrailerMovement(entity, trailerPath);</span>
         }

        // recovered units should now be recovered and dealt with
<span class="nc bnc" id="L9490" title="All 6 branches missed.">        if (entity.isAero() &amp;&amp; recovered &amp;&amp; (loader != null)) {</span>

<span class="nc bnc" id="L9492" title="All 2 branches missed.">            if (loader.isCapitalFighter()) {</span>
<span class="nc bnc" id="L9493" title="All 2 branches missed.">                if (!(loader instanceof FighterSquadron)) {</span>
                    // this is a solo capital fighter so we need to add a new
                    // squadron and load both the loader and loadee
<span class="nc" id="L9496">                    FighterSquadron fs = new FighterSquadron();</span>
<span class="nc" id="L9497">                    fs.setDeployed(true);</span>
<span class="nc" id="L9498">                    fs.setId(getFreeEntityId());</span>
<span class="nc" id="L9499">                    fs.setCurrentVelocity(((Aero) loader).getCurrentVelocity());</span>
<span class="nc" id="L9500">                    fs.setNextVelocity(((Aero) loader).getNextVelocity());</span>
<span class="nc" id="L9501">                    fs.setVectors(loader.getVectors());</span>
<span class="nc" id="L9502">                    fs.setFacing(loader.getFacing());</span>
<span class="nc" id="L9503">                    fs.setOwner(entity.getOwner());</span>
                    // set velocity and heading the same as parent entity
<span class="nc" id="L9505">                    game.addEntity(fs);</span>
<span class="nc" id="L9506">                    send(createAddEntityPacket(fs.getId()));</span>
                    // make him not get a move this turn
<span class="nc" id="L9508">                    fs.setDone(true);</span>
                    // place on board
<span class="nc" id="L9510">                    fs.setPosition(loader.getPosition());</span>
<span class="nc" id="L9511">                    loadUnit(fs, loader, -1);</span>
<span class="nc" id="L9512">                    loader = fs;</span>
<span class="nc" id="L9513">                    entityUpdate(fs.getId());</span>
                }
<span class="nc" id="L9515">                loader.load(entity);</span>
            } else {
<span class="nc" id="L9517">                loader.recover(entity);</span>
<span class="nc" id="L9518">                entity.setRecoveryTurn(5);</span>
            }

            // The loaded unit is being carried by the loader.
<span class="nc" id="L9522">            entity.setTransportId(loader.getId());</span>

            // Remove the loaded unit from the screen.
<span class="nc" id="L9525">            entity.setPosition(null);</span>

            // Update the loaded unit.
<span class="nc" id="L9528">            entityUpdate(entity.getId());</span>
        }

        // even if load was unsuccessful, I may need to update the loader
<span class="nc bnc" id="L9532" title="All 2 branches missed.">        if (null != loader) {</span>
<span class="nc" id="L9533">            entityUpdate(loader.getId());</span>
        }

        // if using double blind, update the player on new units he might see
<span class="nc bnc" id="L9537" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L9538">            send(entity.getOwner().getId(),</span>
<span class="nc" id="L9539">                    createFilteredEntitiesPacket(entity.getOwner(), losCache));</span>
        }

        // if we generated a charge attack, report it now
<span class="nc bnc" id="L9543" title="All 2 branches missed.">        if (charge != null) {</span>
<span class="nc" id="L9544">            send(createAttackPacket(charge, 1));</span>
        }

        // if we generated a ram attack, report it now
<span class="nc bnc" id="L9548" title="All 2 branches missed.">        if (ram != null) {</span>
<span class="nc" id="L9549">            send(createAttackPacket(ram, 1));</span>
        }
<span class="nc bnc" id="L9551" title="All 6 branches missed.">        if ((entity instanceof Mech) &amp;&amp; entity.hasEngine() &amp;&amp; ((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L9552" title="All 2 branches missed.">                &amp;&amp; !entity.hasEnvironmentalSealing()</span>
<span class="nc bnc" id="L9553" title="All 2 branches missed.">                &amp;&amp; (entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc bnc" id="L9554" title="All 2 branches missed.">            if ((!entity.isProne()</span>
<span class="nc" id="L9555">                    &amp;&amp; (game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L9556" title="All 2 branches missed.">                            .terrainLevel(Terrains.WATER) &gt;= 2))</span>
<span class="nc bnc" id="L9557" title="All 2 branches missed.">                    || (entity.isProne()</span>
<span class="nc" id="L9558">                            &amp;&amp; (game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L9559" title="All 2 branches missed.">                                    .terrainLevel(Terrains.WATER) == 1))) {</span>
<span class="nc" id="L9560">                ((Mech) entity).setJustMovedIntoIndustrialKillingWater(true);</span>

            } else {
<span class="nc" id="L9563">                ((Mech) entity).setJustMovedIntoIndustrialKillingWater(false);</span>
            }
        }
<span class="nc" id="L9566">    }</span>

    /**
     * Updates the position of any towed trailers.
     *
     * @param tractor    The Entity that is moving
     * @param trainPath  The path all trailers are following?
     */
    private void processTrailerMovement(Entity tractor, List&lt;Coords&gt; trainPath) {
<span class="nc bnc" id="L9575" title="All 2 branches missed.">        for (int eId : tractor.getAllTowedUnits()) {</span>
<span class="nc" id="L9576">            Entity trailer = game.getEntity(eId);</span>
            // if the Tractor didn't move anywhere, stay where we are
<span class="nc bnc" id="L9578" title="All 2 branches missed.">            if (tractor.delta_distance == 0) {</span>
<span class="nc" id="L9579">                trailer.delta_distance = tractor.delta_distance;</span>
<span class="nc" id="L9580">                trailer.moved = tractor.moved;</span>
<span class="nc" id="L9581">                trailer.setSecondaryFacing(trailer.getFacing());</span>
<span class="nc" id="L9582">                trailer.setDone(true);</span>
<span class="nc" id="L9583">                entityUpdate(eId);</span>
<span class="nc" id="L9584">                continue;</span>
            }
            int stepNumber; // The Coords in trainPath that this trailer should move to
            Coords trailerPos;
<span class="nc" id="L9588">            int trailerNumber = tractor.getAllTowedUnits().indexOf(eId);</span>
<span class="nc" id="L9589">            double trailerPositionOffset = (trailerNumber + 1); //Offset so we get the right position index</span>
            // Unless the tractor is superheavy, put the first trailer in its hex.
            // Technically this would be true for a superheavy trailer too, but only a superheavy tractor can tow one.
<span class="nc bnc" id="L9592" title="All 4 branches missed.">            if (trailerNumber == 0 &amp;&amp; !tractor.isSuperHeavy()) {</span>
<span class="nc" id="L9593">                trailer.setPosition(tractor.getPosition());</span>
<span class="nc" id="L9594">                trailer.setFacing(tractor.getFacing());</span>
            } else {
                // If the trailer is superheavy, place it in a hex by itself
<span class="nc bnc" id="L9597" title="All 2 branches missed.">                if (trailer.isSuperHeavy()) {</span>
<span class="nc" id="L9598">                    trailerPositionOffset ++;</span>
<span class="nc" id="L9599">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9600">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9601">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9602" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9603">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
<span class="nc bnc" id="L9605" title="All 2 branches missed.">                } else if (tractor.isSuperHeavy()) {</span>
                    // If the tractor is superheavy, we can put two trailers in each hex
                    // starting trailer 0 in the hex behind the tractor
<span class="nc" id="L9608">                    trailerPositionOffset = (Math.ceil((trailerPositionOffset / 2.0)) + 1);</span>
<span class="nc" id="L9609">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9610">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9611">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9612" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9613">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
                } else {
                    // Otherwise, we can put two trailers in each hex
                    // starting trailer 1 in the hex behind the tractor
<span class="nc" id="L9618">                    trailerPositionOffset ++;</span>
<span class="nc" id="L9619">                    trailerPositionOffset = Math.ceil((trailerPositionOffset / 2.0));</span>
<span class="nc" id="L9620">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9621">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9622">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9623" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9624">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
                }
            }
            // trailers are immobile by default. Match the tractor's movement here
<span class="nc" id="L9629">            trailer.delta_distance = tractor.delta_distance;</span>
<span class="nc" id="L9630">            trailer.moved = tractor.moved;</span>
<span class="nc" id="L9631">            trailer.setSecondaryFacing(trailer.getFacing());</span>
<span class="nc" id="L9632">            trailer.setDone(true);</span>
<span class="nc" id="L9633">            entityUpdate(eId);</span>
<span class="nc" id="L9634">        }</span>
<span class="nc" id="L9635">    }</span>

    /**
     * Flips the order of a tractor's towed trailers list by index and
     * adds their starting coordinates to a list of hexes the tractor passed through
     *
     * @return  Returns the properly sorted list of all train coordinates
     */
    public List&lt;Coords&gt; initializeTrailerCoordinates(Entity tractor, List&lt;Integer&gt; allTowedTrailers) {
<span class="nc" id="L9644">        List&lt;Coords&gt; trainCoords = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L9645" title="All 2 branches missed.">        for (int trId : allTowedTrailers) {</span>
<span class="nc" id="L9646">            Entity trailer = game.getEntity(trId);</span>
<span class="nc" id="L9647">            Coords position = trailer.getPosition();</span>
            //Duplicates foul up the works...
<span class="nc bnc" id="L9649" title="All 2 branches missed.">            if (!trainCoords.contains(position)) {</span>
<span class="nc" id="L9650">                trainCoords.add(position);</span>
            }
<span class="nc" id="L9652">        }</span>
<span class="nc bnc" id="L9653" title="All 2 branches missed.">        for (Coords c : tractor.getPassedThrough() ) {</span>
<span class="nc bnc" id="L9654" title="All 2 branches missed.">            if (!trainCoords.contains(c)) {</span>
<span class="nc" id="L9655">                trainCoords.add(c);</span>
            }
<span class="nc" id="L9657">        }</span>
<span class="nc" id="L9658">        return trainCoords;</span>
    }

    /**
     * Checks whether the entity used MASC or a supercharger during movement, and if so checks for
     * and resolves any failures.
     *
     * @param entity  The unit using MASC/supercharger
     * @param md      The current &lt;code&gt;MovePath&lt;/code&gt;
     * @return        Whether the unit failed the check
     */
    private boolean checkMASCFailure(Entity entity, MovePath md) {
<span class="nc" id="L9670">        HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; crits = new HashMap&lt;&gt;();</span>
<span class="nc" id="L9671">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L9672" title="All 2 branches missed.">        if (entity.checkForMASCFailure(md, vReport, crits)) {</span>
<span class="nc" id="L9673">            boolean mascFailure = true;</span>
            // Check to see if the pilot can reroll due to Edge
<span class="nc bnc" id="L9675" title="All 2 branches missed.">            if (entity.getCrew().hasEdgeRemaining()</span>
<span class="nc" id="L9676">                    &amp;&amp; entity.getCrew().getOptions()</span>
<span class="nc bnc" id="L9677" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.EDGE_WHEN_MASC_FAILS)) {</span>
<span class="nc" id="L9678">                entity.getCrew().decreaseEdge();</span>
                // Need to reset the MASCUsed flag
<span class="nc" id="L9680">                entity.setMASCUsed(false);</span>
                // Report to notify user that masc check was rerolled
<span class="nc" id="L9682">                Report masc_report = new Report(6501);</span>
<span class="nc" id="L9683">                masc_report.subject = entity.getId();</span>
<span class="nc" id="L9684">                masc_report.indent(2);</span>
<span class="nc" id="L9685">                masc_report.addDesc(entity);</span>
<span class="nc" id="L9686">                vReport.add(masc_report);</span>
                // Report to notify user how much edge pilot has left
<span class="nc" id="L9688">                masc_report = new Report(6510);</span>
<span class="nc" id="L9689">                masc_report.subject = entity.getId();</span>
<span class="nc" id="L9690">                masc_report.indent(2);</span>
<span class="nc" id="L9691">                masc_report.addDesc(entity);</span>
<span class="nc" id="L9692">                masc_report.add(entity.getCrew().getOptions()</span>
<span class="nc" id="L9693">                        .intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L9694">                vReport.addElement(masc_report);</span>
                // Recheck MASC failure
<span class="nc bnc" id="L9696" title="All 2 branches missed.">                if (!entity.checkForMASCFailure(md, vReport, crits)) {</span>
                    // The reroll passed, don't process the failure
<span class="nc" id="L9698">                    mascFailure = false;</span>
<span class="nc" id="L9699">                    addReport(vReport);</span>
                }
            }
            // Check for failure and process it
<span class="nc bnc" id="L9703" title="All 2 branches missed.">            if (mascFailure) {</span>
<span class="nc" id="L9704">                addReport(vReport);</span>
                // If this is supercharger failure we need to damage the supercharger as well as
                // the additional criticals. For mechs this requires the additional step of finding
                // the slot and marking it as hit so it can't absorb future damage.
<span class="nc" id="L9708">                Mounted supercharger = entity.getSuperCharger();</span>
<span class="nc bnc" id="L9709" title="All 4 branches missed.">                if ((null != supercharger) &amp;&amp; supercharger.curMode().equals(&quot;Armed&quot;)) {</span>
<span class="nc bnc" id="L9710" title="All 2 branches missed.">                    if (entity.hasETypeFlag(Entity.ETYPE_MECH)) {</span>
<span class="nc" id="L9711">                        final int loc = supercharger.getLocation();</span>
<span class="nc bnc" id="L9712" title="All 2 branches missed.">                        for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</span>
<span class="nc" id="L9713">                            final CriticalSlot crit = entity.getCritical(loc, slot);</span>
<span class="nc bnc" id="L9714" title="All 4 branches missed.">                            if ((null != crit) &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L9715" title="All 2 branches missed.">                                    &amp;&amp; (crit.getMount().getType().equals(supercharger.getType()))) {</span>
<span class="nc" id="L9716">                                addReport(applyCriticalHit(entity, loc, crit,</span>
                                        true, 0, false));
<span class="nc" id="L9718">                                break;</span>
                            }
                        }
<span class="nc" id="L9721">                    } else {</span>
<span class="nc" id="L9722">                        supercharger.setHit(true);</span>
                    }
<span class="nc" id="L9724">                    supercharger.setMode(&quot;Off&quot;);</span>
                }
<span class="nc bnc" id="L9726" title="All 2 branches missed.">                for (Integer loc : crits.keySet()) {</span>
<span class="nc" id="L9727">                    List&lt;CriticalSlot&gt; lcs = crits.get(loc);</span>
<span class="nc bnc" id="L9728" title="All 2 branches missed.">                    for (CriticalSlot cs : lcs) {</span>
                        // HACK: if loc is -1, we need to deal motive damage to
                        // the tank, the severity of which is stored in the critslot index
<span class="nc bnc" id="L9731" title="All 2 branches missed.">                        if (loc == -1) {</span>
<span class="nc" id="L9732">                            addReport(vehicleMotiveDamage((Tank) entity,</span>
<span class="nc" id="L9733">                                    0, true, cs.getIndex()));</span>
                        } else {
<span class="nc" id="L9735">                            addReport(applyCriticalHit(entity, loc, cs,</span>
                                    true, 0, false));
                        }
<span class="nc" id="L9738">                    }</span>
<span class="nc" id="L9739">                }</span>
                // do any PSR immediately
<span class="nc" id="L9741">                addReport(resolvePilotingRolls(entity));</span>
<span class="nc" id="L9742">                game.resetPSRs(entity);</span>
                // let the player replot their move as MP might be changed
<span class="nc" id="L9744">                md.clear();</span>
<span class="nc" id="L9745">                return true;</span>
            }
<span class="nc" id="L9747">        } else {</span>
<span class="nc" id="L9748">            addReport(vReport);</span>
        }
<span class="nc" id="L9750">        return false;</span>
    }

    /**
     * LAMs or QuadVees converting from leg mode may force any carried infantry (including swarming)
     * to fall into the current hex. A LAM may suffer damage.
     *
     * @param carrier       The &lt;code&gt;Entity&lt;/code&gt; making the conversion.
     * @param rider         The &lt;code&gt;Entity&lt;/code&gt; possibly being forced off.
     * @param curPos        The coordinates of the hex where the conversion starts.
     * @param curFacing     The carrier's facing when conversion starts.
     * @param automatic     Whether the infantry falls automatically. If false, an anti-mech roll is made
     *                      to see whether it stays mounted.
     * @param infDamage     If true, the infantry takes falling damage, +1D6 for conventional.
     * @param carrierDamage If true, the carrier takes damage from converting while carrying infantry.
     */
    private Vector&lt;Report&gt; checkDropBAFromConverting(Entity carrier, Entity rider, Coords curPos, int curFacing,
            boolean automatic, boolean infDamage, boolean carrierDamage) {
<span class="nc" id="L9768">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L9770">        PilotingRollData prd = rider.getBasePilotingRoll(EntityMovementType.MOVE_NONE);</span>
<span class="nc" id="L9771">        boolean falls = automatic;</span>
<span class="nc bnc" id="L9772" title="All 2 branches missed.">        if (automatic) {</span>
<span class="nc" id="L9773">            r = new Report(2465);</span>
<span class="nc" id="L9774">            r.subject = rider.getId();</span>
<span class="nc" id="L9775">            r.addDesc(rider);</span>
<span class="nc" id="L9776">            r.addDesc(carrier);</span>
        } else {
<span class="nc" id="L9778">            r = new Report(2460);</span>
<span class="nc" id="L9779">            r.subject = rider.getId();</span>
<span class="nc" id="L9780">            r.addDesc(rider);</span>
<span class="nc" id="L9781">            r.add(prd);</span>
<span class="nc" id="L9782">            r.addDesc(carrier);</span>
<span class="nc" id="L9783">            final int diceRoll = carrier.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L9784">            r.add(diceRoll);</span>
<span class="nc bnc" id="L9785" title="All 2 branches missed.">            if (diceRoll &lt; prd.getValue()) {</span>
<span class="nc" id="L9786">                r.choose(false);</span>
<span class="nc" id="L9787">                falls = true;</span>
            } else {
<span class="nc" id="L9789">                r.choose(true);</span>
            }
        }
<span class="nc" id="L9792">        reports.add(r);</span>
<span class="nc bnc" id="L9793" title="All 2 branches missed.">        if (falls) {</span>
<span class="nc bnc" id="L9794" title="All 2 branches missed.">            if (carrier.getSwarmAttackerId() == rider.getId()) {</span>
<span class="nc" id="L9795">                rider.setDone(true);</span>
<span class="nc" id="L9796">                carrier.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9797">                rider.setSwarmTargetId(Entity.NONE);</span>
<span class="nc bnc" id="L9798" title="All 2 branches missed.">            } else if (!unloadUnit(carrier, rider, curPos, curFacing, 0)) {</span>
<span class="nc" id="L9799">                MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L9800">                                + rider.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L9801">                                + carrier.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L9802">                                + curPos.getBoardNum());</span>
<span class="nc" id="L9803">                return reports;</span>
            }
<span class="nc bnc" id="L9805" title="All 2 branches missed.">            if (infDamage) {</span>
<span class="nc" id="L9806">                reports.addAll(doEntityFall(rider, curPos, 2, prd));</span>
<span class="nc bnc" id="L9807" title="All 2 branches missed.">                if (rider.getEntityType() == Entity.ETYPE_INFANTRY) {</span>
<span class="nc" id="L9808">                    int extra = Compute.d6();</span>
<span class="nc" id="L9809">                    reports.addAll(damageEntity(rider, new HitData(Infantry.LOC_INFANTRY), extra));</span>
                }
            }
<span class="nc bnc" id="L9812" title="All 2 branches missed.">            if (carrierDamage) {</span>
                //Report the possibility of a critical hit.
<span class="nc" id="L9814">                r = new Report(2470);</span>
<span class="nc" id="L9815">                r.subject = carrier.getId();</span>
<span class="nc" id="L9816">                r.addDesc(carrier);</span>
<span class="nc" id="L9817">                reports.addElement(r);</span>
<span class="nc" id="L9818">                int mod = 0;</span>
<span class="nc bnc" id="L9819" title="All 2 branches missed.">                if (rider.getEntityType() == Entity.ETYPE_INFANTRY) {</span>
<span class="nc" id="L9820">                    mod = -2;</span>
                }
<span class="nc" id="L9822">                HitData hit = carrier.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L9823">                reports.addAll(criticalEntity(carrier, hit.getLocation(), false, mod, 0));</span>
            }
        }
<span class="nc" id="L9826">        return reports;</span>
    }

    /**
     * Handles a pointblank shot for hidden units, which must request feedback
     * from the client of the player who owns the hidden unit.
     * @return Returns true if a point-blank shot was taken, otherwise false
     */
    private boolean processPointblankShotCFR(Entity hidden, Entity target) {
<span class="nc" id="L9835">        sendPointBlankShotCFR(hidden, target);</span>
<span class="nc" id="L9836">        boolean firstPacket = true;</span>
        // Keep processing until we get a response
        while (true) {
<span class="nc" id="L9839">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9841" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9842">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9844">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9845">                    return false;</span>
<span class="nc" id="L9846">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9849" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9850">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9851">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9853" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_HIDDEN_PBS) {</span>
<span class="nc" id="L9854">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_HIDDEN_PBS CFR packet, &quot; </span>
                                + &quot;received: &quot; + cfrType);
<span class="nc" id="L9856">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L9859" title="All 2 branches missed.">                    if (rp.connId != hidden.getOwnerId()) {</span>
<span class="nc" id="L9860">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_HIDDEN_PBS CFR packet &quot; </span>
<span class="nc" id="L9861">                                + &quot;from player  &quot; + hidden.getOwnerId()</span>
                                + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L9863">                        continue;</span>
                    }
<span class="nc" id="L9865">                } else { // If no packets, wait again</span>
<span class="nc" id="L9866">                    continue;</span>
                }
                // First packet indicates whether the PBS is taken or declined
<span class="nc bnc" id="L9869" title="All 2 branches missed.">                if (firstPacket) {</span>
                    // Check to see if the client declined the PBS
<span class="nc bnc" id="L9871" title="All 2 branches missed.">                    if (rp.packet.getObject(1) == null) {</span>
<span class="nc" id="L9872">                        return false;</span>
                    } else {
<span class="nc" id="L9874">                        firstPacket = false;</span>
                        // Notify other clients, so they can display a message
<span class="nc bnc" id="L9876" title="All 2 branches missed.">                        for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L9877" title="All 2 branches missed.">                            if (p.getId() == hidden.getOwnerId()) {</span>
<span class="nc" id="L9878">                                continue;</span>
                            }
<span class="nc" id="L9880">                            send(p.getId(), new Packet(</span>
                                    Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
                                    new Object[] {
<span class="nc" id="L9883">                                            Packet.COMMAND_CFR_HIDDEN_PBS,</span>
<span class="nc" id="L9884">                                            Entity.NONE, Entity.NONE }));</span>
<span class="nc" id="L9885">                        }</span>
                        // Update all clients with the position of the PBS
<span class="nc" id="L9887">                        entityUpdate(target.getId());</span>
<span class="nc" id="L9888">                        continue;</span>
                    }
                }
                // The second packet contains the attacks to process
                @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L9893">                Vector&lt;EntityAction&gt; attacks = (Vector&lt;EntityAction&gt;) rp.packet.getObject(1);</span>
                // Mark the hidden unit as having taken a PBS
<span class="nc" id="L9895">                hidden.setMadePointblankShot(true);</span>
                // Process the Actions
<span class="nc bnc" id="L9897" title="All 2 branches missed.">                for (EntityAction ea : attacks) {</span>
<span class="nc" id="L9898">                    Entity entity = game.getEntity(ea.getEntityId());</span>
<span class="nc bnc" id="L9899" title="All 2 branches missed.">                    if (ea instanceof TorsoTwistAction) {</span>
<span class="nc" id="L9900">                        TorsoTwistAction tta = (TorsoTwistAction) ea;</span>
<span class="nc bnc" id="L9901" title="All 2 branches missed.">                        if (entity.canChangeSecondaryFacing()) {</span>
<span class="nc" id="L9902">                            entity.setSecondaryFacing(tta.getFacing());</span>
                        }
<span class="nc bnc" id="L9904" title="All 2 branches missed.">                    } else if (ea instanceof FlipArmsAction) {</span>
<span class="nc" id="L9905">                        FlipArmsAction faa = (FlipArmsAction) ea;</span>
<span class="nc" id="L9906">                        entity.setArmsFlipped(faa.getIsFlipped());</span>
<span class="nc bnc" id="L9907" title="All 2 branches missed.">                    } else if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L9908">                        boolean hexesAdded = ((SearchlightAttackAction) ea).setHexesIlluminated(game);</span>
                        // If we added new hexes, send them to all players.
                        // These are spotlights at night, you know they're
                        // there.
<span class="nc bnc" id="L9912" title="All 2 branches missed.">                        if (hexesAdded) {</span>
<span class="nc" id="L9913">                            send(createIlluminatedHexesPacket());</span>
                        }
<span class="nc" id="L9915">                        SearchlightAttackAction saa = (SearchlightAttackAction) ea;</span>
<span class="nc" id="L9916">                        addReport(saa.resolveAction(game));</span>
<span class="nc bnc" id="L9917" title="All 2 branches missed.">                    } else if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L9918">                        WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L9919">                        Entity ae = game.getEntity(waa.getEntityId());</span>
<span class="nc" id="L9920">                        Mounted m = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L9921">                        Weapon w = (Weapon) m.getType();</span>
                        // Track attacks original target, for things like swarm LRMs
<span class="nc" id="L9923">                        waa.setOriginalTargetId(waa.getTargetId());</span>
<span class="nc" id="L9924">                        waa.setOriginalTargetType(waa.getTargetType());</span>
<span class="nc" id="L9925">                        AttackHandler ah = w.fire(waa, game, this);</span>
<span class="nc bnc" id="L9926" title="All 2 branches missed.">                        if (ah != null) {</span>
<span class="nc" id="L9927">                            ah.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L9928">                            ah.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L9929">                            game.addAttack(ah);</span>
                        }
                    }
<span class="nc" id="L9932">                }</span>
                // Now handle the attacks
                // Set to the firing phase, so the attacks handle
<span class="nc" id="L9935">                IGame.Phase currentPhase = game.getPhase();</span>
<span class="nc" id="L9936">                game.setPhase(IGame.Phase.PHASE_FIRING);</span>
                // Handle attacks
<span class="nc" id="L9938">                handleAttacks(true);</span>
                // Restore Phase
<span class="nc" id="L9940">                game.setPhase(currentPhase);</span>
<span class="nc" id="L9941">                return true;</span>
            }
        }
    }

    public int processTeleguidedMissileCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; toHitValues) {
<span class="nc" id="L9947">        sendTeleguidedMissileCFR(playerId, targetIds, toHitValues);</span>
        while (true) {
<span class="nc" id="L9949">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9951" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9952">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9954">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9955">                    return 0;</span>
<span class="nc" id="L9956">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9959" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9960">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9961">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9963" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_TELEGUIDED_TARGET) {</span>
<span class="nc" id="L9964">                        MegaMek.getLogger().error(&quot;Expected a &quot; </span>
                                + &quot;COMMAND_CFR_TELEGUIDED_TARGET CFR packet, &quot; + &quot;received: &quot; + cfrType);
<span class="nc" id="L9966">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L9969" title="All 2 branches missed.">                    if (rp.connId != playerId) {</span>
<span class="nc" id="L9970">                        MegaMek.getLogger().error(&quot;Expected a &quot; </span>
                                + &quot;COMMAND_CFR_TELEGUIDED_TARGET CFR packet &quot; + &quot;from player  &quot; + playerId
                                + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L9973">                        continue;</span>
                    }
<span class="nc" id="L9975">                    return (int)rp.packet.getData()[1];</span>
                } // If no packets, wait again
<span class="nc" id="L9977">            }</span>
        }
    }
    
    public int processTAGTargetCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; targetTypes) {
<span class="nc" id="L9982">        sendTAGTargetCFR(playerId, targetIds, targetTypes);</span>
        while (true) {
<span class="nc" id="L9984">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9986" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9987">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9989">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9990">                    return 0;</span>
<span class="nc" id="L9991">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9994" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9995">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9996">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9998" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_TAG_TARGET) {</span>
<span class="nc" id="L9999">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_TAG_TARGET CFR packet, &quot;</span>
                                        + &quot;received: &quot; + cfrType);
<span class="nc" id="L10001">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L10004" title="All 2 branches missed.">                    if (rp.connId != playerId) {</span>
<span class="nc" id="L10005">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_TAG_TARGET CFR packet &quot;</span>
                                        + &quot;from player  &quot; + playerId
                                        + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L10008">                        continue;</span>
                    }
<span class="nc" id="L10010">                    return (int) rp.packet.getData()[1];</span>
                }
<span class="nc" id="L10012">            }</span>
        }
    }

    /**
     * If an aero unit takes off in the same turn that other units loaded, then
     * it risks damage to itself and those units
     *
     * @param a - The &lt;code&gt;Aero&lt;/code&gt; taking off
     */
    private void checkForTakeoffDamage(IAero a) {
<span class="nc" id="L10023">        boolean unsecured = false;</span>
<span class="nc bnc" id="L10024" title="All 2 branches missed.">        for (Entity loaded : ((Entity)a).getLoadedUnits()) {</span>
<span class="nc bnc" id="L10025" title="All 4 branches missed.">            if (loaded.wasLoadedThisTurn() &amp;&amp; !(loaded instanceof Infantry)) {</span>
<span class="nc" id="L10026">                unsecured = true;</span>
                // uh-oh, you forgot your seat belt
<span class="nc" id="L10028">                Report r = new Report(6800);</span>
<span class="nc" id="L10029">                r.subject = loaded.getId();</span>
<span class="nc" id="L10030">                r.addDesc(loaded);</span>
<span class="nc" id="L10031">                addReport(r);</span>
<span class="nc" id="L10032">                int damage = 25;</span>
<span class="nc" id="L10033">                ToHitData toHit = new ToHitData();</span>
<span class="nc bnc" id="L10034" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L10035">                    HitData hit = loaded.rollHitLocation(toHit.getHitTable(), ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10036">                    addReport(damageEntity(loaded, hit, 5, false,</span>
                            DamageType.NONE, false, true, false));
<span class="nc" id="L10038">                    damage -= 5;</span>
<span class="nc" id="L10039">                }</span>
            }
<span class="nc" id="L10041">        }</span>
<span class="nc bnc" id="L10042" title="All 2 branches missed.">        if (unsecured) {</span>
            // roll hit location to get a new critical
<span class="nc" id="L10044">            HitData hit = ((Entity)a).rollHitLocation(ToHitData.HIT_ABOVE, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10045">            addReport(applyCriticalHit((Entity)a, hit.getLocation(), new CriticalSlot(</span>
<span class="nc" id="L10046">                    0, ((Aero)a).getPotCrit()), true, 1, false));</span>
        }

<span class="nc" id="L10049">    }</span>

    /**
     * Delivers a thunder-aug shot to the targeted hex area. Thunder-Augs are 7
     * hexes, though, so...
     *
     * @param damage
     *            The per-hex density of the incoming minefield; that is, the
     *            final value with any modifiers (such as halving and rounding
     *            just for &lt;em&gt;being&lt;/em&gt; T-Aug) already applied.
     */
    public void deliverThunderAugMinefield(Coords coords, int playerId, int damage, int entityId) {
        Coords mfCoord;
<span class="nc bnc" id="L10062" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 7; dir++) {</span>
            // May need to reset here for each new hex.
<span class="nc" id="L10064">            int hexDamage = damage;</span>
<span class="nc bnc" id="L10065" title="All 2 branches missed.">            if (dir == 6) {// The targeted hex.</span>
<span class="nc" id="L10066">                mfCoord = coords;</span>
            } else {// The hex in the dir direction from the targeted hex.
<span class="nc" id="L10068">                mfCoord = coords.translated(dir);</span>
            }

            // Only if this is on the board...
<span class="nc bnc" id="L10072" title="All 2 branches missed.">            if (game.getBoard().contains(mfCoord)) {</span>
<span class="nc" id="L10073">                Minefield minefield = null;</span>
<span class="nc" id="L10074">                Enumeration&lt;Minefield&gt; minefields = game.getMinefields(mfCoord).elements();</span>
                // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10076" title="All 2 branches missed.">                while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10077">                    Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10078" title="All 2 branches missed.">                    if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10079">                        minefield = mf;</span>
<span class="nc" id="L10080">                        break;</span>
                    }
<span class="nc" id="L10082">                }</span>

                // Did we find a Thunder minefield in the hex?
                // N.B. damage Thunder minefields equals the number of
                // missiles, divided by two, rounded up.
<span class="nc bnc" id="L10087" title="All 2 branches missed.">                if (minefield == null) {</span>
                    // Nope. Create a new Thunder minefield
<span class="nc" id="L10089">                    minefield = Minefield.createMinefield(mfCoord, playerId,</span>
                            Minefield.TYPE_CONVENTIONAL, hexDamage);
<span class="nc" id="L10091">                    game.addMinefield(minefield);</span>
<span class="nc" id="L10092">                    checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10093" title="All 2 branches missed.">                } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
                    // Yup. Replace the old one.
<span class="nc" id="L10095">                    removeMinefield(minefield);</span>
<span class="nc" id="L10096">                    hexDamage += minefield.getDensity();</span>

                    // Damage from Thunder minefields are capped.
<span class="nc bnc" id="L10099" title="All 2 branches missed.">                    if (hexDamage &gt; Minefield.MAX_DAMAGE) {</span>
<span class="nc" id="L10100">                        hexDamage = Minefield.MAX_DAMAGE;</span>
                    }
<span class="nc" id="L10102">                    minefield.setDensity(hexDamage);</span>
<span class="nc" id="L10103">                    game.addMinefield(minefield);</span>
<span class="nc" id="L10104">                    checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
                }
            } // End coords-on-board
        } // Handle the next coords
<span class="nc" id="L10108">    }</span>

    /**
     * Adds a Thunder minefield to the hex.
     *
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10119">        Minefield minefield = null;</span>
<span class="nc" id="L10120">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10122" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10123">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10124" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10125">                minefield = mf;</span>
<span class="nc" id="L10126">                break;</span>
            }
<span class="nc" id="L10128">        }</span>

        // Create a new Thunder minefield
<span class="nc bnc" id="L10131" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10132">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_CONVENTIONAL, damage);</span>
<span class="nc" id="L10133">            game.addMinefield(minefield);</span>
<span class="nc" id="L10134">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10135" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10137">            removeMinefield(minefield);</span>
<span class="nc" id="L10138">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10139">            damage += oldDamage;</span>
<span class="nc" id="L10140">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10141">            minefield.setDensity(damage);</span>
<span class="nc" id="L10142">            game.addMinefield(minefield);</span>
<span class="nc" id="L10143">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10145">    }</span>

    /**
     * Adds a Thunder Inferno minefield to the hex.
     *
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderInfernoMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10156">        Minefield minefield = null;</span>
<span class="nc" id="L10157">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10159" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10160">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10161" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_INFERNO) {</span>
<span class="nc" id="L10162">                minefield = mf;</span>
<span class="nc" id="L10163">                break;</span>
            }
<span class="nc" id="L10165">        }</span>

        // Create a new Thunder Inferno minefield
<span class="nc bnc" id="L10168" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10169">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_INFERNO, damage);</span>
<span class="nc" id="L10170">            game.addMinefield(minefield);</span>
<span class="nc" id="L10171">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10172" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10174">            removeMinefield(minefield);</span>
<span class="nc" id="L10175">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10176">            damage += oldDamage;</span>
<span class="nc" id="L10177">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10178">            minefield.setDensity(damage);</span>
<span class="nc" id="L10179">            game.addMinefield(minefield);</span>
<span class="nc" id="L10180">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10182">    }</span>

    /**
     * Delivers an artillery FASCAM shot to the targeted hex area.
     */
    public void deliverFASCAMMinefield(Coords coords, int playerId, int damage, int entityId) {
        // Only if this is on the board...
<span class="nc bnc" id="L10189" title="All 2 branches missed.">        if (game.getBoard().contains(coords)) {</span>
<span class="nc" id="L10190">            Minefield minefield = null;</span>
<span class="nc" id="L10191">            Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
            // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10193" title="All 2 branches missed.">            while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10194">                Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10195" title="All 2 branches missed.">                if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10196">                    minefield = mf;</span>
<span class="nc" id="L10197">                    break;</span>
                }
<span class="nc" id="L10199">            }</span>
            // Did we find a Thunder minefield in the hex?
<span class="nc bnc" id="L10201" title="All 2 branches missed.">            if (minefield == null) {</span>
<span class="nc" id="L10202">                minefield = Minefield.createMinefield(coords, playerId,</span>
                        Minefield.TYPE_CONVENTIONAL, damage);
<span class="nc" id="L10204">                game.addMinefield(minefield);</span>
<span class="nc" id="L10205">                checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10206" title="All 2 branches missed.">            } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
                // Add to the old one.
<span class="nc" id="L10208">                removeMinefield(minefield);</span>
<span class="nc" id="L10209">                int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10210">                damage += oldDamage;</span>
<span class="nc" id="L10211">                damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10212">                minefield.setDensity(damage);</span>
<span class="nc" id="L10213">                game.addMinefield(minefield);</span>
<span class="nc" id="L10214">                checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
            }
        } // End coords-on-board
<span class="nc" id="L10217">    }</span>

    /**
     * Adds a Thunder-Active minefield to the hex.
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderActiveMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10227">        Minefield minefield = null;</span>
<span class="nc" id="L10228">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10230" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10231">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10232" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_ACTIVE) {</span>
<span class="nc" id="L10233">                minefield = mf;</span>
<span class="nc" id="L10234">                break;</span>
            }
<span class="nc" id="L10236">        }</span>

        // Create a new Thunder-Active minefield
<span class="nc bnc" id="L10239" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10240">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_ACTIVE, damage);</span>
<span class="nc" id="L10241">            game.addMinefield(minefield);</span>
<span class="nc" id="L10242">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10243" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10245">            removeMinefield(minefield);</span>
<span class="nc" id="L10246">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10247">            damage += oldDamage;</span>
<span class="nc" id="L10248">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10249">            minefield.setDensity(damage);</span>
<span class="nc" id="L10250">            game.addMinefield(minefield);</span>
<span class="nc" id="L10251">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10253">    }</span>

    /**
     * Adds a Thunder-Vibrabomb minefield to the hex.
     */
    public void deliverThunderVibraMinefield(Coords coords, int playerId,
            int damage, int sensitivity, int entityId) {
<span class="nc" id="L10260">        Minefield minefield = null;</span>
<span class="nc" id="L10261">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10263" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10264">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10265" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L10266">                minefield = mf;</span>
<span class="nc" id="L10267">                break;</span>
            }
<span class="nc" id="L10269">        }</span>

        // Create a new Thunder-Vibra minefield
<span class="nc bnc" id="L10272" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10273">            minefield = Minefield.createMinefield(coords, playerId,</span>
                    Minefield.TYPE_VIBRABOMB, damage, sensitivity);
<span class="nc" id="L10275">            game.addMinefield(minefield);</span>
<span class="nc" id="L10276">            game.addVibrabomb(minefield);</span>
<span class="nc" id="L10277">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10278" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10280">            removeMinefield(minefield);</span>
<span class="nc" id="L10281">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10282">            damage += oldDamage;</span>
<span class="nc" id="L10283">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10284">            minefield.setDensity(damage);</span>
<span class="nc" id="L10285">            game.addMinefield(minefield);</span>
<span class="nc" id="L10286">            game.addVibrabomb(minefield);</span>
<span class="nc" id="L10287">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10289">    }</span>

    /**
     * Creates an artillery flare of the given radius above the target
     */
    public void deliverArtilleryFlare(Coords coords, int radius) {
<span class="nc" id="L10295">        Flare flare = new Flare(coords, 5, radius, Flare.F_DRIFTING);</span>
<span class="nc" id="L10296">        game.addFlare(flare);</span>
<span class="nc" id="L10297">    }</span>

    public void deliverMortarFlare(Coords coords, int duration) {
<span class="nc" id="L10300">        Flare flare = new Flare(coords, duration, 1, Flare.F_IGNITED);</span>
<span class="nc" id="L10301">        game.addFlare(flare);</span>
<span class="nc" id="L10302">    }</span>

    /**
     * deliver missile smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */

    public void deliverMissileSmoke(Coords coords, int smokeType, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10311">        Report r = new Report(5183, Report.PUBLIC);</span>
<span class="nc" id="L10312">        r.indent(2);</span>
        //Report either light or heavy smoke, as appropriate
<span class="nc bnc" id="L10314" title="All 2 branches missed.">        r.choose(smokeType == SmokeCloud.SMOKE_LIGHT);</span>
<span class="nc" id="L10315">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10316">        vPhaseReport.add(r);</span>
<span class="nc" id="L10317">        createSmoke(coords, smokeType, 3);</span>
<span class="nc" id="L10318">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10319">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.SMOKE, smokeType));</span>
<span class="nc" id="L10320">        sendChangedHex(coords);</span>
<span class="nc" id="L10321">    }</span>

    public void deliverSmokeGrenade(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10324">        Report r = new Report(5200, Report.PUBLIC);</span>
<span class="nc" id="L10325">        r.indent(2);</span>
<span class="nc" id="L10326">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10327">        vPhaseReport.add(r);</span>
<span class="nc" id="L10328">        createSmoke(coords, SmokeCloud.SMOKE_LIGHT, 3);</span>
<span class="nc" id="L10329">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10330">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_LIGHT));
<span class="nc" id="L10332">        sendChangedHex(coords);</span>
<span class="nc" id="L10333">    }</span>

    public void deliverSmokeMortar(Coords coords, Vector&lt;Report&gt; vPhaseReport, int duration) {
<span class="nc" id="L10336">        Report r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10337">        r.indent(2);</span>
<span class="nc" id="L10338">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10339">        vPhaseReport.add(r);</span>
<span class="nc" id="L10340">        createSmoke(coords, SmokeCloud.SMOKE_HEAVY, duration);</span>
<span class="nc" id="L10341">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10342">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10344">        sendChangedHex(coords);</span>
<span class="nc" id="L10345">    }</span>

    public void deliverChaffGrenade(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10348">        Report r = new Report(5187, Report.PUBLIC);</span>
<span class="nc" id="L10349">        r.indent(2);</span>
<span class="nc" id="L10350">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10351">        vPhaseReport.add(r);</span>
<span class="nc" id="L10352">        createSmoke(coords, SmokeCloud.SMOKE_CHAFF_LIGHT, 1);</span>
<span class="nc" id="L10353">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10354">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_CHAFF_LIGHT));
<span class="nc" id="L10356">        sendChangedHex(coords);</span>
<span class="nc" id="L10357">    }</span>

    /**
     * deliver artillery smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */
    public void deliverArtillerySmoke(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10365">        Report r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10366">        r.indent(2);</span>
<span class="nc" id="L10367">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10368">        vPhaseReport.add(r);</span>
<span class="nc" id="L10369">        createSmoke(coords, SmokeCloud.SMOKE_HEAVY, 3);</span>
<span class="nc" id="L10370">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10371">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10373">        sendChangedHex(coords);</span>
<span class="nc bnc" id="L10374" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10375">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10376" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10377">                continue;</span>
            }
<span class="nc bnc" id="L10379" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10380">                continue;</span>
            }
<span class="nc" id="L10382">            r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10383">            r.indent(2);</span>
<span class="nc" id="L10384">            r.add(tempcoords.getBoardNum());</span>
<span class="nc" id="L10385">            vPhaseReport.add(r);</span>
<span class="nc" id="L10386">            createSmoke(tempcoords, SmokeCloud.SMOKE_HEAVY, 3);</span>
<span class="nc" id="L10387">            hex = game.getBoard().getHex(tempcoords);</span>
<span class="nc" id="L10388">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10390">            sendChangedHex(tempcoords);</span>
        }
<span class="nc" id="L10392">    }</span>

    /**
     * deliver LASER inhibiting smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */
    public void deliverLIsmoke(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10400">        Report r = new Report(5186, Report.PUBLIC);</span>
<span class="nc" id="L10401">        r.indent(2);</span>
<span class="nc" id="L10402">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10403">        vPhaseReport.add(r);</span>
<span class="nc" id="L10404">        createSmoke(coords, SmokeCloud.SMOKE_LI_HEAVY, 2);</span>
<span class="nc" id="L10405">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10406">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_LI_HEAVY));
<span class="nc" id="L10408">        sendChangedHex(coords);</span>
<span class="nc bnc" id="L10409" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10410">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10411" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10412">                continue;</span>
            }
<span class="nc bnc" id="L10414" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10415">                continue;</span>
            }
<span class="nc" id="L10417">            r = new Report(5186, Report.PUBLIC);</span>
<span class="nc" id="L10418">            r.indent(2);</span>
<span class="nc" id="L10419">            r.add(tempcoords.getBoardNum());</span>
<span class="nc" id="L10420">            vPhaseReport.add(r);</span>
<span class="nc" id="L10421">            createSmoke(tempcoords, SmokeCloud.SMOKE_LI_HEAVY, 2);</span>
<span class="nc" id="L10422">            hex = game.getBoard().getHex(tempcoords);</span>
<span class="nc" id="L10423">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SMOKE, SmokeCloud.SMOKE_LI_HEAVY));
<span class="nc" id="L10425">            sendChangedHex(tempcoords);</span>
        }
<span class="nc" id="L10427">    }</span>

    /**
     * deliver artillery inferno
     *
     * @param coords    the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     * @param ae        the attacking &lt;code&gt;entity&lt;code&gt;
     * @param subjectId the &lt;code&gt;int&lt;/code&gt; id of the target
     */
    public void deliverArtilleryInferno(Coords coords, Entity ae,
            int subjectId, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10438">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
        // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L10441" title="All 2 branches missed.">        if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_IV) {</span>
<span class="nc" id="L10442">            ignite(coords, Terrains.FIRE_LVL_INFERNO_IV, vPhaseReport);</span>
        }
        // possibly melt ice and snow
<span class="nc bnc" id="L10445" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L10446">            vPhaseReport.addAll(meltIceAndSnow(coords, subjectId));</span>
        }
<span class="nc bnc" id="L10448" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {</span>
            // TacOps, p. 356 - treat as if hit by 5 inferno missiles
<span class="nc" id="L10450">            r = new Report(6695);</span>
<span class="nc" id="L10451">            r.indent(3);</span>
<span class="nc" id="L10452">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L10453">            r.subject = entity.getId();</span>
<span class="nc" id="L10454">            r.newlines = 0;</span>
<span class="nc" id="L10455">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10456" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L10457">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L10459">            Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae, entity, 5, true);</span>
<span class="nc" id="L10460">            Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L10461">            vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L10462">        }</span>
<span class="nc bnc" id="L10463" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10464">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10465" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10466">                continue;</span>
            }
<span class="nc bnc" id="L10468" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10469">                continue;</span>
            }
<span class="nc" id="L10471">            h = game.getBoard().getHex(tempcoords);</span>
            // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L10473" title="All 2 branches missed.">            if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_IV) {</span>
<span class="nc" id="L10474">                ignite(tempcoords, Terrains.FIRE_LVL_INFERNO_IV, vPhaseReport);</span>
            }
            // possibly melt ice and snow
<span class="nc bnc" id="L10477" title="All 4 branches missed.">            if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L10478">                vPhaseReport.addAll(meltIceAndSnow(tempcoords, subjectId));</span>
            }
<span class="nc bnc" id="L10480" title="All 2 branches missed.">            for (Entity entity : game.getEntitiesVector(tempcoords)) {</span>
<span class="nc" id="L10481">                r = new Report(6695);</span>
<span class="nc" id="L10482">                r.indent(3);</span>
<span class="nc" id="L10483">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L10484">                r.newlines = 0;</span>
<span class="nc" id="L10485">                r.subject = entity.getId();</span>
<span class="nc" id="L10486">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10487" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L10488">                    Report.addNewline(vPhaseReport);</span>
                }
<span class="nc" id="L10490">                Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae,</span>
                        entity, 5, true);
<span class="nc" id="L10492">                Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L10493">                vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L10494">            }</span>
        }
<span class="nc" id="L10496">    }</span>

    public void deliverScreen(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10499">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
<span class="nc" id="L10501">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10502">        r = new Report(9070, Report.PUBLIC);</span>
<span class="nc" id="L10503">        r.indent(2);</span>
<span class="nc" id="L10504">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10505">        vPhaseReport.add(r);</span>
        // use level to count the number of screens (since level does not matter
        // in space)
<span class="nc" id="L10508">        int nscreens = h.terrainLevel(Terrains.SCREEN);</span>
<span class="nc bnc" id="L10509" title="All 2 branches missed.">        if (nscreens &gt; 0) {</span>
<span class="nc" id="L10510">            h.removeTerrain(Terrains.SCREEN);</span>
<span class="nc" id="L10511">            h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SCREEN, nscreens + 1));
        } else {
<span class="nc" id="L10514">            h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SCREEN, 1));
        }
<span class="nc" id="L10517">        sendChangedHex(coords);</span>
<span class="nc" id="L10518">    }</span>

    /**
     * deploys a new telemissile entity onto the map
     */
    public void deployTeleMissile(Entity ae, WeaponType wtype, AmmoType atype, int wId,
            int capMisMod, int damage, int armor, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10525">        Report r = new Report(9080);</span>
<span class="nc" id="L10526">        r.subject = ae.getId();</span>
<span class="nc" id="L10527">        r.addDesc(ae);</span>
<span class="nc" id="L10528">        r.indent(2);</span>
<span class="nc" id="L10529">        r.newlines = 0;</span>
<span class="nc" id="L10530">        r.add(wtype.getName());</span>
<span class="nc" id="L10531">        vPhaseReport.add(r);</span>
<span class="nc" id="L10532">        TeleMissile tele = new TeleMissile(ae, damage, armor,</span>
<span class="nc" id="L10533">                atype.getTonnage(ae), atype.getAmmoType(), capMisMod);</span>
<span class="nc" id="L10534">        tele.setDeployed(true);</span>
<span class="nc" id="L10535">        tele.setId(getFreeEntityId());</span>
<span class="nc bnc" id="L10536" title="All 2 branches missed.">        if (ae instanceof Aero) {</span>
<span class="nc" id="L10537">            Aero a = (Aero) ae;</span>
<span class="nc" id="L10538">            tele.setCurrentVelocity(a.getCurrentVelocity());</span>
<span class="nc" id="L10539">            tele.setNextVelocity(a.getNextVelocity());</span>
<span class="nc" id="L10540">            tele.setVectors(a.getVectors());</span>
<span class="nc" id="L10541">            tele.setFacing(a.getFacing());</span>
        }
        // set velocity and heading the same as parent entity
<span class="nc" id="L10544">        game.addEntity(tele);</span>
<span class="nc" id="L10545">        send(createAddEntityPacket(tele.getId()));</span>
        // make him not get a move this turn
<span class="nc" id="L10547">        tele.setDone(true);</span>
        // place on board
<span class="nc" id="L10549">        tele.setPosition(ae.getPosition());</span>
        // Update the entity
<span class="nc" id="L10551">        entityUpdate(tele.getId());</span>
        // check to see if the launching of this missile removes control of any
        // prior missiles
<span class="nc bnc" id="L10554" title="All 2 branches missed.">        if (ae.getTMTracker().containsLauncher(wId)) {</span>
<span class="nc" id="L10555">            Entity priorMissile = game.getEntity(ae.getTMTracker().getMissile(</span>
                    wId));
<span class="nc bnc" id="L10557" title="All 2 branches missed.">            if (priorMissile instanceof TeleMissile) {</span>
<span class="nc" id="L10558">                ((TeleMissile) priorMissile).setOutContact(true);</span>
                // remove this from the tracker for good measure
<span class="nc" id="L10560">                ae.getTMTracker().removeMissile(wId);</span>
            }
        }
        // track this missile on the entity
<span class="nc" id="L10564">        ae.getTMTracker().addMissile(wId, tele.getId());</span>
<span class="nc" id="L10565">    }</span>

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t, int missiles) {
<span class="nc" id="L10575">        return deliverInfernoMissiles(ae, t, missiles, CalledShot.CALLED_NONE);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param areaEffect a &lt;code&gt;boolean&lt;/code&gt; indicating whether the attack is from an
     *                   area effect weapon such as Arrow IV inferno, and partial cover should
     *                   be ignored.
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t, int missiles,
                                                 boolean areaEffect) {
<span class="nc" id="L10590">        return deliverInfernoMissiles(ae, t, missiles, CalledShot.CALLED_NONE, areaEffect);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param called   an &lt;code&gt;int&lt;/code&gt; indicated the aiming mode used to fire the
     *                 inferno missiles (for called shots)
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t,
            int missiles, int called) {
<span class="nc" id="L10604">        return deliverInfernoMissiles(ae, t, missiles, called, false);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae         the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t          the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles   the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param called     an &lt;code&gt;int&lt;/code&gt; indicated the aiming mode used to fire the
     *                   inferno missiles (for called shots)
     * @param areaEffect a &lt;code&gt;boolean&lt;/code&gt; indicating whether the attack is from an
     *                   area effect weapon such as Arrow IV inferno, and partial cover should
     *                   be ignored.
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t,
                int missiles, int called, boolean areaEffect) {
<span class="nc" id="L10621">        IHex hex = game.getBoard().getHex(t.getPosition());</span>
        Report r;
<span class="nc" id="L10623">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L10624">        int attId = Entity.NONE;</span>
<span class="nc bnc" id="L10625" title="All 2 branches missed.">        if (null != ae) {</span>
<span class="nc" id="L10626">            attId = ae.getId();</span>
        }
<span class="nc bnc" id="L10628" title="All 5 branches missed.">        switch (t.getTargetType()) {</span>
            case Targetable.TYPE_HEX_ARTILLERY:
                // used for BA inferno explosion
<span class="nc bnc" id="L10631" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector(t.getPosition())) {</span>
<span class="nc bnc" id="L10632" title="All 2 branches missed.">                    if (e.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L10633">                        r = new Report(6685);</span>
<span class="nc" id="L10634">                        r.subject = e.getId();</span>
<span class="nc" id="L10635">                        r.addDesc(e);</span>
<span class="nc" id="L10636">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10637">                        vPhaseReport.addAll(deliverInfernoMissiles(ae, e, missiles, called));</span>
                    } else {
<span class="nc" id="L10639">                        int roll = Compute.d6();</span>
<span class="nc" id="L10640">                        r = new Report(3570);</span>
<span class="nc" id="L10641">                        r.subject = e.getId();</span>
<span class="nc" id="L10642">                        r.addDesc(e);</span>
<span class="nc" id="L10643">                        r.add(roll);</span>
<span class="nc" id="L10644">                        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10645" title="All 2 branches missed.">                        if (roll &gt;= 5) {</span>
<span class="nc" id="L10646">                            vPhaseReport.addAll(deliverInfernoMissiles(ae, e, missiles, called));</span>
                        }
                    }
<span class="nc" id="L10649">                }</span>
<span class="nc bnc" id="L10650" title="All 2 branches missed.">                if (game.getBoard().getBuildingAt(t.getPosition()) != null) {</span>
<span class="nc" id="L10651">                    Vector&lt;Report&gt; vBuildingReport = damageBuilding(game.getBoard().getBuildingAt(t.getPosition()),</span>
<span class="nc" id="L10652">                            2 * missiles, t.getPosition());</span>
<span class="nc bnc" id="L10653" title="All 2 branches missed.">                    for (Report report : vBuildingReport) {</span>
<span class="nc" id="L10654">                        report.subject = attId;</span>
<span class="nc" id="L10655">                    }</span>
<span class="nc" id="L10656">                    vPhaseReport.addAll(vBuildingReport);</span>
                }
                // fall through
            case Targetable.TYPE_HEX_CLEAR:
            case Targetable.TYPE_HEX_IGNITE:
                // Report that damage applied to terrain, if there's TF to damage
<span class="nc" id="L10662">                IHex h = game.getBoard().getHex(t.getPosition());</span>
<span class="nc bnc" id="L10663" title="All 4 branches missed.">                if ((h != null) &amp;&amp; h.hasTerrainfactor()) {</span>
<span class="nc" id="L10664">                    r = new Report(3384);</span>
<span class="nc" id="L10665">                    r.indent(2);</span>
<span class="nc" id="L10666">                    r.subject = attId;</span>
<span class="nc" id="L10667">                    r.add(t.getPosition().getBoardNum());</span>
<span class="nc" id="L10668">                    r.add(missiles * 4);</span>
<span class="nc" id="L10669">                    vPhaseReport.addElement(r);</span>
                }
<span class="nc" id="L10671">                vPhaseReport.addAll(tryClearHex(t.getPosition(), missiles * 4, attId));</span>
<span class="nc" id="L10672">                tryIgniteHex(t.getPosition(), attId, false, true,</span>
                             new TargetRoll(0, &quot;inferno&quot;), -1, vPhaseReport);
<span class="nc" id="L10674">                break;</span>
            case Targetable.TYPE_BLDG_IGNITE:
            case Targetable.TYPE_BUILDING:
<span class="nc" id="L10677">                Vector&lt;Report&gt; vBuildingReport = damageBuilding(game.getBoard().getBuildingAt(t.getPosition()),</span>
<span class="nc" id="L10678">                        2 * missiles, t.getPosition());</span>
<span class="nc bnc" id="L10679" title="All 2 branches missed.">                for (Report report : vBuildingReport) {</span>
<span class="nc" id="L10680">                    report.subject = attId;</span>
<span class="nc" id="L10681">                }</span>
<span class="nc" id="L10682">                vPhaseReport.addAll(vBuildingReport);</span>

                // For each missile, check to see if it hits a unit in this hex
<span class="nc bnc" id="L10685" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector(t.getPosition())) {</span>
<span class="nc bnc" id="L10686" title="All 2 branches missed.">                    if (e.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L10687">                        continue;</span>
                    }
<span class="nc bnc" id="L10689" title="All 2 branches missed.">                    for (int m = 0; m &lt; missiles; m++) {</span>
<span class="nc" id="L10690">                        int roll = Compute.d6();</span>
<span class="nc" id="L10691">                        r = new Report(3570);</span>
<span class="nc" id="L10692">                        r.subject = e.getId();</span>
<span class="nc" id="L10693">                        r.indent(3);</span>
<span class="nc" id="L10694">                        r.addDesc(e);</span>
<span class="nc" id="L10695">                        r.add(roll);</span>
<span class="nc" id="L10696">                        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10697" title="All 2 branches missed.">                        if (roll &gt;= 5) {</span>
<span class="nc" id="L10698">                            Vector&lt;Report&gt; dmgReports = deliverInfernoMissiles(ae, e, 1, called);</span>
<span class="nc bnc" id="L10699" title="All 2 branches missed.">                            for (Report rep : dmgReports) {</span>
<span class="nc" id="L10700">                                rep.indent(4);</span>
<span class="nc" id="L10701">                            }</span>
<span class="nc" id="L10702">                            vPhaseReport.addAll(dmgReports);</span>
                        }
                    }
<span class="nc" id="L10705">                }</span>

<span class="nc" id="L10707">                break;</span>
            case Targetable.TYPE_ENTITY:
<span class="nc" id="L10709">                Entity te = (Entity) t;</span>
<span class="nc bnc" id="L10710" title="All 4 branches missed.">                if ((te instanceof Mech) &amp;&amp; (!areaEffect)) {</span>
                    // Bug #1585497: Check for partial cover
<span class="nc" id="L10712">                    int m = missiles;</span>
<span class="nc" id="L10713">                    LosEffects le = LosEffects.calculateLos(game, attId, t);</span>
<span class="nc" id="L10714">                    int cover = le.getTargetCover();</span>
<span class="nc" id="L10715">                    Vector&lt;Report&gt; coverDamageReports = new Vector&lt;&gt;();</span>
<span class="nc" id="L10716">                    int heatDamage = 0;</span>
<span class="nc" id="L10717">                    boolean heatReduced = false;</span>
<span class="nc" id="L10718">                    String reductionCause = &quot;&quot;;</span>
<span class="nc bnc" id="L10719" title="All 2 branches missed.">                    for (int i = 0; i &lt; m; i++) {</span>
<span class="nc" id="L10720">                        int side = Compute.targetSideTable(ae, t, called);</span>
<span class="nc" id="L10721">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc bnc" id="L10722" title="All 2 branches missed.">                        if (te.removePartialCoverHits(hit.getLocation(), cover, side)) {</span>
<span class="nc" id="L10723">                            missiles--;</span>
                            // Determine if damageable cover is hit
                            int damageableCoverType;
                            Entity coverDropship;
                            Coords coverLoc;

                            // Determine if there is primary and secondary
                            // cover,
                            // and then determine which one gets hit
<span class="nc bnc" id="L10732" title="All 6 branches missed.">                            if (((cover == LosEffects.COVER_75RIGHT) || (cover == LosEffects.COVER_75LEFT))</span>
                                    // 75% cover has a primary and secondary
                                    || ((cover == LosEffects.COVER_HORIZONTAL)
<span class="nc bnc" id="L10735" title="All 2 branches missed.">                                    &amp;&amp; (le.getDamagableCoverTypeSecondary() != LosEffects.DAMAGABLE_COVER_NONE))) {</span>
                                // Horizontal cover provided by two 25%'s,
                                // so primary and secondary
<span class="nc" id="L10738">                                int hitLoc = hit.getLocation();</span>
                                // Primary stores the left side, from the
                                // perspective of the attacker
<span class="nc bnc" id="L10741" title="All 6 branches missed.">                                if ((hitLoc == Mech.LOC_RLEG) || (hitLoc == Mech.LOC_RT)</span>
                                        || (hitLoc == Mech.LOC_RARM)) {
                                    // Left side is primary
<span class="nc" id="L10744">                                    damageableCoverType = le.getDamagableCoverTypePrimary();</span>
<span class="nc" id="L10745">                                    coverDropship = le.getCoverDropshipPrimary();</span>
<span class="nc" id="L10746">                                    coverLoc = le.getCoverLocPrimary();</span>
                                } else {
                                    // If not left side, then right side,
                                    // which is secondary
<span class="nc" id="L10750">                                    damageableCoverType = le.getDamagableCoverTypeSecondary();</span>
<span class="nc" id="L10751">                                    coverDropship = le.getCoverDropshipSecondary();</span>
<span class="nc" id="L10752">                                    coverLoc = le.getCoverLocSecondary();</span>
                                }
<span class="nc" id="L10754">                            } else { // Only primary cover exists</span>
<span class="nc" id="L10755">                                damageableCoverType = le.getDamagableCoverTypePrimary();</span>
<span class="nc" id="L10756">                                coverDropship = le.getCoverDropshipPrimary();</span>
<span class="nc" id="L10757">                                coverLoc = le.getCoverLocPrimary();</span>
                            }

                            // Check if we need to damage the cover that
                            // absorbed
                            // the hit.
<span class="nc" id="L10763">                            Vector&lt;Report&gt; coverDamageReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L10764" title="All 2 branches missed.">                            if (damageableCoverType == LosEffects.DAMAGABLE_COVER_DROPSHIP) {</span>
<span class="nc" id="L10765">                                r = new Report(3465);</span>
<span class="nc" id="L10766">                                r.addDesc(coverDropship);</span>
<span class="nc" id="L10767">                                r.indent(1);</span>
<span class="nc" id="L10768">                                coverDamageReport = deliverInfernoMissiles(ae,</span>
                                        coverDropship, 1, CalledShot.CALLED_NONE);
<span class="nc" id="L10770">                                coverDamageReport.insertElementAt(r, 0);</span>
<span class="nc bnc" id="L10771" title="All 2 branches missed.">                                for (Report report : coverDamageReport) {</span>
<span class="nc" id="L10772">                                    report.indent(1);</span>
<span class="nc" id="L10773">                                }</span>
<span class="nc bnc" id="L10774" title="All 2 branches missed.">                            } else if (damageableCoverType == LosEffects.DAMAGABLE_COVER_BUILDING) {</span>
<span class="nc" id="L10775">                                BuildingTarget bldgTrgt = new BuildingTarget(coverLoc,</span>
<span class="nc" id="L10776">                                        game.getBoard(), false);</span>
<span class="nc" id="L10777">                                coverDamageReport = deliverInfernoMissiles(ae, bldgTrgt, 1,</span>
                                        CalledShot.CALLED_NONE);
                            }
<span class="nc bnc" id="L10780" title="All 2 branches missed.">                            for (Report report : coverDamageReport) {</span>
<span class="nc" id="L10781">                                report.indent(1);</span>
<span class="nc" id="L10782">                            }</span>
<span class="nc" id="L10783">                            coverDamageReports.addAll(coverDamageReport);</span>
<span class="nc" id="L10784">                        } else { // No partial cover, missile hits</span>
<span class="nc bnc" id="L10785" title="All 2 branches missed.">                            if ((te.getArmor(hit) &gt; 0)</span>
<span class="nc bnc" id="L10786" title="All 2 branches missed.">                                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HEAT_DISSIPATING)) {</span>
<span class="nc" id="L10787">                                heatDamage += 1;</span>
<span class="nc" id="L10788">                                heatReduced = true;</span>
<span class="nc" id="L10789">                                reductionCause = EquipmentType.armorNames[te</span>
<span class="nc" id="L10790">                                        .getArmorType(hit.getLocation())];</span>
                            } else {
<span class="nc" id="L10792">                                heatDamage += 2;</span>
                            }
                        }
                    }
<span class="nc bnc" id="L10796" title="All 2 branches missed.">                    if (heatReduced) {</span>
<span class="nc" id="L10797">                        r = new Report(3406);</span>
<span class="nc" id="L10798">                        r.add(heatDamage);</span>
<span class="nc" id="L10799">                        r.subject = te.getId();</span>
<span class="nc" id="L10800">                        r.indent(2);</span>
<span class="nc" id="L10801">                        r.choose(true);</span>
<span class="nc" id="L10802">                        r.add(missiles * 2);</span>
<span class="nc" id="L10803">                        r.add(reductionCause);</span>
                    } else {
<span class="nc" id="L10805">                        r = new Report(3400);</span>
<span class="nc" id="L10806">                        r.add(heatDamage);</span>
<span class="nc" id="L10807">                        r.subject = te.getId();</span>
<span class="nc" id="L10808">                        r.indent(2);</span>
<span class="nc" id="L10809">                        r.choose(true);</span>
                    }
<span class="nc" id="L10811">                    vPhaseReport.add(r);</span>
<span class="nc" id="L10812">                    Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10813">                    te.heatFromExternal += heatDamage;</span>

<span class="nc bnc" id="L10815" title="All 2 branches missed.">                    if (missiles != m) {</span>
<span class="nc" id="L10816">                        r = new Report(3403);</span>
<span class="nc" id="L10817">                        r.add(m - missiles);</span>
<span class="nc" id="L10818">                        r.indent(2);</span>
<span class="nc" id="L10819">                        r.subject = te.getId();</span>
<span class="nc" id="L10820">                        vPhaseReport.add(r);</span>
                    }
<span class="nc" id="L10822">                    vPhaseReport.addAll(coverDamageReports);</span>
<span class="nc" id="L10823">                    Report.addNewline(vPhaseReport);</span>
<span class="nc bnc" id="L10824" title="All 2 branches missed.">                } else if (te.tracksHeat()) {</span>
                    // ASFs and small craft
<span class="nc" id="L10826">                    r = new Report(3400);</span>
<span class="nc" id="L10827">                    r.add(2 * missiles);</span>
<span class="nc" id="L10828">                    r.subject = te.getId();</span>
<span class="nc" id="L10829">                    r.indent(2);</span>
<span class="nc" id="L10830">                    r.choose(true);</span>
<span class="nc" id="L10831">                    vPhaseReport.add(r);</span>
<span class="nc" id="L10832">                    te.heatFromExternal += 2 * missiles;</span>
<span class="nc" id="L10833">                    Report.addNewline(vPhaseReport);</span>
<span class="nc bnc" id="L10834" title="All 2 branches missed.">                } else if (te instanceof GunEmplacement){</span>
<span class="nc" id="L10835">                    int direction = Compute.targetSideTable(ae, te, called);</span>
<span class="nc bnc" id="L10836" title="All 2 branches missed.">                    while (missiles-- &gt; 0) {</span>
<span class="nc" id="L10837">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, direction);</span>
<span class="nc" id="L10838">                        vPhaseReport.addAll(damageEntity(te, hit, 2));</span>
<span class="nc" id="L10839">                    }</span>
<span class="nc bnc" id="L10840" title="All 4 branches missed.">                } else if ((te instanceof Tank) || te.isSupportVehicle()) {</span>
<span class="nc" id="L10841">                    int direction = Compute.targetSideTable(ae, te, called);</span>
<span class="nc bnc" id="L10842" title="All 2 branches missed.">                    while (missiles-- &gt; 0) {</span>
<span class="nc" id="L10843">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, direction);</span>
<span class="nc" id="L10844">                        int critRollMod = 0;</span>
<span class="nc bnc" id="L10845" title="All 4 branches missed.">                        if (!te.isSupportVehicle() || (te.hasArmoredChassis()</span>
<span class="nc bnc" id="L10846" title="All 2 branches missed.">                                &amp;&amp; (te.getBARRating(hit.getLocation()) &gt; 9))) {</span>
<span class="nc" id="L10847">                            critRollMod -= 2;</span>
                        }
<span class="nc bnc" id="L10849" title="All 2 branches missed.">                        if ((te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED)</span>
<span class="nc bnc" id="L10850" title="All 2 branches missed.">                                &amp;&amp; (te.getArmor(hit.getLocation()) &gt; 0)) {</span>
<span class="nc" id="L10851">                            critRollMod -= 2;</span>
                        }
<span class="nc" id="L10853">                        vPhaseReport.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
                                critRollMod, 0, true));
<span class="nc" id="L10855">                    }</span>
<span class="nc bnc" id="L10856" title="All 2 branches missed.">                } else if (te instanceof ConvFighter) {</span>
                    // CFs take a point SI damage for every three missiles that hit.
                    // Use the heatFromExternal field to carry the remainder in case of multiple inferno hits.
<span class="nc" id="L10859">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10860" title="All 2 branches missed.">                    if (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10861">                        int siDamage = te.heatFromExternal / 3;</span>
<span class="nc" id="L10862">                        te.heatFromExternal %= 3;</span>
<span class="nc" id="L10863">                        final ConvFighter ftr = (ConvFighter) te;</span>
<span class="nc" id="L10864">                        int remaining = Math.max(0,  ftr.getSI() - siDamage);</span>
<span class="nc" id="L10865">                        r = new Report(9146);</span>
<span class="nc" id="L10866">                        r.subject = te.getId();</span>
<span class="nc" id="L10867">                        r.indent(2);</span>
<span class="nc" id="L10868">                        r.add(siDamage);</span>
<span class="nc" id="L10869">                        r.add(remaining);</span>
<span class="nc" id="L10870">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10871">                        ftr.setSI(remaining);</span>
<span class="nc" id="L10872">                        te.damageThisPhase += siDamage;</span>
<span class="nc bnc" id="L10873" title="All 2 branches missed.">                        if (remaining &lt;= 0) {</span>
                            // Lets auto-eject if we can!
<span class="nc bnc" id="L10875" title="All 2 branches missed.">                            if (ftr.isAutoEject()</span>
<span class="nc bnc" id="L10876" title="All 2 branches missed.">                                    &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L10877" title="All 2 branches missed.">                                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L10878" title="All 2 branches missed.">                                                &amp;&amp; ftr.isCondEjectSIDest()))) {</span>
<span class="nc" id="L10879">                                vPhaseReport.addAll(ejectEntity(te, true, false));</span>
                            }
<span class="nc" id="L10881">                            vPhaseReport.addAll(destroyEntity(te,&quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L10882">                            ftr.setSI(0);</span>
<span class="nc bnc" id="L10883" title="All 2 branches missed.">                            if (null != ae) {</span>
<span class="nc" id="L10884">                                creditKill(te, ae);</span>
                            }
                        }
<span class="nc" id="L10887">                    }</span>
<span class="nc bnc" id="L10888" title="All 2 branches missed.">                } else if (te.isLargeCraft()) {</span>
                    // Large craft ignore infernos
<span class="nc" id="L10890">                    r = new Report(1242);</span>
<span class="nc" id="L10891">                    r.subject = te.getId();</span>
<span class="nc" id="L10892">                    r.indent(2);</span>
<span class="nc" id="L10893">                    vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10894" title="All 2 branches missed.">                } else if (te instanceof Protomech) {</span>
<span class="nc" id="L10895">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10896" title="All 2 branches missed.">                    while (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10897">                        te.heatFromExternal -= 3;</span>
<span class="nc" id="L10898">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L10899" title="All 2 branches missed.">                        if (hit.getLocation() == Protomech.LOC_NMISS) {</span>
<span class="nc" id="L10900">                            Protomech proto = (Protomech) te;</span>
<span class="nc" id="L10901">                            r = new Report(6035);</span>
<span class="nc" id="L10902">                            r.subject = te.getId();</span>
<span class="nc" id="L10903">                            r.indent(2);</span>
<span class="nc bnc" id="L10904" title="All 2 branches missed.">                            if (proto.isGlider()) {</span>
<span class="nc" id="L10905">                                r.messageId = 6036;</span>
<span class="nc" id="L10906">                                proto.setWingHits(proto.getWingHits() + 1);</span>
                            }
<span class="nc" id="L10908">                            vPhaseReport.add(r);</span>
<span class="nc" id="L10909">                        } else {</span>
<span class="nc" id="L10910">                            r = new Report(6690);</span>
<span class="nc" id="L10911">                            r.subject = te.getId();</span>
<span class="nc" id="L10912">                            r.indent(2);</span>
<span class="nc" id="L10913">                            r.add(te.getLocationName(hit));</span>
<span class="nc" id="L10914">                            vPhaseReport.add(r);</span>
<span class="nc" id="L10915">                            te.destroyLocation(hit.getLocation());</span>
                            // Handle ProtoMech pilot damage
                            // due to location destruction
<span class="nc" id="L10918">                            int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L10919">                                       - ((Protomech) te).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L10920" title="All 2 branches missed.">                            if (hits &gt; 0) {</span>
<span class="nc" id="L10921">                                vPhaseReport.addAll(damageCrew(te, hits));</span>
<span class="nc" id="L10922">                                ((Protomech) te).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L10923">                                        Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                            }
<span class="nc bnc" id="L10925" title="All 2 branches missed.">                            if (te.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L10926">                                vPhaseReport.addAll(destroyEntity(te,</span>
                                        &quot;flaming inferno death&quot;, false, true));
<span class="nc" id="L10928">                                Report.addNewline(vPhaseReport);</span>
                            }
                        }
<span class="nc" id="L10931">                    }</span>
<span class="nc bnc" id="L10932" title="All 2 branches missed.">                } else if (te instanceof BattleArmor) {</span>
<span class="nc bnc" id="L10933" title="All 2 branches missed.">                    if (((BattleArmor) te).isFireResistant()) {</span>
<span class="nc" id="L10934">                        r = new Report(3395);</span>
<span class="nc" id="L10935">                        r.indent(2);</span>
<span class="nc" id="L10936">                        r.subject = te.getId();</span>
<span class="nc" id="L10937">                        r.addDesc(te);</span>
<span class="nc" id="L10938">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10939">                        return vPhaseReport;</span>
                    }
<span class="nc" id="L10941">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10942" title="All 2 branches missed.">                    while (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10943">                        te.heatFromExternal -= 3;</span>
<span class="nc" id="L10944">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10945">                        hit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L10946">                        vPhaseReport.addAll(damageEntity(te, hit, 1));</span>
<span class="nc" id="L10947">                        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10948">                    }</span>
<span class="nc bnc" id="L10949" title="All 2 branches missed.">                } else if (te instanceof Infantry) {</span>
<span class="nc" id="L10950">                    HitData hit = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc bnc" id="L10951" title="All 2 branches missed.">                    if (te.getInternal(hit) &gt; (3 * missiles)) {</span>
                        // internal structure absorbs all damage
<span class="nc" id="L10953">                        te.setInternal(te.getInternal(hit) - (3 * missiles), hit);</span>
<span class="nc" id="L10954">                        r = new Report(6065);</span>
<span class="nc" id="L10955">                        r.addDesc(te);</span>
<span class="nc" id="L10956">                        r.add(3 * missiles);</span>
<span class="nc" id="L10957">                        r.indent(2);</span>
<span class="nc" id="L10958">                        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L10959">                        r.newlines = 0;</span>
<span class="nc" id="L10960">                        r.subject = te.getId();</span>
<span class="nc" id="L10961">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10962">                        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10963">                        r = new Report(6095);</span>
<span class="nc" id="L10964">                        r.add(te.getInternal(hit));</span>
<span class="nc" id="L10965">                        r.subject = te.getId();</span>
<span class="nc" id="L10966">                        r.indent(3);</span>
<span class="nc" id="L10967">                        vPhaseReport.add(r);</span>
                    } else {
<span class="nc" id="L10969">                        vPhaseReport.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
<span class="nc" id="L10970">                        creditKill(te, ae);</span>
<span class="nc" id="L10971">                        Report.addNewline(vPhaseReport);</span>
                    }
                }
        }
<span class="nc" id="L10975">        return vPhaseReport;</span>
    }

    /**
     * Check for any detonations when an entity enters a minefield, except a
     * vibrabomb.
     *
     * @param entity
     *            - the &lt;code&gt;entity&lt;/code&gt; who entered the minefield
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the minefield
     * @param curElev
     *            - an &lt;code&gt;int&lt;/code&gt; for the elevation of the entity entering
     *            the minefield (used for underwater sea mines)
     * @param isOnGround
     *            - &lt;code&gt;true&lt;/code&gt; if the entity is not in the middle of a
     *            jump
     * @param vMineReport
     *            - the report vector that reports will be added to
     * @return - &lt;code&gt;true&lt;/code&gt; if the entity set off any mines
     */
    private boolean enterMinefield(Entity entity, Coords c, int curElev, boolean isOnGround,
                                   Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L10998">        return enterMinefield(entity, c, curElev, isOnGround, vMineReport, -1);</span>
    }

    /**
     * Check for any detonations when an entity enters a minefield, except a
     * vibrabomb.
     *
     * @param entity
     *            - the &lt;code&gt;entity&lt;/code&gt; who entered the minefield
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the minefield
     * @param curElev
     *            - an &lt;code&gt;int&lt;/code&gt; for the elevation of the entity entering
     *            the minefield (used for underwater sea mines)
     * @param isOnGround
     *            - &lt;code&gt;true&lt;/code&gt; if the entity is not in the middle of a
     *            jump
     * @param vMineReport
     *            - the report vector that reports will be added to
     * @param target
     *            - the &lt;code&gt;int&lt;/code&gt; target number for detonation. If this
     *            will be determined by density, it should be -1
     * @return - &lt;code&gt;true&lt;/code&gt; if the entity set off any mines
     */
    private boolean enterMinefield(Entity entity, Coords c, int curElev, boolean isOnGround,
                                   Vector&lt;Report&gt; vMineReport, int target) {
        Report r;
<span class="nc" id="L11025">        boolean trippedMine = false;</span>
        // flying units cannot trip a mine
<span class="nc bnc" id="L11027" title="All 2 branches missed.">        if (curElev &gt; 0) {</span>
<span class="nc" id="L11028">            return false;</span>
        }

        // Check for Mine sweepers
<span class="nc" id="L11032">        Mounted minesweeper = null;</span>
<span class="nc bnc" id="L11033" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L11034" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; m.isReady()</span>
<span class="nc bnc" id="L11035" title="All 2 branches missed.">                    &amp;&amp; (m.getArmorValue() &gt; 0)) {</span>
<span class="nc" id="L11036">                minesweeper = m;</span>
<span class="nc" id="L11037">                break; // Can only have one minesweeper</span>
            }
<span class="nc" id="L11039">        }</span>

<span class="nc" id="L11041">        Vector&lt;Minefield&gt; fieldsToRemove = new Vector&lt;&gt;();</span>
        // loop through mines in this hex
<span class="nc bnc" id="L11043" title="All 2 branches missed.">        for (Minefield mf : game.getMinefields(c)) {</span>

            // vibrabombs are handled differently
<span class="nc bnc" id="L11046" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L11047">                continue;</span>
            }

            // if we are in the water, then the sea mine will only blow up if at
            // the right depth
<span class="nc" id="L11052">            if (game.getBoard().getHex(mf.getCoords())</span>
<span class="nc bnc" id="L11053" title="All 2 branches missed.">                    .containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L11054" title="All 2 branches missed.">                if ((Math.abs(curElev) != mf.getDepth())</span>
<span class="nc" id="L11055">                    &amp;&amp; (Math.abs(curElev + entity.getHeight()) != mf</span>
<span class="nc bnc" id="L11056" title="All 2 branches missed.">                        .getDepth())) {</span>
<span class="nc" id="L11057">                    continue;</span>
                }
            }

            // Check for mine-sweeping.  Vibramines handled elsewhere
<span class="nc bnc" id="L11062" title="All 2 branches missed.">            if ((minesweeper != null)</span>
<span class="nc bnc" id="L11063" title="All 2 branches missed.">                    &amp;&amp; ((mf.getType() == Minefield.TYPE_CONVENTIONAL)</span>
<span class="nc bnc" id="L11064" title="All 2 branches missed.">                            || (mf.getType() == Minefield.TYPE_ACTIVE)</span>
<span class="nc bnc" id="L11065" title="All 2 branches missed.">                            || (mf.getType() == Minefield.TYPE_INFERNO))) {</span>
                // Check to see if the minesweeper clears
<span class="nc" id="L11067">                int roll = Compute.d6(2);</span>

                // Report minefield roll
<span class="nc bnc" id="L11070" title="All 2 branches missed.">                if (doBlind()) { // only report if DB, otherwise all players see</span>
<span class="nc" id="L11071">                r = new Report(2152);</span>
<span class="nc" id="L11072">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11073">                r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11074">                r.add(mf.getCoords().getBoardNum());</span>
<span class="nc" id="L11075">                r.add(roll);</span>
<span class="nc" id="L11076">                r.newlines = 0;</span>
<span class="nc" id="L11077">                vMineReport.add(r);</span>
                }

<span class="nc bnc" id="L11080" title="All 2 branches missed.">                if (roll &gt;= 6) {</span>
                    // Report hit
<span class="nc bnc" id="L11082" title="All 2 branches missed.">                    if (doBlind()) {</span>
<span class="nc" id="L11083">                        r = new Report(5543);</span>
<span class="nc" id="L11084">                        r.player = mf.getPlayerId();</span>
<span class="nc" id="L11085">                        vMineReport.add(r);</span>
                    }

                    // Clear the minefield
<span class="nc" id="L11089">                    r = new Report(2158);</span>
<span class="nc" id="L11090">                    r.subject = entity.getId();</span>
<span class="nc" id="L11091">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11092">                    r.add(Minefield.getDisplayableName(mf.getType()), true);</span>
<span class="nc" id="L11093">                    r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11094">                    r.indent();</span>
<span class="nc" id="L11095">                    vMineReport.add(r);</span>
<span class="nc" id="L11096">                    fieldsToRemove.add(mf);</span>

                    // Handle armor value damage
<span class="nc" id="L11099">                    int remainingAV = minesweeper.getArmorValue() - 6;</span>
<span class="nc" id="L11100">                    minesweeper.setArmorValue(Math.max(remainingAV, 0));</span>

<span class="nc" id="L11102">                    r = new Report(2161);</span>
<span class="nc" id="L11103">                    r.indent(2);</span>
<span class="nc" id="L11104">                    r.subject = entity.getId();</span>
<span class="nc" id="L11105">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11106">                    r.add(6);</span>
<span class="nc" id="L11107">                    r.add(Math.max(remainingAV, 0));</span>
<span class="nc" id="L11108">                    vMineReport.add(r);</span>

<span class="nc bnc" id="L11110" title="All 2 branches missed.">                    if (remainingAV &lt;= 0) {</span>
<span class="nc" id="L11111">                        minesweeper.setDestroyed(true);</span>
                    }
                    // Check for damage transfer
<span class="nc bnc" id="L11114" title="All 2 branches missed.">                    if (remainingAV &lt; 0) {</span>
<span class="nc" id="L11115">                        int damage = Math.abs(remainingAV);</span>
<span class="nc" id="L11116">                        r = new Report(2162);</span>
<span class="nc" id="L11117">                        r.indent(2);</span>
<span class="nc" id="L11118">                        r.subject = entity.getId();</span>
<span class="nc" id="L11119">                        r.add(damage, true);</span>
<span class="nc" id="L11120">                        vMineReport.add(r);</span>

                        // Damage is dealt to the location of minesweeper
<span class="nc" id="L11123">                        HitData hit = new HitData(minesweeper.getLocation());</span>
<span class="nc" id="L11124">                        Vector&lt;Report&gt; damageReports = damageEntity(entity, hit, damage);</span>
<span class="nc bnc" id="L11125" title="All 2 branches missed.">                        for (Report r1 : damageReports) {</span>
<span class="nc" id="L11126">                            r1.indent(1);</span>
<span class="nc" id="L11127">                        }</span>
<span class="nc" id="L11128">                        vMineReport.addAll(damageReports);</span>
                    }
<span class="nc" id="L11130">                    Report.addNewline(vMineReport);</span>
                    // If the minefield is cleared, we're done processing it
<span class="nc" id="L11132">                    continue;</span>
                } else {
                    // Report miss
<span class="nc bnc" id="L11135" title="All 2 branches missed.">                    if (doBlind()) {</span>
<span class="nc" id="L11136">                        r = new Report(5542);</span>
<span class="nc" id="L11137">                        r.player = mf.getPlayerId();</span>
<span class="nc" id="L11138">                        vMineReport.add(r);</span>
                    }
                }
            }

            // check whether we have an active mine
<span class="nc bnc" id="L11144" title="All 4 branches missed.">            if ((mf.getType() == Minefield.TYPE_ACTIVE) &amp;&amp; isOnGround) {</span>
<span class="nc" id="L11145">                continue;</span>
            }
<span class="nc bnc" id="L11147" title="All 4 branches missed.">            if ((mf.getType() != Minefield.TYPE_ACTIVE) &amp;&amp; !isOnGround) {</span>
<span class="nc" id="L11148">                continue;</span>
            }

            // set the target number
<span class="nc bnc" id="L11152" title="All 2 branches missed.">            if (target == -1) {</span>
<span class="nc" id="L11153">                target = mf.getTrigger();</span>
<span class="nc bnc" id="L11154" title="All 2 branches missed.">                if (mf.getType() == Minefield.TYPE_ACTIVE) {</span>
<span class="nc" id="L11155">                    target = 9;</span>
                }
<span class="nc bnc" id="L11157" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc" id="L11158">                    target += 1;</span>
                }
<span class="nc bnc" id="L11160" title="All 2 branches missed.">                if (entity.hasAbility(OptionsConstants.MISC_EAGLE_EYES)) {</span>
<span class="nc" id="L11161">                    target += 2;</span>
                }
<span class="nc bnc" id="L11163" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L11164" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L11165">                    target = 12;</span>
                }
            }

<span class="nc" id="L11169">            int roll = Compute.d6(2);</span>

            // Report minefield roll
<span class="nc bnc" id="L11172" title="All 2 branches missed.">            if (doBlind()) { // Only do if DB, otherwise all players will see</span>
<span class="nc" id="L11173">                r = new Report(2151);</span>
<span class="nc" id="L11174">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11175">                r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11176">                r.add(mf.getCoords().getBoardNum());</span>
<span class="nc" id="L11177">                r.add(target);</span>
<span class="nc" id="L11178">                r.add(roll);</span>
<span class="nc" id="L11179">                r.newlines = 0;</span>
<span class="nc" id="L11180">                vMineReport.add(r);</span>
            }

<span class="nc bnc" id="L11183" title="All 2 branches missed.">            if (roll &lt; target) {</span>
                // Report miss
<span class="nc bnc" id="L11185" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L11186">                    r = new Report(2217);</span>
<span class="nc" id="L11187">                    r.player = mf.getPlayerId();</span>
<span class="nc" id="L11188">                    vMineReport.add(r);</span>
                }
                continue;
            }

            // Report hit
<span class="nc bnc" id="L11194" title="All 2 branches missed.">            if (doBlind()) {</span>
<span class="nc" id="L11195">                r = new Report(2270);</span>
<span class="nc" id="L11196">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11197">                vMineReport.add(r);</span>
            }

            // apply damage
<span class="nc" id="L11201">            trippedMine = true;</span>
            // explodedMines.add(mf);
<span class="nc" id="L11203">            mf.setDetonated(true);</span>
<span class="nc bnc" id="L11204" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_INFERNO) {</span>
                // report hitting an inferno mine
<span class="nc" id="L11206">                r = new Report(2155);</span>
<span class="nc" id="L11207">                r.subject = entity.getId();</span>
<span class="nc" id="L11208">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11209">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11210">                r.indent();</span>
<span class="nc" id="L11211">                vMineReport.add(r);</span>
<span class="nc" id="L11212">                vMineReport.addAll(deliverInfernoMissiles(entity, entity, mf.getDensity() / 2));</span>
            } else {
<span class="nc" id="L11214">                r = new Report(2150);</span>
<span class="nc" id="L11215">                r.subject = entity.getId();</span>
<span class="nc" id="L11216">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11217">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11218">                r.indent();</span>
<span class="nc" id="L11219">                vMineReport.add(r);</span>
<span class="nc" id="L11220">                int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11221" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L11222">                    int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11223">                    damage = damage - cur_damage;</span>
                    HitData hit;
<span class="nc bnc" id="L11225" title="All 2 branches missed.">                    if (minesweeper == null) {</span>
<span class="nc" id="L11226">                        hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE,</span>
                                Minefield.TO_HIT_SIDE);
                    } else { // Minesweepers cause mines to hit minesweeper loc
<span class="nc" id="L11229">                        hit = new HitData(minesweeper.getLocation());</span>
                    }
<span class="nc" id="L11231">                    vMineReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11232">                }</span>
<span class="nc bnc" id="L11233" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
                    // Tanks check for motive system damage from minefields as
                    // from a side hit even though the damage proper hits the
                    // front above; exact side doesn't matter, though.
<span class="nc" id="L11237">                    vMineReport.addAll(vehicleMotiveDamage((Tank)entity,</span>
<span class="nc" id="L11238">                            entity.getMotiveSideMod(ToHitData.SIDE_LEFT)));</span>
                }
<span class="nc" id="L11240">                Report.addNewline(vMineReport);</span>
            }

            // check the direct reduction
<span class="nc" id="L11244">            mf.checkReduction(0, true);</span>
<span class="nc" id="L11245">            revealMinefield(mf);</span>
<span class="nc" id="L11246">        }</span>

<span class="nc bnc" id="L11248" title="All 2 branches missed.">        for (Minefield mf : fieldsToRemove) {</span>
<span class="nc" id="L11249">            removeMinefield(mf);</span>
<span class="nc" id="L11250">        }</span>

<span class="nc" id="L11252">        return trippedMine;</span>
    }

    /**
     * cycle through all mines on the board, check to see whether they should do
     * collateral damage to other mines due to detonation, resets detonation to
     * false, and removes any mines whose density has been reduced to zero.
     */
    private void resetMines() {
<span class="nc" id="L11261">        Enumeration&lt;Coords&gt; mineLoc = game.getMinedCoords();</span>
<span class="nc bnc" id="L11262" title="All 2 branches missed.">        while (mineLoc.hasMoreElements()) {</span>
<span class="nc" id="L11263">            Coords c = mineLoc.nextElement();</span>
<span class="nc" id="L11264">            Enumeration&lt;Minefield&gt; minefields = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11265" title="All 2 branches missed.">            while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L11266">                Minefield minefield = minefields.nextElement();</span>
<span class="nc bnc" id="L11267" title="All 2 branches missed.">                if (minefield.hasDetonated()) {</span>
<span class="nc" id="L11268">                    minefield.setDetonated(false);</span>
<span class="nc" id="L11269">                    Enumeration&lt;Minefield&gt; otherMines = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11270" title="All 2 branches missed.">                    while (otherMines.hasMoreElements()) {</span>
<span class="nc" id="L11271">                        Minefield otherMine = otherMines.nextElement();</span>
<span class="nc bnc" id="L11272" title="All 2 branches missed.">                        if (otherMine.equals(minefield)) {</span>
<span class="nc" id="L11273">                            continue;</span>
                        }
<span class="nc" id="L11275">                        int bonus = 0;</span>
<span class="nc bnc" id="L11276" title="All 2 branches missed.">                        if (otherMine.getDensity() &gt; minefield.getDensity()) {</span>
<span class="nc" id="L11277">                            bonus = 1;</span>
                        }
<span class="nc bnc" id="L11279" title="All 2 branches missed.">                        if (otherMine.getDensity() &lt; minefield.getDensity()) {</span>
<span class="nc" id="L11280">                            bonus = -1;</span>
                        }
<span class="nc" id="L11282">                        otherMine.checkReduction(bonus, false);</span>
<span class="nc" id="L11283">                    }</span>
                }
<span class="nc" id="L11285">            }</span>
            // cycle through a second time to see if any mines at these coords
            // need to be removed
<span class="nc" id="L11288">            List&lt;Minefield&gt; mfRemoved = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L11289">            Enumeration&lt;Minefield&gt; mines = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11290" title="All 2 branches missed.">            while (mines.hasMoreElements()) {</span>
<span class="nc" id="L11291">                Minefield mine = mines.nextElement();</span>
<span class="nc bnc" id="L11292" title="All 2 branches missed.">                if (mine.getDensity() &lt; 5) {</span>
<span class="nc" id="L11293">                    mfRemoved.add(mine);</span>
                }
<span class="nc" id="L11295">            }</span>
            // we have to do it this way to avoid a concurrent error problem
<span class="nc bnc" id="L11297" title="All 2 branches missed.">            for (Minefield mf : mfRemoved) {</span>
<span class="nc" id="L11298">                removeMinefield(mf);</span>
<span class="nc" id="L11299">            }</span>
            // update the mines at these coords
<span class="nc" id="L11301">            sendChangedMines(c);</span>
<span class="nc" id="L11302">        }</span>
<span class="nc" id="L11303">    }</span>

    /**
     * attempt to clear a minefield
     *
     * @param mf     - a &lt;code&gt;Minefield&lt;/code&gt; to clear
     * @param en     - &lt;code&gt;entity&lt;/code&gt; doing the clearing
     * @param target - &lt;code&gt;int&lt;/code&gt; needed to roll for a successful clearance
     * @return &lt;code&gt;true&lt;/code&gt; if clearance successful
     */
    public boolean clearMinefield(Minefield mf, Entity en, int target,
                                  Vector&lt;Report&gt; vClearReport) {
<span class="nc" id="L11315">        return clearMinefield(mf, en, target, -1, vClearReport, 2);</span>
    }

    public boolean clearMinefield(Minefield mf, Entity en, int target,
                                  int botch, Vector&lt;Report&gt; vClearReport) {
<span class="nc" id="L11320">        return clearMinefield(mf, en, target, botch, vClearReport, 1);</span>
    }

    /**
     * attempt to clear a minefield We don't actually remove the minefield here,
     * because if this is called up from within a loop, that will cause problems
     *
     * @param mf
     *            - a &lt;code&gt;Minefield&lt;/code&gt; to clear
     * @param en
     *            - &lt;code&gt;entity&lt;/code&gt; doing the clearing
     * @param target
     *            - &lt;code&gt;int&lt;/code&gt; needed to roll for a successful clearance
     * @param botch
     *            - &lt;code&gt;int&lt;/code&gt; that indicates an accidental detonation
     * @param vClearReport
     *            - The report collection to report to
     * @param indent
     *            - The number of indents for the report
     * @return &lt;code&gt;true&lt;/code&gt; if clearance successful
     */
    public boolean clearMinefield(Minefield mf, Entity en, int target,
            int botch, Vector&lt;Report&gt; vClearReport, int indent) {
        Report r;
<span class="nc" id="L11344">        int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L11345" title="All 2 branches missed.">        if (roll &gt;= target) {</span>
<span class="nc" id="L11346">            r = new Report(2250);</span>
<span class="nc" id="L11347">            r.subject = en.getId();</span>
<span class="nc" id="L11348">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11349">            r.add(target);</span>
<span class="nc" id="L11350">            r.add(roll);</span>
<span class="nc" id="L11351">            r.indent(indent);</span>
<span class="nc" id="L11352">            vClearReport.add(r);</span>
<span class="nc" id="L11353">            return true;</span>
<span class="nc bnc" id="L11354" title="All 2 branches missed.">        } else if (roll &lt;= botch) {</span>
            // TODO : detonate the minefield
<span class="nc" id="L11356">            r = new Report(2255);</span>
<span class="nc" id="L11357">            r.subject = en.getId();</span>
<span class="nc" id="L11358">            r.indent(indent);</span>
<span class="nc" id="L11359">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11360">            r.add(target);</span>
<span class="nc" id="L11361">            r.add(roll);</span>
<span class="nc" id="L11362">            vClearReport.add(r);</span>
            // The detonation damages any units that were also attempting to
            // clear mines in the same hex
<span class="nc bnc" id="L11365" title="All 2 branches missed.">            for (Entity victim : game.getEntitiesVector(mf.getCoords())) {</span>
                Report rVictim;
<span class="nc bnc" id="L11367" title="All 2 branches missed.">                if (victim.isClearingMinefield()) {</span>
<span class="nc" id="L11368">                    rVictim = new Report(2265);</span>
<span class="nc" id="L11369">                    rVictim.subject = victim.getId();</span>
<span class="nc" id="L11370">                    rVictim.add(victim.getShortName(), true);</span>
<span class="nc" id="L11371">                    rVictim.indent(indent + 1);</span>
<span class="nc" id="L11372">                    vClearReport.add(rVictim);</span>
<span class="nc" id="L11373">                    int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11374" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L11375">                        int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11376">                        damage = damage - cur_damage;</span>
<span class="nc" id="L11377">                        HitData hit = victim.rollHitLocation(</span>
                                Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);
<span class="nc" id="L11379">                        vClearReport.addAll(damageEntity(victim, hit, cur_damage));</span>
<span class="nc" id="L11380">                    }</span>
                }
<span class="nc" id="L11382">            }</span>
            // reduction works differently here
<span class="nc bnc" id="L11384" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L11385">                mf.setDensity(Math.max(5, mf.getDensity() - 5));</span>
            } else {
                // congratulations, you cleared the mine by blowing yourself up
<span class="nc" id="L11388">                return true;</span>
            }
        } else {
            // failure
<span class="nc" id="L11392">            r = new Report(2260);</span>
<span class="nc" id="L11393">            r.subject = en.getId();</span>
<span class="nc" id="L11394">            r.indent(indent);</span>
<span class="nc" id="L11395">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11396">            r.add(target);</span>
<span class="nc" id="L11397">            r.add(roll);</span>
<span class="nc" id="L11398">            vClearReport.add(r);</span>
        }
<span class="nc" id="L11400">        return false;</span>
    }

    /**
     * Clear any detonated mines at these coords
     */
    private void clearDetonatedMines(Coords c, int target) {
<span class="nc" id="L11407">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(c).elements();</span>
<span class="nc" id="L11408">        List&lt;Minefield&gt; mfRemoved = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L11409" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L11410">            Minefield minefield = minefields.nextElement();</span>
<span class="nc bnc" id="L11411" title="All 4 branches missed.">            if (minefield.hasDetonated() &amp;&amp; (Compute.d6(2) &gt;= target)) {</span>
<span class="nc" id="L11412">                mfRemoved.add(minefield);</span>
            }
<span class="nc" id="L11414">        }</span>
        // we have to do it this way to avoid a concurrent error problem
<span class="nc bnc" id="L11416" title="All 2 branches missed.">        for (Minefield mf : mfRemoved) {</span>
<span class="nc" id="L11417">            removeMinefield(mf);</span>
<span class="nc" id="L11418">        }</span>
<span class="nc" id="L11419">    }</span>

    /**
     * Checks to see if an entity sets off any vibrabombs.
     */
    private boolean checkVibrabombs(Entity entity, Coords coords, boolean displaced,
                                    Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11426">        return checkVibrabombs(entity, coords, displaced, null, null, vMineReport);</span>
    }

    /**
     * Checks to see if an entity sets off any vibrabombs.
     */
    private boolean checkVibrabombs(Entity entity, Coords coords, boolean displaced, Coords lastPos,
                                    Coords curPos, Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11434">        int mass = (int) entity.getWeight();</span>

        // Check for Mine sweepers
<span class="nc" id="L11437">        Mounted minesweeper = null;</span>
<span class="nc bnc" id="L11438" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L11439" title="All 6 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; m.isReady() &amp;&amp; (m.getArmorValue() &gt; 0)) {</span>
<span class="nc" id="L11440">                minesweeper = m;</span>
<span class="nc" id="L11441">                break; // Can only have one minesweeper</span>
            }
<span class="nc" id="L11443">        }</span>

        // Check for minesweepers sweeping VB minefields
<span class="nc bnc" id="L11446" title="All 2 branches missed.">        if (minesweeper != null) {</span>
<span class="nc" id="L11447">            Vector&lt;Minefield&gt; fieldsToRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L11448" title="All 2 branches missed.">            for (Minefield mf : game.getVibrabombs()) {</span>
                // Ignore mines if they aren't in this position
<span class="nc bnc" id="L11450" title="All 2 branches missed.">                if (!mf.getCoords().equals(coords)) {</span>
<span class="nc" id="L11451">                    continue;</span>
                }

                // Minesweepers on units within 9 tons of the vibrafield setting
                // automatically clear the minefield
<span class="nc bnc" id="L11456" title="All 2 branches missed.">                if (Math.abs(mass - mf.getSetting()) &lt; 10) {</span>
                    // Clear the minefield
                    Report r;
<span class="nc" id="L11459">                    r = new Report(2158);</span>
<span class="nc" id="L11460">                    r.subject = entity.getId();</span>
<span class="nc" id="L11461">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11462">                    r.add(Minefield.getDisplayableName(mf.getType()), true);</span>
<span class="nc" id="L11463">                    r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11464">                    r.indent();</span>
<span class="nc" id="L11465">                    vMineReport.add(r);</span>
<span class="nc" id="L11466">                    fieldsToRemove.add(mf);</span>

                    // Handle armor value damage
<span class="nc" id="L11469">                    int remainingAV = minesweeper.getArmorValue() - 10;</span>
<span class="nc" id="L11470">                    minesweeper.setArmorValue(Math.max(remainingAV, 0));</span>

<span class="nc" id="L11472">                    r = new Report(2161);</span>
<span class="nc" id="L11473">                    r.indent(2);</span>
<span class="nc" id="L11474">                    r.subject = entity.getId();</span>
<span class="nc" id="L11475">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11476">                    r.add(10);</span>
<span class="nc" id="L11477">                    r.add(Math.max(remainingAV, 0));</span>
<span class="nc" id="L11478">                    vMineReport.add(r);</span>

<span class="nc bnc" id="L11480" title="All 2 branches missed.">                    if (remainingAV &lt;= 0) {</span>
<span class="nc" id="L11481">                        minesweeper.setDestroyed(true);</span>
                    }
                    // Check for damage transfer
<span class="nc bnc" id="L11484" title="All 2 branches missed.">                    if (remainingAV &lt; 0) {</span>
<span class="nc" id="L11485">                        int damage = Math.abs(remainingAV);</span>
<span class="nc" id="L11486">                        r = new Report(2162);</span>
<span class="nc" id="L11487">                        r.indent(2);</span>
<span class="nc" id="L11488">                        r.subject = entity.getId();</span>
<span class="nc" id="L11489">                        r.add(damage, true);</span>
<span class="nc" id="L11490">                        vMineReport.add(r);</span>

                        // Damage is dealt to the location of minesweeper
<span class="nc" id="L11493">                        HitData hit = new HitData(minesweeper.getLocation());</span>
<span class="nc" id="L11494">                        Vector&lt;Report&gt; damageReports = damageEntity(entity, hit, damage);</span>
<span class="nc bnc" id="L11495" title="All 2 branches missed.">                        for (Report r1 : damageReports) {</span>
<span class="nc" id="L11496">                            r1.indent(1);</span>
<span class="nc" id="L11497">                        }</span>
<span class="nc" id="L11498">                        vMineReport.addAll(damageReports);</span>
<span class="nc" id="L11499">                        entity.applyDamage();</span>
                    }
<span class="nc" id="L11501">                    Report.addNewline(vMineReport);</span>
                }
<span class="nc" id="L11503">            }</span>
<span class="nc bnc" id="L11504" title="All 2 branches missed.">            for (Minefield mf : fieldsToRemove) {</span>
<span class="nc" id="L11505">                removeMinefield(mf);</span>
<span class="nc" id="L11506">            }</span>
        }


<span class="nc" id="L11510">        boolean boom = false;</span>
        // Only mechs can set off vibrabombs. QuadVees should only be able to set off a
        // vibrabomb in Mech mode. Those that are converting to or from Mech mode should
        // are using leg movement and should be able to set them off.
<span class="nc bnc" id="L11514" title="All 4 branches missed.">        if (!(entity instanceof Mech) || (entity instanceof QuadVee</span>
<span class="nc bnc" id="L11515" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</span>
<span class="nc bnc" id="L11516" title="All 2 branches missed.">                &amp;&amp; !entity.isConvertingNow())) {</span>
<span class="nc" id="L11517">            return false;</span>
        }

<span class="nc" id="L11520">        Enumeration&lt;Minefield&gt; e = game.getVibrabombs().elements();</span>

<span class="nc bnc" id="L11522" title="All 2 branches missed.">        while (e.hasMoreElements()) {</span>
<span class="nc" id="L11523">            Minefield mf = e.nextElement();</span>

            // Bug 954272: Mines shouldn't work underwater, and BMRr says
            // Vibrabombs are mines
<span class="nc bnc" id="L11527" title="All 2 branches missed.">            if (game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L11528" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L11529" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L11530">                continue;</span>
            }

            // Mech weighing 10 tons or less can't set off the bomb
<span class="nc bnc" id="L11534" title="All 2 branches missed.">            if (mass &lt;= (mf.getSetting() - 10)) {</span>
<span class="nc" id="L11535">                continue;</span>
            }

<span class="nc" id="L11538">            int effectiveDistance = (mass - mf.getSetting()) / 10;</span>
<span class="nc" id="L11539">            int actualDistance = coords.distance(mf.getCoords());</span>

<span class="nc bnc" id="L11541" title="All 2 branches missed.">            if (actualDistance &lt;= effectiveDistance) {</span>
<span class="nc" id="L11542">                Report r = new Report(2156);</span>
<span class="nc" id="L11543">                r.subject = entity.getId();</span>
<span class="nc" id="L11544">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11545">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11546">                vMineReport.add(r);</span>
                
                // if the moving entity is not actually moving into the vibrabomb
                // hex, it won't get damaged
<span class="nc" id="L11550">                Integer excludeEntityID = null;</span>
<span class="nc bnc" id="L11551" title="All 2 branches missed.">                if (!coords.equals(mf.getCoords())) {</span>
<span class="nc" id="L11552">                    excludeEntityID = entity.getId();</span>
                }
                    
<span class="nc" id="L11555">                explodeVibrabomb(mf, vMineReport, false, excludeEntityID);</span>
            }

            // Hack; when moving, the Mech isn't in the hex during
            // the movement.
<span class="nc bnc" id="L11560" title="All 4 branches missed.">            if (!displaced &amp;&amp; (actualDistance == 0)) {</span>
                // report getting hit by vibrabomb
<span class="nc" id="L11562">                Report r = new Report(2160);</span>
<span class="nc" id="L11563">                r.subject = entity.getId();</span>
<span class="nc" id="L11564">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11565">                vMineReport.add(r);</span>
<span class="nc" id="L11566">                int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11567" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L11568">                    int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11569">                    damage = damage - cur_damage;</span>
<span class="nc" id="L11570">                    HitData hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);</span>
<span class="nc" id="L11571">                    vMineReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11572">                }</span>
<span class="nc" id="L11573">                vMineReport.addAll(resolvePilotingRolls(entity, true, lastPos, curPos));</span>
                // we need to apply Damage now, in case the entity lost a leg,
                // otherwise it won't get a leg missing mod if it hasn't yet
                // moved and lost a leg, see bug 1071434 for an example
<span class="nc" id="L11577">                entity.applyDamage();</span>
            }

            // don't check for reduction until the end or units in the same hex
            // through
            // movement will get the reduced damage
<span class="nc bnc" id="L11583" title="All 2 branches missed.">            if (mf.hasDetonated()) {</span>
<span class="nc" id="L11584">                boom = true;</span>
<span class="nc" id="L11585">                mf.checkReduction(0, true);</span>
            }

<span class="nc" id="L11588">        }</span>
<span class="nc" id="L11589">        return boom;</span>
    }

    /**
     * Removes the minefield from the game.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to remove
     */
    public void removeMinefield(Minefield mf) {
<span class="nc bnc" id="L11598" title="All 2 branches missed.">        if (game.containsVibrabomb(mf)) {</span>
<span class="nc" id="L11599">            game.removeVibrabomb(mf);</span>
        }
<span class="nc" id="L11601">        game.removeMinefield(mf);</span>

<span class="nc" id="L11603">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc bnc" id="L11604" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L11605">            IPlayer player = players.nextElement();</span>
<span class="nc" id="L11606">            removeMinefield(player, mf);</span>
<span class="nc" id="L11607">        }</span>
<span class="nc" id="L11608">    }</span>

    /**
     * Removes the minefield from a player.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; whose minefield should be removed
     * @param mf     The &lt;code&gt;Minefield&lt;/code&gt; to be removed
     */
    private void removeMinefield(IPlayer player, Minefield mf) {
<span class="nc bnc" id="L11617" title="All 2 branches missed.">        if (player.containsMinefield(mf)) {</span>
<span class="nc" id="L11618">            player.removeMinefield(mf);</span>
<span class="nc" id="L11619">            send(player.getId(), new Packet(Packet.COMMAND_REMOVE_MINEFIELD, mf));</span>
        }
<span class="nc" id="L11621">    }</span>

    /**
     * Reveals a minefield for all players.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to be revealed
     */
    private void revealMinefield(Minefield mf) {
<span class="nc" id="L11629">        Enumeration&lt;Team&gt; teams = game.getTeams();</span>
<span class="nc bnc" id="L11630" title="All 2 branches missed.">        while (teams.hasMoreElements()) {</span>
<span class="nc" id="L11631">            Team team = teams.nextElement();</span>
<span class="nc" id="L11632">            revealMinefield(team, mf);</span>
<span class="nc" id="L11633">        }</span>
<span class="nc" id="L11634">    }</span>

    /**
     * Reveals a minefield for all players on a team.
     *
     * @param team The &lt;code&gt;team&lt;/code&gt; whose minefield should be revealed
     * @param mf   The &lt;code&gt;Minefield&lt;/code&gt; to be revealed
     */
    private void revealMinefield(Team team, Minefield mf) {
<span class="nc" id="L11643">        Enumeration&lt;IPlayer&gt; players = team.getPlayers();</span>
<span class="nc bnc" id="L11644" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L11645">            IPlayer player = players.nextElement();</span>
<span class="nc bnc" id="L11646" title="All 2 branches missed.">            if (!player.containsMinefield(mf)) {</span>
<span class="nc" id="L11647">                player.addMinefield(mf);</span>
<span class="nc" id="L11648">                send(player.getId(), new Packet(Packet.COMMAND_REVEAL_MINEFIELD, mf));</span>
            }
<span class="nc" id="L11650">        }</span>
<span class="nc" id="L11651">    }</span>

    /**
     * checks whether a newly set mine should be revealed to players based on
     * LOS. If so, then it reveals the mine
     */
    private void checkForRevealMinefield(Minefield mf, Entity layer) {
<span class="nc" id="L11658">        Enumeration&lt;Team&gt; teams = game.getTeams();</span>
        // loop through each team and determine if they can see the mine, then
        // loop through players on team
        // and reveal the mine
<span class="nc bnc" id="L11662" title="All 2 branches missed.">        while (teams.hasMoreElements()) {</span>
<span class="nc" id="L11663">            Team team = teams.nextElement();</span>
<span class="nc" id="L11664">            boolean canSee = false;</span>

            // the players own team can always see the mine
<span class="nc bnc" id="L11667" title="All 2 branches missed.">            if (team.equals(game.getTeamForPlayer(game.getPlayer(mf.getPlayerId())))) {</span>
<span class="nc" id="L11668">                canSee = true;</span>
            } else {
                // need to loop through all entities on this team and find the
                // one with the best shot of seeing
                // the mine placement
<span class="nc" id="L11673">                int target = Integer.MAX_VALUE;</span>
<span class="nc" id="L11674">                Iterator&lt;Entity&gt; entities = game.getEntities();</span>
<span class="nc bnc" id="L11675" title="All 2 branches missed.">                while (entities.hasNext()) {</span>
<span class="nc" id="L11676">                    Entity en = entities.next();</span>
                    // are we on the right team?
<span class="nc bnc" id="L11678" title="All 2 branches missed.">                    if (!team.equals(game.getTeamForPlayer(en.getOwner()))) {</span>
<span class="nc" id="L11679">                        continue;</span>
                    }
<span class="nc" id="L11681">                    if (LosEffects.calculateLos(game, en.getId(),</span>
<span class="nc" id="L11682">                            new HexTarget(mf.getCoords(), game.getBoard(),</span>
<span class="nc bnc" id="L11683" title="All 2 branches missed.">                                    Targetable.TYPE_HEX_CLEAR)).canSee()) {</span>
<span class="nc" id="L11684">                        target = 0;</span>
<span class="nc" id="L11685">                        break;</span>
                    }
<span class="nc" id="L11687">                    LosEffects los = LosEffects.calculateLos(game, en.getId(), layer);</span>
<span class="nc bnc" id="L11688" title="All 2 branches missed.">                    if (los.canSee()) {</span>
                        // TODO : need to add mods
<span class="nc" id="L11690">                        ToHitData current = new ToHitData(4, &quot;base&quot;);</span>
<span class="nc" id="L11691">                        current.append(Compute.getAttackerMovementModifier(game, en.getId()));</span>
<span class="nc" id="L11692">                        current.append(Compute.getTargetMovementModifier(game, layer.getId()));</span>
<span class="nc" id="L11693">                        current.append(los.losModifiers(game));</span>
<span class="nc bnc" id="L11694" title="All 2 branches missed.">                        if (current.getValue() &lt; target) {</span>
<span class="nc" id="L11695">                            target = current.getValue();</span>
                        }
                    }
<span class="nc" id="L11698">                }</span>

<span class="nc bnc" id="L11700" title="All 2 branches missed.">                if (Compute.d6(2) &gt;= target) {</span>
<span class="nc" id="L11701">                    canSee = true;</span>
                }
            }
<span class="nc bnc" id="L11704" title="All 2 branches missed.">            if (canSee) {</span>
<span class="nc" id="L11705">                revealMinefield(team, mf);</span>
            }
<span class="nc" id="L11707">        }</span>
<span class="nc" id="L11708">    }</span>

    /**
     * Explodes a vibrabomb.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to explode
     */
    private void explodeVibrabomb(Minefield mf, Vector&lt;Report&gt; vBoomReport, boolean reduce, Integer entityToExclude) {
<span class="nc" id="L11716">        Iterator&lt;Entity&gt; targets = game.getEntities(mf.getCoords());</span>
        Report r;

<span class="nc bnc" id="L11719" title="All 2 branches missed.">        while (targets.hasNext()) {</span>
<span class="nc" id="L11720">            Entity entity = targets.next();</span>

            // Airborne entities wont get hit by the mines...
<span class="nc bnc" id="L11723" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L11724">                continue;</span>
            }

            // check for the OptionsConstants.ADVGRNDMOV_NO_PREMOVE_VIBRA option
            // If it's set, and the target has not yet moved,
            // it doesn't get damaged.
<span class="nc bnc" id="L11730" title="All 2 branches missed.">            if (!entity.isDone()</span>
<span class="nc bnc" id="L11731" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_PREMOVE_VIBRA)) {</span>
<span class="nc" id="L11732">                r = new Report(2157);</span>
<span class="nc" id="L11733">                r.subject = entity.getId();</span>
<span class="nc" id="L11734">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11735">                vBoomReport.add(r);</span>
<span class="nc" id="L11736">                continue;</span>
            }
            
            // the &quot;currently moving entity&quot; may not be in the same hex, so it needs to be excluded
<span class="nc bnc" id="L11740" title="All 4 branches missed.">            if ((entityToExclude != null) &amp;&amp; (entity.getId() == entityToExclude)) {</span>
                // report not hitting vibrabomb
<span class="nc" id="L11742">                r = new Report(2157);</span>
<span class="nc" id="L11743">                r.subject = entity.getId();</span>
<span class="nc" id="L11744">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11745">                vBoomReport.add(r);</span>
<span class="nc" id="L11746">                continue;</span>
            } else {
                // report hitting vibrabomb
<span class="nc" id="L11749">                r = new Report(2160);</span>
<span class="nc" id="L11750">                r.subject = entity.getId();</span>
<span class="nc" id="L11751">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11752">                vBoomReport.add(r);</span>
            }
            
<span class="nc" id="L11755">            int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11756" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L11757">                int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11758">                damage = damage - cur_damage;</span>
<span class="nc" id="L11759">                HitData hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);</span>
<span class="nc" id="L11760">                vBoomReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11761">            }</span>
<span class="nc" id="L11762">            Report.addNewline(vBoomReport);</span>

<span class="nc bnc" id="L11764" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L11765">                vBoomReport.addAll(vehicleMotiveDamage((Tank)entity,</span>
<span class="nc" id="L11766">                        entity.getMotiveSideMod(ToHitData.SIDE_LEFT)));</span>
            }
<span class="nc" id="L11768">            vBoomReport.addAll(resolvePilotingRolls(entity, true, entity.getPosition(),</span>
<span class="nc" id="L11769">                    entity.getPosition()));</span>
            // we need to apply Damage now, in case the entity lost a leg,
            // otherwise it won't get a leg missing mod if it hasn't yet
            // moved and lost a leg, see bug 1071434 for an example
<span class="nc" id="L11773">            game.resetPSRs(entity);</span>
<span class="nc" id="L11774">            entity.applyDamage();</span>
<span class="nc" id="L11775">            Report.addNewline(vBoomReport);</span>
<span class="nc" id="L11776">            entityUpdate(entity.getId());</span>
<span class="nc" id="L11777">        }</span>

        // check the direct reduction of mine
<span class="nc bnc" id="L11780" title="All 2 branches missed.">        if (reduce) {</span>
<span class="nc" id="L11781">            mf.checkReduction(0, true);</span>
        }
<span class="nc" id="L11783">        mf.setDetonated(true);</span>
<span class="nc" id="L11784">    }</span>

    /**
     * drowns any units swarming the entity
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is being swarmed
     * @param pos    The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    private void drownSwarmer(Entity entity, Coords pos) {
        // Any swarming infantry will be destroyed.
<span class="nc" id="L11794">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L11795" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L11796">            final Entity swarmer = game.getEntity(swarmerId);</span>
            // Only *platoons* drown while swarming.
<span class="nc bnc" id="L11798" title="All 2 branches missed.">            if (!(swarmer instanceof BattleArmor)) {</span>
<span class="nc" id="L11799">                swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L11800">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L11801">                swarmer.setPosition(pos);</span>
<span class="nc" id="L11802">                Report r = new Report(2165);</span>
<span class="nc" id="L11803">                r.subject = entity.getId();</span>
<span class="nc" id="L11804">                r.indent();</span>
<span class="nc" id="L11805">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11806">                addReport(r);</span>
<span class="nc" id="L11807">                addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L11808">                entityUpdate(swarmerId);</span>
            }
        }
<span class="nc" id="L11811">    }</span>

    /**
     * Checks to see if we may have just washed off infernos. Call after a step
     * which may have done this.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is being checked
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    void checkForWashedInfernos(Entity entity, Coords coords) {
<span class="nc" id="L11821">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L11822">        int waterLevel = hex.terrainLevel(Terrains.WATER);</span>
        // Mech on fire with infernos can wash them off.
<span class="nc bnc" id="L11824" title="All 4 branches missed.">        if (!(entity instanceof Mech) || !entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L11825">            return;</span>
        }
        // Check if entering depth 2 water or prone in depth 1.
<span class="nc bnc" id="L11828" title="All 4 branches missed.">        if ((waterLevel &gt; 0) &amp;&amp; (entity.relHeight() &lt; 0)) {</span>
<span class="nc" id="L11829">            washInferno(entity, coords);</span>
        }
<span class="nc" id="L11831">    }</span>

    /**
     * Washes off an inferno from a mech and adds it to the (water) hex.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is taking a bath
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    void washInferno(Entity entity, Coords coords) {
<span class="nc" id="L11840">        game.getBoard().addInfernoTo(coords, InfernoTracker.STANDARD_ROUND, 1);</span>
<span class="nc" id="L11841">        entity.infernos.clear();</span>

        // Start a fire in the hex?
<span class="nc" id="L11844">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L11845">        Report r = new Report(2170);</span>
<span class="nc" id="L11846">        r.subject = entity.getId();</span>
<span class="nc" id="L11847">        r.addDesc(entity);</span>
<span class="nc bnc" id="L11848" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L11849">            r.messageId = 2175;</span>
<span class="nc" id="L11850">            ignite(coords, Terrains.FIRE_LVL_INFERNO, null);</span>
        }
<span class="nc" id="L11852">        addReport(r);</span>
<span class="nc" id="L11853">    }</span>

    /**
     * Add heat from the movement phase
     */
    public void addMovementHeat() {
<span class="nc bnc" id="L11859" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L11860">            Entity entity = i.next();</span>

<span class="nc bnc" id="L11862" title="All 2 branches missed.">            if (entity.hasDamagedRHS()) {</span>
<span class="nc" id="L11863">                entity.heatBuildup += 1;</span>
            }

<span class="nc bnc" id="L11866" title="All 2 branches missed.">            if ((entity.getMovementMode() == EntityMovementMode.BIPED_SWIM)</span>
<span class="nc bnc" id="L11867" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.QUAD_SWIM)) {</span>
                // UMU heat
<span class="nc" id="L11869">                entity.heatBuildup += 1;</span>
<span class="nc" id="L11870">                continue;</span>
            }

            // build up heat from movement
<span class="nc bnc" id="L11874" title="All 4 branches missed.">            if (entity.isEvading() &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L11875">                entity.heatBuildup += entity.getRunHeat() + 2;</span>
<span class="nc bnc" id="L11876" title="All 2 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_NONE) {</span>
<span class="nc" id="L11877">                entity.heatBuildup += entity.getStandingHeat();</span>
<span class="nc bnc" id="L11878" title="All 6 branches missed.">            } else if ((entity.moved == EntityMovementType.MOVE_WALK)</span>
                       || (entity.moved == EntityMovementType.MOVE_VTOL_WALK)
                       || (entity.moved == EntityMovementType.MOVE_CAREFUL_STAND)) {
<span class="nc" id="L11881">                entity.heatBuildup += entity.getWalkHeat();</span>
<span class="nc bnc" id="L11882" title="All 6 branches missed.">            } else if ((entity.moved == EntityMovementType.MOVE_RUN)</span>
                       || (entity.moved == EntityMovementType.MOVE_VTOL_RUN)
                       || (entity.moved == EntityMovementType.MOVE_SKID)) {
<span class="nc" id="L11885">                entity.heatBuildup += entity.getRunHeat();</span>
<span class="nc bnc" id="L11886" title="All 2 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L11887">                entity.heatBuildup += entity.getJumpHeat(entity.delta_distance);</span>
<span class="nc bnc" id="L11888" title="All 4 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_SPRINT</span>
                    || entity.moved == EntityMovementType.MOVE_VTOL_SPRINT) {
<span class="nc" id="L11890">                entity.heatBuildup += entity.getSprintHeat();</span>
            }
<span class="nc" id="L11892">        }</span>
<span class="nc" id="L11893">    }</span>

    /**
     * Set the LocationsExposure of an entity
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; who's exposure is being set
     * @param hex
     *            The &lt;code&gt;IHex&lt;/code&gt; the entity is in
     * @param isJump
     *            a &lt;code&gt;boolean&lt;/code&gt; value whether the entity is jumping
     * @param elevation
     *            the elevation the entity should be at.
     */
    public Vector&lt;Report&gt; doSetLocationsExposure(Entity entity, IHex hex,
            boolean isJump, int elevation) {
<span class="nc" id="L11909">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L11910" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L11911">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L11913" title="All 6 branches missed.">        if ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !isJump</span>
            &amp;&amp; (elevation &lt; 0)) {
<span class="nc" id="L11915">            int partialWaterLevel = 1;</span>
<span class="nc bnc" id="L11916" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; entity.isSuperHeavy()) {</span>
<span class="nc" id="L11917">                partialWaterLevel = 2;</span>
            }
<span class="nc bnc" id="L11919" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; !entity.isProne()</span>
<span class="nc bnc" id="L11920" title="All 2 branches missed.">                &amp;&amp; (hex.terrainLevel(Terrains.WATER) &lt;= partialWaterLevel)) {</span>
<span class="nc bnc" id="L11921" title="All 2 branches missed.">                for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc bnc" id="L11922" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().isVacuum()</span>
<span class="nc bnc" id="L11923" title="All 4 branches missed.">                            || ((entity.getEntityType() &amp; Entity.ETYPE_AERO) == 0 &amp;&amp; entity.isSpaceborne())) {</span>
<span class="nc" id="L11924">                        entity.setLocationStatus(loop, ILocationExposureStatus.VACUUM);</span>
                    } else {
<span class="nc" id="L11926">                        entity.setLocationStatus(loop, ILocationExposureStatus.NORMAL);</span>
                    }
                }
<span class="nc" id="L11929">                entity.setLocationStatus(Mech.LOC_RLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11930">                entity.setLocationStatus(Mech.LOC_LLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11931">                vPhaseReport.addAll(breachCheck(entity, Mech.LOC_RLEG, hex));</span>
<span class="nc" id="L11932">                vPhaseReport.addAll(breachCheck(entity, Mech.LOC_LLEG, hex));</span>
<span class="nc bnc" id="L11933" title="All 2 branches missed.">                if (entity instanceof QuadMech) {</span>
<span class="nc" id="L11934">                    entity.setLocationStatus(Mech.LOC_RARM, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11935">                    entity.setLocationStatus(Mech.LOC_LARM, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11936">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_RARM, hex));</span>
<span class="nc" id="L11937">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_LARM, hex));</span>
                }
<span class="nc bnc" id="L11939" title="All 2 branches missed.">                if (entity instanceof TripodMech) {</span>
<span class="nc" id="L11940">                    entity.setLocationStatus(Mech.LOC_CLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11941">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_CLEG, hex));</span>
                }
            } else {
<span class="nc bnc" id="L11944" title="All 2 branches missed.">                for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc" id="L11945">                    entity.setLocationStatus(loop, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11946">                    vPhaseReport.addAll(breachCheck(entity, loop, hex));</span>
                }
            }
<span class="nc" id="L11949">        } else {</span>
<span class="nc bnc" id="L11950" title="All 2 branches missed.">            for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc bnc" id="L11951" title="All 2 branches missed.">                if (game.getPlanetaryConditions().isVacuum()</span>
<span class="nc bnc" id="L11952" title="All 4 branches missed.">                        || ((entity.getEntityType() &amp; Entity.ETYPE_AERO) == 0 &amp;&amp; entity.isSpaceborne())) {</span>
<span class="nc" id="L11953">                    entity.setLocationStatus(loop, ILocationExposureStatus.VACUUM);</span>
                } else {
<span class="nc" id="L11955">                    entity.setLocationStatus(loop, ILocationExposureStatus.NORMAL);</span>
                }
            }
        }
<span class="nc" id="L11959">        return vPhaseReport;</span>
    }

    /**
     * Do a roll to avoid pilot damage from g-forces
     *
     * @param entity       The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param targetNumber The &lt;code&gt;int&lt;/code&gt; to be used for this PSR.
     */
    private void resistGForce(Entity entity, int targetNumber) {
        // okay, print the info
<span class="nc" id="L11970">        Report r = new Report(9330);</span>
<span class="nc" id="L11971">        r.subject = entity.getId();</span>
<span class="nc" id="L11972">        r.addDesc(entity);</span>
<span class="nc" id="L11973">        addReport(r);</span>

        // roll
<span class="nc" id="L11976">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L11977">        r = new Report(9335);</span>
<span class="nc" id="L11978">        r.subject = entity.getId();</span>
<span class="nc" id="L11979">        r.add(Integer.toString(targetNumber));</span>
<span class="nc" id="L11980">        r.add(diceRoll);</span>
<span class="nc bnc" id="L11981" title="All 2 branches missed.">        if (diceRoll &lt; targetNumber) {</span>
<span class="nc" id="L11982">            r.choose(false);</span>
<span class="nc" id="L11983">            addReport(r);</span>
<span class="nc" id="L11984">            addReport(damageCrew(entity, 1));</span>
        } else {
<span class="nc" id="L11986">            r.choose(true);</span>
<span class="nc" id="L11987">            addReport(r);</span>
        }
<span class="nc" id="L11989">    }</span>

    /**
     * Do a piloting skill check in space to avoid structural damage
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckInSpace(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L11999" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12000">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12004">        Report r = new Report(9320);</span>
<span class="nc" id="L12005">        r.subject = entity.getId();</span>
<span class="nc" id="L12006">        r.addDesc(entity);</span>
<span class="nc" id="L12007">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12008">        addReport(r);</span>

        // roll
<span class="nc" id="L12011">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12012">        r = new Report(9325);</span>
<span class="nc" id="L12013">        r.subject = entity.getId();</span>
<span class="nc" id="L12014">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12015">        r.add(roll.getDesc());</span>
<span class="nc" id="L12016">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12018" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12019">            r.choose(false);</span>
<span class="nc" id="L12020">            addReport(r);</span>
<span class="nc" id="L12021">            suc = false;</span>
        } else {
<span class="nc" id="L12023">            r.choose(true);</span>
<span class="nc" id="L12024">            addReport(r);</span>
<span class="nc" id="L12025">            suc = true;</span>
        }

<span class="nc" id="L12028">        return suc;</span>
    }

    /**
     * Do a piloting skill check to take off vertically
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doVerticalTakeOffCheck(Entity entity, PilotingRollData roll) {

<span class="nc bnc" id="L12040" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L12041">            return false;</span>
        }

<span class="nc" id="L12044">        IAero a = (IAero) entity;</span>

<span class="nc bnc" id="L12046" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12047">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12051">        Report r = new Report(9320);</span>
<span class="nc" id="L12052">        r.subject = entity.getId();</span>
<span class="nc" id="L12053">        r.addDesc(entity);</span>
<span class="nc" id="L12054">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12055">        addReport(r);</span>

        // roll
<span class="nc" id="L12058">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12059">        r = new Report(9321);</span>
<span class="nc" id="L12060">        r.subject = entity.getId();</span>
<span class="nc" id="L12061">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12062">        r.add(roll.getDesc());</span>
<span class="nc" id="L12063">        r.add(diceRoll);</span>
<span class="nc" id="L12064">        r.newlines = 0;</span>
<span class="nc" id="L12065">        addReport(r);</span>
<span class="nc" id="L12066">        boolean suc = false;</span>
<span class="nc bnc" id="L12067" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12068">            int mof = roll.getValue() - diceRoll;</span>
<span class="nc bnc" id="L12069" title="All 2 branches missed.">            if (mof &lt; 3) {</span>
<span class="nc" id="L12070">                r = new Report(9322);</span>
<span class="nc" id="L12071">                r.subject = entity.getId();</span>
<span class="nc" id="L12072">                addReport(r);</span>
<span class="nc" id="L12073">                suc = true;</span>
<span class="nc bnc" id="L12074" title="All 2 branches missed.">            } else if (mof &lt; 5) {</span>
<span class="nc" id="L12075">                PilotingRollData newRoll = entity.getBasePilotingRoll();</span>
<span class="nc bnc" id="L12076" title="All 2 branches missed.">                if (Compute.d6(2) &gt;= newRoll.getValue()) {</span>
<span class="nc" id="L12077">                    r = new Report(9322);</span>
<span class="nc" id="L12078">                    r.subject = entity.getId();</span>
<span class="nc" id="L12079">                    addReport(r);</span>
<span class="nc" id="L12080">                    suc = true;</span>
                } else {
<span class="nc" id="L12082">                    r = new Report(9323);</span>
<span class="nc" id="L12083">                    r.subject = entity.getId();</span>
<span class="nc" id="L12084">                    addReport(r);</span>
<span class="nc" id="L12085">                    int damage = 20;</span>
<span class="nc bnc" id="L12086" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L12087">                        addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12088">                                ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12089">                        damage -= 5;</span>
                    }
                }
<span class="nc bnc" id="L12092" title="All 2 branches missed.">            } else if (mof &lt; 6) {</span>
<span class="nc" id="L12093">                r = new Report(9323);</span>
<span class="nc" id="L12094">                r.subject = entity.getId();</span>
<span class="nc" id="L12095">                addReport(r);</span>
<span class="nc" id="L12096">                int damage = 50;</span>
<span class="nc bnc" id="L12097" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L12098">                    addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12099">                            ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12100">                    damage -= 5;</span>
                }
<span class="nc" id="L12102">            } else {</span>
<span class="nc" id="L12103">                r = new Report(9323);</span>
<span class="nc" id="L12104">                r.subject = entity.getId();</span>
<span class="nc" id="L12105">                addReport(r);</span>
<span class="nc" id="L12106">                int damage = 100;</span>
<span class="nc bnc" id="L12107" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L12108">                    addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12109">                            ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12110">                    damage -= 5;</span>
                }
            }
<span class="nc" id="L12113">            a.setGearHit(true);</span>
<span class="nc" id="L12114">            r = new Report(9125);</span>
<span class="nc" id="L12115">            r.subject = entity.getId();</span>
<span class="nc" id="L12116">            addReport(r);</span>
<span class="nc" id="L12117">        } else {</span>
<span class="nc" id="L12118">            r = new Report(9322);</span>
<span class="nc" id="L12119">            r.subject = entity.getId();</span>
<span class="nc" id="L12120">            addReport(r);</span>
<span class="nc" id="L12121">            suc = true;</span>
        }

<span class="nc" id="L12124">        return suc;</span>
    }

    /**
     * Do a piloting skill check in space to do a successful maneuver Failure
     * means moving forward half velocity
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckManeuver(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12136" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12137">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12141">        Report r = new Report(9600);</span>
<span class="nc" id="L12142">        r.subject = entity.getId();</span>
<span class="nc" id="L12143">        r.addDesc(entity);</span>
<span class="nc" id="L12144">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12145">        addReport(r);</span>

        // roll
<span class="nc" id="L12148">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12149">        r = new Report(9601);</span>
<span class="nc" id="L12150">        r.subject = entity.getId();</span>
<span class="nc" id="L12151">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12152">        r.add(roll.getDesc());</span>
<span class="nc" id="L12153">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12155" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12156">            r.choose(false);</span>
<span class="nc" id="L12157">            addReport(r);</span>
<span class="nc" id="L12158">            suc = false;</span>
        } else {
<span class="nc" id="L12160">            r.choose(true);</span>
<span class="nc" id="L12161">            addReport(r);</span>
<span class="nc" id="L12162">            suc = true;</span>
        }

<span class="nc" id="L12165">        return suc;</span>
    }

    /**
     * Do a piloting skill check while standing still (during the movement
     * phase).
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckInPlace(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12177" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12178">            return true;</span>
        }

<span class="nc bnc" id="L12181" title="All 2 branches missed.">        if (entity.isProne()) {</span>
<span class="nc" id="L12182">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12186">        Report r = new Report(2180);</span>
<span class="nc" id="L12187">        r.subject = entity.getId();</span>
<span class="nc" id="L12188">        r.addDesc(entity);</span>
<span class="nc" id="L12189">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12190">        addReport(r);</span>

        // roll
<span class="nc" id="L12193">        final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L12194">        r = new Report(2185);</span>
<span class="nc" id="L12195">        r.subject = entity.getId();</span>
<span class="nc" id="L12196">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12197">        r.add(roll.getDesc());</span>
<span class="nc" id="L12198">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12200" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12201">            r.choose(false);</span>
<span class="nc" id="L12202">            addReport(r);</span>
<span class="nc bnc" id="L12203" title="All 2 branches missed.">            if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L12204" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L12206" title="All 2 branches missed.">                &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L12207" title="All 4 branches missed.">                &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L12208" title="All 4 branches missed.">                if ((entity.getCrew().getPiloting() &gt; 1) &amp;&amp; ((roll.getValue() - diceRoll) &lt; 2)) {</span>
<span class="nc" id="L12209">                    entity.setHullDown(true);</span>
<span class="nc bnc" id="L12210" title="All 2 branches missed.">                } else if ((entity.getCrew().getPiloting() &lt;= 1)</span>
<span class="nc bnc" id="L12211" title="All 2 branches missed.">                        &amp;&amp; ((roll.getValue() - diceRoll) &lt; 3)) {</span>
<span class="nc" id="L12212">                    entity.setHullDown(true);</span>
                }
            }
<span class="nc bnc" id="L12215" title="All 2 branches missed.">            if (!entity.isHullDown()</span>
<span class="nc bnc" id="L12216" title="All 4 branches missed.">                || (entity.isHullDown() &amp;&amp; !entity.canGoHullDown())) {</span>
<span class="nc" id="L12217">                addReport(doEntityFall(entity, roll));</span>
            } else {
<span class="nc" id="L12219">                ServerHelper.sinkToBottom(entity);</span>
                
<span class="nc" id="L12221">                r = new Report(2317);</span>
<span class="nc" id="L12222">                r.subject = entity.getId();</span>
<span class="nc" id="L12223">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L12224">                addReport(r);</span>
            }

<span class="nc" id="L12227">            suc = false;</span>
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12229">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
        } else {
<span class="nc" id="L12231">            r.choose(true);</span>
<span class="nc" id="L12232">            addReport(r);</span>
<span class="nc" id="L12233">            suc = true;</span>
        }

<span class="nc" id="L12236">        return suc;</span>
    }

    /**
     * Do a Piloting Skill check to dislodge swarming infantry.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is doing the dislodging.
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; for this PSR.
     * @param curPos The &lt;code&gt;Coords&lt;/code&gt; the entity is at.
     * @return &lt;code&gt;true&lt;/code&gt; if the dislodging is successful.
     */
    private boolean doDislodgeSwarmerSkillCheck(Entity entity, PilotingRollData roll, Coords curPos) {
        // okay, print the info
<span class="nc" id="L12249">        Report r = new Report(2180);</span>
<span class="nc" id="L12250">        r.subject = entity.getId();</span>
<span class="nc" id="L12251">        r.addDesc(entity);</span>
<span class="nc" id="L12252">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12253">        addReport(r);</span>

        // roll
<span class="nc" id="L12256">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12257">        r = new Report(2190);</span>
<span class="nc" id="L12258">        r.subject = entity.getId();</span>
<span class="nc" id="L12259">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12260">        r.add(roll.getDesc());</span>
<span class="nc" id="L12261">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12262" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12263">            r.choose(false);</span>
<span class="nc" id="L12264">            addReport(r);</span>
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12266">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L12267">            return false;</span>
        }
        // Dislodged swarmers don't get turns.
<span class="nc" id="L12270">        int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc" id="L12271">        final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc bnc" id="L12272" title="All 2 branches missed.">        if (!swarmer.isDone()) {</span>
<span class="nc" id="L12273">            game.removeTurnFor(swarmer);</span>
<span class="nc" id="L12274">            swarmer.setDone(true);</span>
<span class="nc" id="L12275">            send(createTurnVectorPacket());</span>
        }

        // Update the report and cause a fall.
<span class="nc" id="L12279">        r.choose(true);</span>
<span class="nc" id="L12280">        addReport(r);</span>
<span class="nc" id="L12281">        entity.setPosition(curPos);</span>
<span class="nc" id="L12282">        addReport(doEntityFallsInto(entity, curPos, roll, false));</span>
<span class="nc" id="L12283">        return true;</span>
    }

    /**
     * Do a piloting skill check while moving.
     *
     * @param entity          - the &lt;code&gt;Entity&lt;/code&gt; that must roll.
     * @param entityElevation The elevation of the supplied Entity above the surface of the
     *                        src hex. This is necessary as the state of the Entity may
     *                        represent the elevation of the entity about the surface of the
     *                        destination hex.
     * @param src             - the &lt;code&gt;Coords&lt;/code&gt; the entity is moving from.
     * @param dest            - the &lt;code&gt;Coords&lt;/code&gt; the entity is moving to. This value
     *                        can be the same as src for in-place checks.
     * @param roll            - the &lt;code&gt;PilotingRollData&lt;/code&gt; that is causing this
     *                        check.
     * @param isFallRoll      - a &lt;code&gt;boolean&lt;/code&gt; flag that indicates that failure will
     *                        result in a fall or not. Falls will be processed.
     * @return Margin of Failure if the pilot fails the skill check, 0 if they
     * pass.
     */
    private int doSkillCheckWhileMoving(Entity entity, int entityElevation,
            Coords src, Coords dest, PilotingRollData roll, boolean isFallRoll) {
        boolean fallsInPlace;

        // Start the info for this roll.
<span class="nc" id="L12309">        Report r = new Report(1210);</span>
<span class="nc" id="L12310">        r.subject = entity.getId();</span>
<span class="nc" id="L12311">        r.addDesc(entity);</span>

        // Will the entity fall in the source or destination hex?
<span class="nc bnc" id="L12314" title="All 2 branches missed.">        if (src.equals(dest)) {</span>
<span class="nc" id="L12315">            fallsInPlace = true;</span>
<span class="nc" id="L12316">            r.messageId = 2195;</span>
<span class="nc" id="L12317">            r.add(src.getBoardNum(), true);</span>
        } else {
<span class="nc" id="L12319">            fallsInPlace = false;</span>
<span class="nc" id="L12320">            r.messageId = 2200;</span>
<span class="nc" id="L12321">            r.add(src.getBoardNum(), true);</span>
<span class="nc" id="L12322">            r.add(dest.getBoardNum(), true);</span>
        }

        // Finish the info.
<span class="nc" id="L12326">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12327">        addReport(r);</span>

        // roll
<span class="nc" id="L12330">        final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L12331">        r = new Report(2185);</span>
<span class="nc" id="L12332">        r.subject = entity.getId();</span>
<span class="nc" id="L12333">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12334">        r.add(roll.getDesc());</span>
<span class="nc" id="L12335">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12336" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
            // Does failing the PSR result in a fall.
<span class="nc bnc" id="L12338" title="All 4 branches missed.">            if (isFallRoll &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L12339">                r.choose(false);</span>
<span class="nc" id="L12340">                addReport(r);</span>
<span class="nc" id="L12341">                addReport(doEntityFallsInto(entity, entityElevation,</span>
<span class="nc bnc" id="L12342" title="All 4 branches missed.">                                            fallsInPlace ? dest : src, fallsInPlace ? src : dest,</span>
                                            roll, true));
            } else {
<span class="nc" id="L12345">                r.messageId = 2190;</span>
<span class="nc" id="L12346">                r.choose(false);</span>
<span class="nc" id="L12347">                addReport(r);</span>
<span class="nc bnc" id="L12348" title="All 2 branches missed.">                entity.setPosition(fallsInPlace ? src : dest);</span>
            }
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12351">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L12352">            return roll.getValue() - diceRoll;</span>
        }
<span class="nc" id="L12354">        r.choose(true);</span>
<span class="nc" id="L12355">        r.newlines = 2;</span>
<span class="nc" id="L12356">        addReport(r);</span>
<span class="nc" id="L12357">        return 0;</span>
    }

    /**
     * Process a fall when the source and destination hexes are the same.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller. Note: the elevation of the entity is used to
     * determine fall distance, so it is important to ensure the Entity's
     * elevation is correct.
     *
     * @param entity    The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param src       The &lt;code&gt;Coords&lt;/code&gt; of the source hex.
     * @param roll      The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                  by the falling.
     * @param causeAffa The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                  to cause an accidental fall from above
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity, Coords src,
                                             PilotingRollData roll, boolean causeAffa) {
<span class="nc" id="L12377">        return doEntityFallsInto(entity, entity.getElevation(), src, src, roll,</span>
                                 causeAffa);
    }

    /**
     * Process a fall when moving from the source hex to the destination hex.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller. Note: the elevation of the entity is used to
     * determine fall distance, so it is important to ensure the Entity's
     * elevation is correct.
     *
     * @param entity             The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param entitySrcElevation The elevation of the supplied Entity above the surface of the
     *                           src hex. This is necessary as the state of the Entity may
     *                           represent the elevation of the entity about the surface of the
     *                           destination hex.
     * @param src                The &lt;code&gt;Coords&lt;/code&gt; of the source hex.
     * @param dest               The &lt;code&gt;Coords&lt;/code&gt; of the destination hex.
     * @param roll               The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                           by the falling.
     * @param causeAffa          The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                           to cause an accidental fall from above
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity,
                                             int entitySrcElevation, Coords src, Coords dest,
                                             PilotingRollData roll, boolean causeAffa) {
<span class="nc" id="L12404">        return doEntityFallsInto(entity, entitySrcElevation, src, dest, roll,</span>
                                 causeAffa, 0);
    }

    /**
     * Process a fall when moving from the source hex to the destination hex.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller.
     *
     * @param entity             The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param entitySrcElevation The elevation of the supplied Entity above the surface of the
     *                           src hex. This is necessary as the state of the Entity may
     *                           represent the elevation of the entity about the surface of the
     *                           destination hex.
     * @param origSrc            The &lt;code&gt;Coords&lt;/code&gt; of the original source hex.
     * @param origDest           The &lt;code&gt;Coords&lt;/code&gt; of the original destination hex.
     * @param roll               The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                           by the falling.
     * @param causeAffa          The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                           to cause an accidental fall from above
     * @param fallReduction      An integer value to reduce the fall distance by
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity,
                                             int entitySrcElevation, Coords origSrc, Coords origDest,
                                             PilotingRollData roll, boolean causeAffa, int fallReduction) {
<span class="nc" id="L12430">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L12431">        IHex srcHex = game.getBoard().getHex(origSrc);</span>
<span class="nc" id="L12432">        IHex destHex = game.getBoard().getHex(origDest);</span>
        Coords src, dest;
        // We need to fall into the lower of the two hexes, TW pg 68
<span class="nc bnc" id="L12435" title="All 2 branches missed.">        if (srcHex.getLevel() &lt; destHex.getLevel()) {</span>
<span class="nc" id="L12436">            IHex swapHex = destHex;</span>
<span class="nc" id="L12437">            destHex = srcHex;</span>
<span class="nc" id="L12438">            srcHex = swapHex;</span>
<span class="nc" id="L12439">            src = origDest;</span>
<span class="nc" id="L12440">            dest = origSrc;</span>
<span class="nc" id="L12441">        } else {</span>
<span class="nc" id="L12442">            src = origSrc;</span>
<span class="nc" id="L12443">            dest = origDest;</span>
        }
<span class="nc" id="L12445">        final int srcHeightAboveFloor = entitySrcElevation + srcHex.depth(false);</span>
<span class="nc" id="L12446">        int fallElevation = Math.abs((srcHex.floor() + srcHeightAboveFloor)</span>
<span class="nc bnc" id="L12447" title="All 2 branches missed.">                - (destHex.containsTerrain(Terrains.ICE) ? destHex.surface() : destHex.floor()))</span>
                - fallReduction;
<span class="nc bnc" id="L12449" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L12450">            fallElevation -= destHex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc bnc" id="L12452" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_BASEMENT_TYPE)) {</span>
<span class="nc bnc" id="L12453" title="All 2 branches missed.">            if (entity.getElevation() == 0) { // floor 0 falling into basement</span>
<span class="nc" id="L12454">                fallElevation = destHex.depth(true);</span>
            }
        }

        int direction;
<span class="nc bnc" id="L12459" title="All 2 branches missed.">        if (src.equals(dest)) {</span>
<span class="nc" id="L12460">            direction = Compute.d6() - 1;</span>
        } else {
<span class="nc" id="L12462">            direction = src.direction(dest);</span>
        }
        Report r;
        // check entity in target hex
<span class="nc" id="L12466">        Entity affaTarget = game.getAffaTarget(dest, entity);</span>
        // falling mech falls
<span class="nc" id="L12468">        r = new Report(2205);</span>
<span class="nc" id="L12469">        r.subject = entity.getId();</span>
<span class="nc" id="L12470">        r.addDesc(entity);</span>
<span class="nc" id="L12471">        r.add(fallElevation);</span>
<span class="nc" id="L12472">        r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L12473">        r.newlines = 0;</span>

        // if hex was empty, deal damage and we're done
<span class="nc bnc" id="L12476" title="All 2 branches missed.">        if (affaTarget == null) {</span>
<span class="nc" id="L12477">            r.newlines = 1;</span>
<span class="nc" id="L12478">            vPhaseReport.add(r);</span>
            // If we rolled for the direction, we want to use that for the fall
<span class="nc bnc" id="L12480" title="All 2 branches missed.">            if (src.equals(dest)) {</span>
<span class="nc" id="L12481">                vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation,</span>
<span class="nc" id="L12482">                                                 direction, roll, false, srcHex.hasCliffTopTowards(destHex)));</span>
            } else {
                // Otherwise, we'll roll for the direction after the fall
<span class="nc" id="L12485">                vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation, roll));</span>
            }

<span class="nc" id="L12488">            return vPhaseReport;</span>
        }
<span class="nc" id="L12490">        vPhaseReport.add(r);</span>

        // hmmm... somebody there... problems.
<span class="nc bnc" id="L12493" title="All 4 branches missed.">        if ((fallElevation &gt;= 2) &amp;&amp; causeAffa) {</span>
            // accidental fall from above: havoc!
<span class="nc" id="L12495">            r = new Report(2210);</span>
<span class="nc" id="L12496">            r.subject = entity.getId();</span>
<span class="nc" id="L12497">            r.addDesc(affaTarget);</span>
<span class="nc" id="L12498">            vPhaseReport.add(r);</span>

            // determine to-hit number
<span class="nc" id="L12501">            ToHitData toHit = new ToHitData(7, &quot;base&quot;);</span>
<span class="nc bnc" id="L12502" title="All 4 branches missed.">            if ((affaTarget instanceof Tank) || (affaTarget instanceof Dropship)) {</span>
<span class="nc" id="L12503">                toHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, &quot;Target is a Tank&quot;);</span>
            } else {
<span class="nc" id="L12505">                toHit.append(Compute.getTargetMovementModifier(game, affaTarget.getId()));</span>
<span class="nc" id="L12506">                toHit.append(Compute.getTargetTerrainModifier(game, affaTarget));</span>
            }

<span class="nc bnc" id="L12509" title="All 2 branches missed.">            if (toHit.getValue() != TargetRoll.AUTOMATIC_FAIL) {</span>
                // collision roll
<span class="nc" id="L12511">                final int diceRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L12512" title="All 2 branches missed.">                if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12513">                    r = new Report(2212);</span>
<span class="nc" id="L12514">                    r.add(toHit.getValue());</span>
                } else {
<span class="nc" id="L12516">                    r = new Report(2215);</span>
<span class="nc" id="L12517">                    r.subject = entity.getId();</span>
<span class="nc" id="L12518">                    r.add(toHit.getValue());</span>
<span class="nc" id="L12519">                    r.add(diceRoll);</span>
<span class="nc" id="L12520">                    r.newlines = 0;</span>
                }
<span class="nc" id="L12522">                r.indent();</span>
<span class="nc" id="L12523">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12524" title="All 2 branches missed.">                if (diceRoll &gt;= toHit.getValue()) {</span>
                    // deal damage to target
<span class="nc" id="L12526">                    int damage = Compute.getAffaDamageFor(entity);</span>
<span class="nc" id="L12527">                    r = new Report(2220);</span>
<span class="nc" id="L12528">                    r.subject = affaTarget.getId();</span>
<span class="nc" id="L12529">                    r.addDesc(affaTarget);</span>
<span class="nc" id="L12530">                    r.add(damage);</span>
<span class="nc" id="L12531">                    vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12532" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L12533">                        int cluster = Math.min(5, damage);</span>
<span class="nc" id="L12534">                        HitData hit = affaTarget.rollHitLocation(ToHitData.HIT_PUNCH, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L12535">                        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L12536">                        vPhaseReport.addAll(damageEntity(affaTarget, hit, cluster));</span>
<span class="nc" id="L12537">                        damage -= cluster;</span>
<span class="nc" id="L12538">                    }</span>

                    // attacker falls as normal, on his back
                    // only given a modifier, so flesh out into a full piloting
                    // roll
<span class="nc" id="L12543">                    PilotingRollData pilotRoll = entity.getBasePilotingRoll();</span>
<span class="nc" id="L12544">                    pilotRoll.append(roll);</span>
<span class="nc" id="L12545">                    vPhaseReport.addAll(doEntityFall(entity, dest,</span>
                            fallElevation, 3, pilotRoll, false, false));
<span class="nc" id="L12547">                    vPhaseReport.addAll(doEntityDisplacementMinefieldCheck(</span>
<span class="nc" id="L12548">                            entity, src, dest, entity.getElevation()));</span>

                    // defender pushed away, or destroyed, if there is a
                    // stacking violation
<span class="nc" id="L12552">                    Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12553" title="All 2 branches missed.">                    if (violation != null) {</span>
<span class="nc" id="L12554">                        PilotingRollData prd = new PilotingRollData(violation.getId(), 2,</span>
                                &quot;fallen on&quot;);
<span class="nc bnc" id="L12556" title="All 2 branches missed.">                        if (violation instanceof Dropship) {</span>
<span class="nc" id="L12557">                            violation = entity;</span>
<span class="nc" id="L12558">                            prd = null;</span>
                        }
<span class="nc" id="L12560">                        Coords targetDest = Compute.getValidDisplacement(game, violation.getId(),</span>
                                dest, direction);
<span class="nc bnc" id="L12562" title="All 2 branches missed.">                        if (targetDest != null) {</span>
<span class="nc" id="L12563">                            vPhaseReport.addAll(doEntityDisplacement(violation, dest, targetDest, prd));</span>
                            // Update the violating entity's position on the
                            // client.
<span class="nc" id="L12566">                            entityUpdate(violation.getId());</span>
                        } else {
                            // ack! automatic death! Tanks
                            // suffer an ammo/power plant hit.
                            // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L12571">                            vPhaseReport.addAll(destroyEntity(violation, &quot;impossible displacement&quot;,</span>
                                    violation instanceof Mech, violation instanceof Mech));
                        }
                    }
<span class="nc" id="L12575">                    return vPhaseReport;</span>
                }
<span class="nc" id="L12577">            } else {</span>
                // automatic miss
<span class="nc" id="L12579">                r = new Report(2213);</span>
<span class="nc" id="L12580">                r.add(toHit.getDesc());</span>
<span class="nc" id="L12581">                vPhaseReport.add(r);</span>
            }
            // ok, we missed, let's fall into a valid other hex and not cause an
            // AFFA while doing so
<span class="nc" id="L12585">            Coords targetDest = Compute.getValidDisplacement(game, entity.getId(), dest, direction);</span>
<span class="nc bnc" id="L12586" title="All 2 branches missed.">            if (targetDest != null) {</span>
<span class="nc" id="L12587">                vPhaseReport.addAll(doEntityFallsInto(entity, entitySrcElevation, src, targetDest,</span>
<span class="nc" id="L12588">                        new PilotingRollData(entity.getId(),</span>
                                TargetRoll.IMPOSSIBLE,
                                &quot;pushed off a cliff&quot;),
                        false));
                // Update the entity's position on the client.
<span class="nc" id="L12593">                entityUpdate(entity.getId());</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L12598">                vPhaseReport.addAll(destroyEntity(entity,</span>
                        &quot;impossible displacement&quot;, entity instanceof Mech, entity instanceof Mech));
            }
<span class="nc" id="L12601">        } else {</span>
            // damage as normal
<span class="nc" id="L12603">            vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation, roll));</span>
<span class="nc" id="L12604">            Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12605" title="All 2 branches missed.">            if (violation != null) {</span>
<span class="nc" id="L12606">                PilotingRollData prd = new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;);</span>
<span class="nc bnc" id="L12607" title="All 2 branches missed.">                if (violation instanceof Dropship) {</span>
<span class="nc" id="L12608">                    violation = entity;</span>
<span class="nc" id="L12609">                    prd = null;</span>
                }
                // target gets displaced, because of low elevation
<span class="nc" id="L12612">                Coords targetDest = Compute.getValidDisplacement(game, violation.getId(), dest, direction);</span>
<span class="nc" id="L12613">                vPhaseReport.addAll(doEntityDisplacement(violation, dest, targetDest, prd));</span>
                // Update the violating entity's position on the client.
<span class="nc bnc" id="L12615" title="All 2 branches missed.">                if (!game.getOutOfGameEntitiesVector().contains(violation)) {</span>
<span class="nc" id="L12616">                    entityUpdate(violation.getId());</span>
                }
            }
        }
<span class="nc" id="L12620">        return vPhaseReport;</span>
    }

    /**
     * Displace a unit in the direction specified. The unit moves in that
     * direction, and the piloting skill roll is used to determine if it falls.
     * The roll may be unnecessary as certain situations indicate an automatic
     * fall. Rolls are added to the piloting roll list.
     */
    private Vector&lt;Report&gt; doEntityDisplacement(Entity entity, Coords src,
            Coords dest, PilotingRollData roll) {
<span class="nc" id="L12631">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L12633" title="All 2 branches missed.">        if (!game.getBoard().contains(dest)) {</span>
            // set position anyway, for pushes moving through, stuff like that
<span class="nc" id="L12635">            entity.setPosition(dest);</span>
<span class="nc bnc" id="L12636" title="All 2 branches missed.">            if (!entity.isDoomed()) {</span>
                // Make sure there aren't any specific entity turns for entity
<span class="nc" id="L12638">                int turnsRemoved = game.removeSpecificEntityTurnsFor(entity);</span>
                // May need to remove a turn for this Entity
<span class="nc bnc" id="L12640" title="All 2 branches missed.">                if ((game.getPhase() == Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L12641" title="All 4 branches missed.">                        &amp;&amp; !entity.isDone() &amp;&amp; (turnsRemoved == 0)) {</span>
<span class="nc" id="L12642">                    game.removeTurnFor(entity);</span>
<span class="nc" id="L12643">                    send(createTurnVectorPacket());</span>
<span class="nc bnc" id="L12644" title="All 2 branches missed.">                } else if (turnsRemoved &gt; 0) {</span>
<span class="nc" id="L12645">                    send(createTurnVectorPacket());</span>
                }
<span class="nc" id="L12647">                game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L12648">                send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
                // entity forced from the field
<span class="nc" id="L12650">                r = new Report(2230);</span>
<span class="nc" id="L12651">                r.subject = entity.getId();</span>
<span class="nc" id="L12652">                r.addDesc(entity);</span>
<span class="nc" id="L12653">                vPhaseReport.add(r);</span>
                // TODO : remove passengers and swarmers.
            }
<span class="nc" id="L12656">            return vPhaseReport;</span>
        }
<span class="nc" id="L12658">        final IHex srcHex = game.getBoard().getHex(src);</span>
<span class="nc" id="L12659">        final IHex destHex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L12660">        final int direction = src.direction(dest);</span>

        // Handle null hexes.
<span class="nc bnc" id="L12663" title="All 4 branches missed.">        if ((srcHex == null) || (destHex == null)) {</span>
<span class="nc" id="L12664">            MegaMek.getLogger().error(&quot;Can not displace &quot; + entity.getShortName()</span>
                    + &quot; from &quot; + src + &quot; to &quot; + dest + &quot;.&quot;);
<span class="nc" id="L12666">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L12668" title="All 2 branches missed.">        int bldgElev = destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L12669">            ? destHex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L12670">        int fallElevation = srcHex.surface() + entity.getElevation()</span>
<span class="nc" id="L12671">                - (destHex.surface() + bldgElev);</span>
<span class="nc bnc" id="L12672" title="All 2 branches missed.">        if (fallElevation &gt; 1) {</span>
<span class="nc bnc" id="L12673" title="All 2 branches missed.">            if (roll == null) {</span>
<span class="nc" id="L12674">                roll = entity.getBasePilotingRoll();</span>
            }
<span class="nc bnc" id="L12676" title="All 2 branches missed.">            if (!(entity.isAirborneVTOLorWIGE())) {</span>
<span class="nc" id="L12677">                vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                        roll, true));
            } else {
<span class="nc" id="L12680">                entity.setPosition(dest);</span>
            }
<span class="nc" id="L12682">            return vPhaseReport;</span>
        }
        // unstick the entity if it was stuck in swamp
<span class="nc" id="L12685">        boolean wasStuck = entity.isStuck();</span>
<span class="nc" id="L12686">        entity.setStuck(false);</span>
<span class="nc" id="L12687">        int oldElev = entity.getElevation();</span>
        // move the entity into the new location gently
<span class="nc" id="L12689">        entity.setPosition(dest);</span>
<span class="nc" id="L12690">        entity.setElevation(entity.calcElevation(srcHex, destHex));</span>
<span class="nc" id="L12691">        Building bldg = game.getBoard().getBuildingAt(dest);</span>
<span class="nc bnc" id="L12692" title="All 2 branches missed.">        if (bldg != null) {</span>
<span class="nc bnc" id="L12693" title="All 2 branches missed.">            if (destHex.terrainLevel(Terrains.BLDG_ELEV) &gt; oldElev) {</span>
                // whoops, into the building we go
<span class="nc" id="L12695">                passBuildingWall(entity, game.getBoard().getBuildingAt(dest), src, dest, 1,</span>
                        &quot;displaced into&quot;,
<span class="nc bnc" id="L12697" title="All 2 branches missed.">                        Math.abs(entity.getFacing() - src.direction(dest)) == 3,</span>
                        entity.moved, true);
            }
<span class="nc" id="L12700">            checkBuildingCollapseWhileMoving(bldg, entity, dest);</span>
        }
        
<span class="nc" id="L12703">        ServerHelper.checkAndApplyMagmaCrust(destHex, entity.getElevation(), entity, dest, false, vPhaseReport, this);</span>
        
<span class="nc" id="L12705">        Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12706" title="All 2 branches missed.">        if (violation == null) {</span>
            // move and roll normally
<span class="nc" id="L12708">            r = new Report(2235);</span>
<span class="nc" id="L12709">            r.indent();</span>
<span class="nc" id="L12710">            r.subject = entity.getId();</span>
<span class="nc" id="L12711">            r.addDesc(entity);</span>
<span class="nc" id="L12712">            r.add(dest.getBoardNum(), true);</span>
        } else {
            // domino effect: move &amp; displace target
<span class="nc" id="L12715">            r = new Report(2240);</span>
<span class="nc" id="L12716">            r.indent();</span>
<span class="nc" id="L12717">            r.subject = entity.getId();</span>
<span class="nc" id="L12718">            r.addDesc(entity);</span>
<span class="nc" id="L12719">            r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L12720">            r.addDesc(violation);</span>
        }
<span class="nc" id="L12722">        vPhaseReport.add(r);</span>
        // trigger any special things for moving to the new hex
<span class="nc" id="L12724">        vPhaseReport.addAll(doEntityDisplacementMinefieldCheck(entity, src, dest, entity.getElevation()));</span>
<span class="nc" id="L12725">        vPhaseReport.addAll(doSetLocationsExposure(entity, destHex, false, entity.getElevation()));</span>
<span class="nc bnc" id="L12726" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L12727" title="All 2 branches missed.">            &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L12728">            bldg = game.getBoard().getBuildingAt(dest);</span>
<span class="nc bnc" id="L12729" title="All 2 branches missed.">            if (bldg.rollBasement(dest, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L12730">                sendChangedHex(dest);</span>
<span class="nc" id="L12731">                Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L12732">                buildings.add(bldg);</span>
<span class="nc" id="L12733">                sendChangedBuildings(buildings);</span>
            }
        }

        // mechs that were stuck will automatically fall in their new hex
<span class="nc bnc" id="L12738" title="All 4 branches missed.">        if (wasStuck &amp;&amp; entity.canFall()) {</span>
<span class="nc bnc" id="L12739" title="All 2 branches missed.">            if (roll == null) {</span>
<span class="nc" id="L12740">                roll = entity.getBasePilotingRoll();</span>
            }
<span class="nc" id="L12742">            vPhaseReport.addAll(doEntityFall(entity, dest, 0, roll));</span>
        }
        // check bog-down conditions
<span class="nc" id="L12745">        vPhaseReport.addAll(doEntityDisplacementBogDownCheck(entity, dest, entity.getElevation()));</span>

<span class="nc bnc" id="L12747" title="All 2 branches missed.">        if (roll != null) {</span>
<span class="nc bnc" id="L12748" title="All 2 branches missed.">            if (entity.canFall()) {</span>
<span class="nc" id="L12749">                game.addPSR(roll);</span>
<span class="nc bnc" id="L12750" title="All 4 branches missed.">            } else if ((entity instanceof LandAirMech) &amp;&amp; entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L12751">                game.addControlRoll(roll);</span>
            }
        }

<span class="nc" id="L12755">        int waterDepth = destHex.terrainLevel(Terrains.WATER);</span>

<span class="nc bnc" id="L12757" title="All 4 branches missed.">        if (destHex.containsTerrain(Terrains.ICE) &amp;&amp; destHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L12758" title="All 2 branches missed.">            if (!(entity instanceof Infantry)) {</span>
<span class="nc" id="L12759">                int d6 = Compute.d6(1);</span>
<span class="nc" id="L12760">                r = new Report(2118);</span>
<span class="nc" id="L12761">                r.addDesc(entity);</span>
<span class="nc" id="L12762">                r.add(d6);</span>
<span class="nc" id="L12763">                r.subject = entity.getId();</span>
<span class="nc" id="L12764">                vPhaseReport.add(r);</span>

<span class="nc bnc" id="L12766" title="All 2 branches missed.">                if (d6 == 6) {</span>
<span class="nc" id="L12767">                    vPhaseReport.addAll(resolveIceBroken(dest));</span>
                }
<span class="nc" id="L12769">            }</span>
        }
        // Falling into water instantly destroys most non-mechs
<span class="nc bnc" id="L12772" title="All 6 branches missed.">        else if ((waterDepth &gt; 0)</span>
                &amp;&amp; !(entity instanceof Mech)
                &amp;&amp; !(entity instanceof Protomech)
<span class="nc bnc" id="L12775" title="All 4 branches missed.">                &amp;&amp; !((entity.getRunMP() &gt; 0) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.HOVER))</span>
<span class="nc bnc" id="L12776" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L12777" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L12778" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L12779" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L12780">            vPhaseReport.addAll(destroyEntity(entity, &quot;a watery grave&quot;, false));</span>
<span class="nc bnc" id="L12781" title="All 2 branches missed.">        } else if ((waterDepth &gt; 0)</span>
<span class="nc bnc" id="L12782" title="All 2 branches missed.">                &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L12783">            PilotingRollData waterRoll = entity.checkWaterMove(waterDepth, entity.moved);</span>
<span class="nc bnc" id="L12784" title="All 2 branches missed.">            if (waterRoll.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L12785">                doSkillCheckInPlace(entity, waterRoll);</span>
            }
        }
        // Update the entity's position on the client.
<span class="nc" id="L12789">        entityUpdate(entity.getId());</span>

<span class="nc bnc" id="L12791" title="All 2 branches missed.">        if (violation != null) {</span>
            // Can the violating unit move out of the way?
            // if the direction comes from a side, Entity didn't jump, and it
            // has MP left to use, it can try to move.
<span class="nc" id="L12795">            MovePath stepForward = new MovePath(game, violation);</span>
<span class="nc" id="L12796">            MovePath stepBackwards = new MovePath(game, violation);</span>
<span class="nc" id="L12797">            stepForward.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L12798">            stepBackwards.addStep(MoveStepType.BACKWARDS);</span>
<span class="nc" id="L12799">            stepForward.compile(getGame(), violation, false);</span>
<span class="nc" id="L12800">            stepBackwards.compile(getGame(), violation, false);</span>
<span class="nc bnc" id="L12801" title="All 2 branches missed.">            if ((direction != violation.getFacing())</span>
<span class="nc bnc" id="L12802" title="All 2 branches missed.">                    &amp;&amp; (direction != ((violation.getFacing() + 3) % 6))</span>
<span class="nc bnc" id="L12803" title="All 2 branches missed.">                    &amp;&amp; !entity.getIsJumpingNow()</span>
<span class="nc bnc" id="L12804" title="All 4 branches missed.">                    &amp;&amp; (stepForward.isMoveLegal() || stepBackwards.isMoveLegal())) {</span>
                // First, we need to make a PSR to see if we can step out
<span class="nc" id="L12806">                int result = Compute.d6(2);</span>
<span class="nc" id="L12807">                roll = entity.getBasePilotingRoll();</span>

<span class="nc" id="L12809">                r = new Report(2351);</span>
<span class="nc" id="L12810">                r.indent(2);</span>
<span class="nc" id="L12811">                r.subject = violation.getId();</span>
<span class="nc" id="L12812">                r.addDesc(violation);</span>
<span class="nc" id="L12813">                r.add(roll);</span>
<span class="nc" id="L12814">                r.add(result);</span>
<span class="nc" id="L12815">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12816" title="All 2 branches missed.">                if (result &lt; roll.getValue()) {</span>
<span class="nc" id="L12817">                    r.choose(false);</span>
<span class="nc" id="L12818">                    Vector&lt;Report&gt; newReports = doEntityDisplacement(violation,</span>
<span class="nc" id="L12819">                            dest, dest.translated(direction),</span>
<span class="nc" id="L12820">                            new PilotingRollData(violation.getId(),</span>
                                    TargetRoll.AUTOMATIC_FAIL,
                                    &quot;failed to step out of a domino effect&quot;));
<span class="nc bnc" id="L12823" title="All 2 branches missed.">                    for (Report newReport : newReports) {</span>
<span class="nc" id="L12824">                        newReport.indent(3);</span>
<span class="nc" id="L12825">                    }</span>
<span class="nc" id="L12826">                    vPhaseReport.addAll(newReports);</span>
<span class="nc" id="L12827">                } else {</span>
<span class="nc" id="L12828">                    r.choose(true);</span>
<span class="nc" id="L12829">                    sendDominoEffectCFR(violation);</span>
<span class="nc" id="L12830">                    synchronized (cfrPacketQueue) {</span>
                        try {
<span class="nc" id="L12832">                            cfrPacketQueue.wait();</span>
<span class="nc" id="L12833">                        } catch (InterruptedException ignored) {</span>
                            // Do nothing
<span class="nc" id="L12835">                        }</span>
<span class="nc bnc" id="L12836" title="All 2 branches missed.">                        if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L12837">                            ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L12838">                            int cfrType = (int) rp.packet.getData()[0];</span>
                            // Make sure we got the right type of response
<span class="nc bnc" id="L12840" title="All 2 branches missed.">                            if (cfrType != Packet.COMMAND_CFR_DOMINO_EFFECT) {</span>
<span class="nc" id="L12841">                                MegaMek.getLogger().error(&quot;Excepted a COMMAND_CFR_DOMINO_EFFECT CFR packet, &quot;</span>
                                                + &quot;received: &quot; + cfrType);
<span class="nc" id="L12843">                                throw new IllegalStateException();</span>
                            }
<span class="nc" id="L12845">                            MovePath mp = (MovePath) rp.packet.getData()[1];</span>
                            // Move based on the feedback
<span class="nc bnc" id="L12847" title="All 2 branches missed.">                            if (mp != null) {</span>
<span class="nc" id="L12848">                                mp.setGame(getGame());</span>
<span class="nc" id="L12849">                                mp.setEntity(violation);</span>
                                // Report
<span class="nc" id="L12851">                                r = new Report(2352);</span>
<span class="nc" id="L12852">                                r.indent(3);</span>
<span class="nc" id="L12853">                                r.subject = violation.getId();</span>
<span class="nc" id="L12854">                                r.addDesc(violation);</span>
<span class="nc bnc" id="L12855" title="All 2 branches missed.">                                if (mp.getLastStep().getType() == MoveStepType.FORWARDS) {</span>
<span class="nc" id="L12856">                                    r.choose(false);</span>
                                } else {
<span class="nc" id="L12858">                                    r.choose(true);</span>
                                }
<span class="nc" id="L12860">                                r.add(mp.getLastStep().getPosition().getBoardNum());</span>
<span class="nc" id="L12861">                                vPhaseReport.add(r);</span>
                                // Move unit
<span class="nc" id="L12863">                                violation.setPosition(mp.getFinalCoords());</span>
<span class="nc" id="L12864">                                violation.mpUsed += mp.getMpUsed();</span>
<span class="nc" id="L12865">                                violation.moved = mp.getLastStepMovementType();</span>
                            } else { // User decided to do nothing
<span class="nc" id="L12867">                                r = new Report(2358);</span>
<span class="nc" id="L12868">                                r.indent(3);</span>
<span class="nc" id="L12869">                                r.subject = violation.getId();</span>
<span class="nc" id="L12870">                                r.addDesc(violation);</span>
<span class="nc" id="L12871">                                vPhaseReport.add(r);</span>
<span class="nc" id="L12872">                                vPhaseReport.addAll(doEntityDisplacement(violation, dest,</span>
<span class="nc" id="L12873">                                        dest.translated(direction), null));</span>
                            }
<span class="nc" id="L12875">                        } else { // If no responses, treat as no action</span>
<span class="nc" id="L12876">                            vPhaseReport.addAll(doEntityDisplacement(violation,</span>
<span class="nc" id="L12877">                                    dest, dest.translated(direction),</span>
<span class="nc" id="L12878">                                    new PilotingRollData(violation.getId(), 0,</span>
                                            &quot;domino effect&quot;)));
                        }
<span class="nc" id="L12881">                    }</span>
                }
<span class="nc" id="L12883">            } else { // Nope</span>
<span class="nc" id="L12884">                r = new Report(2359);</span>
<span class="nc" id="L12885">                r.indent(2);</span>
<span class="nc" id="L12886">                r.subject = violation.getId();</span>
<span class="nc" id="L12887">                r.addDesc(violation);</span>
<span class="nc" id="L12888">                vPhaseReport.add(r);</span>
<span class="nc" id="L12889">                vPhaseReport.addAll(doEntityDisplacement(violation, dest, dest.translated(direction),</span>
<span class="nc" id="L12890">                        new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;)));</span>

            }
            // Update the violating entity's position on the client,
            // if it didn't get displaced off the board.
<span class="nc bnc" id="L12895" title="All 2 branches missed.">            if (!game.isOutOfGame(violation)) {</span>
<span class="nc" id="L12896">                entityUpdate(violation.getId());</span>
            }
        }
<span class="nc" id="L12899">        return vPhaseReport;</span>
    }

    private void sendDominoEffectCFR(Entity e) {
<span class="nc" id="L12903">        send(e.getOwnerId(), new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12904">                new Object[] { Packet.COMMAND_CFR_DOMINO_EFFECT, e.getId() }));</span>
<span class="nc" id="L12905">    }</span>

    private void sendAMSAssignCFR(Entity e, Mounted ams, List&lt;WeaponAttackAction&gt; waas) {
<span class="nc" id="L12908">        send(e.getOwnerId(),</span>
                new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
<span class="nc" id="L12910">                        new Object[] { Packet.COMMAND_CFR_AMS_ASSIGN,</span>
<span class="nc" id="L12911">                                e.getId(), e.getEquipmentNum(ams), waas }));</span>
<span class="nc" id="L12912">    }</span>

    private void sendAPDSAssignCFR(Entity e, List&lt;Integer&gt; apdsDists,
            List&lt;WeaponAttackAction&gt; waas) {
<span class="nc" id="L12916">        send(e.getOwnerId(), new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12917">                new Object[] { Packet.COMMAND_CFR_APDS_ASSIGN, e.getId(),</span>
                apdsDists, waas }));
<span class="nc" id="L12919">    }</span>

    private void sendPointBlankShotCFR(Entity hidden, Entity target) {
        // Send attacker/target IDs to PBS Client
<span class="nc" id="L12923">        send(hidden.getOwnerId(),</span>
                new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
<span class="nc" id="L12925">                        new Object[] { Packet.COMMAND_CFR_HIDDEN_PBS,</span>
<span class="nc" id="L12926">                                hidden.getId(), target.getId() }));</span>
<span class="nc" id="L12927">    }</span>

    private void sendTeleguidedMissileCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; toHitValues) {
        // Send target id numbers and to-hit values to Client
<span class="nc" id="L12931">        send(playerId, new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12932">                new Object[] { Packet.COMMAND_CFR_TELEGUIDED_TARGET, targetIds, toHitValues}));</span>
<span class="nc" id="L12933">    }</span>
    
    private void sendTAGTargetCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; targetTypes) {
        // Send target id numbers and type identifiers to Client
<span class="nc" id="L12937">        send(playerId, new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12938">                new Object[] { Packet.COMMAND_CFR_TAG_TARGET, targetIds, targetTypes}));</span>
<span class="nc" id="L12939">    }</span>

    private Vector&lt;Report&gt; doEntityDisplacementMinefieldCheck(Entity entity, Coords src, Coords dest, int elev) {
<span class="nc" id="L12942">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L12943">        boolean boom = checkVibrabombs(entity, dest, true, vPhaseReport);</span>
<span class="nc bnc" id="L12944" title="All 2 branches missed.">        if (game.containsMinefield(dest)) {</span>
<span class="nc bnc" id="L12945" title="All 4 branches missed.">            boom = enterMinefield(entity, dest, elev, true, vPhaseReport) || boom;</span>
        }
<span class="nc bnc" id="L12947" title="All 2 branches missed.">        if (boom) {</span>
<span class="nc" id="L12948">            resetMines();</span>
        }

<span class="nc" id="L12951">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; doEntityDisplacementBogDownCheck(Entity entity, Coords c, int elev) {
<span class="nc" id="L12955">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L12957">        IHex destHex = game.getBoard().getHex(c);</span>
<span class="nc" id="L12958">        int bgMod = destHex.getBogDownModifier(entity.getMovementMode(),</span>
                entity instanceof LargeSupportTank);
<span class="nc bnc" id="L12960" title="All 2 branches missed.">        if ((bgMod != TargetRoll.AUTOMATIC_SUCCESS)</span>
<span class="nc bnc" id="L12961" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L12962" title="All 4 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)</span>
                &amp;&amp; (elev == 0)) {
<span class="nc" id="L12964">            PilotingRollData roll = entity.getBasePilotingRoll();</span>
<span class="nc" id="L12965">            roll.append(new PilotingRollData(entity.getId(), bgMod, &quot;avoid bogging down&quot;));</span>
<span class="nc" id="L12966">            int stuckroll = Compute.d6(2);</span>
            // A DFA-ing mech is &quot;displaced&quot; into the target hex. Since it
            // must be jumping, it will automatically be bogged down
<span class="nc bnc" id="L12969" title="All 4 branches missed.">            if (stuckroll &lt; roll.getValue() || entity.isMakingDfa()) {</span>
<span class="nc" id="L12970">                entity.setStuck(true);</span>
<span class="nc" id="L12971">                r = new Report(2081);</span>
<span class="nc" id="L12972">                r.subject = entity.getId();</span>
<span class="nc" id="L12973">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L12974">                vReport.add(r);</span>
                // check for quicksand
<span class="nc" id="L12976">                vReport.addAll(checkQuickSand(c));</span>
            }

        }
<span class="nc" id="L12980">        return vReport;</span>
    }

    /**
     * Receive a deployment packet. If valid, execute it and end the current
     * turn.
     */
    private void receiveDeployment(Packet packet, int connId) {
<span class="nc" id="L12988">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L12989">        Coords coords = (Coords) packet.getObject(1);</span>
<span class="nc" id="L12990">        int nFacing = packet.getIntValue(2);</span>
<span class="nc" id="L12991">        int elevation = packet.getIntValue(3);</span>

        // Handle units that deploy loaded with other units.
<span class="nc" id="L12994">        int loadedCount = packet.getIntValue(4);</span>
<span class="nc" id="L12995">        Vector&lt;Entity&gt; loadVector = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L12996" title="All 2 branches missed.">        for (int i = 0; i &lt; loadedCount; i++) {</span>
<span class="nc" id="L12997">            int loadedId = packet.getIntValue(6 + i);</span>
<span class="nc" id="L12998">            loadVector.addElement(game.getEntity(loadedId));</span>
        }

        // is this the right phase?
<span class="nc bnc" id="L13002" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc" id="L13003">            MegaMek.getLogger().error(&quot;Server got deployment packet in wrong phase&quot;);</span>
<span class="nc" id="L13004">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13008">        final boolean assaultDrop = packet.getBooleanValue(5);</span>
        // can this player/entity act right now?
<span class="nc" id="L13010">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13011" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13012">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L13014" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)</span>
<span class="nc bnc" id="L13015" title="All 4 branches missed.">                || !(game.getBoard().isLegalDeployment(coords, entity.getStartingPos())</span>
<span class="nc bnc" id="L13016" title="All 2 branches missed.">                || (assaultDrop &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_ASSAULT_DROP)</span>
<span class="nc bnc" id="L13017" title="All 2 branches missed.">                    &amp;&amp; entity.canAssaultDrop()))) {</span>
<span class="nc" id="L13018">            String msg = &quot;server got invalid deployment packet from &quot;</span>
                         + &quot;connection &quot; + connId;
<span class="nc bnc" id="L13020" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L13021">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L13023">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13025">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13026">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13027">            send(connId, createTurnIndexPacket(turn.getPlayerNum()));</span>
<span class="nc" id="L13028">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13032">        processDeployment(entity, coords, nFacing, elevation, loadVector, assaultDrop);</span>

        //Update Aero sensors for a space or atmospheric game
<span class="nc bnc" id="L13035" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L13036">            IAero a = (IAero) entity;</span>
<span class="nc" id="L13037">            a.updateSensorOptions();</span>
        }

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L13041" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L13042">            updateVisibilityIndicator(null);</span>
        }

<span class="nc" id="L13045">        endCurrentTurn(entity);</span>
<span class="nc" id="L13046">    }</span>

    /**
     * Used when an Entity that was loaded in another Entity in the Lounge is
     * unloaded during deployment.
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveDeploymentUnload(Packet packet, int connId) {
<span class="nc" id="L13055">        Entity loader = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13056">        Entity loaded = game.getEntity(packet.getIntValue(1));</span>

<span class="nc bnc" id="L13058" title="All 2 branches missed.">        if (game.getPhase() != Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc" id="L13059">            String msg = &quot;server received deployment unload packet &quot;</span>
                    + &quot;outside of deployment phase from connection &quot; + connId;
<span class="nc bnc" id="L13061" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L13062">                msg += &quot;, Entity: &quot; + loader.getShortName();</span>
            } else {
<span class="nc" id="L13064">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13066">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13067">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13071">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13072" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13073">            turn = game.getTurnForPlayer(connId);</span>
        }

<span class="nc bnc" id="L13076" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, loader, game)) {</span>
<span class="nc" id="L13077">            String msg = &quot;server got invalid deployment unload packet from connection &quot; + connId;</span>
<span class="nc bnc" id="L13078" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L13079">                msg += &quot;, Entity: &quot; + loader.getShortName();</span>
            } else {
<span class="nc" id="L13081">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13083">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13084">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13085">            send(connId, createTurnIndexPacket(connId));</span>
<span class="nc" id="L13086">            return;</span>
        }

        // Unload and call entityUpdate
<span class="nc" id="L13090">        unloadUnit(loader, loaded, null, 0, 0, false, true);</span>

        // Need to update the loader
<span class="nc" id="L13093">        entityUpdate(loader.getId());</span>

        // Now need to add a turn for the unloaded unit, to be taken immediately
        // Turn forced to be immediate to avoid messy turn ordering issues
        // (aka, how do we add the turn with individual initiative?)
<span class="nc" id="L13098">        game.insertTurnAfter(new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L13099">                loaded.getOwnerId(), loaded.getId()), game.getTurnIndex() - 1);</span>
        //game.insertNextTurn(new GameTurn.SpecificEntityTurn(
        //        loaded.getOwnerId(), loaded.getId()));
<span class="nc" id="L13102">        send(createTurnVectorPacket());</span>
<span class="nc" id="L13103">    }</span>


    /**
     * Process a deployment packet by... deploying the entity! We load any other
     * specified entities inside of it too. Also, check that the deployment is
     * valid.
     */
    private void processDeployment(Entity entity, Coords coords, int nFacing, int elevation, Vector&lt;Entity&gt; loadVector,
            boolean assaultDrop) {
<span class="nc bnc" id="L13113" title="All 2 branches missed.">        for (Entity loaded : loadVector) {</span>
<span class="nc bnc" id="L13114" title="All 2 branches missed.">            if (loaded.getTransportId() != Entity.NONE) {</span>
                // we probably already loaded this unit in the chat lounge
<span class="nc" id="L13116">                continue;</span>
            }
<span class="nc bnc" id="L13118" title="All 2 branches missed.">            if (loaded.getPosition() != null) {</span>
                // Something is fishy in Denmark.
<span class="nc" id="L13120">                MegaMek.getLogger().error(entity + &quot; can not load entity #&quot; + loaded);</span>
<span class="nc" id="L13121">                break;</span>
            }
            // Have the deployed unit load the indicated unit.
<span class="nc" id="L13124">            loadUnit(entity, loaded, loaded.getTargetBay());</span>
<span class="nc" id="L13125">        }</span>

        /*
         * deal with starting velocity for advanced movement. Probably not the
         * best place to do it, but what are you going to do
         */
<span class="nc bnc" id="L13131" title="All 4 branches missed.">        if (entity.isAero() &amp;&amp; game.useVectorMove()) {</span>
<span class="nc" id="L13132">            IAero a = (IAero) entity;</span>
<span class="nc" id="L13133">            int[] v = {0, 0, 0, 0, 0, 0};</span>

            // if this is the entity's first time deploying, we want to respect the &quot;velocity&quot; setting from the lobby
<span class="nc bnc" id="L13136" title="All 2 branches missed.">            if(entity.wasNeverDeployed()) {</span>
<span class="nc bnc" id="L13137" title="All 2 branches missed.">                if (a.getCurrentVelocityActual() &gt; 0) {</span>
<span class="nc" id="L13138">                    v[nFacing] = a.getCurrentVelocityActual();</span>
<span class="nc" id="L13139">                    entity.setVectors(v);</span>
                }
            // this means the entity is coming back from off board, so we'll rotate the velocity vector by 180
            // and set it to 1/2 the magnitude
            } else {
<span class="nc bnc" id="L13144" title="All 2 branches missed.">                for(int x = 0; x &lt; 6; x++) {</span>
<span class="nc" id="L13145">                    v[(x + 3) % 6] = entity.getVector(x) / 2;</span>
                }

<span class="nc" id="L13148">                entity.setVectors(v);</span>
            }
        }

<span class="nc" id="L13152">        entity.setPosition(coords);</span>
<span class="nc" id="L13153">        entity.setFacing(nFacing);</span>
<span class="nc" id="L13154">        entity.setSecondaryFacing(nFacing);</span>
<span class="nc" id="L13155">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L13156" title="All 2 branches missed.">        if (assaultDrop) {</span>
<span class="nc" id="L13157">            entity.setAltitude(1);</span>
            // from the sky!
<span class="nc" id="L13159">            entity.setAssaultDropInProgress(true);</span>
<span class="nc bnc" id="L13160" title="All 4 branches missed.">        } else if ((entity instanceof VTOL) &amp;&amp; (entity.getExternalUnits().size() &lt;= 0)) {</span>
            // We should let players pick, but this simplifies a lot.
            // Only do it for VTOLs, though; assume everything else is on the
            // ground.
<span class="nc" id="L13164">            entity.setElevation((hex.ceiling() - hex.surface()) + 1);</span>
<span class="nc bnc" id="L13165" title="All 2 branches missed.">            while ((Compute.stackingViolation(game, entity, coords, null) != null)</span>
<span class="nc bnc" id="L13166" title="All 2 branches missed.">                   &amp;&amp; (entity.getElevation() &lt;= 50)) {</span>
<span class="nc" id="L13167">                entity.setElevation(entity.getElevation() + 1);</span>
            }
<span class="nc bnc" id="L13169" title="All 2 branches missed.">            if (entity.getElevation() &gt; 50) {</span>
<span class="nc" id="L13170">                throw new IllegalStateException(&quot;Entity #&quot; + entity.getId()</span>
                        + &quot; appears to be in an infinite loop trying to get a legal elevation.&quot;);
            }
<span class="nc bnc" id="L13173" title="All 2 branches missed.">        } else if (entity.isAero()) {</span>
            // if the entity is airborne, then we don't want to set its
            // elevation below, because that will
            // default to 999
<span class="nc bnc" id="L13177" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L13178">                entity.setElevation(0);</span>
<span class="nc" id="L13179">                elevation = 0;</span>
            }
<span class="nc bnc" id="L13181" title="All 2 branches missed.">            if (!game.getBoard().inSpace()) {</span>
                // all spheroid craft should have velocity of zero in atmosphere
                // regardless of what was entered
<span class="nc" id="L13184">                IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L13185" title="All 4 branches missed.">                if (a.isSpheroid() || game.getPlanetaryConditions().isVacuum()) {</span>
<span class="nc" id="L13186">                    a.setCurrentVelocity(0);</span>
<span class="nc" id="L13187">                    a.setNextVelocity(0);</span>
                }
                // make sure that entity is above the level of the hex if in
                // atmosphere
<span class="nc bnc" id="L13191" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()</span>
<span class="nc bnc" id="L13192" title="All 2 branches missed.">                    &amp;&amp; (entity.getAltitude() &lt;= hex.ceiling(true))) {</span>
                    // you can't be grounded on low atmosphere map
<span class="nc" id="L13194">                    entity.setAltitude(hex.ceiling(true) + 1);</span>
                }
<span class="nc" id="L13196">            }</span>
<span class="nc bnc" id="L13197" title="All 2 branches missed.">        } else if (entity.getMovementMode() == EntityMovementMode.SUBMARINE) {</span>
            // TODO : Submarines should have a selectable height.
            // TODO : For now, pretend they're regular naval.
<span class="nc" id="L13200">            entity.setElevation(0);</span>
<span class="nc bnc" id="L13201" title="All 2 branches missed.">        } else if ((entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L13202" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L13203" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L13204" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.HYDROFOIL)) {</span>
            // For now, assume they're on the surface.
            // entity elevation is relative to hex surface
<span class="nc" id="L13207">            entity.setElevation(0);</span>
<span class="nc bnc" id="L13208" title="All 2 branches missed.">        } else if (hex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L13209">            entity.setElevation(0);</span>
        } else {
<span class="nc" id="L13211">            Building bld = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L13212" title="All 4 branches missed.">            if ((bld != null) &amp;&amp; (bld.getType() == Building.WALL)) {</span>
<span class="nc" id="L13213">                entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
            }

        }
        // add the elevation that was passed into this method
        // TODO : currently only used for building placement, we should do this
        // TODO : more systematically with up/down buttons in the deployment display
<span class="nc" id="L13220">        entity.setElevation(entity.getElevation() + elevation);</span>
<span class="nc bnc" id="L13221" title="All 2 branches missed.">        boolean wigeFlyover = entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L13222" title="All 2 branches missed.">                &amp;&amp; hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L13223" title="All 2 branches missed.">                &amp;&amp; entity.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV);</span>


        // when first entering a building, we need to roll what type
        // of basement it has
<span class="nc" id="L13228">        Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L13229" title="All 2 branches missed.">        if ((bldg != null)) {</span>
<span class="nc bnc" id="L13230" title="All 2 branches missed.">            if (bldg.rollBasement(entity.getPosition(), game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L13231">                sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L13232">                Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L13233">                buildings.add(bldg);</span>
<span class="nc" id="L13234">                sendChangedBuildings(buildings);</span>
            }
<span class="nc" id="L13236">            boolean collapse = checkBuildingCollapseWhileMoving(bldg, entity, entity.getPosition());</span>
<span class="nc bnc" id="L13237" title="All 2 branches missed.">            if (collapse) {</span>
<span class="nc" id="L13238">                addAffectedBldg(bldg, true);</span>
<span class="nc bnc" id="L13239" title="All 2 branches missed.">                if (wigeFlyover) {</span>
                // If the building is collapsed by a WiGE flying over it, the WiGE drops one level of elevation.
<span class="nc" id="L13241">                    entity.setElevation(entity.getElevation() - 1);</span>
                }
            }
        }

<span class="nc" id="L13246">        entity.setDone(true);</span>
<span class="nc" id="L13247">        entity.setDeployed(true);</span>
<span class="nc" id="L13248">        entityUpdate(entity.getId());</span>
<span class="nc" id="L13249">        addReport(doSetLocationsExposure(entity, hex, false, entity.getElevation()));</span>
<span class="nc" id="L13250">    }</span>

    /**
     * receive a packet that contains hexes that are automatically hit by
     * artillery
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveArtyAutoHitHexes(Packet packet, int connId) {
<span class="nc" id="L13261">        PlayerIDandList&lt;Coords&gt; artyAutoHitHexes = (PlayerIDandList&lt;Coords&gt;) packet</span>
<span class="nc" id="L13262">                .getObject(0);</span>

<span class="nc" id="L13264">        int playerId = artyAutoHitHexes.getPlayerID();</span>

        // is this the right phase?
<span class="nc bnc" id="L13267" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES) {</span>
<span class="nc" id="L13268">            MegaMek.getLogger().error(&quot;Server got set artyautohithexespacket in wrong phase&quot;);</span>
<span class="nc" id="L13269">            return;</span>
        }
<span class="nc" id="L13271">        game.getPlayer(playerId).setArtyAutoHitHexes(artyAutoHitHexes);</span>

<span class="nc bnc" id="L13273" title="All 2 branches missed.">        for (Coords coord : artyAutoHitHexes) {</span>
<span class="nc" id="L13274">            game.getBoard().addSpecialHexDisplay(coord,</span>
                    new SpecialHexDisplay(
                            SpecialHexDisplay.Type.ARTILLERY_AUTOHIT,
<span class="nc" id="L13277">                            SpecialHexDisplay.NO_ROUND, getPlayer(playerId),</span>
                            &quot;Artillery auto hit hex, for &quot;
<span class="nc" id="L13279">                            + getPlayer(playerId).getName(),</span>
                            SpecialHexDisplay.SHD_OBSCURED_TEAM));
<span class="nc" id="L13281">        }</span>
<span class="nc" id="L13282">        endCurrentTurn(null);</span>
<span class="nc" id="L13283">    }</span>

    /**
     * receive a packet that contains minefields
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveDeployMinefields(Packet packet, int connId) {
<span class="nc" id="L13293">        Vector&lt;Minefield&gt; minefields = (Vector&lt;Minefield&gt;) packet.getObject(0);</span>

        // is this the right phase?
<span class="nc bnc" id="L13296" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_DEPLOY_MINEFIELDS) {</span>
<span class="nc" id="L13297">            MegaMek.getLogger().error(&quot;Server got deploy minefields packet in wrong phase&quot;);</span>
<span class="nc" id="L13298">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13302">        processDeployMinefields(minefields);</span>
<span class="nc" id="L13303">        endCurrentTurn(null);</span>
<span class="nc" id="L13304">    }</span>

    /**
     * process deployment of minefields
     *
     * @param minefields
     */
    private void processDeployMinefields(Vector&lt;Minefield&gt; minefields) {
<span class="nc" id="L13312">        int playerId = IPlayer.PLAYER_NONE;</span>
<span class="nc bnc" id="L13313" title="All 2 branches missed.">        for (int i = 0; i &lt; minefields.size(); i++) {</span>
<span class="nc" id="L13314">            Minefield mf = minefields.elementAt(i);</span>
<span class="nc" id="L13315">            playerId = mf.getPlayerId();</span>

<span class="nc" id="L13317">            game.addMinefield(mf);</span>
<span class="nc bnc" id="L13318" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L13319">                game.addVibrabomb(mf);</span>
            }
        }

<span class="nc" id="L13323">        IPlayer player = game.getPlayer(playerId);</span>
<span class="nc bnc" id="L13324" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L13325">            int teamId = player.getTeam();</span>

<span class="nc bnc" id="L13327" title="All 2 branches missed.">            if (teamId != IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L13328">                Enumeration&lt;Team&gt; teams = game.getTeams();</span>
<span class="nc bnc" id="L13329" title="All 2 branches missed.">                while (teams.hasMoreElements()) {</span>
<span class="nc" id="L13330">                    Team team = teams.nextElement();</span>
<span class="nc bnc" id="L13331" title="All 2 branches missed.">                    if (team.getId() == teamId) {</span>
<span class="nc" id="L13332">                        Enumeration&lt;IPlayer&gt; players = team.getPlayers();</span>
<span class="nc bnc" id="L13333" title="All 2 branches missed.">                        while (players.hasMoreElements()) {</span>
<span class="nc" id="L13334">                            IPlayer teamPlayer = players.nextElement();</span>
<span class="nc bnc" id="L13335" title="All 2 branches missed.">                            if (teamPlayer.getId() != player.getId()) {</span>
<span class="nc" id="L13336">                                send(teamPlayer.getId(), new Packet(Packet.COMMAND_DEPLOY_MINEFIELDS,</span>
                                        minefields));
                            }
<span class="nc" id="L13339">                            teamPlayer.addMinefields(minefields);</span>
<span class="nc" id="L13340">                        }</span>
                        break;
                    }
<span class="nc" id="L13343">                }</span>
<span class="nc" id="L13344">            } else {</span>
<span class="nc" id="L13345">                player.addMinefields(minefields);</span>
            }
        }
<span class="nc" id="L13348">    }</span>

    /**
     * Client has sent an update indicating that a ground unit is firing at
     * an airborne unit and is overriding the default select for the position
     * in the flight path.
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveGroundToAirHexSelectPacket(Packet packet, int connId) {
<span class="nc" id="L13358">        Integer targetId = (Integer)packet.getObject(0);</span>
<span class="nc" id="L13359">        Integer attackerId = (Integer)packet.getObject(1);</span>
<span class="nc" id="L13360">        Coords pos = (Coords)packet.getObject(2);</span>
<span class="nc" id="L13361">        game.getEntity(targetId).setPlayerPickedPassThrough(attackerId, pos);</span>
<span class="nc" id="L13362">    }</span>

    /**
     * Gets a bunch of entity attacks from the packet. If valid, processes them
     * and ends the current turn.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveAttack(Packet packet, int connId) {
<span class="nc" id="L13370">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13371">        Vector&lt;EntityAction&gt; vector = (Vector&lt;EntityAction&gt;) packet.getObject(1);</span>

        // is this the right phase?
<span class="nc bnc" id="L13374" title="All 2 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L13375" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_PHYSICAL)</span>
<span class="nc bnc" id="L13376" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L13377" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_OFFBOARD)) {</span>
<span class="nc" id="L13378">            MegaMek.getLogger().error(&quot;Server got attack packet in wrong phase&quot;);</span>
<span class="nc" id="L13379">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13383">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13384" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13385">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L13387" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)) {</span>
<span class="nc" id="L13388">            String msg = &quot;error: server got invalid attack packet from connection &quot; + connId;</span>
<span class="nc bnc" id="L13389" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L13390">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L13392">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13394">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13395">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13396">            send(connId, createTurnIndexPacket(turn.getPlayerNum()));</span>
<span class="nc" id="L13397">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13401">        processAttack(entity, vector);</span>

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L13404" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L13405">            updateVisibilityIndicator(null);</span>
        }

<span class="nc" id="L13408">        endCurrentTurn(entity);</span>
<span class="nc" id="L13409">    }</span>

    /**
     * Process a batch of entity attack (or twist) actions by adding them to the
     * proper list to be processed later.
     */
    private void processAttack(Entity entity, Vector&lt;EntityAction&gt; vector) {
        // Convert any null vectors to empty vectors to avoid NPEs.
<span class="nc bnc" id="L13417" title="All 2 branches missed.">        if (vector == null) {</span>
<span class="nc" id="L13418">            vector = new Vector&lt;&gt;(0);</span>
        }

        // Not **all** actions take up the entity's turn.
<span class="nc bnc" id="L13422" title="All 2 branches missed.">        boolean setDone = !((game.getTurn() instanceof GameTurn.TriggerAPPodTurn)</span>
<span class="nc bnc" id="L13423" title="All 2 branches missed.">                || (game.getTurn() instanceof GameTurn.TriggerBPodTurn));</span>
<span class="nc bnc" id="L13424" title="All 2 branches missed.">        for (EntityAction ea : vector) {</span>
            // is this the right entity?
<span class="nc bnc" id="L13426" title="All 2 branches missed.">            if (ea.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L13427">                MegaMek.getLogger().error(&quot;Attack packet has wrong attacker&quot;);</span>
<span class="nc" id="L13428">                continue;</span>
            }
<span class="nc bnc" id="L13430" title="All 2 branches missed.">            if (ea instanceof PushAttackAction) {</span>
                // push attacks go the end of the displacement attacks
<span class="nc" id="L13432">                PushAttackAction paa = (PushAttackAction) ea;</span>
<span class="nc" id="L13433">                entity.setDisplacementAttack(paa);</span>
<span class="nc" id="L13434">                game.addCharge(paa);</span>
<span class="nc bnc" id="L13435" title="All 2 branches missed.">            } else if (ea instanceof DodgeAction) {</span>
<span class="nc" id="L13436">                entity.dodging = true;</span>
<span class="nc bnc" id="L13437" title="All 2 branches missed.">            } else if (ea instanceof SpotAction) {</span>
<span class="nc" id="L13438">                entity.setSpotting(true);</span>
<span class="nc" id="L13439">                entity.setSpotTargetId(((SpotAction) ea).getTargetId());</span>
            } else {
                // add to the normal attack list.
<span class="nc" id="L13442">                game.addAction(ea);</span>
            }

            // Anti-mech and pointblank attacks from
            // hiding may allow the target to respond.
<span class="nc bnc" id="L13447" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L13448">                final WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L13449">                final String weaponName = entity.getEquipment(waa.getWeaponId()).getType()</span>
<span class="nc" id="L13450">                        .getInternalName();</span>

<span class="nc bnc" id="L13452" title="All 4 branches missed.">                if (Infantry.SWARM_MEK.equals(weaponName) || Infantry.LEG_ATTACK.equals(weaponName)) {</span>

                    // Does the target have any AP Pods available?
<span class="nc" id="L13455">                    final Entity target = game.getEntity(waa.getTargetId());</span>
<span class="nc bnc" id="L13456" title="All 2 branches missed.">                    for (Mounted equip : target.getMisc()) {</span>
<span class="nc bnc" id="L13457" title="All 4 branches missed.">                        if (equip.getType().hasFlag(MiscType.F_AP_POD) &amp;&amp; equip.canFire()) {</span>

                            // Yup. Insert a game turn to handle AP pods.
                            // ASSUMPTION : AP pod declarations come
                            // immediately after the attack declaration.
<span class="nc" id="L13462">                            game.insertNextTurn(new GameTurn.TriggerAPPodTurn(target.getOwnerId(),</span>
<span class="nc" id="L13463">                                    target.getId()));</span>
<span class="nc" id="L13464">                            send(createTurnVectorPacket());</span>

                            // We can stop looking.
<span class="nc" id="L13467">                            break;</span>

                        } // end found-available-ap-pod

<span class="nc" id="L13471">                    } // Check the next piece of equipment on the target.</span>

<span class="nc bnc" id="L13473" title="All 2 branches missed.">                    for (Mounted weapon : target.getWeaponList()) {</span>
<span class="nc bnc" id="L13474" title="All 4 branches missed.">                        if (weapon.getType().hasFlag(WeaponType.F_B_POD) &amp;&amp; weapon.canFire()) {</span>

                            // Yup. Insert a game turn to handle B pods.
                            // ASSUMPTION : B pod declarations come
                            // immediately after the attack declaration.
<span class="nc" id="L13479">                            game.insertNextTurn(new GameTurn.TriggerBPodTurn(target.getOwnerId(),</span>
<span class="nc" id="L13480">                                    target.getId(), weaponName));</span>
<span class="nc" id="L13481">                            send(createTurnVectorPacket());</span>

                            // We can stop looking.
<span class="nc" id="L13484">                            break;</span>

                        } // end found-available-b-pod
<span class="nc" id="L13487">                    } // Check the next piece of equipment on the target.</span>
                } // End check-for-available-ap-pod

                // Keep track of altitude loss for weapon attacks
<span class="nc bnc" id="L13491" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L13492">                    IAero aero = (IAero) entity;</span>
<span class="nc bnc" id="L13493" title="All 2 branches missed.">                    if (waa.getAltitudeLoss(game) &gt; aero.getAltLoss()) {</span>
<span class="nc" id="L13494">                        aero.setAltLoss(waa.getAltitudeLoss(game));</span>
                    }
                }
            }

            // If attacker breaks grapple, defender may counter
<span class="nc bnc" id="L13500" title="All 2 branches missed.">            if (ea instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L13501">                final BreakGrappleAttackAction bgaa = (BreakGrappleAttackAction) ea;</span>
<span class="nc" id="L13502">                final Entity att = (game.getEntity(bgaa.getEntityId()));</span>
<span class="nc bnc" id="L13503" title="All 2 branches missed.">                if (att.isGrappleAttacker()) {</span>
<span class="nc" id="L13504">                    final Entity def = (game.getEntity(bgaa.getTargetId()));</span>
                    // Remove existing break grapple by defender (if exists)
<span class="nc bnc" id="L13506" title="All 2 branches missed.">                    if (def.isDone()) {</span>
<span class="nc" id="L13507">                        game.removeActionsFor(def.getId());</span>
                    } else {
<span class="nc" id="L13509">                        game.removeTurnFor(def);</span>
<span class="nc" id="L13510">                        def.setDone(true);</span>
                    }
                    // If defender is able, add a turn to declare counterattack
<span class="nc bnc" id="L13513" title="All 2 branches missed.">                    if (!def.isImmobile()) {</span>
<span class="nc" id="L13514">                        game.insertNextTurn(new GameTurn.CounterGrappleTurn(def.getOwnerId(), def.getId()));</span>
<span class="nc" id="L13515">                        send(createTurnVectorPacket());</span>
                    }
                }
            }
<span class="nc bnc" id="L13519" title="All 2 branches missed.">            if (ea instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L13520">                boolean firingAtNewHex = false;</span>
<span class="nc" id="L13521">                final ArtilleryAttackAction aaa = (ArtilleryAttackAction) ea;</span>
<span class="nc" id="L13522">                final Entity firingEntity = game.getEntity(aaa.getEntityId());</span>
<span class="nc" id="L13523">                for (Enumeration&lt;AttackHandler&gt; j = game.getAttacks(); !firingAtNewHex</span>
<span class="nc bnc" id="L13524" title="All 4 branches missed.">                        &amp;&amp; j.hasMoreElements(); ) {</span>
<span class="nc" id="L13525">                    WeaponHandler wh = (WeaponHandler) j.nextElement();</span>
<span class="nc bnc" id="L13526" title="All 2 branches missed.">                    if (wh.waa instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L13527">                        ArtilleryAttackAction oaaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc bnc" id="L13528" title="All 2 branches missed.">                        if ((oaaa.getEntityId() == aaa.getEntityId())</span>
<span class="nc" id="L13529">                            &amp;&amp; !oaaa.getTarget(game).getPosition()</span>
<span class="nc bnc" id="L13530" title="All 2 branches missed.">                                .equals(aaa.getTarget(game).getPosition())) {</span>
<span class="nc" id="L13531">                            firingAtNewHex = true;</span>
                        }
                    }
<span class="nc" id="L13534">                }</span>
<span class="nc bnc" id="L13535" title="All 2 branches missed.">                if (firingAtNewHex) {</span>
<span class="nc" id="L13536">                    clearArtillerySpotters(firingEntity.getId(), aaa.getWeaponId());</span>
                }
<span class="nc" id="L13538">                Iterator&lt;Entity&gt; spotters = game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L13539">                            public int player = firingEntity.getOwnerId();</span>
<span class="nc" id="L13540">                            public Targetable target = aaa.getTarget(game);</span>

                            public boolean accept(Entity entity) {
<span class="nc" id="L13543">                                LosEffects los = LosEffects.calculateLos(game, entity.getId(), target);</span>
<span class="nc bnc" id="L13544" title="All 4 branches missed.">                                return ((player == entity.getOwnerId()) &amp;&amp; !(los.isBlocked())</span>
<span class="nc bnc" id="L13545" title="All 2 branches missed.">                                        &amp;&amp; entity.isActive());</span>
                            }
                        });
<span class="nc" id="L13548">                Vector&lt;Integer&gt; spotterIds = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L13549" title="All 2 branches missed.">                while (spotters.hasNext()) {</span>
<span class="nc" id="L13550">                    Integer id = spotters.next().getId();</span>
<span class="nc" id="L13551">                    spotterIds.addElement(id);</span>
<span class="nc" id="L13552">                }</span>
<span class="nc" id="L13553">                aaa.setSpotterIds(spotterIds);</span>
            }

            // The equipment type of a club needs to be restored.
<span class="nc bnc" id="L13557" title="All 2 branches missed.">            if (ea instanceof ClubAttackAction) {</span>
<span class="nc" id="L13558">                ClubAttackAction caa = (ClubAttackAction) ea;</span>
<span class="nc" id="L13559">                Mounted club = caa.getClub();</span>
<span class="nc" id="L13560">                club.restore();</span>
            }

            // Mark any AP Pod as used in this turn.
<span class="nc bnc" id="L13564" title="All 2 branches missed.">            if (ea instanceof TriggerAPPodAction) {</span>
<span class="nc" id="L13565">                TriggerAPPodAction tapa = (TriggerAPPodAction) ea;</span>
<span class="nc" id="L13566">                Mounted pod = entity.getEquipment(tapa.getPodId());</span>
<span class="nc" id="L13567">                pod.setUsedThisRound(true);</span>
            }
            // Mark any B Pod as used in this turn.
<span class="nc bnc" id="L13570" title="All 2 branches missed.">            if (ea instanceof TriggerBPodAction) {</span>
<span class="nc" id="L13571">                TriggerBPodAction tba = (TriggerBPodAction) ea;</span>
<span class="nc" id="L13572">                Mounted pod = entity.getEquipment(tba.getPodId());</span>
<span class="nc" id="L13573">                pod.setUsedThisRound(true);</span>
            }

            // Mark illuminated hexes, so they can be displayed
<span class="nc bnc" id="L13577" title="All 2 branches missed.">            if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L13578">                boolean hexesAdded =</span>
<span class="nc" id="L13579">                        ((SearchlightAttackAction) ea).setHexesIlluminated(game);</span>
                // If we added new hexes, send them to all players.
                // These are spotlights at night, you know they're there.
<span class="nc bnc" id="L13582" title="All 2 branches missed.">                if (hexesAdded) {</span>
<span class="nc" id="L13583">                    send(createIlluminatedHexesPacket());</span>
                }
            }
<span class="nc" id="L13586">        }</span>

        // Apply altitude loss
<span class="nc bnc" id="L13589" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L13590">            IAero aero = (IAero) entity;</span>
<span class="nc bnc" id="L13591" title="All 2 branches missed.">            if (aero.getAltLoss() &gt; 0) {</span>
<span class="nc" id="L13592">                Report r = new Report(9095);</span>
<span class="nc" id="L13593">                r.subject = entity.getId();</span>
<span class="nc" id="L13594">                r.addDesc(entity);</span>
<span class="nc" id="L13595">                r.add(aero.getAltLoss());</span>
<span class="nc" id="L13596">                addReport(r);</span>
<span class="nc" id="L13597">                entity.setAltitude(entity.getAltitude() - aero.getAltLoss());</span>
<span class="nc" id="L13598">                aero.setAltLossThisRound(aero.getAltLoss());</span>
<span class="nc" id="L13599">                aero.resetAltLoss();</span>
<span class="nc" id="L13600">                entityUpdate(entity.getId());</span>
            }
        }

        // Unless otherwise stated,
        // this entity is done for the round.
<span class="nc bnc" id="L13606" title="All 2 branches missed.">        if (setDone) {</span>
<span class="nc" id="L13607">            entity.setDone(true);</span>
        }
<span class="nc" id="L13609">        entityUpdate(entity.getId());</span>

<span class="nc" id="L13611">        Packet p = createAttackPacket(vector, 0);</span>
<span class="nc bnc" id="L13612" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
            // Update attack only to player who declared it &amp; observers
<span class="nc bnc" id="L13614" title="All 2 branches missed.">            for (IPlayer player : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L13615" title="All 4 branches missed.">                if (player.canSeeAll() || player.isObserver()</span>
<span class="nc bnc" id="L13616" title="All 2 branches missed.">                    || (entity.getOwnerId() == player.getId())) {</span>
<span class="nc" id="L13617">                    send(player.getId(), p);</span>
                }
<span class="nc" id="L13619">            }</span>
        } else {
            // update all players on the attacks. Don't worry about pushes being
            // a &quot;charge&quot; attack. It doesn't matter to the client.
<span class="nc" id="L13623">            send(p);</span>
        }
<span class="nc" id="L13625">    }</span>

    /**
     * Determine which telemissile attack actions could be affected by AMS, and
     * assign AMS to those attacks.
     */
    public void assignTeleMissileAMS(TeleMissileAttackAction taa) {
        // Map target to a list of telemissile attacks directed at entities
<span class="nc" id="L13633">        Hashtable&lt;Entity, Vector&lt;AttackAction&gt;&gt; htTMAttacks = new Hashtable&lt;&gt;();</span>

        //This should be impossible but just in case...
<span class="nc bnc" id="L13636" title="All 2 branches missed.">        if (taa == null) {</span>
<span class="nc" id="L13637">            MegaMek.getLogger().error(&quot;Null TeleMissileAttackAction!&quot;);</span>
        }

<span class="nc bnc" id="L13640" title="All 2 branches missed.">        Entity target = (taa.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc" id="L13641">                ? (Entity) taa.getTarget(game) : null;</span>

        //If a telemissile is still on the board and its original target is not....
<span class="nc bnc" id="L13644" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L13645">            MegaMek.getLogger().info(&quot;Telemissile has no target. AMS not assigned.&quot;);</span>
<span class="nc" id="L13646">            return;</span>
        }

<span class="nc" id="L13649">        Vector&lt;AttackAction&gt; v = htTMAttacks.computeIfAbsent(target, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13650">        v.addElement(taa);</span>
        // Let each target assign its AMS
<span class="nc bnc" id="L13652" title="All 2 branches missed.">        for (Entity e : htTMAttacks.keySet()) {</span>
<span class="nc" id="L13653">            Vector&lt;AttackAction&gt; vTMAttacks = htTMAttacks.get(e);</span>
            // Allow MM to automatically assign AMS targets
            // AMS bays can fire multiple times, so manual target assignment is kind of pointless
<span class="nc" id="L13656">            e.assignTMAMS(vTMAttacks);</span>
<span class="nc" id="L13657">        }</span>
<span class="nc" id="L13658">    }</span>

    /**
     * Determine which missile attack actions could be affected by AMS, and
     * assign AMS (and APDS) to those attacks.
     */
    public void assignAMS() {
        // Get all of the coords that would be protected by APDS
<span class="nc" id="L13666">        Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; apdsCoords = getAPDSProtectedCoords();</span>
        // Map target to a list of missile attacks directed at it
<span class="nc" id="L13668">        Hashtable&lt;Entity, Vector&lt;WeaponHandler&gt;&gt; htAttacks = new Hashtable&lt;&gt;();</span>
        // Keep track of each APDS, and which attacks it could affect
<span class="nc" id="L13670">        Hashtable&lt;Mounted, Vector&lt;WeaponHandler&gt;&gt; apdsTargets = new Hashtable&lt;&gt;();</span>

<span class="nc bnc" id="L13672" title="All 2 branches missed.">        for (AttackHandler ah : game.getAttacksVector()) {</span>
<span class="nc" id="L13673">            WeaponHandler wh = (WeaponHandler) ah;</span>
<span class="nc" id="L13674">            WeaponAttackAction waa = wh.waa;</span>

            // for artillery attacks, the attacking entity
            // might no longer be in the game.
            //TODO : Yeah, I know there's an exploit here, but better able to shoot some ArrowIVs than none, right?
<span class="nc bnc" id="L13679" title="All 2 branches missed.">            if (game.getEntity(waa.getEntityId()) == null) {</span>
<span class="nc" id="L13680">                MegaMek.getLogger().info(&quot;Can't Assign AMS: Artillery firer is null!&quot;);</span>
<span class="nc" id="L13681">                continue;</span>
            }

<span class="nc" id="L13684">            Mounted weapon = game.getEntity(waa.getEntityId()).getEquipment(waa.getWeaponId());</span>

            // Only entities can have AMS. Arrow IV doesn't target an entity until later, so we have to ignore them
<span class="nc bnc" id="L13687" title="All 4 branches missed.">            if (!(waa instanceof ArtilleryAttackAction) &amp;&amp; (Targetable.TYPE_ENTITY != waa.getTargetType())) {</span>
<span class="nc" id="L13688">                continue;</span>
            }

            // AMS is only used against attacks that hit (TW p129)
<span class="nc bnc" id="L13692" title="All 2 branches missed.">            if (wh.roll &lt; wh.toHit.getValue()) {</span>
<span class="nc" id="L13693">                continue;</span>
            }
            
            // Can only use AMS versus missiles. Artillery Bays might be firing Arrow IV homing missiles,
            // but lack the flag
<span class="nc" id="L13698">            boolean isHomingMissile = false;</span>
<span class="nc bnc" id="L13699" title="All 4 branches missed.">            if (wh instanceof ArtilleryWeaponIndirectHomingHandler</span>
                    || wh instanceof ArtilleryBayWeaponIndirectHomingHandler) {
<span class="nc" id="L13701">                Mounted ammoUsed = game.getEntity(waa.getEntityId()).getEquipment(waa.getAmmoId());</span>
<span class="nc bnc" id="L13702" title="All 2 branches missed.">                AmmoType atype = ammoUsed == null ? null : (AmmoType) ammoUsed.getType();</span>
<span class="nc bnc" id="L13703" title="All 2 branches missed.">                if (atype != null </span>
<span class="nc bnc" id="L13704" title="All 4 branches missed.">                        &amp;&amp; (atype.getAmmoType() == AmmoType.T_ARROW_IV || atype.getAmmoType() == BombType.B_HOMING)) {</span>
<span class="nc" id="L13705">                    isHomingMissile = true;</span>
                }
            }
<span class="nc bnc" id="L13708" title="All 4 branches missed.">            if (!weapon.getType().hasFlag(WeaponType.F_MISSILE) &amp;&amp; !isHomingMissile) {</span>
<span class="nc" id="L13709">                continue;</span>
            }

            // For Bearings-only Capital Missiles, don't assign during the offboard phase
<span class="nc bnc" id="L13713" title="All 2 branches missed.">            if (wh instanceof CapitalMissileBearingsOnlyHandler) {</span>
<span class="nc" id="L13714">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) waa;</span>
<span class="nc bnc" id="L13715" title="All 4 branches missed.">                if (aaa.getTurnsTilHit() &gt; 0 || game.getPhase() != IGame.Phase.PHASE_FIRING) {</span>
<span class="nc" id="L13716">                    continue;</span>
                }
            }

            // For Arrow IV homing artillery
            Entity target;
<span class="nc bnc" id="L13722" title="All 2 branches missed.">            if (waa instanceof ArtilleryAttackAction) {</span>
<span class="nc bnc" id="L13723" title="All 2 branches missed.">                target = (waa.getTargetType() == Targetable.TYPE_ENTITY) ? (Entity) waa</span>
<span class="nc" id="L13724">                    .getTarget(game) : null;</span>

                // In case our target really is null.
<span class="nc bnc" id="L13727" title="All 2 branches missed.">                if (target == null) {</span>
<span class="nc" id="L13728">                    continue;</span>
                }
            } else {
<span class="nc" id="L13731">                target = game.getEntity(waa.getTargetId());</span>
            }
<span class="nc" id="L13733">            Vector&lt;WeaponHandler&gt; v = htAttacks.computeIfAbsent(target, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13734">            v.addElement(wh);</span>
            // Keep track of what weapon attacks could be affected by APDS
<span class="nc bnc" id="L13736" title="All 2 branches missed.">            if (apdsCoords.containsKey(target.getPosition())) {</span>
<span class="nc bnc" id="L13737" title="All 2 branches missed.">                for (Mounted apds : apdsCoords.get(target.getPosition())) {</span>
                    // APDS only affects attacks against friendly units
<span class="nc bnc" id="L13739" title="All 2 branches missed.">                    if (target.isEnemyOf(apds.getEntity())) {</span>
<span class="nc" id="L13740">                        continue;</span>
                    }
<span class="nc" id="L13742">                    Vector&lt;WeaponHandler&gt; handlerList = apdsTargets.computeIfAbsent(apds, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13743">                    handlerList.add(wh);</span>
<span class="nc" id="L13744">                }</span>
            }
<span class="nc" id="L13746">        }</span>
        
        // Let each target assign its AMS
<span class="nc bnc" id="L13749" title="All 2 branches missed.">        for (Entity e : htAttacks.keySet()) {</span>
<span class="nc" id="L13750">            Vector&lt;WeaponHandler&gt; vAttacks = htAttacks.get(e);</span>
            // Allow MM to automatically assign AMS targets
<span class="nc bnc" id="L13752" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.BASE_AUTO_AMS)) {</span>
<span class="nc" id="L13753">                e.assignAMS(vAttacks);</span>
            } else { // Allow user to manually assign targets
<span class="nc" id="L13755">                manuallyAssignAMSTarget(e, vAttacks);</span>
            }
<span class="nc" id="L13757">        }</span>

        // Let each APDS assign itself to an attack
<span class="nc" id="L13760">        Set&lt;WeaponAttackAction&gt; targetedAttacks = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L13761" title="All 2 branches missed.">        for (Mounted apds : apdsTargets.keySet()) {</span>
<span class="nc" id="L13762">            List&lt;WeaponHandler&gt; potentialTargets = apdsTargets.get(apds);</span>
            // Ensure we only target each attack once
<span class="nc" id="L13764">            List&lt;WeaponHandler&gt; targetsToRemove = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L13765" title="All 2 branches missed.">            for (WeaponHandler wh : potentialTargets) {</span>
<span class="nc bnc" id="L13766" title="All 2 branches missed.">                if (targetedAttacks.contains(wh.getWaa())) {</span>
<span class="nc" id="L13767">                    targetsToRemove.add(wh);</span>
                }
<span class="nc" id="L13769">            }</span>
<span class="nc" id="L13770">            potentialTargets.removeAll(targetsToRemove);</span>
            WeaponAttackAction targetedWAA;
            // Assign APDS to an attack
<span class="nc bnc" id="L13773" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.BASE_AUTO_AMS)) {</span>
<span class="nc" id="L13774">                targetedWAA = apds.assignAPDS(potentialTargets);</span>
            } else { // Allow user to manually assign targets
<span class="nc" id="L13776">                targetedWAA = manuallyAssignAPDSTarget(apds, potentialTargets);</span>
            }
<span class="nc bnc" id="L13778" title="All 2 branches missed.">            if (targetedWAA != null) {</span>
<span class="nc" id="L13779">                targetedAttacks.add(targetedWAA);</span>
            }
<span class="nc" id="L13781">        }</span>

<span class="nc" id="L13783">    }</span>

    /**
     * Convenience method for determining which missile attack will be targeted
     * with AMS on the supplied Entity
     *
     * @param apds
     *            The Entity with AMS
     * @param vAttacks
     *            List of missile attacks directed at e
     */
    private WeaponAttackAction manuallyAssignAPDSTarget(Mounted apds,
            List&lt;WeaponHandler&gt; vAttacks) {
<span class="nc" id="L13796">        Entity e = apds.getEntity();</span>
<span class="nc bnc" id="L13797" title="All 2 branches missed.">        if (e == null) {</span>
<span class="nc" id="L13798">            return null;</span>
        }

        // Create a list of valid assignments for this APDS
<span class="nc" id="L13802">        List&lt;WeaponAttackAction&gt; vAttacksInArc = new ArrayList&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L13803" title="All 2 branches missed.">        for (WeaponHandler wr : vAttacks) {</span>
<span class="nc" id="L13804">            boolean isInArc = Compute.isInArc(e.getGame(), e.getId(),</span>
<span class="nc" id="L13805">                    e.getEquipmentNum(apds),</span>
<span class="nc" id="L13806">                    game.getEntity(wr.waa.getEntityId()));</span>
<span class="nc bnc" id="L13807" title="All 2 branches missed.">            boolean isInRange = e.getPosition().distance(</span>
<span class="nc" id="L13808">                    wr.getWaa().getTarget(game).getPosition()) &lt;= 3;</span>
<span class="nc bnc" id="L13809" title="All 4 branches missed.">            if (isInArc &amp;&amp; isInRange) {</span>
<span class="nc" id="L13810">                vAttacksInArc.add(wr.waa);</span>
            }
<span class="nc" id="L13812">        }</span>

        // If there are no valid attacks left, don't bother
<span class="nc bnc" id="L13815" title="All 2 branches missed.">        if (vAttacksInArc.size() &lt; 1) {</span>
<span class="nc" id="L13816">            return null;</span>
        }

<span class="nc" id="L13819">        WeaponAttackAction targetedWAA = null;</span>

<span class="nc bnc" id="L13821" title="All 2 branches missed.">        if (apds.curMode().equals(&quot;Automatic&quot;)) {</span>
<span class="nc" id="L13822">            targetedWAA = Compute.getHighestExpectedDamage(game,</span>
                    vAttacksInArc, true);
        } else {
            // Send a client feedback request
<span class="nc" id="L13826">            List&lt;Integer&gt; apdsDists = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L13827" title="All 2 branches missed.">            for (WeaponAttackAction waa : vAttacksInArc) {</span>
<span class="nc" id="L13828">                apdsDists.add(waa.getTarget(game).getPosition()</span>
<span class="nc" id="L13829">                        .distance(e.getPosition()));</span>
<span class="nc" id="L13830">            }</span>
<span class="nc" id="L13831">            sendAPDSAssignCFR(e, apdsDists, vAttacksInArc);</span>
<span class="nc" id="L13832">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc" id="L13834">                    cfrPacketQueue.wait();</span>
<span class="nc" id="L13835">                } catch (InterruptedException ex) {</span>
                    // Do nothing
<span class="nc" id="L13837">                }</span>
<span class="nc bnc" id="L13838" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L13839">                    ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L13840">                    int cfrType = (int) rp.packet.getData()[0];</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L13842" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_APDS_ASSIGN) {</span>
<span class="nc" id="L13843">                        MegaMek.getLogger().error(&quot;Expected a COMMAND_CFR_AMS_ASSIGN CFR packet, received: &quot; + cfrType);</span>
<span class="nc" id="L13844">                        throw new IllegalStateException();</span>
                    }
<span class="nc" id="L13846">                    Integer waaIndex =</span>
<span class="nc" id="L13847">                            (Integer)rp.packet.getData()[1];</span>
<span class="nc bnc" id="L13848" title="All 2 branches missed.">                    if (waaIndex != null) {</span>
<span class="nc" id="L13849">                        targetedWAA = vAttacksInArc.get(waaIndex);</span>
                    }
                }
<span class="nc" id="L13852">            }</span>
        }

<span class="nc bnc" id="L13855" title="All 2 branches missed.">        if (targetedWAA != null) {</span>
<span class="nc" id="L13856">            targetedWAA.addCounterEquipment(apds);</span>
<span class="nc" id="L13857">            return targetedWAA;</span>
        } else {
<span class="nc" id="L13859">            return null;</span>
        }
    }

    /**
     * Convenience method for determining which missile attack will be targeted
     * with AMS on the supplied Entity
     *
     * @param e
     *            The Entity with AMS
     * @param vAttacks
     *            List of missile attacks directed at e
     */
    private void manuallyAssignAMSTarget(Entity e,
            Vector&lt;WeaponHandler&gt; vAttacks) {
        //Fix for bug #1051 - don't send the targeting nag for a shutdown unit
<span class="nc bnc" id="L13875" title="All 2 branches missed.">        if (e.isShutDown()) {</span>
<span class="nc" id="L13876">            return;</span>
        }
        // Current AMS targets: each attack can only be targeted once
<span class="nc" id="L13879">        HashSet&lt;WeaponAttackAction&gt; amsTargets = new HashSet&lt;&gt;();</span>
        // Pick assignment for each active AMS
<span class="nc bnc" id="L13881" title="All 2 branches missed.">        for (Mounted ams : e.getActiveAMS()) {</span>
            // Skip APDS
<span class="nc bnc" id="L13883" title="All 2 branches missed.">            if (ams.isAPDS()) {</span>
<span class="nc" id="L13884">                continue;</span>
            }
            // Create a list of valid assignments for this AMS
<span class="nc" id="L13887">            List&lt;WeaponAttackAction&gt; vAttacksInArc = new ArrayList&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L13888" title="All 2 branches missed.">            for (WeaponHandler wr : vAttacks) {</span>
<span class="nc bnc" id="L13889" title="All 2 branches missed.">                if (!amsTargets.contains(wr.waa)</span>
<span class="nc bnc" id="L13890" title="All 2 branches missed.">                        &amp;&amp; Compute.isInArc(game, e.getId(),</span>
<span class="nc" id="L13891">                                e.getEquipmentNum(ams),</span>
<span class="nc" id="L13892">                                game.getEntity(wr.waa.getEntityId()))) {</span>
<span class="nc" id="L13893">                    vAttacksInArc.add(wr.waa);</span>
                }
<span class="nc" id="L13895">            }</span>

            // If there are no valid attacks left, don't bother
<span class="nc bnc" id="L13898" title="All 2 branches missed.">            if (vAttacksInArc.size() &lt; 1) {</span>
<span class="nc" id="L13899">                continue;</span>
            }

<span class="nc" id="L13902">            WeaponAttackAction targetedWAA = null;</span>

<span class="nc bnc" id="L13904" title="All 2 branches missed.">            if (ams.curMode().equals(&quot;Automatic&quot;)) {</span>
<span class="nc" id="L13905">                targetedWAA = Compute.getHighestExpectedDamage(game,</span>
                        vAttacksInArc, true);
            } else {
                // Send a client feedback request
<span class="nc" id="L13909">                sendAMSAssignCFR(e, ams, vAttacksInArc);</span>
<span class="nc" id="L13910">                synchronized (cfrPacketQueue) {</span>
                    try {
<span class="nc" id="L13912">                        cfrPacketQueue.wait();</span>
<span class="nc" id="L13913">                    } catch (InterruptedException ex) {</span>
                        // Do nothing
<span class="nc" id="L13915">                    }</span>
<span class="nc bnc" id="L13916" title="All 2 branches missed.">                    if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L13917">                        ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L13918">                        int cfrType = (int) rp.packet.getData()[0];</span>
                        // Make sure we got the right type of response
<span class="nc bnc" id="L13920" title="All 2 branches missed.">                        if (cfrType != Packet.COMMAND_CFR_AMS_ASSIGN) {</span>
<span class="nc" id="L13921">                            MegaMek.getLogger().error(&quot;Expected a COMMAND_CFR_AMS_ASSIGN CFR packet, received: &quot; + cfrType);</span>
<span class="nc" id="L13922">                            throw new IllegalStateException();</span>
                        }
<span class="nc" id="L13924">                        Integer waaIndex =</span>
<span class="nc" id="L13925">                                (Integer)rp.packet.getData()[1];</span>
<span class="nc bnc" id="L13926" title="All 2 branches missed.">                        if (waaIndex != null) {</span>
<span class="nc" id="L13927">                            targetedWAA = vAttacksInArc.get(waaIndex);</span>
                        }
                    }
<span class="nc" id="L13930">                }</span>
            }

<span class="nc bnc" id="L13933" title="All 2 branches missed.">            if (targetedWAA != null) {</span>
<span class="nc" id="L13934">                targetedWAA.addCounterEquipment(ams);</span>
<span class="nc" id="L13935">                amsTargets.add(targetedWAA);</span>
            }
<span class="nc" id="L13937">        }</span>
<span class="nc" id="L13938">    }</span>

    /**
     * Convenience method for computing a mapping of which Coords are
     * &quot;protected&quot; by an APDS. Protection implies that the coords is within the
     * range/arc of an active APDS.
     *
     * @return
     */
    private Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; getAPDSProtectedCoords() {
        // Get all of the coords that would be protected by APDS
<span class="nc" id="L13949">        Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; apdsCoords = new Hashtable&lt;&gt;();</span>
<span class="nc bnc" id="L13950" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
            // Ignore Entitys without positions
<span class="nc bnc" id="L13952" title="All 2 branches missed.">            if (e.getPosition() == null) {</span>
<span class="nc" id="L13953">                continue;</span>
            }
<span class="nc" id="L13955">            Coords origPos = e.getPosition();</span>
<span class="nc bnc" id="L13956" title="All 2 branches missed.">            for (Mounted ams : e.getActiveAMS()) {</span>
                // Ignore non-APDS AMS
<span class="nc bnc" id="L13958" title="All 2 branches missed.">                if (!ams.isAPDS()) {</span>
<span class="nc" id="L13959">                    continue;</span>
                }
                // Add the current hex as a defended location
<span class="nc" id="L13962">                List&lt;Mounted&gt; apdsList = apdsCoords.computeIfAbsent(origPos, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="nc" id="L13963">                apdsList.add(ams);</span>
                // Add each coords that is within arc/range as protected
<span class="nc" id="L13965">                int maxDist = 3;</span>
<span class="nc bnc" id="L13966" title="All 2 branches missed.">                if (e instanceof BattleArmor) {</span>
<span class="nc" id="L13967">                    int numTroopers = ((BattleArmor) e)</span>
<span class="nc" id="L13968">                            .getNumberActiverTroopers();</span>
<span class="nc bnc" id="L13969" title="All 3 branches missed.">                    switch (numTroopers) {</span>
                        case 1:
<span class="nc" id="L13971">                            maxDist = 1;</span>
<span class="nc" id="L13972">                            break;</span>
                        case 2:
                        case 3:
<span class="nc" id="L13975">                            maxDist = 2;</span>
                            break;
                    // Anything above is the same as the default
                    }
                }
<span class="nc bnc" id="L13980" title="All 2 branches missed.">                for (int dist = 1; dist &lt;= maxDist; dist++) {</span>
<span class="nc" id="L13981">                    List&lt;Coords&gt; coords = e.getPosition().allAtDistance(dist);</span>
<span class="nc bnc" id="L13982" title="All 2 branches missed.">                    for (Coords pos : coords) {</span>
                        // Check that we're in the right arc
<span class="nc bnc" id="L13984" title="All 2 branches missed.">                        if (Compute.isInArc(game, e.getId(), e.getEquipmentNum(ams),</span>
<span class="nc" id="L13985">                                new HexTarget(pos, game.getBoard(), HexTarget.TYPE_HEX_CLEAR))) {</span>
<span class="nc" id="L13986">                            apdsList = apdsCoords.computeIfAbsent(pos, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="nc" id="L13987">                            apdsList.add(ams);</span>
                        }
<span class="nc" id="L13989">                    }</span>
                }

<span class="nc" id="L13992">            }</span>
<span class="nc" id="L13993">        }</span>
<span class="nc" id="L13994">        return apdsCoords;</span>
    }

    /**
     * Called at the start and end of movement. Determines if an entity
     * has been detected and/or had a firing solution calculated
     */
    private void detectSpacecraft() {
        // Don't bother if we're not in space or if the game option isn't on
<span class="nc bnc" id="L14003" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14004" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)) {</span>
<span class="nc" id="L14005">            return;</span>
        }

        //Now, run the detection rolls
<span class="nc bnc" id="L14009" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
            //Don't process for invalid units
            //in the case of squadrons and transports, we want the 'host'
            //unit, not the component entities
<span class="nc bnc" id="L14013" title="All 2 branches missed.">            if (detector.getPosition() == null</span>
<span class="nc bnc" id="L14014" title="All 2 branches missed.">                    || detector.isDestroyed()</span>
<span class="nc bnc" id="L14015" title="All 2 branches missed.">                    || detector.isDoomed()</span>
<span class="nc bnc" id="L14016" title="All 2 branches missed.">                    || detector.isOffBoard()</span>
<span class="nc bnc" id="L14017" title="All 2 branches missed.">                    || detector.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14018" title="All 2 branches missed.">                    || detector.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14019">                continue;</span>
            }
<span class="nc bnc" id="L14021" title="All 2 branches missed.">            for (Entity target : game.getEntitiesVector()) {</span>
                //Once a target is detected, we don't need to detect it again
<span class="nc bnc" id="L14023" title="All 2 branches missed.">                if (detector.hasSensorContactFor(target.getId())) {</span>
<span class="nc" id="L14024">                    continue;</span>
                }
                //Don't process for invalid units
                //in the case of squadrons and transports, we want the 'host'
                //unit, not the component entities
<span class="nc bnc" id="L14029" title="All 2 branches missed.">                if (target.getPosition() == null</span>
<span class="nc bnc" id="L14030" title="All 2 branches missed.">                        || target.isDestroyed()</span>
<span class="nc bnc" id="L14031" title="All 2 branches missed.">                        || target.isDoomed()</span>
<span class="nc bnc" id="L14032" title="All 2 branches missed.">                        || target.isOffBoard()</span>
<span class="nc bnc" id="L14033" title="All 2 branches missed.">                        || target.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14034" title="All 2 branches missed.">                        || target.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14035">                    continue;</span>
                }
                // Only process for enemy units
<span class="nc bnc" id="L14038" title="All 2 branches missed.">                if (!detector.isEnemyOf(target)) {</span>
<span class="nc" id="L14039">                    continue;</span>
                }
                //If we successfully detect the enemy, add it to the appropriate detector's sensor contacts list
<span class="nc bnc" id="L14042" title="All 2 branches missed.">                if (Compute.calcSensorContact(game, detector, target)) {</span>
<span class="nc" id="L14043">                    game.getEntity(detector.getId()).addSensorContact(target.getId());</span>
                    //If detector is part of a C3 network, share the contact
<span class="nc bnc" id="L14045" title="All 2 branches missed.">                    if (detector.hasNavalC3()) {</span>
<span class="nc bnc" id="L14046" title="All 2 branches missed.">                        for (Entity c3NetMate : game.getC3NetworkMembers(detector)) {</span>
<span class="nc" id="L14047">                            game.getEntity(c3NetMate.getId()).addSensorContact(target.getId());</span>
<span class="nc" id="L14048">                        }</span>
                    }
                }
<span class="nc" id="L14051">            }</span>
<span class="nc" id="L14052">        }</span>
        //Now, run the firing solution calculations
<span class="nc bnc" id="L14054" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
            //Don't process for invalid units
            //in the case of squadrons and transports, we want the 'host'
            //unit, not the component entities
<span class="nc bnc" id="L14058" title="All 2 branches missed.">            if (detector.getPosition() == null</span>
<span class="nc bnc" id="L14059" title="All 2 branches missed.">                    || detector.isDestroyed()</span>
<span class="nc bnc" id="L14060" title="All 2 branches missed.">                    || detector.isDoomed()</span>
<span class="nc bnc" id="L14061" title="All 2 branches missed.">                    || detector.isOffBoard()</span>
<span class="nc bnc" id="L14062" title="All 2 branches missed.">                    || detector.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14063" title="All 2 branches missed.">                    || detector.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14064">                continue;</span>
            }
<span class="nc bnc" id="L14066" title="All 2 branches missed.">            for (int targetId : detector.getSensorContacts()) {</span>
<span class="nc" id="L14067">                Entity target = game.getEntity(targetId);</span>
                //if we already have a firing solution, no need to process a new one
<span class="nc bnc" id="L14069" title="All 2 branches missed.">                if (detector.hasFiringSolutionFor(targetId)) {</span>
<span class="nc" id="L14070">                    continue;</span>
                }
                //Don't process for invalid units
                //in the case of squadrons and transports, we want the 'host'
                //unit, not the component entities
<span class="nc bnc" id="L14075" title="All 2 branches missed.">                if (target == null</span>
<span class="nc bnc" id="L14076" title="All 2 branches missed.">                        || target.getPosition() == null</span>
<span class="nc bnc" id="L14077" title="All 2 branches missed.">                        || target.isDestroyed()</span>
<span class="nc bnc" id="L14078" title="All 2 branches missed.">                        || target.isDoomed()</span>
<span class="nc bnc" id="L14079" title="All 2 branches missed.">                        || target.isOffBoard()</span>
<span class="nc bnc" id="L14080" title="All 2 branches missed.">                        || target.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14081" title="All 2 branches missed.">                        || target.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14082">                    continue;</span>
                }
                // Only process for enemy units
<span class="nc bnc" id="L14085" title="All 2 branches missed.">                if (!detector.isEnemyOf(target)) {</span>
<span class="nc" id="L14086">                    continue;</span>
                }
                //If we successfully lock up the enemy, add it to the appropriate detector's firing solutions list
<span class="nc bnc" id="L14089" title="All 2 branches missed.">                if (Compute.calcFiringSolution(game, detector, target)) {</span>
<span class="nc" id="L14090">                    game.getEntity(detector.getId()).addFiringSolution(targetId);</span>
                }
<span class="nc" id="L14092">            }</span>
<span class="nc" id="L14093">        }</span>
<span class="nc" id="L14094">    }</span>

    /**
     * Called at the end of movement. Determines if an entity
     * has moved beyond sensor range
     */
    private void updateSpacecraftDetection() {
        // Don't bother if we're not in space or if the game option isn't on
<span class="nc bnc" id="L14102" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14103" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)) {</span>
<span class="nc" id="L14104">            return;</span>
        }
        //Run through our list of units and remove any entities from the plotting board that have moved out of range
<span class="nc bnc" id="L14107" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
<span class="nc" id="L14108">            Compute.updateFiringSolutions(game, detector);</span>
<span class="nc" id="L14109">            Compute.updateSensorContacts(game, detector);</span>
<span class="nc" id="L14110">        }</span>
<span class="nc" id="L14111">    }</span>

    /**
     * Checks to see if any units can detected hidden units.
     */
    private void detectHiddenUnits() {
        // If hidden units aren't on, nothing to do
<span class="nc bnc" id="L14118" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc" id="L14119">            return;</span>
        }
        // Get all hidden units
<span class="nc" id="L14122">        List&lt;Entity&gt; hiddenUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L14123" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L14124" title="All 2 branches missed.">            if (ent.isHidden()) {</span>
<span class="nc" id="L14125">                hiddenUnits.add(ent);</span>
            }
<span class="nc" id="L14127">        }</span>

        // If no one is hidden, there's nothing to do
<span class="nc bnc" id="L14130" title="All 2 branches missed.">        if (hiddenUnits.size() &lt; 1) {</span>
<span class="nc" id="L14131">            return;</span>
        }

<span class="nc" id="L14134">        Set&lt;Integer&gt; reportPlayers = new HashSet&lt;&gt;();</span>
        // See if any unit with a probe, detects any hidden units
<span class="nc bnc" id="L14136" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
<span class="nc" id="L14137">            int probeRange = detector.getBAPRange();</span>

            // Units without a position won't be able to detect
<span class="nc bnc" id="L14140" title="All 2 branches missed.">            if (detector.getPosition() == null) {</span>
<span class="nc" id="L14141">                continue;</span>
            }

<span class="nc bnc" id="L14144" title="All 2 branches missed.">            for (Entity detected : hiddenUnits) {</span>
                // Only detected enemy units
<span class="nc bnc" id="L14146" title="All 2 branches missed.">                if (!detector.isEnemyOf(detected)) {</span>
<span class="nc" id="L14147">                    continue;</span>
                }
                // Can't detect units without a position
<span class="nc bnc" id="L14150" title="All 2 branches missed.">                if (detected.getPosition() == null) {</span>
<span class="nc" id="L14151">                    continue;</span>
                }
                // Can only detect units within the probes range
<span class="nc" id="L14154">                int dist = detector.getPosition().distance(</span>
<span class="nc" id="L14155">                        detected.getPosition());</span>

                // An adjacent enemy unit will detect hidden units, TW pg 259
<span class="nc bnc" id="L14158" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; dist &gt; probeRange) {</span>
<span class="nc" id="L14159">                    continue;</span>
                }

                // Check for Void/Null Sig - only detected by Bloodhound probes
<span class="nc bnc" id="L14163" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; (detected instanceof Mech)) {</span>
<span class="nc" id="L14164">                    Mech m = (Mech)detected;</span>
<span class="nc bnc" id="L14165" title="All 4 branches missed.">                    if ((m.isVoidSigActive() || m.isNullSigActive())</span>
<span class="nc bnc" id="L14166" title="All 2 branches missed.">                            &amp;&amp; !detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14167">                        continue;</span>
                    }
                }

                // Check for Infantry stealth armor
<span class="nc bnc" id="L14172" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; (detected instanceof BattleArmor)) {</span>
<span class="nc" id="L14173">                    BattleArmor ba = (BattleArmor) detected;</span>
                    // Need Bloodhound to detect BA stealth armor
<span class="nc bnc" id="L14175" title="All 2 branches missed.">                    if (ba.isStealthy()</span>
<span class="nc bnc" id="L14176" title="All 2 branches missed.">                            &amp;&amp; !detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14177">                        continue;</span>
                    }
<span class="nc bnc" id="L14179" title="All 4 branches missed.">                } else if (dist &gt; 1 &amp;&amp; (detected instanceof Infantry)) {</span>
<span class="nc" id="L14180">                    Infantry inf = (Infantry) detected;</span>
                    // Can't detect sneaky infantry
<span class="nc bnc" id="L14182" title="All 2 branches missed.">                    if (inf.isStealthy()) {</span>
<span class="nc" id="L14183">                        continue;</span>
                    }
                    // Need bloodhound to detect non-sneaky inf
<span class="nc bnc" id="L14186" title="All 2 branches missed.">                    if (!detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14187">                        continue;</span>
                    }
                }

<span class="nc" id="L14191">                LosEffects los = LosEffects.calculateLos(game,</span>
<span class="nc" id="L14192">                        detector.getId(), detected);</span>
<span class="nc bnc" id="L14193" title="All 4 branches missed.">                if (los.canSee() || dist &lt;= 1) {</span>
<span class="nc" id="L14194">                    detected.setHidden(false);</span>
<span class="nc" id="L14195">                    entityUpdate(detected.getId());</span>
<span class="nc" id="L14196">                    Report r = new Report(9960);</span>
<span class="nc" id="L14197">                    r.addDesc(detector);</span>
<span class="nc" id="L14198">                    r.subject = detector.getId();</span>
<span class="nc" id="L14199">                    r.add(detected.getPosition().getBoardNum());</span>
<span class="nc" id="L14200">                    vPhaseReport.addElement(r);</span>
<span class="nc" id="L14201">                    Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L14202">                    reportPlayers.add(detector.getOwnerId());</span>
<span class="nc" id="L14203">                    reportPlayers.add(detected.getOwnerId());</span>
                }
<span class="nc" id="L14205">            }</span>
<span class="nc" id="L14206">        }</span>

<span class="nc bnc" id="L14208" title="All 4 branches missed.">        if (vPhaseReport.size() &gt; 0 &amp;&amp; game.getPhase() == Phase.PHASE_MOVEMENT</span>
<span class="nc bnc" id="L14209" title="All 2 branches missed.">                &amp;&amp; (game.getTurnIndex() + 1) &lt; game.getTurnVector().size()) {</span>
<span class="nc bnc" id="L14210" title="All 2 branches missed.">            for (Integer playerId : reportPlayers) {</span>
<span class="nc" id="L14211">                send(playerId, createSpecialReportPacket());</span>
<span class="nc" id="L14212">            }</span>
        }
<span class="nc" id="L14214">    }</span>

    /**
     * Called to what players can see what units. This is used to determine who
     * can see what in double blind reports.
     */
    private void resolveWhatPlayersCanSeeWhatUnits() {
<span class="nc" id="L14221">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L14222" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L14223">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L14224">                    .getEntitiesVector());</span>
        }
<span class="nc" id="L14226">        Map&lt;EntityTargetPair, LosEffects&gt; losCache = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L14227" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // We are hidden once again!
<span class="nc" id="L14229">            entity.clearSeenBy();</span>
<span class="nc" id="L14230">            entity.clearDetectedBy();</span>
            // Handle visual spotting
<span class="nc bnc" id="L14232" title="All 2 branches missed.">            for (IPlayer p : whoCanSee(entity, false, losCache)) {</span>
<span class="nc" id="L14233">                entity.addBeenSeenBy(p);</span>
<span class="nc" id="L14234">            }</span>
            // Handle detection by sensors
<span class="nc bnc" id="L14236" title="All 2 branches missed.">            for (IPlayer p : whoCanDetect(entity, allECMInfo, losCache)) {</span>
<span class="nc" id="L14237">                    entity.addBeenDetectedBy(p);</span>
<span class="nc" id="L14238">            }</span>
<span class="nc" id="L14239">        }</span>
<span class="nc" id="L14240">    }</span>

    /**
     * Called during the weapons fire phase. Resolves anything other than
     * weapons fire that happens. Torso twists, for example.
     */
    private void resolveAllButWeaponAttacks() {
<span class="nc" id="L14247">        Vector&lt;EntityAction&gt; triggerPodActions = new Vector&lt;&gt;();</span>
        // loop through actions and handle everything we expect except attacks
<span class="nc" id="L14249">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L14250" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L14251">            EntityAction ea = i.nextElement();</span>
<span class="nc" id="L14252">            Entity entity = game.getEntity(ea.getEntityId());</span>
<span class="nc bnc" id="L14253" title="All 2 branches missed.">            if (ea instanceof TorsoTwistAction) {</span>
<span class="nc" id="L14254">                TorsoTwistAction tta = (TorsoTwistAction) ea;</span>
<span class="nc bnc" id="L14255" title="All 2 branches missed.">                if (entity.canChangeSecondaryFacing()) {</span>
<span class="nc" id="L14256">                    entity.setSecondaryFacing(tta.getFacing());</span>
<span class="nc" id="L14257">                    entity.postProcessFacingChange();</span>
                }
<span class="nc bnc" id="L14259" title="All 2 branches missed.">            } else if (ea instanceof FlipArmsAction) {</span>
<span class="nc" id="L14260">                FlipArmsAction faa = (FlipArmsAction) ea;</span>
<span class="nc" id="L14261">                entity.setArmsFlipped(faa.getIsFlipped());</span>
<span class="nc bnc" id="L14262" title="All 2 branches missed.">            } else if (ea instanceof FindClubAction) {</span>
<span class="nc" id="L14263">                resolveFindClub(entity);</span>
<span class="nc bnc" id="L14264" title="All 2 branches missed.">            } else if (ea instanceof UnjamAction) {</span>
<span class="nc" id="L14265">                resolveUnjam(entity);</span>
<span class="nc bnc" id="L14266" title="All 2 branches missed.">            } else if (ea instanceof ClearMinefieldAction) {</span>
<span class="nc" id="L14267">                resolveClearMinefield(entity,</span>
<span class="nc" id="L14268">                                      ((ClearMinefieldAction) ea).getMinefield());</span>
<span class="nc bnc" id="L14269" title="All 2 branches missed.">            } else if (ea instanceof TriggerAPPodAction) {</span>
<span class="nc" id="L14270">                TriggerAPPodAction tapa = (TriggerAPPodAction) ea;</span>

                // Don't trigger the same pod twice.
<span class="nc bnc" id="L14273" title="All 2 branches missed.">                if (!triggerPodActions.contains(tapa)) {</span>
<span class="nc" id="L14274">                    triggerAPPod(entity, tapa.getPodId());</span>
<span class="nc" id="L14275">                    triggerPodActions.addElement(tapa);</span>
                } else {
<span class="nc" id="L14277">                    MegaMek.getLogger().error(&quot;AP Pod #&quot; + tapa.getPodId() + &quot; on &quot; + entity.getDisplayName()</span>
                                    + &quot; was already triggered this round!!&quot;);
                }
<span class="nc bnc" id="L14280" title="All 2 branches missed.">            } else if (ea instanceof TriggerBPodAction) {</span>
<span class="nc" id="L14281">                TriggerBPodAction tba = (TriggerBPodAction) ea;</span>

                // Don't trigger the same pod twice.
<span class="nc bnc" id="L14284" title="All 2 branches missed.">                if (!triggerPodActions.contains(tba)) {</span>
<span class="nc" id="L14285">                    triggerBPod(entity, tba.getPodId(),</span>
<span class="nc" id="L14286">                                game.getEntity(tba.getTargetId()));</span>
<span class="nc" id="L14287">                    triggerPodActions.addElement(tba);</span>
                } else {
<span class="nc" id="L14289">                    MegaMek.getLogger().error(&quot;B Pod #&quot; + tba.getPodId() + &quot; on &quot; + entity.getDisplayName()</span>
                                    + &quot; was already triggered this round!!&quot;);
                }
<span class="nc bnc" id="L14292" title="All 2 branches missed.">            } else if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L14293">                SearchlightAttackAction saa = (SearchlightAttackAction) ea;</span>
<span class="nc" id="L14294">                addReport(saa.resolveAction(game));</span>
<span class="nc bnc" id="L14295" title="All 2 branches missed.">            } else if (ea instanceof UnjamTurretAction) {</span>
<span class="nc bnc" id="L14296" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L14297">                    ((Tank) entity).unjamTurret(((Tank) entity).getLocTurret());</span>
<span class="nc" id="L14298">                    ((Tank) entity)</span>
<span class="nc" id="L14299">                            .unjamTurret(((Tank) entity).getLocTurret2());</span>
<span class="nc" id="L14300">                    Report r = new Report(3033);</span>
<span class="nc" id="L14301">                    r.addDesc(entity);</span>
<span class="nc" id="L14302">                    addReport(r);</span>
<span class="nc" id="L14303">                } else {</span>
<span class="nc" id="L14304">                    MegaMek.getLogger().error(&quot;Non-Tank tried to unjam turret&quot;);</span>
                }
<span class="nc bnc" id="L14306" title="All 2 branches missed.">            } else if (ea instanceof RepairWeaponMalfunctionAction) {</span>
<span class="nc bnc" id="L14307" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L14308">                    Mounted m = entity</span>
<span class="nc" id="L14309">                            .getEquipment(((RepairWeaponMalfunctionAction) ea)</span>
<span class="nc" id="L14310">                                                  .getWeaponId());</span>
<span class="nc" id="L14311">                    m.setJammed(false);</span>
<span class="nc" id="L14312">                    ((Tank) entity).getJammedWeapons().remove(m);</span>
<span class="nc" id="L14313">                    Report r = new Report(3034);</span>
<span class="nc" id="L14314">                    r.subject = entity.getId();</span>
<span class="nc" id="L14315">                    r.addDesc(entity);</span>
<span class="nc" id="L14316">                    r.add(m.getName());</span>
<span class="nc" id="L14317">                    addReport(r);</span>
<span class="nc" id="L14318">                } else {</span>
<span class="nc" id="L14319">                    MegaMek.getLogger().error(&quot;Non-Tank tried to repair weapon malfunction&quot;);</span>
                }
<span class="nc bnc" id="L14321" title="All 2 branches missed.">            } else if (ea instanceof DisengageAction) {</span>
<span class="nc" id="L14322">                MovePath path = new MovePath(game, entity);</span>
<span class="nc" id="L14323">                path.addStep(MoveStepType.FLEE);</span>
<span class="nc" id="L14324">                addReport(processLeaveMap(path, false, -1));</span>
            }
<span class="nc" id="L14326">        }</span>
<span class="nc" id="L14327">    }</span>

    /*
     * Called during the weapons firing phase to initiate self destruction.
     */
    private void resolveSelfDestructions() {
<span class="nc" id="L14333">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L14335" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L14336" title="All 4 branches missed.">            if (e.getSelfDestructInitiated() &amp;&amp; e.hasEngine()) {</span>
<span class="nc" id="L14337">                r = new Report(6166, Report.PUBLIC);</span>
<span class="nc" id="L14338">                int target = e.getCrew().getPiloting();</span>
<span class="nc" id="L14339">                int roll = e.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L14340">                r.subject = e.getId();</span>
<span class="nc" id="L14341">                r.addDesc(e);</span>
<span class="nc" id="L14342">                r.indent();</span>
<span class="nc" id="L14343">                r.add(target);</span>
<span class="nc" id="L14344">                r.add(roll);</span>
<span class="nc bnc" id="L14345" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14346">                    r.choose(true);</span>
                } else {
<span class="nc" id="L14348">                    r.choose(false);</span>
                }
<span class="nc" id="L14350">                vDesc.add(r);</span>

                // Blow it up...
<span class="nc bnc" id="L14353" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14354">                    int engineRating = e.getEngine().getRating();</span>
<span class="nc" id="L14355">                    r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L14356">                    r.subject = e.getId();</span>
<span class="nc" id="L14357">                    r.indent(2);</span>
<span class="nc" id="L14358">                    vDesc.add(r);</span>

<span class="nc bnc" id="L14360" title="All 2 branches missed.">                    if (e instanceof Mech) {</span>
<span class="nc" id="L14361">                        Mech mech = (Mech) e;</span>
<span class="nc bnc" id="L14362" title="All 2 branches missed.">                        if (mech.isAutoEject()</span>
<span class="nc bnc" id="L14363" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION) || (game
<span class="nc bnc" id="L14365" title="All 2 branches missed.">                                        .getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION) &amp;&amp; mech
<span class="nc bnc" id="L14367" title="All 2 branches missed.">                                        .isCondEjectEngine()))) {</span>
<span class="nc" id="L14368">                            vDesc.addAll(ejectEntity(e, true));</span>
                        }
                    }
<span class="nc" id="L14371">                    e.setSelfDestructedThisTurn(true);</span>
<span class="nc" id="L14372">                    doFusionEngineExplosion(engineRating, e.getPosition(),</span>
                            vDesc, null);
<span class="nc" id="L14374">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L14375">                    r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L14376">                    r.subject = e.getId();</span>
<span class="nc" id="L14377">                    r.indent(2);</span>
<span class="nc" id="L14378">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L14379">                    vDesc.add(r);</span>
                }
<span class="nc" id="L14381">                e.setSelfDestructInitiated(false);</span>
            }
<span class="nc" id="L14383">        }</span>
<span class="nc" id="L14384">        addReport(vDesc);</span>
<span class="nc" id="L14385">    }</span>

    private void reportGhostTargetRolls() {
        // run through an enumeration of deployed game entities. If they have
        // ghost targets, then check the roll
        // and report it
        Report r;
<span class="nc bnc" id="L14392" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L14393">            Entity ent = e.next();</span>
<span class="nc bnc" id="L14394" title="All 4 branches missed.">            if (ent.isDeployed() &amp;&amp; ent.hasGhostTargets(false)) {</span>
<span class="nc" id="L14395">                r = new Report(3630);</span>
<span class="nc" id="L14396">                r.subject = ent.getId();</span>
<span class="nc" id="L14397">                r.addDesc(ent);</span>
                // Ghost target mod is +3 per errata
<span class="nc" id="L14399">                int target = ent.getCrew().getPiloting() + 3;</span>
<span class="nc bnc" id="L14400" title="All 2 branches missed.">                if (ent.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L14401">                    target = ent.getCrew().getGunnery() + 3;</span>
                }
<span class="nc" id="L14403">                int roll = ent.getGhostTargetRoll();</span>
<span class="nc" id="L14404">                r.add(target);</span>
<span class="nc" id="L14405">                r.add(roll);</span>
<span class="nc bnc" id="L14406" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14407">                    r.choose(true);</span>
                } else {
<span class="nc" id="L14409">                    r.choose(false);</span>
                }
<span class="nc" id="L14411">                addReport(r);</span>
            }
<span class="nc" id="L14413">        }</span>
<span class="nc" id="L14414">        addNewLines();</span>
<span class="nc" id="L14415">    }</span>

    private void reportLargeCraftECCMRolls() {
        // run through an enumeration of deployed game entities. If they are
        // large craft in space, then check the roll
        // and report it
<span class="nc bnc" id="L14421" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14422" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L14423">            return;</span>
        }
        Report r;
<span class="nc bnc" id="L14426" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L14427">            Entity ent = e.next();</span>
<span class="nc bnc" id="L14428" title="All 4 branches missed.">            if (ent.isDeployed() &amp;&amp; ent.isLargeCraft()) {</span>
<span class="nc" id="L14429">                r = new Report(3635);</span>
<span class="nc" id="L14430">                r.subject = ent.getId();</span>
<span class="nc" id="L14431">                r.addDesc(ent);</span>
<span class="nc" id="L14432">                int target = ((Aero) ent).getECCMTarget();</span>
<span class="nc" id="L14433">                int roll = ((Aero) ent).getECCMRoll();</span>
<span class="nc" id="L14434">                r.add(roll);</span>
<span class="nc" id="L14435">                r.add(target);</span>
<span class="nc" id="L14436">                int mod = ((Aero) ent).getECCMBonus();</span>
<span class="nc" id="L14437">                r.add(mod);</span>
<span class="nc" id="L14438">                addReport(r);</span>
            }
<span class="nc" id="L14440">        }</span>
<span class="nc" id="L14441">    }</span>

    private void resolveClearMinefield(Entity ent, Minefield mf) {

<span class="nc bnc" id="L14445" title="All 6 branches missed.">        if ((null == mf) || (null == ent) || ent.isDoomed()</span>
<span class="nc bnc" id="L14446" title="All 2 branches missed.">            || ent.isDestroyed()) {</span>
<span class="nc" id="L14447">            return;</span>
        }

<span class="nc" id="L14450">        Coords pos = mf.getCoords();</span>
<span class="nc" id="L14451">        int clear = Minefield.CLEAR_NUMBER_INFANTRY;</span>
<span class="nc" id="L14452">        int boom = Minefield.CLEAR_NUMBER_INFANTRY_ACCIDENT;</span>

<span class="nc" id="L14454">        Report r = new Report(2245);</span>
        // Does the entity has a minesweeper?
<span class="nc bnc" id="L14456" title="All 2 branches missed.">        if ((ent instanceof BattleArmor)) {</span>
<span class="nc" id="L14457">            BattleArmor ba = (BattleArmor)ent;</span>
<span class="nc" id="L14458">            String mcmName = BattleArmor.MANIPULATOR_TYPE_STRINGS</span>
                    [BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE];
<span class="nc bnc" id="L14460" title="All 2 branches missed.">            if (ba.getLeftManipulatorName().equals(mcmName)) {</span>
<span class="nc" id="L14461">                clear = Minefield.CLEAR_NUMBER_BA_SWEEPER;</span>
<span class="nc" id="L14462">                boom = Minefield.CLEAR_NUMBER_BA_SWEEPER_ACCIDENT;</span>
<span class="nc" id="L14463">                r = new Report(2246);</span>
            }
<span class="nc bnc" id="L14465" title="All 2 branches missed.">        } else if (ent instanceof Infantry) { // Check Minesweeping Engineers</span>
<span class="nc" id="L14466">            Infantry inf = (Infantry) ent;</span>
<span class="nc bnc" id="L14467" title="All 2 branches missed.">            if (inf.hasSpecialization(Infantry.MINE_ENGINEERS)) {</span>
<span class="nc" id="L14468">                clear = Minefield.CLEAR_NUMBER_INF_ENG;</span>
<span class="nc" id="L14469">                boom = Minefield.CLEAR_NUMBER_INF_ENG_ACCIDENT;</span>
<span class="nc" id="L14470">                r = new Report(2247);</span>
            }
        }
        // mine clearing roll
<span class="nc" id="L14474">        r.subject = ent.getId();</span>
<span class="nc" id="L14475">        r.add(ent.getShortName(), true);</span>
<span class="nc" id="L14476">        r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L14477">        r.add(pos.getBoardNum(), true);</span>
<span class="nc" id="L14478">        addReport(r);</span>

<span class="nc bnc" id="L14480" title="All 2 branches missed.">        if (clearMinefield(mf, ent, clear, boom, vPhaseReport)) {</span>
<span class="nc" id="L14481">            removeMinefield(mf);</span>
        }
        // some mines might have blown up
<span class="nc" id="L14484">        resetMines();</span>

<span class="nc" id="L14486">        addNewLines();</span>
<span class="nc" id="L14487">    }</span>

    /**
     * Called during the fire phase to resolve all (and only) weapon attacks
     */
    private void resolveOnlyWeaponAttacks() {
        // loop through received attack actions, getting attack handlers
<span class="nc" id="L14494">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L14495" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L14496">            EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L14497" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L14498">                WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L14499">                Entity ae = game.getEntity(waa.getEntityId());</span>
<span class="nc" id="L14500">                Mounted m = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L14501">                Weapon w = (Weapon) m.getType();</span>
                // Track attacks original target, for things like swarm LRMs
<span class="nc" id="L14503">                waa.setOriginalTargetId(waa.getTargetId());</span>
<span class="nc" id="L14504">                waa.setOriginalTargetType(waa.getTargetType());</span>
<span class="nc" id="L14505">                AttackHandler ah = w.fire(waa, game, this);</span>
<span class="nc bnc" id="L14506" title="All 2 branches missed.">                if (ah != null) {</span>
<span class="nc" id="L14507">                    ah.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L14508">                    ah.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L14509">                    game.addAttack(ah);</span>
                }
            }
<span class="nc" id="L14512">        }</span>
        // and clear the attacks Vector
<span class="nc" id="L14514">        game.resetActions();</span>
<span class="nc" id="L14515">    }</span>

    /**
     * Trigger the indicated AP Pod of the entity.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; triggering the AP Pod.
     * @param podId  the &lt;code&gt;int&lt;/code&gt; ID of the AP Pod.
     */
    private void triggerAPPod(Entity entity, int podId) {
        // Get the mount for this pod.
<span class="nc" id="L14525">        Mounted mount = entity.getEquipment(podId);</span>

        // Confirm that this is, indeed, an AP Pod.
<span class="nc bnc" id="L14528" title="All 2 branches missed.">        if (null == mount) {</span>
<span class="nc" id="L14529">            MegaMek.getLogger().error(&quot;Expecting to find an AP Pod at &quot; + podId + &quot; on the unit, &quot; + entity.getDisplayName()</span>
                            + &quot; but found NO equipment at all!!!&quot;);
<span class="nc" id="L14531">            return;</span>
        }
<span class="nc" id="L14533">        EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L14534" title="All 4 branches missed.">        if (!(equip instanceof MiscType) || !equip.hasFlag(MiscType.F_AP_POD)) {</span>
<span class="nc" id="L14535">            MegaMek.getLogger().error(&quot;Expecting to find an AP Pod at &quot; + podId + &quot; on the unit, &quot;+ entity.getDisplayName()</span>
<span class="nc" id="L14536">                            + &quot; but found &quot; + equip.getName() + &quot; instead!!!&quot;);</span>
<span class="nc" id="L14537">            return;</span>
        }

        // Now confirm that the entity can trigger the pod.
        // Ignore the &quot;used this round&quot; flag.
<span class="nc" id="L14542">        boolean oldFired = mount.isUsedThisRound();</span>
<span class="nc" id="L14543">        mount.setUsedThisRound(false);</span>
<span class="nc" id="L14544">        boolean canFire = mount.canFire();</span>
<span class="nc" id="L14545">        mount.setUsedThisRound(oldFired);</span>
<span class="nc bnc" id="L14546" title="All 2 branches missed.">        if (!canFire) {</span>
<span class="nc" id="L14547">            MegaMek.getLogger().error(&quot;Can not trigger the AP Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14548">                    + entity.getDisplayName() + &quot;!!!&quot;);</span>
<span class="nc" id="L14549">            return;</span>
        }

        Report r;

        // Mark the pod as fired and log the action.
<span class="nc" id="L14555">        mount.setFired(true);</span>
<span class="nc" id="L14556">        r = new Report(3010);</span>
<span class="nc" id="L14557">        r.newlines = 0;</span>
<span class="nc" id="L14558">        r.subject = entity.getId();</span>
<span class="nc" id="L14559">        r.addDesc(entity);</span>
<span class="nc" id="L14560">        addReport(r);</span>

        // Walk through ALL entities in the triggering entity's hex.
<span class="nc bnc" id="L14563" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector(entity.getPosition())) {</span>
            // Is this an unarmored infantry platoon?
<span class="nc bnc" id="L14565" title="All 2 branches missed.">            if (target.isConventionalInfantry()) {</span>
                // Roll d6-1 for damage.
<span class="nc" id="L14567">                final int damage = Math.max(1, Compute.d6() - 1);</span>

                // Damage the platoon.
<span class="nc" id="L14570">                addReport(damageEntity(target, new HitData(Infantry.LOC_INFANTRY), damage));</span>

                // Damage from AP Pods is applied immediately.
<span class="nc" id="L14573">                target.applyDamage();</span>
<span class="nc" id="L14574">            } // End target-is-unarmored</span>

            // Nope, the target is immune.
            // Don't make a log entry for the triggering entity.
<span class="nc bnc" id="L14578" title="All 2 branches missed.">            else if (!entity.equals(target)) {</span>
<span class="nc" id="L14579">                r = new Report(3020);</span>
<span class="nc" id="L14580">                r.indent(2);</span>
<span class="nc" id="L14581">                r.subject = target.getId();</span>
<span class="nc" id="L14582">                r.addDesc(target);</span>
<span class="nc" id="L14583">                addReport(r);</span>
            }

<span class="nc" id="L14586">        } // Check the next entity in the triggering entity's hex.</span>
<span class="nc" id="L14587">    }</span>

    /**
     * Trigger the indicated B Pod of the entity.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; triggering the B Pod.
     * @param podId  the &lt;code&gt;int&lt;/code&gt; ID of the B Pod.
     */
    private void triggerBPod(Entity entity, int podId, Entity target) {
        // Get the mount for this pod.
<span class="nc" id="L14597">        Mounted mount = entity.getEquipment(podId);</span>

        // Confirm that this is, indeed, an Anti-BA Pod.
<span class="nc bnc" id="L14600" title="All 2 branches missed.">        if (null == mount) {</span>
<span class="nc" id="L14601">            MegaMek.getLogger().error(&quot;Expecting to find an B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14602">                    + entity.getDisplayName() + &quot; but found NO equipment at all!!!&quot;);</span>
<span class="nc" id="L14603">            return;</span>
        }
<span class="nc" id="L14605">        EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L14606" title="All 4 branches missed.">        if (!(equip instanceof WeaponType) || !equip.hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L14607">            MegaMek.getLogger().error(&quot;Expecting to find an B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14608">                    + entity.getDisplayName() + &quot; but found &quot; + equip.getName() + &quot; instead!!!&quot;);</span>
<span class="nc" id="L14609">            return;</span>
        }

        // Now confirm that the entity can trigger the pod.
        // Ignore the &quot;used this round&quot; flag.
<span class="nc" id="L14614">        boolean oldFired = mount.isUsedThisRound();</span>
<span class="nc" id="L14615">        mount.setUsedThisRound(false);</span>
<span class="nc" id="L14616">        boolean canFire = mount.canFire();</span>
<span class="nc" id="L14617">        mount.setUsedThisRound(oldFired);</span>
<span class="nc bnc" id="L14618" title="All 2 branches missed.">        if (!canFire) {</span>
<span class="nc" id="L14619">            MegaMek.getLogger().error(&quot;Can not trigger the B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14620">                    + entity.getDisplayName() + &quot;!!!&quot;);</span>
<span class="nc" id="L14621">            return;</span>
        }

        Report r;

        // Mark the pod as fired and log the action.
<span class="nc" id="L14627">        mount.setFired(true);</span>
<span class="nc" id="L14628">        r = new Report(3011);</span>
<span class="nc" id="L14629">        r.newlines = 0;</span>
<span class="nc" id="L14630">        r.subject = entity.getId();</span>
<span class="nc" id="L14631">        r.addDesc(entity);</span>
<span class="nc" id="L14632">        addReport(r);</span>

        // Is this an unarmored infantry platoon?
<span class="nc bnc" id="L14635" title="All 2 branches missed.">        if (target.isConventionalInfantry()) {</span>
            // Roll d6 for damage.
<span class="nc" id="L14637">            final int damage = Compute.d6();</span>

            // Damage the platoon.
<span class="nc" id="L14640">            addReport(damageEntity(target, new HitData(Infantry.LOC_INFANTRY), damage));</span>

            // Damage from AP Pods is applied immediately.
<span class="nc" id="L14643">            target.applyDamage();</span>
<span class="nc bnc" id="L14644" title="All 2 branches missed.">        } else if (target instanceof BattleArmor) {</span>
            // 20 damage in 5 point clusters
<span class="nc" id="L14646">            final int damage = 5;</span>

            // Damage the squad.
<span class="nc" id="L14649">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14650">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14651">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14652">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>

            // Damage from B Pods is applied immediately.
<span class="nc" id="L14655">            target.applyDamage();</span>
<span class="nc bnc" id="L14656" title="All 2 branches missed.">        } else if (!entity.equals(target)) {</span>
            // Nope, the target is immune.
            // Don't make a log entry for the triggering entity.
<span class="nc" id="L14659">            r = new Report(3020);</span>
<span class="nc" id="L14660">            r.indent(2);</span>
<span class="nc" id="L14661">            r.subject = target.getId();</span>
<span class="nc" id="L14662">            r.addDesc(target);</span>
<span class="nc" id="L14663">            addReport(r);</span>
        }
<span class="nc" id="L14665">    }</span>

    /**
     * Resolve an Unjam Action object
     */
    private void resolveUnjam(Entity entity) {
        Report r;
<span class="nc" id="L14672">        final int TN = entity.getCrew().getGunnery() + 3;</span>
<span class="nc bnc" id="L14673" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L14674">            r = new Report(3026);</span>
        } else {
<span class="nc" id="L14676">            r = new Report(3025);</span>
        }
<span class="nc" id="L14678">        r.subject = entity.getId();</span>
<span class="nc" id="L14679">        r.addDesc(entity);</span>
<span class="nc" id="L14680">        addReport(r);</span>
<span class="nc bnc" id="L14681" title="All 2 branches missed.">        for (Mounted mounted : entity.getTotalWeaponList()) {</span>
<span class="nc bnc" id="L14682" title="All 4 branches missed.">            if (mounted.isJammed() &amp;&amp; !mounted.isDestroyed()) {</span>
<span class="nc" id="L14683">                WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L14684" title="All 2 branches missed.">                if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L14685">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14686">                    r = new Report(3030);</span>
<span class="nc" id="L14687">                    r.indent();</span>
<span class="nc" id="L14688">                    r.subject = entity.getId();</span>
<span class="nc" id="L14689">                    r.add(wtype.getName());</span>
<span class="nc" id="L14690">                    r.add(TN);</span>
<span class="nc" id="L14691">                    r.add(roll);</span>
<span class="nc bnc" id="L14692" title="All 2 branches missed.">                    if (roll &gt;= TN) {</span>
<span class="nc" id="L14693">                        r.choose(true);</span>
<span class="nc" id="L14694">                        mounted.setJammed(false);</span>
                    } else {
<span class="nc" id="L14696">                        r.choose(false);</span>
                    }
<span class="nc" id="L14698">                    addReport(r);</span>
                }
                // Unofficial option to unjam UACs, ACs, and LACs like Rotary
                // Autocannons
<span class="nc bnc" id="L14702" title="All 2 branches missed.">                if (((wtype.getAmmoType() == AmmoType.T_AC_ULTRA)</span>
<span class="nc bnc" id="L14703" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)</span>
<span class="nc bnc" id="L14704" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC)</span>
<span class="nc bnc" id="L14705" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L14706" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_PAC)</span>
<span class="nc bnc" id="L14707" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_LAC))</span>
<span class="nc bnc" id="L14708" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L14709">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14710">                    r = new Report(3030);</span>
<span class="nc" id="L14711">                    r.indent();</span>
<span class="nc" id="L14712">                    r.subject = entity.getId();</span>
<span class="nc" id="L14713">                    r.add(wtype.getName());</span>
<span class="nc" id="L14714">                    r.add(TN);</span>
<span class="nc" id="L14715">                    r.add(roll);</span>
<span class="nc bnc" id="L14716" title="All 2 branches missed.">                    if (roll &gt;= TN) {</span>
<span class="nc" id="L14717">                        r.choose(true);</span>
<span class="nc" id="L14718">                        mounted.setJammed(false);</span>
                    } else {
<span class="nc" id="L14720">                        r.choose(false);</span>
                    }
<span class="nc" id="L14722">                    addReport(r);</span>
                }
            }
<span class="nc" id="L14725">        }</span>
<span class="nc" id="L14726">    }</span>

    private void resolveFindClub(Entity entity) {
<span class="nc" id="L14729">        EquipmentType clubType = null;</span>

<span class="nc" id="L14731">        entity.setFindingClub(true);</span>

        // Get the entity's current hex.
<span class="nc" id="L14734">        Coords coords = entity.getPosition();</span>
<span class="nc" id="L14735">        IHex curHex = game.getBoard().getHex(coords);</span>

        Report r;

        // Is there a blown off arm in the hex?
<span class="nc bnc" id="L14740" title="All 2 branches missed.">        if (curHex.terrainLevel(Terrains.ARMS) &gt; 0) {</span>
<span class="nc" id="L14741">            clubType = EquipmentType.get(EquipmentTypeLookup.LIMB_CLUB);</span>
<span class="nc" id="L14742">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L14743">                    Terrains.ARMS, curHex.terrainLevel(Terrains.ARMS) - 1));</span>
<span class="nc" id="L14744">            sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L14745">            r = new Report(3035);</span>
<span class="nc" id="L14746">            r.subject = entity.getId();</span>
<span class="nc" id="L14747">            r.addDesc(entity);</span>
<span class="nc" id="L14748">            addReport(r);</span>
        }
        // Is there a blown off leg in the hex?
<span class="nc bnc" id="L14751" title="All 2 branches missed.">        else if (curHex.terrainLevel(Terrains.LEGS) &gt; 0) {</span>
<span class="nc" id="L14752">            clubType = EquipmentType.get(EquipmentTypeLookup.LIMB_CLUB);</span>
<span class="nc" id="L14753">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L14754">                    Terrains.LEGS, curHex.terrainLevel(Terrains.LEGS) - 1));</span>
<span class="nc" id="L14755">            sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L14756">            r = new Report(3040);</span>
<span class="nc" id="L14757">            r.subject = entity.getId();</span>
<span class="nc" id="L14758">            r.addDesc(entity);</span>
<span class="nc" id="L14759">            addReport(r);</span>
        }

        // Is there the rubble of a medium, heavy,
        // or hardened building in the hex?
<span class="nc bnc" id="L14764" title="All 2 branches missed.">        else if (Building.LIGHT &lt; curHex.terrainLevel(Terrains.RUBBLE)) {</span>

            // Finding a club is not guaranteed. The chances are
            // based on the type of building that produced the
            // rubble.
<span class="nc" id="L14769">            boolean found = false;</span>
<span class="nc" id="L14770">            int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L14771" title="All 5 branches missed.">            switch (curHex.terrainLevel(Terrains.RUBBLE)) {</span>
                case Building.MEDIUM:
<span class="nc bnc" id="L14773" title="All 2 branches missed.">                    if (roll &gt;= 7) {</span>
<span class="nc" id="L14774">                        found = true;</span>
                    }
                    break;
                case Building.HEAVY:
<span class="nc bnc" id="L14778" title="All 2 branches missed.">                    if (roll &gt;= 6) {</span>
<span class="nc" id="L14779">                        found = true;</span>
                    }
                    break;
                case Building.HARDENED:
<span class="nc bnc" id="L14783" title="All 2 branches missed.">                    if (roll &gt;= 5) {</span>
<span class="nc" id="L14784">                        found = true;</span>
                    }
                    break;
                case Building.WALL:
<span class="nc bnc" id="L14788" title="All 2 branches missed.">                    if (roll &gt;= 13) {</span>
<span class="nc" id="L14789">                        found = true;</span>
                    }
                    break;
                default:
                    // we must be in ultra
<span class="nc bnc" id="L14794" title="All 2 branches missed.">                    if (roll &gt;= 4) {</span>
<span class="nc" id="L14795">                        found = true;</span>
                    }
            }

            // Let the player know if they found a club.
<span class="nc bnc" id="L14800" title="All 2 branches missed.">            if (found) {</span>
<span class="nc" id="L14801">                clubType = EquipmentType.get(EquipmentTypeLookup.GIRDER_CLUB);</span>
<span class="nc" id="L14802">                r = new Report(3045);</span>
<span class="nc" id="L14803">                r.subject = entity.getId();</span>
<span class="nc" id="L14804">                r.addDesc(entity);</span>
<span class="nc" id="L14805">                addReport(r);</span>
            } else {
                // Sorry, no club for you.
<span class="nc" id="L14808">                r = new Report(3050);</span>
<span class="nc" id="L14809">                r.subject = entity.getId();</span>
<span class="nc" id="L14810">                r.addDesc(entity);</span>
<span class="nc" id="L14811">                addReport(r);</span>
            }
<span class="nc" id="L14813">        }</span>

        // Are there woods in the hex?
<span class="nc bnc" id="L14816" title="All 2 branches missed.">        else if (curHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L14817" title="All 2 branches missed.">                 || curHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L14818">            clubType = EquipmentType.get(EquipmentTypeLookup.TREE_CLUB);</span>
<span class="nc" id="L14819">            r = new Report(3055);</span>
<span class="nc" id="L14820">            r.subject = entity.getId();</span>
<span class="nc" id="L14821">            r.addDesc(entity);</span>
<span class="nc" id="L14822">            addReport(r);</span>
        }

        // add the club
        try {
<span class="nc bnc" id="L14827" title="All 2 branches missed.">            if (clubType != null) {</span>
<span class="nc" id="L14828">                entity.addEquipment(clubType, Entity.LOC_NONE);</span>
            }
<span class="nc" id="L14830">        } catch (LocationFullException ex) {</span>
            // unlikely...
<span class="nc" id="L14832">            r = new Report(3060);</span>
<span class="nc" id="L14833">            r.subject = entity.getId();</span>
<span class="nc" id="L14834">            r.addDesc(entity);</span>
<span class="nc" id="L14835">            addReport(r);</span>
<span class="nc" id="L14836">        }</span>
<span class="nc" id="L14837">    }</span>

    /**
     * Try to ignite the hex, taking into account existing fires and the
     * effects of Inferno rounds.
     *
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex being lit.
     * @param entityId
     *            - the &lt;code&gt;int&lt;/code&gt; id of the entity involved.
     * @param bInferno
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon igniting the hex is an
     *            Inferno round. If some other weapon or ammo is causing the
     *            roll, this should be &lt;code&gt;false&lt;/code&gt;.
     * @param bHotGun
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon is plasma/flamer/incendiary
     *            LRM/etc
     * @param nTargetRoll
     *            - the &lt;code&gt;TargetRoll&lt;/code&gt; for the ignition roll.
     * @param bReportAttempt
     *            - &lt;code&gt;true&lt;/code&gt; if the attempt roll should be added to the
     *            report.
     * @param accidentTarget
     *            - &lt;code&gt;int&lt;/code&gt; the target number below which a roll has to
     *            be made in order to try igniting a hex accidentally. -1 for
     *            intentional
     */
    public boolean tryIgniteHex(Coords c, int entityId, boolean bHotGun,
            boolean bInferno, TargetRoll nTargetRoll, boolean bReportAttempt,
            int accidentTarget, Vector&lt;Report&gt; vPhaseReport) {

<span class="nc" id="L14868">        IHex hex = game.getBoard().getHex(c);</span>
        Report r;

        // Ignore bad coordinates.
<span class="nc bnc" id="L14872" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L14873">            return false;</span>
        }

        // Ignore if fire is not enabled as a game option
<span class="nc bnc" id="L14877" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_START_FIRE)) {</span>
<span class="nc" id="L14878">            return false;</span>
        }

        // is the hex ignitable (how are infernos handled?)
<span class="nc bnc" id="L14882" title="All 2 branches missed.">        if (!hex.isIgnitable()) {</span>
<span class="nc" id="L14883">            return false;</span>
        }

        // first for accidental ignitions, make the necessary roll
<span class="nc bnc" id="L14887" title="All 2 branches missed.">        if (accidentTarget &gt; -1) {</span>
            // if this hex is in snow, then accidental ignitions are not
            // possible
<span class="nc bnc" id="L14890" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L14891">                return false;</span>
            }
<span class="nc" id="L14893">            nTargetRoll.addModifier(2, &quot;accidental&quot;);</span>
<span class="nc" id="L14894">            int accidentRoll = Compute.d6(2);</span>
<span class="nc" id="L14895">            r = new Report(3066);</span>
<span class="nc" id="L14896">            r.subject = entityId;</span>
<span class="nc" id="L14897">            r.add(accidentTarget);</span>
<span class="nc" id="L14898">            r.add(accidentRoll);</span>
<span class="nc" id="L14899">            r.indent(2);</span>
<span class="nc bnc" id="L14900" title="All 2 branches missed.">            if (accidentRoll &gt; accidentTarget) {</span>
<span class="nc" id="L14901">                r.choose(false);</span>
<span class="nc" id="L14902">                vPhaseReport.add(r);</span>
<span class="nc" id="L14903">                return false;</span>
            }
<span class="nc" id="L14905">            r.choose(true);</span>
<span class="nc" id="L14906">            vPhaseReport.add(r);</span>
        }

<span class="nc" id="L14909">        int terrainMod = hex.getIgnitionModifier();</span>
<span class="nc bnc" id="L14910" title="All 2 branches missed.">        if (terrainMod != 0) {</span>
<span class="nc" id="L14911">            nTargetRoll.addModifier(terrainMod, &quot;terrain&quot;);</span>
        }

        // building modifiers
<span class="nc" id="L14915">        Building bldg = game.getBoard().getBuildingAt(c);</span>
<span class="nc bnc" id="L14916" title="All 2 branches missed.">        if (null != bldg) {</span>
<span class="nc" id="L14917">            nTargetRoll.addModifier(bldg.getType() - 3, &quot;building&quot;);</span>
        }

        // add in any modifiers for planetary conditions
<span class="nc" id="L14921">        int weatherMod = game.getPlanetaryConditions().getIgniteModifiers();</span>
<span class="nc bnc" id="L14922" title="All 2 branches missed.">        if (weatherMod != 0) {</span>
<span class="nc" id="L14923">            nTargetRoll.addModifier(weatherMod, &quot;conditions&quot;);</span>
        }

        // if there is snow on the ground and this a hotgun or inferno, it may
        // melt the snow instead
<span class="nc bnc" id="L14928" title="All 2 branches missed.">        if ((hex.containsTerrain(Terrains.SNOW) || hex</span>
<span class="nc bnc" id="L14929" title="All 6 branches missed.">                .containsTerrain(Terrains.ICE)) &amp;&amp; (bHotGun || bInferno)) {</span>
<span class="nc" id="L14930">            boolean melted = false;</span>
<span class="nc" id="L14931">            int meltCheck = Compute.d6(2);</span>
<span class="nc bnc" id="L14932" title="All 4 branches missed.">            if ((hex.terrainLevel(Terrains.SNOW) &gt; 1) &amp;&amp; (meltCheck == 12)) {</span>
<span class="nc" id="L14933">                melted = true;</span>
<span class="nc bnc" id="L14934" title="All 4 branches missed.">            } else if (hex.containsTerrain(Terrains.ICE) &amp;&amp; (meltCheck &gt; 9)) {</span>
<span class="nc" id="L14935">                melted = true;</span>
<span class="nc bnc" id="L14936" title="All 4 branches missed.">            } else if (hex.containsTerrain(Terrains.SNOW) &amp;&amp; (meltCheck &gt; 7)) {</span>
<span class="nc" id="L14937">                melted = true;</span>
            }
<span class="nc bnc" id="L14939" title="All 2 branches missed.">            if (bInferno) {</span>
<span class="nc" id="L14940">                melted = true;</span>
            }
<span class="nc bnc" id="L14942" title="All 2 branches missed.">            if (melted) {</span>
<span class="nc" id="L14943">                vPhaseReport.addAll(meltIceAndSnow(c, entityId));</span>
<span class="nc" id="L14944">                return false;</span>
            }

        }

        // inferno always ignites
        // ERRATA not if targeting clear hexes for ignition is disabled.
<span class="nc bnc" id="L14951" title="All 4 branches missed.">        if (bInferno &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_NO_IGNITE_CLEAR)) {</span>
<span class="nc" id="L14952">            nTargetRoll = new TargetRoll(0, &quot;inferno&quot;);</span>
        }

        // no lighting fires in tornadoes
<span class="nc bnc" id="L14956" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L14957">            nTargetRoll = new TargetRoll(TargetRoll.AUTOMATIC_FAIL, &quot;tornado&quot;);</span>
        }

        // The hex may already be on fire.
<span class="nc bnc" id="L14961" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc bnc" id="L14962" title="All 2 branches missed.">            if (bReportAttempt) {</span>
<span class="nc" id="L14963">                r = new Report(3065);</span>
<span class="nc" id="L14964">                r.indent(2);</span>
<span class="nc" id="L14965">                r.subject = entityId;</span>
<span class="nc" id="L14966">                vPhaseReport.add(r);</span>
            }
<span class="nc bnc" id="L14968" title="All 2 branches missed.">        } else if (checkIgnition(c, nTargetRoll, bInferno, entityId,</span>
                vPhaseReport)) {
<span class="nc" id="L14970">            return true;</span>
        }
<span class="nc" id="L14972">        return false;</span>
    }

    /**
     * Try to ignite the hex, taking into account existing fires and the
     * effects of Inferno rounds. This version of the method will not report the
     * attempt roll.
     *
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex being lit.
     * @param entityId
     *            - the &lt;code&gt;int&lt;/code&gt; id of the entity involved.
     * @param bInferno
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon igniting the hex is an
     *            Inferno round. If some other weapon or ammo is causing the
     *            roll, this should be &lt;code&gt;false&lt;/code&gt;.
     * @param nTargetRoll
     *            - the &lt;code&gt;int&lt;/code&gt; roll target for the attempt.
     */
    public boolean tryIgniteHex(Coords c, int entityId, boolean bHotGun, boolean bInferno,
                                TargetRoll nTargetRoll, int accidentTarget,
                                Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L14994">        return tryIgniteHex(c, entityId, bHotGun, bInferno, nTargetRoll, false,</span>
                accidentTarget, vPhaseReport);
    }

    public Vector&lt;Report&gt; tryClearHex(Coords c, int nDamage, int entityId) {
<span class="nc" id="L14999">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L15000">        IHex h = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L15001" title="All 2 branches missed.">        if (h == null) {</span>
<span class="nc" id="L15002">            return vPhaseReport;</span>
        }
<span class="nc" id="L15004">        ITerrain woods = h.getTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15005">        ITerrain jungle = h.getTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15006">        ITerrain ice = h.getTerrain(Terrains.ICE);</span>
<span class="nc" id="L15007">        ITerrain magma = h.getTerrain(Terrains.MAGMA);</span>
        Report r;
<span class="nc" id="L15009">        int reportType = Report.HIDDEN;</span>
<span class="nc bnc" id="L15010" title="All 2 branches missed.">        if (entityId == Entity.NONE) {</span>
<span class="nc" id="L15011">            reportType = Report.PUBLIC;</span>
        }
<span class="nc bnc" id="L15013" title="All 2 branches missed.">        if (woods != null) {</span>
<span class="nc" id="L15014">            int tf = woods.getTerrainFactor() - nDamage;</span>
<span class="nc" id="L15015">            int level = woods.getLevel();</span>
<span class="nc" id="L15016">            int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L15017" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
<span class="nc" id="L15018">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15019">                h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L15020">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.ROUGH, 1));
                // light converted to rough
<span class="nc" id="L15023">                r = new Report(3090, reportType);</span>
<span class="nc" id="L15024">                r.subject = entityId;</span>
<span class="nc" id="L15025">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15026" title="All 4 branches missed.">            } else if ((tf &lt;= 50) &amp;&amp; (level &gt; 1)) {</span>
<span class="nc" id="L15027">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15028">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.WOODS, 1));
<span class="nc bnc" id="L15030" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15031">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15034">                woods = h.getTerrain(Terrains.WOODS);</span>
                // heavy converted to light
<span class="nc" id="L15036">                r = new Report(3085, reportType);</span>
<span class="nc" id="L15037">                r.subject = entityId;</span>
<span class="nc" id="L15038">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15039" title="All 4 branches missed.">            } else if ((tf &lt;= 90) &amp;&amp; (level &gt; 2)) {</span>
<span class="nc" id="L15040">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15041">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.WOODS, 2));
<span class="nc bnc" id="L15043" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15044">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15047">                woods = h.getTerrain(Terrains.WOODS);</span>
                // ultra heavy converted to heavy
<span class="nc" id="L15049">                r = new Report(3082, reportType);</span>
<span class="nc" id="L15050">                r.subject = entityId;</span>
<span class="nc" id="L15051">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L15053">            woods.setTerrainFactor(tf);</span>
        }
<span class="nc bnc" id="L15055" title="All 2 branches missed.">        if (jungle != null) {</span>
<span class="nc" id="L15056">            int tf = jungle.getTerrainFactor() - nDamage;</span>
<span class="nc" id="L15057">            int level = jungle.getLevel();</span>
<span class="nc" id="L15058">            int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L15059" title="All 2 branches missed.">            if (tf &lt; 0) {</span>
<span class="nc" id="L15060">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15061">                h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L15062">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.ROUGH, 1));
                // light converted to rough
<span class="nc" id="L15065">                r = new Report(3091, reportType);</span>
<span class="nc" id="L15066">                r.subject = entityId;</span>
<span class="nc" id="L15067">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15068" title="All 4 branches missed.">            } else if ((tf &lt;= 50) &amp;&amp; (level &gt; 1)) {</span>
<span class="nc" id="L15069">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15070">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.JUNGLE, 1));
<span class="nc bnc" id="L15072" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15073">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15076">                jungle = h.getTerrain(Terrains.JUNGLE);</span>
                // heavy converted to light
<span class="nc" id="L15078">                r = new Report(3086, reportType);</span>
<span class="nc" id="L15079">                r.subject = entityId;</span>
<span class="nc" id="L15080">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15081" title="All 4 branches missed.">            } else if ((tf &lt;= 90) &amp;&amp; (level &gt; 2)) {</span>
<span class="nc" id="L15082">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15083">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.JUNGLE, 2));
<span class="nc bnc" id="L15085" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15086">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15089">                jungle = h.getTerrain(Terrains.JUNGLE);</span>
                // ultra heavy converted to heavy
<span class="nc" id="L15091">                r = new Report(3083, reportType);</span>
<span class="nc" id="L15092">                r.subject = entityId;</span>
<span class="nc" id="L15093">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L15095">            jungle.setTerrainFactor(tf);</span>
        }
<span class="nc bnc" id="L15097" title="All 2 branches missed.">        if (ice != null) {</span>
<span class="nc" id="L15098">            int tf = ice.getTerrainFactor() - nDamage;</span>
<span class="nc bnc" id="L15099" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
                // ice melted
<span class="nc" id="L15101">                r = new Report(3092, reportType);</span>
<span class="nc" id="L15102">                r.subject = entityId;</span>
<span class="nc" id="L15103">                vPhaseReport.add(r);</span>
<span class="nc" id="L15104">                vPhaseReport.addAll(resolveIceBroken(c));</span>
            } else {
<span class="nc" id="L15106">                ice.setTerrainFactor(tf);</span>
            }
        }
<span class="nc bnc" id="L15109" title="All 4 branches missed.">        if ((magma != null) &amp;&amp; (magma.getLevel() == 1)) {</span>
<span class="nc" id="L15110">            int tf = magma.getTerrainFactor() - nDamage;</span>
<span class="nc bnc" id="L15111" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
                // magma crust destroyed
<span class="nc" id="L15113">                r = new Report(3093, reportType);</span>
<span class="nc" id="L15114">                r.subject = entityId;</span>
<span class="nc" id="L15115">                vPhaseReport.add(r);</span>
<span class="nc" id="L15116">                h.removeTerrain(Terrains.MAGMA);</span>
<span class="nc" id="L15117">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.MAGMA, 2));
<span class="nc bnc" id="L15119" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(c)) {</span>
<span class="nc" id="L15120">                    doMagmaDamage(en, false);</span>
<span class="nc" id="L15121">                }</span>
            } else {
<span class="nc" id="L15123">                magma.setTerrainFactor(tf);</span>
            }
        }
<span class="nc" id="L15126">        sendChangedHex(c);</span>

        // any attempt to clear an heavy industrial hex may cause an exposion
<span class="nc" id="L15129">        checkExplodeIndustrialZone(c, vPhaseReport);</span>

<span class="nc" id="L15131">        return vPhaseReport;</span>
    }

    /**
     * Handle all physical attacks for the round
     */
    private void resolvePhysicalAttacks() {
        // Physical phase header
<span class="nc" id="L15139">        addReport(new Report(4000, Report.PUBLIC));</span>

        // add any pending charges
<span class="nc" id="L15142">        for (Enumeration&lt;AttackAction&gt; i = game.getCharges(); i</span>
<span class="nc bnc" id="L15143" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15144">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15146">        game.resetCharges();</span>

        // add any pending rams
<span class="nc bnc" id="L15149" title="All 2 branches missed.">        for (Enumeration&lt;AttackAction&gt; i = game.getRams(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15150">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15152">        game.resetRams();</span>

        // add any pending Tele Missile Attacks
<span class="nc" id="L15155">        for (Enumeration&lt;AttackAction&gt; i = game.getTeleMissileAttacks(); i</span>
<span class="nc bnc" id="L15156" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15157">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15159">        game.resetTeleMissileAttacks();</span>

        // remove any duplicate attack declarations
<span class="nc" id="L15162">        cleanupPhysicalAttacks();</span>

        // loop thru received attack actions
<span class="nc" id="L15165">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L15166" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15167">            Object o = i.nextElement();</span>
            // verify that the attacker is still active
<span class="nc" id="L15169">            AttackAction aa = (AttackAction) o;</span>
<span class="nc bnc" id="L15170" title="All 4 branches missed.">            if (!game.getEntity(aa.getEntityId()).isActive()</span>
                &amp;&amp; !(o instanceof DfaAttackAction)) {
<span class="nc" id="L15172">                continue;</span>
            }
<span class="nc" id="L15174">            AbstractAttackAction aaa = (AbstractAttackAction) o;</span>
            // do searchlights immediately
<span class="nc bnc" id="L15176" title="All 2 branches missed.">            if (aaa instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L15177">                SearchlightAttackAction saa = (SearchlightAttackAction) aaa;</span>
<span class="nc" id="L15178">                addReport(saa.resolveAction(game));</span>
<span class="nc" id="L15179">            } else {</span>
<span class="nc" id="L15180">                physicalResults.addElement(preTreatPhysicalAttack(aaa));</span>
            }
<span class="nc" id="L15182">        }</span>
<span class="nc" id="L15183">        int cen = Entity.NONE;</span>
<span class="nc bnc" id="L15184" title="All 2 branches missed.">        for (PhysicalResult pr : physicalResults) {</span>
<span class="nc" id="L15185">            resolvePhysicalAttack(pr, cen);</span>
<span class="nc" id="L15186">            cen = pr.aaa.getEntityId();</span>
<span class="nc" id="L15187">        }</span>
<span class="nc" id="L15188">        physicalResults.removeAllElements();</span>
<span class="nc" id="L15189">    }</span>

    /**
     * Cleans up the attack declarations for the physical phase by removing all
     * attacks past the first for any one mech. Also clears out attacks by dead
     * or disabled mechs.
     */
    private void cleanupPhysicalAttacks() {
<span class="nc bnc" id="L15197" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L15198">            Entity entity = i.next();</span>
<span class="nc" id="L15199">            removeDuplicateAttacks(entity.getId());</span>
<span class="nc" id="L15200">        }</span>
<span class="nc" id="L15201">        removeDeadAttacks();</span>
<span class="nc" id="L15202">    }</span>

    /**
     * Removes any actions in the attack queue beyond the first by the specified
     * entity, unless that entity has melee master in which case it allows two
     * attacks.
     */
    private void removeDuplicateAttacks(int entityId) {
<span class="nc" id="L15210">        int allowed = 1;</span>
<span class="nc" id="L15211">        Entity en = game.getEntity(entityId);</span>
<span class="nc bnc" id="L15212" title="All 2 branches missed.">        if (null != en) {</span>
<span class="nc" id="L15213">            allowed = en.getAllowedPhysicalAttacks();</span>
        }
<span class="nc" id="L15215">        Vector&lt;EntityAction&gt; toKeep = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L15217" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15218">            EntityAction action = i.nextElement();</span>
<span class="nc bnc" id="L15219" title="All 2 branches missed.">            if (action.getEntityId() != entityId) {</span>
<span class="nc" id="L15220">                toKeep.addElement(action);</span>
<span class="nc bnc" id="L15221" title="All 2 branches missed.">            } else if (allowed &gt; 0) {</span>
<span class="nc" id="L15222">                toKeep.addElement(action);</span>
<span class="nc bnc" id="L15223" title="All 2 branches missed.">                if (!(action instanceof SearchlightAttackAction)) {</span>
<span class="nc" id="L15224">                    allowed--;</span>
                }
            } else {
<span class="nc" id="L15227">                MegaMek.getLogger().error(&quot;Removing duplicate phys attack for id#&quot; + entityId</span>
<span class="nc" id="L15228">                                + &quot;\n\t\taction was &quot; + action.toString());</span>
            }
<span class="nc" id="L15230">        }</span>

        // reset actions and re-add valid elements
<span class="nc" id="L15233">        game.resetActions();</span>
<span class="nc bnc" id="L15234" title="All 2 branches missed.">        for (EntityAction entityAction : toKeep) {</span>
<span class="nc" id="L15235">            game.addAction(entityAction);</span>
<span class="nc" id="L15236">        }</span>
<span class="nc" id="L15237">    }</span>

    /**
     * Removes all attacks by any dead entities. It does this by going through
     * all the attacks and only keeping ones from active entities. DFAs are kept
     * even if the pilot is unconscious, so that he can fail.
     */
    private void removeDeadAttacks() {
<span class="nc" id="L15245">        Vector&lt;EntityAction&gt; toKeep = new Vector&lt;&gt;(game.actionsSize());</span>

<span class="nc bnc" id="L15247" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15248">            EntityAction action = i.nextElement();</span>
<span class="nc" id="L15249">            Entity entity = game.getEntity(action.getEntityId());</span>
<span class="nc bnc" id="L15250" title="All 4 branches missed.">            if ((entity != null) &amp;&amp; !entity.isDestroyed()</span>
<span class="nc bnc" id="L15251" title="All 4 branches missed.">                    &amp;&amp; (entity.isActive() || (action instanceof DfaAttackAction))) {</span>
<span class="nc" id="L15252">                toKeep.addElement(action);</span>
            }
<span class="nc" id="L15254">        }</span>

        // reset actions and re-add valid elements
<span class="nc" id="L15257">        game.resetActions();</span>
<span class="nc bnc" id="L15258" title="All 2 branches missed.">        for (EntityAction entityAction : toKeep) {</span>
<span class="nc" id="L15259">            game.addAction(entityAction);</span>
<span class="nc" id="L15260">        }</span>
<span class="nc" id="L15261">    }</span>

    /**
     * Apply damage to mech for zweihandering (melee attack with both hands) as per
     * pg. 82, CamOps
     * 
     * @param ae           - the attacking entity
     * @param missed       - did the attack missed. If so PSR is necessary.
     * @param criticalLocs - the locations for possible criticals, should be one or
     *                     both arms depending on if it was an unarmed attack (both
     *                     arms) or a weapon attack (the arm with the weapon).
     */
    private void applyZweihanderSelfDamage(Entity ae, boolean missed, List&lt;Integer&gt; criticalLocs) {
<span class="nc" id="L15274">        Report r = new Report(4022);</span>
<span class="nc" id="L15275">        r.subject = ae.getId();</span>
<span class="nc" id="L15276">        r.indent();</span>
<span class="nc" id="L15277">        r.addDesc(ae);</span>
<span class="nc" id="L15278">        addReport(r);</span>
<span class="nc bnc" id="L15279" title="All 2 branches missed.">        for (Integer loc : criticalLocs) {</span>
<span class="nc" id="L15280">            addReport(criticalEntity(ae, loc, false, 0, 1));</span>
<span class="nc" id="L15281">        }</span>
<span class="nc bnc" id="L15282" title="All 2 branches missed.">        if(missed) {</span>
<span class="nc" id="L15283">            game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;Zweihander miss&quot;));</span>
        }
<span class="nc" id="L15285">    }</span>

    /**
     * Handle a punch attack
     */
    private void resolvePunchAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15291">        final PunchAttackAction paa = (PunchAttackAction) pr.aaa;</span>
<span class="nc" id="L15292">        final Entity ae = game.getEntity(paa.getEntityId());</span>
<span class="nc" id="L15293">        final Targetable target = game.getTarget(paa.getTargetType(), paa.getTargetId());</span>
<span class="nc" id="L15294">        Entity te = null;</span>
<span class="nc bnc" id="L15295" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15296">            te = (Entity) target;</span>
        }
<span class="nc" id="L15298">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15299" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15300">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L15302" title="All 2 branches missed.">        final String armName = paa.getArm() == PunchAttackAction.LEFT ? &quot;Left Arm&quot; : &quot;Right Arm&quot;;</span>

<span class="nc bnc" id="L15304" title="All 2 branches missed.">        final int armLoc = paa.getArm() == PunchAttackAction.LEFT ? Mech.LOC_LARM : Mech.LOC_RARM;</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc bnc" id="L15307" title="All 2 branches missed.">        int damage = paa.getArm() == PunchAttackAction.LEFT ? pr.damage : pr.damageRight;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L15309" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15310">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc bnc" id="L15312" title="All 2 branches missed.">        final ToHitData toHit = paa.getArm() == PunchAttackAction.LEFT ? pr.toHit : pr.toHitRight;</span>
<span class="nc bnc" id="L15313" title="All 2 branches missed.">        int roll = paa.getArm() == PunchAttackAction.LEFT ? pr.roll : pr.rollRight;</span>
<span class="nc" id="L15314">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15315" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15316" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        Report r;

        // Set Margin of Success/Failure.
<span class="nc" id="L15321">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15322" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15323" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15326">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15328" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // report who is making the attacks
<span class="nc" id="L15330">            r = new Report(4005);</span>
<span class="nc" id="L15331">            r.subject = ae.getId();</span>
<span class="nc" id="L15332">            r.addDesc(ae);</span>
<span class="nc" id="L15333">            addReport(r);</span>
        }

<span class="nc" id="L15336">        r = new Report(4010);</span>
<span class="nc" id="L15337">        r.subject = ae.getId();</span>
<span class="nc" id="L15338">        r.indent();</span>
<span class="nc" id="L15339">        r.add(armName);</span>
<span class="nc" id="L15340">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15341">        r.newlines = 0;</span>
<span class="nc" id="L15342">        addReport(r);</span>

<span class="nc bnc" id="L15344" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15345">            r = new Report(4015);</span>
<span class="nc" id="L15346">            r.subject = ae.getId();</span>
<span class="nc" id="L15347">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15348">            addReport(r);</span>
<span class="nc bnc" id="L15349" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15350">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed punch attack&quot;));</span>
            }
<span class="nc" id="L15352">            return;</span>
<span class="nc bnc" id="L15353" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15354">            r = new Report(4020);</span>
<span class="nc" id="L15355">            r.subject = ae.getId();</span>
<span class="nc" id="L15356">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15357">            r.newlines = 0;</span>
<span class="nc" id="L15358">            addReport(r);</span>
<span class="nc" id="L15359">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15361">            r = new Report(4025);</span>
<span class="nc" id="L15362">            r.subject = ae.getId();</span>
<span class="nc" id="L15363">            r.add(toHit);</span>
<span class="nc" id="L15364">            r.add(roll);</span>
<span class="nc" id="L15365">            r.newlines = 0;</span>
<span class="nc" id="L15366">            addReport(r);</span>
<span class="nc bnc" id="L15367" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15368">                r = new Report(3186);</span>
<span class="nc" id="L15369">                r.subject = ae.getId();</span>
<span class="nc" id="L15370">                r.newlines = 0;</span>
<span class="nc" id="L15371">                addReport(r);</span>
            }
<span class="nc bnc" id="L15373" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15374">                r = new Report(3189);</span>
<span class="nc" id="L15375">                r.subject = ae.getId();</span>
<span class="nc" id="L15376">                r.newlines = 0;</span>
<span class="nc" id="L15377">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L15382" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // nope
<span class="nc" id="L15384">            r = new Report(4035);</span>
<span class="nc" id="L15385">            r.subject = ae.getId();</span>
<span class="nc" id="L15386">            addReport(r);</span>

<span class="nc bnc" id="L15388" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15389">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed punch attack&quot;));</span>
            }
            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15392" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L15395" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15396">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15397" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15398">                        report.subject = ae.getId();</span>
<span class="nc" id="L15399">                    }</span>
<span class="nc" id="L15400">                    addReport(buildingReport);</span>
                }

            }

<span class="nc bnc" id="L15405" title="All 2 branches missed.">            if(paa.isZweihandering()) {</span>
<span class="nc" id="L15406">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15407">                criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15408">                criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15409">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }

<span class="nc" id="L15412">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15416" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15417" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15419">            r = new Report(4040);</span>
<span class="nc" id="L15420">            r.subject = ae.getId();</span>
<span class="nc" id="L15421">            addReport(r);</span>
<span class="nc" id="L15422">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15423" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15424">                report.subject = ae.getId();</span>
<span class="nc" id="L15425">            }</span>
<span class="nc" id="L15426">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15429">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

<span class="nc bnc" id="L15431" title="All 2 branches missed.">            if(paa.isZweihandering()) {</span>
<span class="nc" id="L15432">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15433">                criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15434">                criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15435">                applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
            }

            // And we're done!
<span class="nc" id="L15439">            return;</span>
        }

<span class="nc" id="L15442">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15443">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L15444">        r = new Report(4045);</span>
<span class="nc" id="L15445">        r.subject = ae.getId();</span>
<span class="nc" id="L15446">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L15447">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L15448">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15452" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15453">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15454">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15455">            damage -= toBldg;</span>
<span class="nc" id="L15456">            addNewLines();</span>
<span class="nc" id="L15457">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, toBldg, target.getPosition());</span>
<span class="nc bnc" id="L15458" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15459">                report.subject = ae.getId();</span>
<span class="nc" id="L15460">            }</span>
<span class="nc" id="L15461">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L15465">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L15469" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L15470">            r = new Report(4050);</span>
<span class="nc" id="L15471">            r.subject = ae.getId();</span>
<span class="nc" id="L15472">            r.add(te.getShortName());</span>
<span class="nc" id="L15473">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L15474">            r.indent();</span>
<span class="nc" id="L15475">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L15477" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15479" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L15481" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15482">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15483">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

<span class="nc" id="L15486">            damage = checkForSpikes(te, hit.getLocation(), damage, ae,</span>
<span class="nc bnc" id="L15487" title="All 2 branches missed.">                    (paa.getArm() == PunchAttackAction.LEFT) ?  Mech.LOC_LARM : Mech.LOC_RARM);</span>
<span class="nc" id="L15488">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L15489">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                    false, throughFront));
<span class="nc bnc" id="L15491" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L15493">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM, VTOL.CRIT_ROTOR_DESTROYED),
                        false, 0, false));
            }
            // check for extending retractable blades
<span class="nc bnc" id="L15498" title="All 2 branches missed.">            if (paa.isBladeExtended(paa.getArm())) {</span>
<span class="nc" id="L15499">                addNewLines();</span>
<span class="nc" id="L15500">                r = new Report(4455);</span>
<span class="nc" id="L15501">                r.indent(2);</span>
<span class="nc" id="L15502">                r.subject = ae.getId();</span>
<span class="nc" id="L15503">                r.newlines = 0;</span>
<span class="nc" id="L15504">                addReport(r);</span>
                // conventional infantry don't take crits and battle armor need
                // to be handled differently
<span class="nc bnc" id="L15507" title="All 2 branches missed.">                if (!(target instanceof Infantry)) {</span>
<span class="nc" id="L15508">                    addNewLines();</span>
<span class="nc" id="L15509">                    addReport(criticalEntity(te, hit.getLocation(), hit.isRear(), 0,</span>
                            true, false, damage));
                }
<span class="nc bnc" id="L15512" title="All 4 branches missed.">                if ((target instanceof BattleArmor) &amp;&amp; (hit.getLocation() &lt; te.locations())</span>
<span class="nc bnc" id="L15513" title="All 2 branches missed.">                        &amp;&amp; (te.getInternal(hit.getLocation()) &gt; 0)) {</span>
                    // TODO : we should really apply BA criticals through the critical
                    // TODO : hits methods. Right now they are applied in damageEntity
<span class="nc" id="L15516">                    HitData baHit = new HitData(hit.getLocation(), false,</span>
                            HitData.EFFECT_CRITICAL);
<span class="nc" id="L15518">                    addReport(damageEntity(te, baHit, 0));</span>
                }
                // extend the blade
                // since retracting/extending is a freebie in the movement
                // phase, lets assume that the
                // blade retracts to its original mode
                // ae.extendBlade(paa.getArm());
                // check for breaking a nail
<span class="nc bnc" id="L15526" title="All 2 branches missed.">                if (Compute.d6(2) &gt; 9) {</span>
<span class="nc" id="L15527">                    addNewLines();</span>
<span class="nc" id="L15528">                    r = new Report(4456);</span>
<span class="nc" id="L15529">                    r.indent(2);</span>
<span class="nc" id="L15530">                    r.subject = ae.getId();</span>
<span class="nc" id="L15531">                    r.newlines = 0;</span>
<span class="nc" id="L15532">                    addReport(r);</span>
<span class="nc" id="L15533">                    ae.destroyRetractableBlade(armLoc);</span>
                }
            }
        }
<span class="nc" id="L15537">        addNewLines();</span>

<span class="nc bnc" id="L15539" title="All 2 branches missed.">        if(paa.isZweihandering()) {</span>
<span class="nc" id="L15540">            ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15541">            criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15542">            criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15543">            applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
        }
<span class="nc" id="L15545">        addNewLines();</span>


        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L15550" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L15551">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L15553">    }</span>

    /**
     * Handle a kick attack
     */
    private void resolveKickAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15559">        KickAttackAction kaa = (KickAttackAction) pr.aaa;</span>
<span class="nc" id="L15560">        final Entity ae = game.getEntity(kaa.getEntityId());</span>
<span class="nc" id="L15561">        final Targetable target = game.getTarget(kaa.getTargetType(), kaa.getTargetId());</span>
<span class="nc" id="L15562">        Entity te = null;</span>
<span class="nc bnc" id="L15563" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15564">            te = (Entity) target;</span>
        }
<span class="nc" id="L15566">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15567" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15568">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L15570" title="All 2 branches missed.">        String legName = (kaa.getLeg() == KickAttackAction.LEFT)</span>
<span class="nc bnc" id="L15571" title="All 2 branches missed.">                || (kaa.getLeg() == KickAttackAction.LEFTMULE) ? &quot;Left &quot; : &quot;Right &quot;;</span>
<span class="nc bnc" id="L15572" title="All 2 branches missed.">        if ((kaa.getLeg() == KickAttackAction.LEFTMULE)</span>
<span class="nc bnc" id="L15573" title="All 2 branches missed.">                || (kaa.getLeg() == KickAttackAction.RIGHTMULE)) {</span>
<span class="nc" id="L15574">            legName = legName.concat(&quot;rear &quot;);</span>
<span class="nc bnc" id="L15575" title="All 2 branches missed.">        } else if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15576">            legName = legName.concat(&quot;front &quot;);</span>
        }
<span class="nc" id="L15578">        legName = legName.concat(&quot;leg&quot;);</span>
        Report r;

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L15582">        int damage = pr.damage;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L15584" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15585">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc" id="L15587">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L15588">        int roll = pr.roll;</span>
<span class="nc" id="L15589">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15590" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15591" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L15594">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15595" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15596" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15599">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15601" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L15603">            r = new Report(4005);</span>
<span class="nc" id="L15604">            r.subject = ae.getId();</span>
<span class="nc" id="L15605">            r.addDesc(ae);</span>
<span class="nc" id="L15606">            addReport(r);</span>
        }

<span class="nc" id="L15609">        r = new Report(4055);</span>
<span class="nc" id="L15610">        r.subject = ae.getId();</span>
<span class="nc" id="L15611">        r.indent();</span>
<span class="nc" id="L15612">        r.add(legName);</span>
<span class="nc" id="L15613">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15614">        r.newlines = 0;</span>
<span class="nc" id="L15615">        addReport(r);</span>

<span class="nc bnc" id="L15617" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15618">            r = new Report(4060);</span>
<span class="nc" id="L15619">            r.subject = ae.getId();</span>
<span class="nc" id="L15620">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15621">            addReport(r);</span>
<span class="nc bnc" id="L15622" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15623">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            } else {
<span class="nc" id="L15625">                game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            }
<span class="nc" id="L15627">            return;</span>
<span class="nc bnc" id="L15628" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15629">            r = new Report(4065);</span>
<span class="nc" id="L15630">            r.subject = ae.getId();</span>
<span class="nc" id="L15631">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15632">            r.newlines = 0;</span>
<span class="nc" id="L15633">            addReport(r);</span>
<span class="nc" id="L15634">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15636">            r = new Report(4025);</span>
<span class="nc" id="L15637">            r.subject = ae.getId();</span>
<span class="nc" id="L15638">            r.add(toHit);</span>
<span class="nc" id="L15639">            r.add(roll);</span>
<span class="nc" id="L15640">            r.newlines = 0;</span>
<span class="nc" id="L15641">            addReport(r);</span>
<span class="nc bnc" id="L15642" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15643">                r = new Report(3186);</span>
<span class="nc" id="L15644">                r.subject = ae.getId();</span>
<span class="nc" id="L15645">                r.newlines = 0;</span>
<span class="nc" id="L15646">                addReport(r);</span>
            }
<span class="nc bnc" id="L15648" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15649">                r = new Report(3189);</span>
<span class="nc" id="L15650">                r.subject = ae.getId();</span>
<span class="nc" id="L15651">                r.newlines = 0;</span>
<span class="nc" id="L15652">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L15658" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L15660">            r = new Report(4035);</span>
<span class="nc" id="L15661">            r.subject = ae.getId();</span>
<span class="nc" id="L15662">            addReport(r);</span>
<span class="nc bnc" id="L15663" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15664">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            } else {
<span class="nc" id="L15666">                game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            }

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15670" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L15673" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15674">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15675" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15676">                        report.subject = ae.getId();</span>
<span class="nc" id="L15677">                    }</span>
<span class="nc" id="L15678">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L15682">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15686" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15687" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15689">            r = new Report(4040);</span>
<span class="nc" id="L15690">            r.subject = ae.getId();</span>
<span class="nc" id="L15691">            addReport(r);</span>
<span class="nc" id="L15692">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15693" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15694">                report.subject = ae.getId();</span>
<span class="nc" id="L15695">            }</span>
<span class="nc" id="L15696">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15699">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L15702">            return;</span>
        }

<span class="nc" id="L15705">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15706">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L15707">        r = new Report(4045);</span>
<span class="nc" id="L15708">        r.subject = ae.getId();</span>
<span class="nc" id="L15709">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L15710">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L15711">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15715" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15716">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15717">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15718">            damage -= toBldg;</span>
<span class="nc" id="L15719">            addNewLines();</span>
<span class="nc" id="L15720">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15721" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15722">                report.subject = ae.getId();</span>
<span class="nc" id="L15723">            }</span>
<span class="nc" id="L15724">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L15728">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L15732" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L15733">            r = new Report(4050);</span>
<span class="nc" id="L15734">            r.subject = ae.getId();</span>
<span class="nc" id="L15735">            r.add(te.getShortName());</span>
<span class="nc" id="L15736">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L15737">            r.newlines = 0;</span>
<span class="nc" id="L15738">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L15740" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15742" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L15744" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15745">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15746">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

            int leg;
<span class="nc bnc" id="L15750" title="All 4 branches missed.">            switch (kaa.getLeg()) {</span>
                case KickAttackAction.LEFT:
<span class="nc bnc" id="L15752" title="All 2 branches missed.">                    if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15753">                        leg = Mech.LOC_LARM;</span>
                    } else {
<span class="nc" id="L15755">                        leg = Mech.LOC_LLEG;</span>
                    }
<span class="nc" id="L15757">                    break;</span>
                case KickAttackAction.RIGHT:
<span class="nc bnc" id="L15759" title="All 2 branches missed.">                    if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15760">                        leg = Mech.LOC_RARM;</span>
                    } else {
<span class="nc" id="L15762">                        leg = Mech.LOC_RLEG;</span>
                    }
<span class="nc" id="L15764">                    break;</span>
                case KickAttackAction.LEFTMULE:
<span class="nc" id="L15766">                    leg = Mech.LOC_LLEG;</span>
<span class="nc" id="L15767">                    break;</span>
                case KickAttackAction.RIGHTMULE:
                default:
<span class="nc" id="L15770">                    leg = Mech.LOC_RLEG;</span>
                    break;
            }
<span class="nc" id="L15773">            damage = checkForSpikes(te, hit.getLocation(), damage, ae, leg);</span>
<span class="nc" id="L15774">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L15775">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                    false, throughFront));
<span class="nc bnc" id="L15777" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L15779">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
<span class="nc bnc" id="L15783" title="All 2 branches missed.">            if (te.hasQuirk(OptionsConstants.QUIRK_NEG_WEAK_LEGS)) {</span>
<span class="nc" id="L15784">                addNewLines();</span>
<span class="nc" id="L15785">                addReport(criticalEntity(te, hit.getLocation(), hit.isRear(), 0, 0));</span>
            }
        }

<span class="nc bnc" id="L15789" title="All 2 branches missed.">        if (te.canFall()) {</span>
<span class="nc" id="L15790">            PilotingRollData kickPRD = getKickPushPSR(te, ae, te, &quot;was kicked&quot;);</span>
<span class="nc" id="L15791">            game.addPSR(kickPRD);</span>
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L15796" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L15797">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L15800">        addNewLines();</span>
<span class="nc" id="L15801">    }</span>

    /**
     * Handle a kick attack
     */
    private void resolveJumpJetAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15807">        JumpJetAttackAction kaa = (JumpJetAttackAction) pr.aaa;</span>
<span class="nc" id="L15808">        final Entity ae = game.getEntity(kaa.getEntityId());</span>
<span class="nc" id="L15809">        final Targetable target = game.getTarget(kaa.getTargetType(), kaa.getTargetId());</span>
<span class="nc" id="L15810">        Entity te = null;</span>
<span class="nc bnc" id="L15811" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15812">            te = (Entity) target;</span>
        }
<span class="nc" id="L15814">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15815" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15816">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
        String legName;
<span class="nc bnc" id="L15819" title="All 3 branches missed.">        switch (kaa.getLeg()) {</span>
            case JumpJetAttackAction.LEFT:
<span class="nc" id="L15821">                legName = &quot;Left leg&quot;;</span>
<span class="nc" id="L15822">                break;</span>
            case JumpJetAttackAction.RIGHT:
<span class="nc" id="L15824">                legName = &quot;Right leg&quot;;</span>
<span class="nc" id="L15825">                break;</span>
            default:
<span class="nc" id="L15827">                legName = &quot;Both legs&quot;;</span>
                break;
        }

        Report r;

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L15834">        int damage = pr.damage;</span>
<span class="nc" id="L15835">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L15836">        int roll = pr.roll;</span>
<span class="nc" id="L15837">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15838" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15839" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L15842">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15843" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15844" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15847">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15849" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L15851">            r = new Report(4005);</span>
<span class="nc" id="L15852">            r.subject = ae.getId();</span>
<span class="nc" id="L15853">            r.addDesc(ae);</span>
<span class="nc" id="L15854">            addReport(r);</span>
        }

<span class="nc" id="L15857">        r = new Report(4290);</span>
<span class="nc" id="L15858">        r.subject = ae.getId();</span>
<span class="nc" id="L15859">        r.indent();</span>
<span class="nc" id="L15860">        r.add(legName);</span>
<span class="nc" id="L15861">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15862">        r.newlines = 0;</span>
<span class="nc" id="L15863">        addReport(r);</span>

<span class="nc bnc" id="L15865" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15866">            r = new Report(4075);</span>
<span class="nc" id="L15867">            r.subject = ae.getId();</span>
<span class="nc" id="L15868">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15869">            addReport(r);</span>
<span class="nc" id="L15870">            return;</span>
<span class="nc bnc" id="L15871" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15872">            r = new Report(4080);</span>
<span class="nc" id="L15873">            r.subject = ae.getId();</span>
<span class="nc" id="L15874">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15875">            r.newlines = 0;</span>
<span class="nc" id="L15876">            addReport(r);</span>
<span class="nc" id="L15877">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15879">            r = new Report(4025);</span>
<span class="nc" id="L15880">            r.subject = ae.getId();</span>
<span class="nc" id="L15881">            r.add(toHit);</span>
<span class="nc" id="L15882">            r.add(roll);</span>
<span class="nc" id="L15883">            r.newlines = 0;</span>
<span class="nc" id="L15884">            addReport(r);</span>
<span class="nc bnc" id="L15885" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15886">                r = new Report(3186);</span>
<span class="nc" id="L15887">                r.subject = ae.getId();</span>
<span class="nc" id="L15888">                r.newlines = 0;</span>
<span class="nc" id="L15889">                addReport(r);</span>
            }
<span class="nc bnc" id="L15891" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15892">                r = new Report(3189);</span>
<span class="nc" id="L15893">                r.subject = ae.getId();</span>
<span class="nc" id="L15894">                r.newlines = 0;</span>
<span class="nc" id="L15895">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L15901" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L15903">            r = new Report(4035);</span>
<span class="nc" id="L15904">            r.subject = ae.getId();</span>
<span class="nc" id="L15905">            addReport(r);</span>

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15908" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

<span class="nc" id="L15910">                damage += pr.damageRight;</span>
                // Only report if damage was done to the building.
<span class="nc bnc" id="L15912" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15913">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg,</span>
<span class="nc" id="L15914">                                                                   damage, target.getPosition());</span>
<span class="nc bnc" id="L15915" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15916">                        report.subject = ae.getId();</span>
<span class="nc" id="L15917">                    }</span>
<span class="nc" id="L15918">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L15922">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15926" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15927" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
<span class="nc" id="L15928">            damage += pr.damageRight;</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15930">            r = new Report(4040);</span>
<span class="nc" id="L15931">            r.subject = ae.getId();</span>
<span class="nc" id="L15932">            addReport(r);</span>
<span class="nc" id="L15933">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L15934">                                                           target.getPosition());</span>
<span class="nc bnc" id="L15935" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15936">                report.subject = ae.getId();</span>
<span class="nc" id="L15937">            }</span>
<span class="nc" id="L15938">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15941">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L15944">            return;</span>
        }

<span class="nc" id="L15947">        r = new Report(4040);</span>
<span class="nc" id="L15948">        r.subject = ae.getId();</span>
<span class="nc" id="L15949">        r.newlines = 0;</span>
<span class="nc" id="L15950">        addReport(r);</span>

<span class="nc bnc" id="L15952" title="All 2 branches missed.">        for (int leg = 0; leg &lt; 2; leg++) {</span>
<span class="nc bnc" id="L15953" title="All 2 branches missed.">            if (leg == 1) {</span>
<span class="nc" id="L15954">                damage = pr.damageRight;</span>
<span class="nc bnc" id="L15955" title="All 2 branches missed.">                if (damage == 0) {</span>
<span class="nc" id="L15956">                    break;</span>
                }
            }
<span class="nc" id="L15959">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15960">            hit.setGeneralDamageType(HitData.DAMAGE_ENERGY);</span>

            // The building shields all units from a certain amount of damage.
            // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15964" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15965">                int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15966">                int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15967">                damage -= toBldg;</span>
<span class="nc" id="L15968">                addNewLines();</span>
<span class="nc" id="L15969">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L15970">                                                               target.getPosition());</span>
<span class="nc bnc" id="L15971" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L15972">                    report.subject = ae.getId();</span>
<span class="nc" id="L15973">                }</span>
<span class="nc" id="L15974">                addReport(buildingReport);</span>

                // some buildings scale remaining damage that is not absorbed
                // TODO : this isn't quite right for castles brian
<span class="nc" id="L15978">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
            }

            // A building may absorb the entire shot.
<span class="nc bnc" id="L15982" title="All 2 branches missed.">            if (damage == 0) {</span>
<span class="nc" id="L15983">                r = new Report(4050);</span>
<span class="nc" id="L15984">                r.subject = ae.getId();</span>
<span class="nc" id="L15985">                r.add(te.getShortName());</span>
<span class="nc" id="L15986">                r.add(te.getOwner().getName());</span>
<span class="nc" id="L15987">                r.newlines = 0;</span>
<span class="nc" id="L15988">                addReport(r);</span>
            } else {
<span class="nc bnc" id="L15990" title="All 2 branches missed.">                if (glancing) {</span>
                    // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15992" title="All 2 branches missed.">                    damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
                }
<span class="nc bnc" id="L15994" title="All 2 branches missed.">                if (directBlow) {</span>
<span class="nc" id="L15995">                    damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15996">                    hit.makeDirectBlow(toHit.getMoS() / 3);</span>
                }
<span class="nc" id="L15998">                addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                                       false, false, throughFront));
            }
        }

<span class="nc" id="L16003">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L16007" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L16008">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L16010">    }</span>

    /**
     * Handle a ProtoMech physical attack
     */

    private void resolveProtoAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16017">        final ProtomechPhysicalAttackAction ppaa = (ProtomechPhysicalAttackAction) pr.aaa;</span>
<span class="nc" id="L16018">        final Entity ae = game.getEntity(ppaa.getEntityId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16020">        int damage = pr.damage;</span>
<span class="nc" id="L16021">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16022">        int roll = pr.roll;</span>
<span class="nc" id="L16023">        final Targetable target = game.getTarget(ppaa.getTargetType(), ppaa.getTargetId());</span>
<span class="nc" id="L16024">        Entity te = null;</span>
<span class="nc bnc" id="L16025" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16026">            te = (Entity) target;</span>
        }
<span class="nc" id="L16028">        boolean throughFront = true;</span>
<span class="nc bnc" id="L16029" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L16030">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc" id="L16032">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L16033" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16034" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>
        // Set Margin of Success/Failure.
<span class="nc" id="L16036">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16037" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16038" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L16043">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L16045" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L16047">            r = new Report(4005);</span>
<span class="nc" id="L16048">            r.subject = ae.getId();</span>
<span class="nc" id="L16049">            r.addDesc(ae);</span>
<span class="nc" id="L16050">            addReport(r);</span>
        }

<span class="nc" id="L16053">        r = new Report(4070);</span>
<span class="nc" id="L16054">        r.subject = ae.getId();</span>
<span class="nc" id="L16055">        r.indent();</span>
<span class="nc" id="L16056">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16057">        r.newlines = 0;</span>
<span class="nc" id="L16058">        addReport(r);</span>

<span class="nc bnc" id="L16060" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16061">            r = new Report(4075);</span>
<span class="nc" id="L16062">            r.subject = ae.getId();</span>
<span class="nc" id="L16063">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16064">            addReport(r);</span>
<span class="nc" id="L16065">            return;</span>
<span class="nc bnc" id="L16066" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16067">            r = new Report(4080);</span>
<span class="nc" id="L16068">            r.subject = ae.getId();</span>
<span class="nc" id="L16069">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16070">            r.newlines = 0;</span>
<span class="nc" id="L16071">            addReport(r);</span>
<span class="nc" id="L16072">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L16075">            r = new Report(4025);</span>
<span class="nc" id="L16076">            r.subject = ae.getId();</span>
<span class="nc" id="L16077">            r.add(toHit);</span>
<span class="nc" id="L16078">            r.add(roll);</span>
<span class="nc" id="L16079">            r.newlines = 0;</span>
<span class="nc" id="L16080">            addReport(r);</span>
<span class="nc bnc" id="L16081" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L16082">                r = new Report(3186);</span>
<span class="nc" id="L16083">                r.subject = ae.getId();</span>
<span class="nc" id="L16084">                r.newlines = 0;</span>
<span class="nc" id="L16085">                addReport(r);</span>
            }
<span class="nc bnc" id="L16087" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16088">                r = new Report(3189);</span>
<span class="nc" id="L16089">                r.subject = ae.getId();</span>
<span class="nc" id="L16090">                r.newlines = 0;</span>
<span class="nc" id="L16091">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L16097" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16099">            r = new Report(4035);</span>
<span class="nc" id="L16100">            r.subject = ae.getId();</span>
<span class="nc" id="L16101">            addReport(r);</span>

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L16104" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L16107" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L16108">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16109" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L16110">                        report.subject = ae.getId();</span>
<span class="nc" id="L16111">                    }</span>
<span class="nc" id="L16112">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L16116">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L16120" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L16121" title="All 2 branches missed.">                || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L16123">            r = new Report(4040);</span>
<span class="nc" id="L16124">            r.subject = ae.getId();</span>
<span class="nc" id="L16125">            addReport(r);</span>
<span class="nc" id="L16126">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16127" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16128">                report.subject = ae.getId();</span>
<span class="nc" id="L16129">            }</span>
<span class="nc" id="L16130">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L16133">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L16136">            return;</span>
        }

<span class="nc" id="L16139">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16140">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>

<span class="nc" id="L16142">        r = new Report(4045);</span>
<span class="nc" id="L16143">        r.subject = ae.getId();</span>
<span class="nc" id="L16144">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16145">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16146">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16150" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16151">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16152">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16153">            damage -= toBldg;</span>
<span class="nc" id="L16154">            addNewLines();</span>
<span class="nc" id="L16155">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L16156">                                                           target.getPosition());</span>
<span class="nc bnc" id="L16157" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16158">                report.subject = ae.getId();</span>
<span class="nc" id="L16159">            }</span>
<span class="nc" id="L16160">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L16164">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L16168" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L16169">            r = new Report(4050);</span>
<span class="nc" id="L16170">            r.subject = ae.getId();</span>
<span class="nc" id="L16171">            r.add(te.getShortName());</span>
<span class="nc" id="L16172">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L16173">            r.newlines = 0;</span>
<span class="nc" id="L16174">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L16176" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L16178" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L16180" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16181">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L16182">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }
<span class="nc" id="L16184">            addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc bnc" id="L16186" title="All 2 branches missed.">            if (((Protomech) ae).isEDPCharged()) {</span>
<span class="nc" id="L16187">                r = new Report(3701);</span>
<span class="nc" id="L16188">                int taserRoll = Compute.d6(2) - 2;</span>
<span class="nc" id="L16189">                r.add(taserRoll);</span>
<span class="nc" id="L16190">                r.newlines = 0;</span>
<span class="nc" id="L16191">                vPhaseReport.add(r);</span>

<span class="nc bnc" id="L16193" title="All 2 branches missed.">                if (te instanceof BattleArmor) {</span>
<span class="nc" id="L16194">                    r = new Report(3706);</span>
<span class="nc" id="L16195">                    r.addDesc(te);</span>
                    // shut down for rest of scenario, so we actually kill it
                    // TODO : fix for salvage purposes
<span class="nc" id="L16198">                    HitData targetTrooper = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16199">                    r.add(te.getLocationAbbr(targetTrooper));</span>
<span class="nc" id="L16200">                    vPhaseReport.add(r);</span>
<span class="nc" id="L16201">                    vPhaseReport.addAll(criticalEntity(ae, targetTrooper.getLocation(),</span>
<span class="nc" id="L16202">                            targetTrooper.isRear(), 0, false, false, 0));</span>
<span class="nc bnc" id="L16203" title="All 2 branches missed.">                } else if (te instanceof Mech) {</span>
<span class="nc bnc" id="L16204" title="All 2 branches missed.">                    if (((Mech) te).isIndustrial()) {</span>
<span class="nc bnc" id="L16205" title="All 2 branches missed.">                        if (taserRoll &gt;= 8) {</span>
<span class="nc" id="L16206">                            r = new Report(3705);</span>
<span class="nc" id="L16207">                            r.addDesc(te);</span>
<span class="nc" id="L16208">                            r.add(4);</span>
<span class="nc" id="L16209">                            te.taserShutdown(4, false);</span>
                        } else {
                            // suffer +2 to piloting and gunnery for 4 rounds
<span class="nc" id="L16212">                            r = new Report(3710);</span>
<span class="nc" id="L16213">                            r.addDesc(te);</span>
<span class="nc" id="L16214">                            r.add(2);</span>
<span class="nc" id="L16215">                            r.add(4);</span>
<span class="nc" id="L16216">                            te.setTaserInterference(2, 4, true);</span>
                        }
                    } else {
<span class="nc bnc" id="L16219" title="All 2 branches missed.">                        if (taserRoll &gt;= 11) {</span>
<span class="nc" id="L16220">                            r = new Report(3705);</span>
<span class="nc" id="L16221">                            r.addDesc(te);</span>
<span class="nc" id="L16222">                            r.add(3);</span>
<span class="nc" id="L16223">                            vPhaseReport.add(r);</span>
<span class="nc" id="L16224">                            te.taserShutdown(3, false);</span>
                        } else {
<span class="nc" id="L16226">                            r = new Report(3710);</span>
<span class="nc" id="L16227">                            r.addDesc(te);</span>
<span class="nc" id="L16228">                            r.add(2);</span>
<span class="nc" id="L16229">                            r.add(3);</span>
<span class="nc" id="L16230">                            vPhaseReport.add(r);</span>
<span class="nc" id="L16231">                            te.setTaserInterference(2, 3, true);</span>
                        }
                    }
<span class="nc bnc" id="L16234" title="All 6 branches missed.">                } else if ((te instanceof Protomech) || (te instanceof Tank)</span>
                           || (te instanceof Aero)) {
<span class="nc bnc" id="L16236" title="All 2 branches missed.">                    if (taserRoll &gt;= 8) {</span>
<span class="nc" id="L16237">                        r = new Report(3705);</span>
<span class="nc" id="L16238">                        r.addDesc(te);</span>
<span class="nc" id="L16239">                        r.add(4);</span>
<span class="nc" id="L16240">                        vPhaseReport.add(r);</span>
<span class="nc" id="L16241">                        te.taserShutdown(4, false);</span>
                    } else {
<span class="nc" id="L16243">                        r = new Report(3710);</span>
<span class="nc" id="L16244">                        r.addDesc(te);</span>
<span class="nc" id="L16245">                        r.add(2);</span>
<span class="nc" id="L16246">                        r.add(4);</span>
<span class="nc" id="L16247">                        vPhaseReport.add(r);</span>
<span class="nc" id="L16248">                        te.setTaserInterference(2, 4, false);</span>
                    }
                }

            }
        }

<span class="nc" id="L16255">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L16259" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L16260">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L16262">    }</span>

    /**
     * Handle a brush off attack
     */
    private void resolveBrushOffAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16268">        final BrushOffAttackAction baa = (BrushOffAttackAction) pr.aaa;</span>
<span class="nc" id="L16269">        final Entity ae = game.getEntity(baa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target
        // of a &quot;brush off&quot;, but iNarc pods **are**.
<span class="nc" id="L16272">        Targetable target = game.getTarget(baa.getTargetType(), baa.getTargetId());</span>
<span class="nc" id="L16273">        Entity te = null;</span>
<span class="nc bnc" id="L16274" title="All 2 branches missed.">        final String armName = baa.getArm() == BrushOffAttackAction.LEFT ? &quot;Left Arm&quot; : &quot;Right Arm&quot;;</span>
        Report r;

<span class="nc bnc" id="L16277" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16278">            te = game.getEntity(baa.getTargetId());</span>
        }

        // get damage, ToHitData and roll from the PhysicalResult
        // ASSUMPTION: buildings can't absorb *this* damage.
<span class="nc bnc" id="L16283" title="All 2 branches missed.">        int damage = baa.getArm() == BrushOffAttackAction.LEFT ? pr.damage : pr.damageRight;</span>
<span class="nc bnc" id="L16284" title="All 2 branches missed.">        final ToHitData toHit = baa.getArm() == BrushOffAttackAction.LEFT ? pr.toHit : pr.toHitRight;</span>
<span class="nc bnc" id="L16285" title="All 2 branches missed.">        int roll = baa.getArm() == BrushOffAttackAction.LEFT ? pr.roll : pr.rollRight;</span>

<span class="nc bnc" id="L16287" title="All 2 branches missed.">        if (lastEntityId != baa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16289">            r = new Report(4005);</span>
<span class="nc" id="L16290">            r.subject = ae.getId();</span>
<span class="nc" id="L16291">            r.addDesc(ae);</span>
<span class="nc" id="L16292">            addReport(r);</span>
        }

<span class="nc" id="L16295">        r = new Report(4085);</span>
<span class="nc" id="L16296">        r.subject = ae.getId();</span>
<span class="nc" id="L16297">        r.indent();</span>
<span class="nc" id="L16298">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16299">        r.add(armName);</span>
<span class="nc" id="L16300">        r.newlines = 0;</span>
<span class="nc" id="L16301">        addReport(r);</span>

<span class="nc bnc" id="L16303" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16304">            r = new Report(4090);</span>
<span class="nc" id="L16305">            r.subject = ae.getId();</span>
<span class="nc" id="L16306">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16307">            addReport(r);</span>
<span class="nc" id="L16308">            return;</span>
        }

        // report the roll
<span class="nc" id="L16312">        r = new Report(4025);</span>
<span class="nc" id="L16313">        r.subject = ae.getId();</span>
<span class="nc" id="L16314">        r.add(toHit);</span>
<span class="nc" id="L16315">        r.add(roll);</span>
<span class="nc" id="L16316">        r.newlines = 0;</span>
<span class="nc" id="L16317">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L16320" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16322">            r = new Report(4035);</span>
<span class="nc" id="L16323">            r.subject = ae.getId();</span>
<span class="nc" id="L16324">            addReport(r);</span>

            // Missed Brush Off attacks cause punch damage to the attacker.
<span class="nc" id="L16327">            toHit.setHitTable(ToHitData.HIT_PUNCH);</span>
<span class="nc" id="L16328">            toHit.setSideTable(ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16329">            HitData hit = ae.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16330">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16331">            r = new Report(4095);</span>
<span class="nc" id="L16332">            r.subject = ae.getId();</span>
<span class="nc" id="L16333">            r.addDesc(ae);</span>
<span class="nc" id="L16334">            r.add(ae.getLocationAbbr(hit));</span>
<span class="nc" id="L16335">            r.newlines = 0;</span>
<span class="nc" id="L16336">            addReport(r);</span>
<span class="nc" id="L16337">            addReport(damageEntity(ae, hit, damage));</span>
<span class="nc" id="L16338">            addNewLines();</span>
            // if this is an industrial mech, it needs to check for crits
            // at the end of turn
<span class="nc bnc" id="L16341" title="All 4 branches missed.">            if ((ae instanceof Mech) &amp;&amp; ((Mech) ae).isIndustrial()) {</span>
<span class="nc" id="L16342">                ((Mech) ae).setCheckForCrit(true);</span>
            }
<span class="nc" id="L16344">            return;</span>
        }

        // Different target types get different handling.
<span class="nc bnc" id="L16348" title="All 3 branches missed.">        switch (target.getTargetType()) {</span>
            case Targetable.TYPE_ENTITY:
                // Handle Entity targets.
<span class="nc" id="L16351">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16352">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16353">                r = new Report(4045);</span>
<span class="nc" id="L16354">                r.subject = ae.getId();</span>
<span class="nc" id="L16355">                r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16356">                r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16357">                addReport(r);</span>
<span class="nc" id="L16358">                addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16359">                addNewLines();</span>

                // Dislodge the swarming infantry.
<span class="nc" id="L16362">                ae.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L16363">                te.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L16364">                r = new Report(4100);</span>
<span class="nc" id="L16365">                r.subject = ae.getId();</span>
<span class="nc" id="L16366">                r.add(te.getDisplayName());</span>
<span class="nc" id="L16367">                addReport(r);</span>
<span class="nc" id="L16368">                break;</span>
            case Targetable.TYPE_INARC_POD:
                // Handle iNarc pod targets.
                // TODO : check the return code and handle false appropriately.
<span class="nc" id="L16372">                ae.removeINarcPod((INarcPod) target);</span>
                // // TODO : confirm that we don't need to update the attacker.
                // //killme
                // entityUpdate( ae.getId() ); // killme
<span class="nc" id="L16376">                r = new Report(4105);</span>
<span class="nc" id="L16377">                r.subject = ae.getId();</span>
<span class="nc" id="L16378">                r.add(target.getDisplayName());</span>
<span class="nc" id="L16379">                addReport(r);</span>
                break;
            // TODO : add a default: case and handle it appropriately.
        }
<span class="nc" id="L16383">    }</span>

    /**
     * Handle a thrash attack
     */
    private void resolveThrashAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16389">        final ThrashAttackAction taa = (ThrashAttackAction) pr.aaa;</span>
<span class="nc" id="L16390">        final Entity ae = game.getEntity(taa.getEntityId());</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16393">        int hits = pr.damage;</span>
<span class="nc" id="L16394">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16395">        int roll = pr.roll;</span>
<span class="nc bnc" id="L16396" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS)
<span class="nc bnc" id="L16398" title="All 2 branches missed.">                                 &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L16401">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16402" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)
<span class="nc bnc" id="L16404" title="All 2 branches missed.">                                   &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // PLEASE NOTE: buildings are *never* the target of a &quot;thrash&quot;.
<span class="nc" id="L16407">        final Entity te = game.getEntity(taa.getTargetId());</span>
        Report r;

<span class="nc bnc" id="L16410" title="All 2 branches missed.">        if (lastEntityId != taa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16412">            r = new Report(4005);</span>
<span class="nc" id="L16413">            r.subject = ae.getId();</span>
<span class="nc" id="L16414">            r.addDesc(ae);</span>
<span class="nc" id="L16415">            addReport(r);</span>
        }

<span class="nc" id="L16418">        r = new Report(4110);</span>
<span class="nc" id="L16419">        r.subject = ae.getId();</span>
<span class="nc" id="L16420">        r.indent();</span>
<span class="nc" id="L16421">        r.addDesc(te);</span>
<span class="nc" id="L16422">        r.newlines = 0;</span>
<span class="nc" id="L16423">        addReport(r);</span>

<span class="nc bnc" id="L16425" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16426">            r = new Report(4115);</span>
<span class="nc" id="L16427">            r.subject = ae.getId();</span>
<span class="nc" id="L16428">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16429">            addReport(r);</span>
<span class="nc" id="L16430">            return;</span>
        }

        // Thrash attack may hit automatically
<span class="nc bnc" id="L16434" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16435">            r = new Report(4120);</span>
        } else {
            // report the roll
<span class="nc" id="L16438">            r = new Report(4025);</span>
<span class="nc" id="L16439">            r.subject = ae.getId();</span>
<span class="nc" id="L16440">            r.add(toHit);</span>
<span class="nc" id="L16441">            r.add(roll);</span>
<span class="nc" id="L16442">            r.newlines = 0;</span>
<span class="nc" id="L16443">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L16446" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L16448">                r = new Report(4035);</span>
<span class="nc" id="L16449">                r.subject = ae.getId();</span>
<span class="nc" id="L16450">                addReport(r);</span>
<span class="nc" id="L16451">                return;</span>
            }
<span class="nc" id="L16453">            r = new Report(4125);</span>
        }
<span class="nc" id="L16455">        r.subject = ae.getId();</span>
<span class="nc" id="L16456">        r.newlines = 0;</span>
<span class="nc" id="L16457">        addReport(r);</span>

        // Standard damage loop in 5 point clusters.
<span class="nc bnc" id="L16460" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16461">            hits = (int) Math.floor(hits / 2.0);</span>
        }
<span class="nc bnc" id="L16463" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16464">            hits += toHit.getMoS() / 3;</span>
        }

<span class="nc" id="L16467">        r = new Report(4130);</span>
<span class="nc" id="L16468">        r.subject = ae.getId();</span>
<span class="nc" id="L16469">        r.add(hits);</span>
<span class="nc" id="L16470">        r.newlines = 0;</span>
<span class="nc" id="L16471">        addReport(r);</span>
<span class="nc bnc" id="L16472" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16473">            r = new Report(3186);</span>
<span class="nc" id="L16474">            r.subject = ae.getId();</span>
<span class="nc" id="L16475">            r.newlines = 0;</span>
<span class="nc" id="L16476">            addReport(r);</span>
        }
<span class="nc bnc" id="L16478" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16479">            r = new Report(3189);</span>
<span class="nc" id="L16480">            r.subject = ae.getId();</span>
<span class="nc" id="L16481">            r.newlines = 0;</span>
<span class="nc" id="L16482">            addReport(r);</span>
        }

<span class="nc bnc" id="L16485" title="All 2 branches missed.">        while (hits &gt; 0) {</span>
<span class="nc" id="L16486">            int damage = Math.min(5, hits);</span>
<span class="nc" id="L16487">            hits -= damage;</span>
<span class="nc" id="L16488">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16489">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16490">            r = new Report(4135);</span>
<span class="nc" id="L16491">            r.subject = ae.getId();</span>
<span class="nc" id="L16492">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16493">            r.newlines = 0;</span>
<span class="nc" id="L16494">            addReport(r);</span>
<span class="nc" id="L16495">            addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16496">        }</span>

<span class="nc" id="L16498">        addNewLines();</span>

        // Thrash attacks cause PSRs. Failed PSRs cause falling damage.
        // This fall damage applies even though the Thrashing Mek is prone.
<span class="nc" id="L16502">        PilotingRollData rollData = ae.getBasePilotingRoll();</span>
<span class="nc" id="L16503">        ae.addPilotingModifierForTerrain(rollData);</span>
<span class="nc" id="L16504">        rollData.addModifier(0, &quot;thrashing at infantry&quot;);</span>
<span class="nc" id="L16505">        r = new Report(4140);</span>
<span class="nc" id="L16506">        r.subject = ae.getId();</span>
<span class="nc" id="L16507">        r.addDesc(ae);</span>
<span class="nc" id="L16508">        addReport(r);</span>
<span class="nc" id="L16509">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L16510">        r = new Report(2190);</span>
<span class="nc" id="L16511">        r.subject = ae.getId();</span>
<span class="nc" id="L16512">        r.add(rollData.getValueAsString());</span>
<span class="nc" id="L16513">        r.add(rollData.getDesc());</span>
<span class="nc" id="L16514">        r.add(diceRoll);</span>
<span class="nc bnc" id="L16515" title="All 2 branches missed.">        if (diceRoll &lt; rollData.getValue()) {</span>
<span class="nc" id="L16516">            r.choose(false);</span>
<span class="nc" id="L16517">            addReport(r);</span>
<span class="nc" id="L16518">            addReport(doEntityFall(ae, rollData));</span>
        } else {
<span class="nc" id="L16520">            r.choose(true);</span>
<span class="nc" id="L16521">            addReport(r);</span>
        }
<span class="nc" id="L16523">    }</span>

    /**
     * Handle a thrash attack
     */
    private void resolveBAVibroClawAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16529">        final BAVibroClawAttackAction bvaa = (BAVibroClawAttackAction) pr.aaa;</span>
<span class="nc" id="L16530">        final Entity ae = game.getEntity(bvaa.getEntityId());</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16533">        int hits = pr.damage;</span>
<span class="nc" id="L16534">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16535">        int roll = pr.roll;</span>
<span class="nc bnc" id="L16536" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS)
<span class="nc bnc" id="L16538" title="All 2 branches missed.">                                 &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L16541">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16542" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)
<span class="nc bnc" id="L16544" title="All 2 branches missed.">                                   &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // PLEASE NOTE: buildings are *never* the target of a BA vibroclaw
        // attack.
<span class="nc" id="L16548">        final Entity te = game.getEntity(bvaa.getTargetId());</span>
        Report r;

<span class="nc bnc" id="L16551" title="All 2 branches missed.">        if (lastEntityId != bvaa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16553">            r = new Report(4005);</span>
<span class="nc" id="L16554">            r.subject = ae.getId();</span>
<span class="nc" id="L16555">            r.addDesc(ae);</span>
<span class="nc" id="L16556">            addReport(r);</span>
        }

<span class="nc" id="L16559">        r = new Report(4146);</span>
<span class="nc" id="L16560">        r.subject = ae.getId();</span>
<span class="nc" id="L16561">        r.indent();</span>
<span class="nc" id="L16562">        r.addDesc(te);</span>
<span class="nc" id="L16563">        r.newlines = 0;</span>
<span class="nc" id="L16564">        addReport(r);</span>

<span class="nc bnc" id="L16566" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16567">            r = new Report(4147);</span>
<span class="nc" id="L16568">            r.subject = ae.getId();</span>
<span class="nc" id="L16569">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16570">            addReport(r);</span>
<span class="nc" id="L16571">            return;</span>
        }

        // we may hit automatically
<span class="nc bnc" id="L16575" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16576">            r = new Report(4120);</span>
<span class="nc" id="L16577">            r.subject = ae.getId();</span>
<span class="nc" id="L16578">            r.newlines = 0;</span>
<span class="nc" id="L16579">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L16582">            r = new Report(4025);</span>
<span class="nc" id="L16583">            r.subject = ae.getId();</span>
<span class="nc" id="L16584">            r.add(toHit);</span>
<span class="nc" id="L16585">            r.add(roll);</span>
<span class="nc" id="L16586">            r.newlines = 0;</span>
<span class="nc" id="L16587">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L16590" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L16592">                r = new Report(4035);</span>
<span class="nc" id="L16593">                r.subject = ae.getId();</span>
<span class="nc" id="L16594">                addReport(r);</span>
<span class="nc" id="L16595">                return;</span>
            }
        }

        // Standard damage loop
<span class="nc bnc" id="L16600" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16601">            hits = (int) Math.floor(hits / 2.0);</span>
        }
<span class="nc bnc" id="L16603" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16604">            hits += toHit.getMoS() / 3;</span>
        }
<span class="nc bnc" id="L16606" title="All 2 branches missed.">        if (te.isConventionalInfantry()) {</span>
<span class="nc" id="L16607">            r = new Report(4149);</span>
<span class="nc" id="L16608">            r.subject = ae.getId();</span>
<span class="nc" id="L16609">            r.add(hits);</span>
        } else {
<span class="nc" id="L16611">            r = new Report(4148);</span>
<span class="nc" id="L16612">            r.subject = ae.getId();</span>
<span class="nc" id="L16613">            r.add(hits);</span>
<span class="nc" id="L16614">            r.add(ae.getVibroClaws());</span>
        }
<span class="nc" id="L16616">        r.newlines = 0;</span>
<span class="nc" id="L16617">        addReport(r);</span>
<span class="nc bnc" id="L16618" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16619">            r = new Report(3186);</span>
<span class="nc" id="L16620">            r.subject = ae.getId();</span>
<span class="nc" id="L16621">            r.newlines = 0;</span>
<span class="nc" id="L16622">            addReport(r);</span>
        }
<span class="nc bnc" id="L16624" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16625">            r = new Report(3189);</span>
<span class="nc" id="L16626">            r.subject = ae.getId();</span>
<span class="nc" id="L16627">            r.newlines = 0;</span>
<span class="nc" id="L16628">            addReport(r);</span>
        }
<span class="nc bnc" id="L16630" title="All 2 branches missed.">        while (hits &gt; 0) {</span>
            // BA get hit separately by each attacking BA trooper
<span class="nc" id="L16632">            int damage = Math.min(ae.getVibroClaws(), hits);</span>
            // conventional infantry get hit in one lump
<span class="nc bnc" id="L16634" title="All 2 branches missed.">            if (te.isConventionalInfantry()) {</span>
<span class="nc" id="L16635">                damage = hits;</span>
            }
<span class="nc" id="L16637">            hits -= damage;</span>
<span class="nc" id="L16638">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16639">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16640">            r = new Report(4135);</span>
<span class="nc" id="L16641">            r.subject = ae.getId();</span>
<span class="nc" id="L16642">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16643">            r.newlines = 0;</span>
<span class="nc" id="L16644">            addReport(r);</span>
<span class="nc" id="L16645">            addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16646">        }</span>
<span class="nc" id="L16647">        addNewLines();</span>
<span class="nc" id="L16648">    }</span>

    /**
     * Handle a club attack
     */
    private void resolveClubAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16654">        final ClubAttackAction caa = (ClubAttackAction) pr.aaa;</span>
<span class="nc" id="L16655">        final Entity ae = game.getEntity(caa.getEntityId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16657">        int damage = pr.damage;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L16659" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16660">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc" id="L16662">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16663">        int roll = pr.roll;</span>
<span class="nc" id="L16664">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
<span class="nc" id="L16665">        Entity te = null;</span>
<span class="nc bnc" id="L16666" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16667">            te = (Entity) target;</span>
        }
<span class="nc" id="L16669">        boolean throughFront = true;</span>
<span class="nc bnc" id="L16670" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L16671">            throughFront = Compute</span>
<span class="nc" id="L16672">                    .isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc" id="L16674">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L16675" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16676" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
        // Make sure the MoS is zero for *automatic* hits in case direct blows
        // are in force.
<span class="nc bnc" id="L16681" title="All 2 branches missed.">        toHit.setMoS((roll == Integer.MAX_VALUE) ? 0 : roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16682" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16683" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;


        // Which building takes the damage?
<span class="nc" id="L16689">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

        // restore club attack
<span class="nc" id="L16692">        caa.getClub().restore();</span>

        // Shield bash causes 1 point of damage to the shield
<span class="nc bnc" id="L16695" title="All 2 branches missed.">        if (((MiscType) caa.getClub().getType()).isShield()) {</span>
<span class="nc" id="L16696">            ((Mech) ae).shieldAbsorptionDamage(1, caa.getClub().getLocation(), false);</span>
        }

<span class="nc bnc" id="L16699" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16701">            r = new Report(4005);</span>
<span class="nc" id="L16702">            r.subject = ae.getId();</span>
<span class="nc" id="L16703">            r.addDesc(ae);</span>
<span class="nc" id="L16704">            addReport(r);</span>
        }

<span class="nc" id="L16707">        r = new Report(4145);</span>
<span class="nc" id="L16708">        r.subject = ae.getId();</span>
<span class="nc" id="L16709">        r.indent();</span>
<span class="nc" id="L16710">        r.add(caa.getClub().getName());</span>
<span class="nc" id="L16711">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16712">        r.newlines = 0;</span>
<span class="nc" id="L16713">        addReport(r);</span>

        // Flail/Wrecking Ball auto misses on a 2 and hits themself.
<span class="nc bnc" id="L16716" title="All 2 branches missed.">        if ((caa.getClub().getType().hasSubType(MiscType.S_FLAIL)</span>
<span class="nc bnc" id="L16717" title="All 4 branches missed.">                || caa.getClub().getType().hasSubType(MiscType.S_WRECKING_BALL))</span>
            &amp;&amp; (roll == 2)) {
            // miss
<span class="nc" id="L16720">            r = new Report(4035);</span>
<span class="nc" id="L16721">            r.subject = ae.getId();</span>
<span class="nc" id="L16722">            addReport(r);</span>
<span class="nc" id="L16723">            ToHitData newToHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS,</span>
                                               &quot;hit with own flail/wrecking ball&quot;);
<span class="nc" id="L16725">            pr.damage = ClubAttackAction.getDamageFor(ae, caa.getClub(), false, caa.isZweihandering());</span>
<span class="nc" id="L16726">            pr.damage = (pr.damage / 2) + (pr.damage % 2);</span>
<span class="nc" id="L16727">            newToHit.setHitTable(ToHitData.HIT_NORMAL);</span>
<span class="nc" id="L16728">            newToHit.setSideTable(ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16729">            pr.toHit = newToHit;</span>
<span class="nc" id="L16730">            pr.aaa.setTargetId(ae.getId());</span>
<span class="nc" id="L16731">            pr.aaa.setTargetType(Targetable.TYPE_ENTITY);</span>
<span class="nc" id="L16732">            pr.roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L16733">            resolveClubAttack(pr, ae.getId());</span>
<span class="nc bnc" id="L16734" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16735">                game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                        &quot;missed a flail/wrecking ball attack&quot;));
            } else {
<span class="nc" id="L16738">                game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                                                 &quot;missed a flail/wrecking ball attack&quot;));
            }
<span class="nc bnc" id="L16741" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16742">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16743">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16744">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16746">            return;</span>
        }

        // Need to compute 2d6 damage. and add +3 heat build up.
<span class="nc bnc" id="L16750" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_BUZZSAW)) {</span>
<span class="nc" id="L16751">            damage = Compute.d6(2);</span>
<span class="nc" id="L16752">            ae.heatBuildup += 3;</span>

            // Buzzsaw's blade will shatter on a roll of 2.
<span class="nc bnc" id="L16755" title="All 2 branches missed.">            if (roll == 2) {</span>

<span class="nc" id="L16757">                Mounted club = caa.getClub();</span>

<span class="nc bnc" id="L16759" title="All 2 branches missed.">                for (Mounted eq : ae.getWeaponList()) {</span>
<span class="nc bnc" id="L16760" title="All 2 branches missed.">                    if ((eq.getLocation() == club.getLocation())</span>
<span class="nc bnc" id="L16761" title="All 2 branches missed.">                        &amp;&amp; (eq.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L16762" title="All 2 branches missed.">                        &amp;&amp; eq.getType().hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L16763" title="All 2 branches missed.">                        &amp;&amp; eq.getType().hasSubType(MiscType.S_BUZZSAW)) {</span>
<span class="nc" id="L16764">                        eq.setHit(true);</span>
<span class="nc" id="L16765">                        break;</span>
                    }
<span class="nc" id="L16767">                }</span>
<span class="nc" id="L16768">                r = new Report(4037);</span>
<span class="nc" id="L16769">                r.subject = ae.getId();</span>
<span class="nc" id="L16770">                addReport(r);</span>
<span class="nc bnc" id="L16771" title="All 2 branches missed.">                if(caa.isZweihandering()) {</span>
<span class="nc" id="L16772">                    ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16773">                    criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16774">                    applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
                }
<span class="nc" id="L16776">                return;</span>
            }
        }

<span class="nc bnc" id="L16780" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16781">            r = new Report(4075);</span>
<span class="nc" id="L16782">            r.subject = ae.getId();</span>
<span class="nc" id="L16783">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16784">            addReport(r);</span>
<span class="nc bnc" id="L16785" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE_THB)) {</span>
<span class="nc bnc" id="L16786" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16787">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16790">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16794" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE)) {</span>
<span class="nc bnc" id="L16795" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16796">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16799">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16803" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16804">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16805">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16806">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16808">            return;</span>
<span class="nc bnc" id="L16809" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16810">            r = new Report(4080);</span>
<span class="nc" id="L16811">            r.subject = ae.getId();</span>
<span class="nc" id="L16812">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16813">            r.newlines = 0;</span>
<span class="nc" id="L16814">            addReport(r);</span>
<span class="nc" id="L16815">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L16818">            r = new Report(4025);</span>
<span class="nc" id="L16819">            r.subject = ae.getId();</span>
<span class="nc" id="L16820">            r.add(toHit);</span>
<span class="nc" id="L16821">            r.add(roll);</span>
<span class="nc" id="L16822">            r.newlines = 0;</span>
<span class="nc" id="L16823">            addReport(r);</span>
<span class="nc bnc" id="L16824" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L16825">                r = new Report(3186);</span>
<span class="nc" id="L16826">                r.subject = ae.getId();</span>
<span class="nc" id="L16827">                r.newlines = 0;</span>
<span class="nc" id="L16828">                addReport(r);</span>
            }
<span class="nc bnc" id="L16830" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16831">                r = new Report(3189);</span>
<span class="nc" id="L16832">                r.subject = ae.getId();</span>
<span class="nc" id="L16833">                r.newlines = 0;</span>
<span class="nc" id="L16834">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L16840" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16842">            r = new Report(4035);</span>
<span class="nc" id="L16843">            r.subject = ae.getId();</span>
<span class="nc" id="L16844">            addReport(r);</span>
<span class="nc bnc" id="L16845" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE_THB)) {</span>
<span class="nc bnc" id="L16846" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16847">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16850">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16854" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE)) {</span>
<span class="nc bnc" id="L16855" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16856">                    game.addControlRoll(new PilotingRollData(ae.getId(), 2,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16859">                    game.addPSR(new PilotingRollData(ae.getId(), 2,</span>
                            &quot;missed a mace attack&quot;));
                }
            }

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L16865" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L16868" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L16869">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg,</span>
<span class="nc" id="L16870">                                                                   damage, target.getPosition());</span>
<span class="nc bnc" id="L16871" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L16872">                        report.subject = ae.getId();</span>
<span class="nc" id="L16873">                    }</span>
<span class="nc" id="L16874">                    addReport(buildingReport);</span>
                }

            }
<span class="nc bnc" id="L16878" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16879">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16880">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16881">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16883">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L16887" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L16888" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L16890">            r = new Report(4040);</span>
<span class="nc" id="L16891">            r.subject = ae.getId();</span>
<span class="nc" id="L16892">            addReport(r);</span>
<span class="nc" id="L16893">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16894" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16895">                report.subject = ae.getId();</span>
<span class="nc" id="L16896">            }</span>
<span class="nc" id="L16897">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L16900">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

<span class="nc bnc" id="L16902" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16903">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16904">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16905">                applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
<span class="nc bnc" id="L16906" title="All 2 branches missed.">                if (caa.getClub().getType().hasSubType(MiscType.S_CLUB)) {</span>
                    // the club breaks
<span class="nc" id="L16908">                    r = new Report(4150);</span>
<span class="nc" id="L16909">                    r.subject = ae.getId();</span>
<span class="nc" id="L16910">                    r.add(caa.getClub().getName());</span>
<span class="nc" id="L16911">                    addReport(r);</span>
<span class="nc" id="L16912">                    ae.removeMisc(caa.getClub().getName());</span>
                }
            }
            // And we're done!
<span class="nc" id="L16916">            return;</span>
        }

<span class="nc" id="L16919">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16920">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16921">        r = new Report(4045);</span>
<span class="nc" id="L16922">        r.subject = ae.getId();</span>
<span class="nc" id="L16923">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16924">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16925">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16929" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16930">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16931">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16932">            damage -= toBldg;</span>
<span class="nc" id="L16933">            addNewLines();</span>
<span class="nc" id="L16934">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16935" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16936">                report.subject = ae.getId();</span>
<span class="nc" id="L16937">            }</span>
<span class="nc" id="L16938">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L16942">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L16946" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L16947">            r = new Report(4050);</span>
<span class="nc" id="L16948">            r.subject = ae.getId();</span>
<span class="nc" id="L16949">            r.add(te.getShortName());</span>
<span class="nc" id="L16950">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L16951">            r.newlines = 0;</span>
<span class="nc" id="L16952">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L16954" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L16956" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L16958" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16959">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L16960">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

<span class="nc" id="L16963">            damage = checkForSpikes(te, hit.getLocation(), damage, ae, Entity.LOC_NONE);</span>

<span class="nc" id="L16965">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L16966">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                                   false, throughFront));
<span class="nc bnc" id="L16968" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L16970">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM, VTOL.CRIT_ROTOR_DESTROYED),
                        false, 0, false));
            }
        }

        // On a roll of 10+ a lance hitting a mech/Vehicle can cause 1 point of
        // internal damage
<span class="nc bnc" id="L16978" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_LANCE)</span>
<span class="nc bnc" id="L16979" title="All 2 branches missed.">            &amp;&amp; (te.getArmor(hit) &gt; 0)</span>
<span class="nc bnc" id="L16980" title="All 2 branches missed.">            &amp;&amp; (te.getArmorType(hit.getLocation()) != EquipmentType.T_ARMOR_HARDENED)</span>
<span class="nc bnc" id="L16981" title="All 2 branches missed.">            &amp;&amp; (te.getArmorType(hit.getLocation()) != EquipmentType.T_ARMOR_FERRO_LAMELLOR)) {</span>
<span class="nc" id="L16982">            roll = Compute.d6(2);</span>
            // Pierce checking report
<span class="nc" id="L16984">            r = new Report(4021);</span>
<span class="nc" id="L16985">            r.indent(2);</span>
<span class="nc" id="L16986">            r.subject = ae.getId();</span>
<span class="nc" id="L16987">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16988">            r.add(roll);</span>
<span class="nc" id="L16989">            addReport(r);</span>
<span class="nc bnc" id="L16990" title="All 2 branches missed.">            if (roll &gt;= 10) {</span>
<span class="nc" id="L16991">                hit.makeGlancingBlow();</span>
<span class="nc" id="L16992">                addReport(damageEntity(te, hit, 1, false, DamageType.NONE,</span>
                                       true, false, throughFront));
            }
        }

        // TODO : Verify this is correct according to latest rules
<span class="nc bnc" id="L16998" title="All 6 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_WRECKING_BALL)</span>
                &amp;&amp; (ae instanceof SupportTank) &amp;&amp; (te instanceof Mech)) {
            // forces a PSR like a charge
<span class="nc bnc" id="L17001" title="All 4 branches missed.">            if (te instanceof LandAirMech &amp;&amp; te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17002">                game.addControlRoll(new PilotingRollData(te.getId(), 2,</span>
                        &quot;was hit by wrecking ball&quot;));
            } else {
<span class="nc" id="L17005">                game.addPSR(new PilotingRollData(te.getId(), 2,</span>
                        &quot;was hit by wrecking ball&quot;));
            }
        }

        // Chain whips can entangle 'Mech and ProtoMech limbs. This
        // implementation assumes that in order to do so the limb must still
        // have some structure left, so if the whip hits and destroys a
        // location in the same attack no special effects take place.
<span class="nc bnc" id="L17014" title="All 6 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_CHAIN_WHIP)</span>
                &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))) {
<span class="nc" id="L17016">            addNewLines();</span>

<span class="nc" id="L17018">            int loc = hit.getLocation();</span>

<span class="nc bnc" id="L17020" title="All 2 branches missed.">            boolean mightTrip = (te instanceof Mech)</span>
<span class="nc bnc" id="L17021" title="All 2 branches missed.">                    &amp;&amp; te.locationIsLeg(loc)</span>
<span class="nc bnc" id="L17022" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17023" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationDoomed(loc)</span>
<span class="nc bnc" id="L17024" title="All 2 branches missed.">                    &amp;&amp; !te.hasActiveShield(loc)</span>
<span class="nc bnc" id="L17025" title="All 2 branches missed.">                    &amp;&amp; !te.hasPassiveShield(loc);</span>

<span class="nc bnc" id="L17027" title="All 6 branches missed.">            boolean mightGrapple = ((te instanceof Mech)</span>
                    &amp;&amp; ((loc == Mech.LOC_LARM) || (loc == Mech.LOC_RARM))
<span class="nc bnc" id="L17029" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17030" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationDoomed(loc)</span>
<span class="nc bnc" id="L17031" title="All 2 branches missed.">                    &amp;&amp; !te.hasActiveShield(loc)</span>
<span class="nc bnc" id="L17032" title="All 2 branches missed.">                    &amp;&amp; !te.hasPassiveShield(loc)</span>
<span class="nc bnc" id="L17033" title="All 10 branches missed.">                    &amp;&amp; !te.hasNoDefenseShield(loc))</span>
                    || ((te instanceof Protomech)
                        &amp;&amp; ((loc == Protomech.LOC_LARM) || (loc == Protomech.LOC_RARM)
                            || (loc == Protomech.LOC_LEG))
                        // Only check location status after confirming we did
                        // hit a limb -- Protos have no actual near-miss
                        // &quot;location&quot; and will throw an exception if it's
                        // referenced here.
<span class="nc bnc" id="L17041" title="All 2 branches missed.">                        &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17042" title="All 2 branches missed.">                        &amp;&amp; !te.isLocationDoomed(loc));</span>

<span class="nc bnc" id="L17044" title="All 2 branches missed.">            if (mightTrip) {</span>
<span class="nc" id="L17045">                roll = Compute.d6(2);</span>
<span class="nc" id="L17046">                int toHitValue = toHit.getValue();</span>
<span class="nc" id="L17047">                String toHitDesc = toHit.getDesc();</span>
<span class="nc bnc" id="L17048" title="All 6 branches missed.">                if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).hasTSM() &amp;&amp; (ae.heat &gt;= 9))</span>
<span class="nc bnc" id="L17049" title="All 6 branches missed.">                        &amp;&amp; (!((Mech) te).hasTSM() || ((((Mech) te).hasTSM()) &amp;&amp; (te.heat &lt; 9)))) {</span>
<span class="nc" id="L17050">                    toHitValue -= 2;</span>
<span class="nc" id="L17051">                    toHitDesc += &quot; -2 (TSM Active Bonus)&quot;;</span>
                }

<span class="nc" id="L17054">                r = new Report(4450);</span>
<span class="nc" id="L17055">                r.subject = ae.getId();</span>
<span class="nc" id="L17056">                r.add(ae.getShortName());</span>
<span class="nc" id="L17057">                r.add(te.getShortName());</span>
<span class="nc" id="L17058">                r.addDataWithTooltip(String.valueOf(toHitValue), toHitDesc);</span>
<span class="nc" id="L17059">                r.add(roll);</span>
<span class="nc" id="L17060">                r.indent(2);</span>
<span class="nc" id="L17061">                r.newlines = 0;</span>
<span class="nc" id="L17062">                addReport(r);</span>

<span class="nc bnc" id="L17064" title="All 2 branches missed.">                if (roll &gt;= toHitValue) {</span>
<span class="nc" id="L17065">                    r = new Report(2270);</span>
<span class="nc" id="L17066">                    r.subject = ae.getId();</span>
<span class="nc" id="L17067">                    r.newlines = 0;</span>
<span class="nc" id="L17068">                    addReport(r);</span>

<span class="nc" id="L17070">                    game.addPSR(new PilotingRollData(te.getId(), 3, &quot;Snared by chain whip&quot;));</span>
                } else {
<span class="nc" id="L17072">                    r = new Report(2357);</span>
<span class="nc" id="L17073">                    r.subject = ae.getId();</span>
<span class="nc" id="L17074">                    r.newlines = 0;</span>
<span class="nc" id="L17075">                    addReport(r);</span>
                }
<span class="nc bnc" id="L17077" title="All 2 branches missed.">            } else if (mightGrapple) {</span>
<span class="nc" id="L17078">                GrappleAttackAction gaa = new GrappleAttackAction(ae.getId(), te.getId());</span>
                int grappleSide;
<span class="nc bnc" id="L17080" title="All 2 branches missed.">                if (caa.getClub().getLocation() == Mech.LOC_RARM) {</span>
<span class="nc" id="L17081">                    grappleSide = Entity.GRAPPLE_RIGHT;</span>
                } else {
<span class="nc" id="L17083">                    grappleSide = Entity.GRAPPLE_LEFT;</span>
                }
<span class="nc" id="L17085">                ToHitData grappleHit = GrappleAttackAction.toHit(game, ae.getId(), target,</span>
                        grappleSide, true);
<span class="nc" id="L17087">                PhysicalResult grappleResult = new PhysicalResult();</span>
<span class="nc" id="L17088">                grappleResult.aaa = gaa;</span>
<span class="nc" id="L17089">                grappleResult.toHit = grappleHit;</span>
<span class="nc" id="L17090">                grappleResult.roll = Compute.d6(2);</span>
<span class="nc" id="L17091">                resolveGrappleAttack(grappleResult, lastEntityId, grappleSide,</span>
<span class="nc bnc" id="L17092" title="All 2 branches missed.">                        hit.getLocation() == Mech.LOC_RARM ? Entity.GRAPPLE_RIGHT : Entity.GRAPPLE_LEFT);</span>
            }
        }

<span class="nc" id="L17096">        addNewLines();</span>

<span class="nc bnc" id="L17098" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_TREE_CLUB)) {</span>
            // the club breaks
<span class="nc" id="L17100">            r = new Report(4150);</span>
<span class="nc" id="L17101">            r.subject = ae.getId();</span>
<span class="nc" id="L17102">            r.add(caa.getClub().getName());</span>
<span class="nc" id="L17103">            addReport(r);</span>
<span class="nc" id="L17104">            ae.removeMisc(caa.getClub().getName());</span>
        }

<span class="nc bnc" id="L17107" title="All 2 branches missed.">        if(caa.isZweihandering()) {</span>
<span class="nc" id="L17108">            ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L17109">            criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L17110">            applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
<span class="nc bnc" id="L17111" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_CLUB)) {</span>
                // the club breaks
<span class="nc" id="L17113">                r = new Report(4150);</span>
<span class="nc" id="L17114">                r.subject = ae.getId();</span>
<span class="nc" id="L17115">                r.add(caa.getClub().getName());</span>
<span class="nc" id="L17116">                addReport(r);</span>
<span class="nc" id="L17117">                ae.removeMisc(caa.getClub().getName());</span>
            }
        }

<span class="nc" id="L17121">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17125" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L17126">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17128">    }</span>

    /**
     * Handle a push attack
     */
    private void resolvePushAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17134">        final PushAttackAction paa = (PushAttackAction) pr.aaa;</span>
<span class="nc" id="L17135">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17137">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17139">        int roll = pr.roll;</span>
<span class="nc" id="L17140">        final ToHitData toHit = pr.toHit;</span>
        Report r;

        // was this push resolved earlier?
<span class="nc bnc" id="L17144" title="All 2 branches missed.">        if (pr.pushBackResolved) {</span>
<span class="nc" id="L17145">            return;</span>
        }
        // don't try this one again
<span class="nc" id="L17148">        pr.pushBackResolved = true;</span>

<span class="nc bnc" id="L17150" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17152">            r = new Report(4005);</span>
<span class="nc" id="L17153">            r.subject = ae.getId();</span>
<span class="nc" id="L17154">            r.addDesc(ae);</span>
<span class="nc" id="L17155">            addReport(r);</span>
        }

<span class="nc" id="L17158">        r = new Report(4155);</span>
<span class="nc" id="L17159">        r.subject = ae.getId();</span>
<span class="nc" id="L17160">        r.indent();</span>
<span class="nc" id="L17161">        r.addDesc(te);</span>
<span class="nc" id="L17162">        r.newlines = 0;</span>
<span class="nc" id="L17163">        addReport(r);</span>

<span class="nc bnc" id="L17165" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17166">            r = new Report(4160);</span>
<span class="nc" id="L17167">            r.subject = ae.getId();</span>
<span class="nc" id="L17168">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17169">            addReport(r);</span>
<span class="nc" id="L17170">            return;</span>
        }

        // report the roll
<span class="nc" id="L17174">        r = new Report(4025);</span>
<span class="nc" id="L17175">        r.subject = ae.getId();</span>
<span class="nc" id="L17176">        r.add(toHit);</span>
<span class="nc" id="L17177">        r.add(roll);</span>
<span class="nc" id="L17178">        r.newlines = 0;</span>
<span class="nc" id="L17179">        addReport(r);</span>

        // check if our target has a push against us, too, and get it
<span class="nc" id="L17182">        PhysicalResult targetPushResult = null;</span>
<span class="nc bnc" id="L17183" title="All 2 branches missed.">        for (PhysicalResult tpr : physicalResults) {</span>
<span class="nc bnc" id="L17184" title="All 4 branches missed.">            if ((tpr.aaa.getEntityId() == te.getId()) &amp;&amp; (tpr.aaa instanceof PushAttackAction)</span>
<span class="nc bnc" id="L17185" title="All 2 branches missed.">                    &amp;&amp; (tpr.aaa.getTargetId() == ae.getId())) {</span>
<span class="nc" id="L17186">                targetPushResult = tpr;</span>
            }
<span class="nc" id="L17188">        }</span>
        // if our target has a push against us,
        // and we are hitting, we need to resolve both now
<span class="nc bnc" id="L17191" title="All 4 branches missed.">        if ((targetPushResult != null) &amp;&amp; !targetPushResult.pushBackResolved</span>
<span class="nc bnc" id="L17192" title="All 2 branches missed.">            &amp;&amp; (roll &gt;= toHit.getValue())) {</span>
<span class="nc" id="L17193">            targetPushResult.pushBackResolved = true;</span>
            // do they hit?
<span class="nc bnc" id="L17195" title="All 2 branches missed.">            if (targetPushResult.roll &gt;= targetPushResult.toHit.getValue()) {</span>
<span class="nc" id="L17196">                r = new Report(4165);</span>
<span class="nc" id="L17197">                r.subject = ae.getId();</span>
<span class="nc" id="L17198">                r.addDesc(te);</span>
<span class="nc" id="L17199">                r.addDesc(te);</span>
<span class="nc" id="L17200">                r.addDesc(ae);</span>
<span class="nc" id="L17201">                r.add(targetPushResult.toHit);</span>
<span class="nc" id="L17202">                r.add(targetPushResult.roll);</span>
<span class="nc" id="L17203">                r.addDesc(ae);</span>
<span class="nc" id="L17204">                addReport(r);</span>
<span class="nc bnc" id="L17205" title="All 2 branches missed.">                if (ae.canFall()) {</span>
<span class="nc" id="L17206">                    PilotingRollData pushPRD = getKickPushPSR(ae, ae, te, &quot;was pushed&quot;);</span>
<span class="nc" id="L17207">                    game.addPSR(pushPRD);</span>
<span class="nc bnc" id="L17208" title="All 4 branches missed.">                } else if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17209">                    game.addControlRoll(getKickPushPSR(ae, ae, te, &quot;was pushed&quot;));</span>
                }
<span class="nc bnc" id="L17211" title="All 2 branches missed.">                if (te.canFall()) {</span>
<span class="nc" id="L17212">                    PilotingRollData targetPushPRD = getKickPushPSR(te, ae, te, &quot;was pushed&quot;);</span>
<span class="nc" id="L17213">                    game.addPSR(targetPushPRD);</span>
<span class="nc bnc" id="L17214" title="All 4 branches missed.">                } else if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17215">                    game.addControlRoll(getKickPushPSR(te, ae, te, &quot;was pushed&quot;));</span>
                }
<span class="nc" id="L17217">                return;</span>
            }
            // report the miss
<span class="nc" id="L17220">            r = new Report(4166);</span>
<span class="nc" id="L17221">            r.subject = ae.getId();</span>
<span class="nc" id="L17222">            r.addDesc(te);</span>
<span class="nc" id="L17223">            r.addDesc(ae);</span>
<span class="nc" id="L17224">            r.add(targetPushResult.toHit);</span>
<span class="nc" id="L17225">            r.add(targetPushResult.roll);</span>
<span class="nc" id="L17226">            addReport(r);</span>
        }

        // do we hit?
<span class="nc bnc" id="L17230" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17232">            r = new Report(4035);</span>
<span class="nc" id="L17233">            r.subject = ae.getId();</span>
<span class="nc" id="L17234">            addReport(r);</span>
<span class="nc" id="L17235">            return;</span>
        }

        // we hit...
<span class="nc" id="L17239">        int direction = ae.getFacing();</span>

<span class="nc" id="L17241">        Coords src = te.getPosition();</span>
<span class="nc" id="L17242">        Coords dest = src.translated(direction);</span>

<span class="nc" id="L17244">        PilotingRollData pushPRD = getKickPushPSR(te, ae, te, &quot;was pushed&quot;);</span>

<span class="nc bnc" id="L17246" title="All 2 branches missed.">        if (Compute.isValidDisplacement(game, te.getId(), te.getPosition(), direction)) {</span>
<span class="nc" id="L17247">            r = new Report(4170);</span>
<span class="nc" id="L17248">            r.subject = ae.getId();</span>
<span class="nc" id="L17249">            r.newlines = 0;</span>
<span class="nc" id="L17250">            addReport(r);</span>
<span class="nc bnc" id="L17251" title="All 2 branches missed.">            if (game.getBoard().contains(dest)) {</span>
<span class="nc" id="L17252">                r = new Report(4175);</span>
<span class="nc" id="L17253">                r.subject = ae.getId();</span>
<span class="nc" id="L17254">                r.add(dest.getBoardNum(), true);</span>
            } else {
                // uh-oh, pushed off board
<span class="nc" id="L17257">                r = new Report(4180);</span>
<span class="nc" id="L17258">                r.subject = ae.getId();</span>
            }
<span class="nc" id="L17260">            addReport(r);</span>

<span class="nc" id="L17262">            addReport(doEntityDisplacement(te, src, dest, pushPRD));</span>

            // if push actually moved the target, attacker follows through
<span class="nc bnc" id="L17265" title="All 2 branches missed.">            if (!te.getPosition().equals(src)) {</span>
<span class="nc" id="L17266">                ae.setPosition(src);</span>
            }
        } else {
            // target immovable
<span class="nc" id="L17270">            r = new Report(4185);</span>
<span class="nc" id="L17271">            r.subject = ae.getId();</span>
<span class="nc" id="L17272">            addReport(r);</span>
<span class="nc bnc" id="L17273" title="All 2 branches missed.">            if (te.canFall()) {</span>
<span class="nc" id="L17274">                game.addPSR(pushPRD);</span>
            }
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17280" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17281">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L17284">        checkForSpikes(te, ae.rollHitLocation(ToHitData.HIT_PUNCH, Compute.targetSideTable(ae, te)).getLocation(),</span>
                0, ae, Mech.LOC_LARM, Mech.LOC_RARM);

<span class="nc" id="L17287">        addNewLines();</span>
<span class="nc" id="L17288">    }</span>

    /**
     * Handle a trip attack
     */
    private void resolveTripAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17294">        final TripAttackAction paa = (TripAttackAction) pr.aaa;</span>
<span class="nc" id="L17295">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;trip&quot;.
<span class="nc" id="L17297">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17299">        int roll = pr.roll;</span>
<span class="nc" id="L17300">        final ToHitData toHit = pr.toHit;</span>
        Report r;

<span class="nc bnc" id="L17303" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17305">            r = new Report(4005);</span>
<span class="nc" id="L17306">            r.subject = ae.getId();</span>
<span class="nc" id="L17307">            r.addDesc(ae);</span>
<span class="nc" id="L17308">            addReport(r);</span>
        }

<span class="nc" id="L17311">        r = new Report(4280);</span>
<span class="nc" id="L17312">        r.subject = ae.getId();</span>
<span class="nc" id="L17313">        r.indent();</span>
<span class="nc" id="L17314">        r.addDesc(te);</span>
<span class="nc" id="L17315">        r.newlines = 0;</span>
<span class="nc" id="L17316">        addReport(r);</span>

<span class="nc bnc" id="L17318" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17319">            r = new Report(4285);</span>
<span class="nc" id="L17320">            r.subject = ae.getId();</span>
<span class="nc" id="L17321">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17322">            addReport(r);</span>
<span class="nc" id="L17323">            return;</span>
        }

        // report the roll
<span class="nc" id="L17327">        r = new Report(4025);</span>
<span class="nc" id="L17328">        r.subject = ae.getId();</span>
<span class="nc" id="L17329">        r.add(toHit);</span>
<span class="nc" id="L17330">        r.add(roll);</span>
<span class="nc" id="L17331">        r.newlines = 0;</span>
<span class="nc" id="L17332">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L17335" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17337">            r = new Report(4035);</span>
<span class="nc" id="L17338">            r.subject = ae.getId();</span>
<span class="nc" id="L17339">            addReport(r);</span>
<span class="nc" id="L17340">            return;</span>
        }

        // we hit...
<span class="nc bnc" id="L17344" title="All 2 branches missed.">        if (te.canFall()) {</span>
<span class="nc" id="L17345">            PilotingRollData pushPRD = getKickPushPSR(te, ae, te, &quot;was tripped&quot;);</span>
<span class="nc" id="L17346">            game.addPSR(pushPRD);</span>
        }

<span class="nc" id="L17349">        r = new Report(4040);</span>
<span class="nc" id="L17350">        r.subject = ae.getId();</span>
<span class="nc" id="L17351">        addReport(r);</span>
<span class="nc" id="L17352">        addNewLines();</span>
        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17355" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17356">            ((Mech) te).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17358">    }</span>

    /**
     * Handle a grapple attack
     */
    private void resolveGrappleAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17364">        resolveGrappleAttack(pr, lastEntityId, Entity.GRAPPLE_BOTH,</span>
                Entity.GRAPPLE_BOTH);
<span class="nc" id="L17366">    }</span>

    /**
     * Resolves a grapple attack.
     *
     * @param pr            the result of a physical attack - this one specifically being a grapple
     * @param lastEntityId  the entity making the attack
     * @param aeGrappleSide
     *            The side that the attacker is grappling with. For normal
     *            grapples this will be both, for chain whip grapples this will
     *            be the arm with the chain whip in it.
     * @param teGrappleSide
     *            The that the the target is grappling with. For normal grapples
     *            this will be both, for chain whip grapples this will be the
     *            arm that is being whipped.
     */
    private void resolveGrappleAttack(PhysicalResult pr, int lastEntityId,
                                      int aeGrappleSide, int teGrappleSide) {
<span class="nc" id="L17384">        final GrappleAttackAction paa = (GrappleAttackAction) pr.aaa;</span>
<span class="nc" id="L17385">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17387">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17389">        int roll = pr.roll;</span>
<span class="nc" id="L17390">        final ToHitData toHit = pr.toHit;</span>
        Report r;

        // same method as push, for counterattacks
<span class="nc bnc" id="L17394" title="All 2 branches missed.">        if (pr.pushBackResolved) {</span>
<span class="nc" id="L17395">            return;</span>
        }

<span class="nc bnc" id="L17398" title="All 2 branches missed.">        if ((te.getGrappled() != Entity.NONE)</span>
<span class="nc bnc" id="L17399" title="All 2 branches missed.">            || (ae.getGrappled() != Entity.NONE)) {</span>
<span class="nc" id="L17400">            toHit.addModifier(TargetRoll.IMPOSSIBLE, &quot;Already Grappled&quot;);</span>
        }

<span class="nc bnc" id="L17403" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17405">            r = new Report(4005);</span>
<span class="nc" id="L17406">            r.subject = ae.getId();</span>
<span class="nc" id="L17407">            r.addDesc(ae);</span>
<span class="nc" id="L17408">            addReport(r);</span>
        }

<span class="nc" id="L17411">        r = new Report(4295);</span>
<span class="nc" id="L17412">        r.subject = ae.getId();</span>
<span class="nc" id="L17413">        r.indent();</span>
<span class="nc" id="L17414">        r.addDesc(te);</span>
<span class="nc" id="L17415">        r.newlines = 0;</span>
<span class="nc" id="L17416">        addReport(r);</span>

<span class="nc bnc" id="L17418" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17419">            r = new Report(4300);</span>
<span class="nc" id="L17420">            r.subject = ae.getId();</span>
<span class="nc" id="L17421">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17422">            addReport(r);</span>
<span class="nc" id="L17423">            return;</span>
        }

        // report the roll
<span class="nc" id="L17427">        r = new Report(4025);</span>
<span class="nc" id="L17428">        r.subject = ae.getId();</span>
<span class="nc" id="L17429">        r.add(toHit);</span>
<span class="nc" id="L17430">        r.add(roll);</span>
<span class="nc" id="L17431">        r.newlines = 0;</span>
<span class="nc" id="L17432">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L17435" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17437">            r = new Report(4035);</span>
<span class="nc" id="L17438">            r.subject = ae.getId();</span>
<span class="nc" id="L17439">            addReport(r);</span>
<span class="nc" id="L17440">            return;</span>
        }

        // we hit...
<span class="nc" id="L17444">        ae.setGrappled(te.getId(), true);</span>
<span class="nc" id="L17445">        te.setGrappled(ae.getId(), false);</span>
<span class="nc" id="L17446">        ae.setGrappledThisRound(true);</span>
<span class="nc" id="L17447">        te.setGrappledThisRound(true);</span>
        // For normal grapples, AE moves into targets hex.
<span class="nc bnc" id="L17449" title="All 2 branches missed.">        if (aeGrappleSide == Entity.GRAPPLE_BOTH) {</span>
<span class="nc" id="L17450">            Coords pos = te.getPosition();</span>
<span class="nc" id="L17451">            ae.setPosition(pos);</span>
<span class="nc" id="L17452">            ae.setElevation(te.getElevation());</span>
<span class="nc" id="L17453">            te.setFacing((ae.getFacing() + 3) % 6);</span>
<span class="nc" id="L17454">            addReport(doSetLocationsExposure(ae, game.getBoard().getHex(pos),</span>
<span class="nc" id="L17455">                    false, ae.getElevation()));</span>
        }

<span class="nc" id="L17458">        ae.setGrappleSide(aeGrappleSide);</span>
<span class="nc" id="L17459">        te.setGrappleSide(teGrappleSide);</span>

<span class="nc" id="L17461">        r = new Report(4040);</span>
<span class="nc" id="L17462">        r.subject = ae.getId();</span>
<span class="nc" id="L17463">        addReport(r);</span>
<span class="nc" id="L17464">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17468" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17469">            ((Mech) te).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17471">    }</span>

    /**
     * Handle a break grapple attack
     */
    private void resolveBreakGrappleAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17477">        final BreakGrappleAttackAction paa = (BreakGrappleAttackAction) pr.aaa;</span>
<span class="nc" id="L17478">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17480">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17482">        int roll = pr.roll;</span>
<span class="nc" id="L17483">        final ToHitData toHit = pr.toHit;</span>
        Report r;

<span class="nc bnc" id="L17486" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17488">            r = new Report(4005);</span>
<span class="nc" id="L17489">            r.subject = ae.getId();</span>
<span class="nc" id="L17490">            r.addDesc(ae);</span>
<span class="nc" id="L17491">            addReport(r);</span>
        }

<span class="nc" id="L17494">        r = new Report(4305);</span>
<span class="nc" id="L17495">        r.subject = ae.getId();</span>
<span class="nc" id="L17496">        r.indent();</span>
<span class="nc" id="L17497">        r.addDesc(te);</span>
<span class="nc" id="L17498">        r.newlines = 0;</span>
<span class="nc" id="L17499">        addReport(r);</span>

<span class="nc bnc" id="L17501" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17502">            r = new Report(4310);</span>
<span class="nc" id="L17503">            r.subject = ae.getId();</span>
<span class="nc" id="L17504">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17505">            addReport(r);</span>
<span class="nc bnc" id="L17506" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17507">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a physical attack&quot;));</span>
            }
<span class="nc" id="L17509">            return;</span>
        }

<span class="nc bnc" id="L17512" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17513">            r = new Report(4320);</span>
<span class="nc" id="L17514">            r.subject = ae.getId();</span>
<span class="nc" id="L17515">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L17518">            r = new Report(4025);</span>
<span class="nc" id="L17519">            r.subject = ae.getId();</span>
<span class="nc" id="L17520">            r.add(toHit);</span>
<span class="nc" id="L17521">            r.add(roll);</span>
<span class="nc" id="L17522">            r.newlines = 0;</span>
<span class="nc" id="L17523">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L17526" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L17528">                r = new Report(4035);</span>
<span class="nc" id="L17529">                r.subject = ae.getId();</span>
<span class="nc" id="L17530">                addReport(r);</span>
<span class="nc bnc" id="L17531" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17532">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a physical attack&quot;));</span>
                }
<span class="nc" id="L17534">                return;</span>
            }

            // hit
<span class="nc" id="L17538">            r = new Report(4040);</span>
<span class="nc" id="L17539">            r.subject = ae.getId();</span>
        }
<span class="nc" id="L17541">        addReport(r);</span>

        // is there a counterattack?
<span class="nc" id="L17544">        PhysicalResult targetGrappleResult = null;</span>
<span class="nc bnc" id="L17545" title="All 2 branches missed.">        for (PhysicalResult tpr : physicalResults) {</span>
<span class="nc bnc" id="L17546" title="All 4 branches missed.">            if ((tpr.aaa.getEntityId() == te.getId())</span>
                &amp;&amp; (tpr.aaa instanceof GrappleAttackAction)
<span class="nc bnc" id="L17548" title="All 2 branches missed.">                &amp;&amp; (tpr.aaa.getTargetId() == ae.getId())) {</span>
<span class="nc" id="L17549">                targetGrappleResult = tpr;</span>
<span class="nc" id="L17550">                break;</span>
            }
<span class="nc" id="L17552">        }</span>

<span class="nc bnc" id="L17554" title="All 2 branches missed.">        if (targetGrappleResult != null) {</span>
<span class="nc" id="L17555">            targetGrappleResult.pushBackResolved = true;</span>
            // counterattack
<span class="nc" id="L17557">            r = new Report(4315);</span>
<span class="nc" id="L17558">            r.subject = te.getId();</span>
<span class="nc" id="L17559">            r.newlines = 0;</span>
<span class="nc" id="L17560">            r.addDesc(te);</span>
<span class="nc" id="L17561">            addReport(r);</span>

            // report the roll
<span class="nc" id="L17564">            r = new Report(4025);</span>
<span class="nc" id="L17565">            r.subject = te.getId();</span>
<span class="nc" id="L17566">            r.add(targetGrappleResult.toHit);</span>
<span class="nc" id="L17567">            r.add(targetGrappleResult.roll);</span>
<span class="nc" id="L17568">            r.newlines = 0;</span>
<span class="nc" id="L17569">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L17572" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L17574">                r = new Report(4035);</span>
<span class="nc" id="L17575">                r.subject = ae.getId();</span>
<span class="nc" id="L17576">                addReport(r);</span>
            } else {
                // hit
<span class="nc" id="L17579">                r = new Report(4040);</span>
<span class="nc" id="L17580">                r.subject = ae.getId();</span>
<span class="nc" id="L17581">                addReport(r);</span>

                // exchange attacker and defender
<span class="nc" id="L17584">                ae.setGrappled(te.getId(), false);</span>
<span class="nc" id="L17585">                te.setGrappled(ae.getId(), true);</span>

<span class="nc" id="L17587">                return;</span>
            }
        }

        // score the adjacent hexes
<span class="nc" id="L17592">        Coords[] hexes = new Coords[6];</span>
<span class="nc" id="L17593">        int[] scores = new int[6];</span>

<span class="nc" id="L17595">        IHex curHex = game.getBoard().getHex(ae.getPosition());</span>
<span class="nc bnc" id="L17596" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L17597">            hexes[i] = ae.getPosition().translated(i);</span>
<span class="nc" id="L17598">            scores[i] = 0;</span>
<span class="nc" id="L17599">            IHex hex = game.getBoard().getHex(hexes[i]);</span>
<span class="nc bnc" id="L17600" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.MAGMA)) {</span>
<span class="nc" id="L17601">                scores[i] += 10;</span>
            }
<span class="nc bnc" id="L17603" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L17604">                scores[i] += hex.terrainLevel(Terrains.WATER);</span>
            }
<span class="nc bnc" id="L17606" title="All 2 branches missed.">            if ((curHex.surface() - hex.surface()) &gt;= 2) {</span>
<span class="nc" id="L17607">                scores[i] += 2 * (curHex.surface() - hex.surface());</span>
            }
        }

<span class="nc" id="L17611">        int bestScore = 99999;</span>
<span class="nc" id="L17612">        int best = 0;</span>
<span class="nc" id="L17613">        int worstScore = -99999;</span>
<span class="nc" id="L17614">        int worst = 0;</span>

<span class="nc bnc" id="L17616" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc bnc" id="L17617" title="All 2 branches missed.">            if (bestScore &gt; scores[i]) {</span>
<span class="nc" id="L17618">                best = i;</span>
<span class="nc" id="L17619">                bestScore = scores[i];</span>
            }
<span class="nc bnc" id="L17621" title="All 2 branches missed.">            if (worstScore &lt; scores[i]) {</span>
<span class="nc" id="L17622">                worst = i;</span>
<span class="nc" id="L17623">                worstScore = scores[i];</span>
            }
        }

        // attacker doesn't fall, unless off a cliff
<span class="nc bnc" id="L17628" title="All 2 branches missed.">        if (ae.isGrappleAttacker()) {</span>
            // move self to least dangerous hex
<span class="nc" id="L17630">            PilotingRollData psr = ae.getBasePilotingRoll();</span>
<span class="nc" id="L17631">            psr.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;break grapple&quot;);</span>
<span class="nc" id="L17632">            addReport(doEntityDisplacement(ae, ae.getPosition(), hexes[best], psr));</span>
<span class="nc" id="L17633">            ae.setFacing(hexes[best].direction(te.getPosition()));</span>
<span class="nc" id="L17634">        } else {</span>
            // move enemy to most dangerous hex
<span class="nc" id="L17636">            PilotingRollData psr = te.getBasePilotingRoll();</span>
<span class="nc" id="L17637">            psr.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;break grapple&quot;);</span>
<span class="nc" id="L17638">            addReport(doEntityDisplacement(te, te.getPosition(), hexes[worst], psr));</span>
<span class="nc" id="L17639">            te.setFacing(hexes[worst].direction(ae.getPosition()));</span>
        }

        // grapple is broken
<span class="nc" id="L17643">        ae.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L17644">        te.setGrappled(Entity.NONE, false);</span>

<span class="nc" id="L17646">        addNewLines();</span>
<span class="nc" id="L17647">    }</span>

    /**
     * Handle a charge attack
     */
    private void resolveChargeAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17653">        final ChargeAttackAction caa = (ChargeAttackAction) pr.aaa;</span>
<span class="nc" id="L17654">        final Entity ae = game.getEntity(caa.getEntityId());</span>
<span class="nc" id="L17655">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L17657">        int damage = pr.damage;</span>
<span class="nc" id="L17658">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L17659">        int roll = pr.roll;</span>

<span class="nc" id="L17661">        Entity te = null;</span>
<span class="nc bnc" id="L17662" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L17663">            te = (Entity) target;</span>
        }
<span class="nc" id="L17665">        boolean throughFront = true;</span>
<span class="nc bnc" id="L17666" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L17667">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L17669" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17670" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L17673">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L17674" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17675" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L17680">        Building bldg = game.getBoard().getBuildingAt(caa.getTargetPos());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L17683" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L17684">            return;</span>
        }

<span class="nc" id="L17687">        final int direction = ae.getFacing();</span>

        // entity isn't charging any more
<span class="nc" id="L17690">        ae.setDisplacementAttack(null);</span>

<span class="nc bnc" id="L17692" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17694">            r = new Report(4005);</span>
<span class="nc" id="L17695">            r.subject = ae.getId();</span>
<span class="nc" id="L17696">            r.addDesc(ae);</span>
<span class="nc" id="L17697">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L17701" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L17702" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L17703">            r = new Report(4190);</span>
<span class="nc" id="L17704">            r.subject = ae.getId();</span>
<span class="nc" id="L17705">            r.indent();</span>
<span class="nc" id="L17706">            addReport(r);</span>
            // doEntityDisplacement(ae, ae.getPosition(), caa.getTargetPos(),
            // null);
            // Randall said that if a charge fails because of target
            // destruction,
            // the attacker stays in the hex he was in at the end of the
            // movement phase
            // See Bug 912094
<span class="nc" id="L17714">            return;</span>
        }

        // attacker fell down?
<span class="nc bnc" id="L17718" title="All 2 branches missed.">        if (ae.isProne()) {</span>
<span class="nc" id="L17719">            r = new Report(4195);</span>
<span class="nc" id="L17720">            r.subject = ae.getId();</span>
<span class="nc" id="L17721">            r.indent();</span>
<span class="nc" id="L17722">            addReport(r);</span>
<span class="nc" id="L17723">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L17727" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L17728">            r = new Report(4200);</span>
<span class="nc" id="L17729">            r.subject = ae.getId();</span>
<span class="nc" id="L17730">            r.indent();</span>
<span class="nc" id="L17731">            addReport(r);</span>
<span class="nc" id="L17732">            return;</span>
        }

        // target fell down, only for attacking Mechs, though
<span class="nc bnc" id="L17736" title="All 6 branches missed.">        if ((te != null) &amp;&amp; (te.isProne()) &amp;&amp; (ae instanceof Mech)) {</span>
<span class="nc" id="L17737">            r = new Report(4205);</span>
<span class="nc" id="L17738">            r.subject = ae.getId();</span>
<span class="nc" id="L17739">            r.indent();</span>
<span class="nc" id="L17740">            addReport(r);</span>
<span class="nc" id="L17741">            return;</span>
        }

<span class="nc" id="L17744">        r = new Report(4210);</span>
<span class="nc" id="L17745">        r.subject = ae.getId();</span>
<span class="nc" id="L17746">        r.indent();</span>
<span class="nc" id="L17747">        r.add(target.getDisplayName());</span>
<span class="nc" id="L17748">        r.newlines = 0;</span>
<span class="nc" id="L17749">        addReport(r);</span>

        // target still in the same position?
<span class="nc bnc" id="L17752" title="All 2 branches missed.">        if (!target.getPosition().equals(caa.getTargetPos())) {</span>
<span class="nc" id="L17753">            r = new Report(4215);</span>
<span class="nc" id="L17754">            r.subject = ae.getId();</span>
<span class="nc" id="L17755">            addReport(r);</span>
<span class="nc" id="L17756">            addReport(doEntityDisplacement(ae, ae.getPosition(), caa.getTargetPos(), null));</span>
<span class="nc" id="L17757">            return;</span>
        }

        // if the attacker's prone, fudge the roll
<span class="nc bnc" id="L17761" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17762">            roll = -12;</span>
<span class="nc" id="L17763">            r = new Report(4220);</span>
<span class="nc" id="L17764">            r.subject = ae.getId();</span>
<span class="nc" id="L17765">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17766">            addReport(r);</span>
<span class="nc bnc" id="L17767" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17768">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L17769">            r = new Report(4225);</span>
<span class="nc" id="L17770">            r.subject = ae.getId();</span>
<span class="nc" id="L17771">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17772">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L17775">            r = new Report(4025);</span>
<span class="nc" id="L17776">            r.subject = ae.getId();</span>
<span class="nc" id="L17777">            r.add(toHit);</span>
<span class="nc" id="L17778">            r.add(roll);</span>
<span class="nc" id="L17779">            addReport(r);</span>
<span class="nc bnc" id="L17780" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L17781">                r = new Report(3186);</span>
<span class="nc" id="L17782">                r.subject = ae.getId();</span>
<span class="nc" id="L17783">                addReport(r);</span>
            }
<span class="nc bnc" id="L17785" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L17786">                r = new Report(3189);</span>
<span class="nc" id="L17787">                r.subject = ae.getId();</span>
<span class="nc" id="L17788">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L17793" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L17794">            Coords src = ae.getPosition();</span>
<span class="nc" id="L17795">            Coords dest = Compute.getMissedChargeDisplacement(game, ae.getId(), src, direction);</span>

            // TODO : handle movement into/out of/through a building. Do it here?

            // miss
<span class="nc" id="L17800">            r = new Report(4035);</span>
<span class="nc" id="L17801">            r.subject = ae.getId();</span>
<span class="nc" id="L17802">            addReport(r);</span>
            // move attacker to side hex
<span class="nc" id="L17804">            addReport(doEntityDisplacement(ae, src, dest, null));</span>
<span class="nc bnc" id="L17805" title="All 2 branches missed.">        } else if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L17806" title="All 2 branches missed.">                   || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) { // Targeting</span>
            // a building.
            // The building takes the full brunt of the attack.
<span class="nc" id="L17809">            r = new Report(4040);</span>
<span class="nc" id="L17810">            r.subject = ae.getId();</span>
<span class="nc" id="L17811">            addReport(r);</span>
<span class="nc" id="L17812">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L17813" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L17814">                report.subject = ae.getId();</span>
<span class="nc" id="L17815">            }</span>
<span class="nc" id="L17816">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L17819">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // Apply damage to the attacker.
<span class="nc" id="L17822">            int toAttacker = ChargeAttackAction.getDamageTakenBy(ae, bldg, target.getPosition());</span>
<span class="nc" id="L17823">            HitData hit = ae.rollHitLocation(ToHitData.HIT_NORMAL, ae.sideTable(target.getPosition()));</span>
<span class="nc" id="L17824">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L17825">            addReport(damageEntity(ae, hit, toAttacker, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc" id="L17827">            addNewLines();</span>
<span class="nc" id="L17828">            entityUpdate(ae.getId());</span>

            // TODO : Does the attacker enter the building?
            // TODO : What if the building collapses?
<span class="nc" id="L17832">        } else {</span>
            // Resolve the damage.
<span class="nc" id="L17834">            resolveChargeDamage(ae, te, toHit, direction, glancing, throughFront, false);</span>
        }
<span class="nc" id="L17836">    }</span>

    /**
     * Handle an Airmech ram attack
     */
    private void resolveAirmechRamAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17842">        final AirmechRamAttackAction caa = (AirmechRamAttackAction) pr.aaa;</span>
<span class="nc" id="L17843">        final Entity ae = game.getEntity(caa.getEntityId());</span>
<span class="nc" id="L17844">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L17846">        int damage = pr.damage;</span>
<span class="nc" id="L17847">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L17848">        int roll = pr.roll;</span>

<span class="nc" id="L17850">        Entity te = null;</span>
<span class="nc bnc" id="L17851" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L17852">            te = (Entity) target;</span>
        }
<span class="nc" id="L17854">        boolean throughFront = true;</span>
<span class="nc bnc" id="L17855" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L17856">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L17858" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17859" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L17862">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L17863" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17864" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L17869">        Building bldg = game.getBoard().getBuildingAt(caa.getTargetPos());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L17872" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L17873">            return;</span>
        }

<span class="nc" id="L17876">        final int direction = ae.getFacing();</span>

        // entity isn't charging any more
<span class="nc" id="L17879">        ae.setDisplacementAttack(null);</span>

<span class="nc bnc" id="L17881" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17883">            r = new Report(4005);</span>
<span class="nc" id="L17884">            r.subject = ae.getId();</span>
<span class="nc" id="L17885">            r.addDesc(ae);</span>
<span class="nc" id="L17886">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L17890" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L17891" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L17892">            r = new Report(4192);</span>
<span class="nc" id="L17893">            r.subject = ae.getId();</span>
<span class="nc" id="L17894">            r.indent();</span>
<span class="nc" id="L17895">            addReport(r);</span>
<span class="nc" id="L17896">            game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L17897">                    ae.getId(), 0, &quot;missed a ramming attack&quot;));</span>
<span class="nc" id="L17898">            return;</span>
        }

        // attacker landed?
<span class="nc bnc" id="L17902" title="All 2 branches missed.">        if (!ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17903">            r = new Report(4197);</span>
<span class="nc" id="L17904">            r.subject = ae.getId();</span>
<span class="nc" id="L17905">            r.indent();</span>
<span class="nc" id="L17906">            addReport(r);</span>
<span class="nc" id="L17907">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L17911" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L17912">            r = new Report(4202);</span>
<span class="nc" id="L17913">            r.subject = ae.getId();</span>
<span class="nc" id="L17914">            r.indent();</span>
<span class="nc" id="L17915">            addReport(r);</span>
<span class="nc" id="L17916">            return;</span>
        }

<span class="nc" id="L17919">        r = new Report(4212);</span>
<span class="nc" id="L17920">        r.subject = ae.getId();</span>
<span class="nc" id="L17921">        r.indent();</span>
<span class="nc" id="L17922">        r.add(target.getDisplayName());</span>
<span class="nc" id="L17923">        r.newlines = 0;</span>
<span class="nc" id="L17924">        addReport(r);</span>

        // if the attacker's prone, fudge the roll
<span class="nc bnc" id="L17927" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17928">            roll = -12;</span>
<span class="nc" id="L17929">            r = new Report(4222);</span>
<span class="nc" id="L17930">            r.subject = ae.getId();</span>
<span class="nc" id="L17931">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17932">            addReport(r);</span>
<span class="nc bnc" id="L17933" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17934">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L17935">            r = new Report(4227);</span>
<span class="nc" id="L17936">            r.subject = ae.getId();</span>
<span class="nc" id="L17937">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17938">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L17941">            r = new Report(4025);</span>
<span class="nc" id="L17942">            r.subject = ae.getId();</span>
<span class="nc" id="L17943">            r.add(toHit);</span>
<span class="nc" id="L17944">            r.add(roll);</span>
<span class="nc" id="L17945">            addReport(r);</span>
<span class="nc bnc" id="L17946" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L17947">                r = new Report(3186);</span>
<span class="nc" id="L17948">                r.subject = ae.getId();</span>
<span class="nc" id="L17949">                addReport(r);</span>
            }
<span class="nc bnc" id="L17951" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L17952">                r = new Report(3189);</span>
<span class="nc" id="L17953">                r.subject = ae.getId();</span>
<span class="nc" id="L17954">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L17959" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17961">            r = new Report(4035);</span>
<span class="nc" id="L17962">            r.subject = ae.getId();</span>
<span class="nc" id="L17963">            addReport(r);</span>
            // attacker must make a control roll
<span class="nc" id="L17965">            game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed ramming attack&quot;));</span>
<span class="nc bnc" id="L17966" title="All 2 branches missed.">        } else if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L17967" title="All 2 branches missed.">                   || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) { // Targeting</span>
            // a building.
            // The building takes the full brunt of the attack.
<span class="nc" id="L17970">            r = new Report(4040);</span>
<span class="nc" id="L17971">            r.subject = ae.getId();</span>
<span class="nc" id="L17972">            addReport(r);</span>
<span class="nc" id="L17973">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L17974" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L17975">                report.subject = ae.getId();</span>
<span class="nc" id="L17976">            }</span>
<span class="nc" id="L17977">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L17980">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // Apply damage to the attacker.
<span class="nc" id="L17983">            int toAttacker = AirmechRamAttackAction.getDamageTakenBy(ae, target,</span>
                    ae.delta_distance);
<span class="nc" id="L17985">            HitData hit = new HitData(Mech.LOC_CT);</span>
<span class="nc" id="L17986">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L17987">            addReport(damageEntity(ae, hit, toAttacker, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc" id="L17989">            addNewLines();</span>
<span class="nc" id="L17990">            entityUpdate(ae.getId());</span>

            // TODO : Does the attacker enter the building?
            // TODO : What if the building collapses?
<span class="nc" id="L17994">        } else {</span>
            // Resolve the damage.
<span class="nc" id="L17996">            resolveChargeDamage(ae, te, toHit, direction, glancing, throughFront, true);</span>
        }
<span class="nc" id="L17998">    }</span>

    /**
     * Handle a telemissile attack
     */
    private void resolveTeleMissileAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18004">        final TeleMissileAttackAction taa = (TeleMissileAttackAction) pr.aaa;</span>
<span class="nc" id="L18005">        final Entity ae = game.getEntity(taa.getEntityId());</span>
<span class="nc bnc" id="L18006" title="All 2 branches missed.">        if (!(ae instanceof TeleMissile)) {</span>
<span class="nc" id="L18007">            return;</span>
        }
<span class="nc" id="L18009">        TeleMissile tm = (TeleMissile) ae;</span>
<span class="nc" id="L18010">        final Targetable target = game.getTarget(taa.getTargetType(), taa.getTargetId());</span>
<span class="nc" id="L18011">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18012">        int roll = pr.roll;</span>
<span class="nc" id="L18013">        int amsDamage = taa.CounterAVInt;</span>
<span class="nc" id="L18014">        Entity te = null;</span>
<span class="nc bnc" id="L18015" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L18016">            te = (Entity) target;</span>
        }

<span class="nc" id="L18019">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18020" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18021">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }

        Report r;

<span class="nc bnc" id="L18026" title="All 2 branches missed.">        if (lastEntityId != taa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18028">            r = new Report(4005);</span>
<span class="nc" id="L18029">            r.subject = ae.getId();</span>
<span class="nc" id="L18030">            r.addDesc(ae);</span>
<span class="nc" id="L18031">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18035" title="All 2 branches missed.">        if ((target == null)</span>
<span class="nc bnc" id="L18036" title="All 4 branches missed.">                || ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; (te.isDestroyed()</span>
<span class="nc bnc" id="L18037" title="All 4 branches missed.">                || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18038">            r = new Report(4191);</span>
<span class="nc" id="L18039">            r.subject = ae.getId();</span>
<span class="nc" id="L18040">            r.indent();</span>
<span class="nc" id="L18041">            addReport(r);</span>
<span class="nc" id="L18042">            return;</span>
        }

<span class="nc" id="L18045">        r = new Report(9031);</span>
<span class="nc" id="L18046">        r.subject = ae.getId();</span>
<span class="nc" id="L18047">        r.indent();</span>
<span class="nc" id="L18048">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18049">        r.newlines = 1;</span>
<span class="nc" id="L18050">        addReport(r);</span>

        //If point defenses engaged the missile, handle that damage
<span class="nc bnc" id="L18053" title="All 2 branches missed.">        if (amsDamage &gt; 0) {</span>
            //Report the attack
<span class="nc" id="L18055">            r = new Report(3362);</span>
<span class="nc" id="L18056">            r.newlines = 1;</span>
<span class="nc" id="L18057">            r.subject = te.getId();</span>
<span class="nc" id="L18058">            vPhaseReport.add(r);</span>

            //If the target's point defenses overheated, report that
<span class="nc bnc" id="L18061" title="All 2 branches missed.">            if (taa.getPDOverheated()) {</span>
<span class="nc" id="L18062">                r = new Report(3361);</span>
<span class="nc" id="L18063">                r.newlines = 1;</span>
<span class="nc" id="L18064">                r.subject = te.getId();</span>
<span class="nc" id="L18065">                vPhaseReport.add(r);</span>
            }

            //Damage the missile
<span class="nc" id="L18069">            HitData hit = tm.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18070">                    tm.sideTable(te.getPosition(), true));</span>
<span class="nc" id="L18071">            addReport(damageEntity(ae, hit, amsDamage, false,</span>
                    DamageType.NONE, false, false, false));

            //If point defense fire destroys the missile, don't process a hit
<span class="nc bnc" id="L18075" title="All 2 branches missed.">            if (ae.isDoomed()) {</span>
<span class="nc" id="L18076">                return;</span>
            }
        }

        // add some stuff to the to hit value
        // need to add damage done modifier
<span class="nc" id="L18082">        int damageTaken = (ae.getOArmor(TeleMissile.LOC_BODY) - ae.getArmor(TeleMissile.LOC_BODY));</span>
<span class="nc bnc" id="L18083" title="All 2 branches missed.">        if (damageTaken &gt; 10) {</span>
<span class="nc" id="L18084">            toHit.addModifier((int) (Math.floor(damageTaken / 10.0)), &quot;damage taken&quot;);</span>
        }

        // add modifiers for the originating unit missing CIC, FCS, or sensors
<span class="nc" id="L18088">        Entity ride = game.getEntity(tm.getOriginalRideId());</span>
<span class="nc bnc" id="L18089" title="All 2 branches missed.">        if (ride instanceof Aero) {</span>
<span class="nc" id="L18090">            Aero aride = (Aero) ride;</span>
<span class="nc" id="L18091">            int cic = aride.getCICHits();</span>
<span class="nc bnc" id="L18092" title="All 2 branches missed.">            if (cic &gt; 0) {</span>
<span class="nc" id="L18093">                toHit.addModifier(cic * 2, &quot;CIC damage&quot;);</span>
            }

            // sensor hits
<span class="nc" id="L18097">            int sensors = aride.getSensorHits();</span>
<span class="nc bnc" id="L18098" title="All 4 branches missed.">            if ((sensors &gt; 0) &amp;&amp; (sensors &lt; 3)) {</span>
<span class="nc" id="L18099">                toHit.addModifier(sensors, &quot;sensor damage&quot;);</span>
            }
<span class="nc bnc" id="L18101" title="All 2 branches missed.">            if (sensors &gt; 2) {</span>
<span class="nc" id="L18102">                toHit.addModifier(+5, &quot;sensors destroyed&quot;);</span>
            }

            // FCS hits
<span class="nc" id="L18106">            int fcs = aride.getFCSHits();</span>
<span class="nc bnc" id="L18107" title="All 2 branches missed.">            if (fcs &gt; 0) {</span>
<span class="nc" id="L18108">                toHit.addModifier(fcs * 2, &quot;fcs damage&quot;);</span>
            }
        }

<span class="nc bnc" id="L18112" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18113">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L18114">            r = new Report(4226);</span>
<span class="nc" id="L18115">            r.subject = ae.getId();</span>
<span class="nc" id="L18116">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L18119">            r = new Report(9033);</span>
<span class="nc" id="L18120">            r.subject = ae.getId();</span>
<span class="nc" id="L18121">            r.add(toHit);</span>
<span class="nc" id="L18122">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18123">            r.add(roll);</span>
<span class="nc" id="L18124">            r.newlines = 0;</span>
        }
<span class="nc" id="L18126">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L18129" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18131">            r = new Report(4035);</span>
<span class="nc" id="L18132">            r.subject = ae.getId();</span>
<span class="nc" id="L18133">            addReport(r);</span>
        } else {
            // Resolve the damage.
<span class="nc" id="L18136">            HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18137">                    te.sideTable(ae.getPosition(), true));</span>
<span class="nc" id="L18138">            hit.setCapital(true);</span>
<span class="nc" id="L18139">            hit.setCapMisCritMod(tm.getCritMod());</span>
<span class="nc" id="L18140">            addReport(damageEntity(te, hit,</span>
<span class="nc" id="L18141">                    TeleMissileAttackAction.getDamageFor(ae), false,</span>
                    DamageType.NONE, false, false, throughFront));
<span class="nc" id="L18143">            destroyEntity(ae, &quot;successful attack&quot;);</span>
        }

<span class="nc" id="L18146">    }</span>

    /**
     * Handle a ramming attack
     */
    private void resolveRamAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18152">        final RamAttackAction raa = (RamAttackAction) pr.aaa;</span>
<span class="nc" id="L18153">        final Entity ae = game.getEntity(raa.getEntityId());</span>
<span class="nc" id="L18154">        final Targetable target = game.getTarget(raa.getTargetType(), raa.getTargetId());</span>
<span class="nc" id="L18155">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18156">        int roll = pr.roll;</span>
<span class="nc" id="L18157">        Entity te = null;</span>
<span class="nc bnc" id="L18158" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L18159">            te = (Entity) target;</span>
        }

<span class="nc" id="L18162">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18163" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18164">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }

        Report r;

<span class="nc bnc" id="L18169" title="All 2 branches missed.">        boolean glancing = Compute.d6(1) == 6;</span>

        // entity isn't ramming any more
<span class="nc" id="L18172">        ae.setRamming(false);</span>

<span class="nc bnc" id="L18174" title="All 2 branches missed.">        if (lastEntityId != raa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18176">            r = new Report(4005);</span>
<span class="nc" id="L18177">            r.subject = ae.getId();</span>
<span class="nc" id="L18178">            r.addDesc(ae);</span>
<span class="nc" id="L18179">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18183" title="All 2 branches missed.">        if ((target == null)</span>
<span class="nc bnc" id="L18184" title="All 4 branches missed.">                || ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; (te.isDestroyed()</span>
<span class="nc bnc" id="L18185" title="All 4 branches missed.">                || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18186">            r = new Report(4190);</span>
<span class="nc" id="L18187">            r.subject = ae.getId();</span>
<span class="nc" id="L18188">            r.indent();</span>
<span class="nc" id="L18189">            addReport(r);</span>
<span class="nc" id="L18190">            return;</span>
        }

        // steel yourself for attack
<span class="nc" id="L18194">        int steelRoll = Compute.d6(2);</span>
<span class="nc" id="L18195">        r = new Report(9020);</span>
<span class="nc" id="L18196">        r.subject = ae.getId();</span>
<span class="nc" id="L18197">        r.add(steelRoll);</span>

<span class="nc bnc" id="L18199" title="All 2 branches missed.">        if (steelRoll &gt;= 11) {</span>
<span class="nc" id="L18200">            r.choose(true);</span>
<span class="nc" id="L18201">            addReport(r);</span>
        } else {
<span class="nc" id="L18203">            r.choose(false);</span>
<span class="nc" id="L18204">            addReport(r);</span>
<span class="nc" id="L18205">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L18209" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L18210">            r = new Report(4200);</span>
<span class="nc" id="L18211">            r.subject = ae.getId();</span>
<span class="nc" id="L18212">            r.indent();</span>
<span class="nc" id="L18213">            addReport(r);</span>
<span class="nc" id="L18214">            return;</span>
        }

<span class="nc" id="L18217">        r = new Report(9030);</span>
<span class="nc" id="L18218">        r.subject = ae.getId();</span>
<span class="nc" id="L18219">        r.indent();</span>
<span class="nc" id="L18220">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18221">        r.newlines = 0;</span>
<span class="nc" id="L18222">        addReport(r);</span>

<span class="nc bnc" id="L18224" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18225">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L18226">            r = new Report(4225);</span>
<span class="nc" id="L18227">            r.subject = ae.getId();</span>
<span class="nc" id="L18228">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L18231">            r = new Report(4025);</span>
<span class="nc" id="L18232">            r.subject = ae.getId();</span>
<span class="nc" id="L18233">            r.add(toHit);</span>
<span class="nc" id="L18234">            r.add(roll);</span>
<span class="nc" id="L18235">            r.newlines = 0;</span>
        }
<span class="nc" id="L18237">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L18240" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18242">            r = new Report(4035);</span>
<span class="nc" id="L18243">            r.subject = ae.getId();</span>
<span class="nc" id="L18244">            addReport(r);</span>
        } else {
            // Resolve the damage.
<span class="nc" id="L18247">            resolveRamDamage((IAero) ae, te, toHit, glancing, throughFront);</span>
        }

<span class="nc" id="L18250">    }</span>

    /**
     * Handle a ramming attack's damage
     */
    private void resolveRamDamage(IAero aero, Entity te, ToHitData toHit,
                                  boolean glancing, boolean throughFront) {

<span class="nc" id="L18258">        Entity ae = (Entity) aero;</span>

<span class="nc" id="L18260">        int damage = RamAttackAction.getDamageFor(aero, te);</span>
<span class="nc" id="L18261">        int damageTaken = RamAttackAction.getDamageTakenBy(aero, te);</span>
<span class="nc bnc" id="L18262" title="All 2 branches missed.">        if (glancing) {</span>
            // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L18264" title="All 2 branches missed.">            damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
<span class="nc" id="L18265">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

        // are they capital scale?
<span class="nc bnc" id="L18269" title="All 2 branches missed.">        if (te.isCapitalScale()</span>
<span class="nc bnc" id="L18270" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L18271">            damage = (int) Math.floor(damage / 10.0);</span>
        }
<span class="nc bnc" id="L18273" title="All 2 branches missed.">        if (ae.isCapitalScale()</span>
<span class="nc bnc" id="L18274" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L18275">            damageTaken = (int) Math.floor(damageTaken / 10.0);</span>
        }

        Report r;

<span class="nc bnc" id="L18280" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L18281">            r = new Report(9015);</span>
<span class="nc" id="L18282">            r.subject = ae.getId();</span>
<span class="nc" id="L18283">            r.indent(1);</span>
<span class="nc" id="L18284">            addReport(r);</span>
        }

        // damage to attacker
<span class="nc" id="L18288">        r = new Report(4240);</span>
<span class="nc" id="L18289">        r.subject = ae.getId();</span>
<span class="nc" id="L18290">        r.add(damageTaken);</span>
<span class="nc" id="L18291">        r.indent();</span>
<span class="nc" id="L18292">        addReport(r);</span>

<span class="nc" id="L18294">        HitData hit = ae.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18295">                ae.sideTable(te.getPosition(), true));</span>
        // if the damage is greater than the initial armor then destroy the
        // entity
<span class="nc bnc" id="L18298" title="All 2 branches missed.">        if ((2 * ae.getOArmor(hit)) &lt; damageTaken) {</span>
<span class="nc" id="L18299">            addReport(destroyEntity(ae, &quot;by massive ramming damage&quot;, false));</span>
        } else {
<span class="nc" id="L18301">            addReport(damageEntity(ae, hit, damageTaken, false,</span>
                    DamageType.NONE, false, false, throughFront));
        }

<span class="nc" id="L18305">        r = new Report(4230);</span>
<span class="nc" id="L18306">        r.subject = ae.getId();</span>
<span class="nc" id="L18307">        r.add(damage);</span>
<span class="nc" id="L18308">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18309">        r.indent();</span>
<span class="nc" id="L18310">        addReport(r);</span>

<span class="nc" id="L18312">        hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc bnc" id="L18313" title="All 2 branches missed.">        if ((2 * te.getOArmor(hit)) &lt; damage) {</span>
<span class="nc" id="L18314">            addReport(destroyEntity(te, &quot;by massive ramming damage&quot;, false));</span>
        } else {
<span class="nc" id="L18316">            addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                    false, false, throughFront));
        }
<span class="nc" id="L18319">    }</span>

    /**
     * Handle a charge's damage
     */
    private void resolveChargeDamage(Entity ae, Entity te, ToHitData toHit, int direction) {
<span class="nc" id="L18325">        resolveChargeDamage(ae, te, toHit, direction, false, true, false);</span>
<span class="nc" id="L18326">    }</span>

    private void resolveChargeDamage(Entity ae, Entity te, ToHitData toHit, int direction,
                                     boolean glancing, boolean throughFront, boolean airmechRam) {

        // we hit...

<span class="nc" id="L18333">        PilotingRollData chargePSR = null;</span>
        // If we're upright, we may fall down.
<span class="nc bnc" id="L18335" title="All 4 branches missed.">        if (!ae.isProne() &amp;&amp; !airmechRam) {</span>
<span class="nc" id="L18336">            chargePSR = new PilotingRollData(ae.getId(), 2, &quot;charging&quot;);</span>
        }

        // Damage To Target
        int damage;

        // Damage to Attacker
        int damageTaken;

<span class="nc bnc" id="L18345" title="All 2 branches missed.">        if (airmechRam) {</span>
<span class="nc" id="L18346">            damage = AirmechRamAttackAction.getDamageFor(ae);</span>
<span class="nc" id="L18347">            damageTaken = AirmechRamAttackAction.getDamageTakenBy(ae, te);</span>
        } else {
<span class="nc" id="L18349">            damage = ChargeAttackAction.getDamageFor(ae, te, game.getOptions()</span>
<span class="nc" id="L18350">                    .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE), toHit.getMoS());</span>
<span class="nc" id="L18351">            damageTaken = ChargeAttackAction.getDamageTakenBy(ae, te, game</span>
<span class="nc" id="L18352">                    .getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE));</span>
        }
<span class="nc bnc" id="L18354" title="All 2 branches missed.">        if (ae.hasWorkingMisc(MiscType.F_RAM_PLATE)) {</span>
<span class="nc" id="L18355">            damage = (int) Math.ceil(damage * 1.5);</span>
<span class="nc" id="L18356">            damageTaken = (int) Math.floor(damageTaken * 0.5);</span>
        }
<span class="nc bnc" id="L18358" title="All 2 branches missed.">        if (glancing) {</span>
            // Glancing Blow rule doesn't state whether damage to attacker on charge
            // or DFA is halved as well, assume yes. TODO : Check with PM
<span class="nc bnc" id="L18361" title="All 2 branches missed.">            damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
<span class="nc" id="L18362">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }
<span class="nc" id="L18364">        boolean bDirect = false;</span>
<span class="nc" id="L18365">        int directBlowCritMod = toHit.getMoS() / 3;</span>
<span class="nc bnc" id="L18366" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)</span>
<span class="nc bnc" id="L18367" title="All 2 branches missed.">                &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1)) {</span>
<span class="nc" id="L18368">            damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L18369">            bDirect = false;</span>
        }

        // Is the target inside a building?
<span class="nc" id="L18373">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>

        // Which building takes the damage?
<span class="nc" id="L18376">        Building bldg = game.getBoard().getBuildingAt(te.getPosition());</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc" id="L18380">        int bldgAbsorbs = 0;</span>
<span class="nc bnc" id="L18381" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L18382">            bldgAbsorbs = bldg.getAbsorbtion(te.getPosition());</span>
        }

        Report r;

        // damage to attacker
<span class="nc" id="L18388">        r = new Report(4240);</span>
<span class="nc" id="L18389">        r.subject = ae.getId();</span>
<span class="nc" id="L18390">        r.add(damageTaken);</span>
<span class="nc" id="L18391">        r.indent();</span>
<span class="nc" id="L18392">        addReport(r);</span>

        // Charging vehicles check for possible motive system hits.
<span class="nc bnc" id="L18395" title="All 2 branches missed.">        if (ae instanceof Tank) {</span>
<span class="nc" id="L18396">            r = new Report(4241);</span>
<span class="nc" id="L18397">            r.indent();</span>
<span class="nc" id="L18398">            addReport(r);</span>
<span class="nc" id="L18399">            int side = Compute.targetSideTable(te, ae);</span>
<span class="nc" id="L18400">            int mod = ae.getMotiveSideMod(side);</span>
<span class="nc" id="L18401">            addReport(vehicleMotiveDamage((Tank)ae, mod));</span>
        }

<span class="nc bnc" id="L18404" title="All 2 branches missed.">        while (damageTaken &gt; 0) {</span>
            int cluster;
            HitData hit;
            // An airmech ramming attack does all damage to attacker's CT
<span class="nc bnc" id="L18408" title="All 2 branches missed.">            if (airmechRam) {</span>
<span class="nc" id="L18409">                cluster = damageTaken;</span>
<span class="nc" id="L18410">                hit = new HitData(Mech.LOC_CT);</span>
            } else {
<span class="nc" id="L18412">                cluster = Math.min(5, damageTaken);</span>
<span class="nc" id="L18413">                hit = ae.rollHitLocation(toHit.getHitTable(), ae.sideTable(te.getPosition()));</span>
            }
<span class="nc" id="L18415">            damageTaken -= cluster;</span>
<span class="nc" id="L18416">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L18417">            cluster = checkForSpikes(ae, hit.getLocation(), cluster, te, Mech.LOC_CT);</span>
<span class="nc" id="L18418">            addReport(damageEntity(ae, hit, cluster, false, DamageType.NONE,</span>
                    false, false, throughFront));
<span class="nc" id="L18420">        }</span>

        // Damage to target
<span class="nc bnc" id="L18423" title="All 2 branches missed.">        if (ae instanceof Mech) {</span>
<span class="nc" id="L18424">            int spikeDamage = 0;</span>
<span class="nc bnc" id="L18425" title="All 2 branches missed.">            for (int loc = 0; loc &lt; ae.locations(); loc++) {</span>
<span class="nc bnc" id="L18426" title="All 4 branches missed.">                if (((Mech) ae).locationIsTorso(loc) &amp;&amp; ae.hasWorkingMisc(MiscType.F_SPIKES, -1, loc)) {</span>
<span class="nc" id="L18427">                    spikeDamage += 2;</span>
                }
            }
<span class="nc bnc" id="L18430" title="All 2 branches missed.">            if (spikeDamage &gt; 0) {</span>
<span class="nc" id="L18431">                r = new Report(4335);</span>
<span class="nc" id="L18432">                r.indent(2);</span>
<span class="nc" id="L18433">                r.subject = ae.getId();</span>
<span class="nc" id="L18434">                r.add(spikeDamage);</span>
<span class="nc" id="L18435">                addReport(r);</span>
            }
<span class="nc" id="L18437">            damage += spikeDamage;</span>
        }
<span class="nc" id="L18439">        r = new Report(4230);</span>
<span class="nc" id="L18440">        r.subject = ae.getId();</span>
<span class="nc" id="L18441">        r.add(damage);</span>
<span class="nc" id="L18442">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18443">        r.indent();</span>
<span class="nc" id="L18444">        addReport(r);</span>

        // Vehicles that have *been* charged check for motive system damage,
        // too...
        // ...though VTOLs don't use that table and should lose their rotor
        // instead,
        // which would be handled as part of the damage already.
<span class="nc bnc" id="L18451" title="All 4 branches missed.">        if ((te instanceof Tank) &amp;&amp; !(te instanceof VTOL)) {</span>
<span class="nc" id="L18452">            r = new Report(4242);</span>
<span class="nc" id="L18453">            r.indent();</span>
<span class="nc" id="L18454">            addReport(r);</span>

<span class="nc" id="L18456">            int side = Compute.targetSideTable(ae, te);</span>
<span class="nc" id="L18457">            int mod = te.getMotiveSideMod(side);</span>
<span class="nc" id="L18458">            addReport(vehicleMotiveDamage((Tank)te, mod));</span>
        }

        // track any additional damage to the attacker due to the target having spikes
<span class="nc" id="L18462">        int spikeDamage = 0;</span>
<span class="nc bnc" id="L18463" title="All 2 branches missed.">        while (damage &gt; 0) {</span>
<span class="nc" id="L18464">            int cluster = Math.min(5, damage);</span>
            // Airmech ramming attacks do all damage to a single location
<span class="nc bnc" id="L18466" title="All 2 branches missed.">            if (airmechRam) {</span>
<span class="nc" id="L18467">                cluster = damage;</span>
            }
<span class="nc" id="L18469">            damage -= cluster;</span>
<span class="nc bnc" id="L18470" title="All 2 branches missed.">            if (bldgAbsorbs &gt; 0) {</span>
<span class="nc" id="L18471">                int toBldg = Math.min(bldgAbsorbs, cluster);</span>
<span class="nc" id="L18472">                cluster -= toBldg;</span>
<span class="nc" id="L18473">                addNewLines();</span>
<span class="nc" id="L18474">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L18475">                                                               te.getPosition());</span>
<span class="nc bnc" id="L18476" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L18477">                    report.subject = ae.getId();</span>
<span class="nc" id="L18478">                }</span>
<span class="nc" id="L18479">                addReport(buildingReport);</span>

                // some buildings scale remaining damage that is not absorbed
                // TODO : this isn't quite right for castles brian
<span class="nc" id="L18483">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
            }

            // A building may absorb the entire shot.
<span class="nc bnc" id="L18487" title="All 2 branches missed.">            if (cluster == 0) {</span>
<span class="nc" id="L18488">                r = new Report(4235);</span>
<span class="nc" id="L18489">                r.subject = ae.getId();</span>
<span class="nc" id="L18490">                r.addDesc(te);</span>
<span class="nc" id="L18491">                r.indent();</span>
<span class="nc" id="L18492">                addReport(r);</span>
            } else {
<span class="nc" id="L18494">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L18495">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc bnc" id="L18496" title="All 2 branches missed.">                if (bDirect) {</span>
<span class="nc" id="L18497">                    hit.makeDirectBlow(directBlowCritMod);</span>
                }
<span class="nc" id="L18499">                cluster = checkForSpikes(te, hit.getLocation(), cluster, ae, Mech.LOC_CT);</span>
<span class="nc" id="L18500">                addReport(damageEntity(te, hit, cluster, false,</span>
                                       DamageType.NONE, false, false, throughFront));
            }
<span class="nc" id="L18503">        }</span>

<span class="nc bnc" id="L18505" title="All 2 branches missed.">        if (airmechRam) {</span>
<span class="nc bnc" id="L18506" title="All 2 branches missed.">            if (!ae.isDoomed()) {</span>
<span class="nc" id="L18507">                PilotingRollData controlRoll = ae.getBasePilotingRoll();</span>
<span class="nc" id="L18508">                Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
<span class="nc" id="L18509">                r = new Report(9320);</span>
<span class="nc" id="L18510">                r.subject = ae.getId();</span>
<span class="nc" id="L18511">                r.addDesc(ae);</span>
<span class="nc" id="L18512">                r.add(&quot;successful ramming attack&quot;);</span>
<span class="nc" id="L18513">                reports.add(r);</span>
<span class="nc" id="L18514">                int diceRoll = Compute.d6(2);</span>
                // different reports depending on out-of-control status
<span class="nc" id="L18516">                r = new Report(9606);</span>
<span class="nc" id="L18517">                r.subject = ae.getId();</span>
<span class="nc" id="L18518">                r.add(controlRoll.getValueAsString());</span>
<span class="nc" id="L18519">                r.add(controlRoll.getDesc());</span>
<span class="nc" id="L18520">                r.add(diceRoll);</span>
<span class="nc" id="L18521">                r.newlines = 1;</span>
<span class="nc bnc" id="L18522" title="All 2 branches missed.">                if (diceRoll &lt; controlRoll.getValue()) {</span>
<span class="nc" id="L18523">                    r.choose(false);</span>
<span class="nc" id="L18524">                    reports.add(r);</span>
<span class="nc" id="L18525">                    crashAirMech(ae, controlRoll, reports);</span>
                } else {
<span class="nc" id="L18527">                    r.choose(true);</span>
<span class="nc" id="L18528">                    reports.addElement(r);</span>
<span class="nc bnc" id="L18529" title="All 2 branches missed.">                    if (ae instanceof LandAirMech) {</span>
<span class="nc" id="L18530">                        reports.addAll(landAirMech((LandAirMech)ae, ae.getPosition(), 1, ae.delta_distance));</span>
                    }
                }
<span class="nc" id="L18533">                addReport(reports);</span>
<span class="nc" id="L18534">            }</span>
        } else {
            // move attacker and target, if possible
<span class="nc" id="L18537">            Coords src = te.getPosition();</span>
<span class="nc" id="L18538">            Coords dest = src.translated(direction);</span>

<span class="nc bnc" id="L18540" title="All 2 branches missed.">            if (Compute.isValidDisplacement(game, te.getId(), te.getPosition(),</span>
                                            direction)) {
<span class="nc" id="L18542">                addNewLines();</span>
<span class="nc" id="L18543">                addReport(doEntityDisplacement(te, src, dest, new PilotingRollData(</span>
<span class="nc" id="L18544">                        te.getId(), 2, &quot;was charged&quot;)));</span>
<span class="nc" id="L18545">                addReport(doEntityDisplacement(ae, ae.getPosition(), src, chargePSR));</span>
            }

<span class="nc" id="L18548">            addNewLines();</span>
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L18553" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L18554">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L18557">    } // End private void resolveChargeDamage( Entity, Entity, ToHitData )</span>

    /**
     * Checks whether the location has spikes, and if so handles the damage to the
     * attack and returns the reduced damage. Locations without spikes return the
     * original damage amount.
     *
     * @param target            The target of a physical attack
     * @param targetLocation    The location that was hit
     * @param damage            The amount of damage dealt to the target
     * @param attacker          The attacker
     * @param attackerLocation  The location on the attacker that is damaged if the
     *                          target has spikes. Entity.LOC_NONE if the attacker
     *                          can't be damaged by spikes in this attack.
     * @return          The damage after applying any reduction due to spikes
     */
    private int checkForSpikes(Entity target, int targetLocation, int damage,
                               Entity attacker, int attackerLocation) {
<span class="nc" id="L18575">        return checkForSpikes(target, targetLocation, damage, attacker, attackerLocation, Entity.LOC_NONE);</span>
    }

    /**
     * Checks whether the location has spikes, and if so handles the damage to the
     * attack and returns the reduced damage. Locations without spikes return the
     * original damage amount.
     *
     * @param target            The target of a physical attack
     * @param targetLocation    The location that was hit
     * @param damage            The amount of damage dealt to the target
     * @param attacker          The attacker
     * @param attackerLocation  The location on the attacker that is damaged if the
     *                          target has spikes. Entity.LOC_NONE if the attacker
     *                          can't be damaged by spikes in this attack.
     * @param attackerLocation2 If not Entity.LOC_NONE, the damage to the attacker
     *                          will be split between two locations.
     * @return          The damage after applying any reduction due to spikes
     */
    private int checkForSpikes(Entity target, int targetLocation, int damage,
                               Entity attacker, int attackerLocation, int attackerLocation2) {
<span class="nc bnc" id="L18596" title="All 2 branches missed.">        if (target.hasWorkingMisc(MiscType.F_SPIKES, -1, targetLocation)) {</span>
            Report r;
<span class="nc bnc" id="L18598" title="All 2 branches missed.">            if (damage == 0) {</span>
                // Only show damage to attacker (push attack)
<span class="nc" id="L18600">                r = new Report(4333);</span>
<span class="nc bnc" id="L18601" title="All 2 branches missed.">            } else if (attackerLocation != Entity.LOC_NONE) {</span>
                // Show damage reduction and damage to attacker
<span class="nc" id="L18603">                r = new Report(4330);</span>
            } else {
                // Only show damage reduction (club/physical weapon attack)
<span class="nc" id="L18606">                r = new Report(4331);</span>
            }
<span class="nc" id="L18608">            r.indent(2);</span>
<span class="nc" id="L18609">            r.subject = target.getId();</span>
<span class="nc" id="L18610">            addReport(r);</span>
            // An attack that deals zero damage can still damage the attacker in the case of a push
<span class="nc bnc" id="L18612" title="All 2 branches missed.">            if (attackerLocation != Entity.LOC_NONE) {</span>
                // Spikes also protect from retaliatory spike damage
<span class="nc bnc" id="L18614" title="All 2 branches missed.">                if (attacker.hasWorkingMisc(MiscType.F_SPIKES, -1, attackerLocation)) {</span>
<span class="nc" id="L18615">                    r = new Report(4332);</span>
<span class="nc" id="L18616">                    r.indent(2);</span>
<span class="nc" id="L18617">                    r.subject = attacker.getId();</span>
<span class="nc" id="L18618">                    addReport(r);</span>
<span class="nc bnc" id="L18619" title="All 2 branches missed.">                } else if (attackerLocation2 == Entity.LOC_NONE) {</span>
<span class="nc" id="L18620">                    addReport(damageEntity(attacker, new HitData(attackerLocation), 2, false,</span>
                            DamageType.NONE,false, false, false));
                } else {
<span class="nc" id="L18623">                    addReport(damageEntity(attacker, new HitData(attackerLocation), 1, false,</span>
                            DamageType.NONE, false, false, false));
<span class="nc" id="L18625">                    addReport(damageEntity(attacker, new HitData(attackerLocation2), 1, false,</span>
                            DamageType.NONE, false, false, false));
                }
            }
<span class="nc" id="L18629">            return Math.max(1, damage - 4);</span>
        }
<span class="nc" id="L18631">        return damage;</span>
    }

    /**
     * End-phase checks for laid explosives; check whether explosives are
     * touched off, or if we should report laying explosives
     */
    private void checkLayExplosives() {
        // Report continuing explosive work
<span class="nc bnc" id="L18640" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L18641" title="All 2 branches missed.">            if (!(e instanceof Infantry)) {</span>
<span class="nc" id="L18642">                continue;</span>
            }
<span class="nc" id="L18644">            Infantry inf = (Infantry) e;</span>
<span class="nc bnc" id="L18645" title="All 2 branches missed.">            if (inf.turnsLayingExplosives &gt; 0) {</span>
<span class="nc" id="L18646">                Report r = new Report(4271);</span>
<span class="nc" id="L18647">                r.subject = inf.getId();</span>
<span class="nc" id="L18648">                r.addDesc(inf);</span>
<span class="nc" id="L18649">                addReport(r);</span>
            }
<span class="nc" id="L18651">        }</span>
        // Check for touched-off explosives
<span class="nc" id="L18653">        Vector&lt;Building&gt; updatedBuildings = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L18654" title="All 2 branches missed.">        for (DemolitionCharge charge : explodingCharges) {</span>
<span class="nc" id="L18655">            Building bldg = game.getBoard().getBuildingAt(charge.pos);</span>
<span class="nc bnc" id="L18656" title="All 2 branches missed.">            if (bldg == null) { // Shouldn't happen...</span>
<span class="nc" id="L18657">                continue;</span>
            }
<span class="nc" id="L18659">            bldg.removeDemolitionCharge(charge);</span>
<span class="nc" id="L18660">            updatedBuildings.add(bldg);</span>
<span class="nc" id="L18661">            Report r = new Report(4272, Report.PUBLIC);</span>
<span class="nc" id="L18662">            r.add(bldg.getName());</span>
<span class="nc" id="L18663">            addReport(r);</span>
<span class="nc" id="L18664">            Vector&lt;Report&gt; dmgReports = damageBuilding(bldg, charge.damage,</span>
                    &quot; explodes for &quot;, charge.pos);
<span class="nc bnc" id="L18666" title="All 2 branches missed.">            for (Report rep : dmgReports) {</span>
<span class="nc" id="L18667">                rep.indent();</span>
<span class="nc" id="L18668">                addReport(rep);</span>
<span class="nc" id="L18669">            }</span>
<span class="nc" id="L18670">        }</span>
<span class="nc" id="L18671">        explodingCharges.clear();</span>
<span class="nc" id="L18672">        sendChangedBuildings(updatedBuildings);</span>
<span class="nc" id="L18673">    }</span>

    private void resolveLayExplosivesAttack(PhysicalResult pr) {
<span class="nc" id="L18676">        final LayExplosivesAttackAction laa = (LayExplosivesAttackAction) pr.aaa;</span>
<span class="nc" id="L18677">        final Entity ae = game.getEntity(laa.getEntityId());</span>
<span class="nc bnc" id="L18678" title="All 2 branches missed.">        if (ae instanceof Infantry) {</span>
<span class="nc" id="L18679">            Infantry inf = (Infantry) ae;</span>
<span class="nc bnc" id="L18680" title="All 2 branches missed.">            if (inf.turnsLayingExplosives &lt; 0) {</span>
<span class="nc" id="L18681">                inf.turnsLayingExplosives = 0;</span>
<span class="nc" id="L18682">                Report r = new Report(4270);</span>
<span class="nc" id="L18683">                r.subject = inf.getId();</span>
<span class="nc" id="L18684">                r.addDesc(inf);</span>
<span class="nc" id="L18685">                addReport(r);</span>
<span class="nc" id="L18686">            } else {</span>
<span class="nc" id="L18687">                Building building = game.getBoard().getBuildingAt(ae.getPosition());</span>
<span class="nc bnc" id="L18688" title="All 2 branches missed.">                if (building != null) {</span>
<span class="nc" id="L18689">                    building.addDemolitionCharge(ae.getOwner().getId(), pr.damage, ae.getPosition());</span>
<span class="nc" id="L18690">                    Report r = new Report(4275);</span>
<span class="nc" id="L18691">                    r.subject = inf.getId();</span>
<span class="nc" id="L18692">                    r.addDesc(inf);</span>
<span class="nc" id="L18693">                    r.add(pr.damage);</span>
<span class="nc" id="L18694">                    addReport(r);</span>
                    // Update clients with this info
<span class="nc" id="L18696">                    Vector&lt;Building&gt; updatedBuildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L18697">                    updatedBuildings.add(building);</span>
<span class="nc" id="L18698">                    sendChangedBuildings(updatedBuildings);</span>
                }
<span class="nc" id="L18700">                inf.turnsLayingExplosives = -1;</span>
            }
        }
<span class="nc" id="L18703">    }</span>

    /**
     * Handle a death from above attack
     */
    private void resolveDfaAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18709">        final DfaAttackAction daa = (DfaAttackAction) pr.aaa;</span>
<span class="nc" id="L18710">        final Entity ae = game.getEntity(daa.getEntityId());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L18713" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L18714">            return;</span>
        }

<span class="nc" id="L18717">        final IHex aeHex = game.getBoard().getHex(ae.getPosition());</span>
<span class="nc" id="L18718">        final IHex teHex = game.getBoard().getHex(daa.getTargetPos());</span>
<span class="nc" id="L18719">        final Targetable target = game.getTarget(daa.getTargetType(), daa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L18721">        int damage = pr.damage;</span>
<span class="nc" id="L18722">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18723">        int roll = pr.roll;</span>
<span class="nc" id="L18724">        Entity te = null;</span>
<span class="nc bnc" id="L18725" title="All 2 branches missed.">        if ((target != null)</span>
<span class="nc bnc" id="L18726" title="All 2 branches missed.">            &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
            // Lets re-write around that horrible hack that was here before.
            // So instead of asking if a specific location is wet and praying
            // that it won't cause an NPE...
            // We'll check 1) if the hex has water, and 2) if it's deep enough
            // to cover the unit in question at its current elevation.
            // It's especially important to make sure it's done this way,
            // because some units (Sylph, submarines) can be at ANY elevation
            // underwater, and VTOLs can be well above the surface.
<span class="nc" id="L18735">            te = (Entity) target;</span>
<span class="nc" id="L18736">            IHex hex = game.getBoard().getHex(te.getPosition());</span>
<span class="nc bnc" id="L18737" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L18738" title="All 2 branches missed.">                if (te.relHeight() &lt; 0) {</span>
<span class="nc" id="L18739">                    damage = (int) Math.ceil(damage * 0.5f);</span>
                }
            }
        }
<span class="nc" id="L18743">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18744" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18745">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L18747" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L18748" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>
        // Set Margin of Success/Failure.
<span class="nc" id="L18750">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L18751" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L18752" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

<span class="nc" id="L18756">        final int direction = ae.getFacing();</span>

<span class="nc bnc" id="L18758" title="All 2 branches missed.">        if (lastEntityId != daa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18760">            r = new Report(4005);</span>
<span class="nc" id="L18761">            r.subject = ae.getId();</span>
<span class="nc" id="L18762">            r.addDesc(ae);</span>
<span class="nc" id="L18763">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18767" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L18768" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18769">            r = new Report(4245);</span>
<span class="nc" id="L18770">            r.subject = ae.getId();</span>
<span class="nc" id="L18771">            r.indent();</span>
<span class="nc" id="L18772">            addReport(r);</span>
            // entity isn't DFAing any more
<span class="nc" id="L18774">            ae.setDisplacementAttack(null);</span>
<span class="nc bnc" id="L18775" title="All 2 branches missed.">            if (ae.isProne()) {</span>
                // attacker prone during weapons phase
<span class="nc" id="L18777">                addReport(doEntityFall(ae, daa.getTargetPos(), 2, 3,</span>
<span class="nc" id="L18778">                        ae.getBasePilotingRoll(), false, false));</span>

            } else {
                // same effect as successful DFA
<span class="nc" id="L18782">                ae.setElevation(ae.calcElevation(aeHex, teHex, 0, false, false));</span>
<span class="nc" id="L18783">                addReport(doEntityDisplacement(ae, ae.getPosition(),</span>
<span class="nc" id="L18784">                        daa.getTargetPos(), new PilotingRollData(ae.getId(), 4,</span>
                                &quot;executed death from above&quot;)));
            }
<span class="nc" id="L18787">            return;</span>
        }

<span class="nc" id="L18790">        r = new Report(4246);</span>
<span class="nc" id="L18791">        r.subject = ae.getId();</span>
<span class="nc" id="L18792">        r.indent();</span>
<span class="nc" id="L18793">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18794">        r.newlines = 0;</span>
<span class="nc" id="L18795">        addReport(r);</span>

        // target still in the same position?
<span class="nc bnc" id="L18798" title="All 2 branches missed.">        if (!target.getPosition().equals(daa.getTargetPos())) {</span>
<span class="nc" id="L18799">            r = new Report(4215);</span>
<span class="nc" id="L18800">            r.subject = ae.getId();</span>
<span class="nc" id="L18801">            addReport(r);</span>
            // entity isn't DFAing any more
<span class="nc" id="L18803">            ae.setDisplacementAttack(null);</span>
<span class="nc" id="L18804">            addReport(doEntityFallsInto(ae, ae.getElevation(), ae.getPosition(), daa.getTargetPos(),</span>
<span class="nc" id="L18805">                    ae.getBasePilotingRoll(), true));</span>
<span class="nc" id="L18806">            return;</span>
        }

        // hack: if the attacker's prone, or incapacitated, fudge the roll
<span class="nc bnc" id="L18810" title="All 4 branches missed.">        if (ae.isProne() || !ae.isActive()) {</span>
<span class="nc" id="L18811">            roll = -12;</span>
<span class="nc" id="L18812">            r = new Report(4250);</span>
<span class="nc" id="L18813">            r.subject = ae.getId();</span>
<span class="nc" id="L18814">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18815">            r.newlines--;</span>
<span class="nc" id="L18816">            addReport(r);</span>
<span class="nc bnc" id="L18817" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L18818">            roll = -12;</span>
<span class="nc" id="L18819">            r = new Report(4255);</span>
<span class="nc" id="L18820">            r.subject = ae.getId();</span>
<span class="nc" id="L18821">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18822">            addReport(r);</span>
<span class="nc bnc" id="L18823" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18824">            r = new Report(4260);</span>
<span class="nc" id="L18825">            r.subject = ae.getId();</span>
<span class="nc" id="L18826">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18827">            addReport(r);</span>
<span class="nc" id="L18828">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L18831">            r = new Report(4025);</span>
<span class="nc" id="L18832">            r.subject = ae.getId();</span>
<span class="nc" id="L18833">            r.add(toHit);</span>
<span class="nc" id="L18834">            r.add(roll);</span>
<span class="nc" id="L18835">            r.newlines = 0;</span>
<span class="nc" id="L18836">            addReport(r);</span>
<span class="nc bnc" id="L18837" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L18838">                r = new Report(3186);</span>
<span class="nc" id="L18839">                r.subject = ae.getId();</span>
<span class="nc" id="L18840">                r.newlines = 0;</span>
<span class="nc" id="L18841">                addReport(r);</span>
            }
<span class="nc bnc" id="L18843" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18844">                r = new Report(3189);</span>
<span class="nc" id="L18845">                r.subject = ae.getId();</span>
<span class="nc" id="L18846">                r.newlines = 0;</span>
<span class="nc" id="L18847">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L18853" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L18854">            Coords dest = te.getPosition();</span>
<span class="nc" id="L18855">            Coords targetDest = Compute.getPreferredDisplacement(game, te.getId(), dest, direction);</span>
            // miss
<span class="nc" id="L18857">            r = new Report(4035);</span>
<span class="nc" id="L18858">            r.subject = ae.getId();</span>
<span class="nc" id="L18859">            addReport(r);</span>
<span class="nc bnc" id="L18860" title="All 2 branches missed.">            if (targetDest != null) {</span>
                // move target to preferred hex
<span class="nc" id="L18862">                addReport(doEntityDisplacement(te, dest, targetDest, null));</span>
                // attacker falls into destination hex
<span class="nc" id="L18864">                r = new Report(4265);</span>
<span class="nc" id="L18865">                r.subject = ae.getId();</span>
<span class="nc" id="L18866">                r.addDesc(ae);</span>
<span class="nc" id="L18867">                r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L18868">                r.indent();</span>
<span class="nc" id="L18869">                addReport(r);</span>
                // entity isn't DFAing any more
<span class="nc" id="L18871">                ae.setDisplacementAttack(null);</span>
<span class="nc" id="L18872">                addReport(doEntityFall(ae, dest, 2, 3, ae.getBasePilotingRoll(),</span>
                        false, false), 1);
<span class="nc" id="L18874">                Entity violation = Compute.stackingViolation(game, ae.getId(), dest);</span>
<span class="nc bnc" id="L18875" title="All 2 branches missed.">                if (violation != null) {</span>
                    // target gets displaced
<span class="nc" id="L18877">                    targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L18878">                            violation.getId(), dest, direction);</span>
<span class="nc" id="L18879">                    vPhaseReport.addAll(doEntityDisplacement(violation, dest,</span>
<span class="nc" id="L18880">                            targetDest, new PilotingRollData(violation.getId(),</span>
                                    0, &quot;domino effect&quot;)));
                    // Update the violating entity's position on the client.
<span class="nc bnc" id="L18883" title="All 2 branches missed.">                    if (!game.getOutOfGameEntitiesVector().contains(violation)) {</span>
<span class="nc" id="L18884">                        entityUpdate(violation.getId());</span>
                    }
                }
<span class="nc" id="L18887">            } else {</span>
                // attacker destroyed
                // Tanks suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L18891">                addReport(destroyEntity(ae, &quot;impossible displacement&quot;,</span>
                        ae instanceof Mech, ae instanceof Mech));
            }
<span class="nc" id="L18894">            return;</span>
        }

        // we hit...

<span class="nc" id="L18899">        r = new Report(4040);</span>
<span class="nc" id="L18900">        r.subject = ae.getId();</span>
<span class="nc" id="L18901">        addReport(r);</span>

<span class="nc" id="L18903">        Coords dest = target.getPosition();</span>

        // Can't DFA a target inside of a building.
<span class="nc" id="L18906">        int damageTaken = DfaAttackAction.getDamageTakenBy(ae);</span>

        // Targeting a building.
<span class="nc bnc" id="L18909" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L18910" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>

            // Which building takes the damage?
<span class="nc" id="L18913">            Building bldg = game.getBoard().getBuildingAt(daa.getTargetPos());</span>
            
            // The building takes the full brunt of the attack.
<span class="nc" id="L18916">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L18917" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L18918">                report.subject = ae.getId();</span>
<span class="nc" id="L18919">            }</span>
<span class="nc" id="L18920">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L18923">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>
<span class="nc" id="L18924">        } else { // Target isn't building.</span>
<span class="nc bnc" id="L18925" title="All 4 branches missed.">            if (glancing &amp;&amp; (te != null)) {</span>
<span class="nc bnc" id="L18926" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L18928" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18929">                damage += toHit.getMoS() / 3;</span>
            }
            // damage target
<span class="nc" id="L18932">            r = new Report(4230);</span>
<span class="nc" id="L18933">            r.subject = ae.getId();</span>
<span class="nc" id="L18934">            r.add(damage);</span>
<span class="nc" id="L18935">            r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18936">            r.indent(2);</span>
<span class="nc" id="L18937">            addReport(r);</span>

<span class="nc bnc" id="L18939" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L18940">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L18941">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L18942">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc bnc" id="L18943" title="All 2 branches missed.">                if (directBlow) {</span>
<span class="nc" id="L18944">                    hit.makeDirectBlow(toHit.getMoS() / 3);</span>
                }
<span class="nc" id="L18946">                damage -= cluster;</span>
<span class="nc" id="L18947">                cluster = checkForSpikes(te, hit.getLocation(), cluster, ae, Mech.LOC_LLEG, Mech.LOC_RLEG);</span>
<span class="nc" id="L18948">                addReport(damageEntity(te, hit, cluster, false,</span>
                                       DamageType.NONE, false, false, throughFront));
<span class="nc" id="L18950">            }</span>
<span class="nc bnc" id="L18951" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L18953">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
            // Target entities are pushed away or destroyed.
<span class="nc" id="L18958">            Coords targetDest = Compute.getValidDisplacement(game, te.getId(), dest, direction);</span>
<span class="nc bnc" id="L18959" title="All 2 branches missed.">            if (targetDest != null) {</span>
<span class="nc" id="L18960">                addReport(doEntityDisplacement(te, dest, targetDest,</span>
<span class="nc" id="L18961">                        new PilotingRollData(te.getId(), 2, &quot;hit by death from above&quot;)));</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L18966">                addReport(destroyEntity(te, &quot;impossible displacement&quot;,</span>
                        te instanceof Mech, te instanceof Mech));
            }

        }

<span class="nc bnc" id="L18972" title="All 2 branches missed.">        if (glancing) {</span>
            // Glancing Blow rule doesn't state whether damage to attacker on charge
            // or DFA is halved as well, assume yes. TODO : Check with PM
<span class="nc" id="L18975">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

<span class="nc bnc" id="L18978" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_POS_REINFORCED_LEGS)) {</span>
<span class="nc" id="L18979">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

        // damage attacker
<span class="nc" id="L18983">        r = new Report(4240);</span>
<span class="nc" id="L18984">        r.subject = ae.getId();</span>
<span class="nc" id="L18985">        r.add(damageTaken);</span>
<span class="nc" id="L18986">        r.indent(2);</span>
<span class="nc" id="L18987">        addReport(r);</span>
<span class="nc bnc" id="L18988" title="All 2 branches missed.">        while (damageTaken &gt; 0) {</span>
<span class="nc" id="L18989">            int cluster = Math.min(5, damageTaken);</span>
<span class="nc" id="L18990">            HitData hit = ae.rollHitLocation(ToHitData.HIT_KICK, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L18991">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L18992">            addReport(damageEntity(ae, hit, cluster));</span>
<span class="nc" id="L18993">            damageTaken -= cluster;</span>
<span class="nc" id="L18994">        }</span>

<span class="nc bnc" id="L18996" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_NEG_WEAK_LEGS)) {</span>
<span class="nc" id="L18997">            addNewLines();</span>
<span class="nc" id="L18998">            addReport(criticalEntity(ae, Mech.LOC_LLEG, false, 0, 0));</span>
<span class="nc" id="L18999">            addNewLines();</span>
<span class="nc" id="L19000">            addReport(criticalEntity(ae, Mech.LOC_RLEG, false, 0, 0));</span>
<span class="nc bnc" id="L19001" title="All 2 branches missed.">            if (ae instanceof QuadMech) {</span>
<span class="nc" id="L19002">                addNewLines();</span>
<span class="nc" id="L19003">                addReport(criticalEntity(ae, Mech.LOC_LARM, false, 0, 0));</span>
<span class="nc" id="L19004">                addNewLines();</span>
<span class="nc" id="L19005">                addReport(criticalEntity(ae, Mech.LOC_RARM, false, 0, 0));</span>
            }
        }

<span class="nc" id="L19009">        addNewLines();</span>

        // That's it for target buildings.
<span class="nc bnc" id="L19012" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L19013" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
<span class="nc" id="L19014">            return;</span>
        }
<span class="nc" id="L19016">        ae.setElevation(ae.calcElevation(aeHex, teHex, 0, false, false));</span>
        // HACK: to avoid automatic falls, displace from dest to dest
<span class="nc" id="L19018">        addReport(doEntityDisplacement(ae, dest, dest, new PilotingRollData(</span>
<span class="nc" id="L19019">                ae.getId(), 4, &quot;executed death from above&quot;)));</span>

        // entity isn't DFAing any more
<span class="nc" id="L19022">        ae.setDisplacementAttack(null);</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L19026" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L19027">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L19029">    }</span>

    /**
     * Get the Kick or Push PSR, modified by weight class
     *
     * @param psrEntity The &lt;code&gt;Entity&lt;/code&gt; that should make a PSR
     * @param attacker  The attacking &lt;code&gt;Entity&gt;&lt;/code&gt;
     * @param target    The target &lt;code&gt;Entity&lt;/code&gt;
     * @return The &lt;code&gt;PilotingRollData&lt;/code&gt;
     */
    private PilotingRollData getKickPushPSR(Entity psrEntity, Entity attacker,
                                            Entity target, String reason) {
<span class="nc" id="L19041">        int mod = 0;</span>
<span class="nc" id="L19042">        PilotingRollData psr = new PilotingRollData(psrEntity.getId(), mod,</span>
                                                    reason);
<span class="nc bnc" id="L19044" title="All 2 branches missed.">        if (psrEntity.hasQuirk(OptionsConstants.QUIRK_POS_STABLE)) {</span>
<span class="nc" id="L19045">            psr.addModifier(-1, &quot;stable&quot;, false);</span>
        }
<span class="nc bnc" id="L19047" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_PHYSICAL_PSR)) {</span>

<span class="nc bnc" id="L19049" title="All 5 branches missed.">            switch (target.getWeightClass()) {</span>
                case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L19051">                    mod = 1;</span>
<span class="nc" id="L19052">                    break;</span>
                case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L19054">                    mod = 0;</span>
<span class="nc" id="L19055">                    break;</span>
                case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L19057">                    mod = -1;</span>
<span class="nc" id="L19058">                    break;</span>
                case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L19060">                    mod = -2;</span>
                    break;
            }
            String reportStr;
<span class="nc bnc" id="L19064" title="All 2 branches missed.">            if (mod &gt; 0) {</span>
<span class="nc" id="L19065">                reportStr = (&quot;weight class modifier +&quot;) + mod;</span>
            } else {
<span class="nc" id="L19067">                reportStr = (&quot;weight class modifier &quot;) + mod;</span>
            }
<span class="nc" id="L19069">            psr.addModifier(mod, reportStr, false);</span>
        }
<span class="nc" id="L19071">        return psr;</span>
    }

    /**
     * Each mech sinks the amount of heat appropriate to its current heat
     * capacity.
     */
    private void resolveHeat() {
        Report r;
        // Heat phase header
<span class="nc" id="L19081">        addReport(new Report(5000, Report.PUBLIC));</span>
<span class="nc bnc" id="L19082" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L19083">            Entity entity = i.next();</span>
<span class="nc bnc" id="L19084" title="All 4 branches missed.">            if ((null == entity.getPosition()) &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L19085">                continue;</span>
            }
<span class="nc" id="L19087">            IHex entityHex = game.getBoard().getHex(entity.getPosition());</span>

<span class="nc" id="L19089">            int hotDogMod = 0;</span>
<span class="nc bnc" id="L19090" title="All 2 branches missed.">            if (entity.hasAbility(OptionsConstants.PILOT_HOT_DOG)) {</span>
<span class="nc" id="L19091">                hotDogMod = 1;</span>
            }
<span class="nc bnc" id="L19093" title="All 2 branches missed.">            if (entity.getTaserInterferenceHeat()) {</span>
<span class="nc" id="L19094">                entity.heatBuildup += 5;</span>
            }
<span class="nc bnc" id="L19096" title="All 4 branches missed.">            if (entity.hasDamagedRHS() &amp;&amp; entity.weaponFired()) {</span>
<span class="nc" id="L19097">                entity.heatBuildup += 1;</span>
            }
<span class="nc bnc" id="L19099" title="All 6 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech)entity).hasDamagedCoolantSystem() &amp;&amp; entity.weaponFired()) {</span>
<span class="nc" id="L19100">                entity.heatBuildup += 1;</span>
            }

<span class="nc" id="L19103">            int radicalHSBonus = 0;</span>
<span class="nc" id="L19104">            Vector&lt;Report&gt; rhsReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L19105" title="All 2 branches missed.">            if (entity.hasActivatedRadicalHS()) {</span>
<span class="nc bnc" id="L19106" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L19107">                    radicalHSBonus = ((Mech) entity).getActiveSinks();</span>
<span class="nc bnc" id="L19108" title="All 2 branches missed.">                } else if (entity instanceof Aero) {</span>
<span class="nc" id="L19109">                    radicalHSBonus = ((Aero) entity).getHeatSinks();</span>
                } else {
<span class="nc" id="L19111">                    MegaMek.getLogger().error(&quot;Radical heat sinks mounted on non-mech, non-aero Entity!&quot;);</span>
                }
<span class="nc" id="L19113">                int rhsRoll = Compute.d6(2);</span>
                int targetNumber;
<span class="nc bnc" id="L19115" title="All 7 branches missed.">                switch (entity.getConsecutiveRHSUses()) {</span>
                    case 0:
<span class="nc" id="L19117">                        targetNumber = 2;</span>
<span class="nc" id="L19118">                        break;</span>
                    case 1:
<span class="nc" id="L19120">                        targetNumber = 3;</span>
<span class="nc" id="L19121">                        break;</span>
                    case 2:
<span class="nc" id="L19123">                        targetNumber = 5;</span>
<span class="nc" id="L19124">                        break;</span>
                    case 3:
<span class="nc" id="L19126">                        targetNumber = 7;</span>
<span class="nc" id="L19127">                        break;</span>
                    case 4:
<span class="nc" id="L19129">                        targetNumber = 10;</span>
<span class="nc" id="L19130">                        break;</span>
                    case 5:
<span class="nc" id="L19132">                        targetNumber = 11;</span>
<span class="nc" id="L19133">                        break;</span>
                    case 6:
                    default:
<span class="nc" id="L19136">                        targetNumber = TargetRoll.AUTOMATIC_FAIL;</span>
                        break;
                }
<span class="nc" id="L19139">                entity.setConsecutiveRHSUses(entity.getConsecutiveRHSUses() + 1);</span>

                // RHS activation report
<span class="nc" id="L19142">                r = new Report(5540);</span>
<span class="nc" id="L19143">                r.subject = entity.getId();</span>
<span class="nc" id="L19144">                r.indent();</span>
<span class="nc" id="L19145">                r.addDesc(entity);</span>
<span class="nc" id="L19146">                r.add(radicalHSBonus);</span>
<span class="nc" id="L19147">                rhsReports.add(r);</span>

<span class="nc bnc" id="L19149" title="All 2 branches missed.">                boolean rhsFailure = rhsRoll &lt; targetNumber;</span>
<span class="nc" id="L19150">                r = new Report(5541);</span>
<span class="nc" id="L19151">                r.indent(2);</span>
<span class="nc" id="L19152">                r.subject = entity.getId();</span>
<span class="nc" id="L19153">                r.add(targetNumber);</span>
<span class="nc" id="L19154">                r.add(rhsRoll);</span>
<span class="nc" id="L19155">                r.choose(rhsFailure);</span>
<span class="nc" id="L19156">                rhsReports.add(r);</span>

<span class="nc bnc" id="L19158" title="All 2 branches missed.">                if (rhsFailure) {</span>
<span class="nc" id="L19159">                    entity.setHasDamagedRHS(true);</span>
<span class="nc" id="L19160">                    int loc = Entity.LOC_NONE;</span>
<span class="nc bnc" id="L19161" title="All 2 branches missed.">                    for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19162" title="All 2 branches missed.">                        if (m.getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L19163">                            loc = m.getLocation();</span>
<span class="nc" id="L19164">                            m.setDestroyed(true);</span>
<span class="nc" id="L19165">                            break;</span>
                        }
<span class="nc" id="L19167">                    }</span>
<span class="nc bnc" id="L19168" title="All 2 branches missed.">                    if (loc == Entity.LOC_NONE) {</span>
<span class="nc" id="L19169">                        throw new IllegalStateException(&quot;Server.resolveHeat(): &quot; +</span>
                                &quot;Could not find Radical Heat Sink mount on unit that used RHS!&quot;);
                    }
<span class="nc bnc" id="L19172" title="All 2 branches missed.">                    for (int s = 0; s &lt; entity.getNumberOfCriticals(loc); s++) {</span>
<span class="nc" id="L19173">                        CriticalSlot slot = entity.getCritical(loc, s);</span>
<span class="nc bnc" id="L19174" title="All 2 branches missed.">                        if ((slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L19175" title="All 2 branches missed.">                                &amp;&amp; slot.getMount().getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L19176">                            slot.setHit(true);</span>
<span class="nc" id="L19177">                            break;</span>
                        }
                    }
                }
            }

            // put in ASF heat build-up first because there are few differences
<span class="nc bnc" id="L19184" title="All 4 branches missed.">            if (entity instanceof Aero &amp;&amp; !(entity instanceof ConvFighter)) {</span>
<span class="nc" id="L19185">                ServerHelper.resolveAeroHeat(game, entity, vPhaseReport, rhsReports, radicalHSBonus, hotDogMod, this);</span>
<span class="nc" id="L19186">                continue;</span>
            }

            // heat doesn't matter for non-mechs
<span class="nc bnc" id="L19190" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L19191">                entity.heat = 0;</span>
<span class="nc" id="L19192">                entity.heatBuildup = 0;</span>
<span class="nc" id="L19193">                entity.heatFromExternal = 0;</span>
<span class="nc" id="L19194">                entity.coolFromExternal = 0;</span>

<span class="nc bnc" id="L19196" title="All 2 branches missed.">                if (entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L19197">                    doFlamingDamage(entity);</span>
                }
<span class="nc bnc" id="L19199" title="All 2 branches missed.">                if (entity.getTaserShutdownRounds() == 0) {</span>
<span class="nc" id="L19200">                    entity.setBATaserShutdown(false);</span>
<span class="nc bnc" id="L19201" title="All 4 branches missed.">                    if (entity.isShutDown() &amp;&amp; !entity.isManualShutdown()</span>
<span class="nc bnc" id="L19202" title="All 2 branches missed.">                            &amp;&amp; (entity.getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc" id="L19203">                        entity.setShutDown(false);</span>
<span class="nc" id="L19204">                        r = new Report(5045);</span>
<span class="nc" id="L19205">                        r.subject = entity.getId();</span>
<span class="nc" id="L19206">                        r.addDesc(entity);</span>
<span class="nc" id="L19207">                        addReport(r);</span>
                    }
<span class="nc bnc" id="L19209" title="All 2 branches missed.">                } else if (entity.isBATaserShutdown()) {</span>
                    // if we're shutdown by a BA taser, we might activate again
<span class="nc" id="L19211">                    int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L19212" title="All 2 branches missed.">                    if (roll &gt;= 8) {</span>
<span class="nc" id="L19213">                        entity.setTaserShutdownRounds(0);</span>
<span class="nc bnc" id="L19214" title="All 2 branches missed.">                        if (!(entity.isManualShutdown())) {</span>
<span class="nc" id="L19215">                            entity.setShutDown(false);</span>
                        }
<span class="nc" id="L19217">                        entity.setBATaserShutdown(false);</span>
                    }
<span class="nc" id="L19219">                }</span>

                continue;
            }

            // Only Mechs after this point

            // Meks gain heat from inferno hits.
<span class="nc bnc" id="L19227" title="All 2 branches missed.">            if (entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L19228">                int infernoHeat = entity.infernos.getHeat();</span>
<span class="nc" id="L19229">                entity.heatFromExternal += infernoHeat;</span>
<span class="nc" id="L19230">                r = new Report(5010);</span>
<span class="nc" id="L19231">                r.subject = entity.getId();</span>
<span class="nc" id="L19232">                r.add(infernoHeat);</span>
<span class="nc" id="L19233">                addReport(r);</span>
            }

            // should we even bother for this mech?
<span class="nc bnc" id="L19237" title="All 6 branches missed.">            if (entity.isDestroyed() || entity.isDoomed() || entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19238" title="All 2 branches missed.">                    || entity.getCrew().isDead()) {</span>
<span class="nc" id="L19239">                continue;</span>
            }

            // engine hits add a lot of heat, provided the engine is on
<span class="nc" id="L19243">            entity.heatBuildup += entity.getEngineCritHeat();</span>

            // If a Mek had an active Stealth suite, add 10 heat.
<span class="nc bnc" id="L19246" title="All 2 branches missed.">            if (entity.isStealthOn()) {</span>
<span class="nc" id="L19247">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19248">                r = new Report(5015);</span>
<span class="nc" id="L19249">                r.subject = entity.getId();</span>
<span class="nc" id="L19250">                addReport(r);</span>
            }

            // Greg: Nova CEWS If a Mek had an active Nova suite, add 2 heat.
<span class="nc bnc" id="L19254" title="All 2 branches missed.">            if (entity.hasActiveNovaCEWS()) {</span>
<span class="nc" id="L19255">                entity.heatBuildup += 2;</span>
<span class="nc" id="L19256">                r = new Report(5013);</span>
<span class="nc" id="L19257">                r.subject = entity.getId();</span>
<span class="nc" id="L19258">                addReport(r);</span>
            }

            // void sig adds 10 heat
<span class="nc bnc" id="L19262" title="All 2 branches missed.">            if (entity.isVoidSigOn()) {</span>
<span class="nc" id="L19263">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19264">                r = new Report(5016);</span>
<span class="nc" id="L19265">                r.subject = entity.getId();</span>
<span class="nc" id="L19266">                addReport(r);</span>
            }

            // null sig adds 10 heat
<span class="nc bnc" id="L19270" title="All 2 branches missed.">            if (entity.isNullSigOn()) {</span>
<span class="nc" id="L19271">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19272">                r = new Report(5017);</span>
<span class="nc" id="L19273">                r.subject = entity.getId();</span>
<span class="nc" id="L19274">                addReport(r);</span>
            }

            // chameleon polarization field adds 6
<span class="nc bnc" id="L19278" title="All 2 branches missed.">            if (entity.isChameleonShieldOn()) {</span>
<span class="nc" id="L19279">                entity.heatBuildup += 6;</span>
<span class="nc" id="L19280">                r = new Report(5014);</span>
<span class="nc" id="L19281">                r.subject = entity.getId();</span>
<span class="nc" id="L19282">                addReport(r);</span>
            }

            // If a Mek is in extreme Temperatures, add or subtract one
            // heat per 10 degrees (or fraction of 10 degrees) above or
            // below 50 or -30 degrees Celsius
<span class="nc bnc" id="L19288" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getTemperatureDifference(50, -30) != 0</span>
<span class="nc bnc" id="L19289" title="All 2 branches missed.">                    &amp;&amp; !((Mech) entity).hasLaserHeatSinks()) {</span>
<span class="nc bnc" id="L19290" title="All 2 branches missed.">                if (game.getPlanetaryConditions().getTemperature() &gt; 50) {</span>
<span class="nc" id="L19291">                    int heatToAdd = game.getPlanetaryConditions()</span>
<span class="nc" id="L19292">                            .getTemperatureDifference(50, -30);</span>
<span class="nc bnc" id="L19293" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19294">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19296">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19297">                    r = new Report(5020);</span>
<span class="nc" id="L19298">                    r.subject = entity.getId();</span>
<span class="nc" id="L19299">                    r.add(heatToAdd);</span>
<span class="nc" id="L19300">                    addReport(r);</span>
<span class="nc bnc" id="L19301" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19302">                        r = new Report(5550);</span>
<span class="nc" id="L19303">                        addReport(r);</span>
                    }
<span class="nc" id="L19305">                } else {</span>
<span class="nc" id="L19306">                    entity.heatFromExternal -= game.getPlanetaryConditions()</span>
<span class="nc" id="L19307">                            .getTemperatureDifference(50, -30);</span>
<span class="nc" id="L19308">                    r = new Report(5025);</span>
<span class="nc" id="L19309">                    r.subject = entity.getId();</span>
<span class="nc" id="L19310">                    r.add(game.getPlanetaryConditions().getTemperatureDifference(50, -30));</span>
<span class="nc" id="L19311">                    addReport(r);</span>
                }
            }

            // Add +5 Heat if the hex you're in is on fire
            // and was on fire for the full round.
<span class="nc bnc" id="L19317" title="All 2 branches missed.">            if (entityHex != null) {</span>
<span class="nc bnc" id="L19318" title="All 4 branches missed.">                if (entityHex.containsTerrain(Terrains.FIRE) &amp;&amp; (entityHex.getFireTurn() &gt; 0)</span>
<span class="nc bnc" id="L19319" title="All 2 branches missed.">                        &amp;&amp; (entity.getElevation() &lt;= 1)) {</span>
<span class="nc" id="L19320">                    int heatToAdd = 5;</span>
<span class="nc bnc" id="L19321" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19322">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19324">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19325">                    r = new Report(5030);</span>
<span class="nc" id="L19326">                    r.add(heatToAdd);</span>
<span class="nc" id="L19327">                    r.subject = entity.getId();</span>
<span class="nc" id="L19328">                    addReport(r);</span>
<span class="nc bnc" id="L19329" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19330">                        r = new Report(5550);</span>
<span class="nc" id="L19331">                        addReport(r);</span>
                    }
                }
<span class="nc" id="L19334">                int magma = entityHex.terrainLevel(Terrains.MAGMA);</span>
<span class="nc bnc" id="L19335" title="All 4 branches missed.">                if ((magma &gt; 0) &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L19336">                    int heatToAdd = 5 * magma;</span>
<span class="nc bnc" id="L19337" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19338">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19340">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19341">                    r = new Report(5032);</span>
<span class="nc" id="L19342">                    r.subject = entity.getId();</span>
<span class="nc" id="L19343">                    r.add(heatToAdd);</span>
<span class="nc" id="L19344">                    addReport(r);</span>
<span class="nc bnc" id="L19345" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19346">                        r = new Report(5550);</span>
<span class="nc" id="L19347">                        addReport(r);</span>
                    }
                }
            }

            // Check the mech for vibroblades if so then check to see if any
            // are active and what heat they will produce.
<span class="nc bnc" id="L19354" title="All 2 branches missed.">            if (entity.hasVibroblades()) {</span>
                int vibroHeat;

<span class="nc" id="L19357">                vibroHeat = entity.getActiveVibrobladeHeat(Mech.LOC_RARM);</span>
<span class="nc" id="L19358">                vibroHeat += entity.getActiveVibrobladeHeat(Mech.LOC_LARM);</span>

<span class="nc bnc" id="L19360" title="All 2 branches missed.">                if (vibroHeat &gt; 0) {</span>
<span class="nc" id="L19361">                    r = new Report(5018);</span>
<span class="nc" id="L19362">                    r.subject = entity.getId();</span>
<span class="nc" id="L19363">                    r.add(vibroHeat);</span>
<span class="nc" id="L19364">                    addReport(r);</span>
<span class="nc" id="L19365">                    entity.heatBuildup += vibroHeat;</span>
                }
            }

<span class="nc" id="L19369">            int capHeat = 0;</span>
<span class="nc bnc" id="L19370" title="All 2 branches missed.">            for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19371" title="All 4 branches missed.">                if ((m.hasChargedOrChargingCapacitor() == 1) &amp;&amp; !m.isUsedThisRound()) {</span>
<span class="nc" id="L19372">                    capHeat += 5;</span>
                }
<span class="nc bnc" id="L19374" title="All 4 branches missed.">                if ((m.hasChargedOrChargingCapacitor() == 2) &amp;&amp; !m.isUsedThisRound()) {</span>
<span class="nc" id="L19375">                    capHeat += 10;</span>
                }
<span class="nc" id="L19377">            }</span>
<span class="nc bnc" id="L19378" title="All 2 branches missed.">            if (capHeat &gt; 0) {</span>
<span class="nc" id="L19379">                r = new Report(5019);</span>
<span class="nc" id="L19380">                r.subject = entity.getId();</span>
<span class="nc" id="L19381">                r.add(capHeat);</span>
<span class="nc" id="L19382">                addReport(r);</span>
<span class="nc" id="L19383">                entity.heatBuildup += capHeat;</span>
            }

            // Add heat from external sources to the heat buildup
<span class="nc" id="L19387">            int max_ext_heat = game.getOptions().intOption(OptionsConstants.ADVCOMBAT_MAX_EXTERNAL_HEAT);</span>
            // Check Game Options
<span class="nc bnc" id="L19389" title="All 2 branches missed.">            if (max_ext_heat &lt; 0) {</span>
<span class="nc" id="L19390">                max_ext_heat = 15; // standard value specified in TW p.159</span>
            }
<span class="nc" id="L19392">            entity.heatBuildup += Math.min(max_ext_heat, entity.heatFromExternal);</span>
<span class="nc" id="L19393">            entity.heatFromExternal = 0;</span>
            // remove heat we cooled down
<span class="nc" id="L19395">            entity.heatBuildup -= Math.min(9, entity.coolFromExternal);</span>
<span class="nc" id="L19396">            entity.coolFromExternal = 0;</span>

            // Combat computers help manage heat
<span class="nc bnc" id="L19399" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_COMBAT_COMPUTER)) {</span>
<span class="nc" id="L19400">                int reduce = Math.min(entity.heatBuildup, 4);</span>
<span class="nc" id="L19401">                r = new Report(5026);</span>
<span class="nc" id="L19402">                r.subject = entity.getId();</span>
<span class="nc" id="L19403">                r.add(reduce);</span>
<span class="nc" id="L19404">                addReport(r);</span>
<span class="nc" id="L19405">                entity.heatBuildup -= reduce;</span>
            }

<span class="nc bnc" id="L19408" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)</span>
<span class="nc bnc" id="L19409" title="All 2 branches missed.">                    &amp;&amp; ((Mech) entity).isCoolingFlawActive()) {</span>
<span class="nc" id="L19410">                int flaw = 5;</span>
<span class="nc" id="L19411">                r = new Report(5021);</span>
<span class="nc" id="L19412">                r.subject = entity.getId();</span>
<span class="nc" id="L19413">                r.add(flaw);</span>
<span class="nc" id="L19414">                addReport(r);</span>
<span class="nc" id="L19415">                entity.heatBuildup += flaw;</span>
            }
            // if heat build up is negative due to temperature, set it to 0
            // for prettier turn reports
<span class="nc bnc" id="L19419" title="All 2 branches missed.">            if (entity.heatBuildup &lt; 0) {</span>
<span class="nc" id="L19420">                entity.heatBuildup = 0;</span>
            }

            // add the heat we've built up so far.
<span class="nc" id="L19424">            entity.heat += entity.heatBuildup;</span>

            // how much heat can we sink?
<span class="nc" id="L19427">            int toSink = entity.getHeatCapacityWithWater() + radicalHSBonus;</span>

<span class="nc bnc" id="L19429" title="All 2 branches missed.">            if (entity.getCoolantFailureAmount() &gt; 0) {</span>
<span class="nc" id="L19430">                int failureAmount = entity.getCoolantFailureAmount();</span>
<span class="nc" id="L19431">                r = new Report(5520);</span>
<span class="nc" id="L19432">                r.subject = entity.getId();</span>
<span class="nc" id="L19433">                r.add(failureAmount);</span>
<span class="nc" id="L19434">                toSink -= failureAmount;</span>
            }

            // should we use a coolant pod?
<span class="nc bnc" id="L19438" title="All 2 branches missed.">            int safeHeat = entity.hasInfernoAmmo() ? 9 : 13;</span>
<span class="nc" id="L19439">            int possibleSinkage = ((Mech) entity).getNumberOfSinks() - entity.getCoolantFailureAmount();</span>
<span class="nc bnc" id="L19440" title="All 2 branches missed.">            for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19441" title="All 2 branches missed.">                if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L19442">                    AmmoType at = (AmmoType) m.getType();</span>
<span class="nc bnc" id="L19443" title="All 4 branches missed.">                    if ((at.getAmmoType() == AmmoType.T_COOLANT_POD) &amp;&amp; m.isAmmoUsable()) {</span>
<span class="nc" id="L19444">                        EquipmentMode mode = m.curMode();</span>
<span class="nc bnc" id="L19445" title="All 2 branches missed.">                        if (mode.equals(&quot;dump&quot;)) {</span>
<span class="nc" id="L19446">                            r = new Report(5260);</span>
<span class="nc" id="L19447">                            r.subject = entity.getId();</span>
<span class="nc" id="L19448">                            addReport(r);</span>
<span class="nc" id="L19449">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19450">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19451">                            break;</span>
                        }
<span class="nc bnc" id="L19453" title="All 4 branches missed.">                        if (mode.equals(&quot;safe&quot;) &amp;&amp; ((entity.heat - toSink) &gt; safeHeat)) {</span>
<span class="nc" id="L19454">                            r = new Report(5265);</span>
<span class="nc" id="L19455">                            r.subject = entity.getId();</span>
<span class="nc" id="L19456">                            addReport(r);</span>
<span class="nc" id="L19457">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19458">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19459">                            break;</span>
                        }
<span class="nc bnc" id="L19461" title="All 4 branches missed.">                        if (mode.equals(&quot;efficient&quot;) &amp;&amp; ((entity.heat - toSink) &gt;= possibleSinkage)) {</span>
<span class="nc" id="L19462">                            r = new Report(5270);</span>
<span class="nc" id="L19463">                            r.subject = entity.getId();</span>
<span class="nc" id="L19464">                            addReport(r);</span>
<span class="nc" id="L19465">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19466">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19467">                            break;</span>
                        }
                    }
                }
<span class="nc" id="L19471">            }</span>

<span class="nc" id="L19473">            toSink = Math.min(toSink, entity.heat);</span>
<span class="nc" id="L19474">            entity.heat -= toSink;</span>
<span class="nc" id="L19475">            r = new Report(5035);</span>
<span class="nc" id="L19476">            r.subject = entity.getId();</span>
<span class="nc" id="L19477">            r.addDesc(entity);</span>
<span class="nc" id="L19478">            r.add(entity.heatBuildup);</span>
<span class="nc" id="L19479">            r.add(toSink);</span>
<span class="nc" id="L19480">            r.add(entity.heat);</span>
<span class="nc" id="L19481">            addReport(r);</span>
<span class="nc" id="L19482">            entity.heatBuildup = 0;</span>
<span class="nc" id="L19483">            vPhaseReport.addAll(rhsReports);</span>

            // Does the unit have inferno ammo?
<span class="nc bnc" id="L19486" title="All 2 branches missed.">            if (entity.hasInfernoAmmo()) {</span>

                // Roll for possible inferno ammo explosion.
<span class="nc bnc" id="L19489" title="All 2 branches missed.">                if (entity.heat &gt;= 10) {</span>
<span class="nc bnc" id="L19490" title="All 4 branches missed.">                    int boom = (4 + (entity.heat &gt;= 14 ? 2 : 0) + (entity.heat &gt;= 19 ? 2 : 0)</span>
<span class="nc bnc" id="L19491" title="All 4 branches missed.">                                + (entity.heat &gt;= 23 ? 2 : 0) + (entity.heat &gt;= 28 ? 2 : 0))</span>
                               - hotDogMod;
<span class="nc" id="L19493">                    int boomRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L19494" title="All 2 branches missed.">                    if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19495">                        boomRoll += 2;</span>
                    }
<span class="nc" id="L19497">                    r = new Report(5040);</span>
<span class="nc" id="L19498">                    r.subject = entity.getId();</span>
<span class="nc" id="L19499">                    r.addDesc(entity);</span>
<span class="nc" id="L19500">                    r.add(boom);</span>
<span class="nc bnc" id="L19501" title="All 2 branches missed.">                    if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19502">                        r.add(boomRoll + &quot;(&quot; + (boomRoll - 2) + &quot;+2)&quot;);</span>
                    } else {
<span class="nc" id="L19504">                        r.add(boomRoll);</span>
                    }

<span class="nc bnc" id="L19507" title="All 2 branches missed.">                    if (boomRoll &gt;= boom) {</span>
                        // avoided
<span class="nc" id="L19509">                        r.choose(true);</span>
<span class="nc" id="L19510">                        addReport(r);</span>
                    } else {
<span class="nc" id="L19512">                        r.choose(false);</span>
<span class="nc" id="L19513">                        addReport(r);</span>
<span class="nc" id="L19514">                        addReport(explodeInfernoAmmoFromHeat(entity));</span>
                    }
                }
            } // End avoid-inferno-explosion
            int autoShutDownHeat;
            boolean mtHeat;

<span class="nc bnc" id="L19521" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HEAT)) {</span>
<span class="nc" id="L19522">                autoShutDownHeat = 50;</span>
<span class="nc" id="L19523">                mtHeat = true;</span>
            } else {
<span class="nc" id="L19525">                autoShutDownHeat = 30;</span>
<span class="nc" id="L19526">                mtHeat = false;</span>
            }
            // heat effects: start up
<span class="nc bnc" id="L19529" title="All 6 branches missed.">            if ((entity.heat &lt; autoShutDownHeat) &amp;&amp; entity.isShutDown() &amp;&amp; !entity.isStalled()) {</span>
<span class="nc bnc" id="L19530" title="All 2 branches missed.">                if ((entity.getTaserShutdownRounds() == 0)</span>
<span class="nc bnc" id="L19531" title="All 2 branches missed.">                       &amp;&amp; (entity.getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc bnc" id="L19532" title="All 4 branches missed.">                    if ((entity.heat &lt; 14) &amp;&amp; !(entity.isManualShutdown())) {</span>
                        // automatically starts up again
<span class="nc" id="L19534">                        entity.setShutDown(false);</span>
<span class="nc" id="L19535">                        r = new Report(5045);</span>
<span class="nc" id="L19536">                        r.subject = entity.getId();</span>
<span class="nc" id="L19537">                        r.addDesc(entity);</span>
<span class="nc" id="L19538">                        addReport(r);</span>
<span class="nc bnc" id="L19539" title="All 2 branches missed.">                    } else if (!(entity.isManualShutdown())) {</span>
                        // If the pilot is KO and we need to roll, auto-fail.
<span class="nc bnc" id="L19541" title="All 2 branches missed.">                        if (!entity.getCrew().isActive()) {</span>
<span class="nc" id="L19542">                            r = new Report(5049);</span>
<span class="nc" id="L19543">                            r.subject = entity.getId();</span>
<span class="nc" id="L19544">                            r.addDesc(entity);</span>
                        } else {
                            // roll for startup
<span class="nc" id="L19547">                            int startup = (4 + (((entity.heat - 14) / 4) * 2)) - hotDogMod;</span>
<span class="nc bnc" id="L19548" title="All 2 branches missed.">                            if (mtHeat) {</span>
<span class="nc" id="L19549">                                startup -= 5;</span>
<span class="nc bnc" id="L19550" title="All 4 branches missed.">                                switch (entity.getCrew().getPiloting()) {</span>
                                    case 0:
                                    case 1:
<span class="nc" id="L19553">                                        startup -= 2;</span>
<span class="nc" id="L19554">                                        break;</span>
                                    case 2:
                                    case 3:
<span class="nc" id="L19557">                                        startup -= 1;</span>
<span class="nc" id="L19558">                                        break;</span>
                                    case 6:
                                    case 7:
<span class="nc" id="L19561">                                        startup += 1;</span>
                                }
                            }
<span class="nc" id="L19564">                            int suRoll = Compute.d6(2);</span>
<span class="nc" id="L19565">                            r = new Report(5050);</span>
<span class="nc" id="L19566">                            r.subject = entity.getId();</span>
<span class="nc" id="L19567">                            r.addDesc(entity);</span>
<span class="nc" id="L19568">                            r.add(startup);</span>
<span class="nc" id="L19569">                            r.add(suRoll);</span>
<span class="nc bnc" id="L19570" title="All 2 branches missed.">                            if (suRoll &gt;= startup) {</span>
                                // start 'er back up
<span class="nc" id="L19572">                                entity.setShutDown(false);</span>
<span class="nc" id="L19573">                                r.choose(true);</span>
                            } else {
<span class="nc" id="L19575">                                r.choose(false);</span>
                            }
                        }
<span class="nc" id="L19578">                        addReport(r);</span>
                    }
                } else {
                    // if we're shutdown by a BA taser, we might activate
                    // again
<span class="nc bnc" id="L19583" title="All 2 branches missed.">                    if (entity.isBATaserShutdown()) {</span>
<span class="nc" id="L19584">                        int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L19585" title="All 2 branches missed.">                        if (roll &gt;= 7) {</span>
<span class="nc" id="L19586">                            entity.setTaserShutdownRounds(0);</span>
<span class="nc bnc" id="L19587" title="All 2 branches missed.">                            if (!(entity.isManualShutdown())) {</span>
<span class="nc" id="L19588">                                entity.setShutDown(false);</span>
                            }
<span class="nc" id="L19590">                            entity.setBATaserShutdown(false);</span>
                        }
<span class="nc" id="L19592">                    }</span>
                }
            }

            // heat effects: shutdown!
            // Don't shut down if you just restarted.
<span class="nc bnc" id="L19598" title="All 4 branches missed.">            else if ((entity.heat &gt;= 14) &amp;&amp; !entity.isShutDown()) {</span>
<span class="nc bnc" id="L19599" title="All 2 branches missed.">                if (entity.heat &gt;= autoShutDownHeat) {</span>
<span class="nc" id="L19600">                    r = new Report(5055);</span>
<span class="nc" id="L19601">                    r.subject = entity.getId();</span>
<span class="nc" id="L19602">                    r.addDesc(entity);</span>
<span class="nc" id="L19603">                    addReport(r);</span>
                    // add a piloting roll and resolve immediately
<span class="nc bnc" id="L19605" title="All 2 branches missed.">                    if (entity.canFall()) {</span>
<span class="nc" id="L19606">                        game.addPSR(new PilotingRollData(entity.getId(), 3, &quot;reactor shutdown&quot;));</span>
<span class="nc" id="L19607">                        addReport(resolvePilotingRolls());</span>
                    }
                    // okay, now mark shut down
<span class="nc" id="L19610">                    entity.setShutDown(true);</span>
                } else {
                    // Again, pilot KO means shutdown is automatic.
<span class="nc bnc" id="L19613" title="All 2 branches missed.">                    if (!entity.getCrew().isActive()) {</span>
<span class="nc" id="L19614">                        r = new Report(5056);</span>
<span class="nc" id="L19615">                        r.subject = entity.getId();</span>
<span class="nc" id="L19616">                        r.addDesc(entity);</span>
<span class="nc" id="L19617">                        addReport(r);</span>
<span class="nc" id="L19618">                        entity.setShutDown(true);</span>
                    } else {
<span class="nc" id="L19620">                        int shutdown = (4 + (((entity.heat - 14) / 4) * 2)) - hotDogMod;</span>
<span class="nc bnc" id="L19621" title="All 2 branches missed.">                        if (mtHeat) {</span>
<span class="nc" id="L19622">                            shutdown -= 5;</span>
<span class="nc bnc" id="L19623" title="All 4 branches missed.">                            switch (entity.getCrew().getPiloting()) {</span>
                                case 0:
                                case 1:
<span class="nc" id="L19626">                                    shutdown -= 2;</span>
<span class="nc" id="L19627">                                    break;</span>
                                case 2:
                                case 3:
<span class="nc" id="L19630">                                    shutdown -= 1;</span>
<span class="nc" id="L19631">                                    break;</span>
                                case 6:
                                case 7:
<span class="nc" id="L19634">                                    shutdown += 1;</span>
                            }
                        }
<span class="nc" id="L19637">                        int shutdownRoll = Compute.d6(2);</span>
<span class="nc" id="L19638">                        r = new Report(5060);</span>
<span class="nc" id="L19639">                        r.subject = entity.getId();</span>
<span class="nc" id="L19640">                        r.addDesc(entity);</span>
<span class="nc" id="L19641">                        r.add(shutdown);</span>
<span class="nc bnc" id="L19642" title="All 2 branches missed.">                        if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19643">                            r.add((shutdownRoll + 2) + &quot; (&quot; + shutdownRoll + &quot;+2)&quot;);</span>
<span class="nc" id="L19644">                            shutdownRoll += 2;</span>
                        } else {
<span class="nc" id="L19646">                            r.add(shutdownRoll);</span>
                        }
<span class="nc bnc" id="L19648" title="All 2 branches missed.">                        if (shutdownRoll &gt;= shutdown) {</span>
                            // avoided
<span class="nc" id="L19650">                            r.choose(true);</span>
<span class="nc" id="L19651">                            addReport(r);</span>
                        } else {
                            // shutting down...
<span class="nc" id="L19654">                            r.choose(false);</span>
<span class="nc" id="L19655">                            addReport(r);</span>
                            // add a piloting roll and resolve immediately
<span class="nc bnc" id="L19657" title="All 2 branches missed.">                            if (entity.canFall()) {</span>
<span class="nc" id="L19658">                                game.addPSR(new PilotingRollData(entity.getId(), 3, &quot;reactor shutdown&quot;));</span>
<span class="nc" id="L19659">                                addReport(resolvePilotingRolls());</span>
                            }
                            // okay, now mark shut down
<span class="nc" id="L19662">                            entity.setShutDown(true);</span>
                        }
                    }
                }
            }

            // LAMs in fighter mode need to check for random movement due to heat
<span class="nc" id="L19669">            checkRandomAeroMovement(entity, hotDogMod);</span>

            // heat effects: ammo explosion!
<span class="nc bnc" id="L19672" title="All 2 branches missed.">            if (entity.heat &gt;= 19) {</span>
<span class="nc bnc" id="L19673" title="All 4 branches missed.">                int boom = (4 + (entity.heat &gt;= 23 ? 2 : 0) + (entity.heat &gt;= 28 ? 2 : 0))</span>
                           - hotDogMod;
<span class="nc bnc" id="L19675" title="All 2 branches missed.">                if (mtHeat) {</span>
<span class="nc bnc" id="L19676" title="All 2 branches missed.">                    boom += (entity.heat &gt;= 35 ? 2 : 0)</span>
<span class="nc bnc" id="L19677" title="All 2 branches missed.">                            + (entity.heat &gt;= 40 ? 2 : 0)</span>
<span class="nc bnc" id="L19678" title="All 2 branches missed.">                            + (entity.heat &gt;= 45 ? 2 : 0);</span>
                    // Last line is a crutch; 45 heat should be no roll
                    // but automatic explosion.
                }
<span class="nc bnc" id="L19682" title="All 2 branches missed.">                if (((Mech) entity).hasLaserHeatSinks()) {</span>
<span class="nc" id="L19683">                    boom--;</span>
                }
<span class="nc" id="L19685">                int boomRoll = Compute.d6(2);</span>
<span class="nc" id="L19686">                r = new Report(5065);</span>
<span class="nc" id="L19687">                r.subject = entity.getId();</span>
<span class="nc" id="L19688">                r.addDesc(entity);</span>
<span class="nc" id="L19689">                r.add(boom);</span>
<span class="nc bnc" id="L19690" title="All 2 branches missed.">                if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19691">                    r.add((boomRoll + 2) + &quot; (&quot; + boomRoll + &quot;+2)&quot;);</span>
<span class="nc" id="L19692">                    boomRoll += 2;</span>
                } else {
<span class="nc" id="L19694">                    r.add(boomRoll);</span>
                }
<span class="nc bnc" id="L19696" title="All 2 branches missed.">                if (boomRoll &gt;= boom) {</span>
                    // mech is ok
<span class="nc" id="L19698">                    r.choose(true);</span>
<span class="nc" id="L19699">                    addReport(r);</span>
                } else {
                    // boom!
<span class="nc" id="L19702">                    r.choose(false);</span>
<span class="nc" id="L19703">                    addReport(r);</span>
<span class="nc" id="L19704">                    addReport(explodeAmmoFromHeat(entity));</span>
                }
            }

            // heat effects: mechwarrior damage
            // N.B. The pilot may already be dead.
            int lifeSupportCritCount;
<span class="nc bnc" id="L19711" title="All 2 branches missed.">            boolean torsoMountedCockpit = ((Mech) entity).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED;</span>
<span class="nc bnc" id="L19712" title="All 2 branches missed.">            if (torsoMountedCockpit) {</span>
<span class="nc" id="L19713">                lifeSupportCritCount = entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_RT);
<span class="nc" id="L19715">                lifeSupportCritCount += entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_LT);
            } else {
<span class="nc" id="L19718">                lifeSupportCritCount = entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_HEAD);
            }
<span class="nc" id="L19721">            int damageHeat = entity.heat;</span>
<span class="nc bnc" id="L19722" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_IMP_LIFE_SUPPORT)) {</span>
<span class="nc" id="L19723">                damageHeat -= 5;</span>
            }
<span class="nc bnc" id="L19725" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_POOR_LIFE_SUPPORT)) {</span>
<span class="nc" id="L19726">                damageHeat += 5;</span>
            }
<span class="nc bnc" id="L19728" title="All 8 branches missed.">            if ((lifeSupportCritCount &gt; 0)</span>
                    &amp;&amp; ((damageHeat &gt;= 15) || (torsoMountedCockpit &amp;&amp; (damageHeat &gt; 0)))
<span class="nc bnc" id="L19730" title="All 4 branches missed.">                    &amp;&amp; !entity.getCrew().isDead() &amp;&amp; !entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19731" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isEjected()) {</span>
<span class="nc" id="L19732">                int heatLimitDesc = 1;</span>
<span class="nc" id="L19733">                int damageToCrew = 0;</span>
<span class="nc bnc" id="L19734" title="All 4 branches missed.">                if ((damageHeat &gt;= 47) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 5 damage
<span class="nc" id="L19736">                    heatLimitDesc = 47;</span>
<span class="nc" id="L19737">                    damageToCrew = 5;</span>
<span class="nc bnc" id="L19738" title="All 4 branches missed.">                } else if ((damageHeat &gt;= 39) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 4 damage
<span class="nc" id="L19740">                    heatLimitDesc = 39;</span>
<span class="nc" id="L19741">                    damageToCrew = 4;</span>
<span class="nc bnc" id="L19742" title="All 4 branches missed.">                } else if ((damageHeat &gt;= 32) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 3 damage
<span class="nc" id="L19744">                    heatLimitDesc = 32;</span>
<span class="nc" id="L19745">                    damageToCrew = 3;</span>
<span class="nc bnc" id="L19746" title="All 2 branches missed.">                } else if (damageHeat &gt;= 25) {</span>
                    // mechwarrior takes 2 damage
<span class="nc" id="L19748">                    heatLimitDesc = 25;</span>
<span class="nc" id="L19749">                    damageToCrew = 2;</span>
<span class="nc bnc" id="L19750" title="All 2 branches missed.">                } else if (damageHeat &gt;= 15) {</span>
                    // mechwarrior takes 1 damage
<span class="nc" id="L19752">                    heatLimitDesc = 15;</span>
<span class="nc" id="L19753">                    damageToCrew = 1;</span>
                }
<span class="nc bnc" id="L19755" title="All 2 branches missed.">                if ((((Mech) entity).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L19756" title="All 2 branches missed.">                        &amp;&amp; !entity.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L19757">                    damageToCrew += 1;</span>
                }
<span class="nc" id="L19759">                r = new Report(5070);</span>
<span class="nc" id="L19760">                r.subject = entity.getId();</span>
<span class="nc" id="L19761">                r.addDesc(entity);</span>
<span class="nc" id="L19762">                r.add(heatLimitDesc);</span>
<span class="nc" id="L19763">                r.add(damageToCrew);</span>
<span class="nc" id="L19764">                addReport(r);</span>
<span class="nc" id="L19765">                addReport(damageCrew(entity, damageToCrew));</span>
<span class="nc bnc" id="L19766" title="All 6 branches missed.">            } else if (mtHeat &amp;&amp; (entity.heat &gt;= 32) &amp;&amp; !entity.getCrew().isDead()</span>
<span class="nc bnc" id="L19767" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19768" title="All 2 branches missed.">                    &amp;&amp; !entity.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
                // Crew may take damage from heat if MaxTech option is set
<span class="nc" id="L19770">                int heatRoll = Compute.d6(2);</span>
                int avoidNumber;
<span class="nc bnc" id="L19772" title="All 2 branches missed.">                if (entity.heat &gt;= 47) {</span>
<span class="nc" id="L19773">                    avoidNumber = 12;</span>
<span class="nc bnc" id="L19774" title="All 2 branches missed.">                } else if (entity.heat &gt;= 39) {</span>
<span class="nc" id="L19775">                    avoidNumber = 10;</span>
                } else {
<span class="nc" id="L19777">                    avoidNumber = 8;</span>
                }
<span class="nc" id="L19779">                avoidNumber -= hotDogMod;</span>
<span class="nc" id="L19780">                r = new Report(5075);</span>
<span class="nc" id="L19781">                r.subject = entity.getId();</span>
<span class="nc" id="L19782">                r.addDesc(entity);</span>
<span class="nc" id="L19783">                r.add(avoidNumber);</span>
<span class="nc" id="L19784">                r.add(heatRoll);</span>
<span class="nc bnc" id="L19785" title="All 2 branches missed.">                if (heatRoll &gt;= avoidNumber) {</span>
                    // damage avoided
<span class="nc" id="L19787">                    r.choose(true);</span>
<span class="nc" id="L19788">                    addReport(r);</span>
                } else {
<span class="nc" id="L19790">                    r.choose(false);</span>
<span class="nc" id="L19791">                    addReport(r);</span>
<span class="nc" id="L19792">                    addReport(damageCrew(entity, 1));</span>
                }
            }

            // The pilot may have just expired.
<span class="nc bnc" id="L19797" title="All 4 branches missed.">            if ((entity.getCrew().isDead() || entity.getCrew().isDoomed())</span>
<span class="nc bnc" id="L19798" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isEjected()) {</span>
<span class="nc" id="L19799">                r = new Report(5080);</span>
<span class="nc" id="L19800">                r.subject = entity.getId();</span>
<span class="nc" id="L19801">                r.addDesc(entity);</span>
<span class="nc" id="L19802">                addReport(r);</span>
<span class="nc" id="L19803">                addReport(destroyEntity(entity, &quot;crew death&quot;, true));</span>
            }

            // With MaxTech Heat Scale, there may occur critical damage
<span class="nc bnc" id="L19807" title="All 2 branches missed.">            if (mtHeat) {</span>
<span class="nc bnc" id="L19808" title="All 2 branches missed.">                if (entity.heat &gt;= 36) {</span>
<span class="nc" id="L19809">                    int damageRoll = Compute.d6(2);</span>
                    int damageNumber;
<span class="nc bnc" id="L19811" title="All 2 branches missed.">                    if (entity.heat &gt;= 44) {</span>
<span class="nc" id="L19812">                        damageNumber = 10;</span>
                    } else {
<span class="nc" id="L19814">                        damageNumber = 8;</span>
                    }
<span class="nc" id="L19816">                    damageNumber -= hotDogMod;</span>
<span class="nc" id="L19817">                    r = new Report(5085);</span>
<span class="nc" id="L19818">                    r.subject = entity.getId();</span>
<span class="nc" id="L19819">                    r.addDesc(entity);</span>
<span class="nc" id="L19820">                    r.add(damageNumber);</span>
<span class="nc" id="L19821">                    r.add(damageRoll);</span>
<span class="nc" id="L19822">                    r.newlines = 0;</span>
<span class="nc bnc" id="L19823" title="All 2 branches missed.">                    if (damageRoll &gt;= damageNumber) {</span>
<span class="nc" id="L19824">                        r.choose(true);</span>
                    } else {
<span class="nc" id="L19826">                        r.choose(false);</span>
<span class="nc" id="L19827">                        addReport(r);</span>
<span class="nc" id="L19828">                        addReport(oneCriticalEntity(entity, Compute.randomInt(8), false, 0));</span>
                        // add an empty report, for line breaking
<span class="nc" id="L19830">                        r = new Report(1210, Report.PUBLIC);</span>
                    }
<span class="nc" id="L19832">                    addReport(r);</span>
                }
            }

<span class="nc bnc" id="L19836" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_COOLANT_FAILURE)</span>
<span class="nc bnc" id="L19837" title="All 4 branches missed.">                    &amp;&amp; (entity.getHeatCapacity() &gt; entity.getCoolantFailureAmount())</span>
                    &amp;&amp; (entity.heat &gt;= 5)) {
<span class="nc" id="L19839">                int roll = Compute.d6(2);</span>
<span class="nc" id="L19840">                int hitNumber = 10;</span>

<span class="nc" id="L19842">                hitNumber -= Math.max(0, (int) Math.ceil(entity.heat / 5.0) - 2);</span>

<span class="nc" id="L19844">                r = new Report(5525);</span>
<span class="nc" id="L19845">                r.subject = entity.getId();</span>
<span class="nc" id="L19846">                r.add(entity.getShortName());</span>
<span class="nc" id="L19847">                r.add(hitNumber);</span>
<span class="nc" id="L19848">                r.add(roll);</span>
<span class="nc" id="L19849">                r.newlines = 0;</span>
<span class="nc" id="L19850">                addReport(r);</span>
<span class="nc bnc" id="L19851" title="All 2 branches missed.">                if (roll &gt;= hitNumber) {</span>
<span class="nc" id="L19852">                    r = new Report(5052);</span>
<span class="nc" id="L19853">                    r.subject = entity.getId();</span>
<span class="nc" id="L19854">                    addReport(r);</span>
<span class="nc" id="L19855">                    r = new Report(5526);</span>
<span class="nc" id="L19856">                    r.subject = entity.getId();</span>
<span class="nc" id="L19857">                    r.add(entity.getShortNameRaw());</span>
<span class="nc" id="L19858">                    addReport(r);</span>
<span class="nc" id="L19859">                    entity.addCoolantFailureAmount(1);</span>
                } else {
<span class="nc" id="L19861">                    r = new Report(5041);</span>
<span class="nc" id="L19862">                    r.subject = entity.getId();</span>
<span class="nc" id="L19863">                    addReport(r);</span>
                }
            }
<span class="nc" id="L19866">        }</span>

<span class="nc bnc" id="L19868" title="All 2 branches missed.">        if (vPhaseReport.size() == 1) {</span>
            // I guess nothing happened...
<span class="nc" id="L19870">            addReport(new Report(1205, Report.PUBLIC));</span>
        }
<span class="nc" id="L19872">    }</span>

    void checkRandomAeroMovement(Entity entity, int hotDogMod) {
<span class="nc bnc" id="L19875" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L19876">            return;</span>
        }
<span class="nc" id="L19878">        IAero a = (IAero) entity;</span>
        // heat effects: control effects (must make it unless already random moving)
<span class="nc bnc" id="L19880" title="All 4 branches missed.">        if ((entity.heat &gt;= 5) &amp;&amp; !a.isRandomMove()) {</span>
<span class="nc bnc" id="L19881" title="All 4 branches missed.">            int controlAvoid = (5 + (entity.heat &gt;= 10 ? 1 : 0) + (entity.heat &gt;= 15 ? 1 : 0)</span>
<span class="nc bnc" id="L19882" title="All 4 branches missed.">                    + (entity.heat &gt;= 20 ? 1 : 0) + (entity.heat &gt;= 25 ? 2 : 0)) - hotDogMod;</span>
<span class="nc" id="L19883">            int controlRoll = Compute.d6(2);</span>
<span class="nc" id="L19884">            Report r = new Report(9210);</span>
<span class="nc" id="L19885">            r.subject = entity.getId();</span>
<span class="nc" id="L19886">            r.addDesc(entity);</span>
<span class="nc" id="L19887">            r.add(controlAvoid);</span>
<span class="nc" id="L19888">            r.add(controlRoll);</span>
<span class="nc bnc" id="L19889" title="All 2 branches missed.">            if (controlRoll &gt;= controlAvoid) {</span>
                // in control
<span class="nc" id="L19891">                r.choose(true);</span>
<span class="nc" id="L19892">                addReport(r);</span>
            } else {
                // out of control
<span class="nc" id="L19895">                r.choose(false);</span>
<span class="nc" id="L19896">                addReport(r);</span>
                // if not already out of control, this may lead to
                // elevation decline
<span class="nc bnc" id="L19899" title="All 4 branches missed.">                if (!a.isOutControl() &amp;&amp; !a.isSpaceborne()</span>
<span class="nc bnc" id="L19900" title="All 2 branches missed.">                    &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L19901">                    int loss = Compute.d6(1);</span>
<span class="nc" id="L19902">                    r = new Report(9366);</span>
<span class="nc" id="L19903">                    r.newlines = 0;</span>
<span class="nc" id="L19904">                    r.subject = entity.getId();</span>
<span class="nc" id="L19905">                    r.addDesc(entity);</span>
<span class="nc" id="L19906">                    r.add(loss);</span>
<span class="nc" id="L19907">                    addReport(r);</span>
<span class="nc" id="L19908">                    entity.setAltitude(entity.getAltitude() - loss);</span>
                    // check for crash
<span class="nc bnc" id="L19910" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L19911">                        addReport(processCrash(entity, a.getCurrentVelocity(), entity.getPosition()));</span>
                    }
                }
                // force unit out of control through heat
<span class="nc" id="L19915">                a.setOutCtrlHeat(true);</span>
<span class="nc" id="L19916">                a.setRandomMove(true);</span>
            }
        }
<span class="nc" id="L19919">    }</span>

    private void resolveEmergencyCoolantSystem() {
<span class="nc bnc" id="L19922" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L19923" title="All 6 branches missed.">            if ((e instanceof Mech) &amp;&amp; e.hasWorkingMisc(MiscType.F_EMERGENCY_COOLANT_SYSTEM)</span>
                    &amp;&amp; (e.heat &gt; 13)) {
<span class="nc" id="L19925">                Mech mech = (Mech)e;</span>
<span class="nc" id="L19926">                Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L19927">                HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; crits = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L19928" title="All 2 branches missed.">                if (!(mech.doRISCEmergencyCoolantCheckFor(vDesc, crits))) {</span>
<span class="nc" id="L19929">                    mech.heat -= 6 + mech.getCoolantSystemMOS();</span>
<span class="nc" id="L19930">                    Report r = new Report(5027);</span>
<span class="nc" id="L19931">                    r.add(6+mech.getCoolantSystemMOS());</span>
<span class="nc" id="L19932">                    vDesc.add(r);</span>
                }
<span class="nc" id="L19934">                addReport(vDesc);</span>
<span class="nc bnc" id="L19935" title="All 2 branches missed.">                for (Integer loc : crits.keySet()) {</span>
<span class="nc" id="L19936">                    List&lt;CriticalSlot&gt; lcs = crits.get(loc);</span>
<span class="nc bnc" id="L19937" title="All 2 branches missed.">                    for (CriticalSlot cs : lcs) {</span>
<span class="nc" id="L19938">                        addReport(applyCriticalHit(mech, loc, cs, true, 0, false));</span>
<span class="nc" id="L19939">                    }</span>
<span class="nc" id="L19940">                }</span>
            }
<span class="nc" id="L19942">        }</span>
<span class="nc" id="L19943">    }</span>

    /*
     * Resolve HarJel II/III repairs for Mechs so equipped.
     */
    private void resolveHarJelRepairs() {
        Report r;
<span class="nc bnc" id="L19950" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L19951">            Entity entity = i.next();</span>
<span class="nc bnc" id="L19952" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L19953">                continue;</span>
            }

<span class="nc" id="L19956">            Mech me = (Mech) entity;</span>
<span class="nc bnc" id="L19957" title="All 2 branches missed.">            for (int loc = 0; loc &lt; me.locations(); ++loc) {</span>
<span class="nc" id="L19958">                boolean harJelII = me.hasHarJelIIIn(loc); // false implies HarJel III</span>
<span class="nc bnc" id="L19959" title="All 4 branches missed.">                if ((harJelII || me.hasHarJelIIIIn(loc))</span>
<span class="nc bnc" id="L19960" title="All 2 branches missed.">                    &amp;&amp; me.isArmorDamagedThisTurn(loc)) {</span>
<span class="nc bnc" id="L19961" title="All 2 branches missed.">                    if (me.hasRearArmor(loc)) {</span>
                        // must have at least one remaining armor in location
<span class="nc bnc" id="L19963" title="All 4 branches missed.">                        if (!((me.getArmor(loc) &gt; 0) || (me.getArmor(loc, true) &gt; 0))) {</span>
<span class="nc" id="L19964">                            continue;</span>
                        }

<span class="nc bnc" id="L19967" title="All 2 branches missed.">                        int toRepair = harJelII ? 2 : 4;</span>
                        int frontRepair, rearRepair;
                        int desiredFrontRepair, desiredRearRepair;

<span class="nc" id="L19971">                        Mounted harJel = null;</span>
                        // find HarJel item
                        // don't need to check ready or worry about null,
                        // we already know there is one, it's ready,
                        // and there can be at most one in a given location
<span class="nc bnc" id="L19976" title="All 2 branches missed.">                        for (Mounted m: me.getMisc()) {</span>
<span class="nc bnc" id="L19977" title="All 2 branches missed.">                            if ((m.getLocation() == loc)</span>
<span class="nc bnc" id="L19978" title="All 2 branches missed.">                                &amp;&amp; (m.getType().hasFlag(MiscType.F_HARJEL_II)</span>
<span class="nc bnc" id="L19979" title="All 2 branches missed.">                                    || m.getType().hasFlag(MiscType.F_HARJEL_III))) {</span>
<span class="nc" id="L19980">                                harJel = m;</span>
                            }
<span class="nc" id="L19982">                        }</span>

<span class="nc bnc" id="L19984" title="All 2 branches missed.">                        if (harJelII) {</span>
<span class="nc bnc" id="L19985" title="All 2 branches missed.">                            if (harJel.curMode().equals(MiscType.S_HARJEL_II_1F1R)) {</span>
<span class="nc" id="L19986">                                desiredFrontRepair = 1;</span>
<span class="nc bnc" id="L19987" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_II_2F0R)) {</span>
<span class="nc" id="L19988">                                desiredFrontRepair = 2;</span>
                            } else { // 0F2R
<span class="nc" id="L19990">                                desiredFrontRepair = 0;</span>
                            }
                        } else { // HarJel III
<span class="nc bnc" id="L19993" title="All 2 branches missed.">                            if (harJel.curMode().equals(MiscType.S_HARJEL_III_2F2R)) {</span>
<span class="nc" id="L19994">                                desiredFrontRepair = 2;</span>
<span class="nc bnc" id="L19995" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_4F0R)) {</span>
<span class="nc" id="L19996">                                desiredFrontRepair = 4;</span>
<span class="nc bnc" id="L19997" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_3F1R)) {</span>
<span class="nc" id="L19998">                                desiredFrontRepair = 3;</span>
<span class="nc bnc" id="L19999" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_1F3R)) {</span>
<span class="nc" id="L20000">                                desiredFrontRepair = 1;</span>
                            } else { // 0F4R
<span class="nc" id="L20002">                                desiredFrontRepair = 0;</span>
                            }
                        }
<span class="nc" id="L20005">                        desiredRearRepair = toRepair - desiredFrontRepair;</span>

<span class="nc" id="L20007">                        int availableFrontRepair = me.getOArmor(loc) - me.getArmor(loc);</span>
<span class="nc" id="L20008">                        int availableRearRepair = me.getOArmor(loc, true) - me.getArmor(loc, true);</span>
<span class="nc" id="L20009">                        frontRepair = Math.min(availableFrontRepair, desiredFrontRepair);</span>
<span class="nc" id="L20010">                        rearRepair = Math.min(availableRearRepair, desiredRearRepair);</span>
<span class="nc" id="L20011">                        int surplus = desiredFrontRepair - frontRepair;</span>
<span class="nc bnc" id="L20012" title="All 2 branches missed.">                        if (surplus &gt; 0) { // we couldn't use all the points we wanted in front</span>
<span class="nc" id="L20013">                            rearRepair = Math.min(availableRearRepair, rearRepair + surplus);</span>
                        } else {
<span class="nc" id="L20015">                            surplus = desiredRearRepair - rearRepair;</span>
                            // try to move any excess points from rear to front
<span class="nc" id="L20017">                            frontRepair = Math.min(availableFrontRepair, frontRepair + surplus);</span>
                        }

<span class="nc bnc" id="L20020" title="All 2 branches missed.">                        if (frontRepair &gt; 0) {</span>
<span class="nc" id="L20021">                            me.setArmor(me.getArmor(loc) + frontRepair, loc);</span>
<span class="nc bnc" id="L20022" title="All 2 branches missed.">                            r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20023">                            r.subject = me.getId();</span>
<span class="nc" id="L20024">                            r.addDesc(entity);</span>
<span class="nc" id="L20025">                            r.add(frontRepair);</span>
<span class="nc" id="L20026">                            r.add(me.getLocationAbbr(loc));</span>
<span class="nc" id="L20027">                            addReport(r);</span>
                        }
<span class="nc bnc" id="L20029" title="All 2 branches missed.">                        if (rearRepair &gt; 0) {</span>
<span class="nc" id="L20030">                            me.setArmor(me.getArmor(loc, true) + rearRepair, loc, true);</span>
<span class="nc bnc" id="L20031" title="All 2 branches missed.">                            r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20032">                            r.subject = me.getId();</span>
<span class="nc" id="L20033">                            r.addDesc(entity);</span>
<span class="nc" id="L20034">                            r.add(rearRepair);</span>
<span class="nc" id="L20035">                            r.add(me.getLocationAbbr(loc) + &quot; (R)&quot;);</span>
<span class="nc" id="L20036">                            addReport(r);</span>
                        }
<span class="nc" id="L20038">                    } else {</span>
                        // must have at least one remaining armor in location
<span class="nc bnc" id="L20040" title="All 2 branches missed.">                        if (!(me.getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L20041">                            continue;</span>
                        }
<span class="nc bnc" id="L20043" title="All 2 branches missed.">                        int toRepair = harJelII ? 2 : 4;</span>
<span class="nc" id="L20044">                        toRepair = Math.min(toRepair, me.getOArmor(loc) - me.getArmor(loc));</span>
<span class="nc" id="L20045">                        me.setArmor(me.getArmor(loc) + toRepair, loc);</span>
<span class="nc bnc" id="L20046" title="All 2 branches missed.">                        r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20047">                        r.subject = me.getId();</span>
<span class="nc" id="L20048">                        r.addDesc(entity);</span>
<span class="nc" id="L20049">                        r.add(toRepair);</span>
<span class="nc" id="L20050">                        r.add(me.getLocationAbbr(loc));</span>
<span class="nc" id="L20051">                        addReport(r);</span>
                    }
                }
            }
<span class="nc" id="L20055">        }</span>
<span class="nc" id="L20056">    }</span>

    /**
     * Resolve Flaming Damage for the given Entity Taharqa: This is now updated
     * to TacOps rules which is much more lenient So I have change the name to
     * Flaming Damage rather than flaming death
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that may experience flaming damage.
     */
    private void doFlamingDamage(Entity entity) {
        Report r;
<span class="nc" id="L20067">        int boomRoll = Compute.d6(2);</span>

<span class="nc bnc" id="L20069" title="All 2 branches missed.">        if ((entity.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L20070" title="All 2 branches missed.">                &amp;&amp; !entity.infernos.isStillBurning()) {</span>
            // VTOLs don't check as long as they are flying higher than
            // the burning terrain. TODO : Check for rules conformity (ATPM?)
            // according to maxtech, elevation 0 or 1 should be affected,
            // this makes sense for level 2 as well

<span class="nc bnc" id="L20076" title="All 2 branches missed.">            if (entity.getElevation() &gt; 1) {</span>
<span class="nc" id="L20077">                return;</span>
            }
        }
        // Battle Armor squads equipped with fire protection
        // gear automatically avoid flaming damage
        // TODO : can conventional infantry mount fire-resistant armor?
<span class="nc bnc" id="L20083" title="All 2 branches missed.">        if ((entity instanceof BattleArmor)</span>
<span class="nc bnc" id="L20084" title="All 2 branches missed.">            &amp;&amp; ((BattleArmor) entity).isFireResistant()) {</span>
<span class="nc" id="L20085">            r = new Report(5095);</span>
<span class="nc" id="L20086">            r.subject = entity.getId();</span>
<span class="nc" id="L20087">            r.indent(1);</span>
<span class="nc" id="L20088">            r.addDesc(entity);</span>
<span class="nc" id="L20089">            addReport(r);</span>
<span class="nc" id="L20090">            return;</span>
        }

        // mechs shouldn't be here, but just in case
<span class="nc bnc" id="L20094" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L20095">            return;</span>
        }

        // fire has no effect on dropships
<span class="nc bnc" id="L20099" title="All 2 branches missed.">        if (entity instanceof Dropship) {</span>
<span class="nc" id="L20100">            return;</span>
        }

        // Must roll 8+ to survive...
<span class="nc" id="L20104">        r = new Report(5100);</span>
<span class="nc" id="L20105">        r.subject = entity.getId();</span>
<span class="nc" id="L20106">        r.newlines = 0;</span>
<span class="nc" id="L20107">        r.addDesc(entity);</span>
<span class="nc" id="L20108">        r.add(boomRoll);</span>
<span class="nc bnc" id="L20109" title="All 2 branches missed.">        if (boomRoll &gt;= 8) {</span>
            // phew!
<span class="nc" id="L20111">            r.choose(true);</span>
<span class="nc" id="L20112">            addReport(r);</span>
<span class="nc" id="L20113">            Report.addNewline(vPhaseReport);</span>
        } else {
            // eek
<span class="nc" id="L20116">            r.choose(false);</span>
<span class="nc" id="L20117">            r.newlines = 1;</span>
<span class="nc" id="L20118">            addReport(r);</span>
            // gun emplacements have their own critical rules
<span class="nc bnc" id="L20120" title="All 2 branches missed.">            if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L20121">                Vector&lt;GunEmplacement&gt; gun = new Vector&lt;&gt;();</span>
<span class="nc" id="L20122">                gun.add((GunEmplacement) entity);</span>
                
<span class="nc" id="L20124">                Building building = getGame().getBoard().getBuildingAt(entity.getPosition());</span>
                
<span class="nc" id="L20126">                Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L20127">                addReport(criticalGunEmplacement(gun, building, entity.getPosition()));            </span>
            // Taharqa: TacOps rules, protos and vees no longer die instantly
            // (hurray!)
<span class="nc bnc" id="L20130" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
<span class="nc" id="L20131">                int bonus = -2;</span>
<span class="nc bnc" id="L20132" title="All 4 branches missed.">                if ((entity instanceof SupportTank)</span>
                    || (entity instanceof SupportVTOL)) {
<span class="nc" id="L20134">                    bonus = 0;</span>
                }
                // roll a critical hit
<span class="nc" id="L20137">                Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L20138">                addReport(criticalTank((Tank) entity, Tank.LOC_FRONT, bonus, 0, true));</span>
<span class="nc bnc" id="L20139" title="All 2 branches missed.">            } else if (entity instanceof Protomech) {</span>
                // this code is taken from inferno hits
<span class="nc" id="L20141">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L20142" title="All 2 branches missed.">                if (hit.getLocation() == Protomech.LOC_NMISS) {</span>
<span class="nc" id="L20143">                    Protomech proto = (Protomech) entity;</span>
<span class="nc" id="L20144">                    r = new Report(6035);</span>
<span class="nc" id="L20145">                    r.subject = entity.getId();</span>
<span class="nc" id="L20146">                    r.indent(2);</span>
<span class="nc bnc" id="L20147" title="All 2 branches missed.">                    if (proto.isGlider()) {</span>
<span class="nc" id="L20148">                        r.messageId = 6036;</span>
<span class="nc" id="L20149">                        proto.setWingHits(proto.getWingHits() + 1);</span>
                    }
<span class="nc" id="L20151">                    addReport(r);</span>
<span class="nc" id="L20152">                } else {</span>
<span class="nc" id="L20153">                    r = new Report(6690);</span>
<span class="nc" id="L20154">                    r.subject = entity.getId();</span>
<span class="nc" id="L20155">                    r.indent(1);</span>
<span class="nc" id="L20156">                    r.add(entity.getLocationName(hit));</span>
<span class="nc" id="L20157">                    addReport(r);</span>
<span class="nc" id="L20158">                    entity.destroyLocation(hit.getLocation());</span>
                    // Handle ProtoMech pilot damage due to location destruction
<span class="nc" id="L20160">                    int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L20161">                               - ((Protomech) entity).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L20162" title="All 2 branches missed.">                    if (hits &gt; 0) {</span>
<span class="nc" id="L20163">                        addReport(damageCrew(entity, hits));</span>
<span class="nc" id="L20164">                        ((Protomech) entity).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L20165">                                Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                    }
<span class="nc bnc" id="L20167" title="All 2 branches missed.">                    if (entity.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L20168">                        addReport(destroyEntity(entity, &quot;flaming death&quot;, false, true));</span>
<span class="nc" id="L20169">                        Report.addNewline(vPhaseReport);</span>
                    }
                }
<span class="nc" id="L20172">            } else {</span>
                // sucks to be you
<span class="nc" id="L20174">                addReport(destroyEntity(entity, &quot;fire&quot;, false, false));</span>
<span class="nc" id="L20175">                Report.addNewline(vPhaseReport);</span>
            }
        }
<span class="nc" id="L20178">    }</span>

    private void clearFlawedCoolingFlags(Entity entity) {
        // If we're not using quirks, no need to do this check.
<span class="nc bnc" id="L20182" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L20183">            return;</span>
        }
        // Only applies to Mechs.
<span class="nc bnc" id="L20186" title="All 2 branches missed.">        if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20187">            return;</span>
        }

        // Check for existence of flawed cooling quirk.
<span class="nc bnc" id="L20191" title="All 2 branches missed.">        if (!entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)) {</span>
<span class="nc" id="L20192">            return;</span>
        }
<span class="nc" id="L20194">        entity.setFallen(false);</span>
<span class="nc" id="L20195">        entity.setStruck(false);</span>
<span class="nc" id="L20196">    }</span>

    private void checkForFlawedCooling() {

        // If we're not using quirks, no need to do this check.
<span class="nc bnc" id="L20201" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L20202">            return;</span>
        }

<span class="nc bnc" id="L20205" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20206">            final Entity entity = i.next();</span>

            // Only applies to Mechs.
<span class="nc bnc" id="L20209" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20210">                continue;</span>
            }

            // Check for existence of flawed cooling quirk.
<span class="nc bnc" id="L20214" title="All 2 branches missed.">            if (!entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)) {</span>
<span class="nc" id="L20215">                continue;</span>
            }

            // Check for active Cooling Flaw
<span class="nc bnc" id="L20219" title="All 2 branches missed.">            if (((Mech) entity).isCoolingFlawActive()) {</span>
<span class="nc" id="L20220">                continue;</span>
            }

            // Perform the check.
<span class="nc bnc" id="L20224" title="All 2 branches missed.">            if (entity.damageThisPhase &gt;= 20) {</span>
<span class="nc" id="L20225">                addReport(doFlawedCoolingCheck(&quot;20+ damage&quot;, entity));</span>
            }
<span class="nc bnc" id="L20227" title="All 2 branches missed.">            if (entity.hasFallen()) {</span>
<span class="nc" id="L20228">                addReport(doFlawedCoolingCheck(&quot;fall&quot;, entity));</span>
            }
<span class="nc bnc" id="L20230" title="All 2 branches missed.">            if (entity.wasStruck()) {</span>
<span class="nc" id="L20231">                addReport(doFlawedCoolingCheck(&quot;being struck&quot;, entity));</span>
            }
<span class="nc" id="L20233">            clearFlawedCoolingFlags(entity);</span>
<span class="nc" id="L20234">        }</span>
<span class="nc" id="L20235">    }</span>

    /**
     * Checks to see if Flawed Cooling is triggered and generates a report of
     * the result.
     *
     * @param reason
     * @param entity
     * @return
     */
    private Vector&lt;Report&gt; doFlawedCoolingCheck(String reason, Entity entity) {
<span class="nc" id="L20246">        Vector&lt;Report&gt; out = new Vector&lt;&gt;();</span>
<span class="nc" id="L20247">        Report r = new Report(9800);</span>
<span class="nc" id="L20248">        r.addDesc(entity);</span>
<span class="nc" id="L20249">        r.add(reason);</span>
<span class="nc" id="L20250">        int roll = Compute.d6(2);</span>
<span class="nc" id="L20251">        r.add(roll);</span>
<span class="nc" id="L20252">        out.add(r);</span>
<span class="nc bnc" id="L20253" title="All 2 branches missed.">        if (roll &gt;= 10) {</span>
<span class="nc" id="L20254">            Report s = new Report(9805);</span>
<span class="nc" id="L20255">            ((Mech) entity).setCoolingFlawActive(true);</span>
<span class="nc" id="L20256">            out.add(s);</span>
        }

<span class="nc" id="L20259">        return out;</span>
    }

    /**
     * For chain whip grapples, a roll needs to be made at the end of the
     * physical phase to maintain the grapple.
     */
    private void checkForChainWhipGrappleChecks() {
<span class="nc bnc" id="L20267" title="All 2 branches missed.">        for (Entity ae : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L20268" title="All 4 branches missed.">            if ((ae.getGrappled() != Entity.NONE) &amp;&amp; ae.isChainWhipGrappled()</span>
<span class="nc bnc" id="L20269" title="All 4 branches missed.">                    &amp;&amp; ae.isGrappleAttacker() &amp;&amp; !ae.isGrappledThisRound()) {</span>
<span class="nc" id="L20270">                Entity te = game.getEntity(ae.getGrappled());</span>
<span class="nc" id="L20271">                ToHitData grappleHit = GrappleAttackAction.toHit(game,</span>
<span class="nc" id="L20272">                        ae.getId(), te, ae.getGrappleSide(), true);</span>
<span class="nc" id="L20273">                int roll = Compute.d6(2);</span>

<span class="nc" id="L20275">                Report r = new Report(4317);</span>
<span class="nc" id="L20276">                r.subject = ae.getId();</span>
<span class="nc" id="L20277">                r.indent();</span>
<span class="nc" id="L20278">                r.addDesc(ae);</span>
<span class="nc" id="L20279">                r.addDesc(te);</span>
<span class="nc" id="L20280">                r.newlines = 0;</span>
<span class="nc" id="L20281">                addReport(r);</span>

<span class="nc bnc" id="L20283" title="All 2 branches missed.">                if (grappleHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L20284">                    r = new Report(4300);</span>
<span class="nc" id="L20285">                    r.subject = ae.getId();</span>
<span class="nc" id="L20286">                    r.add(grappleHit.getDesc());</span>
<span class="nc" id="L20287">                    addReport(r);</span>
<span class="nc" id="L20288">                    return;</span>
                }

                // report the roll
<span class="nc" id="L20292">                r = new Report(4025);</span>
<span class="nc" id="L20293">                r.subject = ae.getId();</span>
<span class="nc" id="L20294">                r.add(grappleHit);</span>
<span class="nc" id="L20295">                r.add(roll);</span>
<span class="nc" id="L20296">                r.newlines = 0;</span>
<span class="nc" id="L20297">                addReport(r);</span>

                // do we hit?
<span class="nc bnc" id="L20300" title="All 2 branches missed.">                if (roll &gt;= grappleHit.getValue()) {</span>
                    // hit
<span class="nc" id="L20302">                    r = new Report(4040);</span>
<span class="nc" id="L20303">                    r.subject = ae.getId();</span>
<span class="nc" id="L20304">                    addReport(r);</span>
                    // Nothing else to do
<span class="nc" id="L20306">                    return;</span>
                }

                // miss
<span class="nc" id="L20310">                r = new Report(4035);</span>
<span class="nc" id="L20311">                r.subject = ae.getId();</span>
<span class="nc" id="L20312">                addReport(r);</span>

                // Need to break grapple
<span class="nc" id="L20315">                ae.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L20316">                te.setGrappled(Entity.NONE, false);</span>
            }
<span class="nc" id="L20318">        }</span>
<span class="nc" id="L20319">    }</span>

    /**
     * Checks to see if any entity takes enough damage that requires them to
     * make a piloting roll
     */
    private void checkForPSRFromDamage() {
<span class="nc bnc" id="L20326" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20327">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20328" title="All 2 branches missed.">            if (entity.canFall()) {</span>
<span class="nc bnc" id="L20329" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
                    // you can't fall over when you are combat dropping because
                    // you are already falling!
<span class="nc" id="L20332">                    continue;</span>
                }
                // if this mech has 20+ damage, add another roll to the list.
                // Hulldown 'mechs ignore this rule, TO Errata
<span class="nc" id="L20336">                int psrThreshold = 20;</span>
<span class="nc bnc" id="L20337" title="All 2 branches missed.">                if (((Mech) entity).getCockpitType() == Mech.COCKPIT_DUAL</span>
<span class="nc bnc" id="L20338" title="All 2 branches missed.">                        &amp;&amp; entity.getCrew().hasDedicatedPilot()) {</span>
<span class="nc" id="L20339">                    psrThreshold = 30;</span>
                }
<span class="nc bnc" id="L20341" title="All 4 branches missed.">                if ((entity.damageThisPhase &gt;= psrThreshold) &amp;&amp; !entity.isHullDown()) {</span>
<span class="nc bnc" id="L20342" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_TAKING_DAMAGE)) {</span>
<span class="nc" id="L20343">                        PilotingRollData damPRD = new PilotingRollData(entity.getId());</span>
<span class="nc" id="L20344">                        int damMod = entity.damageThisPhase / psrThreshold;</span>
<span class="nc" id="L20345">                        damPRD.addModifier(damMod, (damMod * psrThreshold) + &quot;+ damage&quot;);</span>
<span class="nc" id="L20346">                        int weightMod = 0;</span>
<span class="nc bnc" id="L20347" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVGRNDMOV_TACOPS_PHYSICAL_PSR)) {
<span class="nc bnc" id="L20349" title="All 5 branches missed.">                            switch (entity.getWeightClass()) {</span>
                                case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L20351">                                    weightMod = 1;</span>
<span class="nc" id="L20352">                                    break;</span>
                                case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L20354">                                    weightMod = 0;</span>
<span class="nc" id="L20355">                                    break;</span>
                                case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L20357">                                    weightMod = -1;</span>
<span class="nc" id="L20358">                                    break;</span>
                                case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L20360">                                    weightMod = -2;</span>
                                    break;
                            }
<span class="nc bnc" id="L20363" title="All 4 branches missed.">                            if ((entity instanceof Mech) &amp;&amp; entity.isSuperHeavy()) {</span>
<span class="nc" id="L20364">                                weightMod = -4;</span>
                            }
                            // the weight class PSR modifier is not cumulative
<span class="nc" id="L20367">                            damPRD.addModifier(weightMod,</span>
                                               &quot;weight class modifier&quot;, false);
                        }
<span class="nc bnc" id="L20370" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20371" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20372">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20374">                        game.addPSR(damPRD);</span>
<span class="nc" id="L20375">                    } else {</span>
<span class="nc" id="L20376">                        PilotingRollData damPRD = new PilotingRollData(</span>
<span class="nc" id="L20377">                                entity.getId(), 1, psrThreshold + &quot;+ damage&quot;);</span>
<span class="nc bnc" id="L20378" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20379" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20380">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20382">                        game.addPSR(damPRD);</span>
                    }
                }
            }
<span class="nc bnc" id="L20386" title="All 6 branches missed.">            if (entity.isAero() &amp;&amp; entity.isAirborne() &amp;&amp; !game.getBoard().inSpace()) {</span>
                // if this aero has any damage, add another roll to the list.
<span class="nc bnc" id="L20388" title="All 2 branches missed.">                if (entity.damageThisPhase &gt; 0) {</span>
<span class="nc bnc" id="L20389" title="All 2 branches missed.">                    if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_ATMOSPHERIC_CONTROL)) {</span>
<span class="nc" id="L20390">                        int damMod = entity.damageThisPhase / 20;</span>
<span class="nc" id="L20391">                        PilotingRollData damPRD = new PilotingRollData(entity.getId(), damMod, entity.damageThisPhase + &quot; damage +&quot; + damMod);</span>
<span class="nc bnc" id="L20392" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20393" title="All 2 branches missed.">                                &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20394">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20396">                        game.addControlRoll(damPRD);</span>
<span class="nc" id="L20397">                    } else {</span>
                        // was the damage threshold exceeded this round?
<span class="nc bnc" id="L20399" title="All 2 branches missed.">                        if (((IAero) entity).wasCritThresh()) {</span>
<span class="nc" id="L20400">                            PilotingRollData damThresh = new PilotingRollData(entity.getId(), 0,</span>
                                    &quot;damage threshold exceeded&quot;);
<span class="nc bnc" id="L20402" title="All 2 branches missed.">                            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20403" title="All 2 branches missed.">                                    &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20404">                                damThresh.addModifier(-1, &quot;easy to pilot&quot;);</span>
                            }
<span class="nc" id="L20406">                            game.addControlRoll(damThresh);</span>
                        }
                    }
                }
            }
            // Airborne AirMechs that take 20+ damage make a control roll instead of a PSR.
<span class="nc bnc" id="L20412" title="All 6 branches missed.">            if (entity instanceof LandAirMech &amp;&amp; entity.isAirborneVTOLorWIGE()</span>
                    &amp;&amp; entity.damageThisPhase &gt;= 20) {
<span class="nc" id="L20414">                PilotingRollData damPRD = new PilotingRollData(entity.getId());</span>
<span class="nc" id="L20415">                int damMod = entity.damageThisPhase / 20;</span>
<span class="nc" id="L20416">                damPRD.addModifier(damMod, (damMod * 20) + &quot;+ damage&quot;);</span>
<span class="nc" id="L20417">                game.addControlRoll(damPRD);</span>
            }
<span class="nc" id="L20419">        }</span>
<span class="nc" id="L20420">    }</span>

    /**
     * Checks to see if any non-mech units are standing in fire. Called at the
     * end of the movement phase
     */
    public void checkForFlamingDamage() {
<span class="nc bnc" id="L20427" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20428">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20429" title="All 4 branches missed.">            if ((null == entity.getPosition()) || (entity instanceof Mech)</span>
<span class="nc bnc" id="L20430" title="All 6 branches missed.">                    || entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard()) {</span>
<span class="nc" id="L20431">                continue;</span>
            }
<span class="nc" id="L20433">            final IHex curHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L20434" title="All 2 branches missed.">            final boolean underwater = curHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L20435" title="All 2 branches missed.">                    &amp;&amp; (curHex.depth() &gt; 0)</span>
<span class="nc bnc" id="L20436" title="All 2 branches missed.">                    &amp;&amp; (entity.getElevation() &lt; curHex.surface());</span>
<span class="nc" id="L20437">            final int numFloors = curHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc bnc" id="L20438" title="All 4 branches missed.">            if (curHex.containsTerrain(Terrains.FIRE) &amp;&amp; !underwater</span>
<span class="nc bnc" id="L20439" title="All 2 branches missed.">                    &amp;&amp; ((entity.getElevation() &lt;= 1)</span>
<span class="nc bnc" id="L20440" title="All 2 branches missed.">                            || (entity.getElevation() &lt;= numFloors))) {</span>
<span class="nc" id="L20441">                doFlamingDamage(entity);</span>
            }
<span class="nc" id="L20443">        }</span>
<span class="nc" id="L20444">    }</span>

    /**
     * Checks to see if any telemissiles are in a hex with enemy units. If so,
     * then attack one.
     */
    private void checkForTeleMissileAttacks() {
<span class="nc bnc" id="L20451" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20452">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20453" title="All 2 branches missed.">            if (entity instanceof TeleMissile) {</span>
                // check for enemy units
<span class="nc" id="L20455">                Vector&lt;Integer&gt; potTargets = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L20456" title="All 2 branches missed.">                for (Entity te : game.getEntitiesVector(entity.getPosition())) {</span>
                    //Telemissiles cannot target fighters or other telemissiles
                    //Fighters don't have a distinctive Etype flag, so we have to do
                    //this by exclusion.
<span class="nc bnc" id="L20460" title="All 2 branches missed.">                    if (!(te.hasETypeFlag(Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L20461" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L20462" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L20463" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_WARSHIP)</span>
<span class="nc bnc" id="L20464" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_SPACE_STATION))) {</span>
<span class="nc" id="L20465">                        continue;</span>
                    }
<span class="nc bnc" id="L20467" title="All 2 branches missed.">                    if (te.isEnemyOf(entity)) {</span>
                        // then add it to a vector of potential targets
<span class="nc" id="L20469">                        potTargets.add(te.getId());</span>
                    }
<span class="nc" id="L20471">                }</span>
<span class="nc bnc" id="L20472" title="All 2 branches missed.">                if (potTargets.size() &gt; 0) {</span>
                    // determine randomly
<span class="nc" id="L20474">                    Entity target = game.getEntity(potTargets.get(Compute</span>
<span class="nc" id="L20475">                            .randomInt(potTargets.size())));</span>
                    // report this and add a new TeleMissileAttackAction
<span class="nc" id="L20477">                    Report r = new Report(9085);</span>
<span class="nc" id="L20478">                    r.subject = entity.getId();</span>
<span class="nc" id="L20479">                    r.addDesc(entity);</span>
<span class="nc" id="L20480">                    r.addDesc(target);</span>
<span class="nc" id="L20481">                    addReport(r);</span>
<span class="nc" id="L20482">                    game.addTeleMissileAttack(new TeleMissileAttackAction(entity, target));</span>
                }
            }
<span class="nc" id="L20485">        }</span>
<span class="nc" id="L20486">    }</span>

    private void checkForBlueShieldDamage() {
        Report r;
<span class="nc bnc" id="L20490" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20491">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20492" title="All 4 branches missed.">            if (!(entity instanceof Aero) &amp;&amp; entity.hasActiveBlueShield()</span>
<span class="nc bnc" id="L20493" title="All 2 branches missed.">                &amp;&amp; (entity.getBlueShieldRounds() &gt;= 6)) {</span>
<span class="nc" id="L20494">                int roll = Compute.d6(2);</span>
<span class="nc" id="L20495">                int target = (3 + entity.getBlueShieldRounds()) - 6;</span>
<span class="nc" id="L20496">                r = new Report(1240);</span>
<span class="nc" id="L20497">                r.addDesc(entity);</span>
<span class="nc" id="L20498">                r.add(target);</span>
<span class="nc" id="L20499">                r.add(roll);</span>
<span class="nc bnc" id="L20500" title="All 2 branches missed.">                if (roll &lt; target) {</span>
<span class="nc bnc" id="L20501" title="All 2 branches missed.">                    for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L20502" title="All 2 branches missed.">                        if (m.getType().hasFlag(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L20503">                            m.setBreached(true);</span>
                        }
<span class="nc" id="L20505">                    }</span>
<span class="nc" id="L20506">                    r.choose(true);</span>
                } else {
<span class="nc" id="L20508">                    r.choose(false);</span>
                }
<span class="nc" id="L20510">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L20512">        }</span>
<span class="nc" id="L20513">    }</span>

    /**
     * Check to see if anyone dies due to being in certain planetary conditions.
     */
    private void checkForConditionDeath() {
        Report r;
<span class="nc bnc" id="L20520" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20521">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20522" title="All 6 branches missed.">            if ((null == entity.getPosition()) &amp;&amp; !entity.isOffBoard() || (entity.getTransportId() != Entity.NONE)) {</span>
                // Ignore transported units, and units that don't have a position for some unknown reason
<span class="nc" id="L20524">                continue;</span>
            }
<span class="nc" id="L20526">            String reason = game.getPlanetaryConditions().whyDoomed(entity, game);</span>
<span class="nc bnc" id="L20527" title="All 2 branches missed.">            if (null != reason) {</span>
<span class="nc" id="L20528">                r = new Report(6015);</span>
<span class="nc" id="L20529">                r.subject = entity.getId();</span>
<span class="nc" id="L20530">                r.addDesc(entity);</span>
<span class="nc" id="L20531">                r.add(reason);</span>
<span class="nc" id="L20532">                addReport(r);</span>
<span class="nc" id="L20533">                addReport(destroyEntity(entity, reason, true, true));</span>
            }
<span class="nc" id="L20535">        }</span>
<span class="nc" id="L20536">    }</span>

    /**
     * Check to see if anyone dies due to being in atmosphere.
     */
    private void checkForAtmosphereDeath() {
        Report r;
<span class="nc bnc" id="L20543" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20544">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20545" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20548">                continue;</span>
            }
<span class="nc bnc" id="L20550" title="All 4 branches missed.">            if (entity.doomedInAtmosphere() &amp;&amp; (entity.getAltitude() == 0)) {</span>
<span class="nc" id="L20551">                r = new Report(6016);</span>
<span class="nc" id="L20552">                r.subject = entity.getId();</span>
<span class="nc" id="L20553">                r.addDesc(entity);</span>
<span class="nc" id="L20554">                addReport(r);</span>
<span class="nc" id="L20555">                addReport(destroyEntity(entity,</span>
                        &quot;being in atmosphere where it can't survive&quot;, true,
                        true));
            }
<span class="nc" id="L20559">        }</span>
<span class="nc" id="L20560">    }</span>

    /**
     * checks if IndustrialMechs should die because they moved into to-deep
     * water last round
     */
    private void checkForIndustrialWaterDeath() {
<span class="nc bnc" id="L20567" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20568">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20569" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20572">                continue;</span>
            }
<span class="nc bnc" id="L20574" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L20575" title="All 2 branches missed.">                    &amp;&amp; ((Mech) entity).shouldDieAtEndOfTurnBecauseOfWater()) {</span>
<span class="nc" id="L20576">                addReport(destroyEntity(entity,</span>
                        &quot;being in water without environmental shielding&quot;, true,
                        true));
            }

<span class="nc" id="L20581">        }</span>
<span class="nc" id="L20582">    }</span>

    private void checkForIndustrialEndOfTurn() {
<span class="nc" id="L20585">        checkForIndustrialWaterDeath();</span>
<span class="nc" id="L20586">        checkForIndustrialUnstall();</span>
<span class="nc" id="L20587">        checkForIndustrialCrit(); // This might hit an actuator or gyro, so...</span>
<span class="nc" id="L20588">        addReport(resolvePilotingRolls());</span>
<span class="nc" id="L20589">    }</span>

    private void checkForIndustrialUnstall() {
<span class="nc bnc" id="L20592" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20593">            final Entity entity = i.next();</span>
<span class="nc" id="L20594">            entity.checkUnstall(vPhaseReport);</span>
<span class="nc" id="L20595">        }</span>
<span class="nc" id="L20596">    }</span>

    /**
     * industrial mechs might need to check for critical damage
     */
    private void checkForIndustrialCrit() {
<span class="nc bnc" id="L20602" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20603">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20604" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech) entity).isIndustrial()) {</span>
<span class="nc" id="L20605">                Mech mech = (Mech) entity;</span>
                // should we check for critical damage?
<span class="nc bnc" id="L20607" title="All 2 branches missed.">                if (mech.isCheckForCrit()) {</span>
<span class="nc" id="L20608">                    Report r = new Report(5530);</span>
<span class="nc" id="L20609">                    r.addDesc(mech);</span>
<span class="nc" id="L20610">                    r.subject = mech.getId();</span>
<span class="nc" id="L20611">                    r.newlines = 0;</span>
<span class="nc" id="L20612">                    vPhaseReport.add(r);</span>
                    // for being hit by a physical weapon
<span class="nc bnc" id="L20614" title="All 2 branches missed.">                    if (mech.getLevelsFallen() == 0) {</span>
<span class="nc" id="L20615">                        r = new Report(5531);</span>
<span class="nc" id="L20616">                        r.subject = mech.getId();</span>
                        // or for falling
                    } else {
<span class="nc" id="L20619">                        r = new Report(5532);</span>
<span class="nc" id="L20620">                        r.subject = mech.getId();</span>
<span class="nc" id="L20621">                        r.add(mech.getLevelsFallen());</span>
                    }
<span class="nc" id="L20623">                    vPhaseReport.add(r);</span>
<span class="nc" id="L20624">                    HitData newHit = mech.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L20625">                    vPhaseReport.addAll(criticalEntity(mech,</span>
<span class="nc" id="L20626">                            newHit.getLocation(), newHit.isRear(),</span>
<span class="nc" id="L20627">                            mech.getLevelsFallen(), 0));</span>
                }
            }
<span class="nc" id="L20630">        }</span>
<span class="nc" id="L20631">    }</span>

    /**
     * Check to see if anyone dies due to being in space.
     */
    private void checkForSpaceDeath() {
        Report r;
<span class="nc bnc" id="L20638" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20639">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20640" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20643">                continue;</span>
            }
<span class="nc bnc" id="L20645" title="All 2 branches missed.">            if (entity.doomedInSpace()) {</span>
<span class="nc" id="L20646">                r = new Report(6017);</span>
<span class="nc" id="L20647">                r.subject = entity.getId();</span>
<span class="nc" id="L20648">                r.addDesc(entity);</span>
<span class="nc" id="L20649">                addReport(r);</span>
<span class="nc" id="L20650">                addReport(destroyEntity(entity,</span>
                        &quot;being in space where it can't survive&quot;, true, true));
            }
<span class="nc" id="L20653">        }</span>
<span class="nc" id="L20654">    }</span>

    /**
     * Checks to see if any entities are underwater (or in vacuum) with damaged
     * life support. Called during the end phase.
     */
    private void checkForSuffocation() {
<span class="nc bnc" id="L20661" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20662">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20663" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
<span class="nc" id="L20664">                continue;</span>
            }
<span class="nc" id="L20666">            final IHex curHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L20667" title="All 2 branches missed.">            if ((((entity.getElevation() &lt; 0) &amp;&amp; ((curHex</span>
<span class="nc bnc" id="L20668" title="All 2 branches missed.">                    .terrainLevel(Terrains.WATER) &gt; 1) || ((curHex</span>
<span class="nc bnc" id="L20669" title="All 4 branches missed.">                    .terrainLevel(Terrains.WATER) == 1) &amp;&amp; entity.isProne()))) || game</span>
<span class="nc bnc" id="L20670" title="All 2 branches missed.">                    .getPlanetaryConditions().isVacuum())</span>
<span class="nc bnc" id="L20671" title="All 2 branches missed.">                    &amp;&amp; (entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                            Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_HEAD) &gt; 0)) {
<span class="nc" id="L20673">                Report r = new Report(6020);</span>
<span class="nc" id="L20674">                r.subject = entity.getId();</span>
<span class="nc" id="L20675">                r.addDesc(entity);</span>
<span class="nc" id="L20676">                addReport(r);</span>
<span class="nc" id="L20677">                addReport(damageCrew(entity, 1));</span>

            }
<span class="nc" id="L20680">        }</span>
<span class="nc" id="L20681">    }</span>

    /**
     * Iterates over all entities and gets rid of Narc pods attached to destroyed
     * or lost locations.
     */
    private void cleanupDestroyedNarcPods() {
<span class="nc bnc" id="L20688" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20689">            i.next().clearDestroyedNarcPods();</span>
        }
<span class="nc" id="L20691">    }</span>

    /**
     * Resolves all built up piloting skill rolls. Used at end of weapons,
     * physical phases.
     */
    private Vector&lt;Report&gt; resolvePilotingRolls() {
<span class="nc" id="L20698">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L20699" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20700">            vPhaseReport.addAll(resolvePilotingRolls(i.next()));</span>
        }
<span class="nc" id="L20702">        game.resetPSRs();</span>
<span class="nc" id="L20703">        return vPhaseReport;</span>
    }

    /**
     * Resolves and reports all piloting skill rolls for a single mech.
     */
    private Vector&lt;Report&gt; resolvePilotingRolls(Entity entity) {
<span class="nc" id="L20710">        return resolvePilotingRolls(entity, false, entity.getPosition(),</span>
<span class="nc" id="L20711">                                    entity.getPosition());</span>
    }

    private Vector&lt;Report&gt; resolvePilotingRolls(Entity entity, boolean moving,
                                                Coords src, Coords dest) {
<span class="nc" id="L20716">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        // dead and undeployed and offboard units don't need to.
<span class="nc bnc" id="L20718" title="All 8 branches missed.">        if (entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard() || !entity.isDeployed()</span>
<span class="nc bnc" id="L20719" title="All 2 branches missed.">                || (entity.getTransportId() != Entity.NONE)) {</span>
<span class="nc" id="L20720">            return vPhaseReport;</span>
        }

        // airborne units don't make piloting rolls, they make control rolls
<span class="nc bnc" id="L20724" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>
<span class="nc" id="L20725">            return vPhaseReport;</span>
        }

        Report r;

        // first, do extreme gravity PSR, because non-mechs do these, too
<span class="nc" id="L20731">        PilotingRollData rollTarget = null;</span>
<span class="nc bnc" id="L20732" title="All 2 branches missed.">        for (Enumeration&lt;PilotingRollData&gt; i = game.getExtremeGravityPSRs(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L20733">            final PilotingRollData roll = i.nextElement();</span>
<span class="nc bnc" id="L20734" title="All 2 branches missed.">            if (roll.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L20735">                continue;</span>
            }
            // found a roll, use it (there can be only 1 per entity)
<span class="nc" id="L20738">            rollTarget = roll;</span>
<span class="nc" id="L20739">            game.resetExtremeGravityPSRs(entity);</span>
<span class="nc" id="L20740">        }</span>
<span class="nc bnc" id="L20741" title="All 4 branches missed.">        if ((rollTarget != null) &amp;&amp; (rollTarget.getValue() != TargetRoll.CHECK_FALSE)) {</span>
            // okay, print the info
<span class="nc" id="L20743">            r = new Report(2180);</span>
<span class="nc" id="L20744">            r.subject = entity.getId();</span>
<span class="nc" id="L20745">            r.addDesc(entity);</span>
<span class="nc" id="L20746">            r.add(rollTarget.getLastPlainDesc());</span>
<span class="nc" id="L20747">            vPhaseReport.add(r);</span>
            // roll
<span class="nc" id="L20749">            final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L20750">            r = new Report(2190);</span>
<span class="nc" id="L20751">            r.subject = entity.getId();</span>
<span class="nc" id="L20752">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L20753">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L20754">            r.add(diceRoll);</span>
<span class="nc bnc" id="L20755" title="All 2 branches missed.">            if ((diceRoll &lt; rollTarget.getValue())</span>
<span class="nc bnc" id="L20756" title="All 4 branches missed.">                    || (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2))) {
<span class="nc" id="L20758">                r.choose(false);</span>
                // Report the fumble
<span class="nc bnc" id="L20760" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2)) {
<span class="nc" id="L20762">                    r.messageId = 2306;</span>
                }
<span class="nc" id="L20764">                vPhaseReport.add(r);</span>
                // walking and running, 1 damage per MP used more than we would
                // have normally
<span class="nc bnc" id="L20767" title="All 12 branches missed.">                if ((entity.moved == EntityMovementType.MOVE_WALK)</span>
                        || (entity.moved == EntityMovementType.MOVE_VTOL_WALK)
                        || (entity.moved == EntityMovementType.MOVE_RUN)
                        || (entity.moved == EntityMovementType.MOVE_SPRINT)
                        || (entity.moved == EntityMovementType.MOVE_VTOL_RUN)
                        || (entity.moved == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc bnc" id="L20773" title="All 2 branches missed.">                    if (entity instanceof Mech) {</span>
<span class="nc" id="L20774">                        int j = entity.mpUsed;</span>
<span class="nc" id="L20775">                        int damage = 0;</span>
<span class="nc bnc" id="L20776" title="All 2 branches missed.">                        while (j &gt; entity.getRunningGravityLimit()) {</span>
<span class="nc" id="L20777">                            j--;</span>
<span class="nc" id="L20778">                            damage++;</span>
                        }
                        // Wee, direct internal damage
<span class="nc" id="L20781">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
<span class="nc bnc" id="L20783" title="All 2 branches missed.">                    } else if (entity instanceof Tank) {</span>
                        // if we got a pavement bonus, take care of it
<span class="nc bnc" id="L20785" title="All 2 branches missed.">                        int k = entity.gotPavementBonus ? 1 : 0;</span>
<span class="nc bnc" id="L20786" title="All 2 branches missed.">                        if (!entity.gotPavementBonus) {</span>
<span class="nc" id="L20787">                            int j = entity.mpUsed;</span>
<span class="nc" id="L20788">                            int damage = 0;</span>
<span class="nc bnc" id="L20789" title="All 2 branches missed.">                            while (j &gt; (entity.getRunMP(false, false, false) + k)) {</span>
<span class="nc" id="L20790">                                j--;</span>
<span class="nc" id="L20791">                                damage++;</span>
                            }
<span class="nc" id="L20793">                            vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                       damage));
                        }
                    }
                }
                // jumping
<span class="nc bnc" id="L20799" title="All 4 branches missed.">                if ((entity.moved == EntityMovementType.MOVE_JUMP)</span>
                    &amp;&amp; (entity instanceof Mech)) {
                    // low g, 1 damage for each hex jumped further than
                    // possible normally
<span class="nc bnc" id="L20803" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().getGravity() &lt; 1) {</span>
<span class="nc" id="L20804">                        int j = entity.mpUsed;</span>
<span class="nc" id="L20805">                        int damage = 0;</span>
<span class="nc bnc" id="L20806" title="All 2 branches missed.">                        while (j &gt; entity.getJumpMP(false)) {</span>
<span class="nc" id="L20807">                            j--;</span>
<span class="nc" id="L20808">                            damage++;</span>
                        }
                        // Wee, direct internal damage
<span class="nc" id="L20811">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
<span class="nc" id="L20813">                    }</span>
                    // high g, 1 damage for each MP we have less than normally
<span class="nc bnc" id="L20815" title="All 2 branches missed.">                    else if (game.getPlanetaryConditions().getGravity() &gt; 1) {</span>
<span class="nc" id="L20816">                        int damage = entity.getWalkMP(false, false)</span>
<span class="nc" id="L20817">                                     - entity.getWalkMP();</span>
                        // Wee, direct internal damage
<span class="nc" id="L20819">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20824">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
            } else {
<span class="nc" id="L20826">                r.choose(true);</span>
<span class="nc" id="L20827">                vPhaseReport.add(r);</span>
            }
        }

        // Glider ProtoMechs without sufficient movement to stay airborne make forced landings.
<span class="nc bnc" id="L20832" title="All 4 branches missed.">        if ((entity instanceof Protomech) &amp;&amp; ((Protomech)entity).isGlider()</span>
<span class="nc bnc" id="L20833" title="All 4 branches missed.">                &amp;&amp; entity.isAirborneVTOLorWIGE() &amp;&amp; (entity.getRunMP() &lt; 4)) {</span>
<span class="nc" id="L20834">            vPhaseReport.addAll(landGliderPM((Protomech) entity, entity.getPosition(), entity.getElevation(),</span>
                    entity.delta_distance));
        }

        // non mechs and prone mechs can now return
<span class="nc bnc" id="L20839" title="All 6 branches missed.">        if (!entity.canFall() || (entity.isHullDown() &amp;&amp; entity.canGoHullDown())) {</span>
<span class="nc" id="L20840">            return vPhaseReport;</span>
        }

        // Mechs with UMU float and don't have to roll???
<span class="nc bnc" id="L20844" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L20845">            IHex hex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L20846">            int water = hex.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L20847" title="All 4 branches missed.">            if ((water &gt; 0) &amp;&amp; (entity.getElevation() != -hex.depth(true))</span>
<span class="nc bnc" id="L20848" title="All 4 branches missed.">                    &amp;&amp; ((entity.getElevation() &lt; 0) || ((entity.getElevation() == 0)</span>
<span class="nc bnc" id="L20849" title="All 4 branches missed.">                    &amp;&amp; (hex.terrainLevel(Terrains.BRIDGE_ELEV) != 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE)))</span>
<span class="nc bnc" id="L20850" title="All 4 branches missed.">                    &amp;&amp; !entity.isMakingDfa() &amp;&amp; !entity.isDropping()) {</span>
                // mech is floating in water....
<span class="nc bnc" id="L20852" title="All 2 branches missed.">                if (entity.hasUMU()) {</span>
<span class="nc" id="L20853">                    return vPhaseReport;</span>
                }
                // game.addPSR(new PilotingRollData(entity.getId(),
                // TargetRoll.AUTOMATIC_FAIL, &quot;lost buoyancy&quot;));
            }
        }
        // add all cumulative mods from other rolls to each PSR
        // holds all rolls to make
<span class="nc" id="L20861">        Vector&lt;PilotingRollData&gt; rolls = new Vector&lt;&gt;();</span>
        // holds the initial reason for each roll
<span class="nc" id="L20863">        StringBuilder reasons = new StringBuilder();</span>
<span class="nc" id="L20864">        PilotingRollData base = entity.getBasePilotingRoll();</span>
<span class="nc" id="L20865">        entity.addPilotingModifierForTerrain(base);</span>
<span class="nc bnc" id="L20866" title="All 2 branches missed.">        for (Enumeration&lt;PilotingRollData&gt; i = game.getPSRs(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L20867">            PilotingRollData psr = i.nextElement();</span>
<span class="nc bnc" id="L20868" title="All 2 branches missed.">            if (psr.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L20869">                continue;</span>
            }
            // found a roll
<span class="nc bnc" id="L20872" title="All 2 branches missed.">            if (reasons.length() &gt; 0) {</span>
<span class="nc" id="L20873">                reasons.append(&quot;; &quot;);</span>
            }
<span class="nc" id="L20875">            reasons.append(psr.getPlainDesc());</span>
<span class="nc" id="L20876">            PilotingRollData toUse = entity.getBasePilotingRoll();</span>
<span class="nc" id="L20877">            entity.addPilotingModifierForTerrain(toUse);</span>
<span class="nc" id="L20878">            toUse.append(psr);</span>
            // now, append all other roll's cumulative mods, not the
            // non-cumulative
            // ones
<span class="nc bnc" id="L20882" title="All 2 branches missed.">            for (Enumeration&lt;PilotingRollData&gt; j = game.getPSRs(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L20883">                final PilotingRollData other = j.nextElement();</span>
<span class="nc bnc" id="L20884" title="All 4 branches missed.">                if ((other.getEntityId() != entity.getId()) || other.equals(psr)) {</span>
<span class="nc" id="L20885">                    continue;</span>
                }
<span class="nc" id="L20887">                toUse.append(other, false);</span>
<span class="nc" id="L20888">            }</span>
<span class="nc" id="L20889">            rolls.add(toUse);</span>
<span class="nc" id="L20890">        }</span>
        // any rolls needed?
<span class="nc bnc" id="L20892" title="All 2 branches missed.">        if (rolls.size() == 0) {</span>
<span class="nc" id="L20893">            return vPhaseReport;</span>
        }
        // is our base roll impossible?
<span class="nc bnc" id="L20896" title="All 4 branches missed.">        if ((base.getValue() == TargetRoll.AUTOMATIC_FAIL) || (base.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L20897">            r = new Report(2275);</span>
<span class="nc" id="L20898">            r.subject = entity.getId();</span>
<span class="nc" id="L20899">            r.addDesc(entity);</span>
<span class="nc" id="L20900">            r.add(rolls.size());</span>
<span class="nc" id="L20901">            r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L20902">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20903" title="All 2 branches missed.">            if (moving) {</span>
<span class="nc" id="L20904">                vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                        base, true));
<span class="nc bnc" id="L20906" title="All 4 branches missed.">            } else if ((entity instanceof Mech) &amp;&amp; game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20908" title="All 2 branches missed.">                    &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20909" title="All 4 branches missed.">                    &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20910" title="All 4 branches missed.">                if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L20911">                    r = new Report(2317);</span>
<span class="nc" id="L20912">                    r.subject = entity.getId();</span>
<span class="nc" id="L20913">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L20914">                    vPhaseReport.add(r);</span>
                } else {
<span class="nc" id="L20916">                    vPhaseReport.addAll(doEntityFall(entity, base));</span>
                }
            } else {
<span class="nc" id="L20919">                vPhaseReport.addAll(doEntityFall(entity, base));</span>
            }
            // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20922">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L20923">            return vPhaseReport;</span>
        }
        // loop through rolls we do have to make...
<span class="nc" id="L20926">        r = new Report(2280);</span>
<span class="nc" id="L20927">        r.subject = entity.getId();</span>
<span class="nc" id="L20928">        r.addDesc(entity);</span>
<span class="nc" id="L20929">        r.add(rolls.size());</span>
<span class="nc" id="L20930">        r.add(reasons.toString()); // international issue</span>
<span class="nc" id="L20931">        vPhaseReport.add(r);</span>
<span class="nc" id="L20932">        r = new Report(2285);</span>
<span class="nc" id="L20933">        r.subject = entity.getId();</span>
<span class="nc" id="L20934">        r.add(base.getValueAsString());</span>
<span class="nc" id="L20935">        r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L20936">        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20937" title="All 2 branches missed.">        for (int i = 0; i &lt; rolls.size(); i++) {</span>
<span class="nc" id="L20938">            PilotingRollData roll = rolls.elementAt(i);</span>
<span class="nc" id="L20939">            r = new Report(2290);</span>
<span class="nc" id="L20940">            r.subject = entity.getId();</span>
<span class="nc" id="L20941">            r.indent();</span>
<span class="nc" id="L20942">            r.newlines = 0;</span>
<span class="nc" id="L20943">            r.add(i + 1);</span>
<span class="nc" id="L20944">            r.add(roll.getDesc()); // international issue</span>
<span class="nc" id="L20945">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20946" title="All 2 branches missed.">            if ((roll.getValue() == TargetRoll.AUTOMATIC_FAIL)</span>
<span class="nc bnc" id="L20947" title="All 2 branches missed.">                || (roll.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L20948">                r = new Report(2295);</span>
<span class="nc" id="L20949">                r.subject = entity.getId();</span>
<span class="nc" id="L20950">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20951" title="All 2 branches missed.">                if (moving) {</span>
<span class="nc" id="L20952">                    vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                            roll, true));
                } else {
<span class="nc bnc" id="L20955" title="All 4 branches missed.">                    if ((entity instanceof Mech) &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20957" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20958" title="All 4 branches missed.">                            &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20959" title="All 4 branches missed.">                        if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L20960">                            r = new Report(2317);</span>
<span class="nc" id="L20961">                            r.subject = entity.getId();</span>
<span class="nc" id="L20962">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L20963">                            vPhaseReport.add(r);</span>
                        } else {
<span class="nc" id="L20965">                            vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                        }
                    } else {
<span class="nc" id="L20968">                        vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20972">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L20973">                return vPhaseReport;</span>
            }
<span class="nc" id="L20975">            int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L20976">            r = new Report(2300);</span>
<span class="nc" id="L20977">            r.add(roll);</span>
<span class="nc" id="L20978">            r.add(diceRoll);</span>
<span class="nc" id="L20979">            r.subject = entity.getId();</span>
<span class="nc bnc" id="L20980" title="All 2 branches missed.">            if ((diceRoll &lt; roll.getValue())</span>
<span class="nc bnc" id="L20981" title="All 4 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES) &amp;&amp; (diceRoll == 2))) {</span>
<span class="nc" id="L20982">                r.choose(false);</span>
                // Report the fumble
<span class="nc bnc" id="L20984" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2)) {
<span class="nc" id="L20986">                    r.messageId = 2306;</span>
                }
<span class="nc" id="L20988">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20989" title="All 2 branches missed.">                if (moving) {</span>
<span class="nc" id="L20990">                    vPhaseReport.addAll(doEntityFallsInto(entity,</span>
<span class="nc" id="L20991">                                                          entity.getElevation(), src, dest, roll, true));</span>
                } else {
<span class="nc bnc" id="L20993" title="All 2 branches missed.">                    if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L20994" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20996" title="All 2 branches missed.">                        &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20997" title="All 4 branches missed.">                        &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20998" title="All 2 branches missed.">                        if ((entity.getCrew().getPiloting() &gt; 1)</span>
<span class="nc bnc" id="L20999" title="All 2 branches missed.">                            &amp;&amp; ((roll.getValue() - diceRoll) &lt; 2)) {</span>
<span class="nc" id="L21000">                            entity.setHullDown(true);</span>
<span class="nc bnc" id="L21001" title="All 2 branches missed.">                        } else if ((entity.getCrew().getPiloting() &lt;= 1)</span>
<span class="nc bnc" id="L21002" title="All 2 branches missed.">                                   &amp;&amp; ((roll.getValue() - diceRoll) &lt; 3)) {</span>
<span class="nc" id="L21003">                            entity.setHullDown(true);</span>
                        }
<span class="nc bnc" id="L21005" title="All 4 branches missed.">                        if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L21006">                            ServerHelper.sinkToBottom(entity);</span>
                            
<span class="nc" id="L21008">                            r = new Report(2317);</span>
<span class="nc" id="L21009">                            r.subject = entity.getId();</span>
<span class="nc" id="L21010">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L21011">                            vPhaseReport.add(r);</span>
                        } else {
<span class="nc" id="L21013">                            vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                        }
                    } else {
<span class="nc" id="L21016">                        vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L21020">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L21021">                return vPhaseReport;</span>
            }
<span class="nc" id="L21023">            r.choose(true);</span>
<span class="nc" id="L21024">            vPhaseReport.add(r);</span>
        }
<span class="nc" id="L21026">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; checkForTraitors() {
<span class="nc" id="L21030">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
        // check for traitors
<span class="nc bnc" id="L21032" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21033">            Entity entity = i.next();</span>
<span class="nc bnc" id="L21034" title="All 6 branches missed.">            if (entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard()</span>
<span class="nc bnc" id="L21035" title="All 2 branches missed.">                    || !entity.isDeployed()) {</span>
<span class="nc" id="L21036">                continue;</span>
            }
<span class="nc bnc" id="L21038" title="All 4 branches missed.">            if ((entity.getTraitorId() != -1) &amp;&amp; (entity.getOwnerId() != entity.getTraitorId())) {</span>
<span class="nc" id="L21039">                final IPlayer oldPlayer = game.getPlayer(entity.getOwnerId());</span>
<span class="nc" id="L21040">                final IPlayer newPlayer = game.getPlayer(entity.getTraitorId());</span>
<span class="nc bnc" id="L21041" title="All 2 branches missed.">                if (newPlayer != null) {</span>
<span class="nc" id="L21042">                    Report r = new Report(7305);</span>
<span class="nc" id="L21043">                    r.subject = entity.getId();</span>
<span class="nc" id="L21044">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L21045">                    r.add(newPlayer.getName());</span>
<span class="nc" id="L21046">                    entity.setOwner(newPlayer);</span>
<span class="nc" id="L21047">                    entityUpdate(entity.getId());</span>
<span class="nc" id="L21048">                    vFullReport.add(r);</span>

                    // Move the initial count and BV to their new player
<span class="nc" id="L21051">                    newPlayer.changeInitialEntityCount(1);</span>
<span class="nc" id="L21052">                    newPlayer.changeInitialBV(entity.calculateBattleValue());</span>

                    // And remove it from their old player, if they exist
<span class="nc bnc" id="L21055" title="All 2 branches missed.">                    if (oldPlayer != null) {</span>
<span class="nc" id="L21056">                        oldPlayer.changeInitialEntityCount(-1);</span>
                        // Note: I don't remove the full initial BV if I'm damaged, but that
                        // actually makes sense
<span class="nc" id="L21059">                        oldPlayer.changeInitialBV(-1 * entity.calculateBattleValue());</span>
                    }
                }
<span class="nc" id="L21062">                entity.setTraitorId(-1);</span>
            }
<span class="nc" id="L21064">        }</span>
<span class="nc bnc" id="L21065" title="All 2 branches missed.">        if (!vFullReport.isEmpty()) {</span>
<span class="nc" id="L21066">            vFullReport.add(0, new Report(7300));</span>
        }
<span class="nc" id="L21068">        return vFullReport;</span>
    }

    /**
     * Resolves all built up control rolls. Used only during end phase
     */
    private Vector&lt;Report&gt; resolveControlRolls() {
<span class="nc" id="L21075">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L21076">        vFullReport.add(new Report(5001, Report.PUBLIC));</span>
<span class="nc bnc" id="L21077" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21078">            vFullReport.addAll(resolveControl(i.next()));</span>
        }
<span class="nc" id="L21080">        game.resetControlRolls();</span>
<span class="nc" id="L21081">        return vFullReport;</span>
    }

    /**
     * Resolves and reports all control skill rolls for a single aero or airborne LAM in airmech mode.
     */
    private Vector&lt;Report&gt; resolveControl(Entity e) {
<span class="nc" id="L21088">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L21089" title="All 8 branches missed.">        if (e.isDoomed() || e.isDestroyed() || e.isOffBoard() || !e.isDeployed()) {</span>
<span class="nc" id="L21090">            return vReport;</span>
        }
        Report r;

        /*
         * See forum answers on OOC
         * http://forums.classicbattletech.com/index.php/topic,20424.0.html
         */

<span class="nc" id="L21099">        IAero a = null;</span>
<span class="nc" id="L21100">        boolean canRecover = false;</span>
<span class="nc bnc" id="L21101" title="All 6 branches missed.">        if (e.isAero() &amp;&amp; (e.isAirborne() || e.isSpaceborne())) {</span>
<span class="nc" id="L21102">            a = (IAero) e;</span>
            // they should get a shot at a recovery roll at the end of all this
            // if they are already out of control
<span class="nc" id="L21105">            canRecover = a.isOutControl();</span>
<span class="nc bnc" id="L21106" title="All 4 branches missed.">        } else if (!(e instanceof LandAirMech) || !e.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L21107">            return vReport;</span>
        }

        // if the unit already is moving randomly then it can't get any
        // worse
<span class="nc bnc" id="L21112" title="All 4 branches missed.">        if (a == null || !a.isRandomMove()) {</span>

            // find control rolls and make them
<span class="nc" id="L21115">            Vector&lt;PilotingRollData&gt; rolls = new Vector&lt;&gt;();</span>
<span class="nc" id="L21116">            StringBuilder reasons = new StringBuilder();</span>
<span class="nc" id="L21117">            PilotingRollData target = e.getBasePilotingRoll();</span>
            // maneuvering ace
            // TODO : pending rules query
            // http://www.classicbattletech.com/forums/index.php/topic,63552.new.html#new
            // for now I am assuming Man Ace applies to all out-of-control
            // rolls, but not other
            // uses of control rolls (thus it doesn't go in
            // Entity#addEntityBonuses) and
            // furthermore it doesn't apply to recovery rolls
<span class="nc bnc" id="L21126" title="All 2 branches missed.">            if (e.isUsingManAce()) {</span>
<span class="nc" id="L21127">                target.addModifier(-1, &quot;maneuvering ace&quot;);</span>
            }
<span class="nc bnc" id="L21129" title="All 2 branches missed.">            for (Enumeration&lt;PilotingRollData&gt; j = game.getControlRolls(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L21130">                final PilotingRollData modifier = j.nextElement();</span>
<span class="nc bnc" id="L21131" title="All 2 branches missed.">                if (modifier.getEntityId() != e.getId()) {</span>
<span class="nc" id="L21132">                    continue;</span>
                }
                // found a roll, add it
<span class="nc" id="L21135">                rolls.addElement(modifier);</span>
<span class="nc bnc" id="L21136" title="All 2 branches missed.">                if (reasons.length() &gt; 0) {</span>
<span class="nc" id="L21137">                    reasons.append(&quot;; &quot;);</span>
                }
<span class="nc" id="L21139">                reasons.append(modifier.getCumulativePlainDesc());</span>
<span class="nc" id="L21140">                target.append(modifier);</span>
<span class="nc" id="L21141">            }</span>
            // any rolls needed?
<span class="nc bnc" id="L21143" title="All 2 branches missed.">            if (rolls.size() &gt; 0) {</span>
                // loop through rolls we do have to make...
<span class="nc" id="L21145">                r = new Report(9310);</span>
<span class="nc" id="L21146">                r.subject = e.getId();</span>
<span class="nc" id="L21147">                r.addDesc(e);</span>
<span class="nc" id="L21148">                r.add(rolls.size());</span>
<span class="nc" id="L21149">                r.add(reasons.toString()); // international issue</span>
<span class="nc" id="L21150">                vReport.add(r);</span>
<span class="nc" id="L21151">                r = new Report(2285);</span>
<span class="nc" id="L21152">                r.subject = e.getId();</span>
<span class="nc" id="L21153">                r.add(target.getValueAsString());</span>
<span class="nc" id="L21154">                r.add(target.getDesc()); // international issue</span>
<span class="nc" id="L21155">                vReport.add(r);</span>
<span class="nc bnc" id="L21156" title="All 2 branches missed.">                for (int j = 0; j &lt; rolls.size(); j++) {</span>
<span class="nc" id="L21157">                    PilotingRollData modifier = rolls.elementAt(j);</span>
<span class="nc" id="L21158">                    r = new Report(2290);</span>
<span class="nc" id="L21159">                    r.subject = e.getId();</span>
<span class="nc" id="L21160">                    r.indent();</span>
<span class="nc" id="L21161">                    r.newlines = 0;</span>
<span class="nc" id="L21162">                    r.add(j + 1);</span>
<span class="nc" id="L21163">                    r.add(modifier.getPlainDesc()); // international issue</span>
<span class="nc" id="L21164">                    vReport.add(r);</span>
<span class="nc" id="L21165">                    int diceRoll = Compute.d6(2);</span>
                    // different reports depending on out-of-control status
<span class="nc bnc" id="L21167" title="All 4 branches missed.">                    if (a != null &amp;&amp; a.isOutControl()) {</span>
<span class="nc" id="L21168">                        r = new Report(9360);</span>
<span class="nc" id="L21169">                        r.subject = e.getId();</span>
<span class="nc" id="L21170">                        r.add(target);</span>
<span class="nc" id="L21171">                        r.add(diceRoll);</span>
<span class="nc bnc" id="L21172" title="All 2 branches missed.">                        if (diceRoll &lt; (target.getValue() - 5)) {</span>
<span class="nc" id="L21173">                            r.choose(false);</span>
<span class="nc" id="L21174">                            vReport.add(r);</span>
<span class="nc" id="L21175">                            a.setRandomMove(true);</span>
                        } else {
<span class="nc" id="L21177">                            r.choose(true);</span>
<span class="nc" id="L21178">                            vReport.add(r);</span>
                        }
                    } else {
<span class="nc" id="L21181">                        r = new Report(9315);</span>
<span class="nc" id="L21182">                        r.subject = e.getId();</span>
<span class="nc" id="L21183">                        r.add(target);</span>
<span class="nc" id="L21184">                        r.add(diceRoll);</span>
<span class="nc" id="L21185">                        r.newlines = 1;</span>
<span class="nc bnc" id="L21186" title="All 2 branches missed.">                        if (diceRoll &lt; target.getValue()) {</span>
<span class="nc" id="L21187">                            r.choose(false);</span>
<span class="nc" id="L21188">                            vReport.add(r);</span>
<span class="nc bnc" id="L21189" title="All 2 branches missed.">                            if (a != null) {</span>
<span class="nc" id="L21190">                                a.setOutControl(true);</span>
                                // do we have random movement?
<span class="nc bnc" id="L21192" title="All 2 branches missed.">                                if ((target.getValue() - diceRoll) &gt; 5) {</span>
<span class="nc" id="L21193">                                    r = new Report(9365);</span>
<span class="nc" id="L21194">                                    r.newlines = 0;</span>
<span class="nc" id="L21195">                                    r.subject = e.getId();</span>
<span class="nc" id="L21196">                                    vReport.add(r);</span>
<span class="nc" id="L21197">                                    a.setRandomMove(true);</span>
                                }
                                // if on the atmospheric map, then lose altitude
                                // and check
                                // for crash
<span class="nc bnc" id="L21202" title="All 4 branches missed.">                                if (!a.isSpaceborne() &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L21203">                                    int loss = Compute.d6(1);</span>
<span class="nc" id="L21204">                                    int origAltitude = e.getAltitude();</span>
<span class="nc" id="L21205">                                    e.setAltitude(e.getAltitude() - loss);</span>
                                    //Reroll altitude loss with edge if the new altitude would result in a crash
<span class="nc bnc" id="L21207" title="All 4 branches missed.">                                    if (e.getAltitude() &lt;= 0</span>
                                            //Don't waste the edge if it won't help
                                            &amp;&amp; origAltitude &gt; 1
<span class="nc bnc" id="L21210" title="All 2 branches missed.">                                            &amp;&amp; e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21211" title="All 2 branches missed.">                                            &amp;&amp; e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_ALT_LOSS)) {</span>
<span class="nc" id="L21212">                                        loss = Compute.d6(1);</span>
                                        //Report the edge use
<span class="nc" id="L21214">                                        r = new Report(9367);</span>
<span class="nc" id="L21215">                                        r.newlines = 1;</span>
<span class="nc" id="L21216">                                        r.subject = e.getId();</span>
<span class="nc" id="L21217">                                        vReport.add(r);</span>
<span class="nc" id="L21218">                                        e.setAltitude(origAltitude - loss);</span>
                                        // and spend the edge point
<span class="nc" id="L21220">                                        e.getCrew().decreaseEdge();</span>
                                    }
                                    //Report the altitude loss
<span class="nc" id="L21223">                                    r = new Report(9366);</span>
<span class="nc" id="L21224">                                    r.newlines = 0;</span>
<span class="nc" id="L21225">                                    r.subject = e.getId();</span>
<span class="nc" id="L21226">                                    r.addDesc(e);</span>
<span class="nc" id="L21227">                                    r.add(loss);</span>
<span class="nc" id="L21228">                                    vReport.add(r);</span>
                                    // check for crash
<span class="nc bnc" id="L21230" title="All 2 branches missed.">                                    if (checkCrash(e, e.getPosition(),</span>
<span class="nc" id="L21231">                                            e.getAltitude())) {</span>
<span class="nc" id="L21232">                                        vReport.addAll(processCrash(e,</span>
<span class="nc" id="L21233">                                                a.getCurrentVelocity(),</span>
<span class="nc" id="L21234">                                                e.getPosition()));</span>
<span class="nc" id="L21235">                                        break;</span>
                                    }
<span class="nc" id="L21237">                                }</span>
<span class="nc bnc" id="L21238" title="All 4 branches missed.">                            } else if (e instanceof LandAirMech &amp;&amp; e.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L21239">                                int loss = target.getValue() - diceRoll;</span>
<span class="nc" id="L21240">                                r = new Report(9366);</span>
<span class="nc" id="L21241">                                r.subject = e.getId();</span>
<span class="nc" id="L21242">                                r.addDesc(e);</span>
<span class="nc" id="L21243">                                r.add(loss);</span>
<span class="nc" id="L21244">                                vReport.add(r);</span>
<span class="nc" id="L21245">                                IHex hex = game.getBoard().getHex(e.getPosition());</span>
<span class="nc" id="L21246">                                int elevation = Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc bnc" id="L21247" title="All 2 branches missed.">                                if (e.getElevation() - loss &lt;= elevation) {</span>
<span class="nc" id="L21248">                                    crashAirMech(e, target, vReport);</span>
                                } else {
<span class="nc" id="L21250">                                    e.setElevation(e.getElevation() - loss);</span>
                                }
<span class="nc" id="L21252">                            }</span>
                        } else {
<span class="nc" id="L21254">                            r.choose(true);</span>
<span class="nc" id="L21255">                            vReport.add(r);</span>
                        }
                    }
                }
            }
        }

        // if they were out-of-control to start with, give them a chance to
        // regain control
<span class="nc bnc" id="L21264" title="All 2 branches missed.">        if (canRecover) {</span>
<span class="nc" id="L21265">            PilotingRollData base = e.getBasePilotingRoll();</span>
            // is our base roll impossible?
<span class="nc bnc" id="L21267" title="All 2 branches missed.">            if ((base.getValue() == TargetRoll.AUTOMATIC_FAIL)</span>
<span class="nc bnc" id="L21268" title="All 2 branches missed.">                    || (base.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
                // report something
<span class="nc" id="L21270">                r = new Report(9340);</span>
<span class="nc" id="L21271">                r.subject = e.getId();</span>
<span class="nc" id="L21272">                r.addDesc(e);</span>
<span class="nc" id="L21273">                r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L21274">                vReport.add(r);</span>
<span class="nc" id="L21275">                return vReport;</span>
            }
<span class="nc" id="L21277">            r = new Report(9345);</span>
<span class="nc" id="L21278">            r.subject = e.getId();</span>
<span class="nc" id="L21279">            r.addDesc(e);</span>
<span class="nc" id="L21280">            r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L21281">            vReport.add(r);</span>
<span class="nc" id="L21282">            int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L21283">            r = new Report(9350);</span>
<span class="nc" id="L21284">            r.subject = e.getId();</span>
<span class="nc" id="L21285">            r.add(base);</span>
<span class="nc" id="L21286">            r.add(diceRoll);</span>
<span class="nc bnc" id="L21287" title="All 2 branches missed.">            if (diceRoll &lt; base.getValue()) {</span>
<span class="nc" id="L21288">                r.choose(false);</span>
<span class="nc" id="L21289">                vReport.add(r);</span>
            } else {
<span class="nc" id="L21291">                r.choose(true);</span>
<span class="nc" id="L21292">                vReport.add(r);</span>
<span class="nc" id="L21293">                a.setOutControl(false);</span>
<span class="nc" id="L21294">                a.setOutCtrlHeat(false);</span>
<span class="nc" id="L21295">                a.setRandomMove(false);</span>
            }
        }
<span class="nc" id="L21298">        return vReport;</span>
    }

    /**
     * Inflict damage on a pilot
     *
     * @param en     The &lt;code&gt;Entity&lt;/code&gt; who's pilot gets damaged.
     * @param damage The &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    public Vector&lt;Report&gt; damageCrew(Entity en, int damage) {
<span class="nc" id="L21308">        return damageCrew(en, damage, -1);</span>
    }

    /**
     * Inflict damage on a pilot
     *
     * @param en        The &lt;code&gt;Entity&lt;/code&gt; who's pilot gets damaged.
     * @param damage    The &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param crewPos   The &lt;code&gt;int&lt;/code&gt;position of the crew member in a &lt;code&gt;MultiCrewCockpit&lt;/crew&gt;
     *                  that takes the damage. A value &lt; 0 applies the damage to all crew members.
     *                  The basic &lt;crew&gt;Crew&lt;/crew&gt; ignores this value.
     */
    public Vector&lt;Report&gt; damageCrew(Entity en, int damage, int crewPos) {
<span class="nc" id="L21321">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L21322">        Crew crew = en.getCrew();</span>
        Report r;
<span class="nc bnc" id="L21324" title="All 6 branches missed.">        if (!crew.isDead() &amp;&amp; !crew.isEjected() &amp;&amp; !crew.isDoomed()) {</span>
<span class="nc bnc" id="L21325" title="All 2 branches missed.">            for (int pos = 0; pos &lt; en.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L21326" title="All 4 branches missed.">                if (crewPos &gt;= 0</span>
<span class="nc bnc" id="L21327" title="All 2 branches missed.">                        &amp;&amp; (crewPos != pos || crew.isDead(crewPos))) {</span>
<span class="nc" id="L21328">                    continue;</span>
                }
<span class="nc bnc" id="L21330" title="All 2 branches missed.">                boolean wasPilot = crew.getCurrentPilotIndex() == pos;</span>
<span class="nc bnc" id="L21331" title="All 2 branches missed.">                boolean wasGunner = crew.getCurrentGunnerIndex() == pos;</span>
<span class="nc" id="L21332">                crew.setHits(crew.getHits(pos) + damage, pos);</span>
<span class="nc bnc" id="L21333" title="All 2 branches missed.">                if (en.isLargeCraft()) {</span>
<span class="nc" id="L21334">                    r = new Report (6028);</span>
<span class="nc" id="L21335">                    r.subject = en.getId();</span>
<span class="nc" id="L21336">                    r.indent(2);</span>
<span class="nc" id="L21337">                    r.addDesc(en);</span>
<span class="nc" id="L21338">                    r.add(damage);</span>
<span class="nc bnc" id="L21339" title="All 2 branches missed.">                    if (((Aero)en).isEjecting()) {</span>
<span class="nc" id="L21340">                        r.add(&quot;as crew depart the ship&quot;);</span>
                    } else {
                        //Blank data
<span class="nc" id="L21343">                        r.add(&quot;&quot;);</span>
                    }
<span class="nc" id="L21345">                    r.add(crew.getHits(pos));</span>
<span class="nc" id="L21346">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L21347" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits()) {</span>
<span class="nc" id="L21348">                        vDesc.addAll(resolveCrewDamage(en, damage, pos));</span>
<span class="nc bnc" id="L21349" title="All 2 branches missed.">                    } else if (!crew.isDoomed()) {</span>
<span class="nc" id="L21350">                        crew.setDoomed(true);</span>
                        //Safety. We might use this logic for large naval vessels later on
<span class="nc bnc" id="L21352" title="All 4 branches missed.">                        if (en instanceof Aero &amp;&amp; ((Aero)en).isEjecting()) {</span>
<span class="nc" id="L21353">                            vDesc.addAll(destroyEntity(en, &quot;ejection&quot;, true));</span>
<span class="nc" id="L21354">                            ((Aero)en).setEjecting(false);</span>
                        } else {
<span class="nc" id="L21356">                            vDesc.addAll(destroyEntity(en, &quot;crew casualties&quot;, true));</span>
                        }
                    }
                } else {
<span class="nc bnc" id="L21360" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits(pos)) {</span>
<span class="nc" id="L21361">                        r = new Report(6025);</span>
                    } else {
<span class="nc" id="L21363">                        r = new Report(6026);</span>
                    }
<span class="nc" id="L21365">                    r.subject = en.getId();</span>
<span class="nc" id="L21366">                    r.indent(2);</span>
<span class="nc" id="L21367">                    r.add(crew.getCrewType().getRoleName(pos));</span>
<span class="nc" id="L21368">                    r.addDesc(en);</span>
<span class="nc" id="L21369">                    r.add(crew.getName(pos));</span>
<span class="nc" id="L21370">                    r.add(damage);</span>
<span class="nc" id="L21371">                    r.add(crew.getHits(pos));</span>
<span class="nc" id="L21372">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L21373" title="All 2 branches missed.">                    if (crew.isDead(pos)) {</span>
<span class="nc" id="L21374">                        r = createCrewTakeoverReport(en, pos, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L21375" title="All 2 branches missed.">                        if (null != r) {</span>
<span class="nc" id="L21376">                            vDesc.addElement(r);</span>
                        }
                    }
<span class="nc bnc" id="L21379" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits()) {</span>
<span class="nc" id="L21380">                        vDesc.addAll(resolveCrewDamage(en, damage, pos));</span>
<span class="nc bnc" id="L21381" title="All 2 branches missed.">                    } else if (!crew.isDoomed()) {</span>
<span class="nc" id="L21382">                        crew.setDoomed(true);</span>
<span class="nc" id="L21383">                        vDesc.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                    }
                }
            }
        } else {
<span class="nc bnc" id="L21388" title="All 8 branches missed.">            boolean isPilot = (en instanceof Mech) || ((en instanceof Aero)</span>
                    &amp;&amp; !(en instanceof SmallCraft) &amp;&amp; !(en instanceof Jumpship));
<span class="nc bnc" id="L21390" title="All 4 branches missed.">            if (crew.isDead() || crew.isDoomed()) {</span>
<span class="nc bnc" id="L21391" title="All 2 branches missed.">                if (isPilot) {</span>
<span class="nc" id="L21392">                    r = new Report(6021);</span>
                } else {
<span class="nc" id="L21394">                    r = new Report(6022);</span>
                }
            } else {
<span class="nc bnc" id="L21397" title="All 2 branches missed.">                if (isPilot) {</span>
<span class="nc" id="L21398">                    r = new Report(6023);</span>
                } else {
<span class="nc" id="L21400">                    r = new Report(6024);</span>
                }
            }
<span class="nc" id="L21403">            r.subject = en.getId();</span>
<span class="nc" id="L21404">            r.addDesc(en);</span>
<span class="nc" id="L21405">            r.add(crew.getName());</span>
<span class="nc" id="L21406">            r.indent(2);</span>
<span class="nc" id="L21407">            vDesc.add(r);</span>
        }
<span class="nc bnc" id="L21409" title="All 4 branches missed.">        if (en.isAirborneVTOLorWIGE() &amp;&amp; !en.getCrew().isActive()) {</span>
<span class="nc bnc" id="L21410" title="All 2 branches missed.">            if (en instanceof LandAirMech) {</span>
<span class="nc" id="L21411">                crashAirMech(en, en.getBasePilotingRoll(), vDesc);</span>
<span class="nc bnc" id="L21412" title="All 2 branches missed.">            } else if (en instanceof Protomech) {</span>
<span class="nc" id="L21413">                vDesc.addAll(landGliderPM((Protomech)en));</span>
            }
        }
<span class="nc" id="L21416">        return vDesc;</span>
    }

    /**
     * Convenience method that fills in a report showing that a crew member of a multicrew cockpit
     * has taken over for another incapacitated crew member.
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; for the crew.
     * @param slot      The slot index of the crew member that was incapacitated.
     * @param wasPilot  Whether the crew member was the pilot before becoming incapacitated.
     * @param wasGunner Whether the crew member was the gunner before becoming incapacitated.
     * @return          A completed &lt;code&gt;Report&lt;/code&gt; if the position was assumed by another
     *                  crew members, otherwise null.
     */
    private Report createCrewTakeoverReport(Entity e, int slot, boolean wasPilot, boolean wasGunner) {
<span class="nc bnc" id="L21431" title="All 4 branches missed.">        if (wasPilot &amp;&amp; e.getCrew().getCurrentPilotIndex() != slot) {</span>
<span class="nc" id="L21432">            Report r = new Report(5560);</span>
<span class="nc" id="L21433">            r.subject = e.getId();</span>
<span class="nc" id="L21434">            r.indent(4);</span>
<span class="nc" id="L21435">            r.add(e.getCrew().getNameAndRole(e.getCrew().getCurrentPilotIndex()));</span>
<span class="nc" id="L21436">            r.add(e.getCrew().getCrewType().getRoleName(e.getCrew().getCrewType().getPilotPos()));</span>
<span class="nc" id="L21437">            r.addDesc(e);</span>
<span class="nc" id="L21438">            return r;</span>
        }
<span class="nc bnc" id="L21440" title="All 4 branches missed.">        if (wasGunner &amp;&amp; e.getCrew().getCurrentGunnerIndex() != slot) {</span>
<span class="nc" id="L21441">            Report r = new Report(5560);</span>
<span class="nc" id="L21442">            r.subject = e.getId();</span>
<span class="nc" id="L21443">            r.indent(4);</span>
<span class="nc" id="L21444">            r.add(e.getCrew().getNameAndRole(e.getCrew().getCurrentGunnerIndex()));</span>
<span class="nc" id="L21445">            r.add(e.getCrew().getCrewType().getRoleName(e.getCrew().getCrewType().getGunnerPos()));</span>
<span class="nc" id="L21446">            r.addDesc(e);</span>
<span class="nc" id="L21447">            return r;</span>
        }
<span class="nc" id="L21449">        return null;</span>
    }

    /**
     * resolves consciousness rolls for one entity
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; that took damage
     * @param damage    The &lt;code&gt;int&lt;/code&gt; damage taken by the pilot
     * @param crewPos   The &lt;code&gt;int&lt;/code&gt; index of the crew member for multi crew cockpits, ignored by
     *                  basic &lt;code&gt;crew&lt;/code&gt;
     */
    private Vector&lt;Report&gt; resolveCrewDamage(Entity e, int damage, int crewPos) {
<span class="nc" id="L21461">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L21462">        final int totalHits = e.getCrew().getHits(crewPos);</span>
<span class="nc bnc" id="L21463" title="All 4 branches missed.">        if ((e instanceof MechWarrior) || !e.isTargetable()</span>
<span class="nc bnc" id="L21464" title="All 4 branches missed.">            || !e.getCrew().isActive(crewPos) || (damage == 0)) {</span>
<span class="nc" id="L21465">            return vDesc;</span>
        }

        // no consciousness roll for pain-shunted warriors
<span class="nc bnc" id="L21469" title="All 2 branches missed.">        if (e.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L21470">            return vDesc;</span>
        }

        // no consciousness roll for capital fighter pilots or large craft crews
<span class="nc bnc" id="L21474" title="All 4 branches missed.">        if (e.isCapitalFighter() || e.isLargeCraft()) {</span>
<span class="nc" id="L21475">            return vDesc;</span>
        }

<span class="nc bnc" id="L21478" title="All 2 branches missed.">        for (int hit = (totalHits - damage) + 1; hit &lt;= totalHits; hit++) {</span>
<span class="nc" id="L21479">            int rollTarget = Compute.getConsciousnessNumber(hit);</span>
<span class="nc bnc" id="L21480" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.RPG_TOUGHNESS)) {</span>
<span class="nc" id="L21481">                rollTarget -= e.getCrew().getToughness(crewPos);</span>
            }
<span class="nc" id="L21483">            boolean edgeUsed = false;</span>
            do {
<span class="nc bnc" id="L21485" title="All 2 branches missed.">                if (edgeUsed) {</span>
<span class="nc" id="L21486">                    e.getCrew().decreaseEdge();</span>
                }
<span class="nc" id="L21488">                int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L21489" title="All 2 branches missed.">                if (e.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)) {</span>
<span class="nc" id="L21490">                    roll = Math.min(12, roll + 1);</span>
                }
<span class="nc" id="L21492">                Report r = new Report(6030);</span>
<span class="nc" id="L21493">                r.indent(2);</span>
<span class="nc" id="L21494">                r.subject = e.getId();</span>
<span class="nc" id="L21495">                r.add(e.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L21496">                r.addDesc(e);</span>
<span class="nc" id="L21497">                r.add(e.getCrew().getName(crewPos));</span>
<span class="nc" id="L21498">                r.add(rollTarget);</span>
<span class="nc" id="L21499">                r.add(roll);</span>
<span class="nc bnc" id="L21500" title="All 2 branches missed.">                if (roll &gt;= rollTarget) {</span>
<span class="nc" id="L21501">                    e.getCrew().setKoThisRound(false, crewPos);</span>
<span class="nc" id="L21502">                    r.choose(true);</span>
                } else {
<span class="nc" id="L21504">                    e.getCrew().setKoThisRound(true, crewPos);</span>
<span class="nc" id="L21505">                    r.choose(false);</span>
<span class="nc bnc" id="L21506" title="All 2 branches missed.">                    if (e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21507" title="All 2 branches missed.">                            &amp;&amp; (e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_KO)</span>
<span class="nc bnc" id="L21508" title="All 2 branches missed.">                            || e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_KO))) {</span>
<span class="nc" id="L21509">                        edgeUsed = true;</span>
<span class="nc" id="L21510">                        vDesc.add(r);</span>
<span class="nc" id="L21511">                        r = new Report(6520);</span>
<span class="nc" id="L21512">                        r.subject = e.getId();</span>
<span class="nc" id="L21513">                        r.addDesc(e);</span>
<span class="nc" id="L21514">                        r.add(e.getCrew().getName(crewPos));</span>
<span class="nc" id="L21515">                        r.add(e.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
                    } // if
                    // return true;
                } // else
<span class="nc" id="L21519">                vDesc.add(r);</span>
<span class="nc bnc" id="L21520" title="All 2 branches missed.">            } while (e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21521" title="All 2 branches missed.">                     &amp;&amp; e.getCrew().isKoThisRound(crewPos)</span>
<span class="nc bnc" id="L21522" title="All 2 branches missed.">                     &amp;&amp; (e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_KO)</span>
<span class="nc bnc" id="L21523" title="All 2 branches missed.">                         || e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_KO)));</span>
            // end of do-while
<span class="nc bnc" id="L21525" title="All 2 branches missed.">            if (e.getCrew().isKoThisRound(crewPos)) {</span>
<span class="nc bnc" id="L21526" title="All 2 branches missed.">                boolean wasPilot = e.getCrew().getCurrentPilotIndex() == crewPos;</span>
<span class="nc bnc" id="L21527" title="All 2 branches missed.">                boolean wasGunner = e.getCrew().getCurrentGunnerIndex() == crewPos;</span>
<span class="nc" id="L21528">                e.getCrew().setUnconscious(true, crewPos);</span>
<span class="nc" id="L21529">                Report r = createCrewTakeoverReport(e, crewPos, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L21530" title="All 2 branches missed.">                if (null != r) {</span>
<span class="nc" id="L21531">                    vDesc.add(r);</span>
                }
<span class="nc" id="L21533">                return vDesc;</span>
            }
        }
<span class="nc" id="L21536">        return vDesc;</span>
    }

    /**
     * Make the rolls indicating whether any unconscious crews wake up
     */
    private void resolveCrewWakeUp() {
<span class="nc bnc" id="L21543" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21544">            final Entity e = i.next();</span>

            // only unconscious pilots of mechs and protos, ASF and Small Craft
            // and MechWarriors can roll to wake up
<span class="nc bnc" id="L21548" title="All 12 branches missed.">            if (e.isTargetable()</span>
                    &amp;&amp; ((e instanceof Mech) || (e instanceof Protomech)
                            || (e instanceof MechWarrior) || ((e instanceof Aero) &amp;&amp; !(e instanceof Jumpship)))) {
<span class="nc bnc" id="L21551" title="All 2 branches missed.">                for (int pos = 0; pos &lt; e.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L21552" title="All 2 branches missed.">                    if (e.getCrew().isMissing(pos)) {</span>
<span class="nc" id="L21553">                        continue;</span>
                    }
<span class="nc bnc" id="L21555" title="All 2 branches missed.">                    if (e.getCrew().isUnconscious(pos)</span>
<span class="nc bnc" id="L21556" title="All 2 branches missed.">                            &amp;&amp; !e.getCrew().isKoThisRound(pos)) {</span>
<span class="nc" id="L21557">                        int roll = Compute.d6(2);</span>

<span class="nc bnc" id="L21559" title="All 2 branches missed.">                        if (e.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)) {</span>
<span class="nc" id="L21560">                            roll = Math.min(12, roll + 1);</span>
                        }

<span class="nc" id="L21563">                        int rollTarget = Compute.getConsciousnessNumber(e.getCrew()</span>
<span class="nc" id="L21564">                                                                         .getHits(pos));</span>
<span class="nc" id="L21565">                        Report r = new Report(6029);</span>
<span class="nc" id="L21566">                        r.subject = e.getId();</span>
<span class="nc" id="L21567">                        r.add(e.getCrew().getCrewType().getRoleName(pos));</span>
<span class="nc" id="L21568">                        r.addDesc(e);</span>
<span class="nc" id="L21569">                        r.add(e.getCrew().getName(pos));</span>
<span class="nc" id="L21570">                        r.add(rollTarget);</span>
<span class="nc" id="L21571">                        r.add(roll);</span>
<span class="nc bnc" id="L21572" title="All 2 branches missed.">                        if (roll &gt;= rollTarget) {</span>
<span class="nc" id="L21573">                            r.choose(true);</span>
<span class="nc" id="L21574">                            e.getCrew().setUnconscious(false, pos);</span>
                        } else {
<span class="nc" id="L21576">                            r.choose(false);</span>
                        }
<span class="nc" id="L21578">                        addReport(r);</span>
                    }
                }
            }
<span class="nc" id="L21582">        }</span>
<span class="nc" id="L21583">    }</span>

    /**
     * Check whether any &lt;code&gt;Entity&lt;/code&gt; with a cockpit command console has been scheduled to swap
     * roles between the two crew members.
     */
    private void resolveConsoleCrewSwaps() {
<span class="nc bnc" id="L21590" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21591">            final Entity e = i.next();</span>
<span class="nc bnc" id="L21592" title="All 2 branches missed.">            if (e.getCrew().doConsoleRoleSwap()) {</span>
<span class="nc" id="L21593">                final Crew crew = e.getCrew();</span>
<span class="nc" id="L21594">                final int current = crew.getCurrentPilotIndex();</span>
<span class="nc" id="L21595">                Report r = new Report(5560);</span>
<span class="nc" id="L21596">                r.subject = e.getId();</span>
<span class="nc" id="L21597">                r.add(crew.getNameAndRole(current));</span>
<span class="nc" id="L21598">                r.add(crew.getCrewType().getRoleName(0));</span>
<span class="nc" id="L21599">                r.addDesc(e);</span>
<span class="nc" id="L21600">                addReport(r);</span>
            }
<span class="nc" id="L21602">        }</span>
<span class="nc" id="L21603">    }</span>

    /*
     * Resolve any outstanding self destructions...
     */
    private void resolveSelfDestruct() {
<span class="nc bnc" id="L21609" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L21610" title="All 2 branches missed.">            if (e.getSelfDestructing()) {</span>
<span class="nc" id="L21611">                e.setSelfDestructing(false);</span>
<span class="nc" id="L21612">                e.setSelfDestructInitiated(true);</span>
<span class="nc" id="L21613">                Report r = new Report(5535, Report.PUBLIC);</span>
<span class="nc" id="L21614">                r.subject = e.getId();</span>
<span class="nc" id="L21615">                r.addDesc(e);</span>
<span class="nc" id="L21616">                addReport(r);</span>
            }
<span class="nc" id="L21618">        }</span>
<span class="nc" id="L21619">    }</span>

    /*
     * Resolve any outstanding crashes from shutting down and being airborne
     * VTOL or WiGE...
     */
    private void resolveShutdownCrashes() {
<span class="nc bnc" id="L21626" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L21627" title="All 4 branches missed.">            if (e.isShutDown() &amp;&amp; e.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L21628" title="All 4 branches missed.">                &amp;&amp; !(e.isDestroyed() || e.isDoomed())) {</span>
<span class="nc" id="L21629">                Tank t = (Tank) e;</span>
<span class="nc" id="L21630">                t.immobilize();</span>
<span class="nc" id="L21631">                addReport(forceLandVTOLorWiGE(t));</span>
            }
<span class="nc" id="L21633">        }</span>
<span class="nc" id="L21634">    }</span>

    /**
     * Resolve any potential fatal damage to Capital Fighter after each
     * individual attacker is finished
     */
    private Vector&lt;Report&gt; checkFatalThresholds(int nextAE, int prevAE) {
<span class="nc" id="L21641">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L21642" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext();) {</span>
<span class="nc" id="L21643">            Entity en = e.next();</span>
<span class="nc bnc" id="L21644" title="All 4 branches missed.">            if (!en.isCapitalFighter() || (nextAE == Entity.NONE)) {</span>
<span class="nc" id="L21645">                continue;</span>
            }
<span class="nc" id="L21647">            IAero ship = (IAero) en;</span>
<span class="nc" id="L21648">            int damage = ship.getCurrentDamage();</span>
<span class="nc" id="L21649">            double divisor = 2.0;</span>
<span class="nc bnc" id="L21650" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21651">                divisor = 20.0;</span>
            }
<span class="nc bnc" id="L21653" title="All 2 branches missed.">            if (damage &gt;= ship.getFatalThresh()) {</span>
<span class="nc" id="L21654">                int roll = Compute.d6(2)</span>
<span class="nc" id="L21655">                        + (int) Math.floor((damage - ship.getFatalThresh())</span>
                                / divisor);
<span class="nc bnc" id="L21657" title="All 2 branches missed.">                if (roll &gt; 9) {</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L21659" title="All 2 branches missed.">                    if (ship instanceof LandAirMech) {</span>
                        // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L21661">                        LandAirMech lam = (LandAirMech) ship;</span>
<span class="nc bnc" id="L21662" title="All 2 branches missed.">                        if (lam.isAutoEject()</span>
<span class="nc bnc" id="L21663" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21664" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21665" title="All 2 branches missed.">                                            &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L21666">                            addReport(ejectEntity(en, true, false));</span>
                        }
<span class="nc" id="L21668">                    } else {</span>
                        // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L21670">                        Aero aero = (Aero) ship;</span>
<span class="nc bnc" id="L21671" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L21672" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21673" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21674" title="All 2 branches missed.">                                            &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L21675">                            addReport(ejectEntity(en, true, false));</span>
                        }
                    }
<span class="nc" id="L21678">                    vDesc.addAll(destroyEntity((Entity)ship, &quot;fatal damage threshold&quot;));</span>
<span class="nc" id="L21679">                    ship.doDisbandDamage();</span>
<span class="nc bnc" id="L21680" title="All 2 branches missed.">                    if (prevAE != Entity.NONE) {</span>
<span class="nc" id="L21681">                        creditKill(en, game.getEntity(prevAE));</span>
                    }
                }
            }
<span class="nc" id="L21685">            ship.setCurrentDamage(0);</span>
<span class="nc" id="L21686">        }</span>
<span class="nc" id="L21687">        return vDesc;</span>
    }

    /**
     * damage an Entity
     *
     * @param te            the &lt;code&gt;Entity&lt;/code&gt; to be damaged
     * @param hit           the corresponding &lt;code&gt;HitData&lt;/code&gt;
     * @param damage        the &lt;code&gt;int&lt;/code&gt; amount of damage
     * @param ammoExplosion a &lt;code&gt;boolean&lt;/code&gt; indicating if this is an ammo explosion
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    private Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                        boolean ammoExplosion) {
<span class="nc" id="L21701">        return damageEntity(te, hit, damage, ammoExplosion, DamageType.NONE,</span>
                            false, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te     the target entity
     * @param hit    the hit data for the location hit
     * @param damage the damage to apply
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage) {
<span class="nc" id="L21715">        return damageEntity(te, hit, damage, false, DamageType.NONE, false,</span>
                            false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                       boolean ammoExplosion, DamageType bFrag, boolean damageIS) {
<span class="nc" id="L21736">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                        boolean ammoExplosion, DamageType bFrag, boolean damageIS,
                                        boolean areaSatArty) {
<span class="nc" id="L21759">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, true);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                       boolean ammoExplosion, DamageType bFrag, boolean damageIS,
                                       boolean areaSatArty, boolean throughFront) {
<span class="nc" id="L21783">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, throughFront, false, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @param underWater    Is the damage coming from an underwater attack
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
            boolean ammoExplosion, DamageType bFrag, boolean damageIS,
            boolean areaSatArty, boolean throughFront, boolean underWater) {
<span class="nc" id="L21808">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, throughFront, underWater, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @param underWater    Is the damage coming from an underwater attack?
     * @param nukeS2S       is this a ship-to-ship nuke?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
            boolean ammoExplosion, DamageType bFrag, boolean damageIS,
            boolean areaSatArty, boolean throughFront, boolean underWater,
            boolean nukeS2S) {

<span class="nc" id="L21836">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L21838">        int te_n = te.getId();</span>

        // if this is a fighter squadron then pick an active fighter and pass on
        // the damage
<span class="nc bnc" id="L21842" title="All 2 branches missed.">        if (te instanceof FighterSquadron) {</span>
<span class="nc bnc" id="L21843" title="All 2 branches missed.">            if(te.getActiveSubEntities().orElse(Collections.emptyList()).isEmpty()) {</span>
<span class="nc" id="L21844">                return vDesc;</span>
            }
<span class="nc" id="L21846">            List&lt;Entity&gt; fighters = te.getSubEntities().orElse(Collections.emptyList());</span>
<span class="nc" id="L21847">            Entity fighter = fighters.get(hit.getLocation());</span>
<span class="nc" id="L21848">            HitData new_hit = fighter.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L21849">            new_hit.setBoxCars(hit.rolledBoxCars());</span>
<span class="nc" id="L21850">            new_hit.setGeneralDamageType(hit.getGeneralDamageType());</span>
<span class="nc" id="L21851">            new_hit.setCapital(hit.isCapital());</span>
<span class="nc" id="L21852">            new_hit.setCapMisCritMod(hit.getCapMisCritMod());</span>
<span class="nc" id="L21853">            new_hit.setSingleAV(hit.getSingleAV());</span>
<span class="nc" id="L21854">            new_hit.setAttackerId(hit.getAttackerId());</span>
<span class="nc" id="L21855">            return damageEntity(fighter, new_hit, damage, ammoExplosion, bFrag,</span>
                                damageIS, areaSatArty, throughFront, underWater, nukeS2S);
        }

        // Battle Armor takes full damage to each trooper from area-effect.
<span class="nc bnc" id="L21860" title="All 4 branches missed.">        if (areaSatArty &amp;&amp; (te instanceof BattleArmor)) {</span>
<span class="nc" id="L21861">            r = new Report(6044);</span>
<span class="nc" id="L21862">            r.subject = te.getId();</span>
<span class="nc" id="L21863">            r.indent(2);</span>
<span class="nc" id="L21864">            vDesc.add(r);</span>
<span class="nc bnc" id="L21865" title="All 2 branches missed.">            for (int i = 0; i &lt; ((BattleArmor) te).getTroopers(); i++) {</span>
<span class="nc" id="L21866">                hit.setLocation(BattleArmor.LOC_TROOPER_1 + i);</span>
<span class="nc bnc" id="L21867" title="All 2 branches missed.">                if (te.getInternal(hit) &gt; 0) {</span>
<span class="nc" id="L21868">                    vDesc.addAll(damageEntity(te, hit, damage, ammoExplosion, bFrag,</span>
                            damageIS, false, throughFront, underWater, nukeS2S));
                }
            }
<span class="nc" id="L21872">            return vDesc;</span>
        }

        // This is good for shields if a shield absorps the hit it shouldn't
        // effect the pilot.
        // TC SRM's that hit the head do external and internal damage but its
        // one hit and shouldn't cause
        // 2 hits to the pilot.
<span class="nc bnc" id="L21880" title="All 2 branches missed.">        boolean isHeadHit = (te instanceof Mech)</span>
<span class="nc bnc" id="L21881" title="All 2 branches missed.">                            &amp;&amp; (((Mech) te).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L21882" title="All 2 branches missed.">                            &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L21883" title="All 2 branches missed.">                            &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS);</span>

        // booleans to indicate criticals for AT2
<span class="nc" id="L21886">        boolean critSI = false;</span>
<span class="nc" id="L21887">        boolean critThresh = false;</span>

        // get the relevant damage for damage thresholding
<span class="nc" id="L21890">        int threshDamage = damage;</span>
        // weapon groups only get the damage of one weapon
<span class="nc bnc" id="L21892" title="All 2 branches missed.">        if ((hit.getSingleAV() &gt; -1)</span>
<span class="nc bnc" id="L21893" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21894">            threshDamage = hit.getSingleAV();</span>
        }

        // is this capital-scale damage
<span class="nc" id="L21898">        boolean isCapital = hit.isCapital();</span>

        // check capital/standard damage
<span class="nc bnc" id="L21901" title="All 2 branches missed.">        if (isCapital</span>
<span class="nc bnc" id="L21902" title="All 4 branches missed.">            &amp;&amp; (!te.isCapitalScale() || game.getOptions().booleanOption(</span>
                OptionsConstants.ADVAERORULES_AERO_SANITY))) {
<span class="nc" id="L21904">            damage = 10 * damage;</span>
<span class="nc" id="L21905">            threshDamage = 10 * threshDamage;</span>
        }
<span class="nc bnc" id="L21907" title="All 4 branches missed.">        if (!isCapital &amp;&amp; te.isCapitalScale()</span>
<span class="nc bnc" id="L21908" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21909">            damage = (int) Math.round(damage / 10.0);</span>
<span class="nc" id="L21910">            threshDamage = (int) Math.round(threshDamage / 10.0);</span>
        }

<span class="nc" id="L21913">        int damage_orig = damage;</span>

        // show Locations which have rerolled with Edge
<span class="nc" id="L21916">        HitData undoneLocation = hit.getUndoneLocation();</span>
<span class="nc bnc" id="L21917" title="All 2 branches missed.">        while (undoneLocation != null) {</span>
<span class="nc" id="L21918">            r = new Report(6500);</span>
<span class="nc" id="L21919">            r.subject = te_n;</span>
<span class="nc" id="L21920">            r.indent(2);</span>
<span class="nc" id="L21921">            r.addDesc(te);</span>
<span class="nc" id="L21922">            r.add(te.getLocationAbbr(undoneLocation));</span>
<span class="nc" id="L21923">            vDesc.addElement(r);</span>
<span class="nc" id="L21924">            undoneLocation = undoneLocation.getUndoneLocation();</span>
        } // while
        // if edge was uses, give at end overview of remaining
<span class="nc bnc" id="L21927" title="All 2 branches missed.">        if (hit.getUndoneLocation() != null) {</span>
<span class="nc" id="L21928">            r = new Report(6510);</span>
<span class="nc" id="L21929">            r.subject = te_n;</span>
<span class="nc" id="L21930">            r.indent(2);</span>
<span class="nc" id="L21931">            r.addDesc(te);</span>
<span class="nc" id="L21932">            r.add(te.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L21933">            vDesc.addElement(r);</span>
        } // if

<span class="nc" id="L21936">        boolean autoEject = false;</span>
<span class="nc bnc" id="L21937" title="All 2 branches missed.">        if (ammoExplosion) {</span>
<span class="nc bnc" id="L21938" title="All 2 branches missed.">            if (te instanceof Mech) {</span>
<span class="nc" id="L21939">                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L21940" title="All 4 branches missed.">                if (mech.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21941" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21942" title="All 2 branches missed.">                                &amp;&amp; mech.isCondEjectAmmo()))) {</span>
<span class="nc" id="L21943">                    autoEject = true;</span>
<span class="nc" id="L21944">                    vDesc.addAll(ejectEntity(te, true));</span>
                }
<span class="nc bnc" id="L21946" title="All 2 branches missed.">            } else if (te instanceof Aero) {</span>
<span class="nc" id="L21947">                Aero aero = (Aero) te;</span>
<span class="nc bnc" id="L21948" title="All 4 branches missed.">                if (aero.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21949" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21950" title="All 2 branches missed.">                                &amp;&amp; aero.isCondEjectAmmo()))) {</span>
<span class="nc" id="L21951">                    autoEject = true;</span>
<span class="nc" id="L21952">                    vDesc.addAll(ejectEntity(te, true));</span>
                }
            }
        }
<span class="nc" id="L21956">        boolean isBattleArmor = te instanceof BattleArmor;</span>
<span class="nc bnc" id="L21957" title="All 4 branches missed.">        boolean isPlatoon = !isBattleArmor &amp;&amp; (te instanceof Infantry);</span>
<span class="nc" id="L21958">        boolean isFerroFibrousTarget = false;</span>
<span class="nc" id="L21959">        boolean wasDamageIS = false;</span>
<span class="nc" id="L21960">        boolean tookInternalDamage = damageIS;</span>
<span class="nc" id="L21961">        IHex te_hex = null;</span>

<span class="nc bnc" id="L21963" title="All 4 branches missed.">        boolean hardenedArmor = ((te instanceof Mech) || (te instanceof Tank))</span>
<span class="nc bnc" id="L21964" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED);</span>
<span class="nc bnc" id="L21965" title="All 6 branches missed.">        boolean ferroLamellorArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21966" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_LAMELLOR);</span>
<span class="nc bnc" id="L21967" title="All 6 branches missed.">        boolean reflectiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21968" title="All 4 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REFLECTIVE))</span>
<span class="nc bnc" id="L21969" title="All 2 branches missed.">                || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REFLECTIVE));</span>
<span class="nc bnc" id="L21970" title="All 6 branches missed.">        boolean reactiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21971" title="All 4 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REACTIVE))</span>
<span class="nc bnc" id="L21972" title="All 2 branches missed.">                || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REACTIVE));</span>
<span class="nc bnc" id="L21973" title="All 6 branches missed.">        boolean ballisticArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21974" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BALLISTIC_REINFORCED);</span>
<span class="nc bnc" id="L21975" title="All 2 branches missed.">        boolean impactArmor = (te instanceof Mech)</span>
<span class="nc bnc" id="L21976" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_IMPACT_RESISTANT);</span>
<span class="nc bnc" id="L21977" title="All 2 branches missed.">        boolean bar5 = te.getBARRating(hit.getLocation()) &lt;= 5;</span>

        // TACs from the hit location table
        int crits;
<span class="nc bnc" id="L21981" title="All 2 branches missed.">        if ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == HitData.EFFECT_CRITICAL) {</span>
<span class="nc" id="L21982">            crits = 1;</span>
        } else {
<span class="nc" id="L21984">            crits = 0;</span>
        }

        // this is for special crits, like AP and tandem-charge
<span class="nc" id="L21988">        int specCrits = 0;</span>

        // the bonus to the crit roll if using the
        // &quot;advanced determining critical hits rule&quot;
<span class="nc" id="L21992">        int critBonus = 0;</span>
<span class="nc bnc" id="L21993" title="All 8 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CRIT_ROLL)</span>
            &amp;&amp; (damage_orig &gt; 0)
            &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))) {
<span class="nc" id="L21996">            critBonus = Math.min((damage_orig - 1) / 5, 4);</span>
        }

        // Find out if Human TRO plays a part it crit bonus
<span class="nc" id="L22000">        Entity ae = game.getEntity(hit.getAttackerId());</span>
<span class="nc bnc" id="L22001" title="All 4 branches missed.">        if ((ae != null) &amp;&amp; !areaSatArty) {</span>
<span class="nc bnc" id="L22002" title="All 4 branches missed.">            if ((te instanceof Mech) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_MECH)) {</span>
<span class="nc" id="L22003">                critBonus += 1;</span>
<span class="nc bnc" id="L22004" title="All 4 branches missed.">            } else if ((te instanceof Aero) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_AERO)) {</span>
<span class="nc" id="L22005">                critBonus += 1;</span>
<span class="nc bnc" id="L22006" title="All 4 branches missed.">            } else if ((te instanceof Tank) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_VEE)) {</span>
<span class="nc" id="L22007">                critBonus += 1;</span>
<span class="nc bnc" id="L22008" title="All 4 branches missed.">            } else if ((te instanceof BattleArmor) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_BA)) {</span>
<span class="nc" id="L22009">                critBonus += 1;</span>
            }
        }

<span class="nc" id="L22013">        HitData nextHit = null;</span>

        // Some &quot;hits&quot; on a ProtoMech are actually misses.
<span class="nc bnc" id="L22016" title="All 4 branches missed.">        if ((te instanceof Protomech) &amp;&amp; (hit.getLocation() == Protomech.LOC_NMISS)) {</span>
<span class="nc" id="L22017">            Protomech proto = (Protomech) te;</span>
<span class="nc" id="L22018">            r = new Report(6035);</span>
<span class="nc" id="L22019">            r.subject = te.getId();</span>
<span class="nc" id="L22020">            r.indent(2);</span>
<span class="nc bnc" id="L22021" title="All 2 branches missed.">            if (proto.isGlider()) {</span>
<span class="nc" id="L22022">                r.messageId = 6036;</span>
<span class="nc" id="L22023">                proto.setWingHits(proto.getWingHits() + 1);</span>
            }
<span class="nc" id="L22025">            vDesc.add(r);</span>
<span class="nc" id="L22026">            return vDesc;</span>
        }

        // check for critical hit/miss vs. a BA
<span class="nc bnc" id="L22030" title="All 4 branches missed.">        if ((crits &gt; 0) &amp;&amp; (te instanceof BattleArmor)) {</span>
            // possible critical miss if the rerolled location isn't alive
<span class="nc bnc" id="L22032" title="All 4 branches missed.">            if ((hit.getLocation() &gt;= te.locations()) || (te.getInternal(hit.getLocation()) &lt;= 0)) {</span>
<span class="nc" id="L22033">                r = new Report(6037);</span>
<span class="nc" id="L22034">                r.add(hit.getLocation());</span>
<span class="nc" id="L22035">                r.subject = te_n;</span>
<span class="nc" id="L22036">                r.indent(2);</span>
<span class="nc" id="L22037">                vDesc.addElement(r);</span>
<span class="nc" id="L22038">                return vDesc;</span>
            }
            // otherwise critical hit
<span class="nc" id="L22041">            r = new Report(6225);</span>
<span class="nc" id="L22042">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L22043">            r.subject = te_n;</span>
<span class="nc" id="L22044">            r.indent(2);</span>
<span class="nc" id="L22045">            vDesc.addElement(r);</span>

<span class="nc" id="L22047">            crits = 0;</span>
<span class="nc" id="L22048">            damage = Math.max(te.getInternal(hit.getLocation()) + te.getArmor(hit.getLocation()), damage);</span>
        }

<span class="nc bnc" id="L22051" title="All 4 branches missed.">        if ((te.getArmor(hit) &gt; 0) &amp;&amp; ((te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_FIBROUS)</span>
<span class="nc bnc" id="L22052" title="All 2 branches missed.">                || (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_LIGHT_FERRO)</span>
<span class="nc bnc" id="L22053" title="All 2 branches missed.">                || (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HEAVY_FERRO))) {</span>
<span class="nc" id="L22054">            isFerroFibrousTarget = true;</span>
        }

        // area effect against infantry is double damage
<span class="nc bnc" id="L22058" title="All 4 branches missed.">        if (isPlatoon &amp;&amp; areaSatArty) {</span>
            // PBI. Double damage.
<span class="nc" id="L22060">            damage *= 2;</span>
<span class="nc" id="L22061">            r = new Report(6039);</span>
<span class="nc" id="L22062">            r.subject = te_n;</span>
<span class="nc" id="L22063">            r.indent(2);</span>
<span class="nc" id="L22064">            vDesc.addElement(r);</span>
        }

        // Is the infantry in the open?
<span class="nc bnc" id="L22068" title="All 2 branches missed.">        if(ServerHelper.infantryInOpen(te, te_hex, game, isPlatoon, ammoExplosion, hit.isIgnoreInfantryDoubleDamage())) {</span>
            // PBI. Damage is doubled.
<span class="nc" id="L22070">            damage *= 2;</span>
<span class="nc" id="L22071">            r = new Report(6040);</span>
<span class="nc" id="L22072">            r.subject = te_n;</span>
<span class="nc" id="L22073">            r.indent(2);</span>
<span class="nc" id="L22074">            vDesc.addElement(r);</span>
        }

        // Is the infantry in vacuum?
<span class="nc bnc" id="L22078" title="All 8 branches missed.">        if ((isPlatoon || isBattleArmor) &amp;&amp; !te.isDestroyed() &amp;&amp; !te.isDoomed()</span>
<span class="nc bnc" id="L22079" title="All 2 branches missed.">            &amp;&amp; game.getPlanetaryConditions().isVacuum()) {</span>
            // PBI. Double damage.
<span class="nc" id="L22081">            damage *= 2;</span>
<span class="nc" id="L22082">            r = new Report(6041);</span>
<span class="nc" id="L22083">            r.subject = te_n;</span>
<span class="nc" id="L22084">            r.indent(2);</span>
<span class="nc" id="L22085">            vDesc.addElement(r);</span>
        }
        // If dealing with fragmentation missiles,
        // it does double damage to infantry...
        // We're actually going to abuse this for AX-head warheads, too, so as
        // to not add another parameter.
<span class="nc bnc" id="L22091" title="All 8 branches missed.">        switch (bFrag) {</span>
            case FRAGMENTATION:
                // Fragmentation missiles deal full damage to conventional
                // infantry
                // (only) and no damage to other target types.
<span class="nc bnc" id="L22096" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22097">                    damage = 0;</span>
<span class="nc" id="L22098">                    r = new Report(6050); // For some reason this report never</span>
                    // actually shows up...
<span class="nc" id="L22100">                    r.subject = te_n;</span>
<span class="nc" id="L22101">                    r.indent(2);</span>
<span class="nc" id="L22102">                    vDesc.addElement(r);</span>
                } else {
<span class="nc" id="L22104">                    r = new Report(6045); // ...but this one displays just fine.</span>
<span class="nc" id="L22105">                    r.subject = te_n;</span>
<span class="nc" id="L22106">                    r.indent(2);</span>
<span class="nc" id="L22107">                    vDesc.addElement(r);</span>
                }
<span class="nc" id="L22109">                break;</span>
            case NONPENETRATING:
<span class="nc bnc" id="L22111" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22112">                    damage = 0;</span>
<span class="nc" id="L22113">                    r = new Report(6051);</span>
<span class="nc" id="L22114">                    r.subject = te_n;</span>
<span class="nc" id="L22115">                    r.indent(2);</span>
<span class="nc" id="L22116">                    vDesc.addElement(r);</span>
                }
                break;
            case FLECHETTE:
                // Flechette ammo deals full damage to conventional infantry and
                // half damage to other targets (including battle armor).
<span class="nc bnc" id="L22122" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22123">                    damage /= 2;</span>
<span class="nc" id="L22124">                    r = new Report(6060);</span>
<span class="nc" id="L22125">                    r.subject = te_n;</span>
<span class="nc" id="L22126">                    r.indent(2);</span>
<span class="nc" id="L22127">                    vDesc.addElement(r);</span>
                } else {
<span class="nc" id="L22129">                    r = new Report(6055);</span>
<span class="nc" id="L22130">                    r.subject = te_n;</span>
<span class="nc" id="L22131">                    r.indent(2);</span>
<span class="nc" id="L22132">                    vDesc.addElement(r);</span>
                }
<span class="nc" id="L22134">                break;</span>
            case ACID:
<span class="nc bnc" id="L22136" title="All 10 branches missed.">                if (isFerroFibrousTarget || reactiveArmor || reflectiveArmor</span>
                    || ferroLamellorArmor || bar5) {
<span class="nc bnc" id="L22138" title="All 2 branches missed.">                    if (te.getArmor(hit) &lt;= 0) {</span>
<span class="nc" id="L22139">                        break; // hitting IS, not acid-affected armor</span>
                    }
<span class="nc" id="L22141">                    damage = Math.min(te.getArmor(hit), 3);</span>
<span class="nc" id="L22142">                    r = new Report(6061);</span>
<span class="nc" id="L22143">                    r.subject = te_n;</span>
<span class="nc" id="L22144">                    r.indent(2);</span>
<span class="nc" id="L22145">                    r.add(damage);</span>
<span class="nc" id="L22146">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22147" title="All 2 branches missed.">                } else if (isPlatoon) {</span>
<span class="nc" id="L22148">                    damage = (int) Math.ceil(damage * 1.5);</span>
<span class="nc" id="L22149">                    r = new Report(6062);</span>
<span class="nc" id="L22150">                    r.subject = te_n;</span>
<span class="nc" id="L22151">                    r.indent(2);</span>
<span class="nc" id="L22152">                    vDesc.addElement(r);</span>
                }
                break;
            case INCENDIARY:
                // Incendiary AC ammo does +2 damage to unarmoured infantry
<span class="nc bnc" id="L22157" title="All 2 branches missed.">                if (isPlatoon) {</span>
<span class="nc" id="L22158">                    damage += 2;</span>
<span class="nc" id="L22159">                    r = new Report(6064);</span>
<span class="nc" id="L22160">                    r.subject = te_n;</span>
<span class="nc" id="L22161">                    r.indent(2);</span>
<span class="nc" id="L22162">                    vDesc.addElement(r);</span>
                }
                break;
            case ANTI_TSM:
<span class="nc" id="L22166">                te.hitThisRoundByAntiTSM = true;</span>
<span class="nc" id="L22167">                break;</span>
            case NAIL_RIVET:
                // no damage against armor of BAR rating &gt;=5
<span class="nc bnc" id="L22170" title="All 2 branches missed.">                if ((te.getBARRating(hit.getLocation()) &gt;= 5)</span>
<span class="nc bnc" id="L22171" title="All 2 branches missed.">                    &amp;&amp; (te.getArmor(hit.getLocation()) &gt; 0)) {</span>
<span class="nc" id="L22172">                    damage = 0;</span>
<span class="nc" id="L22173">                    r = new Report(6063);</span>
<span class="nc" id="L22174">                    r.subject = te_n;</span>
<span class="nc" id="L22175">                    r.indent(2);</span>
<span class="nc" id="L22176">                    vDesc.add(r);</span>
                }
                break;
            default:
                // We can ignore this.
                break;
        }

        // adjust VTOL rotor damage
<span class="nc bnc" id="L22185" title="All 4 branches missed.">        if ((te instanceof VTOL) &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L22186" title="All 2 branches missed.">            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_PHYSICAL)</span>
<span class="nc bnc" id="L22187" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_FULL_ROTOR_HITS)) {</span>
<span class="nc" id="L22188">            damage = (damage + 9) / 10;</span>
        }

        // save EI status, in case sensors crit destroys it
<span class="nc" id="L22192">        final boolean eiStatus = te.hasActiveEiCockpit();</span>
        // BA using EI implants receive +1 damage from attacks
<span class="nc bnc" id="L22194" title="All 6 branches missed.">        if (!(te instanceof Mech) &amp;&amp; !(te instanceof Protomech) &amp;&amp; eiStatus) {</span>
<span class="nc" id="L22195">            damage += 1;</span>
        }

        // check for case on Aeros
<span class="nc bnc" id="L22199" title="All 2 branches missed.">        if (te instanceof Aero) {</span>
<span class="nc" id="L22200">            Aero a = (Aero) te;</span>
<span class="nc bnc" id="L22201" title="All 4 branches missed.">            if (ammoExplosion &amp;&amp; a.hasCase()) {</span>
                // damage should be reduced by a factor of 2 for ammo explosions
                // according to p. 161, TW
<span class="nc" id="L22204">                damage /= 2;</span>
<span class="nc" id="L22205">                r = new Report(9010);</span>
<span class="nc" id="L22206">                r.subject = te_n;</span>
<span class="nc" id="L22207">                r.add(damage);</span>
<span class="nc" id="L22208">                r.indent(3);</span>
<span class="nc" id="L22209">                vDesc.addElement(r);</span>
            }
        }

        // infantry armor can reduce damage
<span class="nc bnc" id="L22214" title="All 4 branches missed.">        if (isPlatoon &amp;&amp; (((Infantry) te).calcDamageDivisor() != 1.0)) {</span>
<span class="nc" id="L22215">            r = new Report(6074);</span>
<span class="nc" id="L22216">            r.subject = te_n;</span>
<span class="nc" id="L22217">            r.indent(2);</span>
<span class="nc" id="L22218">            r.add(damage);</span>
<span class="nc" id="L22219">            damage = (int) Math.ceil((damage) / ((Infantry) te).calcDamageDivisor());</span>
<span class="nc" id="L22220">            r.add(damage);</span>
<span class="nc" id="L22221">            vDesc.addElement(r);</span>
        }

        // Allocate the damage
<span class="nc bnc" id="L22225" title="All 2 branches missed.">        while (damage &gt; 0) {</span>

            // first check for ammo explosions on aeros separately, because it
            // must be done before
            // standard to capital damage conversions
<span class="nc bnc" id="L22230" title="All 6 branches missed.">            if ((te instanceof Aero) &amp;&amp; (hit.getLocation() == Aero.LOC_AFT)</span>
                &amp;&amp; !damageIS) {
<span class="nc bnc" id="L22232" title="All 2 branches missed.">                for (Mounted mAmmo : te.getAmmo()) {</span>
<span class="nc bnc" id="L22233" title="All 6 branches missed.">                    if (mAmmo.isDumping() &amp;&amp; !mAmmo.isDestroyed() &amp;&amp; !mAmmo.isHit()</span>
<span class="nc bnc" id="L22234" title="All 2 branches missed.">                            &amp;&amp; !(mAmmo.getType() instanceof BombType)) {</span>
                        // doh. explode it
<span class="nc" id="L22236">                        vDesc.addAll(explodeEquipment(te, mAmmo.getLocation(), mAmmo));</span>
<span class="nc" id="L22237">                        mAmmo.setHit(true);</span>
                    }
<span class="nc" id="L22239">                }</span>
            }

<span class="nc bnc" id="L22242" title="All 2 branches missed.">            if (te.isAero()) {</span>
                // chance of a critical if damage greater than threshold
<span class="nc" id="L22244">                IAero a = (IAero) te;</span>
<span class="nc bnc" id="L22245" title="All 2 branches missed.">                if ((threshDamage &gt; a.getThresh(hit.getLocation()))) {</span>
<span class="nc" id="L22246">                    critThresh = true;</span>
<span class="nc" id="L22247">                    a.setCritThresh(true);</span>
                }
            }

            // Capital fighters receive damage differently
<span class="nc bnc" id="L22252" title="All 2 branches missed.">            if (te.isCapitalFighter()) {</span>
<span class="nc" id="L22253">                IAero a = (IAero) te;</span>
<span class="nc" id="L22254">                a.setCurrentDamage(a.getCurrentDamage() + damage);</span>
<span class="nc" id="L22255">                a.setCapArmor(a.getCapArmor() - damage);</span>
<span class="nc" id="L22256">                r = new Report(9065);</span>
<span class="nc" id="L22257">                r.subject = te_n;</span>
<span class="nc" id="L22258">                r.indent(2);</span>
<span class="nc" id="L22259">                r.newlines = 0;</span>
<span class="nc" id="L22260">                r.addDesc(te);</span>
<span class="nc" id="L22261">                r.add(damage);</span>
<span class="nc" id="L22262">                vDesc.addElement(r);</span>
<span class="nc" id="L22263">                r = new Report(6085);</span>
<span class="nc" id="L22264">                r.subject = te_n;</span>
<span class="nc" id="L22265">                r.add(Math.max(a.getCapArmor(), 0));</span>
<span class="nc" id="L22266">                vDesc.addElement(r);</span>
                // check to see if this destroyed the entity
<span class="nc bnc" id="L22268" title="All 2 branches missed.">                if (a.getCapArmor() &lt;= 0) {</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L22270" title="All 2 branches missed.">                    if (a instanceof LandAirMech) {</span>
                        // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L22272">                        LandAirMech lam = (LandAirMech) a;</span>
<span class="nc bnc" id="L22273" title="All 2 branches missed.">                        if (lam.isAutoEject()</span>
<span class="nc bnc" id="L22274" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22275" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22276" title="All 2 branches missed.">                                            &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L22277">                            addReport(ejectEntity(te, true, false));</span>
                        }
<span class="nc" id="L22279">                    } else {</span>
                        // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L22281">                        Aero aero = (Aero) a;</span>
<span class="nc bnc" id="L22282" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L22283" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L22284" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22285" title="All 2 branches missed.">                                            &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L22286">                            addReport(ejectEntity(te, true, false));</span>
                        }
                    }
<span class="nc" id="L22289">                    vDesc.addAll(destroyEntity(te, &quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L22290">                    a.doDisbandDamage();</span>
<span class="nc" id="L22291">                    a.setCapArmor(0);</span>
<span class="nc bnc" id="L22292" title="All 2 branches missed.">                    if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L22293">                        creditKill(te, game.getEntity(hit.getAttackerId()));</span>
                    }
                }
                // check for aero crits from natural 12 or threshold; LAMs take damage as mechs
<span class="nc bnc" id="L22297" title="All 2 branches missed.">                if (te instanceof Aero) {</span>
<span class="nc" id="L22298">                    checkAeroCrits(vDesc, (Aero) te, hit, damage_orig, critThresh,</span>
                                   critSI, ammoExplosion, nukeS2S);
                }
<span class="nc" id="L22301">                return vDesc;</span>
            }

<span class="nc bnc" id="L22304" title="All 4 branches missed.">            if (!((te instanceof Aero) &amp;&amp; ammoExplosion)) {</span>
                // report something different for Aero ammo explosions
<span class="nc" id="L22306">                r = new Report(6065);</span>
<span class="nc" id="L22307">                r.subject = te_n;</span>
<span class="nc" id="L22308">                r.indent(2);</span>
<span class="nc" id="L22309">                r.addDesc(te);</span>
<span class="nc" id="L22310">                r.add(damage);</span>
<span class="nc bnc" id="L22311" title="All 2 branches missed.">                if (damageIS) {</span>
<span class="nc" id="L22312">                    r.messageId = 6070;</span>
                }
<span class="nc" id="L22314">                r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L22315">                vDesc.addElement(r);</span>
            }

            // was the section destroyed earlier this phase?
<span class="nc bnc" id="L22319" title="All 2 branches missed.">            if (te.getInternal(hit) == IArmorState.ARMOR_DOOMED) {</span>
                // cannot transfer a through armor crit if so
<span class="nc" id="L22321">                crits = 0;</span>
            }

            // here goes the fun :)
            // Shields take damage first then cowls then armor whee
            // Shield does not protect from ammo explosions or falls.
<span class="nc bnc" id="L22327" title="All 8 branches missed.">            if (!ammoExplosion &amp;&amp; !hit.isFallDamage() &amp;&amp; !damageIS &amp;&amp; te.hasShield()</span>
<span class="nc bnc" id="L22328" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc" id="L22329">                Mech me = (Mech) te;</span>
<span class="nc" id="L22330">                int damageNew = me.shieldAbsorptionDamage(damage, hit.getLocation(), hit.isRear());</span>
                // if a shield absorbed the damage then lets tell the world
                // about it.
<span class="nc bnc" id="L22333" title="All 2 branches missed.">                if (damageNew != damage) {</span>
<span class="nc" id="L22334">                    int absorb = damage - damageNew;</span>
<span class="nc" id="L22335">                    te.damageThisPhase += absorb;</span>
<span class="nc" id="L22336">                    damage = damageNew;</span>

<span class="nc" id="L22338">                    r = new Report(3530);</span>
<span class="nc" id="L22339">                    r.subject = te_n;</span>
<span class="nc" id="L22340">                    r.indent(3);</span>
<span class="nc" id="L22341">                    r.add(absorb);</span>
<span class="nc" id="L22342">                    vDesc.addElement(r);</span>

<span class="nc bnc" id="L22344" title="All 2 branches missed.">                    if (damage &lt;= 0) {</span>
<span class="nc" id="L22345">                        crits = 0;</span>
<span class="nc" id="L22346">                        specCrits = 0;</span>
<span class="nc" id="L22347">                        isHeadHit = false;</span>
                    }
                }
            }

            // Armored Cowl may absorb some damage from hit
<span class="nc bnc" id="L22353" title="All 2 branches missed.">            if (te instanceof Mech) {</span>
<span class="nc" id="L22354">                Mech me = (Mech) te;</span>
<span class="nc bnc" id="L22355" title="All 6 branches missed.">                if (me.hasCowl() &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
                    &amp;&amp; !throughFront) {
<span class="nc" id="L22357">                    int damageNew = me.damageCowl(damage);</span>
<span class="nc" id="L22358">                    int damageDiff = damage - damageNew;</span>
<span class="nc" id="L22359">                    me.damageThisPhase += damageDiff;</span>
<span class="nc" id="L22360">                    damage = damageNew;</span>

<span class="nc" id="L22362">                    r = new Report(3520);</span>
<span class="nc" id="L22363">                    r.subject = te_n;</span>
<span class="nc" id="L22364">                    r.indent(3);</span>
<span class="nc" id="L22365">                    r.add(damageDiff);</span>
<span class="nc" id="L22366">                    vDesc.addElement(r);</span>
                }
            }

            // So might modular armor, if the location mounts any.
<span class="nc bnc" id="L22371" title="All 4 branches missed.">            if (!ammoExplosion &amp;&amp; !damageIS</span>
<span class="nc bnc" id="L22372" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc" id="L22373">                int damageNew = te.getDamageReductionFromModularArmor(hit, damage, vDesc);</span>
<span class="nc" id="L22374">                int damageDiff = damage - damageNew;</span>
<span class="nc" id="L22375">                te.damageThisPhase += damageDiff;</span>
<span class="nc" id="L22376">                damage = damageNew;</span>
            }

            // Destroy searchlights on 7+ (torso hits on mechs)
<span class="nc bnc" id="L22380" title="All 2 branches missed.">            if (te.hasSpotlight()) {</span>
<span class="nc" id="L22381">                boolean spotlightHittable = true;</span>
<span class="nc" id="L22382">                int loc = hit.getLocation();</span>
<span class="nc bnc" id="L22383" title="All 2 branches missed.">                if (te instanceof Mech) {</span>
<span class="nc bnc" id="L22384" title="All 6 branches missed.">                    if ((loc != Mech.LOC_CT) &amp;&amp; (loc != Mech.LOC_LT) &amp;&amp; (loc != Mech.LOC_RT)) {</span>
<span class="nc" id="L22385">                        spotlightHittable = false;</span>
                    }
<span class="nc bnc" id="L22387" title="All 2 branches missed.">                } else if (te instanceof Tank) {</span>
<span class="nc bnc" id="L22388" title="All 2 branches missed.">                    if (te instanceof SuperHeavyTank) {</span>
<span class="nc bnc" id="L22389" title="All 10 branches missed.">                        if ((loc != Tank.LOC_FRONT)</span>
                                &amp;&amp; (loc != SuperHeavyTank.LOC_FRONTRIGHT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_FRONTLEFT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_REARRIGHT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_REARLEFT)) {
<span class="nc" id="L22394">                            spotlightHittable = false;</span>
                        }
<span class="nc bnc" id="L22396" title="All 2 branches missed.">                    } else if (te instanceof LargeSupportTank) {</span>
<span class="nc bnc" id="L22397" title="All 10 branches missed.">                        if ((loc != Tank.LOC_FRONT)</span>
                                &amp;&amp; (loc != LargeSupportTank.LOC_FRONTRIGHT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_FRONTLEFT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_REARRIGHT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_REARLEFT)) {
<span class="nc" id="L22402">                            spotlightHittable = false;</span>
                        }
                    } else {
<span class="nc bnc" id="L22405" title="All 6 branches missed.">                        if ((loc != Tank.LOC_FRONT) &amp;&amp; (loc != Tank.LOC_RIGHT)</span>
                                &amp;&amp; (loc != Tank.LOC_LEFT)) {
<span class="nc" id="L22407">                            spotlightHittable = false;</span>
                        }
                    }

                }
<span class="nc bnc" id="L22412" title="All 2 branches missed.">                if (spotlightHittable) {</span>
<span class="nc" id="L22413">                    int spotroll = Compute.d6(2);</span>
<span class="nc" id="L22414">                    r = new Report(6072);</span>
<span class="nc" id="L22415">                    r.indent(2);</span>
<span class="nc" id="L22416">                    r.subject = te_n;</span>
<span class="nc" id="L22417">                    r.add(&quot;7+&quot;);</span>
<span class="nc" id="L22418">                    r.add(&quot;Searchlight&quot;);</span>
<span class="nc" id="L22419">                    r.add(spotroll);</span>
<span class="nc" id="L22420">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22421" title="All 2 branches missed.">                    if (spotroll &gt;= 7) {</span>
<span class="nc" id="L22422">                        r = new Report(6071);</span>
<span class="nc" id="L22423">                        r.subject = te_n;</span>
<span class="nc" id="L22424">                        r.indent(2);</span>
<span class="nc" id="L22425">                        r.add(&quot;Searchlight&quot;);</span>
<span class="nc" id="L22426">                        vDesc.addElement(r);</span>
<span class="nc" id="L22427">                        te.destroyOneSpotlight();</span>
                    }
                }
            }

            // Does an exterior passenger absorb some of the damage?
<span class="nc bnc" id="L22433" title="All 2 branches missed.">            if (!damageIS) {</span>
<span class="nc" id="L22434">                int nLoc = hit.getLocation();</span>
<span class="nc" id="L22435">                Entity passenger = te.getExteriorUnitAt(nLoc, hit.isRear());</span>
                // Does an exterior passenger absorb some of the damage?
<span class="nc bnc" id="L22437" title="All 8 branches missed.">                if (!ammoExplosion &amp;&amp; (null != passenger) &amp;&amp; !passenger.isDoomed()</span>
                        &amp;&amp; (bFrag != DamageType.IGNORE_PASSENGER)) {
<span class="nc" id="L22439">                    damage = damageExternalPassenger(te, hit, damage, vDesc, passenger);</span>
                }

<span class="nc bnc" id="L22442" title="All 6 branches missed.">                boolean bTorso = (nLoc == Mech.LOC_CT) || (nLoc == Mech.LOC_RT)</span>
                        || (nLoc == Mech.LOC_LT);

                // Does a swarming unit absorb damage?
<span class="nc" id="L22446">                int swarmer = te.getSwarmAttackerId();</span>
<span class="nc bnc" id="L22447" title="All 6 branches missed.">                if ((!(te instanceof Mech) || bTorso) &amp;&amp; (swarmer != Entity.NONE)</span>
<span class="nc bnc" id="L22448" title="All 8 branches missed.">                        &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == 0) &amp;&amp; (Compute.d6() &gt;= 5)</span>
                        &amp;&amp; (bFrag != DamageType.IGNORE_PASSENGER) &amp;&amp; !ammoExplosion) {
<span class="nc" id="L22450">                    Entity swarm = game.getEntity(swarmer);</span>
                    // Yup. Roll up some hit data for that passenger.
<span class="nc" id="L22452">                    r = new Report(6076);</span>
<span class="nc" id="L22453">                    r.subject = swarmer;</span>
<span class="nc" id="L22454">                    r.indent(3);</span>
<span class="nc" id="L22455">                    r.addDesc(swarm);</span>
<span class="nc" id="L22456">                    vDesc.addElement(r);</span>

<span class="nc" id="L22458">                    HitData passHit = swarm.rollHitLocation(</span>
                            ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);

                    // How much damage will the swarm absorb?
<span class="nc" id="L22462">                    int absorb = 0;</span>
<span class="nc" id="L22463">                    HitData nextPassHit = passHit;</span>
                    do {
<span class="nc bnc" id="L22465" title="All 2 branches missed.">                        if (0 &lt; swarm.getArmor(nextPassHit)) {</span>
<span class="nc" id="L22466">                            absorb += swarm.getArmor(nextPassHit);</span>
                        }
<span class="nc bnc" id="L22468" title="All 2 branches missed.">                        if (0 &lt; swarm.getInternal(nextPassHit)) {</span>
<span class="nc" id="L22469">                            absorb += swarm.getInternal(nextPassHit);</span>
                        }
<span class="nc" id="L22471">                        nextPassHit = swarm.getTransferLocation(nextPassHit);</span>
<span class="nc bnc" id="L22472" title="All 2 branches missed.">                    } while ((damage &gt; absorb)</span>
<span class="nc bnc" id="L22473" title="All 2 branches missed.">                             &amp;&amp; (nextPassHit.getLocation() &gt;= 0));</span>

                    // Damage the swarm.
<span class="nc" id="L22476">                    int absorbedDamage = Math.min(damage, absorb);</span>
<span class="nc" id="L22477">                    Vector&lt;Report&gt; newReports = damageEntity(swarm, passHit,</span>
                                                             absorbedDamage);
<span class="nc bnc" id="L22479" title="All 2 branches missed.">                    for (Report newReport : newReports) {</span>
<span class="nc" id="L22480">                        newReport.indent(2);</span>
<span class="nc" id="L22481">                    }</span>
<span class="nc" id="L22482">                    vDesc.addAll(newReports);</span>

                    // Did some damage pass on?
<span class="nc bnc" id="L22485" title="All 2 branches missed.">                    if (damage &gt; absorb) {</span>
                        // Yup. Remove the absorbed damage.
<span class="nc" id="L22487">                        damage -= absorb;</span>
<span class="nc" id="L22488">                        r = new Report(6080);</span>
<span class="nc" id="L22489">                        r.subject = te_n;</span>
<span class="nc" id="L22490">                        r.indent(2);</span>
<span class="nc" id="L22491">                        r.add(damage);</span>
<span class="nc" id="L22492">                        r.addDesc(te);</span>
<span class="nc" id="L22493">                        vDesc.addElement(r);</span>
                    } else {
                        // Nope. Return our description.
<span class="nc" id="L22496">                        return vDesc;</span>
                    }
                }

                // is this a mech/tank dumping ammo being hit in the rear torso?
<span class="nc bnc" id="L22501" title="All 8 branches missed.">                if (((te instanceof Mech) &amp;&amp; hit.isRear() &amp;&amp; bTorso)</span>
<span class="nc bnc" id="L22502" title="All 2 branches missed.">                        || ((te instanceof Tank) &amp;&amp; (hit.getLocation() == (te instanceof SuperHeavyTank ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L22503" title="All 2 branches missed.">                                : Tank.LOC_REAR)))) {</span>
<span class="nc bnc" id="L22504" title="All 2 branches missed.">                    for (Mounted mAmmo : te.getAmmo()) {</span>
<span class="nc bnc" id="L22505" title="All 4 branches missed.">                        if (mAmmo.isDumping() &amp;&amp; !mAmmo.isDestroyed()</span>
<span class="nc bnc" id="L22506" title="All 2 branches missed.">                            &amp;&amp; !mAmmo.isHit()) {</span>
                            // doh. explode it
<span class="nc" id="L22508">                            vDesc.addAll(explodeEquipment(te,</span>
<span class="nc" id="L22509">                                                          mAmmo.getLocation(), mAmmo));</span>
<span class="nc" id="L22510">                            mAmmo.setHit(true);</span>
                        }
<span class="nc" id="L22512">                    }</span>
                }
            }
            // is there armor in the location hit?
<span class="nc bnc" id="L22516" title="All 6 branches missed.">            if (!ammoExplosion &amp;&amp; (te.getArmor(hit) &gt; 0) &amp;&amp; !damageIS) {</span>
<span class="nc" id="L22517">                int tmpDamageHold = -1;</span>
<span class="nc" id="L22518">                int origDamage = damage;</span>

<span class="nc bnc" id="L22520" title="All 2 branches missed.">                if (isPlatoon) {</span>
                    // infantry armour works differently
<span class="nc" id="L22522">                    int armor = te.getArmor(hit);</span>
<span class="nc" id="L22523">                    int men = te.getInternal(hit);</span>
<span class="nc" id="L22524">                    tmpDamageHold = damage % 2;</span>
<span class="nc" id="L22525">                    damage /= 2;</span>
<span class="nc bnc" id="L22526" title="All 4 branches missed.">                    if ((tmpDamageHold == 1) &amp;&amp; (armor &gt;= men)) {</span>
                        // extra 1 point of damage to armor
<span class="nc" id="L22528">                        tmpDamageHold = damage;</span>
<span class="nc" id="L22529">                        damage++;</span>
                    } else {
                        // extra 0 or 1 point of damage to men
<span class="nc" id="L22532">                        tmpDamageHold += damage;</span>
                    }
                    // If the target has Ferro-Lamellor armor, we need to adjust
                    // damage. (4/5ths rounded down),
                    // Also check to eliminate crit chances for damage reduced
                    // to 0
<span class="nc bnc" id="L22538" title="All 2 branches missed.">                } else if (ferroLamellorArmor</span>
<span class="nc bnc" id="L22539" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22540" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22541" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22542">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22543">                    damage = (int) Math.floor((((double) damage) * 4) / 5);</span>
<span class="nc bnc" id="L22544" title="All 2 branches missed.">                    if (damage &lt;= 0) {</span>
<span class="nc" id="L22545">                        isHeadHit = false;</span>
<span class="nc" id="L22546">                        crits = 0;</span>
                    }
<span class="nc" id="L22548">                    r = new Report(6073);</span>
<span class="nc" id="L22549">                    r.subject = te_n;</span>
<span class="nc" id="L22550">                    r.indent(3);</span>
<span class="nc" id="L22551">                    r.add(damage);</span>
<span class="nc" id="L22552">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22553" title="All 2 branches missed.">                } else if (ballisticArmor</span>
<span class="nc bnc" id="L22554" title="All 2 branches missed.">                           &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22555" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22556" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_BALLISTIC)</span>
<span class="nc bnc" id="L22557" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE))) {</span>
<span class="nc" id="L22558">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22559">                    damage = Math.max(1, damage / 2);</span>
<span class="nc" id="L22560">                    r = new Report(6088);</span>
<span class="nc" id="L22561">                    r.subject = te_n;</span>
<span class="nc" id="L22562">                    r.indent(3);</span>
<span class="nc" id="L22563">                    r.add(damage);</span>
<span class="nc" id="L22564">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22565" title="All 2 branches missed.">                } else if (impactArmor</span>
<span class="nc bnc" id="L22566" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)) {</span>
<span class="nc" id="L22567">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22568">                    damage -= (int) Math.ceil((double) damage / 3);</span>
<span class="nc" id="L22569">                    damage = Math.max(1, damage);</span>
<span class="nc" id="L22570">                    r = new Report(6089);</span>
<span class="nc" id="L22571">                    r.subject = te_n;</span>
<span class="nc" id="L22572">                    r.indent(3);</span>
<span class="nc" id="L22573">                    r.add(damage);</span>
<span class="nc" id="L22574">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22575" title="All 2 branches missed.">                } else if (reflectiveArmor</span>
<span class="nc bnc" id="L22576" title="All 4 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)</span>
                           &amp;&amp; !isBattleArmor) { // BA reflec does not receive extra physical damage
<span class="nc" id="L22578">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22579">                    int currArmor = te.getArmor(hit);</span>
<span class="nc" id="L22580">                    int dmgToDouble = Math.min(damage, currArmor / 2);</span>
<span class="nc" id="L22581">                    damage += dmgToDouble;</span>
<span class="nc" id="L22582">                    r = new Report(6066);</span>
<span class="nc" id="L22583">                    r.subject = te_n;</span>
<span class="nc" id="L22584">                    r.indent(3);</span>
<span class="nc" id="L22585">                    r.add(currArmor);</span>
<span class="nc" id="L22586">                    r.add(tmpDamageHold);</span>
<span class="nc" id="L22587">                    r.add(dmgToDouble);</span>
<span class="nc" id="L22588">                    r.add(damage);</span>
<span class="nc" id="L22589">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22590" title="All 6 branches missed.">                } else if (reflectiveArmor &amp;&amp; areaSatArty &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L22591">                    tmpDamageHold = damage; // BA reflec does not receive extra AE damage</span>
<span class="nc" id="L22592">                    int currArmor = te.getArmor(hit);</span>
<span class="nc" id="L22593">                    int dmgToDouble = Math.min(damage, currArmor / 2);</span>
<span class="nc" id="L22594">                    damage += dmgToDouble;</span>
<span class="nc" id="L22595">                    r = new Report(6087);</span>
<span class="nc" id="L22596">                    r.subject = te_n;</span>
<span class="nc" id="L22597">                    r.indent(3);</span>
<span class="nc" id="L22598">                    r.add(currArmor);</span>
<span class="nc" id="L22599">                    r.add(tmpDamageHold);</span>
<span class="nc" id="L22600">                    r.add(dmgToDouble);</span>
<span class="nc" id="L22601">                    r.add(damage);</span>
<span class="nc" id="L22602">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22603" title="All 2 branches missed.">                } else if (reflectiveArmor</span>
<span class="nc bnc" id="L22604" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_ENERGY)) {</span>
<span class="nc" id="L22605">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22606">                    damage = (int) Math.floor(((double) damage) / 2);</span>
<span class="nc bnc" id="L22607" title="All 2 branches missed.">                    if (tmpDamageHold == 1) {</span>
<span class="nc" id="L22608">                        damage = 1;</span>
                    }
<span class="nc" id="L22610">                    r = new Report(6067);</span>
<span class="nc" id="L22611">                    r.subject = te_n;</span>
<span class="nc" id="L22612">                    r.indent(3);</span>
<span class="nc" id="L22613">                    r.add(damage);</span>
<span class="nc" id="L22614">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22615" title="All 2 branches missed.">                } else if (reactiveArmor</span>
<span class="nc bnc" id="L22616" title="All 2 branches missed.">                           &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE)</span>
<span class="nc bnc" id="L22617" title="All 4 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE) ||</span>
                               areaSatArty)) {
<span class="nc" id="L22619">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22620">                    damage = (int) Math.floor(((double) damage) / 2);</span>
<span class="nc bnc" id="L22621" title="All 2 branches missed.">                    if (tmpDamageHold == 1) {</span>
<span class="nc" id="L22622">                        damage = 1;</span>
                    }
<span class="nc" id="L22624">                    r = new Report(6068);</span>
<span class="nc" id="L22625">                    r.subject = te_n;</span>
<span class="nc" id="L22626">                    r.indent(3);</span>
<span class="nc" id="L22627">                    r.add(damage);</span>
<span class="nc" id="L22628">                    vDesc.addElement(r);</span>
                }

                // If we're using optional tank damage thresholds, setup our hit
                // effects now...
<span class="nc bnc" id="L22633" title="All 2 branches missed.">                if ((te instanceof Tank)</span>
<span class="nc" id="L22634">                        &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L22635" title="All 6 branches missed.">                                .booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                        &amp;&amp; !((te instanceof VTOL) || (te instanceof GunEmplacement))) {
<span class="nc" id="L22637">                    int thresh = (int) Math.ceil(</span>
<span class="nc bnc" id="L22638" title="All 2 branches missed.">                            (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD_VARIABLE)</span>
<span class="nc" id="L22639">                                    ? te.getArmor(hit)</span>
<span class="nc" id="L22640">                                    : te.getOArmor(hit)) / (double) game.getOptions().intOption(</span>
                                            OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD_DIVISOR));

                    // adjust for hardened armor
<span class="nc bnc" id="L22644" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22645" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22646" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22647" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22648">                        thresh *= 2;</span>
                    }

<span class="nc bnc" id="L22651" title="All 4 branches missed.">                    if ((damage &gt; thresh) || (te.getArmor(hit) &lt; damage)) {</span>
<span class="nc" id="L22652">                        hit.setEffect(((Tank) te).getPotCrit());</span>
<span class="nc" id="L22653">                        ((Tank) te).setOverThresh(true);</span>
                        // TACs from the hit location table
<span class="nc bnc" id="L22655" title="All 2 branches missed.">                        crits = ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL)</span>
<span class="nc" id="L22656">                                == HitData.EFFECT_CRITICAL) ? 1 : 0;</span>
                    } else {
<span class="nc" id="L22658">                        ((Tank) te).setOverThresh(false);</span>
<span class="nc" id="L22659">                        crits = 0;</span>
                    }
                }

                // if there's a mast mount in the rotor, it and all other
                // equipment
                // on it get destroyed
<span class="nc bnc" id="L22666" title="All 2 branches missed.">                if ((te instanceof VTOL)</span>
<span class="nc bnc" id="L22667" title="All 2 branches missed.">                    &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L22668" title="All 2 branches missed.">                    &amp;&amp; te.hasWorkingMisc(MiscType.F_MAST_MOUNT, -1,</span>
                                         VTOL.LOC_ROTOR)) {
<span class="nc" id="L22670">                    r = new Report(6081);</span>
<span class="nc" id="L22671">                    r.subject = te_n;</span>
<span class="nc" id="L22672">                    r.indent(2);</span>
<span class="nc" id="L22673">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22674" title="All 2 branches missed.">                    for (Mounted mount : te.getMisc()) {</span>
<span class="nc bnc" id="L22675" title="All 2 branches missed.">                        if (mount.getLocation() == VTOL.LOC_ROTOR) {</span>
<span class="nc" id="L22676">                            mount.setHit(true);</span>
                        }
<span class="nc" id="L22678">                    }</span>
                }
                // Need to account for the possibility of hardened armor here
<span class="nc" id="L22681">                int armorThreshold = te.getArmor(hit);</span>
<span class="nc bnc" id="L22682" title="All 2 branches missed.">                if (hardenedArmor</span>
<span class="nc bnc" id="L22683" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22684" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22685" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22686">                    armorThreshold *= 2;</span>
<span class="nc bnc" id="L22687" title="All 2 branches missed.">                    armorThreshold -= (te.isHardenedArmorDamaged(hit)) ? 1 : 0;</span>
<span class="nc" id="L22688">                    vDesc.lastElement().newlines = 0;</span>
<span class="nc" id="L22689">                    r = new Report(6069);</span>
<span class="nc" id="L22690">                    r.subject = te_n;</span>
<span class="nc" id="L22691">                    r.indent(3);</span>
<span class="nc" id="L22692">                    int reportedDamage = damage / 2;</span>
<span class="nc bnc" id="L22693" title="All 2 branches missed.">                    if ((damage % 2) &gt; 0) {</span>
<span class="nc" id="L22694">                        r.add(reportedDamage + &quot;.5&quot;);</span>
                    } else {
<span class="nc" id="L22696">                        r.add(reportedDamage);</span>
                    }

<span class="nc" id="L22699">                    vDesc.addElement(r);</span>
                }
<span class="nc bnc" id="L22701" title="All 2 branches missed.">                if (armorThreshold &gt;= damage) {</span>

                    // armor absorbs all damage
                    // Hardened armor deals with damage in its own fashion...
<span class="nc bnc" id="L22705" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22706" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22707" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22708" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22709">                        armorThreshold -= damage;</span>
<span class="nc bnc" id="L22710" title="All 2 branches missed.">                        te.setHardenedArmorDamaged(hit, (armorThreshold % 2) &gt; 0);</span>
<span class="nc" id="L22711">                        te.setArmor((armorThreshold / 2) + (armorThreshold % 2), hit);</span>
                    } else {
<span class="nc" id="L22713">                        te.setArmor(te.getArmor(hit) - damage, hit);</span>
                    }

                    // set &quot;armor damage&quot; flag for HarJel II/III
                    // we only care about this if there is armor remaining,
                    // so don't worry about the case where damage exceeds
                    // armorThreshold
<span class="nc bnc" id="L22720" title="All 4 branches missed.">                    if ((te instanceof Mech) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L22721">                        ((Mech) te).setArmorDamagedThisTurn(hit.getLocation(), true);</span>
                    }

                    // if the armor is hardened, any penetrating crits are
                    // rolled at -2
<span class="nc bnc" id="L22726" title="All 2 branches missed.">                    if (hardenedArmor) {</span>
<span class="nc" id="L22727">                        critBonus -= 2;</span>
                    }

<span class="nc bnc" id="L22730" title="All 2 branches missed.">                    if (tmpDamageHold &gt;= 0) {</span>
<span class="nc" id="L22731">                        te.damageThisPhase += tmpDamageHold;</span>
                    } else {
<span class="nc" id="L22733">                        te.damageThisPhase += damage;</span>
                    }
<span class="nc" id="L22735">                    damage = 0;</span>
<span class="nc bnc" id="L22736" title="All 2 branches missed.">                    if (!te.isHardenedArmorDamaged(hit)) {</span>
<span class="nc" id="L22737">                        r = new Report(6085);</span>
                    } else {
<span class="nc" id="L22739">                        r = new Report(6086);</span>
                    }

<span class="nc" id="L22742">                    r.subject = te_n;</span>
<span class="nc" id="L22743">                    r.indent(3);</span>
<span class="nc" id="L22744">                    r.add(te.getArmor(hit));</span>
<span class="nc" id="L22745">                    vDesc.addElement(r);</span>

                    // telemissiles are destroyed if they lose all armor
<span class="nc bnc" id="L22748" title="All 2 branches missed.">                    if ((te instanceof TeleMissile)</span>
<span class="nc bnc" id="L22749" title="All 2 branches missed.">                        &amp;&amp; (te.getArmor(hit) == damage)) {</span>
<span class="nc" id="L22750">                        vDesc.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
                    }

                } else {
                    // damage goes on to internal
<span class="nc" id="L22755">                    int absorbed = Math.max(te.getArmor(hit), 0);</span>
<span class="nc bnc" id="L22756" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22757" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22758" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)) {</span>
<span class="nc" id="L22759">                        absorbed = (absorbed * 2)</span>
<span class="nc bnc" id="L22760" title="All 2 branches missed.">                                   - ((te.isHardenedArmorDamaged(hit)) ? 1 : 0);</span>
                    }
<span class="nc bnc" id="L22762" title="All 6 branches missed.">                    if (reflectiveArmor &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)</span>
                            &amp;&amp; !isBattleArmor) {
<span class="nc" id="L22764">                        absorbed = (int) Math.ceil(absorbed / 2.0);</span>
<span class="nc" id="L22765">                        damage = tmpDamageHold;</span>
<span class="nc" id="L22766">                        tmpDamageHold = 0;</span>
                    }
<span class="nc" id="L22768">                    te.setArmor(IArmorState.ARMOR_DESTROYED, hit);</span>
<span class="nc bnc" id="L22769" title="All 2 branches missed.">                    if (tmpDamageHold &gt;= 0) {</span>
<span class="nc" id="L22770">                        te.damageThisPhase += 2 * absorbed;</span>
                    } else {
<span class="nc" id="L22772">                        te.damageThisPhase += absorbed;</span>
                    }
<span class="nc" id="L22774">                    damage -= absorbed;</span>
<span class="nc" id="L22775">                    r = new Report(6090);</span>
<span class="nc" id="L22776">                    r.subject = te_n;</span>
<span class="nc" id="L22777">                    r.indent(3);</span>
<span class="nc" id="L22778">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22779" title="All 2 branches missed.">                    if (te instanceof GunEmplacement) {</span>
                        // gun emplacements have no internal,
                        // destroy the section
<span class="nc" id="L22782">                        te.destroyLocation(hit.getLocation());</span>
<span class="nc" id="L22783">                        r = new Report(6115);</span>
<span class="nc" id="L22784">                        r.subject = te_n;</span>
<span class="nc" id="L22785">                        vDesc.addElement(r);</span>

<span class="nc bnc" id="L22787" title="All 2 branches missed.">                        if (te.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L22788">                            vDesc.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
                        }
                    }
                }

                // targets with BAR armor get crits, depending on damage and BAR
                // rating
<span class="nc bnc" id="L22795" title="All 2 branches missed.">                if (te.hasBARArmor(hit.getLocation())) {</span>
<span class="nc bnc" id="L22796" title="All 2 branches missed.">                    if (origDamage &gt; te.getBARRating(hit.getLocation())) {</span>
<span class="nc bnc" id="L22797" title="All 2 branches missed.">                        if (te.hasArmoredChassis()) {</span>
                            // crit roll with -1 mod
<span class="nc" id="L22799">                            vDesc.addAll(criticalEntity(te, hit.getLocation(),</span>
<span class="nc" id="L22800">                                                        hit.isRear(), -1 + critBonus, damage_orig));</span>
                        } else {
<span class="nc" id="L22802">                            vDesc.addAll(criticalEntity(te, hit.getLocation(),</span>
<span class="nc" id="L22803">                                                        hit.isRear(), critBonus, damage_orig));</span>
                        }
                    }
                }

<span class="nc bnc" id="L22808" title="All 4 branches missed.">                if ((tmpDamageHold &gt; 0) &amp;&amp; isPlatoon) {</span>
<span class="nc" id="L22809">                    damage = tmpDamageHold;</span>
                }
            }

            // For optional tank damage thresholds, the overthresh flag won't
            // be set if IS is damaged, so set it here.
<span class="nc bnc" id="L22815" title="All 2 branches missed.">            if ((te instanceof Tank)</span>
<span class="nc bnc" id="L22816" title="All 4 branches missed.">                    &amp;&amp; ((te.getArmor(hit) &lt; 1) || damageIS)</span>
<span class="nc bnc" id="L22817" title="All 6 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                    &amp;&amp; !((te instanceof VTOL)
                            || (te instanceof GunEmplacement))) {
<span class="nc" id="L22820">                ((Tank) te).setOverThresh(true);</span>
            }

            // is there damage remaining?
<span class="nc bnc" id="L22824" title="All 2 branches missed.">            if (damage &gt; 0) {</span>

                // if this is an Aero then I need to apply internal damage
                // to the SI after halving it. Return from here to prevent
                // further processing
<span class="nc bnc" id="L22829" title="All 2 branches missed.">                if (te instanceof Aero) {</span>
<span class="nc" id="L22830">                    Aero a = (Aero) te;</span>

                    // check for large craft ammo explosions here: damage vented through armor, excess
                    // dissipating, much like Tank CASE.
<span class="nc bnc" id="L22834" title="All 4 branches missed.">                    if (ammoExplosion &amp;&amp; te.isLargeCraft()) {</span>
<span class="nc" id="L22835">                        te.damageThisPhase += damage;</span>
<span class="nc" id="L22836">                        r = new Report(6128);</span>
<span class="nc" id="L22837">                        r.subject = te_n;</span>
<span class="nc" id="L22838">                        r.indent(2);</span>
<span class="nc" id="L22839">                        r.add(damage);</span>
<span class="nc" id="L22840">                        int loc = hit.getLocation();</span>
                        //Roll for broadside weapons so fore/aft side armor facing takes the damage
<span class="nc bnc" id="L22842" title="All 2 branches missed.">                        if (loc == Warship.LOC_LBS) {</span>
<span class="nc" id="L22843">                            int locRoll = Compute.d6();</span>
<span class="nc bnc" id="L22844" title="All 2 branches missed.">                            if (locRoll &lt; 4) {</span>
<span class="nc" id="L22845">                                loc = Jumpship.LOC_FLS;</span>
                            } else {
<span class="nc" id="L22847">                                loc = Jumpship.LOC_ALS;</span>
                            }
                        }
<span class="nc bnc" id="L22850" title="All 2 branches missed.">                        if (loc == Warship.LOC_RBS) {</span>
<span class="nc" id="L22851">                            int locRoll = Compute.d6();</span>
<span class="nc bnc" id="L22852" title="All 2 branches missed.">                            if (locRoll &lt; 4) {</span>
<span class="nc" id="L22853">                                loc = Jumpship.LOC_FRS;</span>
                            } else {
<span class="nc" id="L22855">                                loc = Jumpship.LOC_ARS;</span>
                            }
                        }
<span class="nc" id="L22858">                        r.add(te.getLocationAbbr(loc));</span>
<span class="nc" id="L22859">                        vDesc.add(r);</span>
<span class="nc bnc" id="L22860" title="All 2 branches missed.">                        if (damage &gt; te.getArmor(loc)) {</span>
<span class="nc" id="L22861">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc" id="L22862">                            r = new Report(6090);</span>
                        } else {
<span class="nc" id="L22864">                            te.setArmor(te.getArmor(loc) - damage, loc);</span>
<span class="nc" id="L22865">                            r = new Report(6085);</span>
<span class="nc" id="L22866">                            r.add(te.getArmor(loc));</span>
                        }
<span class="nc" id="L22868">                        r.subject = te_n;</span>
<span class="nc" id="L22869">                        r.indent(3);</span>
<span class="nc" id="L22870">                        vDesc.add(r);</span>
<span class="nc" id="L22871">                        damage = 0;</span>
                    }

                    // check for overpenetration
<span class="nc bnc" id="L22875" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVAERORULES_STRATOPS_OVER_PENETRATE)) {
<span class="nc" id="L22877">                        int opRoll = Compute.d6(1);</span>
<span class="nc bnc" id="L22878" title="All 14 branches missed.">                        if ((((te instanceof Jumpship) || (te instanceof SpaceStation))</span>
                             &amp;&amp; !(te instanceof Warship) &amp;&amp; (opRoll &gt; 3))
                            || ((te instanceof Dropship) &amp;&amp; (opRoll &gt; 4))
                            || ((te instanceof Warship)
<span class="nc bnc" id="L22882" title="All 4 branches missed.">                                &amp;&amp; (a.get0SI() &lt;= 30) &amp;&amp; (opRoll &gt; 5))) {</span>
                            // over-penetration happened
<span class="nc" id="L22884">                            r = new Report(9090);</span>
<span class="nc" id="L22885">                            r.subject = te_n;</span>
<span class="nc" id="L22886">                            r.newlines = 0;</span>
<span class="nc" id="L22887">                            vDesc.addElement(r);</span>
<span class="nc" id="L22888">                            int new_loc = a.getOppositeLocation(hit</span>
<span class="nc" id="L22889">                                                                        .getLocation());</span>
<span class="nc" id="L22890">                            damage = Math.min(damage, te.getArmor(new_loc));</span>
                            // We don't want to deal negative damage
<span class="nc" id="L22892">                            damage = Math.max(damage, 0);</span>
<span class="nc" id="L22893">                            r = new Report(6065);</span>
<span class="nc" id="L22894">                            r.subject = te_n;</span>
<span class="nc" id="L22895">                            r.indent(2);</span>
<span class="nc" id="L22896">                            r.newlines = 0;</span>
<span class="nc" id="L22897">                            r.addDesc(te);</span>
<span class="nc" id="L22898">                            r.add(damage);</span>
<span class="nc" id="L22899">                            r.add(te.getLocationAbbr(new_loc));</span>
<span class="nc" id="L22900">                            vDesc.addElement(r);</span>
<span class="nc" id="L22901">                            te.setArmor(te.getArmor(new_loc) - damage, new_loc);</span>
<span class="nc bnc" id="L22902" title="All 4 branches missed.">                            if ((te instanceof Warship)</span>
                                || (te instanceof Dropship)) {
<span class="nc" id="L22904">                                damage = 2;</span>
                            } else {
<span class="nc" id="L22906">                                damage = 0;</span>
                            }
                        }
                    }

                    // divide damage in half
                    // do not divide by half if it is an ammo exposion
<span class="nc bnc" id="L22913" title="All 4 branches missed.">                    if (!ammoExplosion &amp;&amp; !nukeS2S</span>
<span class="nc bnc" id="L22914" title="All 2 branches missed.">                        &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L22915">                        damage /= 2;</span>
                    }

                    // this should result in a crit
                    // but only if it really did damage after rounding down
<span class="nc bnc" id="L22920" title="All 2 branches missed.">                    if (damage &gt; 0) {</span>
<span class="nc" id="L22921">                        critSI = true;</span>
                    }

                    // Now apply damage to the structural integrity
<span class="nc" id="L22925">                    a.setSI(a.getSI() - damage);</span>
<span class="nc" id="L22926">                    te.damageThisPhase += damage;</span>
                    // send the report
<span class="nc" id="L22928">                    r = new Report(1210);</span>
<span class="nc" id="L22929">                    r.subject = te_n;</span>
<span class="nc" id="L22930">                    r.newlines = 1;</span>
<span class="nc bnc" id="L22931" title="All 2 branches missed.">                    if (!ammoExplosion) {</span>
<span class="nc" id="L22932">                        r.messageId = 9005;</span>
                    }
                    //Only for fighters
<span class="nc bnc" id="L22935" title="All 4 branches missed.">                    if (ammoExplosion &amp;&amp; !a.isLargeCraft()) {</span>
<span class="nc" id="L22936">                        r.messageId = 9006;</span>
                    }
<span class="nc" id="L22938">                    r.add(damage);</span>
<span class="nc" id="L22939">                    r.add(Math.max(a.getSI(), 0));</span>
<span class="nc" id="L22940">                    vDesc.addElement(r);</span>
                    // check to see if this would destroy the ASF
<span class="nc bnc" id="L22942" title="All 2 branches missed.">                    if (a.getSI() &lt;= 0) {</span>
                        // Lets auto-eject if we can!
<span class="nc bnc" id="L22944" title="All 2 branches missed.">                        if (a.isAutoEject()</span>
<span class="nc bnc" id="L22945" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22946" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22947" title="All 2 branches missed.">                                            &amp;&amp; a.isCondEjectSIDest()))) {</span>
<span class="nc" id="L22948">                            vDesc.addAll(ejectEntity(te, true, false));</span>
                        } else {
<span class="nc" id="L22950">                            vDesc.addAll(destroyEntity(te,&quot;Structural Integrity Collapse&quot;));</span>
                        }
<span class="nc" id="L22952">                        a.setSI(0);</span>
<span class="nc bnc" id="L22953" title="All 2 branches missed.">                        if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L22954">                            creditKill(a, game.getEntity(hit.getAttackerId()));</span>
                        }
                    }
<span class="nc" id="L22957">                    checkAeroCrits(vDesc, a, hit, damage_orig, critThresh, critSI, ammoExplosion, nukeS2S);</span>
<span class="nc" id="L22958">                    return vDesc;</span>
                }

                // Check for CASE II right away. if so reduce damage to 1
                // and let it hit the IS.
                // Also remove as much of the rear armor as allowed by the
                // damage. If arm/leg/head
                // Then they lose all their armor if its less then the
                // explosion damage.
<span class="nc bnc" id="L22967" title="All 4 branches missed.">                if (ammoExplosion &amp;&amp; te.hasCASEII(hit.getLocation())) {</span>
                    // 1 point of damage goes to IS
<span class="nc" id="L22969">                    damage--;</span>
                    // Remaining damage prevented by CASE II
<span class="nc" id="L22971">                    r = new Report(6126);</span>
<span class="nc" id="L22972">                    r.subject = te_n;</span>
<span class="nc" id="L22973">                    r.add(damage);</span>
<span class="nc" id="L22974">                    r.indent(3);</span>
<span class="nc" id="L22975">                    vDesc.addElement(r);</span>
<span class="nc" id="L22976">                    int loc = hit.getLocation();</span>
<span class="nc bnc" id="L22977" title="All 6 branches missed.">                    if ((te instanceof Mech) &amp;&amp; ((loc == Mech.LOC_HEAD) || ((Mech) te).isArm(loc)</span>
<span class="nc bnc" id="L22978" title="All 2 branches missed.">                            || te.locationIsLeg(loc))) {</span>
<span class="nc" id="L22979">                        int half = (int) Math.ceil(te.getOArmor(loc, false) / 2.0);</span>
<span class="nc bnc" id="L22980" title="All 2 branches missed.">                        if (damage &gt; half) {</span>
<span class="nc" id="L22981">                            damage = half;</span>
                        }
<span class="nc bnc" id="L22983" title="All 2 branches missed.">                        if (damage &gt;= te.getArmor(loc, false)) {</span>
<span class="nc" id="L22984">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc, false);</span>
                        } else {
<span class="nc" id="L22986">                            te.setArmor(te.getArmor(loc, false) - damage, loc, false);</span>
                        }
<span class="nc" id="L22988">                    } else {</span>
<span class="nc bnc" id="L22989" title="All 2 branches missed.">                        if (damage &gt;= te.getArmor(loc, true)) {</span>
<span class="nc" id="L22990">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc, true);</span>
                        } else {
<span class="nc" id="L22992">                            te.setArmor(te.getArmor(loc, true) - damage, loc, true);</span>
                        }
                    }

<span class="nc bnc" id="L22996" title="All 2 branches missed.">                    if (te.getInternal(hit) &gt; 0) {</span>
                        // Mek takes 1 point of IS damage
<span class="nc" id="L22998">                        damage = 1;</span>
                    } else {
<span class="nc" id="L23000">                        damage = 0;</span>
                    }

<span class="nc" id="L23003">                    te.damageThisPhase += damage;</span>

<span class="nc" id="L23005">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L23006">                    r = new Report(6127);</span>
<span class="nc" id="L23007">                    r.subject = te.getId();</span>
<span class="nc" id="L23008">                    r.add(roll);</span>
<span class="nc" id="L23009">                    vDesc.add(r);</span>
<span class="nc bnc" id="L23010" title="All 2 branches missed.">                    if (roll &gt;= 8) {</span>
<span class="nc" id="L23011">                        hit.setEffect(HitData.EFFECT_NO_CRITICALS);</span>
                    }
                }
                // check for tank CASE here: damage to rear armor, excess
                // dissipating, and a crew stunned crit
<span class="nc bnc" id="L23016" title="All 4 branches missed.">                if (ammoExplosion &amp;&amp; (te instanceof Tank)</span>
<span class="nc bnc" id="L23017" title="All 2 branches missed.">                    &amp;&amp; te.locationHasCase(Tank.LOC_BODY)) {</span>
<span class="nc" id="L23018">                    te.damageThisPhase += damage;</span>
<span class="nc" id="L23019">                    r = new Report(6124);</span>
<span class="nc" id="L23020">                    r.subject = te_n;</span>
<span class="nc" id="L23021">                    r.indent(2);</span>
<span class="nc" id="L23022">                    r.add(damage);</span>
<span class="nc" id="L23023">                    vDesc.add(r);</span>
<span class="nc bnc" id="L23024" title="All 2 branches missed.">                    int loc = (te instanceof SuperHeavyTank) ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L23025" title="All 2 branches missed.">                            : (te instanceof LargeSupportTank) ? LargeSupportTank.LOC_REAR : Tank.LOC_REAR;</span>
<span class="nc bnc" id="L23026" title="All 2 branches missed.">                    if (damage &gt; te.getArmor(loc)) {</span>
<span class="nc" id="L23027">                        te.setArmor(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc" id="L23028">                        r = new Report(6090);</span>
                    } else {
<span class="nc" id="L23030">                        te.setArmor(te.getArmor(loc) - damage, loc);</span>
<span class="nc" id="L23031">                        r = new Report(6085);</span>
<span class="nc" id="L23032">                        r.add(te.getArmor(loc));</span>
                    }
<span class="nc" id="L23034">                    r.subject = te_n;</span>
<span class="nc" id="L23035">                    r.indent(3);</span>
<span class="nc" id="L23036">                    vDesc.add(r);</span>
<span class="nc" id="L23037">                    damage = 0;</span>
                    int critIndex;
<span class="nc bnc" id="L23039" title="All 2 branches missed.">                    if (((Tank) te).isCommanderHit()</span>
<span class="nc bnc" id="L23040" title="All 2 branches missed.">                        &amp;&amp; ((Tank) te).isDriverHit()) {</span>
<span class="nc" id="L23041">                        critIndex = Tank.CRIT_CREW_KILLED;</span>
                    } else {
<span class="nc" id="L23043">                        critIndex = Tank.CRIT_CREW_STUNNED;</span>
                    }
<span class="nc" id="L23045">                    vDesc.addAll(applyCriticalHit(te, Entity.NONE, new CriticalSlot(0, critIndex), true, 0, false));</span>
                }

                // is there internal structure in the location hit?
<span class="nc bnc" id="L23049" title="All 2 branches missed.">                if (te.getInternal(hit) &gt; 0) {</span>

                    // Now we need to consider alternate structure types!
<span class="nc" id="L23052">                    int tmpDamageHold = -1;</span>
<span class="nc bnc" id="L23053" title="All 2 branches missed.">                    if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23054" title="All 2 branches missed.">                        &amp;&amp; ((Mech) te).hasCompositeStructure()) {</span>
<span class="nc" id="L23055">                        tmpDamageHold = damage;</span>
<span class="nc" id="L23056">                        damage *= 2;</span>
<span class="nc" id="L23057">                        r = new Report(6091);</span>
<span class="nc" id="L23058">                        r.subject = te_n;</span>
<span class="nc" id="L23059">                        r.indent(3);</span>
<span class="nc" id="L23060">                        vDesc.add(r);</span>
                    }
<span class="nc bnc" id="L23062" title="All 2 branches missed.">                    if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23063" title="All 2 branches missed.">                        &amp;&amp; ((Mech) te).hasReinforcedStructure()) {</span>
<span class="nc" id="L23064">                        tmpDamageHold = damage;</span>
<span class="nc" id="L23065">                        damage /= 2;</span>
<span class="nc" id="L23066">                        damage += tmpDamageHold % 2;</span>
<span class="nc" id="L23067">                        r = new Report(6092);</span>
<span class="nc" id="L23068">                        r.subject = te_n;</span>
<span class="nc" id="L23069">                        r.indent(3);</span>
<span class="nc" id="L23070">                        vDesc.add(r);</span>
                    }
<span class="nc bnc" id="L23072" title="All 4 branches missed.">                    if ((te.getInternal(hit) &gt; damage) &amp;&amp; (damage &gt; 0)) {</span>
                        // internal structure absorbs all damage
<span class="nc" id="L23074">                        te.setInternal(te.getInternal(hit) - damage, hit);</span>
                        // Triggers a critical hit on Vehicles and Mechs.
<span class="nc bnc" id="L23076" title="All 4 branches missed.">                        if (!isPlatoon &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L23077">                            crits++;</span>
                        }
<span class="nc" id="L23079">                        tookInternalDamage = true;</span>
                        // Alternate structures don't affect our damage total
                        // for later PSR purposes, so use the previously stored
                        // value here as necessary.
<span class="nc bnc" id="L23083" title="All 2 branches missed.">                        te.damageThisPhase += (tmpDamageHold &gt; -1) ?</span>
<span class="nc" id="L23084">                                tmpDamageHold : damage;</span>
<span class="nc" id="L23085">                        damage = 0;</span>
<span class="nc" id="L23086">                        r = new Report(6100);</span>
<span class="nc" id="L23087">                        r.subject = te_n;</span>
<span class="nc" id="L23088">                        r.indent(3);</span>
                        // Infantry platoons have men not &quot;Internals&quot;.
<span class="nc bnc" id="L23090" title="All 2 branches missed.">                        if (isPlatoon) {</span>
<span class="nc" id="L23091">                            r.messageId = 6095;</span>
                        }
<span class="nc" id="L23093">                        r.add(te.getInternal(hit));</span>
<span class="nc" id="L23094">                        vDesc.addElement(r);</span>
<span class="nc bnc" id="L23095" title="All 2 branches missed.">                    } else if (damage &gt; 0) {</span>
                        // Triggers a critical hit on Vehicles and Mechs.
<span class="nc bnc" id="L23097" title="All 4 branches missed.">                        if (!isPlatoon &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L23098">                            crits++;</span>
                        }
                        // damage transfers, maybe
<span class="nc" id="L23101">                        int absorbed = Math.max(te.getInternal(hit), 0);</span>

                        // Handle ProtoMech pilot damage
                        // due to location destruction
<span class="nc bnc" id="L23105" title="All 2 branches missed.">                        if (te instanceof Protomech) {</span>
<span class="nc" id="L23106">                            int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L23107">                                    - ((Protomech) te).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L23108" title="All 2 branches missed.">                            if (hits &gt; 0) {</span>
<span class="nc" id="L23109">                                vDesc.addAll(damageCrew(te, hits));</span>
<span class="nc" id="L23110">                                ((Protomech) te).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L23111">                                        Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                            }
                        }

                        // Platoon, Trooper, or Section destroyed message
<span class="nc" id="L23116">                        r = new Report(1210);</span>
<span class="nc" id="L23117">                        r.subject = te_n;</span>
<span class="nc bnc" id="L23118" title="All 2 branches missed.">                        if (isPlatoon) {</span>
                            // Infantry have only one section, and
                            // are therefore destroyed.
<span class="nc bnc" id="L23121" title="All 2 branches missed.">                            if (((Infantry) te).isSquad()) {</span>
<span class="nc" id="L23122">                                r.messageId = 6106; // Squad Killed</span>
                            } else {
<span class="nc" id="L23124">                                r.messageId = 6105; // Platoon Killed</span>
                            }
<span class="nc bnc" id="L23126" title="All 2 branches missed.">                        } else if (isBattleArmor) {</span>
<span class="nc" id="L23127">                            r.messageId = 6110;</span>
                        } else {
<span class="nc" id="L23129">                            r.messageId = 6115;</span>
                        }
<span class="nc" id="L23131">                        r.indent(3);</span>
<span class="nc" id="L23132">                        vDesc.addElement(r);</span>

                        // If a sidetorso got destroyed, and the
                        // corresponding arm is not yet destroyed, add
                        // it as a club to that hex (p.35 BMRr)
<span class="nc bnc" id="L23137" title="All 2 branches missed.">                        if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23138" title="All 2 branches missed.">                                &amp;&amp; (((hit.getLocation() == Mech.LOC_RT)</span>
<span class="nc bnc" id="L23139" title="All 2 branches missed.">                                        &amp;&amp; (te.getInternal(Mech.LOC_RARM) &gt; 0))</span>
<span class="nc bnc" id="L23140" title="All 2 branches missed.">                                    || ((hit.getLocation() == Mech.LOC_LT)</span>
<span class="nc bnc" id="L23141" title="All 2 branches missed.">                                        &amp;&amp; (te.getInternal(Mech.LOC_LARM) &gt; 0)))) {</span>
                            int blownOffLocation;
<span class="nc bnc" id="L23143" title="All 2 branches missed.">                            if (hit.getLocation() == Mech.LOC_RT) {</span>
<span class="nc" id="L23144">                                blownOffLocation = Mech.LOC_RARM;</span>
                            } else {
<span class="nc" id="L23146">                                blownOffLocation = Mech.LOC_LARM;</span>
                            }
<span class="nc" id="L23148">                            te.destroyLocation(blownOffLocation, true);</span>
<span class="nc" id="L23149">                            r = new Report(6120);</span>
<span class="nc" id="L23150">                            r.subject = te_n;</span>
<span class="nc" id="L23151">                            r.add(te.getLocationName(blownOffLocation));</span>
<span class="nc" id="L23152">                            vDesc.addElement(r);</span>
<span class="nc" id="L23153">                            IHex h = game.getBoard().getHex(te.getPosition());</span>
<span class="nc bnc" id="L23154" title="All 2 branches missed.">                            if(null != h) {</span>
<span class="nc bnc" id="L23155" title="All 2 branches missed.">                                if (te instanceof BipedMech) {</span>
<span class="nc bnc" id="L23156" title="All 2 branches missed.">                                    if (!h.containsTerrain(Terrains.ARMS)) {</span>
<span class="nc" id="L23157">                                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L23158">                                                             .createTerrain(Terrains.ARMS, 1));</span>
                                    } else {
<span class="nc" id="L23160">                                        h.addTerrain(Terrains</span>
<span class="nc" id="L23161">                                                             .getTerrainFactory()</span>
<span class="nc" id="L23162">                                                             .createTerrain(</span>
                                                                     Terrains.ARMS,
<span class="nc" id="L23164">                                                                     h.terrainLevel(Terrains.ARMS) + 1));</span>
                                    }
<span class="nc bnc" id="L23166" title="All 2 branches missed.">                                } else if (!h.containsTerrain(Terrains.LEGS)) {</span>
<span class="nc" id="L23167">                                    h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L23168">                                                         .createTerrain(Terrains.LEGS, 1));</span>
                                } else {
<span class="nc" id="L23170">                                    h.addTerrain(Terrains</span>
<span class="nc" id="L23171">                                                         .getTerrainFactory()</span>
<span class="nc" id="L23172">                                                         .createTerrain(</span>
                                                                 Terrains.LEGS,
<span class="nc" id="L23174">                                                                 h.terrainLevel(Terrains.LEGS) + 1));</span>
                                }
<span class="nc" id="L23176">                                sendChangedHex(te.getPosition());</span>
                            }
                        }

                        // Troopers riding on a location
                        // all die when the location is destroyed.
<span class="nc bnc" id="L23182" title="All 4 branches missed.">                        if ((te instanceof Mech) || (te instanceof Tank)) {</span>
<span class="nc" id="L23183">                            Entity passenger = te.getExteriorUnitAt(</span>
<span class="nc" id="L23184">                                    hit.getLocation(), hit.isRear());</span>
<span class="nc bnc" id="L23185" title="All 4 branches missed.">                            if ((null != passenger) &amp;&amp; !passenger.isDoomed()) {</span>
<span class="nc" id="L23186">                                HitData passHit = passenger</span>
<span class="nc" id="L23187">                                        .getTrooperAtLocation(hit, te);</span>
                                // ensures a kill
<span class="nc" id="L23189">                                passHit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc bnc" id="L23190" title="All 2 branches missed.">                                if (passenger.getInternal(passHit) &gt; 0) {</span>
<span class="nc" id="L23191">                                    vDesc.addAll(damageEntity(passenger,</span>
                                                              passHit, damage));
                                }
<span class="nc" id="L23194">                                passHit = new HitData(hit.getLocation(),</span>
<span class="nc bnc" id="L23195" title="All 2 branches missed.">                                                      !hit.isRear());</span>
<span class="nc" id="L23196">                                passHit = passenger.getTrooperAtLocation(</span>
                                        passHit, te);
                                // ensures a kill
<span class="nc" id="L23199">                                passHit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc bnc" id="L23200" title="All 2 branches missed.">                                if (passenger.getInternal(passHit) &gt; 0) {</span>
<span class="nc" id="L23201">                                    vDesc.addAll(damageEntity(passenger,</span>
                                                              passHit, damage));
                                }
                            }
                        }

                        // BA inferno explosions
<span class="nc bnc" id="L23208" title="All 2 branches missed.">                        if (te instanceof BattleArmor) {</span>
<span class="nc" id="L23209">                            int infernos = 0;</span>
<span class="nc bnc" id="L23210" title="All 2 branches missed.">                            for (Mounted m : te.getEquipment()) {</span>
<span class="nc bnc" id="L23211" title="All 2 branches missed.">                                if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L23212">                                    AmmoType at = (AmmoType) m.getType();</span>
<span class="nc bnc" id="L23213" title="All 4 branches missed.">                                    if (((at.getAmmoType() == AmmoType.T_SRM) || (at.getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L23214" title="All 2 branches missed.">                                            &amp;&amp; (at.getMunitionType() == AmmoType.M_INFERNO)) {</span>
<span class="nc" id="L23215">                                        infernos += at.getRackSize() * m.getHittableShotsLeft();</span>
                                    }
<span class="nc bnc" id="L23217" title="All 2 branches missed.">                                } else if (m.getType().hasFlag(MiscType.F_FIRE_RESISTANT)) {</span>
                                    // immune to inferno explosion
<span class="nc" id="L23219">                                    infernos = 0;</span>
<span class="nc" id="L23220">                                    break;</span>
                                }
<span class="nc" id="L23222">                            }</span>
<span class="nc bnc" id="L23223" title="All 2 branches missed.">                            if (infernos &gt; 0) {</span>
<span class="nc" id="L23224">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L23225">                                r = new Report(6680);</span>
<span class="nc" id="L23226">                                r.add(roll);</span>
<span class="nc" id="L23227">                                vDesc.add(r);</span>
<span class="nc bnc" id="L23228" title="All 2 branches missed.">                                if (roll &gt;= 8) {</span>
<span class="nc" id="L23229">                                    Coords c = te.getPosition();</span>
<span class="nc bnc" id="L23230" title="All 2 branches missed.">                                    if (c == null) {</span>
<span class="nc" id="L23231">                                        Entity transport = game.getEntity(te.getTransportId());</span>
<span class="nc bnc" id="L23232" title="All 2 branches missed.">                                        if (transport != null) {</span>
<span class="nc" id="L23233">                                            c = transport.getPosition();</span>
                                        }
<span class="nc" id="L23235">                                        vPhaseReport.addAll(deliverInfernoMissiles(te, te, infernos));</span>
                                    }
<span class="nc bnc" id="L23237" title="All 2 branches missed.">                                    if (c != null) {</span>
<span class="nc" id="L23238">                                        vPhaseReport.addAll(deliverInfernoMissiles(te,</span>
<span class="nc" id="L23239">                                                new HexTarget(c, game.getBoard(), Targetable.TYPE_HEX_ARTILLERY),</span>
                                                infernos));
                                    }
                                }
                            }
                        }

                        // Mark off the internal structure here, but *don't*
                        // destroy the location just yet -- there are checks
                        // still to run!
<span class="nc" id="L23249">                        te.setInternal(0, hit);</span>
<span class="nc" id="L23250">                        te.damageThisPhase += absorbed;</span>
<span class="nc" id="L23251">                        damage -= absorbed;</span>

                        // Now we need to consider alternate structure types!
<span class="nc bnc" id="L23254" title="All 2 branches missed.">                        if (tmpDamageHold &gt; 0) {</span>
<span class="nc bnc" id="L23255" title="All 2 branches missed.">                            if (((Mech) te).hasCompositeStructure()) {</span>
                                // If there's a remainder, we can actually
                                // ignore it.
<span class="nc" id="L23258">                                damage /= 2;</span>
<span class="nc bnc" id="L23259" title="All 2 branches missed.">                            } else if (((Mech) te).hasReinforcedStructure()) {</span>
<span class="nc" id="L23260">                                damage *= 2;</span>
<span class="nc" id="L23261">                                damage -= tmpDamageHold % 2;</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L23266" title="All 2 branches missed.">                if (te.getInternal(hit) &lt;= 0) {</span>
                    // internal structure is gone, what are the transfer
                    // potentials?
<span class="nc" id="L23269">                    nextHit = te.getTransferLocation(hit);</span>
<span class="nc bnc" id="L23270" title="All 2 branches missed.">                    if (nextHit.getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc bnc" id="L23271" title="All 2 branches missed.">                        if (te instanceof Mech) {</span>
                            // Start with the number of engine crits in this
                            // location, if any...
<span class="nc" id="L23274">                            te.engineHitsThisPhase += te.getNumberOfCriticals(</span>
                                    CriticalSlot.TYPE_SYSTEM,
<span class="nc" id="L23276">                                    Mech.SYSTEM_ENGINE, hit.getLocation());</span>
                            // ...then deduct the ones destroyed previously or
                            // critically
                            // hit this round already. That leaves the ones
                            // actually
                            // destroyed with the location.
<span class="nc" id="L23282">                            te.engineHitsThisPhase -= te.getHitCriticals(</span>
                                    CriticalSlot.TYPE_SYSTEM,
<span class="nc" id="L23284">                                    Mech.SYSTEM_ENGINE, hit.getLocation());</span>
                        }

<span class="nc" id="L23287">                        boolean engineExploded = checkEngineExplosion(te,</span>
                                vDesc, te.engineHitsThisPhase);

<span class="nc bnc" id="L23290" title="All 2 branches missed.">                        if (!engineExploded) {</span>
                            // Entity destroyed. Ammo explosions are
                            // neither survivable nor salvageable.
                            // Only ammo explosions in the CT are devastating.
<span class="nc bnc" id="L23294" title="All 10 branches missed.">                            vDesc.addAll(destroyEntity(te, &quot;damage&quot;, !ammoExplosion,</span>
                                    !((ammoExplosion || areaSatArty) &amp;&amp; ((te instanceof Tank)
<span class="nc bnc" id="L23296" title="All 2 branches missed.">                                            || ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_CT))))));</span>
                            // If the head is destroyed, kill the crew.

<span class="nc bnc" id="L23299" title="All 4 branches missed.">                            if ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L23300" title="All 4 branches missed.">                                    &amp;&amp; !te.getCrew().isDead() &amp;&amp; !te.getCrew().isDoomed()</span>
<span class="nc bnc" id="L23301" title="All 2 branches missed.">                                    &amp;&amp; game.getOptions().booleanOption(</span>
                                            OptionsConstants.ADVANCED_TACOPS_SKIN_OF_THE_TEETH_EJECTION)) {
<span class="nc" id="L23303">                                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L23304" title="All 2 branches missed.">                                if (mech.isAutoEject()</span>
<span class="nc bnc" id="L23305" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23307" title="All 2 branches missed.">                                        || (game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23309" title="All 2 branches missed.">                                                &amp;&amp; mech.isCondEjectHeadshot()))) {</span>
<span class="nc" id="L23310">                                    autoEject = true;</span>
<span class="nc" id="L23311">                                    vDesc.addAll(ejectEntity(te, true, true));</span>
                                }
                            }

<span class="nc bnc" id="L23315" title="All 4 branches missed.">                            if ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_CT)</span>
<span class="nc bnc" id="L23316" title="All 4 branches missed.">                                    &amp;&amp; !te.getCrew().isDead() &amp;&amp; !te.getCrew().isDoomed()) {</span>
<span class="nc" id="L23317">                                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L23318" title="All 2 branches missed.">                                if (mech.isAutoEject()</span>
<span class="nc bnc" id="L23319" title="All 2 branches missed.">                                        &amp;&amp; game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23321" title="All 2 branches missed.">                                        &amp;&amp; mech.isCondEjectCTDest()) {</span>
<span class="nc bnc" id="L23322" title="All 2 branches missed.">                                    if (mech.getCrew().getHits() &lt; 5) {</span>
<span class="nc" id="L23323">                                        Report.addNewline(vDesc);</span>
<span class="nc" id="L23324">                                        mech.setDoomed(false);</span>
<span class="nc" id="L23325">                                        mech.setDoomed(true);</span>
                                    }
<span class="nc" id="L23327">                                    autoEject = true;</span>
<span class="nc" id="L23328">                                    vDesc.addAll(ejectEntity(te, true));</span>
                                }
                            }

<span class="nc bnc" id="L23332" title="All 2 branches missed.">                            if ((hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L23333" title="All 8 branches missed.">                                    || ((hit.getLocation() == Mech.LOC_CT)</span>
                                    &amp;&amp; ((ammoExplosion &amp;&amp; !autoEject) || areaSatArty))) {
<span class="nc" id="L23335">                                te.getCrew().setDoomed(true);</span>
                            }
<span class="nc bnc" id="L23337" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {
<span class="nc" id="L23339">                                vDesc.addAll(abandonEntity(te));</span>
                            }
                        }

                        // nowhere for further damage to go
<span class="nc" id="L23344">                        damage = 0;</span>
<span class="nc bnc" id="L23345" title="All 2 branches missed.">                    } else if (nextHit.getLocation() == Entity.LOC_NONE) {</span>
                        // Rest of the damage is wasted.
<span class="nc" id="L23347">                        damage = 0;</span>
<span class="nc bnc" id="L23348" title="All 2 branches missed.">                    } else if (ammoExplosion</span>
<span class="nc bnc" id="L23349" title="All 2 branches missed.">                               &amp;&amp; te.locationHasCase(hit.getLocation())) {</span>
                        // Remaining damage prevented by CASE
<span class="nc" id="L23351">                        r = new Report(6125);</span>
<span class="nc" id="L23352">                        r.subject = te_n;</span>
<span class="nc" id="L23353">                        r.add(damage);</span>
<span class="nc" id="L23354">                        r.indent(3);</span>
<span class="nc" id="L23355">                        vDesc.addElement(r);</span>

                        // The target takes no more damage from the explosion.
<span class="nc" id="L23358">                        damage = 0;</span>
<span class="nc bnc" id="L23359" title="All 2 branches missed.">                    } else if (damage &gt; 0) {</span>
                        // remaining damage transfers
<span class="nc" id="L23361">                        r = new Report(6130);</span>
<span class="nc" id="L23362">                        r.subject = te_n;</span>
<span class="nc" id="L23363">                        r.indent(2);</span>
<span class="nc" id="L23364">                        r.add(damage);</span>
<span class="nc" id="L23365">                        r.add(te.getLocationAbbr(nextHit));</span>
<span class="nc" id="L23366">                        vDesc.addElement(r);</span>

                        // If there are split weapons in this location, mark it
                        // as hit, even if it took no criticals.
<span class="nc bnc" id="L23370" title="All 2 branches missed.">                        for (Mounted m : te.getWeaponList()) {</span>
<span class="nc bnc" id="L23371" title="All 2 branches missed.">                            if (m.isSplit()) {</span>
<span class="nc bnc" id="L23372" title="All 2 branches missed.">                                if ((m.getLocation() == hit.getLocation())</span>
<span class="nc" id="L23373">                                    || (m.getLocation() == nextHit</span>
<span class="nc bnc" id="L23374" title="All 2 branches missed.">                                        .getLocation())) {</span>
<span class="nc" id="L23375">                                    te.setWeaponHit(m);</span>
                                }
                            }
<span class="nc" id="L23378">                        }</span>
                        // if this is damage from a nail/rivet gun, and we
                        // transfer
                        // to a location that has armor, and BAR &gt;=5, no damage
<span class="nc bnc" id="L23382" title="All 2 branches missed.">                        if ((bFrag == DamageType.NAIL_RIVET)</span>
<span class="nc bnc" id="L23383" title="All 2 branches missed.">                            &amp;&amp; (te.getArmor(nextHit.getLocation()) &gt; 0)</span>
<span class="nc bnc" id="L23384" title="All 2 branches missed.">                            &amp;&amp; (te.getBARRating(nextHit.getLocation()) &gt;= 5)) {</span>
<span class="nc" id="L23385">                            damage = 0;</span>
<span class="nc" id="L23386">                            r = new Report(6065);</span>
<span class="nc" id="L23387">                            r.subject = te_n;</span>
<span class="nc" id="L23388">                            r.indent(2);</span>
<span class="nc" id="L23389">                            vDesc.add(r);</span>
                        }
                    }
                }
<span class="nc bnc" id="L23393" title="All 2 branches missed.">            } else if (hit.getSpecCrit()) {</span>
                // ok, we dealt damage but didn't go on to internal
                // we get a chance of a crit, using Armor Piercing.
                // but only if we don't have hardened, Ferro-Lamellor, or reactive armor
<span class="nc bnc" id="L23397" title="All 6 branches missed.">                if (!hardenedArmor &amp;&amp; !ferroLamellorArmor &amp;&amp; !reactiveArmor) {</span>
<span class="nc" id="L23398">                    specCrits++;</span>
                }
            }
            // check for breaching
<span class="nc" id="L23402">            vDesc.addAll(breachCheck(te, hit.getLocation(), null, underWater));</span>

            // resolve special results
<span class="nc bnc" id="L23405" title="All 2 branches missed.">            if ((hit.getEffect() &amp; HitData.EFFECT_VEHICLE_MOVE_DAMAGED) == HitData.EFFECT_VEHICLE_MOVE_DAMAGED) {</span>
<span class="nc" id="L23406">                vDesc.addAll(vehicleMotiveDamage((Tank) te, hit.getMotiveMod()));</span>
            }
            // Damage from any source can break spikes
<span class="nc bnc" id="L23409" title="All 2 branches missed.">            if (te.hasWorkingMisc(MiscType.F_SPIKES, -1, hit.getLocation())) {</span>
<span class="nc" id="L23410">                vDesc.add(checkBreakSpikes(te, hit.getLocation()));</span>
            }

            // roll all critical hits against this location
            // unless the section destroyed in a previous phase?
            // Cause a crit.
<span class="nc bnc" id="L23416" title="All 2 branches missed.">            if ((te.getInternal(hit) != IArmorState.ARMOR_DESTROYED)</span>
<span class="nc bnc" id="L23417" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc bnc" id="L23418" title="All 2 branches missed.">                for (int i = 0; i &lt; crits; i++) {</span>
<span class="nc" id="L23419">                    vDesc.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
<span class="nc" id="L23420">                            hit.glancingMod() + critBonus, damage_orig));</span>
                }
<span class="nc" id="L23422">                crits = 0;</span>

<span class="nc bnc" id="L23424" title="All 2 branches missed.">                for (int i = 0; i &lt; specCrits; i++) {</span>
                    // against BAR or reflective armor, we get a +2 mod
<span class="nc bnc" id="L23426" title="All 2 branches missed.">                    int critMod = te.hasBARArmor(hit.getLocation()) ? 2 : 0;</span>
<span class="nc bnc" id="L23427" title="All 4 branches missed.">                    critMod += (reflectiveArmor &amp;&amp; !isBattleArmor) ? 2 : 0; // BA</span>
                    // against impact armor, we get a +1 mod
<span class="nc bnc" id="L23429" title="All 2 branches missed.">                    critMod += impactArmor ? 1 : 0;</span>
                    // hardened armour has no crit penalty
<span class="nc bnc" id="L23431" title="All 2 branches missed.">                    if (!hardenedArmor) {</span>
                        // non-hardened armor gets modifiers
                        // the -2 for hardened is handled in the critBonus
                        // variable
<span class="nc" id="L23435">                        critMod += hit.getSpecCritMod();</span>
<span class="nc" id="L23436">                        critMod += hit.glancingMod();</span>
                    }
<span class="nc" id="L23438">                    vDesc.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
                            critMod + critBonus, damage_orig));
                }
<span class="nc" id="L23441">                specCrits = 0;</span>
            }

            // resolve Aero crits
<span class="nc bnc" id="L23445" title="All 2 branches missed.">            if (te instanceof Aero) {</span>
<span class="nc" id="L23446">                checkAeroCrits(vDesc, (Aero) te, hit, damage_orig, critThresh, critSI,</span>
                        ammoExplosion, nukeS2S);
            }

<span class="nc bnc" id="L23450" title="All 2 branches missed.">            if (isHeadHit</span>
<span class="nc bnc" id="L23451" title="All 2 branches missed.">                &amp;&amp; !te.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L23452">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23453">                vDesc.addAll(damageCrew(te, 1));</span>
            }

            // If the location has run out of internal structure, finally
            // actually
            // destroy it here. *EXCEPTION:* Aero units have 0 internal
            // structure
            // in every location by default and are handled elsewhere, so they
            // get a bye.
<span class="nc bnc" id="L23462" title="All 4 branches missed.">            if (!(te instanceof Aero) &amp;&amp; (te.getInternal(hit) &lt;= 0)) {</span>
<span class="nc" id="L23463">                te.destroyLocation(hit.getLocation());</span>

                // Check for possible engine destruction here
<span class="nc bnc" id="L23466" title="All 2 branches missed.">                if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23467" title="All 4 branches missed.">                        &amp;&amp; ((hit.getLocation() == Mech.LOC_RT) || (hit.getLocation() == Mech.LOC_LT))) {</span>

<span class="nc" id="L23469">                    int numEngineHits = te.getEngineHits();</span>
<span class="nc" id="L23470">                    boolean engineExploded = checkEngineExplosion(te, vDesc, numEngineHits);</span>

<span class="nc" id="L23472">                    int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L23473" title="All 6 branches missed.">                    if ((te instanceof Mech) &amp;&amp; te.isSuperHeavy() &amp;&amp; te.hasEngine()</span>
<span class="nc bnc" id="L23474" title="All 2 branches missed.">                            &amp;&amp; (te.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L23475">                        hitsToDestroy = 2;</span>
                    }

<span class="nc bnc" id="L23478" title="All 4 branches missed.">                    if (!engineExploded &amp;&amp; (numEngineHits &gt;= hitsToDestroy)) {</span>
                        // third engine hit
<span class="nc" id="L23480">                        vDesc.addAll(destroyEntity(te, &quot;engine destruction&quot;));</span>
<span class="nc" id="L23481">                        if (game.getOptions()</span>
<span class="nc bnc" id="L23482" title="All 2 branches missed.">                                .booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L23483">                            vDesc.addAll(abandonEntity(te));</span>
                        }
<span class="nc" id="L23485">                        te.setSelfDestructing(false);</span>
<span class="nc" id="L23486">                        te.setSelfDestructInitiated(false);</span>
                    }

                    // Torso destruction in airborne LAM causes immediate crash.
<span class="nc bnc" id="L23490" title="All 6 branches missed.">                    if ((te instanceof LandAirMech) &amp;&amp; !te.isDestroyed() &amp;&amp; !te.isDoomed()) {</span>
<span class="nc" id="L23491">                        r = new Report(9710);</span>
<span class="nc" id="L23492">                        r.subject = te.getId();</span>
<span class="nc" id="L23493">                        r.addDesc(te);</span>
<span class="nc bnc" id="L23494" title="All 2 branches missed.">                        if (te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L23495">                            vDesc.add(r);</span>
<span class="nc" id="L23496">                            crashAirMech(te, new PilotingRollData(te.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                                    &quot;side torso destroyed&quot;), vDesc);
<span class="nc bnc" id="L23498" title="All 4 branches missed.">                        } else if (te.isAirborne() &amp;&amp; te.isAero()) {</span>
<span class="nc" id="L23499">                            vDesc.add(r);</span>
<span class="nc" id="L23500">                            vDesc.addAll(processCrash(te, ((IAero)te).getCurrentVelocity(), te.getPosition()));</span>
                        }
                    }
                }

            }

            // If damage remains, loop to next location; if not, be sure to stop
            // here because we may need to refer back to the last *damaged*
            // location again later. (This is safe because at damage &lt;= 0 the
            // loop terminates anyway.)
<span class="nc bnc" id="L23511" title="All 2 branches missed.">            if (damage &gt; 0) {</span>
<span class="nc" id="L23512">                hit = nextHit;</span>
                // Need to update armor status for the new location
<span class="nc bnc" id="L23514" title="All 4 branches missed.">                hardenedArmor = ((te instanceof Mech) || (te instanceof Tank))</span>
<span class="nc bnc" id="L23515" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED);</span>
<span class="nc bnc" id="L23516" title="All 6 branches missed.">                ferroLamellorArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23517" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_LAMELLOR);</span>
<span class="nc bnc" id="L23518" title="All 6 branches missed.">                reflectiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23519" title="All 4 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REFLECTIVE))</span>
                        || (isBattleArmor
<span class="nc bnc" id="L23521" title="All 2 branches missed.">                                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REFLECTIVE));</span>
<span class="nc bnc" id="L23522" title="All 6 branches missed.">                reactiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23523" title="All 4 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REACTIVE))</span>
<span class="nc bnc" id="L23524" title="All 2 branches missed.">                        || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REACTIVE));</span>
<span class="nc bnc" id="L23525" title="All 6 branches missed.">                ballisticArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23526" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BALLISTIC_REINFORCED);</span>
<span class="nc bnc" id="L23527" title="All 2 branches missed.">                impactArmor = (te instanceof Mech)</span>
<span class="nc bnc" id="L23528" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_IMPACT_RESISTANT);</span>
            }
<span class="nc bnc" id="L23530" title="All 2 branches missed.">            if (damageIS) {</span>
<span class="nc" id="L23531">                wasDamageIS = true;</span>
<span class="nc" id="L23532">                damageIS = false;</span>
            }
        }
        // Mechs using EI implants take pilot damage each time a hit
        // inflicts IS damage
<span class="nc bnc" id="L23537" title="All 6 branches missed.">        if (tookInternalDamage</span>
            &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))
<span class="nc bnc" id="L23539" title="All 2 branches missed.">            &amp;&amp; te.hasActiveEiCockpit()) {</span>
<span class="nc" id="L23540">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23541">            int roll = Compute.d6(2);</span>
<span class="nc" id="L23542">            r = new Report(5075);</span>
<span class="nc" id="L23543">            r.subject = te.getId();</span>
<span class="nc" id="L23544">            r.addDesc(te);</span>
<span class="nc" id="L23545">            r.add(7);</span>
<span class="nc" id="L23546">            r.add(roll);</span>
<span class="nc bnc" id="L23547" title="All 2 branches missed.">            r.choose(roll &gt;= 7);</span>
<span class="nc" id="L23548">            r.indent(2);</span>
<span class="nc" id="L23549">            vDesc.add(r);</span>
<span class="nc bnc" id="L23550" title="All 2 branches missed.">            if (roll &lt; 7) {</span>
<span class="nc" id="L23551">                vDesc.addAll(damageCrew(te, 1));</span>
            }
        }

        // if using VDNI (but not buffered), check for damage on an internal hit
<span class="nc bnc" id="L23556" title="All 2 branches missed.">        if (tookInternalDamage</span>
<span class="nc bnc" id="L23557" title="All 2 branches missed.">            &amp;&amp; te.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L23558" title="All 2 branches missed.">            &amp;&amp; !te.hasAbility(OptionsConstants.MD_BVDNI)</span>
<span class="nc bnc" id="L23559" title="All 2 branches missed.">            &amp;&amp; !te.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L23560">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23561">            int roll = Compute.d6(2);</span>
<span class="nc" id="L23562">            r = new Report(3580);</span>
<span class="nc" id="L23563">            r.subject = te.getId();</span>
<span class="nc" id="L23564">            r.addDesc(te);</span>
<span class="nc" id="L23565">            r.add(7);</span>
<span class="nc" id="L23566">            r.add(roll);</span>
<span class="nc bnc" id="L23567" title="All 2 branches missed.">            r.choose(roll &gt;= 8);</span>
<span class="nc" id="L23568">            r.indent(2);</span>
<span class="nc" id="L23569">            vDesc.add(r);</span>
<span class="nc bnc" id="L23570" title="All 2 branches missed.">            if (roll &gt;= 8) {</span>
<span class="nc" id="L23571">                vDesc.addAll(damageCrew(te, 1));</span>
            }
        }

        // TacOps p.78 Ammo booms can hurt other units in same and adjacent hexes
        // But, this does not apply to CASE'd units and it only applies if the
        // ammo explosion
        // destroyed the unit
<span class="nc bnc" id="L23579" title="All 4 branches missed.">        if (ammoExplosion &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_AMMUNITION)</span>
            // For 'Mechs we care whether there was CASE specifically in the
            // location that went boom...
<span class="nc bnc" id="L23582" title="All 8 branches missed.">            &amp;&amp; !(te.locationHasCase(hit.getLocation()) || te.hasCASEII(hit.getLocation()))</span>
            // ...but vehicles and ASFs just have one CASE item for the
            // whole unit, so we need to look whether there's CASE anywhere
            // at all.
            &amp;&amp; !(((te instanceof Tank) || (te instanceof Aero)) &amp;&amp; te
<span class="nc bnc" id="L23587" title="All 10 branches missed.">                .hasCase()) &amp;&amp; (te.isDestroyed() || te.isDoomed())</span>
            &amp;&amp; (damage_orig &gt; 0) &amp;&amp; ((damage_orig / 10) &gt; 0)) {
<span class="nc" id="L23589">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23590">            r = new Report(5068, Report.PUBLIC);</span>
<span class="nc" id="L23591">            r.subject = te.getId();</span>
<span class="nc" id="L23592">            r.addDesc(te);</span>
<span class="nc" id="L23593">            r.indent(2);</span>
<span class="nc" id="L23594">            vDesc.add(r);</span>
<span class="nc" id="L23595">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23596">            r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L23597">            r.subject = te.getId();</span>
<span class="nc" id="L23598">            r.indent(2);</span>
<span class="nc" id="L23599">            vDesc.add(r);</span>
<span class="nc" id="L23600">            int[] damages = {(int) Math.floor(damage_orig / 10.0),</span>
<span class="nc" id="L23601">                             (int) Math.floor(damage_orig / 20.0)};</span>
<span class="nc" id="L23602">            doExplosion(damages, false, te.getPosition(), true, vDesc, null, 5,</span>
<span class="nc" id="L23603">                        te.getId(), false);</span>
<span class="nc" id="L23604">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23605">            r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L23606">            r.subject = te.getId();</span>
<span class="nc" id="L23607">            r.indent(2);</span>
<span class="nc" id="L23608">            vDesc.add(r);</span>
        }

        // This flag indicates the hit was directly to IS
<span class="nc bnc" id="L23612" title="All 2 branches missed.">        if (wasDamageIS) {</span>
<span class="nc" id="L23613">            Report.addNewline(vDesc);</span>
        }
<span class="nc" id="L23615">        return vDesc;</span>
    }

    /**
     * Apply damage to an Entity carrying external Battle Armor or ProtoMech
     * when a location with a trooper present is hit.
     *
     * @param te             The carrying Entity
     * @param hit            The hit to resolve
     * @param damage         The amount of damage to be allocated
     * @param vDesc          The report vector
     * @param passenger      The BA squad
     * @return               The amount of damage remaining
     */
    private int damageExternalPassenger(Entity te, HitData hit, int damage, Vector&lt;Report&gt; vDesc,
                                        Entity passenger) {
        Report r;
<span class="nc" id="L23632">        int passengerDamage = damage;</span>
<span class="nc" id="L23633">        int avoidRoll = Compute.d6();</span>
<span class="nc" id="L23634">        HitData passHit = passenger.getTrooperAtLocation(hit, te);</span>
<span class="nc bnc" id="L23635" title="All 2 branches missed.">        if (passenger.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L23636">            passengerDamage -= damage / 2;</span>
<span class="nc" id="L23637">            passHit = passenger.rollHitLocation(ToHitData.HIT_SPECIAL_PROTO, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L23638" title="All 2 branches missed.">        } else if (avoidRoll &lt; 5) {</span>
<span class="nc" id="L23639">            passengerDamage = 0;</span>
        }
<span class="nc" id="L23641">        passHit.setGeneralDamageType(hit.getGeneralDamageType());</span>

<span class="nc bnc" id="L23643" title="All 2 branches missed.">        if (passengerDamage &gt; 0) {</span>
            // Yup. Roll up some hit data for that passenger.
<span class="nc" id="L23645">            r = new Report(6075);</span>
<span class="nc" id="L23646">            r.subject = passenger.getId();</span>
<span class="nc" id="L23647">            r.indent(3);</span>
<span class="nc" id="L23648">            r.addDesc(passenger);</span>
<span class="nc" id="L23649">            vDesc.addElement(r);</span>

            // How much damage will the passenger absorb?
<span class="nc" id="L23652">            int absorb = 0;</span>
<span class="nc" id="L23653">            HitData nextPassHit = passHit;</span>
            do {
<span class="nc" id="L23655">                int armorType = passenger.getArmorType(nextPassHit.getLocation());</span>
<span class="nc" id="L23656">                boolean armorDamageReduction = false;</span>
<span class="nc bnc" id="L23657" title="All 2 branches missed.">                if (((armorType == EquipmentType.T_ARMOR_BA_REACTIVE)</span>
<span class="nc bnc" id="L23658" title="All 2 branches missed.">                        &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE)))</span>
<span class="nc bnc" id="L23659" title="All 2 branches missed.">                        || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE)) {</span>
<span class="nc" id="L23660">                    armorDamageReduction = true;</span>
                }
                // Check for reflective armor
<span class="nc bnc" id="L23663" title="All 2 branches missed.">                if ((armorType == EquipmentType.T_ARMOR_BA_REFLECTIVE)</span>
<span class="nc bnc" id="L23664" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_ENERGY)) {</span>
<span class="nc" id="L23665">                    armorDamageReduction = true;</span>
                }
<span class="nc bnc" id="L23667" title="All 2 branches missed.">                if (0 &lt; passenger.getArmor(nextPassHit)) {</span>
<span class="nc" id="L23668">                    absorb += passenger.getArmor(nextPassHit);</span>
<span class="nc bnc" id="L23669" title="All 2 branches missed.">                    if (armorDamageReduction) {</span>
<span class="nc" id="L23670">                        absorb *= 2;</span>
                    }
                }
<span class="nc bnc" id="L23673" title="All 2 branches missed.">                if (0 &lt; passenger.getInternal(nextPassHit)) {</span>
<span class="nc" id="L23674">                    absorb += passenger.getInternal(nextPassHit);</span>
                    // Armor damage reduction, like for reflective or
                    // reactive armor will divide the whole damage
                    // total by 2 and round down. If we have an odd
                    // damage total, need to add 1 to make this
                    // evenly divisible by 2
<span class="nc bnc" id="L23680" title="All 4 branches missed.">                    if (((absorb % 2) != 0) &amp;&amp; armorDamageReduction) {</span>
<span class="nc" id="L23681">                        absorb++;</span>
                    }
                }
<span class="nc" id="L23684">                nextPassHit = passenger.getTransferLocation(nextPassHit);</span>
<span class="nc bnc" id="L23685" title="All 4 branches missed.">            } while ((damage &gt; absorb) &amp;&amp; (nextPassHit.getLocation() &gt;= 0));</span>

            // Damage the passenger.
<span class="nc" id="L23688">            absorb = Math.min(passengerDamage, absorb);</span>
<span class="nc" id="L23689">            Vector&lt;Report&gt; newReports = damageEntity(passenger, passHit, absorb);</span>
<span class="nc bnc" id="L23690" title="All 2 branches missed.">            for (Report newReport : newReports) {</span>
<span class="nc" id="L23691">                newReport.indent(2);</span>
<span class="nc" id="L23692">            }</span>
<span class="nc" id="L23693">            vDesc.addAll(newReports);</span>

            // Did some damage pass on?
<span class="nc bnc" id="L23696" title="All 2 branches missed.">            if (damage &gt; absorb) {</span>
                // Yup. Remove the absorbed damage.
<span class="nc" id="L23698">                damage -= absorb;</span>
<span class="nc" id="L23699">                r = new Report(6080);</span>
<span class="nc" id="L23700">                r.subject = te.getId();</span>
<span class="nc" id="L23701">                r.indent(2);</span>
<span class="nc" id="L23702">                r.add(damage);</span>
<span class="nc" id="L23703">                r.addDesc(te);</span>
<span class="nc" id="L23704">                vDesc.addElement(r);</span>
            } else {
                // Nope. Return our description.
<span class="nc" id="L23707">                return 0;</span>
            }

<span class="nc" id="L23710">        } else {</span>
            // Report that a passenger that could've been missed
            // narrowly avoids damage
<span class="nc" id="L23713">            r = new Report(6084);</span>
<span class="nc" id="L23714">            r.subject = passenger.getId();</span>
<span class="nc" id="L23715">            r.indent(3);</span>
<span class="nc" id="L23716">            r.addDesc(passenger);</span>
<span class="nc" id="L23717">            vDesc.addElement(r);</span>
        } // End nLoc-has-exterior-passenger
<span class="nc bnc" id="L23719" title="All 4 branches missed.">        if (passenger.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="nc bnc" id="L23720" title="All 4 branches missed.">                &amp;&amp; (passengerDamage &gt; 0) &amp;&amp; !passenger.isDoomed() &amp;&amp; !passenger.isDestroyed()) {</span>
<span class="nc" id="L23721">            r = new Report(3850);</span>
<span class="nc" id="L23722">            r.subject = passenger.getId();</span>
<span class="nc" id="L23723">            r.indent(3);</span>
<span class="nc" id="L23724">            r.addDesc(passenger);</span>
<span class="nc" id="L23725">            vDesc.addElement(r);</span>
<span class="nc" id="L23726">            int facing = te.getFacing();</span>
            // We're going to assume that it's mounted facing the mech
<span class="nc" id="L23728">            Coords position = te.getPosition();</span>
<span class="nc bnc" id="L23729" title="All 2 branches missed.">            if (!hit.isRear()) {</span>
<span class="nc" id="L23730">                facing = (facing + 3) % 6;</span>
            }
<span class="nc" id="L23732">            unloadUnit(te, passenger, position, facing, te.getElevation(), false, false);</span>
<span class="nc" id="L23733">            Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L23734">                    passenger.getId(), position);</span>
<span class="nc bnc" id="L23735" title="All 2 branches missed.">            if (violation != null) {</span>
<span class="nc" id="L23736">                Coords targetDest = Compute.getValidDisplacement(game, passenger.getId(), position,</span>
<span class="nc" id="L23737">                        Compute.d6() - 1);</span>
<span class="nc" id="L23738">                addReport(doEntityDisplacement(violation, position, targetDest, null));</span>
                // Update the violating entity's position on the client.
<span class="nc" id="L23740">                entityUpdate(violation.getId());</span>
            }
        }
<span class="nc" id="L23743">        return damage;</span>
    }

    /**
     * Check to see if the entity's engine explodes. Rules for ICE explosions
     * are different to fusion engines.
     *
     * @param en    - the &lt;code&gt;Entity&lt;/code&gt; in question. This value must not be
     *              &lt;code&gt;null&lt;/code&gt;.
     * @param vDesc - the &lt;code&gt;Vector&lt;/code&gt; that this function should add its
     *              &lt;code&gt;Report&lt;code&gt;s to.  It may be empty, but not
     *              &lt;code&gt;null&lt;/code&gt;.
     * @param hits  - the number of criticals on the engine
     * @return &lt;code&gt;true&lt;/code&gt; if the unit's engine exploded,
     * &lt;code&gt;false&lt;/code&gt; if not.
     */
    private boolean checkEngineExplosion(Entity en, Vector&lt;Report&gt; vDesc, int hits) {
<span class="nc bnc" id="L23760" title="All 6 branches missed.">        if (!(en instanceof Mech) &amp;&amp; !(en instanceof Aero) &amp;&amp; !(en instanceof Tank)) {</span>
<span class="nc" id="L23761">            return false;</span>
        }
        // If this method gets called for an entity that's already destroyed or
        // that hasn't taken any actual engine hits this phase yet, do nothing.
<span class="nc bnc" id="L23765" title="All 4 branches missed.">        if (en.isDestroyed() || (en.engineHitsThisPhase &lt;= 0)</span>
<span class="nc bnc" id="L23766" title="All 4 branches missed.">                || en.getSelfDestructedThisTurn() || !en.hasEngine()) {</span>
<span class="nc" id="L23767">            return false;</span>
        }
<span class="nc" id="L23769">        int explosionBTH = 10;</span>
<span class="nc" id="L23770">        int hitsPerRound = 4;</span>
<span class="nc" id="L23771">        Engine engine = en.getEngine();</span>

<span class="nc bnc" id="L23773" title="All 2 branches missed.">        if(en instanceof Tank) {</span>
<span class="nc" id="L23774">            explosionBTH = 12;</span>
<span class="nc" id="L23775">            hitsPerRound = 1;</span>
<span class="nc bnc" id="L23776" title="All 2 branches missed.">        } else if(!(en instanceof Mech)) {</span>
<span class="nc" id="L23777">            explosionBTH = 12;</span>
<span class="nc" id="L23778">            hitsPerRound = 1;</span>
        }

        // Non mechs and mechs that already rolled are safe
<span class="nc bnc" id="L23782" title="All 4 branches missed.">        if (en.rolledForEngineExplosion || !(en instanceof Mech)) {</span>
<span class="nc" id="L23783">            return false;</span>
        }
        // ICE can always explode and roll every time hit
<span class="nc bnc" id="L23786" title="All 2 branches missed.">        if (engine.isFusion()</span>
<span class="nc bnc" id="L23787" title="All 4 branches missed.">                &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_ENGINE_EXPLOSIONS)</span>
                        || (en.engineHitsThisPhase &lt; hitsPerRound))) {
<span class="nc" id="L23789">            return false;</span>
        }
<span class="nc bnc" id="L23791" title="All 2 branches missed.">        if (!engine.isFusion()) {</span>
<span class="nc bnc" id="L23792" title="All 4 branches missed.">            switch (hits) {</span>
                case 0:
<span class="nc" id="L23794">                    return false;</span>
                case 1:
<span class="nc" id="L23796">                    explosionBTH = 10;</span>
<span class="nc" id="L23797">                    break;</span>
                case 2:
<span class="nc" id="L23799">                    explosionBTH = 7;</span>
<span class="nc" id="L23800">                    break;</span>
                case 3:
                default:
<span class="nc" id="L23803">                    explosionBTH = 4;</span>
                    break;
            }
        }
<span class="nc" id="L23807">        int explosionRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L23808" title="All 2 branches missed.">        boolean didExplode = explosionRoll &gt;= explosionBTH;</span>

        Report r;
<span class="nc" id="L23811">        r = new Report(6150);</span>
<span class="nc" id="L23812">        r.subject = en.getId();</span>
<span class="nc" id="L23813">        r.indent(2);</span>
<span class="nc" id="L23814">        r.addDesc(en);</span>
<span class="nc" id="L23815">        r.add(en.engineHitsThisPhase);</span>
<span class="nc" id="L23816">        vDesc.addElement(r);</span>
<span class="nc" id="L23817">        r = new Report(6155);</span>
<span class="nc" id="L23818">        r.subject = en.getId();</span>
<span class="nc" id="L23819">        r.indent(2);</span>
<span class="nc" id="L23820">        r.add(explosionBTH);</span>
<span class="nc" id="L23821">        r.add(explosionRoll);</span>
<span class="nc" id="L23822">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L23824" title="All 2 branches missed.">        if (!didExplode) {</span>
            // whew!
<span class="nc bnc" id="L23826" title="All 2 branches missed.">            if (engine.isFusion()) {</span>
<span class="nc" id="L23827">                en.rolledForEngineExplosion = true;</span>
            }
            // fusion engines only roll 1/phase but ICE roll every time damaged
<span class="nc" id="L23830">            r = new Report(6160);</span>
<span class="nc" id="L23831">            r.subject = en.getId();</span>
<span class="nc" id="L23832">            r.indent(2);</span>
<span class="nc" id="L23833">            vDesc.addElement(r);</span>
        } else {
<span class="nc" id="L23835">            en.rolledForEngineExplosion = true;</span>
<span class="nc" id="L23836">            r = new Report(6165, Report.PUBLIC);</span>
<span class="nc" id="L23837">            r.subject = en.getId();</span>
<span class="nc" id="L23838">            r.indent(2);</span>
<span class="nc" id="L23839">            vDesc.addElement(r);</span>
<span class="nc" id="L23840">            vDesc.addAll(destroyEntity(en, &quot;engine explosion&quot;, false, false));</span>
            // kill the crew
<span class="nc" id="L23842">            en.getCrew().setDoomed(true);</span>

            // This is a hack so MM.NET marks the mech as not salvageable
<span class="nc" id="L23845">            en.destroyLocation(Mech.LOC_CT);</span>

            // ICE explosions don't hurt anyone else, but fusion do
<span class="nc bnc" id="L23848" title="All 2 branches missed.">            if (engine.isFusion()) {</span>
<span class="nc" id="L23849">                int engineRating = en.getEngine().getRating();</span>
<span class="nc" id="L23850">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23851">                r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L23852">                r.subject = en.getId();</span>
<span class="nc" id="L23853">                r.indent(2);</span>
<span class="nc" id="L23854">                vDesc.add(r);</span>

<span class="nc" id="L23856">                Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L23857" title="All 4 branches missed.">                if (mech.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(</span>
                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23859" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(</span>
                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23861" title="All 2 branches missed.">                        &amp;&amp; mech.isCondEjectEngine()))) {</span>
<span class="nc" id="L23862">                    vDesc.addAll(ejectEntity(en, true));</span>
                }

<span class="nc" id="L23865">                doFusionEngineExplosion(engineRating, en.getPosition(), vDesc, null);</span>
<span class="nc" id="L23866">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23867">                r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L23868">                r.subject = en.getId();</span>
<span class="nc" id="L23869">                r.indent(2);</span>
<span class="nc" id="L23870">                vDesc.add(r);</span>

            }
        }

<span class="nc" id="L23875">        return didExplode;</span>
    }

    /**
     * Extract explosion functionality for generalized explosions in areas.
     */
    public void doFusionEngineExplosion(int engineRating, Coords position, Vector&lt;Report&gt; vDesc,
                                        Vector&lt;Integer&gt; vUnits) {
<span class="nc" id="L23883">        int[] myDamages = { engineRating, (engineRating / 10), (engineRating / 20),</span>
                (engineRating / 40) };
<span class="nc" id="L23885">        doExplosion(myDamages, true, position, false, vDesc, vUnits, 5, -1, true);</span>
<span class="nc" id="L23886">    }</span>

    /**
     * General function to cause explosions in areas.
     */
    public void doExplosion(int damage, int degradation, boolean autoDestroyInSameHex,
                            Coords position, boolean allowShelter, Vector&lt;Report&gt; vDesc,
                            Vector&lt;Integer&gt; vUnits, int excludedUnitId) {
<span class="nc bnc" id="L23894" title="All 2 branches missed.">        if (degradation &lt; 1) {</span>
<span class="nc" id="L23895">            return;</span>
        }

<span class="nc" id="L23898">        int[] myDamages = new int[damage / degradation];</span>

<span class="nc bnc" id="L23900" title="All 2 branches missed.">        if (myDamages.length &lt; 1) {</span>
<span class="nc" id="L23901">            return;</span>
        }

<span class="nc" id="L23904">        myDamages[0] = damage;</span>
<span class="nc bnc" id="L23905" title="All 2 branches missed.">        for (int x = 1; x &lt; myDamages.length; x++) {</span>
<span class="nc" id="L23906">            myDamages[x] = myDamages[x - 1] - degradation;</span>
        }
<span class="nc" id="L23908">        doExplosion(myDamages, autoDestroyInSameHex, position, allowShelter, vDesc, vUnits,</span>
                5, excludedUnitId, false);
<span class="nc" id="L23910">    }</span>

    /**
     * General function to cause explosions in areas.
     */
    public void doExplosion(int[] damages, boolean autoDestroyInSameHex, Coords position,
                            boolean allowShelter, Vector&lt;Report&gt; vDesc, Vector&lt;Integer&gt; vUnits,
                            int clusterAmt, int excludedUnitId, boolean engineExplosion) {
<span class="nc bnc" id="L23918" title="All 2 branches missed.">        if (vDesc == null) {</span>
<span class="nc" id="L23919">            vDesc = new Vector&lt;&gt;();</span>
        }

<span class="nc bnc" id="L23922" title="All 2 branches missed.">        if (vUnits == null) {</span>
<span class="nc" id="L23923">            vUnits = new Vector&lt;&gt;();</span>
        }

        Report r;
<span class="nc" id="L23927">        HashSet&lt;Entity&gt; entitiesHit = new HashSet&lt;&gt;();</span>

        // We need to damage buildings.
<span class="nc" id="L23930">        Enumeration&lt;Building&gt; buildings = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L23931" title="All 2 branches missed.">        while (buildings.hasMoreElements()) {</span>
<span class="nc" id="L23932">            final Building bldg = buildings.nextElement();</span>

            // Lets find the closest hex from the building.
<span class="nc" id="L23935">            Enumeration&lt;Coords&gt; hexes = bldg.getCoords();</span>

<span class="nc bnc" id="L23937" title="All 2 branches missed.">            while (hexes.hasMoreElements()) {</span>
<span class="nc" id="L23938">                final Coords coords = hexes.nextElement();</span>
<span class="nc" id="L23939">                int dist = position.distance(coords);</span>
<span class="nc bnc" id="L23940" title="All 2 branches missed.">                if (dist &lt; damages.length) {</span>
<span class="nc" id="L23941">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damages[dist], coords);</span>
<span class="nc bnc" id="L23942" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L23943">                        report.type = Report.PUBLIC;</span>
<span class="nc" id="L23944">                    }</span>
<span class="nc" id="L23945">                    vDesc.addAll(buildingReport);</span>
                }
<span class="nc" id="L23947">            }</span>
<span class="nc" id="L23948">        }</span>

        // We need to damage terrain
<span class="nc" id="L23951">        int maxDist = damages.length;</span>
<span class="nc" id="L23952">        IHex hex = game.getBoard().getHex(position);</span>
        // Center hex starts on fire for engine explosions
<span class="nc bnc" id="L23954" title="All 6 branches missed.">        if (engineExplosion &amp;&amp; (hex != null) &amp;&amp; !hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L23955">            r = new Report(5136);</span>
<span class="nc" id="L23956">            r.indent(2);</span>
<span class="nc" id="L23957">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L23958">            r.add(position.getBoardNum());</span>
<span class="nc" id="L23959">            vDesc.add(r);</span>
<span class="nc" id="L23960">            Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
<span class="nc" id="L23961">            ignite(position, Terrains.FIRE_LVL_NORMAL, reports);</span>
<span class="nc bnc" id="L23962" title="All 2 branches missed.">            for (Report report : reports) {</span>
<span class="nc" id="L23963">                report.indent();</span>
<span class="nc" id="L23964">            }</span>
<span class="nc" id="L23965">            vDesc.addAll(reports);</span>
        }
<span class="nc bnc" id="L23967" title="All 4 branches missed.">        if ((hex != null) &amp;&amp; hex.hasTerrainfactor()) {</span>
<span class="nc" id="L23968">            r = new Report(3384);</span>
<span class="nc" id="L23969">            r.indent(2);</span>
<span class="nc" id="L23970">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L23971">            r.add(position.getBoardNum());</span>
<span class="nc" id="L23972">            r.add(damages[0]);</span>
<span class="nc" id="L23973">            vDesc.add(r);</span>
        }
<span class="nc" id="L23975">        Vector&lt;Report&gt; reports = tryClearHex(position, damages[0], Entity.NONE);</span>
<span class="nc bnc" id="L23976" title="All 2 branches missed.">        for (Report report : reports) {</span>
<span class="nc" id="L23977">            report.indent(3);</span>
<span class="nc" id="L23978">        }</span>
<span class="nc" id="L23979">        vDesc.addAll(reports);</span>

        // Handle surrounding coords
<span class="nc bnc" id="L23982" title="All 2 branches missed.">        for (int dist = 1; dist &lt; maxDist; dist++) {</span>
<span class="nc" id="L23983">            List&lt;Coords&gt; coords = position.allAtDistance(dist);</span>
<span class="nc bnc" id="L23984" title="All 2 branches missed.">            for (Coords c : coords) {</span>
<span class="nc" id="L23985">                hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L23986" title="All 4 branches missed.">                if ((hex != null) &amp;&amp; hex.hasTerrainfactor()) {</span>
<span class="nc" id="L23987">                    r = new Report(3384);</span>
<span class="nc" id="L23988">                    r.indent(2);</span>
<span class="nc" id="L23989">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L23990">                    r.add(c.getBoardNum());</span>
<span class="nc" id="L23991">                    r.add(damages[dist]);</span>
<span class="nc" id="L23992">                    vDesc.add(r);</span>
                }
<span class="nc" id="L23994">                reports = tryClearHex(c, damages[dist], Entity.NONE);</span>
<span class="nc bnc" id="L23995" title="All 2 branches missed.">                for (Report report : reports) {</span>
<span class="nc" id="L23996">                    report.indent(3);</span>
<span class="nc" id="L23997">                }</span>
<span class="nc" id="L23998">                vDesc.addAll(reports);</span>
<span class="nc" id="L23999">            }</span>
        }

        // Now we damage people near the explosion.
<span class="nc" id="L24003">        List&lt;Entity&gt; loaded = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L24004" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; ents = game.getEntities(); ents.hasNext();) {</span>
<span class="nc" id="L24005">            Entity entity = ents.next();</span>

<span class="nc bnc" id="L24007" title="All 2 branches missed.">            if (entitiesHit.contains(entity)) {</span>
<span class="nc" id="L24008">                continue;</span>
            }

<span class="nc bnc" id="L24011" title="All 2 branches missed.">            if (entity.getId() == excludedUnitId) {</span>
<span class="nc" id="L24012">                continue;</span>
            }

<span class="nc bnc" id="L24015" title="All 4 branches missed.">            if (entity.isDestroyed() || !entity.isDeployed()) {</span>
                // FIXME
                // IS this the behavior we want?
                // This means, incidentally, that salvage is never affected by
                // explosions
                // as long as it was destroyed before the explosion.
<span class="nc" id="L24021">                continue;</span>
            }

            // We are going to assume that explosions are on the ground here so
            // flying entities should be unaffected
<span class="nc bnc" id="L24026" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L24027">                continue;</span>
            }

<span class="nc bnc" id="L24030" title="All 4 branches missed.">            if ((entity instanceof MechWarrior) &amp;&amp; !((MechWarrior) entity).hasLanded()) {</span>
                // MechWarrior is still up in the air ejecting hence safe
                // from this explosion.
<span class="nc" id="L24033">                continue;</span>
            }

<span class="nc" id="L24036">            Coords entityPos = entity.getPosition();</span>
<span class="nc bnc" id="L24037" title="All 2 branches missed.">            if (entityPos == null) {</span>
                // maybe its loaded?
<span class="nc" id="L24039">                Entity transport = game.getEntity(entity.getTransportId());</span>
<span class="nc bnc" id="L24040" title="All 4 branches missed.">                if ((transport != null) &amp;&amp; !transport.isAirborne()) {</span>
<span class="nc" id="L24041">                    loaded.add(entity);</span>
                }
                continue;
            }
<span class="nc" id="L24045">            int range = position.distance(entityPos);</span>

<span class="nc bnc" id="L24047" title="All 2 branches missed.">            if (range &gt;= damages.length) {</span>
                // Yeah, this is fine. It's outside the blast radius.
<span class="nc" id="L24049">                continue;</span>
            }

            // We might need to nuke everyone in the explosion hex. If so...
<span class="nc bnc" id="L24053" title="All 4 branches missed.">            if ((range == 0) &amp;&amp; autoDestroyInSameHex) {</span>
                // Add the reports
<span class="nc" id="L24055">                vDesc.addAll(destroyEntity(entity, &quot;explosion proximity&quot;, false, false));</span>
                // Add it to the &quot;blasted units&quot; list
<span class="nc" id="L24057">                vUnits.add(entity.getId());</span>
                // Kill the crew
<span class="nc" id="L24059">                entity.getCrew().setDoomed(true);</span>

<span class="nc" id="L24061">                entitiesHit.add(entity);</span>
<span class="nc" id="L24062">                continue;</span>
            }

<span class="nc" id="L24065">            int damage = damages[range];</span>

<span class="nc bnc" id="L24067" title="All 4 branches missed.">            if (allowShelter &amp;&amp; canShelter(entityPos, position, entity.relHeight())) {</span>
<span class="nc bnc" id="L24068" title="All 2 branches missed.">                if (isSheltered()) {</span>
<span class="nc" id="L24069">                    r = new Report(6545);</span>
<span class="nc" id="L24070">                    r.addDesc(entity);</span>
<span class="nc" id="L24071">                    r.subject = entity.getId();</span>
<span class="nc" id="L24072">                    vDesc.addElement(r);</span>
<span class="nc" id="L24073">                    continue;</span>
                }
                // If shelter is allowed but didn't work, report that.
<span class="nc" id="L24076">                r = new Report(6546);</span>
<span class="nc" id="L24077">                r.subject = entity.getId();</span>
<span class="nc" id="L24078">                r.addDesc(entity);</span>
<span class="nc" id="L24079">                vDesc.addElement(r);</span>
            }

            // Since it's taking damage, add it to the list of units hit.
<span class="nc" id="L24083">            vUnits.add(entity.getId());</span>

<span class="nc" id="L24085">            AreaEffectHelper.applyExplosionClusterDamageToEntity(entity, damage, clusterAmt, position, vDesc, this);</span>
            
<span class="nc" id="L24087">            Report.addNewline(vDesc);</span>
<span class="nc" id="L24088">        }</span>

        // now deal with loaded units...
<span class="nc bnc" id="L24091" title="All 2 branches missed.">        for (Entity e : loaded) {</span>
            // This can be null, if the transport died from damage
<span class="nc" id="L24093">            final Entity transporter = game.getEntity(e.getTransportId());</span>
<span class="nc bnc" id="L24094" title="All 4 branches missed.">            if ((transporter == null) || transporter.getExternalUnits().contains(e)) {</span>
                // Its external or transport was destroyed - hit it.
<span class="nc bnc" id="L24096" title="All 2 branches missed.">                final Coords entityPos = (transporter == null ? e.getPosition()</span>
<span class="nc" id="L24097">                        : transporter.getPosition());</span>
<span class="nc" id="L24098">                final int range = position.distance(entityPos);</span>

<span class="nc bnc" id="L24100" title="All 2 branches missed.">                if (range &gt;= damages.length) {</span>
                    // Yeah, this is fine. It's outside the blast radius.
<span class="nc" id="L24102">                    continue;</span>
                }

<span class="nc" id="L24105">                int damage = damages[range];</span>
<span class="nc bnc" id="L24106" title="All 2 branches missed.">                if (allowShelter) {</span>
<span class="nc bnc" id="L24107" title="All 2 branches missed.">                    final int absHeight = (transporter == null ? e.relHeight()</span>
<span class="nc" id="L24108">                            : transporter.relHeight());</span>
<span class="nc bnc" id="L24109" title="All 2 branches missed.">                    if (canShelter(entityPos, position, absHeight)) {</span>
<span class="nc bnc" id="L24110" title="All 2 branches missed.">                        if (isSheltered()) {</span>
<span class="nc" id="L24111">                            r = new Report(6545);</span>
<span class="nc" id="L24112">                            r.addDesc(e);</span>
<span class="nc" id="L24113">                            r.subject = e.getId();</span>
<span class="nc" id="L24114">                            vDesc.addElement(r);</span>
<span class="nc" id="L24115">                            continue;</span>
                        }
                        // If shelter is allowed but didn't work, report that.
<span class="nc" id="L24118">                        r = new Report(6546);</span>
<span class="nc" id="L24119">                        r.subject = e.getId();</span>
<span class="nc" id="L24120">                        r.addDesc(e);</span>
<span class="nc" id="L24121">                        vDesc.addElement(r);</span>
                    }
                }
                // No shelter
                // Since it's taking damage, add it to the list of units hit.
<span class="nc" id="L24126">                vUnits.add(e.getId());</span>

<span class="nc" id="L24128">                r = new Report(6175);</span>
<span class="nc" id="L24129">                r.subject = e.getId();</span>
<span class="nc" id="L24130">                r.indent(2);</span>
<span class="nc" id="L24131">                r.addDesc(e);</span>
<span class="nc" id="L24132">                r.add(damage);</span>
<span class="nc" id="L24133">                vDesc.addElement(r);</span>

<span class="nc bnc" id="L24135" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L24136">                    int cluster = Math.min(5, damage);</span>
<span class="nc" id="L24137">                    int table = ToHitData.HIT_NORMAL;</span>
<span class="nc bnc" id="L24138" title="All 2 branches missed.">                    if (e instanceof Protomech) {</span>
<span class="nc" id="L24139">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
                    }
<span class="nc" id="L24141">                    HitData hit = e.rollHitLocation(table, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L24142">                    vDesc.addAll(damageEntity(e, hit, cluster, false,</span>
                            DamageType.IGNORE_PASSENGER, false, true));
<span class="nc" id="L24144">                    damage -= cluster;</span>
<span class="nc" id="L24145">                }</span>
<span class="nc" id="L24146">                Report.addNewline(vDesc);</span>
            }
<span class="nc" id="L24148">        }</span>
<span class="nc" id="L24149">    }</span>

    /**
     * Check if an Entity of the passed height can find shelter from a nuke blast
     *
     * @param entityPosition  the &lt;code&gt;Coords&lt;/code&gt; the Entity is at
     * @param position        the &lt;code&gt;Coords&lt;/code&gt; of the explosion
     * @param entityAbsHeight the &lt;code&gt;int&lt;/code&gt; height of the entity
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating if the entity of the
     * given height can find shelter
     */
    public boolean canShelter(Coords entityPosition, Coords position, int entityAbsHeight) {
        // What is the next hex in the direction of the blast?
<span class="nc" id="L24162">        Coords shelteringCoords = Coords.nextHex(entityPosition, position);</span>
<span class="nc" id="L24163">        IHex shelteringHex = game.getBoard().getHex(shelteringCoords);</span>

        // This is an error condition. It really shouldn't ever happen.
<span class="nc bnc" id="L24166" title="All 2 branches missed.">        if (shelteringHex == null) {</span>
<span class="nc" id="L24167">            return false;</span>
        }

        // Now figure out the height to which that hex will provide shelter.
        // It's worth noting, this assumes that any building in the hex has
        // already survived the bomb blast. In the case where a building
        // won't survive the blast but hasn't actually taken the damage
        // yet, this will be wrong.
<span class="nc" id="L24175">        int shelterLevel = shelteringHex.floor();</span>
<span class="nc bnc" id="L24176" title="All 2 branches missed.">        if (shelteringHex.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L24177">            shelterLevel = shelteringHex.ceiling();</span>
        }

        // Get the absolute height of the unit relative to level 0.
<span class="nc" id="L24181">        entityAbsHeight += game.getBoard().getHex(entityPosition).surface();</span>

        // Now find the height that needs to be sheltered, and compare.
<span class="nc bnc" id="L24184" title="All 2 branches missed.">        return entityAbsHeight &lt; shelterLevel;</span>
    }

    /**
     * @return true if the unit succeeds a shelter roll
     */
    private boolean isSheltered() {
<span class="nc bnc" id="L24191" title="All 2 branches missed.">        return Compute.d6(2) &gt;= 9;</span>
    }

    /**
     * add a nuke to be exploded in the next weapons attack phase
     *
     * @param nuke this is an int[] with i=0 and i=1 being X and Y coordinates respectively,
     *             If the input array is length 3, then i=2 is NukeType (from HS:3070)
     *             If the input array is length 6, then i=2 is the base damage dealt,
     *             i=3 is the degradation, i=4 is the secondary radius, and i=5 is the crater depth
     */
    public void addScheduledNuke(int[] nuke) {
<span class="nc" id="L24203">        scheduledNukes.add(nuke);</span>
<span class="nc" id="L24204">    }</span>

    /**
     * explode any scheduled nukes
     */
    private void resolveScheduledNukes() {
<span class="nc bnc" id="L24210" title="All 2 branches missed.">        for (int[] nuke : scheduledNukes) {</span>
<span class="nc bnc" id="L24211" title="All 2 branches missed.">            if (nuke.length == 3) {</span>
<span class="nc" id="L24212">                doNuclearExplosion(new Coords(nuke[0] - 1, nuke[1] - 1), nuke[2],</span>
                        vPhaseReport);
            }
<span class="nc bnc" id="L24215" title="All 2 branches missed.">            if (nuke.length == 6) {</span>
<span class="nc" id="L24216">                doNuclearExplosion(new Coords(nuke[0] - 1, nuke[1] - 1), nuke[2], nuke[3],</span>
                        nuke[4], nuke[5], vPhaseReport);
            }
<span class="nc" id="L24219">        }</span>
<span class="nc" id="L24220">        scheduledNukes.clear();</span>
<span class="nc" id="L24221">    }</span>

    /**
     * do a nuclear explosion
     *
     * @param position the position that will be hit by the nuke
     * @param nukeType the type of nuke
     * @param vDesc    a vector that contains the output report
     */
    public void doNuclearExplosion(Coords position, int nukeType, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L24231">        NukeStats nukeStats = AreaEffectHelper.getNukeStats(nukeType);</span>
        
<span class="nc bnc" id="L24233" title="All 2 branches missed.">        if(nukeStats == null) {</span>
<span class="nc" id="L24234">            MegaMek.getLogger().error(&quot;Illegal nuke not listed in HS:3070&quot;);</span>
        }
        
<span class="nc" id="L24237">        doNuclearExplosion(position, nukeStats.baseDamage, nukeStats.degradation, nukeStats.secondaryRadius,</span>
                nukeStats.craterDepth, vDesc);        
<span class="nc" id="L24239">    }</span>

    /**
     * explode a nuke
     *
     * @param position          the position that will be hit by the nuke
     * @param baseDamage        the base damage from the blast
     * @param degradation       how fast the blast's power degrades
     * @param secondaryRadius   the secondary blast radius
     * @param craterDepth       the depth of the crater created by the blast
     * @param vDesc             a vector that contains the output report
     */
    public void doNuclearExplosion(Coords position, int baseDamage, int degradation,
                                   int secondaryRadius, int craterDepth, Vector&lt;Report&gt; vDesc) {
        // Just in case.
<span class="nc bnc" id="L24254" title="All 2 branches missed.">        if (vDesc == null) {</span>
<span class="nc" id="L24255">            vDesc = new Vector&lt;&gt;();</span>
        }

        // First, crater the terrain.
        // All terrain, units, buildings... EVERYTHING in here is just gone.
        // Gotta love nukes.
<span class="nc" id="L24261">        Report r = new Report(1215, Report.PUBLIC);</span>

<span class="nc" id="L24263">        r.indent();</span>
<span class="nc" id="L24264">        r.add(position.getBoardNum(), true);</span>
<span class="nc" id="L24265">        vDesc.add(r);</span>

<span class="nc" id="L24267">        int curDepth = craterDepth;</span>
<span class="nc" id="L24268">        int range = 0;</span>
<span class="nc bnc" id="L24269" title="All 2 branches missed.">        while (range &lt; (2 * craterDepth)) {</span>
            // Get the set of hexes at this range.
<span class="nc" id="L24271">            List&lt;Coords&gt; hexSet = position.allAtDistance(range);</span>

            // Iterate through the hexes.
<span class="nc bnc" id="L24274" title="All 2 branches missed.">            for (Coords myHexCoords: hexSet) {</span>
                // ignore out of bounds coordinates
<span class="nc bnc" id="L24276" title="All 2 branches missed.">                if (!game.getBoard().contains(myHexCoords)) {</span>
<span class="nc" id="L24277">                    continue;</span>
                }
                
<span class="nc" id="L24280">                IHex myHex = game.getBoard().getHex(myHexCoords);</span>
                // In each hex, first, sink the terrain if necessary.
<span class="nc" id="L24282">                myHex.setLevel((myHex.getLevel() - curDepth));</span>

                // Then, remove ANY terrains here.
                // I mean ALL of them; they're all just gone.
                // No ruins, no water, no rough, no nothing.
<span class="nc bnc" id="L24287" title="All 2 branches missed.">                if (myHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L24288">                    myHex.setLevel(myHex.floor());</span>
                }
<span class="nc" id="L24290">                myHex.removeAllTerrains();</span>
<span class="nc" id="L24291">                myHex.clearExits();</span>

<span class="nc" id="L24293">                sendChangedHex(myHexCoords);</span>
<span class="nc" id="L24294">            }</span>

            // Lastly, if the next distance is a multiple of 2...
            // The crater depth goes down one.
<span class="nc bnc" id="L24298" title="All 4 branches missed.">            if ((range &gt; 0) &amp;&amp; ((range % 2) == 0)) {</span>
<span class="nc" id="L24299">                curDepth--;</span>
            }

            // Now that the hexes are dealt with, increment the distance.
<span class="nc" id="L24303">            range++;</span>
<span class="nc" id="L24304">        }</span>

        // This is technically part of cratering, but...
        // Now we destroy all the units inside the cratering range.
<span class="nc bnc" id="L24308" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // loaded units and off board units don't have a position,
            // so we don't count 'em here
<span class="nc bnc" id="L24311" title="All 4 branches missed.">            if ((entity.getTransportId() != Entity.NONE) || (entity.getPosition() == null)) {</span>
<span class="nc" id="L24312">                continue;</span>
            }

            // If it's too far away for this...
<span class="nc bnc" id="L24316" title="All 2 branches missed.">            if (position.distance(entity.getPosition()) &gt;= range) {</span>
<span class="nc" id="L24317">                continue;</span>
            }

            // If it's already destroyed...
<span class="nc bnc" id="L24321" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc" id="L24322">                continue;</span>
            }

<span class="nc" id="L24325">            vDesc.addAll(destroyEntity(entity, &quot;nuclear explosion proximity&quot;,</span>
                    false, false));
            // Kill the crew
<span class="nc" id="L24328">            entity.getCrew().setDoomed(true);</span>
<span class="nc" id="L24329">        }</span>

        // Then, do actual blast damage.
        // Use the standard blast function for this.
<span class="nc" id="L24333">        Vector&lt;Report&gt; tmpV = new Vector&lt;&gt;();</span>
<span class="nc" id="L24334">        Vector&lt;Integer&gt; blastedUnitsVec = new Vector&lt;&gt;();</span>
<span class="nc" id="L24335">        doExplosion(baseDamage, degradation, true, position, true, tmpV,</span>
                    blastedUnitsVec, -1);
<span class="nc" id="L24337">        Report.indentAll(tmpV, 2);</span>
<span class="nc" id="L24338">        vDesc.addAll(tmpV);</span>

        // Everything that was blasted by the explosion has to make a piloting
        // check at +6.
<span class="nc bnc" id="L24342" title="All 2 branches missed.">        for (int i : blastedUnitsVec) {</span>
<span class="nc" id="L24343">            Entity o = game.getEntity(i);</span>
<span class="nc bnc" id="L24344" title="All 2 branches missed.">            if (o.canFall()) {</span>
                // Needs a piloting check at +6 to avoid falling over.
<span class="nc" id="L24346">                game.addPSR(new PilotingRollData(o.getId(), 6,</span>
                        &quot;hit by nuclear blast&quot;));
<span class="nc bnc" id="L24348" title="All 2 branches missed.">            } else if (o instanceof VTOL) {</span>
                // Needs a piloting check at +6 to avoid crashing.
                // Wheeeeee!
<span class="nc" id="L24351">                VTOL vt = (VTOL) o;</span>

                // Check only applies if it's in the air.
                // FIXME: is this actually correct? What about
                // buildings/bridges?
<span class="nc bnc" id="L24356" title="All 2 branches missed.">                if (vt.getElevation() &gt; 0) {</span>
<span class="nc" id="L24357">                    game.addPSR(new PilotingRollData(vt.getId(), 6,</span>
                                                     &quot;hit by nuclear blast&quot;));
                }
<span class="nc bnc" id="L24360" title="All 2 branches missed.">            } else if (o instanceof Tank) {</span>
                // As per official answer on the rules questions board...
                // Needs a piloting check at +6 to avoid a 1-level fall...
                // But ONLY if a hover-tank.
                // TODO : Fix me
            }
<span class="nc" id="L24366">        }</span>

        // This ISN'T part of the blast, but if there's ANYTHING in the ground
        // zero hex, destroy it.
<span class="nc" id="L24370">        Building tmpB = game.getBoard().getBuildingAt(position);</span>
<span class="nc bnc" id="L24371" title="All 2 branches missed.">        if (tmpB != null) {</span>
<span class="nc" id="L24372">            r = new Report(2415);</span>
<span class="nc" id="L24373">            r.add(tmpB.getName());</span>
<span class="nc" id="L24374">            addReport(r);</span>
<span class="nc" id="L24375">            tmpB.setCurrentCF(0, position);</span>
        }
<span class="nc" id="L24377">        IHex gzHex = game.getBoard().getHex(position);</span>
<span class="nc bnc" id="L24378" title="All 2 branches missed.">        if (gzHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L24379">            gzHex.setLevel(gzHex.floor());</span>
        }
<span class="nc" id="L24381">        gzHex.removeAllTerrains();</span>

        // Next, for whatever's left, do terrain effects
        // such as clearing, roughing, and boiling off water.
<span class="nc" id="L24385">        boolean damageFlag = true;</span>
<span class="nc" id="L24386">        int damageAtRange = baseDamage - (degradation * range);</span>
<span class="nc bnc" id="L24387" title="All 2 branches missed.">        if (damageAtRange &gt; 0) {</span>
<span class="nc bnc" id="L24388" title="All 2 branches missed.">            for (int x = range; damageFlag; x++) {</span>
                // Damage terrain as necessary.
                // Get all the hexes, and then iterate through them.
<span class="nc" id="L24391">                List&lt;Coords&gt; hexSet = position.allAtDistance(x);</span>

                // Iterate through the hexes.
<span class="nc bnc" id="L24394" title="All 2 branches missed.">                for (Coords myHexCoords : hexSet) {</span>
                    // ignore out of bounds coordinates
<span class="nc bnc" id="L24396" title="All 2 branches missed.">                    if (!game.getBoard().contains(myHexCoords)) {</span>
<span class="nc" id="L24397">                        continue;</span>
                    }
                    
<span class="nc" id="L24400">                    IHex myHex = game.getBoard().getHex(myHexCoords);</span>

                    // For each 3000 damage, water level is reduced by 1.
<span class="nc bnc" id="L24403" title="All 4 branches missed.">                    if ((damageAtRange &gt;= 3000) &amp;&amp; (myHex.containsTerrain(Terrains.WATER))) {</span>
<span class="nc" id="L24404">                        int numCleared = damageAtRange / 3000;</span>
<span class="nc" id="L24405">                        int oldLevel = myHex.terrainLevel(Terrains.WATER);</span>
<span class="nc" id="L24406">                        myHex.removeTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L24407" title="All 2 branches missed.">                        if (oldLevel &gt; numCleared) {</span>
<span class="nc" id="L24408">                            myHex.setLevel(myHex.getLevel() - numCleared);</span>
<span class="nc" id="L24409">                            myHex.addTerrain(new Terrain(Terrains.WATER, oldLevel - numCleared));</span>
                        } else {
<span class="nc" id="L24411">                            myHex.setLevel(myHex.getLevel() - oldLevel);</span>
                        }
                    }

                    // ANY non-water hex that takes 200 becomes rough.
<span class="nc bnc" id="L24416" title="All 4 branches missed.">                    if ((damageAtRange &gt;= 200) &amp;&amp; (!myHex.containsTerrain(Terrains.WATER))) {</span>
<span class="nc" id="L24417">                        myHex.removeAllTerrains();</span>
<span class="nc" id="L24418">                        myHex.clearExits();</span>
<span class="nc" id="L24419">                        myHex.addTerrain(new Terrain(Terrains.ROUGH, 1));</span>
<span class="nc bnc" id="L24420" title="All 2 branches missed.">                    } else if ((damageAtRange &gt;= 20)</span>
<span class="nc bnc" id="L24421" title="All 2 branches missed.">                            &amp;&amp; ((myHex.containsTerrain(Terrains.WOODS))</span>
<span class="nc bnc" id="L24422" title="All 2 branches missed.">                            || (myHex.containsTerrain(Terrains.JUNGLE)))) {</span>
                        // Each 20 clears woods by 1 level.
<span class="nc" id="L24424">                        int numCleared = damageAtRange / 20;</span>
<span class="nc bnc" id="L24425" title="All 2 branches missed.">                        int terrainType = (myHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc" id="L24426">                                ? Terrains.WOODS : Terrains.JUNGLE);</span>
<span class="nc" id="L24427">                        int oldLevel = myHex.terrainLevel(terrainType);</span>
<span class="nc" id="L24428">                        int oldEl = myHex.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L24429">                        myHex.removeTerrain(terrainType);</span>
<span class="nc bnc" id="L24430" title="All 2 branches missed.">                        if (oldLevel &gt; numCleared) {</span>
<span class="nc" id="L24431">                            myHex.addTerrain(new Terrain(terrainType, oldLevel - numCleared));</span>
<span class="nc bnc" id="L24432" title="All 2 branches missed.">                            if (oldEl != 1) {</span>
<span class="nc" id="L24433">                                myHex.addTerrain(new Terrain(Terrains.FOLIAGE_ELEV, </span>
<span class="nc bnc" id="L24434" title="All 2 branches missed.">                                        oldLevel - numCleared == 3 ? 3 : 2));</span>
                            }
                        } else {
<span class="nc" id="L24437">                            myHex.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                        }
                    }

<span class="nc" id="L24441">                    sendChangedHex(myHexCoords);</span>
<span class="nc" id="L24442">                }</span>

                // Initialize for the next iteration.
<span class="nc" id="L24445">                damageAtRange = baseDamage - ((degradation * x) + 1);</span>

                // If the damage is less than 20, it has no terrain effect.
<span class="nc bnc" id="L24448" title="All 2 branches missed.">                if (damageAtRange &lt; 20) {</span>
<span class="nc" id="L24449">                    damageFlag = false;</span>
                }
            }
        }

        // Lastly, do secondary effects.
<span class="nc bnc" id="L24455" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // loaded units and off board units don't have a position,
            // so we don't count 'em here
<span class="nc bnc" id="L24458" title="All 4 branches missed.">            if ((entity.getTransportId() != Entity.NONE) || (entity.getPosition() == null)) {</span>
<span class="nc" id="L24459">                continue;</span>
            }

            // If it's already destroyed...
<span class="nc bnc" id="L24463" title="All 4 branches missed.">            if ((entity.isDoomed()) || (entity.isDestroyed())) {</span>
<span class="nc" id="L24464">                continue;</span>
            }

            // If it's too far away for this...
<span class="nc bnc" id="L24468" title="All 2 branches missed.">            if (position.distance(entity.getPosition()) &gt; secondaryRadius) {</span>
<span class="nc" id="L24469">                continue;</span>
            }

            // Actually do secondary effects against it.
            // Since the effects are unit-dependant, we'll just define it in the
            // entity.
<span class="nc" id="L24475">            applySecondaryNuclearEffects(entity, position, vDesc);</span>
<span class="nc" id="L24476">        }</span>

        // All right. We're done.
<span class="nc" id="L24479">        r = new Report(1216, Report.PUBLIC);</span>
<span class="nc" id="L24480">        r.indent();</span>
<span class="nc" id="L24481">        r.newlines = 2;</span>
<span class="nc" id="L24482">        vDesc.add(r);</span>
<span class="nc" id="L24483">    }</span>

    /**
     * Handles secondary effects from nuclear blasts against all units in range.
     *
     * @param entity   The entity to affect.
     * @param position The coordinates of the nuclear blast, for to-hit directions.
     * @param vDesc    a description vector to use for reports.
     */
    public void applySecondaryNuclearEffects(Entity entity, Coords position, Vector&lt;Report&gt; vDesc) {
        // If it's already destroyed, give up. We really don't care.
<span class="nc bnc" id="L24494" title="All 2 branches missed.">        if (entity.isDestroyed()) {</span>
<span class="nc" id="L24495">            return;</span>
        }

        // Check to see if the infantry is in a protective structure.
<span class="nc bnc" id="L24499" title="All 2 branches missed.">        boolean inHardenedBuilding = (Compute.isInBuilding(game, entity)</span>
<span class="nc bnc" id="L24500" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(entity.getPosition()).terrainLevel(Terrains.BUILDING) == 4));</span>

        // Roll 2d6.
<span class="nc" id="L24503">        int roll = Compute.d6(2);</span>

<span class="nc" id="L24505">        Report r = new Report(6555);</span>
<span class="nc" id="L24506">        r.subject = entity.getId();</span>
<span class="nc" id="L24507">        r.add(entity.getDisplayName());</span>
<span class="nc" id="L24508">        r.add(roll);</span>

        // If they are in protective structure, add 2 to the roll.
<span class="nc bnc" id="L24511" title="All 2 branches missed.">        if (inHardenedBuilding) {</span>
<span class="nc" id="L24512">            roll += 2;</span>
<span class="nc" id="L24513">            r.add(&quot; + 2 (unit is in hardened building)&quot;);</span>
        } else {
<span class="nc" id="L24515">            r.add(&quot;&quot;);</span>
        }

        // Also, if the entity is &quot;hardened&quot; against EMI, it gets a +2.
        // For these purposes, I'm going to hand this off to the Entity itself
        // to tell us.
        // Right now, it IS based purely on class, but I won't rule out the idea
        // of
        // &quot;nuclear hardening&quot; as equipment for a support vehicle, for example.
<span class="nc bnc" id="L24524" title="All 2 branches missed.">        if (entity.isNuclearHardened()) {</span>
<span class="nc" id="L24525">            roll += 2;</span>
<span class="nc" id="L24526">            r.add(&quot; + 2 (unit is hardened against EMI)&quot;);</span>
        } else {
<span class="nc" id="L24528">            r.add(&quot;&quot;);</span>
        }

<span class="nc" id="L24531">        r.indent(2);</span>
<span class="nc" id="L24532">        vDesc.add(r);</span>

        // Now, compare it to the table, and apply the effects.
<span class="nc bnc" id="L24535" title="All 2 branches missed.">        if (roll &lt;= 4) {</span>
            // The unit is destroyed.
            // Sucks, doesn't it?
            // This applies to all units.
            // Yup, just sucks.
<span class="nc" id="L24540">            vDesc.addAll(destroyEntity(entity,</span>
                    &quot;nuclear explosion secondary effects&quot;, false, false));
            // Kill the crew
<span class="nc" id="L24543">            entity.getCrew().setDoomed(true);</span>
<span class="nc bnc" id="L24544" title="All 2 branches missed.">        } else if (roll &lt;= 6) {</span>
<span class="nc bnc" id="L24545" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // It takes 50% casualties, rounded up.
<span class="nc" id="L24547">                BattleArmor myBA = (BattleArmor) entity;</span>
<span class="nc" id="L24548">                int numDeaths = (int) (Math.ceil((myBA.getNumberActiverTroopers())) / 2.0);</span>
<span class="nc bnc" id="L24549" title="All 2 branches missed.">                for (int x = 0; x &lt; numDeaths; x++) {</span>
<span class="nc" id="L24550">                    vDesc.addAll(applyCriticalHit(entity, 0, null, false,</span>
                            0, false));
                }
<span class="nc bnc" id="L24553" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
                // Standard infantry are auto-killed in this band, unless
                // they're in a building.
<span class="nc bnc" id="L24556" title="All 2 branches missed.">                if (game.getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.BUILDING)) {</span>
                    // 50% casualties, rounded up.
<span class="nc" id="L24558">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 2.0));</span>
<span class="nc" id="L24559">                    vDesc.addAll(damageEntity(entity, new HitData(</span>
                            Infantry.LOC_INFANTRY), damage, true));
<span class="nc" id="L24561">                } else {</span>
<span class="nc" id="L24562">                    vDesc.addAll(destroyEntity(entity,</span>
                            &quot;nuclear explosion secondary effects&quot;, false, false));
<span class="nc" id="L24564">                    entity.getCrew().setDoomed(true);</span>
                }
<span class="nc bnc" id="L24566" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
                // All vehicles suffer two critical hits...
<span class="nc" id="L24568">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24569">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>
<span class="nc" id="L24570">                hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24571">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // ...and a Crew Killed hit.
<span class="nc" id="L24574">                vDesc.addAll(applyCriticalHit(entity, 0, new CriticalSlot(0,</span>
                        Tank.CRIT_CREW_KILLED), false, 0, false));
<span class="nc bnc" id="L24576" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
                // 'Mechs suffer two critical hits...
<span class="nc" id="L24578">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24579">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>
<span class="nc" id="L24580">                hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24581">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // and four pilot hits.
<span class="nc" id="L24584">                vDesc.addAll(damageCrew(entity, 4));</span>
<span class="nc" id="L24585">            }</span>
            // Buildings and gun emplacements and such are only affected by the EMI.
            // No auto-crits or anything.
<span class="nc bnc" id="L24588" title="All 2 branches missed.">        } else if (roll &lt;= 10) {</span>
<span class="nc bnc" id="L24589" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // It takes 25% casualties, rounded up.
<span class="nc" id="L24591">                BattleArmor myBA = (BattleArmor) entity;</span>
<span class="nc" id="L24592">                int numDeaths = (int) (Math.ceil(((myBA.getNumberActiverTroopers())) / 4.0));</span>
<span class="nc bnc" id="L24593" title="All 2 branches missed.">                for (int x = 0; x &lt; numDeaths; x++) {</span>
<span class="nc" id="L24594">                    vDesc.addAll(applyCriticalHit(entity, 0, null, false, 0, false));</span>
                }
<span class="nc bnc" id="L24596" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
<span class="nc bnc" id="L24597" title="All 2 branches missed.">                if (game.getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.BUILDING)) {</span>
                    // 25% casualties, rounded up.
<span class="nc" id="L24599">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 4.0));</span>
<span class="nc" id="L24600">                    vDesc.addAll(damageEntity(entity, new HitData(Infantry.LOC_INFANTRY), damage, true));</span>
<span class="nc" id="L24601">                } else {</span>
                    // 50% casualties, rounded up.
<span class="nc" id="L24603">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 2.0));</span>
<span class="nc" id="L24604">                    vDesc.addAll(damageEntity(entity, new HitData(Infantry.LOC_INFANTRY), damage, true));</span>
<span class="nc" id="L24605">                }</span>
<span class="nc bnc" id="L24606" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
                // It takes one crit...
<span class="nc" id="L24608">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24609">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // Plus a Crew Stunned critical.
<span class="nc" id="L24612">                vDesc.addAll(applyCriticalHit(entity, 0, new CriticalSlot(0,</span>
                        Tank.CRIT_CREW_STUNNED), false, 0, false));
<span class="nc bnc" id="L24614" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
                // 'Mechs suffer a critical hit...
<span class="nc" id="L24616">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24617">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // and two pilot hits.
<span class="nc" id="L24620">                vDesc.addAll(damageCrew(entity, 2));</span>
            }
            // Buildings and gun emplacements and such are only affected by
            // the EMI.
            // No auto-crits or anything.
        }
        // If it's 11+, there are no secondary effects beyond EMI.
        // Lucky bastards.

        // And lastly, the unit is now affected by electromagnetic interference.
<span class="nc" id="L24630">        entity.setEMI(true);</span>
<span class="nc" id="L24631">    }</span>

    /**
     * Apply a single critical hit. The following private member of Server are
     * accessed from this function, preventing it from being factored out of the
     * Server class: destroyEntity() destroyLocation() checkEngineExplosion()
     * damageCrew() explodeEquipment() game
     *
     * @param en               the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to &lt;code&gt;Tank&lt;/code&gt;s and
     *                         for hits to a &lt;code&gt;Protomech&lt;/code&gt; torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;. For critical hits on a
     *                         &lt;code&gt;Tank&lt;/code&gt;, the index of the slot should be the index
     *                         of the critical hit table.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as triggering
     *                         an ammo explosion, sending hovercraft to watery graves, or
     *                         damaging ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    public Vector&lt;Report&gt; applyCriticalHit(Entity en, int loc, CriticalSlot cs,
                                           boolean secondaryEffects, int damageCaused,
                                           boolean isCapital) {
<span class="nc" id="L24660">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L24663" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L24664">            vDesc.addAll(applyTankCritical((Tank)en, loc, cs, damageCaused));</span>
<span class="nc bnc" id="L24665" title="All 2 branches missed.">        } else if (en instanceof Aero) {</span>
<span class="nc" id="L24666">            vDesc.addAll(applyAeroCritical((Aero)en, loc, cs, damageCaused, isCapital));</span>
<span class="nc bnc" id="L24667" title="All 2 branches missed.">        } else if (en instanceof BattleArmor) {</span>
            // We might as well handle this here.
            // However, we're considering a crit against BA as a &quot;crew kill&quot;.
<span class="nc" id="L24670">            BattleArmor ba = (BattleArmor) en;</span>
<span class="nc" id="L24671">            r = new Report(6111);</span>
<span class="nc" id="L24672">            int randomTrooper = ba.getRandomTrooper();</span>
<span class="nc" id="L24673">            ba.destroyLocation(randomTrooper);</span>
<span class="nc" id="L24674">            r.add(randomTrooper);</span>
<span class="nc" id="L24675">            r.newlines = 1;</span>
<span class="nc" id="L24676">            vDesc.add(r);</span>
<span class="nc bnc" id="L24677" title="All 2 branches missed.">        } else if (CriticalSlot.TYPE_SYSTEM == cs.getType()) {</span>
            // Handle critical hits on system slots.
<span class="nc" id="L24679">            cs.setHit(true);</span>
<span class="nc bnc" id="L24680" title="All 2 branches missed.">            if (en instanceof Protomech) {</span>
<span class="nc" id="L24681">                vDesc.addAll(applyProtomechCritical((Protomech)en, loc, cs, secondaryEffects, damageCaused, isCapital));</span>
            } else {
<span class="nc" id="L24683">                vDesc.addAll(applyMechSystemCritical(en, loc, cs));</span>
            }
<span class="nc bnc" id="L24685" title="All 2 branches missed.">        } else if (CriticalSlot.TYPE_EQUIPMENT == cs.getType()) {</span>
<span class="nc" id="L24686">            vDesc.addAll(applyEquipmentCritical(en, loc, cs, secondaryEffects));</span>
        } // End crit-on-equipment-slot
        // mechs with TSM hit by anti-tsm missiles this round get another
        // crit
<span class="nc bnc" id="L24690" title="All 4 branches missed.">        if ((en instanceof Mech) &amp;&amp; en.hitThisRoundByAntiTSM) {</span>
<span class="nc" id="L24691">            Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L24692" title="All 2 branches missed.">            if (mech.hasTSM()) {</span>
<span class="nc" id="L24693">                r = new Report(6430);</span>
<span class="nc" id="L24694">                r.subject = en.getId();</span>
<span class="nc" id="L24695">                r.indent(2);</span>
<span class="nc" id="L24696">                r.addDesc(en);</span>
<span class="nc" id="L24697">                r.newlines = 0;</span>
<span class="nc" id="L24698">                vDesc.addElement(r);</span>
<span class="nc" id="L24699">                vDesc.addAll(oneCriticalEntity(en, Compute.d6(2), false, damageCaused));</span>
            }
<span class="nc" id="L24701">            en.hitThisRoundByAntiTSM = false;</span>
        }

        // if using buffered VDNI then a possible pilot hit
<span class="nc bnc" id="L24705" title="All 4 branches missed.">        if (en.hasAbility(OptionsConstants.MD_BVDNI) &amp;&amp; !en.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L24706">            Report.addNewline(vDesc);</span>
<span class="nc" id="L24707">            int roll = Compute.d6(2);</span>
<span class="nc" id="L24708">            r = new Report(3580);</span>
<span class="nc" id="L24709">            r.subject = en.getId();</span>
<span class="nc" id="L24710">            r.addDesc(en);</span>
<span class="nc" id="L24711">            r.add(7);</span>
<span class="nc" id="L24712">            r.add(roll);</span>
<span class="nc bnc" id="L24713" title="All 2 branches missed.">            r.choose(roll &gt;= 8);</span>
<span class="nc" id="L24714">            r.indent(2);</span>
<span class="nc" id="L24715">            vDesc.add(r);</span>
<span class="nc bnc" id="L24716" title="All 2 branches missed.">            if (roll &gt;= 8) {</span>
<span class="nc" id="L24717">                vDesc.addAll(damageCrew(en, 1));</span>
            }
        }

        // Return the results of the damage.
<span class="nc" id="L24722">        return vDesc;</span>
    }

    /**
     * Apply a single critical hit to an equipment slot.
     *
     * @param en               the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as triggering
     *                         an ammo explosion, sending hovercraft to watery graves, or
     *                         damaging ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     */
    private Vector&lt;Report&gt; applyEquipmentCritical(Entity en, int loc, CriticalSlot cs,
                                                  boolean secondaryEffects) {
<span class="nc" id="L24741">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L24743">        cs.setHit(true);</span>
<span class="nc" id="L24744">        Mounted mounted = cs.getMount();</span>
<span class="nc" id="L24745">        EquipmentType eqType = mounted.getType();</span>
<span class="nc" id="L24746">        boolean hitBefore = mounted.isHit();</span>

<span class="nc" id="L24748">        r = new Report(6225);</span>
<span class="nc" id="L24749">        r.subject = en.getId();</span>
<span class="nc" id="L24750">        r.indent(3);</span>
<span class="nc" id="L24751">        r.add(mounted.getDesc());</span>
<span class="nc" id="L24752">        reports.addElement(r);</span>

        // Shield objects are not useless when they take one crit.
        // Shields can be critted and still be usable.
<span class="nc bnc" id="L24756" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; ((MiscType) eqType).isShield()) {</span>
<span class="nc" id="L24757">            mounted.setHit(false);</span>
        } else {
<span class="nc" id="L24759">            mounted.setHit(true);</span>
        }

<span class="nc bnc" id="L24762" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; eqType.hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L24763">            ((Mech)en).setHasDamagedCoolantSystem(true);</span>
        }

<span class="nc bnc" id="L24766" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; eqType.hasFlag(MiscType.F_HARJEL)) {</span>
<span class="nc" id="L24767">            reports.addAll(breachLocation(en, loc, null, true));</span>
        }

        // HarJel II/III hits trigger another possible critical hit on
        // the same location
        // it's like an ammunition explosion---a secondary effect
<span class="nc bnc" id="L24773" title="All 4 branches missed.">        if (secondaryEffects &amp;&amp; (eqType instanceof MiscType)</span>
<span class="nc bnc" id="L24774" title="All 6 branches missed.">                &amp;&amp; (eqType.hasFlag(MiscType.F_HARJEL_II) || eqType.hasFlag(MiscType.F_HARJEL_III))</span>
                &amp;&amp; !hitBefore) {
<span class="nc" id="L24776">            r = new Report(9852);</span>
<span class="nc" id="L24777">            r.subject = en.getId();</span>
<span class="nc" id="L24778">            r.indent(2);</span>
<span class="nc" id="L24779">            reports.addElement(r);</span>
<span class="nc" id="L24780">            reports.addAll(criticalEntity(en, loc, false, 0, 0));</span>
        }

        // If the item is the ECM suite of a Mek Stealth system
        // then it's destruction turns off the stealth.
<span class="nc bnc" id="L24785" title="All 4 branches missed.">        if (!hitBefore &amp;&amp; (eqType instanceof MiscType)</span>
<span class="nc bnc" id="L24786" title="All 2 branches missed.">            &amp;&amp; eqType.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L24787" title="All 2 branches missed.">            &amp;&amp; (mounted.getLinkedBy() != null)) {</span>
<span class="nc" id="L24788">            Mounted stealth = mounted.getLinkedBy();</span>
<span class="nc" id="L24789">            r = new Report(6255);</span>
<span class="nc" id="L24790">            r.subject = en.getId();</span>
<span class="nc" id="L24791">            r.indent(2);</span>
<span class="nc" id="L24792">            r.add(stealth.getType().getName());</span>
<span class="nc" id="L24793">            reports.addElement(r);</span>
<span class="nc" id="L24794">            stealth.setMode(&quot;Off&quot;);</span>
        }

        // Handle equipment explosions.
        // Equipment explosions are secondary effects and
        // do not occur when loading from a scenario.
<span class="nc bnc" id="L24800" title="All 4 branches missed.">        if (((secondaryEffects &amp;&amp; eqType.isExplosive(mounted))</span>
<span class="nc bnc" id="L24801" title="All 6 branches missed.">                || mounted.isHotLoaded() || (mounted.hasChargedCapacitor() != 0))</span>
                &amp;&amp; !hitBefore) {
<span class="nc" id="L24803">            reports.addAll(explodeEquipment(en, loc, mounted));</span>
        }

        // Make sure that ammo in this slot is exhausted.
<span class="nc bnc" id="L24807" title="All 2 branches missed.">        if (mounted.getBaseShotsLeft() &gt; 0) {</span>
<span class="nc" id="L24808">            mounted.setShotsLeft(0);</span>
        }

        // LAMs that are part of a fighter squadron will need to have the squadron recalculate
        // the bomb load out on a bomb bay critical.
<span class="nc bnc" id="L24813" title="All 4 branches missed.">        if (en.isPartOfFighterSquadron() &amp;&amp; (mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L24814" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc" id="L24815">            Entity squadron = game.getEntity(en.getTransportId());</span>
<span class="nc bnc" id="L24816" title="All 2 branches missed.">            if (squadron instanceof FighterSquadron) {</span>
<span class="nc" id="L24817">                ((FighterSquadron) squadron).computeSquadronBombLoadout();</span>
            }
        }
<span class="nc" id="L24820">        return reports;</span>
    }

    /**
     * Apply a single critical hit to a Mech system.
     *
     * @param en   the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *             not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc  the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs   the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *             not be &lt;code&gt;null&lt;/code&gt;.
     */
    private Vector&lt;Report&gt; applyMechSystemCritical(Entity en, int loc, CriticalSlot cs) {
<span class="nc" id="L24833">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L24835">        r = new Report(6225);</span>
<span class="nc" id="L24836">        r.subject = en.getId();</span>
<span class="nc" id="L24837">        r.indent(3);</span>
<span class="nc" id="L24838">        r.add(((Mech) en).getSystemName(cs.getIndex()));</span>
<span class="nc" id="L24839">        reports.addElement(r);</span>
<span class="nc bnc" id="L24840" title="All 7 branches missed.">        switch (cs.getIndex()) {</span>
            case Mech.SYSTEM_COCKPIT:
                // Lets auto-eject if we can!
<span class="nc" id="L24843">                Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L24844" title="All 2 branches missed.">                if (game.getOptions().booleanOption(</span>
                        OptionsConstants.ADVANCED_TACOPS_SKIN_OF_THE_TEETH_EJECTION)) {
<span class="nc bnc" id="L24846" title="All 2 branches missed.">                    if (mech.isAutoEject()</span>
<span class="nc bnc" id="L24847" title="All 2 branches missed.">                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L24848" title="All 2 branches missed.">                            || (game.getOptions().booleanOption(</span>
                                    OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L24850" title="All 2 branches missed.">                            &amp;&amp; mech.isCondEjectHeadshot()))) {</span>
<span class="nc" id="L24851">                        reports.addAll(ejectEntity(en, true, true));</span>
                    }
                }

                //First check whether this hit takes out the whole crew; for multi-crew cockpits
                //we need to check the other critical positions (if any).
<span class="nc" id="L24857">                boolean allDead = true;</span>
<span class="nc" id="L24858">                int crewSlot = ((Mech)en).getCrewForCockpitSlot(loc, cs);</span>
<span class="nc bnc" id="L24859" title="All 2 branches missed.">                if (crewSlot &gt;= 0) {</span>
<span class="nc bnc" id="L24860" title="All 2 branches missed.">                    for (int i = 0; i &lt; en.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L24861" title="All 6 branches missed.">                        if (i != crewSlot &amp;&amp; !en.getCrew().isDead(i) &amp;&amp; !en.getCrew().isMissing(i)) {</span>
<span class="nc" id="L24862">                            allDead = false;</span>
                        }
                    }
                }
<span class="nc bnc" id="L24866" title="All 2 branches missed.">                if (allDead) {</span>
                    // Don't kill a pilot multiple times.
<span class="nc bnc" id="L24868" title="All 2 branches missed.">                    if (Crew.DEATH &gt; en.getCrew().getHits()) {</span>
                        // Single pilot or tripod cockpit; all crew are killed.
<span class="nc" id="L24870">                        en.getCrew().setDoomed(true);</span>
<span class="nc" id="L24871">                        Report.addNewline(reports);</span>
<span class="nc" id="L24872">                        reports.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                    }
<span class="nc bnc" id="L24874" title="All 2 branches missed.">                } else if (!en.getCrew().isMissing(crewSlot)){</span>
<span class="nc bnc" id="L24875" title="All 2 branches missed.">                    boolean wasPilot = en.getCrew().getCurrentPilotIndex() == crewSlot;</span>
<span class="nc bnc" id="L24876" title="All 2 branches missed.">                    boolean wasGunner = en.getCrew().getCurrentGunnerIndex() == crewSlot;</span>
<span class="nc" id="L24877">                    en.getCrew().setDead(true, crewSlot);</span>
<span class="nc" id="L24878">                    r = new Report(6027);</span>
<span class="nc" id="L24879">                    r.subject = en.getId();</span>
<span class="nc" id="L24880">                    r.indent(2);</span>
<span class="nc" id="L24881">                    r.add(en.getCrew().getCrewType().getRoleName(crewSlot));</span>
<span class="nc" id="L24882">                    r.addDesc(en);</span>
<span class="nc" id="L24883">                    r.add(en.getCrew().getName(crewSlot));</span>
<span class="nc" id="L24884">                    reports.addElement(r);</span>
<span class="nc" id="L24885">                    r = createCrewTakeoverReport(en, crewSlot, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L24886" title="All 2 branches missed.">                    if (null != r) {</span>
<span class="nc" id="L24887">                        reports.add(r);</span>
                    }
<span class="nc" id="L24889">                }</span>

                break;
            case Mech.SYSTEM_ENGINE:
                // if the slot is missing, the location was previously
                // destroyed and the engine hit was then counted already
<span class="nc bnc" id="L24895" title="All 2 branches missed.">                if (!cs.isMissing()) {</span>
<span class="nc" id="L24896">                    en.engineHitsThisPhase++;</span>
                }
<span class="nc" id="L24898">                int numEngineHits = en.getEngineHits();</span>
<span class="nc" id="L24899">                boolean engineExploded = checkEngineExplosion(en, reports, numEngineHits);</span>
<span class="nc" id="L24900">                int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L24901" title="All 4 branches missed.">                if (en.isSuperHeavy() &amp;&amp; en.hasEngine()</span>
<span class="nc bnc" id="L24902" title="All 2 branches missed.">                        &amp;&amp; (en.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L24903">                    hitsToDestroy = 2;</span>
                }

<span class="nc bnc" id="L24906" title="All 4 branches missed.">                if (!engineExploded &amp;&amp; (numEngineHits &gt;= hitsToDestroy)) {</span>
                    // third engine hit
<span class="nc" id="L24908">                    reports.addAll(destroyEntity(en, &quot;engine destruction&quot;));</span>
<span class="nc" id="L24909">                    if (game.getOptions()</span>
<span class="nc bnc" id="L24910" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L24911">                        reports.addAll(abandonEntity(en));</span>
                    }
<span class="nc" id="L24913">                    en.setSelfDestructing(false);</span>
<span class="nc" id="L24914">                    en.setSelfDestructInitiated(false);</span>
                }
                break;
            case Mech.SYSTEM_GYRO:
<span class="nc" id="L24918">                int gyroHits = en.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, loc);</span>
<span class="nc bnc" id="L24919" title="All 2 branches missed.">                if (en.getGyroType() != Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L24920">                    gyroHits++;</span>
                }
                // Automatically falls in AirMech mode, which it seems would indicate a crash if airborne.
<span class="nc bnc" id="L24923" title="All 6 branches missed.">                if (gyroHits == 3 &amp;&amp; en instanceof LandAirMech &amp;&amp; en.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L24924">                    crashAirMech(en, new PilotingRollData(en.getId(),</span>
                            TargetRoll.AUTOMATIC_FAIL, 1, &quot;gyro destroyed&quot;), reports);
<span class="nc" id="L24926">                    break;</span>
                }
                //No PSR for Mechs in non-leg mode
<span class="nc bnc" id="L24929" title="All 2 branches missed.">                if (!en.canFall(true)) {</span>
<span class="nc" id="L24930">                    break;</span>
                }
<span class="nc bnc" id="L24932" title="All 4 branches missed.">                switch (gyroHits) {</span>
                    case 3:
                        // HD 3 hits, standard 2 hits
<span class="nc" id="L24935">                        game.addPSR(new PilotingRollData(en.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                                1, &quot;gyro destroyed&quot;));
                        // Gyro destroyed entities may not be hull down
<span class="nc" id="L24938">                        en.setHullDown(false);</span>
<span class="nc" id="L24939">                        break;</span>
                    case 2:
                        // HD 2 hits, standard 1 hit
<span class="nc" id="L24942">                        game.addPSR(new PilotingRollData(en.getId(), 3, &quot;gyro hit&quot;));</span>
<span class="nc" id="L24943">                        break;</span>
                    case 1:
                        // HD 1 hit
<span class="nc" id="L24946">                        game.addPSR(new PilotingRollData(en.getId(), 2, &quot;gyro hit&quot;));</span>
<span class="nc" id="L24947">                        break;</span>
                    default:
                        // ignore if &gt;4 hits (don't over do it, the auto fail
                        // already happened.)
                }
<span class="nc" id="L24952">                break;</span>
            case Mech.ACTUATOR_UPPER_LEG:
            case Mech.ACTUATOR_LOWER_LEG:
            case Mech.ACTUATOR_FOOT:
<span class="nc bnc" id="L24956" title="All 2 branches missed.">                if (en.canFall(true)) {</span>
                    // leg/foot actuator piloting roll
<span class="nc" id="L24958">                    game.addPSR(new PilotingRollData(en.getId(), 1, &quot;leg/foot actuator hit&quot;));</span>
                }
                break;
            case Mech.ACTUATOR_HIP:
<span class="nc bnc" id="L24962" title="All 2 branches missed.">                if (en.canFall(true)) {</span>
                    // hip piloting roll
<span class="nc" id="L24964">                    game.addPSR(new PilotingRollData(en.getId(), 2, &quot;hip actuator hit&quot;));</span>
                }
                break;
            case LandAirMech.LAM_AVIONICS:
<span class="nc bnc" id="L24968" title="All 2 branches missed.">                if (en.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L24969" title="All 2 branches missed.">                    if (en.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L24970">                        game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L24971">                                en.getTransportId(), 1, &quot;avionics hit&quot;));</span>
<span class="nc bnc" id="L24972" title="All 2 branches missed.">                    } else if (en.isCapitalFighter()){</span>
<span class="nc" id="L24973">                        game.addControlRoll(new PilotingRollData(en.getId(), 1,</span>
                                &quot;avionics hit&quot;));
                    } else {
<span class="nc" id="L24976">                        game.addControlRoll(new PilotingRollData(en.getId(), 0,</span>
                                &quot;avionics hit&quot;));
                    }
                }
                break;
        }
<span class="nc" id="L24982">        return reports;</span>
    }

    /**
     * Apply a single critical hit to a ProtoMech.
     *
     * @param pm               the &lt;code&gt;Protomech&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to a &lt;code&gt;Protomech&lt;/code&gt;
     *                         torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as damaging
     *                         ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    private Vector&lt;Report&gt; applyProtomechCritical(Protomech pm, int loc, CriticalSlot cs,
                                                  boolean secondaryEffects, int damageCaused,
                                                  boolean isCapital) {
<span class="nc" id="L25006">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L25008">        int numHit = pm.getCritsHit(loc);</span>
<span class="nc bnc" id="L25009" title="All 2 branches missed.">        if ((cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_A)</span>
<span class="nc bnc" id="L25010" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_B)</span>
<span class="nc bnc" id="L25011" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_C)</span>
<span class="nc bnc" id="L25012" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_D)</span>
<span class="nc bnc" id="L25013" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_E)</span>
<span class="nc bnc" id="L25014" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_F)) {</span>
<span class="nc" id="L25015">            r = new Report(6225);</span>
<span class="nc" id="L25016">            r.subject = pm.getId();</span>
<span class="nc" id="L25017">            r.indent(3);</span>
<span class="nc" id="L25018">            r.add(Protomech.systemNames[cs.getIndex()]);</span>
<span class="nc" id="L25019">            reports.addElement(r);</span>
        }
<span class="nc bnc" id="L25021" title="All 11 branches missed.">        switch (cs.getIndex()) {</span>
            case Protomech.SYSTEM_HEADCRIT:
<span class="nc bnc" id="L25023" title="All 2 branches missed.">                if (2 == numHit) {</span>
<span class="nc" id="L25024">                    r = new Report(6230);</span>
<span class="nc" id="L25025">                    r.subject = pm.getId();</span>
<span class="nc" id="L25026">                    reports.addElement(r);</span>
<span class="nc" id="L25027">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_ARMCRIT:
<span class="nc bnc" id="L25031" title="All 2 branches missed.">                if (2 == numHit) {</span>
<span class="nc" id="L25032">                    r = new Report(6235);</span>
<span class="nc" id="L25033">                    r.subject = pm.getId();</span>
<span class="nc" id="L25034">                    reports.addElement(r);</span>
<span class="nc" id="L25035">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_LEGCRIT:
<span class="nc bnc" id="L25039" title="All 2 branches missed.">                if (3 == numHit) {</span>
<span class="nc" id="L25040">                    r = new Report(6240);</span>
<span class="nc" id="L25041">                    r.subject = pm.getId();</span>
<span class="nc" id="L25042">                    r.newlines = 0;</span>
<span class="nc" id="L25043">                    reports.addElement(r);</span>
<span class="nc" id="L25044">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_TORSOCRIT:
<span class="nc bnc" id="L25048" title="All 2 branches missed.">                if (3 == numHit) {</span>
<span class="nc" id="L25049">                    reports.addAll(destroyEntity(pm, &quot;torso destruction&quot;));</span>
                }
                // Torso weapon hits are secondary effects and
                // do not occur when loading from a scenario.
<span class="nc bnc" id="L25053" title="All 2 branches missed.">                else if (secondaryEffects) {</span>
<span class="nc" id="L25054">                    int tweapRoll = Compute.d6(1);</span>
                    CriticalSlot newSlot;

<span class="nc bnc" id="L25057" title="All 7 branches missed.">                    switch (tweapRoll) {</span>
                        case 1:
<span class="nc bnc" id="L25059" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25060">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_A);
<span class="nc" id="L25062">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25064">                                break;</span>
                            }
                        case 2:
<span class="nc bnc" id="L25067" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25068">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_B);
<span class="nc" id="L25070">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25072">                                break;</span>
                            }
<span class="nc" id="L25074">                            newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                    Protomech.SYSTEM_TORSO_WEAPON_A);
<span class="nc" id="L25076">                            reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                    secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25078">                            break;</span>
                        case 3:
<span class="nc bnc" id="L25080" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25081">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25083">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25085">                                break;</span>
                            }
                        case 4:
<span class="nc bnc" id="L25088" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25089">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_D);
<span class="nc" id="L25091">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25093">                                break;</span>
                            }
<span class="nc" id="L25095">                            newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                    Protomech.SYSTEM_TORSO_WEAPON_B);
<span class="nc" id="L25097">                            reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                    secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25099">                            break;</span>
                        case 5:
<span class="nc bnc" id="L25101" title="All 2 branches missed.">                            if (pm.getWeight() &gt; 9) {</span>
<span class="nc bnc" id="L25102" title="All 2 branches missed.">                                if (pm.isQuad()) {</span>
<span class="nc" id="L25103">                                    newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                            Protomech.SYSTEM_TORSO_WEAPON_E);
<span class="nc" id="L25105">                                    reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                            secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25107">                                    break;</span>
                                }
<span class="nc" id="L25109">                                newSlot = new CriticalSlot(</span>
                                        CriticalSlot.TYPE_SYSTEM,
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25112">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25114">                                break;</span>
                            }
                        case 6:
<span class="nc bnc" id="L25117" title="All 2 branches missed.">                            if (pm.getWeight() &gt; 9) {</span>
<span class="nc bnc" id="L25118" title="All 2 branches missed.">                                if (pm.isQuad()) {</span>
<span class="nc" id="L25119">                                    newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                            Protomech.SYSTEM_TORSO_WEAPON_F);
<span class="nc" id="L25121">                                    reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                            secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25123">                                    break;</span>
                                }
<span class="nc" id="L25125">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25127">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
                                break;
                            }
                    }
                    // A magnetic clamp system is destroyed by any torso critical.
<span class="nc" id="L25133">                    Mounted magClamp = pm.getMisc().stream().filter(m -&gt; m.getType()</span>
<span class="nc" id="L25134">                            .hasFlag(MiscType.F_MAGNETIC_CLAMP)).findFirst().orElse(null);</span>
<span class="nc bnc" id="L25135" title="All 4 branches missed.">                    if ((magClamp != null) &amp;&amp; !magClamp.isHit()) {</span>
<span class="nc" id="L25136">                        magClamp.setHit(true);</span>
<span class="nc" id="L25137">                        r = new Report(6252);</span>
<span class="nc" id="L25138">                        r.subject = pm.getId();</span>
<span class="nc" id="L25139">                        reports.addElement(r);</span>
                    }
<span class="nc" id="L25141">                }</span>
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_A:
<span class="nc" id="L25144">                Mounted weaponA = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25145" title="All 2 branches missed.">                if (null != weaponA) {</span>
<span class="nc" id="L25146">                    weaponA.setHit(true);</span>
<span class="nc" id="L25147">                    r = new Report(6245);</span>
<span class="nc" id="L25148">                    r.subject = pm.getId();</span>
<span class="nc" id="L25149">                    r.newlines = 0;</span>
<span class="nc" id="L25150">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_B:
<span class="nc" id="L25154">                Mounted weaponB = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25155" title="All 2 branches missed.">                if (null != weaponB) {</span>
<span class="nc" id="L25156">                    weaponB.setHit(true);</span>
<span class="nc" id="L25157">                    r = new Report(6246);</span>
<span class="nc" id="L25158">                    r.subject = pm.getId();</span>
<span class="nc" id="L25159">                    r.newlines = 0;</span>
<span class="nc" id="L25160">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_C:
<span class="nc" id="L25164">                Mounted weaponC = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25165" title="All 2 branches missed.">                if (null != weaponC) {</span>
<span class="nc" id="L25166">                    weaponC.setHit(true);</span>
<span class="nc" id="L25167">                    r = new Report(6247);</span>
<span class="nc" id="L25168">                    r.subject = pm.getId();</span>
<span class="nc" id="L25169">                    r.newlines = 0;</span>
<span class="nc" id="L25170">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_D:
<span class="nc" id="L25174">                Mounted weaponD = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25175" title="All 2 branches missed.">                if (null != weaponD) {</span>
<span class="nc" id="L25176">                    weaponD.setHit(true);</span>
<span class="nc" id="L25177">                    r = new Report(6248);</span>
<span class="nc" id="L25178">                    r.subject = pm.getId();</span>
<span class="nc" id="L25179">                    r.newlines = 0;</span>
<span class="nc" id="L25180">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_E:
<span class="nc" id="L25184">                Mounted weaponE = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25185" title="All 2 branches missed.">                if (null != weaponE) {</span>
<span class="nc" id="L25186">                    weaponE.setHit(true);</span>
<span class="nc" id="L25187">                    r = new Report(6249);</span>
<span class="nc" id="L25188">                    r.subject = pm.getId();</span>
<span class="nc" id="L25189">                    r.newlines = 0;</span>
<span class="nc" id="L25190">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_F:
<span class="nc" id="L25194">                Mounted weaponF = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25195" title="All 2 branches missed.">                if (null != weaponF) {</span>
<span class="nc" id="L25196">                    weaponF.setHit(true);</span>
<span class="nc" id="L25197">                    r = new Report(6250);</span>
<span class="nc" id="L25198">                    r.subject = pm.getId();</span>
<span class="nc" id="L25199">                    r.newlines = 0;</span>
<span class="nc" id="L25200">                    reports.addElement(r);</span>
                }
                break;
        } // End switch( cs.getType() )

        // Shaded hits cause pilot damage.
<span class="nc bnc" id="L25206" title="All 2 branches missed.">        if (pm.shaded(loc, numHit)) {</span>
            // Destroyed ProtoMech sections have
            // already damaged the pilot.
<span class="nc" id="L25209">            int pHits = Protomech.POSSIBLE_PILOT_DAMAGE[loc]</span>
<span class="nc" id="L25210">                        - pm.getPilotDamageTaken(loc);</span>
<span class="nc bnc" id="L25211" title="All 2 branches missed.">            if (Math.min(1, pHits) &gt; 0) {</span>
<span class="nc" id="L25212">                Report.addNewline(reports);</span>
<span class="nc" id="L25213">                reports.addAll(damageCrew(pm, 1));</span>
<span class="nc" id="L25214">                pHits = 1 + pm.getPilotDamageTaken(loc);</span>
<span class="nc" id="L25215">                pm.setPilotDamageTaken(loc, pHits);</span>
            }
        } // End have-shaded-hit
<span class="nc" id="L25218">        return reports;</span>
    }

    /**
     * Apply a single critical hit to an aerospace unit.
     *
     * @param aero             the &lt;code&gt;Aero&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    private Vector&lt;Report&gt; applyAeroCritical(Aero aero, int loc, CriticalSlot cs, int damageCaused, boolean isCapital) {
<span class="nc" id="L25233">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L25235">        Jumpship js = null;</span>
<span class="nc bnc" id="L25236" title="All 2 branches missed.">        if (aero instanceof Jumpship) {</span>
<span class="nc" id="L25237">            js = (Jumpship)aero;</span>
        }

<span class="nc bnc" id="L25240" title="All 24 branches missed.">        switch (cs.getIndex()) {</span>
            case Aero.CRIT_NONE:
                // no effect
<span class="nc" id="L25243">                r = new Report(6005);</span>
<span class="nc" id="L25244">                r.subject = aero.getId();</span>
<span class="nc" id="L25245">                reports.add(r);</span>
<span class="nc" id="L25246">                break;</span>
            case Aero.CRIT_FCS:
                // Fire control system
<span class="nc" id="L25249">                r = new Report(9105);</span>
<span class="nc" id="L25250">                r.subject = aero.getId();</span>
<span class="nc" id="L25251">                reports.add(r);</span>
<span class="nc" id="L25252">                aero.setFCSHits(aero.getFCSHits() + 1);</span>
<span class="nc" id="L25253">                break;</span>
            case Aero.CRIT_SENSOR:
                // sensors
<span class="nc" id="L25256">                r = new Report(6620);</span>
<span class="nc" id="L25257">                r.subject = aero.getId();</span>
<span class="nc" id="L25258">                reports.add(r);</span>
<span class="nc" id="L25259">                aero.setSensorHits(aero.getSensorHits() + 1);</span>
<span class="nc" id="L25260">                break;</span>
            case Aero.CRIT_AVIONICS:
                // avionics
<span class="nc" id="L25263">                r = new Report(9110);</span>
<span class="nc" id="L25264">                r.subject = aero.getId();</span>
<span class="nc" id="L25265">                reports.add(r);</span>
<span class="nc" id="L25266">                aero.setAvionicsHits(aero.getAvionicsHits() + 1);</span>
<span class="nc bnc" id="L25267" title="All 2 branches missed.">                if (aero.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25268">                    game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25269">                            aero.getTransportId(), 1, &quot;avionics hit&quot;));</span>
<span class="nc bnc" id="L25270" title="All 2 branches missed.">                } else if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25271">                    game.addControlRoll(new PilotingRollData(aero.getId(), 1,</span>
                                                             &quot;avionics hit&quot;));
                } else {
<span class="nc" id="L25274">                    game.addControlRoll(new PilotingRollData(aero.getId(), 0,</span>
                                                             &quot;avionics hit&quot;));
                }
<span class="nc" id="L25277">                break;</span>
            case Aero.CRIT_CONTROL:
                // force control roll
<span class="nc" id="L25280">                r = new Report(9115);</span>
<span class="nc" id="L25281">                r.subject = aero.getId();</span>
<span class="nc" id="L25282">                reports.add(r);</span>
<span class="nc bnc" id="L25283" title="All 2 branches missed.">                if (aero.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25284">                    game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25285">                            aero.getTransportId(), 1, &quot;critical hit&quot;));</span>
<span class="nc bnc" id="L25286" title="All 2 branches missed.">                } else if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25287">                    game.addControlRoll(new PilotingRollData(aero.getId(), 1,</span>
                                                             &quot;critical hit&quot;));
                } else {
<span class="nc" id="L25290">                    game.addControlRoll(new PilotingRollData(aero.getId(), 0,</span>
                                                             &quot;critical hit&quot;));
                }
<span class="nc" id="L25293">                break;</span>
            case Aero.CRIT_FUEL_TANK:
                // fuel tank
<span class="nc" id="L25296">                int boomTarget = 10;</span>
<span class="nc bnc" id="L25297" title="All 2 branches missed.">                if (aero.hasQuirk(OptionsConstants.QUIRK_NEG_FRAGILE_FUEL)) {</span>
<span class="nc" id="L25298">                    boomTarget = 8;</span>
                }
<span class="nc bnc" id="L25300" title="All 4 branches missed.">                if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25301" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)) {
<span class="nc" id="L25303">                    boomTarget = 12;</span>
                }
                // check for possible explosion
<span class="nc" id="L25306">                int fuelroll = Compute.d6(2);</span>
<span class="nc" id="L25307">                r = new Report(9120);</span>
<span class="nc" id="L25308">                r.subject = aero.getId();</span>
<span class="nc bnc" id="L25309" title="All 2 branches missed.">                if (fuelroll &gt;= boomTarget) {</span>
                    // A chance to reroll the explosion with edge
<span class="nc bnc" id="L25311" title="All 2 branches missed.">                    if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25312" title="All 2 branches missed.">                            &amp;&amp; aero.getCrew().getOptions().booleanOption(</span>
                                    OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)) {
                        // Reporting this is funky because 9120 only has room for 2 choices. Replace it.
<span class="nc" id="L25315">                        r = new Report(9123);</span>
<span class="nc" id="L25316">                        r.subject = aero.getId();</span>
<span class="nc" id="L25317">                        r.newlines = 0;</span>
<span class="nc" id="L25318">                        reports.add(r);</span>
<span class="nc" id="L25319">                        aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25320">                        fuelroll = Compute.d6(2);</span>
                        // To explode, or not to explode
<span class="nc bnc" id="L25322" title="All 2 branches missed.">                        if (fuelroll &gt;= boomTarget) {</span>
<span class="nc" id="L25323">                            r = new Report(9124);</span>
<span class="nc" id="L25324">                            r.subject = aero.getId();</span>
                        } else {
<span class="nc" id="L25326">                            r = new Report(9122);</span>
<span class="nc" id="L25327">                            r.subject = aero.getId();</span>
<span class="nc" id="L25328">                            reports.add(r);</span>
<span class="nc" id="L25329">                            break;</span>
                        }
                    }
<span class="nc" id="L25332">                    r.choose(true);</span>
<span class="nc" id="L25333">                    reports.add(r);</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L25335" title="All 2 branches missed.">                    if (aero.isFighter()) {</span>
<span class="nc bnc" id="L25336" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L25337" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L25339" title="All 2 branches missed.">                                || (game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L25341" title="All 2 branches missed.">                                &amp;&amp; aero.isCondEjectFuel()))) {</span>
<span class="nc" id="L25342">                            reports.addAll(ejectEntity(aero, true, false));</span>
                        }
                    }
<span class="nc" id="L25345">                    reports.addAll(destroyEntity(aero, &quot;fuel explosion&quot;, false, false));</span>
                } else {
<span class="nc" id="L25347">                    r.choose(false);</span>
<span class="nc" id="L25348">                    reports.add(r);</span>
                }
                
<span class="nc" id="L25351">                aero.setFuelTankHit(true);</span>
<span class="nc" id="L25352">                break;</span>
            case Aero.CRIT_CREW:
                // pilot hit
<span class="nc" id="L25355">                r = new Report(6650);</span>
<span class="nc bnc" id="L25356" title="All 2 branches missed.">                if (aero.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L25357">                    r = new Report(6651);</span>
<span class="nc" id="L25358">                    r.subject = aero.getId();</span>
<span class="nc" id="L25359">                    reports.add(r);</span>
<span class="nc" id="L25360">                    break;</span>
<span class="nc bnc" id="L25361" title="All 2 branches missed.">                } else if (aero.hasAbility(OptionsConstants.MD_TSM_IMPLANT)) {</span>
<span class="nc" id="L25362">                    r = new Report(6652);</span>
<span class="nc" id="L25363">                    r.subject = aero.getId();</span>
<span class="nc" id="L25364">                    reports.add(r);</span>
<span class="nc" id="L25365">                    break;</span>
                }
<span class="nc bnc" id="L25367" title="All 4 branches missed.">                if ((aero instanceof SmallCraft) || (aero instanceof Jumpship)) {</span>
<span class="nc" id="L25368">                    r = new Report(9197);</span>
                }
<span class="nc bnc" id="L25370" title="All 4 branches missed.">                if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25371" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)
<span class="nc bnc" id="L25373" title="All 2 branches missed.">                        &amp;&amp; (aero.getIgnoredCrewHits() &lt; 2)) {</span>
<span class="nc" id="L25374">                    aero.setIgnoredCrewHits(aero.getIgnoredCrewHits() + 1);</span>
<span class="nc" id="L25375">                    r = new Report(9198);</span>
<span class="nc" id="L25376">                    r.subject = aero.getId();</span>
<span class="nc" id="L25377">                    reports.add(r);</span>
<span class="nc" id="L25378">                    break;</span>
                }
<span class="nc" id="L25380">                r.subject = aero.getId();</span>
<span class="nc" id="L25381">                reports.add(r);</span>
<span class="nc" id="L25382">                reports.addAll(damageCrew(aero, 1));</span>
                // The pilot may have just expired.
<span class="nc bnc" id="L25384" title="All 4 branches missed.">                if ((aero.getCrew().isDead() || aero.getCrew().isDoomed())</span>
<span class="nc bnc" id="L25385" title="All 2 branches missed.">                       &amp;&amp; !aero.getCrew().isEjected()) {</span>
<span class="nc" id="L25386">                    reports.addAll(destroyEntity(aero, &quot;pilot death&quot;, true, true));</span>
                }
                break;
            case Aero.CRIT_GEAR:
                // landing gear
<span class="nc" id="L25391">                r = new Report(9125);</span>
<span class="nc" id="L25392">                r.subject = aero.getId();</span>
<span class="nc" id="L25393">                reports.add(r);</span>
<span class="nc" id="L25394">                aero.setGearHit(true);</span>
<span class="nc" id="L25395">                break;</span>
            case Aero.CRIT_BOMB:
                // bomb destroyed
                // go through bomb list and choose one
<span class="nc" id="L25399">                List&lt;Mounted&gt; bombs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25400" title="All 2 branches missed.">                for (Mounted bomb : aero.getBombs()) {</span>
<span class="nc bnc" id="L25401" title="All 4 branches missed.">                    if (bomb.getType().isHittable() &amp;&amp; (bomb.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L25402">                        bombs.add(bomb);</span>
                    }
<span class="nc" id="L25404">                }</span>
<span class="nc bnc" id="L25405" title="All 2 branches missed.">                if (bombs.size() &gt; 0) {</span>
<span class="nc" id="L25406">                    Mounted hitbomb = bombs.get(Compute.randomInt(bombs.size()));</span>
<span class="nc" id="L25407">                    hitbomb.setShotsLeft(0);</span>
<span class="nc" id="L25408">                    hitbomb.setDestroyed(true);</span>
<span class="nc" id="L25409">                    r = new Report(9130);</span>
<span class="nc" id="L25410">                    r.subject = aero.getId();</span>
<span class="nc" id="L25411">                    r.add(hitbomb.getDesc());</span>
<span class="nc" id="L25412">                    reports.add(r);</span>
                    // If we are part of a squadron, we should recalculate
                    // the bomb salvo for the squadron
<span class="nc bnc" id="L25415" title="All 2 branches missed.">                    if (aero.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L25416">                        Entity e = game.getEntity(aero.getTransportId());</span>
<span class="nc bnc" id="L25417" title="All 2 branches missed.">                        if (e instanceof FighterSquadron) {</span>
<span class="nc" id="L25418">                            ((FighterSquadron) e).computeSquadronBombLoadout();</span>
                        }
                    }
<span class="nc" id="L25421">                } else {</span>
<span class="nc" id="L25422">                    r = new Report(9131);</span>
<span class="nc" id="L25423">                    r.subject = aero.getId();</span>
<span class="nc" id="L25424">                    reports.add(r);</span>
                }
<span class="nc" id="L25426">                break;</span>
            case Aero.CRIT_HEATSINK:
                // heat sink hit
<span class="nc" id="L25429">                int sinksLost = 1;</span>
<span class="nc bnc" id="L25430" title="All 2 branches missed.">                if (isCapital) {</span>
<span class="nc" id="L25431">                    sinksLost = 10;</span>
                }
<span class="nc" id="L25433">                r = new Report(9135);</span>
<span class="nc" id="L25434">                r.subject = aero.getId();</span>
<span class="nc" id="L25435">                r.add(sinksLost);</span>
<span class="nc" id="L25436">                reports.add(r);</span>
<span class="nc" id="L25437">                aero.setHeatSinks(Math.max(0, aero.getHeatSinks() - sinksLost));</span>
<span class="nc" id="L25438">                break;</span>
            case Aero.CRIT_WEAPON_BROAD:
<span class="nc bnc" id="L25440" title="All 2 branches missed.">                if (aero instanceof Warship) {</span>
<span class="nc bnc" id="L25441" title="All 4 branches missed.">                    if ((loc == Jumpship.LOC_ALS) || (loc == Jumpship.LOC_FLS)) {</span>
<span class="nc" id="L25442">                        loc = Warship.LOC_LBS;</span>
<span class="nc bnc" id="L25443" title="All 4 branches missed.">                    } else if ((loc == Jumpship.LOC_ARS)</span>
                               || (loc == Jumpship.LOC_FRS)) {
<span class="nc" id="L25445">                        loc = Warship.LOC_RBS;</span>
                    }
                }
            case Aero.CRIT_WEAPON:
<span class="nc bnc" id="L25449" title="All 2 branches missed.">                if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25450">                    boolean destroyAll = false;</span>
                    // CRIT_WEAPON damages the capital fighter/squadron's weapon groups
                    // Go ahead and map damage for the fighter's weapon criticals for MHQ
                    // resolution.
<span class="nc" id="L25454">                    aero.damageCapFighterWeapons(loc);</span>
<span class="nc bnc" id="L25455" title="All 4 branches missed.">                    if ((loc == Aero.LOC_NOSE) || (loc == Aero.LOC_AFT)) {</span>
<span class="nc" id="L25456">                        destroyAll = true;</span>
                    }
                    
                    // Convert L/R wing location to wings, else wing weapons never get hit
<span class="nc bnc" id="L25460" title="All 4 branches missed.">                    if (loc == Aero.LOC_LWING || loc == Aero.LOC_RWING) {</span>
<span class="nc" id="L25461">                        loc = Aero.LOC_WINGS;</span>
                    }
                    
<span class="nc bnc" id="L25464" title="All 2 branches missed.">                    if (loc == Aero.LOC_WINGS) {</span>
<span class="nc bnc" id="L25465" title="All 2 branches missed.">                        if (aero.areWingsHit()) {</span>
<span class="nc" id="L25466">                            destroyAll = true;</span>
                        } else {
<span class="nc" id="L25468">                            aero.setWingsHit(true);</span>
                        }
                    }
<span class="nc bnc" id="L25471" title="All 2 branches missed.">                    for (Mounted weapon : aero.getWeaponList()) {</span>
<span class="nc bnc" id="L25472" title="All 2 branches missed.">                        if (weapon.getLocation() == loc) {</span>
<span class="nc bnc" id="L25473" title="All 2 branches missed.">                            if (destroyAll) {</span>
<span class="nc" id="L25474">                                weapon.setHit(true);</span>
                            } else {
<span class="nc" id="L25476">                                weapon.setNWeapons(weapon.getNWeapons() / 2);</span>
                            }
                        }
<span class="nc" id="L25479">                    }</span>
                    // also destroy any ECM or BAP in the location hit
<span class="nc bnc" id="L25481" title="All 2 branches missed.">                    for (Mounted misc : aero.getMisc()) {</span>
<span class="nc bnc" id="L25482" title="All 2 branches missed.">                        if ((misc.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L25483" title="All 2 branches missed.">                            || misc.getType().hasFlag(MiscType.F_ANGEL_ECM)</span>
<span class="nc bnc" id="L25484" title="All 2 branches missed.">                            || misc.getType().hasFlag(MiscType.F_BAP))</span>
<span class="nc bnc" id="L25485" title="All 2 branches missed.">                                &amp;&amp; misc.getLocation() == loc) {</span>
<span class="nc" id="L25486">                            misc.setHit(true);</span>
                            //Taharqa: We should also damage the critical slot, or
                            //MM and MHQ won't remember that this weapon is damaged on the MUL
                            //file
<span class="nc bnc" id="L25490" title="All 2 branches missed.">                            for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25491">                                CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25492" title="All 2 branches missed.">                                if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25493" title="All 2 branches missed.">                                        (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25494">                                    continue;</span>
                                }
<span class="nc" id="L25496">                                Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25497" title="All 2 branches missed.">                                if (mounted.equals(misc)) {</span>
<span class="nc" id="L25498">                                    aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25499">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L25503">                    }</span>
<span class="nc" id="L25504">                    r = new Report(9152);</span>
<span class="nc" id="L25505">                    r.subject = aero.getId();</span>
<span class="nc" id="L25506">                    r.add(aero.getLocationName(loc));</span>
<span class="nc" id="L25507">                    reports.add(r);</span>
<span class="nc" id="L25508">                    break;</span>
                }
<span class="nc" id="L25510">                r = new Report(9150);</span>
<span class="nc" id="L25511">                r.subject = aero.getId();</span>
<span class="nc" id="L25512">                List&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25513" title="All 2 branches missed.">                for (Mounted weapon : aero.getWeaponList()) {</span>
<span class="nc bnc" id="L25514" title="All 4 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isDestroyed()</span>
<span class="nc bnc" id="L25515" title="All 2 branches missed.">                            &amp;&amp; weapon.getType().isHittable()) {</span>
<span class="nc" id="L25516">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L25518">                }</span>
                // add in in hittable misc equipment
<span class="nc bnc" id="L25520" title="All 2 branches missed.">                for (Mounted misc : aero.getMisc()) {</span>
<span class="nc bnc" id="L25521" title="All 2 branches missed.">                    if (misc.getType().isHittable()</span>
<span class="nc bnc" id="L25522" title="All 2 branches missed.">                        &amp;&amp; (misc.getLocation() == loc)</span>
<span class="nc bnc" id="L25523" title="All 2 branches missed.">                        &amp;&amp; !misc.isDestroyed()) {</span>
<span class="nc" id="L25524">                        weapons.add(misc);</span>
                    }
<span class="nc" id="L25526">                }</span>
<span class="nc bnc" id="L25527" title="All 2 branches missed.">                if (weapons.size() &gt; 0) {</span>
<span class="nc" id="L25528">                    Mounted weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
                    // possibly check for an ammo explosion
                    // don't allow ammo explosions on fighter squadrons
<span class="nc bnc" id="L25531" title="All 4 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AMMO_EXPLOSIONS)</span>
                        &amp;&amp; !(aero instanceof FighterSquadron)
<span class="nc bnc" id="L25533" title="All 2 branches missed.">                        &amp;&amp; (weapon.getType() instanceof WeaponType)) {</span>
                        //Bay Weapons
<span class="nc bnc" id="L25535" title="All 2 branches missed.">                        if (aero.usesWeaponBays()) {</span>
                            //Finish reporting(9150) a hit on the bay
<span class="nc" id="L25537">                            r.add(weapon.getName());</span>
<span class="nc" id="L25538">                            reports.add(r);</span>
                            //Pick a random weapon in the bay and get the stats
<span class="nc" id="L25540">                            int wId = weapon.getBayWeapons().get(Compute.randomInt(weapon.getBayWeapons().size()));</span>
<span class="nc" id="L25541">                            Mounted bayW = aero.getEquipment(wId);</span>
<span class="nc" id="L25542">                            Mounted bayWAmmo = bayW.getLinked();</span>
<span class="nc bnc" id="L25543" title="All 4 branches missed.">                            if (bayWAmmo != null &amp;&amp; bayWAmmo.getType().isExplosive(bayWAmmo)) {</span>
<span class="nc" id="L25544">                                r = new Report(9156);</span>
<span class="nc" id="L25545">                                r.subject = aero.getId();</span>
<span class="nc" id="L25546">                                r.newlines = 1;</span>
<span class="nc" id="L25547">                                r.indent(2);</span>
                                //On a roll of 10+, the ammo bin explodes
<span class="nc" id="L25549">                                int ammoRoll = Compute.d6(2);</span>
<span class="nc" id="L25550">                                boomTarget = 10;</span>
<span class="nc bnc" id="L25551" title="All 2 branches missed.">                                r.choose(ammoRoll &gt;= boomTarget);</span>
                                // A chance to reroll an explosion with edge
<span class="nc bnc" id="L25553" title="All 2 branches missed.">                                if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25554" title="All 4 branches missed.">                                        &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)</span>
                                        &amp;&amp; ammoRoll &gt;= boomTarget) {
                                    // Report 9156 doesn't offer the right choices. Replace it.
<span class="nc" id="L25557">                                    r = new Report(9158);</span>
<span class="nc" id="L25558">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25559">                                    r.newlines = 0;</span>
<span class="nc" id="L25560">                                    r.indent(2);</span>
<span class="nc" id="L25561">                                    reports.add(r);</span>
<span class="nc" id="L25562">                                    aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25563">                                    ammoRoll = Compute.d6(2);</span>
                                    // To explode, or not to explode
<span class="nc bnc" id="L25565" title="All 2 branches missed.">                                    if (ammoRoll &gt;= boomTarget) {</span>
<span class="nc" id="L25566">                                        reports.addAll(explodeEquipment(aero, loc, bayWAmmo));</span>
                                    } else {
<span class="nc" id="L25568">                                        r = new Report(9157);</span>
<span class="nc" id="L25569">                                        r.subject = aero.getId();</span>
<span class="nc" id="L25570">                                        reports.add(r);</span>
                                    }
                                } else {
                                    //Finish handling report 9156
<span class="nc" id="L25574">                                    reports.add(r);</span>
<span class="nc bnc" id="L25575" title="All 2 branches missed.">                                    if (ammoRoll &gt;= boomTarget) {</span>
<span class="nc" id="L25576">                                        reports.addAll(explodeEquipment(aero, loc, bayWAmmo));</span>
                                    }
                                }
                            }
                            //Hit the weapon then also hit all the other weapons in the bay
<span class="nc" id="L25581">                            weapon.setHit(true);</span>
<span class="nc bnc" id="L25582" title="All 2 branches missed.">                            for(int next : weapon.getBayWeapons()) {</span>
<span class="nc" id="L25583">                                Mounted bayWeap = aero.getEquipment(next);</span>
<span class="nc bnc" id="L25584" title="All 2 branches missed.">                                if(null != bayWeap) {</span>
<span class="nc" id="L25585">                                    bayWeap.setHit(true);</span>
                                    //Taharqa: We should also damage the critical slot, or
                                    //MM and MHQ won't remember that this weapon is damaged on the MUL
                                    //file
<span class="nc bnc" id="L25589" title="All 2 branches missed.">                                    for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25590">                                        CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25591" title="All 2 branches missed.">                                        if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25592" title="All 2 branches missed.">                                                (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25593">                                            continue;</span>
                                        }
<span class="nc" id="L25595">                                        Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25596" title="All 2 branches missed.">                                        if (mounted.equals(bayWeap)) {</span>
<span class="nc" id="L25597">                                            aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25598">                                            break;</span>
                                        }
                                    }
                                }
<span class="nc" id="L25602">                            }</span>
<span class="nc" id="L25603">                            break;</span>
                        }
                        // does it use Ammo?
<span class="nc" id="L25606">                        WeaponType wtype = (WeaponType) weapon.getType();</span>
<span class="nc bnc" id="L25607" title="All 2 branches missed.">                        if (wtype.getAmmoType() != AmmoType.T_NA) {</span>
<span class="nc" id="L25608">                            Mounted m = weapon.getLinked();</span>
<span class="nc" id="L25609">                            int ammoroll = Compute.d6(2);</span>
<span class="nc bnc" id="L25610" title="All 2 branches missed.">                            if (ammoroll &gt;= 10) {</span>
                                // A chance to reroll an explosion with edge
<span class="nc bnc" id="L25612" title="All 2 branches missed.">                                if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25613" title="All 2 branches missed.">                                        &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)) {</span>
<span class="nc" id="L25614">                                    aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25615">                                    r = new Report(6530);</span>
<span class="nc" id="L25616">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25617">                                    r.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25618">                                    reports.add(r);</span>
<span class="nc" id="L25619">                                    ammoroll = Compute.d6(2);</span>
<span class="nc bnc" id="L25620" title="All 2 branches missed.">                                    if (ammoroll &gt;= 10) {</span>
<span class="nc" id="L25621">                                        reports.addAll(explodeEquipment(aero, loc, m));</span>
<span class="nc" id="L25622">                                        break;</span>
                                    } else {
                                        //Crisis averted, set report 9150 back up
<span class="nc" id="L25625">                                        r = new Report(9150);</span>
<span class="nc" id="L25626">                                        r.subject = aero.getId();</span>
                                    }
                                } else {
<span class="nc" id="L25629">                                    r = new Report(9151);</span>
<span class="nc" id="L25630">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25631">                                    r.add(m.getName());</span>
<span class="nc" id="L25632">                                    r.newlines = 0;</span>
<span class="nc" id="L25633">                                    reports.add(r);</span>
<span class="nc" id="L25634">                                    reports.addAll(explodeEquipment(aero, loc, m));</span>
<span class="nc" id="L25635">                                    break;</span>
                                }
                            }
                        }
                    }
                    // If the weapon is explosive, use edge to roll up a new one
<span class="nc bnc" id="L25641" title="All 2 branches missed.">                    if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25642" title="All 2 branches missed.">                            &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)</span>
<span class="nc bnc" id="L25643" title="All 4 branches missed.">                            &amp;&amp; (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L25644" title="All 2 branches missed.">                                    &amp;&amp; !weapon.isDestroyed())) {</span>
<span class="nc" id="L25645">                        aero.getCrew().decreaseEdge();</span>
                        //Try something new for an interrupting report. r is still 9150.
<span class="nc" id="L25647">                        Report r1 = new Report(6530);</span>
<span class="nc" id="L25648">                        r1.subject = aero.getId();</span>
<span class="nc" id="L25649">                        r1.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25650">                        reports.add(r1);</span>
<span class="nc" id="L25651">                        weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
                    }
<span class="nc" id="L25653">                    r.add(weapon.getName());</span>
<span class="nc" id="L25654">                    reports.add(r);</span>
                    // explosive weapons e.g. gauss now explode
<span class="nc bnc" id="L25656" title="All 4 branches missed.">                    if (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L25657" title="All 2 branches missed.">                        &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L25658">                        reports.addAll(explodeEquipment(aero, loc, weapon));</span>
                    }
<span class="nc" id="L25660">                    weapon.setHit(true);</span>
                    //Taharqa: We should also damage the critical slot, or
                    //MM and MHQ won't remember that this weapon is damaged on the MUL
                    //file
<span class="nc bnc" id="L25664" title="All 2 branches missed.">                    for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25665">                        CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25666" title="All 2 branches missed.">                        if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25667" title="All 2 branches missed.">                                (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25668">                            continue;</span>
                        }
<span class="nc" id="L25670">                        Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25671" title="All 2 branches missed.">                        if (mounted.equals(weapon)) {</span>
<span class="nc" id="L25672">                            aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25673">                            break;</span>
                        }
                    }
                    //if this is a weapons bay then also hit all the other weapons
<span class="nc bnc" id="L25677" title="All 2 branches missed.">                    for(int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L25678">                        Mounted bayWeap = aero.getEquipment(wId);</span>
<span class="nc bnc" id="L25679" title="All 2 branches missed.">                        if(null != bayWeap) {</span>
<span class="nc" id="L25680">                            bayWeap.setHit(true);</span>
                            //Taharqa: We should also damage the critical slot, or
                            //MM and MHQ won't remember that this weapon is damaged on the MUL
                            //file
<span class="nc bnc" id="L25684" title="All 2 branches missed.">                            for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25685">                                CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25686" title="All 2 branches missed.">                                if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25687" title="All 2 branches missed.">                                        (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25688">                                    continue;</span>
                                }
<span class="nc" id="L25690">                                Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25691" title="All 2 branches missed.">                                if (mounted.equals(bayWeap)) {</span>
<span class="nc" id="L25692">                                    aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25693">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L25697">                    }</span>
<span class="nc" id="L25698">                } else {</span>
<span class="nc" id="L25699">                    r = new Report(9155);</span>
<span class="nc" id="L25700">                    r.subject = aero.getId();</span>
<span class="nc" id="L25701">                    reports.add(r);</span>
                }
<span class="nc" id="L25703">                break;</span>
            case Aero.CRIT_ENGINE:
                // engine hit
<span class="nc" id="L25706">                r = new Report(9140);</span>
<span class="nc" id="L25707">                r.subject = aero.getId();</span>
<span class="nc" id="L25708">                reports.add(r);</span>
<span class="nc" id="L25709">                aero.engineHitsThisPhase++;</span>
<span class="nc" id="L25710">                boolean engineExploded = checkEngineExplosion(aero, reports, 1);</span>
<span class="nc" id="L25711">                aero.setEngineHits(aero.getEngineHits() + 1);</span>
<span class="nc bnc" id="L25712" title="All 4 branches missed.">                if ((aero.getEngineHits() &gt;= aero.getMaxEngineHits())</span>
                    || engineExploded) {
                    // this engine hit puts the ASF out of commission
<span class="nc" id="L25715">                    reports.addAll(destroyEntity(aero, &quot;engine destruction&quot;, true,</span>
                                               true));
<span class="nc" id="L25717">                    aero.setSelfDestructing(false);</span>
<span class="nc" id="L25718">                    aero.setSelfDestructInitiated(false);</span>
                }
                break;
            case Aero.CRIT_LEFT_THRUSTER:
                // thruster hit
<span class="nc" id="L25723">                r = new Report(9160);</span>
<span class="nc" id="L25724">                r.subject = aero.getId();</span>
<span class="nc" id="L25725">                reports.add(r);</span>
<span class="nc" id="L25726">                aero.setLeftThrustHits(aero.getLeftThrustHits() + 1);</span>
<span class="nc" id="L25727">                break;</span>
            case Aero.CRIT_RIGHT_THRUSTER:
                // thruster hit
<span class="nc" id="L25730">                r = new Report(9160);</span>
<span class="nc" id="L25731">                r.subject = aero.getId();</span>
<span class="nc" id="L25732">                reports.add(r);</span>
<span class="nc" id="L25733">                aero.setRightThrustHits(aero.getRightThrustHits() + 1);</span>
<span class="nc" id="L25734">                break;</span>
            case Aero.CRIT_CARGO:
<span class="nc" id="L25736">                applyCargoCritical(aero, damageCaused, reports);</span>
<span class="nc" id="L25737">                break;</span>
            case Aero.CRIT_DOOR:
                // door hit
                // choose a random bay
<span class="nc" id="L25741">                String bayType = aero.damageBayDoor();</span>
<span class="nc bnc" id="L25742" title="All 2 branches missed.">                if (!bayType.equals(&quot;none&quot;)) {</span>
<span class="nc" id="L25743">                    r = new Report(9170);</span>
<span class="nc" id="L25744">                    r.subject = aero.getId();</span>
<span class="nc" id="L25745">                    r.add(bayType);</span>
<span class="nc" id="L25746">                    reports.add(r);</span>
                } else {
<span class="nc" id="L25748">                    r = new Report(9171);</span>
<span class="nc" id="L25749">                    r.subject = aero.getId();</span>
<span class="nc" id="L25750">                    reports.add(r);</span>
                }
<span class="nc" id="L25752">                break;</span>
            case Aero.CRIT_DOCK_COLLAR:
                // docking collar hit
                // different effect for DropShips and JumpShips
<span class="nc bnc" id="L25756" title="All 2 branches missed.">                if (aero instanceof Dropship) {</span>
<span class="nc" id="L25757">                    ((Dropship)aero).setDamageDockCollar(true);</span>
<span class="nc" id="L25758">                    r = new Report(9175);</span>
<span class="nc" id="L25759">                    r.subject = aero.getId();</span>
<span class="nc" id="L25760">                    reports.add(r);</span>
                }
<span class="nc bnc" id="L25762" title="All 2 branches missed.">                if (aero instanceof Jumpship) {</span>
                    // damage a random docking collar
<span class="nc bnc" id="L25764" title="All 2 branches missed.">                    if (aero.damageDockCollar()) {</span>
<span class="nc" id="L25765">                        r = new Report(9176);</span>
<span class="nc" id="L25766">                        r.subject = aero.getId();</span>
<span class="nc" id="L25767">                        reports.add(r);</span>
                    } else {
<span class="nc" id="L25769">                        r = new Report(9177);</span>
<span class="nc" id="L25770">                        r.subject = aero.getId();</span>
<span class="nc" id="L25771">                        reports.add(r);</span>
                    }
                }
                break;
            case Aero.CRIT_KF_BOOM:
                // KF boom hit
                // no real effect yet
<span class="nc bnc" id="L25778" title="All 2 branches missed.">                if (aero instanceof Dropship) {</span>
<span class="nc" id="L25779">                    ((Dropship)aero).setDamageKFBoom(true);</span>
<span class="nc" id="L25780">                    r = new Report(9180);</span>
<span class="nc" id="L25781">                    r.subject = aero.getId();</span>
<span class="nc" id="L25782">                    reports.add(r);</span>
                }
                break;
            case Aero.CRIT_CIC:
<span class="nc bnc" id="L25786" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L25787">                    break;</span>
                }
                // CIC hit
<span class="nc" id="L25790">                r = new Report(9185);</span>
<span class="nc" id="L25791">                r.subject = aero.getId();</span>
<span class="nc" id="L25792">                reports.add(r);</span>
<span class="nc" id="L25793">                js.setCICHits(js.getCICHits() + 1);</span>
<span class="nc" id="L25794">                break;</span>
            case Aero.CRIT_KF_DRIVE:
                //Per SO construction rules, stations have no KF drive, therefore they can't take a hit to it...
<span class="nc bnc" id="L25797" title="All 4 branches missed.">                if (js == null || js instanceof SpaceStation) {</span>
<span class="nc" id="L25798">                    break;</span>
                }
                // KF Drive hit - damage the drive integrity
<span class="nc" id="L25801">                js.setKFIntegrity(Math.max(0, (js.getKFIntegrity() - 1)));</span>
<span class="nc bnc" id="L25802" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_EXPANDED_KF_DRIVE_DAMAGE)) {</span>
                    //Randomize the component struck - probabilities taken from the old BattleSpace record sheets
<span class="nc bnc" id="L25804" title="All 7 branches missed.">                    switch (Compute.d6(2)) {</span>
                    case 2:
                        //Drive Coil Hit
<span class="nc" id="L25807">                        r = new Report(9186);</span>
<span class="nc" id="L25808">                        r.subject = aero.getId();</span>
<span class="nc" id="L25809">                        reports.add(r);</span>
<span class="nc" id="L25810">                        js.setKFDriveCoilHit(true);</span>
<span class="nc" id="L25811">                        break;</span>
                    case 3:
                    case 11:
                        //Charging System Hit
<span class="nc" id="L25815">                        r = new Report(9187);</span>
<span class="nc" id="L25816">                        r.subject = aero.getId();</span>
<span class="nc" id="L25817">                        reports.add(r);</span>
<span class="nc" id="L25818">                        js.setKFChargingSystemHit(true);</span>
<span class="nc" id="L25819">                        break;</span>
                    case 5:
                        //Field Initiator Hit
<span class="nc" id="L25822">                        r = new Report(9190);</span>
<span class="nc" id="L25823">                        r.subject = aero.getId();</span>
<span class="nc" id="L25824">                        reports.add(r);</span>
<span class="nc" id="L25825">                        js.setKFFieldInitiatorHit(true);</span>
<span class="nc" id="L25826">                        break;</span>
                    case 4:
                    case 6:
                    case 7:
                    case 8:
                        //Helium Tank Hit
<span class="nc" id="L25832">                        r = new Report(9189);</span>
<span class="nc" id="L25833">                        r.subject = aero.getId();</span>
<span class="nc" id="L25834">                        reports.add(r);</span>
<span class="nc" id="L25835">                        js.setKFHeliumTankHit(true);</span>
<span class="nc" id="L25836">                        break;</span>
                    case 9:
                        //Drive Controller Hit
<span class="nc" id="L25839">                        r = new Report(9191);</span>
<span class="nc" id="L25840">                        r.subject = aero.getId();</span>
<span class="nc" id="L25841">                        reports.add(r);</span>
<span class="nc" id="L25842">                        js.setKFDriveControllerHit(true);</span>
<span class="nc" id="L25843">                        break;</span>
                    case 10:
                    case 12:
                        //LF Battery Hit - if you don't have one, treat as helium tank
<span class="nc bnc" id="L25847" title="All 2 branches missed.">                        if (js.hasLF()) {</span>
<span class="nc" id="L25848">                            r = new Report(9188);</span>
<span class="nc" id="L25849">                            r.subject = aero.getId();</span>
<span class="nc" id="L25850">                            reports.add(r);</span>
<span class="nc" id="L25851">                            js.setLFBatteryHit(true);</span>
                        } else {
<span class="nc" id="L25853">                            r = new Report(9189);</span>
<span class="nc" id="L25854">                            r.subject = aero.getId();</span>
<span class="nc" id="L25855">                            reports.add(r);</span>
<span class="nc" id="L25856">                            js.setKFHeliumTankHit(true);</span>
                        }
<span class="nc" id="L25858">                        break;</span>
                    }
                } else {
                    //Just report the standard KF hit, per SO rules
<span class="nc" id="L25862">                    r = new Report(9194);</span>
<span class="nc" id="L25863">                    r.subject = aero.getId();</span>
<span class="nc" id="L25864">                    reports.add(r);</span>
                }
<span class="nc" id="L25866">                break;</span>
            case Aero.CRIT_GRAV_DECK:
<span class="nc bnc" id="L25868" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L25869">                    break;</span>
                }
<span class="nc" id="L25871">                int choice = Compute.randomInt(js.getTotalGravDeck());</span>
                // Grav Deck hit
<span class="nc" id="L25873">                r = new Report(9195);</span>
<span class="nc" id="L25874">                r.subject = aero.getId();</span>
<span class="nc" id="L25875">                reports.add(r);</span>
<span class="nc" id="L25876">                js.setGravDeckDamageFlag(choice, 1);</span>
<span class="nc" id="L25877">                break;</span>
            case Aero.CRIT_LIFE_SUPPORT:
                // Life Support hit
<span class="nc" id="L25880">                aero.setLifeSupport(false);</span>
<span class="nc" id="L25881">                r = new Report(9196);</span>
<span class="nc" id="L25882">                r.subject = aero.getId();</span>
<span class="nc" id="L25883">                reports.add(r);</span>
                break;
        }
<span class="nc" id="L25886">        return reports;</span>
    }

    /**
     * Selects random undestroyed bay and applies damage, destroying loaded units where applicable.
     *
     * @param aero           The unit that received the cargo critical.
     * @param damageCaused   The amount of damage applied by the hit that resulted in the cargo critical.
     * @param reports        Used to return any report generated while applying the critical.
     */
    private void applyCargoCritical(Aero aero, int damageCaused, Vector&lt;Report&gt; reports) {
        Report r;
        // cargo hit
        // First what percentage of the cargo did the hit destroy?
<span class="nc" id="L25900">        double percentDestroyed = 0.0;</span>
<span class="nc" id="L25901">        double mult = 2.0;</span>
<span class="nc bnc" id="L25902" title="All 4 branches missed.">        if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25903" title="All 2 branches missed.">            &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)) {</span>
<span class="nc" id="L25904">            mult = 4.0;</span>
        }
<span class="nc bnc" id="L25906" title="All 2 branches missed.">        if (damageCaused &gt; 0) {</span>
<span class="nc" id="L25907">            percentDestroyed = Math.min(</span>
<span class="nc" id="L25908">                    damageCaused / (mult * aero.getSI()), 1.0);</span>
        }
        List&lt;Bay&gt; bays;
<span class="nc" id="L25911">        double destroyed = 0;</span>
        // did it hit cargo or units
<span class="nc" id="L25913">        int roll = Compute.d6(1);</span>
        // A hit on a bay filled with transported units is devastating
        // allow a reroll with edge
<span class="nc bnc" id="L25916" title="All 2 branches missed.">        if (aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_UNIT_CARGO_LOST)</span>
<span class="nc bnc" id="L25917" title="All 4 branches missed.">                &amp;&amp; aero.getCrew().hasEdgeRemaining() &amp;&amp; roll &gt; 3) {</span>
<span class="nc" id="L25918">            aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25919">            r = new Report(9172);</span>
<span class="nc" id="L25920">            r.subject = aero.getId();</span>
<span class="nc" id="L25921">            r.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25922">            reports.add(r);</span>
            //Reroll. Maybe we'll hit cargo.
<span class="nc" id="L25924">            roll = Compute.d6(1);</span>
        }
<span class="nc bnc" id="L25926" title="All 2 branches missed.">        if (roll &lt; 4) {</span>
<span class="nc" id="L25927">            bays = aero.getTransportBays().stream().filter(Bay::isCargo).collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L25929">            bays = aero.getTransportBays().stream()</span>
<span class="nc bnc" id="L25930" title="All 4 branches missed.">                    .filter(b -&gt; !b.isCargo() &amp;&amp; !b.isQuarters()).collect(Collectors.toList());</span>
        }
<span class="nc" id="L25932">        Bay hitBay = null;</span>
<span class="nc bnc" id="L25933" title="All 4 branches missed.">        while ((null == hitBay) &amp;&amp; !bays.isEmpty()) {</span>
<span class="nc" id="L25934">            hitBay = bays.remove(Compute.randomInt(bays.size()));</span>
<span class="nc bnc" id="L25935" title="All 2 branches missed.">            if (hitBay.getBayDamage() &lt; hitBay.getCapacity()) {</span>
<span class="nc bnc" id="L25936" title="All 2 branches missed.">                if (hitBay.isCargo()) {</span>
<span class="nc" id="L25937">                    destroyed = (hitBay.getCapacity() * percentDestroyed * 2.0) / 2.0;</span>
                } else {
<span class="nc" id="L25939">                    destroyed = Math.ceil(hitBay.getCapacity() * percentDestroyed);</span>
                }
            } else {
<span class="nc" id="L25942">                hitBay = null;</span>
            }
        }
<span class="nc bnc" id="L25945" title="All 2 branches missed.">        if (null != hitBay) {</span>
<span class="nc" id="L25946">            destroyed = Math.min(destroyed, hitBay.getCapacity() - hitBay.getBayDamage());</span>
<span class="nc bnc" id="L25947" title="All 2 branches missed.">            if (hitBay.isCargo()) {</span>
<span class="nc" id="L25948">                r = new Report(9165);</span>
            } else {
<span class="nc" id="L25950">                r = new Report(9166);</span>
            }
<span class="nc" id="L25952">            r.subject = aero.getId();</span>
<span class="nc" id="L25953">            r.add(hitBay.getBayNumber());</span>
<span class="nc bnc" id="L25954" title="All 2 branches missed.">            if (destroyed == (int) destroyed) {</span>
<span class="nc" id="L25955">                r.add((int) destroyed);</span>
            } else {
<span class="nc" id="L25957">                r.add(String.valueOf(Math.ceil(destroyed * 2.0) / 2.0));</span>
            }
<span class="nc" id="L25959">            reports.add(r);</span>
<span class="nc bnc" id="L25960" title="All 2 branches missed.">            if (!hitBay.isCargo()) {</span>
<span class="nc" id="L25961">                List&lt;Entity&gt; units = new ArrayList&lt;&gt;(hitBay.getLoadedUnits());</span>
<span class="nc" id="L25962">                List&lt;Entity&gt; toRemove = new ArrayList&lt;&gt;();</span>
                //We're letting destroyed units stay in the bay now, but take them off the targets list
<span class="nc bnc" id="L25964" title="All 2 branches missed.">                for (Entity en : units) {</span>
<span class="nc bnc" id="L25965" title="All 4 branches missed.">                    if (en.isDestroyed() || en.isDoomed()) {</span>
<span class="nc" id="L25966">                        toRemove.add(en);</span>
                    }
<span class="nc" id="L25968">                }</span>
<span class="nc" id="L25969">                units.removeAll(toRemove);</span>
<span class="nc bnc" id="L25970" title="All 4 branches missed.">                while ((destroyed &gt; 0) &amp;&amp; !units.isEmpty()) {</span>
<span class="nc" id="L25971">                    Entity target = units.remove(Compute.randomInt(units.size()));</span>
<span class="nc" id="L25972">                    reports.addAll(destroyEntity(target, &quot;cargo damage&quot;,</span>
                            false, true));
<span class="nc" id="L25974">                    destroyed--;</span>
<span class="nc" id="L25975">                }</span>
<span class="nc" id="L25976">            }</span>
        } else {
<span class="nc" id="L25978">            r = new Report(9167);</span>
<span class="nc" id="L25979">            r.subject = aero.getId();</span>
<span class="nc bnc" id="L25980" title="All 2 branches missed.">            r.choose(roll &lt; 4); // cargo or transport</span>
<span class="nc" id="L25981">            reports.add(r);</span>
        }
<span class="nc" id="L25983">    }</span>

    /**
     * Apply a single critical hit to a vehicle.
     *
     * @param tank             the &lt;code&gt;Tank&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to &lt;code&gt;Tank&lt;/code&gt;s and
     *                         for hits to a &lt;code&gt;Protomech&lt;/code&gt; torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;. The index of the slot should be the index
     *                         of the critical hit table.
     * @param damageCaused     the amount of damage causing this critical.
     */
    private Vector&lt;Report&gt; applyTankCritical(Tank tank, int loc, CriticalSlot cs, int damageCaused) {
<span class="nc" id="L25999">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
        HitData hit;
<span class="nc bnc" id="L26002" title="All 22 branches missed.">        switch (cs.getIndex()) {</span>
            case Tank.CRIT_NONE:
                // no effect
<span class="nc" id="L26005">                r = new Report(6005);</span>
<span class="nc" id="L26006">                r.subject = tank.getId();</span>
<span class="nc" id="L26007">                reports.add(r);</span>
<span class="nc" id="L26008">                break;</span>
            case Tank.CRIT_AMMO:
                // ammo explosion
<span class="nc" id="L26011">                r = new Report(6610);</span>
<span class="nc" id="L26012">                r.subject = tank.getId();</span>
<span class="nc" id="L26013">                reports.add(r);</span>
<span class="nc" id="L26014">                int damage = 0;</span>
<span class="nc bnc" id="L26015" title="All 2 branches missed.">                for (Mounted m : tank.getAmmo()) {</span>
                    // Don't include ammo of one-shot weapons.
<span class="nc bnc" id="L26017" title="All 2 branches missed.">                    if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L26018">                        continue;</span>
                    }
<span class="nc" id="L26020">                    m.setHit(true);</span>
<span class="nc" id="L26021">                    int tmp = m.getHittableShotsLeft()</span>
<span class="nc" id="L26022">                              * ((AmmoType) m.getType()).getDamagePerShot()</span>
<span class="nc" id="L26023">                              * ((AmmoType) m.getType()).getRackSize();</span>
<span class="nc" id="L26024">                    m.setShotsLeft(0);</span>
                    // non-explosive ammo can't explode
<span class="nc bnc" id="L26026" title="All 2 branches missed.">                    if (!m.getType().isExplosive(m)) {</span>
<span class="nc" id="L26027">                        continue;</span>
                    }
<span class="nc" id="L26029">                    damage += tmp;</span>
<span class="nc" id="L26030">                    r = new Report(6390);</span>
<span class="nc" id="L26031">                    r.subject = tank.getId();</span>
<span class="nc" id="L26032">                    r.add(m.getName());</span>
<span class="nc" id="L26033">                    r.add(tmp);</span>
<span class="nc" id="L26034">                    reports.add(r);</span>
<span class="nc" id="L26035">                }</span>
<span class="nc" id="L26036">                hit = new HitData(loc);</span>
<span class="nc" id="L26037">                reports.addAll(damageEntity(tank, hit, damage, true));</span>
<span class="nc" id="L26038">                break;</span>
            case Tank.CRIT_CARGO:
                // Cargo/infantry damage
<span class="nc" id="L26041">                r = new Report(6615);</span>
<span class="nc" id="L26042">                r.subject = tank.getId();</span>
<span class="nc" id="L26043">                reports.add(r);</span>
<span class="nc" id="L26044">                List&lt;Entity&gt; passengers = tank.getLoadedUnits();</span>
<span class="nc bnc" id="L26045" title="All 2 branches missed.">                if (passengers.size() &gt; 0) {</span>
<span class="nc" id="L26046">                    Entity target = passengers.get(Compute.randomInt(passengers.size()));</span>
<span class="nc" id="L26047">                    hit = target.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L26048">                    reports.addAll(damageEntity(target, hit, damageCaused));</span>
<span class="nc" id="L26049">                }</span>
                break;
            case Tank.CRIT_COMMANDER:
<span class="nc bnc" id="L26052" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26053" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26054">                    r = new Report(6191);</span>
<span class="nc" id="L26055">                    r.subject = tank.getId();</span>
<span class="nc" id="L26056">                    reports.add(r);</span>
<span class="nc" id="L26057">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26059" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26060" title="All 2 branches missed.">                        &amp;&amp; !tank.isCommanderHitPS()) {</span>
<span class="nc" id="L26061">                        r = new Report(6606);</span>
<span class="nc" id="L26062">                        r.subject = tank.getId();</span>
<span class="nc" id="L26063">                        reports.add(r);</span>
<span class="nc" id="L26064">                        tank.setCommanderHitPS(true);</span>
<span class="nc bnc" id="L26065" title="All 2 branches missed.">                    } else if (tank.hasWorkingMisc(MiscType.F_COMMAND_CONSOLE)</span>
<span class="nc bnc" id="L26066" title="All 2 branches missed.">                            &amp;&amp; !tank.isUsingConsoleCommander()) {</span>
<span class="nc" id="L26067">                        r = new Report(6607);</span>
<span class="nc" id="L26068">                        r.subject = tank.getId();</span>
<span class="nc" id="L26069">                        reports.add(r);</span>
<span class="nc" id="L26070">                        tank.setUsingConsoleCommander(true);</span>
                    } else {
<span class="nc" id="L26072">                        r = new Report(6605);</span>
<span class="nc" id="L26073">                        r.subject = tank.getId();</span>
<span class="nc" id="L26074">                        reports.add(r);</span>
<span class="nc" id="L26075">                        tank.setCommanderHit(true);</span>
                    }
                }
                // fall through here, because effects of crew stunned also
                // apply
            case Tank.CRIT_CREW_STUNNED:
<span class="nc bnc" id="L26081" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26082" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26083">                    r = new Report(6191);</span>
<span class="nc" id="L26084">                    r.subject = tank.getId();</span>
<span class="nc" id="L26085">                    reports.add(r);</span>
<span class="nc" id="L26086">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26088" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26089" title="All 2 branches missed.">                            || tank.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L26090">                        r = new Report(6186);</span>
                    } else {
<span class="nc" id="L26092">                        tank.stunCrew();</span>
<span class="nc" id="L26093">                        r = new Report(6185);</span>
<span class="nc" id="L26094">                        r.add(tank.getStunnedTurns() - 1);</span>
                    }
<span class="nc" id="L26096">                    r.subject = tank.getId();</span>
<span class="nc" id="L26097">                    reports.add(r);</span>
                }
<span class="nc" id="L26099">                break;</span>
            case Tank.CRIT_DRIVER:
<span class="nc bnc" id="L26101" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26102" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26103">                    r = new Report(6191);</span>
<span class="nc" id="L26104">                    r.subject = tank.getId();</span>
<span class="nc" id="L26105">                    reports.add(r);</span>
<span class="nc" id="L26106">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26108" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26109" title="All 2 branches missed.">                        &amp;&amp; !tank.isDriverHitPS()) {</span>
<span class="nc" id="L26110">                        r = new Report(6601);</span>
<span class="nc" id="L26111">                        r.subject = tank.getId();</span>
<span class="nc" id="L26112">                        reports.add(r);</span>
<span class="nc" id="L26113">                        tank.setDriverHitPS(true);</span>
                    } else {
<span class="nc" id="L26115">                        r = new Report(6600);</span>
<span class="nc" id="L26116">                        r.subject = tank.getId();</span>
<span class="nc" id="L26117">                        reports.add(r);</span>
<span class="nc" id="L26118">                        tank.setDriverHit(true);</span>
                    }
                }
<span class="nc" id="L26121">                break;</span>
            case Tank.CRIT_CREW_KILLED:
<span class="nc bnc" id="L26123" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26124" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26125">                    r = new Report(6191);</span>
<span class="nc" id="L26126">                    r.subject = tank.getId();</span>
<span class="nc" id="L26127">                    reports.add(r);</span>
<span class="nc" id="L26128">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26130" title="All 4 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT) &amp;&amp; !tank.isCrewHitPS()) {</span>
<span class="nc" id="L26131">                        r = new Report(6191);</span>
<span class="nc" id="L26132">                        r.subject = tank.getId();</span>
<span class="nc" id="L26133">                        reports.add(r);</span>
<span class="nc" id="L26134">                        tank.setCrewHitPS(true);</span>
                    } else {
<span class="nc" id="L26136">                        r = new Report(6190);</span>
<span class="nc" id="L26137">                        r.subject = tank.getId();</span>
<span class="nc" id="L26138">                        reports.add(r);</span>
<span class="nc" id="L26139">                        tank.getCrew().setDoomed(true);</span>
<span class="nc bnc" id="L26140" title="All 2 branches missed.">                        if (tank.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L26141">                            reports.addAll(crashVTOLorWiGE(tank));</span>
                        }
                    }
                }
                break;
            case Tank.CRIT_ENGINE:
<span class="nc" id="L26147">                r = new Report(6210);</span>
<span class="nc" id="L26148">                r.subject = tank.getId();</span>
<span class="nc" id="L26149">                reports.add(r);</span>
<span class="nc" id="L26150">                tank.engineHit();</span>
<span class="nc" id="L26151">                tank.engineHitsThisPhase++;</span>
<span class="nc" id="L26152">                boolean engineExploded = checkEngineExplosion(tank, reports, 1);</span>
<span class="nc bnc" id="L26153" title="All 2 branches missed.">                if (engineExploded) {</span>
<span class="nc" id="L26154">                    reports.addAll(destroyEntity(tank, &quot;engine destruction&quot;, true, true));</span>
<span class="nc" id="L26155">                    tank.setSelfDestructing(false);</span>
<span class="nc" id="L26156">                    tank.setSelfDestructInitiated(false);</span>
                }
<span class="nc bnc" id="L26158" title="All 2 branches missed.">                if (tank.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L26159" title="All 4 branches missed.">                    &amp;&amp; !(tank.isDestroyed() || tank.isDoomed())) {</span>
<span class="nc" id="L26160">                    tank.immobilize();</span>
<span class="nc" id="L26161">                    reports.addAll(forceLandVTOLorWiGE(tank));</span>
                }
                break;
            case Tank.CRIT_FUEL_TANK:
<span class="nc" id="L26165">                r = new Report(6215);</span>
<span class="nc" id="L26166">                r.subject = tank.getId();</span>
<span class="nc" id="L26167">                reports.add(r);</span>
<span class="nc" id="L26168">                reports.addAll(destroyEntity(tank, &quot;fuel explosion&quot;, false, false));</span>
<span class="nc" id="L26169">                break;</span>
            case Tank.CRIT_SENSOR:
<span class="nc" id="L26171">                r = new Report(6620);</span>
<span class="nc" id="L26172">                r.subject = tank.getId();</span>
<span class="nc" id="L26173">                reports.add(r);</span>
<span class="nc" id="L26174">                tank.setSensorHits(tank.getSensorHits() + 1);</span>
<span class="nc" id="L26175">                break;</span>
            case Tank.CRIT_STABILIZER:
<span class="nc" id="L26177">                r = new Report(6625);</span>
<span class="nc" id="L26178">                r.subject = tank.getId();</span>
<span class="nc" id="L26179">                reports.add(r);</span>
<span class="nc" id="L26180">                tank.setStabiliserHit(loc);</span>
<span class="nc" id="L26181">                break;</span>
            case Tank.CRIT_TURRET_DESTROYED:
<span class="nc" id="L26183">                r = new Report(6630);</span>
<span class="nc" id="L26184">                r.subject = tank.getId();</span>
<span class="nc" id="L26185">                reports.add(r);</span>
<span class="nc" id="L26186">                tank.destroyLocation(tank.getLocTurret());</span>
<span class="nc" id="L26187">                reports.addAll(destroyEntity(tank, &quot;turret blown off&quot;, true, true));</span>
<span class="nc" id="L26188">                break;</span>
            case Tank.CRIT_TURRET_JAM:
<span class="nc bnc" id="L26190" title="All 2 branches missed.">                if (tank.isTurretEverJammed(loc)) {</span>
<span class="nc" id="L26191">                    r = new Report(6640);</span>
<span class="nc" id="L26192">                    r.subject = tank.getId();</span>
<span class="nc" id="L26193">                    reports.add(r);</span>
<span class="nc" id="L26194">                    tank.lockTurret(loc);</span>
<span class="nc" id="L26195">                    break;</span>
                }
<span class="nc" id="L26197">                r = new Report(6635);</span>
<span class="nc" id="L26198">                r.subject = tank.getId();</span>
<span class="nc" id="L26199">                reports.add(r);</span>
<span class="nc" id="L26200">                tank.jamTurret(loc);</span>
<span class="nc" id="L26201">                break;</span>
            case Tank.CRIT_TURRET_LOCK:
<span class="nc" id="L26203">                r = new Report(6640);</span>
<span class="nc" id="L26204">                r.subject = tank.getId();</span>
<span class="nc" id="L26205">                reports.add(r);</span>
<span class="nc" id="L26206">                tank.lockTurret(loc);</span>
<span class="nc" id="L26207">                break;</span>
            case Tank.CRIT_WEAPON_DESTROYED: {
<span class="nc" id="L26209">                r = new Report(6305);</span>
<span class="nc" id="L26210">                r.subject = tank.getId();</span>
<span class="nc" id="L26211">                List&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L26212" title="All 2 branches missed.">                for (Mounted weapon : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L26213" title="All 6 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isHit() &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26214">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L26216">                }</span>
                // sort weapons by BV
<span class="nc" id="L26218">                weapons.sort(new WeaponComparatorBV());</span>
<span class="nc" id="L26219">                int roll = Compute.d6();</span>
                Mounted weapon;
<span class="nc bnc" id="L26221" title="All 2 branches missed.">                if (roll &lt; 4) {</span>
                    // defender should choose, we'll just use the lowest BV
                    // weapon
<span class="nc" id="L26224">                    weapon = weapons.get(weapons.size() - 1);</span>
                } else {
                    // attacker chooses, we'll use the highest BV weapon
<span class="nc" id="L26227">                    weapon = weapons.get(0);</span>
                }
<span class="nc" id="L26229">                r.add(weapon.getName());</span>
<span class="nc" id="L26230">                reports.add(r);</span>
                // explosive weapons e.g. gauss now explode
<span class="nc bnc" id="L26232" title="All 4 branches missed.">                if (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L26233" title="All 2 branches missed.">                       &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26234">                    reports.addAll(explodeEquipment(tank, loc, weapon));</span>
                }
<span class="nc" id="L26236">                weapon.setHit(true);</span>
                //Taharqa: We should also damage the critical slot, or
                //MM and MHQ won't remember that this weapon is damaged on the MUL
                //file
<span class="nc bnc" id="L26240" title="All 2 branches missed.">                for (int i = 0; i &lt; tank.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L26241">                    CriticalSlot slot1 = tank.getCritical(loc, i);</span>
<span class="nc bnc" id="L26242" title="All 4 branches missed.">                    if ((slot1 == null) || (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L26243">                        continue;</span>
                    }
<span class="nc" id="L26245">                    Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L26246" title="All 2 branches missed.">                    if (mounted.equals(weapon)) {</span>
<span class="nc" id="L26247">                        tank.hitAllCriticals(loc, i);</span>
<span class="nc" id="L26248">                        break;</span>
                    }
                }
<span class="nc" id="L26251">                break;</span>
            }
            case Tank.CRIT_WEAPON_JAM: {
<span class="nc" id="L26254">                r = new Report(6645);</span>
<span class="nc" id="L26255">                r.subject = tank.getId();</span>
<span class="nc" id="L26256">                ArrayList&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L26257" title="All 2 branches missed.">                for (Mounted weapon : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L26258" title="All 4 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isJammed()</span>
<span class="nc bnc" id="L26259" title="All 4 branches missed.">                        &amp;&amp; !weapon.jammedThisPhase() &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L26260" title="All 2 branches missed.">                        &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26261">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L26263">                }</span>
<span class="nc bnc" id="L26264" title="All 2 branches missed.">                if (weapons.size() &gt; 0) {</span>
<span class="nc" id="L26265">                    Mounted weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
<span class="nc" id="L26266">                    weapon.setJammed(true);</span>
<span class="nc" id="L26267">                    tank.addJammedWeapon(weapon);</span>
<span class="nc" id="L26268">                    r.add(weapon.getName());</span>
<span class="nc" id="L26269">                    reports.add(r);</span>
<span class="nc" id="L26270">                }</span>
                break;
            }
            case VTOL.CRIT_PILOT:
<span class="nc" id="L26274">                r = new Report(6650);</span>
<span class="nc" id="L26275">                r.subject = tank.getId();</span>
<span class="nc" id="L26276">                reports.add(r);</span>
<span class="nc" id="L26277">                tank.setDriverHit(true);</span>
<span class="nc" id="L26278">                PilotingRollData psr = tank.getBasePilotingRoll();</span>
<span class="nc" id="L26279">                psr.addModifier(0, &quot;pilot injury&quot;);</span>
<span class="nc bnc" id="L26280" title="All 2 branches missed.">                if (!doSkillCheckInPlace(tank, psr)) {</span>
<span class="nc" id="L26281">                    r = new Report(6675);</span>
<span class="nc" id="L26282">                    r.subject = tank.getId();</span>
<span class="nc" id="L26283">                    r.addDesc(tank);</span>
<span class="nc" id="L26284">                    reports.add(r);</span>
<span class="nc" id="L26285">                    boolean crash = true;</span>
<span class="nc bnc" id="L26286" title="All 2 branches missed.">                    if (tank.canGoDown()) {</span>
<span class="nc" id="L26287">                        tank.setElevation(tank.getElevation() - 1);</span>
<span class="nc bnc" id="L26288" title="All 2 branches missed.">                        crash = !tank.canGoDown();</span>
                    }
<span class="nc bnc" id="L26290" title="All 2 branches missed.">                    if (crash) {</span>
<span class="nc" id="L26291">                        reports.addAll(crashVTOLorWiGE(tank));</span>
                    }
<span class="nc" id="L26293">                }</span>
                break;
            case VTOL.CRIT_COPILOT:
<span class="nc" id="L26296">                r = new Report(6655);</span>
<span class="nc" id="L26297">                r.subject = tank.getId();</span>
<span class="nc" id="L26298">                reports.add(r);</span>
<span class="nc" id="L26299">                tank.setCommanderHit(true);</span>
<span class="nc" id="L26300">                break;</span>
            case VTOL.CRIT_ROTOR_DAMAGE: {
                // Only resolve rotor crits if the rotor was actually still
                // there.
<span class="nc bnc" id="L26304" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26305">                    r = new Report(6660);</span>
<span class="nc" id="L26306">                    r.subject = tank.getId();</span>
<span class="nc" id="L26307">                    reports.add(r);</span>
<span class="nc" id="L26308">                    tank.setMotiveDamage(tank.getMotiveDamage() + 1);</span>
<span class="nc bnc" id="L26309" title="All 2 branches missed.">                    if (tank.getMotiveDamage() &gt;= tank.getOriginalWalkMP()) {</span>
<span class="nc" id="L26310">                        tank.immobilize();</span>
<span class="nc bnc" id="L26311" title="All 2 branches missed.">                        if (tank.isAirborneVTOLorWIGE()</span>
                            // Don't bother with forcing a landing if
                            // we're already otherwise destroyed.
<span class="nc bnc" id="L26314" title="All 4 branches missed.">                            &amp;&amp; !(tank.isDestroyed() || tank.isDoomed())) {</span>
<span class="nc" id="L26315">                            reports.addAll(forceLandVTOLorWiGE(tank));</span>
                        }
                    }
                }
                break;
            }
            case VTOL.CRIT_ROTOR_DESTROYED:
                // Only resolve rotor crits if the rotor was actually still
                // there. Note that despite the name this critical hit does
                // not in itself physically destroy the rotor *location*
                // (which would simply kill the VTOL).
<span class="nc bnc" id="L26326" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26327">                    r = new Report(6670);</span>
<span class="nc" id="L26328">                    r.subject = tank.getId();</span>
<span class="nc" id="L26329">                    reports.add(r);</span>
<span class="nc" id="L26330">                    tank.immobilize();</span>
<span class="nc" id="L26331">                    reports.addAll(crashVTOLorWiGE(tank, true));</span>
                }
                break;
            case VTOL.CRIT_FLIGHT_STABILIZER:
                // Only resolve rotor crits if the rotor was actually still
                // there.
<span class="nc bnc" id="L26337" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26338">                    r = new Report(6665);</span>
<span class="nc" id="L26339">                    r.subject = tank.getId();</span>
<span class="nc" id="L26340">                    reports.add(r);</span>
<span class="nc" id="L26341">                    tank.setStabiliserHit(VTOL.LOC_ROTOR);</span>
                }
                break;
        }
<span class="nc" id="L26345">        return reports;</span>
    }

    /**
     * Rolls and resolves critical hits with a die roll modifier.
     */

    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear, int critMod, int damage) {
<span class="nc" id="L26353">        return criticalEntity(en, loc, isRear, critMod, true, false, damage);</span>
    }

    /**
     * Rolls and resolves critical hits with a die roll modifier.
     */

    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear, int critMod, int damage,
                                         boolean damagedByFire) {
<span class="nc" id="L26362">        return criticalEntity(en, loc, isRear, critMod, true, false, damage, damagedByFire);</span>
    }

    /**
     * Rolls one critical hit
     */
    public Vector&lt;Report&gt; oneCriticalEntity(Entity en, int loc, boolean isRear, int damage) {
<span class="nc" id="L26369">        return criticalEntity(en, loc, isRear, 0, false, false, damage);</span>
    }

    /**
     * Makes any roll required when an AirMech lands and resolve any damage or
     * skidding resulting from a failed roll. Updates final position and elevation.
     *
     * @param lam       the landing LAM
     * @param pos       the &lt;code&gt;Coords&lt;/code&gt; of the landing hex
     * @param elevation the elevation from which the landing is attempted (usually 1, but may be higher
     *                          if the unit is forced to land due to insufficient movement
     * @param distance  the distance the unit moved in the turn prior to landing
     */
    private Vector&lt;Report&gt; landAirMech(LandAirMech lam, Coords pos, int elevation, int distance) {
<span class="nc" id="L26383">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc" id="L26385">        lam.setPosition(pos);</span>
<span class="nc" id="L26386">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26387" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26388">            lam.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
        } else {
<span class="nc" id="L26390">            lam.setElevation(0);</span>
        }
<span class="nc" id="L26392">        PilotingRollData psr = lam.checkAirMechLanding();</span>
<span class="nc bnc" id="L26393" title="All 2 branches missed.">        if (psr.getValue() != TargetRoll.CHECK_FALSE</span>
<span class="nc bnc" id="L26394" title="All 2 branches missed.">                &amp;&amp; (0 &gt; doSkillCheckWhileMoving(lam, elevation, pos, pos, psr, false))) {</span>
<span class="nc" id="L26395">            crashAirMech(lam, pos, elevation, distance, psr, vDesc);</span>
        }
<span class="nc" id="L26397">        return vDesc;</span>
    }

    private boolean crashAirMech(Entity en, PilotingRollData psr, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26401">        return crashAirMech(en, en.getPosition(), en.getElevation(), en.delta_distance, psr, vDesc);</span>
    }

    private boolean crashAirMech(Entity en, Coords pos, int elevation, int distance,
                                 PilotingRollData psr, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26406">        MoveStep step = new MoveStep(null, MoveStepType.DOWN);</span>
<span class="nc" id="L26407">        step.setFromEntity(en, game);</span>
<span class="nc" id="L26408">        return crashAirMech(en, pos, elevation, distance, psr, step, vDesc);</span>
    }

    private boolean crashAirMech(Entity en, Coords pos, int elevation, int distance,
                                 PilotingRollData psr, MoveStep lastStep, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26413">        vDesc.addAll(doEntityFallsInto(en, elevation, pos, pos, psr, true, 0));</span>
<span class="nc bnc" id="L26414" title="All 2 branches missed.">        return en.isDoomed()</span>
<span class="nc bnc" id="L26415" title="All 2 branches missed.">                || processSkid(en, pos, 0, 0, distance, lastStep, en.moved, false);</span>
    }

    /**
     * Makes the landing roll required for a glider ProtoMech and resolves any damage
     * resulting from a failed roll. Updates final position and elevation.
     *
     * @param en    the landing glider ProtoMech
     */
    private Vector&lt;Report&gt; landGliderPM(Protomech en) {
<span class="nc" id="L26425">        return landGliderPM(en, en.getPosition(), en.getElevation(), en.delta_distance);</span>
    }

    /**
     * Makes the landing roll required for a glider ProtoMech and resolves any damage
     * resulting from a failed roll. Updates final position and elevation.
     *
     * @param en    the landing glider ProtoMech
     * @param pos   the &lt;code&gt;Coords&lt;/code&gt; of the landing hex
     * @param startElevation    the elevation from which the landing is attempted (usually 1, but may be higher
     *                          if the unit is forced to land due to insufficient movement
     * @param distance  the distance the unit moved in the turn prior to landing
     */
    private Vector&lt;Report&gt; landGliderPM(Protomech en, Coords pos, int startElevation,
                                        int distance) {
<span class="nc" id="L26440">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc" id="L26442">        en.setPosition(pos);</span>
<span class="nc" id="L26443">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26444" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26445">            en.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
        } else {
<span class="nc" id="L26447">            en.setElevation(0);</span>
        }
<span class="nc" id="L26449">        PilotingRollData psr = en.checkGliderLanding();</span>
<span class="nc bnc" id="L26450" title="All 2 branches missed.">        if ((psr.getValue() != TargetRoll.CHECK_FALSE)</span>
<span class="nc bnc" id="L26451" title="All 2 branches missed.">                &amp;&amp; (0 &gt; doSkillCheckWhileMoving(en, startElevation, pos, pos, psr, false))) {</span>
<span class="nc bnc" id="L26452" title="All 2 branches missed.">            for (int i = 0; i &lt; en.getNumberOfCriticals(Protomech.LOC_LEG); i++) {</span>
<span class="nc" id="L26453">                en.getCritical(Protomech.LOC_LEG, i).setHit(true);</span>
            }
<span class="nc" id="L26455">            HitData hit = new HitData(Protomech.LOC_LEG);</span>
<span class="nc" id="L26456">            vDesc.addAll(damageEntity(en, hit, 2 * startElevation));</span>
        }
<span class="nc" id="L26458">        return vDesc;</span>
    }

    /**
     * Resolves the forced landing of one airborne {@code VTOL} or {@code WiGE}
     * in its current hex. As this method is only for internal use and not part
     * of the exported public API, it simply relies on its client code to only
     * ever hand it a valid airborne vehicle and does not run any further checks
     * of its own.
     *
     * @param en The {@code VTOL} or {@code WiGE} in question.
     * @return The resulting {@code Vector} of {@code Report}s.
     */
    private Vector&lt;Report&gt; forceLandVTOLorWiGE(Tank en) {
<span class="nc" id="L26472">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L26473">        PilotingRollData psr = en.getBasePilotingRoll();</span>
<span class="nc" id="L26474">        IHex hex = game.getBoard().getHex(en.getPosition());</span>
<span class="nc bnc" id="L26475" title="All 2 branches missed.">        if (en instanceof VTOL) {</span>
<span class="nc" id="L26476">            psr.addModifier(4, &quot;VTOL making forced landing&quot;);</span>
        } else {
<span class="nc" id="L26478">            psr.addModifier(0, &quot;WiGE making forced landing&quot;);</span>
        }
<span class="nc" id="L26480">        int elevation = Math.max(hex.terrainLevel(Terrains.BLDG_ELEV),</span>
<span class="nc" id="L26481">                                 hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
<span class="nc" id="L26482">        elevation = Math.max(elevation, 0);</span>
<span class="nc" id="L26483">        elevation = Math.min(elevation, en.getElevation());</span>
<span class="nc bnc" id="L26484" title="All 2 branches missed.">        if (en.getElevation() &gt; elevation) {</span>
<span class="nc bnc" id="L26485" title="All 2 branches missed.">            if (!hex.containsTerrain(Terrains.FUEL_TANK)</span>
<span class="nc bnc" id="L26486" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L26487" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L26488" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L26489" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.RUBBLE)</span>
<span class="nc bnc" id="L26490" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L26491" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc" id="L26492">                Report r = new Report(2180);</span>
<span class="nc" id="L26493">                r.subject = en.getId();</span>
<span class="nc" id="L26494">                r.addDesc(en);</span>
<span class="nc" id="L26495">                r.add(psr.getLastPlainDesc(), true);</span>
<span class="nc" id="L26496">                vDesc.add(r);</span>

                // roll
<span class="nc" id="L26499">                final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L26500">                r = new Report(2185);</span>
<span class="nc" id="L26501">                r.subject = en.getId();</span>
<span class="nc" id="L26502">                r.add(psr.getValueAsString());</span>
<span class="nc" id="L26503">                r.add(psr.getDesc());</span>
<span class="nc" id="L26504">                r.add(diceRoll);</span>
<span class="nc bnc" id="L26505" title="All 2 branches missed.">                if (diceRoll &lt; psr.getValue()) {</span>
<span class="nc" id="L26506">                    r.choose(false);</span>
<span class="nc" id="L26507">                    vDesc.add(r);</span>
<span class="nc" id="L26508">                    vDesc.addAll(crashVTOLorWiGE(en, true));</span>
                } else {
<span class="nc" id="L26510">                    r.choose(true);</span>
<span class="nc" id="L26511">                    vDesc.add(r);</span>
<span class="nc" id="L26512">                    en.setElevation(elevation);</span>
                }
<span class="nc" id="L26514">            } else {</span>
<span class="nc" id="L26515">                vDesc.addAll(crashVTOLorWiGE(en, true));</span>
            }
        }
<span class="nc" id="L26518">        return vDesc;</span>
    }

    /**
     * Crash a VTOL
     *
     * @param en the &lt;code&gt;VTOL&lt;/code&gt; to be crashed
     * @return the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing phase reports
     */
    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en) {
<span class="nc" id="L26528">        return crashVTOLorWiGE(en, false, false, 0, en.getPosition(),</span>
<span class="nc" id="L26529">                               en.getElevation(), 0);</span>
    }

    /**
     * Crash a VTOL or WiGE.
     *
     * @param en              The {@code VTOL} or {@code WiGE} to crash.
     * @param rerollRotorHits Whether any rotor hits from the crash should be rerolled,
     *                        typically after a &quot;rotor destroyed&quot; critical hit.
     * @return The {@code Vector&lt;Report&gt;} of resulting reports.
     */
    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en, boolean rerollRotorHits) {
<span class="nc" id="L26541">        return crashVTOLorWiGE(en, rerollRotorHits, false, 0, en.getPosition(),</span>
<span class="nc" id="L26542">                               en.getElevation(), 0);</span>
    }

    /**
     * Crash a VTOL or WiGE.
     *
     * @param en              The {@code VTOL} or {@code WiGE} to crash.
     * @param rerollRotorHits Whether any rotor hits from the crash should be rerolled,
     *                        typically after a &quot;rotor destroyed&quot; critical hit.
     * @param sideSlipCrash   A &lt;code&gt;boolean&lt;/code&gt; value indicating whether this is a
     *                        sideslip crash or not.
     * @param hexesMoved      The &lt;code&gt;int&lt;/code&gt; number of hexes moved.
     * @param crashPos        The &lt;code&gt;Coords&lt;/code&gt; of the crash
     * @param crashElevation  The &lt;code&gt;int&lt;/code&gt; elevation of the VTOL
     * @param impactSide      The &lt;code&gt;int&lt;/code&gt; describing the side on which the VTOL
     *                        falls
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; of Reports.
     */

    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en, boolean rerollRotorHits,
                                           boolean sideSlipCrash, int hexesMoved, Coords crashPos,
                                           int crashElevation, int impactSide) {
<span class="nc" id="L26564">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // we might be off the board after a DFA, so return then
<span class="nc bnc" id="L26568" title="All 2 branches missed.">        if (!game.getBoard().contains(crashPos)) {</span>
<span class="nc" id="L26569">            return vDesc;</span>
        }

<span class="nc bnc" id="L26572" title="All 2 branches missed.">        if (!sideSlipCrash) {</span>
            // report lost movement and crashing
<span class="nc" id="L26574">            r = new Report(6260);</span>
<span class="nc" id="L26575">            r.subject = en.getId();</span>
<span class="nc" id="L26576">            r.newlines = 0;</span>
<span class="nc" id="L26577">            r.addDesc(en);</span>
<span class="nc" id="L26578">            vDesc.addElement(r);</span>
<span class="nc" id="L26579">            int newElevation = 0;</span>
<span class="nc" id="L26580">            IHex fallHex = game.getBoard().getHex(crashPos);</span>

            // May land on roof of building or bridge
<span class="nc bnc" id="L26583" title="All 2 branches missed.">            if (fallHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26584">                newElevation = fallHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc bnc" id="L26585" title="All 2 branches missed.">            } else if (fallHex.containsTerrain(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc" id="L26586">                newElevation = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc bnc" id="L26587" title="All 2 branches missed.">                if (newElevation &gt; crashElevation) {</span>
<span class="nc" id="L26588">                    newElevation = 0; // vtol was under bridge already</span>
                }
            }

<span class="nc" id="L26592">            int fall = crashElevation - newElevation;</span>
<span class="nc bnc" id="L26593" title="All 2 branches missed.">            if (fall == 0) {</span>
                // already on ground, no harm done
<span class="nc" id="L26595">                r = new Report(6265);</span>
<span class="nc" id="L26596">                r.subject = en.getId();</span>
<span class="nc" id="L26597">                vDesc.addElement(r);</span>
<span class="nc" id="L26598">                return vDesc;</span>
            }
            // set elevation 1st to avoid multiple crashes
<span class="nc" id="L26601">            en.setElevation(newElevation);</span>

            // plummets to ground
<span class="nc" id="L26604">            r = new Report(6270);</span>
<span class="nc" id="L26605">            r.subject = en.getId();</span>
<span class="nc" id="L26606">            r.add(fall);</span>
<span class="nc" id="L26607">            vDesc.addElement(r);</span>

            // facing after fall
            String side;
            int table;
<span class="nc" id="L26612">            int facing = Compute.d6() - 1;</span>
<span class="nc bnc" id="L26613" title="All 4 branches missed.">            switch (facing) {</span>
                case 1:
                case 2:
<span class="nc" id="L26616">                    side = &quot;right side&quot;;</span>
<span class="nc" id="L26617">                    table = ToHitData.SIDE_RIGHT;</span>
<span class="nc" id="L26618">                    break;</span>
                case 3:
<span class="nc" id="L26620">                    side = &quot;rear&quot;;</span>
<span class="nc" id="L26621">                    table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L26622">                    break;</span>
                case 4:
                case 5:
<span class="nc" id="L26625">                    side = &quot;left side&quot;;</span>
<span class="nc" id="L26626">                    table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L26627">                    break;</span>
                case 0:
                default:
<span class="nc" id="L26630">                    side = &quot;front&quot;;</span>
<span class="nc" id="L26631">                    table = ToHitData.SIDE_FRONT;</span>
            }

<span class="nc bnc" id="L26634" title="All 2 branches missed.">            if (newElevation &lt;= 0) {</span>
<span class="nc" id="L26635">                boolean waterFall = fallHex.containsTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L26636" title="All 4 branches missed.">                if (waterFall &amp;&amp; fallHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L26637">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L26638">                    r = new Report(2119);</span>
<span class="nc" id="L26639">                    r.subject = en.getId();</span>
<span class="nc" id="L26640">                    r.addDesc(en);</span>
<span class="nc" id="L26641">                    r.add(roll);</span>
<span class="nc" id="L26642">                    r.subject = en.getId();</span>
<span class="nc" id="L26643">                    vDesc.add(r);</span>
<span class="nc bnc" id="L26644" title="All 2 branches missed.">                    if (roll &gt; 3) {</span>
<span class="nc" id="L26645">                        vDesc.addAll(resolveIceBroken(crashPos));</span>
                    } else {
<span class="nc" id="L26647">                        waterFall = false; // saved by ice</span>
                    }
                }
<span class="nc bnc" id="L26650" title="All 2 branches missed.">                if (waterFall) {</span>
                    // falls into water and is destroyed
<span class="nc" id="L26652">                    r = new Report(6275);</span>
<span class="nc" id="L26653">                    r.subject = en.getId();</span>
<span class="nc" id="L26654">                    vDesc.addElement(r);</span>
<span class="nc" id="L26655">                    vDesc.addAll(destroyEntity(en, &quot;Fell into water&quot;, false, false));</span>
                    // not sure, is this salvageable?
                }
            }

            // calculate damage for hitting the surface
<span class="nc" id="L26661">            int damage = (int) Math.round(en.getWeight() / 10.0) * (fall + 1);</span>

            // adjust damage for gravity
<span class="nc" id="L26664">            damage = Math.round(damage * game.getPlanetaryConditions().getGravity());</span>
            // report falling
<span class="nc" id="L26666">            r = new Report(6280);</span>
<span class="nc" id="L26667">            r.subject = en.getId();</span>
<span class="nc" id="L26668">            r.indent();</span>
<span class="nc" id="L26669">            r.addDesc(en);</span>
<span class="nc" id="L26670">            r.add(side);</span>
<span class="nc" id="L26671">            r.add(damage);</span>
            //r.newlines = 0;
<span class="nc" id="L26673">            vDesc.addElement(r);</span>

<span class="nc" id="L26675">            en.setFacing((en.getFacing() + (facing)) % 6);</span>

<span class="nc" id="L26677">            boolean exploded = false;</span>

            // standard damage loop
<span class="nc bnc" id="L26680" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L26681">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L26682">                HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, table);</span>
<span class="nc bnc" id="L26683" title="All 6 branches missed.">                if ((en instanceof VTOL) &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR) &amp;&amp; rerollRotorHits) {</span>
<span class="nc" id="L26684">                    continue;</span>
                }
<span class="nc" id="L26686">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L26687">                int[] isBefore = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26688">                                  en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc" id="L26689">                vDesc.addAll(damageEntity(en, hit, cluster));</span>
<span class="nc" id="L26690">                int[] isAfter = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26691">                                 en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc bnc" id="L26692" title="All 2 branches missed.">                for (int x = 0; x &lt;= 3; x++) {</span>
<span class="nc bnc" id="L26693" title="All 2 branches missed.">                    if (isBefore[x] != isAfter[x]) {</span>
<span class="nc" id="L26694">                        exploded = true;</span>
<span class="nc" id="L26695">                        break;</span>
                    }
                }
<span class="nc" id="L26698">                damage -= cluster;</span>
<span class="nc" id="L26699">            }</span>
<span class="nc bnc" id="L26700" title="All 2 branches missed.">            if (exploded) {</span>
<span class="nc" id="L26701">                r = new Report(6285);</span>
<span class="nc" id="L26702">                r.subject = en.getId();</span>
<span class="nc" id="L26703">                r.addDesc(en);</span>
<span class="nc" id="L26704">                vDesc.addElement(r);</span>
<span class="nc" id="L26705">                vDesc.addAll(explodeVTOLorWiGE(en));</span>
            }

            // check for location exposure
<span class="nc" id="L26709">            vDesc.addAll(doSetLocationsExposure(en, fallHex, false, newElevation));</span>

<span class="nc" id="L26711">        } else {</span>
<span class="nc" id="L26712">            en.setElevation(0);// considered landed in the hex.</span>
            // crashes into ground thanks to sideslip
<span class="nc" id="L26714">            r = new Report(6290);</span>
<span class="nc" id="L26715">            r.subject = en.getId();</span>
<span class="nc" id="L26716">            r.addDesc(en);</span>
<span class="nc" id="L26717">            vDesc.addElement(r);</span>
<span class="nc" id="L26718">            int damage = (int) Math.round(en.getWeight() / 10.0) * (hexesMoved + 1);</span>
<span class="nc" id="L26719">            boolean exploded = false;</span>

            // standard damage loop
<span class="nc bnc" id="L26722" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L26723">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L26724">                HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, impactSide);</span>
<span class="nc" id="L26725">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L26726">                int[] isBefore = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26727">                                  en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc" id="L26728">                vDesc.addAll(damageEntity(en, hit, cluster));</span>
<span class="nc" id="L26729">                int[] isAfter = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26730">                                 en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc bnc" id="L26731" title="All 2 branches missed.">                for (int x = 0; x &lt;= 3; x++) {</span>
<span class="nc bnc" id="L26732" title="All 2 branches missed.">                    if (isBefore[x] != isAfter[x]) {</span>
<span class="nc" id="L26733">                        exploded = true;</span>
<span class="nc" id="L26734">                        break;</span>
                    }
                }
<span class="nc" id="L26737">                damage -= cluster;</span>
<span class="nc" id="L26738">            }</span>
<span class="nc bnc" id="L26739" title="All 2 branches missed.">            if (exploded) {</span>
<span class="nc" id="L26740">                r = new Report(6295);</span>
<span class="nc" id="L26741">                r.subject = en.getId();</span>
<span class="nc" id="L26742">                r.addDesc(en);</span>
<span class="nc" id="L26743">                vDesc.addElement(r);</span>
<span class="nc" id="L26744">                vDesc.addAll(explodeVTOLorWiGE(en));</span>
            }

        }

<span class="nc bnc" id="L26749" title="All 2 branches missed.">        if (game.containsMinefield(crashPos)) {</span>
            // may set off any minefields in the hex
<span class="nc" id="L26751">            enterMinefield(en, crashPos, 0, true, vDesc, 7);</span>
            // it may also clear any minefields that it detonated
<span class="nc" id="L26753">            clearDetonatedMines(crashPos, 5);</span>
<span class="nc" id="L26754">            resetMines();</span>
        }

<span class="nc" id="L26757">        return vDesc;</span>

    }

    /**
     * Explode a VTOL
     *
     * @param en The &lt;code&gt;VTOL&lt;/code&gt; to explode.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of reports
     */
    private Vector&lt;Report&gt; explodeVTOLorWiGE(Tank en) {
<span class="nc" id="L26768">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L26771" title="All 4 branches missed.">        if(en.hasEngine() &amp;&amp; en.getEngine().isFusion()) {</span>
            // fusion engine, no effect
<span class="nc" id="L26773">            r = new Report(6300);</span>
<span class="nc" id="L26774">            r.subject = en.getId();</span>
<span class="nc" id="L26775">            vDesc.addElement(r);</span>
        } else {
<span class="nc" id="L26777">            Coords pos = en.getPosition();</span>
<span class="nc" id="L26778">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26779" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L26780">                ignite(pos, Terrains.FIRE_LVL_NORMAL, vDesc);</span>
            } else {
<span class="nc" id="L26782">                ignite(pos, Terrains.FIRE_LVL_INFERNO, vDesc);</span>
            }
<span class="nc" id="L26784">            vDesc.addAll(destroyEntity(en, &quot;crashed and burned&quot;, false, false));</span>
        }

<span class="nc" id="L26787">        return vDesc;</span>
    }

    /**
     * rolls and resolves one tank critical hit
     *
     * @param t       the &lt;code&gt;Tank&lt;/code&gt; to be critted
     * @param loc     the &lt;code&gt;int&lt;/code&gt; location of the Tank to be critted
     * @param critMod the &lt;code&gt;int&lt;/code&gt; modifier to the crit roll
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    private Vector&lt;Report&gt; criticalTank(Tank t, int loc, int critMod, int damage, boolean damagedByFire) {
<span class="nc" id="L26799">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // roll the critical
<span class="nc" id="L26803">        r = new Report(6305);</span>
<span class="nc" id="L26804">        r.subject = t.getId();</span>
<span class="nc" id="L26805">        r.indent(3);</span>
<span class="nc" id="L26806">        r.add(t.getLocationAbbr(loc));</span>
<span class="nc" id="L26807">        r.newlines = 0;</span>
<span class="nc" id="L26808">        vDesc.add(r);</span>
<span class="nc" id="L26809">        int roll = Compute.d6(2);</span>
<span class="nc" id="L26810">        r = new Report(6310);</span>
<span class="nc" id="L26811">        r.subject = t.getId();</span>
<span class="nc" id="L26812">        String rollString = &quot;&quot;;</span>
<span class="nc bnc" id="L26813" title="All 2 branches missed.">        if (critMod != 0) {</span>
<span class="nc" id="L26814">            rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L26815" title="All 2 branches missed.">            if (critMod &gt; 0) {</span>
<span class="nc" id="L26816">                rollString += &quot;+&quot;;</span>
            }
<span class="nc" id="L26818">            rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L26819">            roll += critMod;</span>
        }
<span class="nc" id="L26821">        rollString += roll;</span>
<span class="nc" id="L26822">        r.add(rollString);</span>
<span class="nc" id="L26823">        r.newlines = 0;</span>
<span class="nc" id="L26824">        vDesc.add(r);</span>

        // now look up on vehicle crits table
<span class="nc" id="L26827">        int critType = t.getCriticalEffect(roll, loc, damagedByFire);</span>
<span class="nc bnc" id="L26828" title="All 2 branches missed.">        if ((critType == Tank.CRIT_NONE)</span>
<span class="nc bnc" id="L26829" title="All 6 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                &amp;&amp; !((t instanceof VTOL) || (t instanceof GunEmplacement))
<span class="nc bnc" id="L26831" title="All 2 branches missed.">                &amp;&amp; !t.getOverThresh()) {</span>
<span class="nc" id="L26832">            r = new Report(6006);</span>
<span class="nc" id="L26833">            r.subject = t.getId();</span>
<span class="nc" id="L26834">            r.newlines = 0;</span>
<span class="nc" id="L26835">            vDesc.add(r);</span>
        }
<span class="nc" id="L26837">        vDesc.addAll(applyCriticalHit(t, loc, new CriticalSlot(0, critType),</span>
                                      true, damage, false));
<span class="nc bnc" id="L26839" title="All 6 branches missed.">        if ((critType != Tank.CRIT_NONE) &amp;&amp; t.hasEngine() &amp;&amp; !t.getEngine().isFusion()</span>
<span class="nc bnc" id="L26840" title="All 4 branches missed.">                &amp;&amp; t.hasQuirk(OptionsConstants.QUIRK_NEG_FRAGILE_FUEL) &amp;&amp; (Compute.d6(2) &gt; 9)) {</span>
            // BOOM!!
<span class="nc" id="L26842">            vDesc.addAll(applyCriticalHit(t, loc, new CriticalSlot(0,</span>
                    Tank.CRIT_FUEL_TANK), true, damage, false));
        }
<span class="nc" id="L26845">        return vDesc;</span>
    }

    /**
     * Checks for aero criticals
     *
     * @param vDesc         - report vector
     * @param a             - the entity being critted
     * @param hit           - the hitdata for the attack
     * @param damage_orig   - the original damage of the attack
     * @param critThresh    - did the attack go over the damage threshold
     * @param critSI        - did the attack damage SI
     * @param ammoExplosion - was the damage from an ammo explosion
     * @param nukeS2S       - was this a ship 2 ship nuke attack
     */
    private void checkAeroCrits(Vector&lt;Report&gt; vDesc, Aero a, HitData hit,
                                int damage_orig, boolean critThresh, boolean critSI,
                                boolean ammoExplosion, boolean nukeS2S) {

        Report r;

<span class="nc" id="L26866">        boolean isCapital = hit.isCapital();</span>
        // get any capital missile critical mods
<span class="nc" id="L26868">        int capitalMissile = hit.getCapMisCritMod();</span>

        // check for nuclear critical
<span class="nc bnc" id="L26871" title="All 2 branches missed.">        if (nukeS2S) {</span>
            // add a control roll
<span class="nc" id="L26873">            PilotingRollData nukePSR = new PilotingRollData(a.getId(), 4,</span>
                    &quot;Nuclear attack&quot;, false);
<span class="nc" id="L26875">            game.addControlRoll(nukePSR);</span>

<span class="nc" id="L26877">            Report.addNewline(vDesc);</span>
            // need some kind of report
<span class="nc" id="L26879">            int nukeroll = Compute.d6(2);</span>
<span class="nc" id="L26880">            r = new Report(9145);</span>
<span class="nc" id="L26881">            r.subject = a.getId();</span>
<span class="nc" id="L26882">            r.indent(3);</span>
<span class="nc" id="L26883">            r.add(capitalMissile);</span>
<span class="nc" id="L26884">            r.add(nukeroll);</span>
<span class="nc" id="L26885">            vDesc.add(r);</span>
<span class="nc bnc" id="L26886" title="All 2 branches missed.">            if (nukeroll &gt;= capitalMissile) {</span>
                // Allow a reroll with edge
<span class="nc bnc" id="L26888" title="All 2 branches missed.">                if (a.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_NUKE_CRIT)</span>
<span class="nc bnc" id="L26889" title="All 2 branches missed.">                        &amp;&amp; a.getCrew().hasEdgeRemaining()) {</span>
<span class="nc" id="L26890">                    a.getCrew().decreaseEdge();</span>
<span class="nc" id="L26891">                    r = new Report(9148);</span>
<span class="nc" id="L26892">                    r.subject = a.getId();</span>
<span class="nc" id="L26893">                    r.indent(3);</span>
<span class="nc" id="L26894">                    r.add(a.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L26895">                    vDesc.add(r);</span>
                    // Reroll
<span class="nc" id="L26897">                    nukeroll = Compute.d6(2);</span>
                    // and report the new results
<span class="nc" id="L26899">                    r = new Report(9149);</span>
<span class="nc" id="L26900">                    r.subject = a.getId();</span>
<span class="nc" id="L26901">                    r.indent(3);</span>
<span class="nc" id="L26902">                    r.add(capitalMissile);</span>
<span class="nc" id="L26903">                    r.add(nukeroll);</span>
<span class="nc bnc" id="L26904" title="All 2 branches missed.">                    r.choose(nukeroll &gt;= capitalMissile);</span>
<span class="nc" id="L26905">                    vDesc.add(r);</span>
<span class="nc bnc" id="L26906" title="All 2 branches missed.">                    if (nukeroll &lt; capitalMissile) {</span>
                        // We might be vaporized by the damage itself, but no additional effect
<span class="nc" id="L26908">                        return;</span>
                    }
                }
<span class="nc" id="L26911">                a.setSI(a.getSI() - (damage_orig * 10));</span>
<span class="nc" id="L26912">                a.damageThisPhase += (damage_orig * 10);</span>
<span class="nc" id="L26913">                r = new Report(9146);</span>
<span class="nc" id="L26914">                r.subject = a.getId();</span>
<span class="nc" id="L26915">                r.add((damage_orig * 10));</span>
<span class="nc" id="L26916">                r.indent(4);</span>
<span class="nc" id="L26917">                r.add(Math.max(a.getSI(), 0));</span>
<span class="nc" id="L26918">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L26919" title="All 2 branches missed.">                if (a.getSI() &lt;= 0) {</span>
                    //No auto-ejection chance here. Nuke would vaporize the pilot.
<span class="nc" id="L26921">                    vDesc.addAll(destroyEntity(a, &quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L26922">                    a.setSI(0);</span>
<span class="nc bnc" id="L26923" title="All 2 branches missed.">                    if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L26924">                        creditKill(a, game.getEntity(hit.getAttackerId()));</span>
                    }
<span class="nc bnc" id="L26926" title="All 2 branches missed.">                } else if (!critSI) {</span>
<span class="nc" id="L26927">                    critSI = true;</span>
                }
            } else {
<span class="nc" id="L26930">                r = new Report(9147);</span>
<span class="nc" id="L26931">                r.subject = a.getId();</span>
<span class="nc" id="L26932">                r.indent(4);</span>
<span class="nc" id="L26933">                vDesc.addElement(r);</span>
            }
        }

        // apply crits
<span class="nc bnc" id="L26938" title="All 2 branches missed.">        if (hit.rolledBoxCars()) {</span>
<span class="nc bnc" id="L26939" title="All 2 branches missed.">            if (hit.isFirstHit()) {</span>
                // Allow edge use to ignore the critical roll
<span class="nc bnc" id="L26941" title="All 2 branches missed.">                if (a.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_LUCKY_CRIT)</span>
<span class="nc bnc" id="L26942" title="All 2 branches missed.">                        &amp;&amp; a.getCrew().hasEdgeRemaining()) {</span>
<span class="nc" id="L26943">                    a.getCrew().decreaseEdge();</span>
<span class="nc" id="L26944">                    r = new Report(9103);</span>
<span class="nc" id="L26945">                    r.subject = a.getId();</span>
<span class="nc" id="L26946">                    r.indent(3);</span>
<span class="nc" id="L26947">                    r.add(a.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L26948">                    vDesc.addElement(r);</span>
                    // Skip the critical roll
<span class="nc" id="L26950">                    return;</span>
                }
<span class="nc" id="L26952">                vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(), &quot;12 to hit&quot;,</span>
                        8, damage_orig, isCapital));
            } else { // Let the user know why the lucky crit doesn't apply
<span class="nc" id="L26955">                r = new Report(9102);</span>
<span class="nc" id="L26956">                r.subject = a.getId();</span>
<span class="nc" id="L26957">                r.indent(3);</span>
<span class="nc" id="L26958">                vDesc.addElement(r);</span>
            }
        }
        // ammo explosions shouldn't affect threshold because they
        // go right to SI
<span class="nc bnc" id="L26963" title="All 4 branches missed.">        if (critThresh &amp;&amp; !ammoExplosion) {</span>
<span class="nc" id="L26964">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;Damage threshold exceeded&quot;, 8, damage_orig, isCapital));
        }
<span class="nc bnc" id="L26967" title="All 4 branches missed.">        if (critSI &amp;&amp; !ammoExplosion) {</span>
<span class="nc" id="L26968">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;SI damaged&quot;, 8, damage_orig, isCapital));
        }
<span class="nc bnc" id="L26971" title="All 4 branches missed.">        if ((capitalMissile &gt; 0) &amp;&amp; !nukeS2S) {</span>
<span class="nc" id="L26972">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;Capital Missile&quot;, capitalMissile, damage_orig, isCapital));
        }
<span class="nc" id="L26975">    }</span>

    private Vector&lt;Report&gt; criticalAero(Aero a, int loc, int critMod,
            String reason, int target, int damage, boolean isCapital) {
<span class="nc" id="L26979">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        //Telemissiles don't take critical hits
<span class="nc bnc" id="L26983" title="All 2 branches missed.">        if (a instanceof TeleMissile) {</span>
<span class="nc" id="L26984">            return vDesc;</span>
        }

        // roll the critical
<span class="nc" id="L26988">        r = new Report(9100);</span>
<span class="nc" id="L26989">        r.subject = a.getId();</span>
<span class="nc" id="L26990">        r.add(reason);</span>
<span class="nc" id="L26991">        r.indent(3);</span>
<span class="nc" id="L26992">        r.newlines = 0;</span>
<span class="nc" id="L26993">        vDesc.add(r);</span>
<span class="nc" id="L26994">        int roll = Compute.d6(2);</span>
<span class="nc" id="L26995">        r = new Report(9101);</span>
<span class="nc" id="L26996">        r.subject = a.getId();</span>
<span class="nc" id="L26997">        r.add(target);</span>
<span class="nc" id="L26998">        String rollString = &quot;&quot;;</span>
<span class="nc bnc" id="L26999" title="All 2 branches missed.">        if (critMod != 0) {</span>
<span class="nc" id="L27000">            rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L27001" title="All 2 branches missed.">            if (critMod &gt; 0) {</span>
<span class="nc" id="L27002">                rollString += &quot;+&quot;;</span>
            }
<span class="nc" id="L27004">            rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L27005">            roll += critMod;</span>
        }
<span class="nc" id="L27007">        rollString += roll;</span>
<span class="nc" id="L27008">        r.add(rollString);</span>
<span class="nc" id="L27009">        r.newlines = 0;</span>
<span class="nc" id="L27010">        vDesc.add(r);</span>

        // now look up on vehicle crits table
<span class="nc" id="L27013">        int critType = a.getCriticalEffect(roll, target);</span>
<span class="nc" id="L27014">        vDesc.addAll(applyCriticalHit(a, loc, new CriticalSlot(0, critType),</span>
                true, damage, isCapital));
<span class="nc" id="L27016">        return vDesc;</span>
    }

    /**
     * Rolls and resolves critical hits on mechs or vehicles. if rollNumber is
     * false, a single hit is applied - needed for MaxTech Heat Scale rule.
     */
    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear,
            int critMod, boolean rollNumber, boolean isCapital, int damage) {
<span class="nc" id="L27025">        return criticalEntity(en, loc, isRear, critMod, rollNumber, isCapital,</span>
                damage, false);
    }

    /**
     * Rolls and resolves critical hits on mechs or vehicles. if rollNumber is
     * false, a single hit is applied - needed for MaxTech Heat Scale rule.
     */
    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear,
            int critMod, boolean rollNumber, boolean isCapital, int damage,
            boolean damagedByFire) {

<span class="nc bnc" id="L27037" title="All 2 branches missed.">        if (en.hasQuirk(&quot;poor_work&quot;)) {</span>
<span class="nc" id="L27038">            critMod += 1;</span>
        }
<span class="nc bnc" id="L27040" title="All 2 branches missed.">        if (en.hasQuirk(OptionsConstants.QUIRK_NEG_PROTOTYPE)) {</span>
<span class="nc" id="L27041">            critMod += 2;</span>
        }

        // Apply modifiers for Anti-penetrative ablation armor
<span class="nc bnc" id="L27045" title="All 2 branches missed.">        if ((en.getArmor(loc, isRear) &gt; 0)</span>
<span class="nc bnc" id="L27046" title="All 2 branches missed.">                &amp;&amp; (en.getArmorType(loc) == EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION)) {</span>
<span class="nc" id="L27047">            critMod -= 2;</span>
        }

<span class="nc bnc" id="L27050" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L27051">            return criticalTank((Tank) en, loc, critMod, damage, damagedByFire);</span>
        }

<span class="nc bnc" id="L27054" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L27055">            return criticalAero((Aero) en, loc, critMod, &quot;unknown&quot;, 8, damage,</span>
                    isCapital);
        }
        CriticalSlot slot;
<span class="nc" id="L27059">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L27061">        Coords coords = en.getPosition();</span>
<span class="nc" id="L27062">        IHex hex = null;</span>
        int hits;
<span class="nc bnc" id="L27064" title="All 2 branches missed.">        if (rollNumber) {</span>
<span class="nc bnc" id="L27065" title="All 2 branches missed.">            if (null != coords) {</span>
<span class="nc" id="L27066">                hex = game.getBoard().getHex(coords);</span>
            }
<span class="nc" id="L27068">            r = new Report(6305);</span>
<span class="nc" id="L27069">            r.subject = en.getId();</span>
<span class="nc" id="L27070">            r.indent(3);</span>
<span class="nc" id="L27071">            r.add(en.getLocationAbbr(loc));</span>
<span class="nc" id="L27072">            r.newlines = 0;</span>
<span class="nc" id="L27073">            vDesc.addElement(r);</span>
<span class="nc" id="L27074">            hits = 0;</span>
<span class="nc" id="L27075">            int roll = Compute.d6(2);</span>
<span class="nc" id="L27076">            r = new Report(6310);</span>
<span class="nc" id="L27077">            r.subject = en.getId();</span>
<span class="nc" id="L27078">            String rollString = &quot;&quot;;</span>
            // industrials get a +2 bonus on the roll
<span class="nc bnc" id="L27080" title="All 4 branches missed.">            if ((en instanceof Mech) &amp;&amp; ((Mech) en).isIndustrial()) {</span>
<span class="nc" id="L27081">                critMod += 2;</span>
            }
            // reinforced structure gets a -1 mod
<span class="nc bnc" id="L27084" title="All 4 branches missed.">            if ((en instanceof Mech) &amp;&amp; ((Mech) en).hasReinforcedStructure()) {</span>
<span class="nc" id="L27085">                critMod -= 1;</span>
            }
<span class="nc bnc" id="L27087" title="All 2 branches missed.">            if (critMod != 0) {</span>
<span class="nc" id="L27088">                rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L27089" title="All 2 branches missed.">                if (critMod &gt; 0) {</span>
<span class="nc" id="L27090">                    rollString += &quot;+&quot;;</span>
                }
<span class="nc" id="L27092">                rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L27093">                roll += critMod;</span>
            }
<span class="nc" id="L27095">            rollString += roll;</span>
<span class="nc" id="L27096">            r.add(rollString);</span>
<span class="nc" id="L27097">            r.newlines = 0;</span>
<span class="nc" id="L27098">            vDesc.addElement(r);</span>
<span class="nc" id="L27099">            boolean advancedCrit = game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVCOMBAT_TACOPS_CRIT_ROLL);
<span class="nc bnc" id="L27101" title="All 8 branches missed.">            if ((!advancedCrit &amp;&amp; (roll &lt;= 7)) || (advancedCrit &amp;&amp; (roll &lt;= 8))) {</span>
                // no effect
<span class="nc" id="L27103">                r = new Report(6005);</span>
<span class="nc" id="L27104">                r.subject = en.getId();</span>
<span class="nc" id="L27105">                vDesc.addElement(r);</span>
<span class="nc" id="L27106">                return vDesc;</span>
<span class="nc bnc" id="L27107" title="All 12 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 8) &amp;&amp; (roll &lt;= 9))</span>
                    || (advancedCrit &amp;&amp; (roll &gt;= 9) &amp;&amp; (roll &lt;= 10))) {
<span class="nc" id="L27109">                hits = 1;</span>
<span class="nc" id="L27110">                r = new Report(6315);</span>
<span class="nc" id="L27111">                r.subject = en.getId();</span>
<span class="nc" id="L27112">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27113" title="All 12 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 10) &amp;&amp; (roll &lt;= 11))</span>
                    || (advancedCrit &amp;&amp; (roll &gt;= 11) &amp;&amp; (roll &lt;= 12))) {
<span class="nc" id="L27115">                hits = 2;</span>
<span class="nc" id="L27116">                r = new Report(6320);</span>
<span class="nc" id="L27117">                r.subject = en.getId();</span>
<span class="nc" id="L27118">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27119" title="All 6 branches missed.">            } else if (advancedCrit &amp;&amp; (roll &gt;= 13) &amp;&amp; (roll &lt;= 14)) {</span>
<span class="nc" id="L27120">                hits = 3;</span>
<span class="nc" id="L27121">                r = new Report(6325);</span>
<span class="nc" id="L27122">                r.subject = en.getId();</span>
<span class="nc" id="L27123">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27124" title="All 8 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 12)) || (advancedCrit &amp;&amp; (roll &gt;= 15))) {</span>
<span class="nc bnc" id="L27125" title="All 2 branches missed.">                if (en instanceof Protomech) {</span>
<span class="nc" id="L27126">                    hits = 3;</span>
<span class="nc" id="L27127">                    r = new Report(6325);</span>
<span class="nc" id="L27128">                    r.subject = en.getId();</span>
<span class="nc" id="L27129">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L27130" title="All 2 branches missed.">                } else if (en.locationIsLeg(loc)) {</span>
<span class="nc" id="L27131">                    CriticalSlot cs = en.getCritical(loc, 0);</span>
<span class="nc bnc" id="L27132" title="All 4 branches missed.">                    if ((cs != null) &amp;&amp; cs.isArmored()) {</span>
<span class="nc" id="L27133">                        r = new Report(6700);</span>
<span class="nc" id="L27134">                        r.subject = en.getId();</span>
<span class="nc" id="L27135">                        r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27136">                        r.newlines = 0;</span>
<span class="nc" id="L27137">                        vDesc.addElement(r);</span>
<span class="nc" id="L27138">                        cs.setArmored(false);</span>
<span class="nc" id="L27139">                        return vDesc;</span>
                    }
                    // limb blown off
<span class="nc" id="L27142">                    r = new Report(6120);</span>
<span class="nc" id="L27143">                    r.subject = en.getId();</span>
<span class="nc" id="L27144">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27145">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L27146" title="All 2 branches missed.">                    if (en.getInternal(loc) &gt; 0) {</span>
<span class="nc" id="L27147">                        en.destroyLocation(loc, true);</span>
                    }
<span class="nc bnc" id="L27149" title="All 2 branches missed.">                    if (null != hex) {</span>
<span class="nc bnc" id="L27150" title="All 2 branches missed.">                        if (!hex.containsTerrain(Terrains.LEGS)) {</span>
<span class="nc" id="L27151">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27152">                                    .createTerrain(Terrains.LEGS, 1));</span>
                        } else {
<span class="nc" id="L27154">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27155">                                    .createTerrain(Terrains.LEGS,</span>
<span class="nc" id="L27156">                                            hex.terrainLevel(Terrains.LEGS) + 1));</span>
                        }
                    }
<span class="nc" id="L27159">                    sendChangedHex(en.getPosition());</span>
<span class="nc" id="L27160">                    return vDesc;</span>
<span class="nc bnc" id="L27161" title="All 4 branches missed.">                } else if ((loc == Mech.LOC_RARM) || (loc == Mech.LOC_LARM)) {</span>
<span class="nc" id="L27162">                    CriticalSlot cs = en.getCritical(loc, 0);</span>
<span class="nc bnc" id="L27163" title="All 4 branches missed.">                    if ((cs != null) &amp;&amp; cs.isArmored()) {</span>
<span class="nc" id="L27164">                        r = new Report(6700);</span>
<span class="nc" id="L27165">                        r.subject = en.getId();</span>
<span class="nc" id="L27166">                        r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27167">                        r.newlines = 0;</span>
<span class="nc" id="L27168">                        vDesc.addElement(r);</span>
<span class="nc" id="L27169">                        cs.setArmored(false);</span>
<span class="nc" id="L27170">                        return vDesc;</span>
                    }

                    // limb blown off
<span class="nc" id="L27174">                    r = new Report(6120);</span>
<span class="nc" id="L27175">                    r.subject = en.getId();</span>
<span class="nc" id="L27176">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27177">                    vDesc.addElement(r);</span>
<span class="nc" id="L27178">                    en.destroyLocation(loc, true);</span>
<span class="nc bnc" id="L27179" title="All 2 branches missed.">                    if (null != hex) {</span>
<span class="nc bnc" id="L27180" title="All 2 branches missed.">                        if (!hex.containsTerrain(Terrains.ARMS)) {</span>
<span class="nc" id="L27181">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27182">                                    .createTerrain(Terrains.ARMS, 1));</span>
                        } else {
<span class="nc" id="L27184">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27185">                                    .createTerrain(Terrains.ARMS,</span>
<span class="nc" id="L27186">                                            hex.terrainLevel(Terrains.ARMS) + 1));</span>
                        }
                    }
<span class="nc" id="L27189">                    sendChangedHex(en.getPosition());</span>
<span class="nc" id="L27190">                    return vDesc;</span>
<span class="nc bnc" id="L27191" title="All 2 branches missed.">                } else if (loc == Mech.LOC_HEAD) {</span>
                    // head blown off
<span class="nc" id="L27193">                    r = new Report(6330);</span>
<span class="nc" id="L27194">                    r.subject = en.getId();</span>
<span class="nc" id="L27195">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27196">                    vDesc.addElement(r);</span>
<span class="nc" id="L27197">                    en.destroyLocation(loc, true);</span>
<span class="nc bnc" id="L27198" title="All 2 branches missed.">                    if (((Mech) en).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED) {</span>
                        // Don't kill a pilot multiple times.
<span class="nc bnc" id="L27200" title="All 2 branches missed.">                        if (Crew.DEATH &gt; en.getCrew().getHits()) {</span>
<span class="nc" id="L27201">                            en.getCrew().setDoomed(true);</span>
<span class="nc" id="L27202">                            Report.addNewline(vDesc);</span>
<span class="nc" id="L27203">                            vDesc.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                        }
                    }
<span class="nc" id="L27206">                    return vDesc;</span>
                } else {
                    // torso hit
<span class="nc" id="L27209">                    hits = 3;</span>
                    // industrials get 4 crits on a modified result of 14
<span class="nc bnc" id="L27211" title="All 6 branches missed.">                    if ((roll &gt;= 14) &amp;&amp; (en instanceof Mech) &amp;&amp; ((Mech) en).isIndustrial()) {</span>
<span class="nc" id="L27212">                        hits = 4;</span>
                    }
<span class="nc" id="L27214">                    r = new Report(6325);</span>
<span class="nc" id="L27215">                    r.subject = en.getId();</span>
<span class="nc" id="L27216">                    vDesc.addElement(r);</span>
                }
            }
<span class="nc" id="L27219">        } else {</span>
<span class="nc" id="L27220">            hits = 1;</span>
        }

        // Check if there is the potential for a reactive armor crit
        // Because reactive armor isn't hittable, the transfer check doesn't
        // consider it
<span class="nc bnc" id="L27226" title="All 2 branches missed.">        boolean possibleReactiveCrit = (en.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27227" title="All 2 branches missed.">                &amp;&amp; (en.getArmorType(loc) == EquipmentType.T_ARMOR_REACTIVE);</span>
<span class="nc" id="L27228">        boolean locContainsReactiveArmor = false;</span>
<span class="nc bnc" id="L27229" title="All 4 branches missed.">        for (int i = 0; (i &lt; en.getNumberOfCriticals(loc)) &amp;&amp; possibleReactiveCrit; i++) {</span>
<span class="nc" id="L27230">            CriticalSlot crit = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L27231" title="All 4 branches missed.">            if ((crit != null) &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27232" title="All 2 branches missed.">                    &amp;&amp; (crit.getMount() != null)</span>
<span class="nc bnc" id="L27233" title="All 2 branches missed.">                    &amp;&amp; crit.getMount().getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L27234">                locContainsReactiveArmor = true;</span>
<span class="nc" id="L27235">                break;</span>
            }
        }
<span class="nc" id="L27238">        possibleReactiveCrit &amp;= locContainsReactiveArmor;</span>

        // transfer criticals, if needed
<span class="nc bnc" id="L27241" title="All 4 branches missed.">        while ((en.canTransferCriticals(loc) &amp;&amp; !possibleReactiveCrit)</span>
<span class="nc bnc" id="L27242" title="All 2 branches missed.">                &amp;&amp; (en.getTransferLocation(loc) != Entity.LOC_DESTROYED)</span>
<span class="nc bnc" id="L27243" title="All 2 branches missed.">                &amp;&amp; (en.getTransferLocation(loc) != Entity.LOC_NONE)) {</span>
<span class="nc" id="L27244">            loc = en.getTransferLocation(loc);</span>
<span class="nc" id="L27245">            r = new Report(6335);</span>
<span class="nc" id="L27246">            r.subject = en.getId();</span>
<span class="nc" id="L27247">            r.indent(3);</span>
<span class="nc" id="L27248">            r.add(en.getLocationAbbr(loc));</span>
<span class="nc" id="L27249">            vDesc.addElement(r);</span>
        }

        // Roll critical hits in this location.
<span class="nc bnc" id="L27253" title="All 2 branches missed.">        while (hits &gt; 0) {</span>

            // Have we hit all available slots in this location?
<span class="nc bnc" id="L27256" title="All 2 branches missed.">            if (en.getHittableCriticals(loc) &lt;= 0) {</span>
<span class="nc" id="L27257">                r = new Report(6340);</span>
<span class="nc" id="L27258">                r.subject = en.getId();</span>
<span class="nc" id="L27259">                r.indent(3);</span>
<span class="nc" id="L27260">                vDesc.addElement(r);</span>
<span class="nc" id="L27261">                break;</span>
            }

            // Randomly pick a slot to be hit.
<span class="nc" id="L27265">            int slotIndex = Compute.randomInt(en.getNumberOfCriticals(loc));</span>
<span class="nc" id="L27266">            slot = en.getCritical(loc, slotIndex);</span>

            // There are certain special cases, like reactive armor
            // some crits aren't normally hittable, except in certain cases
<span class="nc" id="L27270">            boolean reactiveArmorCrit = false;</span>
<span class="nc bnc" id="L27271" title="All 4 branches missed.">            if ((slot != null) &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27272" title="All 2 branches missed.">                    &amp;&amp; (slot.getMount() != null)) {</span>
<span class="nc" id="L27273">                Mounted eq = slot.getMount();</span>
<span class="nc bnc" id="L27274" title="All 4 branches missed.">                if (eq.getType().hasFlag(MiscType.F_REACTIVE) &amp;&amp; (en.getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L27275">                    reactiveArmorCrit = true;</span>
                }
            }

            // Ignore empty or unhitable slots (this
            // includes all previously hit slots).
<span class="nc bnc" id="L27281" title="All 6 branches missed.">            if ((slot != null) &amp;&amp; (slot.isHittable() || reactiveArmorCrit)) {</span>

<span class="nc bnc" id="L27283" title="All 2 branches missed.">                if (slot.isArmored()) {</span>
<span class="nc" id="L27284">                    r = new Report(6710);</span>
<span class="nc" id="L27285">                    r.subject = en.getId();</span>
<span class="nc bnc" id="L27286" title="All 2 branches missed.">                    if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
                        // Pretty sure that only 'mechs have system crits,
                        // but just in case....
<span class="nc bnc" id="L27289" title="All 2 branches missed.">                        if (en instanceof Mech) {</span>
<span class="nc" id="L27290">                            r.add(((Mech) en).getSystemName(slot.getIndex()));</span>
                        }
                    } else {
                        // Shouldn't be null, but we'll be careful...
<span class="nc bnc" id="L27294" title="All 2 branches missed.">                        if (slot.getMount() != null) {</span>
<span class="nc" id="L27295">                            r.add(slot.getMount().getName());</span>
                        }
                    }
<span class="nc" id="L27298">                    vDesc.addElement(r);</span>
<span class="nc" id="L27299">                    slot.setArmored(false);</span>
<span class="nc" id="L27300">                    hits--;</span>
<span class="nc" id="L27301">                    continue;</span>
                }
                // if explosive use edge
<span class="nc bnc" id="L27304" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L27305" title="All 2 branches missed.">                        &amp;&amp; (en.getCrew().hasEdgeRemaining() &amp;&amp; en.getCrew().getOptions()</span>
<span class="nc bnc" id="L27306" title="All 2 branches missed.">                                .booleanOption(OptionsConstants.EDGE_WHEN_EXPLOSION))</span>
<span class="nc bnc" id="L27307" title="All 2 branches missed.">                        &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27308" title="All 2 branches missed.">                        &amp;&amp; slot.getMount().getType().isExplosive(slot.getMount())) {</span>
<span class="nc" id="L27309">                    en.getCrew().decreaseEdge();</span>
<span class="nc" id="L27310">                    r = new Report(6530);</span>
<span class="nc" id="L27311">                    r.subject = en.getId();</span>
<span class="nc" id="L27312">                    r.indent(3);</span>
<span class="nc" id="L27313">                    r.add(en.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L27314">                    vDesc.addElement(r);</span>
<span class="nc" id="L27315">                    continue;</span>
                }

                // check for reactive armor exploding
<span class="nc bnc" id="L27319" title="All 2 branches missed.">                if (reactiveArmorCrit) {</span>
<span class="nc" id="L27320">                    Mounted mount = slot.getMount();</span>
<span class="nc bnc" id="L27321" title="All 4 branches missed.">                    if ((mount != null) &amp;&amp; mount.getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L27322">                        int roll = Compute.d6(2);</span>
<span class="nc" id="L27323">                        r = new Report(6082);</span>
<span class="nc" id="L27324">                        r.subject = en.getId();</span>
<span class="nc" id="L27325">                        r.indent(3);</span>
<span class="nc" id="L27326">                        r.add(roll);</span>
<span class="nc" id="L27327">                        vDesc.addElement(r);</span>
                        // big budda boom
<span class="nc bnc" id="L27329" title="All 2 branches missed.">                        if (roll == 2) {</span>
<span class="nc" id="L27330">                            r = new Report(6083);</span>
<span class="nc" id="L27331">                            r.subject = en.getId();</span>
<span class="nc" id="L27332">                            r.indent(4);</span>
<span class="nc" id="L27333">                            vDesc.addElement(r);</span>
<span class="nc" id="L27334">                            Vector&lt;Report&gt; newReports = new Vector&lt;&gt;(damageEntity(en,</span>
<span class="nc" id="L27335">                                    new HitData(loc), en.getArmor(loc)));</span>
<span class="nc bnc" id="L27336" title="All 2 branches missed.">                            if (en.hasRearArmor(loc)) {</span>
<span class="nc" id="L27337">                                newReports.addAll(damageEntity(en, new HitData(loc, true),</span>
<span class="nc" id="L27338">                                        en.getArmor(loc, true)));</span>
                            }
<span class="nc" id="L27340">                            newReports.addAll(damageEntity(en, new HitData(loc), 1));</span>
<span class="nc bnc" id="L27341" title="All 2 branches missed.">                            for (Report rep : newReports) {</span>
<span class="nc" id="L27342">                                rep.indent(4);</span>
<span class="nc" id="L27343">                            }</span>
<span class="nc" id="L27344">                            vDesc.addAll(newReports);</span>
<span class="nc" id="L27345">                        } else {</span>
                            // If only hittable crits are reactive,
                            // this crit is absorbed
<span class="nc" id="L27348">                            boolean allHittableCritsReactive = true;</span>
<span class="nc bnc" id="L27349" title="All 2 branches missed.">                            for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L27350">                                CriticalSlot crit = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L27351" title="All 2 branches missed.">                                if (crit.isHittable()) {</span>
<span class="nc" id="L27352">                                    allHittableCritsReactive = false;</span>
<span class="nc" id="L27353">                                    break;</span>
                                }
                                // We must have reactive crits to get to this
                                // point, so if nothing else is hittable, we
                                // must only have reactive crits
                            }
<span class="nc bnc" id="L27359" title="All 2 branches missed.">                            if (allHittableCritsReactive) {</span>
<span class="nc" id="L27360">                                hits--;</span>
                            }
                            continue;
                        }
                    }
                }
<span class="nc" id="L27366">                vDesc.addAll(applyCriticalHit(en, loc, slot, true, damage, isCapital));</span>
<span class="nc" id="L27367">                hits--;</span>
            }
<span class="nc" id="L27369">        } // Hit another slot in this location.</span>

<span class="nc" id="L27371">        return vDesc;</span>
    }

    /**
     * Checks for location breach and returns phase logging.
     * &lt;p/&gt;
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc    the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *               checked for a breach.
     * @param hex    the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *               value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *               an attack, and non-null if it occurs during movement.
     */
    private Vector&lt;Report&gt; breachCheck(Entity entity, int loc, IHex hex) {
<span class="nc" id="L27386">        return breachCheck(entity, loc, hex, false);</span>
    }

    /**
     * Checks for location breach and returns phase logging.
     * &lt;p/&gt;
     *
     * @param entity     the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc        the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *                   checked for a breach.
     * @param hex        the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *                   value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *                   an attack, and non-null if it occurs during movement.
     * @param underWater Is the breach check a result of an underwater attack?
     */
    private Vector&lt;Report&gt; breachCheck(Entity entity, int loc, IHex hex, boolean underWater) {
<span class="nc" id="L27402">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // Infantry do not suffer breaches, nor do Telemissiles
        // VTOLs can't operate in vacuum or underwater, so no breaches
<span class="nc bnc" id="L27407" title="All 6 branches missed.">        if (entity instanceof Infantry || entity instanceof TeleMissile || entity instanceof VTOL) {</span>
<span class="nc" id="L27408">            return vDesc;</span>
        }

<span class="nc" id="L27411">        boolean dumping = false;</span>
<span class="nc bnc" id="L27412" title="All 2 branches missed.">        for (Mounted m : entity.getAmmo()) {</span>
<span class="nc bnc" id="L27413" title="All 2 branches missed.">            if (m.isDumping()) {</span>
                // dumping ammo underwater is very stupid thing to do
<span class="nc" id="L27415">                dumping = true;</span>
<span class="nc" id="L27416">                break;</span>
            }
<span class="nc" id="L27418">        }</span>
        // This handles both water and vacuum breaches.
        // Also need to account for hull breaches on surface naval vessels which
        // are technically not &quot;wet&quot;
<span class="nc bnc" id="L27422" title="All 2 branches missed.">        if ((entity.getLocationStatus(loc) &gt; ILocationExposureStatus.NORMAL)</span>
<span class="nc bnc" id="L27423" title="All 4 branches missed.">                || (entity.isSurfaceNaval() &amp;&amp; (loc != ((Tank) entity).getLocTurret()))) {</span>
            // Does the location have armor (check rear armor on Mek)
            // and is the check due to damage?
<span class="nc" id="L27426">            int breachroll = 0;</span>
            // set the target roll for the breach
<span class="nc" id="L27428">            int target = 10;</span>
            // if this is a vacuum check and we are in trace atmosphere then
            // adjust target
<span class="nc bnc" id="L27431" title="All 2 branches missed.">            if ((entity.getLocationStatus(loc) == ILocationExposureStatus.VACUUM)</span>
<span class="nc bnc" id="L27432" title="All 2 branches missed.">                    &amp;&amp; (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_TRACE)) {</span>
<span class="nc" id="L27433">                target = 12;</span>
            }
            // if this is a surface naval vessel and the attack is not from
            // underwater
            // then the breach should only occur on a roll of 12
<span class="nc bnc" id="L27438" title="All 4 branches missed.">            if (entity.isSurfaceNaval() &amp;&amp; !underWater) {</span>
<span class="nc" id="L27439">                target = 12;</span>
            }
<span class="nc bnc" id="L27441" title="All 4 branches missed.">            if ((entity.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27442" title="All 4 branches missed.">                    &amp;&amp; (!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0) &amp;&amp; (null == hex)) {</span>
                // functional HarJel prevents breach
<span class="nc bnc" id="L27444" title="All 2 branches missed.">                if (entity.hasHarJelIn(loc)) {</span>
<span class="nc" id="L27445">                    r = new Report(6342);</span>
<span class="nc" id="L27446">                    r.subject = entity.getId();</span>
<span class="nc" id="L27447">                    r.indent(3);</span>
<span class="nc" id="L27448">                    vDesc.addElement(r);</span>
<span class="nc" id="L27449">                    return vDesc;</span>
                }
<span class="nc bnc" id="L27451" title="All 4 branches missed.">                if ((entity instanceof Mech) &amp;&amp; (((Mech) entity).hasHarJelIIIn(loc)</span>
<span class="nc bnc" id="L27452" title="All 2 branches missed.">                        || ((Mech) entity).hasHarJelIIIIn(loc))) {</span>
<span class="nc" id="L27453">                    r = new Report(6343);</span>
<span class="nc" id="L27454">                    r.subject = entity.getId();</span>
<span class="nc" id="L27455">                    r.indent(3);</span>
<span class="nc" id="L27456">                    vDesc.addElement(r);</span>
<span class="nc" id="L27457">                    target -= 2;</span>
                }
                // Impact-resistant armor easier to breach
<span class="nc bnc" id="L27460" title="All 2 branches missed.">                if ((entity.getArmorType(loc) == EquipmentType.T_ARMOR_IMPACT_RESISTANT)) {</span>
<span class="nc" id="L27461">                    r = new Report(6344);</span>
<span class="nc" id="L27462">                    r.subject = entity.getId();</span>
<span class="nc" id="L27463">                    r.indent(3);</span>
<span class="nc" id="L27464">                    vDesc.addElement(r);</span>
<span class="nc" id="L27465">                    target += 1;</span>
                }
<span class="nc" id="L27467">                breachroll = Compute.d6(2);</span>
<span class="nc" id="L27468">                r = new Report(6345);</span>
<span class="nc" id="L27469">                r.subject = entity.getId();</span>
<span class="nc" id="L27470">                r.indent(3);</span>
<span class="nc" id="L27471">                r.add(entity.getLocationAbbr(loc));</span>
<span class="nc" id="L27472">                r.add(breachroll);</span>
<span class="nc" id="L27473">                r.newlines = 0;</span>
<span class="nc bnc" id="L27474" title="All 2 branches missed.">                if (breachroll &gt;= target) {</span>
<span class="nc" id="L27475">                    r.choose(false);</span>
                } else {
<span class="nc" id="L27477">                    r.choose(true);</span>
                }
<span class="nc" id="L27479">                vDesc.addElement(r);</span>
            }
            // Breach by damage or lack of armor.
<span class="nc bnc" id="L27482" title="All 16 branches missed.">            if ((breachroll &gt;= target) || !(entity.getArmor(loc) &gt; 0)</span>
                    || (dumping &amp;&amp; (!(entity instanceof Mech)
                        || (loc == Mech.LOC_CT) || (loc == Mech.LOC_RT) || (loc == Mech.LOC_LT)))
<span class="nc bnc" id="L27485" title="All 2 branches missed.">                    || !(!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0)) {</span>
                // Functional HarJel prevents breach as long as armor remains
                // (and, presumably, as long as you don't open your chassis on
                // purpose, say to dump ammo...).
<span class="nc bnc" id="L27489" title="All 6 branches missed.">                if ((entity.hasHarJelIn(loc)) &amp;&amp; (entity.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27490" title="All 4 branches missed.">                    &amp;&amp; (!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0) &amp;&amp; !dumping) {</span>
<span class="nc" id="L27491">                    r = new Report(6342);</span>
<span class="nc" id="L27492">                    r.subject = entity.getId();</span>
<span class="nc" id="L27493">                    r.indent(3);</span>
<span class="nc" id="L27494">                    vDesc.addElement(r);</span>
<span class="nc" id="L27495">                    return vDesc;</span>
                }
<span class="nc" id="L27497">                vDesc.addAll(breachLocation(entity, loc, hex, false));</span>
            }
        }
<span class="nc" id="L27500">        return vDesc;</span>
    }

    /**
     * Marks all equipment in a location on an entity as useless.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc    the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *               checked for a breach.
     * @param hex    the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *               value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *               an attack, and non-null if it occurs during movement.
     * @param harJel a &lt;code&gt;boolean&lt;/code&gt; value indicating if the uselessness is
     *               the cause of a critically hit HarJel system
     */
    private Vector&lt;Report&gt; breachLocation(Entity entity, int loc, IHex hex, boolean harJel) {
<span class="nc" id="L27516">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L27519" title="All 2 branches missed.">        if ((entity.getInternal(loc) &lt; 0)</span>
<span class="nc bnc" id="L27520" title="All 2 branches missed.">                || (entity.getLocationStatus(loc) &lt; ILocationExposureStatus.NORMAL)) {</span>
            // already destroyed or breached? don't bother
<span class="nc" id="L27522">            return vDesc;</span>
        }

<span class="nc" id="L27525">        r = new Report(6350);</span>
<span class="nc bnc" id="L27526" title="All 2 branches missed.">        if (harJel) {</span>
<span class="nc" id="L27527">            r.messageId = 6351;</span>
        }
<span class="nc" id="L27529">        r.subject = entity.getId();</span>
<span class="nc" id="L27530">        r.add(entity.getShortName());</span>
<span class="nc" id="L27531">        r.add(entity.getLocationAbbr(loc));</span>
<span class="nc" id="L27532">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L27534" title="All 2 branches missed.">        if (entity instanceof Tank) {</span>
<span class="nc" id="L27535">            vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;, true, true));</span>
<span class="nc" id="L27536">            return vDesc;</span>
        }
<span class="nc bnc" id="L27538" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L27539">            Mech mech = (Mech) entity;</span>
            // equipment and crits will be marked in applyDamage?

            // equipment marked missing
<span class="nc bnc" id="L27543" title="All 2 branches missed.">            for (Mounted mounted : entity.getEquipment()) {</span>
<span class="nc bnc" id="L27544" title="All 2 branches missed.">                if (mounted.getLocation() == loc) {</span>
<span class="nc" id="L27545">                    mounted.setBreached(true);</span>
                }
<span class="nc" id="L27547">            }</span>
            // all critical slots set as useless
<span class="nc bnc" id="L27549" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L27550">                final CriticalSlot cs = entity.getCritical(loc, i);</span>
<span class="nc bnc" id="L27551" title="All 2 branches missed.">                if (cs != null) {</span>
                    // for every undamaged actuator destroyed by breaching,
                    // we make a PSR (see bug 1040858)
<span class="nc bnc" id="L27554" title="All 4 branches missed.">                    if (entity.locationIsLeg(loc) &amp;&amp; entity.canFall(true)) {</span>
<span class="nc bnc" id="L27555" title="All 2 branches missed.">                        if (cs.isHittable()) {</span>
<span class="nc bnc" id="L27556" title="All 3 branches missed.">                            switch (cs.getIndex()) {</span>
                                case Mech.ACTUATOR_UPPER_LEG:
                                case Mech.ACTUATOR_LOWER_LEG:
                                case Mech.ACTUATOR_FOOT:
                                    // leg/foot actuator piloting roll
<span class="nc" id="L27561">                                    game.addPSR(new PilotingRollData(entity.getId(), 1,</span>
                                            &quot;leg/foot actuator hit&quot;));
<span class="nc" id="L27563">                                    break;</span>
                                case Mech.ACTUATOR_HIP:
                                    // hip piloting roll at +0, because we get the +2 anyway
                                    // because the location is breached.
                                    // The phase report will look a bit weird, but the
                                    // roll is correct
<span class="nc" id="L27569">                                    game.addPSR(new PilotingRollData(entity.getId(), 0,</span>
                                            &quot;hip actuator hit&quot;));
                                    break;
                            }
                        }
                    }
<span class="nc" id="L27575">                    cs.setBreached(true);</span>
                }
            }

            // Check location for engine/cockpit breach and report accordingly
<span class="nc bnc" id="L27580" title="All 2 branches missed.">            if (loc == Mech.LOC_CT) {</span>
<span class="nc" id="L27581">                vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;));</span>
<span class="nc bnc" id="L27582" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L27583">                    vDesc.addAll(abandonEntity(entity));</span>
                }
            }
<span class="nc bnc" id="L27586" title="All 2 branches missed.">            if (loc == Mech.LOC_HEAD) {</span>
<span class="nc" id="L27587">                entity.getCrew().setDoomed(true);</span>
<span class="nc" id="L27588">                vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;));</span>
<span class="nc bnc" id="L27589" title="All 2 branches missed.">                if (entity.getLocationStatus(loc) == ILocationExposureStatus.WET) {</span>
<span class="nc" id="L27590">                    r = new Report(6355);</span>
                } else {
<span class="nc" id="L27592">                    r = new Report(6360);</span>
                }
<span class="nc" id="L27594">                r.subject = entity.getId();</span>
<span class="nc" id="L27595">                r.addDesc(entity);</span>
<span class="nc" id="L27596">                vDesc.addElement(r);</span>
            }

            // Set the status of the location.
            // N.B. if we set the status before rolling water PSRs, we get a
            // &quot;LEG DESTROYED&quot; modifier; setting the status after gives a hip
            // actuator modifier.
<span class="nc" id="L27603">            entity.setLocationStatus(loc, ILocationExposureStatus.BREACHED);</span>

            // Did the hull breach destroy the engine?
<span class="nc" id="L27606">            int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L27607" title="All 4 branches missed.">            if (mech.isSuperHeavy() &amp;&amp; mech.hasEngine()</span>
<span class="nc bnc" id="L27608" title="All 2 branches missed.">                    &amp;&amp; (mech.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L27609">                hitsToDestroy = 2;</span>
            }
<span class="nc" id="L27611">            if ((entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_LT)</span>
<span class="nc" id="L27612">                    + entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_CT)</span>
<span class="nc bnc" id="L27613" title="All 2 branches missed.">                    + entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_RT))</span>
                    &gt;= hitsToDestroy) {
<span class="nc" id="L27615">                vDesc.addAll(destroyEntity(entity, &quot;engine destruction&quot;));</span>
<span class="nc bnc" id="L27616" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L27617">                    vDesc.addAll(abandonEntity(entity));</span>
                }
            }

<span class="nc bnc" id="L27621" title="All 2 branches missed.">            if (loc == Mech.LOC_LT) {</span>
<span class="nc" id="L27622">                vDesc.addAll(breachLocation(entity, Mech.LOC_LARM, hex, false));</span>
            }
<span class="nc bnc" id="L27624" title="All 2 branches missed.">            if (loc == Mech.LOC_RT) {</span>
<span class="nc" id="L27625">                vDesc.addAll(breachLocation(entity, Mech.LOC_RARM, hex, false));</span>
            }
        }

<span class="nc" id="L27629">        return vDesc;</span>
    }

    /**
     * Mark the unit as destroyed! Units transported in the destroyed unit will
     * get a chance to escape.
     *
     * @param entity - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *               destroyed.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    private Vector&lt;Report&gt; destroyEntity(Entity entity, String reason) {
<span class="nc" id="L27643">        return destroyEntity(entity, reason, true);</span>
    }

    /**
     * Marks a unit as destroyed! Units transported inside the destroyed unit
     * will get a chance to escape unless the destruction was not survivable.
     *
     * @param entity     - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason     - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *                   destroyed.
     * @param survivable - a &lt;code&gt;boolean&lt;/code&gt; that identifies the destruction as
     *                   unsurvivable for transported units.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    public Vector&lt;Report&gt; destroyEntity(Entity entity, String reason, boolean survivable) {
        // Generally, the entity can still be salvaged.
<span class="nc" id="L27660">        return destroyEntity(entity, reason, survivable, true);</span>
    }

    /**
     * Marks a unit as destroyed! Units transported inside the destroyed unit
     * will get a chance to escape unless the destruction was not survivable.
     *
     * @param entity     - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason     - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *                   destroyed.
     * @param survivable - a &lt;code&gt;boolean&lt;/code&gt; that identifies the destruction as
     *                   unsurvivable for transported units.
     * @param canSalvage - a &lt;code&gt;boolean&lt;/code&gt; that indicates if the unit can be
     *                   salvaged (or cannibalized for spare parts). If
     *                   &lt;code&gt;true&lt;/code&gt;, salvage operations are possible, if
     *                   &lt;code&gt;false&lt;/code&gt;, the unit is too badly damaged.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    public Vector&lt;Report&gt; destroyEntity(Entity entity, String reason, boolean survivable,
                                         boolean canSalvage) {
        // can't destroy an entity if it's already been destroyed        
<span class="nc bnc" id="L27682" title="All 2 branches missed.">        if(entity.isDestroyed()) {</span>
<span class="nc" id="L27683">            return new Vector&lt;Report&gt;();</span>
        }
        
<span class="nc" id="L27686">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
        
        //We'll need this later...
<span class="nc" id="L27690">        Aero ship = null;</span>
<span class="nc bnc" id="L27691" title="All 2 branches missed.">        if (entity.isLargeCraft()) {</span>
<span class="nc" id="L27692">            ship = (Aero) entity;</span>
        }

        // regardless of what was passed in, units loaded onto aeros not on the
        // ground are destroyed
<span class="nc bnc" id="L27697" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>
<span class="nc" id="L27698">            survivable = false;</span>
<span class="nc bnc" id="L27699" title="All 2 branches missed.">        } else if (entity.isAero()) {</span>
<span class="nc" id="L27700">            survivable = true;</span>
        }

        // The unit can suffer an ammo explosion after it has been destroyed.
<span class="nc" id="L27704">        int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L27705" title="All 2 branches missed.">        if (!canSalvage) {</span>
<span class="nc" id="L27706">            entity.setSalvage(false);</span>
<span class="nc" id="L27707">            condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
        }

        // Destroy the entity, unless it's already destroyed.
<span class="nc bnc" id="L27711" title="All 4 branches missed.">        if (!entity.isDoomed() &amp;&amp; !entity.isDestroyed()) {</span>
<span class="nc" id="L27712">            r = new Report(6365);</span>
<span class="nc" id="L27713">            r.subject = entity.getId();</span>
<span class="nc" id="L27714">            r.addDesc(entity);</span>
<span class="nc" id="L27715">            r.add(reason);</span>
<span class="nc" id="L27716">            vDesc.addElement(r);</span>

<span class="nc" id="L27718">            entity.setDoomed(true);</span>

            // Kill any picked up MechWarriors
<span class="nc" id="L27721">            Enumeration&lt;Integer&gt; iter = entity.getPickedUpMechWarriors().elements();</span>
<span class="nc bnc" id="L27722" title="All 2 branches missed.">            while (iter.hasMoreElements()) {</span>
<span class="nc" id="L27723">                int mechWarriorId = iter.nextElement();</span>
<span class="nc" id="L27724">                Entity mw = game.getEntity(mechWarriorId);</span>

                // in some situations, a &quot;picked up&quot; mechwarrior won't actually exist
                // probably this is brought about by picking up a mechwarrior in a previous MekHQ scenario
                // then having the same unit get blown up in a subsequent scenario
                // in that case, we simply move on
<span class="nc bnc" id="L27730" title="All 2 branches missed.">                if(mw == null) {</span>
<span class="nc" id="L27731">                    continue;</span>
                }

<span class="nc" id="L27734">                mw.setDestroyed(true);</span>
                // We can safely remove these, as they can't be targeted
<span class="nc" id="L27736">                game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L27737">                entityUpdate(mw.getId());</span>
<span class="nc" id="L27738">                send(createRemoveEntityPacket(mw.getId(), condition));</span>
<span class="nc" id="L27739">                r = new Report(6370);</span>
<span class="nc" id="L27740">                r.subject = mw.getId();</span>
<span class="nc" id="L27741">                r.addDesc(mw);</span>
<span class="nc" id="L27742">                vDesc.addElement(r);</span>
<span class="nc" id="L27743">            }</span>

            // make any remaining telemissiles operated by this entity
            // out of contact
<span class="nc bnc" id="L27747" title="All 2 branches missed.">            for (int missileId : entity.getTMTracker().getMissiles()) {</span>
<span class="nc" id="L27748">                Entity tm = game.getEntity(missileId);</span>
<span class="nc bnc" id="L27749" title="All 6 branches missed.">                if ((null != tm) &amp;&amp; !tm.isDestroyed() &amp;&amp; (tm instanceof TeleMissile)) {</span>
<span class="nc" id="L27750">                    ((TeleMissile) tm).setOutContact(true);</span>
<span class="nc" id="L27751">                    entityUpdate(tm.getId());</span>
                }
<span class="nc" id="L27753">            }</span>

            // Mechanized BA that could die on a 3+
<span class="nc" id="L27756">            ArrayList&lt;Entity&gt; externalUnits = entity.getExternalUnits();</span>

            // Handle escape of transported units.
<span class="nc bnc" id="L27759" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L27760">                Coords curPos = entity.getPosition();</span>
<span class="nc" id="L27761">                int curFacing = entity.getFacing();</span>
<span class="nc bnc" id="L27762" title="All 2 branches missed.">                for (Entity other : entity.getLoadedUnits()) {</span>
                    //If the unit has been destroyed (as from a cargo hit), skip it
<span class="nc bnc" id="L27764" title="All 2 branches missed.">                    if (other.isDestroyed()) {</span>
<span class="nc" id="L27765">                        continue;</span>
                    }
                    // Can the other unit survive?
<span class="nc" id="L27768">                    boolean survived = false;</span>
<span class="nc bnc" id="L27769" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L27770" title="All 2 branches missed.">                        if ((entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L27771" title="All 2 branches missed.">                                || (entity.getMovementMode() == EntityMovementMode.HYDROFOIL)) {</span>
<span class="nc bnc" id="L27772" title="All 2 branches missed.">                            if (other.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L27773" title="All 2 branches missed.">                                survived = Compute.d6() &lt;= 3;</span>
<span class="nc bnc" id="L27774" title="All 2 branches missed.">                            } else if (other.getMovementMode() == EntityMovementMode.INF_JUMP) {</span>
<span class="nc bnc" id="L27775" title="All 2 branches missed.">                                survived = Compute.d6() == 1;</span>
<span class="nc bnc" id="L27776" title="All 2 branches missed.">                            } else if (other.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L27777" title="All 2 branches missed.">                                survived = Compute.d6() &lt;= 2;</span>
                            }
<span class="nc bnc" id="L27779" title="All 2 branches missed.">                        } else if (entity.getMovementMode() == EntityMovementMode.SUBMARINE) {</span>
<span class="nc bnc" id="L27780" title="All 2 branches missed.">                            if (other.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L27781" title="All 2 branches missed.">                                survived = Compute.d6() == 1;</span>
                            }
                        } else {
<span class="nc bnc" id="L27784" title="All 2 branches missed.">                            survived = Compute.d6() &lt;= 4;</span>
                        }
<span class="nc bnc" id="L27786" title="All 2 branches missed.">                    } else if (entity instanceof Mech) {</span>
                        // mechanized BA can escape on a roll of 1 or 2
<span class="nc bnc" id="L27788" title="All 2 branches missed.">                        if (externalUnits.contains(other)) {</span>
<span class="nc bnc" id="L27789" title="All 2 branches missed.">                            survived = Compute.d6() &lt; 3;</span>
                        }
                    }
<span class="nc bnc" id="L27792" title="All 8 branches missed.">                    if (!survivable || (externalUnits.contains(other) &amp;&amp; !survived)</span>
                            //Don't unload from ejecting spacecraft. The crews aren't in their units...
<span class="nc bnc" id="L27794" title="All 2 branches missed.">                            || (ship != null &amp;&amp; ship.isEjecting())) {</span>
                        // Nope.
<span class="nc" id="L27796">                        other.setDestroyed(true);</span>
                        // We need to unload the unit, since it's ID goes away
<span class="nc" id="L27798">                        entity.unload(other);</span>
                        // Safe to remove, as they aren't targeted
<span class="nc" id="L27800">                        game.moveToGraveyard(other.getId());</span>
<span class="nc" id="L27801">                        send(createRemoveEntityPacket(other.getId(), condition));</span>
<span class="nc" id="L27802">                        r = new Report(6370);</span>
<span class="nc" id="L27803">                        r.subject = other.getId();</span>
<span class="nc" id="L27804">                        r.addDesc(other);</span>
<span class="nc" id="L27805">                        vDesc.addElement(r);</span>
                    }
                    // Can we unload the unit to the current hex?
                    // TODO : unloading into stacking violation is not
                    // explicitly prohibited in the BMRr.
<span class="nc bnc" id="L27810" title="All 2 branches missed.">                    else if ((null != Compute.stackingViolation(game, other.getId(), curPos))</span>
<span class="nc bnc" id="L27811" title="All 2 branches missed.">                             || other.isLocationProhibited(curPos)) {</span>
                        // Nope.
<span class="nc" id="L27813">                        other.setDestroyed(true);</span>
                        // We need to unload the unit, since it's ID goes away
<span class="nc" id="L27815">                        entity.unload(other);</span>
                        // Safe to remove, as they aren't targeted
<span class="nc" id="L27817">                        game.moveToGraveyard(other.getId());</span>
<span class="nc" id="L27818">                        send(createRemoveEntityPacket(other.getId(), condition));</span>
<span class="nc" id="L27819">                        r = new Report(6375);</span>
<span class="nc" id="L27820">                        r.subject = other.getId();</span>
<span class="nc" id="L27821">                        r.addDesc(other);</span>
<span class="nc" id="L27822">                        vDesc.addElement(r);</span>
                    } // End can-not-unload
                    else {
                        // The other unit survives.
<span class="nc" id="L27826">                        unloadUnit(entity, other, curPos, curFacing,</span>
<span class="nc" id="L27827">                                   entity.getElevation(), true, false);</span>
                    }

<span class="nc" id="L27830">                } // Handle the next transported unit.</span>

            } // End has-transported-unit

            // Handle transporting unit.
<span class="nc bnc" id="L27835" title="All 2 branches missed.">            if (Entity.NONE != entity.getTransportId()) {</span>
<span class="nc" id="L27836">                final Entity transport = game.getEntity(entity.getTransportId());</span>
<span class="nc" id="L27837">                Coords curPos = transport.getPosition();</span>
<span class="nc" id="L27838">                int curFacing = transport.getFacing();</span>
<span class="nc bnc" id="L27839" title="All 2 branches missed.">                if (!transport.isLargeCraft()) {</span>
<span class="nc" id="L27840">                    unloadUnit(transport, entity, curPos, curFacing, transport.getElevation());</span>
                }
<span class="nc" id="L27842">                entityUpdate(transport.getId());</span>

                // if this is the last fighter in a fighter squadron then remove
                // the squadron
<span class="nc bnc" id="L27846" title="All 2 branches missed.">                if ((transport instanceof FighterSquadron)</span>
<span class="nc bnc" id="L27847" title="All 2 branches missed.">                        &amp;&amp; transport.getSubEntities().orElse(Collections.emptyList()).isEmpty()) {</span>
<span class="nc" id="L27848">                    transport.setDestroyed(true);</span>
                    // Can't remove this here, otherwise later attacks will fail
                    //game.moveToGraveyard(transport.getId());
                    //entityUpdate(transport.getId());
                    //send(createRemoveEntityPacket(transport.getId(), condition));
<span class="nc" id="L27853">                    r = new Report(6365);</span>
<span class="nc" id="L27854">                    r.subject = transport.getId();</span>
<span class="nc" id="L27855">                    r.addDesc(transport);</span>
<span class="nc" id="L27856">                    r.add(&quot;fighter destruction&quot;);</span>
<span class="nc" id="L27857">                    vDesc.addElement(r);</span>
                }

            } // End unit-is-transported

            // Is this unit towing some trailers?
            // If so, disconnect them
<span class="nc bnc" id="L27864" title="All 2 branches missed.">            if (!entity.getAllTowedUnits().isEmpty()) {</span>
                //Find the first trailer in the list and drop it
                //this will disconnect all that follow too
<span class="nc" id="L27867">                Entity leadTrailer = game.getEntity(entity.getAllTowedUnits().get(0));</span>
<span class="nc" id="L27868">                disconnectUnit(entity, leadTrailer, entity.getPosition());</span>
            }

            // Is this unit a trailer being towed? If so, disconnect it from its tractor
<span class="nc bnc" id="L27872" title="All 2 branches missed.">            if (entity.getTractor() != Entity.NONE) {</span>
<span class="nc" id="L27873">                Entity tractor = game.getEntity(entity.getTractor());</span>
<span class="nc" id="L27874">                disconnectUnit(tractor, entity, tractor.getPosition());</span>
            }

            // Is this unit being swarmed?
<span class="nc" id="L27878">            final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L27879" title="All 2 branches missed.">            if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L27880">                final Entity swarmer = game.getEntity(swarmerId);</span>

<span class="nc" id="L27882">                swarmer.setSwarmTargetId(Entity.NONE);</span>
                // a unit that stopped swarming due to the swarmed unit dieing
                // should be able to move: setSwarmTargetId to Entity.None
                // changes done to true and unloaded to true, need to undo this
<span class="nc" id="L27886">                swarmer.setUnloaded(false);</span>
<span class="nc" id="L27887">                swarmer.setDone(false);</span>
<span class="nc" id="L27888">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L27889">                Report.addNewline(vDesc);</span>
<span class="nc" id="L27890">                r = new Report(6380);</span>
<span class="nc" id="L27891">                r.subject = swarmerId;</span>
<span class="nc" id="L27892">                r.addDesc(swarmer);</span>
<span class="nc" id="L27893">                vDesc.addElement(r);</span>
                // Swarming infantry shouldn't take damage when their target dies
                // http://bg.battletech.com/forums/total-warfare/swarming-question
<span class="nc" id="L27896">                entityUpdate(swarmerId);</span>
            }

            // Is this unit swarming somebody?
<span class="nc" id="L27900">            final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L27901" title="All 2 branches missed.">            if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L27902">                final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L27903">                swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L27904">                entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L27905">                r = new Report(6385);</span>
<span class="nc" id="L27906">                r.subject = swarmed.getId();</span>
<span class="nc" id="L27907">                r.addDesc(swarmed);</span>
<span class="nc" id="L27908">                vDesc.addElement(r);</span>
<span class="nc" id="L27909">                entityUpdate(swarmedId);</span>
            }

            // If in a grapple, release both mechs
<span class="nc bnc" id="L27913" title="All 2 branches missed.">            if (entity.getGrappled() != Entity.NONE) {</span>
<span class="nc" id="L27914">                int grappler = entity.getGrappled();</span>
<span class="nc" id="L27915">                entity.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L27916">                Entity e = game.getEntity(grappler);</span>
<span class="nc bnc" id="L27917" title="All 2 branches missed.">                if (e != null) {</span>
<span class="nc" id="L27918">                    e.setGrappled(Entity.NONE, false);</span>
                }
<span class="nc" id="L27920">                entityUpdate(grappler);</span>
            }
        } // End entity-not-already-destroyed.

        // if using battlefield wreckage rules, then the destruction of this
        // unit
        // might convert the hex to rough
<span class="nc" id="L27927">        Coords curPos = entity.getPosition();</span>
<span class="nc" id="L27928">        IHex entityHex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L27929" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_BATTLE_WRECK)</span>
<span class="nc bnc" id="L27930" title="All 6 branches missed.">                &amp;&amp; (entityHex != null) &amp;&amp; game.getBoard().onGround()</span>
                &amp;&amp; !((entity instanceof Infantry) || (entity instanceof Protomech))) {
            // large support vees will create ultra rough, otherwise rough
<span class="nc bnc" id="L27933" title="All 2 branches missed.">            if (entity instanceof LargeSupportTank) {</span>
<span class="nc bnc" id="L27934" title="All 2 branches missed.">                if (entityHex.terrainLevel(Terrains.ROUGH) &lt; 2) {</span>
<span class="nc" id="L27935">                    entityHex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27936">                            .createTerrain(Terrains.ROUGH, 2));</span>
<span class="nc" id="L27937">                    sendChangedHex(curPos);</span>
                }
<span class="nc bnc" id="L27939" title="All 4 branches missed.">            } else if ((entity.getWeight() &gt;= 40) &amp;&amp; !entityHex.containsTerrain(Terrains.ROUGH)) {</span>
<span class="nc" id="L27940">                entityHex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27941">                        .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L27942">                sendChangedHex(curPos);</span>
            }
        }

        // update our entity, so clients have correct data needed for MekWars stuff
<span class="nc" id="L27947">        entityUpdate(entity.getId());</span>

<span class="nc" id="L27949">        return vDesc;</span>
    }

    /**
     * Makes a piece of equipment on a mech explode! POW! This expects either
     * ammo, or an explosive weapon. Returns a vector of Report objects.
     */
    private Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, int slot) {
<span class="nc" id="L27957">        CriticalSlot critSlot = en.getCritical(loc, slot);</span>
<span class="nc" id="L27958">        Vector&lt;Report&gt; reports = explodeEquipment(en, loc, critSlot.getMount());</span>
<span class="nc bnc" id="L27959" title="All 2 branches missed.">        if (critSlot.getMount2() != null) {</span>
<span class="nc" id="L27960">            reports.addAll(explodeEquipment(en, loc, critSlot.getMount2()));</span>
        }
<span class="nc" id="L27962">        return reports;</span>
    }

    /**
     * Explodes a piece of equipment on the unit.
     */
    public Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, Mounted mounted) { 
<span class="nc" id="L27969">        return explodeEquipment(en, loc, mounted, false);</span>
    }
    
    /**
     * Makes a piece of equipment on a mech explode! POW! This expects either
     * ammo, or an explosive weapon. Returns a vector of Report objects.
     * Possible to override 'is explosive' check
     */
    public Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, Mounted mounted, boolean overrideExplosiveCheck) {
<span class="nc" id="L27978">        final String METHOD_NAME = &quot;explodeEquipment(Entity,int,Mounted)&quot;;</span>
<span class="nc" id="L27979">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        // is this already destroyed?
<span class="nc bnc" id="L27981" title="All 2 branches missed.">        if (mounted.isDestroyed()) {</span>
<span class="nc" id="L27982">            MegaMek.getLogger().error(&quot;Called on destroyed equipment(&quot; + mounted.getName() + &quot;)&quot;);</span>
<span class="nc" id="L27983">            return vDesc;</span>
        }

        // Special case: LAM bomb bays explode the bomb stored there, which may involve going through a
        // launch weapon to the bomb ammo.
<span class="nc bnc" id="L27988" title="All 4 branches missed.">        if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc bnc" id="L27989" title="All 2 branches missed.">            while (mounted.getLinked() != null) {</span>
<span class="nc" id="L27990">                mounted = mounted.getLinked();</span>
            }
            // Fuel tank explodes on 2d6 roll of 10+
<span class="nc bnc" id="L27993" title="All 4 branches missed.">            if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_FUEL)) {</span>
<span class="nc" id="L27994">                Report r = new Report(9120);</span>
<span class="nc" id="L27995">                r.subject = en.getId();</span>
<span class="nc" id="L27996">                int boomTarget = 10;</span>
                // check for possible explosion
<span class="nc" id="L27998">                int fuelRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L27999" title="All 2 branches missed.">                r.choose(fuelRoll &gt;= boomTarget);</span>
<span class="nc bnc" id="L28000" title="All 2 branches missed.">                if (fuelRoll &gt;= boomTarget) {</span>
<span class="nc" id="L28001">                    r.choose(true);</span>
<span class="nc" id="L28002">                    vDesc.add(r);</span>
                } else {
<span class="nc" id="L28004">                    r.choose(false);</span>
<span class="nc" id="L28005">                    vDesc.add(r);</span>
<span class="nc" id="L28006">                    return vDesc;</span>
                }
            }
        }

<span class="nc bnc" id="L28011" title="All 4 branches missed.">        if(!overrideExplosiveCheck &amp;&amp; !mounted.getType().isExplosive(mounted, false)) {</span>
<span class="nc" id="L28012">            return vDesc;</span>
        }

        // Inferno ammo causes heat buildup as well as the damage
<span class="nc bnc" id="L28016" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28017" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L28018" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L28019" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_IATM)</span>
<span class="nc bnc" id="L28020" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L28021" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L28022" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28023">            en.heatBuildup += Math.min(mounted.getExplosionDamage(), 30);</span>
        }

        // Inferno bombs in LAM bomb bays
<span class="nc bnc" id="L28027" title="All 2 branches missed.">        if ((mounted.getType() instanceof BombType)</span>
<span class="nc bnc" id="L28028" title="All 2 branches missed.">                &amp;&amp; (((BombType)mounted.getType()).getBombType() == BombType.B_INFERNO)) {</span>
<span class="nc" id="L28029">            en.heatBuildup += Math.min(mounted.getExplosionDamage(), 30);</span>
        }

        // determine and deal damage
<span class="nc" id="L28033">        int damage = mounted.getExplosionDamage();</span>

        // Smoke ammo halves damage
<span class="nc bnc" id="L28036" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28037" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L28038" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L28039" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L28040" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_LRM_IMP))</span>
<span class="nc bnc" id="L28041" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_SMOKE_WARHEAD)</span>
<span class="nc bnc" id="L28042" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28043">            damage = ((mounted.getExplosionDamage()) / 2);</span>
        }
        // coolant explodes for 2 damage and reduces heat by 3
<span class="nc bnc" id="L28046" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28047" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L28048" title="All 2 branches missed.">                || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_HEAVY_FLAMER))</span>
<span class="nc bnc" id="L28049" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_COOLANT)</span>
<span class="nc bnc" id="L28050" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28051">            damage = 2;</span>
<span class="nc" id="L28052">            en.coolFromExternal += 3;</span>
        }

        // divide damage by 10 for aeros, per TW rules on pg. 161
<span class="nc bnc" id="L28056" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L28057">            int newDamage = (int) Math.floor(damage / 10.0);</span>
<span class="nc bnc" id="L28058" title="All 4 branches missed.">            if ((newDamage == 0) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L28059">                damage = 1;</span>
            } else {
<span class="nc" id="L28061">                damage = newDamage;</span>
            }
        }

<span class="nc bnc" id="L28065" title="All 2 branches missed.">        if (damage &lt;= 0) {</span>
<span class="nc" id="L28066">            return vDesc;</span>
        }

<span class="nc" id="L28069">        Report r = new Report(6390);</span>
<span class="nc" id="L28070">        r.subject = en.getId();</span>
<span class="nc" id="L28071">        r.add(mounted.getName());</span>
<span class="nc" id="L28072">        r.add(damage);</span>
<span class="nc" id="L28073">        r.indent(3);</span>
<span class="nc" id="L28074">        vDesc.addElement(r);</span>
        // Mounted is a weapon and has Hot-Loaded ammo in it and it exploded now
        // we need to roll for chain reaction
<span class="nc bnc" id="L28077" title="All 4 branches missed.">        if ((mounted.getType() instanceof WeaponType) &amp;&amp; mounted.isHotLoaded()) {</span>
<span class="nc" id="L28078">            int roll = Compute.d6(2);</span>
<span class="nc" id="L28079">            int ammoExploded = 0;</span>
<span class="nc" id="L28080">            r = new Report(6077);</span>
<span class="nc" id="L28081">            r.subject = en.getId();</span>
<span class="nc" id="L28082">            r.add(roll);</span>
<span class="nc" id="L28083">            r.indent(2);</span>
<span class="nc" id="L28084">            vDesc.addElement(r);</span>

            // roll of 2-5 means a chain reaction happened
<span class="nc bnc" id="L28087" title="All 2 branches missed.">            if (roll &lt; 6) {</span>
<span class="nc bnc" id="L28088" title="All 2 branches missed.">                for (Mounted ammo : en.getAmmo()) {</span>
<span class="nc bnc" id="L28089" title="All 4 branches missed.">                    if ((ammo.getLocation() == loc) &amp;&amp; (ammo.getExplosionDamage() &gt; 0)</span>
                            // Dead-Fire ammo bins are designed not to explode
                            // from the chain reaction
                            // Of Critted Launchers with DFM or HotLoaded ammo.
<span class="nc bnc" id="L28093" title="All 2 branches missed.">                            &amp;&amp; (((AmmoType) ammo.getType()).getMunitionType() != AmmoType.M_DEAD_FIRE)) {</span>
<span class="nc" id="L28094">                        ammoExploded++;</span>
<span class="nc" id="L28095">                        vDesc.addAll(this.explodeEquipment(en, loc, ammo));</span>
<span class="nc" id="L28096">                        break;</span>
                    }
<span class="nc" id="L28098">                }</span>
<span class="nc bnc" id="L28099" title="All 2 branches missed.">                if (ammoExploded == 0) {</span>
<span class="nc" id="L28100">                    r = new Report(6078);</span>
<span class="nc" id="L28101">                    r.subject = en.getId();</span>
<span class="nc" id="L28102">                    r.indent(2);</span>
<span class="nc" id="L28103">                    vDesc.addElement(r);</span>
                }
            } else {
<span class="nc" id="L28106">                r = new Report(6079);</span>
<span class="nc" id="L28107">                r.subject = en.getId();</span>
<span class="nc" id="L28108">                r.indent(2);</span>
<span class="nc" id="L28109">                vDesc.addElement(r);</span>
            }
        }

<span class="nc" id="L28113">        HitData hit = new HitData(loc);</span>
        // check to determine whether this is capital scale if we have a capital
        // scale entity
<span class="nc bnc" id="L28116" title="All 2 branches missed.">        if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc bnc" id="L28117" title="All 2 branches missed.">            if (((AmmoType) mounted.getType()).isCapital()) {</span>
<span class="nc" id="L28118">                hit.setCapital(true);</span>
            }
        }

        // exploding RISC laser pulse module should cause no normal crits, just
        // automatically crit the first uncritted crit of the laser it's
        // attached to
<span class="nc bnc" id="L28125" title="All 4 branches missed.">        if ((mounted.getType() instanceof MiscType)  &amp;&amp; mounted.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L28126">            hit.setEffect(HitData.EFFECT_NO_CRITICALS);</span>
<span class="nc" id="L28127">            Mounted laser = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L28128" title="All 2 branches missed.">            if (en instanceof Mech) {</span>
<span class="nc bnc" id="L28129" title="All 2 branches missed.">                for (int slot = 0; slot &lt; en.getNumberOfCriticals(laser.getLocation()); slot++) {</span>
<span class="nc" id="L28130">                    CriticalSlot cs = en.getCritical(laser.getLocation(), slot);</span>
<span class="nc bnc" id="L28131" title="All 4 branches missed.">                    if ((cs.getType() == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; cs.getMount().equals(laser)</span>
<span class="nc bnc" id="L28132" title="All 2 branches missed.">                            &amp;&amp; cs.isHittable()) {</span>
<span class="nc" id="L28133">                        cs.setHit(true);</span>
<span class="nc" id="L28134">                        cs.setRepairable(true);</span>
<span class="nc" id="L28135">                        break;</span>
                    }
                }
            }
<span class="nc" id="L28139">            laser.setHit(true);</span>
        }

<span class="nc" id="L28142">        mounted.setShotsLeft(0);</span>

<span class="nc" id="L28144">        int pilotDamage = 2;</span>
<span class="nc bnc" id="L28145" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L28146">            pilotDamage = 1;</span>
        }
<span class="nc bnc" id="L28148" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_CASE_PILOT_DAMAGE)</span>
<span class="nc bnc" id="L28149" title="All 4 branches missed.">                &amp;&amp; (en.locationHasCase(hit.getLocation()) || en.hasCASEII(hit.getLocation()))) {</span>
<span class="nc" id="L28150">            pilotDamage = 1;</span>
        }
<span class="nc bnc" id="L28152" title="All 2 branches missed.">        if (en.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)</span>
<span class="nc bnc" id="L28153" title="All 2 branches missed.">                || en.hasAbility(OptionsConstants.MISC_IRON_MAN)) {</span>
<span class="nc" id="L28154">            pilotDamage -= 1;</span>
        }
        // tanks only take pilot damage when using BVDNI or VDNI
<span class="nc bnc" id="L28157" title="All 4 branches missed.">        if ((en instanceof Tank) &amp;&amp; !(en.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L28158" title="All 2 branches missed.">                || en.hasAbility(OptionsConstants.MD_BVDNI))) {</span>
<span class="nc" id="L28159">            pilotDamage = 0;</span>
        }
<span class="nc bnc" id="L28161" title="All 2 branches missed.">        if (!en.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L28162">            vDesc.addAll(damageCrew(en, pilotDamage, en.getCrew().getCurrentPilotIndex()));</span>
        }
<span class="nc bnc" id="L28164" title="All 4 branches missed.">        if (en.getCrew().isDoomed() || en.getCrew().isDead()) {</span>
<span class="nc" id="L28165">            vDesc.addAll(destroyEntity(en, &quot;crew death&quot;, true));</span>
        } else {
<span class="nc" id="L28167">            Report.addNewline(vDesc);</span>
        }

<span class="nc" id="L28170">        Vector&lt;Report&gt; newReports = damageEntity(en, hit, damage, true);</span>
<span class="nc bnc" id="L28171" title="All 2 branches missed.">        for (Report rep : newReports) {</span>
<span class="nc" id="L28172">            rep.indent(2);</span>
<span class="nc" id="L28173">        }</span>
<span class="nc" id="L28174">        vDesc.addAll(newReports);</span>
<span class="nc" id="L28175">        Report.addNewline(vDesc);</span>

<span class="nc" id="L28177">        return vDesc;</span>
    }

    /**
     * Makes one slot of ammo, determined by certain rules, explode on a mech.
     */
    Vector&lt;Report&gt; explodeAmmoFromHeat(Entity entity) {
<span class="nc" id="L28184">        int damage = 0;</span>
<span class="nc" id="L28185">        int rack = 0;</span>
<span class="nc" id="L28186">        int boomloc = -1;</span>
<span class="nc" id="L28187">        int boomslot = -1;</span>
<span class="nc" id="L28188">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L28190" title="All 2 branches missed.">        for (int j = 0; j &lt; entity.locations(); j++) {</span>
<span class="nc bnc" id="L28191" title="All 2 branches missed.">            for (int k = 0; k &lt; entity.getNumberOfCriticals(j); k++) {</span>
<span class="nc" id="L28192">                CriticalSlot cs = entity.getCritical(j, k);</span>
<span class="nc bnc" id="L28193" title="All 6 branches missed.">                if ((cs == null) || cs.isDestroyed() || cs.isHit()</span>
<span class="nc bnc" id="L28194" title="All 2 branches missed.">                        || (cs.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L28195">                    continue;</span>
                }
<span class="nc" id="L28197">                Mounted mounted = cs.getMount();</span>
<span class="nc bnc" id="L28198" title="All 4 branches missed.">                if ((mounted == null) || (!(mounted.getType() instanceof AmmoType))) {</span>
<span class="nc" id="L28199">                    continue;</span>
                }
<span class="nc" id="L28201">                AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L28202" title="All 2 branches missed.">                if (!atype.isExplosive(mounted)) {</span>
<span class="nc" id="L28203">                    continue;</span>
                }
                // coolant pods and flamer coolant ammo don't explode from heat
<span class="nc bnc" id="L28206" title="All 2 branches missed.">                if ((atype.getAmmoType() == AmmoType.T_COOLANT_POD)</span>
<span class="nc bnc" id="L28207" title="All 2 branches missed.">                        || (((atype.getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L28208" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_HEAVY_FLAMER))</span>
<span class="nc bnc" id="L28209" title="All 2 branches missed.">                                &amp;&amp; (atype.getMunitionType() == AmmoType.M_COOLANT))) {</span>
<span class="nc" id="L28210">                    continue;</span>
                }
                // ignore empty, destroyed, or missing bins
<span class="nc bnc" id="L28213" title="All 2 branches missed.">                if (mounted.getHittableShotsLeft() == 0) {</span>
<span class="nc" id="L28214">                    continue;</span>
                }
                // TW page 160, compare one rack's
                // damage. Ties go to most rounds.
<span class="nc" id="L28218">                int newRack = atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L28219">                int newDamage = mounted.getExplosionDamage();</span>
<span class="nc" id="L28220">                Mounted mount2 = cs.getMount2();</span>
<span class="nc bnc" id="L28221" title="All 4 branches missed.">                if ((mount2 != null) &amp;&amp; (mount2.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28222" title="All 2 branches missed.">                        &amp;&amp; (mount2.getHittableShotsLeft() &gt; 0)) {</span>
                    // must be for same weaponType, so rackSize stays
<span class="nc" id="L28224">                    atype = (AmmoType) mount2.getType();</span>
<span class="nc" id="L28225">                    newRack += atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L28226">                    newDamage += mount2.getExplosionDamage();</span>
                }
<span class="nc bnc" id="L28228" title="All 8 branches missed.">                if (!mounted.isHit()</span>
                        &amp;&amp; ((rack &lt; newRack) || ((rack == newRack) &amp;&amp; (damage &lt; newDamage)))) {
<span class="nc" id="L28230">                    rack = newRack;</span>
<span class="nc" id="L28231">                    damage = newDamage;</span>
<span class="nc" id="L28232">                    boomloc = j;</span>
<span class="nc" id="L28233">                    boomslot = k;</span>
                }
            }
        }
<span class="nc bnc" id="L28237" title="All 4 branches missed.">        if ((boomloc != -1) &amp;&amp; (boomslot != -1)) {</span>
<span class="nc" id="L28238">            CriticalSlot slot = entity.getCritical(boomloc, boomslot);</span>
<span class="nc" id="L28239">            slot.setHit(true);</span>
<span class="nc" id="L28240">            slot.getMount().setHit(true);</span>
<span class="nc bnc" id="L28241" title="All 2 branches missed.">            if (slot.getMount2() != null) {</span>
<span class="nc" id="L28242">                slot.getMount2().setHit(true);</span>
            }
<span class="nc" id="L28244">            vDesc.addAll(explodeEquipment(entity, boomloc, boomslot));</span>
<span class="nc" id="L28245">        } else {</span>
            // Luckily, there is no ammo to explode.
<span class="nc" id="L28247">            Report r = new Report(5105);</span>
<span class="nc" id="L28248">            r.subject = entity.getId();</span>
<span class="nc" id="L28249">            r.indent();</span>
<span class="nc" id="L28250">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L28252">        return vDesc;</span>
    }

    /**
     * Makes a mech fall.
     *
     * @param entity
     *            The Entity that is falling. It is expected that the Entity's
     *            position and elevation reflect the state prior to the fall
     * @param fallPos
     *            The location that the Entity is falling into.
     * @param fallHeight
     *            The height that Entity is falling.
     * @param facing
     *            The facing of the fall. Used to determine the the hit location
     *            and also determines facing after the fall (used as an offset
     *            of the Entity's current facing).
     * @param roll
     *            The PSR required to avoid damage to the pilot/crew.
     * @param intoBasement
     *            Flag that determines whether this is a fall into a basement or
     *            not.
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, Coords fallPos, int fallHeight, int facing,
                                        PilotingRollData roll, boolean intoBasement, boolean fromCliff) {
<span class="nc" id="L28277">        entity.setFallen(true);</span>

<span class="nc" id="L28279">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc" id="L28282">        IHex fallHex = game.getBoard().getHex(fallPos);</span>

<span class="nc" id="L28284">        boolean handlingBasement = false;</span>
<span class="nc" id="L28285">        int damageTable = ToHitData.HIT_NORMAL;</span>

        // we don't need to deal damage yet, if the entity is doing DFA
<span class="nc bnc" id="L28288" title="All 2 branches missed.">        if (entity.isMakingDfa()) {</span>
<span class="nc" id="L28289">            r = new Report(2305);</span>
<span class="nc" id="L28290">            r.subject = entity.getId();</span>
<span class="nc" id="L28291">            vPhaseReport.add(r);</span>
<span class="nc" id="L28292">            entity.setProne(true);</span>
<span class="nc" id="L28293">            return vPhaseReport;</span>
        }

        // facing after fall
        String side;
        int table;
<span class="nc bnc" id="L28299" title="All 4 branches missed.">        switch (facing) {</span>
            case 1:
            case 2:
<span class="nc" id="L28302">                side = &quot;right side&quot;;</span>
<span class="nc" id="L28303">                table = ToHitData.SIDE_RIGHT;</span>
<span class="nc" id="L28304">                break;</span>
            case 3:
<span class="nc" id="L28306">                side = &quot;rear&quot;;</span>
<span class="nc" id="L28307">                table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L28308">                break;</span>
            case 4:
            case 5:
<span class="nc" id="L28311">                side = &quot;left side&quot;;</span>
<span class="nc" id="L28312">                table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L28313">                break;</span>
            case 0:
            default:
<span class="nc" id="L28316">                side = &quot;front&quot;;</span>
<span class="nc" id="L28317">                table = ToHitData.SIDE_FRONT;</span>
        }

<span class="nc" id="L28320">        int waterDepth = 0;</span>
<span class="nc bnc" id="L28321" title="All 2 branches missed.">        if (fallHex.containsTerrain(Terrains.WATER)) {</span>
            // *Only* use this if there actually is water in the hex, otherwise
            // we get ITerrain.LEVEL_NONE, i.e. Integer.minValue...
<span class="nc" id="L28324">            waterDepth = fallHex.terrainLevel(Terrains.WATER);</span>
        }
<span class="nc" id="L28326">        boolean fallOntoBridge = false;</span>
        // only fall onto the bridge if we were in the hex and on it,
        // or we fell from a hex that the bridge exits to
<span class="nc bnc" id="L28329" title="All 4 branches missed.">        if ((entity.climbMode() &amp;&amp; (entity.getPosition() != fallPos)</span>
<span class="nc bnc" id="L28330" title="All 2 branches missed.">                &amp;&amp; fallHex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L28331" title="All 2 branches missed.">                &amp;&amp; fallHex.containsTerrainExit(Terrains.BRIDGE, fallPos.direction(entity.getPosition())))</span>
<span class="nc bnc" id="L28332" title="All 2 branches missed.">                || (entity.getElevation() == fallHex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L28333">            fallOntoBridge = true;</span>
        }
<span class="nc" id="L28335">        int bridgeElev = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L28336">        int buildingElev = fallHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L28337">        int damageHeight = fallHeight;</span>
<span class="nc" id="L28338">        int newElevation = 0;</span>

        // we might have to check if the building/bridge we are falling onto
        // collapses
<span class="nc" id="L28342">        boolean checkCollapse = false;</span>

<span class="nc bnc" id="L28344" title="All 4 branches missed.">        if ((entity.getElevation() &gt;= buildingElev) &amp;&amp; (buildingElev &gt;= 0)) {</span>
            // fallHeight should already reflect this
<span class="nc" id="L28346">            newElevation = buildingElev;</span>
<span class="nc" id="L28347">            checkCollapse = true;</span>
<span class="nc bnc" id="L28348" title="All 6 branches missed.">        } else if (fallOntoBridge &amp;&amp; (entity.getElevation() &gt;= bridgeElev) &amp;&amp; (bridgeElev &gt;= 0)) {</span>
            // fallHeight should already reflect this
<span class="nc" id="L28350">            waterDepth = 0;</span>
<span class="nc" id="L28351">            newElevation = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L28352">            checkCollapse = true;</span>
<span class="nc bnc" id="L28353" title="All 4 branches missed.">        } else if (fallHex.containsTerrain(Terrains.ICE) &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L28354">            waterDepth = 0;</span>
<span class="nc" id="L28355">            newElevation = 0;</span>
            // If we are in a basement, we are at a negative elevation, and so
            // setting newElevation = 0 will cause us to &quot;fall up&quot;
<span class="nc bnc" id="L28358" title="All 2 branches missed.">        } else if ((entity.getMovementMode() != EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L28359" title="All 2 branches missed.">                   &amp;&amp; (game.getBoard().getBuildingAt(fallPos) != null)) {</span>
<span class="nc" id="L28360">            newElevation = entity.getElevation();</span>
        }
        // HACK: if the destination hex is water, assume that the fall height given is
        // to the floor of the hex, and modify it so that it's to the surface
<span class="nc bnc" id="L28364" title="All 2 branches missed.">        else if (waterDepth &gt; 0) {</span>
<span class="nc" id="L28365">            damageHeight = fallHeight - waterDepth;</span>
<span class="nc" id="L28366">            newElevation = -waterDepth;</span>
        }
        // only do these basement checks if we didn't fall onto the building
        // from above
<span class="nc bnc" id="L28370" title="All 2 branches missed.">        if (intoBasement) {</span>
<span class="nc" id="L28371">            Building bldg = game.getBoard().getBuildingAt(fallPos);</span>
<span class="nc" id="L28372">            BasementType basement = bldg.getBasement(fallPos);</span>
<span class="nc bnc" id="L28373" title="All 4 branches missed.">            if ((basement != BasementType.NONE) &amp;&amp; (basement != BasementType.ONE_DEEP_NORMALINFONLY)</span>
<span class="nc bnc" id="L28374" title="All 4 branches missed.">                    &amp;&amp; (entity.getElevation() == 0) &amp;&amp; (bldg.getBasementCollapsed(fallPos))) {</span>

<span class="nc bnc" id="L28376" title="All 2 branches missed.">                if (fallHex.depth(true) == 0) {</span>
<span class="nc" id="L28377">                    MegaMek.getLogger().error(&quot;Entity &quot; + entity.getDisplayName() + &quot; is falling into a depth &quot;</span>
<span class="nc" id="L28378">                            + fallHex.depth(true) + &quot; basement -- not allowed!!&quot;);</span>
<span class="nc" id="L28379">                    return vPhaseReport;</span>
                }
<span class="nc" id="L28381">                damageHeight = basement.getDepth();</span>

<span class="nc" id="L28383">                newElevation = newElevation - damageHeight;</span>

<span class="nc" id="L28385">                handlingBasement = true;</span>
                // May have to adjust hit table for 'mechs
<span class="nc bnc" id="L28387" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc bnc" id="L28388" title="All 4 branches missed.">                    if ((basement == BasementType.TWO_DEEP_FEET)</span>
                            || (basement == BasementType.ONE_DEEP_FEET)) {
<span class="nc" id="L28390">                        damageTable = ToHitData.HIT_KICK;</span>
<span class="nc bnc" id="L28391" title="All 4 branches missed.">                    } else if ((basement == BasementType.TWO_DEEP_HEAD)</span>
                            || (basement == BasementType.ONE_DEEP_HEAD)) {
<span class="nc" id="L28393">                        damageTable = ToHitData.HIT_PUNCH;</span>
                    } else {
<span class="nc" id="L28395">                        damageTable = ToHitData.HIT_NORMAL;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L28400" title="All 2 branches missed.">        if (entity instanceof Protomech) {</span>
<span class="nc" id="L28401">            damageTable = ToHitData.HIT_SPECIAL_PROTO;</span>
        }
        // Falling into water instantly destroys most non-mechs
<span class="nc bnc" id="L28404" title="All 6 branches missed.">        if ((waterDepth &gt; 0)</span>
            &amp;&amp; !(entity instanceof Mech)
            &amp;&amp; !(entity instanceof Protomech)
<span class="nc bnc" id="L28407" title="All 4 branches missed.">            &amp;&amp; !((entity.getRunMP() &gt; 0) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.HOVER))</span>
<span class="nc bnc" id="L28408" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L28409" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L28410" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L28411" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L28412">            vPhaseReport.addAll(destroyEntity(entity, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L28413">            return vPhaseReport;</span>
        }

        // set how deep the mech has fallen
<span class="nc bnc" id="L28417" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28418">            Mech mech = (Mech) entity;</span>
<span class="nc" id="L28419">            mech.setLevelsFallen(damageHeight + waterDepth + 1);</span>
            // an industrial mech now needs to check for a crit at the end of
            // the turn
<span class="nc bnc" id="L28422" title="All 2 branches missed.">            if (mech.isIndustrial()) {</span>
<span class="nc" id="L28423">                mech.setCheckForCrit(true);</span>
            }
        }

        // calculate damage for hitting the surface
<span class="nc" id="L28428">        int damage = (int) Math.round(entity.getWeight() / 10.0)</span>
                     * (damageHeight + 1);
        // different rules (pg. 151 of TW) for battle armor and infantry
<span class="nc bnc" id="L28431" title="All 2 branches missed.">        if (entity instanceof Infantry) {</span>
<span class="nc" id="L28432">            damage = (int) Math.ceil(damageHeight / 2.0);</span>
            // no damage for fall from less than 2 levels
<span class="nc bnc" id="L28434" title="All 2 branches missed.">            if (damageHeight &lt; 2) {</span>
<span class="nc" id="L28435">                damage = 0;</span>
            }
<span class="nc bnc" id="L28437" title="All 2 branches missed.">            if (!(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L28438">                int dice = 3;</span>
<span class="nc bnc" id="L28439" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.INF_MOTORIZED) {</span>
<span class="nc" id="L28440">                    dice = 2;</span>
<span class="nc bnc" id="L28441" title="All 2 branches missed.">                } else if ((entity.getMovementMode() == EntityMovementMode.INF_JUMP)</span>
<span class="nc bnc" id="L28442" title="All 2 branches missed.">                           || ((Infantry) entity).isMechanized()) {</span>
<span class="nc" id="L28443">                    dice = 1;</span>
                }
<span class="nc" id="L28445">                damage = damage * Compute.d6(dice);</span>
            }
        }
        // Different rules (pg 62/63/152 of TW) for Tanks
<span class="nc bnc" id="L28449" title="All 2 branches missed.">        if (entity instanceof Tank) {</span>
            // Falls from less than 2 levels don't damage combat vehicles
            // except if they fall off a sheer cliff
<span class="nc bnc" id="L28452" title="All 4 branches missed.">            if (damageHeight &lt; 2 &amp;&amp; !fromCliff) {</span>
<span class="nc" id="L28453">                damage = 0; </span>
            }
            // Falls from &gt;= 2 elevations damage like crashing VTOLs
            // Ends up being the regular damage: weight / 10 * (height + 1)
            // And this was already computed
        }
        // calculate damage for hitting the ground, but only if we actually fell
        // into water
        // if we fell onto the water surface, that damage is halved.
<span class="nc" id="L28462">        int waterDamage = 0;</span>
<span class="nc bnc" id="L28463" title="All 2 branches missed.">        if (waterDepth &gt; 0) {</span>
<span class="nc" id="L28464">            damage /= 2;</span>
<span class="nc" id="L28465">            waterDamage = ((int) Math.round(entity.getWeight() / 10.0) * (waterDepth + 1)) / 2;</span>
        }

        // If the waterDepth is larger than the fall height, we fell underwater
<span class="nc bnc" id="L28469" title="All 6 branches missed.">        if ((waterDepth &gt;= fallHeight) &amp;&amp; ((waterDepth != 0) || (fallHeight != 0))) {</span>
<span class="nc" id="L28470">            damage = 0;</span>
<span class="nc" id="L28471">            waterDamage = ((int) Math.round(entity.getWeight() / 10.0) * (fallHeight + 1)) / 2;</span>
        }
        // adjust damage for gravity
<span class="nc" id="L28474">        damage = Math</span>
<span class="nc" id="L28475">                .round(damage * game.getPlanetaryConditions().getGravity());</span>
<span class="nc" id="L28476">        waterDamage = Math.round(waterDamage</span>
<span class="nc" id="L28477">                                 * game.getPlanetaryConditions().getGravity());</span>

        // report falling
<span class="nc bnc" id="L28480" title="All 2 branches missed.">        if (waterDamage == 0) {</span>
<span class="nc" id="L28481">            r = new Report(2310);</span>
<span class="nc" id="L28482">            r.subject = entity.getId();</span>
<span class="nc" id="L28483">            r.indent();</span>
<span class="nc" id="L28484">            r.addDesc(entity);</span>
<span class="nc" id="L28485">            r.add(side); // international issue</span>
<span class="nc" id="L28486">            r.add(damage);</span>
<span class="nc bnc" id="L28487" title="All 2 branches missed.">        } else if (damage &gt; 0) {</span>
<span class="nc" id="L28488">            r = new Report(2315);</span>
<span class="nc" id="L28489">            r.subject = entity.getId();</span>
<span class="nc" id="L28490">            r.indent();</span>
<span class="nc" id="L28491">            r.addDesc(entity);</span>
<span class="nc" id="L28492">            r.add(side); // international issue</span>
<span class="nc" id="L28493">            r.add(damage);</span>
<span class="nc" id="L28494">            r.add(waterDamage);</span>
        } else {
<span class="nc" id="L28496">            r = new Report(2310);</span>
<span class="nc" id="L28497">            r.subject = entity.getId();</span>
<span class="nc" id="L28498">            r.indent();</span>
<span class="nc" id="L28499">            r.addDesc(entity);</span>
<span class="nc" id="L28500">            r.add(side); // international issue</span>
<span class="nc" id="L28501">            r.add(waterDamage);</span>
        }
<span class="nc" id="L28503">        vPhaseReport.add(r);</span>

        // Any swarming infantry will be dislodged, but we don't want to
        // interrupt the fall's report. We have to get the ID now because
        // the fall may kill the entity which will reset the attacker ID.
<span class="nc" id="L28508">        final int swarmerId = entity.getSwarmAttackerId();</span>

        // Positioning must be prior to damage for proper handling of breaches
        // Only Mechs can fall prone.
<span class="nc bnc" id="L28512" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28513">            entity.setProne(true);</span>
        }
<span class="nc" id="L28515">        entity.setPosition(fallPos);</span>
<span class="nc" id="L28516">        entity.setElevation(newElevation);</span>
        // Only 'mechs change facing when they fall
<span class="nc bnc" id="L28518" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28519">            entity.setFacing((entity.getFacing() + (facing)) % 6);</span>
<span class="nc" id="L28520">            entity.setSecondaryFacing(entity.getFacing());</span>
        }

        // if falling into a bog-down hex, the entity automatically gets stuck (except when on a bridge or building)
        // but avoid reporting this twice in the case of DFAs
<span class="nc bnc" id="L28525" title="All 4 branches missed.">        if (!entity.isStuck() &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc bnc" id="L28526" title="All 2 branches missed.">            if (fallHex.getBogDownModifier(entity.getMovementMode(),</span>
                    entity instanceof LargeSupportTank) != TargetRoll.AUTOMATIC_SUCCESS) {
<span class="nc" id="L28528">                entity.setStuck(true);</span>
<span class="nc" id="L28529">                r = new Report(2081);</span>
<span class="nc" id="L28530">                r.subject = entity.getId();</span>
<span class="nc" id="L28531">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L28532">                vPhaseReport.add(r);</span>
                // check for quicksand
<span class="nc" id="L28534">                vPhaseReport.addAll(checkQuickSand(fallPos));</span>
            }
        }

        // standard damage loop
<span class="nc bnc" id="L28539" title="All 4 branches missed.">        if ((entity instanceof Infantry) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc bnc" id="L28540" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L28541" title="All 2 branches missed.">                for (int i = 1; i &lt; entity.locations(); i++) {</span>
<span class="nc" id="L28542">                    HitData h = new HitData(i);</span>
<span class="nc" id="L28543">                    vPhaseReport.addAll(damageEntity(entity, h, damage));</span>
<span class="nc" id="L28544">                    addNewLines();</span>
                }
            } else {
<span class="nc" id="L28547">                HitData h = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L28548">                vPhaseReport.addAll(damageEntity(entity, h, damage));</span>
<span class="nc" id="L28549">            }</span>
        } else {
<span class="nc bnc" id="L28551" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L28552">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L28553">                HitData hit = entity.rollHitLocation(damageTable, table);</span>
<span class="nc" id="L28554">                hit.makeFallDamage(true);</span>
<span class="nc" id="L28555">                vPhaseReport.addAll(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L28556">                damage -= cluster;</span>
<span class="nc" id="L28557">            }</span>
        }

<span class="nc bnc" id="L28560" title="All 2 branches missed.">        if (waterDepth &gt; 0) {</span>
<span class="nc bnc" id="L28561" title="All 2 branches missed.">            for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc" id="L28562">                entity.setLocationStatus(loop, ILocationExposureStatus.WET);</span>
            }
        }
        // Water damage
<span class="nc bnc" id="L28566" title="All 2 branches missed.">        while (waterDamage &gt; 0) {</span>
<span class="nc" id="L28567">            int cluster = Math.min(5, waterDamage);</span>
<span class="nc" id="L28568">            HitData hit = entity.rollHitLocation(damageTable, table);</span>
<span class="nc" id="L28569">            hit.makeFallDamage(true);</span>
<span class="nc" id="L28570">            vPhaseReport.addAll(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L28571">            waterDamage -= cluster;</span>
<span class="nc" id="L28572">        }</span>

        // check for location exposure
<span class="nc" id="L28575">        vPhaseReport.addAll(doSetLocationsExposure(entity, fallHex, false,</span>
                                                   -waterDepth));

        // only mechs should roll to avoid pilot damage
        // vehicles may fall due to sideslips
<span class="nc bnc" id="L28580" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28581">            vPhaseReport.addAll(checkPilotAvoidFallDamage(entity, fallHeight, roll));</span>
        }

        // Now dislodge any swarming infantry.
<span class="nc bnc" id="L28585" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L28586">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L28587">            entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L28588">            swarmer.setSwarmTargetId(Entity.NONE);</span>
            // Did the infantry fall into water?
<span class="nc bnc" id="L28590" title="All 2 branches missed.">            if ((waterDepth &gt; 0)</span>
<span class="nc bnc" id="L28591" title="All 2 branches missed.">                &amp;&amp; (swarmer.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
                // Swarming infantry die.
<span class="nc" id="L28593">                swarmer.setPosition(fallPos);</span>
<span class="nc" id="L28594">                r = new Report(2330);</span>
<span class="nc" id="L28595">                r.newlines = 0;</span>
<span class="nc" id="L28596">                r.subject = swarmer.getId();</span>
<span class="nc" id="L28597">                r.addDesc(swarmer);</span>
<span class="nc" id="L28598">                vPhaseReport.add(r);</span>
<span class="nc" id="L28599">                vPhaseReport.addAll(destroyEntity(swarmer, &quot;a watery grave&quot;,</span>
                                                  false));
            } else {
                // Swarming infantry take a 2d6 point hit.
                // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L28604">                r = new Report(2335);</span>
<span class="nc" id="L28605">                r.newlines = 0;</span>
<span class="nc" id="L28606">                r.subject = swarmer.getId();</span>
<span class="nc" id="L28607">                r.addDesc(swarmer);</span>
<span class="nc" id="L28608">                vPhaseReport.add(r);</span>
<span class="nc" id="L28609">                vPhaseReport.addAll(damageEntity(swarmer, swarmer</span>
<span class="nc" id="L28610">                        .rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L28611">                                         ToHitData.SIDE_FRONT), Compute.d6(2)));</span>
<span class="nc" id="L28612">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L28614">            swarmer.setPosition(fallPos);</span>
<span class="nc" id="L28615">            entityUpdate(swarmerId);</span>
<span class="nc bnc" id="L28616" title="All 2 branches missed.">            if (!swarmer.isDone()) {</span>
<span class="nc" id="L28617">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L28618">                swarmer.setDone(true);</span>
<span class="nc" id="L28619">                send(createTurnVectorPacket());</span>
            }
        } // End dislodge-infantry

        // clear all PSRs after a fall -- the Mek has already failed ONE and
        // fallen, it'd be cruel to make it fail some more!
<span class="nc" id="L28625">        game.resetPSRs(entity);</span>

        // if there is a minefield in this hex, then the mech may set it off
<span class="nc bnc" id="L28628" title="All 2 branches missed.">        if (game.containsMinefield(fallPos)</span>
<span class="nc bnc" id="L28629" title="All 2 branches missed.">            &amp;&amp; enterMinefield(entity, fallPos, newElevation, true,</span>
                              vPhaseReport, 12)) {
<span class="nc" id="L28631">            resetMines();</span>
        }
        // if we have to, check if the building/bridge we fell on collapses -
        // unless it's a fall into a basement,
        // then we're already gonna check that in building collapse, where we
        // came from
<span class="nc bnc" id="L28637" title="All 4 branches missed.">        if (checkCollapse &amp;&amp; !handlingBasement) {</span>

<span class="nc" id="L28639">            checkForCollapse(game.getBoard().getBuildingAt(fallPos),</span>
<span class="nc" id="L28640">                             game.getPositionMap(), fallPos, false, vPhaseReport);</span>
        }

<span class="nc" id="L28643">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; checkPilotAvoidFallDamage(Entity entity, int fallHeight, PilotingRollData roll) {
<span class="nc" id="L28647">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L28649" title="All 2 branches missed.">        if (entity.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)</span>
<span class="nc bnc" id="L28650" title="All 2 branches missed.">                || entity.hasAbility(OptionsConstants.MD_TSM_IMPLANT)) {</span>
<span class="nc" id="L28651">            return reports;</span>
        }
        // we want to be able to avoid pilot damage even when it was
        // an automatic fall, only unconsciousness should cause auto-damage
<span class="nc" id="L28655">        roll.removeAutos();</span>

<span class="nc bnc" id="L28657" title="All 2 branches missed.">        if (fallHeight &gt; 1) {</span>
<span class="nc" id="L28658">            roll.addModifier(fallHeight - 1, &quot;height of fall&quot;);</span>
        }

<span class="nc bnc" id="L28661" title="All 2 branches missed.">        if (entity.getCrew().getSlotCount() &gt; 1) {</span>
            //Extract the base from the list of modifiers so we can replace it with the piloting
            //skill of each crew member.
<span class="nc" id="L28664">            List&lt;TargetRollModifier&gt; modifiers = new ArrayList&lt;&gt;(roll.getModifiers());</span>
<span class="nc bnc" id="L28665" title="All 2 branches missed.">            if (modifiers.size() &gt; 0) {</span>
<span class="nc" id="L28666">                modifiers.remove(0);</span>
            }
<span class="nc bnc" id="L28668" title="All 2 branches missed.">            for (int pos = 0; pos &lt; entity.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L28669" title="All 4 branches missed.">                if (entity.getCrew().isMissing(pos) || entity.getCrew().isDead(pos)) {</span>
<span class="nc" id="L28670">                    continue;</span>
                }
                PilotingRollData prd;
<span class="nc bnc" id="L28673" title="All 2 branches missed.">                if (entity.getCrew().isDead(pos)) {</span>
<span class="nc" id="L28674">                    continue;</span>
<span class="nc bnc" id="L28675" title="All 2 branches missed.">                } else if (entity.getCrew().isUnconscious(pos)) {</span>
<span class="nc" id="L28676">                    prd = new PilotingRollData(entity.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                            &quot;Crew member unconscious&quot;);
                } else {
<span class="nc" id="L28679">                    prd = new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L28680">                            entity.getCrew().getPiloting(pos), &quot;Base piloting skill&quot;);</span>
<span class="nc" id="L28681">                    modifiers.forEach(prd::addModifier);</span>
                }
<span class="nc" id="L28683">                reports.addAll(resolvePilotDamageFromFall(entity, prd, pos));</span>
            }
<span class="nc" id="L28685">        } else {</span>
<span class="nc" id="L28686">            reports.addAll(resolvePilotDamageFromFall(entity, roll, 0));</span>
        }
<span class="nc" id="L28688">        return reports;</span>
    }

    private Vector&lt;Report&gt; resolvePilotDamageFromFall(Entity entity, PilotingRollData roll, int crewPos) {
<span class="nc" id="L28692">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L28694" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L28695">            r = new Report(2320);</span>
<span class="nc" id="L28696">            r.subject = entity.getId();</span>
<span class="nc" id="L28697">            r.add(entity.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L28698">            r.addDesc(entity);</span>
<span class="nc" id="L28699">            r.add(entity.getCrew().getName(crewPos));</span>
<span class="nc" id="L28700">            r.indent();</span>
<span class="nc" id="L28701">            reports.add(r);</span>
<span class="nc" id="L28702">            reports.addAll(damageCrew(entity, 1, crewPos));</span>
        } else {
<span class="nc" id="L28704">            int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L28705">            r = new Report(2325);</span>
<span class="nc" id="L28706">            r.subject = entity.getId();</span>
<span class="nc" id="L28707">            r.add(entity.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L28708">            r.addDesc(entity);</span>
<span class="nc" id="L28709">            r.add(entity.getCrew().getName(crewPos));</span>
<span class="nc" id="L28710">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L28711">            r.add(diceRoll);</span>
<span class="nc bnc" id="L28712" title="All 2 branches missed.">            if (diceRoll &gt;= roll.getValue()) {</span>
<span class="nc" id="L28713">                r.choose(true);</span>
<span class="nc" id="L28714">                reports.add(r);</span>
            } else {
<span class="nc" id="L28716">                r.choose(false);</span>
<span class="nc" id="L28717">                reports.add(r);</span>
<span class="nc" id="L28718">                reports.addAll(damageCrew(entity, 1, crewPos));</span>
            }
        }
<span class="nc" id="L28721">        Report.addNewline(reports);</span>
<span class="nc" id="L28722">        return reports;</span>
    }

    /**
     * The mech falls into an unoccupied hex from the given height above
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, Coords fallPos,
                                        int height, PilotingRollData roll) {
<span class="nc" id="L28730">        return doEntityFall(entity, fallPos, height, Compute.d6(1) - 1, roll,</span>
                            false, false);
    }

    /**
     * The mech falls down in place
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, PilotingRollData roll) {
<span class="nc" id="L28738">        boolean fallToSurface = false;</span>
        // on ice
<span class="nc" id="L28740">        int toSubtract = 0;</span>
<span class="nc" id="L28741">        IHex currHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L28742" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L28743" title="All 2 branches missed.">            &amp;&amp; (entity.getElevation() != -currHex.depth())) {</span>
<span class="nc" id="L28744">            fallToSurface = true;</span>
<span class="nc" id="L28745">            toSubtract = 0;</span>
        }
        // on a bridge
<span class="nc bnc" id="L28748" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc" id="L28749">            &amp;&amp; (entity.getElevation() &gt;= currHex</span>
<span class="nc bnc" id="L28750" title="All 2 branches missed.">                .terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L28751">            fallToSurface = true;</span>
<span class="nc" id="L28752">            toSubtract = currHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
        }
        // on a building
<span class="nc bnc" id="L28755" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L28756">            &amp;&amp; (entity.getElevation() &gt;= currHex</span>
<span class="nc bnc" id="L28757" title="All 2 branches missed.">                .terrainLevel(Terrains.BLDG_ELEV))) {</span>
<span class="nc" id="L28758">            fallToSurface = true;</span>
<span class="nc" id="L28759">            toSubtract = currHex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc" id="L28761">        return doEntityFall(entity, entity.getPosition(), entity.getElevation()</span>
<span class="nc bnc" id="L28762" title="All 2 branches missed.">                + (!fallToSurface ? currHex.depth(true) : -toSubtract), roll);</span>
    }

    /**
     * Report: - Any ammo dumps beginning the following round. - Any ammo dumps
     * that have ended with the end of this round.
     */
    private void resolveAmmoDumps() {
        Report r;
<span class="nc bnc" id="L28771" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L28772" title="All 2 branches missed.">            for (Mounted m : entity.getAmmo()) {</span>
<span class="nc bnc" id="L28773" title="All 2 branches missed.">                if (m.isPendingDump()) {</span>
                    // report dumping next round
<span class="nc" id="L28775">                    r = new Report(5110);</span>
<span class="nc" id="L28776">                    r.subject = entity.getId();</span>
<span class="nc" id="L28777">                    r.addDesc(entity);</span>
<span class="nc" id="L28778">                    r.add(m.getName());</span>
<span class="nc" id="L28779">                    addReport(r);</span>
                    // update status
<span class="nc" id="L28781">                    m.setPendingDump(false);</span>
<span class="nc" id="L28782">                    m.setDumping(true);</span>
<span class="nc bnc" id="L28783" title="All 2 branches missed.">                } else if (m.isDumping()) {</span>
                    // report finished dumping
<span class="nc" id="L28785">                    r = new Report(5115);</span>
<span class="nc" id="L28786">                    r.subject = entity.getId();</span>
<span class="nc" id="L28787">                    r.addDesc(entity);</span>
<span class="nc" id="L28788">                    r.add(m.getName());</span>
<span class="nc" id="L28789">                    addReport(r);</span>
                    // update status
<span class="nc" id="L28791">                    m.setDumping(false);</span>
<span class="nc" id="L28792">                    m.setShotsLeft(0);</span>
                }
<span class="nc" id="L28794">            }</span>
            // also do DWP dumping
<span class="nc bnc" id="L28796" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L28797" title="All 2 branches missed.">                for (Mounted m : entity.getWeaponList()) {</span>
<span class="nc bnc" id="L28798" title="All 4 branches missed.">                    if (m.isDWPMounted() &amp;&amp; m.isPendingDump()) {</span>
<span class="nc" id="L28799">                        m.setMissing(true);</span>
<span class="nc" id="L28800">                        r = new Report(5116);</span>
<span class="nc" id="L28801">                        r.subject = entity.getId();</span>
<span class="nc" id="L28802">                        r.addDesc(entity);</span>
<span class="nc" id="L28803">                        r.add(m.getName());</span>
<span class="nc" id="L28804">                        addReport(r);</span>
<span class="nc" id="L28805">                        m.setPendingDump(false);</span>
                        // Also dump all of the ammo in the DWP
<span class="nc bnc" id="L28807" title="All 2 branches missed.">                        for (Mounted ammo : entity.getAmmo()) {</span>
<span class="nc bnc" id="L28808" title="All 2 branches missed.">                            if (m.equals(ammo.getLinkedBy())) {</span>
<span class="nc" id="L28809">                                ammo.setMissing(true);</span>
                            }
<span class="nc" id="L28811">                        }</span>
                    // Check for jettisoning missiles
<span class="nc bnc" id="L28813" title="All 4 branches missed.">                    } else if (m.isBodyMounted() &amp;&amp; m.isPendingDump()</span>
<span class="nc bnc" id="L28814" title="All 2 branches missed.">                            &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L28815" title="All 2 branches missed.">                            &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L28816" title="All 2 branches missed.">                            &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28817">                        m.setMissing(true);</span>
<span class="nc" id="L28818">                        r = new Report(5116);</span>
<span class="nc" id="L28819">                        r.subject = entity.getId();</span>
<span class="nc" id="L28820">                        r.addDesc(entity);</span>
<span class="nc" id="L28821">                        r.add(m.getName());</span>
<span class="nc" id="L28822">                        addReport(r);</span>
<span class="nc" id="L28823">                        m.setPendingDump(false);</span>
                        // Dump all ammo related to this launcher
                        // BA burdened is based on whether the launcher has
                        // ammo left
<span class="nc bnc" id="L28827" title="All 2 branches missed.">                        while ((m.getLinked() != null)</span>
<span class="nc bnc" id="L28828" title="All 2 branches missed.">                                &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28829">                            m.getLinked().setMissing(true);</span>
<span class="nc" id="L28830">                            entity.loadWeapon(m);</span>
                        }
                    }
<span class="nc" id="L28833">                }</span>
            }
<span class="nc" id="L28835">            entity.reloadEmptyWeapons();</span>
<span class="nc" id="L28836">        }</span>
<span class="nc" id="L28837">    }</span>

    /**
     * Checks for fire ignition based on a given target roll. If successful,
     * lights a fire also checks to see that fire is possible in the specified
     * hex.
     *
     * @param c        - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll     - the &lt;code&gt;TargetRoll&lt;/code&gt; for the ignition roll
     * @param bInferno - &lt;code&gt;true&lt;/code&gt; if the fire is an inferno fire. If this
     *                 value is &lt;code&gt;false&lt;/code&gt; the hex will be lit only if it
     *                 contains Woods,jungle or a Building.
     * @param entityId - the entityId responsible for the ignite attempt. If the
     *                 value is Entity.NONE, then the roll attempt will not be
     *                 included in the report.
     */
    public boolean checkIgnition(Coords c, TargetRoll roll, boolean bInferno, int entityId,
                                 Vector&lt;Report&gt; vPhaseReport) {

<span class="nc" id="L28856">        IHex hex = game.getBoard().getHex(c);</span>

        // The hex might be null due to spreadFire translation
        // goes outside of the board limit.
<span class="nc bnc" id="L28860" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28861">            return false;</span>
        }

        // The hex may already be on fire.
<span class="nc bnc" id="L28865" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L28866">            return false;</span>
        }

<span class="nc bnc" id="L28869" title="All 4 branches missed.">        if (!bInferno &amp;&amp; !hex.isIgnitable()) {</span>
<span class="nc" id="L28870">            return false;</span>
        }

<span class="nc" id="L28873">        int fireRoll = Compute.d6(2);</span>
        Report r;
<span class="nc bnc" id="L28875" title="All 2 branches missed.">        if (entityId != Entity.NONE) {</span>
<span class="nc" id="L28876">            r = new Report(3430);</span>
<span class="nc" id="L28877">            r.indent(2);</span>
<span class="nc" id="L28878">            r.subject = entityId;</span>
<span class="nc" id="L28879">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L28880">            r.add(roll.getDesc());</span>
<span class="nc" id="L28881">            r.add(fireRoll);</span>
<span class="nc" id="L28882">            vPhaseReport.add(r);</span>
        }
<span class="nc bnc" id="L28884" title="All 2 branches missed.">        if (fireRoll &gt;= roll.getValue()) {</span>
<span class="nc" id="L28885">            ignite(c, Terrains.FIRE_LVL_NORMAL, vPhaseReport);</span>
<span class="nc" id="L28886">            return true;</span>
        }
<span class="nc" id="L28888">        return false;</span>
    }

    /**
     * Returns true if the hex is set on fire with the specified roll. Of
     * course, also checks to see that fire is possible in the specified hex.
     * This version of the method will not report the attempt roll.
     *
     * @param c        - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll     - the &lt;code&gt;int&lt;/code&gt; target number for the ignition roll
     * @param bInferno - &lt;code&gt;true&lt;/code&gt; if the fire can be lit in any terrain. If
     *                 this value is &lt;code&gt;false&lt;/code&gt; the hex will be lit only if
     *                 it contains Woods, jungle or a Building.
     */
    public boolean checkIgnition(Coords c, TargetRoll roll, boolean bInferno) {
<span class="nc" id="L28903">        return checkIgnition(c, roll, bInferno, Entity.NONE, null);</span>
    }

    /**
     * Returns true if the hex is set on fire with the specified roll. Of
     * course, also checks to see that fire is possible in the specified hex.
     * This version of the method will not report the attempt roll.
     *
     * @param c    - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll - the &lt;code&gt;int&lt;/code&gt; target number for the ignition roll
     */
    public boolean checkIgnition(Coords c, TargetRoll roll) {
        // default signature, assuming only woods can burn
<span class="nc" id="L28916">        return checkIgnition(c, roll, false, Entity.NONE, null);</span>
    }

    /**
     * add fire to a hex
     *
     * @param c         - the &lt;code&gt;Coords&lt;/code&gt; of the hex to be set on fire
     * @param fireLevel - The level of fire, see Terrains
     */
    public void ignite(Coords c, int fireLevel, Vector&lt;Report&gt; vReport) {
        // you can't start fires in some planetary conditions!
<span class="nc bnc" id="L28927" title="All 2 branches missed.">        if (null != game.getPlanetaryConditions().cannotStartFire()) {</span>
<span class="nc bnc" id="L28928" title="All 2 branches missed.">            if (null != vReport) {</span>
<span class="nc" id="L28929">                Report r = new Report(3007);</span>
<span class="nc" id="L28930">                r.indent(2);</span>
<span class="nc" id="L28931">                r.add(game.getPlanetaryConditions().cannotStartFire());</span>
<span class="nc" id="L28932">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L28933">                vReport.add(r);</span>
            }
<span class="nc" id="L28935">            return;</span>
        }

<span class="nc bnc" id="L28938" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_START_FIRE)) {</span>
<span class="nc bnc" id="L28939" title="All 2 branches missed.">            if (null != vReport) {</span>
<span class="nc" id="L28940">                Report r = new Report(3008);</span>
<span class="nc" id="L28941">                r.indent(2);</span>
<span class="nc" id="L28942">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L28943">                vReport.add(r);</span>
            }
<span class="nc" id="L28945">            return;</span>
        }

<span class="nc" id="L28948">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L28949" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28950">            return;</span>
        }

<span class="nc" id="L28953">        Report r = new Report(3005);</span>
<span class="nc" id="L28954">        r.indent(2);</span>
<span class="nc" id="L28955">        r.add(c.getBoardNum());</span>
<span class="nc" id="L28956">        r.type = Report.PUBLIC;</span>

        // Adjust report message for inferno types
<span class="nc bnc" id="L28959" title="All 4 branches missed.">        switch (fireLevel) {</span>
            case Terrains.FIRE_LVL_INFERNO:
<span class="nc" id="L28961">                r.messageId = 3006;</span>
<span class="nc" id="L28962">                break;</span>
            case Terrains.FIRE_LVL_INFERNO_BOMB:
<span class="nc" id="L28964">                r.messageId = 3003;</span>
<span class="nc" id="L28965">                break;</span>
            case Terrains.FIRE_LVL_INFERNO_IV:
<span class="nc" id="L28967">                r.messageId = 3004;</span>
                break;
        }

        // report it
<span class="nc bnc" id="L28972" title="All 2 branches missed.">        if (null != vReport) {</span>
<span class="nc" id="L28973">            vReport.add(r);</span>
        }
<span class="nc" id="L28975">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FIRE, fireLevel));</span>
<span class="nc" id="L28976">        sendChangedHex(c);</span>
<span class="nc" id="L28977">    }</span>

    /**
     * remove fire from a hex
     *
     * @param fireCoords
     * @param reason
     */
    public void removeFire(Coords fireCoords, String reason) {
<span class="nc" id="L28986">        IHex hex = game.getBoard().getHex(fireCoords);</span>
<span class="nc bnc" id="L28987" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28988">            return;</span>
        }
<span class="nc" id="L28990">        hex.removeTerrain(Terrains.FIRE);</span>
<span class="nc" id="L28991">        hex.resetFireTurn();</span>
<span class="nc" id="L28992">        sendChangedHex(fireCoords);</span>
        // fire goes out
<span class="nc" id="L28994">        Report r = new Report(5170, Report.PUBLIC);</span>
<span class="nc" id="L28995">        r.add(fireCoords.getBoardNum());</span>
<span class="nc" id="L28996">        r.add(reason);</span>
<span class="nc" id="L28997">        addReport(r);</span>
<span class="nc" id="L28998">    }</span>

    /**
     * Called when a fire is burning. Called 3 times per fire hex.
     *
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; x-coordinate of the hex
     */
    public void addSmoke(ArrayList&lt;Coords&gt; coords, int windDir, boolean bInferno) {
        // if a tornado, then no smoke!
<span class="nc bnc" id="L29007" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L29008">            return;</span>
        }

<span class="nc" id="L29011">        int smokeLevel = 0;</span>
<span class="nc bnc" id="L29012" title="All 2 branches missed.">        for (Coords smokeCoords : coords) {</span>
<span class="nc" id="L29013">            IHex smokeHex = game.getBoard().getHex(smokeCoords);</span>
            Report r;
<span class="nc bnc" id="L29015" title="All 2 branches missed.">            if (smokeHex == null) {</span>
<span class="nc" id="L29016">                continue;</span>
            }
            // Have to check if it's inferno smoke or from a heavy/hardened
            // building
            // - heavy smoke from those
<span class="nc bnc" id="L29021" title="All 4 branches missed.">            if (bInferno || (Building.MEDIUM &lt; smokeHex.terrainLevel(Terrains.FUEL_TANK))</span>
<span class="nc bnc" id="L29022" title="All 2 branches missed.">                    || (Building.MEDIUM &lt; smokeHex.terrainLevel(Terrains.BUILDING))) {</span>
<span class="nc bnc" id="L29023" title="All 2 branches missed.">                if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_HEAVY) {</span>
                    // heavy smoke fills hex
<span class="nc" id="L29025">                    r = new Report(5180, Report.PUBLIC);</span>
                } else {
<span class="nc" id="L29027">                    r = new Report(5185, Report.PUBLIC);</span>
                }
<span class="nc" id="L29029">                smokeLevel = SmokeCloud.SMOKE_HEAVY;</span>
<span class="nc" id="L29030">                r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29031">                addReport(r);</span>
            } else {
<span class="nc bnc" id="L29033" title="All 2 branches missed.">                if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_HEAVY) {</span>
                    // heavy smoke overpowers light
<span class="nc" id="L29035">                    r = new Report(5190, Report.PUBLIC);</span>
<span class="nc" id="L29036">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29037">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
<span class="nc" id="L29038">                    addReport(r);</span>
<span class="nc bnc" id="L29039" title="All 2 branches missed.">                } else if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_LIGHT) {</span>
                    // light smoke continue to fill hex
<span class="nc" id="L29041">                    r = new Report(5195, Report.PUBLIC);</span>
<span class="nc" id="L29042">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29043">                    addReport(r);</span>
<span class="nc" id="L29044">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
                } else {
<span class="nc" id="L29046">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
                    // light smoke fills hex
<span class="nc" id="L29048">                    r = new Report(5200, Report.PUBLIC);</span>
<span class="nc" id="L29049">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29050">                    addReport(r);</span>
                }
            }
<span class="nc" id="L29053">        }</span>
<span class="nc" id="L29054">        createSmoke(coords, smokeLevel, 0);</span>
<span class="nc" id="L29055">    }</span>

    /**
     * Scans the boards directory for map boards of the appropriate size and
     * returns them.
     *
     * @return A list of relative paths to the board files, without the '.board'
     * extension.
     */
    private List&lt;String&gt; scanForBoardsInDir(final File boardDir, final String basePath,
                                            final BoardDimensions dimensions, List&lt;String&gt; boards) {
<span class="nc bnc" id="L29066" title="All 2 branches missed.">        if (boardDir == null) {</span>
<span class="nc" id="L29067">            throw new IllegalArgumentException(&quot;must provide searchDir&quot;);</span>
<span class="nc bnc" id="L29068" title="All 2 branches missed.">        } else if (basePath == null) {</span>
<span class="nc" id="L29069">            throw new IllegalArgumentException(&quot;must provide basePath&quot;);</span>
<span class="nc bnc" id="L29070" title="All 2 branches missed.">        } else if (dimensions == null) {</span>
<span class="nc" id="L29071">            throw new IllegalArgumentException(&quot;must provide dimensions&quot;);</span>
<span class="nc bnc" id="L29072" title="All 2 branches missed.">        } else if (boards == null) {</span>
<span class="nc" id="L29073">            throw new IllegalArgumentException(&quot;must provide boards&quot;);</span>
        }

<span class="nc" id="L29076">        String[] fileList = boardDir.list();</span>
<span class="nc bnc" id="L29077" title="All 2 branches missed.">        if (fileList != null) {</span>
<span class="nc bnc" id="L29078" title="All 2 branches missed.">            for (String filename : fileList) {</span>
<span class="nc" id="L29079">                File filePath = new MegaMekFile(boardDir, filename).getFile();</span>
<span class="nc bnc" id="L29080" title="All 2 branches missed.">                if (filePath.isDirectory()) {</span>
<span class="nc" id="L29081">                    scanForBoardsInDir(new MegaMekFile(boardDir, filename).getFile(),</span>
<span class="nc" id="L29082">                            basePath.concat(File.separator).concat(filename), dimensions, boards);</span>
                } else {
<span class="nc bnc" id="L29084" title="All 2 branches missed.">                    if (filename.endsWith(&quot;.board&quot;)) { //$NON-NLS-1$</span>
<span class="nc bnc" id="L29085" title="All 2 branches missed.">                        if (Board.boardIsSize(filePath, dimensions)) {</span>
<span class="nc" id="L29086">                            boards.add(basePath.concat(File.separator)</span>
<span class="nc" id="L29087">                                    .concat(filename.substring(0, filename.lastIndexOf(&quot;.&quot;))));</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L29093">        return boards;</span>
    }

    /**
     * Recursively scan the specified path to determine the board sizes
     * available.
     *
     * @param searchDir The directory to search below this path (may be null for all
     *                  in base path).
     * @param sizes     Where to store the discovered board sizes
     */
    private void getBoardSizesInDir(final File searchDir, TreeSet&lt;BoardDimensions&gt; sizes) {
<span class="nc bnc" id="L29105" title="All 2 branches missed.">        if (searchDir == null) {</span>
<span class="nc" id="L29106">            throw new IllegalArgumentException(&quot;must provide searchDir&quot;);</span>
        }

<span class="nc bnc" id="L29109" title="All 2 branches missed.">        if (sizes == null) {</span>
<span class="nc" id="L29110">            throw new IllegalArgumentException(&quot;must provide sizes&quot;);</span>
        }

<span class="nc" id="L29113">        String[] file_list = searchDir.list();</span>

<span class="nc bnc" id="L29115" title="All 2 branches missed.">        if (file_list != null) {</span>
<span class="nc bnc" id="L29116" title="All 2 branches missed.">            for (String filename : file_list) {</span>
<span class="nc" id="L29117">                File query_file = new File(searchDir, filename);</span>

<span class="nc bnc" id="L29119" title="All 2 branches missed.">                if (query_file.isDirectory()) {</span>
<span class="nc" id="L29120">                    getBoardSizesInDir(query_file, sizes);</span>
                } else {
                    try {
<span class="nc bnc" id="L29123" title="All 2 branches missed.">                        if (filename.endsWith(&quot;.board&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L29124">                            BoardDimensions size = Board.getSize(query_file);</span>
<span class="nc bnc" id="L29125" title="All 2 branches missed.">                            if (size == null) {</span>
<span class="nc" id="L29126">                                throw new Exception();</span>
                            }
<span class="nc" id="L29128">                            sizes.add(Board.getSize(query_file));</span>
                        }
<span class="nc" id="L29130">                    } catch (Exception e) {</span>
<span class="nc" id="L29131">                        MegaMek.getLogger().error(&quot;Error parsing board: &quot; + query_file.getAbsolutePath(), e);</span>
<span class="nc" id="L29132">                    }</span>
                }
            }
        }
<span class="nc" id="L29136">    }</span>

    /**
     * Get a list of the available board sizes from the boards data directory.
     *
     * @return A Set containing all the available board sizes.
     */
    private Set&lt;BoardDimensions&gt; getBoardSizes() {
<span class="nc" id="L29144">        TreeSet&lt;BoardDimensions&gt; board_sizes = new TreeSet&lt;&gt;();</span>

<span class="nc" id="L29146">        File boards_dir = Configuration.boardsDir();</span>
        // Slightly overkill sanity check...
<span class="nc bnc" id="L29148" title="All 2 branches missed.">        if (boards_dir.isDirectory()) {</span>
<span class="nc" id="L29149">            getBoardSizesInDir(boards_dir, board_sizes);</span>
        }
<span class="nc" id="L29151">        boards_dir = new File(Configuration.userdataDir(), Configuration.boardsDir().toString());</span>
<span class="nc bnc" id="L29152" title="All 2 branches missed.">        if (boards_dir.isDirectory()) {</span>
<span class="nc" id="L29153">            getBoardSizesInDir(boards_dir, board_sizes);</span>
        }

<span class="nc" id="L29156">        return board_sizes;</span>
    }

    /**
     * Scan for map boards with the specified dimensions.
     *
     * @param dimensions The desired board dimensions.
     * @return A list of path names, minus the '.board' extension, relative to
     * the boards data directory.
     */
    private ArrayList&lt;String&gt; scanForBoards(final BoardDimensions dimensions) {
<span class="nc" id="L29167">        ArrayList&lt;String&gt; boards = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L29169">        File boardDir = Configuration.boardsDir();</span>
<span class="nc" id="L29170">        boards.add(MapSettings.BOARD_GENERATED);</span>
        // just a check...
<span class="nc bnc" id="L29172" title="All 2 branches missed.">        if (!boardDir.isDirectory()) {</span>
<span class="nc" id="L29173">            return boards;</span>
        }

        // scan files
<span class="nc" id="L29177">        List&lt;String&gt; tempList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L29178">        Comparator&lt;String&gt; sortComp = StringUtil.stringComparator();</span>
<span class="nc" id="L29179">        scanForBoardsInDir(boardDir, &quot;&quot;, dimensions, tempList);</span>
        // Check boards in userData dir
<span class="nc" id="L29181">        boardDir = new File(Configuration.userdataDir(), Configuration.boardsDir().toString());</span>
<span class="nc bnc" id="L29182" title="All 2 branches missed.">        if (boardDir.isDirectory()) {</span>
<span class="nc" id="L29183">            scanForBoardsInDir(boardDir, &quot;&quot;, dimensions, tempList);</span>
        }
        // if there are any boards, add these:
<span class="nc bnc" id="L29186" title="All 2 branches missed.">        if (tempList.size() &gt; 0) {</span>
<span class="nc" id="L29187">            boards.add(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L29188">            boards.add(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L29189">            tempList.sort(sortComp);</span>
<span class="nc" id="L29190">            boards.addAll(tempList);</span>
        }

<span class="nc" id="L29193">        return boards;</span>
    }

    /**
     * @return whether this game is double blind or not and we should be blind in
     * the current phase
     */
    private boolean doBlind() {
<span class="nc bnc" id="L29201" title="All 2 branches missed.">        return game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L29202" title="All 2 branches missed.">               &amp;&amp; game.getPhase().isDuringOrAfter(IGame.Phase.PHASE_DEPLOYMENT);</span>
    }

    private boolean suppressBlindBV() {
<span class="nc" id="L29206">        return game.getOptions().booleanOption(OptionsConstants.ADVANCED_SUPPRESS_DB_BV);</span>
    }

    /**
     * In a double-blind game, update only visible entities. Otherwise, update
     * everyone
     */
    public void entityUpdate(int nEntityID) {
<span class="nc" id="L29214">        entityUpdate(nEntityID, new Vector&lt;&gt;(), true, null);</span>
<span class="nc" id="L29215">    }</span>

    /**
     * In a double-blind game, update only visible entities. Otherwise, update
     * everyone
     *
     * @param updateVisibility Flag that determines if whoCanSee needs to be
     *                         called to update who can see the entity for
     *                         double-blind games.
     */
    public void entityUpdate(int nEntityID, Vector&lt;UnitLocation&gt; movePath, boolean updateVisibility,
                             Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc" id="L29227">        Entity eTarget = game.getEntity(nEntityID);</span>
<span class="nc bnc" id="L29228" title="All 2 branches missed.">        if (eTarget == null) {</span>
<span class="nc bnc" id="L29229" title="All 2 branches missed.">            if (game.getOutOfGameEntity(nEntityID) != null) {</span>
<span class="nc" id="L29230">                MegaMek.getLogger().error(&quot;S: attempted to send entity update for out of game entity, id was &quot; + nEntityID);</span>
            } else {
<span class="nc" id="L29232">                MegaMek.getLogger().error(&quot;S: attempted to send entity update for null entity, id was &quot; + nEntityID);</span>
            }

<span class="nc" id="L29235">            return; // do not send the update it will crash the client</span>
        }

        // If we're doing double blind, be careful who can see it...
<span class="nc bnc" id="L29239" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L29240">            Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
            Vector&lt;IPlayer&gt; vCanSee;
<span class="nc bnc" id="L29242" title="All 2 branches missed.">            if (updateVisibility) {</span>
<span class="nc" id="L29243">                vCanSee = whoCanSee(eTarget, true, losCache);</span>
            } else {
<span class="nc" id="L29245">                vCanSee = eTarget.getWhoCanSee();</span>
            }

            // If this unit has ECM, players with units affected by the ECM will
            //  need to know about this entity, even if they can't see it.
            //  Otherwise, the client can't properly report things like to-hits.
<span class="nc bnc" id="L29251" title="All 4 branches missed.">            if ((eTarget.getECMRange() &gt; 0) &amp;&amp; (eTarget.getPosition() != null)) {</span>
<span class="nc" id="L29252">                int ecmRange = eTarget.getECMRange();</span>
<span class="nc" id="L29253">                Coords pos = eTarget.getPosition();</span>
<span class="nc bnc" id="L29254" title="All 2 branches missed.">                for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L29255" title="All 2 branches missed.">                    if ((ent.getPosition() != null)</span>
<span class="nc bnc" id="L29256" title="All 2 branches missed.">                        &amp;&amp; (pos.distance(ent.getPosition()) &lt;= ecmRange)) {</span>
<span class="nc bnc" id="L29257" title="All 2 branches missed.">                        if (!vCanSee.contains(ent.getOwner())) {</span>
<span class="nc" id="L29258">                            vCanSee.add(ent.getOwner());</span>
                        }
                    }
<span class="nc" id="L29261">                }</span>
            }

            // send an entity update to everyone who can see
<span class="nc" id="L29265">            Packet pack = createEntityPacket(nEntityID, movePath);</span>
<span class="nc bnc" id="L29266" title="All 2 branches missed.">            for (int x = 0; x &lt; vCanSee.size(); x++) {</span>
<span class="nc" id="L29267">                IPlayer p = vCanSee.elementAt(x);</span>
<span class="nc" id="L29268">                send(p.getId(), pack);</span>
            }
            // send an entity delete to everyone else
<span class="nc" id="L29271">            pack = createRemoveEntityPacket(nEntityID,</span>
<span class="nc" id="L29272">                                            eTarget.getRemovalCondition());</span>
<span class="nc bnc" id="L29273" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc bnc" id="L29274" title="All 2 branches missed.">                if (!vCanSee.contains(playersVector.elementAt(x))) {</span>
<span class="nc" id="L29275">                    IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29276">                    send(p.getId(), pack);</span>
                }
            }

<span class="nc" id="L29280">            entityUpdateLoadedUnits(eTarget, vCanSee, playersVector);</span>
<span class="nc" id="L29281">        } else {</span>
            // But if we're not, then everyone can see.
<span class="nc" id="L29283">            send(createEntityPacket(nEntityID, movePath));</span>
        }
<span class="nc" id="L29285">    }</span>

    /**
     * Whenever updating an Entity, we also need to update all of its loaded
     * Entity's, otherwise it could cause issues with Clients.
     *
     * @param loader        An Entity being updated that is transporting units that should
     *                      also send an update
     * @param vCanSee       The list of Players who can see the loader.
     * @param playersVector The list of all Players
     */
    private void entityUpdateLoadedUnits(Entity loader,
                                         Vector&lt;IPlayer&gt; vCanSee, Vector&lt;IPlayer&gt; playersVector) {
        Packet pack;

        // In double-blind, the client may not know about the loaded units,
        // so we need to send them.
<span class="nc bnc" id="L29302" title="All 2 branches missed.">        for (Entity eLoaded : loader.getLoadedUnits()) {</span>
            // send an entity update to everyone who can see
<span class="nc" id="L29304">            pack = createEntityPacket(eLoaded.getId(), null);</span>
<span class="nc bnc" id="L29305" title="All 2 branches missed.">            for (int x = 0; x &lt; vCanSee.size(); x++) {</span>
<span class="nc" id="L29306">                IPlayer p = vCanSee.elementAt(x);</span>
<span class="nc" id="L29307">                send(p.getId(), pack);</span>
            }
            // send an entity delete to everyone else
<span class="nc" id="L29310">            pack = createRemoveEntityPacket(eLoaded.getId(),</span>
<span class="nc" id="L29311">                                            eLoaded.getRemovalCondition());</span>
<span class="nc bnc" id="L29312" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc bnc" id="L29313" title="All 2 branches missed.">                if (!vCanSee.contains(playersVector.elementAt(x))) {</span>
<span class="nc" id="L29314">                    IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29315">                    send(p.getId(), pack);</span>
                }
            }
<span class="nc" id="L29318">            entityUpdateLoadedUnits(eLoaded, vCanSee, playersVector);</span>
<span class="nc" id="L29319">        }</span>
<span class="nc" id="L29320">    }</span>

    /**
     * Returns a vector of which players can see this entity, always allowing
     * for sensor detections.
     */
    private Vector&lt;IPlayer&gt; whoCanSee(Entity entity) {
<span class="nc" id="L29327">        return whoCanSee(entity, true, null);</span>
    }

    /**
     * Returns a vector of which players can see the given entity, optionally
     * allowing for sensors to count.
     *
     * @param entity     The entity to check visibility for
     * @param useSensors A flag that determines whether sensors are allowed
     * @return A vector of the players who can see the entity
     */
    private Vector&lt;IPlayer&gt; whoCanSee(Entity entity, boolean useSensors,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29340" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29341">            losCache = new HashMap&lt;&gt;();</span>
        }
        // Some times Null entities are sent to this
<span class="nc bnc" id="L29344" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L29345">            return new Vector&lt;&gt;();</span>
        }

<span class="nc" id="L29348">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29349" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS) &amp;&amp; useSensors) {</span>
<span class="nc" id="L29350">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L29351">                    .getEntitiesVector());</span>
        }

<span class="nc" id="L29354">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>
<span class="nc" id="L29355">        List&lt;Entity&gt; vEntities = game.getEntitiesVector();</span>

<span class="nc" id="L29357">        Vector&lt;IPlayer&gt; vCanSee = new Vector&lt;&gt;();</span>
<span class="nc" id="L29358">        vCanSee.addElement(entity.getOwner());</span>
<span class="nc bnc" id="L29359" title="All 2 branches missed.">        if (bTeamVision) {</span>
<span class="nc" id="L29360">            addTeammates(vCanSee, entity.getOwner());</span>
        }

        // Deal with players who can see all.
<span class="nc bnc" id="L29364" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; p = game.getPlayers(); p.hasMoreElements();) {</span>
<span class="nc" id="L29365">            IPlayer player = p.nextElement();</span>

<span class="nc bnc" id="L29367" title="All 4 branches missed.">            if (player.canSeeAll() &amp;&amp; !vCanSee.contains(player)) {</span>
<span class="nc" id="L29368">                vCanSee.addElement(player);</span>
            }
<span class="nc" id="L29370">        }</span>

        // If the entity is hidden, skip; no one else will be able to see it.
<span class="nc bnc" id="L29373" title="All 2 branches missed.">        if (entity.isHidden()) {</span>
<span class="nc" id="L29374">            return vCanSee;</span>
        }
<span class="nc bnc" id="L29376" title="All 2 branches missed.">        for (Entity spotter : vEntities) {</span>
            // Certain conditions make the spotter ineligible
<span class="nc bnc" id="L29378" title="All 4 branches missed.">            if (!spotter.isActive() || spotter.isOffBoard()</span>
<span class="nc bnc" id="L29379" title="All 2 branches missed.">                    || vCanSee.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29380">                continue;</span>
            }
            // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29383">            EntityTargetPair etp = new EntityTargetPair(spotter, entity);</span>
<span class="nc" id="L29384">            LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29385" title="All 2 branches missed.">            if (los == null) {</span>
<span class="nc" id="L29386">                los = LosEffects.calculateLos(game, spotter.getId(), entity);</span>
<span class="nc" id="L29387">                losCache.put(etp, los);</span>
            }
<span class="nc bnc" id="L29389" title="All 2 branches missed.">            if (Compute.canSee(game, spotter, entity, useSensors, los,</span>
                    allECMInfo)) {
<span class="nc bnc" id="L29391" title="All 2 branches missed.">                if (!vCanSee.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29392">                    vCanSee.addElement(spotter.getOwner());</span>
                }
<span class="nc bnc" id="L29394" title="All 2 branches missed.">                if (bTeamVision) {</span>
<span class="nc" id="L29395">                    addTeammates(vCanSee, spotter.getOwner());</span>
                }
<span class="nc" id="L29397">                addObservers(vCanSee);</span>
            }
<span class="nc" id="L29399">        }</span>
<span class="nc" id="L29400">        return vCanSee;</span>
    }

    /**
     * Determine which players can detect the given entity with sensors.
     * Because recomputing ECM and LosEffects frequently can get expensive, this
     * data can be cached and passed in.
     *
     * @param entity        The Entity being detected.
     * @param allECMInfo    Cached ECMInfo for all Entities in the game.
     * @param losCache      Cached LosEffects for particular Entity/Targetable
     *                      pairs.  Can be passed in null.
     * @return
     */
    private Vector&lt;IPlayer&gt; whoCanDetect(Entity entity,
            List&lt;ECMInfo&gt; allECMInfo,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29417" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29418">            losCache = new HashMap&lt;&gt;();</span>
        }

<span class="nc" id="L29421">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>
<span class="nc" id="L29422">        List&lt;Entity&gt; vEntities = game.getEntitiesVector();</span>

<span class="nc" id="L29424">        Vector&lt;IPlayer&gt; vCanDetect = new Vector&lt;&gt;();</span>

        // If the entity is hidden, skip; no one else will be able to detect it
<span class="nc bnc" id="L29427" title="All 4 branches missed.">        if (entity.isHidden() || entity.isOffBoard()) {</span>
<span class="nc" id="L29428">            return vCanDetect;</span>
        }

<span class="nc bnc" id="L29431" title="All 2 branches missed.">        for (Entity spotter : vEntities) {</span>
<span class="nc bnc" id="L29432" title="All 4 branches missed.">            if (!spotter.isActive() || spotter.isOffBoard()</span>
<span class="nc bnc" id="L29433" title="All 2 branches missed.">                    || vCanDetect.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29434">                continue;</span>
            }
            // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29437">            EntityTargetPair etp = new EntityTargetPair(spotter, entity);</span>
<span class="nc" id="L29438">            LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29439" title="All 2 branches missed.">            if (los == null) {</span>
<span class="nc" id="L29440">                los = LosEffects.calculateLos(game, spotter.getId(), entity);</span>
<span class="nc" id="L29441">                losCache.put(etp, los);</span>
            }
<span class="nc bnc" id="L29443" title="All 2 branches missed.">            if (Compute.inSensorRange(game, los, spotter, entity, allECMInfo)) {</span>
<span class="nc bnc" id="L29444" title="All 2 branches missed.">                if (!vCanDetect.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29445">                    vCanDetect.addElement(spotter.getOwner());</span>
                }
<span class="nc bnc" id="L29447" title="All 2 branches missed.">                if (bTeamVision) {</span>
<span class="nc" id="L29448">                    addTeammates(vCanDetect, spotter.getOwner());</span>
                }
<span class="nc" id="L29450">                addObservers(vCanDetect);</span>
            }
<span class="nc" id="L29452">            }</span>

<span class="nc" id="L29454">        return vCanDetect;</span>
    }

    /**
     * Adds teammates of a player to the Vector. Utility function for whoCanSee.
     */
    private void addTeammates(Vector&lt;IPlayer&gt; vector, IPlayer player) {
<span class="nc" id="L29461">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29462" title="All 2 branches missed.">        for (int j = 0; j &lt; playersVector.size(); j++) {</span>
<span class="nc" id="L29463">            IPlayer p = playersVector.elementAt(j);</span>
<span class="nc bnc" id="L29464" title="All 4 branches missed.">            if (!player.isEnemyOf(p) &amp;&amp; !vector.contains(p)) {</span>
<span class="nc" id="L29465">                vector.addElement(p);</span>
            }
        }
<span class="nc" id="L29468">    }</span>

    /**
     * Adds observers to the Vector. Utility function for whoCanSee.
     */
    private void addObservers(Vector&lt;IPlayer&gt; vector) {
<span class="nc" id="L29474">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29475" title="All 2 branches missed.">        for (int j = 0; j &lt; playersVector.size(); j++) {</span>
<span class="nc" id="L29476">            IPlayer p = playersVector.elementAt(j);</span>
<span class="nc bnc" id="L29477" title="All 4 branches missed.">            if (p.isObserver() &amp;&amp; !vector.contains(p)) {</span>
<span class="nc" id="L29478">                vector.addElement(p);</span>
            }
        }
<span class="nc" id="L29481">    }</span>

    /**
     * Send the complete list of entities to the players. If double_blind is in
     * effect, enforce it by filtering the entities
     */
    private void entityAllUpdate() {
        // If double-blind is in effect, filter each players' list individually,
        // and then quit out...
<span class="nc bnc" id="L29490" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L29491">            Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29492" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc" id="L29493">                IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29494">                send(p.getId(), createFilteredEntitiesPacket(p, null));</span>
            }
<span class="nc" id="L29496">            return;</span>
        }

        // Otherwise, send the full list.
<span class="nc" id="L29500">        send(createEntitiesPacket());</span>
<span class="nc" id="L29501">    }</span>

    /**
     * Filters an entity vector according to LOS
     */
    private List&lt;Entity&gt; filterEntities(IPlayer pViewer,
            List&lt;Entity&gt; vEntities,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29509" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29510">            losCache = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L29512">        Vector&lt;Entity&gt; vCanSee = new Vector&lt;&gt;();</span>
<span class="nc" id="L29513">        Vector&lt;Entity&gt; vMyEntities = new Vector&lt;&gt;();</span>
<span class="nc" id="L29514">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>

        // If they can see all, return the input list
<span class="nc bnc" id="L29517" title="All 2 branches missed.">        if (pViewer.canSeeAll()) {</span>
<span class="nc" id="L29518">            return vEntities;</span>
        }

<span class="nc" id="L29521">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29522" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L29523">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game.getEntitiesVector());</span>
        }

        // If they're an observer, they can see anything seen by any enemy.
<span class="nc bnc" id="L29527" title="All 2 branches missed.">        if (pViewer.isObserver()) {</span>
<span class="nc" id="L29528">            vMyEntities.addAll(vEntities);</span>
<span class="nc bnc" id="L29529" title="All 2 branches missed.">            for (Entity a : vMyEntities) {</span>
<span class="nc bnc" id="L29530" title="All 2 branches missed.">                for (Entity b : vMyEntities) {</span>
<span class="nc bnc" id="L29531" title="All 2 branches missed.">                    if (a.isEnemyOf(b)</span>
<span class="nc bnc" id="L29532" title="All 2 branches missed.">                        &amp;&amp; Compute.canSee(game, b, a, true, null, allECMInfo)) {</span>
<span class="nc" id="L29533">                        addVisibleEntity(vCanSee, a);</span>
<span class="nc" id="L29534">                        break;</span>
                    }
<span class="nc" id="L29536">                }</span>
<span class="nc" id="L29537">            }</span>
<span class="nc" id="L29538">            return vCanSee;</span>
        }

        // If they aren't an observer and can't see all, create the list of
        // &quot;friendly&quot; units.
<span class="nc bnc" id="L29543" title="All 2 branches missed.">        for (Entity e : vEntities) {</span>
<span class="nc bnc" id="L29544" title="All 6 branches missed.">            if ((e.getOwner() == pViewer) || (bTeamVision &amp;&amp; !e.getOwner().isEnemyOf(pViewer))) {</span>
<span class="nc" id="L29545">                vMyEntities.addElement(e);</span>
            }
<span class="nc" id="L29547">        }</span>

        // Then, break down the list by whether they're friendly,
        // or whether or not any friendly unit can see them.
<span class="nc bnc" id="L29551" title="All 2 branches missed.">        for (Entity e : vEntities) {</span>
            // If it's their own unit, obviously, they can see it.
<span class="nc bnc" id="L29553" title="All 2 branches missed.">            if (vMyEntities.contains(e)) {</span>
<span class="nc" id="L29554">                addVisibleEntity(vCanSee, e);</span>
<span class="nc" id="L29555">                continue;</span>
<span class="nc bnc" id="L29556" title="All 2 branches missed.">            } else if (e.isHidden()) {</span>
                // If it's NOT friendly and is hidden, they can't see it,
                // period.
                // LOS doesn't matter.
<span class="nc" id="L29560">                continue;</span>
            }
<span class="nc bnc" id="L29562" title="All 2 branches missed.">            for (Entity spotter : vMyEntities) {</span>

                // If they're off-board, skip it; they can't see anything.
<span class="nc bnc" id="L29565" title="All 2 branches missed.">                if (spotter.isOffBoard()) {</span>
<span class="nc" id="L29566">                    continue;</span>
                }

                // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29570">                EntityTargetPair etp = new EntityTargetPair(spotter, e);</span>
<span class="nc" id="L29571">                LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29572" title="All 2 branches missed.">                if (los == null) {</span>
<span class="nc" id="L29573">                    los = LosEffects.calculateLos(game, spotter.getId(), e);</span>
<span class="nc" id="L29574">                    losCache.put(etp, los);</span>
                }
                // Otherwise, if they can see the entity in question
<span class="nc bnc" id="L29577" title="All 2 branches missed.">                if (Compute.canSee(game, spotter, e, true, los, allECMInfo)) {</span>
<span class="nc" id="L29578">                    addVisibleEntity(vCanSee, e);</span>
<span class="nc" id="L29579">                    break;</span>
                }

                // If this unit has ECM, players with units affected by the ECM
                //  will need to know about this entity, even if they can't see
                //  it.  Otherwise, the client can't properly report things
                //  like to-hits.
<span class="nc bnc" id="L29586" title="All 4 branches missed.">                if ((e.getECMRange() &gt; 0) &amp;&amp; (e.getPosition() != null) &amp;&amp;</span>
<span class="nc bnc" id="L29587" title="All 2 branches missed.">                    (spotter.getPosition() != null)) {</span>
<span class="nc" id="L29588">                    int ecmRange = e.getECMRange();</span>
<span class="nc" id="L29589">                    Coords pos = e.getPosition();</span>
<span class="nc bnc" id="L29590" title="All 2 branches missed.">                    if (pos.distance(spotter.getPosition()) &lt;= ecmRange) {</span>
<span class="nc" id="L29591">                        addVisibleEntity(vCanSee, e);</span>
                    }
                }
<span class="nc" id="L29594">            }</span>
<span class="nc" id="L29595">        }</span>

<span class="nc" id="L29597">        return vCanSee;</span>
    }

    /**
     * Recursive method to add an &lt;code&gt;Entity&lt;/code&gt; and all of its transported
     * units to the list of units visible to a particular player. It is
     * important to ensure that if a unit is in the list of visible units then
     * all of its transported units (and their transported units, and so on) are
     * also considered visible, otherwise it can lead to issues. This method
     * also ensures that no duplicate Entities are added.
     *
     * @param vCanSee A collection of units that can be see
     * @param e       An Entity that is seen and needs to be added to the collection
     *                of seen entities. All of
     */
    private void addVisibleEntity(Vector&lt;Entity&gt; vCanSee, Entity e) {
<span class="nc bnc" id="L29613" title="All 2 branches missed.">        if (!vCanSee.contains(e)) {</span>
<span class="nc" id="L29614">            vCanSee.add(e);</span>
        }
<span class="nc bnc" id="L29616" title="All 2 branches missed.">        for (Entity transported : e.getLoadedUnits()) {</span>
<span class="nc" id="L29617">            addVisibleEntity(vCanSee, transported);</span>
<span class="nc" id="L29618">        }</span>
<span class="nc" id="L29619">    }</span>

    /**
     * Filter a report vector for double blind.
     *
     * @param originalReportVector the original &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt;
     * @param p                    the &lt;code&gt;Player&lt;/code&gt; who should see stuff only visible to
     *                             him
     * @return the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; with stuff only Player p can see
     */
    private Vector&lt;Report&gt; filterReportVector(Vector&lt;Report&gt; originalReportVector, IPlayer p) {
        // If no double blind, no filtering to do
<span class="nc bnc" id="L29631" title="All 2 branches missed.">        if (!doBlind()) {</span>
<span class="nc" id="L29632">            return new Vector&lt;&gt;(originalReportVector);</span>
        }
        // But if it is, then filter everything properly.
<span class="nc" id="L29635">        Vector&lt;Report&gt; filteredReportVector = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29636" title="All 2 branches missed.">        for (Report r : originalReportVector) {</span>
<span class="nc" id="L29637">            Report filteredReport = filterReport(r, p, false);</span>
<span class="nc bnc" id="L29638" title="All 2 branches missed.">            if (filteredReport != null) {</span>
<span class="nc" id="L29639">                filteredReportVector.addElement(filteredReport);</span>
            }
<span class="nc" id="L29641">        }</span>
<span class="nc" id="L29642">        return filteredReportVector;</span>
    }

    /**
     * Filter a single report so that the correct double-blind obscuration takes
     * place. To mark a message as &quot;this should be visible to anyone seeing this
     * entity&quot; set r.subject to the entity id to mark a message as &quot;only visible
     * to the player&quot; set r.player to that player's id and set r.type to
     * Report.PLAYER to mark a message as visible to all, set r.type to
     * Report.PUBLIC
     *
     * @param r         the Report to filter
     * @param p         the Player that we are going to send the filtered report to
     * @param omitCheck boolean indicating that this report happened in the past, so we
     *                  no longer have access to the Player
     * @return a new Report, which has possibly been obscured
     */
    private Report filterReport(Report r, IPlayer p, boolean omitCheck) {
<span class="nc bnc" id="L29660" title="All 6 branches missed.">        if ((r.subject == Entity.NONE) &amp;&amp; (r.type != Report.PLAYER) &amp;&amp; (r.type != Report.PUBLIC)) {</span>
            // Reports that don't have a subject should be public.
<span class="nc" id="L29662">            MegaMek.getLogger().error(&quot;Attempting to filter a Report object that is not public yet &quot;</span>
                            + &quot;but has no subject.\n\t\tmessageId: &quot; + r.messageId);
<span class="nc" id="L29664">            return r;</span>
        }
<span class="nc bnc" id="L29666" title="All 6 branches missed.">        if ((r.type == Report.PUBLIC) || ((p == null) &amp;&amp; !omitCheck)) {</span>
<span class="nc" id="L29667">            return r;</span>
        }
<span class="nc" id="L29669">        Entity entity = game.getEntity(r.subject);</span>
<span class="nc bnc" id="L29670" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L29671">            entity = game.getOutOfGameEntity(r.subject);</span>
        }
<span class="nc" id="L29673">        IPlayer owner = null;</span>
<span class="nc bnc" id="L29674" title="All 2 branches missed.">        if (entity != null) {</span>
<span class="nc" id="L29675">            owner = entity.getOwner();</span>
            // off board (Artillery) units get treated as public messages
<span class="nc bnc" id="L29677" title="All 2 branches missed.">            if (entity.isOffBoard()) {</span>
<span class="nc" id="L29678">                return r;</span>
            }
        }

<span class="nc bnc" id="L29682" title="All 8 branches missed.">        if ((r.type != Report.PLAYER) &amp;&amp; !omitCheck</span>
            &amp;&amp; ((entity == null) || (owner == null))) {
<span class="nc" id="L29684">            MegaMek.getLogger().error(&quot;Attempting to filter a report object that is not public but has a subject (&quot;</span>
                            + entity + &quot;) with owner (&quot; + owner + &quot;).\n\tmessageId: &quot; + r.messageId);
<span class="nc" id="L29686">            return r;</span>
        }

<span class="nc bnc" id="L29689" title="All 4 branches missed.">        boolean shouldObscure = omitCheck</span>
<span class="nc bnc" id="L29690" title="All 4 branches missed.">                                || ((entity != null) &amp;&amp; !entity.hasSeenEntity(p))</span>
<span class="nc bnc" id="L29691" title="All 2 branches missed.">                                || ((r.type == Report.PLAYER) &amp;&amp; (p.getId() != r.player));</span>
        // If suppressing double blind messages, don't send this report at all.
<span class="nc" id="L29693">        if (game.getOptions()</span>
<span class="nc bnc" id="L29694" title="All 4 branches missed.">                .booleanOption(OptionsConstants.ADVANCED_SUPRESS_ALL_DB_MESSAGES)</span>
            &amp;&amp; shouldObscure) {
            // Mark the original report to indicate it was filtered
<span class="nc bnc" id="L29697" title="All 2 branches missed.">            if (p != null) {</span>
<span class="nc" id="L29698">                r.addObscuredRecipient(p.getName());</span>
            }
<span class="nc" id="L29700">            return null;</span>
        }
<span class="nc" id="L29702">        Report copy = new Report(r);</span>
        // Otherwise, obscure data in the report
<span class="nc bnc" id="L29704" title="All 2 branches missed.">        for (int j = 0; j &lt; copy.dataCount(); j++) {</span>
<span class="nc bnc" id="L29705" title="All 2 branches missed.">            if (shouldObscure) {</span>
                // This report should be obscured
<span class="nc bnc" id="L29707" title="All 2 branches missed.">                if (r.isValueObscured(j)) {</span>
<span class="nc" id="L29708">                    copy.hideData(j);</span>
                    // Mark the original report to indicate which players
                    // received an obscured version of it.
<span class="nc bnc" id="L29711" title="All 2 branches missed.">                    if (p != null) {</span>
<span class="nc" id="L29712">                        r.addObscuredRecipient(p.getName());</span>
                    }
                }
            }
        }
<span class="nc" id="L29717">        return copy;</span>
    }

    /**
     *
     * @return a vector which has as its keys the round number and as its
     *         elements vectors that contain all the reports for the specified player
     *         that round. The reports returned this way are properly filtered for
     *         double blind.
     */
    private Vector&lt;Vector&lt;Report&gt;&gt; filterPastReports(
            Vector&lt;Vector&lt;Report&gt;&gt; pastReports, IPlayer p) {
        // Only actually bother with the filtering if double-blind is in effect.
<span class="nc bnc" id="L29730" title="All 2 branches missed.">        if (!doBlind()) {</span>
<span class="nc" id="L29731">            return pastReports;</span>
        }
        // Perform filtering
<span class="nc" id="L29734">        Vector&lt;Vector&lt;Report&gt;&gt; filteredReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29735" title="All 2 branches missed.">        for (Vector&lt;Report&gt; roundReports : pastReports) {</span>
<span class="nc" id="L29736">            Vector&lt;Report&gt; filteredRoundReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29737" title="All 2 branches missed.">            for (Report r : roundReports) {</span>
<span class="nc bnc" id="L29738" title="All 2 branches missed.">                if (r.isObscuredRecipient(p.getName())) {</span>
<span class="nc" id="L29739">                    r = filterReport(r, null, true);</span>
                }
<span class="nc bnc" id="L29741" title="All 2 branches missed.">                if (r != null) {</span>
<span class="nc" id="L29742">                    filteredRoundReports.addElement(r);</span>
                }
<span class="nc" id="L29744">            }</span>
<span class="nc" id="L29745">            filteredReports.addElement(filteredRoundReports);</span>
<span class="nc" id="L29746">        }</span>
<span class="nc" id="L29747">        return filteredReports;</span>
    }

    /**
     * Updates entities graphical &quot;visibility indications&quot; which are used in
     * double-blind games.
     *
     * @param losCache  It can be expensive to have to recompute LoSEffects
     *                  again and again, so in some cases where this may happen,
     *                  the LosEffects are cached.   This can safely be null.
     */
    private void updateVisibilityIndicator(Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29759" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29760">            losCache = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L29762">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29763" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L29764">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L29765">                    .getEntitiesVector());</span>
        }

<span class="nc" id="L29768">        List&lt;Entity&gt; vAllEntities = game.getEntitiesVector();</span>
<span class="nc bnc" id="L29769" title="All 2 branches missed.">        for (Entity e : vAllEntities) {</span>
<span class="nc" id="L29770">            Vector&lt;IPlayer&gt; whoCouldSee = new Vector&lt;&gt;(e.getWhoCanSee());</span>
<span class="nc" id="L29771">            Vector&lt;IPlayer&gt; whoCouldDetect = new Vector&lt;&gt;(e.getWhoCanDetect());</span>
<span class="nc" id="L29772">            e.setVisibleToEnemy(false);</span>
<span class="nc" id="L29773">            e.setDetectedByEnemy(false);</span>
<span class="nc" id="L29774">            e.clearSeenBy();</span>
<span class="nc" id="L29775">            e.clearDetectedBy();</span>
<span class="nc" id="L29776">            Vector&lt;IPlayer&gt; vCanSee = whoCanSee(e, false, losCache);</span>
            // Who can See this unit?
<span class="nc bnc" id="L29778" title="All 2 branches missed.">            for (IPlayer p : vCanSee) {</span>
<span class="nc bnc" id="L29779" title="All 4 branches missed.">                if (e.getOwner().isEnemyOf(p) &amp;&amp; !p.isObserver()) {</span>
<span class="nc" id="L29780">                    e.setVisibleToEnemy(true);</span>
<span class="nc" id="L29781">                    e.setEverSeenByEnemy(true);</span>
                    // If we can see it, it's detected
<span class="nc" id="L29783">                    e.setDetectedByEnemy(true);</span>
                }
<span class="nc" id="L29785">                e.addBeenSeenBy(p);</span>
<span class="nc" id="L29786">            }</span>
            // Who can Detect this unit?
<span class="nc" id="L29788">            Vector&lt;IPlayer&gt; vCanDetect = whoCanDetect(e, allECMInfo, losCache);</span>
<span class="nc bnc" id="L29789" title="All 2 branches missed.">            for (IPlayer p : vCanDetect) {</span>
<span class="nc bnc" id="L29790" title="All 4 branches missed.">                if (e.getOwner().isEnemyOf(p) &amp;&amp; !p.isObserver()) {</span>
<span class="nc" id="L29791">                    e.setDetectedByEnemy(true);</span>
                }
<span class="nc" id="L29793">                e.addBeenDetectedBy(p);</span>
<span class="nc" id="L29794">            }</span>

            // If a client can now see/detect this entity, but couldn't before,
            // then the client needs to be updated with the Entity
<span class="nc" id="L29798">            boolean hasClientWithoutEntity = false;</span>
<span class="nc bnc" id="L29799" title="All 2 branches missed.">            for (IPlayer p : vCanSee) {</span>
<span class="nc bnc" id="L29800" title="All 4 branches missed.">                if (!whoCouldSee.contains(p) &amp;&amp; !whoCouldDetect.contains(p)) {</span>
<span class="nc" id="L29801">                    hasClientWithoutEntity = true;</span>
<span class="nc" id="L29802">                    break;</span>
                }
<span class="nc" id="L29804">            }</span>
<span class="nc bnc" id="L29805" title="All 2 branches missed.">            if (!hasClientWithoutEntity) {</span>
<span class="nc bnc" id="L29806" title="All 2 branches missed.">                for (IPlayer p : vCanDetect) {</span>
<span class="nc bnc" id="L29807" title="All 4 branches missed.">                    if (!whoCouldSee.contains(p) &amp;&amp; !whoCouldDetect.contains(p)) {</span>
<span class="nc" id="L29808">                        hasClientWithoutEntity = true;</span>
<span class="nc" id="L29809">                        break;</span>
                    }
<span class="nc" id="L29811">                }</span>
            }
<span class="nc bnc" id="L29813" title="All 2 branches missed.">            if (hasClientWithoutEntity) {</span>
<span class="nc" id="L29814">                entityUpdate(e.getId(), new Vector&lt;&gt;(), false, losCache);</span>
            } else {
<span class="nc" id="L29816">                sendVisibilityIndicator(e);</span>
            }
<span class="nc" id="L29818">        }</span>
<span class="nc" id="L29819">    }</span>

    /**
     * Checks if an entity added by the client is valid and if so, adds it to
     * the list
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityAdd(Packet c, int connIndex) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L29830">        final List&lt;Entity&gt; entities = (List&lt;Entity&gt;) c.getObject(0);</span>
<span class="nc" id="L29831">        List&lt;Integer&gt; entityIds = new ArrayList&lt;&gt;(entities.size());</span>
        // Map client-received to server-given IDs: 
<span class="nc" id="L29833">        Map&lt;Integer, Integer&gt; idMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L29835" title="All 2 branches missed.">        for (final Entity entity : entities) {</span>

            // Verify the entity's design
<span class="nc bnc" id="L29838" title="All 2 branches missed.">            if (Server.entityVerifier == null) {</span>
<span class="nc" id="L29839">                Server.entityVerifier = EntityVerifier.getInstance(new MegaMekFile(</span>
<span class="nc" id="L29840">                        Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</span>
            }

            // Create a TestEntity instance for supported unit types
<span class="nc" id="L29844">            TestEntity testEntity = null;</span>
<span class="nc" id="L29845">            entity.restore();</span>
<span class="nc bnc" id="L29846" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L29847">                testEntity = new TestMech((Mech) entity, entityVerifier.mechOption, null);</span>
<span class="nc bnc" id="L29848" title="All 2 branches missed.">            } else if ((entity.getEntityType() == Entity.ETYPE_TANK)</span>
<span class="nc bnc" id="L29849" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_GUN_EMPLACEMENT)) {</span>
<span class="nc bnc" id="L29850" title="All 2 branches missed.">                if (entity.isSupportVehicle()) {</span>
<span class="nc" id="L29851">                    testEntity = new TestSupportVehicle(entity, entityVerifier.tankOption, null);</span>
                } else {
<span class="nc" id="L29853">                    testEntity = new TestTank((Tank) entity, entityVerifier.tankOption, null);</span>
                }
<span class="nc bnc" id="L29855" title="All 2 branches missed.">            } else if ((entity.getEntityType() == Entity.ETYPE_AERO)</span>
<span class="nc bnc" id="L29856" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L29857" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L29858" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_FIGHTER_SQUADRON)</span>
<span class="nc bnc" id="L29859" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L29860" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_SPACE_STATION)) {</span>
<span class="nc" id="L29861">                testEntity = new TestAero((Aero) entity, entityVerifier.aeroOption, null);</span>
<span class="nc bnc" id="L29862" title="All 2 branches missed.">            } else if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L29863">                testEntity = new TestBattleArmor((BattleArmor) entity, entityVerifier.baOption, null);</span>
            }

<span class="nc bnc" id="L29866" title="All 2 branches missed.">            if (testEntity != null) {</span>
<span class="nc" id="L29867">                StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L29868" title="All 2 branches missed.">                if (testEntity.correctEntity(sb, TechConstants.getGameTechLevel(game, entity.isClan()))) {</span>
<span class="nc" id="L29869">                    entity.setDesignValid(true);</span>
                } else {
<span class="nc" id="L29871">                    MegaMek.getLogger().error(sb.toString());</span>
<span class="nc bnc" id="L29872" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ALLOWED_ALLOW_ILLEGAL_UNITS)) {</span>
<span class="nc" id="L29873">                        entity.setDesignValid(false);</span>
                    } else {
<span class="nc" id="L29875">                        IPlayer cheater = game.getPlayer(connIndex);</span>
<span class="nc" id="L29876">                        sendServerChat(&quot;Player &quot; + cheater.getName()</span>
                                       + &quot; attempted to add an illegal unit design (&quot;
<span class="nc" id="L29878">                                       + entity.getShortNameRaw()</span>
                                       + &quot;), the unit was rejected.&quot;);
<span class="nc" id="L29880">                        return;</span>
                    }
                }
            }

            // If we're adding a ProtoMech, calculate it's unit number.
<span class="nc bnc" id="L29886" title="All 2 branches missed.">            if (entity instanceof Protomech) {</span>
                // How many ProtoMechs does the player already have?
<span class="nc" id="L29888">                int numPlayerProtos = game</span>
<span class="nc" id="L29889">                        .getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L29890">                            private final int ownerId = entity.getOwnerId();</span>

                            public boolean accept(Entity entity) {
<span class="nc bnc" id="L29893" title="All 2 branches missed.">                                return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L29894" title="All 2 branches missed.">                                        &amp;&amp; (ownerId == entity.getOwnerId());</span>
                            }
                        });

                // According to page 54 of the BMRr, ProtoMechs must be
                // deployed in full Points of five, unless circumstances have
                // reduced the number to less than that.
<span class="nc" id="L29901">                entity.setUnitNumber((short) (numPlayerProtos / 5));</span>
            } // End added-ProtoMech

            // Only assign an entity ID when the client hasn't.
<span class="nc bnc" id="L29905" title="All 2 branches missed.">            if (Entity.NONE == entity.getId()) {</span>
<span class="nc" id="L29906">                entity.setId(getFreeEntityId());</span>
            }

<span class="nc" id="L29909">            int clientSideId = entity.getId();</span>
<span class="nc" id="L29910">            game.addEntity(entity);</span>
            
            // Remember which received ID corresponds to which actual ID
<span class="nc" id="L29913">            idMap.put(clientSideId, entity.getId());</span>

            // Now we relink C3/NC3/C3i to our guys! Yes, this is hackish... but, we
            // do what we must. Its just too bad we have to loop over the entire entities array..
<span class="nc bnc" id="L29917" title="All 6 branches missed.">            if (entity.hasC3() || entity.hasC3i() || entity.hasNavalC3()) {</span>
<span class="nc" id="L29918">                boolean C3iSet = false;</span>

<span class="nc bnc" id="L29920" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>

                    // C3 Checks
<span class="nc bnc" id="L29923" title="All 2 branches missed.">                    if (entity.hasC3()) {</span>
<span class="nc bnc" id="L29924" title="All 2 branches missed.">                        if ((entity.getC3MasterIsUUIDAsString() != null)</span>
<span class="nc bnc" id="L29925" title="All 2 branches missed.">                                &amp;&amp; entity.getC3MasterIsUUIDAsString().equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29926">                            entity.setC3Master(e, false);</span>
<span class="nc" id="L29927">                            entity.setC3MasterIsUUIDAsString(null);</span>
<span class="nc bnc" id="L29928" title="All 2 branches missed.">                        } else if ((e.getC3MasterIsUUIDAsString() != null)</span>
<span class="nc bnc" id="L29929" title="All 2 branches missed.">                                &amp;&amp; e.getC3MasterIsUUIDAsString().equals(entity.getC3UUIDAsString())) {</span>
<span class="nc" id="L29930">                            e.setC3Master(entity, false);</span>
<span class="nc" id="L29931">                            e.setC3MasterIsUUIDAsString(null);</span>
                            // Taharqa: we need to update the other entity for
                            // the
                            // client
                            // or it won't show up right. I am not sure if I
                            // like
                            // the idea of updating other entities in this
                            // method,
                            // but it
                            // will work for now.
<span class="nc bnc" id="L29941" title="All 2 branches missed.">                            if (!entities.contains(e)) {</span>
<span class="nc" id="L29942">                                entityUpdate(e.getId());</span>
                            }
                        }
                    }

                    // C3i Checks
<span class="nc bnc" id="L29948" title="All 4 branches missed.">                    if (entity.hasC3i() &amp;&amp; !C3iSet) {</span>
<span class="nc" id="L29949">                        entity.setC3NetIdSelf();</span>
<span class="nc" id="L29950">                        int pos = 0;</span>
<span class="nc bnc" id="L29951" title="All 2 branches missed.">                        while (pos &lt; Entity.MAX_C3i_NODES) {</span>
                            // We've found a network, join it.
<span class="nc bnc" id="L29953" title="All 2 branches missed.">                            if ((entity.getC3iNextUUIDAsString(pos) != null)</span>
<span class="nc bnc" id="L29954" title="All 2 branches missed.">                                    &amp;&amp; (e.getC3UUIDAsString() != null)</span>
<span class="nc" id="L29955">                                    &amp;&amp; entity.getC3iNextUUIDAsString(pos)</span>
<span class="nc bnc" id="L29956" title="All 2 branches missed.">                                    .equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29957">                                entity.setC3NetId(e);</span>
<span class="nc" id="L29958">                                C3iSet = true;</span>
<span class="nc" id="L29959">                                break;</span>
                            }

<span class="nc" id="L29962">                            pos++;</span>
                        }
                    }

                    // NC3 Checks
<span class="nc bnc" id="L29967" title="All 4 branches missed.">                    if (entity.hasNavalC3() &amp;&amp; !C3iSet) {</span>
<span class="nc" id="L29968">                        entity.setC3NetIdSelf();</span>
<span class="nc" id="L29969">                        int pos = 0;</span>
<span class="nc bnc" id="L29970" title="All 2 branches missed.">                        while (pos &lt; Entity.MAX_C3i_NODES) {</span>
                            // We've found a network, join it.
<span class="nc bnc" id="L29972" title="All 2 branches missed.">                            if ((entity.getNC3NextUUIDAsString(pos) != null)</span>
<span class="nc bnc" id="L29973" title="All 2 branches missed.">                                    &amp;&amp; (e.getC3UUIDAsString() != null)</span>
<span class="nc" id="L29974">                                    &amp;&amp; entity.getNC3NextUUIDAsString(pos)</span>
<span class="nc bnc" id="L29975" title="All 2 branches missed.">                                    .equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29976">                                entity.setC3NetId(e);</span>
<span class="nc" id="L29977">                                C3iSet = true;</span>
<span class="nc" id="L29978">                                break;</span>
                            }

<span class="nc" id="L29981">                            pos++;</span>
                        }
                    }
<span class="nc" id="L29984">                }</span>
            }
            // Give the unit a spotlight, if it has the spotlight quirk
<span class="nc bnc" id="L29987" title="All 2 branches missed.">            entity.setExternalSpotlight(entity.hasExternaSpotlight()</span>
<span class="nc bnc" id="L29988" title="All 2 branches missed.">                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</span>
<span class="nc" id="L29989">            entityIds.add(entity.getId());</span>

<span class="nc bnc" id="L29991" title="All 2 branches missed.">            if (game.getPhase() != Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L29992">                entity.getOwner().changeInitialEntityCount(1);</span>
<span class="nc" id="L29993">                entity.getOwner().changeInitialBV(entity.calculateBattleValue());</span>
            }
<span class="nc" id="L29995">        }</span>
        
        // Cycle through the entities again and update any carried units
        // and carrier units to use the correct server-given IDs.
        // Typically necessary when loading a MUL containing transported units.
        
        // First, deal with units loaded into bays. These are saved for the carrier
        // in MULs and must be restored exactly to recreate the bay loading.
<span class="nc" id="L30003">        Set&lt;Entity&gt; transportCorrected = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L30004" title="All 2 branches missed.">        for (final Entity carrier: entities) {</span>
<span class="nc bnc" id="L30005" title="All 2 branches missed.">            for (int carriedId: carrier.getBayLoadedUnitIds()) {</span>
                // First, see if a bay loaded unit can be found and unloaded,
                // because it might be the wrong unit
<span class="nc" id="L30008">                Entity carried = game.getEntity(carriedId);</span>
<span class="nc bnc" id="L30009" title="All 2 branches missed.">                if (carried == null) {</span>
<span class="nc" id="L30010">                    continue;</span>
                }
<span class="nc" id="L30012">                int bay = carrier.getBay(carried).getBayNumber();</span>
<span class="nc" id="L30013">                carrier.unload(carried);</span>
                // Now, load the correct unit if there is one
<span class="nc bnc" id="L30015" title="All 2 branches missed.">                if (idMap.containsKey(carriedId)) {</span>
<span class="nc" id="L30016">                    Entity newCarried = game.getEntity(idMap.get(carriedId));</span>
<span class="nc bnc" id="L30017" title="All 2 branches missed.">                    if (carrier.canLoad(newCarried, false)) {</span>
<span class="nc" id="L30018">                        carrier.load(newCarried, false, bay);</span>
<span class="nc" id="L30019">                        newCarried.setTransportId(carrier.getId());</span>
                        // Remember that the carried unit should not be treated again below
<span class="nc" id="L30021">                        transportCorrected.add(newCarried);</span>
                    }
                }
<span class="nc" id="L30024">            }</span>
<span class="nc" id="L30025">        }</span>

        // Now restore the transport settings from the entities' transporter IDs
        // With anything other than bays, MULs only show the carrier, not the carried units 
<span class="nc bnc" id="L30029" title="All 2 branches missed.">        for (final Entity entity: entities) {</span>
            // Don't correct those that are already corrected
<span class="nc bnc" id="L30031" title="All 2 branches missed.">            if (transportCorrected.contains(entity)) {</span>
<span class="nc" id="L30032">                continue;</span>
            }
            // Get the original (client side) ID of the transporter
<span class="nc" id="L30035">            int origTrsp = entity.getTransportId();</span>
            // Only act if the unit thinks it is transported
<span class="nc bnc" id="L30037" title="All 2 branches missed.">            if (origTrsp != Entity.NONE) {</span>
                // If the transporter is among the new units, go on with loading 
<span class="nc bnc" id="L30039" title="All 2 branches missed.">                if (idMap.containsKey(origTrsp)) {</span>
                    // The wrong transporter doesn't know of anything and does not need an update
<span class="nc" id="L30041">                    Entity carrier = game.getEntity(idMap.get(origTrsp)); </span>
<span class="nc bnc" id="L30042" title="All 2 branches missed.">                    if (carrier.canLoad(entity, false)) {</span>
                        // The correct transporter must be told it's carrying something and
                        // the carried unit must be told where it is embarked
<span class="nc" id="L30045">                        carrier.load(entity, false);</span>
<span class="nc" id="L30046">                        entity.setTransportId(idMap.get(origTrsp));</span>
                    } else {
                        // This seems to be an invalid carrier; update the entity accordingly
<span class="nc" id="L30049">                        entity.setTransportId(Entity.NONE);</span>
                    }
<span class="nc" id="L30051">                } else {</span>
                    // this transporter does not exist; update the entity accordingly
<span class="nc" id="L30053">                    entity.setTransportId(Entity.NONE);</span>
                }
            }
<span class="nc" id="L30056">        }</span>
        
        // Set the &quot;loaded keepers&quot; which is apparently used for deployment unloading to
        // differentiate between units loaded in the lobby and other carried units
        // When entering a game from the lobby, this list is generated again, but not when 
        // the added entities are loaded during a game. When getting loaded units from a MUL,
        // act as if they were loaded in the lobby.
<span class="nc bnc" id="L30063" title="All 2 branches missed.">        for (final Entity entity: entities) {</span>
<span class="nc bnc" id="L30064" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L30065">                Vector&lt;Integer&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L30066" title="All 2 branches missed.">                for (Entity en : entity.getLoadedUnits()) {</span>
<span class="nc" id="L30067">                    v.add(en.getId());</span>
<span class="nc" id="L30068">                }</span>
<span class="nc" id="L30069">                entity.setLoadedKeepers(v);</span>
            }
<span class="nc" id="L30071">        }</span>

<span class="nc" id="L30073">        send(createAddEntityPacket(entityIds));</span>
<span class="nc" id="L30074">    }</span>

    /**
     * adds a squadron to the game
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveSquadronAdd(Packet c, int connIndex) {

<span class="nc" id="L30084">        final FighterSquadron fs = (FighterSquadron) c.getObject(0);</span>
<span class="nc" id="L30085">        final Vector&lt;Integer&gt; fighters = (Vector&lt;Integer&gt;) c.getObject(1);</span>
<span class="nc bnc" id="L30086" title="All 2 branches missed.">        if (fighters.size() &lt; 1) {</span>
<span class="nc" id="L30087">            return;</span>
        }
        // fs.setOwner(fighters.firstElement().getOwner());
        // Only assign an entity ID when the client hasn't.
<span class="nc bnc" id="L30091" title="All 2 branches missed.">        if (Entity.NONE == fs.getId()) {</span>
<span class="nc" id="L30092">            fs.setId(getFreeEntityId());</span>
        }
<span class="nc" id="L30094">        game.addEntity(fs);</span>
<span class="nc bnc" id="L30095" title="All 2 branches missed.">        for (int id : fighters) {</span>
<span class="nc" id="L30096">            Entity fighter = game.getEntity(id);</span>
<span class="nc bnc" id="L30097" title="All 2 branches missed.">            if (null != fighter) {</span>
<span class="nc" id="L30098">                fs.load(fighter, false);</span>
<span class="nc" id="L30099">                fs.autoSetMaxBombPoints();</span>
<span class="nc" id="L30100">                fighter.setTransportId(fs.getId());</span>
                // If this is the lounge, we want to configure bombs
<span class="nc bnc" id="L30102" title="All 2 branches missed.">                if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30103">                    ((IBomber)fighter).setBombChoices(fs.getBombChoices());</span>
                }
<span class="nc" id="L30105">                entityUpdate(fighter.getId());</span>
            }
<span class="nc" id="L30107">        }</span>
<span class="nc" id="L30108">        send(createAddEntityPacket(fs.getId()));</span>

<span class="nc" id="L30110">    }</span>

    /**
     * Updates an entity with the info from the client. Only valid to do this
     * during the lounge phase, except for heat sink changing.
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityUpdate(Packet c, int connIndex) {
<span class="nc" id="L30119">        Entity entity = (Entity) c.getObject(0);</span>
<span class="nc" id="L30120">        Entity oldEntity = game.getEntity(entity.getId());</span>
<span class="nc bnc" id="L30121" title="All 2 branches missed.">        if ((oldEntity != null)</span>
<span class="nc bnc" id="L30122" title="All 2 branches missed.">                &amp;&amp; ((oldEntity.getOwner() == getPlayer(connIndex)) || (oldEntity</span>
<span class="nc bnc" id="L30123" title="All 2 branches missed.">                        .getOwner().getTeam() == getPlayer(connIndex).getTeam()))) {</span>
<span class="nc" id="L30124">            game.setEntity(entity.getId(), entity);</span>
<span class="nc" id="L30125">            entityUpdate(entity.getId());</span>
            // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30127" title="All 2 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30128">                StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L30129" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) {</span>
<span class="nc" id="L30130">                    message.append(&quot;A Unit &quot;);</span>
<span class="nc" id="L30131">                    message.append('(').append(entity.getOwner().getName()).append(')');</span>
<span class="nc bnc" id="L30132" title="All 2 branches missed.">                } else if (game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP)) {</span>
<span class="nc" id="L30133">                    message.append(&quot;Unit &quot;);</span>
<span class="nc bnc" id="L30134" title="All 2 branches missed.">                    if (!entity.getExternalIdAsString().equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L30135">                        message.append('[')</span>
<span class="nc" id="L30136">                               .append(entity.getExternalIdAsString())</span>
<span class="nc" id="L30137">                               .append(&quot;] &quot;);</span>
                    }
<span class="nc" id="L30139">                    message.append(entity.getId()).append(&quot; (&quot;)</span>
<span class="nc" id="L30140">                           .append(entity.getOwner().getName()).append(')');</span>
                } else {
<span class="nc" id="L30142">                    message.append(&quot;Unit &quot;);</span>
<span class="nc" id="L30143">                    message.append(entity.getDisplayName());</span>
                }
<span class="nc" id="L30145">                message.append(&quot; has been customized.&quot;);</span>
<span class="nc" id="L30146">                sendServerChat(message.toString());</span>
            }
        }
<span class="nc" id="L30149">    }</span>

    /**
     * loads an entity into another one. Meant to be called from the chat lounge
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityLoad(Packet c, int connIndex) {
<span class="nc" id="L30157">        int loadeeId = (Integer) c.getObject(0);</span>
<span class="nc" id="L30158">        int loaderId = (Integer) c.getObject(1);</span>
<span class="nc" id="L30159">        int bayNumber = (Integer) c.getObject(2);</span>
<span class="nc" id="L30160">        Entity loadee = game.getEntity(loadeeId);</span>
<span class="nc" id="L30161">        Entity loader = game.getEntity(loaderId);</span>

<span class="nc bnc" id="L30163" title="All 4 branches missed.">        if ((loadee != null) &amp;&amp; (loader != null)) {</span>
<span class="nc" id="L30164">            loadUnit(loader, loadee, bayNumber);</span>
            // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30166" title="All 2 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
                /*
                 * StringBuffer message = new StringBuffer();
                 * message.append(&quot;Unit &quot;); if
                 * (game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) ||
                 * game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) { if
                 * (!entity.getExternalIdAsString().equals(&quot;-1&quot;)) {
                 * message.append('[') .append(entity.getExternalIdAsString())
                 * .append(&quot;] &quot;); } message.append(entity.getId()).append('(')
                 * .append(entity.getOwner().getName()).append(')'); } else {
                 * message.append(entity.getDisplayName()); }
                 * message.append(&quot; has been customized.&quot;);
                 * sendServerChat(message.toString());
                 */
                // Set this so units can be unloaded in the first movement phase
<span class="nc" id="L30181">                loadee.setLoadedThisTurn(false);</span>
            }
        }
<span class="nc" id="L30184">    }</span>

    /**
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveCustomInit(Packet c, int connIndex) {
        // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30193" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30194">            IPlayer p = (IPlayer) c.getObject(0);</span>
<span class="nc" id="L30195">            sendServerChat(&quot;&quot; + p.getName() + &quot; has customized initiative.&quot;);</span>
        }
<span class="nc" id="L30197">    }</span>

    /**
     * receive and process an entity mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityModeChange(Packet c, int connIndex) {
<span class="nc" id="L30206">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30207">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30208">        int mode = c.getIntValue(2);</span>
<span class="nc" id="L30209">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30210" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30211">            return;</span>
        }
<span class="nc" id="L30213">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30215" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30216">            return;</span>
        }

        try {
            // Check for BA dumping body mounted missile launchers
<span class="nc bnc" id="L30221" title="All 4 branches missed.">            if ((e instanceof BattleArmor) &amp;&amp; (!m.isMissing())</span>
<span class="nc bnc" id="L30222" title="All 2 branches missed.">                    &amp;&amp; m.isBodyMounted()</span>
<span class="nc bnc" id="L30223" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L30224" title="All 2 branches missed.">                    &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L30225" title="All 4 branches missed.">                    &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)</span>
                    &amp;&amp; (mode &lt;= 0)) {
<span class="nc bnc" id="L30227" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
            // a mode change for ammo means dumping or hot loading
<span class="nc bnc" id="L30229" title="All 2 branches missed.">            } else if ((m.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L30230" title="All 6 branches missed.">                &amp;&amp; !m.getType().hasInstantModeSwitch() &amp;&amp; (mode &lt; 0</span>
<span class="nc bnc" id="L30231" title="All 2 branches missed.">                            || mode == 0 &amp;&amp; m.isPendingDump())) {</span>
<span class="nc bnc" id="L30232" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
<span class="nc bnc" id="L30233" title="All 6 branches missed.">            } else if ((m.getType() instanceof WeaponType) &amp;&amp; m.isDWPMounted()</span>
                       &amp;&amp; (mode &lt;= 0)) {
<span class="nc bnc" id="L30235" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
            } else {
<span class="nc bnc" id="L30237" title="All 2 branches missed.">                if (!m.setMode(mode)) {</span>
<span class="nc" id="L30238">                    String message = e.getShortName() + &quot;: &quot; + m.getName() + &quot;: &quot; + e.getLocationName(m.getLocation())</span>
                            + &quot; trying to compensate&quot;;
<span class="nc" id="L30240">                    MegaMek.getLogger().error(message);</span>
<span class="nc" id="L30241">                    sendServerChat(message);</span>
<span class="nc" id="L30242">                    e.setGameOptions();</span>

<span class="nc bnc" id="L30244" title="All 2 branches missed.">                    if (!m.setMode(mode)) {</span>
<span class="nc" id="L30245">                        message = e.getShortName() + &quot;: &quot; + m.getName() + &quot;: &quot; + e.getLocationName(m.getLocation())</span>
                                + &quot; unable to compensate&quot;;
<span class="nc" id="L30247">                        MegaMek.getLogger().error(message);</span>
<span class="nc" id="L30248">                        sendServerChat(message);</span>
                    }

                }
            }
<span class="nc" id="L30253">        } catch (Exception ex) {</span>
<span class="nc" id="L30254">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L30255">        }</span>

<span class="nc" id="L30257">    }</span>

    /**
     * Receive and process an Entity Sensor Change Packet
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySensorChange(Packet c, int connIndex) {
<span class="nc" id="L30265">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30266">        int sensorId = c.getIntValue(1);</span>
<span class="nc" id="L30267">        Entity e = game.getEntity(entityId);</span>
<span class="nc" id="L30268">        e.setNextSensor(e.getSensors().elementAt(sensorId));</span>
<span class="nc" id="L30269">    }</span>

    /**
     * Receive and process an Entity Heat Sinks Change Packet
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySinksChange(Packet c, int connIndex) {
<span class="nc" id="L30277">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30278">        int numSinks = c.getIntValue(1);</span>
<span class="nc" id="L30279">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30280" title="All 4 branches missed.">        if ((e instanceof Mech) &amp;&amp; (connIndex == e.getOwnerId())) {</span>
<span class="nc" id="L30281">            ((Mech)e).setActiveSinksNextRound(numSinks);</span>
        }
<span class="nc" id="L30283">    }</span>

    /**
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityActivateHidden(Packet c, int connIndex) {
<span class="nc" id="L30291">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30292">        IGame.Phase phase = (IGame.Phase)c.getObject(1);</span>
<span class="nc" id="L30293">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30294" title="All 2 branches missed.">        if (connIndex != e.getOwnerId()) {</span>
<span class="nc" id="L30295">            MegaMek.getLogger().error(&quot;Player &quot; + connIndex </span>
<span class="nc" id="L30296">                    + &quot; tried to activate a hidden unit owned by Player &quot; + e.getOwnerId());</span>
<span class="nc" id="L30297">            return;</span>
        }
<span class="nc" id="L30299">        e.setHiddeActivationPhase(phase);</span>
<span class="nc" id="L30300">        entityUpdate(entityId);</span>
<span class="nc" id="L30301">    }</span>


    /**
     * receive and process an entity nova network mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityNovaNetworkModeChange(Packet c, int connIndex) {

        try {
<span class="nc" id="L30313">            int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30314">            String networkID = c.getObject(1).toString();</span>
<span class="nc" id="L30315">            Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30316" title="All 2 branches missed.">            if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30317">                return;</span>
            }
            // FIXME: Greg: This can result in setting the network to link to
            // hostile units.
            // However, it should be caught by both the isMemberOfNetwork test
            // from the c3 module as well as
            // by the clients possible input.
<span class="nc" id="L30324">            e.setNewRoundNovaNetworkString(networkID);</span>
<span class="nc" id="L30325">        } catch (Exception ex) {</span>
<span class="nc" id="L30326">            ex.printStackTrace();</span>
<span class="nc" id="L30327">        }</span>

<span class="nc" id="L30329">    }</span>

    /**
     * receive and process an entity mounted facing change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityMountedFacingChange(Packet c, int connIndex) {
<span class="nc" id="L30338">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30339">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30340">        int facing = c.getIntValue(2);</span>
<span class="nc" id="L30341">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30342" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30343">            return;</span>
        }
<span class="nc" id="L30345">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30347" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30348">            return;</span>
        }
<span class="nc" id="L30350">        m.setFacing(facing);</span>
<span class="nc" id="L30351">    }</span>

    /**
     * receive and process an entity mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityCalledShotChange(Packet c, int connIndex) {
<span class="nc" id="L30360">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30361">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30362">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30363" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30364">            return;</span>
        }
<span class="nc" id="L30366">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30368" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30369">            return;</span>
        }
<span class="nc" id="L30371">        m.getCalledShot().switchCalledShot();</span>
<span class="nc" id="L30372">    }</span>

    /**
     * receive and process an entity system mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySystemModeChange(Packet c, int connIndex) {
<span class="nc" id="L30381">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30382">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30383">        int mode = c.getIntValue(2);</span>
<span class="nc" id="L30384">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30385" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30386">            return;</span>
        }
<span class="nc bnc" id="L30388" title="All 4 branches missed.">        if ((e instanceof Mech) &amp;&amp; (equipId == Mech.SYSTEM_COCKPIT)) {</span>
<span class="nc" id="L30389">            ((Mech) e).setCockpitStatus(mode);</span>
        }
<span class="nc" id="L30391">    }</span>

    /**
     * Receive a packet that contains an Entity ammo change
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityAmmoChange(Packet c, int connIndex) {
<span class="nc" id="L30400">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30401">        int weaponId = c.getIntValue(1);</span>
<span class="nc" id="L30402">        int ammoId = c.getIntValue(2);</span>
<span class="nc" id="L30403">        Entity e = game.getEntity(entityId);</span>

        // Did we receive a request for a valid Entity?
<span class="nc bnc" id="L30406" title="All 2 branches missed.">        if (null == e) {</span>
<span class="nc" id="L30407">            MegaMek.getLogger().error(&quot;Could not find entity# &quot; + entityId);</span>
<span class="nc" id="L30408">            return;</span>
        }
<span class="nc" id="L30410">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30411" title="All 4 branches missed.">        if ((null != player) &amp;&amp; (e.getOwner() != player)) {</span>
<span class="nc" id="L30412">            MegaMek.getLogger().error(&quot;Player &quot; + player.getName() + &quot; does not own the entity &quot; + e.getDisplayName());</span>
<span class="nc" id="L30413">            return;</span>
        }

        // Make sure that the entity has the given equipment.
<span class="nc" id="L30417">        Mounted mWeap = e.getEquipment(weaponId);</span>
<span class="nc" id="L30418">        Mounted mAmmo = e.getEquipment(ammoId);</span>
<span class="nc bnc" id="L30419" title="All 2 branches missed.">        if (null == mAmmo) {</span>
<span class="nc" id="L30420">            MegaMek.getLogger().error(&quot;Entity &quot; + e.getDisplayName() + &quot; does not have ammo #&quot; + ammoId);</span>
<span class="nc" id="L30421">            return;</span>
        }
<span class="nc bnc" id="L30423" title="All 2 branches missed.">        if (!(mAmmo.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L30424">            MegaMek.getLogger().error(&quot;Item #&quot; + ammoId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30425">                    + &quot; is a &quot; + mAmmo.getName() + &quot; and not ammo.&quot;);</span>
<span class="nc" id="L30426">            return;</span>
        }
<span class="nc bnc" id="L30428" title="All 2 branches missed.">        if (null == mWeap) {</span>
<span class="nc" id="L30429">            MegaMek.getLogger().error(&quot;Entity &quot; + e.getDisplayName() + &quot; does not have weapon #&quot; + weaponId);</span>
<span class="nc" id="L30430">            return;</span>
        }
<span class="nc bnc" id="L30432" title="All 2 branches missed.">        if (!(mWeap.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L30433">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30434">                    + &quot; is a &quot; + mWeap.getName() + &quot; and not a weapon.&quot;);</span>
<span class="nc" id="L30435">            return;</span>
        }
<span class="nc bnc" id="L30437" title="All 2 branches missed.">        if (((WeaponType) mWeap.getType()).getAmmoType() == AmmoType.T_NA) {</span>
<span class="nc" id="L30438">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30439">                    + &quot; is a &quot; + mWeap.getName() + &quot; and does not use ammo.&quot;);</span>
<span class="nc" id="L30440">            return;</span>
        }
<span class="nc bnc" id="L30442" title="All 2 branches missed.">        if (mWeap.getType().hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L30443" title="All 2 branches missed.">                &amp;&amp; !mWeap.getType().hasFlag(WeaponType.F_DOUBLE_ONESHOT)) {</span>
<span class="nc" id="L30444">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30445">                    + &quot; is a &quot; + mWeap.getName() + &quot; and cannot use external ammo.&quot;);</span>
<span class="nc" id="L30446">            return;</span>
        }

        // Load the weapon.
<span class="nc" id="L30450">        e.loadWeapon(mWeap, mAmmo);</span>
<span class="nc" id="L30451">    }</span>

    /**
     * Deletes an entity owned by a certain player from the list
     */
    private void receiveEntityDelete(Packet c, int connIndex) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L30458">        List&lt;Integer&gt; ids = (List&lt;Integer&gt;) c.getObject(0);</span>
<span class="nc bnc" id="L30459" title="All 2 branches missed.">        for (Integer entityId : ids) {</span>
<span class="nc" id="L30460">            final Entity entity = game.getEntity(entityId);</span>

            // Only allow players to delete their *own* entities.
<span class="nc bnc" id="L30463" title="All 4 branches missed.">            if ((entity != null) &amp;&amp; (entity.getOwner() == getPlayer(connIndex))) {</span>

                // If we're deleting a ProtoMech, recalculate unit numbers.
<span class="nc bnc" id="L30466" title="All 2 branches missed.">                if (entity instanceof Protomech) {</span>

                    // How many ProtoMechs does the player have (include this one)?
<span class="nc" id="L30469">                    int numPlayerProtos = game.getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L30470">                        private final int ownerId = entity.getOwnerId();</span>

                        public boolean accept(Entity entity) {
<span class="nc bnc" id="L30473" title="All 4 branches missed.">                            return (entity instanceof Protomech) &amp;&amp; (ownerId == entity.getOwnerId());</span>
                        }
                    });

                    // According to page 54 of the BMRr, ProtoMechs must be
                    // deployed in full Points of five, unless &quot;losses&quot; have
                    // reduced the number to less than that.
<span class="nc" id="L30480">                    final char oldMax = (char) (Math.ceil(numPlayerProtos / 5.0) - 1);</span>
<span class="nc" id="L30481">                    char newMax = (char) (Math.ceil((numPlayerProtos - 1) / 5.0) - 1);</span>
<span class="nc" id="L30482">                    short deletedUnitNum = entity.getUnitNumber();</span>

                    // Do we have to update a ProtoMech from the last unit?
<span class="nc bnc" id="L30485" title="All 4 branches missed.">                    if ((oldMax != deletedUnitNum) &amp;&amp; (oldMax != newMax)) {</span>

                        // Yup. Find a ProtoMech from the last unit, and
                        // set it's unit number to the deleted entity.
<span class="nc" id="L30489">                        Iterator&lt;Entity&gt; lastUnit =</span>
<span class="nc" id="L30490">                                game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L30491">                                    private final int ownerId = entity.getOwnerId();</span>

<span class="nc" id="L30493">                                    private final char lastUnitNum = oldMax;</span>

                                    public boolean accept(Entity entity) {
<span class="nc bnc" id="L30496" title="All 2 branches missed.">                                        return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L30497" title="All 2 branches missed.">                                                &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L30498" title="All 2 branches missed.">                                                &amp;&amp; (lastUnitNum == entity.getUnitNumber());</span>
                                    }
                                });
<span class="nc" id="L30501">                        Entity lastUnitMember = lastUnit.next();</span>
<span class="nc" id="L30502">                        lastUnitMember.setUnitNumber(deletedUnitNum);</span>
<span class="nc" id="L30503">                        entityUpdate(lastUnitMember.getId());</span>
                    } // End update-unit-number
                } // End added-ProtoMech

<span class="nc bnc" id="L30507" title="All 2 branches missed.">                if (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT) {</span>
                    // if a unit is removed during deployment just keep going
                    // without adjusting the turn vector.
<span class="nc" id="L30510">                    game.removeTurnFor(entity);</span>
<span class="nc" id="L30511">                    game.removeEntity(entityId, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
                }
            }
<span class="nc" id="L30514">        }</span>

        // during deployment this absolutely must be called before game.removeEntity(), otherwise the game hangs
        // when a unit is removed. Cause unknown.
<span class="nc" id="L30518">        send(createRemoveEntityPacket(ids, IEntityRemovalConditions.REMOVE_NEVER_JOINED));</span>

        // Prevents deployment hanging. Only do this during deployment.
<span class="nc bnc" id="L30521" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc bnc" id="L30522" title="All 2 branches missed.">            for (Integer entityId : ids) {</span>
<span class="nc" id="L30523">                final Entity entity = game.getEntity(entityId);</span>
<span class="nc" id="L30524">                game.removeEntity(entityId, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
<span class="nc" id="L30525">                endCurrentTurn(entity);</span>
<span class="nc" id="L30526">            }</span>
        }
<span class="nc" id="L30528">    }</span>

    /**
     * Sets a player's ready status
     */
    private void receivePlayerDone(Packet pkt, int connIndex) {
<span class="nc" id="L30534">        boolean ready = pkt.getBooleanValue(0);</span>
<span class="nc" id="L30535">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30536" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L30537">            player.setDone(ready);</span>
        }
<span class="nc" id="L30539">    }</span>

    private void receiveInitiativeRerollRequest(Packet pkt, int connIndex) {
<span class="nc" id="L30542">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30543" title="All 2 branches missed.">        if (IGame.Phase.PHASE_INITIATIVE_REPORT != game.getPhase()) {</span>
<span class="nc" id="L30544">            StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L30545" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L30546">                message.append(&quot;Player #&quot;).append(connIndex);</span>
            } else {
<span class="nc" id="L30548">                message.append(player.getName());</span>
            }
<span class="nc" id="L30550">            message.append(&quot; is not allowed to ask for a reroll at this time.&quot;);</span>
<span class="nc" id="L30551">            MegaMek.getLogger().error(message.toString());</span>
<span class="nc" id="L30552">            sendServerChat(message.toString());</span>
<span class="nc" id="L30553">            return;</span>
        }
<span class="nc bnc" id="L30555" title="All 2 branches missed.">        if (game.hasTacticalGenius(player)) {</span>
<span class="nc" id="L30556">            game.addInitiativeRerollRequest(game.getTeamForPlayer(player));</span>
        }
<span class="nc bnc" id="L30558" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L30559">            player.setDone(true);</span>
        }
<span class="nc" id="L30561">        checkReady();</span>
<span class="nc" id="L30562">    }</span>

    /**
     * Sets game options, providing that the player has specified the password
     * correctly.
     *
     * @return true if any options have been successfully changed.
     */
    private boolean receiveGameOptions(Packet packet, int connId) {
<span class="nc" id="L30571">        IPlayer player = game.getPlayer(connId);</span>
        // Check player
<span class="nc bnc" id="L30573" title="All 2 branches missed.">        if (null == player) {</span>
<span class="nc" id="L30574">            MegaMek.getLogger().error(&quot;Server does not recognize player at connection &quot; + connId);</span>
<span class="nc" id="L30575">            return false;</span>
        }

        // check password
<span class="nc bnc" id="L30579" title="All 6 branches missed.">        if ((password != null) &amp;&amp; (password.length() &gt; 0) &amp;&amp; !password.equals(packet.getObject(0))) {</span>
<span class="nc" id="L30580">            sendServerChat(connId, &quot;The password you specified to change game options is incorrect.&quot;);</span>
<span class="nc" id="L30581">            return false;</span>
        }

<span class="nc bnc" id="L30584" title="All 2 branches missed.">        if (game.getPhase().isDuringOrAfter(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L30585">            return false;</span>
        }

<span class="nc" id="L30588">        int changed = 0;</span>

<span class="nc bnc" id="L30590" title="All 2 branches missed.">        for (Enumeration&lt;?&gt; i = ((Vector&lt;?&gt;) packet.getObject(1)).elements(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30591">            IBasicOption option = (IBasicOption) i.nextElement();</span>
<span class="nc" id="L30592">            IOption originalOption = game.getOptions().getOption(option.getName());</span>

<span class="nc bnc" id="L30594" title="All 2 branches missed.">            if (originalOption == null) {</span>
<span class="nc" id="L30595">                continue;</span>
            }

<span class="nc" id="L30598">            String message = &quot;Player &quot; + player.getName() + &quot; changed option \&quot;&quot; +</span>
<span class="nc" id="L30599">                    originalOption.getDisplayableName() + &quot;\&quot; to &quot; + option.getValue().toString() + '.';</span>
<span class="nc" id="L30600">            sendServerChat(message);</span>
<span class="nc" id="L30601">            originalOption.setValue(option.getValue());</span>
<span class="nc" id="L30602">            changed++;</span>
<span class="nc" id="L30603">        }</span>

        // Set proper RNG
<span class="nc" id="L30606">        Compute.setRNG(game.getOptions().intOption(OptionsConstants.BASE_RNG_TYPE));</span>

<span class="nc bnc" id="L30608" title="All 2 branches missed.">        if (changed &gt; 0) {</span>
<span class="nc bnc" id="L30609" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector()) {</span>
<span class="nc" id="L30610">                en.setGameOptions();</span>
<span class="nc" id="L30611">            }</span>
<span class="nc" id="L30612">            entityAllUpdate();</span>
<span class="nc" id="L30613">            return true;</span>
        }
<span class="nc" id="L30615">        return false;</span>
    }

    /**
     * Performs the additional processing of the received options after the the
     * &lt;code&gt;receiveGameOptions&lt;code&gt; done its job; should be called after
     * &lt;code&gt;receiveGameOptions&lt;code&gt; only if the &lt;code&gt;receiveGameOptions&lt;code&gt;
     * returned &lt;code&gt;true&lt;/code&gt;
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveGameOptionsAux(Packet packet, int connId) {
<span class="nc bnc" id="L30628" title="All 2 branches missed.">        for (Enumeration&lt;?&gt; i = ((Vector&lt;?&gt;) packet.getObject(1)).elements(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30629">            IBasicOption option = (IBasicOption) i.nextElement();</span>
<span class="nc" id="L30630">            IOption originalOption = game.getOptions().getOption(option.getName());</span>
<span class="nc bnc" id="L30631" title="All 2 branches missed.">            if (originalOption != null) {</span>
<span class="nc bnc" id="L30632" title="All 2 branches missed.">                if (&quot;maps_include_subdir&quot;.equals(originalOption.getName())) {</span>
<span class="nc" id="L30633">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L30634">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L30635">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L30636">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L30637">                    send(createMapSettingsPacket());</span>
                }
            }
<span class="nc" id="L30640">        }</span>

<span class="nc" id="L30642">    }</span>

    /**
     * Sends out the game victory event to all connections
     */
    private void transmitGameVictoryEventToAll() {
<span class="nc bnc" id="L30648" title="All 2 branches missed.">        for (IConnection conn : connections) {</span>
<span class="nc" id="L30649">            send(conn.getId(), new Packet(Packet.COMMAND_GAME_VICTORY_EVENT));</span>
<span class="nc" id="L30650">        }</span>
<span class="nc" id="L30651">    }</span>

    /**
     * Sends out all player info to the specified connection
     */
    private void transmitAllPlayerConnects(int connId) {
<span class="nc bnc" id="L30657" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30658">            final IPlayer player = i.nextElement();</span>

<span class="nc" id="L30660">            send(connId, createPlayerConnectPacket(player.getId()));</span>
<span class="nc" id="L30661">        }</span>
<span class="nc" id="L30662">    }</span>

    /**
     * Creates a packet informing that the player has connected
     */
    private Packet createPlayerConnectPacket(int playerId) {
<span class="nc" id="L30668">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30669">        data[0] = playerId;</span>
<span class="nc" id="L30670">        data[1] = getPlayer(playerId);</span>
<span class="nc" id="L30671">        return new Packet(Packet.COMMAND_PLAYER_ADD, data);</span>
    }

    /**
     * Creates a packet containing the player info, for update
     */
    private Packet createPlayerUpdatePacket(int playerId) {
<span class="nc" id="L30678">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30679">        data[0] = playerId;</span>
<span class="nc" id="L30680">        data[1] = getPlayer(playerId);</span>
<span class="nc" id="L30681">        return new Packet(Packet.COMMAND_PLAYER_UPDATE, data);</span>
    }

    /**
     * Sends out the player info updates for all players to all connections
     */
    private void transmitAllPlayerUpdates() {
<span class="nc bnc" id="L30688" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30689">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L30690" title="All 2 branches missed.">            if (null != player) {</span>
<span class="nc" id="L30691">                send(createPlayerUpdatePacket(player.getId()));</span>
            }
<span class="nc" id="L30693">        }</span>
<span class="nc" id="L30694">    }</span>

    /**
     * Sends out the player ready stats for all players to all connections
     */
    private void transmitAllPlayerDones() {
<span class="nc bnc" id="L30700" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30701">            final IPlayer player = i.nextElement();</span>

<span class="nc" id="L30703">            send(createPlayerDonePacket(player.getId()));</span>
<span class="nc" id="L30704">        }</span>
<span class="nc" id="L30705">    }</span>

    /**
     * Creates a packet containing the player ready status
     */
    private Packet createPlayerDonePacket(int playerId) {
<span class="nc" id="L30711">        Object[] data = new Object[2];</span>
<span class="nc" id="L30712">        data[0] = playerId;</span>
<span class="nc" id="L30713">        data[1] = getPlayer(playerId).isDone();</span>
<span class="nc" id="L30714">        return new Packet(Packet.COMMAND_PLAYER_READY, data);</span>
    }

    /**
     * Creates a packet containing the current turn vector
     */
    private Packet createTurnVectorPacket() {
<span class="nc" id="L30721">        return new Packet(Packet.COMMAND_SENDING_TURNS, game.getTurnVector());</span>
    }

    /**
     * Creates a packet containing the current turn index
     */
    private Packet createTurnIndexPacket(int playerId) {
<span class="nc" id="L30728">        final Object[] data = new Object[3];</span>
<span class="nc" id="L30729">        data[0] = game.getTurnIndex();</span>
<span class="nc" id="L30730">        data[1] = playerId;</span>
<span class="nc" id="L30731">        return new Packet(Packet.COMMAND_TURN, data);</span>
    }

    /**
     * Creates a packet containing the map settings
     */
    private Packet createMapSettingsPacket() {
<span class="nc" id="L30738">        return new Packet(Packet.COMMAND_SENDING_MAP_SETTINGS, mapSettings);</span>
    }

    private Packet createMapSizesPacket() {
<span class="nc" id="L30742">        Set&lt;BoardDimensions&gt; sizes = getBoardSizes();</span>
<span class="nc" id="L30743">        return new Packet(Packet.COMMAND_SENDING_AVAILABLE_MAP_SIZES, sizes);</span>
    }

    /**
     * Creates a packet containing the planetary conditions
     */
    private Packet createPlanetaryConditionsPacket() {
<span class="nc" id="L30750">        return new Packet(Packet.COMMAND_SENDING_PLANETARY_CONDITIONS,</span>
<span class="nc" id="L30751">                          game.getPlanetaryConditions());</span>
    }

    /**
     * Creates a packet containing the game settings
     */
    private Packet createGameSettingsPacket() {
<span class="nc" id="L30758">        return new Packet(Packet.COMMAND_SENDING_GAME_SETTINGS, game.getOptions());</span>
    }

    /**
     * Creates a packet containing the game board
     */
    private Packet createBoardPacket() {
<span class="nc" id="L30765">        return new Packet(Packet.COMMAND_SENDING_BOARD, game.getBoard());</span>
    }

    /**
     * Creates a packet containing a single entity, for update
     */
    private Packet createEntityPacket(int entityId, Vector&lt;UnitLocation&gt; movePath) {
<span class="nc" id="L30772">        final Entity entity = game.getEntity(entityId);</span>
<span class="nc" id="L30773">        final Object[] data = new Object[3];</span>
<span class="nc" id="L30774">        data[0] = entityId;</span>
<span class="nc" id="L30775">        data[1] = entity;</span>
<span class="nc" id="L30776">        data[2] = movePath;</span>
<span class="nc" id="L30777">        return new Packet(Packet.COMMAND_ENTITY_UPDATE, data);</span>
    }

    /**
     * Creates a packet containing a Vector of Reports
     */
    private Packet createReportPacket(IPlayer p) {
        // When the final report is created, MM sends a null player to create
        // the
        // report. This will handle that issue.
<span class="nc bnc" id="L30787" title="All 4 branches missed.">        if ((p == null) || !doBlind()) {</span>
<span class="nc" id="L30788">            return new Packet(Packet.COMMAND_SENDING_REPORTS, vPhaseReport);</span>
        }
<span class="nc" id="L30790">        return new Packet(Packet.COMMAND_SENDING_REPORTS, filterReportVector(vPhaseReport, p));</span>
    }

    /**
     * Creates a packet containing a Vector of special Reports which needs to be
     * sent during a phase that is not a report phase.
     */
    private Packet createSpecialReportPacket() {
<span class="nc" id="L30798">        return new Packet(Packet.COMMAND_SENDING_REPORTS_SPECIAL, vPhaseReport.clone());</span>
    }

    /**
     * Creates a packet containing a Vector of Reports that represent a Tactical
     * Genius re-roll request which needs to update a current phase's report.
     */
    private Packet createTacticalGeniusReportPacket() {
<span class="nc" id="L30806">        return new Packet(Packet.COMMAND_SENDING_REPORTS_TACTICAL_GENIUS, vPhaseReport.clone());</span>
    }

    /**
     * Creates a packet containing all the round reports
     */
    private Packet createAllReportsPacket(IPlayer p) {
<span class="nc" id="L30813">        return new Packet(Packet.COMMAND_SENDING_REPORTS_ALL,</span>
<span class="nc" id="L30814">                filterPastReports(game.getAllReports(), p));</span>
    }

    /**
     * Creates a packet containing all current entities
     */
    private Packet createEntitiesPacket() {
<span class="nc" id="L30821">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, game.getEntitiesVector());</span>
    }

    /**
     * Creates a packet containing all current and out-of-game entities
     */
    private Packet createFullEntitiesPacket() {
<span class="nc" id="L30828">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30829">        data[0] = game.getEntitiesVector();</span>
<span class="nc" id="L30830">        data[1] = game.getOutOfGameEntitiesVector();</span>
<span class="nc" id="L30831">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, data);</span>
    }

    /**
     * Creates a packet containing all entities visible to the player in a blind
     * game
     */
    private Packet createFilteredEntitiesPacket(IPlayer p, Map&lt;EntityTargetPair,
            LosEffects&gt; losCache) {
<span class="nc" id="L30840">        return new Packet(Packet.COMMAND_SENDING_ENTITIES,</span>
<span class="nc" id="L30841">                filterEntities(p, game.getEntitiesVector(), losCache));</span>
    }

    /**
     * Creates a packet containing all entities, including wrecks, visible to
     * the player in a blind game
     */
    private Packet createFilteredFullEntitiesPacket(IPlayer p) {
<span class="nc" id="L30849">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30850">        data[0] = filterEntities(p, game.getEntitiesVector(), null);</span>
<span class="nc" id="L30851">        data[1] = game.getOutOfGameEntitiesVector();</span>
<span class="nc" id="L30852">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, data);</span>
    }

    private Packet createAddEntityPacket(int entityId) {
<span class="nc" id="L30856">        ArrayList&lt;Integer&gt; entityIds = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L30857">        entityIds.add(entityId);</span>
<span class="nc" id="L30858">        return createAddEntityPacket(entityIds);</span>
    }

    /**
     * Creates a packet detailing the addition of an entity
     */
    private Packet createAddEntityPacket(List&lt;Integer&gt; entityIds) {
<span class="nc" id="L30865">        ArrayList&lt;Entity&gt; entities = new ArrayList&lt;&gt;(entityIds.size());</span>
<span class="nc bnc" id="L30866" title="All 2 branches missed.">        for (Integer id : entityIds) {</span>
<span class="nc" id="L30867">            entities.add(game.getEntity(id));</span>
<span class="nc" id="L30868">        }</span>
<span class="nc" id="L30869">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30870">        data[0] = entityIds;</span>
<span class="nc" id="L30871">        data[1] = entities;</span>
<span class="nc" id="L30872">        return new Packet(Packet.COMMAND_ENTITY_ADD, data);</span>
    }

    /**
     * Creates a packet detailing the removal of an entity. Maintained for
     * backwards compatibility.
     *
     * @param entityId - the &lt;code&gt;int&lt;/code&gt; ID of the entity being removed.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(int entityId) {
<span class="nc" id="L30883">        return createRemoveEntityPacket(entityId, IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
    }

    /**
     * Creates a packet detailing the removal of an entity.
     *
     * @param entityId  - the &lt;code&gt;int&lt;/code&gt; ID of the entity being removed.
     * @param condition - the &lt;code&gt;int&lt;/code&gt; condition the unit was in. This value
     *                  must be one of constants in
     *                  &lt;code&gt;IEntityRemovalConditions&lt;/code&gt;, or an
     *                  &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(int entityId, int condition) {
<span class="nc" id="L30897">        List&lt;Integer&gt; ids = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L30898">        ids.add(entityId);</span>
<span class="nc" id="L30899">        return createRemoveEntityPacket(ids, condition);</span>
    }

    /**
     * Creates a packet detailing the removal of a list of entities.
     *
     * @param entityIds - the &lt;code&gt;int&lt;/code&gt; ID of each entity being removed.
     * @param condition - the &lt;code&gt;int&lt;/code&gt; condition the units were in. This value
     *                  must be one of constants in
     *                  &lt;code&gt;IEntityRemovalConditions&lt;/code&gt;, or an
     *                  &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(List&lt;Integer&gt; entityIds, int condition) {
<span class="nc bnc" id="L30913" title="All 16 branches missed.">        if ((condition != IEntityRemovalConditions.REMOVE_UNKNOWN)</span>
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_IN_RETREAT)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_PUSHED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_SALVAGEABLE)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_EJECTED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_CAPTURED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_DEVASTATED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_NEVER_JOINED)) {
<span class="nc" id="L30921">            throw new IllegalArgumentException(&quot;Unknown unit condition: &quot; + condition);</span>
        }
<span class="nc" id="L30923">        Object[] array = new Object[2];</span>
<span class="nc" id="L30924">        array[0] = entityIds;</span>
<span class="nc" id="L30925">        array[1] = condition;</span>
<span class="nc" id="L30926">        return new Packet(Packet.COMMAND_ENTITY_REMOVE, array);</span>
    }

    /**
     * Creates a packet indicating end of game, including detailed unit status
     */
    private Packet createEndOfGamePacket() {
<span class="nc" id="L30933">        Object[] array = new Object[3];</span>
<span class="nc" id="L30934">        array[0] = getDetailedVictoryReport();</span>
<span class="nc" id="L30935">        array[1] = game.getVictoryPlayerId();</span>
<span class="nc" id="L30936">        array[2] = game.getVictoryTeam();</span>
<span class="nc" id="L30937">        return new Packet(Packet.COMMAND_END_OF_GAME, array);</span>
    }

<span class="fc" id="L30940">    public static String ORIGIN = &quot;***Server&quot;;</span>

    public static String formatChatMessage(String origin, String message) {
<span class="fc" id="L30943">        return origin + &quot;: &quot; + message;</span>
    }

    /**
     * Transmits a chat message to all players
     */
    public void sendChat(int connId, String origin, String message) {
<span class="nc" id="L30950">        send(connId, new Packet(Packet.COMMAND_CHAT, formatChatMessage(origin, message)));</span>
<span class="nc" id="L30951">    }</span>

    /**
     * Transmits a chat message to all players
     */
    private void sendChat(String origin, String message) {
<span class="nc" id="L30957">        String chat = formatChatMessage(origin, message);</span>
<span class="nc" id="L30958">        send(new Packet(Packet.COMMAND_CHAT, chat));</span>
<span class="nc" id="L30959">    }</span>

    public void sendServerChat(int connId, String message) {
<span class="nc" id="L30962">        sendChat(connId, ORIGIN, message);</span>
<span class="nc" id="L30963">    }</span>

    public void sendServerChat(String message) {
<span class="nc" id="L30966">        sendChat(ORIGIN, message);</span>
<span class="nc" id="L30967">    }</span>

    /**
     * Creates a packet containing a hex, and the coordinates it goes at.
     */
    private Packet createHexChangePacket(Coords coords, IHex hex) {
<span class="nc" id="L30973">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30974">        data[0] = coords;</span>
<span class="nc" id="L30975">        data[1] = hex;</span>
<span class="nc" id="L30976">        return new Packet(Packet.COMMAND_CHANGE_HEX, data);</span>
    }

    public void sendSmokeCloudAdded(SmokeCloud cloud) {
<span class="nc" id="L30980">        final Object[] data = new Object[1];</span>
<span class="nc" id="L30981">        data[0] = cloud;</span>
<span class="nc" id="L30982">        send(new Packet(Packet.COMMAND_ADD_SMOKE_CLOUD, data));</span>
<span class="nc" id="L30983">    }</span>

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedHex(Coords coords) {
<span class="nc" id="L30989">        send(createHexChangePacket(coords, game.getBoard().getHex(coords)));</span>
<span class="nc" id="L30990">    }</span>

    /**
     * Creates a packet containing a hex, and the coordinates it goes at.
     */
    private Packet createHexesChangePacket(Set&lt;Coords&gt; coords, Set&lt;IHex&gt; hex) {
<span class="nc" id="L30996">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30997">        data[0] = coords;</span>
<span class="nc" id="L30998">        data[1] = hex;</span>
<span class="nc" id="L30999">        return new Packet(Packet.COMMAND_CHANGE_HEXES, data);</span>
    }

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedHexes(Set&lt;Coords&gt; coords) {
<span class="nc" id="L31006">        Set&lt;IHex&gt; hexes = new LinkedHashSet&lt;&gt;();</span>
<span class="nc bnc" id="L31007" title="All 2 branches missed.">        for (Coords coord : coords) {</span>
<span class="nc" id="L31008">            hexes.add(game.getBoard().getHex(coord));</span>
<span class="nc" id="L31009">        }</span>
<span class="nc" id="L31010">        send(createHexesChangePacket(coords, hexes));</span>
<span class="nc" id="L31011">    }</span>

    /**
     * Creates a packet containing a vector of mines.
     */
    private Packet createMineChangePacket(Coords coords) {
<span class="nc" id="L31017">        return new Packet(Packet.COMMAND_UPDATE_MINEFIELDS, game.getMinefields(coords));</span>
    }

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedMines(Coords coords) {
<span class="nc" id="L31024">        send(createMineChangePacket(coords));</span>
<span class="nc" id="L31025">    }</span>

    public void sendVisibilityIndicator(Entity e) {
<span class="nc" id="L31028">        final Object[] data = new Object[6];</span>
<span class="nc" id="L31029">        data[0] = e.getId();</span>
<span class="nc" id="L31030">        data[1] = e.isEverSeenByEnemy();</span>
<span class="nc" id="L31031">        data[2] = e.isVisibleToEnemy();</span>
<span class="nc" id="L31032">        data[3] = e.isDetectedByEnemy();</span>
<span class="nc" id="L31033">        data[4] = e.getWhoCanSee();</span>
<span class="nc" id="L31034">        data[5] = e.getWhoCanDetect();</span>
<span class="nc" id="L31035">        send(new Packet(Packet.COMMAND_ENTITY_VISIBILITY_INDICATOR, data));</span>
<span class="nc" id="L31036">    }</span>

    /**
     * Creates a packet for an attack
     */
    private Packet createAttackPacket(List&lt;?&gt; vector, int charges) {
<span class="nc" id="L31042">        final Object[] data = new Object[2];</span>
<span class="nc" id="L31043">        data[0] = vector;</span>
<span class="nc" id="L31044">        data[1] = charges;</span>
<span class="nc" id="L31045">        return new Packet(Packet.COMMAND_ENTITY_ATTACK, data);</span>
    }

    /**
     * Creates a packet for an attack
     */
    private Packet createAttackPacket(EntityAction ea, int charge) {
<span class="nc" id="L31052">        Vector&lt;EntityAction&gt; vector = new Vector&lt;&gt;(1);</span>
<span class="nc" id="L31053">        vector.addElement(ea);</span>
<span class="nc" id="L31054">        Object[] data = new Object[2];</span>
<span class="nc" id="L31055">        data[0] = vector;</span>
<span class="nc" id="L31056">        data[1] = charge;</span>
<span class="nc" id="L31057">        return new Packet(Packet.COMMAND_ENTITY_ATTACK, data);</span>
    }

    /**
     *
     */
    private Packet createSpecialHexDisplayPacket(int toPlayer) {
<span class="nc" id="L31064">        Hashtable&lt;Coords, Collection&lt;SpecialHexDisplay&gt;&gt; shdTable = game</span>
<span class="nc" id="L31065">                .getBoard().getSpecialHexDisplayTable();</span>
<span class="nc" id="L31066">        Hashtable&lt;Coords, Collection&lt;SpecialHexDisplay&gt;&gt; shdTable2 = new Hashtable&lt;&gt;();</span>
        LinkedList&lt;SpecialHexDisplay&gt; tempList;
<span class="nc" id="L31068">        IPlayer player = getPlayer(toPlayer);</span>
<span class="nc bnc" id="L31069" title="All 2 branches missed.">        if (player != null) {</span>
<span class="nc bnc" id="L31070" title="All 2 branches missed.">            for (Coords coord : shdTable.keySet()) {</span>
<span class="nc" id="L31071">                tempList = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L31072" title="All 2 branches missed.">                for (SpecialHexDisplay shd : shdTable.get(coord)) {</span>
<span class="nc bnc" id="L31073" title="All 2 branches missed.">                    if (!shd.isObscured(player)) {</span>
<span class="nc" id="L31074">                        tempList.add(0, shd);</span>
                    }
<span class="nc" id="L31076">                }</span>
<span class="nc bnc" id="L31077" title="All 2 branches missed.">                if (!tempList.isEmpty()) {</span>
<span class="nc" id="L31078">                    shdTable2.put(coord, tempList);</span>
                }
<span class="nc" id="L31080">            }</span>
        }
<span class="nc" id="L31082">        return new Packet(Packet.COMMAND_SENDING_SPECIAL_HEX_DISPLAY, shdTable2);</span>
    }

    private Packet createTagInfoUpdatesPacket() {
<span class="nc" id="L31086">        return new Packet(Packet.COMMAND_SENDING_TAGINFO, game.getTagInfo());</span>
    }

    /**
     * Creates a packet containing off board artillery attacks
     */
    private Packet createArtilleryPacket(IPlayer p) {
<span class="nc" id="L31093">        Vector&lt;ArtilleryAttackAction&gt; v = new Vector&lt;&gt;();</span>
<span class="nc" id="L31094">        int team = p.getTeam();</span>
<span class="nc bnc" id="L31095" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; i = game.getAttacks(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L31096">            WeaponHandler wh = (WeaponHandler) i.nextElement();</span>
<span class="nc bnc" id="L31097" title="All 2 branches missed.">            if (wh.waa instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L31098">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc bnc" id="L31099" title="All 4 branches missed.">                if ((aaa.getPlayerId() == p.getId())</span>
                        || ((team != IPlayer.TEAM_NONE)
<span class="nc bnc" id="L31101" title="All 2 branches missed.">                        &amp;&amp; (team == game.getPlayer(aaa.getPlayerId()).getTeam()))</span>
<span class="nc bnc" id="L31102" title="All 2 branches missed.">                        || p.getSeeAll()) {</span>
<span class="nc" id="L31103">                    v.addElement(aaa);</span>
                }
            }
<span class="nc" id="L31106">        }</span>
<span class="nc" id="L31107">        return new Packet(Packet.COMMAND_SENDING_ARTILLERYATTACKS, v);</span>
    }

    private Packet createIlluminatedHexesPacket() {
<span class="nc" id="L31111">        HashSet&lt;Coords&gt; illuminateHexes = game.getIlluminatedPositions();</span>
<span class="nc" id="L31112">        return new Packet(Packet.COMMAND_SENDING_ILLUM_HEXES, illuminateHexes);</span>
    }

    /**
     * Creates a packet containing flares
     */
    private Packet createFlarePacket() {

<span class="nc" id="L31120">        return new Packet(Packet.COMMAND_SENDING_FLARES, game.getFlares());</span>
    }

    /**
     * Send a packet to all connected clients.
     */
    private void send(Packet packet) {
<span class="nc bnc" id="L31127" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L31128">            return;</span>
        }
<span class="nc bnc" id="L31130" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L31131">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L31132">            conn.send(packet);</span>
<span class="nc" id="L31133">        }</span>
<span class="nc" id="L31134">    }</span>

    // WOR
    public void send_Nova_Change(int Id, String net) {
<span class="nc" id="L31138">        Object[] data = {Id, net};</span>
<span class="nc" id="L31139">        Packet packet = new Packet(Packet.COMMAND_ENTITY_NOVA_NETWORK_CHANGE, data);</span>
<span class="nc" id="L31140">        send(packet);</span>
<span class="nc" id="L31141">    }</span>

    private void sendReport() {
<span class="nc" id="L31144">        sendReport(false);</span>
<span class="nc" id="L31145">    }</span>

    /**
     * Send the round report to all connected clients.
     */
    private void sendReport(boolean tacticalGeniusReport) {
<span class="nc bnc" id="L31151" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L31152">            return;</span>
        }

<span class="nc bnc" id="L31155" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L31156">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L31157">            IPlayer p = game.getPlayer(conn.getId());</span>
            Packet packet;
<span class="nc bnc" id="L31159" title="All 2 branches missed.">            if (tacticalGeniusReport) {</span>
<span class="nc" id="L31160">                packet = createTacticalGeniusReportPacket();</span>
            } else {
<span class="nc" id="L31162">                packet = createReportPacket(p);</span>
            }
<span class="nc" id="L31164">            conn.send(packet);</span>
<span class="nc" id="L31165">        }</span>
<span class="nc" id="L31166">    }</span>

    /**
     * Send a packet to a specific connection.
     */
    public void send(int connId, Packet packet) {
<span class="nc bnc" id="L31172" title="All 2 branches missed.">        if (getClient(connId) != null) {</span>
<span class="nc" id="L31173">            getClient(connId).send(packet);</span>
        }
        // What should we do if we've lost this client?
        // For now, nothing.
<span class="nc" id="L31177">    }</span>

    /**
     * Send a packet to a pending connection
     */
    private void sendToPending(int connId, Packet packet) {
<span class="nc" id="L31183">        IConnection pendingConn = getPendingConnection(connId);</span>
<span class="nc bnc" id="L31184" title="All 2 branches missed.">        if (pendingConn != null) {</span>
<span class="nc" id="L31185">            pendingConn.send(packet);</span>
        }
        // What should we do if we've lost this client?
        // For now, nothing.
<span class="nc" id="L31189">    }</span>

    /**
     * Process an in-game command
     */
    private void processCommand(int connId, String commandString) {
        String[] args;
        String commandName;
        // all tokens are read as strings; if they're numbers, string-ize 'em.
        // replaced the tokenizer with the split function.
<span class="nc" id="L31199">        args = commandString.split(&quot;\\s+&quot;);</span>

        // figure out which command this is
<span class="nc" id="L31202">        commandName = args[0].substring(1);</span>

        // process it
<span class="nc" id="L31205">        ServerCommand command = getCommand(commandName);</span>
<span class="nc bnc" id="L31206" title="All 2 branches missed.">        if (command != null) {</span>
<span class="nc" id="L31207">            command.run(connId, args);</span>
        } else {
<span class="nc" id="L31209">            sendServerChat(connId,</span>
                    &quot;Command not recognized.  Type /help for a list of commands.&quot;);
        }
<span class="nc" id="L31212">    }</span>

    // Easter eggs. Happy April Fool's Day!!
    private static final String DUNE_CALL = &quot;They tried and failed?&quot;;

    private static final String DUNE_RESPONSE = &quot;They tried and died!&quot;;

    private static final String STAR_WARS_CALL = &quot;I'd just as soon kiss a Wookiee.&quot;;

    private static final String STAR_WARS_RESPONSE = &quot;I can arrange that!&quot;;

    private static final String INVADER_ZIM_CALL = &quot;What does the G stand for?&quot;;

    private static final String INVADER_ZIM_RESPONSE = &quot;I don't know.&quot;;

    private static final String WARGAMES_CALL = &quot;Shall we play a game?&quot;;

    private static final String WARGAMES_RESPONSE = &quot;Let's play global thermonuclear war.&quot;;

    /**
     * Process a packet from a connection.
     *
     * @param connId
     *            - the &lt;code&gt;int&lt;/code&gt; ID the connection that received the
     *            packet.
     * @param packet
     *            - the &lt;code&gt;Packet&lt;/code&gt; to be processed.
     */
    protected void handle(int connId, Packet packet) {
<span class="nc" id="L31241">        IPlayer player = game.getPlayer(connId);</span>
        // Check player. Please note, the connection may be pending.
<span class="nc bnc" id="L31243" title="All 4 branches missed.">        if ((null == player) &amp;&amp; (null == getPendingConnection(connId))) {</span>
<span class="nc" id="L31244">            MegaMek.getLogger().error(&quot;Server does not recognize player at connection &quot; + connId);</span>
<span class="nc" id="L31245">            return;</span>
        }

<span class="nc bnc" id="L31248" title="All 2 branches missed.">        if (packet == null) {</span>
<span class="nc" id="L31249">            MegaMek.getLogger().error(&quot;Got null packet&quot;);</span>
<span class="nc" id="L31250">            return;</span>
        }
        // act on it
<span class="nc bnc" id="L31253" title="All 42 branches missed.">        switch (packet.getCommand()) {</span>
            case Packet.COMMAND_CLIENT_VERSIONS:
<span class="nc" id="L31255">                receivePlayerVersion(packet, connId);</span>
<span class="nc" id="L31256">                break;</span>
            case Packet.COMMAND_CLOSE_CONNECTION:
                // We have a client going down!
<span class="nc" id="L31259">                IConnection c = getConnection(connId);</span>
<span class="nc bnc" id="L31260" title="All 2 branches missed.">                if (c != null) {</span>
<span class="nc" id="L31261">                    c.close();</span>
                }
                break;
            case Packet.COMMAND_CLIENT_NAME:
<span class="nc" id="L31265">                receivePlayerName(packet, connId);</span>
<span class="nc" id="L31266">                break;</span>
            case Packet.COMMAND_PLAYER_UPDATE:
<span class="nc" id="L31268">                receivePlayerInfo(packet, connId);</span>
<span class="nc" id="L31269">                validatePlayerInfo(connId);</span>
<span class="nc" id="L31270">                send(createPlayerUpdatePacket(connId));</span>
<span class="nc" id="L31271">                break;</span>
            case Packet.COMMAND_PLAYER_READY:
<span class="nc" id="L31273">                receivePlayerDone(packet, connId);</span>
<span class="nc" id="L31274">                send(createPlayerDonePacket(connId));</span>
<span class="nc" id="L31275">                checkReady();</span>
<span class="nc" id="L31276">                break;</span>
            case Packet.COMMAND_REROLL_INITIATIVE:
<span class="nc" id="L31278">                receiveInitiativeRerollRequest(packet, connId);</span>
                // send(createPlayerDonePacket(connId));
<span class="nc" id="L31280">                break;</span>
            case Packet.COMMAND_FORWARD_INITIATIVE:
<span class="nc" id="L31282">                receiveForwardIni(connId);</span>
<span class="nc" id="L31283">                break;</span>
            case Packet.COMMAND_CHAT:
<span class="nc" id="L31285">                String chat = (String) packet.getObject(0);</span>
<span class="nc bnc" id="L31286" title="All 2 branches missed.">                if (chat.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L31287">                    processCommand(connId, chat);</span>
<span class="nc bnc" id="L31288" title="All 2 branches missed.">                } else if (packet.getData().length &gt; 1) {</span>
<span class="nc" id="L31289">                    connId = (int) packet.getObject(1);</span>
<span class="nc bnc" id="L31290" title="All 2 branches missed.">                    if (connId == IPlayer.PLAYER_NONE) {</span>
<span class="nc" id="L31291">                        sendServerChat(chat);</span>
                    } else {
<span class="nc" id="L31293">                        sendServerChat(connId, chat);</span>
                    }
                } else {
<span class="nc" id="L31296">                    sendChat(player.getName(), chat);</span>
                }
                // Easter eggs. Happy April Fool's Day!!
<span class="nc bnc" id="L31299" title="All 2 branches missed.">                if (DUNE_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31300">                    sendServerChat(DUNE_RESPONSE);</span>
<span class="nc bnc" id="L31301" title="All 2 branches missed.">                } else if (STAR_WARS_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31302">                    sendServerChat(STAR_WARS_RESPONSE);</span>
<span class="nc bnc" id="L31303" title="All 2 branches missed.">                } else if (INVADER_ZIM_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31304">                    sendServerChat(INVADER_ZIM_RESPONSE);</span>
<span class="nc bnc" id="L31305" title="All 2 branches missed.">                } else if (WARGAMES_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31306">                    sendServerChat(WARGAMES_RESPONSE);</span>
                }
                break;
            case Packet.COMMAND_BLDG_EXPLODE:
<span class="nc" id="L31310">                DemolitionCharge charge = (DemolitionCharge)packet.getData()[0];</span>
<span class="nc bnc" id="L31311" title="All 2 branches missed.">                if (charge.playerId == connId) {</span>
<span class="nc bnc" id="L31312" title="All 2 branches missed.">                    if (!explodingCharges.contains(charge)) {</span>
<span class="nc" id="L31313">                        explodingCharges.add(charge);</span>
<span class="nc" id="L31314">                        IPlayer p = game.getPlayer(connId);</span>
<span class="nc" id="L31315">                        sendServerChat(p.getName() + &quot; has touched off explosives &quot;</span>
                                + &quot;(handled in end phase)!&quot;);
<span class="nc" id="L31317">                    }</span>
                }
                break;
            case Packet.COMMAND_ENTITY_MOVE:
<span class="nc" id="L31321">                receiveMovement(packet, connId);</span>
<span class="nc" id="L31322">                break;</span>
            case Packet.COMMAND_ENTITY_DEPLOY:
<span class="nc" id="L31324">                receiveDeployment(packet, connId);</span>
<span class="nc" id="L31325">                break;</span>
            case Packet.COMMAND_ENTITY_DEPLOY_UNLOAD:
<span class="nc" id="L31327">                receiveDeploymentUnload(packet, connId);</span>
<span class="nc" id="L31328">                break;</span>
            case Packet.COMMAND_DEPLOY_MINEFIELDS:
<span class="nc" id="L31330">                receiveDeployMinefields(packet, connId);</span>
<span class="nc" id="L31331">                break;</span>
            case Packet.COMMAND_ENTITY_ATTACK:
<span class="nc" id="L31333">                receiveAttack(packet, connId);</span>
<span class="nc" id="L31334">                break;</span>
            case Packet.COMMAND_ENTITY_GTA_HEX_SELECT:
<span class="nc" id="L31336">                receiveGroundToAirHexSelectPacket(packet, connId);</span>
<span class="nc" id="L31337">                break;</span>
            case Packet.COMMAND_ENTITY_ADD:
<span class="nc" id="L31339">                receiveEntityAdd(packet, connId);</span>
<span class="nc" id="L31340">                resetPlayersDone();</span>
<span class="nc" id="L31341">                break;</span>
            case Packet.COMMAND_ENTITY_UPDATE:
<span class="nc" id="L31343">                receiveEntityUpdate(packet, connId);</span>
<span class="nc" id="L31344">                resetPlayersDone();</span>
<span class="nc" id="L31345">                break;</span>
            case Packet.COMMAND_ENTITY_LOAD:
<span class="nc" id="L31347">                receiveEntityLoad(packet, connId);</span>
<span class="nc" id="L31348">                resetPlayersDone();</span>
<span class="nc" id="L31349">                transmitAllPlayerDones();</span>
<span class="nc" id="L31350">                break;</span>
            case Packet.COMMAND_ENTITY_MODECHANGE:
<span class="nc" id="L31352">                receiveEntityModeChange(packet, connId);</span>
<span class="nc" id="L31353">                break;</span>
            case Packet.COMMAND_ENTITY_SENSORCHANGE:
<span class="nc" id="L31355">                receiveEntitySensorChange(packet, connId);</span>
<span class="nc" id="L31356">                break;</span>
            case Packet.COMMAND_ENTITY_SINKSCHANGE:
<span class="nc" id="L31358">                receiveEntitySinksChange(packet, connId);</span>
<span class="nc" id="L31359">                break;</span>
            case Packet.COMMAND_ENTITY_ACTIVATE_HIDDEN:
<span class="nc" id="L31361">                receiveEntityActivateHidden(packet, connId);</span>
<span class="nc" id="L31362">                break;</span>
            case Packet.COMMAND_ENTITY_NOVA_NETWORK_CHANGE:
<span class="nc" id="L31364">                receiveEntityNovaNetworkModeChange(packet, connId);</span>
<span class="nc" id="L31365">                break;</span>
            case Packet.COMMAND_ENTITY_MOUNTED_FACINGCHANGE:
<span class="nc" id="L31367">                receiveEntityMountedFacingChange(packet, connId);</span>
<span class="nc" id="L31368">                break;</span>
            case Packet.COMMAND_ENTITY_CALLEDSHOTCHANGE:
<span class="nc" id="L31370">                receiveEntityCalledShotChange(packet, connId);</span>
<span class="nc" id="L31371">                break;</span>
            case Packet.COMMAND_ENTITY_SYSTEMMODECHANGE:
<span class="nc" id="L31373">                receiveEntitySystemModeChange(packet, connId);</span>
<span class="nc" id="L31374">                break;</span>
            case Packet.COMMAND_ENTITY_AMMOCHANGE:
<span class="nc" id="L31376">                receiveEntityAmmoChange(packet, connId);</span>
<span class="nc" id="L31377">                break;</span>
            case Packet.COMMAND_ENTITY_REMOVE:
<span class="nc" id="L31379">                receiveEntityDelete(packet, connId);</span>
<span class="nc" id="L31380">                resetPlayersDone();</span>
<span class="nc" id="L31381">                break;</span>
            case Packet.COMMAND_ENTITY_WORDER_UPDATE:
<span class="nc" id="L31383">                Object[] data = packet.getData();</span>
<span class="nc" id="L31384">                Entity ent = game.getEntity((Integer) data[0]);</span>
<span class="nc bnc" id="L31385" title="All 2 branches missed.">                if (ent != null) {</span>
<span class="nc" id="L31386">                    Entity.WeaponSortOrder order = (Entity.WeaponSortOrder) data[1];</span>
<span class="nc" id="L31387">                    ent.setWeaponSortOrder(order);</span>
                    // Used by the client but is set in setWeaponSortOrder
<span class="nc" id="L31389">                    ent.setWeapOrderChanged(false);</span>
<span class="nc bnc" id="L31390" title="All 2 branches missed.">                    if (order == Entity.WeaponSortOrder.CUSTOM) {</span>
                        @SuppressWarnings(&quot;unchecked&quot;)
                        // Unchecked cause of limitations in Java when casting
                        // to a collection
<span class="nc" id="L31394">                        Map&lt;Integer, Integer&gt; customWeaponOrder = (Map&lt;Integer, Integer&gt;) data[2];</span>
<span class="nc" id="L31395">                        ent.setCustomWeaponOrder(customWeaponOrder);</span>
                    }
<span class="nc" id="L31397">                }</span>
                break;
            case Packet.COMMAND_SENDING_GAME_SETTINGS:
<span class="nc bnc" id="L31400" title="All 2 branches missed.">                if (receiveGameOptions(packet, connId)) {</span>
<span class="nc" id="L31401">                    resetPlayersDone();</span>
<span class="nc" id="L31402">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31403">                    send(createGameSettingsPacket());</span>
<span class="nc" id="L31404">                    receiveGameOptionsAux(packet, connId);</span>
                }
                break;
            case Packet.COMMAND_SENDING_MAP_SETTINGS:
<span class="nc bnc" id="L31408" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31409">                    MapSettings newSettings = (MapSettings) packet.getObject(0);</span>
<span class="nc bnc" id="L31410" title="All 2 branches missed.">                    if (!mapSettings.equalMapGenParameters(newSettings)) {</span>
<span class="nc" id="L31411">                        sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed map settings&quot;);</span>
                    }
<span class="nc" id="L31413">                    mapSettings = newSettings;</span>
<span class="nc" id="L31414">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L31415">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L31416">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L31417">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L31418">                    mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L31419">                    mapSettings.removeUnavailable();</span>
                    // if still only nulls left, use BOARD_GENERATED
<span class="nc bnc" id="L31421" title="All 2 branches missed.">                    if (mapSettings.getBoardsSelected().next() == null) {</span>
<span class="nc" id="L31422">                        mapSettings.setNullBoards((MapSettings.BOARD_GENERATED));</span>
                    }
<span class="nc" id="L31424">                    resetPlayersDone();</span>
<span class="nc" id="L31425">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31426">                    send(createMapSettingsPacket());</span>
<span class="nc" id="L31427">                }</span>
                break;
            case Packet.COMMAND_SENDING_MAP_DIMENSIONS:
<span class="nc bnc" id="L31430" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31431">                    MapSettings newSettings = (MapSettings) packet.getObject(0);</span>
<span class="nc bnc" id="L31432" title="All 2 branches missed.">                    if (!mapSettings.equalMapGenParameters(newSettings)) {</span>
<span class="nc" id="L31433">                        sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed map dimensions&quot;);</span>
                    }
<span class="nc" id="L31435">                    mapSettings = newSettings;</span>
<span class="nc" id="L31436">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L31437">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L31438">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L31439">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L31440">                    mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L31441">                    mapSettings.removeUnavailable();</span>
                    // if still only nulls left, use BOARD_GENERATED
<span class="nc bnc" id="L31443" title="All 2 branches missed.">                    if (mapSettings.getBoardsSelected().next() == null) {</span>
<span class="nc" id="L31444">                        mapSettings.setNullBoards((MapSettings.BOARD_GENERATED));</span>
                    }
<span class="nc" id="L31446">                    resetPlayersDone();</span>
<span class="nc" id="L31447">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31448">                    send(createMapSettingsPacket());</span>
<span class="nc" id="L31449">                }</span>
                break;
            case Packet.COMMAND_SENDING_PLANETARY_CONDITIONS:
                // MapSettings newSettings = (MapSettings) packet.getObject(0);
<span class="nc bnc" id="L31453" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31454">                    PlanetaryConditions conditions = (PlanetaryConditions) packet.getObject(0);</span>
<span class="nc" id="L31455">                    sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed planetary conditions&quot;);</span>
<span class="nc" id="L31456">                    game.setPlanetaryConditions(conditions);</span>
<span class="nc" id="L31457">                    resetPlayersDone();</span>
<span class="nc" id="L31458">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31459">                    send(createPlanetaryConditionsPacket());</span>
<span class="nc" id="L31460">                }</span>
                break;
            case Packet.COMMAND_UNLOAD_STRANDED:
<span class="nc" id="L31463">                receiveUnloadStranded(packet, connId);</span>
<span class="nc" id="L31464">                break;</span>
            case Packet.COMMAND_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L31466">                receiveArtyAutoHitHexes(packet, connId);</span>
<span class="nc" id="L31467">                break;</span>
            case Packet.COMMAND_CUSTOM_INITIATIVE:
<span class="nc" id="L31469">                receiveCustomInit(packet, connId);</span>
<span class="nc" id="L31470">                resetPlayersDone();</span>
<span class="nc" id="L31471">                transmitAllPlayerDones();</span>
<span class="nc" id="L31472">                break;</span>
            case Packet.COMMAND_LOAD_GAME:
                try {
<span class="nc" id="L31475">                    sendServerChat(getPlayer(connId).getName() + &quot; loaded a new game.&quot;);</span>
<span class="nc" id="L31476">                    setGame((IGame) packet.getObject(0));</span>
<span class="nc bnc" id="L31477" title="All 2 branches missed.">                    for (IConnection conn : connections) {</span>
<span class="nc" id="L31478">                        sendCurrentInfo(conn.getId());</span>
<span class="nc" id="L31479">                    }</span>
<span class="nc" id="L31480">                } catch (Exception e) {</span>
<span class="nc" id="L31481">                    MegaMek.getLogger().error(&quot;Error loading save game sent from client&quot;, e);</span>
<span class="nc" id="L31482">                }</span>
<span class="nc" id="L31483">                break;</span>
            case Packet.COMMAND_SQUADRON_ADD:
<span class="nc" id="L31485">                receiveSquadronAdd(packet, connId);</span>
<span class="nc" id="L31486">                resetPlayersDone();</span>
<span class="nc" id="L31487">                transmitAllPlayerDones();</span>
<span class="nc" id="L31488">                break;</span>
            case Packet.COMMAND_RESET_ROUND_DEPLOYMENT:
<span class="nc" id="L31490">                game.setupRoundDeployment();</span>
<span class="nc" id="L31491">                break;</span>
            case Packet.COMMAND_SPECIAL_HEX_DISPLAY_DELETE:
<span class="nc" id="L31493">                game.getBoard().removeSpecialHexDisplay((Coords) packet.getObject(0),</span>
<span class="nc" id="L31494">                        (SpecialHexDisplay) packet.getObject(1));</span>
<span class="nc" id="L31495">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L31496">                break;</span>
            case Packet.COMMAND_SPECIAL_HEX_DISPLAY_APPEND:
<span class="nc" id="L31498">                game.getBoard().addSpecialHexDisplay((Coords) packet.getObject(0),</span>
<span class="nc" id="L31499">                        (SpecialHexDisplay) packet.getObject(1));</span>
<span class="nc" id="L31500">                sendSpecialHexDisplayPackets();</span>
                break;
        }
<span class="nc" id="L31503">    }</span>

    /**
     * Listen for incoming clients.
     */
    public void run() {
<span class="nc" id="L31509">        Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L31510">        MegaMek.getLogger().info(&quot;s: listening for clients...&quot;);</span>
<span class="nc bnc" id="L31511" title="All 2 branches missed.">        while (connector == currentThread) {</span>
            try {
<span class="nc" id="L31513">                Socket s = serverSocket.accept();</span>
<span class="nc" id="L31514">                synchronized (serverLock) {</span>
<span class="nc" id="L31515">                    int id = getFreeConnectionId();</span>
<span class="nc" id="L31516">                    MegaMek.getLogger().info(&quot;s: accepting player connection #&quot; + id + &quot;...&quot;);</span>

<span class="nc" id="L31518">                    IConnection c = ConnectionFactory.getInstance().createServerConnection(s, id);</span>
<span class="nc" id="L31519">                    c.addConnectionListener(connectionListener);</span>
<span class="nc" id="L31520">                    c.open();</span>
<span class="nc" id="L31521">                    connectionsPending.addElement(c);</span>
<span class="nc" id="L31522">                    ConnectionHandler ch = new ConnectionHandler(c);</span>
<span class="nc" id="L31523">                    Thread newConnThread = new Thread(ch, &quot;Connection &quot; + id);</span>
<span class="nc" id="L31524">                    newConnThread.start();</span>
<span class="nc" id="L31525">                    connectionHandlers.put(id, ch);</span>

<span class="nc" id="L31527">                    greeting(id);</span>
<span class="nc" id="L31528">                    ConnectionWatchdog w = new ConnectionWatchdog(this, id);</span>
<span class="nc" id="L31529">                    watchdogTimer.schedule(w, 1000, 500);</span>
<span class="nc" id="L31530">                }</span>
<span class="nc" id="L31531">            } catch (InterruptedIOException ignored) {</span>
                // ignore , just SOTimeout blowing..
<span class="nc" id="L31533">            } catch (IOException ignored) { }</span>
        }
<span class="nc" id="L31535">    }</span>

    /**
     * Makes one slot of inferno ammo, determined by certain rules, explode on a
     * mech.
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; that should suffer an inferno ammo
     *            explosion.
     */
    private Vector&lt;Report&gt; explodeInfernoAmmoFromHeat(Entity entity) {
<span class="nc" id="L31546">        int damage = 0;</span>
<span class="nc" id="L31547">        int rack = 0;</span>
<span class="nc" id="L31548">        int boomloc = -1;</span>
<span class="nc" id="L31549">        int boomslot = -1;</span>
<span class="nc" id="L31550">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // Find the most destructive Inferno ammo.
<span class="nc bnc" id="L31554" title="All 2 branches missed.">        for (int j = 0; j &lt; entity.locations(); j++) {</span>
<span class="nc bnc" id="L31555" title="All 2 branches missed.">            for (int k = 0; k &lt; entity.getNumberOfCriticals(j); k++) {</span>
<span class="nc" id="L31556">                CriticalSlot cs = entity.getCritical(j, k);</span>
                // Ignore empty, destroyed, hit, and structure slots.
<span class="nc bnc" id="L31558" title="All 6 branches missed.">                if ((cs == null) || cs.isDestroyed() || cs.isHit()</span>
<span class="nc bnc" id="L31559" title="All 2 branches missed.">                        || (cs.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L31560">                    continue;</span>
                }
                // Ignore everything but ammo or LAM bomb bay slots.
<span class="nc" id="L31563">                Mounted mounted = cs.getMount();</span>
                int newRack;
                int newDamage;
<span class="nc bnc" id="L31566" title="All 2 branches missed.">                if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc" id="L31567">                    AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L31568" title="All 2 branches missed.">                    if (!atype.isExplosive(mounted)</span>
<span class="nc bnc" id="L31569" title="All 2 branches missed.">                            || ((atype.getMunitionType() != AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L31570" title="All 2 branches missed.">                            &amp;&amp; (atype.getMunitionType() != AmmoType.M_IATM_IIW))) {</span>
<span class="nc" id="L31571">                        continue;</span>
                    }
                    // ignore empty, destroyed, or missing bins
<span class="nc bnc" id="L31574" title="All 2 branches missed.">                    if (mounted.getHittableShotsLeft() == 0) {</span>
<span class="nc" id="L31575">                        continue;</span>
                    }
                    // Find the most destructive undamaged ammo.
                    // TW page 160, compare one rack's
                    // damage. Ties go to most rounds.
<span class="nc" id="L31580">                    newRack = atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L31581">                    newDamage = mounted.getExplosionDamage();</span>
<span class="nc" id="L31582">                    Mounted mount2 = cs.getMount2();</span>
<span class="nc bnc" id="L31583" title="All 4 branches missed.">                    if ((mount2 != null) &amp;&amp; (mount2.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L31584" title="All 2 branches missed.">                            &amp;&amp; (mount2.getHittableShotsLeft() &gt; 0)) {</span>
                        // must be for same weaponType, so rackSize stays
<span class="nc" id="L31586">                        atype = (AmmoType) mount2.getType();</span>
<span class="nc" id="L31587">                        newRack += atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L31588">                        newDamage += mount2.getExplosionDamage();</span>
                    }
<span class="nc bnc" id="L31590" title="All 2 branches missed.">                } else if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L31591" title="All 2 branches missed.">                        &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc bnc" id="L31592" title="All 2 branches missed.">                    while (mounted.getLinked() != null) {</span>
<span class="nc" id="L31593">                        mounted = mounted.getLinked();</span>
                    }
<span class="nc bnc" id="L31595" title="All 2 branches missed.">                    if (mounted.getExplosionDamage() == 0) {</span>
<span class="nc" id="L31596">                        continue;</span>
                    }
<span class="nc" id="L31598">                    newRack = 1;</span>
<span class="nc" id="L31599">                    newDamage = mounted.getExplosionDamage();</span>
                } else {
                    continue;
                }

<span class="nc bnc" id="L31604" title="All 8 branches missed.">                if (!mounted.isHit()</span>
                        &amp;&amp; ((rack &lt; newRack) || ((rack == newRack) &amp;&amp; (damage &lt; newDamage)))) {
<span class="nc" id="L31606">                    rack = newRack;</span>
<span class="nc" id="L31607">                    damage = newDamage;</span>
<span class="nc" id="L31608">                    boomloc = j;</span>
<span class="nc" id="L31609">                    boomslot = k;</span>
                }
            }
        }
        // Did we find anything to explode?
<span class="nc bnc" id="L31614" title="All 4 branches missed.">        if ((boomloc != -1) &amp;&amp; (boomslot != -1)) {</span>
<span class="nc" id="L31615">            CriticalSlot slot = entity.getCritical(boomloc, boomslot);</span>
<span class="nc" id="L31616">            slot.setHit(true);</span>
<span class="nc" id="L31617">            Mounted equip = slot.getMount();</span>
<span class="nc" id="L31618">            equip.setHit(true);</span>
            // We've allocated heatBuildup to heat in resolveHeat(),
            // so need to add to the entity's heat instead.
<span class="nc bnc" id="L31621" title="All 2 branches missed.">            if ((equip.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L31622" title="All 2 branches missed.">                    || (equip.getLinked() != null</span>
<span class="nc bnc" id="L31623" title="All 2 branches missed.">                        &amp;&amp; equip.getLinked().getType() instanceof BombType</span>
<span class="nc bnc" id="L31624" title="All 2 branches missed.">                        &amp;&amp; ((BombType)equip.getLinked().getType()).getBombType() == BombType.B_INFERNO)) {</span>
<span class="nc" id="L31625">                entity.heat += Math.min(equip.getExplosionDamage(), 30);</span>
            }
<span class="nc" id="L31627">            vDesc.addAll(explodeEquipment(entity, boomloc, boomslot));</span>
<span class="nc" id="L31628">            r = new Report(5155);</span>
<span class="nc" id="L31629">            r.indent();</span>
<span class="nc" id="L31630">            r.subject = entity.getId();</span>
<span class="nc" id="L31631">            r.add(entity.heat);</span>
<span class="nc" id="L31632">            vDesc.addElement(r);</span>
<span class="nc" id="L31633">            entity.heatBuildup = 0;</span>
<span class="nc" id="L31634">        } else { // no ammo to explode</span>
<span class="nc" id="L31635">            r = new Report(5160);</span>
<span class="nc" id="L31636">            r.indent();</span>
<span class="nc" id="L31637">            r.subject = entity.getId();</span>
<span class="nc" id="L31638">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L31640">        return vDesc;</span>
    }

    /**
     * checks for unintended explosion of heavy industrial zone hex and applies
     * damage to entities occupying the hex
     */
    public void checkExplodeIndustrialZone(Coords c, Vector&lt;Report&gt; vDesc) {
        Report r;
<span class="nc" id="L31649">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L31650" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L31651">            return;</span>
        }

<span class="nc bnc" id="L31654" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.INDUSTRIAL)) {</span>
<span class="nc" id="L31655">            return;</span>
        }

<span class="nc" id="L31658">        r = new Report(3590, Report.PUBLIC);</span>
<span class="nc" id="L31659">        r.add(c.getBoardNum());</span>
<span class="nc" id="L31660">        r.indent(2);</span>
<span class="nc" id="L31661">        int effect = Compute.d6(2);</span>
<span class="nc" id="L31662">        r.add(8);</span>
<span class="nc" id="L31663">        r.add(effect);</span>
<span class="nc bnc" id="L31664" title="All 2 branches missed.">        if (effect &gt; 7) {</span>
<span class="nc" id="L31665">            r.choose(true);</span>
<span class="nc" id="L31666">            r.newlines = 0;</span>
<span class="nc" id="L31667">            vDesc.add(r);</span>
<span class="nc" id="L31668">            boolean onFire = false;</span>
<span class="nc" id="L31669">            boolean powerLine = false;</span>
<span class="nc" id="L31670">            boolean minorExp = false;</span>
<span class="nc" id="L31671">            boolean elecExp = false;</span>
<span class="nc" id="L31672">            boolean majorExp = false;</span>
<span class="nc bnc" id="L31673" title="All 2 branches missed.">            if (effect == 8) {</span>
<span class="nc" id="L31674">                onFire = true;</span>
<span class="nc" id="L31675">                r = new Report(3600, Report.PUBLIC);</span>
<span class="nc" id="L31676">                r.newlines = 0;</span>
<span class="nc" id="L31677">                vDesc.add(r);</span>
<span class="nc bnc" id="L31678" title="All 2 branches missed.">            } else if (effect == 9) {</span>
<span class="nc" id="L31679">                powerLine = true;</span>
<span class="nc" id="L31680">                r = new Report(3605, Report.PUBLIC);</span>
<span class="nc" id="L31681">                r.newlines = 0;</span>
<span class="nc" id="L31682">                vDesc.add(r);</span>
<span class="nc bnc" id="L31683" title="All 2 branches missed.">            } else if (effect == 10) {</span>
<span class="nc" id="L31684">                minorExp = true;</span>
<span class="nc" id="L31685">                onFire = true;</span>
<span class="nc" id="L31686">                r = new Report(3610, Report.PUBLIC);</span>
<span class="nc" id="L31687">                r.newlines = 0;</span>
<span class="nc" id="L31688">                vDesc.add(r);</span>
<span class="nc bnc" id="L31689" title="All 2 branches missed.">            } else if (effect == 11) {</span>
<span class="nc" id="L31690">                elecExp = true;</span>
<span class="nc" id="L31691">                r = new Report(3615, Report.PUBLIC);</span>
<span class="nc" id="L31692">                r.newlines = 0;</span>
<span class="nc" id="L31693">                vDesc.add(r);</span>
            } else {
<span class="nc" id="L31695">                onFire = true;</span>
<span class="nc" id="L31696">                majorExp = true;</span>
<span class="nc" id="L31697">                r = new Report(3620, Report.PUBLIC);</span>
<span class="nc" id="L31698">                r.newlines = 0;</span>
<span class="nc" id="L31699">                vDesc.add(r);</span>
            }
            // apply damage here
<span class="nc bnc" id="L31702" title="All 8 branches missed.">            if (powerLine || minorExp || elecExp || majorExp) {</span>
                // cycle through the entities in the hex and apply damage
<span class="nc bnc" id="L31704" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(c)) {</span>
<span class="nc" id="L31705">                    int damage = 3;</span>
<span class="nc bnc" id="L31706" title="All 2 branches missed.">                    if (minorExp) {</span>
<span class="nc" id="L31707">                        damage = 5;</span>
                    }
<span class="nc bnc" id="L31709" title="All 2 branches missed.">                    if (elecExp) {</span>
<span class="nc" id="L31710">                        damage = Compute.d6(1) + 3;</span>
                    }
<span class="nc bnc" id="L31712" title="All 2 branches missed.">                    if (majorExp) {</span>
<span class="nc" id="L31713">                        damage = Compute.d6(2);</span>
                    }
<span class="nc" id="L31715">                    HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L31716" title="All 2 branches missed.">                    if (en instanceof BattleArmor) {</span>
                        // ugly - I have to apply damage to each trooper
                        // separately
<span class="nc bnc" id="L31719" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; en.locations(); loc++) {</span>
<span class="nc bnc" id="L31720" title="All 2 branches missed.">                            if ((IArmorState.ARMOR_NA != en.getInternal(loc))</span>
<span class="nc bnc" id="L31721" title="All 2 branches missed.">                                    &amp;&amp; (IArmorState.ARMOR_DESTROYED != en.getInternal(loc))</span>
<span class="nc bnc" id="L31722" title="All 2 branches missed.">                                    &amp;&amp; (IArmorState.ARMOR_DOOMED != en.getInternal(loc))) {</span>
<span class="nc" id="L31723">                                vDesc.addAll(damageEntity(en, new HitData(loc), damage));</span>
                            }
                        }
                    } else {
<span class="nc" id="L31727">                        vDesc.addAll(damageEntity(en, hit, damage));</span>
                    }
<span class="nc bnc" id="L31729" title="All 2 branches missed.">                    if (majorExp) {</span>
                        // lets pretend that the infernos came from the entity
                        // itself (should give us side_front)
<span class="nc" id="L31732">                        vDesc.addAll(deliverInfernoMissiles(en, en, Compute.d6(2)));</span>
                    }
<span class="nc" id="L31734">                }</span>
            }
<span class="nc" id="L31736">            Report.addNewline(vDesc);</span>
<span class="nc bnc" id="L31737" title="All 4 branches missed.">            if (onFire &amp;&amp; !hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L31738">                ignite(c, Terrains.FIRE_LVL_NORMAL, vDesc);</span>
            }
<span class="nc" id="L31740">        } else {</span>
            // report no explosion
<span class="nc" id="L31742">            r.choose(false);</span>
<span class="nc" id="L31743">            vDesc.add(r);</span>
        }
<span class="nc" id="L31745">    }</span>

    /**
     * Determine the results of an entity moving through a wall of a building
     * after having moved a certain distance. This gets called when a Mech or a
     * Tank enters a building, leaves a building, or travels from one hex to
     * another inside a multi-hex building.
     *
     * @param entity
     *            - the &lt;code&gt;Entity&lt;/code&gt; that passed through a wall. Don't
     *            pass &lt;code&gt;Infantry&lt;/code&gt; units to this method.
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; the entity is passing through.
     * @param lastPos
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex the entity is exiting.
     * @param curPos
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex the entity is entering
     * @param distance
     *            - the &lt;code&gt;int&lt;/code&gt; number of hexes the entity has moved
     *            already this phase.
     * @param why
     *            - the &lt;code&gt;String&lt;/code&gt; explanation for this action.
     * @param backwards
     *            - the &lt;code&gt;boolean&lt;/code&gt; indicating if the entity is
     *            entering the hex backwards
     * @param entering
     *            - a &lt;code&gt;boolean&lt;/code&gt; if the entity is entering or exiting
     *            a building
     */
    private void passBuildingWall(Entity entity, Building bldg, Coords lastPos, Coords curPos,
                                  int distance, String why, boolean backwards,
                                  EntityMovementType overallMoveType, boolean entering) {
        Report r;

<span class="nc bnc" id="L31779" title="All 2 branches missed.">        if (entity instanceof Protomech) {</span>
<span class="nc" id="L31780">            Vector&lt;Report&gt; vBuildingReport = damageBuilding(bldg, 1, curPos);</span>
<span class="nc bnc" id="L31781" title="All 2 branches missed.">            for (Report report : vBuildingReport) {</span>
<span class="nc" id="L31782">                report.subject = entity.getId();</span>
<span class="nc" id="L31783">            }</span>
<span class="nc" id="L31784">            addReport(vBuildingReport);</span>
<span class="nc" id="L31785">        } else {</span>
            // Need to roll based on building type.
<span class="nc" id="L31787">            PilotingRollData psr = entity.rollMovementInBuilding(bldg, distance, why, overallMoveType);</span>

            // Did the entity make the roll?
<span class="nc bnc" id="L31790" title="All 2 branches missed.">            if (0 &lt; doSkillCheckWhileMoving(entity, entity.getElevation(), lastPos, curPos, psr, false)) {</span>

                // Divide the building's current CF by 10, round up.
<span class="nc" id="L31793">                int damage = (int) Math.floor(bldg.getDamageFromScale()</span>
<span class="nc bnc" id="L31794" title="All 2 branches missed.">                        * Math.ceil(bldg.getCurrentCF(entering ? curPos : lastPos) / 10.0));</span>

                // Infantry and Battle armor take different amounts of damage
                // then Meks and vehicles.
<span class="nc bnc" id="L31798" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc" id="L31799">                    damage = bldg.getType() + 1;</span>
                }
                // It is possible that the unit takes no damage.
<span class="nc bnc" id="L31802" title="All 2 branches missed.">                if (damage == 0) {</span>
<span class="nc" id="L31803">                    r = new Report(6440);</span>
<span class="nc" id="L31804">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L31805">                    r.subject = entity.getId();</span>
<span class="nc" id="L31806">                    r.indent(2);</span>
<span class="nc" id="L31807">                    addReport(r);</span>
                } else {
                    // TW, pg. 268: if unit moves forward, damage from front,
                    // if backwards, damage from rear.
<span class="nc" id="L31811">                    int side = ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L31812" title="All 2 branches missed.">                    if (backwards) {</span>
<span class="nc" id="L31813">                        side = ToHitData.SIDE_REAR;</span>
                    }
<span class="nc" id="L31815">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc" id="L31816">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L31817">                    addReport(damageEntity(entity, hit, damage));</span>
                }
            }

            // Infantry and BA are damaged by buildings but do not damage them
<span class="nc bnc" id="L31822" title="All 2 branches missed.">            if (entity instanceof Infantry) {</span>
<span class="nc" id="L31823">                return;</span>
            }
            // Damage the building. The CF can never drop below 0.
<span class="nc" id="L31826">            int toBldg = (int) Math.floor(bldg.getDamageToScale()</span>
<span class="nc" id="L31827">                    * Math.ceil(entity.getWeight() / 10.0));</span>
<span class="nc bnc" id="L31828" title="All 2 branches missed.">            int curCF = bldg.getCurrentCF(entering ? curPos : lastPos);</span>
<span class="nc" id="L31829">            curCF -= Math.min(curCF, toBldg);</span>
<span class="nc bnc" id="L31830" title="All 2 branches missed.">            bldg.setCurrentCF(curCF, entering ? curPos : lastPos);</span>

            // Apply the correct amount of damage to infantry in the building.
            // ASSUMPTION: We inflict toBldg damage to infantry and
            // not the amount to bring building to 0 CF.
<span class="nc bnc" id="L31835" title="All 2 branches missed.">            addReport(damageInfantryIn(bldg, toBldg, entering ? curPos : lastPos));</span>
        }
<span class="nc" id="L31837">    }</span>

    /**
     * check if a building collapses because of a moving entity
     *
     * @param bldg
     *            the &lt;code&gt;Building&lt;/code&gt;
     * @param entity
     *            the &lt;code&gt;Entity&lt;/code&gt;
     * @param curPos
     *            the &lt;code&gt;Coords&lt;/code&gt; of the position of the entity
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating if the building collapses
     */
    private boolean checkBuildingCollapseWhileMoving(Building bldg, Entity entity, Coords curPos) {
<span class="nc" id="L31851">        Coords oldPos = entity.getPosition();</span>
        // Count the moving entity in its current position, not
        // its pre-move position. Be sure to handle nulls.
<span class="nc" id="L31854">        entity.setPosition(curPos);</span>

        // Get the position map of all entities in the game.
<span class="nc" id="L31857">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>

        // Check for collapse of this building due to overloading, and return.
<span class="nc" id="L31860">        boolean rv = checkForCollapse(bldg, positionMap, curPos, true, vPhaseReport);</span>

        // If the entity was not displaced and didn't fall, move it back where it was
<span class="nc bnc" id="L31863" title="All 4 branches missed.">        if (curPos.equals(entity.getPosition()) &amp;&amp; !entity.isProne()) {</span>
<span class="nc" id="L31864">            entity.setPosition(oldPos);</span>
        }
<span class="nc" id="L31866">        return rv;</span>
    }

    public Vector&lt;Report&gt; damageInfantryIn(Building bldg, int damage, Coords hexCoords) {
<span class="nc" id="L31870">        return damageInfantryIn(bldg, damage, hexCoords, WeaponType.WEAPON_NA);</span>
    }

    /**
     * Apply the correct amount of damage that passes on to any infantry unit in
     * the given building, based upon the amount of damage the building just
     * sustained. This amount is a percentage dictated by pg. 172 of TW.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that sustained the damage.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    public Vector&lt;Report&gt; damageInfantryIn(Building bldg, int damage, Coords hexCoords,
                                           int infDamageClass) {
<span class="nc" id="L31883">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L31885" title="All 2 branches missed.">        if (bldg == null) {</span>
<span class="nc" id="L31886">            return vDesc;</span>
        }
        // Calculate the amount of damage the infantry will sustain.
<span class="nc" id="L31889">        float percent = bldg.getDamageReductionFromOutside();</span>
        Report r;

        // Round up at .5 points of damage.
<span class="nc" id="L31893">        int toInf = Math.round(damage * percent);</span>

        // some buildings scale remaining damage
<span class="nc" id="L31896">        toInf = (int) Math.floor(bldg.getDamageToScale() * toInf);</span>

        // Walk through the entities in the game.
<span class="nc bnc" id="L31899" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc" id="L31900">            final Coords coords = entity.getPosition();</span>

            // If the entity is infantry in the affected hex?
<span class="nc bnc" id="L31903" title="All 6 branches missed.">            if ((entity instanceof Infantry) &amp;&amp; bldg.isIn(coords) &amp;&amp; coords.equals(hexCoords)) {</span>
                // Is the entity is inside of the building
                // (instead of just on top of it)?
<span class="nc bnc" id="L31906" title="All 2 branches missed.">                if (Compute.isInBuilding(game, entity, coords)) {</span>

                    // Report if the infantry receive no points of damage.
<span class="nc bnc" id="L31909" title="All 2 branches missed.">                    if (toInf == 0) {</span>
<span class="nc" id="L31910">                        r = new Report(6445);</span>
<span class="nc" id="L31911">                        r.indent(3);</span>
<span class="nc" id="L31912">                        r.subject = entity.getId();</span>
<span class="nc" id="L31913">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L31914">                        vDesc.addElement(r);</span>
                    } else {
                        // Yup. Damage the entity.
<span class="nc" id="L31917">                        r = new Report(6450);</span>
<span class="nc" id="L31918">                        r.indent(3);</span>
<span class="nc" id="L31919">                        r.subject = entity.getId();</span>
<span class="nc" id="L31920">                        r.add(toInf);</span>
<span class="nc" id="L31921">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L31922">                        vDesc.addElement(r);</span>
                        // need to adjust damage to conventional infantry
                        // TW page 217 says left over damage gets treated as
                        // direct fire ballistic damage
<span class="nc bnc" id="L31926" title="All 2 branches missed.">                        if (!(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L31927">                            toInf = Compute.directBlowInfantryDamage(toInf, 0,</span>
                                    WeaponType.WEAPON_DIRECT_FIRE, false, false);
                        }
<span class="nc" id="L31930">                        int remaining = toInf;</span>
<span class="nc" id="L31931">                        int cluster = toInf;</span>
                        // Battle Armor units use 5 point clusters.
<span class="nc bnc" id="L31933" title="All 2 branches missed.">                        if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L31934">                            cluster = 5;</span>
                        }
<span class="nc bnc" id="L31936" title="All 2 branches missed.">                        while (remaining &gt; 0) {</span>
<span class="nc" id="L31937">                            int next = Math.min(cluster, remaining);</span>
<span class="nc" id="L31938">                            HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L31939">                            vDesc.addAll((damageEntity(entity, hit, next)));</span>
<span class="nc" id="L31940">                            remaining -= next;</span>
<span class="nc" id="L31941">                        }</span>
                    }

<span class="nc" id="L31944">                    Report.addNewline(vDesc);</span>
                } // End infantry-inside-building
            } // End entity-is-infantry-in-building-hex
<span class="nc" id="L31947">        } // Handle the next entity</span>

<span class="nc" id="L31949">        return vDesc;</span>
    } // End private void damageInfantryIn( Building, int )

    /**
     * Determine if the given building should collapse. If so, inflict the
     * appropriate amount of damage on each entity in the building and update
     * the clients. If the building does not collapse, determine if any entities
     * crash through its floor into its basement. Again, apply appropriate
     * damage.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; being checked. This value should
     *            not be &lt;code&gt;null&lt;/code&gt;.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be checked
     * @return &lt;code&gt;true&lt;/code&gt; if the building collapsed.
     */
    public boolean checkForCollapse(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                    Coords coords, boolean checkBecauseOfDamage,
                                    Vector&lt;Report&gt; vPhaseReport) {

        // If the input is meaningless, do nothing and throw no exception.
<span class="nc bnc" id="L31976" title="All 8 branches missed.">        if ((bldg == null) || (positionMap == null) || positionMap.isEmpty()</span>
<span class="nc bnc" id="L31977" title="All 4 branches missed.">                || (coords == null) || !bldg.isIn(coords) || !bldg.hasCFIn(coords)) {</span>
<span class="nc" id="L31978">            return false;</span>
        }

        // Get the building's current CF.
<span class="nc" id="L31982">        int currentCF = bldg.getCurrentCF(coords);</span>

        // Track all units that fall into the building's basement by Coords.
<span class="nc" id="L31985">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; basementMap = new Hashtable&lt;&gt;();</span>

        // look for a collapse.
<span class="nc" id="L31988">        boolean collapse = false;</span>

<span class="nc" id="L31990">        boolean basementCollapse = false;</span>

<span class="nc" id="L31992">        boolean topFloorCollapse = false;</span>

<span class="nc bnc" id="L31994" title="All 4 branches missed.">        if (checkBecauseOfDamage &amp;&amp; (currentCF &lt;= 0)) {</span>
<span class="nc" id="L31995">            collapse = true;</span>
        }

        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L31999">        final Vector&lt;Entity&gt; vector = positionMap.get(coords);</span>

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32002" title="All 2 branches missed.">        if (vector != null) {</span>
            // How many levels does this building have in this hex?
<span class="nc" id="L32004">            final IHex curHex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L32005">            final int numFloors = Math.max(0, curHex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L32006">            final int bridgeEl = curHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L32007">            int numLoads = numFloors;</span>
<span class="nc bnc" id="L32008" title="All 2 branches missed.">            if (bridgeEl != ITerrain.LEVEL_NONE) {</span>
<span class="nc" id="L32009">                numLoads++;</span>
            }
<span class="nc bnc" id="L32011" title="All 2 branches missed.">            if (numLoads &lt; 1) {</span>
<span class="nc" id="L32012">                MegaMek.getLogger().error(&quot;Check for collapse: hex &quot; + coords.toString() </span>
                        + &quot; has no bridge or building&quot;);
<span class="nc" id="L32014">                return false;</span>
            }

            // Track the load of each floor (and of the roof) separately.
            // Track all units that fall into the basement in this hex.
            // track all floors, ground at index 0, the first floor is at
            // index 1, the second is at index 1, etc., and the roof is
            // at index (numFloors).
            // if bridge is present, bridge will be numFloors+1
<span class="nc" id="L32023">            double[] loads = new double[numLoads + 1];</span>
            // WiGEs flying over the building are also tracked, but can only collapse the top floor
            // and only count 25% of their tonnage.
<span class="nc" id="L32026">            double wigeLoad = 0;</span>
            // track all units that might fall into the basement
<span class="nc" id="L32028">            Vector&lt;Entity&gt; basement = new Vector&lt;&gt;();</span>

<span class="nc" id="L32030">            boolean recheckLoop = true;</span>
<span class="nc bnc" id="L32031" title="All 4 branches missed.">            for (int i = 0; (i &lt; 2) &amp;&amp; recheckLoop; i++) {</span>
<span class="nc" id="L32032">                recheckLoop = false;</span>
<span class="nc" id="L32033">                Arrays.fill(loads, 0);</span>

                // Walk through the entities in this position.
<span class="nc" id="L32036">                Enumeration&lt;Entity&gt; entities = vector.elements();</span>
<span class="nc bnc" id="L32037" title="All 4 branches missed.">                while (!collapse &amp;&amp; entities.hasMoreElements()) {</span>
<span class="nc" id="L32038">                    final Entity entity = entities.nextElement();</span>
                    // WiGEs can collapse the top floor of a building by flying over it.
<span class="nc" id="L32040">                    final int entityElev = entity.getElevation();</span>
<span class="nc bnc" id="L32041" title="All 4 branches missed.">                    final boolean wigeFlyover = entity.getMovementMode() == EntityMovementMode.WIGE</span>
                            &amp;&amp; entityElev == numFloors + 1;

<span class="nc bnc" id="L32044" title="All 4 branches missed.">                    if (entityElev != bridgeEl &amp;&amp; !wigeFlyover) {</span>
                        // Ignore entities not *inside* the building
<span class="nc bnc" id="L32046" title="All 2 branches missed.">                        if (entityElev &gt; numFloors) {</span>
<span class="nc" id="L32047">                            continue;</span>
                        }
                    }
                    
                    // if we're under a bridge, we can't collapse the bridge
<span class="nc bnc" id="L32052" title="All 2 branches missed.">                    if (entityElev &lt; bridgeEl) {</span>
<span class="nc" id="L32053">                        continue;</span>
                    }

<span class="nc bnc" id="L32056" title="All 2 branches missed.">                    if ((entity.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L32057" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L32058" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L32059" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L32060" title="All 2 branches missed.">                            || entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L32061">                        continue; // under the bridge even at same level</span>
                    }

<span class="nc bnc" id="L32064" title="All 2 branches missed.">                    if (entityElev == 0) {</span>
<span class="nc" id="L32065">                        basement.add(entity);</span>
                    }

                    // units already in the basement
<span class="nc bnc" id="L32069" title="All 2 branches missed.">                    if (entityElev &lt; 0) {</span>
<span class="nc" id="L32070">                        continue;</span>
                    }

                    // Add the weight to the correct floor.
<span class="nc" id="L32074">                    double load = entity.getWeight();</span>
<span class="nc" id="L32075">                    int floor = entityElev;</span>
<span class="nc bnc" id="L32076" title="All 2 branches missed.">                    if (floor == bridgeEl) {</span>
<span class="nc" id="L32077">                        floor = numLoads;</span>
                    }
                    // Entities on the roof fall to the previous top floor/new roof
<span class="nc bnc" id="L32080" title="All 4 branches missed.">                    if (topFloorCollapse &amp;&amp; floor == numFloors) {</span>
<span class="nc" id="L32081">                        floor--;</span>
                    }

<span class="nc bnc" id="L32084" title="All 2 branches missed.">                    if (wigeFlyover) {</span>
<span class="nc" id="L32085">                        wigeLoad += load;</span>
<span class="nc bnc" id="L32086" title="All 2 branches missed.">                        if (wigeLoad &gt; currentCF * 4) {</span>
<span class="nc" id="L32087">                            topFloorCollapse = true;</span>
<span class="nc" id="L32088">                            loads[numFloors - 1] += loads[numFloors];</span>
<span class="nc" id="L32089">                            loads[numFloors] = 0;</span>
                        }
                    } else {
<span class="nc" id="L32092">                        loads[floor] += load;</span>
<span class="nc bnc" id="L32093" title="All 2 branches missed.">                        if (loads[floor] &gt; currentCF) {</span>
                            // If the load on any floor but the ground floor
                            // exceeds the building's current CF it collapses.
<span class="nc bnc" id="L32096" title="All 2 branches missed.">                            if (floor != 0) {</span>
<span class="nc" id="L32097">                                collapse = true;</span>
<span class="nc bnc" id="L32098" title="All 2 branches missed.">                            } else if (!bldg.getBasementCollapsed(coords)) {</span>
<span class="nc" id="L32099">                                basementCollapse = true;</span>
                            }
                        }
                    } // End increase-load
<span class="nc" id="L32103">                } // Handle the next entity.</span>

                // Track all entities that fell into the basement.
<span class="nc bnc" id="L32106" title="All 2 branches missed.">                if (basementCollapse) {</span>
<span class="nc" id="L32107">                    basementMap.put(coords, basement);</span>
                }

                // did anyone fall into the basement?
<span class="nc bnc" id="L32111" title="All 6 branches missed.">                if (!basementMap.isEmpty() &amp;&amp; (bldg.getBasement(coords) != BasementType.NONE) &amp;&amp; !collapse) {</span>
<span class="nc" id="L32112">                    collapseBasement(bldg, basementMap, coords, vPhaseReport);</span>
<span class="nc bnc" id="L32113" title="All 2 branches missed.">                    if (currentCF == 0) {</span>
<span class="nc" id="L32114">                        collapse = true;</span>
<span class="nc" id="L32115">                        recheckLoop = false;</span>
                    } else {
<span class="nc" id="L32117">                        recheckLoop = true; // basement collapse might cause a further collapse</span>
                    }
                } else {
<span class="nc" id="L32120">                    recheckLoop = false; // don't check again, we didn't change the CF</span>
                }
<span class="nc bnc" id="L32122" title="All 2 branches missed.">                if (collapse) {</span>
<span class="nc" id="L32123">                    recheckLoop = false;</span>
                    // recheck if the basement collapsed since the basement falls
                    // might trigger a greater collapse.
                }
            } // End have-entities-here
        }

        // Collapse the building if the flag is set.
<span class="nc bnc" id="L32131" title="All 2 branches missed.">        if (collapse) {</span>
<span class="nc" id="L32132">            Report r = new Report(2375, Report.PUBLIC);</span>
<span class="nc" id="L32133">            r.add(bldg.getName());</span>
<span class="nc" id="L32134">            vPhaseReport.add(r);</span>

<span class="nc" id="L32136">            collapseBuilding(bldg, positionMap, coords, false, vPhaseReport);</span>
<span class="nc bnc" id="L32137" title="All 2 branches missed.">        } else if (topFloorCollapse) {</span>
<span class="nc" id="L32138">                Report r = new Report(2376, Report.PUBLIC);</span>
<span class="nc" id="L32139">                r.add(bldg.getName());</span>
<span class="nc" id="L32140">                vPhaseReport.add(r);</span>

<span class="nc" id="L32142">                collapseBuilding(bldg, positionMap, coords, false, true, vPhaseReport);</span>
        }

        // Return true if the building collapsed.
<span class="nc bnc" id="L32146" title="All 4 branches missed.">        return collapse || topFloorCollapse;</span>

    } // End private boolean checkForCollapse( Building, Hashtable )

    public void collapseBuilding(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L32152">        collapseBuilding(bldg, positionMap, coords, true, false, vPhaseReport);</span>
<span class="nc" id="L32153">    }</span>

    public void collapseBuilding(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, boolean collapseAll, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L32157">        collapseBuilding(bldg, positionMap, coords, collapseAll, false, vPhaseReport);</span>
<span class="nc" id="L32158">    }</span>

    /**
     * Collapse a building basement. Inflict the appropriate amount of damage on
     * all entities that fell to the basement. Update all clients.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; that has collapsed.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - The &lt;code&gt;Coords&gt;&lt;/code&gt; of the building basement hex that
     *            has collapsed
     */
    public void collapseBasement(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L32177" title="All 2 branches missed.">        if (!bldg.hasCFIn(coords)) {</span>
<span class="nc" id="L32178">            return;</span>
        }
        int runningCFTotal;
<span class="nc" id="L32181">        runningCFTotal = bldg.getCurrentCF(coords);</span>

        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32184">        final Vector&lt;Entity&gt; entities = positionMap.get(coords);</span>

<span class="nc bnc" id="L32186" title="All 2 branches missed.">        if (bldg.getBasement(coords) == BasementType.NONE) {</span>
<span class="nc" id="L32187">            return;</span>
        } else {
<span class="nc" id="L32189">            bldg.collapseBasement(coords, game.getBoard(), vPhaseReport);</span>
        }

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32193" title="All 2 branches missed.">        if (entities != null) {</span>

            // Sort in elevation order
<span class="nc" id="L32196">            entities.sort((a, b) -&gt; {</span>
<span class="nc bnc" id="L32197" title="All 2 branches missed.">                if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32198">                    return -1;</span>
<span class="nc bnc" id="L32199" title="All 2 branches missed.">                } else if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32200">                    return 1;</span>
                }
<span class="nc" id="L32202">                return 0;</span>
            });
            // Walk through the entities in this position.
<span class="nc bnc" id="L32205" title="All 2 branches missed.">            for (Entity entity : entities) {</span>

                // int floor = entity.getElevation();

<span class="nc" id="L32209">                int cfDamage = (int) Math.ceil(Math.round(entity.getWeight() / 10.0));</span>

                // all entities should fall
                // ASSUMPTION: PSR to avoid pilot damage
<span class="nc" id="L32213">                PilotingRollData psr = entity.getBasePilotingRoll();</span>
<span class="nc" id="L32214">                entity.addPilotingModifierForTerrain(psr, coords);</span>

                // fall into basement
<span class="nc bnc" id="L32217" title="All 2 branches missed.">                if ((bldg.getBasement(coords) == BasementType.TWO_DEEP_HEAD)</span>
<span class="nc bnc" id="L32218" title="All 2 branches missed.">                        || (bldg.getBasement(coords) == BasementType.TWO_DEEP_FEET)) {</span>
<span class="nc" id="L32219">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is falling 2 floors into &quot; + coords.toString());</span>
                    // Damage is determined by the depth of the basement, so a
                    //  fall of 0 elevation is correct in this case
<span class="nc" id="L32222">                    vPhaseReport.addAll(doEntityFall(entity, coords, 0,</span>
<span class="nc" id="L32223">                            Compute.d6(), psr, true, false));</span>
<span class="nc" id="L32224">                    runningCFTotal -= cfDamage * 2;</span>
<span class="nc bnc" id="L32225" title="All 2 branches missed.">                } else if ((bldg.getBasement(coords) != BasementType.NONE)</span>
<span class="nc bnc" id="L32226" title="All 2 branches missed.">                           &amp;&amp; (bldg.getBasement(coords) != BasementType.ONE_DEEP_NORMALINFONLY)) {</span>
<span class="nc" id="L32227">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is falling 1 floor into &quot; + coords.toString());</span>
                    // Damage is determined by the depth of the basement, so a
                    //  fall of 0 elevation is correct in this case
<span class="nc" id="L32230">                    vPhaseReport.addAll(doEntityFall(entity, coords, 0,</span>
<span class="nc" id="L32231">                            Compute.d6(), psr, true, false));</span>
<span class="nc" id="L32232">                    runningCFTotal -= cfDamage;</span>
                } else {
<span class="nc" id="L32234">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is not falling into &quot; + coords.toString());</span>
                }

                // Update this entity.
                // ASSUMPTION: this is the correct thing to do.
<span class="nc" id="L32239">                entityUpdate(entity.getId());</span>

<span class="nc" id="L32241">            } // Handle the next entity.</span>

        } // End have-entities-here.

        // Update the building
<span class="nc bnc" id="L32246" title="All 2 branches missed.">        if (runningCFTotal &lt; 0) {</span>
<span class="nc" id="L32247">            bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32248">            bldg.setPhaseCF(0, coords);</span>
        } else {
<span class="nc" id="L32250">            bldg.setCurrentCF(runningCFTotal, coords);</span>
<span class="nc" id="L32251">            bldg.setPhaseCF(runningCFTotal, coords);</span>
        }
<span class="nc" id="L32253">        sendChangedHex(coords);</span>
<span class="nc" id="L32254">        Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L32255">        buildings.add(bldg);</span>
<span class="nc" id="L32256">        sendChangedBuildings(buildings);</span>
<span class="nc" id="L32257">    }</span>

    /**
     * Collapse a building hex. Inflict the appropriate amount of damage on all
     * entities in the building. Update all clients.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; that has collapsed.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - The &lt;code&gt;Coords&gt;&lt;/code&gt; of the building hex that has
     *            collapsed
     * @param collapseAll
     *            - A &lt;code&gt;boolean&lt;/code&gt; indicating whether or not this
     *            collapse of a hex should be able to collapse the whole
     *            building
     * @param topFloor
     *            - A &lt;code&gt;boolean&lt;/code&gt; indicating that only the top floor collapses
     *              (from a WiGE flying over the top).
     *
     */
    public void collapseBuilding(Building bldg,
            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap, Coords coords,
            boolean collapseAll, boolean topFloor, Vector&lt;Report&gt; vPhaseReport) {
        // sometimes, buildings that reach CF 0 decide against collapsing
        // but we want them to go away anyway, as a building with CF 0 cannot stand
<span class="nc bnc" id="L32287" title="All 2 branches missed.">        final int phaseCF = bldg.hasCFIn(coords) ? bldg.getPhaseCF(coords) : 0;</span>

        // Loop through the hexes in the building, and apply
        // damage to all entities inside or on top of the building.
        Report r;
        
        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32294">        final Vector&lt;Entity&gt; vector = positionMap.get(coords);</span>

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32297" title="All 2 branches missed.">        if (vector != null) {</span>

            // How many levels does this building have in this hex?
<span class="nc" id="L32300">            final IHex curHex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L32301">            final int bridgeEl = curHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L32302">            final int numFloors = Math.max(bridgeEl,</span>
<span class="nc" id="L32303">                    curHex.terrainLevel(Terrains.BLDG_ELEV));</span>

            // Now collapse the building in this hex, so entities fall to
            // the ground
<span class="nc bnc" id="L32307" title="All 4 branches missed.">            if (topFloor &amp;&amp; numFloors &gt; 1) {</span>
<span class="nc" id="L32308">                curHex.removeTerrain(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L32309">                curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.BLDG_ELEV, numFloors - 1));</span>
<span class="nc" id="L32310">                sendChangedHex(coords);</span>
            } else {
<span class="nc" id="L32312">                bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32313">                bldg.setPhaseCF(0, coords);</span>
<span class="nc" id="L32314">                send(createCollapseBuildingPacket(coords));</span>
<span class="nc" id="L32315">                game.getBoard().collapseBuilding(coords);</span>
            }

            // Sort in elevation order
<span class="nc" id="L32319">            vector.sort((a, b) -&gt; {</span>
<span class="nc bnc" id="L32320" title="All 2 branches missed.">                if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32321">                    return -1;</span>
<span class="nc bnc" id="L32322" title="All 2 branches missed.">                } else if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32323">                    return 1;</span>
                }
<span class="nc" id="L32325">                return 0;</span>
            });
            // Walk through the entities in this position.
<span class="nc" id="L32328">            Enumeration&lt;Entity&gt; entities = vector.elements();</span>
<span class="nc bnc" id="L32329" title="All 2 branches missed.">            while (entities.hasMoreElements()) {</span>
<span class="nc" id="L32330">                final Entity entity = entities.nextElement();</span>
                // all gun emplacements are simply destroyed
<span class="nc bnc" id="L32332" title="All 2 branches missed.">                if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L32333">                    vPhaseReport.addAll(destroyEntity(entity, &quot;building collapse&quot;));</span>
<span class="nc" id="L32334">                    addNewLines();</span>
<span class="nc" id="L32335">                    continue;</span>
                }

<span class="nc" id="L32338">                int floor = entity.getElevation();</span>
                // If only the top floor collapses, we only care about units on the top level
                // or on the roof.
<span class="nc bnc" id="L32341" title="All 4 branches missed.">                if (topFloor &amp;&amp; floor &lt; numFloors - 1) {</span>
<span class="nc" id="L32342">                    continue;</span>
                }
                // units trapped in a basement under a collapsing building are
                // destroyed
<span class="nc bnc" id="L32346" title="All 2 branches missed.">                if (floor &lt; 0) {</span>
<span class="nc" id="L32347">                    vPhaseReport.addAll(destroyEntity(entity,</span>
                            &quot;Crushed under building rubble&quot;, false, false));
                }

                // Ignore units above the building / bridge.
<span class="nc bnc" id="L32352" title="All 2 branches missed.">                if (floor &gt; numFloors) {</span>
<span class="nc" id="L32353">                    continue;</span>
                }

                // Treat units on the roof like
                // they were in the top floor.
<span class="nc bnc" id="L32358" title="All 2 branches missed.">                if (floor == numFloors) {</span>
<span class="nc" id="L32359">                    floor--;</span>
                }

                // Calculate collapse damage for this entity.
<span class="nc" id="L32363">                int damage = (int) Math.floor(bldg.getDamageFromScale()</span>
<span class="nc" id="L32364">                        * Math.ceil((phaseCF * (numFloors - floor)) / 10.0));</span>

                // Infantry suffer more damage.
<span class="nc bnc" id="L32367" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc bnc" id="L32368" title="All 4 branches missed.">                    if ((entity instanceof BattleArmor) || ((Infantry) entity).isMechanized()) {</span>
<span class="nc" id="L32369">                        damage *= 2;</span>
                    } else {
<span class="nc" id="L32371">                        damage *= 3;</span>
                    }
                }

                // Apply collapse damage the entity.
<span class="nc" id="L32376">                r = new Report(6455);</span>
<span class="nc" id="L32377">                r.indent();</span>
<span class="nc" id="L32378">                r.subject = entity.getId();</span>
<span class="nc" id="L32379">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L32380">                r.add(damage);</span>
<span class="nc" id="L32381">                vPhaseReport.add(r);</span>
<span class="nc" id="L32382">                int remaining = damage;</span>
<span class="nc" id="L32383">                int cluster = damage;</span>
<span class="nc bnc" id="L32384" title="All 6 branches missed.">                if ((entity instanceof BattleArmor) || (entity instanceof Mech)</span>
                        || (entity instanceof Tank)) {
<span class="nc" id="L32386">                    cluster = 5;</span>
                }
<span class="nc bnc" id="L32388" title="All 2 branches missed.">                while (remaining &gt; 0) {</span>
<span class="nc" id="L32389">                    int next = Math.min(cluster, remaining);</span>
                    int table;
<span class="nc bnc" id="L32391" title="All 2 branches missed.">                    if (entity instanceof Protomech) {</span>
<span class="nc" id="L32392">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
<span class="nc bnc" id="L32393" title="All 2 branches missed.">                    } else if (entity.getElevation() == numFloors) {</span>
<span class="nc" id="L32394">                        table = ToHitData.HIT_NORMAL;</span>
                    } else {
<span class="nc" id="L32396">                        table = ToHitData.HIT_PUNCH;</span>
                    }
<span class="nc" id="L32398">                    HitData hit = entity.rollHitLocation(table, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L32399">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L32400">                    vPhaseReport.addAll(damageEntity(entity, hit, next));</span>
<span class="nc" id="L32401">                    remaining -= next;</span>
<span class="nc" id="L32402">                }</span>
<span class="nc" id="L32403">                vPhaseReport.add(new Report(1210, Report.PUBLIC));</span>

                // all entities should fall
<span class="nc" id="L32406">                floor = entity.getElevation();</span>
<span class="nc bnc" id="L32407" title="All 4 branches missed.">                if ((floor &gt; 0) || (floor == bridgeEl)) {</span>
                    // ASSUMPTION: PSR to avoid pilot damage
                    // should use mods for entity damage and
                    // 20+ points of collapse damage (if any).
<span class="nc" id="L32411">                    PilotingRollData psr = entity.getBasePilotingRoll();</span>
<span class="nc" id="L32412">                    entity.addPilotingModifierForTerrain(psr, coords);</span>
<span class="nc bnc" id="L32413" title="All 2 branches missed.">                    if (damage &gt;= 20) {</span>
<span class="nc" id="L32414">                        psr.addModifier(1, &quot;20+ damage&quot;);</span>
                    }
<span class="nc" id="L32416">                    vPhaseReport.addAll(doEntityFallsInto(entity, coords, psr,</span>
                            true));
                }
                // Update this entity.
                // ASSUMPTION: this is the correct thing to do.
<span class="nc" id="L32421">                entityUpdate(entity.getId());</span>

<span class="nc" id="L32423">            } // Handle the next entity.</span>

<span class="nc" id="L32425">        } // End have-entities-here.</span>

        else {
            // Update the building.
<span class="nc" id="L32429">            bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32430">            bldg.setPhaseCF(0, coords);</span>
<span class="nc" id="L32431">            send(createCollapseBuildingPacket(coords));</span>
<span class="nc" id="L32432">            game.getBoard().collapseBuilding(coords);</span>
        }
        // if more than half of the hexes are gone, collapse all
<span class="nc bnc" id="L32435" title="All 2 branches missed.">        if (bldg.getCollapsedHexCount() &gt; (bldg.getOriginalHexCount() / 2)) {</span>
<span class="nc" id="L32436">            for (Enumeration&lt;Coords&gt; coordsEnum = bldg.getCoords(); coordsEnum</span>
<span class="nc bnc" id="L32437" title="All 2 branches missed.">                    .hasMoreElements();) {</span>
<span class="nc" id="L32438">                coords = coordsEnum.nextElement();</span>
<span class="nc" id="L32439">                collapseBuilding(bldg, game.getPositionMap(), coords, false,</span>
                        vPhaseReport);
            }
        }

<span class="nc" id="L32444">    } // End private void collapseBuilding( Building )</span>

    /**
     * Tell the clients to replace the given building with rubble hexes.
     *
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; that has collapsed.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createCollapseBuildingPacket(Coords coords) {
<span class="nc" id="L32453">        Vector&lt;Coords&gt; coordsV = new Vector&lt;&gt;();</span>
<span class="nc" id="L32454">        coordsV.addElement(coords);</span>
<span class="nc" id="L32455">        return createCollapseBuildingPacket(coordsV);</span>
    }

    /**
     * Tell the clients to replace the given building hexes with rubble hexes.
     *
     * @param coords - a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Coords&lt;/code&gt;s that has
     *               collapsed.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createCollapseBuildingPacket(Vector&lt;Coords&gt; coords) {
<span class="nc" id="L32466">        return new Packet(Packet.COMMAND_BLDG_COLLAPSE, coords);</span>
    }

    /**
     * Tell the clients to update the CFs of the given buildings.
     *
     * @param buildings - a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Building&lt;/code&gt;s that need to
     *                  be updated.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createUpdateBuildingPacket(Vector&lt;Building&gt; buildings) {
<span class="nc" id="L32477">        return new Packet(Packet.COMMAND_BLDG_UPDATE, buildings);</span>
    }

    /**
     * Apply this phase's damage to all buildings. Buildings may collapse due to
     * damage.
     */
    private void applyBuildingDamage() {

        // Walk through the buildings in the game.
        // Build the collapse and update vectors as you go.
        // N.B. never, NEVER, collapse buildings while you are walking through
        // the Enumeration from megamek.common.Board#getBuildings.
<span class="nc" id="L32490">        Map&lt;Building, Vector&lt;Coords&gt;&gt; collapse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L32491">        Map&lt;Building, Vector&lt;Coords&gt;&gt; update = new HashMap&lt;&gt;();</span>
<span class="nc" id="L32492">        Enumeration&lt;Building&gt; buildings = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L32493" title="All 2 branches missed.">        while (buildings.hasMoreElements()) {</span>
<span class="nc" id="L32494">            Building bldg = buildings.nextElement();</span>
<span class="nc" id="L32495">            Vector&lt;Coords&gt; collapseCoords = new Vector&lt;&gt;();</span>
<span class="nc" id="L32496">            Vector&lt;Coords&gt; updateCoords = new Vector&lt;&gt;();</span>
<span class="nc" id="L32497">            Enumeration&lt;Coords&gt; buildingCoords = bldg.getCoords();</span>
<span class="nc bnc" id="L32498" title="All 2 branches missed.">            while (buildingCoords.hasMoreElements()) {</span>
<span class="nc" id="L32499">                Coords coords = buildingCoords.nextElement();</span>
                // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32501" title="All 2 branches missed.">                if (bldg.getCurrentCF(coords) == 0) {</span>
<span class="nc" id="L32502">                    collapseCoords.addElement(coords);</span>
                }
                // If the building took damage this round, update it.
<span class="nc bnc" id="L32505" title="All 2 branches missed.">                else if (bldg.getPhaseCF(coords) != bldg.getCurrentCF(coords)) {</span>
<span class="nc" id="L32506">                    bldg.setPhaseCF(bldg.getCurrentCF(coords), coords);</span>
<span class="nc" id="L32507">                    updateCoords.addElement(coords);</span>
                }
<span class="nc" id="L32509">            }</span>
<span class="nc" id="L32510">            collapse.put(bldg, collapseCoords);</span>
<span class="nc" id="L32511">            update.put(bldg, updateCoords);</span>
<span class="nc" id="L32512">        } // Handle the next building</span>

        // If we have any buildings to collapse, collapse them now.
<span class="nc bnc" id="L32515" title="All 2 branches missed.">        if (!collapse.isEmpty()) {</span>

            // Get the position map of all entities in the game.
<span class="nc" id="L32518">            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game</span>
<span class="nc" id="L32519">                    .getPositionMap();</span>

            // Walk through the hexes that have collapsed.
<span class="nc bnc" id="L32522" title="All 2 branches missed.">            for (Building bldg : collapse.keySet()) {</span>
<span class="nc" id="L32523">                Vector&lt;Coords&gt; coordsVector = collapse.get(bldg);</span>
<span class="nc bnc" id="L32524" title="All 2 branches missed.">                for (Coords coords : coordsVector) {</span>
<span class="nc" id="L32525">                    Report r = new Report(6460, Report.PUBLIC);</span>
<span class="nc" id="L32526">                    r.add(bldg.getName());</span>
<span class="nc" id="L32527">                    addReport(r);</span>
<span class="nc" id="L32528">                    collapseBuilding(bldg, positionMap, coords, vPhaseReport);</span>
<span class="nc" id="L32529">                }</span>
<span class="nc" id="L32530">            }</span>
        }

        // check for buildings which should collapse due to being overloaded now
        // CF is reduced
<span class="nc bnc" id="L32535" title="All 2 branches missed.">        if (!update.isEmpty()) {</span>
<span class="nc" id="L32536">            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>
<span class="nc bnc" id="L32537" title="All 2 branches missed.">            for (Building bldg : update.keySet()) {</span>
<span class="nc" id="L32538">                Vector&lt;Coords&gt; updateCoords = update.get(bldg);</span>
<span class="nc" id="L32539">                Vector&lt;Coords&gt; coordsToRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32540" title="All 2 branches missed.">                for (Coords coords : updateCoords) {</span>
<span class="nc bnc" id="L32541" title="All 2 branches missed.">                    if (checkForCollapse(bldg, positionMap, coords, false,</span>
                                         vPhaseReport)) {
<span class="nc" id="L32543">                        coordsToRemove.add(coords);</span>
                    }
<span class="nc" id="L32545">                }</span>
<span class="nc" id="L32546">                updateCoords.removeAll(coordsToRemove);</span>
<span class="nc" id="L32547">                update.put(bldg, updateCoords);</span>
<span class="nc" id="L32548">            }</span>
        }

        // If we have any buildings to update, send the message.
<span class="nc bnc" id="L32552" title="All 2 branches missed.">        if (!update.isEmpty()) {</span>
<span class="nc" id="L32553">            sendChangedBuildings(new Vector&lt;&gt;(update.keySet()));</span>
        }
<span class="nc" id="L32555">    }</span>

    /**
     * Apply the given amount of damage to the building. Please note, this
     * method does &lt;b&gt;not&lt;/b&gt; apply any damage to units inside the building,
     * update the clients, or check for the building's collapse.
     * &lt;p/&gt;
     * A default message will be used to describe why the building took the
     * damage.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that has been damaged. This value
     *               should not be &lt;code&gt;null&lt;/code&gt;, but no exception will occur.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be damaged
     * @return a &lt;code&gt;Report&lt;/code&gt; to be shown to the players.
     */
    public Vector&lt;Report&gt; damageBuilding(Building bldg, int damage,
                                         Coords coords) {
<span class="nc" id="L32573">        final String defaultWhy = &quot; absorbs &quot;;</span>
<span class="nc" id="L32574">        return damageBuilding(bldg, damage, defaultWhy, coords);</span>
    }

    /**
     * Apply the given amount of damage to the building. Please note, this
     * method does &lt;b&gt;not&lt;/b&gt; apply any damage to units inside the building,
     * update the clients, or check for the building's collapse.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that has been damaged. This value
     *               should not be &lt;code&gt;null&lt;/code&gt;, but no exception will occur.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param why    - the &lt;code&gt;String&lt;/code&gt; message that describes why the
     *               building took the damage.
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be damaged
     * @return a &lt;code&gt;Report&lt;/code&gt; to be shown to the players.
     */
    public Vector&lt;Report&gt; damageBuilding(Building bldg, int damage, String why, Coords coords) {
<span class="nc" id="L32591">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L32592">        Report r = new Report(1210, Report.PUBLIC);</span>

        // Do nothing if no building or no damage was passed.
<span class="nc bnc" id="L32595" title="All 4 branches missed.">        if ((bldg != null) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L32596">            r.messageId = 3435;</span>
<span class="nc" id="L32597">            r.add(bldg.toString());</span>
<span class="nc" id="L32598">            r.add(why);</span>
<span class="nc" id="L32599">            r.add(damage);</span>
<span class="nc" id="L32600">            vPhaseReport.add(r);</span>
<span class="nc" id="L32601">            int curArmor = bldg.getArmor(coords);</span>
<span class="nc bnc" id="L32602" title="All 2 branches missed.">            if (curArmor &gt;= damage) {</span>
<span class="nc" id="L32603">                curArmor -= Math.min(curArmor, damage);</span>
<span class="nc" id="L32604">                bldg.setArmor(curArmor, coords);</span>
<span class="nc" id="L32605">                r = new Report(3436, Report.PUBLIC);</span>
<span class="nc" id="L32606">                r.indent(0);</span>
<span class="nc" id="L32607">                r.add(damage);</span>
<span class="nc" id="L32608">                r.add(curArmor);</span>
<span class="nc" id="L32609">                vPhaseReport.add(r);</span>
            } else {
<span class="nc" id="L32611">                r.add(damage);</span>
<span class="nc bnc" id="L32612" title="All 2 branches missed.">                if (curArmor &gt; 0) {</span>
<span class="nc" id="L32613">                    bldg.setArmor(0, coords);</span>
<span class="nc" id="L32614">                    damage = damage - curArmor;</span>
<span class="nc" id="L32615">                    r = new Report(3436, Report.PUBLIC);</span>
<span class="nc" id="L32616">                    r.indent(0);</span>
<span class="nc" id="L32617">                    r.add(curArmor);</span>
<span class="nc" id="L32618">                    r.add(0);</span>
<span class="nc" id="L32619">                    vPhaseReport.add(r);</span>
                }
<span class="nc" id="L32621">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
<span class="nc bnc" id="L32622" title="All 2 branches missed.">                if (bldg.getDamageToScale() &lt; 1.0) {</span>
<span class="nc" id="L32623">                    r = new Report(3437, Report.PUBLIC);</span>
<span class="nc" id="L32624">                    r.indent(0);</span>
<span class="nc" id="L32625">                    r.add(damage);</span>
<span class="nc" id="L32626">                    vPhaseReport.add(r);</span>
                }
<span class="nc bnc" id="L32628" title="All 2 branches missed.">                if (bldg.getDamageToScale() &gt; 1.0) {</span>
<span class="nc" id="L32629">                    r = new Report(3438, Report.PUBLIC);</span>
<span class="nc" id="L32630">                    r.indent(0);</span>
<span class="nc" id="L32631">                    r.add(damage);</span>
<span class="nc" id="L32632">                    vPhaseReport.add(r);</span>
                }
<span class="nc" id="L32634">                int curCF = bldg.getCurrentCF(coords);</span>
<span class="nc" id="L32635">                final int startingCF = curCF;</span>
<span class="nc" id="L32636">                curCF -= Math.min(curCF, damage);</span>
<span class="nc" id="L32637">                bldg.setCurrentCF(curCF, coords);</span>

<span class="nc" id="L32639">                r = new Report(6436, Report.PUBLIC);</span>
<span class="nc" id="L32640">                r.indent(1);</span>
<span class="nc bnc" id="L32641" title="All 2 branches missed.">                String fontColorOpen = curCF &lt;= 0 ? &quot;&lt;font color='C00000'&gt;&quot; : &quot;&quot;;</span>
<span class="nc bnc" id="L32642" title="All 2 branches missed.">                String fontColorClose = curCF &lt;= 0 ? &quot;&lt;/font&gt;&quot; : &quot;&quot;;</span>
<span class="nc" id="L32643">                r.add(String.format(&quot;%s%s%s&quot;, fontColorOpen, curCF, fontColorClose));</span>
<span class="nc" id="L32644">                vPhaseReport.add(r);</span>

<span class="nc" id="L32646">                final int damageThresh = (int) Math.ceil(bldg.getPhaseCF(coords) / 10.0);</span>

                // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32649" title="All 4 branches missed.">                if ((curCF == 0) &amp;&amp; (startingCF != 0)) {</span>
<span class="nc bnc" id="L32650" title="All 2 branches missed.">                    if (bldg instanceof FuelTank) {</span>
                        // If this is a fuel tank, we'll give it its own
                        // message.
<span class="nc" id="L32653">                        r = new Report(3441);</span>
<span class="nc" id="L32654">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32655">                        r.indent(0);</span>
<span class="nc" id="L32656">                        vPhaseReport.add(r);</span>
                        // ...But we ALSO need to blow up everything nearby.
                        // Bwahahahahaha...
<span class="nc" id="L32659">                        r = new Report(3560);</span>
<span class="nc" id="L32660">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32661">                        r.newlines = 1;</span>
<span class="nc" id="L32662">                        vPhaseReport.add(r);</span>
<span class="nc" id="L32663">                        Vector&lt;Report&gt; vRep = new Vector&lt;&gt;();</span>
<span class="nc" id="L32664">                        doExplosion(((FuelTank) bldg).getMagnitude(), 10,</span>
<span class="nc" id="L32665">                                false, bldg.getCoords().nextElement(), true,</span>
                                vRep, null, -1);
<span class="nc" id="L32667">                        Report.indentAll(vRep, 2);</span>
<span class="nc" id="L32668">                        vPhaseReport.addAll(vRep);</span>
<span class="nc" id="L32669">                        return vPhaseReport;</span>
                    }
<span class="nc bnc" id="L32671" title="All 2 branches missed.">                    if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L32672">                        r = new Report(3442);</span>
<span class="nc" id="L32673">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32674">                        r.indent(0);</span>
<span class="nc" id="L32675">                        vPhaseReport.add(r);</span>
                    } else {
<span class="nc" id="L32677">                        r = new Report(3440);</span>
<span class="nc" id="L32678">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32679">                        r.indent(0);</span>
<span class="nc" id="L32680">                        vPhaseReport.add(r);</span>
                    }
<span class="nc bnc" id="L32682" title="All 4 branches missed.">                } else if ((curCF &lt; startingCF) &amp;&amp; (damage &gt; damageThresh)) {</span>
                    // need to check for crits
                    // don't bother unless we have some gun emplacements
<span class="nc" id="L32685">                    Vector&lt;GunEmplacement&gt; guns = game</span>
<span class="nc" id="L32686">                            .getGunEmplacements(coords);</span>
<span class="nc bnc" id="L32687" title="All 2 branches missed.">                    if (guns.size() &gt; 0) {</span>
<span class="nc" id="L32688">                        vPhaseReport.addAll(criticalGunEmplacement(guns, bldg,</span>
                                coords));
                    }
                }
            }
        }
<span class="nc" id="L32694">        Report.indentAll(vPhaseReport, 2);</span>
<span class="nc" id="L32695">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; criticalGunEmplacement(Vector&lt;GunEmplacement&gt; guns, Building bldg,
                                                  Coords coords) {
<span class="nc" id="L32700">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L32702">        r = new Report(3800);</span>
<span class="nc" id="L32703">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32704">        r.indent(0);</span>
<span class="nc" id="L32705">        vDesc.add(r);</span>

<span class="nc" id="L32707">        int critRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L32708" title="All 2 branches missed.">        if (critRoll &lt; 6) {</span>
<span class="nc" id="L32709">            r = new Report(3805);</span>
<span class="nc" id="L32710">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32711">            r.indent(1);</span>
<span class="nc" id="L32712">            vDesc.add(r);</span>
<span class="nc bnc" id="L32713" title="All 2 branches missed.">        } else if (critRoll == 6) {</span>
            // weapon malfunction
            // lets just randomly determine which weapon gets hit
<span class="nc" id="L32716">            Vector&lt;Mounted&gt; wpns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32717" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32718" title="All 2 branches missed.">                for (Mounted wpn : gun.getWeaponList()) {</span>
<span class="nc bnc" id="L32719" title="All 4 branches missed.">                    if (!wpn.isHit() &amp;&amp; !wpn.isJammed()</span>
<span class="nc bnc" id="L32720" title="All 2 branches missed.">                        &amp;&amp; !wpn.jammedThisPhase()) {</span>
<span class="nc" id="L32721">                        wpns.add(wpn);</span>
                    }
<span class="nc" id="L32723">                }</span>
<span class="nc" id="L32724">            }</span>
<span class="nc bnc" id="L32725" title="All 2 branches missed.">            if (wpns.size() &gt; 0) {</span>
<span class="nc" id="L32726">                Mounted weapon = wpns.elementAt(Compute.randomInt(wpns.size()));</span>
<span class="nc" id="L32727">                weapon.setJammed(true);</span>
<span class="nc" id="L32728">                ((GunEmplacement) weapon.getEntity()).addJammedWeapon(weapon);</span>
<span class="nc" id="L32729">                r = new Report(3845);</span>
<span class="nc" id="L32730">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32731">                r.indent(1);</span>
<span class="nc" id="L32732">                r.add(weapon.getDesc());</span>
<span class="nc" id="L32733">            } else {</span>
<span class="nc" id="L32734">                r = new Report(3846);</span>
<span class="nc" id="L32735">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32736">                r.indent(1);</span>
            }
<span class="nc" id="L32738">            vDesc.add(r);</span>
<span class="nc bnc" id="L32739" title="All 2 branches missed.">        } else if (critRoll == 7) {</span>
            // gunners stunned
<span class="nc bnc" id="L32741" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32742">                gun.stunCrew();</span>
<span class="nc" id="L32743">                r = new Report(3810);</span>
<span class="nc" id="L32744">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32745">                r.indent(1);</span>
<span class="nc" id="L32746">                vDesc.add(r);</span>
<span class="nc" id="L32747">            }</span>
<span class="nc bnc" id="L32748" title="All 2 branches missed.">        } else if (critRoll == 8) {</span>
            // weapon destroyed
            // lets just randomly determine which weapon gets hit
<span class="nc" id="L32751">            Vector&lt;Mounted&gt; wpns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32752" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32753" title="All 2 branches missed.">                for (Mounted wpn : gun.getWeaponList()) {</span>
<span class="nc bnc" id="L32754" title="All 2 branches missed.">                    if (!wpn.isHit()) {</span>
<span class="nc" id="L32755">                        wpns.add(wpn);</span>
                    }
<span class="nc" id="L32757">                }</span>
<span class="nc" id="L32758">            }</span>
<span class="nc bnc" id="L32759" title="All 2 branches missed.">            if (wpns.size() &gt; 0) {</span>
<span class="nc" id="L32760">                Mounted weapon = wpns.elementAt(Compute.randomInt(wpns.size()));</span>
<span class="nc" id="L32761">                weapon.setHit(true);</span>
<span class="nc" id="L32762">                r = new Report(3840);</span>
<span class="nc" id="L32763">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32764">                r.indent(1);</span>
<span class="nc" id="L32765">                r.add(weapon.getDesc());</span>
<span class="nc" id="L32766">            } else {</span>
<span class="nc" id="L32767">                r = new Report(3841);</span>
<span class="nc" id="L32768">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32769">                r.indent(1);</span>
            }
<span class="nc" id="L32771">            vDesc.add(r);</span>
<span class="nc bnc" id="L32772" title="All 2 branches missed.">        } else if (critRoll == 9) {</span>
            // gunners killed
<span class="nc" id="L32774">            r = new Report(3815);</span>
<span class="nc" id="L32775">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32776">            r.indent(1);</span>
<span class="nc" id="L32777">            vDesc.add(r);</span>
<span class="nc bnc" id="L32778" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32779">                gun.getCrew().setDoomed(true);</span>
<span class="nc" id="L32780">            }</span>
<span class="nc bnc" id="L32781" title="All 2 branches missed.">        } else if (critRoll == 10) {</span>
<span class="nc bnc" id="L32782" title="All 2 branches missed.">            if (Compute.d6() &gt; 3) {</span>
                // turret lock
<span class="nc" id="L32784">                r = new Report(3820);</span>
<span class="nc" id="L32785">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32786">                r.indent(1);</span>
<span class="nc" id="L32787">                vDesc.add(r);</span>
<span class="nc bnc" id="L32788" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32789">                    gun.lockTurret(gun.getLocTurret());</span>
<span class="nc" id="L32790">                }</span>
            } else {
                // turret jam
<span class="nc" id="L32793">                r = new Report(3825);</span>
<span class="nc" id="L32794">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32795">                r.indent(1);</span>
<span class="nc" id="L32796">                vDesc.add(r);</span>
<span class="nc bnc" id="L32797" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32798" title="All 2 branches missed.">                    if (gun.isTurretEverJammed(gun.getLocTurret())) {</span>
<span class="nc" id="L32799">                        gun.lockTurret(gun.getLocTurret());</span>
                    } else {
<span class="nc" id="L32801">                        gun.jamTurret(gun.getLocTurret());</span>
                    }
<span class="nc" id="L32803">                }</span>
            }
<span class="nc bnc" id="L32805" title="All 2 branches missed.">        } else if (critRoll == 11) {</span>
<span class="nc" id="L32806">            r = new Report(3830);</span>
<span class="nc" id="L32807">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32808">            r.indent(1);</span>
<span class="nc" id="L32809">            r.add(bldg.getName());</span>
<span class="nc" id="L32810">            int boom = 0;</span>
<span class="nc bnc" id="L32811" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32812" title="All 2 branches missed.">                for (Mounted ammo : gun.getAmmo()) {</span>
<span class="nc" id="L32813">                    ammo.setHit(true);</span>
<span class="nc bnc" id="L32814" title="All 2 branches missed.">                    if (ammo.getType().isExplosive(ammo)) {</span>
<span class="nc" id="L32815">                        boom += ammo.getHittableShotsLeft()</span>
<span class="nc" id="L32816">                                * ((AmmoType) ammo.getType())</span>
<span class="nc" id="L32817">                                .getDamagePerShot()</span>
<span class="nc" id="L32818">                                * ((AmmoType) ammo.getType()).getRackSize();</span>
                    }
<span class="nc" id="L32820">                }</span>
<span class="nc" id="L32821">            }</span>
<span class="nc" id="L32822">            boom = (int) Math.floor(bldg.getDamageToScale() * boom);</span>
            
<span class="nc bnc" id="L32824" title="All 2 branches missed.">            if (boom == 0) {</span>
<span class="nc" id="L32825">                Report rNoAmmo = new Report(3831);</span>
<span class="nc" id="L32826">                rNoAmmo.type = Report.PUBLIC;</span>
<span class="nc" id="L32827">                rNoAmmo.indent(1);</span>
<span class="nc" id="L32828">                vDesc.add(rNoAmmo);</span>
<span class="nc" id="L32829">                return vDesc;</span>
            }
            
<span class="nc" id="L32832">            r.add(boom);</span>
<span class="nc" id="L32833">            int curCF = bldg.getCurrentCF(coords);</span>
<span class="nc" id="L32834">            curCF -= Math.min(curCF, boom);</span>
<span class="nc" id="L32835">            bldg.setCurrentCF(curCF, coords);</span>
<span class="nc" id="L32836">            r.add(bldg.getCurrentCF(coords));</span>
<span class="nc" id="L32837">            vDesc.add(r);</span>
            // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32839" title="All 4 branches missed.">            if ((curCF == 0) &amp;&amp; (bldg.getPhaseCF(coords) != 0)) {</span>
                
                // when a building collapses due to an ammo explosion, we can consider
                // that turret annihilated for the purposes of salvage.
<span class="nc bnc" id="L32843" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32844">                    vDesc.addAll(destroyEntity(gun, &quot;ammo explosion&quot;, false, false));</span>
<span class="nc" id="L32845">                }</span>
                
<span class="nc bnc" id="L32847" title="All 2 branches missed.">                if (bldg instanceof FuelTank) {</span>
                    // If this is a fuel tank, we'll give it its own
                    // message.
<span class="nc" id="L32850">                    r = new Report(3441);</span>
<span class="nc" id="L32851">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L32852">                    r.indent(0);</span>
<span class="nc" id="L32853">                    vDesc.add(r);</span>
                    // ...But we ALSO need to blow up everything nearby.
                    // Bwahahahahaha...
<span class="nc" id="L32856">                    r = new Report(3560);</span>
<span class="nc" id="L32857">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L32858">                    r.newlines = 1;</span>
<span class="nc" id="L32859">                    vDesc.add(r);</span>
<span class="nc" id="L32860">                    Vector&lt;Report&gt; vRep = new Vector&lt;&gt;();</span>
<span class="nc" id="L32861">                    doExplosion(((FuelTank) bldg).getMagnitude(), 10, false,</span>
<span class="nc" id="L32862">                                bldg.getCoords().nextElement(), true, vRep, null,</span>
                                -1);
<span class="nc" id="L32864">                    Report.indentAll(vRep, 2);</span>
<span class="nc" id="L32865">                    vDesc.addAll(vRep);</span>
<span class="nc" id="L32866">                    return vPhaseReport;</span>
                }
<span class="nc bnc" id="L32868" title="All 2 branches missed.">                if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L32869">                    r = new Report(3442);</span>
                } else {
<span class="nc" id="L32871">                    r = new Report(3440);</span>
                }
<span class="nc" id="L32873">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32874">                r.indent(0);</span>
<span class="nc" id="L32875">                vDesc.add(r);</span>
            }
<span class="nc bnc" id="L32877" title="All 2 branches missed.">        } else if (critRoll == 12) {</span>
            // non-weapon equipment is hit
<span class="nc" id="L32879">            Vector&lt;Mounted&gt; equipmentList = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32880" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32881" title="All 2 branches missed.">                for (Mounted equipment : gun.getMisc()) {</span>
<span class="nc bnc" id="L32882" title="All 2 branches missed.">                    if (!equipment.isHit()) {</span>
<span class="nc" id="L32883">                        equipmentList.add(equipment);</span>
                    }
<span class="nc" id="L32885">                }</span>
<span class="nc" id="L32886">            }</span>
            
<span class="nc bnc" id="L32888" title="All 2 branches missed.">            if (equipmentList.size() &gt; 0) {</span>
<span class="nc" id="L32889">                Mounted equipment = equipmentList.elementAt(Compute.randomInt(equipmentList.size()));</span>
<span class="nc" id="L32890">                equipment.setHit(true);</span>
<span class="nc" id="L32891">                r = new Report(3840);</span>
<span class="nc" id="L32892">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32893">                r.indent(1);</span>
<span class="nc" id="L32894">                r.add(equipment.getDesc());</span>
<span class="nc" id="L32895">            } else {</span>
<span class="nc" id="L32896">                r = new Report(3835);</span>
<span class="nc" id="L32897">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32898">                r.indent(1);</span>
            }
<span class="nc" id="L32900">            vDesc.add(r);</span>
        }

<span class="nc" id="L32903">        return vDesc;</span>
    }

    public void sendChangedBuildings(Vector&lt;Building&gt; buildings) {
<span class="nc" id="L32907">        send(createUpdateBuildingPacket(buildings));</span>
<span class="nc" id="L32908">    }</span>

    /**
     * Receives an packet to unload entity is stranded on immobile transports,
     * and queue all valid requests for execution. If all players that have
     * stranded entities have answered, executes the pending requests and end
     * the current turn.
     */
    private void receiveUnloadStranded(Packet packet, int connId) {
        GameTurn.UnloadStrandedTurn turn;
<span class="nc" id="L32918">        final IPlayer player = game.getPlayer(connId);</span>
<span class="nc" id="L32919">        int[] entityIds = (int[]) packet.getObject(0);</span>
        Vector&lt;IPlayer&gt; declared;
        IPlayer other;
        Enumeration&lt;EntityAction&gt; pending;
        UnloadStrandedAction action;
        Entity entity;

        // Is this the right phase?
<span class="nc bnc" id="L32927" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L32928">            MegaMek.getLogger().error(&quot;Server got unload stranded packet in wrong phase&quot;);</span>
<span class="nc" id="L32929">            return;</span>
        }

        // Are we in an &quot;unload stranded entities&quot; turn?
<span class="nc bnc" id="L32933" title="All 2 branches missed.">        if (game.getTurn() instanceof GameTurn.UnloadStrandedTurn) {</span>
<span class="nc" id="L32934">            turn = (GameTurn.UnloadStrandedTurn) game.getTurn();</span>
        } else {
<span class="nc" id="L32936">            MegaMek.getLogger().error(&quot;Server got unload stranded packet out of sequence&quot;);</span>
<span class="nc" id="L32937">            sendServerChat(player.getName() + &quot; should not be sending 'unload stranded entity' packets at this time.&quot;);</span>
<span class="nc" id="L32938">            return;</span>
        }

        // Can this player act right now?
<span class="nc bnc" id="L32942" title="All 2 branches missed.">        if (!turn.isValid(connId, game)) {</span>
<span class="nc" id="L32943">            MegaMek.getLogger().error(&quot;Server got unload stranded packet from invalid player&quot;);</span>
<span class="nc" id="L32944">            sendServerChat(player.getName() + &quot; should not be sending 'unload stranded entity' packets.&quot;);</span>
<span class="nc" id="L32945">            return;</span>
        }

        // Did the player already send an 'unload' request?
        // N.B. we're also building the list of players who
        // have declared their &quot;unload stranded&quot; actions.
<span class="nc" id="L32951">        declared = new Vector&lt;&gt;();</span>
<span class="nc" id="L32952">        pending = game.getActions();</span>
<span class="nc bnc" id="L32953" title="All 2 branches missed.">        while (pending.hasMoreElements()) {</span>
<span class="nc" id="L32954">            action = (UnloadStrandedAction) pending.nextElement();</span>
<span class="nc bnc" id="L32955" title="All 2 branches missed.">            if (action.getPlayerId() == connId) {</span>
<span class="nc" id="L32956">                MegaMek.getLogger().error(&quot;Server got multiple unload stranded packets from player&quot;);</span>
<span class="nc" id="L32957">                sendServerChat(player.getName() + &quot; should not send multiple 'unload stranded entity' packets.&quot;);</span>
<span class="nc" id="L32958">                return;</span>
            }
            // This player is not from the current connection.
            // Record this player to determine if this turn is done.
<span class="nc" id="L32962">            other = game.getPlayer(action.getPlayerId());</span>
<span class="nc bnc" id="L32963" title="All 2 branches missed.">            if (!declared.contains(other)) {</span>
<span class="nc" id="L32964">                declared.addElement(other);</span>
            }
        } // Handle the next &quot;unload stranded&quot; action.

        // Make sure the player selected at least *one* valid entity ID.
<span class="nc" id="L32969">        boolean foundValid = false;</span>
<span class="nc bnc" id="L32970" title="All 4 branches missed.">        for (int index = 0; (null != entityIds) &amp;&amp; (index &lt; entityIds.length); index++) {</span>
<span class="nc" id="L32971">            entity = game.getEntity(entityIds[index]);</span>
<span class="nc bnc" id="L32972" title="All 2 branches missed.">            if (!game.getTurn().isValid(connId, entity, game)) {</span>
<span class="nc" id="L32973">                MegaMek.getLogger().error(&quot;Server got unload stranded packet for invalid entity&quot;);</span>
<span class="nc" id="L32974">                StringBuilder message = new StringBuilder();</span>
<span class="nc" id="L32975">                message.append(player.getName()).append(&quot; can not unload stranded entity &quot;);</span>
<span class="nc bnc" id="L32976" title="All 2 branches missed.">                if (null == entity) {</span>
<span class="nc" id="L32977">                    message.append('#').append(entityIds[index]);</span>
                } else {
<span class="nc" id="L32979">                    message.append(entity.getDisplayName());</span>
                }
<span class="nc" id="L32981">                message.append(&quot; at this time.&quot;);</span>
<span class="nc" id="L32982">                sendServerChat(message.toString());</span>
<span class="nc" id="L32983">            } else {</span>
<span class="nc" id="L32984">                foundValid = true;</span>
<span class="nc" id="L32985">                game.addAction(new UnloadStrandedAction(connId, entityIds[index]));</span>
            }
        }

        // Did the player choose not to unload any valid stranded entity?
<span class="nc bnc" id="L32990" title="All 2 branches missed.">        if (!foundValid) {</span>
<span class="nc" id="L32991">            game.addAction(new UnloadStrandedAction(connId, Entity.NONE));</span>
        }

        // Either way, the connection's player has now declared.
<span class="nc" id="L32995">        declared.addElement(player);</span>

        // Are all players who are unloading entities done? Walk
        // through the turn's stranded entities, and look to see
        // if their player has finished their turn.
<span class="nc" id="L33000">        entityIds = turn.getEntityIds();</span>
<span class="nc bnc" id="L33001" title="All 2 branches missed.">        for (int entityId : entityIds) {</span>
<span class="nc" id="L33002">            entity = game.getEntity(entityId);</span>
<span class="nc" id="L33003">            other = entity.getOwner();</span>
<span class="nc bnc" id="L33004" title="All 2 branches missed.">            if (!declared.contains(other)) {</span>
                // At least one player still needs to declare.
<span class="nc" id="L33006">                return;</span>
            }
        }

        // All players have declared whether they're unloading stranded units.
        // Walk the list of pending actions and unload the entities.
<span class="nc" id="L33012">        pending = game.getActions();</span>
<span class="nc bnc" id="L33013" title="All 2 branches missed.">        while (pending.hasMoreElements()) {</span>
<span class="nc" id="L33014">            action = (UnloadStrandedAction) pending.nextElement();</span>

            // Some players don't want to unload any stranded units.
<span class="nc bnc" id="L33017" title="All 2 branches missed.">            if (Entity.NONE != action.getEntityId()) {</span>
<span class="nc" id="L33018">                entity = game.getEntity(action.getEntityId());</span>
<span class="nc bnc" id="L33019" title="All 2 branches missed.">                if (null == entity) {</span>
                    // After all this, we couldn't find the entity!!!
<span class="nc" id="L33021">                    MegaMek.getLogger().error(&quot;Server could not find stranded entity #&quot;</span>
<span class="nc" id="L33022">                            + action.getEntityId() + &quot; to unload!!!&quot;);</span>
                } else {
                    // Unload the entity. Get the unit's transporter.
<span class="nc" id="L33025">                    Entity transporter = game</span>
<span class="nc" id="L33026">                            .getEntity(entity.getTransportId());</span>
<span class="nc" id="L33027">                    unloadUnit(transporter, entity, transporter.getPosition(),</span>
<span class="nc" id="L33028">                               transporter.getFacing(), transporter.getElevation());</span>
<span class="nc" id="L33029">                }</span>
            }

        } // Handle the next pending unload action

        // Clear the list of pending units and move to the next turn.
<span class="nc" id="L33035">        game.resetActions();</span>
<span class="nc" id="L33036">        changeToNextTurn(connId);</span>
<span class="nc" id="L33037">    }</span>

    /**
     * For all current artillery attacks in the air from this entity with this
     * weapon, clear the list of spotters. Needed because firing another round
     * before first lands voids spotting.
     *
     * @param entityID the &lt;code&gt;int&lt;/code&gt; id of the entity
     * @param weaponID the &lt;code&gt;int&lt;/code&gt; id of the weapon
     */
    private void clearArtillerySpotters(int entityID, int weaponID) {
<span class="nc bnc" id="L33048" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; i = game.getAttacks(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L33049">            WeaponHandler wh = (WeaponHandler) i.nextElement();</span>
<span class="nc bnc" id="L33050" title="All 2 branches missed.">            if ((wh.waa instanceof ArtilleryAttackAction)</span>
<span class="nc bnc" id="L33051" title="All 2 branches missed.">                &amp;&amp; (wh.waa.getEntityId() == entityID)</span>
<span class="nc bnc" id="L33052" title="All 2 branches missed.">                &amp;&amp; (wh.waa.getWeaponId() == weaponID)) {</span>
<span class="nc" id="L33053">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc" id="L33054">                aaa.setSpotterIds(null);</span>
            }
<span class="nc" id="L33056">        }</span>
<span class="nc" id="L33057">    }</span>

    /**
     * Credits a Kill for an entity, if the target got killed.
     *
     * @param target   The &lt;code&gt;Entity&lt;/code&gt; that got killed.
     * @param attacker The &lt;code&gt;Entity&lt;/code&gt; that did the killing.
     */
    public void creditKill(Entity target, Entity attacker) {
        // Kills should be credited for each individual fighter, instead of the
        // squadron
<span class="nc bnc" id="L33068" title="All 2 branches missed.">        if (target instanceof FighterSquadron) {</span>
<span class="nc" id="L33069">            return;</span>
        }
        // If a squadron scores a kill, assign it randomly to one of the member fighters
<span class="nc bnc" id="L33072" title="All 2 branches missed.">        if (attacker instanceof FighterSquadron) {</span>
<span class="nc" id="L33073">            Entity killer = attacker.getLoadedUnits().get(Compute.randomInt(attacker.getLoadedUnits().size()));</span>
<span class="nc bnc" id="L33074" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L33075">                attacker = killer;</span>
            }
        }
<span class="nc bnc" id="L33078" title="All 4 branches missed.">        if ((target.isDoomed() || target.getCrew().isDoomed())</span>
<span class="nc bnc" id="L33079" title="All 4 branches missed.">            &amp;&amp; !target.getGaveKillCredit() &amp;&amp; (attacker != null)) {</span>
<span class="nc" id="L33080">            attacker.addKill(target);</span>
        }
<span class="nc" id="L33082">    }</span>

    /**
     * pre-treats a physical attack
     *
     * @param aaa The &lt;code&gt;AbstractAttackAction&lt;/code&gt; of the physical attack
     *            to pre-treat
     * @return The &lt;code&gt;PhysicalResult&lt;/code&gt; of that action, including
     * possible damage.
     */
    private PhysicalResult preTreatPhysicalAttack(AbstractAttackAction aaa) {
<span class="nc" id="L33093">        final Entity ae = game.getEntity(aaa.getEntityId());</span>
<span class="nc" id="L33094">        int damage = 0;</span>
<span class="nc" id="L33095">        PhysicalResult pr = new PhysicalResult();</span>
<span class="nc" id="L33096">        ToHitData toHit = new ToHitData();</span>
<span class="nc" id="L33097">        pr.roll = Compute.d6(2);</span>
<span class="nc" id="L33098">        pr.aaa = aaa;</span>
<span class="nc bnc" id="L33099" title="All 2 branches missed.">        if (aaa instanceof BrushOffAttackAction) {</span>
<span class="nc" id="L33100">            BrushOffAttackAction baa = (BrushOffAttackAction) aaa;</span>
<span class="nc" id="L33101">            int arm = baa.getArm();</span>
<span class="nc" id="L33102">            baa.setArm(BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33103">            toHit = BrushOffAttackAction.toHit(game, aaa.getEntityId(),</span>
<span class="nc" id="L33104">                    aaa.getTarget(game), BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33105">            baa.setArm(BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33106">            pr.toHitRight = BrushOffAttackAction.toHit(game, aaa.getEntityId(),</span>
<span class="nc" id="L33107">                    aaa.getTarget(game), BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33108">            damage = BrushOffAttackAction.getDamageFor(ae, BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33109">            pr.damageRight = BrushOffAttackAction.getDamageFor(ae, BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33110">            baa.setArm(arm);</span>
<span class="nc" id="L33111">            pr.rollRight = Compute.d6(2);</span>
<span class="nc bnc" id="L33112" title="All 2 branches missed.">        } else if (aaa instanceof ChargeAttackAction) {</span>
<span class="nc" id="L33113">            ChargeAttackAction caa = (ChargeAttackAction) aaa;</span>
<span class="nc" id="L33114">            toHit = caa.toHit(game);</span>
<span class="nc bnc" id="L33115" title="All 2 branches missed.">            if (caa.getTarget(game) instanceof Entity) {</span>
<span class="nc" id="L33116">                Entity target = (Entity) caa.getTarget(game);</span>
<span class="nc" id="L33117">                damage = ChargeAttackAction.getDamageFor(ae, target,</span>
<span class="nc" id="L33118">                        game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
<span class="nc" id="L33119">                        toHit.getMoS());</span>
<span class="nc" id="L33120">            } else {</span>
<span class="nc" id="L33121">                damage = ChargeAttackAction.getDamageFor(ae);</span>
            }
<span class="nc bnc" id="L33123" title="All 2 branches missed.">        } else if (aaa instanceof AirmechRamAttackAction) {</span>
<span class="nc" id="L33124">            AirmechRamAttackAction raa = (AirmechRamAttackAction) aaa;</span>
<span class="nc" id="L33125">            toHit = raa.toHit(game);</span>
<span class="nc" id="L33126">            damage = AirmechRamAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33127" title="All 2 branches missed.">        } else if (aaa instanceof ClubAttackAction) {</span>
<span class="nc" id="L33128">            ClubAttackAction caa = (ClubAttackAction) aaa;</span>
<span class="nc" id="L33129">            toHit = caa.toHit(game);</span>
<span class="nc" id="L33130">            damage = ClubAttackAction.getDamageFor(ae, caa.getClub(),</span>
<span class="nc" id="L33131">                    caa.getTarget(game).isConventionalInfantry(), caa.isZweihandering());</span>
<span class="nc bnc" id="L33132" title="All 2 branches missed.">            if (caa.getTargetType() == Targetable.TYPE_BUILDING) {</span>
<span class="nc" id="L33133">                EquipmentType clubType = caa.getClub().getType();</span>
<span class="nc bnc" id="L33134" title="All 2 branches missed.">                if (clubType.hasSubType(MiscType.S_BACKHOE)</span>
<span class="nc bnc" id="L33135" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_CHAINSAW)</span>
<span class="nc bnc" id="L33136" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_MINING_DRILL)</span>
<span class="nc bnc" id="L33137" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_PILE_DRIVER)) {</span>
<span class="nc" id="L33138">                    damage += Compute.d6(1);</span>
<span class="nc bnc" id="L33139" title="All 2 branches missed.">                } else if (clubType.hasSubType(MiscType.S_DUAL_SAW)) {</span>
<span class="nc" id="L33140">                    damage += Compute.d6(2);</span>
<span class="nc bnc" id="L33141" title="All 2 branches missed.">                } else if (clubType.hasSubType(MiscType.S_ROCK_CUTTER)) {</span>
<span class="nc" id="L33142">                    damage += Compute.d6(3);</span>
                }
<span class="nc bnc" id="L33144" title="All 2 branches missed.">                else if (clubType.hasSubType(MiscType.S_WRECKING_BALL)) {</span>
<span class="nc" id="L33145">                    damage += Compute.d6(4);</span>
                }
            }
<span class="nc bnc" id="L33148" title="All 2 branches missed.">        } else if (aaa instanceof DfaAttackAction) {</span>
<span class="nc" id="L33149">            DfaAttackAction daa = (DfaAttackAction) aaa;</span>
<span class="nc" id="L33150">            toHit = daa.toHit(game);</span>
<span class="nc" id="L33151">            damage = DfaAttackAction.getDamageFor(ae, daa.getTarget(game).isConventionalInfantry());</span>
<span class="nc bnc" id="L33152" title="All 2 branches missed.">        } else if (aaa instanceof KickAttackAction) {</span>
<span class="nc" id="L33153">            KickAttackAction kaa = (KickAttackAction) aaa;</span>
<span class="nc" id="L33154">            toHit = kaa.toHit(game);</span>
<span class="nc" id="L33155">            damage = KickAttackAction.getDamageFor(ae, kaa.getLeg(),</span>
<span class="nc" id="L33156">                    kaa.getTarget(game).isConventionalInfantry());</span>
<span class="nc bnc" id="L33157" title="All 2 branches missed.">        } else if (aaa instanceof ProtomechPhysicalAttackAction) {</span>
<span class="nc" id="L33158">            ProtomechPhysicalAttackAction paa = (ProtomechPhysicalAttackAction) aaa;</span>
<span class="nc" id="L33159">            toHit = paa.toHit(game);</span>
<span class="nc" id="L33160">            damage = ProtomechPhysicalAttackAction.getDamageFor(ae, paa.getTarget(game));</span>
<span class="nc bnc" id="L33161" title="All 2 branches missed.">        } else if (aaa instanceof PunchAttackAction) {</span>
<span class="nc" id="L33162">            PunchAttackAction paa = (PunchAttackAction) aaa;</span>
<span class="nc" id="L33163">            int arm = paa.getArm();</span>
            int damageRight;
<span class="nc" id="L33165">            paa.setArm(PunchAttackAction.LEFT);</span>
<span class="nc" id="L33166">            toHit = paa.toHit(game);</span>
<span class="nc" id="L33167">            paa.setArm(PunchAttackAction.RIGHT);</span>
<span class="nc" id="L33168">            ToHitData toHitRight = paa.toHit(game);</span>
<span class="nc" id="L33169">            damage = PunchAttackAction.getDamageFor(ae, PunchAttackAction.LEFT,</span>
<span class="nc" id="L33170">                    paa.getTarget(game).isConventionalInfantry(), paa.isZweihandering());</span>
<span class="nc" id="L33171">            damageRight = PunchAttackAction.getDamageFor(ae, PunchAttackAction.RIGHT,</span>
<span class="nc" id="L33172">                    paa.getTarget(game).isConventionalInfantry(), paa.isZweihandering());</span>
<span class="nc" id="L33173">            paa.setArm(arm);</span>
            // If we're punching while prone (at a Tank,
            // duh), then we can only use one arm.
<span class="nc bnc" id="L33176" title="All 2 branches missed.">            if (ae.isProne()) {</span>
<span class="nc" id="L33177">                double oddsLeft = Compute.oddsAbove(toHit.getValue(),</span>
<span class="nc" id="L33178">                        ae.hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING));</span>
<span class="nc" id="L33179">                double oddsRight = Compute.oddsAbove(toHitRight.getValue(),</span>
<span class="nc" id="L33180">                        ae.hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING));</span>
                // Use the best attack.
<span class="nc bnc" id="L33182" title="All 2 branches missed.">                if ((oddsLeft * damage) &gt; (oddsRight * damageRight)) {</span>
<span class="nc" id="L33183">                    paa.setArm(PunchAttackAction.LEFT);</span>
                } else {
<span class="nc" id="L33185">                    paa.setArm(PunchAttackAction.RIGHT);</span>
                }
            }
<span class="nc" id="L33188">            pr.damageRight = damageRight;</span>
<span class="nc" id="L33189">            pr.toHitRight = toHitRight;</span>
<span class="nc" id="L33190">            pr.rollRight = Compute.d6(2);</span>
<span class="nc bnc" id="L33191" title="All 2 branches missed.">        } else if (aaa instanceof PushAttackAction) {</span>
<span class="nc" id="L33192">            PushAttackAction paa = (PushAttackAction) aaa;</span>
<span class="nc" id="L33193">            toHit = paa.toHit(game);</span>
<span class="nc bnc" id="L33194" title="All 2 branches missed.">        } else if (aaa instanceof TripAttackAction) {</span>
<span class="nc" id="L33195">            TripAttackAction paa = (TripAttackAction) aaa;</span>
<span class="nc" id="L33196">            toHit = paa.toHit(game);</span>
<span class="nc bnc" id="L33197" title="All 2 branches missed.">        } else if (aaa instanceof LayExplosivesAttackAction) {</span>
<span class="nc" id="L33198">            LayExplosivesAttackAction leaa = (LayExplosivesAttackAction) aaa;</span>
<span class="nc" id="L33199">            toHit = leaa.toHit(game);</span>
<span class="nc" id="L33200">            damage = LayExplosivesAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33201" title="All 2 branches missed.">        } else if (aaa instanceof ThrashAttackAction) {</span>
<span class="nc" id="L33202">            ThrashAttackAction taa = (ThrashAttackAction) aaa;</span>
<span class="nc" id="L33203">            toHit = taa.toHit(game);</span>
<span class="nc" id="L33204">            damage = ThrashAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33205" title="All 2 branches missed.">        } else if (aaa instanceof JumpJetAttackAction) {</span>
<span class="nc" id="L33206">            JumpJetAttackAction jaa = (JumpJetAttackAction) aaa;</span>
<span class="nc" id="L33207">            toHit = jaa.toHit(game);</span>
<span class="nc bnc" id="L33208" title="All 2 branches missed.">            if (jaa.getLeg() == JumpJetAttackAction.BOTH) {</span>
<span class="nc" id="L33209">                damage = JumpJetAttackAction.getDamageFor(ae, JumpJetAttackAction.LEFT);</span>
<span class="nc" id="L33210">                pr.damageRight = JumpJetAttackAction.getDamageFor(ae, JumpJetAttackAction.LEFT);</span>
            } else {
<span class="nc" id="L33212">                damage = JumpJetAttackAction.getDamageFor(ae, jaa.getLeg());</span>
<span class="nc" id="L33213">                pr.damageRight = 0;</span>
            }
<span class="nc" id="L33215">            ae.heatBuildup += (damage + pr.damageRight) / 3;</span>
<span class="nc bnc" id="L33216" title="All 2 branches missed.">        } else if (aaa instanceof GrappleAttackAction) {</span>
<span class="nc" id="L33217">            GrappleAttackAction taa = (GrappleAttackAction) aaa;</span>
<span class="nc" id="L33218">            toHit = taa.toHit(game);</span>
<span class="nc bnc" id="L33219" title="All 2 branches missed.">        } else if (aaa instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L33220">            BreakGrappleAttackAction taa = (BreakGrappleAttackAction) aaa;</span>
<span class="nc" id="L33221">            toHit = taa.toHit(game);</span>
<span class="nc bnc" id="L33222" title="All 2 branches missed.">        } else if (aaa instanceof RamAttackAction) {</span>
<span class="nc" id="L33223">            RamAttackAction raa = (RamAttackAction) aaa;</span>
<span class="nc" id="L33224">            toHit = raa.toHit(game);</span>
<span class="nc" id="L33225">            damage = RamAttackAction.getDamageFor((IAero) ae, (Entity) aaa.getTarget(game));</span>
<span class="nc bnc" id="L33226" title="All 2 branches missed.">        } else if (aaa instanceof TeleMissileAttackAction) {</span>
<span class="nc" id="L33227">            TeleMissileAttackAction taa = (TeleMissileAttackAction) aaa;</span>
<span class="nc" id="L33228">            assignTeleMissileAMS(taa);</span>
<span class="nc" id="L33229">            taa.calcCounterAV(game, taa.getTarget(game));</span>
<span class="nc" id="L33230">            toHit = taa.toHit(game);</span>
<span class="nc" id="L33231">            damage = TeleMissileAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33232" title="All 2 branches missed.">        } else if (aaa instanceof BAVibroClawAttackAction) {</span>
<span class="nc" id="L33233">            BAVibroClawAttackAction bvca = (BAVibroClawAttackAction) aaa;</span>
<span class="nc" id="L33234">            toHit = bvca.toHit(game);</span>
<span class="nc" id="L33235">            damage = BAVibroClawAttackAction.getDamageFor(ae);</span>
        }
<span class="nc" id="L33237">        pr.toHit = toHit;</span>
<span class="nc" id="L33238">        pr.damage = damage;</span>
<span class="nc" id="L33239">        return pr;</span>
    }

    /**
     * Resolve a Physical Attack
     *
     * @param pr  The &lt;code&gt;PhysicalResult&lt;/code&gt; of the physical attack
     * @param cen The &lt;code&gt;int&lt;/code&gt; Entity Id of the entity whose physical
     *            attack was last resolved
     */
    private void resolvePhysicalAttack(PhysicalResult pr, int cen) {
<span class="nc" id="L33250">        AbstractAttackAction aaa = pr.aaa;</span>
<span class="nc bnc" id="L33251" title="All 2 branches missed.">        if (aaa instanceof PunchAttackAction) {</span>
<span class="nc" id="L33252">            PunchAttackAction paa = (PunchAttackAction) aaa;</span>
<span class="nc bnc" id="L33253" title="All 2 branches missed.">            if (paa.getArm() == PunchAttackAction.BOTH) {</span>
<span class="nc" id="L33254">                paa.setArm(PunchAttackAction.LEFT);</span>
<span class="nc" id="L33255">                pr.aaa = paa;</span>
<span class="nc" id="L33256">                resolvePunchAttack(pr, cen);</span>
<span class="nc" id="L33257">                cen = paa.getEntityId();</span>
<span class="nc" id="L33258">                paa.setArm(PunchAttackAction.RIGHT);</span>
<span class="nc" id="L33259">                pr.aaa = paa;</span>
<span class="nc" id="L33260">                resolvePunchAttack(pr, cen);</span>
            } else {
<span class="nc" id="L33262">                resolvePunchAttack(pr, cen);</span>
<span class="nc" id="L33263">                cen = paa.getEntityId();</span>
            }
<span class="nc bnc" id="L33265" title="All 2 branches missed.">        } else if (aaa instanceof KickAttackAction) {</span>
<span class="nc" id="L33266">            resolveKickAttack(pr, cen);</span>
<span class="nc" id="L33267">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33268" title="All 2 branches missed.">        } else if (aaa instanceof BrushOffAttackAction) {</span>
<span class="nc" id="L33269">            BrushOffAttackAction baa = (BrushOffAttackAction) aaa;</span>
<span class="nc bnc" id="L33270" title="All 2 branches missed.">            if (baa.getArm() == BrushOffAttackAction.BOTH) {</span>
<span class="nc" id="L33271">                baa.setArm(BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33272">                pr.aaa = baa;</span>
<span class="nc" id="L33273">                resolveBrushOffAttack(pr, cen);</span>
<span class="nc" id="L33274">                cen = baa.getEntityId();</span>
<span class="nc" id="L33275">                baa.setArm(BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33276">                pr.aaa = baa;</span>
<span class="nc" id="L33277">                resolveBrushOffAttack(pr, cen);</span>
            } else {
<span class="nc" id="L33279">                resolveBrushOffAttack(pr, cen);</span>
<span class="nc" id="L33280">                cen = baa.getEntityId();</span>
            }
<span class="nc bnc" id="L33282" title="All 2 branches missed.">        } else if (aaa instanceof ThrashAttackAction) {</span>
<span class="nc" id="L33283">            resolveThrashAttack(pr, cen);</span>
<span class="nc" id="L33284">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33285" title="All 2 branches missed.">        } else if (aaa instanceof ProtomechPhysicalAttackAction) {</span>
<span class="nc" id="L33286">            resolveProtoAttack(pr, cen);</span>
<span class="nc" id="L33287">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33288" title="All 2 branches missed.">        } else if (aaa instanceof ClubAttackAction) {</span>
<span class="nc" id="L33289">            resolveClubAttack(pr, cen);</span>
<span class="nc" id="L33290">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33291" title="All 2 branches missed.">        } else if (aaa instanceof PushAttackAction) {</span>
<span class="nc" id="L33292">            resolvePushAttack(pr, cen);</span>
<span class="nc" id="L33293">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33294" title="All 2 branches missed.">        } else if (aaa instanceof ChargeAttackAction) {</span>
<span class="nc" id="L33295">            resolveChargeAttack(pr, cen);</span>
<span class="nc" id="L33296">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33297" title="All 2 branches missed.">        } else if (aaa instanceof AirmechRamAttackAction) {</span>
<span class="nc" id="L33298">            resolveAirmechRamAttack(pr, cen);</span>
<span class="nc" id="L33299">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33300" title="All 2 branches missed.">        } else if (aaa instanceof DfaAttackAction) {</span>
<span class="nc" id="L33301">            resolveDfaAttack(pr, cen);</span>
<span class="nc" id="L33302">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33303" title="All 2 branches missed.">        } else if (aaa instanceof LayExplosivesAttackAction) {</span>
<span class="nc" id="L33304">            resolveLayExplosivesAttack(pr);</span>
<span class="nc" id="L33305">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33306" title="All 2 branches missed.">        } else if (aaa instanceof TripAttackAction) {</span>
<span class="nc" id="L33307">            resolveTripAttack(pr, cen);</span>
<span class="nc" id="L33308">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33309" title="All 2 branches missed.">        } else if (aaa instanceof JumpJetAttackAction) {</span>
<span class="nc" id="L33310">            resolveJumpJetAttack(pr, cen);</span>
<span class="nc" id="L33311">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33312" title="All 2 branches missed.">        } else if (aaa instanceof GrappleAttackAction) {</span>
<span class="nc" id="L33313">            resolveGrappleAttack(pr, cen);</span>
<span class="nc" id="L33314">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33315" title="All 2 branches missed.">        } else if (aaa instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L33316">            resolveBreakGrappleAttack(pr, cen);</span>
<span class="nc" id="L33317">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33318" title="All 2 branches missed.">        } else if (aaa instanceof RamAttackAction) {</span>
<span class="nc" id="L33319">            resolveRamAttack(pr, cen);</span>
<span class="nc" id="L33320">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33321" title="All 2 branches missed.">        } else if (aaa instanceof TeleMissileAttackAction) {</span>
<span class="nc" id="L33322">            resolveTeleMissileAttack(pr, cen);</span>
<span class="nc" id="L33323">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33324" title="All 2 branches missed.">        } else if (aaa instanceof BAVibroClawAttackAction) {</span>
<span class="nc" id="L33325">            resolveBAVibroClawAttack(pr, cen);</span>
<span class="nc" id="L33326">            cen = aaa.getEntityId();</span>
        } else {
<span class="nc" id="L33328">            MegaMek.getLogger().error(&quot;Unknown attack action declared.&quot;);</span>
        }
        // Not all targets are Entities.
<span class="nc" id="L33331">        Targetable target = game.getTarget(aaa.getTargetType(), aaa.getTargetId());</span>
<span class="nc bnc" id="L33332" title="All 2 branches missed.">        if (target instanceof Entity) {</span>
<span class="nc" id="L33333">            Entity targetEntity = (Entity) target;</span>
<span class="nc" id="L33334">            targetEntity.setStruck(true);</span>
<span class="nc" id="L33335">            targetEntity.addAttackedByThisTurn(target.getTargetId());</span>
<span class="nc" id="L33336">            creditKill(targetEntity, game.getEntity(cen));</span>
        }
<span class="nc" id="L33338">    }</span>

    /**
     * Add any extreme gravity PSRs the entity gets due to its movement
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; to check.
     * @param step
     *            The last &lt;code&gt;MoveStep&lt;/code&gt; of this entity
     * @param moveType
     *            The movement type for the MovePath the supplied MoveStep comes
     *            from. This generally comes from the last step in the move
     *            path.
     * @param curPos
     *            The current &lt;code&gt;Coords&lt;/code&gt; of this entity
     * @param cachedMaxMPExpenditure
     *            Server checks run/jump MP at start of move, as appropriate,
     *            caches to avoid mid-move change in MP causing erroneous grav
     *            check
     */
    private void checkExtremeGravityMovement(Entity entity, MoveStep step,
                                             EntityMovementType moveType, Coords curPos,
                                             int cachedMaxMPExpenditure) {
        PilotingRollData rollTarget;
<span class="nc bnc" id="L33362" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getGravity() != 1) {</span>
<span class="nc bnc" id="L33363" title="All 4 branches missed.">            if ((entity instanceof Mech) || (entity instanceof Tank)) {</span>
<span class="nc bnc" id="L33364" title="All 12 branches missed.">                if ((moveType == EntityMovementType.MOVE_WALK)</span>
                        || (moveType == EntityMovementType.MOVE_VTOL_WALK)
                        || (moveType == EntityMovementType.MOVE_RUN)
                        || (moveType == EntityMovementType.MOVE_SPRINT)
                        || (moveType == EntityMovementType.MOVE_VTOL_RUN)
                        || (moveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L33370">                    int limit = cachedMaxMPExpenditure;</span>
<span class="nc bnc" id="L33371" title="All 4 branches missed.">                    if (step.isOnlyPavement() &amp;&amp; entity.isEligibleForPavementBonus()) {</span>
<span class="nc" id="L33372">                        limit++;</span>
                    }
<span class="nc bnc" id="L33374" title="All 2 branches missed.">                    if (step.getMpUsed() &gt; limit) {</span>
                        // We moved too fast, let's make PSR to see if we get
                        // damage
<span class="nc" id="L33377">                        game.addExtremeGravityPSR(entity.checkMovedTooFast(</span>
                                step, moveType));
                    }
<span class="nc bnc" id="L33380" title="All 2 branches missed.">                } else if (moveType == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L33381">                    MegaMek.getLogger().debug(&quot;Gravity move check jump: &quot; </span>
<span class="nc" id="L33382">                            + step.getMpUsed() + &quot;/&quot; + cachedMaxMPExpenditure);</span>
<span class="nc" id="L33383">                    int origWalkMP = entity.getWalkMP(false, false);</span>
<span class="nc" id="L33384">                    int gravWalkMP = entity.getWalkMP();</span>
<span class="nc bnc" id="L33385" title="All 2 branches missed.">                    if (step.getMpUsed() &gt; cachedMaxMPExpenditure) {</span>
                        // Jumped too far, make PSR to see if we get damaged
<span class="nc" id="L33387">                        game.addExtremeGravityPSR(entity.checkMovedTooFast(</span>
                                step, moveType));
<span class="nc bnc" id="L33389" title="All 4 branches missed.">                    } else if ((game.getPlanetaryConditions().getGravity() &gt; 1)</span>
                            &amp;&amp; ((origWalkMP - gravWalkMP) &gt; 0)) {
                        // jumping in high g is bad for your legs
                        // Damage dealt = 1 pt for each MP lost due to gravity
                        // Ignore this if no damage would be dealt
<span class="nc" id="L33394">                        rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L33395">                        entity.addPilotingModifierForTerrain(rollTarget, step);</span>
<span class="nc" id="L33396">                        int gravMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L33397">                                .getGravityPilotPenalty();</span>
<span class="nc bnc" id="L33398" title="All 4 branches missed.">                        if ((gravMod != 0) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L33399">                            rollTarget.addModifier(gravMod, game</span>
<span class="nc" id="L33400">                                    .getPlanetaryConditions().getGravity()</span>
                                    + &quot;G gravity&quot;);
                        }
<span class="nc" id="L33403">                        rollTarget.append(new PilotingRollData(entity.getId(),</span>
                                0, &quot;jumped in high gravity&quot;));
<span class="nc" id="L33405">                        game.addExtremeGravityPSR(rollTarget);</span>
                    }
                }
            }
        }
<span class="nc" id="L33410">    }</span>

    /**
     * Damage the inner structure of a mech's leg / a tank's front. This only
     * happens when the Entity fails an extreme Gravity PSR.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; to damage.
     * @param damage The &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    private Vector&lt;Report&gt; doExtremeGravityDamage(Entity entity, int damage) {
<span class="nc" id="L33420">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        HitData hit;
<span class="nc bnc" id="L33422" title="All 2 branches missed.">        if (entity instanceof BipedMech) {</span>
<span class="nc bnc" id="L33423" title="All 2 branches missed.">            for (int i = 6; i &lt;= 7; i++) {</span>
<span class="nc" id="L33424">                hit = new HitData(i);</span>
<span class="nc" id="L33425">                vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                        DamageType.NONE, true));
            }
        }
<span class="nc bnc" id="L33429" title="All 2 branches missed.">        if (entity instanceof QuadMech) {</span>
<span class="nc bnc" id="L33430" title="All 2 branches missed.">            for (int i = 4; i &lt;= 7; i++) {</span>
<span class="nc" id="L33431">                hit = new HitData(i);</span>
<span class="nc" id="L33432">                vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                        DamageType.NONE, true));
            }
<span class="nc bnc" id="L33435" title="All 2 branches missed.">        } else if (entity instanceof Tank) {</span>
<span class="nc" id="L33436">            hit = new HitData(Tank.LOC_FRONT);</span>
<span class="nc" id="L33437">            vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                    DamageType.NONE, true));
<span class="nc" id="L33439">            vPhaseReport.addAll(vehicleMotiveDamage((Tank)entity, 0));</span>
        }
<span class="nc" id="L33441">        return vPhaseReport;</span>
    }

    /**
     * Eject an Entity.
     *
     * @param entity    The &lt;code&gt;Entity&lt;/code&gt; to eject.
     * @param autoEject The &lt;code&gt;boolean&lt;/code&gt; state of the entity's auto- ejection
     *                  system
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; ejectEntity(Entity entity, boolean autoEject) {
<span class="nc" id="L33453">        return ejectEntity(entity, autoEject, false);</span>
    }

    /**
     * Eject an Entity.
     *
     * @param entity            The &lt;code&gt;Entity&lt;/code&gt; to eject.
     * @param autoEject         The &lt;code&gt;boolean&lt;/code&gt; state of the entity's auto- ejection
     *                          system
     * @param skin_of_the_teeth Perform a skin of the teeth ejection
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; ejectEntity(Entity entity, boolean autoEject,
                                      boolean skin_of_the_teeth) {
<span class="nc" id="L33467">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L33471" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L33472">            return vDesc;</span>
        }

        // If the crew are already dead, don't bother
<span class="nc bnc" id="L33476" title="All 2 branches missed.">        if (entity.isCarcass()) {</span>
<span class="nc" id="L33477">            return vDesc;</span>
        }

        // Mek and fighter pilots may get hurt during ejection,
        // and run around the board afterwards.
<span class="nc bnc" id="L33482" title="All 4 branches missed.">        if (entity instanceof Mech || entity.isFighter()) {</span>
<span class="nc" id="L33483">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L33484" title="All 2 branches missed.">            Coords targetCoords = (null != entity.getPosition())</span>
<span class="nc" id="L33485">                ? entity.getPosition().translated((facing + 3) % 6) : null;</span>
<span class="nc bnc" id="L33486" title="All 4 branches missed.">            if (entity.isSpaceborne() &amp;&amp; entity.getPosition() != null) {</span>
                //Pilots in space should eject into the fighter's hex, not behind it
<span class="nc" id="L33488">                targetCoords = entity.getPosition();</span>
            }

<span class="nc bnc" id="L33491" title="All 2 branches missed.">            if (autoEject) {</span>
<span class="nc" id="L33492">                r = new Report(6395);</span>
<span class="nc" id="L33493">                r.subject = entity.getId();</span>
<span class="nc" id="L33494">                r.addDesc(entity);</span>
<span class="nc" id="L33495">                r.indent(2);</span>
<span class="nc" id="L33496">                vDesc.addElement(r);</span>
            }

            // okay, print the info
<span class="nc" id="L33500">            PilotingRollData rollTarget = getEjectModifiers(game, entity,</span>
<span class="nc" id="L33501">                    entity.getCrew().getCurrentPilotIndex(), autoEject);</span>
<span class="nc" id="L33502">            r = new Report(2180);</span>
<span class="nc" id="L33503">            r.subject = entity.getId();</span>
<span class="nc" id="L33504">            r.addDesc(entity);</span>
<span class="nc" id="L33505">            r.add(rollTarget.getLastPlainDesc(), true);</span>
<span class="nc" id="L33506">            r.indent();</span>
<span class="nc" id="L33507">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L33508" title="All 2 branches missed.">            for (int crewPos = 0; crewPos &lt; entity.getCrew().getSlotCount(); crewPos++) {</span>
<span class="nc bnc" id="L33509" title="All 2 branches missed.">                if (entity.getCrew().isMissing(crewPos)) {</span>
<span class="nc" id="L33510">                    continue;</span>
                }
<span class="nc" id="L33512">                rollTarget = getEjectModifiers(game, entity, crewPos,</span>
                        autoEject);
                // roll
<span class="nc" id="L33515">                final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc bnc" id="L33516" title="All 2 branches missed.">                if (entity.getCrew().getSlotCount() &gt; 1) {</span>
<span class="nc" id="L33517">                    r = new Report(2193);</span>
<span class="nc" id="L33518">                    r.add(entity.getCrew().getNameAndRole(crewPos));</span>
                } else {
<span class="nc" id="L33520">                    r = new Report(2190);</span>
                }
<span class="nc" id="L33522">                r.subject = entity.getId();</span>
<span class="nc" id="L33523">                r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L33524">                r.add(rollTarget.getDesc());</span>
<span class="nc" id="L33525">                r.add(diceRoll);</span>
<span class="nc" id="L33526">                r.indent();</span>
<span class="nc bnc" id="L33527" title="All 2 branches missed.">                if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L33528">                    r.choose(false);</span>
<span class="nc" id="L33529">                    vDesc.addElement(r);</span>
<span class="nc" id="L33530">                    Report.addNewline(vDesc);</span>
<span class="nc bnc" id="L33531" title="All 2 branches missed.">                    if ((rollTarget.getValue() - diceRoll) &gt; 1) {</span>
                        // Pilots take damage based on ejection roll MoF
<span class="nc" id="L33533">                        int damage = (rollTarget.getValue() - diceRoll);</span>
<span class="nc bnc" id="L33534" title="All 2 branches missed.">                        if (entity instanceof Mech) {</span>
                            // MechWarriors only take 1 damage per 2 points of MoF
<span class="nc" id="L33536">                            damage /= 2;</span>
                        }
<span class="nc bnc" id="L33538" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_DIFFICULT_EJECT)) {</span>
<span class="nc" id="L33539">                            damage++;</span>
                        }
<span class="nc" id="L33541">                        vDesc.addAll(damageCrew(entity, damage, crewPos));</span>
                    }

                    // If this is a skin of the teeth ejection...
<span class="nc bnc" id="L33545" title="All 4 branches missed.">                    if (skin_of_the_teeth &amp;&amp; (entity.getCrew().getHits(crewPos) &lt; 6)) {</span>
<span class="nc" id="L33546">                        Report.addNewline(vDesc);</span>
<span class="nc" id="L33547">                        vDesc.addAll(damageCrew(entity, 6 - entity.getCrew()</span>
<span class="nc" id="L33548">                                                                .getHits(crewPos)));</span>
                    }
                } else {
<span class="nc" id="L33551">                    r.choose(true);</span>
<span class="nc" id="L33552">                    vDesc.addElement(r);</span>
                }
            }
            // create the MechWarrior in any case, for campaign tracking
<span class="nc" id="L33556">            MechWarrior pilot = new MechWarrior(entity);</span>
<span class="nc" id="L33557">            pilot.setDeployed(true);</span>
<span class="nc" id="L33558">            pilot.setId(getFreeEntityId());</span>
<span class="nc" id="L33559">            pilot.setLanded(false);</span>
<span class="nc bnc" id="L33560" title="All 2 branches missed.">            if (entity.isSpaceborne()) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L33562">                pilot.setVectors(entity.getVectors());</span>
<span class="nc" id="L33563">                pilot.setFacing(entity.getFacing());</span>
<span class="nc" id="L33564">                pilot.setCurrentVelocity(entity.getVelocity());</span>
                //If the pilot ejects, he should no longer be accelerating
<span class="nc" id="L33566">                pilot.setNextVelocity(entity.getVelocity());</span>
<span class="nc bnc" id="L33567" title="All 2 branches missed.">            } else if (entity.isAirborne()) {</span>
<span class="nc" id="L33568">                pilot.setAltitude(entity.getAltitude());</span>
            }
            //Pilot flight suits are vacuum-rated. MechWarriors wear shorts...
<span class="nc" id="L33571">            pilot.setSpaceSuit(entity.isAero());</span>
<span class="nc" id="L33572">            game.addEntity(pilot);</span>
<span class="nc" id="L33573">            send(createAddEntityPacket(pilot.getId()));</span>
            // make him not get a move this turn
<span class="nc" id="L33575">            pilot.setDone(true);</span>
<span class="nc" id="L33576">            int living = 0;</span>
<span class="nc bnc" id="L33577" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L33578" title="All 4 branches missed.">                if (!entity.getCrew().isDead(i) &amp;&amp; entity.getCrew().getHits(i) &lt; Crew.DEATH) {</span>
<span class="nc" id="L33579">                    living++;</span>
                }
            }
<span class="nc" id="L33582">            pilot.setInternal(living, MechWarrior.LOC_INFANTRY);</span>
<span class="nc bnc" id="L33583" title="All 4 branches missed.">            if (entity.getCrew().isDead() || entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
<span class="nc" id="L33584">                pilot.setDoomed(true);</span>
            }

<span class="nc bnc" id="L33587" title="All 2 branches missed.">            if (entity.getCrew().isDoomed()) {</span>
<span class="nc" id="L33588">                vDesc.addAll(destroyEntity(pilot, &quot;deadly ejection&quot;, false,</span>
                                           false));
            } else {
                // Add the pilot as an infantry unit on the battlefield.
<span class="nc bnc" id="L33592" title="All 2 branches missed.">                if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L33593">                    pilot.setPosition(targetCoords);</span>
                    // report safe ejection
<span class="nc" id="L33595">                    r = new Report(6400);</span>
<span class="nc" id="L33596">                    r.subject = entity.getId();</span>
<span class="nc" id="L33597">                    r.indent(3);</span>
<span class="nc" id="L33598">                    vDesc.addElement(r);</span>
                    // Update the entity
<span class="nc" id="L33600">                    entityUpdate(pilot.getId());</span>
                    // check if the pilot lands in a minefield
<span class="nc bnc" id="L33602" title="All 2 branches missed.">                    if (!entity.isAirborne()) {</span>
<span class="nc" id="L33603">                        vDesc.addAll(doEntityDisplacementMinefieldCheck(pilot,</span>
<span class="nc" id="L33604">                                entity.getPosition(), targetCoords,</span>
<span class="nc" id="L33605">                                entity.getElevation()));</span>
                    }
                } else {
                    // ejects safely
<span class="nc" id="L33609">                    r = new Report(6410);</span>
<span class="nc" id="L33610">                    r.subject = entity.getId();</span>
<span class="nc" id="L33611">                    r.indent(3);</span>
<span class="nc" id="L33612">                    vDesc.addElement(r);</span>
<span class="nc" id="L33613">                    game.removeEntity(pilot.getId(),</span>
                                      IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L33615">                    send(createRemoveEntityPacket(pilot.getId(),</span>
                                                  IEntityRemovalConditions.REMOVE_IN_RETREAT));
                    // }
                }
<span class="nc bnc" id="L33619" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)</span>
                        // Don't create a pilot entity on low-atmospheric maps
<span class="nc bnc" id="L33621" title="All 2 branches missed.">                        || game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L33622">                    game.removeEntity(pilot.getId(),</span>
                                      IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L33624">                    send(createRemoveEntityPacket(pilot.getId(),</span>
                                                  IEntityRemovalConditions.REMOVE_IN_RETREAT));
                }

                // If this is a skin of the teeth ejection...
<span class="nc bnc" id="L33629" title="All 4 branches missed.">                if (skin_of_the_teeth &amp;&amp; (pilot.getCrew().getHits() &lt; 5)) {</span>
<span class="nc" id="L33630">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L33631">                    vDesc.addAll(damageCrew(pilot, 5 - pilot.getCrew()</span>
<span class="nc" id="L33632">                                                            .getHits()));</span>
                }
            } // Crew safely ejects.

            // ejection damages the cockpit
            // kind of irrelevant in stand-alone games, but important for MekHQ
<span class="nc bnc" id="L33638" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L33639">                Mech mech = (Mech) entity;</span>
                // in case of mechs with 'full head ejection', the head is treated as blown off
<span class="nc bnc" id="L33641" title="All 2 branches missed.">                if (mech.hasFullHeadEject()) {</span>
<span class="nc" id="L33642">                    entity.destroyLocation(Mech.LOC_HEAD, true);</span>
                } else {
<span class="nc bnc" id="L33644" title="All 2 branches missed.">                    for (CriticalSlot slot : (mech.getCockpit())) {</span>
<span class="nc" id="L33645">                        slot.setDestroyed(true);</span>
<span class="nc" id="L33646">                    }</span>
                }
            }            
<span class="nc" id="L33649">        } // End entity-is-Mek or fighter</span>
<span class="nc bnc" id="L33650" title="All 4 branches missed.">        else if (game.getBoard().contains(entity.getPosition())</span>
                 &amp;&amp; (entity instanceof Tank)) {
<span class="nc" id="L33652">            EjectedCrew crew = new EjectedCrew(entity);</span>
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33655">            crew.setGame(game);</span>
<span class="nc" id="L33656">            crew.setDeployed(true);</span>
<span class="nc" id="L33657">            crew.setId(getFreeEntityId());</span>
            // Make them not get a move this turn
<span class="nc" id="L33659">            crew.setDone(true);</span>
            // Place on board
            // Vehicles don't have ejection systems, so crew must abandon into
            // a legal hex
<span class="nc" id="L33663">            Coords legalPosition = null;</span>
<span class="nc bnc" id="L33664" title="All 2 branches missed.">            if (!crew.isLocationProhibited(entity.getPosition())) {</span>
<span class="nc" id="L33665">                legalPosition = entity.getPosition();</span>
            } else {
<span class="nc bnc" id="L33667" title="All 4 branches missed.">                for (int dir = 0; (dir &lt; 6) &amp;&amp; (legalPosition == null); dir++) {</span>
<span class="nc" id="L33668">                    Coords adjCoords = entity.getPosition().translated(dir);</span>
<span class="nc bnc" id="L33669" title="All 2 branches missed.">                    if (!crew.isLocationProhibited(adjCoords)) {</span>
<span class="nc" id="L33670">                        legalPosition = adjCoords;</span>
                    }
                }
            }
            // Cannot abandon if there is no legal hex. This shouldn't have been allowed
<span class="nc bnc" id="L33675" title="All 2 branches missed.">            if (legalPosition == null) {</span>
<span class="nc" id="L33676">                MegaMek.getLogger().error(&quot;Vehicle crews cannot abandon if there is no legal hex!&quot;);</span>
<span class="nc" id="L33677">                return vDesc;</span>
            }
<span class="nc" id="L33679">            crew.setPosition(legalPosition);</span>
            // Add Entity to game
<span class="nc" id="L33681">            game.addEntity(crew);</span>
            // Tell clients about new entity
<span class="nc" id="L33683">            send(createAddEntityPacket(crew.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33685">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L33687">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew,</span>
<span class="nc" id="L33688">                    entity.getPosition(), entity.getPosition(),</span>
<span class="nc" id="L33689">                    entity.getElevation()));</span>
<span class="nc bnc" id="L33690" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33691">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33692">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        } //End ground vehicles

        // Mark the entity's crew as &quot;ejected&quot;.
<span class="nc" id="L33697">        entity.getCrew().setEjected(true);</span>
<span class="nc bnc" id="L33698" title="All 2 branches missed.">        if (entity instanceof VTOL) {</span>
<span class="nc" id="L33699">            vDesc.addAll(crashVTOLorWiGE((VTOL) entity));</span>
        }
<span class="nc" id="L33701">        vDesc.addAll(destroyEntity(entity, &quot;ejection&quot;, true, true));</span>

        // only remove the unit that ejected manually
<span class="nc bnc" id="L33704" title="All 2 branches missed.">        if (!autoEject) {</span>
<span class="nc" id="L33705">            game.removeEntity(entity.getId(),</span>
                    IEntityRemovalConditions.REMOVE_EJECTED);
<span class="nc" id="L33707">            send(createRemoveEntityPacket(entity.getId(),</span>
                    IEntityRemovalConditions.REMOVE_EJECTED));
        }
<span class="nc" id="L33710">        return vDesc;</span>
    }
    
    /**
     * Abandon a spacecraft (large or small).
     *
     * @param entity  The &lt;code&gt;Aero&lt;/code&gt; to eject.
     * @param inSpace Is this ship spaceborne?
     * @param airborne Is this ship in atmospheric flight?
     * @param pos The coords of this ejection. Needed when abandoning a grounded ship
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the gamelog.
     */
    public Vector&lt;Report&gt; ejectSpacecraft(Aero entity, boolean inSpace, boolean airborne, Coords pos) {
<span class="nc" id="L33723">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L33727" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L33728">            return vDesc;</span>
        }

        // If the crew are already dead, don't bother
<span class="nc bnc" id="L33732" title="All 2 branches missed.">        if (entity.isCarcass()) {</span>
<span class="nc" id="L33733">            return vDesc;</span>
        }

        // Try to launch some escape pods and lifeboats, if any are left
<span class="nc bnc" id="L33737" title="All 8 branches missed.">        if ((inSpace &amp;&amp; (entity.getPodsLeft() &gt; 0 || entity.getLifeBoatsLeft() &gt; 0))</span>
<span class="nc bnc" id="L33738" title="All 2 branches missed.">                || (airborne &amp;&amp; entity.getPodsLeft() &gt; 0)) {</span>
            // Report the ejection
<span class="nc" id="L33740">            PilotingRollData rollTarget = getEjectModifiers(game, entity,</span>
<span class="nc" id="L33741">                    entity.getCrew().getCurrentPilotIndex(), false);</span>
<span class="nc" id="L33742">            r = new Report(2180);</span>
<span class="nc" id="L33743">            r.subject = entity.getId();</span>
<span class="nc" id="L33744">            r.addDesc(entity);</span>
<span class="nc" id="L33745">            r.add(rollTarget.getLastPlainDesc(), true);</span>
<span class="nc" id="L33746">            r.indent();</span>
<span class="nc" id="L33747">            vDesc.addElement(r);</span>
<span class="nc" id="L33748">            int roll = Compute.d6(2);</span>
<span class="nc" id="L33749">            int MOS = (roll - Math.max(2, rollTarget.getValue()));</span>
            //Report the roll
<span class="nc" id="L33751">            r = new Report(2190);</span>
<span class="nc" id="L33752">            r.subject = entity.getId();</span>
<span class="nc" id="L33753">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L33754">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L33755">            r.add(roll);</span>
<span class="nc" id="L33756">            r.indent();</span>
<span class="nc bnc" id="L33757" title="All 2 branches missed.">            r.choose(roll &gt;= rollTarget.getValue());</span>
<span class="nc" id="L33758">            vDesc.addElement(r);</span>
            //Per SO p27, you get a certain number of escape pods away per turn per 100k tons of ship
<span class="nc" id="L33760">            int escapeMultiplier = (int) (entity.getWeight() / 100000);</span>
            //Set up the maximum number that CAN launch
<span class="nc" id="L33762">            int toLaunch = 0;</span>
<span class="nc bnc" id="L33763" title="All 2 branches missed.">            if (roll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L33764">                toLaunch = 1;</span>
            } else {
<span class="nc" id="L33766">                toLaunch = (1 + MOS) * Math.max(1, escapeMultiplier);</span>
            }
            //And now modify it based on what the unit actually has TO launch
<span class="nc" id="L33769">            int launchCounter = toLaunch;</span>
<span class="nc" id="L33770">            int totalLaunched = 0;</span>
<span class="nc" id="L33771">            boolean isPod = false;</span>
<span class="nc bnc" id="L33772" title="All 2 branches missed.">            while (launchCounter &gt; 0) {</span>
<span class="nc" id="L33773">                int launched = 0;</span>
<span class="nc bnc" id="L33774" title="All 6 branches missed.">                if (entity.getPodsLeft() &gt; 0 &amp;&amp; (airborne || entity.getPodsLeft() &gt;= entity.getLifeBoatsLeft())) {</span>
                    //Entity has more escape pods than lifeboats (or equal numbers)
<span class="nc" id="L33776">                    launched = Math.min(launchCounter, entity.getPodsLeft());</span>
<span class="nc" id="L33777">                    entity.setLaunchedEscapePods(entity.getLaunchedEscapePods() + launched);</span>
<span class="nc" id="L33778">                    totalLaunched += launched;</span>
<span class="nc" id="L33779">                    launchCounter -= launched;</span>
<span class="nc" id="L33780">                    isPod = true;</span>
<span class="nc bnc" id="L33781" title="All 6 branches missed.">                } else if (inSpace &amp;&amp; entity.getLifeBoatsLeft() &gt; 0 &amp;&amp; (entity.getLifeBoatsLeft() &gt; entity.getPodsLeft())) {</span>
                    //Entity has more lifeboats left
<span class="nc" id="L33783">                    launched = Math.min(launchCounter, entity.getLifeBoatsLeft());</span>
<span class="nc" id="L33784">                    entity.setLaunchedLifeBoats(entity.getLaunchedLifeBoats() + launched);</span>
<span class="nc" id="L33785">                    totalLaunched += launched;</span>
<span class="nc" id="L33786">                    launchCounter -= launched;</span>
                } else {
                    //We've run out of both. End the loop
                    break;
                }
<span class="nc" id="L33791">            }</span>
<span class="nc" id="L33792">            int nEscaped = Math.min((entity.getCrew().getCurrentSize() + entity.getNPassenger()), (totalLaunched * 6));</span>
            //Report how many pods launched and how many escaped
<span class="nc bnc" id="L33794" title="All 2 branches missed.">            if (totalLaunched &gt; 0) {</span>
<span class="nc" id="L33795">                r = new Report(6401);</span>
<span class="nc" id="L33796">                r.subject = entity.getId();</span>
<span class="nc" id="L33797">                r.indent();</span>
<span class="nc" id="L33798">                r.add(totalLaunched);</span>
<span class="nc" id="L33799">                r.add(nEscaped);</span>
<span class="nc" id="L33800">                vDesc.addElement(r);</span>
            }
<span class="nc" id="L33802">            EscapePods pods = new EscapePods(entity,totalLaunched,isPod);</span>
<span class="nc" id="L33803">            entity.addEscapeCraft(pods.getExternalIdAsString());</span>
            //Update the personnel numbers
            
            //If there are passengers aboard, get them out first
<span class="nc bnc" id="L33807" title="All 2 branches missed.">            if (entity.getNPassenger() &gt; 0) {</span>
<span class="nc" id="L33808">                int change = Math.min(entity.getNPassenger(), nEscaped);</span>
<span class="nc" id="L33809">                entity.setNPassenger(Math.max(entity.getNPassenger() - nEscaped, 0));</span>
<span class="nc" id="L33810">                pods.addPassengers(entity.getExternalIdAsString(), change);</span>
<span class="nc" id="L33811">                nEscaped -= change;</span>
            }
            //Now get the crew out with such space as is left
<span class="nc bnc" id="L33814" title="All 2 branches missed.">            if (nEscaped &gt; 0) {</span>
<span class="nc" id="L33815">                entity.setNCrew(entity.getNCrew() - nEscaped);</span>
<span class="nc" id="L33816">                entity.getCrew().setCurrentSize(Math.max(0, entity.getCrew().getCurrentSize() - nEscaped));</span>
<span class="nc" id="L33817">                pods.addNOtherCrew(entity.getExternalIdAsString(), nEscaped);</span>
                //*Damage* the host ship's crew to account for the people that left
<span class="nc" id="L33819">                vDesc.addAll(damageCrew(entity,entity.getCrew().calculateHits()));</span>
<span class="nc bnc" id="L33820" title="All 2 branches missed.">                if (entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
                    //Then we've finished ejecting
<span class="nc" id="L33822">                    entity.getCrew().setEjected(true);</span>
                }
            }
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33827">            pods.setPosition(entity.getPosition());</span>
<span class="nc" id="L33828">            pods.setGame(game);</span>
<span class="nc" id="L33829">            pods.setDeployed(true);</span>
<span class="nc" id="L33830">            pods.setId(getFreeEntityId());</span>
            //Escape craft retain the heading and velocity of the unit they eject from
<span class="nc" id="L33832">            pods.setVectors(entity.getVectors());</span>
<span class="nc" id="L33833">            pods.setFacing(entity.getFacing());</span>
<span class="nc" id="L33834">            pods.setCurrentVelocity(entity.getCurrentVelocity());</span>
            //If the crew ejects, they should no longer be accelerating
<span class="nc" id="L33836">            pods.setNextVelocity(entity.getVelocity());</span>
<span class="nc bnc" id="L33837" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L33838">                pods.setAltitude(entity.getAltitude());</span>
            }
            // Add Entity to game
<span class="nc" id="L33841">            game.addEntity(pods);</span>
            // No movement this turn
<span class="nc" id="L33843">            pods.setDone(true);</span>
            // Tell clients about new entity
<span class="nc" id="L33845">            send(createAddEntityPacket(pods.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33847">            entityUpdate(pods.getId());</span>
<span class="nc bnc" id="L33848" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33849">                game.removeEntity(pods.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33850">                send(createRemoveEntityPacket(pods.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
<span class="nc" id="L33852">        } // End Escape Pod/Lifeboat Ejection</span>
        else {
<span class="nc bnc" id="L33854" title="All 2 branches missed.">            if (airborne) {</span>
                // Can't abandon in atmosphere with no escape pods
<span class="nc" id="L33856">                r = new Report(6402);</span>
<span class="nc" id="L33857">                r.subject = entity.getId();</span>
<span class="nc" id="L33858">                r.addDesc(entity);</span>
<span class="nc" id="L33859">                r.indent();</span>
<span class="nc" id="L33860">                vDesc.addElement(r);</span>
<span class="nc" id="L33861">                return vDesc;</span>
            }
            
            // Eject up to 50 spacesuited crewmen out the nearest airlock!
            // This only works in space or on the ground
<span class="nc" id="L33866">            int nEscaped = Math.min(entity.getNPassenger() + entity.getCrew().getCurrentSize(), 50);</span>
<span class="nc" id="L33867">            EjectedCrew crew = new EjectedCrew(entity, nEscaped);</span>
<span class="nc" id="L33868">            entity.addEscapeCraft(crew.getExternalIdAsString());</span>
            
            //Report the escape
<span class="nc" id="L33871">            r = new Report(6403);</span>
<span class="nc" id="L33872">            r.subject = entity.getId();</span>
<span class="nc" id="L33873">            r.addDesc(entity);</span>
<span class="nc" id="L33874">            r.add(nEscaped);</span>
<span class="nc" id="L33875">            r.indent();</span>
<span class="nc" id="L33876">            vDesc.addElement(r);</span>

            //If there are passengers aboard, get them out first
<span class="nc bnc" id="L33879" title="All 2 branches missed.">            if (entity.getNPassenger() &gt; 0) {</span>
<span class="nc" id="L33880">                int change = Math.min(entity.getNPassenger(), nEscaped);</span>
<span class="nc" id="L33881">                entity.setNPassenger(Math.max(entity.getNPassenger() - nEscaped, 0));</span>
<span class="nc" id="L33882">                crew.addPassengers(entity.getExternalIdAsString(), change);</span>
<span class="nc" id="L33883">                nEscaped -= change;</span>
            }
            //Now get the crew out with such airlock space as is left
<span class="nc bnc" id="L33886" title="All 2 branches missed.">            if (nEscaped &gt; 0) {</span>
<span class="nc" id="L33887">                entity.setNCrew(entity.getNCrew() - nEscaped);</span>
<span class="nc" id="L33888">                entity.getCrew().setCurrentSize(Math.max(0, entity.getCrew().getCurrentSize() - nEscaped));</span>
<span class="nc" id="L33889">                crew.addNOtherCrew(entity.getExternalIdAsString(), nEscaped);</span>
                //*Damage* the host ship's crew to account for the people that left
<span class="nc" id="L33891">                vDesc.addAll(damageCrew(entity,entity.getCrew().calculateHits()));</span>
<span class="nc bnc" id="L33892" title="All 2 branches missed.">                if (entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
                    //Then we've finished ejecting
<span class="nc" id="L33894">                    entity.getCrew().setEjected(true);</span>
                }
            }
            
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33900">            crew.setGame(game);</span>
<span class="nc" id="L33901">            crew.setDeployed(true);</span>
<span class="nc" id="L33902">            crew.setId(getFreeEntityId());</span>
<span class="nc bnc" id="L33903" title="All 2 branches missed.">            if (inSpace) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L33905">                crew.setVectors(entity.getVectors());</span>
<span class="nc" id="L33906">                crew.setFacing(entity.getFacing());</span>
<span class="nc" id="L33907">                crew.setCurrentVelocity(entity.getVelocity());</span>
                //If the crew ejects, they should no longer be accelerating
<span class="nc" id="L33909">                crew.setNextVelocity(entity.getVelocity());</span>
                // We're going to be nice and assume a ship has enough spacesuits for everyone aboard...
<span class="nc" id="L33911">                crew.setSpaceSuit(true);</span>
<span class="nc" id="L33912">                crew.setPosition(entity.getPosition());</span>
            } else {
                // On the ground, crew must abandon into a legal hex
<span class="nc" id="L33915">                Coords legalPosition = null;</span>
                //Small Craft can just abandon into the hex they occupy
<span class="nc bnc" id="L33917" title="All 4 branches missed.">                if (!entity.isLargeCraft() &amp;&amp; !crew.isLocationProhibited(entity.getPosition())) {</span>
<span class="nc" id="L33918">                    legalPosition = entity.getPosition();</span>
                } else {
                    //Use the passed in coords. We already calculated whether they're legal or not
<span class="nc" id="L33921">                    legalPosition = pos;</span>
                }
                // Cannot abandon if there is no legal hex.  This shoudln't have
                // been allowed
<span class="nc bnc" id="L33925" title="All 2 branches missed.">                if (legalPosition == null) {</span>
<span class="nc" id="L33926">                    MegaMek.getLogger().error(&quot;Spacecraft crews cannot abandon if there is no legal hex!&quot;);</span>
<span class="nc" id="L33927">                    return vDesc;</span>
                }
<span class="nc" id="L33929">                crew.setPosition(legalPosition);</span>
            }
            // Add Entity to game
<span class="nc" id="L33932">            game.addEntity(crew);</span>
            // No movement this turn
<span class="nc" id="L33934">            crew.setDone(true);</span>
            // Tell clients about new entity
<span class="nc" id="L33936">            send(createAddEntityPacket(crew.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33938">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L33940">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew,</span>
<span class="nc" id="L33941">                    entity.getPosition(), entity.getPosition(),</span>
<span class="nc" id="L33942">                    entity.getElevation()));</span>
<span class="nc bnc" id="L33943" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33944">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33945">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        }
        // If we get here, end movement and return the report
<span class="nc" id="L33949">        entity.setDone(true);</span>
<span class="nc" id="L33950">        entityUpdate(entity.getId());</span>
<span class="nc" id="L33951">        return vDesc;</span>
    }

    public static PilotingRollData getEjectModifiers(IGame game,
            Entity entity, int crewPos, boolean autoEject) {
<span class="nc" id="L33956">        int facing = entity.getFacing();</span>
<span class="nc bnc" id="L33957" title="All 2 branches missed.">        if (entity.isPartOfFighterSquadron()) {</span>
            // Because the components of a squadron have no position and will pass the next test
<span class="nc" id="L33959">            Entity squadron = game.getEntity(entity.getTransportId());</span>
<span class="nc" id="L33960">            return getEjectModifiers(game, entity, crewPos, autoEject, squadron.getPosition(),</span>
                    &quot;ejecting&quot;);
        }
<span class="nc bnc" id="L33963" title="All 2 branches missed.">        if(null == entity.getPosition()) {</span>
            // Off-board unit?
<span class="nc" id="L33965">            return new PilotingRollData(entity.getId(), entity.getCrew().getPiloting(), &quot;ejecting&quot;);</span>
        }
<span class="nc" id="L33967">        Coords targetCoords = entity.getPosition().translated((facing + 3) % 6);</span>
<span class="nc" id="L33968">        return getEjectModifiers(game, entity, crewPos, autoEject, targetCoords,</span>
                &quot;ejecting&quot;);
    }

    public static PilotingRollData getEjectModifiers(IGame game, Entity entity, int crewPos,
            boolean autoEject, Coords targetCoords, String desc) {
<span class="nc" id="L33974">        PilotingRollData rollTarget = new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L33975">                entity.getCrew().getPiloting(crewPos), desc);</span>
        // Per SO p26, fighters can eject as per TO rules on 196 with some exceptions
<span class="nc bnc" id="L33977" title="All 2 branches missed.">        if (entity.isProne()) {</span>
<span class="nc" id="L33978">            rollTarget.addModifier(5, &quot;Mech is prone&quot;);</span>
        }
<span class="nc bnc" id="L33980" title="All 2 branches missed.">        if (entity.getCrew().isUnconscious(crewPos)) {</span>
<span class="nc" id="L33981">            rollTarget.addModifier(3, &quot;pilot unconscious&quot;);</span>
        }
<span class="nc bnc" id="L33983" title="All 2 branches missed.">        if (autoEject) {</span>
<span class="nc" id="L33984">            rollTarget.addModifier(1, &quot;automatic ejection&quot;);</span>
        }
        // Per SO p27, Large Craft roll too, to see how many escape pods launch successfully
<span class="nc bnc" id="L33987" title="All 4 branches missed.">        if ((entity.isAero() &amp;&amp; ((IAero)entity).isOutControl())</span>
<span class="nc bnc" id="L33988" title="All 4 branches missed.">                || (entity.isPartOfFighterSquadron() &amp;&amp; ((IAero)game.getEntity(entity.getTransportId())).isOutControl())) {</span>
<span class="nc" id="L33989">            rollTarget.addModifier(5, &quot;Out of Control&quot;);</span>
        }
        // A decreased large craft crew makes it harder to eject large numbers of pods
<span class="nc bnc" id="L33992" title="All 4 branches missed.">        if (entity.isLargeCraft() &amp;&amp; entity.getCrew().getHits() &gt; 0) {</span>
<span class="nc" id="L33993">            rollTarget.addModifier(entity.getCrew().getHits(), &quot;Crew hits&quot;);</span>
        }
<span class="nc bnc" id="L33995" title="All 2 branches missed.">        if ((entity instanceof Mech)</span>
<span class="nc" id="L33996">                &amp;&amp; (entity.getInternal(Mech.LOC_HEAD) &lt; entity</span>
<span class="nc bnc" id="L33997" title="All 2 branches missed.">                        .getOInternal(Mech.LOC_HEAD))) {</span>
<span class="nc" id="L33998">            rollTarget.addModifier(</span>
<span class="nc" id="L33999">                    entity.getOInternal(Mech.LOC_HEAD)</span>
<span class="nc" id="L34000">                            - entity.getInternal(Mech.LOC_HEAD),</span>
                    &quot;Head Internal Structure Damage&quot;);
        }
<span class="nc" id="L34003">        IHex targetHex = game.getBoard().getHex(targetCoords);</span>
        //Terrain modifiers should only apply if the unit is on the ground...
<span class="nc bnc" id="L34005" title="All 4 branches missed.">        if (!entity.isSpaceborne() &amp;&amp; !entity.isAirborne()) {</span>
<span class="nc bnc" id="L34006" title="All 2 branches missed.">            if (targetHex != null) {</span>
<span class="nc bnc" id="L34007" title="All 2 branches missed.">                if ((targetHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34008" title="All 2 branches missed.">                        &amp;&amp; !targetHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34009">                    rollTarget.addModifier(-1, &quot;landing in water&quot;);</span>
<span class="nc bnc" id="L34010" title="All 2 branches missed.">                } else if (targetHex.containsTerrain(Terrains.ROUGH)) {</span>
<span class="nc" id="L34011">                    rollTarget.addModifier(0, &quot;landing in rough&quot;);</span>
<span class="nc bnc" id="L34012" title="All 2 branches missed.">                } else if (targetHex.containsTerrain(Terrains.RUBBLE)) {</span>
<span class="nc" id="L34013">                    rollTarget.addModifier(0, &quot;landing in rubble&quot;);</span>
<span class="nc bnc" id="L34014" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 1) {</span>
<span class="nc" id="L34015">                    rollTarget.addModifier(2, &quot;landing in light woods&quot;);</span>
<span class="nc bnc" id="L34016" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 2) {</span>
<span class="nc" id="L34017">                    rollTarget.addModifier(3, &quot;landing in heavy woods&quot;);</span>
<span class="nc bnc" id="L34018" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 3) {</span>
<span class="nc" id="L34019">                    rollTarget.addModifier(4, &quot;landing in ultra heavy woods&quot;);</span>
<span class="nc bnc" id="L34020" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 1) {</span>
<span class="nc" id="L34021">                    rollTarget.addModifier(3, &quot;landing in light jungle&quot;);</span>
<span class="nc bnc" id="L34022" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 2) {</span>
<span class="nc" id="L34023">                    rollTarget.addModifier(5, &quot;landing in heavy jungle&quot;);</span>
<span class="nc bnc" id="L34024" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 3) {</span>
<span class="nc" id="L34025">                    rollTarget.addModifier(7, &quot;landing in ultra heavy jungle&quot;);</span>
<span class="nc bnc" id="L34026" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.BLDG_ELEV) &gt; 0) {</span>
<span class="nc" id="L34027">                    rollTarget.addModifier(</span>
<span class="nc" id="L34028">                            targetHex.terrainLevel(Terrains.BLDG_ELEV),</span>
                            &quot;landing in a building&quot;);
                } else {
<span class="nc" id="L34031">                    rollTarget.addModifier(-2, &quot;landing in clear terrain&quot;);</span>
                }
            } else {
<span class="nc" id="L34034">                rollTarget.addModifier(-2, &quot;landing off the board&quot;);</span>
            }
        }
<span class="nc bnc" id="L34037" title="All 2 branches missed.">        if (!entity.isSpaceborne()) {</span>
            //At present, the UI lets you set these atmospheric conditions for a space battle, but it shouldn't
            //That's a fix for another day, probably when I get around to space terrain and 'weather'
<span class="nc bnc" id="L34040" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getGravity() == 0) {</span>
<span class="nc" id="L34041">                rollTarget.addModifier(3, &quot;Zero-G&quot;);</span>
<span class="nc bnc" id="L34042" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getGravity() &lt; .8) {</span>
<span class="nc" id="L34043">                rollTarget.addModifier(2, &quot;Low-G&quot;);</span>
<span class="nc bnc" id="L34044" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getGravity() &gt; 1.2) {</span>
<span class="nc" id="L34045">                rollTarget.addModifier(2, &quot;High-G&quot;);</span>
            }
        
            //Vacuum shouldn't apply to ASF ejection since they're designed for it, but the rules don't specify
            //High and low pressures make more sense to apply to all
<span class="nc bnc" id="L34050" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_VACUUM) {</span>
<span class="nc" id="L34051">                rollTarget.addModifier(3, &quot;Vacuum&quot;);</span>
<span class="nc bnc" id="L34052" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_VHIGH) {</span>
<span class="nc" id="L34053">                rollTarget.addModifier(2, &quot;Very High Atmosphere Pressure&quot;);</span>
<span class="nc bnc" id="L34054" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_TRACE) {</span>
<span class="nc" id="L34055">                rollTarget.addModifier(2, &quot;Trace atmosphere&quot;);</span>
            }
        }

<span class="nc bnc" id="L34059" title="All 2 branches missed.">        if ((game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW)</span>
<span class="nc bnc" id="L34060" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_ICE_STORM)</span>
<span class="nc bnc" id="L34061" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_DOWNPOUR)</span>
<span class="nc bnc" id="L34062" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_STRONG_GALE)) {</span>
<span class="nc" id="L34063">            rollTarget.addModifier(2, &quot;Bad Weather&quot;);</span>
        }

<span class="nc bnc" id="L34066" title="All 2 branches missed.">        if ((game.getPlanetaryConditions().getWindStrength() &gt;= PlanetaryConditions.WI_STORM)</span>
<span class="nc bnc" id="L34067" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_BLIZZARD)</span>
<span class="nc bnc" id="L34068" title="All 2 branches missed.">                || ((game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW) &amp;&amp; (game</span>
<span class="nc bnc" id="L34069" title="All 2 branches missed.">                        .getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_STRONG_GALE))) {</span>
<span class="nc" id="L34070">            rollTarget.addModifier(3, &quot;Really Bad Weather&quot;);</span>
        }
<span class="nc" id="L34072">        return rollTarget;</span>
    }

    /**
     * Creates a new Ballistic Infantry unit at the end of the movement phase
     */
    public void resolveCallSupport() {
<span class="nc bnc" id="L34079" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L34080" title="All 4 branches missed.">            if ((e instanceof Infantry) &amp;&amp; ((Infantry) e).getIsCallingSupport()) {</span>

                // Now lets create a new foot platoon
<span class="nc" id="L34083">                Infantry guerrilla = new Infantry();</span>
<span class="nc" id="L34084">                guerrilla.setChassis(&quot;Insurgents&quot;);</span>
<span class="nc" id="L34085">                guerrilla.setModel(&quot;(Rifle)&quot;);</span>
<span class="nc" id="L34086">                guerrilla.setSquadN(4);</span>
<span class="nc" id="L34087">                guerrilla.setSquadSize(7);</span>
<span class="nc" id="L34088">                guerrilla.autoSetInternal();</span>
<span class="nc" id="L34089">                guerrilla.getCrew().setGunnery(5, 0);</span>
                try {
<span class="nc" id="L34091">                    guerrilla.addEquipment(EquipmentType.get(EquipmentTypeLookup.INFANTRY_ASSAULT_RIFLE),</span>
                            Infantry.LOC_INFANTRY);
<span class="nc" id="L34093">                    guerrilla.setPrimaryWeapon((InfantryWeapon) InfantryWeapon</span>
<span class="nc" id="L34094">                            .get(EquipmentTypeLookup.INFANTRY_ASSAULT_RIFLE));</span>
<span class="nc" id="L34095">                } catch (Exception ex) {</span>
<span class="nc" id="L34096">                    ex.printStackTrace();</span>
<span class="nc" id="L34097">                }</span>
<span class="nc" id="L34098">                guerrilla.setDeployed(true);</span>
<span class="nc" id="L34099">                guerrilla.setDone(true);</span>
<span class="nc" id="L34100">                guerrilla.setId(getFreeEntityId());</span>
<span class="nc" id="L34101">                guerrilla.setOwner(e.getOwner());</span>
<span class="nc" id="L34102">                game.addEntity(guerrilla);</span>

                // Add the infantry unit on the battlefield. Should spawn within 3 hexes
                // First get coords then loop over some targets
<span class="nc" id="L34106">                Coords tmpCoords = e.getPosition();</span>
<span class="nc" id="L34107">                Coords targetCoords = null;</span>
<span class="nc bnc" id="L34108" title="All 2 branches missed.">                while (!game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34109">                    targetCoords = Compute.scatter(tmpCoords, (Compute.d6(1) / 2));</span>
<span class="nc bnc" id="L34110" title="All 2 branches missed.">                    if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34111">                        guerrilla.setPosition(targetCoords);</span>
<span class="nc" id="L34112">                        break;</span>
                    }
                }
<span class="nc" id="L34115">                send(createAddEntityPacket(guerrilla.getId()));</span>
<span class="nc" id="L34116">                ((Infantry) e).setIsCallingSupport(false);</span>
                /*
                // Update the entity
                entityUpdate(guerrilla.getId());
                Report r = new Report(5535, Report.PUBLIC);
                r.subject = e.getId();
                r.addDesc(e);
                addReport(r);*/
            }
<span class="nc" id="L34125">        }</span>
<span class="nc" id="L34126">    }</span>

    /**
     * Abandon an Entity.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; to abandon.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; abandonEntity(Entity entity) {
<span class="nc" id="L34135">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L34139" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L34140">            return vDesc;</span>
        }

<span class="nc bnc" id="L34143" title="All 4 branches missed.">        if (entity.getCrew().isDoomed() || entity.getCrew().isDead()) {</span>
<span class="nc" id="L34144">            return vDesc;</span>
        }

<span class="nc" id="L34147">        Coords targetCoords = entity.getPosition();</span>

<span class="nc bnc" id="L34149" title="All 6 branches missed.">        if (entity instanceof Mech || (entity.isAero() &amp;&amp; !entity.isAirborne())) {</span>
            // okay, print the info
<span class="nc" id="L34151">            r = new Report(2027);</span>
<span class="nc" id="L34152">            r.subject = entity.getId();</span>
<span class="nc" id="L34153">            r.add(entity.getCrew().getName());</span>
<span class="nc" id="L34154">            r.addDesc(entity);</span>
<span class="nc" id="L34155">            r.indent(3);</span>
<span class="nc" id="L34156">            vDesc.addElement(r);</span>
            // Don't make ill-equipped pilots abandon into vacuum
<span class="nc bnc" id="L34158" title="All 4 branches missed.">            if (game.getPlanetaryConditions().isVacuum() &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L34159">                return vDesc;</span>
            }

            // create the MechWarrior in any case, for campaign tracking
<span class="nc" id="L34163">            MechWarrior pilot = new MechWarrior(entity);</span>
<span class="nc" id="L34164">            pilot.getCrew().setUnconscious(entity.getCrew().isUnconscious());</span>
<span class="nc" id="L34165">            pilot.setDeployed(true);</span>
<span class="nc" id="L34166">            pilot.setId(getFreeEntityId());</span>
            //Pilot flight suits are vacuum-rated. MechWarriors wear shorts...
<span class="nc" id="L34168">            pilot.setSpaceSuit(entity.isAero());</span>
<span class="nc bnc" id="L34169" title="All 2 branches missed.">            if (entity.isSpaceborne()) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L34171">                pilot.setVectors(entity.getVectors());</span>
<span class="nc" id="L34172">                pilot.setFacing(entity.getFacing());</span>
<span class="nc" id="L34173">                pilot.setCurrentVelocity(entity.getVelocity());</span>
                //If the pilot ejects, he should no longer be accelerating
<span class="nc" id="L34175">                pilot.setNextVelocity(entity.getVelocity());</span>
            }
<span class="nc" id="L34177">            game.addEntity(pilot);</span>
<span class="nc" id="L34178">            send(createAddEntityPacket(pilot.getId()));</span>
            // make him not get a move this turn
<span class="nc" id="L34180">            pilot.setDone(true);</span>
            // Add the pilot as an infantry unit on the battlefield.
<span class="nc bnc" id="L34182" title="All 2 branches missed.">            if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34183">                pilot.setPosition(targetCoords);</span>
            }
<span class="nc" id="L34185">            pilot.setCommander(entity.isCommander());</span>
            // Update the entity
<span class="nc" id="L34187">            entityUpdate(pilot.getId());</span>
            // check if the pilot lands in a minefield
<span class="nc" id="L34189">            vDesc.addAll(doEntityDisplacementMinefieldCheck(pilot, entity.getPosition(),</span>
<span class="nc" id="L34190">                    targetCoords, entity.getElevation()));</span>
<span class="nc bnc" id="L34191" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34192">                game.removeEntity(pilot.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34193">                send(createRemoveEntityPacket(pilot.getId(),</span>
                        IEntityRemovalConditions.REMOVE_IN_RETREAT));
            }
<span class="nc" id="L34196">        } // End entity-is-Mek or Aero</span>
<span class="nc bnc" id="L34197" title="All 4 branches missed.">        else if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT)</span>
                 &amp;&amp; (entity instanceof Tank)) {
            // Don't make them abandon into vacuum
<span class="nc bnc" id="L34200" title="All 2 branches missed.">            if (game.getPlanetaryConditions().isVacuum()) {</span>
<span class="nc" id="L34201">                return vDesc;</span>
            }
<span class="nc" id="L34203">            EjectedCrew crew = new EjectedCrew(entity);</span>
<span class="nc" id="L34204">            crew.setDeployed(true);</span>
<span class="nc" id="L34205">            crew.setId(getFreeEntityId());</span>
<span class="nc" id="L34206">            game.addEntity(crew);</span>
<span class="nc" id="L34207">            send(createAddEntityPacket(crew.getId()));</span>
            // Make them not get a move this turn
<span class="nc" id="L34209">            crew.setDone(true);</span>
            // Place on board
<span class="nc bnc" id="L34211" title="All 2 branches missed.">            if(game.getBoard().contains(entity.getPosition())) {</span>
<span class="nc" id="L34212">                crew.setPosition(entity.getPosition());</span>
            }
            // Update the entity
<span class="nc" id="L34215">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L34217">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew, entity.getPosition(),</span>
<span class="nc" id="L34218">                    entity.getPosition(), entity.getElevation()));</span>
<span class="nc bnc" id="L34219" title="All 2 branches missed.">            if(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34220">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34221">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        }

        // Mark the entity's crew as &quot;ejected&quot;.
<span class="nc" id="L34226">        entity.getCrew().setEjected(true);</span>

<span class="nc" id="L34228">        return vDesc;</span>
    }

    /**
     * Checks if ejected MechWarriors are eligible to be picked up, and if so,
     * captures them or picks them up
     */
    private void resolveMechWarriorPickUp() {
        Report r;

        // fetch all mechWarriors that are not picked up
<span class="nc" id="L34239">        Iterator&lt;Entity&gt; mechWarriors = game.getSelectedEntities(entity -&gt; {</span>
<span class="nc bnc" id="L34240" title="All 2 branches missed.">                    if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L34241">                        MechWarrior mw = (MechWarrior) entity;</span>
<span class="nc bnc" id="L34242" title="All 2 branches missed.">                        return (mw.getPickedUpById() == Entity.NONE)</span>
<span class="nc bnc" id="L34243" title="All 2 branches missed.">                                &amp;&amp; !mw.isDoomed()</span>
<span class="nc bnc" id="L34244" title="All 2 branches missed.">                                &amp;&amp; (mw.getTransportId() == Entity.NONE);</span>
                    }
<span class="nc" id="L34246">                    return false;</span>
                });
        // loop through them, check if they are in a hex occupied by another
        // unit
<span class="nc bnc" id="L34250" title="All 2 branches missed.">        while (mechWarriors.hasNext()) {</span>
<span class="nc" id="L34251">            boolean pickedUp = false;</span>
<span class="nc" id="L34252">            MechWarrior e = (MechWarrior) mechWarriors.next();</span>
            // Check for owner entities first...
<span class="nc bnc" id="L34254" title="All 2 branches missed.">            for (Entity pe : game.getEntitiesVector(e.getPosition())) {</span>
<span class="nc bnc" id="L34255" title="All 6 branches missed.">                if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34256" title="All 4 branches missed.">                        || (pe.isAirborne() &amp;&amp; !pe.isSpaceborne())</span>
<span class="nc bnc" id="L34257" title="All 2 branches missed.">                        || (pe.getElevation() != e.getElevation())</span>
<span class="nc bnc" id="L34258" title="All 2 branches missed.">                        || (pe.getOwnerId() != e.getOwnerId())</span>
<span class="nc bnc" id="L34259" title="All 2 branches missed.">                        || (pe.getId() == e.getId())) {</span>
<span class="nc" id="L34260">                    continue;</span>
                }
<span class="nc bnc" id="L34262" title="All 2 branches missed.">                if (pe instanceof MechWarrior) {</span>
                    // MWs have a beer together
<span class="nc" id="L34264">                    r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34265">                    r.add(pe.getDisplayName());</span>
<span class="nc" id="L34266">                    addReport(r);</span>
<span class="nc" id="L34267">                    continue;</span>
                }
                // Pick up the unit.
<span class="nc" id="L34270">                pe.pickUp(e);</span>
                // The picked unit is being carried by the loader.
<span class="nc" id="L34272">                e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34273">                e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34274">                pickedUp = true;</span>
<span class="nc" id="L34275">                r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34276">                r.add(e.getDisplayName());</span>
<span class="nc" id="L34277">                r.addDesc(pe);</span>
<span class="nc" id="L34278">                addReport(r);</span>
<span class="nc" id="L34279">                break;</span>
            }
            // Check for allied entities next...
<span class="nc bnc" id="L34282" title="All 2 branches missed.">            if (!pickedUp) {</span>
<span class="nc bnc" id="L34283" title="All 2 branches missed.">                for (Entity pe : game.getEntitiesVector(e.getPosition())) {</span>
<span class="nc bnc" id="L34284" title="All 6 branches missed.">                    if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34285" title="All 4 branches missed.">                            || (pe.isAirborne() &amp;&amp; !pe.isSpaceborne())</span>
<span class="nc bnc" id="L34286" title="All 2 branches missed.">                            || (pe.getElevation() != e.getElevation())</span>
<span class="nc bnc" id="L34287" title="All 4 branches missed.">                            || (pe.getOwnerId() == e.getOwnerId()) || (pe.getId() == e.getId())</span>
<span class="nc bnc" id="L34288" title="All 2 branches missed.">                            || (pe.getOwner().getTeam() == IPlayer.TEAM_NONE)</span>
<span class="nc bnc" id="L34289" title="All 2 branches missed.">                            || (pe.getOwner().getTeam() != e.getOwner().getTeam())) {</span>
<span class="nc" id="L34290">                        continue;</span>
                    }
<span class="nc bnc" id="L34292" title="All 2 branches missed.">                    if (pe instanceof MechWarrior) {</span>
                        // MWs have a beer together
<span class="nc" id="L34294">                        r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34295">                        r.add(pe.getDisplayName());</span>
<span class="nc" id="L34296">                        addReport(r);</span>
<span class="nc" id="L34297">                        continue;</span>
                    }
                    // Pick up the unit.
<span class="nc" id="L34300">                    pe.pickUp(e);</span>
                    // The picked unit is being carried by the loader.
<span class="nc" id="L34302">                    e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34303">                    e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34304">                    pickedUp = true;</span>
<span class="nc" id="L34305">                    r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34306">                    r.add(e.getDisplayName());</span>
<span class="nc" id="L34307">                    r.addDesc(pe);</span>
<span class="nc" id="L34308">                    addReport(r);</span>
<span class="nc" id="L34309">                    break;</span>
                }
            }
            // Now check for anyone else...
<span class="nc bnc" id="L34313" title="All 2 branches missed.">            if (!pickedUp) {</span>
<span class="nc" id="L34314">                Iterator&lt;Entity&gt; pickupEnemyEntities = game.getEnemyEntities(e.getPosition(), e);</span>
<span class="nc bnc" id="L34315" title="All 2 branches missed.">                while (pickupEnemyEntities.hasNext()) {</span>
<span class="nc" id="L34316">                    Entity pe = pickupEnemyEntities.next();</span>
<span class="nc bnc" id="L34317" title="All 6 branches missed.">                    if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34318" title="All 4 branches missed.">                            || pe.isAirborne() || (pe.getElevation() != e.getElevation())) {</span>
<span class="nc" id="L34319">                        continue;</span>
                    }
<span class="nc bnc" id="L34321" title="All 2 branches missed.">                    if (pe instanceof MechWarrior) {</span>
                        // MWs have a beer together
<span class="nc" id="L34323">                        r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34324">                        r.add(pe.getDisplayName());</span>
<span class="nc" id="L34325">                        addReport(r);</span>
<span class="nc" id="L34326">                        continue;</span>
                    }
                    // Capture the unit.
<span class="nc" id="L34329">                    pe.pickUp(e);</span>
                    // The captured unit is being carried by the loader.
<span class="nc" id="L34331">                    e.setCaptured(true);</span>
<span class="nc" id="L34332">                    e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34333">                    e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34334">                    pickedUp = true;</span>
<span class="nc" id="L34335">                    r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34336">                    r.add(e.getDisplayName());</span>
<span class="nc" id="L34337">                    r.addDesc(pe);</span>
<span class="nc" id="L34338">                    addReport(r);</span>
<span class="nc" id="L34339">                    break;</span>
                }
            }
<span class="nc bnc" id="L34342" title="All 2 branches missed.">            if (pickedUp) {</span>
                // Remove the picked-up unit from the screen.
<span class="nc" id="L34344">                e.setPosition(null);</span>
                // Update the loaded unit.
<span class="nc" id="L34346">                entityUpdate(e.getId());</span>
            }
<span class="nc" id="L34348">        }</span>
<span class="nc" id="L34349">    }</span>

    /**
     * destroy all wheeled and tracked Tanks that got displaced into water
     */
    private void resolveSinkVees() {
<span class="nc" id="L34355">        Iterator&lt;Entity&gt; sinkableTanks = game.getSelectedEntities(entity -&gt; {</span>
<span class="nc bnc" id="L34356" title="All 6 branches missed.">                    if (entity.isOffBoard() || (entity.getPosition() == null)</span>
                            || !(entity instanceof Tank)) {
<span class="nc" id="L34358">                        return false;</span>
                    }
<span class="nc" id="L34360">                    final IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34361" title="All 2 branches missed.">                    final boolean onBridge = (hex.terrainLevel(Terrains.BRIDGE) &gt; 0)</span>
<span class="nc bnc" id="L34362" title="All 2 branches missed.">                            &amp;&amp; (entity.getElevation() == hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
<span class="nc bnc" id="L34363" title="All 2 branches missed.">                    return ((entity.getMovementMode() == EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L34364" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.WHEELED)</span>
<span class="nc bnc" id="L34365" title="All 2 branches missed.">                            || ((entity.getMovementMode() == EntityMovementMode.HOVER)))</span>
<span class="nc bnc" id="L34366" title="All 6 branches missed.">                            &amp;&amp; entity.isImmobile() &amp;&amp; (hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34367" title="All 2 branches missed.">                            &amp;&amp; !onBridge &amp;&amp; !(entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS))</span>
<span class="nc bnc" id="L34368" title="All 2 branches missed.">                            &amp;&amp; !(entity.hasWorkingMisc(MiscType.F_FLOTATION_HULL));</span>
                });
<span class="nc bnc" id="L34370" title="All 2 branches missed.">        while (sinkableTanks.hasNext()) {</span>
<span class="nc" id="L34371">            Entity e = sinkableTanks.next();</span>
<span class="nc" id="L34372">            addReport(destroyEntity(e, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L34373">        }</span>
<span class="nc" id="L34374">    }</span>

    /**
     * let all Entities make their &quot;break-free-of-swamp-stickyness&quot; PSR
     */
    private void doTryUnstuck() {
<span class="nc bnc" id="L34380" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L34381">            return;</span>
        }

        Report r;

<span class="nc" id="L34386">        Iterator&lt;Entity&gt; stuckEntities = game.getSelectedEntities(Entity::isStuck);</span>
        PilotingRollData rollTarget;
<span class="nc bnc" id="L34388" title="All 2 branches missed.">        while (stuckEntities.hasNext()) {</span>
<span class="nc" id="L34389">            Entity entity = stuckEntities.next();</span>
<span class="nc bnc" id="L34390" title="All 2 branches missed.">            if (entity.getPosition() == null) {</span>
<span class="nc bnc" id="L34391" title="All 2 branches missed.">                if (entity.isDeployed()) {</span>
<span class="nc" id="L34392">                    MegaMek.getLogger().info(&quot;Entity #&quot; + entity.getId() + &quot; does not know its position.&quot;);</span>
                } else { // If the Entity isn't deployed, then something goofy
                    // happened.  We'll just unstuck the Entity
<span class="nc" id="L34395">                    entity.setStuck(false);</span>
<span class="nc" id="L34396">                    MegaMek.getLogger().info(&quot;Entity #&quot; + entity.getId() + &quot; was stuck in a swamp, but not deployed. Stuck state reset&quot;);</span>
                }
<span class="nc" id="L34398">                continue;</span>
            }
<span class="nc" id="L34400">            rollTarget = entity.getBasePilotingRoll();</span>
<span class="nc" id="L34401">            entity.addPilotingModifierForTerrain(rollTarget);</span>
            // apart from swamp &amp; liquid magma, -1 modifier
<span class="nc" id="L34403">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc" id="L34404">            hex.getUnstuckModifier(entity.getElevation(), rollTarget);</span>
            // okay, print the info
<span class="nc" id="L34406">            r = new Report(2340);</span>
<span class="nc" id="L34407">            r.addDesc(entity);</span>
<span class="nc" id="L34408">            addReport(r);</span>

            // roll
<span class="nc" id="L34411">            final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L34412">            r = new Report(2190);</span>
<span class="nc" id="L34413">            r.subject = entity.getId();</span>
<span class="nc" id="L34414">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L34415">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L34416">            r.add(diceRoll);</span>
<span class="nc bnc" id="L34417" title="All 2 branches missed.">            if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L34418">                r.choose(false);</span>
            } else {
<span class="nc" id="L34420">                r.choose(true);</span>
<span class="nc" id="L34421">                entity.setStuck(false);</span>
<span class="nc" id="L34422">                entity.setCanUnstickByJumping(false);</span>
<span class="nc" id="L34423">                entity.setElevation(0);</span>
<span class="nc" id="L34424">                entityUpdate(entity.getId());</span>
            }
<span class="nc" id="L34426">            addReport(r);</span>
<span class="nc" id="L34427">        }</span>
<span class="nc" id="L34428">    }</span>

    /**
     * Remove all iNarc pods from all vehicles that did not move and shoot this
     * round NOTE: this is not quite what the rules say, the player should be
     * able to choose whether or not to remove all iNarc Pods that are attached.
     */
    private void resolveVeeINarcPodRemoval() {
<span class="nc" id="L34436">        Iterator&lt;Entity&gt; vees = game.getSelectedEntities(</span>
<span class="nc bnc" id="L34437" title="All 4 branches missed.">                entity -&gt; (entity instanceof Tank) &amp;&amp; (entity.mpUsed == 0));</span>
        boolean canSwipePods;
<span class="nc bnc" id="L34439" title="All 2 branches missed.">        while (vees.hasNext()) {</span>
<span class="nc" id="L34440">            canSwipePods = true;</span>
<span class="nc" id="L34441">            Entity entity = vees.next();</span>
<span class="nc bnc" id="L34442" title="All 2 branches missed.">            for (int i = 0; i &lt;= 5; i++) {</span>
<span class="nc bnc" id="L34443" title="All 2 branches missed.">                if (entity.weaponFiredFrom(i)) {</span>
<span class="nc" id="L34444">                    canSwipePods = false;</span>
                }
            }
<span class="nc bnc" id="L34447" title="All 2 branches missed.">            if (((Tank) entity).getStunnedTurns() &gt; 0) {</span>
<span class="nc" id="L34448">                canSwipePods = false;</span>
            }
<span class="nc bnc" id="L34450" title="All 4 branches missed.">            if (canSwipePods &amp;&amp; entity.hasINarcPodsAttached()</span>
<span class="nc bnc" id="L34451" title="All 2 branches missed.">                &amp;&amp; entity.getCrew().isActive()) {</span>
<span class="nc" id="L34452">                entity.removeAllINarcPods();</span>
<span class="nc" id="L34453">                Report r = new Report(2345);</span>
<span class="nc" id="L34454">                r.addDesc(entity);</span>
<span class="nc" id="L34455">                addReport(r);</span>
            }
<span class="nc" id="L34457">        }</span>
<span class="nc" id="L34458">    }</span>

    /*
     * //See note above where knownDeadEntities variable is declared private
     * void deadEntitiesCleanup() { Entity en = null; for(Enumeration k =
     * game.getGraveyardEntities(); k.hasMoreElements(); en = (Entity)
     * k.nextElement()) { if (en != null) { if (!knownDeadEntities.contains(en))
     * { knownDeadEntities.add(en); } } } }
     */

    /**
     * remove Ice in the hex that's at the passed coords, and let entities fall
     * into water below it, if there is water
     *
     * @param c the &lt;code&gt;Coords&lt;/code&gt; of the hex where ice should be removed
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; for the phase report
     */
    private Vector&lt;Report&gt; resolveIceBroken(Coords c) {
<span class="nc" id="L34476">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L34477">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L34478">        hex.removeTerrain(Terrains.ICE);</span>
<span class="nc" id="L34479">        sendChangedHex(c);</span>
        // if there is water below the ice
<span class="nc bnc" id="L34481" title="All 2 branches missed.">        if (hex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
            // drop entities on the surface into the water
<span class="nc bnc" id="L34483" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector(c)) {</span>
                // If the unit is on the surface, and is no longer allowed in
                // the hex
<span class="nc bnc" id="L34486" title="All 2 branches missed.">                boolean isHoverOrWiGE = (e.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34487" title="All 2 branches missed.">                        || (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc bnc" id="L34488" title="All 2 branches missed.">                if ((e.getElevation() == 0)</span>
<span class="nc bnc" id="L34489" title="All 4 branches missed.">                        &amp;&amp; !(hex.containsTerrain(Terrains.BLDG_ELEV, 0))</span>
<span class="nc bnc" id="L34490" title="All 2 branches missed.">                        &amp;&amp; !(isHoverOrWiGE &amp;&amp; (e.getRunMP() &gt;= 0))</span>
<span class="nc bnc" id="L34491" title="All 2 branches missed.">                        &amp;&amp; (e.getMovementMode() != EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L34492" title="All 4 branches missed.">                        &amp;&amp; !e.hasUMU()</span>
<span class="nc bnc" id="L34493" title="All 2 branches missed.">                        &amp;&amp; !(e instanceof QuadVee &amp;&amp; e.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)) {</span>
<span class="nc" id="L34494">                    vPhaseReport.addAll(doEntityFallsInto(e, c,</span>
                            new PilotingRollData(TargetRoll.AUTOMATIC_FAIL),
                            true));
                }
<span class="nc" id="L34498">            }</span>
        }
<span class="nc" id="L34500">        return vPhaseReport;</span>
    }

    /**
     * melt any snow or ice in a hex, including checking for the effects of
     * breaking through ice
     */
    private Vector&lt;Report&gt; meltIceAndSnow(Coords c, int entityId) {
<span class="nc" id="L34508">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L34510">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L34511">        r = new Report(3069);</span>
<span class="nc" id="L34512">        r.indent(2);</span>
<span class="nc" id="L34513">        r.subject = entityId;</span>
<span class="nc" id="L34514">        vDesc.add(r);</span>
<span class="nc bnc" id="L34515" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L34516">            hex.removeTerrain(Terrains.SNOW);</span>
<span class="nc" id="L34517">            sendChangedHex(c);</span>
        }
<span class="nc bnc" id="L34519" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34520">            vDesc.addAll(resolveIceBroken(c));</span>
        }
        // if we were not in water, then add mud
<span class="nc bnc" id="L34523" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L34524" title="All 2 branches missed.">            &amp;&amp; !hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L34525">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.MUD, 1));
<span class="nc" id="L34527">            sendChangedHex(c);</span>
        }
<span class="nc" id="L34529">        return vDesc;</span>
    }

    /**
     * check to see if a swamp hex becomes quicksand
     */
    private Vector&lt;Report&gt; checkQuickSand(Coords c) {
<span class="nc" id="L34536">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L34538">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L34539" title="All 2 branches missed.">        if (hex.terrainLevel(Terrains.SWAMP) == 1) {</span>
<span class="nc bnc" id="L34540" title="All 2 branches missed.">            if (Compute.d6(2) == 12) {</span>
                // better find a rope
<span class="nc" id="L34542">                hex.removeTerrain(Terrains.SWAMP);</span>
<span class="nc" id="L34543">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.SWAMP, 2));</span>
<span class="nc" id="L34544">                sendChangedHex(c);</span>
<span class="nc" id="L34545">                r = new Report(2440);</span>
<span class="nc" id="L34546">                r.indent(1);</span>
<span class="nc" id="L34547">                vDesc.add(r);</span>
            }
        }
<span class="nc" id="L34550">        return vDesc;</span>
    }

    /**
     * check for vehicle fire, according to the MaxTech rules
     *
     * @param tank    the &lt;code&gt;Tank&lt;/code&gt; to be checked
     * @param inferno a &lt;code&gt;boolean&lt;/code&gt; parameter whether or not this check is
     *                because of inferno fire
     */
    public Vector&lt;Report&gt; checkForVehicleFire(Tank tank, boolean inferno) {
<span class="nc" id="L34561">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L34562">        int boomRoll = Compute.d6(2);</span>
<span class="nc" id="L34563">        int penalty = 0;</span>
<span class="nc bnc" id="L34564" title="All 3 branches missed.">        switch (tank.getMovementMode()) {</span>
            case HOVER:
<span class="nc" id="L34566">                penalty = 4;</span>
<span class="nc" id="L34567">                break;</span>
            case VTOL:
            case WHEELED:
<span class="nc" id="L34570">                penalty = 2;</span>
<span class="nc" id="L34571">                break;</span>
            default:
                break;
        }
<span class="nc bnc" id="L34575" title="All 2 branches missed.">        if (inferno) {</span>
<span class="nc" id="L34576">            boomRoll = 12;</span>
        }
<span class="nc" id="L34578">        Report r = new Report(5250);</span>
<span class="nc" id="L34579">        r.subject = tank.getId();</span>
<span class="nc" id="L34580">        r.addDesc(tank);</span>
<span class="nc" id="L34581">        r.add(8 - penalty);</span>
<span class="nc" id="L34582">        r.add(boomRoll);</span>
<span class="nc bnc" id="L34583" title="All 2 branches missed.">        if ((boomRoll + penalty) &lt; 8) {</span>
            // phew!
<span class="nc" id="L34585">            r.choose(true);</span>
<span class="nc" id="L34586">            vPhaseReport.add(r);</span>
        } else {
            // eek
<span class="nc bnc" id="L34589" title="All 2 branches missed.">            if (!inferno) {</span>
<span class="nc" id="L34590">                r.choose(false);</span>
<span class="nc" id="L34591">                vPhaseReport.add(r);</span>
            }
<span class="nc bnc" id="L34593" title="All 2 branches missed.">            if ((boomRoll + penalty) &lt; 10) {</span>
<span class="nc" id="L34594">                addReport(vehicleMotiveDamage(tank, penalty - 1));</span>
            } else {
<span class="nc" id="L34596">                vPhaseReport.addAll(resolveVehicleFire(tank, false));</span>
<span class="nc bnc" id="L34597" title="All 2 branches missed.">                if ((boomRoll + penalty) &gt;= 12) {</span>
<span class="nc" id="L34598">                    r = new Report(5255);</span>
<span class="nc" id="L34599">                    r.subject = tank.getId();</span>
<span class="nc" id="L34600">                    r.indent(3);</span>
<span class="nc" id="L34601">                    vPhaseReport.add(r);</span>
<span class="nc" id="L34602">                    tank.setOnFire(inferno);</span>
                }
            }
        }
<span class="nc" id="L34606">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; resolveVehicleFire(Tank tank, boolean existingStatus) {
<span class="nc" id="L34610">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L34611" title="All 4 branches missed.">        if (existingStatus &amp;&amp; !tank.isOnFire()) {</span>
<span class="nc" id="L34612">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L34614" title="All 2 branches missed.">        for (int i = 0; i &lt; tank.locations(); i++) {</span>
<span class="nc bnc" id="L34615" title="All 6 branches missed.">            if ((i == Tank.LOC_BODY) || ((tank instanceof VTOL) &amp;&amp; (i == VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L34616">                continue;</span>
            }
<span class="nc bnc" id="L34618" title="All 4 branches missed.">            if (existingStatus &amp;&amp; !tank.isLocationBurning(i)) {</span>
<span class="nc" id="L34619">                continue;</span>
            }
<span class="nc" id="L34621">            HitData hit = new HitData(i);</span>
<span class="nc" id="L34622">            int damage = Compute.d6(1);</span>
<span class="nc" id="L34623">            vPhaseReport.addAll(damageEntity(tank, hit, damage));</span>
<span class="nc bnc" id="L34624" title="All 4 branches missed.">            if ((damage == 1) &amp;&amp; existingStatus) {</span>
<span class="nc" id="L34625">                tank.extinguishLocation(i);</span>
            }
        }
<span class="nc" id="L34628">        return vPhaseReport;</span>
    }

    public Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier) {
<span class="nc" id="L34632">        return vehicleMotiveDamage(te, modifier, false, -1, false);</span>
    }

    private Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier, boolean noRoll,
                                               int damageType) {
<span class="nc" id="L34637">        return vehicleMotiveDamage(te, modifier, noRoll, damageType, false);</span>
    }

    /**
     * do vehicle movement damage
     *
     * @param te         the Tank to damage
     * @param modifier   the modifier to the roll
     * @param noRoll     don't roll, immediately deal damage
     * @param damageType the type to deal (1 = minor, 2 = moderate, 3 = heavy
     * @param jumpDamage is this a movement damage roll from using vehicular JJs
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing what to add to the turn log
     */
    private Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier, boolean noRoll,
                                               int damageType, boolean jumpDamage) {
<span class="nc" id="L34652">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L34654" title="All 6 branches missed.">        switch (te.getMovementMode()) {</span>
            case HOVER:
            case HYDROFOIL:
<span class="nc bnc" id="L34657" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34658">                    modifier -= 1;</span>
                } else {
<span class="nc" id="L34660">                    modifier += 3;</span>
                }
<span class="nc" id="L34662">                break;</span>
            case WHEELED:
<span class="nc bnc" id="L34664" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34665">                    modifier += 1;</span>
                } else {
<span class="nc" id="L34667">                    modifier += 2;</span>
                }
<span class="nc" id="L34669">                break;</span>
            case WIGE:
<span class="nc bnc" id="L34671" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34672">                    modifier -= 2;</span>
                } else {
<span class="nc" id="L34674">                    modifier += 4;</span>
                }
<span class="nc" id="L34676">                break;</span>
            case TRACKED:
<span class="nc bnc" id="L34678" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34679">                    modifier += 2;</span>
                }
                break;
            case VTOL:
                // VTOL don't roll, auto -1 MP as long as the rotor location
                // still exists (otherwise don't bother reporting).
<span class="nc bnc" id="L34685" title="All 4 branches missed.">                if (!(te.isLocationBad(VTOL.LOC_ROTOR) || te.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L34686">                    te.setMotiveDamage(te.getMotiveDamage() + 1);</span>
<span class="nc bnc" id="L34687" title="All 2 branches missed.">                    if (te.getOriginalWalkMP() &gt; te.getMotiveDamage()) {</span>
<span class="nc" id="L34688">                        r = new Report(6660);</span>
<span class="nc" id="L34689">                        r.indent(3);</span>
<span class="nc" id="L34690">                        r.subject = te.getId();</span>
<span class="nc" id="L34691">                        vDesc.add(r);</span>
                    } else {
<span class="nc" id="L34693">                        r = new Report(6670);</span>
<span class="nc" id="L34694">                        r.subject = te.getId();</span>
<span class="nc" id="L34695">                        vDesc.add(r);</span>
<span class="nc" id="L34696">                        te.immobilize();</span>
                        // Being reduced to 0 MP by rotor damage forces a
                        // landing
                        // like an engine hit...
<span class="nc bnc" id="L34700" title="All 2 branches missed.">                        if (te.isAirborneVTOLorWIGE()</span>
                            // ...but don't bother to resolve that if we're
                            // already otherwise destroyed.
<span class="nc bnc" id="L34703" title="All 4 branches missed.">                            &amp;&amp; !(te.isDestroyed() || te.isDoomed())) {</span>
<span class="nc" id="L34704">                            vDesc.addAll(forceLandVTOLorWiGE(te));</span>
                        }
                    }
                }
                // This completes our handling of VTOLs; the rest of the method
                // doesn't need to worry about them anymore.
<span class="nc" id="L34710">                return vDesc;</span>
            default:
                break;
        }
        // Apply vehicle effectiveness...except for jumps.
<span class="nc bnc" id="L34715" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)</span>
                &amp;&amp; !jumpDamage) {
<span class="nc" id="L34717">            modifier = Math.max(modifier - 1, 0);</span>
        }

<span class="nc bnc" id="L34720" title="All 2 branches missed.">        if (te.hasWorkingMisc(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L34721">            modifier -= 2;</span>
        }
<span class="nc" id="L34723">        int roll = Compute.d6(2) + modifier;</span>
<span class="nc" id="L34724">        r = new Report(6306);</span>
<span class="nc" id="L34725">        r.subject = te.getId();</span>
<span class="nc" id="L34726">        r.newlines = 0;</span>
<span class="nc" id="L34727">        r.indent(3);</span>
<span class="nc" id="L34728">        vDesc.add(r);</span>
<span class="nc bnc" id="L34729" title="All 2 branches missed.">        if (!noRoll) {</span>
<span class="nc" id="L34730">            r = new Report(6310);</span>
<span class="nc" id="L34731">            r.subject = te.getId();</span>
<span class="nc" id="L34732">            r.add(roll);</span>
<span class="nc" id="L34733">            r.newlines = 0;</span>
<span class="nc" id="L34734">            vDesc.add(r);</span>
<span class="nc" id="L34735">            r = new Report(3340);</span>
<span class="nc" id="L34736">            r.add(modifier);</span>
<span class="nc" id="L34737">            r.subject = te.getId();</span>
<span class="nc" id="L34738">            vDesc.add(r);</span>
        }

<span class="nc bnc" id="L34741" title="All 8 branches missed.">        if ((noRoll &amp;&amp; (damageType == 0)) || (!noRoll &amp;&amp; (roll &lt;= 5))) {</span>
            // no effect
<span class="nc" id="L34743">            r = new Report(6005);</span>
<span class="nc" id="L34744">            r.subject = te.getId();</span>
<span class="nc" id="L34745">            r.indent(3);</span>
<span class="nc" id="L34746">            vDesc.add(r);</span>
<span class="nc bnc" id="L34747" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 1)) || (!noRoll &amp;&amp; (roll &lt;= 7))) {</span>
            // minor damage
<span class="nc" id="L34749">            r = new Report(6470);</span>
<span class="nc" id="L34750">            r.subject = te.getId();</span>
<span class="nc" id="L34751">            r.indent(3);</span>
<span class="nc" id="L34752">            vDesc.add(r);</span>
<span class="nc" id="L34753">            te.addMovementDamage(1);</span>
<span class="nc bnc" id="L34754" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 2)) || (!noRoll &amp;&amp; (roll &lt;= 9))) {</span>
            // moderate damage
<span class="nc" id="L34756">            r = new Report(6471);</span>
<span class="nc" id="L34757">            r.subject = te.getId();</span>
<span class="nc" id="L34758">            r.indent(3);</span>
<span class="nc" id="L34759">            vDesc.add(r);</span>
<span class="nc" id="L34760">            te.addMovementDamage(2);</span>
<span class="nc bnc" id="L34761" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 3)) || (!noRoll &amp;&amp; (roll &lt;= 11))) {</span>
            // heavy damage
<span class="nc" id="L34763">            r = new Report(6472);</span>
<span class="nc" id="L34764">            r.subject = te.getId();</span>
<span class="nc" id="L34765">            r.indent(3);</span>
<span class="nc" id="L34766">            vDesc.add(r);</span>
<span class="nc" id="L34767">            te.addMovementDamage(3);</span>
        } else {
<span class="nc" id="L34769">            r = new Report(6473);</span>
<span class="nc" id="L34770">            r.subject = te.getId();</span>
<span class="nc" id="L34771">            r.indent(3);</span>
<span class="nc" id="L34772">            vDesc.add(r);</span>
<span class="nc" id="L34773">            te.addMovementDamage(4);</span>
        }
        // These checks should perhaps be moved to Tank.applyDamage(), but I'm
        // unsure how to *report* any outcomes from there. Note that these treat
        // being reduced to 0 MP and being actually immobilized as the same thing,
        // which for these particular purposes may or may not be the intent of
        // the rules in all cases.
        // Immobile hovercraft on water sink...
<span class="nc bnc" id="L34781" title="All 2 branches missed.">        if (((te.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34782" title="All 4 branches missed.">                || ((te.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (te.getElevation() == 0)))</span>
<span class="nc bnc" id="L34783" title="All 4 branches missed.">                &amp;&amp; (te.isMovementHitPending() || (te.getWalkMP() &lt;= 0))</span>
                // HACK: Have to check for *pending* hit here and below.
<span class="nc bnc" id="L34785" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(te.getPosition()).terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34786" title="All 2 branches missed.">                &amp;&amp; !game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34787">            vDesc.addAll(destroyEntity(te, &quot;a watery grave&quot;, false));</span>
        }
        // ...while immobile WiGEs crash.
<span class="nc bnc" id="L34790" title="All 4 branches missed.">        if (((te.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (te.isAirborneVTOLorWIGE()))</span>
<span class="nc bnc" id="L34791" title="All 4 branches missed.">                &amp;&amp; (te.isMovementHitPending() || (te.getWalkMP() &lt;= 0))) {</span>
            // report problem: add tab
<span class="nc" id="L34793">            vDesc.addAll(crashVTOLorWiGE(te));</span>
        }
<span class="nc" id="L34795">        return vDesc;</span>
    }

    /**
     * Add a whole lotta Reports to the players report queues as well as the
     * Master report queue vPhaseReport.
     */
    private void addReport(Vector&lt;Report&gt; reports) {
<span class="nc" id="L34803">        vPhaseReport.addAll(reports);</span>
<span class="nc" id="L34804">    }</span>

    /**
     * Add a whole lotta Reports to the players report queues as well as the
     * Master report queue vPhaseReport, indenting each report by the passed
     * value.
     */
    private void addReport(Vector&lt;Report&gt; reports, int indents) {
<span class="nc bnc" id="L34812" title="All 2 branches missed.">        for (Report r : reports) {</span>
<span class="nc" id="L34813">            r.indent(indents);</span>
<span class="nc" id="L34814">            vPhaseReport.add(r);</span>
<span class="nc" id="L34815">        }</span>
<span class="nc" id="L34816">    }</span>

    /**
     * Add a single report to the report queue of all players and the master
     * vPhaseReport queue
     */
    private void addReport(Report report) {
<span class="nc" id="L34823">        vPhaseReport.addElement(report);</span>
<span class="nc" id="L34824">    }</span>

    /**
     * New Round has started clear everyone's report queue
     */
    private void clearReports() {
<span class="nc" id="L34830">        vPhaseReport.removeAllElements();</span>
<span class="nc" id="L34831">    }</span>

    /**
     * make sure all the new lines that were added to the old vPhaseReport get
     * added to all of the players filters
     */
    private void addNewLines() {
<span class="nc" id="L34838">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L34839">    }</span>

    /**
     * resolve the landing of an assault drop
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; for which to resolve it
     */
    public void doAssaultDrop(Entity entity) {
        //resolve according to SO p.22

<span class="nc" id="L34849">        Report r = new Report(2380);</span>

        // whatever else happens, this entity is on the ground now
<span class="nc" id="L34852">        entity.setAltitude(0);</span>

        PilotingRollData psr;
        // LAMs that convert to fighter mode on the landing turn are processed as crashes
<span class="nc bnc" id="L34856" title="All 2 branches missed.">        if ((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L34857" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER)) {</span>
<span class="nc" id="L34858">            addReport(processCrash(entity, 0, entity.getPosition()));</span>
<span class="nc" id="L34859">            return;</span>
        }
<span class="nc bnc" id="L34861" title="All 4 branches missed.">        if ((entity instanceof Protomech) || (entity instanceof BattleArmor)) {</span>
<span class="nc" id="L34862">            psr = new PilotingRollData(entity.getId(), 5, &quot;landing assault drop&quot;);</span>
<span class="nc bnc" id="L34863" title="All 2 branches missed.">        } else if (entity instanceof Infantry) {</span>
<span class="nc" id="L34864">            psr = new PilotingRollData(entity.getId(), 4, &quot;landing assault drop&quot;);</span>
        } else {
<span class="nc" id="L34866">            psr = entity.getBasePilotingRoll();</span>
        }
<span class="nc" id="L34868">        int roll = Compute.d6(2);</span>
        // check for a safe landing
<span class="nc" id="L34870">        addNewLines();</span>
<span class="nc" id="L34871">        r.subject = entity.getId();</span>
<span class="nc" id="L34872">        r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L34873">        r.add(psr);</span>
<span class="nc" id="L34874">        r.add(roll);</span>
<span class="nc" id="L34875">        r.newlines = 1;</span>
<span class="nc bnc" id="L34876" title="All 2 branches missed.">        r.choose(roll &gt;= psr.getValue());</span>
<span class="nc" id="L34877">        addReport(r);</span>

        // if we are on an atmospheric map or the entity is off the map for some reason
<span class="nc bnc" id="L34880" title="All 4 branches missed.">        if (game.getBoard().inAtmosphere() || entity.getPosition() == null) {</span>
            // then just remove the entity
            // TODO : for this and when the unit scatters off the board, we should really still
            // TODO : apply damage before we remove, but this causes all kinds of problems for
            // TODO : doEntityFallsInto and related methods which expect a coord on the board
            // TODO : - need to make those more robust
<span class="nc" id="L34886">            r = new Report(2388);</span>
<span class="nc" id="L34887">            addReport(r);</span>
<span class="nc" id="L34888">            r.subject = entity.getId();</span>
<span class="nc" id="L34889">            r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L34890">            game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34891">            return;</span>
        }

<span class="nc bnc" id="L34894" title="All 2 branches missed.">        if (roll &lt; psr.getValue()) {</span>
<span class="nc" id="L34895">            int fallHeight = psr.getValue() - roll;</span>

            // if you fail by more than 7, you automatically fail
<span class="nc bnc" id="L34898" title="All 2 branches missed.">            if (fallHeight &gt; 7) {</span>
<span class="nc" id="L34899">                addReport(destroyEntity(entity, &quot;failed assault drop&quot;, false, false));</span>
<span class="nc" id="L34900">                entityUpdate(entity.getId());</span>
<span class="nc" id="L34901">                return;</span>
            }

            // determine where we really land
<span class="nc" id="L34905">            Coords c = Compute.scatterAssaultDrop(entity.getPosition(), fallHeight);</span>
<span class="nc" id="L34906">            int distance = entity.getPosition().distance(c);</span>
<span class="nc" id="L34907">            r = new Report(2385);</span>
<span class="nc" id="L34908">            r.subject = entity.getId();</span>
<span class="nc" id="L34909">            r.add(distance);</span>
<span class="nc" id="L34910">            r.indent();</span>
<span class="nc" id="L34911">            r.newlines = 0;</span>
<span class="nc" id="L34912">            addReport(r);</span>
<span class="nc bnc" id="L34913" title="All 2 branches missed.">            if (!game.getBoard().contains(c)) {</span>
<span class="nc" id="L34914">                r = new Report(2386);</span>
<span class="nc" id="L34915">                addReport(r);</span>
<span class="nc" id="L34916">                game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34917">                return;</span>
            } else {
<span class="nc" id="L34919">                r = new Report(2387);</span>
<span class="nc" id="L34920">                r.add(c.getBoardNum());</span>
<span class="nc" id="L34921">                addReport(r);</span>
            }
<span class="nc" id="L34923">            entity.setPosition(c);</span>

            // do fall damage from accidental fall
            //set elevation to fall height above ground or building roof
<span class="nc" id="L34927">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34928" title="All 2 branches missed.">            int bldgElev = hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L34929">                    ? hex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L34930">            entity.setElevation(fallHeight + bldgElev);</span>
<span class="nc bnc" id="L34931" title="All 2 branches missed.">            if (entity.isConventionalInfantry()) {</span>
<span class="nc" id="L34932">                HitData hit = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L34933">                addReport(damageEntity(entity, hit, 1));</span>
                // LAMs that convert to fighter mode on the landing turn are processed as crashes regardless of roll
<span class="nc" id="L34935">            } else {</span>
<span class="nc" id="L34936">                addReport(doEntityFallsInto(entity, c, psr, true));</span>
            }
<span class="nc" id="L34938">        } else {</span>
            // set entity to expected elevation
<span class="nc" id="L34940">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34941" title="All 2 branches missed.">            int bldgElev = hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L34942">                    ? hex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L34943">            entity.setElevation(bldgElev);</span>

<span class="nc" id="L34945">            Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L34946" title="All 2 branches missed.">            if (bldg != null) {</span>
                // whoops we step on the roof
<span class="nc" id="L34948">                checkBuildingCollapseWhileMoving(bldg, entity, entity.getPosition());</span>
            }

            // finally, check for any stacking violations
<span class="nc" id="L34952">            Entity violated = Compute.stackingViolation(game, entity, entity.getPosition(), null);</span>
<span class="nc bnc" id="L34953" title="All 2 branches missed.">            if (violated != null) {</span>
                // StratOps explicitly says that this is not treated as an accident
                // fall from above
                // so we just need to displace the violating unit
                // check to see if the violating unit is a DropShip and if so, then
                // displace the unit dropping instead
<span class="nc bnc" id="L34959" title="All 2 branches missed.">                if (violated instanceof Dropship) {</span>
<span class="nc" id="L34960">                    violated = entity;</span>
                }
<span class="nc" id="L34962">                Coords targetDest = Compute.getValidDisplacement(game, violated.getId(),</span>
<span class="nc" id="L34963">                        violated.getPosition(), Compute.d6() - 1);</span>
<span class="nc bnc" id="L34964" title="All 2 branches missed.">                if (null != targetDest) {</span>
<span class="nc" id="L34965">                    doEntityDisplacement(violated, violated.getPosition(), targetDest, null);</span>
<span class="nc" id="L34966">                    entityUpdate(violated.getId());</span>
                } else {
                    // ack! automatic death! Tanks
                    // suffer an ammo/power plant hit.
                    // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L34971">                    vPhaseReport.addAll(destroyEntity(entity, &quot;impossible displacement&quot;,</span>
                            entity instanceof Mech, entity instanceof Mech));
                }
            }
        }
<span class="nc" id="L34976">    }</span>

    /**
     * resolve assault drops for all entities
     */
    void doAllAssaultDrops() {
<span class="nc bnc" id="L34982" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L34983" title="All 4 branches missed.">            if (e.isAssaultDropInProgress() &amp;&amp; e.isDeployed()) {</span>
<span class="nc" id="L34984">                doAssaultDrop(e);</span>
<span class="nc" id="L34985">                e.setLandedAssaultDrop();</span>
            }
<span class="nc" id="L34987">        }</span>
<span class="nc" id="L34988">    }</span>

    /**
     * do damage from magma
     *
     * @param en       the affected &lt;code&gt;Entity&lt;/code&gt;
     * @param eruption &lt;code&gt;boolean&lt;/code&gt; indicating whether or not this is because
     *                 of an eruption
     */
    void doMagmaDamage(Entity en, boolean eruption) {
<span class="nc bnc" id="L34998" title="All 4 branches missed.">        if ((((en.getMovementMode() == EntityMovementMode.VTOL) &amp;&amp; (en.getElevation() &gt; 0))</span>
<span class="nc bnc" id="L34999" title="All 2 branches missed.">                || (en.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L35000" title="All 2 branches missed.">                || ((en.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L35001" title="All 6 branches missed.">                &amp;&amp; (en.getOriginalWalkMP() &gt; 0) &amp;&amp; !eruption)) &amp;&amp; !en.isImmobile()) {</span>
<span class="nc" id="L35002">            return;</span>
        }
        Report r;
<span class="nc" id="L35005">        boolean isMech = en instanceof Mech;</span>
<span class="nc bnc" id="L35006" title="All 2 branches missed.">        if (isMech) {</span>
<span class="nc" id="L35007">            r = new Report(2405);</span>
        } else {
<span class="nc" id="L35009">            r = new Report(2400);</span>
        }
<span class="nc" id="L35011">        r.addDesc(en);</span>
<span class="nc" id="L35012">        r.subject = en.getId();</span>
<span class="nc" id="L35013">        addReport(r);</span>
<span class="nc bnc" id="L35014" title="All 2 branches missed.">        if (isMech) {</span>
            HitData h;
<span class="nc bnc" id="L35016" title="All 2 branches missed.">            for (int i = 0; i &lt; en.locations(); i++) {</span>
<span class="nc bnc" id="L35017" title="All 6 branches missed.">                if (eruption || en.locationIsLeg(i) || en.isProne()) {</span>
<span class="nc" id="L35018">                    h = new HitData(i);</span>
<span class="nc" id="L35019">                    addReport(damageEntity(en, h, Compute.d6(2)));</span>
                }
            }
        } else {
<span class="nc" id="L35023">            addReport(destroyEntity(en, &quot;fell into magma&quot;, false, false));</span>
        }
<span class="nc" id="L35025">        addNewLines();</span>
<span class="nc" id="L35026">    }</span>

    /**
     * sink any entities in quicksand in the current hex
     */
    public void doSinkEntity(Entity en) {
        Report r;
<span class="nc" id="L35033">        r = new Report(2445);</span>
<span class="nc" id="L35034">        r.addDesc(en);</span>
<span class="nc" id="L35035">        r.subject = en.getId();</span>
<span class="nc" id="L35036">        addReport(r);</span>
<span class="nc" id="L35037">        en.setElevation(en.getElevation() - 1);</span>
        // if this means the entity is below the ground, then bye-bye!
<span class="nc bnc" id="L35039" title="All 2 branches missed.">        if (Math.abs(en.getElevation()) &gt; en.getHeight()) {</span>
<span class="nc" id="L35040">            addReport(destroyEntity(en, &quot;quicksand&quot;));</span>
        }
<span class="nc" id="L35042">    }</span>

    /**
     * deal area saturation damage to an individual hex
     *
     * @param coords         The hex being hit
     * @param attackSource   The location the attack came from. For hit table resolution
     * @param damage         Amount of damage to deal to each entity
     * @param ammo           The ammo type being used
     * @param subjectId      Subject for reports
     * @param killer         Who should be credited with kills
     * @param exclude        Entity that should take no damage (used for homing splash)
     * @param flak           Flak, hits flying units only, instead of flyers being immune
     * @param altitude       Absolute altitude for flak attack
     * @param vPhaseReport   The Vector of Reports for the phase report
     * @param asfFlak        Is this flak against ASF?
     * @param alreadyHit     a vector of unit ids for units that have already been hit that
     *                       will be ignored
     * @param variableDamage if true, treat damage as the number of six-sided dice to roll
     */
    public Vector&lt;Integer&gt; artilleryDamageHex(Coords coords,
            Coords attackSource, int damage, AmmoType ammo, int subjectId,
            Entity killer, Entity exclude, boolean flak, int altitude,
            Vector&lt;Report&gt; vPhaseReport, boolean asfFlak,
            Vector&lt;Integer&gt; alreadyHit, boolean variableDamage) {

<span class="nc" id="L35068">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35069" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L35070">            return alreadyHit; // not on board.</span>
        }

        Report r;

        // Non-flak artillery damages terrain
<span class="nc bnc" id="L35076" title="All 2 branches missed.">        if (!flak) {</span>
            // Report that damage applied to terrain, if there's TF to damage
<span class="nc" id="L35078">            IHex h = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35079" title="All 4 branches missed.">            if ((h != null) &amp;&amp; h.hasTerrainfactor()) {</span>
<span class="nc" id="L35080">                r = new Report(3384);</span>
<span class="nc" id="L35081">                r.indent(2);</span>
<span class="nc" id="L35082">                r.subject = subjectId;</span>
<span class="nc" id="L35083">                r.add(coords.getBoardNum());</span>
<span class="nc" id="L35084">                r.add(damage * 2);</span>
<span class="nc" id="L35085">                vPhaseReport.addElement(r);</span>
            }
            // Update hex and report any changes
<span class="nc" id="L35088">            Vector&lt;Report&gt; newReports = tryClearHex(coords, damage * 2, subjectId);</span>
<span class="nc bnc" id="L35089" title="All 2 branches missed.">            for (Report nr : newReports) {</span>
<span class="nc" id="L35090">                nr.indent(3);</span>
<span class="nc" id="L35091">            }</span>
<span class="nc" id="L35092">            vPhaseReport.addAll(newReports);</span>
        }
        
<span class="nc bnc" id="L35095" title="All 2 branches missed.">        boolean isFuelAirBomb = </span>
                ammo != null &amp;&amp;
<span class="nc bnc" id="L35097" title="All 2 branches missed.">                (BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_SMALL ||</span>
<span class="nc bnc" id="L35098" title="All 2 branches missed.">                BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_LARGE);</span>
        
<span class="nc" id="L35100">        Building bldg = game.getBoard().getBuildingAt(coords);</span>
<span class="nc" id="L35101">        int bldgAbsorbs = 0;</span>
<span class="nc bnc" id="L35102" title="All 4 branches missed.">        if ((bldg != null)</span>
<span class="nc bnc" id="L35103" title="All 2 branches missed.">                &amp;&amp; !(flak &amp;&amp; (((altitude &gt; hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L35104" title="All 2 branches missed.">                || (altitude &gt; hex.terrainLevel(Terrains.BRIDGE_ELEV)))))) {</span>
<span class="nc" id="L35105">            bldgAbsorbs = bldg.getAbsorbtion(coords);</span>
<span class="nc bnc" id="L35106" title="All 4 branches missed.">            if (!((ammo != null) &amp;&amp; (ammo.getMunitionType() == AmmoType.M_FLECHETTE))) {</span>
<span class="nc" id="L35107">                int actualDamage = damage;</span>
                
<span class="nc bnc" id="L35109" title="All 2 branches missed.">                if(isFuelAirBomb) {</span>
                    // light buildings take 1.5x damage from fuel-air bombs
<span class="nc bnc" id="L35111" title="All 2 branches missed.">                    if(bldg.getType() == Building.LIGHT) {</span>
<span class="nc" id="L35112">                        actualDamage = (int) Math.ceil(actualDamage * 1.5);</span>
                        
<span class="nc" id="L35114">                        r = new Report(9991);</span>
<span class="nc" id="L35115">                        r.indent(1);</span>
<span class="nc" id="L35116">                        r.subject = killer.getId();</span>
<span class="nc" id="L35117">                        r.newlines = 1;</span>
<span class="nc" id="L35118">                        vPhaseReport.addElement(r);</span>
                    } 

                    // armored and &quot;castle brian&quot; buildings take .5 damage from fuel-air bombs
                    // but I have no idea how to determine if a building is a castle or a brian
                    // note that being armored and being &quot;light&quot; are not mutually exclusive
<span class="nc bnc" id="L35124" title="All 2 branches missed.">                    if(bldg.getArmor(coords) &gt; 0) {</span>
<span class="nc" id="L35125">                        actualDamage = (int) Math.floor(actualDamage * .5);</span>
                        
<span class="nc" id="L35127">                        r = new Report(9992);</span>
<span class="nc" id="L35128">                        r.indent(1);</span>
<span class="nc" id="L35129">                        r.subject = killer.getId();</span>
<span class="nc" id="L35130">                        r.newlines = 1;</span>
<span class="nc" id="L35131">                        vPhaseReport.addElement(r);</span>
                    }
                }             
                
                
                // damage the building
<span class="nc" id="L35137">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, actualDamage, coords);</span>
<span class="nc bnc" id="L35138" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L35139">                    report.subject = subjectId;</span>
<span class="nc" id="L35140">                }</span>
<span class="nc" id="L35141">                vPhaseReport.addAll(buildingReport);</span>
            }
        }

<span class="nc bnc" id="L35145" title="All 4 branches missed.">        if (flak &amp;&amp; ((altitude &lt;= 0)</span>
<span class="nc bnc" id="L35146" title="All 2 branches missed.">                || (altitude &lt;= hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L35147" title="All 2 branches missed.">                || (altitude == hex.terrainLevel(Terrains.BRIDGE_ELEV)))) {</span>
            // Flak in this hex would only hit landed units
<span class="nc" id="L35149">            return alreadyHit;</span>
        }

        // get units in hex
<span class="nc bnc" id="L35153" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {  </span>
            // Check: is entity excluded?
<span class="nc bnc" id="L35155" title="All 4 branches missed.">            if ((entity == exclude) || alreadyHit.contains(entity.getId())) {</span>
<span class="nc" id="L35156">                continue;</span>
            } else {
<span class="nc" id="L35158">                alreadyHit.add(entity.getId());</span>
            }
            
<span class="nc" id="L35161">            AreaEffectHelper.artilleryDamageEntity(entity, damage, bldg, bldgAbsorbs, </span>
                    variableDamage, asfFlak, flak, altitude,
                    attackSource, ammo, coords, isFuelAirBomb,
                    killer, hex, subjectId, vPhaseReport, this);
<span class="nc" id="L35165">        }</span>

<span class="nc" id="L35167">        return alreadyHit;</span>
    }

    /**
     * deal area saturation damage to the map, used for artillery
     *
     * @param centre       The hex on which damage is centred
     * @param attackSource The position the attack came from
     * @param ammo         The ammo type doing the damage
     * @param subjectId    Subject for reports
     * @param killer       Who should be credited with kills
     * @param flak         Flak, hits flying units only, instead of flyers being immune
     * @param altitude     Absolute altitude for flak attack
     * @param mineClear    Does this clear mines?
     * @param vPhaseReport The Vector of Reports for the phase report
     * @param asfFlak      Is this flak against ASF?
     * @param attackingBA  How many BA suits are in the squad if this is a BA Tube arty
     *                     attack, -1 otherwise
     */
    public void artilleryDamageArea(Coords centre, Coords attackSource,
            AmmoType ammo, int subjectId, Entity killer, boolean flak,
            int altitude, boolean mineClear, Vector&lt;Report&gt; vPhaseReport,
            boolean asfFlak, int attackingBA) {
<span class="nc" id="L35190">        DamageFalloff damageFalloff = AreaEffectHelper.calculateDamageFallOff(ammo, attackingBA, mineClear);</span>
        
<span class="nc" id="L35192">        int damage = damageFalloff.damage;</span>
<span class="nc" id="L35193">        int falloff = damageFalloff.falloff;</span>
<span class="nc bnc" id="L35194" title="All 2 branches missed.">        if(damageFalloff.clusterMunitionsFlag) {</span>
<span class="nc" id="L35195">            attackSource = centre;</span>
        }
        
<span class="nc" id="L35198">        artilleryDamageArea(centre, attackSource, ammo, subjectId, killer,</span>
                damage, falloff, flak, altitude, vPhaseReport, asfFlak);
<span class="nc" id="L35200">    }</span>

    /**
     * Deals area-saturation damage to an area of the board. Used for artillery,
     * bombs, or anything else with linear decrease in damage
     *
     * @param centre
     *            The hex on which damage is centred
     * @param attackSource
     *            The position the attack came from
     * @param ammo
     *            The ammo type doing the damage
     * @param subjectId
     *            Subject for reports
     * @param killer
     *            Who should be credited with kills
     * @param damage
     *            Damage at ground zero
     * @param falloff
     *            Reduction in damage for each hex of distance
     * @param flak
     *            Flak, hits flying units only, instead of flyers being immune
     * @param altitude
     *            Absolute altitude for flak attack
     * @param vPhaseReport
     *            The Vector of Reports for the phase report
     * @param asfFlak
     *            Is this flak against ASF?
     */
    public void artilleryDamageArea(Coords centre, Coords attackSource, AmmoType ammo, int subjectId,
                                    Entity killer, int damage, int falloff, boolean flak, int altitude,
                                    Vector&lt;Report&gt; vPhaseReport, boolean asfFlak) {
<span class="nc" id="L35232">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L35233" title="All 2 branches missed.">        for (int ring = 0; damage &gt; 0; ring++, damage -= falloff) {</span>
<span class="nc" id="L35234">            List&lt;Coords&gt; hexes = centre.allAtDistance(ring);</span>
<span class="nc bnc" id="L35235" title="All 2 branches missed.">            for (Coords c : hexes) {</span>
<span class="nc" id="L35236">                alreadyHit = artilleryDamageHex(c, attackSource, damage, ammo,</span>
                        subjectId, killer, null, flak, altitude, vPhaseReport,
                        asfFlak, alreadyHit, false);
<span class="nc" id="L35239">            }</span>
<span class="nc" id="L35240">            attackSource = centre; // all splash comes from ground zero</span>
        }
<span class="nc" id="L35242">    }</span>

    public void deliverBombDamage(Coords centre, int type, int subjectId, Entity killer,
                                  Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L35246">        int range = 0;</span>
<span class="nc" id="L35247">        int damage = 10;</span>
<span class="nc bnc" id="L35248" title="All 2 branches missed.">        if (type == BombType.B_CLUSTER) {</span>
<span class="nc" id="L35249">            range = 1;</span>
<span class="nc" id="L35250">            damage = 5;</span>
        }
<span class="nc" id="L35252">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>

<span class="nc" id="L35254">        alreadyHit = artilleryDamageHex(centre, centre, damage, null,</span>
                subjectId, killer, null, false, 0, vPhaseReport, false,
                alreadyHit, false);
<span class="nc bnc" id="L35257" title="All 2 branches missed.">        if (range &gt; 0) {</span>
<span class="nc" id="L35258">            List&lt;Coords&gt; hexes = centre.allAtDistance(range);</span>
<span class="nc bnc" id="L35259" title="All 2 branches missed.">            for (Coords c : hexes) {</span>
<span class="nc" id="L35260">                alreadyHit = artilleryDamageHex(c, centre, damage, null,</span>
                        subjectId, killer, null, false, 0, vPhaseReport, false,
                        alreadyHit, false);
<span class="nc" id="L35263">            }</span>
        }
<span class="nc" id="L35265">    }</span>

    /**
     * deliver inferno bomb
     *
     * @param coords    the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     * @param ae        the attacking &lt;code&gt;entity&lt;code&gt;
     * @param subjectId the &lt;code&gt;int&lt;/code&gt; id of the target
     */
    public void deliverBombInferno(Coords coords, Entity ae, int subjectId,
                                   Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L35276">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
        // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L35279" title="All 2 branches missed.">        if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_BOMB) {</span>
<span class="nc" id="L35280">            ignite(coords, Terrains.FIRE_LVL_INFERNO_BOMB, vPhaseReport);</span>
        }
        // possibly melt ice and snow
<span class="nc bnc" id="L35283" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L35284">            vPhaseReport.addAll(meltIceAndSnow(coords, subjectId));</span>
        }
<span class="nc bnc" id="L35286" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {</span>
<span class="nc bnc" id="L35287" title="All 4 branches missed.">            if (entity.isAirborne() || entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L35288">                continue;</span>
            }
            // TacOps, p. 359 - treat as if hit by 5 inferno missiles
<span class="nc" id="L35291">            r = new Report(6696);</span>
<span class="nc" id="L35292">            r.indent(3);</span>
<span class="nc" id="L35293">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L35294">            r.subject = entity.getId();</span>
<span class="nc" id="L35295">            r.newlines = 0;</span>
<span class="nc" id="L35296">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L35297" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L35298">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L35300">            Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae, entity, 5);</span>
<span class="nc" id="L35301">            Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L35302">            vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L35303">        }</span>
<span class="nc" id="L35304">    }</span>

    /**
     * Resolve any Infantry units which are fortifying hexes
     */
    void resolveFortify() {
        Report r;
<span class="nc bnc" id="L35311" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L35312" title="All 2 branches missed.">            if (ent instanceof Infantry) {</span>
<span class="nc" id="L35313">                Infantry inf = (Infantry) ent;</span>
<span class="nc" id="L35314">                int dig = inf.getDugIn();</span>
<span class="nc bnc" id="L35315" title="All 2 branches missed.">                if (dig == Infantry.DUG_IN_WORKING) {</span>
<span class="nc" id="L35316">                    r = new Report(5300);</span>
<span class="nc" id="L35317">                    r.addDesc(inf);</span>
<span class="nc" id="L35318">                    r.subject = inf.getId();</span>
<span class="nc" id="L35319">                    addReport(r);</span>
<span class="nc bnc" id="L35320" title="All 2 branches missed.">                } else if (dig == Infantry.DUG_IN_FORTIFYING2) {</span>
<span class="nc" id="L35321">                    Coords c = inf.getPosition();</span>
<span class="nc" id="L35322">                    r = new Report(5305);</span>
<span class="nc" id="L35323">                    r.addDesc(inf);</span>
<span class="nc" id="L35324">                    r.add(c.getBoardNum());</span>
<span class="nc" id="L35325">                    r.subject = inf.getId();</span>
<span class="nc" id="L35326">                    addReport(r);</span>
                    // fortification complete - add to map
<span class="nc" id="L35328">                    IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L35329">                    hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FORTIFIED, 1));
<span class="nc" id="L35331">                    sendChangedHex(c);</span>
                    // Clear the dig in for any units in same hex, since they
                    // get it for free by fort
<span class="nc bnc" id="L35334" title="All 2 branches missed.">                    for (Entity ent2 : game.getEntitiesVector(c)) {</span>
<span class="nc bnc" id="L35335" title="All 2 branches missed.">                        if (ent2 instanceof Infantry) {</span>
<span class="nc" id="L35336">                            Infantry inf2 = (Infantry) ent;</span>
<span class="nc" id="L35337">                            inf2.setDugIn(Infantry.DUG_IN_NONE);</span>
                        }
<span class="nc" id="L35339">                    }</span>
                }
            }
<span class="nc" id="L35342">        }</span>
<span class="nc" id="L35343">    }</span>

    /**
     * Check if spikes get broken in the given location
     *
     * @param e   The {@link Entity} to check
     * @param loc The location index
     * @return    A report showing the results of the roll
     */
    private Report checkBreakSpikes(Entity e, int loc) {
<span class="nc" id="L35353">        int roll = Compute.d6(2);</span>
        Report r;
<span class="nc bnc" id="L35355" title="All 2 branches missed.">        if (roll &lt; 9) {</span>
<span class="nc" id="L35356">            r = new Report(4445);</span>
<span class="nc" id="L35357">            r.indent(2);</span>
<span class="nc" id="L35358">            r.add(roll);</span>
<span class="nc" id="L35359">            r.subject = e.getId();</span>
        } else {
<span class="nc" id="L35361">            r = new Report(4440);</span>
<span class="nc" id="L35362">            r.indent(2);</span>
<span class="nc" id="L35363">            r.add(roll);</span>
<span class="nc" id="L35364">            r.subject = e.getId();</span>
<span class="nc bnc" id="L35365" title="All 2 branches missed.">            for (Mounted m : e.getMisc()) {</span>
<span class="nc bnc" id="L35366" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_SPIKES)</span>
<span class="nc bnc" id="L35367" title="All 2 branches missed.">                        &amp;&amp; (m.getLocation() == loc)) {</span>
<span class="nc" id="L35368">                    m.setHit(true);</span>
                }
<span class="nc" id="L35370">            }</span>
        }
<span class="nc" id="L35372">        return r;</span>
    }

    /**
     * @return a &lt;code&gt;String&lt;/code&gt; representing the hostname
     */
    public String getHost() {
        try {
<span class="nc" id="L35380">            return InetAddress.getLocalHost().getHostName();</span>
<span class="nc" id="L35381">        } catch (UnknownHostException e) {</span>
<span class="nc" id="L35382">            e.printStackTrace();</span>
<span class="nc" id="L35383">            return &quot;&quot;;</span>
        }
    }

    /**
     * @return the &lt;code&gt;int&lt;/code&gt; this server is listening on
     */
    public int getPort() {
<span class="nc" id="L35391">        return serverSocket.getLocalPort();</span>
    }

    /**
     * Loops through all the attacks the game has. Checks if they care about
     * current phase, if so, runs them, and removes them if they don't want to
     * stay. TODO : Refactor the new entity announcement out of here.
     */
    private void handleAttacks() {
<span class="nc" id="L35400">        handleAttacks(false);</span>
<span class="nc" id="L35401">    }</span>

    private void handleAttacks(boolean pointblankShot) {
        Report r;
<span class="nc" id="L35405">        int lastAttackerId = -1;</span>
        Vector&lt;AttackHandler&gt; currentAttacks, keptAttacks;
<span class="nc" id="L35407">        currentAttacks = game.getAttacksVector();</span>
<span class="nc" id="L35408">        keptAttacks = new Vector&lt;&gt;();</span>
<span class="nc" id="L35409">        Vector&lt;Report&gt; handleAttackReports = new Vector&lt;&gt;();</span>
        // first, do any TAGs, so homing arty will have TAG
<span class="nc bnc" id="L35411" title="All 2 branches missed.">        for (AttackHandler ah : currentAttacks) {</span>
<span class="nc bnc" id="L35412" title="All 2 branches missed.">            if (!(ah instanceof TAGHandler)) {</span>
<span class="nc" id="L35413">                continue;</span>
            }
<span class="nc bnc" id="L35415" title="All 2 branches missed.">            if (ah.cares(game.getPhase())) {</span>
<span class="nc" id="L35416">                int aId = ah.getAttackerId();</span>
<span class="nc bnc" id="L35417" title="All 4 branches missed.">                if ((aId != lastAttackerId) &amp;&amp; !ah.announcedEntityFiring()) {</span>
                    // report who is firing
<span class="nc bnc" id="L35419" title="All 2 branches missed.">                    if (pointblankShot) {</span>
<span class="nc" id="L35420">                        r = new Report(3102);</span>
                    } else {
<span class="nc" id="L35422">                        r = new Report(3100);</span>
                    }
<span class="nc" id="L35424">                    r.subject = aId;</span>
<span class="nc" id="L35425">                    Entity ae = game.getEntity(aId);</span>
<span class="nc" id="L35426">                    r.addDesc(ae);</span>
<span class="nc" id="L35427">                    handleAttackReports.addElement(r);</span>
<span class="nc" id="L35428">                    ah.setAnnouncedEntityFiring(true);</span>
<span class="nc" id="L35429">                    lastAttackerId = aId;</span>
                }
<span class="nc" id="L35431">                boolean keep = ah.handle(game.getPhase(), handleAttackReports);</span>
<span class="nc bnc" id="L35432" title="All 2 branches missed.">                if (keep) {</span>
<span class="nc" id="L35433">                    keptAttacks.add(ah);</span>
                }
<span class="nc" id="L35435">                Report.addNewline(handleAttackReports);</span>
            }
<span class="nc" id="L35437">        }</span>
        // now resolve everything but TAG
<span class="nc bnc" id="L35439" title="All 2 branches missed.">        for (AttackHandler ah : currentAttacks) {</span>
<span class="nc bnc" id="L35440" title="All 2 branches missed.">            if (ah instanceof TAGHandler) {</span>
<span class="nc" id="L35441">                continue;</span>
            }
<span class="nc bnc" id="L35443" title="All 2 branches missed.">            if (ah.cares(game.getPhase())) {</span>
<span class="nc" id="L35444">                int aId = ah.getAttackerId();</span>
<span class="nc bnc" id="L35445" title="All 4 branches missed.">                if ((aId != lastAttackerId) &amp;&amp; !ah.announcedEntityFiring()) {</span>
                    // if this is a new attacker then resolve any
                    // standard-to-cap damage
                    // from previous
<span class="nc" id="L35449">                    handleAttackReports.addAll(checkFatalThresholds(aId,</span>
                            lastAttackerId));
                    // report who is firing
<span class="nc bnc" id="L35452" title="All 2 branches missed.">                    if (pointblankShot) {</span>
<span class="nc" id="L35453">                        r = new Report(3102);</span>
<span class="nc bnc" id="L35454" title="All 2 branches missed.">                    } else if (ah.isStrafing()) {</span>
<span class="nc" id="L35455">                        r = new Report(3101);</span>
                    } else {
<span class="nc" id="L35457">                        r = new Report(3100);</span>
                    }
<span class="nc" id="L35459">                    r.subject = aId;</span>
<span class="nc" id="L35460">                    Entity ae = game.getEntity(aId);</span>
                    // for arty, attacker may be dead, or fled, so check out-of-
                    // game entities
<span class="nc bnc" id="L35463" title="All 2 branches missed.">                    if (ae == null) {</span>
<span class="nc" id="L35464">                        ae = game.getOutOfGameEntity(aId);</span>
                    }
<span class="nc" id="L35466">                    r.addDesc(ae);</span>
<span class="nc" id="L35467">                    handleAttackReports.addElement(r);</span>
<span class="nc" id="L35468">                    ah.setAnnouncedEntityFiring(true);</span>
<span class="nc" id="L35469">                    lastAttackerId = aId;</span>
                }
<span class="nc" id="L35471">                boolean keep = ah.handle(game.getPhase(), handleAttackReports);</span>
<span class="nc bnc" id="L35472" title="All 2 branches missed.">                if (keep) {</span>
<span class="nc" id="L35473">                    keptAttacks.add(ah);</span>
                }
<span class="nc" id="L35475">                Report.addNewline(handleAttackReports);</span>
<span class="nc" id="L35476">            } else {</span>
<span class="nc" id="L35477">                keptAttacks.add(ah);</span>
            }
<span class="nc" id="L35479">        }</span>
        // resolve standard to capital one more time
<span class="nc" id="L35481">        handleAttackReports.addAll(checkFatalThresholds(lastAttackerId,</span>
                lastAttackerId));
<span class="nc bnc" id="L35483" title="All 2 branches missed.">        if (handleAttackReports.size() &gt; 0) {</span>
<span class="nc" id="L35484">            Report.addNewline(handleAttackReports);</span>
        }
<span class="nc" id="L35486">        addReport(handleAttackReports);</span>
        // HACK, but anything else seems to run into weird problems.
<span class="nc" id="L35488">        game.setAttacksVector(keptAttacks);</span>
<span class="nc" id="L35489">    }</span>

    /**
     * @return the current server instance
     */
    public static Server getServerInstance() {
<span class="fc" id="L35495">        return serverInstance;</span>
    }

    /**
     * create a &lt;code&gt;SmokeCloud&lt;/code&gt; object and add it to the server list
     *
     * @param coords   the location to create the smoke
     * @param level    1=Light 2=Heavy Smoke 3:light LI smoke 4: Heavy LI smoke
     * @param duration How long the smoke will last.
     */
    public void createSmoke(Coords coords, int level, int duration) {
<span class="nc" id="L35506">        SmokeCloud cloud = new SmokeCloud(coords, level, duration);</span>
<span class="nc" id="L35507">        game.addSmokeCloud(cloud);</span>
<span class="nc" id="L35508">        sendSmokeCloudAdded(cloud);</span>
<span class="nc" id="L35509">    }</span>

    /**
     * create a &lt;code&gt;SmokeCloud&lt;/code&gt; object and add it to the server list
     *
     * @param coords   the location to create the smoke
     * @param level    1=Light 2=Heavy Smoke 3:light LI smoke 4: Heavy LI smoke
     * @param duration duration How long the smoke will last.
     */
    public void createSmoke(ArrayList&lt;Coords&gt; coords, int level, int duration) {
<span class="nc" id="L35519">        SmokeCloud cloud = new SmokeCloud(coords, level, duration);</span>
<span class="nc" id="L35520">        game.addSmokeCloud(cloud);</span>
<span class="nc" id="L35521">        sendSmokeCloudAdded(cloud);</span>
<span class="nc" id="L35522">    }</span>

    /**
     * Update the map with a new set of coords.
     *
     * @param newCoords the location to move the smoke to
     */
    public void updateSmoke(SmokeCloud cloud, ArrayList&lt;Coords&gt; newCoords) {
<span class="nc" id="L35530">        removeSmokeTerrain(cloud);</span>
<span class="nc" id="L35531">        cloud.getCoordsList().clear();</span>
<span class="nc" id="L35532">        cloud.getCoordsList().addAll(newCoords);</span>
<span class="nc" id="L35533">    }</span>

    /**
     * remove a cloud from the map
     *
     * @param cloud the location to remove the smoke from
     */
    public void removeSmokeTerrain(SmokeCloud cloud) {
<span class="nc bnc" id="L35541" title="All 2 branches missed.">        for (Coords coords : cloud.getCoordsList()) {</span>
<span class="nc" id="L35542">            IHex nextHex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35543" title="All 4 branches missed.">            if ((nextHex != null) &amp;&amp; nextHex.containsTerrain(Terrains.SMOKE)) {</span>
<span class="nc" id="L35544">                nextHex.removeTerrain(Terrains.SMOKE);</span>
<span class="nc" id="L35545">                sendChangedHex(coords);</span>
            }
<span class="nc" id="L35547">        }</span>
<span class="nc" id="L35548">    }</span>

    public List&lt;SmokeCloud&gt; getSmokeCloudList() {
<span class="nc" id="L35551">        return game.getSmokeCloudList();</span>
    }

    /**
     * Check to see if blowing sand caused damage to airborne VTOL/WIGEs
     */
    private Vector&lt;Report&gt; resolveBlowingSandDamage() {
<span class="nc" id="L35558">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L35559">        vFullReport.add(new Report(5002, Report.PUBLIC));</span>
<span class="nc" id="L35560">        int damage_bonus = Math.max(0, game.getPlanetaryConditions().getWindStrength()</span>
                - PlanetaryConditions.WI_MOD_GALE);
        // cycle through each team and damage 1d6 airborne VTOL/WiGE
<span class="nc bnc" id="L35563" title="All 2 branches missed.">        for (Enumeration&lt;Team&gt; loop = game.getTeams(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L35564">            Team team = loop.nextElement();</span>
<span class="nc" id="L35565">            Vector&lt;Integer&gt; airborne = team.getAirborneVTOL();</span>
<span class="nc bnc" id="L35566" title="All 2 branches missed.">            if (airborne.size() &gt; 0) {</span>
                // how many units are affected
<span class="nc" id="L35568">                int unitsAffected = Math.min(Compute.d6(), airborne.size());</span>
<span class="nc bnc" id="L35569" title="All 4 branches missed.">                while ((unitsAffected &gt; 0) &amp;&amp; (airborne.size() &gt; 0)) {</span>
<span class="nc" id="L35570">                    int loc = Compute.randomInt(airborne.size());</span>
<span class="nc" id="L35571">                    Entity en = game.getEntity(airborne.get(loc));</span>
<span class="nc" id="L35572">                    int damage = Math.max(1, Compute.d6() / 2) + damage_bonus;</span>
<span class="nc bnc" id="L35573" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L35574">                        HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_RANDOM);</span>
<span class="nc" id="L35575">                        vFullReport.addAll(damageEntity(en, hit, 1));</span>
<span class="nc" id="L35576">                        damage--;</span>
<span class="nc" id="L35577">                    }</span>
<span class="nc" id="L35578">                    unitsAffected--;</span>
<span class="nc" id="L35579">                    airborne.remove(loc);</span>
<span class="nc" id="L35580">                }</span>
            }
<span class="nc" id="L35582">        }</span>
<span class="nc" id="L35583">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L35584">        return vFullReport;</span>
    }

    /**
     * let an entity lay a mine
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that should lay a mine
     * @param mineId an &lt;code&gt;int&lt;/code&gt; pointing to the mine
     */
    private void layMine(Entity entity, int mineId, Coords coords) {
<span class="nc" id="L35594">        Mounted mine = entity.getEquipment(mineId);</span>
        Report r;
<span class="nc bnc" id="L35596" title="All 2 branches missed.">        if (!mine.isMissing()) {</span>
<span class="nc" id="L35597">            int reportId = 0;</span>
<span class="nc bnc" id="L35598" title="All 5 branches missed.">            switch (mine.getMineType()) {</span>
                case Mounted.MINE_CONVENTIONAL:
<span class="nc" id="L35600">                    deliverThunderMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35601">                            entity.getId());</span>
<span class="nc" id="L35602">                    reportId = 3500;</span>
<span class="nc" id="L35603">                    break;</span>
                case Mounted.MINE_VIBRABOMB:
<span class="nc" id="L35605">                    deliverThunderVibraMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35606">                            mine.getVibraSetting(), entity.getId());</span>
<span class="nc" id="L35607">                    reportId = 3505;</span>
<span class="nc" id="L35608">                    break;</span>
                case Mounted.MINE_ACTIVE:
<span class="nc" id="L35610">                    deliverThunderActiveMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35611">                            entity.getId());</span>
<span class="nc" id="L35612">                    reportId = 3510;</span>
<span class="nc" id="L35613">                    break;</span>
                case Mounted.MINE_INFERNO:
<span class="nc" id="L35615">                    deliverThunderInfernoMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35616">                            entity.getId());</span>
<span class="nc" id="L35617">                    reportId = 3515;</span>
                    break;
                // TODO : command-detonated mines
                // case 2:
            }
<span class="nc" id="L35622">            mine.setShotsLeft(mine.getUsableShotsLeft() - 1);</span>
<span class="nc bnc" id="L35623" title="All 2 branches missed.">            if (mine.getUsableShotsLeft() &lt;= 0) {</span>
<span class="nc" id="L35624">                mine.setMissing(true);</span>
            }
<span class="nc" id="L35626">            r = new Report(reportId);</span>
<span class="nc" id="L35627">            r.subject = entity.getId();</span>
<span class="nc" id="L35628">            r.addDesc(entity);</span>
<span class="nc" id="L35629">            r.add(coords.getBoardNum());</span>
<span class="nc" id="L35630">            addReport(r);</span>
<span class="nc" id="L35631">            entity.setLayingMines(true);</span>
        }
<span class="nc" id="L35633">    }</span>

    public void reportRoll(Roll roll) {
<span class="nc" id="L35636">        Report r = new Report(1230);</span>
<span class="nc" id="L35637">        r.add(roll.getReport());</span>
<span class="nc" id="L35638">        addReport(r);</span>
<span class="nc" id="L35639">    }</span>

    private void registerWithServerBrowser(boolean register, String urlString) {
        try {
<span class="nc" id="L35643">            URL url = new URL(urlString);</span>
<span class="nc" id="L35644">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L35645">            conn.setDoOutput(true);</span>
<span class="nc" id="L35646">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span>
<span class="nc" id="L35647">            DataOutputStream printout = new DataOutputStream(</span>
<span class="nc" id="L35648">                    conn.getOutputStream());</span>
            String content;
<span class="nc" id="L35650">            content = &quot;port=&quot;</span>
<span class="nc" id="L35651">                      + URLEncoder.encode(</span>
<span class="nc" id="L35652">                              Integer.toString(serverSocket.getLocalPort()), &quot;UTF-8&quot;);</span>
<span class="nc bnc" id="L35653" title="All 2 branches missed.">            if (register) {</span>
<span class="nc bnc" id="L35654" title="All 2 branches missed.">                for (IConnection iconn : connections) {</span>
<span class="nc" id="L35655">                    content += &quot;&amp;players[]=&quot; + (getPlayer(iconn.getId()).getName());</span>
<span class="nc" id="L35656">                }</span>
<span class="nc bnc" id="L35657" title="All 2 branches missed.">                if ((game.getPhase() != Phase.PHASE_LOUNGE)</span>
<span class="nc bnc" id="L35658" title="All 2 branches missed.">                        &amp;&amp; (game.getPhase() != Phase.PHASE_UNKNOWN)) {</span>
<span class="nc" id="L35659">                    content += &quot;&amp;close=yes&quot;;</span>
                }
<span class="nc" id="L35661">                content += &quot;&amp;version=&quot; + MegaMek.VERSION;</span>
<span class="nc bnc" id="L35662" title="All 2 branches missed.">                if (isPassworded()) {</span>
<span class="nc" id="L35663">                    content += &quot;&amp;pw=yes&quot;;</span>
                }
            } else {
<span class="nc" id="L35666">                content += &quot;&amp;delete=yes&quot;;</span>
            }
<span class="nc bnc" id="L35668" title="All 2 branches missed.">            if (serverAccessKey != null) {</span>
<span class="nc" id="L35669">                content += &quot;&amp;key=&quot; + serverAccessKey;</span>
            }
<span class="nc" id="L35671">            printout.writeBytes(content);</span>
<span class="nc" id="L35672">            printout.flush();</span>
<span class="nc" id="L35673">            BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream()));</span>
            String line;
<span class="nc bnc" id="L35675" title="All 2 branches missed.">            if (conn.getResponseCode() == 200) {</span>
<span class="nc bnc" id="L35676" title="All 2 branches missed.">                while ((line = rd.readLine()) != null) {</span>
<span class="nc bnc" id="L35677" title="All 2 branches missed.">                    if (serverAccessKey == null) {</span>
<span class="nc" id="L35678">                        serverAccessKey = line;</span>
                    }
                }
            }
<span class="nc" id="L35682">            rd.close();</span>
<span class="nc" id="L35683">            printout.close();</span>
<span class="nc" id="L35684">        } catch (Exception ignored) {</span>
<span class="nc" id="L35685">        }</span>
<span class="nc" id="L35686">    }</span>

    public Set&lt;Coords&gt; getHexUpdateSet() {
<span class="nc" id="L35689">        return hexUpdateSet;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>