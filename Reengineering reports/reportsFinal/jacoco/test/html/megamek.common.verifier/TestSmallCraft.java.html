<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestSmallCraft.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.verifier</a> &gt; <span class="el_source">TestSmallCraft.java</span></div><h1>TestSmallCraft.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2017 - The MegaMek Team
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */
package megamek.common.verifier;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import megamek.common.Aero;
import megamek.common.AmmoType;
import megamek.common.Bay;
import megamek.common.CriticalSlot;
import megamek.common.Entity;
import megamek.common.EquipmentType;
import megamek.common.ITechManager;
import megamek.common.MiscType;
import megamek.common.Mounted;
import megamek.common.SmallCraft;
import megamek.common.TechConstants;
import megamek.common.WeaponType;
import megamek.common.util.StringUtil;

/**
 * Class for testing and validating instantiations for Small Craft and Dropships.
 *
 * @author Neoancient
 *
 */
public class TestSmallCraft extends TestAero {
    
    // Indices used to specify firing arcs with aliases for aerodyne and spheroid
    public static final int ARC_NOSE = SmallCraft.LOC_NOSE;
    public static final int ARC_LWING = SmallCraft.LOC_LWING;
    public static final int ARC_RWING = SmallCraft.LOC_RWING;
    public static final int ARC_AFT = SmallCraft.LOC_AFT;
    public static final int REAR_ARC_OFFSET = SmallCraft.LOC_HULL;
    public static final int ARC_FWD_LEFT = SmallCraft.LOC_LWING;
    public static final int ARC_FWD_RIGHT = SmallCraft.LOC_RWING;
    public static final int ARC_AFT_LEFT = SmallCraft.LOC_LWING + REAR_ARC_OFFSET;
    public static final int ARC_AFT_RIGHT = SmallCraft.LOC_RWING + REAR_ARC_OFFSET;
    
    private final SmallCraft smallCraft;

<span class="nc" id="L58">    public enum AerospaceArmor{</span>
<span class="nc" id="L59">        STANDARD(EquipmentType.T_ARMOR_AEROSPACE, false),   </span>
<span class="nc" id="L60">        CLAN_STANDARD(EquipmentType.T_ARMOR_AEROSPACE, true),</span>
<span class="nc" id="L61">        IS_FERRO_ALUM(EquipmentType.T_ARMOR_ALUM, false),</span>
<span class="nc" id="L62">        CLAN_FERRO_ALUM(EquipmentType.T_ARMOR_ALUM, true),</span>
<span class="nc" id="L63">        FERRO_PROTO(EquipmentType.T_ARMOR_FERRO_ALUM_PROTO, false),        </span>
<span class="nc" id="L64">        HEAVY_FERRO_ALUM(EquipmentType.T_ARMOR_HEAVY_ALUM, false),</span>
<span class="nc" id="L65">        LIGHT_FERRO_ALUM(EquipmentType.T_ARMOR_LIGHT_ALUM, false),</span>
<span class="nc" id="L66">        PRIMITIVE(EquipmentType.T_ARMOR_PRIMITIVE_AERO, false);        </span>

        /**
         * The type, corresponding to types defined in 
         * &lt;code&gt;EquipmentType&lt;/code&gt;.
         */
        public int type;
                
        /**
         * Denotes whether this armor is Clan or not.
         */
        public boolean isClan;
        
<span class="nc" id="L79">        AerospaceArmor(int t, boolean c){</span>
<span class="nc" id="L80">            type = t;</span>
<span class="nc" id="L81">            isClan = c;</span>
<span class="nc" id="L82">        }</span>
        
        /**
         * Given an armor type, return the &lt;code&gt;AerospaceArmor&lt;/code&gt; instance that
         * represents that type.
         * 
         * @param t  The armor type.
         * @param c  Whether this armor type is Clan or not.
         * @return   The &lt;code&gt;AeroArmor&lt;/code&gt; that corresponds to the given 
         *              type or null if no match was found.
         */
        public static AerospaceArmor getArmor(int t, boolean c){
<span class="nc bnc" id="L94" title="All 2 branches missed.">            for (AerospaceArmor a : values()){</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">                if (a.type == t &amp;&amp; a.isClan == c){</span>
<span class="nc" id="L96">                    return a;</span>
                }
            }
<span class="nc" id="L99">            return null;</span>
        }
        
        /**
         * Calculates and returns the points per ton of the armor type given the
         * weight and shape of a small craft/dropship
         * 
         * @param sc The small craft/dropship
         * @return   The number of points of armor per ton
         */
        public double pointsPerTon(SmallCraft sc) {
<span class="nc" id="L110">            return SmallCraft.armorPointsPerTon(sc.getWeight(), sc.isSpheroid(), type, isClan);</span>
        }
        
        /**
         * @return The &lt;code&gt;MiscType&lt;/code&gt; for this armor.
         */
        public EquipmentType getArmorEqType() {
<span class="nc" id="L117">            String name = EquipmentType.getArmorTypeName(type, isClan);</span>
<span class="nc" id="L118">            return EquipmentType.get(name);</span>
        }
    }

    /**
     * Filters all small craft/dropship armor according to given tech constraints
     * 
     * @param techManager Used to check the tech constraints
     * @return A list of all armors that meet the tech constraints
     */
    public static List&lt;EquipmentType&gt; legalArmorsFor(ITechManager techManager) {
<span class="nc" id="L129">        List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        for (AerospaceArmor armor : AerospaceArmor.values()) {</span>
<span class="nc" id="L131">            final EquipmentType eq = armor.getArmorEqType();</span>
<span class="nc bnc" id="L132" title="All 4 branches missed.">            if ((null != eq) &amp;&amp; techManager.isLegal(eq)) {</span>
<span class="nc" id="L133">                retVal.add(eq);</span>
            }
        }
<span class="nc" id="L136">        return retVal;</span>
    }
    
    public static int maxArmorPoints(SmallCraft sc) {
<span class="nc" id="L140">        AerospaceArmor a = AerospaceArmor.getArmor(sc.getArmorType(0),</span>
<span class="nc" id="L141">                TechConstants.isClan(sc.getArmorTechLevel(0)));</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (null != a) {</span>
<span class="nc" id="L143">            return (int) Math.floor(a.pointsPerTon(sc) * maxArmorWeight(sc)</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                    + sc.get0SI() * (sc.isPrimitive() ? 2.64 : 4));</span>
        } else {
<span class="nc" id="L146">            return 0;</span>
        }
    }
    
    /**
     *  Computes the maximum number armor level in tons
     *   
     */
    public static double maxArmorWeight(SmallCraft smallCraft){
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (smallCraft.isSpheroid()) {</span>
<span class="nc" id="L156">            return floor(smallCraft.get0SI() * 3.6, Ceil.HALFTON);</span>
        } else {
<span class="nc" id="L158">            return floor(smallCraft.get0SI() * 4.5, Ceil.HALFTON);</span>
        }
    }
    
    /**
     * Computes the amount of weight required for fire control systems and power distribution
     * systems for exceeding the base limit of weapons per firing arc.
     * 
     * Spheroid aft side arcs are implemented as rear-mounted; the return value uses the index
     * of forward side + 3 for the aft side arcs.
     * 
     * @param sc The small craft/dropship in question
     * @return   Returns a &lt;code&gt;double&lt;/code&gt; array, where each element corresponds to a 
     *           location and the value is the extra tonnage required by exceeding the base
     *           allotment
     */
    public static double[] extraSlotCost(SmallCraft sc) {
        // Arcs/locations include the hull. Spheroids have two arcs in each side location;
        // the indices for the side aft arcs are after the virtual wings location.
<span class="nc bnc" id="L177" title="All 2 branches missed.">        final int arcs = sc.isSpheroid() ? 8 : 5;</span>
<span class="nc" id="L178">        int[] weaponsPerArc = new int[arcs];</span>
<span class="nc" id="L179">        double[] weaponTonnage = new double[arcs];</span>
<span class="nc" id="L180">        boolean hasNC3 = sc.hasWorkingMisc(MiscType.F_NAVAL_C3);</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        for (Mounted m : sc.getEquipment()) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (usesWeaponSlot(sc, m.getType())) {</span>
<span class="nc" id="L184">                int arc = m.getLocation();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (arc &lt; 0) {</span>
<span class="nc" id="L186">                    continue;</span>
                }
<span class="nc bnc" id="L188" title="All 4 branches missed.">                if (sc.isSpheroid() &amp;&amp; m.isRearMounted()) {</span>
<span class="nc" id="L189">                    arc += REAR_ARC_OFFSET;</span>
                }
<span class="nc" id="L191">                weaponsPerArc[arc]++;</span>
<span class="nc" id="L192">                weaponTonnage[arc] += m.getTonnage();</span>
            }
<span class="nc" id="L194">        }</span>
<span class="nc" id="L195">        double[] retVal = new double[arcs];</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        for (int arc = 0; arc &lt; arcs; arc++) {</span>
<span class="nc" id="L197">            int excess = (weaponsPerArc[arc] - 1) / slotsPerArc(sc);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (excess &gt; 0) {</span>
<span class="nc" id="L199">                retVal[arc] = ceil(excess * weaponTonnage[arc] / 10.0, Ceil.HALFTON);</span>
            }
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (hasNC3) {</span>
<span class="nc" id="L202">                retVal[arc] *= 2;</span>
            }
        }
<span class="nc" id="L205">        return retVal;</span>
    }
    
    /**
     * Computes the weight of the engine.
     * 
     * @param clan          Whether the unit is a Clan design
     * @param tonnage       The weight of the unit
     * @param desiredSafeThrust  The safe thrust value
     * @param dropship      Whether the unit is a dropship (only relevant for primitives)
     * @param year          The original construction year (only relevant for primitives)
     * @return              The weight of the engine in tons
     */
    public static double calculateEngineTonnage(boolean clan, double tonnage, 
            int desiredSafeThrust, boolean dropship, int year) {
        double multiplier;
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (clan) {</span>
<span class="nc" id="L222">            multiplier = 0.061;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        } else if (dropship) {</span>
<span class="nc" id="L224">            multiplier = dropshipEngineMultiplier(year);</span>
        } else {
<span class="nc" id="L226">            multiplier = smallCraftEngineMultiplier(year);</span>
        }
<span class="nc" id="L228">        return ceil(tonnage * desiredSafeThrust * multiplier, Ceil.HALFTON);</span>
    }
    
    public static int weightFreeHeatSinks(SmallCraft sc) {
<span class="nc" id="L232">        double engineTonnage = calculateEngineTonnage(sc.isClan(), sc.getWeight(), sc.getWalkMP(),</span>
<span class="nc" id="L233">                sc.hasETypeFlag(Entity.ETYPE_DROPSHIP), sc.getOriginalBuildYear());</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (sc.isSpheroid()) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (sc.isPrimitive()) {</span>
<span class="nc" id="L236">                return (int)Math.floor(Math.sqrt(engineTonnage * 1.3));</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            } else if ((sc.getDesignType() == SmallCraft.MILITARY)</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    &amp;&amp; sc.hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc" id="L239">                return (int)Math.floor(Math.sqrt(engineTonnage * 6.8));</span>
            } else {
<span class="nc" id="L241">                return (int)Math.floor(Math.sqrt(engineTonnage * 1.6));</span>
            }
        } else {
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (sc.isPrimitive()) {</span>
<span class="nc" id="L245">                return (int)Math.floor(engineTonnage / 75.0);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            } else if ((sc.getDesignType() == SmallCraft.MILITARY)</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                    &amp;&amp; sc.hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc" id="L248">                return (int)Math.floor(engineTonnage / 20.0);</span>
            } else {
<span class="nc" id="L250">                return (int)Math.floor(engineTonnage / 60.0);</span>
            }
        }
    }
    
    public static double smallCraftEngineMultiplier(int year) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (year &gt;= 2500) {</span>
<span class="nc" id="L257">            return 0.065;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        } else if (year &gt;= 2400) {</span>
<span class="nc" id="L259">            return 0.078;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        } else if (year &gt;= 2300) {</span>
<span class="nc" id="L261">            return 0.091;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        } else if (year &gt;= 2251) {</span>
<span class="nc" id="L263">            return 0.0975;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        } else if (year &gt;= 2201) {</span>
<span class="nc" id="L265">            return 0.1105;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        } else if (year &gt;= 2151) {</span>
<span class="nc" id="L267">            return 0.1235;</span>
        } else {
<span class="nc" id="L269">            return 0.143;</span>
        }
    }
    
    public static double smallCraftControlMultiplier(int year) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (year &gt;= 2500) {</span>
<span class="nc" id="L275">            return 0.0075;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        } else if (year &gt;= 2400) {</span>
<span class="nc" id="L277">            return 0.00825;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        } else if (year &gt;= 2300) {</span>
<span class="nc" id="L279">            return 0.00975;</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        } else if (year &gt;= 2251) {</span>
<span class="nc" id="L281">            return 0.01125;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        } else if (year &gt;= 2201) {</span>
<span class="nc" id="L283">            return 0.01275;</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        } else if (year &gt;= 2151) {</span>
<span class="nc" id="L285">            return 0.01245;</span>
        } else {
<span class="nc" id="L287">            return 0.01575;</span>
        }
    }
    
    public static double dropshipEngineMultiplier(int year) {
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (year &gt;= 2500) {</span>
<span class="nc" id="L293">            return 0.065;</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        } else if (year &gt;= 2351) {</span>
<span class="nc" id="L295">            return 0.0715;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        } else if (year &gt;= 2300) {</span>
<span class="nc" id="L297">            return 0.0845;</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        } else if (year &gt;= 2251) {</span>
<span class="nc" id="L299">            return 0.091;</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        } else if (year &gt;= 2201) {</span>
<span class="nc" id="L301">            return 0.1104;</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        } else if (year &gt;= 2151) {</span>
<span class="nc" id="L303">            return 0.117;</span>
        } else {
<span class="nc" id="L305">            return 0.13;</span>
        }
    }
    
    public static double dropshipControlMultiplier(int year) {
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (year &gt;= 2500) {</span>
<span class="nc" id="L311">            return 0.0075;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        } else if (year &gt;= 2351) {</span>
<span class="nc" id="L313">            return 0.009;</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        } else if (year &gt;= 2300) {</span>
<span class="nc" id="L315">            return 0.00975;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">        } else if (year &gt;= 2251) {</span>
<span class="nc" id="L317">            return 0.0105;</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        } else if (year &gt;= 2201) {</span>
<span class="nc" id="L319">            return 0.0120;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        } else if (year &gt;= 2151) {</span>
<span class="nc" id="L321">            return 0.0135;</span>
        } else {
<span class="nc" id="L323">            return 0.015;</span>
        }
    }
    
    /**
     * @return Minimum crew requirements based on unit type and equipment crew requirements.
     */
    public static int minimumBaseCrew(SmallCraft sc) {
<span class="nc" id="L331">        int crew = 3;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (sc.hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc" id="L333">            crew += (int)Math.ceil(sc.getWeight() / 5000);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (sc.getDesignType() == SmallCraft.MILITARY) {</span>
<span class="nc" id="L335">                crew++;</span>
            }
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        for (Mounted m : sc.getMisc()) {</span>
<span class="nc" id="L339">            crew += equipmentCrewRequirements(m);</span>
<span class="nc" id="L340">        }</span>
<span class="nc" id="L341">        return crew;</span>
    }
        
    public TestSmallCraft(SmallCraft sc, TestEntityOption option, String fs) {
<span class="nc" id="L345">        super(sc, option, fs);</span>
        
<span class="nc" id="L347">        smallCraft = sc;</span>
<span class="nc" id="L348">    }</span>

    @Override
    public Entity getEntity() {
<span class="nc" id="L352">        return smallCraft;</span>
    }

    @Override
    public boolean isTank() {
<span class="nc" id="L357">        return false;</span>
    }

    @Override
    public boolean isMech() {
<span class="nc" id="L362">        return false;</span>
    }
    
    @Override
    public boolean isAero() {
<span class="nc" id="L367">        return true;</span>
    }
    
    @Override
    public boolean isSmallCraft() {
<span class="nc" id="L372">        return true;</span>
    }

    @Override
    public double getWeightControls() {
        // Non primitives use the multiplier for 2500+ even if they were built before that date
<span class="nc bnc" id="L378" title="All 2 branches missed.">        int year = smallCraft.isPrimitive()? smallCraft.getOriginalBuildYear() : 2500;</span>
        // Small craft round up to the half ton and dropships to the full ton
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (smallCraft.hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc" id="L381">            return ceil(smallCraft.getWeight()</span>
<span class="nc" id="L382">                    * dropshipControlMultiplier(year), Ceil.TON);</span>
        } else {
<span class="nc" id="L384">            return ceil(smallCraft.getWeight()</span>
<span class="nc" id="L385">                    * smallCraftControlMultiplier(year), Ceil.HALFTON);</span>
        }
    }

    @Override
    public double getWeightEngine() {
<span class="nc" id="L391">        return calculateEngineTonnage(smallCraft.isClan(), smallCraft.getWeight(),</span>
<span class="nc" id="L392">                smallCraft.getOriginalWalkMP(), smallCraft.hasETypeFlag(Entity.ETYPE_DROPSHIP),</span>
<span class="nc" id="L393">                smallCraft.getOriginalBuildYear());</span>
    }

    @Override
    public String printWeightEngine() {
<span class="nc" id="L398">        return StringUtil.makeLength(&quot;Engine: &quot;, getPrintSize() - 5)</span>
<span class="nc" id="L399">                + TestEntity.makeWeightString(getWeightEngine()) + &quot;\n&quot;;</span>
    }

    @Override
    public double getWeightFuel() {
        // Add 2% for pumps and round up to the half ton
<span class="nc" id="L405">        return ceil(smallCraft.getFuelTonnage() * 1.02, Ceil.HALFTON);</span>
    }

    @Override
    public int getCountHeatSinks() {
<span class="nc" id="L410">        return smallCraft.getHeatSinks();</span>
    }

    @Override
    public double getWeightHeatSinks() {
<span class="nc" id="L415">        return Math.max(smallCraft.getHeatSinks() - weightFreeHeatSinks(smallCraft), 0);        </span>
    }

    // Bays can store multiple tons of ammo in a single slot.
    @Override
    public double getWeightAmmo() {
<span class="nc" id="L421">        double weight = 0.0;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">        for (Mounted m : getEntity().getAmmo()) {</span>

            // One Shot Ammo
<span class="nc bnc" id="L425" title="All 2 branches missed.">            if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L426">                continue;</span>
            }

<span class="nc" id="L429">            AmmoType mt = (AmmoType) m.getType();</span>
<span class="nc" id="L430">            int slots = (int) Math.ceil((double) m.getBaseShotsLeft() / mt.getShots());</span>
<span class="nc" id="L431">            weight += m.getTonnage() * slots;</span>
<span class="nc" id="L432">        }</span>
<span class="nc" id="L433">        return weight;</span>
    }

    @Override
    public double getWeightMisc() {
<span class="nc" id="L438">        double weight = 0.0;</span>
        // Add in extra fire control system weight for exceeding base slot limit
<span class="nc bnc" id="L440" title="All 2 branches missed.">        for (double extra : extraSlotCost(smallCraft)) {</span>
<span class="nc" id="L441">            weight += extra;</span>
        }
        // 7 tons each for life boats and escape pods, which includes the 5-ton vehicle and a
        // 2-ton launch mechanism
<span class="nc" id="L445">        weight += (smallCraft.getLifeBoats() + smallCraft.getEscapePods()) * 7;</span>
<span class="nc" id="L446">        return weight;</span>
    }

    @Override
    public String printWeightMisc() {
<span class="nc" id="L451">        double weight = getWeightMisc();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (weight &gt; 0){</span>
<span class="nc" id="L453">            return StringUtil.makeLength(</span>
<span class="nc" id="L454">                    &quot;Escape pods/Life boats: &quot;, getPrintSize() - 5) + weight + &quot;\n&quot;;</span>
        }
<span class="nc" id="L456">        return &quot;&quot;;</span>
    }
    
    @Override
    public StringBuffer printWeapon() {
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (!getEntity().usesWeaponBays()) {</span>
<span class="nc" id="L462">            return super.printWeapon();</span>
        }
<span class="nc" id="L464">        StringBuffer buffer = new StringBuffer();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        for (Mounted m : getEntity().getWeaponBayList()) {</span>
<span class="nc" id="L466">            buffer.append(m.getName()).append(&quot; &quot;)</span>
<span class="nc" id="L467">                .append(getLocationAbbr(m.getLocation()));</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">            if (m.isRearMounted()) {</span>
<span class="nc" id="L469">                buffer.append(&quot; (R)&quot;);</span>
            }
<span class="nc" id="L471">            buffer.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            for (Integer wNum : m.getBayWeapons()) {</span>
<span class="nc" id="L473">                final Mounted w = getEntity().getEquipment(wNum);</span>
<span class="nc" id="L474">                buffer.append(&quot;   &quot;).append(StringUtil.makeLength(w.getName(),</span>
<span class="nc" id="L475">                        getPrintSize() - 25)).append(w.getTonnage())</span>
<span class="nc" id="L476">                    .append(&quot;\n&quot;);</span>
<span class="nc" id="L477">            }</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            for (Integer aNum : m.getBayAmmo()) {</span>
<span class="nc" id="L479">                final Mounted a = getEntity().getEquipment(aNum);</span>
<span class="nc" id="L480">                double weight = a.getTonnage() * a.getBaseShotsLeft() / ((AmmoType) a.getType()).getShots();</span>
<span class="nc" id="L481">                buffer.append(&quot;   &quot;).append(StringUtil.makeLength(a.getName(),</span>
<span class="nc" id="L482">                        getPrintSize() - 25)).append(weight).append(&quot;\n&quot;);</span>
<span class="nc" id="L483">            }</span>
<span class="nc" id="L484">        }</span>
<span class="nc" id="L485">        return buffer;</span>
    }

    @Override
    public StringBuffer printAmmo() {
<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (!smallCraft.usesWeaponBays()) {</span>
<span class="nc" id="L491">            return super.printAmmo();</span>
        }
<span class="nc" id="L493">        return new StringBuffer();</span>
    }

    @Override
    public boolean hasDoubleHeatSinks() {
<span class="nc bnc" id="L498" title="All 2 branches missed.">        return smallCraft.getHeatType() == Aero.HEAT_DOUBLE;</span>
    }

    @Override
    public String printWeightControls() {
<span class="nc" id="L503">        return StringUtil.makeLength(</span>
<span class="nc" id="L504">                &quot;Control Systems:&quot;, getPrintSize() - 5) + makeWeightString(getWeightControls()) +</span>
                &quot;\n&quot;;
    }

    @Override
    public String printWeightFuel() {
<span class="nc" id="L510">        return StringUtil.makeLength(</span>
<span class="nc" id="L511">                &quot;Fuel: &quot;, getPrintSize() - 5) + makeWeightString(getWeightFuel()) +</span>
                &quot;\n&quot;;
    }

    @Override
    public Aero getAero() {
<span class="nc" id="L517">        return smallCraft;</span>
    }
    
    public SmallCraft getSmallCraft() {
<span class="nc" id="L521">        return smallCraft;</span>
    }

    @Override
    public String printArmorLocProp(int loc, int wert) {
<span class="nc" id="L526">        return &quot; is greater than &quot; + wert + &quot;!&quot;;</span>
    }

    /**
     * Checks to see if this unit has valid armor assignment.
     * 
     * @param buff A buffer that collects messages about validation failures
     * @return     Whether the unit's armor is valid
     */
    @Override
    public boolean correctArmor(StringBuffer buff) {
<span class="nc" id="L537">        boolean correct = true;</span>
<span class="nc" id="L538">        double maxArmor = maxArmorWeight(smallCraft);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (smallCraft.getLabArmorTonnage() &gt; maxArmor) {</span>
<span class="nc" id="L540">            buff.append(&quot;Total armor,&quot;).append(smallCraft.getLabArmorTonnage())</span>
<span class="nc" id="L541">                    .append(&quot; tons, is greater than the maximum: &quot;).append(maxArmor).append(&quot;\n&quot;);</span>
<span class="nc" id="L542">            correct = false;</span>
        }

<span class="nc" id="L545">        return correct ;</span>
    }
    
    /**
     * Checks that the heatsink type is a legal value.
     *
     * @param buff A buffer that collects messages about validation failures
     * @return     Whether the unit's heat sinks are valid.
     */
    @Override
    public boolean correctHeatSinks(StringBuffer buff) {
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if ((smallCraft.getHeatType() != Aero.HEAT_SINGLE) </span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">                &amp;&amp; (smallCraft.getHeatType() != Aero.HEAT_DOUBLE)) {</span>
<span class="nc" id="L558">            buff.append(&quot;Invalid heatsink type!  Valid types are &quot;).append(Aero.HEAT_SINGLE)</span>
<span class="nc" id="L559">                    .append(&quot; and &quot;).append(Aero.HEAT_DOUBLE).append(&quot;.  Found &quot;)</span>
<span class="nc" id="L560">                    .append(smallCraft.getHeatType()).append(&quot;.&quot;);</span>
<span class="nc" id="L561">            return false;</span>
        }
<span class="nc" id="L563">        return true;</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {
<span class="nc" id="L568">        boolean correct = true;</span>
        
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (skip()) {</span>
<span class="nc" id="L571">            return true;</span>
        }
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (!correctWeight(buff)) {</span>
<span class="nc" id="L574">            buff.insert(0, printTechLevel() + printShortMovement());</span>
<span class="nc" id="L575">            buff.append(printWeightCalculation());</span>
<span class="nc" id="L576">            correct = false;</span>
        }
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if (getCountHeatSinks() &lt; weightFreeHeatSinks(smallCraft)) {</span>
<span class="nc" id="L579">            buff.append(&quot;Heat Sinks:\n&quot;);</span>
<span class="nc" id="L580">            buff.append(&quot; Total     &quot;).append(getCountHeatSinks()).append(&quot;\n&quot;);</span>
<span class="nc" id="L581">            buff.append(&quot; Required  &quot;).append(weightFreeHeatSinks(smallCraft)).append(&quot;\n&quot;);</span>
<span class="nc" id="L582">            correct = false;</span>
        }                
        
<span class="nc bnc" id="L585" title="All 4 branches missed.">        if (showCorrectArmor() &amp;&amp; !correctArmor(buff)) {</span>
<span class="nc" id="L586">            correct = false;</span>
        }
<span class="nc bnc" id="L588" title="All 4 branches missed.">        if (showFailedEquip() &amp;&amp; hasFailedEquipment(buff)) {</span>
<span class="nc" id="L589">            correct = false;</span>
        }
        
<span class="nc bnc" id="L592" title="All 2 branches missed.">        correct &amp;= !hasIllegalTechLevels(buff, ammoTechLvl);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">        correct &amp;= !hasIllegalEquipmentCombinations(buff);</span>
<span class="nc" id="L594">        correct &amp;= correctHeatSinks(buff);</span>
<span class="nc" id="L595">        correct &amp;= correctCrew(buff);</span>
<span class="nc" id="L596">        correct &amp;= correctCriticals(buff);</span>
        
<span class="nc" id="L598">        return correct;</span>
    }

    @Override
    public boolean hasIllegalEquipmentCombinations(StringBuffer buff) {
<span class="nc" id="L603">        boolean illegal = false;</span>
        
        // For dropships, make sure all bays have at least one weapon and that there are at least
        // ten shots of ammo for each ammo-using weapon in the bay.
<span class="nc bnc" id="L607" title="All 2 branches missed.">        for (Mounted bay : smallCraft.getWeaponBayList()) {</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">            if (bay.getBayWeapons().size() == 0) {</span>
<span class="nc" id="L609">                buff.append(&quot;Bay &quot;).append(bay.getName()).append(&quot; has no weapons\n&quot;);</span>
<span class="nc" id="L610">                illegal = true;</span>
            }
<span class="nc" id="L612">            Map&lt;Integer,Integer&gt; ammoWeaponCount = new HashMap&lt;&gt;();</span>
<span class="nc" id="L613">            Map&lt;Integer,Integer&gt; ammoTypeCount = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">            for (Integer wNum : bay.getBayWeapons()) {</span>
<span class="nc" id="L615">                final Mounted w = smallCraft.getEquipment(wNum);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                if (w.isOneShotWeapon()) {</span>
<span class="nc" id="L617">                    continue;</span>
                }
<span class="nc bnc" id="L619" title="All 2 branches missed.">                if (w.getType() instanceof WeaponType) {</span>
<span class="nc" id="L620">                    ammoWeaponCount.merge(((WeaponType)w.getType()).getAmmoType(), 1, Integer::sum);</span>
                } else {
<span class="nc" id="L622">                    buff.append(w.getName()).append(&quot; in bay &quot;).append(bay.getName()).append(&quot; is not a weapon\n&quot;);</span>
<span class="nc" id="L623">                    illegal = true;</span>
                }
<span class="nc" id="L625">            }</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">            for (Integer aNum : bay.getBayAmmo()) {</span>
<span class="nc" id="L627">                final Mounted a = smallCraft.getEquipment(aNum);</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">                if (a.getType() instanceof AmmoType) {</span>
<span class="nc" id="L629">                    ammoTypeCount.merge(((AmmoType)a.getType()).getAmmoType(), a.getUsableShotsLeft(),</span>
                            Integer::sum);
                } else {
<span class="nc" id="L632">                    buff.append(a.getName()).append(&quot; in bay &quot;).append(bay.getName()).append(&quot; is not ammo\n&quot;);</span>
<span class="nc" id="L633">                    illegal = true;</span>
                }
<span class="nc" id="L635">            }</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">            for (Integer at : ammoWeaponCount.keySet()) {</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                if (at != AmmoType.T_NA) {</span>
<span class="nc" id="L638">                    int needed = ammoWeaponCount.get(at) * 10;</span>
<span class="nc bnc" id="L639" title="All 4 branches missed.">                    if ((at == AmmoType.T_AC_ULTRA) || (at == AmmoType.T_AC_ULTRA_THB)) {</span>
<span class="nc" id="L640">                        needed *= 2;</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                    } else if ((at == AmmoType.T_AC_ROTARY)) {</span>
<span class="nc" id="L642">                        needed *= 6;</span>
                    }
<span class="nc bnc" id="L644" title="All 2 branches missed.">                    if (!ammoTypeCount.containsKey(at)</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">                            || ammoTypeCount.get(at) &lt; needed) {</span>
<span class="nc" id="L646">                        buff.append(&quot;Bay &quot;).append(bay.getName()).append(&quot; does not have the minimum 10 shots of ammo for each weapon\n&quot;);</span>
<span class="nc" id="L647">                        illegal = true;</span>
<span class="nc" id="L648">                        break;</span>
                    }
                }
<span class="nc" id="L651">            }</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">            for (Integer at : ammoTypeCount.keySet()) {</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                if (!ammoWeaponCount.containsKey(at)) {</span>
<span class="nc" id="L654">                    buff.append(&quot;Bay &quot;).append(bay.getName()).append(&quot; has ammo for a weapon not in the bay\n&quot;);</span>
<span class="nc" id="L655">                    illegal = true;</span>
<span class="nc" id="L656">                    break;</span>
                }
<span class="nc" id="L658">            }</span>
<span class="nc" id="L659">        }</span>
        
        // Count lateral weapons to make sure both sides match
<span class="nc" id="L662">        Map&lt;EquipmentType,Integer&gt; leftFwd = new HashMap&lt;&gt;();</span>
<span class="nc" id="L663">        Map&lt;EquipmentType,Integer&gt; leftAft = new HashMap&lt;&gt;();</span>
<span class="nc" id="L664">        Map&lt;EquipmentType,Integer&gt; rightFwd = new HashMap&lt;&gt;();</span>
<span class="nc" id="L665">        Map&lt;EquipmentType,Integer&gt; rightAft = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">        BigInteger typeFlag = smallCraft.hasETypeFlag(Entity.ETYPE_DROPSHIP)?</span>
<span class="nc" id="L667">                MiscType.F_DS_EQUIPMENT : MiscType.F_SC_EQUIPMENT;</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">        for (Mounted m : smallCraft.getEquipment()) {</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">            if (m.getType() instanceof MiscType) {</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                if (!m.getType().hasFlag(typeFlag)) {</span>
<span class="nc" id="L671">                    buff.append(&quot;Cannot mount &quot;).append(m.getType().getName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L672">                    illegal = true;</span>
                }
<span class="nc bnc" id="L674" title="All 2 branches missed.">            } else if ((m.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">                    &amp;&amp; (smallCraft.hasETypeFlag(Entity.ETYPE_DROPSHIP))</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">                    &amp;&amp; (((AmmoType)m.getType()).getAmmoType() == AmmoType.T_COOLANT_POD)) {</span>
<span class="nc" id="L677">                buff.append(&quot;Cannot mount &quot;).append(m.getType().getName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L678">                illegal = true;</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            } else if (m.getType() instanceof WeaponType) {</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                if (m.getLocation() == SmallCraft.LOC_LWING) {</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                    if (m.isRearMounted()) {</span>
<span class="nc" id="L682">                        leftAft.merge(m.getType(), 1, Integer::sum);</span>
                    } else {
<span class="nc" id="L684">                        leftFwd.merge(m.getType(), 1, Integer::sum);</span>
                    }
<span class="nc bnc" id="L686" title="All 2 branches missed.">                } else if (m.getLocation() == SmallCraft.LOC_RWING) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                    if (m.isRearMounted()) {</span>
<span class="nc" id="L688">                        rightAft.merge(m.getType(), 1, Integer::sum);</span>
                    } else {
<span class="nc" id="L690">                        rightFwd.merge(m.getType(), 1, Integer::sum);</span>
                    }
                }
<span class="nc bnc" id="L693" title="All 2 branches missed.">                if (!isAeroWeapon(m.getType(), smallCraft)) {</span>
<span class="nc" id="L694">                    buff.append(&quot;Cannot mount &quot;).append(m.getType().getName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L695">                    illegal = true;</span>
                }
            }
<span class="nc" id="L698">        }</span>
<span class="nc" id="L699">        boolean lateralMatch = true;</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">        for (EquipmentType eq : leftFwd.keySet()) {</span>
<span class="nc bnc" id="L701" title="All 4 branches missed.">            if (!rightFwd.containsKey(eq) || !leftFwd.get(eq).equals(rightFwd.get(eq))) {</span>
<span class="nc" id="L702">                lateralMatch = false;</span>
<span class="nc" id="L703">                break;</span>
            }
<span class="nc" id="L705">        }</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">        if (lateralMatch) {</span>
            //We've already checked counts, so in the reverse direction we only need to see if there's
            //anything not found on the other side.
<span class="nc bnc" id="L709" title="All 2 branches missed.">            for (EquipmentType eq : rightFwd.keySet()) {</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                if (!leftFwd.containsKey(eq)) {</span>
<span class="nc" id="L711">                    lateralMatch = false;</span>
<span class="nc" id="L712">                    break;</span>
                }
<span class="nc" id="L714">            }</span>
        }
<span class="nc bnc" id="L716" title="All 2 branches missed.">        if (lateralMatch) {</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">            for (EquipmentType eq : leftAft.keySet()) {</span>
<span class="nc bnc" id="L718" title="All 4 branches missed.">                if (!rightAft.containsKey(eq) || !leftAft.get(eq).equals(rightAft.get(eq))) {</span>
<span class="nc" id="L719">                    lateralMatch = false;</span>
<span class="nc" id="L720">                    break;</span>
                }
<span class="nc" id="L722">            }</span>
        }
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (lateralMatch) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">            for (EquipmentType eq : rightAft.keySet()) {</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                if (!leftAft.containsKey(eq)) {</span>
<span class="nc" id="L727">                    lateralMatch = false;</span>
<span class="nc" id="L728">                    break;</span>
                }
<span class="nc" id="L730">            }</span>
        }
<span class="nc bnc" id="L732" title="All 2 branches missed.">        if (!lateralMatch) {</span>
<span class="nc" id="L733">            buff.append(&quot;Left and right side weapon loads do not match.\n&quot;);</span>
<span class="nc" id="L734">            illegal = true;</span>
        }

<span class="nc" id="L737">        int bayDoors = 0;</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">        for (Bay bay : smallCraft.getTransportBays()) {</span>
<span class="nc" id="L739">            bayDoors += bay.getDoors();</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">            if (bay.getDoors() == 0) {</span>
<span class="nc" id="L741">                BayData data = BayData.getBayType(bay);</span>
<span class="nc bnc" id="L742" title="All 6 branches missed.">                if ((data != null) &amp;&amp; !data.isCargoBay() &amp;&amp; !data.isInfantryBay()) {</span>
<span class="nc" id="L743">                    buff.append(&quot;Transport bays other than cargo and infantry require at least one door.\n&quot;);</span>
<span class="nc" id="L744">                    illegal = true;</span>
                }
            }
<span class="nc" id="L747">        }</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">        if (bayDoors &gt; maxBayDoors(smallCraft)) {</span>
<span class="nc" id="L749">            buff.append(&quot;Exceeds maximum number of bay doors.\n&quot;);</span>
<span class="nc" id="L750">            illegal = true;</span>
        }

<span class="nc" id="L753">        return illegal;</span>
    }
    
    /**
     * Checks that the unit meets minimum crew and quarters requirements.
     * @param buffer Where to write messages explaining failures.
     * @return  true if the crew data is valid.
     */
    public boolean correctCrew(StringBuffer buffer) {
<span class="nc" id="L762">        boolean illegal = false;</span>
<span class="nc" id="L763">        int crewSize = getSmallCraft().getNCrew() - getSmallCraft().getBayPersonnel();</span>
<span class="nc" id="L764">        int reqCrew = minimumBaseCrew(getSmallCraft()) + requiredGunners(getSmallCraft());</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if (crewSize &lt; reqCrew) {</span>
<span class="nc" id="L766">            buffer.append(&quot;Requires &quot;).append(reqCrew).append(&quot; crew and only has &quot;).append(crewSize).append(&quot;\n&quot;);</span>
<span class="nc" id="L767">            illegal = true;</span>
        }
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if (getSmallCraft().getNOfficers() * 5 &lt; reqCrew) {</span>
<span class="nc" id="L770">            buffer.append(&quot;Requires at least &quot;).append((int) Math.ceil(reqCrew / 5.0)).append(&quot; officers\n&quot;);</span>
<span class="nc" id="L771">            illegal = true;</span>
        }
<span class="nc" id="L773">        crewSize += getSmallCraft().getNPassenger();</span>
<span class="nc" id="L774">        crewSize += getSmallCraft().getNMarines();</span>
<span class="nc" id="L775">        crewSize += getSmallCraft().getNBattleArmor();</span>
<span class="nc" id="L776">        int quarters = 0;</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">        for (Bay bay : getSmallCraft().getTransportBays()) {</span>
<span class="nc" id="L778">            Quarters q = Quarters.getQuartersForBay(bay);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">            if (null != q) {</span>
<span class="nc" id="L780">                quarters += bay.getCapacity();</span>
            }
<span class="nc" id="L782">        }</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">        if (quarters &lt; crewSize) {</span>
<span class="nc" id="L784">            buffer.append(&quot;Requires quarters for &quot;).append(crewSize).append(&quot; crew but only has &quot;).append(quarters).append(&quot;\n&quot;);</span>
<span class="nc" id="L785">            illegal = true;</span>
        }
<span class="nc bnc" id="L787" title="All 2 branches missed.">        return !illegal;</span>
    }

    @Override
    public StringBuffer printEntity() {
<span class="nc" id="L792">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L793">        buff.append(&quot;Small Craft/Dropship: &quot;).append(smallCraft.getDisplayName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L794">        buff.append(&quot;Found in: &quot;).append(fileString).append(&quot;\n&quot;);        </span>
<span class="nc" id="L795">        buff.append(printTechLevel());</span>
<span class="nc" id="L796">        buff.append(&quot;Intro year: &quot;).append(getEntity().getYear()).append(&quot;\n&quot;);</span>
<span class="nc" id="L797">        buff.append(printSource());</span>
<span class="nc" id="L798">        buff.append(printShortMovement());</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if (correctWeight(buff, true, true)) {</span>
<span class="nc" id="L800">            buff.append(&quot;Weight: &quot;).append(getWeight()).append(&quot; (&quot;)</span>
<span class="nc" id="L801">                    .append(calculateWeight()).append(&quot;)\n&quot;);</span>
        }
<span class="nc" id="L803">        buff.append(printWeightCalculation()).append(&quot;\n&quot;);</span>
<span class="nc" id="L804">        buff.append(printArmorPlacement());</span>
<span class="nc" id="L805">        correctArmor(buff);</span>
<span class="nc" id="L806">        buff.append(printLocations());</span>
<span class="nc" id="L807">        correctCriticals(buff);</span>

        // printArmor(buff);
<span class="nc" id="L810">        printFailedEquipment(buff);</span>
<span class="nc" id="L811">        return buff;</span>
    }
    
    @Override
    public double calculateWeight() {
<span class="nc" id="L816">        double weight = 0;</span>
<span class="nc" id="L817">        weight += getWeightStructure();</span>
<span class="nc" id="L818">        weight += getWeightEngine();</span>
<span class="nc" id="L819">        weight += getWeightControls();</span>
<span class="nc" id="L820">        weight += getWeightFuel();</span>
<span class="nc" id="L821">        weight += getWeightHeatSinks();</span>
<span class="nc" id="L822">        weight += getWeightArmor();</span>
<span class="nc" id="L823">        weight += getWeightMisc();</span>

<span class="nc" id="L825">        weight += getWeightMiscEquip();</span>
<span class="nc" id="L826">        weight += getWeightWeapon();</span>
<span class="nc" id="L827">        weight += getWeightAmmo();</span>

<span class="nc" id="L829">        weight += getWeightCarryingSpace();</span>
<span class="nc" id="L830">        weight += getWeightQuarters();</span>

<span class="nc" id="L832">        return weight;</span>
    }

    @Override
    public String printWeightCalculation() {
<span class="nc" id="L837">        return printWeightEngine()</span>
<span class="nc" id="L838">                + printWeightControls() + printWeightFuel() </span>
<span class="nc" id="L839">                + printWeightHeatSinks()</span>
<span class="nc" id="L840">                + printWeightArmor() + printWeightMisc()</span>
<span class="nc" id="L841">                + printWeightCarryingSpace()</span>
<span class="nc" id="L842">                + printWeightQuarters()</span>
                + &quot;Equipment:\n&quot;
<span class="nc" id="L844">                + printMiscEquip() + printWeapon() + printAmmo();</span>
    }
    
    @Override
    public String printLocations() {
<span class="nc" id="L849">        StringBuilder buff = new StringBuilder();</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">        for (int i = 0; i &lt; getEntity().locations(); i++) {</span>
<span class="nc" id="L851">            String locationName = getEntity().getLocationName(i);</span>
<span class="nc" id="L852">            buff.append(locationName).append(&quot;:&quot;);</span>
<span class="nc" id="L853">            buff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">            for (int j = 0; j &lt; getEntity().getNumberOfCriticals(i); j++) {</span>
<span class="nc" id="L855">                CriticalSlot slot = getEntity().getCritical(i, j);</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">                if (slot == null) {</span>
<span class="nc" id="L857">                    j = getEntity().getNumberOfCriticals(i);                    </span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                } else if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
<span class="nc" id="L859">                        buff.append(j).append(&quot;. UNKNOWN SYSTEM NAME&quot;);</span>
<span class="nc" id="L860">                        buff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">                } else if (slot.getType() == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L862">                    EquipmentType e = getEntity().getEquipmentType(slot);</span>
<span class="nc" id="L863">                    buff.append(j).append(&quot;. &quot;).append(e.getInternalName());</span>
<span class="nc" id="L864">                    buff.append(&quot;\n&quot;);</span>
                }
            }
        }

<span class="nc" id="L869">        double[] extra = extraSlotCost(getSmallCraft());</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">        for (int i = 0; i &lt; extra.length; i++) {</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">            if (extra[i] &gt; 0) {</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">                if (i &lt; getEntity().locations()) {</span>
<span class="nc" id="L873">                    buff.append(getLocationAbbr(i));</span>
                } else {
<span class="nc" id="L875">                    buff.append(getLocationAbbr(i - 3)).append(&quot; (R)&quot;);</span>
                }
<span class="nc" id="L877">                buff.append(&quot; requires &quot;).append(extra[i]).append(&quot; tons of additional fire control.\n&quot;);</span>
            }
        }
<span class="nc" id="L880">        return buff.toString();</span>
    }

    @Override
    public String getName() {
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if (smallCraft.hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc" id="L886">            return &quot;Dropship: &quot; + smallCraft.getDisplayName();</span>
        } else {
<span class="nc" id="L888">            return &quot;Small Craft: &quot; + smallCraft.getDisplayName();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>