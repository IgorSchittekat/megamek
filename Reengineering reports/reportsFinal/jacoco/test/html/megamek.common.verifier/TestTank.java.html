<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestTank.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.verifier</a> &gt; <span class="el_source">TestTank.java</span></div><h1>TestTank.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

/*
 * Author: Reinhard Vicinus
 */

package megamek.common.verifier;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import megamek.common.*;
import megamek.common.annotations.Nullable;
import megamek.common.util.StringUtil;
import megamek.common.weapons.flamers.VehicleFlamerWeapon;
import megamek.common.weapons.lasers.CLChemicalLaserWeapon;

public class TestTank extends TestEntity {

    /**
     * Defines the maximum amount of armor a VTOL can mount on its rotor.
     */
<span class="nc" id="L39">    public static int VTOL_MAX_ROTOR_ARMOR = 2;</span>

    private final Tank tank;

    public TestTank(Tank tank, TestEntityOption options, String fileString) {
<span class="nc" id="L44">        super(options, tank.getEngine(), getArmor(tank), getStructure(tank));</span>
<span class="nc" id="L45">        this.tank = tank;</span>
<span class="nc" id="L46">        this.fileString = fileString;</span>
<span class="nc" id="L47">    }</span>

    protected static Structure getStructure(Tank tank) {
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (tank.isSupportVehicle()) {</span>
<span class="nc" id="L51">            return new SupportVeeStructure(tank);</span>
        }
<span class="nc" id="L53">        int type = EquipmentType.T_STRUCTURE_STANDARD;</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (tank.getStructureType() == 1) {</span>
<span class="nc" id="L55">            type = EquipmentType.T_STRUCTURE_ENDO_STEEL;</span>
        }
<span class="nc" id="L57">        return new Structure(type, tank.isSuperHeavy(), tank.getMovementMode());</span>
    }

    private static Armor[] getArmor(Tank tank) {
        Armor[] armor;
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!tank.hasPatchworkArmor()) {</span>
<span class="nc" id="L63">            armor = new Armor[1];</span>
<span class="nc" id="L64">            int type = tank.getArmorType(1);</span>
<span class="nc" id="L65">            int flag = 0;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (tank.isClanArmor(1)) {</span>
<span class="nc" id="L67">                flag |= Armor.CLAN_ARMOR;</span>
            }
<span class="nc" id="L69">            armor[0] = new Armor(type, flag);</span>
<span class="nc" id="L70">            return armor;</span>
        } else {
<span class="nc" id="L72">            armor = new Armor[tank.locations()];</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            for (int i = 0; i &lt; tank.locations(); i++) {</span>
<span class="nc" id="L74">                int type = tank.getArmorType(1);</span>
<span class="nc" id="L75">                int flag = 0;</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                if (tank.isClanArmor(1)) {</span>
<span class="nc" id="L77">                    flag |= Armor.CLAN_ARMOR;</span>
                }
<span class="nc" id="L79">                armor[i] = new Armor(type, flag);</span>
            }
        }
<span class="nc" id="L82">        return armor;</span>
    }

    /**
     * Filters all vehicle armor according to given tech constraints
     *
     * @param movementMode The vehicle movement mode
     * @param techManager  The tech constraints
     * @return             The armors legal for the unit
     */
    public static List&lt;EquipmentType&gt; legalArmorsFor(EntityMovementMode movementMode, ITechManager techManager) {
<span class="nc" id="L93">        List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        for (int at = 0; at &lt; EquipmentType.armorNames.length; at++) {</span>
<span class="nc bnc" id="L95" title="All 10 branches missed.">            if ((at == EquipmentType.T_ARMOR_PATCHWORK)</span>
                    || ((at == EquipmentType.T_ARMOR_HARDENED)
                            &amp;&amp; ((movementMode == EntityMovementMode.VTOL)
                            || (movementMode == EntityMovementMode.HOVER)
                            || (movementMode == EntityMovementMode.WIGE)))) {
<span class="nc" id="L100">                continue;</span>
            }
<span class="nc" id="L102">            String name = EquipmentType.getArmorTypeName(at, techManager.useClanTechBase());</span>
<span class="nc" id="L103">            EquipmentType eq = EquipmentType.get(name);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if ((null != eq)</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                    &amp;&amp; eq.hasFlag(MiscType.F_TANK_EQUIPMENT)</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    &amp;&amp; techManager.isLegal(eq)) {</span>
<span class="nc" id="L107">                retVal.add(eq);</span>
            }
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (techManager.useMixedTech()) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                name = EquipmentType.getArmorTypeName(at, !techManager.useClanTechBase());</span>
<span class="nc" id="L111">                EquipmentType eq2 = EquipmentType.get(name);</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">                if ((null != eq2) &amp;&amp; (eq != eq2)</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                        &amp;&amp; eq2.hasFlag(MiscType.F_TANK_EQUIPMENT)</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                        &amp;&amp; techManager.isLegal(eq2)) {</span>
<span class="nc" id="L115">                    retVal.add(eq2);</span>
                }
            }
        }
<span class="nc" id="L119">        return retVal;</span>
    }

    /**
     * Maximum construction weight by vehicle type
     *
     * @param mode        The vehicle's movement mode
     * @param superheavy  Whether the vehicle is superheavy
     * @return            The maximum construction tonnage
     */
    public static double maxTonnage(EntityMovementMode mode, boolean superheavy) {
<span class="nc bnc" id="L130" title="All 6 branches missed.">        switch(mode) {</span>
            case WHEELED:
            case WIGE:
<span class="nc bnc" id="L133" title="All 2 branches missed.">                return superheavy ? 160.0 : 80.0;</span>
            case HOVER:
<span class="nc bnc" id="L135" title="All 2 branches missed.">                return superheavy ? 100.0 : 50.0;</span>
            case VTOL:
<span class="nc bnc" id="L137" title="All 2 branches missed.">                return superheavy ? 60.0 : 30.0;</span>
            case NAVAL:
            case SUBMARINE:
<span class="nc bnc" id="L140" title="All 2 branches missed.">                return superheavy ? 555.0 : 300.0;</span>
            case HYDROFOIL:
<span class="nc" id="L142">                return 100.0; // not eligible for superheavy</span>
            case TRACKED:
            default:
<span class="nc bnc" id="L145" title="All 2 branches missed.">                return superheavy ? 200.0 : 100.0;</span>
        }
    }

    @Override
    public Entity getEntity() {
<span class="nc" id="L151">        return tank;</span>
    }

    @Override
    public boolean isTank() {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        return !(tank instanceof GunEmplacement);</span>
    }

    @Override
    public boolean isMech() {
<span class="nc" id="L161">        return false;</span>
    }

    @Override
    public boolean isAero() {
<span class="nc" id="L166">        return false;</span>
    }

    @Override
    public boolean isSmallCraft() {
<span class="nc" id="L171">        return false;</span>
    }
    
    @Override
    public boolean isAdvancedAerospace() {
<span class="nc" id="L176">        return false;</span>
    }

    @Override
    public boolean isProtomech() {
<span class="nc" id="L181">        return false;</span>
    }

    public double getTankWeightTurret() {
<span class="nc" id="L185">        double weight = 0;</span>

        // For omni vees, the base chassis sets a turret weight
<span class="nc bnc" id="L188" title="All 4 branches missed.">        if (tank.isOmni() &amp;&amp; tank.getBaseChassisTurretWeight() &gt;= 0) {</span>
<span class="nc" id="L189">            weight = tank.getBaseChassisTurretWeight();</span>
        } else {
            // For non-omnis, count up the weight of eq in the turret
<span class="nc bnc" id="L192" title="All 2 branches missed.">            for (Mounted m : tank.getEquipment()) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if ((m.getLocation() == tank.getLocTurret())</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                        &amp;&amp; !(m.getType() instanceof AmmoType)</span>
                        // Skip any patchwork armor mounts
<span class="nc bnc" id="L196" title="All 2 branches missed.">                        &amp;&amp; (EquipmentType.getArmorType(m.getType()) == EquipmentType.T_ARMOR_UNKNOWN)) {</span>
<span class="nc" id="L197">                    weight += m.getTonnage();</span>
                }
<span class="nc" id="L199">            }</span>
            // Turrets weight 10% of the weight of weapons in them
<span class="nc" id="L201">            weight = weight / 10.0f;</span>
        }

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (tank.isSupportVehicle()) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">            if (getEntity().getWeight() &lt; 5) {</span>
<span class="nc" id="L206">                return TestEntity.ceil(weight, Ceil.KILO);</span>
            } else {
<span class="nc" id="L208">                return TestEntity.ceil(weight, Ceil.HALFTON);</span>
            }
        } else {
<span class="nc" id="L211">            return TestEntity.ceilMaxHalf(weight, getWeightCeilingTurret());</span>
        }
    }

    public double getTankWeightDualTurret() {
<span class="nc" id="L216">        double weight = 0;</span>

        // For omni vees, the base chassis sets a turret weight
<span class="nc bnc" id="L219" title="All 4 branches missed.">        if (tank.isOmni() &amp;&amp; tank.getBaseChassisTurret2Weight() &gt;= 0) {</span>
<span class="nc" id="L220">            weight = tank.getBaseChassisTurret2Weight();</span>
        } else {
            // For non-omnis, count up the weight of eq in the turret
<span class="nc bnc" id="L223" title="All 2 branches missed.">            for (Mounted m : tank.getEquipment()) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                if ((m.getLocation() == tank.getLocTurret2())</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                        &amp;&amp; !(m.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L226">                    weight += m.getTonnage();</span>
                }
<span class="nc" id="L228">            }</span>
            // Turrets weight 10% of the weight of weapons in them
<span class="nc" id="L230">            weight = weight / 10.0f;</span>
        }
<span class="nc" id="L232">        return TestEntity.ceilMaxHalf(weight, getWeightCeilingTurret());</span>
    }

    public double getTankWeightLifting() {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        switch (tank.getMovementMode()) {</span>
            case HOVER:
            case VTOL:
            case HYDROFOIL:
            case SUBMARINE:
            case WIGE:
<span class="nc" id="L242">                return TestEntity.ceilMaxHalf(tank.getWeight() / 10.0f,</span>
<span class="nc" id="L243">                        getWeightCeilingLifting());</span>
            default:
<span class="nc" id="L245">                return 0f;</span>
        }
    }

    @Override
    public double getWeightMisc() {
<span class="nc" id="L251">        return getTankWeightTurret() + getTankWeightDualTurret() + getTankWeightLifting();</span>
    }

    @Override
    public double getWeightControls() {
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (tank.hasNoControlSystems()) {</span>
<span class="nc" id="L257">            return 0;</span>
        } else {
<span class="nc" id="L259">            return TestEntity.ceilMaxHalf(tank.getWeight() / 20.0f,</span>
<span class="nc" id="L260">                    getWeightCeilingControls());</span>
        }
    }

    @Override
    public boolean hasDoubleHeatSinks() {
        // tanks can't have DHS
<span class="nc" id="L267">        return false;</span>
    }

    @Override
    public int getCountHeatSinks() {
<span class="nc" id="L272">        return heatNeutralHSRequirement();</span>
    }

    @Override
    public double getWeightHeatSinks() {
<span class="nc" id="L277">        int heat = getCountHeatSinks();</span>
<span class="nc" id="L278">        heat -= engine.getWeightFreeEngineHeatSinks();</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (heat &lt; 0) {</span>
<span class="nc" id="L280">            heat = 0;</span>
        }
<span class="nc" id="L282">        return heat;</span>
    }

    @Override
    public String printWeightMisc() {
<span class="nc bnc" id="L287" title="All 2 branches missed.">        String turretString = !tank.hasNoTurret() ? StringUtil.makeLength(&quot;Turret:&quot;,</span>
<span class="nc" id="L288">                getPrintSize() - 5)</span>
<span class="nc" id="L289">                + TestEntity.makeWeightString(getTankWeightTurret()) + &quot;\n&quot; : &quot;&quot;;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        String dualTurretString = !tank.hasNoDualTurret() ? StringUtil.makeLength(&quot;Front Turret:&quot;,</span>
<span class="nc" id="L291">                getPrintSize() - 5)</span>
<span class="nc" id="L292">                + TestEntity.makeWeightString(getTankWeightDualTurret()) + &quot;\n&quot; : &quot;&quot;;</span>
<span class="nc" id="L293">        return turretString + dualTurretString</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                + (getTankWeightLifting() != 0 ? StringUtil.makeLength(</span>
<span class="nc" id="L295">                        &quot;Lifting Equip:&quot;, getPrintSize() - 5)</span>
<span class="nc" id="L296">                        + TestEntity.makeWeightString(getTankWeightLifting()) + &quot;\n&quot; : &quot;&quot;)</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                + (getWeightPowerAmp() != 0 ? StringUtil.makeLength(</span>
<span class="nc" id="L298">                        &quot;Power Amp:&quot;, getPrintSize() - 5)</span>
<span class="nc" id="L299">                        + TestEntity.makeWeightString(getWeightPowerAmp()) + &quot;\n&quot; : &quot;&quot;);</span>
    }

    @Override
    public String printWeightControls() {
<span class="nc" id="L304">        return StringUtil.makeLength(&quot;Controls:&quot;, getPrintSize() - 5)</span>
<span class="nc" id="L305">                + TestEntity.makeWeightString(getWeightControls()) + &quot;\n&quot;;</span>
    }

    @Override
    public double getWeightCarryingSpace() {
<span class="nc" id="L310">        return super.getWeightCarryingSpace() + tank.getExtraCrewSeats() * 0.5;</span>
    }

    public String printWeightCarryingSpace() {
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (tank.getExtraCrewSeats() &gt; 0) {</span>
<span class="nc" id="L315">            return super.printWeightCarryingSpace()</span>
<span class="nc" id="L316">                    + StringUtil.makeLength(&quot;Combat Seats:&quot;, getPrintSize() - 5)</span>
<span class="nc" id="L317">                    + TestEntity.makeWeightString(tank.getExtraCrewSeats() * 0.5) + &quot;\n&quot;;</span>
        } else {
<span class="nc" id="L319">            return super.printWeightCarryingSpace();</span>
        }
    }

    public Tank getTank() {
<span class="nc" id="L324">        return tank;</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff) {
<span class="nc" id="L329">        return correctEntity(buff, getEntity().getTechLevel());</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {
<span class="nc" id="L334">        boolean correct = true;</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (skip()) {</span>
<span class="nc" id="L336">            return true;</span>
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!correctWeight(buff)) {</span>
<span class="nc" id="L339">            buff.insert(0, printTechLevel() + printShortMovement());</span>
<span class="nc" id="L340">            buff.append(printWeightCalculation()).append(&quot;\n&quot;);</span>
<span class="nc" id="L341">            correct = false;</span>
        }
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (!engine.engineValid) {</span>
<span class="nc" id="L344">            buff.append(engine.problem.toString()).append(&quot;\n\n&quot;);</span>
<span class="nc" id="L345">            correct = false;</span>
        }
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (tank.getFreeSlots() &lt; 0) {</span>
<span class="nc" id="L348">            buff.append(&quot;Not enough item slots available! Using &quot;);</span>
<span class="nc" id="L349">            buff.append(Math.abs(tank.getFreeSlots()));</span>
<span class="nc" id="L350">            buff.append(&quot; slot(s) too many.\n&quot;);</span>
<span class="nc" id="L351">            buff.append(printSlotCalculation()).append(&quot;\n&quot;);</span>
<span class="nc" id="L352">            correct = false;</span>
        }
<span class="nc" id="L354">        int armorLimit = (int) (((tank.getWeight() * 7) / 2) + 40);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (tank.getTotalOArmor() &gt; armorLimit) {</span>
<span class="nc" id="L356">            buff.append(&quot;Armor exceeds point limit for &quot;);</span>
<span class="nc" id="L357">            buff.append(tank.getWeight());</span>
<span class="nc" id="L358">            buff.append(&quot;-ton vehicle: &quot;);</span>
<span class="nc" id="L359">            buff.append(tank.getTotalOArmor());</span>
<span class="nc" id="L360">            buff.append(&quot; points &gt; &quot;);</span>
<span class="nc" id="L361">            buff.append(armorLimit);</span>
<span class="nc" id="L362">            buff.append(&quot;.\n\n&quot;);</span>
<span class="nc" id="L363">            correct = false;</span>
        }
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (tank instanceof VTOL) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            if (!tank.hasWorkingMisc(MiscType.F_MAST_MOUNT)) {</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                for (Mounted m : tank.getEquipment()) {</span>
                    // Units with patchwork armor place any armor slots in the same location
                    // as the armor. This is for accounting convenience.
<span class="nc bnc" id="L370" title="All 2 branches missed.">                    if ((m.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                            &amp;&amp; EquipmentType.getArmorType(m.getType()) == EquipmentType.T_ARMOR_UNKNOWN) {</span>
<span class="nc" id="L372">                        buff.append(&quot;rotor equipment must be placed in mast mount&quot;);</span>
<span class="nc" id="L373">                        correct = false;</span>
                    }
<span class="nc" id="L375">                }</span>
            }
<span class="nc bnc" id="L377" title="All 2 branches missed.">            if (tank.getOArmor(VTOL.LOC_ROTOR) &gt; VTOL_MAX_ROTOR_ARMOR) {</span>
<span class="nc" id="L378">                buff.append(tank.getOArmor(VTOL.LOC_ROTOR));</span>
<span class="nc" id="L379">                buff.append(&quot; points of VTOL rotor armor exceed &quot;)</span>
<span class="nc" id="L380">                        .append(VTOL_MAX_ROTOR_ARMOR).append(&quot;-point limit.\n\n&quot;);</span>
<span class="nc" id="L381">                correct = false;</span>
            }
        }
<span class="nc bnc" id="L384" title="All 2 branches missed.">        for (Mounted m : tank.getEquipment()) {</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            if (!legalForMotiveType(m.getType(), tank.getMovementMode(), false)) {</span>
<span class="nc" id="L386">                buff.append(m.getType().getName()).append(&quot; is incompatible with &quot;)</span>
<span class="nc" id="L387">                        .append(tank.getMovementModeAsString());</span>
<span class="nc" id="L388">                correct = false;</span>
            }
<span class="nc" id="L390">        }</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">        for (Mounted m : tank.getMisc()) {</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_COMBAT_VEHICLE_ESCAPE_POD)) {</span>
<span class="nc bnc" id="L393" title="All 4 branches missed.">                if (m.getLocation() != (tank instanceof SuperHeavyTank?SuperHeavyTank.LOC_REAR:Tank.LOC_REAR)) {</span>
<span class="nc" id="L394">                    buff.append(&quot;combat vehicle escape pod must be placed in rear&quot;);</span>
<span class="nc" id="L395">                    correct = false;</span>
                }
<span class="nc bnc" id="L397" title="All 6 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MASC) &amp;&amp; m.getType().hasSubType(MiscType.S_SUPERCHARGER)</span>
                    &amp;&amp; (tank instanceof VTOL)) {
<span class="nc" id="L399">                buff.append(&quot;VTOLS cannot mount superchargers.&quot;);</span>
<span class="nc" id="L400">                correct = false;</span>
            }
<span class="nc" id="L402">        }</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        for (int loc = 0; loc &lt; tank.locations(); loc++) {</span>
<span class="nc" id="L404">            int count = 0;</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            for (Mounted misc : tank.getMisc()) {</span>
<span class="nc bnc" id="L406" title="All 4 branches missed.">                if ((misc.getLocation() == loc) &amp;&amp; misc.getType().hasFlag(MiscType.F_MANIPULATOR)) {</span>
<span class="nc" id="L407">                    count++;</span>
                }
<span class="nc" id="L409">            }</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (count &gt; 2) {</span>
<span class="nc" id="L411">                buff.append(&quot;max of 2 manipulators per location&quot;);</span>
<span class="nc" id="L412">                correct = false;</span>
<span class="nc" id="L413">                break;</span>
            }
        }

<span class="nc bnc" id="L417" title="All 4 branches missed.">        if (showFailedEquip() &amp;&amp; hasFailedEquipment(buff)) {</span>
<span class="nc" id="L418">            correct = false;</span>
        }
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (hasIllegalTechLevels(buff, ammoTechLvl)) {</span>
<span class="nc" id="L421">            correct = false;</span>
        }
<span class="nc bnc" id="L423" title="All 4 branches missed.">        if (showIncorrectIntroYear() &amp;&amp; hasIncorrectIntroYear(buff)) {</span>
<span class="nc" id="L424">            correct = false;</span>
        }
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (hasIllegalEquipmentCombinations(buff)) {</span>
<span class="nc" id="L427">            correct = false;</span>
        }
<span class="nc bnc" id="L429" title="All 2 branches missed.">        if (!correctCriticals(buff)) {</span>
<span class="nc" id="L430">            correct = false;</span>
        }
<span class="nc" id="L432">        return correct;</span>
    }

    /**
     * Checks whether the equipment is compatible with the vehicle's motive type
     *
     * @param eq            The equipment to check
     * @param mode          The vehicle's motive type
     * @param supporVehicle Whether the vehicle is a support vehicle.
     * @return              Whether the equipment and motive type are compatible
     */
    public static boolean legalForMotiveType(EquipmentType eq, EntityMovementMode mode, boolean supporVehicle) {
        // A couple broad categories for convenience
<span class="nc bnc" id="L445" title="All 2 branches missed.">        final boolean isNaval = mode.equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                || mode.equals(EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                || mode.equals(EntityMovementMode.SUBMARINE);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">        final boolean isAero = mode.equals(EntityMovementMode.AERODYNE)</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                || mode.equals(EntityMovementMode.AIRSHIP)</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                || mode.equals(EntityMovementMode.STATION_KEEPING);</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (eq instanceof MiscType) {</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_FLOTATION_HULL)) {</span>
                // Per errata, WiGE vehicles automatically include flotation hull
<span class="nc bnc" id="L454" title="All 4 branches missed.">                return mode.equals(EntityMovementMode.HOVER) || mode.equals(EntityMovementMode.VTOL);</span>
            }
<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_FULLY_AMPHIBIOUS)</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_LIMITED_AMPHIBIOUS)</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_BULLDOZER)</span>
<span class="nc bnc" id="L459" title="All 4 branches missed.">                    || (eq.hasFlag(MiscType.F_CLUB) &amp;&amp; eq.hasSubType(MiscType.S_COMBINE))) {</span>
<span class="nc bnc" id="L460" title="All 4 branches missed.">                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED);</span>
            }
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_DUNE_BUGGY)) {</span>
<span class="nc" id="L463">                return mode.equals(EntityMovementMode.WHEELED);</span>
            }
            // Submarines have environmental sealing as part of their base construction
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                return !mode.equals(EntityMovementMode.SUBMARINE);</span>
            }
<span class="nc bnc" id="L469" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_JUMP_JET)</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_VEEDC)</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">                    || (eq.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">                    &amp;&amp; eq.hasSubType(MiscType.S_CHAINSAW | MiscType.S_DUAL_SAW | MiscType.S_MINING_DRILL))) {</span>
<span class="nc bnc" id="L473" title="All 4 branches missed.">                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">                        || mode.equals(EntityMovementMode.HOVER) || mode.equals(EntityMovementMode.WIGE);</span>
            }
<span class="nc bnc" id="L476" title="All 4 branches missed.">            if (eq.hasFlag(MiscType.F_MINESWEEPER) || eq.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                    &amp;&amp; eq.hasSubType(MiscType.S_PILE_DRIVER)) {</span>
<span class="nc bnc" id="L478" title="All 6 branches missed.">                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED)</span>
                        || isNaval;
            }
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_HITCH)) {</span>
<span class="nc bnc" id="L482" title="All 4 branches missed.">                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L483" title="All 4 branches missed.">                        || mode.equals(EntityMovementMode.RAIL) || mode.equals(EntityMovementMode.MAGLEV);</span>
            }
<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_LIFEBOAT)) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                if (eq.hasSubType(MiscType.S_MARITIME_ESCAPE_POD | MiscType.S_MARITIME_LIFEBOAT)) {</span>
                    // Allowed for all naval units and support vehicles with an amphibious chassis mod
<span class="nc bnc" id="L488" title="All 6 branches missed.">                    return supporVehicle ? !mode.equals(EntityMovementMode.HOVER) : !isNaval;</span>
                } else {
<span class="nc" id="L490">                    return isAero;</span>
                }
            }
<span class="nc bnc" id="L493" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L496" title="All 4 branches missed.">                    || (eq.hasFlag(MiscType.F_MASC) &amp;&amp; eq.hasSubType(MiscType.S_SUPERCHARGER))</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                    || (eq.hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                    &amp;&amp; eq.hasSubType(MiscType.S_BACKHOE | MiscType.S_ROCK_CUTTER</span>
                    | MiscType.S_SPOT_WELDER | MiscType.S_WRECKING_BALL))) {
<span class="nc bnc" id="L500" title="All 4 branches missed.">                return !mode.equals(EntityMovementMode.VTOL) &amp;&amp; !isAero;</span>
            }
<span class="nc bnc" id="L502" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_AP_POD)) {</span>
<span class="nc bnc" id="L503" title="All 4 branches missed.">                return !isNaval &amp;&amp; !isAero;</span>
            }
<span class="nc bnc" id="L505" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">                return !isAero</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                        &amp;&amp; !mode.equals(EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                        &amp;&amp; !mode.equals(EntityMovementMode.RAIL)</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                        &amp;&amp; !mode.equals(EntityMovementMode.MAGLEV);</span>
            }
<span class="nc bnc" id="L511" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_MASH)) {</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                return !mode.equals(EntityMovementMode.VTOL);</span>
            }
<span class="nc bnc" id="L514" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_SPONSON_TURRET)</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_LADDER)) {</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                return !isAero;</span>
            }
<span class="nc bnc" id="L518" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_PINTLE_TURRET)) {</span>
<span class="nc bnc" id="L519" title="All 4 branches missed.">                return !isNaval &amp;&amp; !mode.equals(EntityMovementMode.AERODYNE)</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                        &amp;&amp; !mode.equals(EntityMovementMode.STATION_KEEPING);</span>
            }
<span class="nc bnc" id="L522" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_LOOKDOWN_RADAR)</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_INFRARED_IMAGER)</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_HIRES_IMAGER)) {</span>
<span class="nc bnc" id="L525" title="All 4 branches missed.">                return isAero || mode.equals(EntityMovementMode.VTOL);</span>
            }
<span class="nc bnc" id="L527" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_REFUELING_DROGUE)) {</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                return mode.equals(EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                        || mode.equals(EntityMovementMode.AERODYNE)</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">                        || mode.equals(EntityMovementMode.AIRSHIP);</span>
            }
<span class="nc bnc" id="L532" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_SASRCS)</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_LIGHT_SAIL)</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_SPACE_MINE_DISPENSER)</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_SMALL_COMM_SCANNER_SUITE)) {</span>
<span class="nc" id="L536">                return mode.equals(EntityMovementMode.STATION_KEEPING);</span>
            }
<span class="nc bnc" id="L538" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_VEHICLE_MINE_DISPENSER)) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                return !mode.equals(EntityMovementMode.STATION_KEEPING);</span>
            }
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_EXTERNAL_STORES_HARDPOINT)) {</span>
<span class="nc" id="L542">                return mode.equals(EntityMovementMode.AERODYNE);</span>
            }
<span class="nc bnc" id="L544" title="All 2 branches missed.">        } else if (eq instanceof WeaponType) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">            if (((WeaponType) eq).getAmmoType() == AmmoType.T_BPOD) {</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                return !isNaval;</span>
            }
<span class="nc bnc" id="L548" title="All 2 branches missed.">            if (((WeaponType) eq).getAmmoType() == AmmoType.T_NAIL_RIVET_GUN) {</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                return !mode.equals(EntityMovementMode.VTOL);</span>
            }
        }
<span class="nc" id="L552">        return true;</span>
    }

    @Override
    public boolean correctWeight(StringBuffer buff, boolean showO, boolean showU) {
<span class="nc" id="L557">        boolean correct = super.correctWeight(buff, showO, showU);</span>
<span class="nc" id="L558">        double max = maxTonnage(getEntity().getMovementMode(), getEntity().isSuperHeavy());</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">        if (getEntity().getWeight() &gt; max) {</span>
<span class="nc" id="L560">            correct = false;</span>
<span class="nc" id="L561">            buff.append(&quot;Exceeds maximum tonnage of &quot;).append(max).append(&quot; for &quot;)</span>
<span class="nc" id="L562">                    .append(getEntity().getMovementModeAsString())</span>
<span class="nc" id="L563">                    .append(&quot; combat vehicle.\n&quot;);</span>
        }
<span class="nc" id="L565">        return correct;</span>
    }

    public boolean correctCriticals(StringBuffer buff) {
<span class="nc" id="L569">        List&lt;Mounted&gt; unallocated = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L570">        boolean correct = true;</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">        for (Mounted mount : tank.getMisc()) {</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">            if (mount.getLocation() == Entity.LOC_NONE &amp;&amp; !(mount.getCriticals() == 0)) {</span>
<span class="nc" id="L574">                unallocated.add(mount);</span>
            }
<span class="nc" id="L576">        }</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        for (Mounted mount : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">            if (mount.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L579">                unallocated.add(mount);</span>
            }
<span class="nc" id="L581">        }</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">        for (Mounted mount : tank.getAmmo()) {</span>
<span class="nc" id="L583">            int ammoType = ((AmmoType)mount.getType()).getAmmoType();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            if ((mount.getLocation() == Entity.LOC_NONE) &amp;&amp;</span>
<span class="nc bnc" id="L585" title="All 4 branches missed.">                    (mount.getUsableShotsLeft() &gt; 1</span>
                            || ammoType == AmmoType.T_CRUISE_MISSILE )) {
<span class="nc" id="L587">                unallocated.add(mount);</span>
            }
<span class="nc" id="L589">        }</span>

<span class="nc bnc" id="L591" title="All 2 branches missed.">        if (!unallocated.isEmpty()) {</span>
<span class="nc" id="L592">            buff.append(&quot;Unallocated Equipment:\n&quot;);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">            for (Mounted mount : unallocated) {</span>
<span class="nc" id="L594">                buff.append(mount.getType().getInternalName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L595">            }</span>
<span class="nc" id="L596">            correct = false;</span>
        }

<span class="nc" id="L599">        return correct;</span>
    }

    @Override
    public StringBuffer printEntity() {
<span class="nc" id="L604">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L605">        buff.append(&quot;Tank: &quot;).append(tank.getDisplayName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L606">        buff.append(&quot;Found in: &quot;).append(fileString).append(&quot;\n&quot;);</span>
<span class="nc" id="L607">        buff.append(printTechLevel());</span>
<span class="nc" id="L608">        buff.append(&quot;Intro year: &quot;).append(tank.getYear()).append(&quot;\n&quot;);</span>
<span class="nc" id="L609">        buff.append(printSource());</span>
<span class="nc" id="L610">        buff.append(printShortMovement());</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (correctWeight(buff, true, true)) {</span>
<span class="nc" id="L612">            buff.append(&quot;Weight: &quot;).append(getWeight()).append(&quot; (&quot;).append(</span>
<span class="nc" id="L613">                    calculateWeight()).append(&quot;)\n&quot;);</span>
        }

<span class="nc" id="L616">        buff.append(printWeightCalculation()).append(&quot;\n&quot;);</span>
<span class="nc" id="L617">        printFailedEquipment(buff);</span>
<span class="nc" id="L618">        return buff;</span>
    }
    
    public StringBuffer printSlotCalculation() {
<span class="nc" id="L622">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L623">        buff.append(&quot;Available slots: &quot;).append(tank.getTotalSlots()).append(&quot;\n&quot;);</span>
        // different engines take different amounts of slots
<span class="nc" id="L625">        int engineSlots = 0;</span>
<span class="nc bnc" id="L626" title="All 4 branches missed.">        if (tank.hasEngine() &amp;&amp; tank.getEngine().isFusion()) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">            if (tank.getEngine().getEngineType() == Engine.LIGHT_ENGINE) {</span>
<span class="nc" id="L628">                engineSlots = 1;</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">            } else if (tank.getEngine().getEngineType() == Engine.XL_ENGINE) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">                engineSlots = tank.getEngine().hasFlag(Engine.CLAN_ENGINE)? 1 : 2;</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            } else if (tank.getEngine().getEngineType() == Engine.XXL_ENGINE) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                engineSlots = tank.getEngine().hasFlag(Engine.CLAN_ENGINE)? 2 : 4;</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            } else if (tank.getEngine().getEngineType() == Engine.COMPACT_ENGINE) {</span>
<span class="nc" id="L634">                engineSlots--;</span>
            }
            
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (tank.getEngine().getEngineType() == Engine.LARGE_ENGINE) {</span>
<span class="nc" id="L638">                engineSlots++;</span>
            }
        }
<span class="nc bnc" id="L641" title="All 2 branches missed.">        if (engineSlots != 0) {</span>
<span class="nc" id="L642">            buff.append(StringUtil.makeLength(tank.getEngine().getEngineName(), 30));</span>
<span class="nc" id="L643">            buff.append(engineSlots).append(&quot;\n&quot;);</span>
        }

        // JJs take just 1 slot
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (tank.getJumpMP(false) &gt; 0) {</span>
<span class="nc" id="L648">            buff.append(StringUtil.makeLength(&quot;Jump Jets&quot;, 30)).append(&quot;1\n&quot;);</span>
        }

<span class="nc" id="L651">        boolean addedCargo = false;</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">        for (Mounted mount : tank.getEquipment()) {</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">            if ((mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                    &amp;&amp; mount.getType().hasFlag(MiscType.F_CARGO)) {</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                if (!addedCargo) {</span>
<span class="nc" id="L656">                    buff.append(StringUtil.makeLength(mount.getName(), 30));</span>
<span class="nc" id="L657">                    buff.append(mount.getType().getTankSlots(tank)).append(&quot;\n&quot;);</span>
<span class="nc" id="L658">                    addedCargo = true;</span>
<span class="nc" id="L659">                    continue;</span>
                } else {
                    continue;
                }
            }
<span class="nc bnc" id="L664" title="All 2 branches missed.">            if (!((mount.getType() instanceof AmmoType) || Arrays.asList(</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">                    EquipmentType.armorNames).contains(</span>
<span class="nc" id="L666">                    mount.getType().getName()))) {</span>
<span class="nc" id="L667">                buff.append(StringUtil.makeLength(mount.getName(), 30));</span>
<span class="nc" id="L668">                buff.append(mount.getType().getTankSlots(tank)).append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L670">        }</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (tank.getExtraCrewSeats() &gt; 0) {</span>
<span class="nc" id="L672">            buff.append(StringUtil.makeLength(&quot;Combat Crew Seats:&quot;, 30));</span>
<span class="nc" id="L673">            buff.append(tank.getExtraCrewSeats()).append(&quot;\n&quot;);</span>
        }
        // different armor types take different amount of slots
<span class="nc" id="L676">        int armorSlots = 0;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (!tank.hasPatchworkArmor()) {</span>
<span class="nc" id="L678">            int type = tank.getArmorType(1);</span>
<span class="nc bnc" id="L679" title="All 6 branches missed.">            switch (type) {</span>
                case EquipmentType.T_ARMOR_FERRO_FIBROUS:
<span class="nc bnc" id="L681" title="All 2 branches missed.">                    if (TechConstants.isClan(tank.getArmorTechLevel(1))) {</span>
<span class="nc" id="L682">                        armorSlots++;</span>
                    } else {
<span class="nc" id="L684">                        armorSlots += 2;</span>
                    }
<span class="nc" id="L686">                    break;</span>
                case EquipmentType.T_ARMOR_HEAVY_FERRO:
<span class="nc" id="L688">                    armorSlots += 3;</span>
<span class="nc" id="L689">                    break;</span>
                case EquipmentType.T_ARMOR_LIGHT_FERRO:
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_HARDENED:
<span class="nc" id="L694">                    armorSlots++;</span>
<span class="nc" id="L695">                    break;</span>
                case EquipmentType.T_ARMOR_STEALTH:
<span class="nc" id="L697">                    armorSlots += 2;</span>
<span class="nc" id="L698">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
<span class="nc bnc" id="L700" title="All 2 branches missed.">                    if (TechConstants.isClan(tank.getArmorTechLevel(1))) {</span>
<span class="nc" id="L701">                        armorSlots++;</span>
                    } else {
<span class="nc" id="L703">                        armorSlots += 2;</span>
                    }
<span class="nc" id="L705">                    break;</span>
                default:
                    break;
            }
<span class="nc bnc" id="L709" title="All 2 branches missed.">            if (armorSlots != 0) {</span>
<span class="nc" id="L710">                buff.append(StringUtil.makeLength(EquipmentType.getArmorTypeName(type,</span>
<span class="nc" id="L711">                        TechConstants.isClan(tank.getArmorTechLevel(1))), 30));</span>
<span class="nc" id="L712">                buff.append(armorSlots).append(&quot;\n&quot;);</span>
            }
        }

        // for ammo, each type of ammo takes one slots, regardless of
        // submunition type
<span class="nc" id="L718">        Map&lt;String, Boolean&gt; foundAmmo = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">        for (Mounted ammo : tank.getAmmo()) {</span>
            // don't count oneshot ammo
<span class="nc bnc" id="L721" title="All 2 branches missed.">            if ((ammo.getLocation() == Entity.LOC_NONE)</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">                    &amp;&amp; (ammo.getBaseShotsLeft() == 1)) {</span>
<span class="nc" id="L723">                continue;</span>
            }
<span class="nc" id="L725">            AmmoType at = (AmmoType) ammo.getType();</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">            if (foundAmmo.get(at.getAmmoType() + &quot;:&quot; + at.getRackSize()) == null) {</span>
<span class="nc" id="L727">                buff.append(StringUtil.makeLength(at.getName(), 30));</span>
<span class="nc" id="L728">                buff.append(&quot;1\n&quot;);</span>
<span class="nc" id="L729">                foundAmmo.put(at.getAmmoType() + &quot;:&quot; + at.getRackSize(), true);</span>
            }
<span class="nc" id="L731">        }</span>
        // if a tank has an infantry bay, add 1 slots (multiple bays take 1 slot
        // total)
<span class="nc" id="L734">        boolean infantryBayCounted = false;</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">        for (Transporter transport : tank.getTransports()) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (transport instanceof TroopSpace) {</span>
<span class="nc" id="L737">                buff.append(StringUtil.makeLength(&quot;Troop Space&quot;, 30));</span>
<span class="nc" id="L738">                buff.append(&quot;1\n&quot;);</span>
<span class="nc" id="L739">                infantryBayCounted = true;</span>
<span class="nc" id="L740">                break;</span>
            }
<span class="nc" id="L742">        }</span>
        // unit transport bays take 1 slot each
<span class="nc bnc" id="L744" title="All 2 branches missed.">        for (Bay bay : tank.getTransportBays()) {</span>
<span class="nc bnc" id="L745" title="All 6 branches missed.">            if (((bay instanceof BattleArmorBay) || (bay instanceof InfantryBay))</span>
                    &amp;&amp; !infantryBayCounted) {
<span class="nc" id="L747">                buff.append(StringUtil.makeLength(&quot;Infantry Bay&quot;, 30));</span>
<span class="nc" id="L748">                buff.append(&quot;1&quot;).append(&quot;\n&quot;);</span>
<span class="nc" id="L749">                infantryBayCounted = true;</span>
            } else {
<span class="nc" id="L751">                buff.append(StringUtil.makeLength(&quot;Transport Bay&quot;, 30));</span>
<span class="nc" id="L752">                buff.append(&quot;1&quot;).append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L754">        }        </span>
<span class="nc" id="L755">        return buff;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L760">        return &quot;Tank: &quot; + tank.getDisplayName();</span>
    }

    @Override
    public double getWeightPowerAmp() {
<span class="nc bnc" id="L765" title="All 4 branches missed.">        if (getEntity().isSupportVehicle() &amp;&amp; (getEntity().getWeight() &lt; 5)) {</span>
<span class="nc" id="L766">            return 0;</span>
        }
    	
<span class="nc bnc" id="L769" title="All 4 branches missed.">        if (!engine.isFusion() &amp;&amp; (engine.getEngineType() != Engine.FISSION)) {</span>
<span class="nc" id="L770">            double weight = 0;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            for (Mounted m : tank.getWeaponList()) {</span>
<span class="nc" id="L772">                WeaponType wt = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L773" title="All 6 branches missed.">                if (wt.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !(wt instanceof CLChemicalLaserWeapon) &amp;&amp; !(wt instanceof VehicleFlamerWeapon)) {</span>
<span class="nc" id="L774">                    weight += m.getTonnage();</span>
                }
<span class="nc bnc" id="L776" title="All 4 branches missed.">                if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof</span>
<span class="nc" id="L777">                        MiscType) &amp;&amp; m.getLinkedBy().getType().</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">                        hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc" id="L779">                    weight += m.getLinkedBy().getTonnage();</span>
                }
<span class="nc" id="L781">            }</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">            for (Mounted m : tank.getMisc()) {</span>
<span class="nc bnc" id="L783" title="All 4 branches missed.">                if (m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; m.getType().hasSubType(MiscType.S_SPOT_WELDER)) {</span>
<span class="nc" id="L784">                    weight += m.getTonnage();</span>
                }
<span class="nc" id="L786">            }</span>
<span class="nc" id="L787">            return TestEntity.ceil(weight / 10, getWeightCeilingPowerAmp());</span>
        }
<span class="nc" id="L789">        return 0;</span>
    }
    
    /**
     * Check if the unit has combinations of equipment which are not allowed in
     * the construction rules.
     *
     * @param buff
     *            diagnostics are appended to this
     * @return true if the entity is illegal
     */
    @Override
    public boolean hasIllegalEquipmentCombinations(StringBuffer buff) {
<span class="nc" id="L802">        boolean illegal = super.hasIllegalEquipmentCombinations(buff);</span>
        
<span class="nc" id="L804">        boolean hasSponsonTurret = false;</span>

<span class="nc bnc" id="L806" title="All 2 branches missed.">        for (Mounted m : getEntity().getMisc()) {</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_SPONSON_TURRET)) {</span>
<span class="nc" id="L808">                hasSponsonTurret = true;</span>
            }
<span class="nc" id="L810">        }</span>
        
<span class="nc bnc" id="L812" title="All 2 branches missed.">        for (Mounted m : getEntity().getMisc()) {</span>
<span class="nc" id="L813">            final MiscType misc = (MiscType)m.getType();</span>
            
<span class="nc bnc" id="L815" title="All 2 branches missed.">            if (misc.hasFlag(MiscType.F_JUMP_JET)) {</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">                if (hasSponsonTurret) {</span>
<span class="nc" id="L817">                    buff.append(&quot;can't combine vehicular jump jets and sponson turret\n&quot;);</span>
<span class="nc" id="L818">                    illegal = true;</span>
                }
<span class="nc bnc" id="L820" title="All 2 branches missed.">                if ((getEntity().getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">                        &amp;&amp; (getEntity().getMovementMode() != EntityMovementMode.WHEELED)</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">                        &amp;&amp; (getEntity().getMovementMode() != EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">                        &amp;&amp; (getEntity().getMovementMode() != EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L824">                    buff.append(&quot;jump jets only possible on vehicles with hover, wheeled, tracked, or Wing-in-Ground Effect movement mode\n&quot;);</span>
<span class="nc" id="L825">                    illegal = true;</span>
                }
            }
<span class="nc" id="L828">        }</span>

<span class="nc bnc" id="L830" title="All 2 branches missed.">        if ((tank.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                || (tank.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                || (tank.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">            for (int i = 0; i &lt; tank.locations(); i++) {</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                if (tank.getArmorType(i) == EquipmentType.T_ARMOR_HARDENED) {</span>
<span class="nc" id="L835">                    buff.append(&quot;Hardened armor can't be mounted on WiGE/Hover/Wheeled vehicles\n&quot;);</span>
<span class="nc" id="L836">                    illegal = true;</span>
                }
            }
        }
        
        // Ensure that omni tank turrets aren't overloaded
<span class="nc bnc" id="L842" title="All 2 branches missed.">        if (tank.isOmni()) {</span>
            // Check to see if the base chassis turret weight is set
<span class="nc" id="L844">            double turretWeight = 0;</span>
<span class="nc" id="L845">            double turret2Weight = 0;</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">            for (Mounted m : tank.getEquipment()) {</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">                if ((m.getLocation() == tank.getLocTurret2())</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">                        &amp;&amp; !(m.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L849">                    turret2Weight += m.getTonnage();</span>
                }
<span class="nc bnc" id="L851" title="All 2 branches missed.">                if ((m.getLocation() == tank.getLocTurret())</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                        &amp;&amp; !(m.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L853">                    turretWeight += m.getTonnage();</span>
                }
<span class="nc" id="L855">            }</span>
<span class="nc" id="L856">            turretWeight *= 0.1;</span>
<span class="nc" id="L857">            turret2Weight *= 0.1;</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">            if (tank.isSupportVehicle()) {</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">                if (getEntity().getWeight() &lt; 5) {</span>
<span class="nc" id="L860">                    turretWeight = TestEntity.ceil(turretWeight, Ceil.KILO);</span>
<span class="nc" id="L861">                    turret2Weight = TestEntity.ceil(turret2Weight, Ceil.KILO);</span>
                } else {
<span class="nc" id="L863">                    turretWeight = TestEntity.ceil(turretWeight, Ceil.HALFTON);</span>
<span class="nc" id="L864">                    turret2Weight = TestEntity.ceil(turret2Weight, Ceil.HALFTON);</span>
                }
            } else {
<span class="nc" id="L867">                turretWeight = TestEntity.ceil(turretWeight,</span>
<span class="nc" id="L868">                        getWeightCeilingTurret());</span>
<span class="nc" id="L869">                turret2Weight = TestEntity.ceil(turret2Weight,</span>
<span class="nc" id="L870">                        getWeightCeilingTurret());</span>
            }
<span class="nc bnc" id="L872" title="All 2 branches missed.">            if ((tank.getBaseChassisTurretWeight() &gt;= 0)</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">                    &amp;&amp; (turretWeight &gt; tank.getBaseChassisTurretWeight())) {</span>
<span class="nc" id="L874">                buff.append(&quot;Unit has more weight in the turret than allowed &quot;)</span>
<span class="nc" id="L875">                        .append(&quot;by base chassis!  Current weight: &quot;)</span>
<span class="nc" id="L876">                        .append(turretWeight)</span>
<span class="nc" id="L877">                        .append(&quot;, base chassis turret weight: &quot;)</span>
<span class="nc" id="L878">                        .append(tank.getBaseChassisTurretWeight()).append(&quot;\n&quot;);</span>
<span class="nc" id="L879">                illegal = true;</span>
            }
<span class="nc bnc" id="L881" title="All 2 branches missed.">            if ((tank.getBaseChassisTurret2Weight() &gt;= 0)</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                    &amp;&amp; (turret2Weight &gt; tank.getBaseChassisTurret2Weight())) {</span>
<span class="nc" id="L883">                buff.append(&quot;Unit has more weight in the second turret than &quot;)</span>
<span class="nc" id="L884">                        .append(&quot;allowed by base chassis!  Current weight: &quot;)</span>
<span class="nc" id="L885">                        .append(turret2Weight).append(&quot;, base chassis turret weight: &quot;)</span>
<span class="nc" id="L886">                        .append(tank.getBaseChassisTurret2Weight()).append(&quot;\n&quot;);</span>
<span class="nc" id="L887">                illegal = true;</span>
            }
        }
        
<span class="nc" id="L891">        return illegal;</span>
    }

    /**
     * @param tank      The Tank
     * @param eq        The equipment
     * @param location  A location index on the Entity
     * @param buffer    If non-null and the location is invalid, will be appended with an explanation
     * @return          Whether the equipment can be mounted in the location on the Tank
     */
    public static boolean isValidTankLocation(Tank tank, EquipmentType eq, int location,
                                              @Nullable StringBuffer buffer) {
<span class="nc bnc" id="L903" title="All 4 branches missed.">        if (isBodyEquipment(eq) &amp;&amp; (location != Tank.LOC_BODY)) {</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">            if (buffer != null) {</span>
<span class="nc" id="L905">                buffer.append(eq.getName()).append(&quot; must be mounted in the body.\n&quot;);</span>
            }
<span class="nc" id="L907">            return false;</span>
        }
        final boolean isRearLocation;
        final boolean isTurretLocation;
        // SuperHeavyTank and LargeSupportTank have the same location indices.
<span class="nc bnc" id="L912" title="All 4 branches missed.">        if ((tank instanceof SuperHeavyTank) || (tank instanceof LargeSupportTank)) {</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">            isRearLocation = location == SuperHeavyTank.LOC_REAR;</span>
<span class="nc bnc" id="L914" title="All 4 branches missed.">            isTurretLocation = (location == SuperHeavyTank.LOC_TURRET) || (location == SuperHeavyTank.LOC_TURRET_2);</span>
        } else {
<span class="nc bnc" id="L916" title="All 2 branches missed.">            isRearLocation = location == Tank.LOC_REAR;</span>
<span class="nc bnc" id="L917" title="All 4 branches missed.">            isTurretLocation = (location == Tank.LOC_TURRET) || (location == Tank.LOC_TURRET_2);</span>
        }
<span class="nc bnc" id="L919" title="All 2 branches missed.">        if (eq instanceof MiscType) {</span>
            // Equipment explicitly forbidden to a mast mount
<span class="nc bnc" id="L921" title="All 4 branches missed.">            if ((eq.hasFlag(MiscType.F_MODULAR_ARMOR) || eq.hasFlag(MiscType.F_HARJEL)</span>
<span class="nc bnc" id="L922" title="All 4 branches missed.">                    || eq.hasFlag(MiscType.F_LIGHT_FLUID_SUCTION_SYSTEM) || eq.hasFlag(MiscType.F_LIFTHOIST)</span>
<span class="nc bnc" id="L923" title="All 4 branches missed.">                    || eq.hasFlag(MiscType.F_MANIPULATOR) || eq.hasFlag(MiscType.F_FLUID_SUCTION_SYSTEM)</span>
<span class="nc bnc" id="L924" title="All 8 branches missed.">                    || eq.hasFlag(MiscType.F_LIGHT_FLUID_SUCTION_SYSTEM) || eq.hasFlag(MiscType.F_SPRAYER))</span>
                    &amp;&amp; (tank instanceof VTOL) &amp;&amp; (location == VTOL.LOC_ROTOR)) {
<span class="nc bnc" id="L926" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L927">                    buffer.append(eq.getName()).append(&quot; cannot be mounted in the rotor.\n&quot;);</span>
                }
<span class="nc" id="L929">                return false;</span>
            }
<span class="nc bnc" id="L931" title="All 4 branches missed.">            if ((eq.hasFlag(MiscType.F_HARJEL) || eq.hasFlag(MiscType.F_LIGHT_FLUID_SUCTION_SYSTEM)</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_SPRAYER)</span>
<span class="nc bnc" id="L933" title="All 6 branches missed.">                    || (eq.hasFlag(MiscType.F_LIFTHOIST) &amp;&amp; !(tank instanceof VTOL)))</span>
                    &amp;&amp; (location == Tank.LOC_BODY)) {
<span class="nc bnc" id="L935" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L936">                    buffer.append(eq.getName()).append(&quot; cannot be mounted in the body.\n&quot;);</span>
                }
<span class="nc" id="L938">                return false;</span>
            }
<span class="nc bnc" id="L940" title="All 6 branches missed.">            if (eq.hasFlag(MiscType.F_BULLDOZER) &amp;&amp; ((location != Tank.LOC_FRONT) &amp;&amp; (location != Tank.LOC_REAR))) {</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L942">                    buffer.append(eq.getName()).append(&quot; must be mounted on the front or rear.\n&quot;);</span>
                }
<span class="nc" id="L944">                return false;</span>
            }
<span class="nc bnc" id="L946" title="All 8 branches missed.">            if (eq.hasFlag(MiscType.F_CLUB) &amp;&amp; eq.hasSubType(MiscType.S_PILE_DRIVER)</span>
                    &amp;&amp; (location != Tank.LOC_FRONT) &amp;&amp; !isRearLocation) {
<span class="nc bnc" id="L948" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L949">                    buffer.append(eq.getName()).append(&quot; must be mounted on the front or rear.\n&quot;);</span>
                }
<span class="nc" id="L951">                return false;</span>
            }
<span class="nc bnc" id="L953" title="All 6 branches missed.">            if (eq.hasFlag(MiscType.F_CLUB) &amp;&amp; eq.hasSubType(MiscType.S_WRECKING_BALL) &amp;&amp; !isTurretLocation) {</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L955">                    buffer.append(eq.getName()).append(&quot; must be mounted on a turret.\n&quot;);</span>
                }
<span class="nc" id="L957">                return false;</span>
            }
<span class="nc bnc" id="L959" title="All 10 branches missed.">            if (eq.hasFlag(MiscType.F_CLUB) &amp;&amp; !eq.hasSubType(MiscType.S_PILE_DRIVER | MiscType.S_SPOT_WELDER</span>
                    | MiscType.S_WRECKING_BALL)
                    &amp;&amp; (location != Tank.LOC_FRONT) &amp;&amp; !isRearLocation &amp;&amp; !isTurretLocation) {
<span class="nc bnc" id="L962" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L963">                    buffer.append(eq.getName()).append(&quot; must be mounted on the front, rear, or turret.\n&quot;);</span>
                }
<span class="nc" id="L965">                return false;</span>
            }
<span class="nc bnc" id="L967" title="All 10 branches missed.">            if (eq.hasFlag(MiscType.F_LADDER) &amp;&amp; ((location == Tank.LOC_FRONT) || isRearLocation</span>
                    || ((tank instanceof VTOL) &amp;&amp; (location == VTOL.LOC_ROTOR)))) {
<span class="nc bnc" id="L969" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L970">                    buffer.append(eq.getName()).append(&quot; must be mounted on the side or turret.\n&quot;);</span>
                }
<span class="nc" id="L972">                return false;</span>
            }
<span class="nc bnc" id="L974" title="All 4 branches missed.">            if (eq.hasFlag(MiscType.F_MAST_MOUNT) &amp;&amp; (location != VTOL.LOC_ROTOR)) {</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L976">                    buffer.append(eq.getName()).append(&quot; must be mounted on the rotor.\n&quot;);</span>
                }
<span class="nc" id="L978">                return false;</span>
            }
            // The minesweeper is also permitted in the front-side/rear-side location for &quot;particularly
            // large vehicles&quot; (TacOps, 326) but it is not clear how large this needs to be. Superheavy?
            // multi-hex large naval support?
<span class="nc bnc" id="L983" title="All 6 branches missed.">            if (eq.hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; (location != Tank.LOC_FRONT) &amp;&amp; !isRearLocation) {</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L985">                    buffer.append(eq.getName()).append(&quot; must be mounted on the front or rear.\n&quot;);</span>
                }
<span class="nc" id="L987">                return false;</span>
            }
<span class="nc bnc" id="L989" title="All 2 branches missed.">        } else if (eq instanceof WeaponType) {</span>
<span class="nc bnc" id="L990" title="All 6 branches missed.">            if ((((WeaponType) eq).getAmmoType() == AmmoType.T_GAUSS_HEAVY)</span>
                    &amp;&amp; (location != Tank.LOC_FRONT) &amp;&amp; !isRearLocation) {
<span class="nc bnc" id="L992" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L993">                    buffer.append(eq.getName()).append(&quot; cannot be mounted on the sides or turret.\n&quot;);</span>
                }
<span class="nc" id="L995">                return false;</span>
            }
<span class="nc bnc" id="L997" title="All 4 branches missed.">            if ((((WeaponType) eq).getAmmoType() == AmmoType.T_IGAUSS_HEAVY)</span>
                    &amp;&amp; isTurretLocation) {
<span class="nc bnc" id="L999" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1000">                    buffer.append(eq.getName()).append(&quot; cannot be mounted on a turret.\n&quot;);</span>
                }
<span class="nc" id="L1002">                return false;</span>
            }
<span class="nc bnc" id="L1004" title="All 4 branches missed.">            if (!eq.hasFlag(WeaponType.F_C3M) &amp;&amp; !eq.hasFlag(WeaponType.F_C3MBS)</span>
<span class="nc bnc" id="L1005" title="All 4 branches missed.">                    &amp;&amp; !eq.hasFlag(WeaponType.F_TAG) &amp;&amp; (location == Tank.LOC_BODY)) {</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1007">                    buffer.append(eq.getName()).append(&quot; cannot be mounted in the body.\n&quot;);</span>
                }
<span class="nc" id="L1009">                return false;</span>
            }
<span class="nc bnc" id="L1011" title="All 4 branches missed.">            if ((tank instanceof VTOL) &amp;&amp; (location == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">                    &amp;&amp; !eq.hasFlag(WeaponType.F_TAG)) {</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1014">                    buffer.append(eq.getName()).append(&quot; cannot be mounted in the rotor.\n&quot;);</span>
                }
<span class="nc" id="L1016">                return false;</span>
            }
        }
<span class="nc" id="L1019">        return true;</span>
    }

    /**
     * Determines whether a piece of equipment should be mounted in the body location.
     *
     * @param eq       The equipment
     * @return         Whether the equipment needs to be assigned to the body location.
     */
    public static boolean isBodyEquipment(EquipmentType eq) {
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (eq instanceof MiscType) {</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            return eq.hasFlag(MiscType.F_CHASSIS_MODIFICATION)</span>
<span class="nc bnc" id="L1031" title="All 4 branches missed.">                    || (eq.hasFlag(MiscType.F_CASE) &amp;&amp; !eq.isClan())</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_CASEII)</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_JUMP_JET)</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_FUEL)</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_BLUE_SHIELD);</span>
        } else {
<span class="nc" id="L1037">            return eq instanceof AmmoType;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>