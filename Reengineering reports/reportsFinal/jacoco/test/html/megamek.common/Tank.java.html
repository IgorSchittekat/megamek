<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Tank.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Tank.java</span></div><h1>Tank.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000-2003 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */
package megamek.common;

import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.Vector;

import megamek.MegaMek;
import megamek.common.options.OptionsConstants;
import megamek.common.verifier.SupportVeeStructure;
import megamek.common.verifier.TestEntity;
import megamek.common.weapons.flamers.VehicleFlamerWeapon;
import megamek.common.weapons.lasers.CLChemicalLaserWeapon;

/**
 * You know what tanks are, silly.
 */
<span class="nc" id="L36">public class Tank extends Entity {</span>
    private static final long serialVersionUID = -857210851169206264L;
<span class="nc" id="L38">    protected boolean m_bHasNoTurret = false;</span>
<span class="nc" id="L39">    protected boolean m_bTurretLocked = false;</span>
<span class="nc" id="L40">    protected boolean m_bTurretJammed = false;</span>
<span class="nc" id="L41">    protected boolean m_bTurretEverJammed = false;</span>
<span class="nc" id="L42">    protected boolean m_bHasNoDualTurret = false;</span>
<span class="nc" id="L43">    protected boolean m_bDualTurretLocked = false;</span>
<span class="nc" id="L44">    protected boolean m_bDualTurretJammed = false;</span>
<span class="nc" id="L45">    protected boolean m_bDualTurretEverJammed = false;</span>
<span class="nc" id="L46">    private int m_nTurretOffset = 0;</span>
<span class="nc" id="L47">    private int m_nDualTurretOffset = 0;</span>
<span class="nc" id="L48">    private int m_nStunnedTurns = 0;</span>
<span class="nc" id="L49">    private boolean m_bImmobile = false;</span>
<span class="nc" id="L50">    private boolean m_bImmobileHit = false;</span>
<span class="nc" id="L51">    private int burningLocations = 0;</span>
<span class="nc" id="L52">    private boolean m_bBackedIntoHullDown = false;</span>
<span class="nc" id="L53">    protected int motivePenalty = 0;</span>
<span class="nc" id="L54">    protected int motiveDamage = 0;</span>
<span class="nc" id="L55">    private boolean minorMovementDamage = false;</span>
<span class="nc" id="L56">    private boolean moderateMovementDamage = false;</span>
<span class="nc" id="L57">    private boolean heavyMovementDamage = false;</span>
<span class="nc" id="L58">    private boolean infernoFire = false;</span>
<span class="nc" id="L59">    private ArrayList&lt;Mounted&gt; jammedWeapons = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L60">    protected boolean engineHit = false;</span>

    // locations
    public static final int LOC_BODY = 0;
    public static final int LOC_FRONT = 1;
    public static final int LOC_RIGHT = 2;
    public static final int LOC_LEFT = 3;
    public static final int LOC_REAR = 4;
    /**
     * for dual turret tanks, this is the rear turret
     **/
    public static final int LOC_TURRET = 5;
    /**
     * for dual turret tanks, this is the front turret
     **/
    public static final int LOC_TURRET_2 = 6;

    // critical hits
    public static final int CRIT_NONE = -1;
    public static final int CRIT_DRIVER = 0;
    public static final int CRIT_WEAPON_JAM = 1;
    public static final int CRIT_WEAPON_DESTROYED = 2;
    public static final int CRIT_STABILIZER = 3;
    public static final int CRIT_SENSOR = 4;
    public static final int CRIT_COMMANDER = 5;
    public static final int CRIT_CREW_KILLED = 6;
    public static final int CRIT_CREW_STUNNED = 7;
    public static final int CRIT_CARGO = 8;
    public static final int CRIT_ENGINE = 9;
    public static final int CRIT_FUEL_TANK = 10;
    public static final int CRIT_AMMO = 11;
    public static final int CRIT_TURRET_JAM = 12;
    public static final int CRIT_TURRET_LOCK = 13;
    public static final int CRIT_TURRET_DESTROYED = 14;

    // tanks have no critical slot limitations
<span class="fc" id="L96">    private static final int[] NUM_OF_SLOTS = {25, 25, 25, 25, 25, 25, 25};</span>

<span class="fc" id="L98">    private static String[] LOCATION_ABBRS = {&quot;BD&quot;, &quot;FR&quot;, &quot;RS&quot;, &quot;LS&quot;, &quot;RR&quot;,</span>
            &quot;TU&quot;, &quot;FT&quot;};
<span class="fc" id="L100">    private static String[] LOCATION_NAMES = {&quot;Body&quot;, &quot;Front&quot;, &quot;Right&quot;,</span>
            &quot;Left&quot;, &quot;Rear&quot;, &quot;Turret&quot;};

<span class="fc" id="L103">    private static String[] LOCATION_NAMES_DUAL_TURRET = {&quot;Body&quot;, &quot;Front&quot;,</span>
            &quot;Right&quot;, &quot;Left&quot;, &quot;Rear&quot;, &quot;Rear Turret&quot;, &quot;Front Turret&quot;};

    @Override
    public int getUnitType() {
<span class="nc" id="L108">        EntityMovementMode mm = getMovementMode();</span>
<span class="nc bnc" id="L109" title="All 6 branches missed.">        return (mm == EntityMovementMode.NAVAL) || (mm == EntityMovementMode.HYDROFOIL) || (mm == EntityMovementMode.SUBMARINE)</span>
<span class="nc" id="L110">                ? UnitType.NAVAL</span>
<span class="nc" id="L111">                : UnitType.TANK;</span>
    }

    @Override
    public String[] getLocationAbbrs() {
<span class="nc" id="L116">        return LOCATION_ABBRS;</span>
    }

    @Override
    public String[] getLocationNames() {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L122">            return LOCATION_NAMES_DUAL_TURRET;</span>
        }
<span class="nc" id="L124">        return LOCATION_NAMES;</span>
    }

    public int getLocTurret() {
<span class="nc" id="L128">        return LOC_TURRET;</span>
    }

    public int getLocTurret2() {
<span class="nc" id="L132">        return LOC_TURRET_2;</span>
    }

<span class="nc" id="L135">    private int sensorHits = 0;</span>
<span class="nc" id="L136">    private int stabiliserHits = 0;</span>
<span class="nc" id="L137">    private boolean driverHit = false;</span>
<span class="nc" id="L138">    private boolean commanderHit = false;</span>
    //If there is a cockpit command console, the tank does not suffer the effects of the first commander critical,
    //but the command console benefits are lost as the backup has to take command.
<span class="nc" id="L141">    private boolean usingConsoleCommander = false;</span>
    /**
     * Vehicles can be constructed with seating for additional crew. This has no effect on play
     */
<span class="nc" id="L145">    private int extraCrewSeats = 0;</span>

    // set up some vars for what the critical effects would be
<span class="nc" id="L148">    private int potCrit = CRIT_NONE;</span>
<span class="nc" id="L149">    private boolean overThresh = false;</span>

    // pain-shunted units can take two driver and commander hits and two hits
    // before being killed
<span class="nc" id="L153">    private boolean driverHitPS = false;</span>
<span class="nc" id="L154">    private boolean commanderHitPS = false;</span>
<span class="nc" id="L155">    private boolean crewHitPS = false;</span>

    /**
     * Keeps track of the base weight of the turret for omni tanks.
     */
    public static final int BASE_CHASSIS_TURRET_WT_UNASSIGNED = -1;
<span class="nc" id="L161">    private double baseChassisTurretWeight = BASE_CHASSIS_TURRET_WT_UNASSIGNED;</span>
<span class="nc" id="L162">    private double baseChassisTurret2Weight = BASE_CHASSIS_TURRET_WT_UNASSIGNED;</span>
<span class="nc" id="L163">    private double baseChassisSponsonPintleWeight = BASE_CHASSIS_TURRET_WT_UNASSIGNED;</span>

    /**
     * Flag to indicate unit is constructed as a trailer. Trailers do not require
     * control systems or engines unless they are intended for independent operation.
     */
<span class="nc" id="L169">    private boolean trailer = false;</span>
    /**
     * Keeps track of whether this vehicle has control systems.  Trailers aren't
     * required to have control systems.
     */
<span class="nc" id="L174">    private boolean hasNoControlSystems = false;</span>

    /**
     * Alternate fuel for ICEs that affects operating range
     */
<span class="nc" id="L179">    private FuelType fuelType = FuelType.PETROCHEMICALS;</span>

    public CrewType defaultCrewType() {
<span class="nc" id="L182">        return CrewType.CREW;</span>
    }

    public int getPotCrit() {
<span class="nc" id="L186">        return potCrit;</span>
    }

    public void setPotCrit(int crit) {
<span class="nc" id="L190">        potCrit = crit;</span>
<span class="nc" id="L191">    }</span>

    public boolean getOverThresh() {
<span class="nc" id="L194">        return overThresh;</span>
    }

    public void setOverThresh(boolean tf) {
<span class="nc" id="L198">        overThresh = tf;</span>
<span class="nc" id="L199">    }</span>

    public boolean hasNoTurret() {
<span class="nc" id="L202">        return m_bHasNoTurret;</span>
    }

    public boolean hasNoDualTurret() {
<span class="nc" id="L206">        return m_bHasNoDualTurret;</span>
    }

    public void setHasNoTurret(boolean b) {
<span class="nc" id="L210">        m_bHasNoTurret = b;</span>
<span class="nc" id="L211">    }</span>

    public void setHasNoDualTurret(boolean b) {
<span class="nc" id="L214">        m_bHasNoDualTurret = b;</span>
<span class="nc" id="L215">    }</span>

    public int getMotiveDamage() {
<span class="nc" id="L218">        return motiveDamage;</span>
    }

    public void setMotiveDamage(int d) {
<span class="nc" id="L222">        motiveDamage = d;</span>
<span class="nc" id="L223">    }</span>

    public int getMotivePenalty() {
<span class="nc" id="L226">        return motivePenalty;</span>
    }

    public void setMotivePenalty(int p) {
<span class="nc" id="L230">        motivePenalty = p;</span>
<span class="nc" id="L231">    }</span>

<span class="fc" id="L233">    private static final TechAdvancement TA_COMBAT_VEHICLE = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="fc" id="L234">            .setAdvancement(DATE_NONE, 2470, 2490).setProductionFactions(F_TH)</span>
<span class="fc" id="L235">            .setTechRating(RATING_E).setAvailability(RATING_C, RATING_C, RATING_C, RATING_B)</span>
<span class="fc" id="L236">            .setStaticTechLevel(SimpleTechLevel.INTRO);</span>

    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="nc" id="L240">        return TA_COMBAT_VEHICLE;</span>
    }

    //Advanced turrets
    public static TechAdvancement getDualTurretTA() {
<span class="nc" id="L245">        return new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L246">                .setAdvancement(DATE_PS, 3080, 3080).setApproximate(false, true, false)</span>
<span class="nc" id="L247">                .setTechRating(RATING_B).setAvailability(RATING_F, RATING_F, RATING_F, RATING_E)</span>
<span class="nc" id="L248">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL);</span>
    }

    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<span class="nc" id="L252">        super.addSystemTechAdvancement(ctl);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L254">            ctl.addComponent(getDualTurretTA());</span>
        }
<span class="nc" id="L256">    }</span>

    /**
     * Returns this entity's walking/cruising mp, factored for heat, extreme
     * temperatures, and gravity.
     */
    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat) {
<span class="nc" id="L264">        return getWalkMP(gravity, ignoreheat, false);</span>
    }

    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat,
                         boolean ignoremodulararmor) {
<span class="nc" id="L270">        int j = getOriginalWalkMP();</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">        if (engineHit || isImmobile()) {</span>
<span class="nc" id="L272">            return 0;</span>
        }
<span class="nc" id="L274">        j = Math.max(0, j - motiveDamage);</span>
<span class="nc" id="L275">        j = Math.max(0, j - getCargoMpReduction(this));</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L277">            int weatherMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L278">                    .getMovementMods(this);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L280">                j = Math.max(j + weatherMod, 0);</span>
            }
        }

<span class="nc bnc" id="L284" title="All 4 branches missed.">        if (!ignoremodulararmor &amp;&amp; hasModularArmor()) {</span>
<span class="nc" id="L285">            j--;</span>
        }
<span class="nc bnc" id="L287" title="All 4 branches missed.">        if (hasWorkingMisc(MiscType.F_DUNE_BUGGY) &amp;&amp; (game != null)) {</span>
<span class="nc" id="L288">            j--;</span>
        }

<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L292">            j = applyGravityEffectsOnMP(j);</span>
        }

        //If the unit is towing trailers, adjust its walkMP, TW p205
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (!getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L297">            double trainWeight = getWeight();</span>
<span class="nc" id="L298">            int lowestSuspensionFactor = getSuspensionFactor();</span>
            //Add up the trailers
<span class="nc bnc" id="L300" title="All 2 branches missed.">            for (int id : getAllTowedUnits()) {</span>
<span class="nc" id="L301">                Entity tr = game.getEntity(id);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                if (tr == null) {</span>
                    //this isn't supposed to happen, but it can in rare cases when tr is destroyed
<span class="nc" id="L304">                    continue;</span>
                }
<span class="nc bnc" id="L306" title="All 2 branches missed.">                if (tr instanceof Tank) {</span>
<span class="nc" id="L307">                    Tank trailer = (Tank) tr;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                    if (trailer.getSuspensionFactor() &lt; lowestSuspensionFactor) {</span>
<span class="nc" id="L309">                        lowestSuspensionFactor = trailer.getSuspensionFactor();</span>
                    }
                }
<span class="nc" id="L312">                trainWeight += tr.getWeight();</span>
<span class="nc" id="L313">            }</span>
<span class="nc" id="L314">            j = (int) ((getEngine().getRating() + lowestSuspensionFactor) / trainWeight);</span>
        }

<span class="nc" id="L317">        return j;</span>

    }

    @Override
    public boolean isEligibleForPavementBonus() {
<span class="nc bnc" id="L323" title="All 4 branches missed.">        return movementMode == EntityMovementMode.TRACKED || movementMode == EntityMovementMode.WHEELED;</span>
    }

    public boolean isTurretLocked(int turret) {
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc bnc" id="L328" title="All 4 branches missed.">            return m_bTurretLocked || m_bTurretJammed;</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">            return m_bDualTurretLocked || m_bDualTurretJammed;</span>
        }
<span class="nc" id="L332">        return false;</span>
    }

    public boolean isTurretJammed(int turret) {
        // this is rather a hack but the only idea I came up with.
        // for the first time this is checked. If this is a partially repaired
        // turret it will be jammed.
        // so just set it to jammed and change the partial repair value to
        // false.

<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;veh_locked_turret&quot;)) {</span>
<span class="nc" id="L343">            m_bTurretJammed = true;</span>
<span class="nc" id="L344">            m_bDualTurretJammed = true;</span>
<span class="nc" id="L345">            getPartialRepairs().getOption(&quot;veh_locked_turret&quot;).setValue(false);</span>
        }
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L348">            return m_bTurretJammed;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L350">            return m_bDualTurretJammed;</span>
        }
<span class="nc" id="L352">        return false;</span>
    }

    /**
     * Returns the number of locations in the entity
     */
    @Override
    public int locations() {
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (m_bHasNoDualTurret) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            return m_bHasNoTurret ? 5 : 6;</span>
        }
<span class="nc" id="L363">        return 7;</span>
    }

    @Override
    public int getBodyLocation() {
<span class="nc" id="L368">        return LOC_BODY;</span>
    }

    @Override
    public boolean canChangeSecondaryFacing() {
<span class="nc bnc" id="L373" title="All 4 branches missed.">        return !m_bHasNoTurret &amp;&amp; !isTurretLocked(getLocTurret());</span>
    }

    @Override
    public boolean isValidSecondaryFacing(int n) {
<span class="nc bnc" id="L378" title="All 2 branches missed.">        return !isTurretLocked(getLocTurret());</span>
    }

    @Override
    public int clipSecondaryFacing(int n) {
<span class="nc" id="L383">        return n;</span>
    }

    @Override
    public void setSecondaryFacing(int sec_facing) {
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (!isTurretLocked(getLocTurret())) {</span>
<span class="nc" id="L389">            super.setSecondaryFacing(sec_facing);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (!m_bHasNoTurret) {</span>
<span class="nc" id="L391">                m_nTurretOffset = sec_facing - getFacing();</span>
            }
        }
<span class="nc" id="L394">    }</span>

    @Override
    public void setFacing(int facing) {
<span class="nc" id="L398">        super.setFacing(facing);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (isTurretLocked(getLocTurret())) {</span>
<span class="nc" id="L400">            int nTurretFacing = (facing + m_nTurretOffset + 6) % 6;</span>
<span class="nc" id="L401">            super.setSecondaryFacing(nTurretFacing);</span>
        }
<span class="nc" id="L403">    }</span>

    public int getDualTurretFacing() {
<span class="nc" id="L406">        return (facing + m_nDualTurretOffset + 6) % 6;</span>
    }

    public void setDualTurretOffset(int offset) {
<span class="nc" id="L410">        m_nDualTurretOffset = offset;</span>
<span class="nc" id="L411">    }</span>

    public boolean isStabiliserHit(int loc) {
<span class="nc bnc" id="L414" title="All 2 branches missed.">        return (stabiliserHits &amp; (1 &lt;&lt; loc)) == (1 &lt;&lt; loc);</span>
    }

    public void setStabiliserHit(int loc) {
<span class="nc" id="L418">        stabiliserHits |= (1 &lt;&lt; loc);</span>
<span class="nc" id="L419">    }</span>

    public void clearStabiliserHit(int loc) {
<span class="nc" id="L422">        stabiliserHits &amp;= ~(1 &lt;&lt; loc);</span>
<span class="nc" id="L423">    }</span>

    public int getSensorHits() {
<span class="nc" id="L426">        return sensorHits;</span>
    }

    public void setSensorHits(int hits) {
<span class="nc" id="L430">        sensorHits = hits;</span>
<span class="nc" id="L431">    }</span>

    public boolean isDriverHit() {
<span class="nc" id="L434">        return driverHit;</span>
    }

    public void setDriverHit(boolean hit) {
<span class="nc" id="L438">        driverHit = hit;</span>
<span class="nc" id="L439">    }</span>

    public boolean isCommanderHit() {
<span class="nc" id="L442">        return commanderHit;</span>
    }

    public void setCommanderHit(boolean hit) {
<span class="nc" id="L446">        commanderHit = hit;</span>
<span class="nc" id="L447">    }</span>

    public boolean isUsingConsoleCommander() {
<span class="nc" id="L450">        return usingConsoleCommander;</span>
    }

    public void setUsingConsoleCommander(boolean b) {
<span class="nc" id="L454">        usingConsoleCommander = b;</span>
<span class="nc" id="L455">    }</span>

    /**
     * @return Additional seats beyond the minimum crew requirements
     */
    public int getExtraCrewSeats() {
<span class="nc" id="L461">        return extraCrewSeats;</span>
    }

    public void setExtraCrewSeats(int seats) {
<span class="nc" id="L465">        this.extraCrewSeats = seats;</span>
<span class="nc" id="L466">    }</span>

    public boolean isDriverHitPS() {
<span class="nc" id="L469">        return driverHitPS;</span>
    }

    public void setDriverHitPS(boolean hit) {
<span class="nc" id="L473">        driverHitPS = hit;</span>
<span class="nc" id="L474">    }</span>

    public boolean isCommanderHitPS() {
<span class="nc" id="L477">        return commanderHitPS;</span>
    }

    public void setCommanderHitPS(boolean hit) {
<span class="nc" id="L481">        commanderHitPS = hit;</span>
<span class="nc" id="L482">    }</span>

    public boolean isCrewHitPS() {
<span class="nc" id="L485">        return crewHitPS;</span>
    }

    public void setCrewHitPS(boolean hit) {
<span class="nc" id="L489">        crewHitPS = hit;</span>
<span class="nc" id="L490">    }</span>

    public boolean isMovementHit() {
<span class="nc" id="L493">        return m_bImmobile;</span>
    }

    public boolean isMovementHitPending() {
<span class="nc" id="L497">        return m_bImmobileHit;</span>
    }

    /**
     * Marks this tank for immobilization, most likely from a related motive
     * system hit. To &lt;em&gt;actually&lt;/em&gt; immobilize it, {@link #applyDamage()}
     * must also be invoked; until then, {@link #isMovementHitPending()} will
     * return true after this but neither {@link #isMovementHit()} nor
     * {@link #isImmobile()} will have been updated yet (because the tank is
     * technically not immobile just &lt;em&gt;yet&lt;/em&gt; until damage is actually
     * resolved).
     */
    public void immobilize() {
<span class="nc" id="L510">        m_bImmobileHit = true;</span>
<span class="nc" id="L511">    }</span>

    @Override
    public boolean isImmobile(boolean checkCrew) {
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if ((game != null)</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_IMMOBILE_VEHICLES)) {</span>
<span class="nc" id="L517">            return super.isImmobile(checkCrew);</span>
        }
        //Towed trailers need to reference the tractor, or they return Immobile due to 0 MP...
        //We do run into some double-blind entityList differences though, so include a null check
<span class="nc bnc" id="L521" title="All 4 branches missed.">        if (isTrailer() &amp;&amp; (getTractor() != Entity.NONE)) {</span>
<span class="nc bnc" id="L522" title="All 6 branches missed.">            return (game.getEntity(getTractor()) != null ? game.getEntity(getTractor()).isImmobile(checkCrew) : super.isImmobile(checkCrew) || m_bImmobile);</span>
        }
<span class="nc bnc" id="L524" title="All 4 branches missed.">        return m_bImmobile || super.isImmobile(checkCrew);</span>
    }

    /**
     * Whether this unit is irreversibly immobilized for the rest of the game.
     * Tanks have some additional criteria.
     */
    @Override
    public boolean isPermanentlyImmobilized(boolean checkCrew) {
<span class="nc bnc" id="L533" title="All 4 branches missed.">        return super.isPermanentlyImmobilized(checkCrew) || isMovementHit();</span>
    }

    @Override
    public boolean hasCommandConsoleBonus() {
<span class="nc bnc" id="L538" title="All 6 branches missed.">        if (!hasWorkingMisc(MiscType.F_COMMAND_CONSOLE) || isCommanderHit() || isUsingConsoleCommander()) {</span>
<span class="nc" id="L539">            return false;</span>
        }
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">            return getWeightClass() &gt;= EntityWeightClass.WEIGHT_LARGE_SUPPORT</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                    &amp;&amp; hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL);</span>
        } else {
<span class="nc bnc" id="L545" title="All 2 branches missed.">            return getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY;</span>
        }
    }


    /**
     * Tanks have all sorts of prohibited terrain.
     */
    @Override
    public boolean isLocationProhibited(Coords c, int currElevation) {
<span class="nc" id="L555">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.IMPASSABLE)) {</span>
<span class="nc" id="L557">            return true;</span>
        }

<span class="nc bnc" id="L560" title="All 4 branches missed.">        if (hex.containsTerrain(Terrains.SPACE) &amp;&amp; doomedInSpace()) {</span>
<span class="nc" id="L561">            return true;</span>
        }

        // Additional restrictions for hidden units
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (isHidden()) {</span>
            // Can't deploy in paved hexes
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if ((hex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.ROAD))</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    &amp;&amp; (!hex.containsTerrain(Terrains.BUILDING)</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.RUBBLE))) {</span>
<span class="nc" id="L571">                return true;</span>
            }
            // Can't deploy on a bridge
<span class="nc bnc" id="L574" title="All 2 branches missed.">            if ((hex.terrainLevel(Terrains.BRIDGE_ELEV) == currElevation)</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                    &amp;&amp; hex.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L576">                return true;</span>
            }
            // Can't deploy on the surface of water
<span class="nc bnc" id="L579" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WATER) &amp;&amp; (currElevation == 0)) {</span>
<span class="nc" id="L580">                return true;</span>
            }
        }

<span class="nc" id="L584">        boolean hasFlotationHull = hasWorkingMisc(MiscType.F_FLOTATION_HULL);</span>
<span class="nc" id="L585">        boolean isAmphibious = hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS);</span>
<span class="nc" id="L586">        boolean hexHasRoad = hex.containsTerrain(Terrains.ROAD);</span>

        // roads allow movement through hexes that you normally couldn't go through
<span class="nc bnc" id="L589" title="All 7 branches missed.">        switch (movementMode) {</span>
            case TRACKED:
<span class="nc bnc" id="L591" title="All 2 branches missed.">                if (!isSuperHeavy()) {</span>
<span class="nc bnc" id="L592" title="All 4 branches missed.">                    return ((hex.terrainLevel(Terrains.WOODS) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L594" title="All 6 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                            &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L596" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1)</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.ROUGH) &gt; 1)</span>
<span class="nc bnc" id="L599" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.RUBBLE) &gt; 5) &amp;&amp; !hexHasRoad);</span>
                } else {
<span class="nc bnc" id="L601" title="All 4 branches missed.">                    return ((hex.terrainLevel(Terrains.WOODS) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L603" title="All 6 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                            &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L605" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1);</span>
                }
            case WHEELED:
<span class="nc bnc" id="L609" title="All 2 branches missed.">                if (!isSuperHeavy()) {</span>
<span class="nc bnc" id="L610" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.ROUGH) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L613" title="All 6 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                            &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L615" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.RUBBLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                            || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.SNOW) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.GEYSER) == 2);</span>
                } else {
<span class="nc bnc" id="L621" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L622" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.ROUGH) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L624" title="All 6 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                            &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L626" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.RUBBLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                            || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L628" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.GEYSER) == 2);</span>
                }
            case HOVER:
<span class="nc bnc" id="L632" title="All 2 branches missed.">                if (!isSuperHeavy()) {</span>
<span class="nc bnc" id="L633" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L634" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1)</span>
<span class="nc bnc" id="L636" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.ROUGH) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L637" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.RUBBLE) &gt; 5) &amp;&amp; !hexHasRoad);</span>
                } else {
<span class="nc bnc" id="L639" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L640" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1);</span>
                }

            case NAVAL:
            case HYDROFOIL:
                // Can only deploy under a bridge if there is sufficient clearance.
<span class="nc bnc" id="L647" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                        &amp;&amp; (getHeight() &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV) - hex.surface())) {</span>
<span class="nc" id="L649">                    return true;</span>
                }
<span class="nc bnc" id="L651" title="All 2 branches missed.">                return (hex.terrainLevel(Terrains.WATER) &lt;= 0)</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                        || hex.containsTerrain(Terrains.ICE);</span>
            case SUBMARINE:
                // Submarines get extra clearance equal to the depth of water.
<span class="nc bnc" id="L655" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                        &amp;&amp; (getHeight() &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV) - hex.floor())) {</span>
<span class="nc" id="L657">                    return true;</span>
                }
<span class="nc bnc" id="L659" title="All 2 branches missed.">                return (hex.terrainLevel(Terrains.WATER) &lt;= 0);</span>
            case WIGE:
<span class="nc bnc" id="L661" title="All 2 branches missed.">                return (hex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">                        || hex.containsTerrain(Terrains.JUNGLE))</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                        &amp;&amp; hex.ceiling() &gt; currElevation;</span>
            default:
<span class="nc" id="L665">                return false;</span>
        }
    }

    public void lockTurret(int turret) {
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L671">            m_bTurretLocked = true;</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L673">            m_bDualTurretLocked = true;</span>
        }

<span class="nc" id="L676">    }</span>

    public void jamTurret(int turret) {
<span class="nc bnc" id="L679" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L680">            m_bTurretEverJammed = true;</span>
<span class="nc" id="L681">            m_bTurretJammed = true;</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L683">            m_bDualTurretEverJammed = true;</span>
<span class="nc" id="L684">            m_bDualTurretJammed = true;</span>
        }

<span class="nc" id="L687">    }</span>

    public void unjamTurret(int turret) {
<span class="nc bnc" id="L690" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L691">            m_bTurretJammed = false;</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L693">            m_bDualTurretJammed = false;</span>
        }
<span class="nc" id="L695">    }</span>

    public boolean isTurretEverJammed(int turret) {
<span class="nc bnc" id="L698" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L699">            return m_bTurretEverJammed;</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L701">            return m_bDualTurretEverJammed;</span>
        }
<span class="nc" id="L703">        return false;</span>
    }

    public int getStunnedTurns() {
<span class="nc" id="L707">        return m_nStunnedTurns;</span>
    }

    public void setStunnedTurns(int turns) {
<span class="nc" id="L711">        m_nStunnedTurns = turns;</span>
<span class="nc" id="L712">    }</span>

    public void stunCrew() {
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (m_nStunnedTurns == 0) {</span>
<span class="nc" id="L716">            m_nStunnedTurns = 2;</span>
        } else {
<span class="nc" id="L718">            m_nStunnedTurns++;</span>
        }
<span class="nc" id="L720">    }</span>

    @Override
    public void applyDamage() {
<span class="nc" id="L724">        applyMovementDamage();</span>

<span class="nc" id="L726">        super.applyDamage();</span>
<span class="nc" id="L727">    }</span>

    /**
     * Applies movement damage to the Tank.
     */
    public void applyMovementDamage() {
<span class="nc" id="L733">        m_bImmobile |= m_bImmobileHit;</span>

        // Towed trailers need to use the values of the tractor, or they return Immobile due to 0 MP...
<span class="nc bnc" id="L736" title="All 6 branches missed.">        if (isTrailer() &amp;&amp; (getTractor() != Entity.NONE) &amp;&amp; game.getEntity(getTractor()).hasETypeFlag(Entity.ETYPE_TANK)) {</span>
<span class="nc" id="L737">            Tank Tractor = (Tank) game.getEntity(getTractor());</span>
<span class="nc" id="L738">            m_bImmobile = Tractor.m_bImmobile;</span>
<span class="nc" id="L739">            m_bImmobileHit = Tractor.m_bImmobileHit;</span>
        }
<span class="nc" id="L741">    }</span>

    @Override
    public void newRound(int roundNumber) {
<span class="nc" id="L745">        super.newRound(roundNumber);</span>

        // If MASC was used last turn, increment the counter,
        // otherwise decrement. Then, clear the counter
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (usedMASC) {</span>
<span class="nc" id="L750">            nMASCLevel++;</span>
<span class="nc" id="L751">            bMASCWentUp = true;</span>
        } else {
<span class="nc" id="L753">            nMASCLevel = Math.max(0, nMASCLevel - 1);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">            if (bMASCWentUp) {</span>
<span class="nc" id="L755">                nMASCLevel = Math.max(0, nMASCLevel - 1);</span>
<span class="nc" id="L756">                bMASCWentUp = false;</span>
            }
        }

        // Clear the MASC flag
<span class="nc" id="L761">        usedMASC = false;</span>

        // check for crew stun
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (m_nStunnedTurns &gt; 0) {</span>
<span class="nc" id="L765">            m_nStunnedTurns--;</span>
        }

        // reset turret facing, if not jammed
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if (!m_bTurretLocked) {</span>
<span class="nc" id="L770">            setSecondaryFacing(getFacing());</span>
        }
<span class="nc" id="L772">    }</span>

    /**
     * Returns the name of the type of movement used. This is tank-specific.
     */
    @Override
    public String getMovementString(EntityMovementType mtype) {
<span class="nc bnc" id="L779" title="All 7 branches missed.">        switch (mtype) {</span>
            case MOVE_SKID:
<span class="nc" id="L781">                return &quot;Skidded&quot;;</span>
            case MOVE_NONE:
<span class="nc" id="L783">                return &quot;None&quot;;</span>
            case MOVE_WALK:
            case MOVE_VTOL_WALK:
<span class="nc" id="L786">                return &quot;Cruised&quot;;</span>
            case MOVE_RUN:
            case MOVE_VTOL_RUN:
<span class="nc" id="L789">                return &quot;Flanked&quot;;</span>
            case MOVE_SPRINT:
            case MOVE_VTOL_SPRINT:
<span class="nc" id="L792">                return &quot;Sprinted&quot;;</span>
            case MOVE_JUMP:
<span class="nc" id="L794">                return &quot;Jumped&quot;;</span>
            default:
<span class="nc" id="L796">                return &quot;Unknown!&quot;;</span>
        }
    }

    /**
     * Returns the name of the type of movement used. This is tank-specific.
     */
    @Override
    public String getMovementAbbr(EntityMovementType mtype) {
<span class="nc bnc" id="L805" title="All 7 branches missed.">        switch (mtype) {</span>
            case MOVE_SKID:
<span class="nc" id="L807">                return &quot;S&quot;;</span>
            case MOVE_NONE:
<span class="nc" id="L809">                return &quot;N&quot;;</span>
            case MOVE_WALK:
            case MOVE_VTOL_WALK:
<span class="nc" id="L812">                return &quot;C&quot;;</span>
            case MOVE_RUN:
            case MOVE_VTOL_RUN:
<span class="nc" id="L815">                return &quot;F&quot;;</span>
            case MOVE_SPRINT:
            case MOVE_VTOL_SPRINT:
<span class="nc" id="L818">                return &quot;O&quot;;</span>
            case MOVE_JUMP:
<span class="nc" id="L820">                return &quot;J&quot;;</span>
            default:
<span class="nc" id="L822">                return &quot;?&quot;;</span>
        }
    }

    @Override
    public boolean hasRearArmor(int loc) {
<span class="nc" id="L828">        return false;</span>
    }

    @Override
    public int firstArmorIndex() {
<span class="nc" id="L833">        return LOC_FRONT;</span>
    }

    /**
     * Returns the Compute.ARC that the weapon fires into.
     */
    @Override
    public int getWeaponArc(int wn) {
<span class="nc" id="L841">        final Mounted mounted = getEquipment(wn);</span>

        // B-Pods need to be special-cased, the have 360 firing arc
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if ((mounted.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L846">            return Compute.ARC_360;</span>
        }
        // VGLs base arc on their facing
<span class="nc bnc" id="L849" title="All 2 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L850">            return Compute.firingArcFromVGLFacing(mounted.getFacing());</span>
        }
<span class="nc bnc" id="L852" title="All 7 branches missed.">        switch (mounted.getLocation()) {</span>
            case LOC_BODY:
                // Body mounted C3Ms fire into the front arc,
                // per
                // http://forums.classicbattletech.com/index.php/topic,9400.0.html
            case LOC_FRONT:
<span class="nc bnc" id="L858" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L859">                    return Compute.ARC_PINTLE_TURRET_FRONT;</span>
                }
<span class="nc bnc" id="L861" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L862">                    return Compute.ARC_NOSE;</span>
                }
            case LOC_TURRET:
<span class="nc bnc" id="L865" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L866">                    return Compute.ARC_TURRET;</span>
                }
<span class="nc" id="L868">                return Compute.ARC_FORWARD;</span>
            case LOC_TURRET_2:
                // Doubles as chin turret location for VTOLs, for which
                // Tank.LOC_TURRET == magic number 5 == VTOL.LOC_ROTOR.
<span class="nc bnc" id="L872" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L873">                    return Compute.ARC_TURRET;</span>
                }
<span class="nc" id="L875">                return Compute.ARC_FORWARD;</span>
            case LOC_RIGHT:
<span class="nc bnc" id="L877" title="All 2 branches missed.">                if (mounted.isSponsonTurretMounted()) {</span>
<span class="nc" id="L878">                    return Compute.ARC_SPONSON_TURRET_RIGHT;</span>
                }
<span class="nc bnc" id="L880" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L881">                    return Compute.ARC_PINTLE_TURRET_RIGHT;</span>
                }
<span class="nc bnc" id="L883" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L884">                    return Compute.ARC_RIGHT_BROADSIDE;</span>
                }
<span class="nc" id="L886">                return Compute.ARC_RIGHTSIDE;</span>
            case LOC_LEFT:
<span class="nc bnc" id="L888" title="All 2 branches missed.">                if (mounted.isSponsonTurretMounted()) {</span>
<span class="nc" id="L889">                    return Compute.ARC_SPONSON_TURRET_LEFT;</span>
                }
<span class="nc bnc" id="L891" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L892">                    return Compute.ARC_PINTLE_TURRET_LEFT;</span>
                }
<span class="nc bnc" id="L894" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L895">                    return Compute.ARC_LEFT_BROADSIDE;</span>
                }
<span class="nc" id="L897">                return Compute.ARC_LEFTSIDE;</span>
            case LOC_REAR:
<span class="nc bnc" id="L899" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L900">                    return Compute.ARC_PINTLE_TURRET_REAR;</span>
                }
<span class="nc bnc" id="L902" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L903">                    return Compute.ARC_AFT;</span>
                }
<span class="nc" id="L905">                return Compute.ARC_REAR;</span>
            default:
<span class="nc" id="L907">                return Compute.ARC_360;</span>
        }
    }

    /**
     * Returns true if this weapon fires into the secondary facing arc. If
     * false, assume it fires into the primary.
     */
    @Override
    public boolean isSecondaryArcWeapon(int weaponId) {
<span class="nc bnc" id="L917" title="All 2 branches missed.">        if (getEquipment(weaponId).getLocation() == getLocTurret()) {</span>
<span class="nc" id="L918">            return true;</span>
        }
<span class="nc" id="L920">        return false;</span>
    }

    /**
     * Rolls up a hit location
     */
    @Override
    public HitData rollHitLocation(int table, int side, int aimedLocation,
                                   int aimingMode, int cover) {
<span class="nc" id="L929">        int nArmorLoc = LOC_FRONT;</span>
<span class="nc" id="L930">        boolean bSide = false;</span>
<span class="nc" id="L931">        boolean bRear = false;</span>
<span class="nc bnc" id="L932" title="All 4 branches missed.">        boolean ignoreTurret = m_bHasNoTurret</span>
                || (table == ToHitData.HIT_UNDERWATER);
<span class="nc" id="L934">        int motiveMod = getMotiveSideMod(side);</span>
<span class="nc" id="L935">        setPotCrit(HitData.EFFECT_NONE);</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (isHullDown()) {</span>
            // which direction a tank moved in before going hull down is
            // important
            int moveInDirection;
<span class="nc bnc" id="L940" title="All 2 branches missed.">            if (!m_bBackedIntoHullDown) {</span>
<span class="nc" id="L941">                moveInDirection = ToHitData.SIDE_FRONT;</span>
            } else {
<span class="nc" id="L943">                moveInDirection = ToHitData.SIDE_REAR;</span>
            }
<span class="nc bnc" id="L945" title="All 6 branches missed.">            if ((side == moveInDirection) || (side == ToHitData.SIDE_LEFT)</span>
                    || (side == ToHitData.SIDE_RIGHT)) {
<span class="nc bnc" id="L947" title="All 2 branches missed.">                if (!ignoreTurret) {</span>
                    // on a hull down vee, all hits expect for those that come
                    // from the opposite direction to which it entered the hex
                    // it
                    // went Hull Down in go to turret if one exists.
<span class="nc bnc" id="L952" title="All 2 branches missed.">                    if (!hasNoDualTurret()) {</span>
<span class="nc" id="L953">                        int roll = Compute.d6() - 2;</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">                        if (roll &lt;= 3) {</span>
<span class="nc" id="L955">                            nArmorLoc = getLocTurret2();</span>
                        } else {
<span class="nc" id="L957">                            nArmorLoc = getLocTurret();</span>
                        }
<span class="nc" id="L959">                    } else {</span>
<span class="nc" id="L960">                        nArmorLoc = getLocTurret();</span>
                    }
                }
                // If the tank doesn't have turret all hits that don't come from
                // the opposite direction to which it entered the hex it went
                // Hull Down in hit side they come in from
                else {
<span class="nc" id="L967">                    nArmorLoc = side;</span>
                }
                // Hull Down tanks don't make hit location rolls
<span class="nc" id="L970">                return new HitData(nArmorLoc);</span>
            }
        }
<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (side == ToHitData.SIDE_LEFT) {</span>
<span class="nc" id="L974">            nArmorLoc = LOC_LEFT;</span>
<span class="nc" id="L975">            bSide = true;</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_RIGHT) {</span>
<span class="nc" id="L977">            nArmorLoc = LOC_RIGHT;</span>
<span class="nc" id="L978">            bSide = true;</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L980">            nArmorLoc = LOC_REAR;</span>
<span class="nc" id="L981">            bRear = true;</span>
        }
<span class="nc" id="L983">        HitData rv = new HitData(nArmorLoc);</span>
<span class="nc" id="L984">        boolean bHitAimed = false;</span>
<span class="nc bnc" id="L985" title="All 4 branches missed.">        if ((aimedLocation != LOC_NONE)</span>
                &amp;&amp; (aimingMode != IAimingModes.AIM_MODE_NONE)) {

<span class="nc" id="L988">            int roll = Compute.d6(2);</span>

<span class="nc bnc" id="L990" title="All 4 branches missed.">            if ((5 &lt; roll) &amp;&amp; (roll &lt; 9)) {</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">                rv = new HitData(aimedLocation, side == ToHitData.SIDE_REAR,</span>
                        true);
<span class="nc" id="L993">                bHitAimed = true;</span>
            }
        }
<span class="nc bnc" id="L996" title="All 2 branches missed.">        if (!bHitAimed) {</span>
<span class="nc bnc" id="L997" title="All 9 branches missed.">            switch (Compute.d6(2)) {</span>
                case 2:
<span class="nc bnc" id="L999" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {</span>
<span class="nc" id="L1000">                        setPotCrit(HitData.EFFECT_CRITICAL);</span>
                    } else {
<span class="nc" id="L1002">                        rv.setEffect(HitData.EFFECT_CRITICAL);</span>
                    }
<span class="nc" id="L1004">                    break;</span>
                case 3:
                case 4:
<span class="nc bnc" id="L1007" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {</span>
<span class="nc" id="L1008">                        setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
                    } else {
<span class="nc" id="L1010">                        rv.setEffect(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
                    }
<span class="nc" id="L1012">                    rv.setMotiveMod(motiveMod);</span>
<span class="nc" id="L1013">                    break;</span>
                case 5:
<span class="nc bnc" id="L1015" title="All 2 branches missed.">                    if (bSide) {</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1018">                            setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1019">                            rv = new HitData(LOC_FRONT);</span>
                        } else {
<span class="nc" id="L1021">                            rv = new HitData(LOC_FRONT, false,</span>
                                    HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                        }
<span class="nc bnc" id="L1024" title="All 2 branches missed.">                    } else if (bRear) {</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1027">                            setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1028">                            rv = new HitData(LOC_LEFT);</span>
                        } else {
<span class="nc" id="L1030">                            rv = new HitData(LOC_LEFT, false,</span>
                                    HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                        }
                    } else {
<span class="nc bnc" id="L1034" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1036">                            setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1037">                            rv = new HitData(LOC_LEFT);</span>
                        } else {
<span class="nc" id="L1039">                            rv = new HitData(LOC_LEFT, false,</span>
                                    HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                        }
                    }
<span class="nc" id="L1043">                    rv.setMotiveMod(motiveMod);</span>
<span class="nc" id="L1044">                    break;</span>
                case 6:
                case 7:
<span class="nc" id="L1047">                    break;</span>
                case 8:
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                    if (bSide</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                            &amp;&amp; !game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)) {
<span class="nc bnc" id="L1052" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1054">                            setPotCrit(HitData.EFFECT_CRITICAL);</span>
                        } else {
<span class="nc" id="L1056">                            rv.setEffect(HitData.EFFECT_CRITICAL);</span>
                        }
                    }
                    break;
                case 9:
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)) {
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                        if (bSide) {</span>
<span class="nc" id="L1064">                            rv = new HitData(LOC_REAR);</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                        } else if (bRear) {</span>
<span class="nc" id="L1066">                            rv = new HitData(LOC_RIGHT);</span>
                        } else {
<span class="nc" id="L1068">                            rv = new HitData(LOC_LEFT);</span>
                        }
                    } else {
<span class="nc bnc" id="L1071" title="All 2 branches missed.">                        if (bSide) {</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1074">                                setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1075">                                rv = new HitData(LOC_REAR);</span>
                            } else {
<span class="nc" id="L1077">                                rv = new HitData(LOC_REAR, false,</span>
                                        HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                            }
<span class="nc bnc" id="L1080" title="All 2 branches missed.">                        } else if (bRear) {</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1083">                                setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1084">                                rv = new HitData(LOC_RIGHT);</span>
                            } else {
<span class="nc" id="L1086">                                rv = new HitData(LOC_RIGHT, false,</span>
                                        HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                            }
                        } else {
<span class="nc bnc" id="L1090" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1092">                                setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1093">                                rv = new HitData(LOC_LEFT);</span>
                            } else {
<span class="nc" id="L1095">                                rv = new HitData(LOC_LEFT, false,</span>
                                        HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                            }
                        }
<span class="nc" id="L1099">                        rv.setMotiveMod(motiveMod);</span>
                    }
<span class="nc" id="L1101">                    break;</span>
                case 10:
                case 11:
<span class="nc bnc" id="L1104" title="All 2 branches missed.">                    if (!ignoreTurret) {</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">                        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L1106">                            int roll = Compute.d6();</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                            if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc" id="L1108">                                roll -= 2;</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">                            } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L1110">                                roll += 2;</span>
                            }
<span class="nc bnc" id="L1112" title="All 2 branches missed.">                            if (roll &lt;= 3) {</span>
<span class="nc" id="L1113">                                rv = new HitData(LOC_TURRET_2);</span>
                            } else {
<span class="nc" id="L1115">                                rv = new HitData(LOC_TURRET);</span>
                            }
<span class="nc" id="L1117">                        } else {</span>
<span class="nc" id="L1118">                            rv = new HitData(LOC_TURRET);</span>
                        }
                    }
                    break;
                case 12:
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                    if (ignoreTurret) {</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1126">                            setPotCrit(HitData.EFFECT_CRITICAL);</span>
                        } else {
<span class="nc" id="L1128">                            rv.setEffect(HitData.EFFECT_CRITICAL);</span>
                        }
                    } else {
<span class="nc bnc" id="L1131" title="All 2 branches missed.">                        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L1132">                            int roll = Compute.d6();</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">                            if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc" id="L1134">                                roll -= 2;</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">                            } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L1136">                                roll += 2;</span>
                            }
<span class="nc bnc" id="L1138" title="All 2 branches missed.">                            if (roll &lt;= 3) {</span>
<span class="nc bnc" id="L1139" title="All 2 branches missed.">                                if (game.getOptions().booleanOption(</span>
                                        OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1141">                                    setPotCrit(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1142">                                    rv = new HitData(LOC_TURRET_2);</span>
                                } else {
<span class="nc" id="L1144">                                    rv = new HitData(LOC_TURRET_2, false,</span>
                                            HitData.EFFECT_CRITICAL);
                                }
                            } else {
<span class="nc bnc" id="L1148" title="All 2 branches missed.">                                if (game.getOptions().booleanOption(</span>
                                        OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1150">                                    setPotCrit(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1151">                                    rv = new HitData(LOC_TURRET);</span>
                                } else {
<span class="nc" id="L1153">                                    rv = new HitData(LOC_TURRET, false,</span>
                                            HitData.EFFECT_CRITICAL);
                                }
                            }
<span class="nc" id="L1157">                        } else {</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1160">                                setPotCrit(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1161">                                rv = new HitData(LOC_TURRET);</span>
                            } else {
<span class="nc" id="L1163">                                rv = new HitData(LOC_TURRET, false,</span>
                                        HitData.EFFECT_CRITICAL);
                            }
                        }
                    }
            }
        }
<span class="nc bnc" id="L1170" title="All 2 branches missed.">        if (table == ToHitData.HIT_SWARM) {</span>
<span class="nc" id="L1171">            rv.setEffect(rv.getEffect() | HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1172">            setPotCrit(HitData.EFFECT_CRITICAL);</span>
        }
<span class="nc" id="L1174">        return rv;</span>
    }

    @Override
    public HitData rollHitLocation(int table, int side) {
<span class="nc" id="L1179">        return rollHitLocation(table, side, LOC_NONE,</span>
                IAimingModes.AIM_MODE_NONE, LosEffects.COVER_NONE);
    }

    /**
     * Gets the location that excess damage transfers to
     */
    @Override
    public HitData getTransferLocation(HitData hit) {
<span class="nc" id="L1188">        return new HitData(LOC_DESTROYED);</span>
    }

    /**
     * Gets the location that is destroyed recursively
     */
    @Override
    public int getDependentLocation(int loc) {
<span class="nc" id="L1196">        return LOC_NONE;</span>
    }

    /**
     * Calculates the battle value of this mech
     */
    @Override
    public int calculateBattleValue() {
<span class="nc bnc" id="L1204" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L1205">            return manualBV;</span>
        }

<span class="nc" id="L1208">        return calculateBattleValue(false, false);</span>
    }

    /**
     * Calculates the battle value of this tank
     */
    @Override
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L1217">            return manualBV;</span>
        }
<span class="nc bnc" id="L1219" title="All 4 branches missed.">        if (isCarcass() &amp;&amp; !ignorePilot) {</span>
<span class="nc" id="L1220">            return 0;</span>
        }
<span class="nc" id="L1222">        bvText = new StringBuffer(</span>
                &quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Battle Value Calculations For &quot;);

<span class="nc" id="L1225">        bvText.append(getChassis());</span>
<span class="nc" id="L1226">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L1227">        bvText.append(getModel());</span>
<span class="nc" id="L1228">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L1229">        bvText.append(nl);</span>

<span class="nc" id="L1231">        bvText.append(&quot;&lt;b&gt;Defensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1232">        bvText.append(nl);</span>

<span class="nc" id="L1234">        double dbv = 0; // defensive battle value</span>
<span class="nc" id="L1235">        double obv = 0; // offensive bv</span>

<span class="nc" id="L1237">        boolean blueShield = false;</span>
        // a blueshield system means a +0.2 on the armor and internal modifier,
        // like for mechs
<span class="nc bnc" id="L1240" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L1241">            blueShield = true;</span>
        }

<span class="nc" id="L1244">        bvText.append(startTable);</span>
<span class="nc" id="L1245">        double armorMultiplier = 1.0;</span>

<span class="nc bnc" id="L1247" title="All 2 branches missed.">        for (int loc = 1; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L1248">            int modularArmor = 0;</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">            for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">                if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">                        &amp;&amp; mounted.getType().hasFlag(MiscType.F_MODULAR_ARMOR)</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">                        &amp;&amp; (mounted.getLocation() == loc)) {</span>
<span class="nc" id="L1253">                    modularArmor += mounted.getBaseDamageCapacity()</span>
<span class="nc" id="L1254">                            - mounted.getDamageTaken();</span>
                }
<span class="nc" id="L1256">            }</span>
            // total armor points

<span class="nc bnc" id="L1259" title="All 5 branches missed.">            switch (getArmorType(loc)) {</span>
                case EquipmentType.T_ARMOR_COMMERCIAL:
<span class="nc" id="L1261">                    armorMultiplier = 0.5;</span>
<span class="nc" id="L1262">                    break;</span>
                case EquipmentType.T_ARMOR_HARDENED:
<span class="nc" id="L1264">                    armorMultiplier = 2.0;</span>
<span class="nc" id="L1265">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L1269">                    armorMultiplier = 1.5;</span>
<span class="nc" id="L1270">                    break;</span>
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
<span class="nc" id="L1273">                    armorMultiplier = 1.2;</span>
<span class="nc" id="L1274">                    break;</span>
                default:
<span class="nc" id="L1276">                    armorMultiplier = 1.0;</span>
                    break;
            }

<span class="nc bnc" id="L1280" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L1281">                armorMultiplier += 0.2;</span>
            }
<span class="nc" id="L1283">            bvText.append(startRow);</span>
<span class="nc" id="L1284">            bvText.append(startColumn);</span>

<span class="nc" id="L1286">            int armor = getArmor(loc) + modularArmor;</span>
<span class="nc" id="L1287">            bvText.append(&quot;Total Armor &quot; + this.getLocationAbbr(loc) + &quot; (&quot;</span>
                    + armor + &quot;) x &quot;);
<span class="nc" id="L1289">            bvText.append(armorMultiplier);</span>
<span class="nc" id="L1290">            bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L1291">            bvText.append(getBARRating(loc));</span>
<span class="nc" id="L1292">            bvText.append(&quot;/10&quot;);</span>
<span class="nc" id="L1293">            bvText.append(endColumn);</span>
<span class="nc" id="L1294">            bvText.append(startColumn);</span>
<span class="nc" id="L1295">            bvText.append(endColumn);</span>
<span class="nc" id="L1296">            bvText.append(startColumn);</span>
<span class="nc" id="L1297">            double armorBV = (getArmor(loc) + modularArmor) * armorMultiplier * (getBARRating(loc) / 10.0);</span>
<span class="nc" id="L1298">            bvText.append(armorBV);</span>
<span class="nc" id="L1299">            dbv += armorBV;</span>
<span class="nc" id="L1300">            bvText.append(endColumn);</span>
        }
<span class="nc" id="L1302">        bvText.append(startRow);</span>
<span class="nc" id="L1303">        bvText.append(startColumn);</span>
<span class="nc" id="L1304">        bvText.append(&quot;Total modified armor BV x 2.5 &quot;);</span>
<span class="nc" id="L1305">        bvText.append(endColumn);</span>
<span class="nc" id="L1306">        bvText.append(startColumn);</span>
<span class="nc" id="L1307">        bvText.append(endColumn);</span>
<span class="nc" id="L1308">        bvText.append(startColumn);</span>
<span class="nc" id="L1309">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1310">        dbv *= 2.5;</span>
<span class="nc" id="L1311">        bvText.append(dbv);</span>
<span class="nc" id="L1312">        bvText.append(endColumn);</span>
<span class="nc" id="L1313">        bvText.append(endRow);</span>
<span class="nc" id="L1314">        bvText.append(startRow);</span>
<span class="nc" id="L1315">        bvText.append(startColumn);</span>
<span class="nc" id="L1316">        bvText.append(&quot;Total I.S. Points x 1.5 x Blue Shield Multipler&quot;);</span>
<span class="nc" id="L1317">        bvText.append(endColumn);</span>
<span class="nc" id="L1318">        bvText.append(startColumn);</span>
<span class="nc" id="L1319">        bvText.append(getTotalInternal());</span>
<span class="nc" id="L1320">        bvText.append(&quot; x 1.5 x &quot;);</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">        bvText.append((blueShield ? 1.2 : 1));</span>
<span class="nc" id="L1322">        bvText.append(endColumn);</span>
<span class="nc" id="L1323">        bvText.append(startColumn);</span>
<span class="nc" id="L1324">        bvText.append(&quot;= &quot;);</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">        bvText.append(getTotalInternal() * 1.5 * (blueShield ? 1.2 : 1));</span>
<span class="nc" id="L1326">        bvText.append(endColumn);</span>
<span class="nc" id="L1327">        bvText.append(endRow);</span>
        // total internal structure
<span class="nc bnc" id="L1329" title="All 2 branches missed.">        dbv += getTotalInternal() * 1.5 * (blueShield ? 1.2 : 1);</span>

<span class="nc" id="L1331">        bvText.append(startRow);</span>
<span class="nc" id="L1332">        bvText.append(startColumn);</span>
<span class="nc" id="L1333">        bvText.append(endColumn);</span>
<span class="nc" id="L1334">        bvText.append(startColumn);</span>
<span class="nc" id="L1335">        bvText.append(endColumn);</span>
<span class="nc" id="L1336">        bvText.append(startColumn);</span>
<span class="nc" id="L1337">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1338">        bvText.append(endColumn);</span>
<span class="nc" id="L1339">        bvText.append(endRow);</span>

<span class="nc" id="L1341">        bvText.append(startRow);</span>
<span class="nc" id="L1342">        bvText.append(startColumn);</span>
<span class="nc" id="L1343">        bvText.append(&quot;Defensive Equipment&quot;);</span>
<span class="nc" id="L1344">        bvText.append(endColumn);</span>
<span class="nc" id="L1345">        bvText.append(endRow);</span>
<span class="nc" id="L1346">        bvText.append(startRow);</span>
<span class="nc" id="L1347">        bvText.append(startColumn);</span>
<span class="nc" id="L1348">        bvText.append(endColumn);</span>
<span class="nc" id="L1349">        double amsAmmoBV = 0;</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L1351">            AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L1352" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_AMS) || (atype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L1353">                amsAmmoBV += atype.getBV(this);</span>
            }
<span class="nc" id="L1355">        }</span>
<span class="nc" id="L1356">        double amsBV = 0;</span>
        // add defensive equipment
<span class="nc" id="L1358">        double dEquipmentBV = 0;</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L1360">            EquipmentType etype = mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1363" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1364">                continue;</span>
            }

<span class="nc bnc" id="L1367" title="All 2 branches missed.">            if (((etype instanceof WeaponType) &amp;&amp; (etype</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">                    .hasFlag(WeaponType.F_AMS) || etype</span>
<span class="nc bnc" id="L1369" title="All 4 branches missed.">                    .hasFlag(WeaponType.F_B_POD) || etype.hasFlag(WeaponType.F_M_POD)))) {</span>
<span class="nc" id="L1370">                bvText.append(startRow);</span>
<span class="nc" id="L1371">                bvText.append(startColumn);</span>
<span class="nc" id="L1372">                bvText.append(etype.getName());</span>
<span class="nc" id="L1373">                bvText.append(endColumn);</span>
<span class="nc" id="L1374">                bvText.append(startColumn);</span>
<span class="nc" id="L1375">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1376">                bvText.append(endColumn);</span>
<span class="nc" id="L1377">                bvText.append(endRow);</span>
<span class="nc" id="L1378">                dEquipmentBV += etype.getBV(this);</span>
<span class="nc" id="L1379">                WeaponType wtype = (WeaponType) etype;</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">                if ((wtype.hasFlag(WeaponType.F_AMS)</span>
<span class="nc bnc" id="L1381" title="All 4 branches missed.">                        &amp;&amp; (wtype.getAmmoType() == AmmoType.T_AMS)) || (wtype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L1382">                    amsBV += etype.getBV(this);</span>
                }
<span class="nc bnc" id="L1384" title="All 2 branches missed.">            } else if (((etype instanceof MiscType) &amp;&amp; (etype</span>
<span class="nc bnc" id="L1385" title="All 2 branches missed.">                    .hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_AP_POD)</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_BULLDOZER)</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_CHAFF_POD) || etype</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">                    .hasFlag(MiscType.F_BAP)))</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L1394">                MiscType mtype = (MiscType) etype;</span>
<span class="nc" id="L1395">                double bv = mtype.getBV(this, mounted.getLocation());</span>
<span class="nc" id="L1396">                bvText.append(startColumn);</span>
<span class="nc" id="L1397">                bvText.append(mounted.getName());</span>
<span class="nc" id="L1398">                bvText.append(endColumn);</span>
<span class="nc" id="L1399">                bvText.append(startColumn);</span>
<span class="nc" id="L1400">                bvText.append(bv);</span>
<span class="nc" id="L1401">                dEquipmentBV += bv;</span>
<span class="nc" id="L1402">                bvText.append(endColumn);</span>
<span class="nc" id="L1403">                bvText.append(endRow);</span>
            }
<span class="nc" id="L1405">        }</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">        if (amsAmmoBV &gt; 0) {</span>
<span class="nc" id="L1407">            bvText.append(startRow);</span>
<span class="nc" id="L1408">            bvText.append(startColumn);</span>

<span class="nc" id="L1410">            bvText.append(&quot;AMS Ammo (to a maximum of AMS BV)&quot;);</span>
<span class="nc" id="L1411">            bvText.append(endColumn);</span>
<span class="nc" id="L1412">            bvText.append(startColumn);</span>
<span class="nc" id="L1413">            bvText.append(endColumn);</span>
<span class="nc" id="L1414">            bvText.append(startColumn);</span>
<span class="nc" id="L1415">            bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1416">            bvText.append(Math.min(amsBV, amsAmmoBV));</span>
<span class="nc" id="L1417">            bvText.append(endColumn);</span>
<span class="nc" id="L1418">            bvText.append(endRow);</span>
<span class="nc" id="L1419">            dEquipmentBV += Math.min(amsBV, amsAmmoBV);</span>
        }
<span class="nc" id="L1421">        bvText.append(endRow);</span>
<span class="nc" id="L1422">        bvText.append(startRow);</span>
<span class="nc" id="L1423">        bvText.append(startColumn);</span>
<span class="nc" id="L1424">        bvText.append(endColumn);</span>
<span class="nc" id="L1425">        bvText.append(startColumn);</span>
<span class="nc" id="L1426">        bvText.append(endColumn);</span>
<span class="nc" id="L1427">        bvText.append(startColumn);</span>
<span class="nc" id="L1428">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1429">        bvText.append(dEquipmentBV);</span>
<span class="nc" id="L1430">        bvText.append(endColumn);</span>
<span class="nc" id="L1431">        bvText.append(endRow);</span>
<span class="nc" id="L1432">        bvText.append(startRow);</span>

<span class="nc" id="L1434">        dbv += dEquipmentBV;</span>

<span class="nc" id="L1436">        bvText.append(startRow);</span>
<span class="nc" id="L1437">        bvText.append(startColumn);</span>
<span class="nc" id="L1438">        bvText.append(endColumn);</span>
<span class="nc" id="L1439">        bvText.append(startColumn);</span>
<span class="nc" id="L1440">        bvText.append(endColumn);</span>
<span class="nc" id="L1441">        bvText.append(startColumn);</span>
<span class="nc" id="L1442">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1443">        bvText.append(endColumn);</span>
<span class="nc" id="L1444">        bvText.append(endRow);</span>

        double typeModifier;
<span class="nc bnc" id="L1447" title="All 5 branches missed.">        switch (getMovementMode()) {</span>
            case TRACKED:
<span class="nc" id="L1449">                typeModifier = 0.9;</span>
<span class="nc" id="L1450">                break;</span>
            case WHEELED:
<span class="nc" id="L1452">                typeModifier = 0.8;</span>
<span class="nc" id="L1453">                break;</span>
            case HOVER:
            case VTOL:
            case WIGE:
<span class="nc" id="L1457">                typeModifier = 0.7;</span>
<span class="nc" id="L1458">                break;</span>
            case NAVAL:
            case RAIL:
<span class="nc" id="L1461">                typeModifier = 0.6;</span>
<span class="nc" id="L1462">                break;</span>
            default:
<span class="nc" id="L1464">                typeModifier = 0.6;</span>
        }

<span class="nc bnc" id="L1467" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc bnc" id="L1468" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L1470">                    typeModifier += 0.2;</span>
<span class="nc bnc" id="L1471" title="All 2 branches missed.">                } else if (m.getType().hasFlag(MiscType.F_LIMITED_AMPHIBIOUS)</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_DUNE_BUGGY)</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_FLOTATION_HULL)</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)</span>
<span class="nc bnc" id="L1475" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L1476">                    typeModifier += 0.1;</span>
                }
<span class="nc" id="L1478">            }</span>
        }
<span class="nc" id="L1480">        typeModifier = Math.round(typeModifier * 10.0) / 10.0;</span>
<span class="nc" id="L1481">        bvText.append(startColumn);</span>
<span class="nc" id="L1482">        bvText.append(&quot;x Body Type Modifier&quot;);</span>
<span class="nc" id="L1483">        bvText.append(endColumn);</span>
<span class="nc" id="L1484">        bvText.append(startColumn);</span>
<span class="nc" id="L1485">        bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L1486">        bvText.append(typeModifier);</span>
<span class="nc" id="L1487">        bvText.append(endColumn);</span>
<span class="nc" id="L1488">        bvText.append(startColumn);</span>
<span class="nc" id="L1489">        bvText.append(endColumn);</span>

<span class="nc" id="L1491">        dbv *= typeModifier;</span>

<span class="nc" id="L1493">        bvText.append(endRow);</span>
<span class="nc" id="L1494">        bvText.append(startRow);</span>
<span class="nc" id="L1495">        bvText.append(startColumn);</span>
<span class="nc" id="L1496">        bvText.append(&quot;x Target Movement modifier&quot;);</span>
<span class="nc" id="L1497">        bvText.append(endColumn);</span>
        // adjust for target movement modifier
<span class="nc" id="L1499">        double tmmRan = Compute.getTargetMovementModifier(</span>
<span class="nc" id="L1500">                getRunMP(false, true, true), this instanceof VTOL,</span>
<span class="nc" id="L1501">                this instanceof VTOL, game).getValue();</span>
        // for the future, when we implement jumping tanks
<span class="nc bnc" id="L1503" title="All 2 branches missed.">        double tmmJumped = (getJumpMP() &gt; 0) ? Compute.</span>
<span class="nc" id="L1504">                getTargetMovementModifier(getJumpMP(), true, false, game).</span>
<span class="nc" id="L1505">                getValue() : 0;</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">        if (hasStealth()) {</span>
<span class="nc" id="L1507">            tmmRan += 2;</span>
<span class="nc" id="L1508">            tmmJumped += 2;</span>
        }
<span class="nc bnc" id="L1510" title="All 2 branches missed.">        if (getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L1511">            tmmRan += 1;</span>
<span class="nc" id="L1512">            tmmJumped += 1;</span>
        }
<span class="nc" id="L1514">        double tmmFactor = 1 + (Math.max(tmmRan, tmmJumped) / 10);</span>
<span class="nc" id="L1515">        dbv *= tmmFactor;</span>
        // Deal with floating point errors
<span class="nc" id="L1517">        dbv = Math.round(dbv * 100000.0) / 100000.0;</span>

<span class="nc" id="L1519">        bvText.append(startColumn);</span>
<span class="nc" id="L1520">        bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L1521">        bvText.append(tmmFactor);</span>
<span class="nc" id="L1522">        bvText.append(endColumn);</span>
<span class="nc" id="L1523">        bvText.append(endRow);</span>

<span class="nc" id="L1525">        bvText.append(startRow);</span>
<span class="nc" id="L1526">        bvText.append(startColumn);</span>
<span class="nc" id="L1527">        bvText.append(endColumn);</span>
<span class="nc" id="L1528">        bvText.append(startColumn);</span>
<span class="nc" id="L1529">        bvText.append(endColumn);</span>
<span class="nc" id="L1530">        bvText.append(startColumn);</span>
<span class="nc" id="L1531">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1532">        bvText.append(endColumn);</span>
<span class="nc" id="L1533">        bvText.append(endRow);</span>
<span class="nc" id="L1534">        bvText.append(startRow);</span>
<span class="nc" id="L1535">        bvText.append(startColumn);</span>
<span class="nc" id="L1536">        bvText.append(endColumn);</span>
<span class="nc" id="L1537">        bvText.append(startColumn);</span>
<span class="nc" id="L1538">        bvText.append(endColumn);</span>
<span class="nc" id="L1539">        bvText.append(startColumn);</span>
<span class="nc" id="L1540">        bvText.append(dbv);</span>
<span class="nc" id="L1541">        bvText.append(endColumn);</span>
<span class="nc" id="L1542">        bvText.append(endRow);</span>

<span class="nc" id="L1544">        double weaponBV = 0;</span>

        // figure out base weapon bv
<span class="nc" id="L1547">        double weaponsBVFront = 0;</span>
<span class="nc" id="L1548">        double weaponsBVRear = 0;</span>
<span class="nc" id="L1549">        boolean hasTargComp = hasTargComp();</span>
<span class="nc" id="L1550">        double targetingSystemBVMod = 1.0;</span>

<span class="nc bnc" id="L1552" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL)) {</span>
<span class="nc" id="L1554">                targetingSystemBVMod = 1.0;</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">            } else if (hasWorkingMisc(MiscType.F_BASIC_FIRECONTROL)) {</span>
<span class="nc" id="L1556">                targetingSystemBVMod = .9;</span>
            } else {
<span class="nc" id="L1558">                targetingSystemBVMod = .8;</span>
            }
        }

<span class="nc" id="L1562">        bvText.append(startRow);</span>
<span class="nc" id="L1563">        bvText.append(startColumn);</span>
<span class="nc" id="L1564">        bvText.append(&quot;Weapons&quot;);</span>
<span class="nc" id="L1565">        bvText.append(endColumn);</span>
<span class="nc" id="L1566">        bvText.append(startColumn);</span>
<span class="nc" id="L1567">        bvText.append(endColumn);</span>
<span class="nc" id="L1568">        bvText.append(endRow);</span>

<span class="nc" id="L1570">        bvText.append(startRow);</span>
<span class="nc" id="L1571">        bvText.append(startColumn);</span>
        // and add up BVs for ammo-using weapon types for excessive ammo rule
<span class="nc" id="L1573">        Map&lt;String, Double&gt; weaponsForExcessiveAmmo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc" id="L1575">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L1576">            double dBV = wtype.getBV(this);</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1579" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1580">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L1584" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L1585">                continue;</span>
            }
<span class="nc bnc" id="L1587" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L1588">                continue;</span>
            }
<span class="nc bnc" id="L1590" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_M_POD)) {</span>
<span class="nc" id="L1591">                continue;</span>
            }
<span class="nc" id="L1593">            String weaponName = wtype.getName();</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">            if (mounted.getLinkedBy() != null) {</span>
                // check to see if the weapon is a PPC and has a Capacitor
                // attached to it
<span class="nc bnc" id="L1597" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_PPC)) {</span>
<span class="nc" id="L1598">                    dBV += ((MiscType) mounted.getLinkedBy().getType()).getBV(</span>
                            this, mounted);
<span class="nc" id="L1600">                    weaponName = weaponName.concat(&quot; with Capacitor&quot;);</span>
                }
            }


            // calc MG Array here:
<span class="nc bnc" id="L1606" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L1607">                double mgBV = 0;</span>
<span class="nc bnc" id="L1608" title="All 2 branches missed.">                for (int eqNum : mounted.getBayWeapons()) {</span>
<span class="nc" id="L1609">                    Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L1610" title="All 4 branches missed.">                    if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L1611">                        mgBV += mg.getType().getBV(this);</span>
                    }
<span class="nc" id="L1613">                }</span>
<span class="nc" id="L1614">                dBV = mgBV * 0.67;</span>
            }

<span class="nc" id="L1617">            bvText.append(weaponName);</span>
<span class="nc" id="L1618">            bvText.append(&quot; &quot;);</span>
<span class="nc" id="L1619">            bvText.append(dBV);</span>

            // artemis bumps up the value
<span class="nc bnc" id="L1622" title="All 2 branches missed.">            if (mounted.getLinkedBy() != null) {</span>
<span class="nc" id="L1623">                Mounted mLinker = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L1624" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1625" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</span>
<span class="nc" id="L1626">                    dBV *= 1.2;</span>
<span class="nc" id="L1627">                    bvText.append(&quot; x 1.2 Artemis IV&quot;);</span>
                }
<span class="nc bnc" id="L1629" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1630" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_PROTO)) {</span>
<span class="nc" id="L1631">                    dBV *= 1.1;</span>
<span class="nc" id="L1632">                    bvText.append(&quot; x 1.1 Artemis IV Prototype&quot;);</span>
                }
<span class="nc bnc" id="L1634" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</span>
<span class="nc" id="L1636">                    dBV *= 1.3;</span>
<span class="nc" id="L1637">                    bvText.append(&quot; x 1.3 Artemis V&quot;);</span>
                }
<span class="nc bnc" id="L1639" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</span>
<span class="nc" id="L1641">                    dBV *= 1.15;</span>
<span class="nc" id="L1642">                    bvText.append(&quot; x 1.15 Apollo&quot;);</span>
                }
<span class="nc bnc" id="L1644" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L1646">                    dBV *= 1.15;</span>
<span class="nc" id="L1647">                    bvText.append(&quot; x 1.15 RISC Laser Pulse Module&quot;);</span>
                }
            }
<span class="nc bnc" id="L1650" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L1651">                dBV *= 0.8;</span>
<span class="nc" id="L1652">                bvText.append(&quot; x 0.8 Drone OS&quot;);</span>
            }


            // and we'll add the tcomp here too
<span class="nc bnc" id="L1657" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; hasTargComp) {</span>
<span class="nc" id="L1658">                dBV *= 1.25;</span>
<span class="nc" id="L1659">                bvText.append(&quot; x 1.25 Direct Fire and TC&quot;);</span>
<span class="nc bnc" id="L1660" title="All 4 branches missed.">            } else if (isSupportVehicle() &amp;&amp; !wtype.hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L1661">                dBV *= targetingSystemBVMod;</span>
<span class="nc" id="L1662">                bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L1663">                bvText.append(targetingSystemBVMod);</span>
<span class="nc" id="L1664">                bvText.append(&quot; Targeting System&quot;);</span>
            }
<span class="nc" id="L1666">            bvText.append(endColumn);</span>
<span class="nc" id="L1667">            bvText.append(startColumn);</span>
<span class="nc bnc" id="L1668" title="All 2 branches missed.">            if (mounted.getLocation() == (this instanceof SuperHeavyTank ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">                    : this instanceof LargeSupportTank ? LargeSupportTank.LOC_REAR</span>
<span class="nc bnc" id="L1670" title="All 2 branches missed.">                    : LOC_REAR)) {</span>
<span class="nc" id="L1671">                weaponsBVRear += dBV;</span>
<span class="nc" id="L1672">                bvText.append(&quot; Rear&quot;);</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">            } else if (mounted.getLocation() == LOC_FRONT) {</span>
<span class="nc" id="L1674">                weaponsBVFront += dBV;</span>
<span class="nc" id="L1675">                bvText.append(&quot; Front&quot;);</span>
            } else {
<span class="nc" id="L1677">                weaponBV += dBV;</span>
<span class="nc" id="L1678">                bvText.append(&quot; Side/Turret&quot;);</span>
            }
            // add up BV of ammo-using weapons for each type of weapon,
            // to compare with ammo BV later for excessive ammo BV rule
<span class="nc bnc" id="L1682" title="All 4 branches missed.">            if (!((wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !((wtype.getAmmoType() == AmmoType.T_PLASMA)</span>
<span class="nc bnc" id="L1683" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_HEAVY_FLAMER) || (wtype</span>
<span class="nc bnc" id="L1685" title="All 2 branches missed.">                    .getAmmoType() == AmmoType.T_CHEMICAL_LASER)))</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_INFANTRY) || (wtype</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">                    .getAmmoType() == AmmoType.T_NA))) {</span>
<span class="nc" id="L1689">                String key = wtype.getAmmoType() + &quot;:&quot; + wtype.getRackSize();</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">                if (!weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L1691">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this));</span>
                } else {
<span class="nc" id="L1693">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this)</span>
<span class="nc" id="L1694">                            + weaponsForExcessiveAmmo.get(key));</span>
                }
            }
<span class="nc" id="L1697">            bvText.append(endColumn);</span>
<span class="nc" id="L1698">            bvText.append(startColumn);</span>
<span class="nc" id="L1699">            bvText.append(dBV);</span>
<span class="nc" id="L1700">            bvText.append(endColumn);</span>

<span class="nc" id="L1702">            bvText.append(endRow);</span>

<span class="nc" id="L1704">            bvText.append(startRow);</span>
<span class="nc" id="L1705">            bvText.append(startColumn);</span>
<span class="nc" id="L1706">        }</span>

<span class="nc" id="L1708">        bvText.append(endColumn);</span>
<span class="nc" id="L1709">        bvText.append(endRow);</span>
<span class="nc" id="L1710">        bvText.append(startRow);</span>
<span class="nc" id="L1711">        bvText.append(startColumn);</span>
<span class="nc" id="L1712">        bvText.append(endColumn);</span>
<span class="nc" id="L1713">        bvText.append(startColumn);</span>
<span class="nc" id="L1714">        bvText.append(endColumn);</span>

<span class="nc bnc" id="L1716" title="All 2 branches missed.">        if (weaponsBVFront &gt; weaponsBVRear) {</span>
<span class="nc" id="L1717">            weaponBV += weaponsBVFront;</span>
<span class="nc" id="L1718">            weaponBV += (weaponsBVRear * 0.5);</span>
        } else {
<span class="nc" id="L1720">            weaponBV += weaponsBVRear;</span>
<span class="nc" id="L1721">            weaponBV += (weaponsBVFront * 0.5);</span>
        }

<span class="nc" id="L1724">        bvText.append(startColumn);</span>
<span class="nc" id="L1725">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1726">        bvText.append(weaponBV);</span>
<span class="nc" id="L1727">        bvText.append(endColumn);</span>
<span class="nc" id="L1728">        bvText.append(endRow);</span>

<span class="nc" id="L1730">        bvText.append(startRow);</span>
<span class="nc" id="L1731">        bvText.append(startColumn);</span>
<span class="nc" id="L1732">        bvText.append(endColumn);</span>
<span class="nc" id="L1733">        bvText.append(startColumn);</span>
<span class="nc" id="L1734">        bvText.append(endColumn);</span>
<span class="nc" id="L1735">        bvText.append(startColumn);</span>
<span class="nc" id="L1736">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1737">        bvText.append(endColumn);</span>
<span class="nc" id="L1738">        bvText.append(endRow);</span>

<span class="nc" id="L1740">        bvText.append(startRow);</span>

<span class="nc" id="L1742">        bvText.append(&quot;Ammo BV&quot;);</span>
<span class="nc" id="L1743">        bvText.append(endRow);</span>

<span class="nc" id="L1745">        bvText.append(startRow);</span>
<span class="nc" id="L1746">        bvText.append(startColumn);</span>
<span class="nc" id="L1747">        bvText.append(endColumn);</span>
<span class="nc" id="L1748">        bvText.append(startColumn);</span>
        // add ammo bv
<span class="nc" id="L1750">        double ammoBV = 0;</span>
        // extra BV for when we have semiguided LRMs and someone else has TAG on
        // our team
<span class="nc" id="L1753">        double tagBV = 0;</span>
<span class="nc" id="L1754">        Map&lt;String, Double&gt; ammo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L1755">        ArrayList&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L1756" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L1757">            AmmoType atype = (AmmoType) mounted.getType();</span>

            // don't count depleted ammo
<span class="nc bnc" id="L1760" title="All 2 branches missed.">            if (mounted.getUsableShotsLeft() == 0) {</span>
<span class="nc" id="L1761">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L1765" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_AMS) || (atype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L1766">                continue;</span>
            }

            // don't count oneshot ammo, it's considered part of the launcher.
<span class="nc bnc" id="L1770" title="All 2 branches missed.">            if (mounted.getLocation() == Entity.LOC_NONE) {</span>
                // assumption: ammo without a location is for a oneshot weapon
<span class="nc" id="L1772">                continue;</span>
            }

<span class="nc" id="L1775">            bvText.append(atype.getName());</span>
<span class="nc" id="L1776">            bvText.append(endColumn);</span>
<span class="nc" id="L1777">            bvText.append(startColumn);</span>

            // semiguided or homing ammo might count double
<span class="nc bnc" id="L1780" title="All 2 branches missed.">            if ((atype.getMunitionType() == AmmoType.M_SEMIGUIDED)</span>
<span class="nc bnc" id="L1781" title="All 2 branches missed.">                    || (atype.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L1782">                IPlayer tmpP = getOwner();</span>
                // Okay, actually check for friendly TAG.
<span class="nc bnc" id="L1784" title="All 2 branches missed.">                if (tmpP != null) {</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">                    if (tmpP.hasTAG()) {</span>
<span class="nc" id="L1786">                        tagBV += atype.getBV(this);</span>
<span class="nc bnc" id="L1787" title="All 4 branches missed.">                    } else if ((tmpP.getTeam() != IPlayer.TEAM_NONE)</span>
                            &amp;&amp; (game != null)) {
<span class="nc" id="L1789">                        for (Enumeration&lt;Team&gt; e = game.getTeams(); e</span>
<span class="nc bnc" id="L1790" title="All 2 branches missed.">                                .hasMoreElements(); ) {</span>
<span class="nc" id="L1791">                            Team m = e.nextElement();</span>
<span class="nc bnc" id="L1792" title="All 2 branches missed.">                            if (m.getId() == tmpP.getTeam()) {</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">                                if (m.hasTAG(game)) {</span>
<span class="nc" id="L1794">                                    tagBV += atype.getBV(this);</span>
<span class="nc" id="L1795">                                    bvText.append(&quot;Tag: &quot;);</span>
<span class="nc" id="L1796">                                    bvText.append(atype.getBV(this));</span>
                                }
                                // A player can't be on two teams.
                                // If we check his team and don't give the
                                // penalty, that's it.
                                break;
                            }
<span class="nc" id="L1803">                        }</span>
                    }
                }
            }
<span class="nc" id="L1807">            String key = atype.getAmmoType() + &quot;:&quot; + atype.getRackSize();</span>
<span class="nc bnc" id="L1808" title="All 2 branches missed.">            if (!keys.contains(key)) {</span>
<span class="nc" id="L1809">                keys.add(key);</span>
            }
<span class="nc bnc" id="L1811" title="All 2 branches missed.">            if (!ammo.containsKey(key)) {</span>
<span class="nc" id="L1812">                ammo.put(key, atype.getBV(this));</span>
            } else {
<span class="nc" id="L1814">                ammo.put(key, atype.getBV(this) + ammo.get(key));</span>
            }
<span class="nc" id="L1816">            bvText.append(&quot;BV: &quot;);</span>
<span class="nc" id="L1817">            bvText.append(atype.getBV(this));</span>
<span class="nc" id="L1818">            bvText.append(endColumn);</span>
<span class="nc" id="L1819">            bvText.append(endRow);</span>
<span class="nc" id="L1820">            bvText.append(startRow);</span>
<span class="nc" id="L1821">            bvText.append(startColumn);</span>
<span class="nc" id="L1822">            bvText.append(endColumn);</span>
<span class="nc" id="L1823">            bvText.append(startColumn);</span>
<span class="nc" id="L1824">        }</span>
<span class="nc" id="L1825">        bvText.append(endColumn);</span>
<span class="nc" id="L1826">        bvText.append(endRow);</span>
        // excessive ammo rule:
        // only count BV for ammo for a weapontype until the BV of all weapons
        // of that
        // type on the mech is reached
<span class="nc bnc" id="L1831" title="All 2 branches missed.">        for (String key : keys) {</span>
            // They dont exist in either hash then dont bother adding nulls.
<span class="nc bnc" id="L1833" title="All 2 branches missed.">            if (!ammo.containsKey(key)</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">                    || !weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L1835">                continue;</span>
            }
<span class="nc bnc" id="L1837" title="All 2 branches missed.">            if (ammo.get(key) &gt; weaponsForExcessiveAmmo.get(key)) {</span>
<span class="nc" id="L1838">                ammoBV += weaponsForExcessiveAmmo.get(key);</span>
            } else {
<span class="nc" id="L1840">                ammoBV += ammo.get(key);</span>
            }
<span class="nc" id="L1842">        }</span>
<span class="nc" id="L1843">        ammoBV *= targetingSystemBVMod;</span>

<span class="nc" id="L1845">        bvText.append(startRow);</span>
<span class="nc" id="L1846">        bvText.append(startColumn);</span>
<span class="nc" id="L1847">        bvText.append(endColumn);</span>
<span class="nc" id="L1848">        bvText.append(startColumn);</span>
<span class="nc" id="L1849">        bvText.append(endColumn);</span>
<span class="nc" id="L1850">        bvText.append(startColumn);</span>
<span class="nc" id="L1851">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1852">        bvText.append(ammoBV);</span>
<span class="nc" id="L1853">        bvText.append(endColumn);</span>
<span class="nc" id="L1854">        bvText.append(endRow);</span>

<span class="nc" id="L1856">        weaponBV += ammoBV;</span>

<span class="nc" id="L1858">        bvText.append(startRow);</span>
<span class="nc" id="L1859">        bvText.append(startColumn);</span>
<span class="nc" id="L1860">        bvText.append(endColumn);</span>
<span class="nc" id="L1861">        bvText.append(startColumn);</span>
<span class="nc" id="L1862">        bvText.append(endColumn);</span>
<span class="nc" id="L1863">        bvText.append(startColumn);</span>
<span class="nc" id="L1864">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1865">        bvText.append(endColumn);</span>
<span class="nc" id="L1866">        bvText.append(endRow);</span>

        // add offensive misc. equipment BV (everything except AMS, A-Pod, ECM -
        // BMR p152)
<span class="nc" id="L1870">        bvText.append(startRow);</span>
<span class="nc" id="L1871">        bvText.append(startColumn);</span>
<span class="nc" id="L1872">        bvText.append(&quot;Offensive Equipment&quot;);</span>
<span class="nc" id="L1873">        bvText.append(endColumn);</span>
<span class="nc" id="L1874">        bvText.append(endRow);</span>
<span class="nc" id="L1875">        bvText.append(startRow);</span>
<span class="nc" id="L1876">        bvText.append(startColumn);</span>
<span class="nc" id="L1877">        bvText.append(endColumn);</span>
<span class="nc" id="L1878">        bvText.append(startColumn);</span>

<span class="nc" id="L1880">        double oEquipmentBV = 0;</span>
<span class="nc bnc" id="L1881" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L1882">            MiscType mtype = (MiscType) mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1885" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1886">                continue;</span>
            }

<span class="nc bnc" id="L1889" title="All 2 branches missed.">            if ((mtype.hasFlag(MiscType.F_ECM) &amp;&amp; !mtype</span>
<span class="nc bnc" id="L1890" title="All 2 branches missed.">                    .hasFlag(MiscType.F_WATCHDOG))</span>
<span class="nc bnc" id="L1891" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_AP_POD)</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1893" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_CHAFF_POD)</span>
<span class="nc bnc" id="L1896" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L1897" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_BULLDOZER)</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_TARGCOMP)</span>
<span class="nc bnc" id="L1899" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L1900">                continue;</span>
            }
<span class="nc" id="L1902">            double bv = mtype.getBV(this, mounted.getLocation());</span>
            // we need to special case watchdog, because it has both offensive
            // and defensive BV
<span class="nc bnc" id="L1905" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_WATCHDOG)) {</span>
<span class="nc" id="L1906">                bv = 7;</span>
            }
<span class="nc" id="L1908">            oEquipmentBV += bv;</span>
<span class="nc" id="L1909">            bvText.append(mounted.getName());</span>
<span class="nc" id="L1910">            bvText.append(endColumn);</span>
<span class="nc" id="L1911">            bvText.append(startColumn);</span>
<span class="nc" id="L1912">            bvText.append(bv);</span>
<span class="nc" id="L1913">            bvText.append(endColumn);</span>
<span class="nc" id="L1914">            bvText.append(endRow);</span>
<span class="nc" id="L1915">            bvText.append(startRow);</span>
<span class="nc" id="L1916">            bvText.append(startColumn);</span>
<span class="nc" id="L1917">            bvText.append(endColumn);</span>
<span class="nc" id="L1918">            bvText.append(startColumn);</span>
<span class="nc" id="L1919">        }</span>

<span class="nc" id="L1921">        bvText.append(endRow);</span>
<span class="nc" id="L1922">        bvText.append(startRow);</span>
<span class="nc" id="L1923">        bvText.append(startColumn);</span>
<span class="nc" id="L1924">        bvText.append(endColumn);</span>
<span class="nc" id="L1925">        bvText.append(startColumn);</span>
<span class="nc" id="L1926">        bvText.append(endColumn);</span>
<span class="nc" id="L1927">        bvText.append(startColumn);</span>
<span class="nc" id="L1928">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1929">        bvText.append(oEquipmentBV);</span>
<span class="nc" id="L1930">        bvText.append(endColumn);</span>
<span class="nc" id="L1931">        bvText.append(endRow);</span>

<span class="nc" id="L1933">        weaponBV += oEquipmentBV;</span>

<span class="nc" id="L1935">        bvText.append(startRow);</span>
<span class="nc" id="L1936">        bvText.append(startColumn);</span>
<span class="nc" id="L1937">        bvText.append(endColumn);</span>
<span class="nc" id="L1938">        bvText.append(startColumn);</span>
<span class="nc" id="L1939">        bvText.append(endColumn);</span>
<span class="nc" id="L1940">        bvText.append(startColumn);</span>
<span class="nc" id="L1941">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1942">        bvText.append(endColumn);</span>
<span class="nc" id="L1943">        bvText.append(endRow);</span>

<span class="nc" id="L1945">        bvText.append(startRow);</span>
<span class="nc" id="L1946">        bvText.append(startColumn);</span>
<span class="nc" id="L1947">        bvText.append(&quot;+ weight / 2&quot;);</span>
<span class="nc" id="L1948">        bvText.append(endColumn);</span>
<span class="nc" id="L1949">        bvText.append(startColumn);</span>
<span class="nc" id="L1950">        bvText.append(getWeight());</span>
<span class="nc" id="L1951">        bvText.append(&quot; / 2 &quot;);</span>
<span class="nc" id="L1952">        bvText.append(endColumn);</span>
<span class="nc" id="L1953">        bvText.append(startColumn);</span>
<span class="nc" id="L1954">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1955">        bvText.append(getWeight() / 2);</span>
<span class="nc" id="L1956">        bvText.append(endColumn);</span>
<span class="nc" id="L1957">        bvText.append(endRow);</span>

<span class="nc" id="L1959">        weaponBV += getWeight() / 2;</span>

        // adjust further for speed factor
<span class="nc" id="L1962">        double runMP = getRunMP(false, true, true);</span>

        // Trains use cruise instead of flank MP for speed factor
<span class="nc bnc" id="L1965" title="All 4 branches missed.">        if (getMovementMode().equals(EntityMovementMode.RAIL) || getMovementMode().equals(EntityMovementMode.MAGLEV)) {</span>
<span class="nc" id="L1966">            runMP = getWalkMP(false, true, true);</span>
        }
        // trailers have original run MP of 0, but should count at 1 for speed
        // factor calculation
<span class="nc bnc" id="L1970" title="All 2 branches missed.">        if (getOriginalRunMP() == 0) {</span>
<span class="nc" id="L1971">            runMP = 1;</span>
        }
<span class="nc" id="L1973">        double speedFactor = Math</span>
<span class="nc" id="L1974">                .pow(1 + (((runMP + (Math.round(getJumpMP(false) / 2.0))) - 5)</span>
                        / 10), 1.2);
<span class="nc" id="L1976">        speedFactor = Math.round(speedFactor * 100) / 100.0;</span>

<span class="nc" id="L1978">        obv = weaponBV * speedFactor;</span>

<span class="nc" id="L1980">        bvText.append(startRow);</span>
<span class="nc" id="L1981">        bvText.append(startColumn);</span>
<span class="nc" id="L1982">        bvText.append(&quot;+ weapons bv * speed factor&quot;);</span>
<span class="nc" id="L1983">        bvText.append(endColumn);</span>
<span class="nc" id="L1984">        bvText.append(startColumn);</span>
<span class="nc" id="L1985">        bvText.append(weaponBV);</span>
<span class="nc" id="L1986">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L1987">        bvText.append(speedFactor);</span>
<span class="nc" id="L1988">        bvText.append(endColumn);</span>
<span class="nc" id="L1989">        bvText.append(startColumn);</span>
<span class="nc" id="L1990">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1991">        bvText.append(obv);</span>
<span class="nc" id="L1992">        bvText.append(endColumn);</span>
<span class="nc" id="L1993">        bvText.append(endRow);</span>

<span class="nc" id="L1995">        bvText.append(startRow);</span>
<span class="nc" id="L1996">        bvText.append(startColumn);</span>
<span class="nc" id="L1997">        bvText.append(endColumn);</span>
<span class="nc" id="L1998">        bvText.append(startColumn);</span>
<span class="nc" id="L1999">        bvText.append(endColumn);</span>
<span class="nc" id="L2000">        bvText.append(startColumn);</span>
<span class="nc" id="L2001">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L2002">        bvText.append(endColumn);</span>
<span class="nc" id="L2003">        bvText.append(endRow);</span>

        double finalBV;
<span class="nc bnc" id="L2006" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L2007">            finalBV = 2 * Math.sqrt(obv * dbv);</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">            if (finalBV == 0) {</span>
<span class="nc" id="L2009">                finalBV = dbv + obv;</span>
            }
        } else {
<span class="nc" id="L2012">            finalBV = dbv + obv;</span>
        }
<span class="nc" id="L2014">        double totalBV = finalBV;</span>

<span class="nc bnc" id="L2016" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L2017">            finalBV *= 0.95;</span>
<span class="nc" id="L2018">            finalBV = Math.round(finalBV);</span>
<span class="nc" id="L2019">            bvText.append(startRow);</span>
<span class="nc" id="L2020">            bvText.append(startColumn);</span>
<span class="nc" id="L2021">            bvText.append(&quot;Total BV * Drone Operating System Modifier&quot;);</span>
<span class="nc" id="L2022">            bvText.append(endColumn);</span>
<span class="nc" id="L2023">            bvText.append(startColumn);</span>
<span class="nc" id="L2024">            bvText.append(totalBV);</span>
<span class="nc" id="L2025">            bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L2026">            bvText.append(&quot;0.95&quot;);</span>
<span class="nc" id="L2027">            bvText.append(endColumn);</span>
<span class="nc" id="L2028">            bvText.append(startColumn);</span>
<span class="nc" id="L2029">            bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L2030">            bvText.append(finalBV);</span>
<span class="nc" id="L2031">            bvText.append(endColumn);</span>
<span class="nc" id="L2032">            bvText.append(endRow);</span>

<span class="nc" id="L2034">            bvText.append(startRow);</span>
<span class="nc" id="L2035">            bvText.append(startColumn);</span>
<span class="nc" id="L2036">            bvText.append(endColumn);</span>
<span class="nc" id="L2037">            bvText.append(startColumn);</span>
<span class="nc" id="L2038">            bvText.append(endColumn);</span>
<span class="nc" id="L2039">            bvText.append(startColumn);</span>

<span class="nc" id="L2041">            bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2042">            bvText.append(endColumn);</span>
<span class="nc" id="L2043">            bvText.append(endRow);</span>
        }

<span class="nc" id="L2046">        bvText.append(startRow);</span>
<span class="nc" id="L2047">        bvText.append(startColumn);</span>
<span class="nc" id="L2048">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L2049">        bvText.append(endColumn);</span>
<span class="nc" id="L2050">        bvText.append(startColumn);</span>
<span class="nc" id="L2051">        bvText.append(endColumn);</span>
<span class="nc" id="L2052">        bvText.append(startColumn);</span>

<span class="nc" id="L2054">        bvText.append(finalBV);</span>
<span class="nc" id="L2055">        bvText.append(endColumn);</span>
<span class="nc" id="L2056">        bvText.append(endRow);</span>

        // we get extra bv from some stuff
<span class="nc" id="L2059">        double xbv = 0.0;</span>
        // extra BV for semi-guided lrm when TAG in our team
<span class="nc" id="L2061">        xbv += tagBV;</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">        if (!ignoreC3) {</span>
<span class="nc" id="L2063">            xbv += getExtraC3BV((int) Math.round(finalBV));</span>
        }

<span class="nc" id="L2066">        finalBV = Math.round(finalBV + xbv);</span>

        // and then factor in pilot
<span class="nc" id="L2069">        double pilotFactor = 1;</span>
<span class="nc bnc" id="L2070" title="All 4 branches missed.">        if (!ignorePilot &amp;&amp; (null != getCrew())) {</span>
<span class="nc" id="L2071">            pilotFactor = getCrew().getBVSkillMultiplier(game);</span>
        }

<span class="nc" id="L2074">        int retVal = (int) Math.round((finalBV) * pilotFactor);</span>

<span class="nc" id="L2076">        bvText.append(startRow);</span>
<span class="nc" id="L2077">        bvText.append(startColumn);</span>
<span class="nc" id="L2078">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L2079">        bvText.append(endColumn);</span>
<span class="nc" id="L2080">        bvText.append(startColumn);</span>
<span class="nc" id="L2081">        bvText.append(endColumn);</span>
<span class="nc" id="L2082">        bvText.append(startColumn);</span>
<span class="nc" id="L2083">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L2084">        bvText.append(retVal);</span>
<span class="nc" id="L2085">        bvText.append(endColumn);</span>
<span class="nc" id="L2086">        bvText.append(endRow);</span>

<span class="nc" id="L2088">        return retVal;</span>
    }

    @Override
    public PilotingRollData addEntityBonuses(PilotingRollData prd) {
<span class="nc bnc" id="L2093" title="All 2 branches missed.">        if (motivePenalty &gt; 0) {</span>
<span class="nc" id="L2094">            prd.addModifier(motivePenalty, &quot;Steering Damage&quot;);</span>
        }
<span class="nc bnc" id="L2096" title="All 2 branches missed.">        if (commanderHit) {</span>
<span class="nc" id="L2097">            prd.addModifier(1, &quot;commander injured&quot;);</span>
        }
<span class="nc bnc" id="L2099" title="All 2 branches missed.">        if (driverHit) {</span>
<span class="nc" id="L2100">            prd.addModifier(2, &quot;driver injured&quot;);</span>
        }

        // are we wheeled and in light snow?
<span class="nc" id="L2104">        IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L2105" title="All 4 branches missed.">        if ((null != hex) &amp;&amp; (getMovementMode() == EntityMovementMode.WHEELED)</span>
<span class="nc bnc" id="L2106" title="All 2 branches missed.">                &amp;&amp; (hex.terrainLevel(Terrains.SNOW) == 1)) {</span>
<span class="nc" id="L2107">            prd.addModifier(1, &quot;thin snow&quot;);</span>
        }

        // VDNI bonus?
<span class="nc bnc" id="L2111" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L2112" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L2113">            prd.addModifier(-1, &quot;VDNI&quot;);</span>
        }

<span class="nc bnc" id="L2116" title="All 2 branches missed.">        if (hasModularArmor()) {</span>
<span class="nc" id="L2117">            prd.addModifier(1, &quot;Modular Armor&quot;);</span>
        }

<span class="nc" id="L2120">        return prd;</span>
    }

    @Override
    public boolean usesTurnMode() {
<span class="nc bnc" id="L2125" title="All 4 branches missed.">        return game != null &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TURN_MODE);</span>
    }

    @Override
    public Vector&lt;Report&gt; victoryReport() {
<span class="nc" id="L2130">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>

<span class="nc" id="L2132">        Report r = new Report(7025);</span>
<span class="nc" id="L2133">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L2134">        r.addDesc(this);</span>
<span class="nc" id="L2135">        vDesc.addElement(r);</span>

<span class="nc" id="L2137">        r = new Report(7035);</span>
<span class="nc" id="L2138">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L2139">        r.newlines = 0;</span>
<span class="nc" id="L2140">        vDesc.addElement(r);</span>
<span class="nc" id="L2141">        vDesc.addAll(getCrew().getDescVector(false));</span>
<span class="nc" id="L2142">        r = new Report(7070, Report.PUBLIC);</span>
<span class="nc" id="L2143">        r.add(getKillNumber());</span>
<span class="nc" id="L2144">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L2146" title="All 2 branches missed.">        if (isDestroyed()) {</span>
<span class="nc" id="L2147">            Entity killer = game.getEntity(killerId);</span>
<span class="nc bnc" id="L2148" title="All 2 branches missed.">            if (killer == null) {</span>
<span class="nc" id="L2149">                killer = game.getOutOfGameEntity(killerId);</span>
            }
<span class="nc bnc" id="L2151" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L2152">                r = new Report(7072, Report.PUBLIC);</span>
<span class="nc" id="L2153">                r.addDesc(killer);</span>
            } else {
<span class="nc" id="L2155">                r = new Report(7073, Report.PUBLIC);</span>
            }
<span class="nc" id="L2157">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">        } else if (getCrew().isEjected()) {</span>
<span class="nc" id="L2159">            r = new Report(7071, Report.PUBLIC);</span>
<span class="nc" id="L2160">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L2162">        r.newlines = 2;</span>

<span class="nc" id="L2164">        return vDesc;</span>
    }

    @Override
    public int[] getNoOfSlots() {
<span class="nc" id="L2169">        return NUM_OF_SLOTS;</span>
    }

    /**
     * Tanks don't have MASC
     */
    @Override
    public int getRunMPwithoutMASC(boolean gravity, boolean ignoreheat,
                                   boolean ignoremodulararmor) {
<span class="nc" id="L2178">        return super.getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getRunMP(boolean, boolean, boolean)
     */
    @Override
    public int getRunMP(boolean gravity, boolean ignoreheat,
                        boolean ignoremodulararmor) {
<span class="nc bnc" id="L2189" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L2190">            return (getWalkMP(gravity, ignoreheat, ignoremodulararmor) * 2);</span>
        }
<span class="nc" id="L2192">        return getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMP()
     */
    @Override
    public int getSprintMP() {
        // Overdrive
<span class="nc bnc" id="L2203" title="All 2 branches missed.">        if (game != null</span>
<span class="nc bnc" id="L2204" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2205">            return getSprintMP(true, false, false);</span>
        }
<span class="nc" id="L2207">        return getSprintMP(true, false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMP(boolean, boolean, boolean)
     */
    @Override
    public int getSprintMP(boolean gravity, boolean ignoreheat,
                           boolean ignoremodulararmor) {
<span class="nc bnc" id="L2218" title="All 2 branches missed.">        if (game != null &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L2219" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc bnc" id="L2220" title="All 2 branches missed.">            if (hasArmedMASC()) {</span>
<span class="nc" id="L2221">                return (int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                        ignoremodulararmor) * 2.5);
            } else {
<span class="nc" id="L2224">                return getSprintMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
            }
        } else {
<span class="nc" id="L2227">            return getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
        }
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMPwithoutMASC(boolean, boolean)
     */
    @Override
    public int getSprintMPwithoutMASC() {
<span class="nc" id="L2238">        return getSprintMPwithoutMASC(true, false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMPwithoutMASC(boolean, boolean,
     * boolean)
     */
    @Override
    public int getSprintMPwithoutMASC(boolean gravity, boolean ignoreheat,
                                      boolean ignoremodulararmor) {
<span class="nc bnc" id="L2250" title="All 2 branches missed.">        if (game != null &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L2251" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2252">            return (int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                    ignoremodulararmor) * 2.0);
        } else {
<span class="nc" id="L2255">            return getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
        }
    }

    public int getOriginalSprintMPwithoutMASC() {
<span class="nc bnc" id="L2260" title="All 2 branches missed.">        if (game != null &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L2261" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2262">            return (int) Math.ceil(getOriginalWalkMP() * 2.0);</span>
        } else {
<span class="nc" id="L2264">            return getOriginalRunMP();</span>
        }
    }

    /**
     * Returns this entity's Sprint mp as a string.
     */
    @Override
    public String getSprintMPasString() {
<span class="nc bnc" id="L2273" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L2274">            return getRunMPwithoutMASC() + &quot;(&quot; + getSprintMP() + &quot;)&quot;;</span>
        }
<span class="nc" id="L2276">        return Integer.toString(getSprintMP());</span>
    }

    @Override
    public int getRunningGravityLimit() {
<span class="nc bnc" id="L2281" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2282">            return getSprintMP(false, false, false);</span>
        }
<span class="nc" id="L2284">        return getRunMP(false, false, false);</span>
    }

    @Override
    public int getHeatCapacity(boolean radicalHeatSinks) {
<span class="nc" id="L2289">        return DOES_NOT_TRACK_HEAT;</span>
    }

    @Override
    public int getHeatCapacityWithWater() {
<span class="nc" id="L2294">        return getHeatCapacity();</span>
    }

    @Override
    public int getEngineCritHeat() {
<span class="nc" id="L2299">        return 0;</span>
    }

    @Override
    public void autoSetInternal() {
<span class="nc" id="L2304">        int nInternal = (int) Math.ceil(weight / 10.0);</span>

        // No internals in the body location.
<span class="nc" id="L2307">        initializeInternal(IArmorState.ARMOR_NA, LOC_BODY);</span>

<span class="nc bnc" id="L2309" title="All 2 branches missed.">        for (int x = 1; x &lt; locations(); x++) {</span>
<span class="nc" id="L2310">            initializeInternal(nInternal, x);</span>
        }
<span class="nc" id="L2312">    }</span>

    @Override
    public int getMaxElevationChange() {
<span class="nc" id="L2316">        return 1;</span>
    }

    @Override
    public int getMaxElevationDown(int currElevation) {
        // WIGEs can go down as far as they want
        // 50 is a pretty arbitrary max amount, but that's also the
        // highest elevation for VTOLs, so I'll just use that
<span class="nc bnc" id="L2324" title="All 2 branches missed.">        if ((currElevation &gt; 0)</span>
<span class="nc bnc" id="L2325" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() == EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L2326">            return 50;</span>
        }
<span class="nc" id="L2328">        return super.getMaxElevationDown(currElevation);</span>
    }

    /**
     * Determine if the unit can be repaired, or only harvested for spares.
     *
     * @return A &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit can
     * be repaired (given enough time and parts); if this value is
     * &lt;code&gt;false&lt;/code&gt;, the unit is only a source of spares.
     * @see Entity#isSalvage()
     */
    @Override
    public boolean isRepairable() {
        // A tank is repairable if it is salvageable,
        // and none of its body internals are gone.
<span class="nc" id="L2343">        boolean retval = isSalvage();</span>
<span class="nc" id="L2344">        int loc = Tank.LOC_FRONT;</span>
<span class="nc bnc" id="L2345" title="All 4 branches missed.">        while (retval &amp;&amp; (loc &lt; getLocTurret())) {</span>
<span class="nc" id="L2346">            int loc_is = this.getInternal(loc);</span>
<span class="nc" id="L2347">            loc++;</span>
<span class="nc bnc" id="L2348" title="All 4 branches missed.">            retval = (loc_is != IArmorState.ARMOR_DOOMED)</span>
                    &amp;&amp; (loc_is != IArmorState.ARMOR_DESTROYED);
<span class="nc" id="L2350">        }</span>
<span class="nc" id="L2351">        return retval;</span>
    }

    @Override
    public boolean canCharge() {
        // Tanks can charge, except Hovers when the option is set, and WIGEs
<span class="nc bnc" id="L2357" title="All 2 branches missed.">        return super.canCharge()</span>
<span class="nc bnc" id="L2358" title="All 2 branches missed.">                &amp;&amp; !(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_HOVER_CHARGE)</span>
<span class="nc bnc" id="L2359" title="All 2 branches missed.">                &amp;&amp; (EntityMovementMode.HOVER == getMovementMode()))</span>
<span class="nc bnc" id="L2360" title="All 4 branches missed.">                &amp;&amp; !(EntityMovementMode.WIGE == getMovementMode()) &amp;&amp; !(getStunnedTurns() &gt; 0);</span>
    }

    @Override
    public boolean canDFA() {
        // Tanks can't DFA
<span class="nc" id="L2366">        return false;</span>
    }

    /**
     * @return suspension factor of vehicle
     */
    public int getSuspensionFactor() {
<span class="nc" id="L2373">        return getSuspensionFactor(getMovementMode(), weight);</span>
    }

    /**
     * Static method to calculate suspension factor without needing a vehicle
     */
    public static int getSuspensionFactor(EntityMovementMode movementMode, double weight) {
<span class="nc bnc" id="L2380" title="All 8 branches missed.">        switch (movementMode) {</span>
            case HOVER:
<span class="nc bnc" id="L2382" title="All 2 branches missed.">                if (weight &lt;= 10) {</span>
<span class="nc" id="L2383">                    return 40;</span>
                }
<span class="nc bnc" id="L2385" title="All 2 branches missed.">                if (weight &lt;= 20) {</span>
<span class="nc" id="L2386">                    return 85;</span>
                }
<span class="nc bnc" id="L2388" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2389">                    return 130;</span>
                }
<span class="nc bnc" id="L2391" title="All 2 branches missed.">                if (weight &lt;= 40) {</span>
<span class="nc" id="L2392">                    return 175;</span>
                }
<span class="nc bnc" id="L2394" title="All 2 branches missed.">                if (weight &lt;= 50) {</span>
<span class="nc" id="L2395">                    return 235;</span>
                } else {
<span class="nc" id="L2397">                    return 235 + (45 * (int) Math.ceil((weight - 50) / 25f));</span>
                }
            case HYDROFOIL:
<span class="nc bnc" id="L2400" title="All 2 branches missed.">                if (weight &lt;= 10) {</span>
<span class="nc" id="L2401">                    return 60;</span>
                }
<span class="nc bnc" id="L2403" title="All 2 branches missed.">                if (weight &lt;= 20) {</span>
<span class="nc" id="L2404">                    return 105;</span>
                }
<span class="nc bnc" id="L2406" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2407">                    return 150;</span>
                }
<span class="nc bnc" id="L2409" title="All 2 branches missed.">                if (weight &lt;= 40) {</span>
<span class="nc" id="L2410">                    return 195;</span>
                }
<span class="nc bnc" id="L2412" title="All 2 branches missed.">                if (weight &lt;= 50) {</span>
<span class="nc" id="L2413">                    return 255;</span>
                }
<span class="nc bnc" id="L2415" title="All 2 branches missed.">                if (weight &lt;= 60) {</span>
<span class="nc" id="L2416">                    return 300;</span>
                }
<span class="nc bnc" id="L2418" title="All 2 branches missed.">                if (weight &lt;= 70) {</span>
<span class="nc" id="L2419">                    return 345;</span>
                }
<span class="nc bnc" id="L2421" title="All 2 branches missed.">                if (weight &lt;= 80) {</span>
<span class="nc" id="L2422">                    return 390;</span>
                }
<span class="nc bnc" id="L2424" title="All 2 branches missed.">                if (weight &lt;= 90) {</span>
<span class="nc" id="L2425">                    return 435;</span>
                }
<span class="nc" id="L2427">                return 480;</span>
            case NAVAL:
            case SUBMARINE:
<span class="nc bnc" id="L2430" title="All 2 branches missed.">                if (weight &lt;= 300) {</span>
<span class="nc" id="L2431">                    return 30;</span>
                } else {
<span class="nc" id="L2433">                    int factor = (int) Math.ceil(weight / 10);</span>
<span class="nc" id="L2434">                    factor += factor % 5;</span>
<span class="nc" id="L2435">                    return factor;</span>
                }

            case TRACKED:
<span class="nc" id="L2439">                return 0;</span>
            case WHEELED:
<span class="nc bnc" id="L2441" title="All 2 branches missed.">                if (weight &lt;= 80) {</span>
<span class="nc" id="L2442">                    return 20;</span>
                } else {
<span class="nc" id="L2444">                    return 40;</span>
                }
            case VTOL:
<span class="nc bnc" id="L2447" title="All 2 branches missed.">                if (weight &lt;= 10) {</span>
<span class="nc" id="L2448">                    return 50;</span>
                }
<span class="nc bnc" id="L2450" title="All 2 branches missed.">                if (weight &lt;= 20) {</span>
<span class="nc" id="L2451">                    return 95;</span>
                }
<span class="nc bnc" id="L2453" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2454">                    return 140;</span>
                } else {
<span class="nc" id="L2456">                    return 140 + (45 * (int) Math.ceil((weight - 30) / 20f));</span>
                }

            case WIGE:
<span class="nc bnc" id="L2460" title="All 2 branches missed.">                if (weight &lt;= 15) {</span>
<span class="nc" id="L2461">                    return 45;</span>
                }
<span class="nc bnc" id="L2463" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2464">                    return 80;</span>
                }
<span class="nc bnc" id="L2466" title="All 2 branches missed.">                if (weight &lt;= 45) {</span>
<span class="nc" id="L2467">                    return 115;</span>
                }
<span class="nc bnc" id="L2469" title="All 2 branches missed.">                if (weight &lt;= 80) {</span>
<span class="nc" id="L2470">                    return 140;</span>
                } else {
<span class="nc" id="L2472">                    return 140 + (35 * (int) Math.ceil((weight - 80) / 30f));</span>
                }
            default:
<span class="nc" id="L2475">                return 0;</span>
        }
    }

    private void addCostDetails(double cost, double[] costs) {
<span class="nc" id="L2480">        bvText = new StringBuffer();</span>
<span class="nc" id="L2481">        ArrayList&lt;String&gt; left = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L2483" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2484">            left.add(&quot;Chassis&quot;);</span>
        }
<span class="nc" id="L2486">        left.add(&quot;Engine&quot;);</span>
<span class="nc" id="L2487">        left.add(&quot;Armor&quot;);</span>
<span class="nc bnc" id="L2488" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2489">            left.add(&quot;Final Structural Cost&quot;);</span>
        } else {
<span class="nc" id="L2491">            left.add(&quot;Internal Structure&quot;);</span>
<span class="nc" id="L2492">            left.add(&quot;Control Systems&quot;);</span>
        }
<span class="nc" id="L2494">        left.add(&quot;Power Amplifiers&quot;);</span>
<span class="nc" id="L2495">        left.add(&quot;Heat Sinks&quot;);</span>
<span class="nc" id="L2496">        left.add(&quot;Turret&quot;);</span>
<span class="nc" id="L2497">        left.add(&quot;Equipment&quot;);</span>
<span class="nc bnc" id="L2498" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc" id="L2499">            left.add(&quot;Lift Equipment&quot;);</span>
        }
<span class="nc" id="L2501">        left.add(&quot;Omni Multiplier&quot;);</span>
<span class="nc" id="L2502">        left.add(&quot;Tonnage Multiplier&quot;);</span>
<span class="nc bnc" id="L2503" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>

<span class="nc" id="L2505">            left.add(&quot;Flotation Hull/Environmental Sealing multiplier&quot;);</span>
<span class="nc" id="L2506">            left.add(&quot;Off-Road Multiplier&quot;);</span>
        }

<span class="nc" id="L2509">        NumberFormat commafy = NumberFormat.getInstance();</span>

<span class="nc" id="L2511">        bvText.append(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Cost Calculations For &quot;);</span>
<span class="nc" id="L2512">        bvText.append(getChassis());</span>
<span class="nc" id="L2513">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L2514">        bvText.append(getModel());</span>
<span class="nc" id="L2515">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L2516">        bvText.append(nl);</span>

<span class="nc" id="L2518">        bvText.append(startTable);</span>
        // find the maximum length of the columns.
<span class="nc bnc" id="L2520" title="All 2 branches missed.">        for (int l = 0; l &lt; left.size(); l++) {</span>

<span class="nc bnc" id="L2522" title="All 2 branches missed.">            if (l == 7) {</span>
<span class="nc" id="L2523">                getWeaponsAndEquipmentCost(true);</span>
            } else {
<span class="nc bnc" id="L2525" title="All 2 branches missed.">                if (left.get(l).equals(&quot;Final Structural Cost&quot;)) {</span>
<span class="nc" id="L2526">                    bvText.append(startRow);</span>
<span class="nc" id="L2527">                    bvText.append(startColumn);</span>
<span class="nc" id="L2528">                    bvText.append(endColumn);</span>
<span class="nc" id="L2529">                    bvText.append(startColumn);</span>
<span class="nc" id="L2530">                    bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2531">                    bvText.append(endColumn);</span>
<span class="nc" id="L2532">                    bvText.append(endRow);</span>
                }
<span class="nc" id="L2534">                bvText.append(startRow);</span>
<span class="nc" id="L2535">                bvText.append(startColumn);</span>
<span class="nc" id="L2536">                bvText.append(left.get(l));</span>
<span class="nc" id="L2537">                bvText.append(endColumn);</span>
<span class="nc" id="L2538">                bvText.append(startColumn);</span>

<span class="nc bnc" id="L2540" title="All 2 branches missed.">                if (costs[l] == 0) {</span>
<span class="nc" id="L2541">                    bvText.append(&quot;N/A&quot;);</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">                } else if (costs[l] &lt; 0) {</span>
<span class="nc" id="L2543">                    bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L2544">                    bvText.append(commafy.format(-costs[l]));</span>
                } else {
<span class="nc" id="L2546">                    bvText.append(commafy.format(costs[l]));</span>

                }
<span class="nc" id="L2549">                bvText.append(endColumn);</span>
<span class="nc" id="L2550">                bvText.append(endRow);</span>
            }
        }
<span class="nc" id="L2553">        bvText.append(startRow);</span>
<span class="nc" id="L2554">        bvText.append(startColumn);</span>
<span class="nc" id="L2555">        bvText.append(endColumn);</span>
<span class="nc" id="L2556">        bvText.append(startColumn);</span>
<span class="nc" id="L2557">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2558">        bvText.append(endColumn);</span>
<span class="nc" id="L2559">        bvText.append(endRow);</span>

<span class="nc" id="L2561">        bvText.append(startRow);</span>
<span class="nc" id="L2562">        bvText.append(startColumn);</span>
<span class="nc" id="L2563">        bvText.append(&quot;Total Cost:&quot;);</span>
<span class="nc" id="L2564">        bvText.append(endColumn);</span>
<span class="nc" id="L2565">        bvText.append(startColumn);</span>
<span class="nc" id="L2566">        bvText.append(commafy.format(cost));</span>
<span class="nc" id="L2567">        bvText.append(endColumn);</span>
<span class="nc" id="L2568">        bvText.append(endRow);</span>

<span class="nc" id="L2570">        bvText.append(endTable);</span>
<span class="nc" id="L2571">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>
<span class="nc" id="L2572">    }</span>

    @Override
    public double getCost(boolean ignoreAmmo) {
<span class="nc" id="L2576">        double[] costs = new double[13 + locations()];</span>
<span class="nc" id="L2577">        int i = 0;</span>
        // Chassis cost for Support Vehicles
<span class="nc bnc" id="L2579" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2580">            double chassisCost = 2500 * SupportVeeStructure.getWeightStructure(this);</span>
<span class="nc bnc" id="L2581" title="All 2 branches missed.">            if (hasMisc(MiscType.F_AMPHIBIOUS)) {</span>
<span class="nc" id="L2582">                chassisCost *= 1.25;</span>
            }
<span class="nc bnc" id="L2584" title="All 2 branches missed.">            if (hasMisc(MiscType.F_ARMORED_CHASSIS)) {</span>
<span class="nc" id="L2585">                chassisCost *= 2.0;</span>
            }
<span class="nc bnc" id="L2587" title="All 2 branches missed.">            if (hasMisc(MiscType.F_BICYCLE)) {</span>
<span class="nc" id="L2588">                chassisCost *= 0.75;</span>
            }
<span class="nc bnc" id="L2590" title="All 2 branches missed.">            if (hasMisc(MiscType.F_CONVERTIBLE)) {</span>
<span class="nc" id="L2591">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2593" title="All 2 branches missed.">            if (hasMisc(MiscType.F_DUNE_BUGGY)) {</span>
<span class="nc" id="L2594">                chassisCost *= 1.25;</span>
            }
<span class="nc bnc" id="L2596" title="All 2 branches missed.">            if (hasMisc(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L2597">                chassisCost *= 1.75;</span>
            }
<span class="nc bnc" id="L2599" title="All 2 branches missed.">            if (hasMisc(MiscType.F_EXTERNAL_POWER_PICKUP)) {</span>
<span class="nc" id="L2600">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2602" title="All 2 branches missed.">            if (hasMisc(MiscType.F_HYDROFOIL)) {</span>
<span class="nc" id="L2603">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2605" title="All 2 branches missed.">            if (hasMisc(MiscType.F_MONOCYCLE)) {</span>
<span class="nc" id="L2606">                chassisCost *= 1.3;</span>
            }
<span class="nc bnc" id="L2608" title="All 2 branches missed.">            if (hasMisc(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L2609">                chassisCost *= 1.2;</span>
            }
<span class="nc bnc" id="L2611" title="All 2 branches missed.">            if (hasMisc(MiscType.F_PROP)) {</span>
<span class="nc" id="L2612">                chassisCost *= 0.75;</span>
            }
<span class="nc bnc" id="L2614" title="All 2 branches missed.">            if (hasMisc(MiscType.F_SNOWMOBILE)) {</span>
<span class="nc" id="L2615">                chassisCost *= 1.3;</span>
            }
<span class="nc bnc" id="L2617" title="All 2 branches missed.">            if (hasMisc(MiscType.F_STOL_CHASSIS)) {</span>
<span class="nc" id="L2618">                chassisCost *= 1.5;</span>
            }
<span class="nc bnc" id="L2620" title="All 2 branches missed.">            if (hasMisc(MiscType.F_SUBMERSIBLE)) {</span>
<span class="nc" id="L2621">                chassisCost *= 3.5;</span>
            }
<span class="nc bnc" id="L2623" title="All 2 branches missed.">            if (hasMisc(MiscType.F_TRACTOR_MODIFICATION)) {</span>
<span class="nc" id="L2624">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2626" title="All 2 branches missed.">            if (hasMisc(MiscType.F_TRAILER_MODIFICATION)) {</span>
<span class="nc" id="L2627">                chassisCost *= 0.75;</span>
            }
<span class="nc bnc" id="L2629" title="All 2 branches missed.">            if (hasMisc(MiscType.F_ULTRA_LIGHT)) {</span>
<span class="nc" id="L2630">                chassisCost *= 1.5;</span>
            }
<span class="nc bnc" id="L2632" title="All 2 branches missed.">            if (hasMisc(MiscType.F_VSTOL_CHASSIS)) {</span>
<span class="nc" id="L2633">                chassisCost *= 2;</span>
            }
<span class="nc" id="L2635">            costs[i++] = chassisCost;</span>
        }

        // Engine Costs
<span class="nc" id="L2639">        double engineCost = 0.0;</span>
<span class="nc bnc" id="L2640" title="All 2 branches missed.">        if (hasEngine()) {</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">            if (isSupportVehicle()) {</span>
<span class="nc" id="L2642">                engineCost = 5000 * getEngine().getWeightEngine(this)</span>
<span class="nc" id="L2643">                        * Engine.getSVCostMultiplier(getEngine().getEngineType());</span>
            } else {
<span class="nc" id="L2645">                engineCost = (getEngine().getBaseCost() *</span>
<span class="nc" id="L2646">                        getEngine().getRating() * weight) / 75.0;</span>
            }
        }
<span class="nc" id="L2649">        costs[i++] = engineCost;</span>

        // armor
<span class="nc bnc" id="L2652" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2653">            int totalArmorPoints = 0;</span>
<span class="nc bnc" id="L2654" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L2655">                totalArmorPoints += getOArmor(loc);</span>
            }
<span class="nc" id="L2657">            costs[i++] = totalArmorPoints</span>
<span class="nc" id="L2658">                    * EquipmentType.getSupportVehicleArmorCostPerPoint(getBARRating(firstArmorIndex()));</span>
<span class="nc" id="L2659">        } else {</span>
<span class="nc bnc" id="L2660" title="All 2 branches missed.">            if (hasPatchworkArmor()) {</span>
<span class="nc bnc" id="L2661" title="All 2 branches missed.">                for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L2662">                    costs[i++] = getArmorWeight(loc)</span>
<span class="nc" id="L2663">                            * EquipmentType.getArmorCost(armorType[loc]);</span>
                }

            } else {
<span class="nc" id="L2667">                costs[i++] = getArmorWeight()</span>
<span class="nc" id="L2668">                        * EquipmentType.getArmorCost(armorType[0]);</span>
            }
        }

        // Compute final structural cost
<span class="nc" id="L2673">        int structCostIdx = 0;</span>
<span class="nc bnc" id="L2674" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2675">            structCostIdx = i++;</span>
<span class="nc" id="L2676">            costs[structCostIdx] = 0;</span>
<span class="nc bnc" id="L2677" title="All 2 branches missed.">            for (int c = 0; c &lt; structCostIdx; c++) {</span>
<span class="nc" id="L2678">                costs[structCostIdx] += costs[c];</span>
            }
<span class="nc" id="L2680">            double techRatingMultiplier = 0.5 + (getStructuralTechRating() * 0.25);</span>
<span class="nc" id="L2681">            costs[structCostIdx] *= techRatingMultiplier;</span>
<span class="nc" id="L2682">        } else {</span>
            // IS has no variations, no Endo etc., but non-naval superheavies have heavier structure
<span class="nc bnc" id="L2684" title="All 4 branches missed.">            if (!isSuperHeavy() || getMovementMode().equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2685" title="All 2 branches missed.">                    || getMovementMode().equals(EntityMovementMode.SUBMARINE)) { // There are no superheavy hydrofoils</span>
<span class="nc" id="L2686">                costs[i++] = RoundWeight.nextHalfTon(weight / 10.0) * 10000;</span>
            } else {
<span class="nc" id="L2688">                costs[i++] = RoundWeight.nextHalfTon(weight / 5.0) * 10000;</span>
            }
<span class="nc bnc" id="L2690" title="All 2 branches missed.">            double controlWeight = hasNoControlSystems() ? 0.0 : RoundWeight.nextHalfTon(weight * 0.05); // ?</span>
            // should be rounded up to nearest half-ton
<span class="nc" id="L2692">            costs[i++] = 10000 * controlWeight;</span>
        }

<span class="nc bnc" id="L2695" title="All 2 branches missed.">        double freeHeatSinks = (hasEngine() ? getEngine().getWeightFreeEngineHeatSinks() : 0);</span>
<span class="nc" id="L2696">        int sinks = TestEntity.calcHeatNeutralHSRequirement(this);</span>
<span class="nc" id="L2697">        double turretWeight = 0;</span>
<span class="nc" id="L2698">        double paWeight = getPowerAmplifierWeight();</span>
<span class="nc bnc" id="L2699" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L2700" title="All 4 branches missed.">            if ((m.getLocation() == getLocTurret()) || (m.getLocation() == getLocTurret2())) {</span>
<span class="nc" id="L2701">                turretWeight += m.getTonnage() / 10.0;</span>
<span class="nc bnc" id="L2702" title="All 4 branches missed.">                if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof MiscType)</span>
<span class="nc bnc" id="L2703" title="All 2 branches missed.">                        &amp;&amp; m.getLinkedBy().getType().hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc" id="L2704">                    turretWeight += m.getLinkedBy().getTonnage() / 10.0;</span>
                }
            }
<span class="nc" id="L2707">        }</span>
<span class="nc" id="L2708">        turretWeight = RoundWeight.standard(turretWeight, this);</span>
<span class="nc" id="L2709">        costs[i++] = 20000 * paWeight;</span>
<span class="nc" id="L2710">        costs[i++] = 2000 * Math.max(0, sinks - freeHeatSinks);</span>
<span class="nc" id="L2711">        costs[i++] = turretWeight * 5000;</span>

<span class="nc" id="L2713">        costs[i++] = getWeaponsAndEquipmentCost(ignoreAmmo) + getExtraCrewSeats() * 100;</span>

<span class="nc bnc" id="L2715" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
            double diveTonnage;
<span class="nc bnc" id="L2717" title="All 2 branches missed.">            switch (movementMode) {</span>
                case HOVER:
                case HYDROFOIL:
                case VTOL:
                case SUBMARINE:
                case WIGE:
<span class="nc" id="L2723">                    diveTonnage = Math.ceil(weight / 5.0) / 2.0;</span>
<span class="nc" id="L2724">                    break;</span>
                default:
<span class="nc" id="L2726">                    diveTonnage = 0.0;</span>
                    break;
            }
<span class="nc bnc" id="L2729" title="All 2 branches missed.">            if (movementMode != EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2730">                costs[i++] = diveTonnage * 20000;</span>
            } else {
<span class="nc" id="L2732">                costs[i++] = diveTonnage * 40000;</span>
            }
        }

<span class="nc" id="L2736">        double cost = 0; // calculate the total</span>
<span class="nc bnc" id="L2737" title="All 2 branches missed.">        for (int x = structCostIdx; x &lt; i; x++) {</span>
<span class="nc" id="L2738">            cost += costs[x];</span>
        }

        // TODO Decouple cost calculation from addCostDetails and eliminate duplicate code in getPriceMultiplier
<span class="nc bnc" id="L2742" title="All 2 branches missed.">        if (isOmni()) { // Omni conversion cost goes here.</span>
<span class="nc" id="L2743">            cost *= 1.25;</span>
<span class="nc" id="L2744">            costs[i++] = -1.25;</span>
        } else {
<span class="nc" id="L2746">            costs[i++] = 0;</span>
        }


<span class="nc" id="L2750">        double multiplier = 1.0;</span>
<span class="nc bnc" id="L2751" title="All 2 branches missed.">        if (isSupportVehicle()</span>
<span class="nc bnc" id="L2752" title="All 2 branches missed.">                &amp;&amp; (movementMode.equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2753" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2754" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.SUBMARINE))) {</span>
<span class="nc" id="L2755">            multiplier += weight / 100000.0;</span>
        } else {
<span class="nc bnc" id="L2757" title="All 8 branches missed.">            switch (movementMode) {</span>
                case HOVER:
                case SUBMARINE:
<span class="nc" id="L2760">                    multiplier += weight / 50.0;</span>
<span class="nc" id="L2761">                    break;</span>
                case HYDROFOIL:
<span class="nc" id="L2763">                    multiplier += weight / 75.0;</span>
<span class="nc" id="L2764">                    break;</span>
                case NAVAL:
                case WHEELED:
<span class="nc" id="L2767">                    multiplier += weight / 200.0;</span>
<span class="nc" id="L2768">                    break;</span>
                case TRACKED:
<span class="nc" id="L2770">                    multiplier += weight / 100.0;</span>
<span class="nc" id="L2771">                    break;</span>
                case VTOL:
<span class="nc" id="L2773">                    multiplier += weight / 30.0;</span>
<span class="nc" id="L2774">                    break;</span>
                case WIGE:
<span class="nc" id="L2776">                    multiplier += weight / 25.0;</span>
<span class="nc" id="L2777">                    break;</span>
                case RAIL:
                case MAGLEV:
<span class="nc" id="L2780">                    multiplier += weight / 250.0;</span>
                    break;
            }
        }
<span class="nc" id="L2784">        cost *= multiplier;</span>
<span class="nc" id="L2785">        costs[i++] = -multiplier;</span>

<span class="nc bnc" id="L2787" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc bnc" id="L2788" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_FLOTATION_HULL)</span>
<span class="nc bnc" id="L2789" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L2790">                cost *= 1.25;</span>
<span class="nc" id="L2791">                costs[i++] = -1.25;</span>

            }
<span class="nc bnc" id="L2794" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L2795">                cost *= 1.2;</span>
<span class="nc" id="L2796">                costs[i++] = -1.2;</span>
            }
        }


<span class="nc" id="L2801">        addCostDetails(cost, costs);</span>
<span class="nc" id="L2802">        return Math.round(cost);</span>
    }

    @Override
    public double getPriceMultiplier() {
<span class="nc" id="L2807">        double priceMultiplier = 1.0;</span>
<span class="nc bnc" id="L2808" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L2809">            priceMultiplier *= 1.25;</span>
        }
<span class="nc bnc" id="L2811" title="All 2 branches missed.">        if (isSupportVehicle()</span>
<span class="nc bnc" id="L2812" title="All 2 branches missed.">                &amp;&amp; (movementMode.equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2813" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2814" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.SUBMARINE))) {</span>
<span class="nc" id="L2815">            priceMultiplier *= weight / 100000.0;</span>
        } else {
<span class="nc bnc" id="L2817" title="All 8 branches missed.">            switch (movementMode) {</span>
                case HOVER:
                case SUBMARINE:
<span class="nc" id="L2820">                    priceMultiplier *= weight / 50.0;</span>
<span class="nc" id="L2821">                    break;</span>
                case HYDROFOIL:
<span class="nc" id="L2823">                    priceMultiplier *= weight / 75.0;</span>
<span class="nc" id="L2824">                    break;</span>
                case NAVAL:
                case WHEELED:
<span class="nc" id="L2827">                    priceMultiplier *= weight / 200.0;</span>
<span class="nc" id="L2828">                    break;</span>
                case TRACKED:
<span class="nc" id="L2830">                    priceMultiplier *= weight / 100.0;</span>
<span class="nc" id="L2831">                    break;</span>
                case VTOL:
<span class="nc" id="L2833">                    priceMultiplier *= weight / 30.0;</span>
<span class="nc" id="L2834">                    break;</span>
                case WIGE:
<span class="nc" id="L2836">                    priceMultiplier *= weight / 25.0;</span>
<span class="nc" id="L2837">                    break;</span>
                case RAIL:
                case MAGLEV:
<span class="nc" id="L2840">                    priceMultiplier *= weight / 250.0;</span>
                    break;
            }
        }
<span class="nc bnc" id="L2844" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc bnc" id="L2845" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_FLOTATION_HULL)</span>
<span class="nc bnc" id="L2846" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_VACUUM_PROTECTION)</span>
<span class="nc bnc" id="L2847" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L2848">                priceMultiplier *= 1.25;</span>

            }
<span class="nc bnc" id="L2851" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L2852">                priceMultiplier *= 1.2;</span>
            }
        }
<span class="nc" id="L2855">        return priceMultiplier;</span>
    }

    @Override
    protected int implicitClanCASE() {
<span class="nc bnc" id="L2860" title="All 2 branches missed.">        if (!isClan()) {</span>
<span class="nc" id="L2861">            return 0;</span>
        }
<span class="nc" id="L2863">        int explicit = 0;</span>
<span class="nc" id="L2864">        Set&lt;Integer&gt; caseLocations = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2865" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L2866" title="All 4 branches missed.">            if ((m.getType() instanceof MiscType) &amp;&amp; (m.getType().hasFlag(MiscType.F_CASE))) {</span>
<span class="nc" id="L2867">                explicit++;</span>
<span class="nc bnc" id="L2868" title="All 2 branches missed.">            } else if (m.getType().isExplosive(m)) {</span>
<span class="nc" id="L2869">                caseLocations.add(m.getLocation());</span>
<span class="nc bnc" id="L2870" title="All 2 branches missed.">                if (m.getSecondLocation() &gt;= 0) {</span>
<span class="nc" id="L2871">                    caseLocations.add(m.getSecondLocation());</span>
                }
            }
<span class="nc" id="L2874">        }</span>
<span class="nc" id="L2875">        return Math.max(0, caseLocations.size() - explicit);</span>
    }

    @Override
    public boolean doomedInExtremeTemp() {
<span class="nc" id="L2880">        return false;</span>
    }

    @Override
    public boolean doomedInVacuum() {
<span class="nc bnc" id="L2885" title="All 6 branches missed.">        if (hasEngine() &amp;&amp; (getEngine().isFusion() || getEngine().getEngineType() == Engine.FISSION</span>
<span class="nc bnc" id="L2886" title="All 2 branches missed.">                || getEngine().getEngineType() == Engine.FUEL_CELL)) {</span>
<span class="nc bnc" id="L2887" title="All 2 branches missed.">            return !hasEnvironmentalSealing();</span>
        }
<span class="nc" id="L2889">        return true;</span>
    }

    @Override
    public boolean hasEnvironmentalSealing() {
<span class="nc bnc" id="L2894" title="All 2 branches missed.">        return getMovementMode().equals(EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L2895" title="All 2 branches missed.">                || super.hasEnvironmentalSealing();</span>
    }

    @Override
    public boolean doomedOnGround() {
<span class="nc" id="L2900">        return false;</span>
    }

    @Override
    public boolean doomedInAtmosphere() {
<span class="nc" id="L2905">        return true;</span>
    }

    @Override
    public boolean doomedInSpace() {
<span class="nc" id="L2910">        return true;</span>
    }

    @Override
    /**
     * Checks to see if a Tank is capable of going hull-down.  This is true if
     * hull-down rules are enabled and the Tank is in a fortified hex.
     *
     *  @return True if hull-down is enabled and the Tank is in a fortified hex.
     */
    public boolean canGoHullDown() {
        // MoveStep line 2179 performs this same check
        // performing it here will allow us to disable the Hulldown button
        // if the movement is illegal
<span class="nc" id="L2924">        IHex occupiedHex = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L2925" title="All 2 branches missed.">        return occupiedHex.containsTerrain(Terrains.FORTIFIED)</span>
<span class="nc bnc" id="L2926" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_HULL_DOWN);</span>
    }

    public void setOnFire(boolean inferno) {
<span class="nc" id="L2930">        infernoFire |= inferno;</span>
<span class="nc" id="L2931">        burningLocations = (1 &lt;&lt; locations()) - 1;</span>
<span class="nc" id="L2932">        extinguishLocation(LOC_BODY);</span>
<span class="nc" id="L2933">    }</span>

    public boolean isOnFire() {
<span class="nc bnc" id="L2936" title="All 4 branches missed.">        return (burningLocations != 0) || infernos.isStillBurning();</span>
    }

    public boolean isInfernoFire() {
<span class="nc" id="L2940">        return infernoFire;</span>
    }

    public boolean isLocationBurning(int location) {
<span class="nc" id="L2944">        int flag = (1 &lt;&lt; location);</span>
<span class="nc bnc" id="L2945" title="All 2 branches missed.">        return (burningLocations &amp; flag) == flag;</span>
    }

    public void extinguishLocation(int location) {
<span class="nc" id="L2949">        int flag = ~(1 &lt;&lt; location);</span>
<span class="nc" id="L2950">        burningLocations &amp;= flag;</span>
<span class="nc" id="L2951">    }</span>

    /**
     * extinguish all inferno fire on this Tank
     */
    public void extinguishAll() {
<span class="nc" id="L2957">        burningLocations = 0;</span>
<span class="nc" id="L2958">        infernoFire = false;</span>
<span class="nc" id="L2959">        infernos.clear();</span>
<span class="nc" id="L2960">    }</span>

    /**
     * adds minor, moderate or heavy movement system damage
     *
     * @param level a &lt;code&gt;int&lt;/code&gt; representing minor damage (1), moderate
     *              damage (2), heavy damage (3), or immobilized (4)
     */
    public void addMovementDamage(int level) {
<span class="nc bnc" id="L2969" title="All 5 branches missed.">        switch (level) {</span>
            case 1:
<span class="nc bnc" id="L2971" title="All 2 branches missed.">                if (!minorMovementDamage) {</span>
<span class="nc" id="L2972">                    minorMovementDamage = true;</span>
<span class="nc" id="L2973">                    motivePenalty += level;</span>
                }
                break;
            case 2:
<span class="nc bnc" id="L2977" title="All 2 branches missed.">                if (!moderateMovementDamage) {</span>
<span class="nc" id="L2978">                    moderateMovementDamage = true;</span>
<span class="nc" id="L2979">                    motivePenalty += level;</span>
                }
<span class="nc" id="L2981">                motiveDamage++;</span>
<span class="nc" id="L2982">                break;</span>
            case 3:
<span class="nc bnc" id="L2984" title="All 2 branches missed.">                if (!heavyMovementDamage) {</span>
<span class="nc" id="L2985">                    heavyMovementDamage = true;</span>
<span class="nc" id="L2986">                    motivePenalty += level;</span>
                }
<span class="nc" id="L2988">                int nMP = getOriginalWalkMP() - motiveDamage;</span>
<span class="nc bnc" id="L2989" title="All 2 branches missed.">                if (nMP &gt; 0) {</span>
<span class="nc" id="L2990">                    motiveDamage = getOriginalWalkMP()</span>
<span class="nc" id="L2991">                            - (int) Math.ceil(nMP / 2.0);</span>
                }
                break;
            case 4:
<span class="nc" id="L2995">                motiveDamage = getOriginalWalkMP();</span>
<span class="nc" id="L2996">                immobilize();</span>
        }
<span class="nc" id="L2998">    }</span>

    public boolean hasMinorMovementDamage() {
<span class="nc" id="L3001">        return minorMovementDamage;</span>
    }

    public boolean hasModerateMovementDamage() {
<span class="nc" id="L3005">        return moderateMovementDamage;</span>
    }

    public boolean hasHeavyMovementDamage() {
<span class="nc" id="L3009">        return heavyMovementDamage;</span>
    }

    @Override
    public boolean isNuclearHardened() {
<span class="nc" id="L3014">        return true;</span>
    }

    @Override
    public void addEquipment(Mounted mounted, int loc, boolean rearMounted)
            throws LocationFullException {
<span class="nc bnc" id="L3020" title="All 2 branches missed.">        if (getEquipmentNum(mounted) == -1) {</span>
<span class="nc" id="L3021">            super.addEquipment(mounted, loc, rearMounted);</span>
        }
        // Add the piece equipment to our slots.
<span class="nc" id="L3024">        addCritical(loc, new CriticalSlot(mounted));</span>
<span class="nc bnc" id="L3025" title="All 2 branches missed.">        if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3026" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(MiscType.F_JUMP_JET)) {</span>
<span class="nc" id="L3027">            setOriginalJumpMP(getOriginalJumpMP() + 1);</span>
        }
<span class="nc" id="L3029">    }</span>

    /**
     * get the type of critical caused by a critical roll, taking account of
     * existing damage
     *
     * @param roll          the final dice roll
     * @param loc           the hit location
     * @param damagedByFire whether or not the critical was caused by fire,
     *                      which is distinct from damage for unofficial thresholding purposes.
     * @return a critical type
     */
    public int getCriticalEffect(int roll, int loc, boolean damagedByFire) {
<span class="nc bnc" id="L3042" title="All 2 branches missed.">        if (roll &gt; 12) {</span>
<span class="nc" id="L3043">            roll = 12;</span>
        }
<span class="nc bnc" id="L3045" title="All 2 branches missed.">        if ((roll &lt; 6)</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
<span class="nc bnc" id="L3047" title="All 4 branches missed.">                &amp;&amp; !getOverThresh() &amp;&amp; !damagedByFire)) {</span>
<span class="nc" id="L3048">            return CRIT_NONE;</span>
        }
<span class="nc bnc" id="L3050" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L3051" title="All 2 branches missed.">            if (i &gt; 0) {</span>
<span class="nc" id="L3052">                roll = 6;</span>
            }
<span class="nc bnc" id="L3054" title="All 2 branches missed.">            if (loc == LOC_FRONT) {</span>
<span class="nc bnc" id="L3055" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3057" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc bnc" id="L3058" title="All 2 branches missed.">                            if (!isDriverHit()) {</span>
<span class="nc" id="L3059">                                return CRIT_DRIVER;</span>
<span class="nc bnc" id="L3060" title="All 2 branches missed.">                            } else if (!isCommanderHit()) {</span>
<span class="nc" id="L3061">                                return CRIT_CREW_STUNNED;</span>
                            } else {
<span class="nc" id="L3063">                                return CRIT_CREW_KILLED;</span>
                            }
                        }
                    case 7:
<span class="nc bnc" id="L3067" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3068" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3069" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3070" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3071">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3073">                        }</span>
                    case 8:
<span class="nc bnc" id="L3075" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3076" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3077" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3078">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3080">                            }</span>
                        }
                    case 9:
<span class="nc bnc" id="L3083" title="All 2 branches missed.">                        if (getSensorHits() &lt; 4) {</span>
<span class="nc" id="L3084">                            return CRIT_SENSOR;</span>
                        }
                    case 10:
<span class="nc bnc" id="L3087" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc bnc" id="L3088" title="All 2 branches missed.">                            if (!isCommanderHit()) {</span>
<span class="nc" id="L3089">                                return CRIT_COMMANDER;</span>
<span class="nc bnc" id="L3090" title="All 2 branches missed.">                            } else if (!isDriverHit()) {</span>
<span class="nc" id="L3091">                                return CRIT_CREW_STUNNED;</span>
                            } else {
<span class="nc" id="L3093">                                return CRIT_CREW_KILLED;</span>
                            }
                        }
                    case 11:
<span class="nc bnc" id="L3097" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3098" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3099" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3100">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3102">                        }</span>
                    case 12:
<span class="nc bnc" id="L3104" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc" id="L3105">                            return CRIT_CREW_KILLED;</span>
                        }
                }
<span class="nc bnc" id="L3108" title="All 2 branches missed.">            } else if (loc == LOC_REAR) {</span>
<span class="nc bnc" id="L3109" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3111" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3112" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3113" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3114" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3115">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3117">                        }</span>
                    case 7:
<span class="nc bnc" id="L3119" title="All 2 branches missed.">                        if (getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L3120">                            return CRIT_CARGO;</span>
                        }
                    case 8:
<span class="nc bnc" id="L3123" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3124" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3125" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3126">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3128">                            }</span>
                        }
                    case 9:
<span class="nc bnc" id="L3131" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3132" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3133" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3134">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3136">                        }</span>
                    case 10:
<span class="nc bnc" id="L3138" title="All 2 branches missed.">                        if (!engineHit) {</span>
<span class="nc bnc" id="L3139" title="All 2 branches missed.">                            return (hasEngine() ? CRIT_ENGINE : CRIT_NONE);</span>
                        }
                    case 11:
<span class="nc bnc" id="L3142" title="All 2 branches missed.">                        for (Mounted m : getAmmo()) {</span>
<span class="nc bnc" id="L3143" title="All 4 branches missed.">                            if (!m.isDestroyed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3144" title="All 2 branches missed.">                                    &amp;&amp; (m.getLocation() != Entity.LOC_NONE)) {</span>
<span class="nc" id="L3145">                                return CRIT_AMMO;</span>
                            }
<span class="nc" id="L3147">                        }</span>
                    case 12:
<span class="nc bnc" id="L3149" title="All 2 branches missed.">                        if (hasEngine()) {</span>
<span class="nc bnc" id="L3150" title="All 4 branches missed.">                            if (getEngine().isFusion() &amp;&amp; !engineHit) {</span>
<span class="nc" id="L3151">                                return CRIT_ENGINE;</span>
<span class="nc bnc" id="L3152" title="All 2 branches missed.">                            } else if (!getEngine().isFusion()) {</span>
<span class="nc" id="L3153">                                return CRIT_FUEL_TANK;</span>
                            }
                        } else {
<span class="nc" id="L3156">                            return CRIT_NONE;</span>
                        }
                }
<span class="nc bnc" id="L3159" title="All 4 branches missed.">            } else if ((loc == getLocTurret()) || (loc == getLocTurret2())) {</span>
<span class="nc bnc" id="L3160" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3162" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3163" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3164" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3165">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3167">                            }</span>
                        }
                    case 7:
<span class="nc bnc" id="L3170" title="All 2 branches missed.">                        if (!isTurretLocked(loc)) {</span>
<span class="nc" id="L3171">                            return CRIT_TURRET_JAM;</span>
                        }
                    case 8:
<span class="nc bnc" id="L3174" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3175" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3176" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3177" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3178">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3180">                        }</span>
                    case 9:
<span class="nc bnc" id="L3182" title="All 2 branches missed.">                        if (!isTurretLocked(loc)) {</span>
<span class="nc" id="L3183">                            return CRIT_TURRET_LOCK;</span>
                        }
                    case 10:
<span class="nc bnc" id="L3186" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3187" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3188" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3189">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3191">                        }</span>
                    case 11:
<span class="nc bnc" id="L3193" title="All 2 branches missed.">                        for (Mounted m : getAmmo()) {</span>
<span class="nc bnc" id="L3194" title="All 4 branches missed.">                            if (!m.isDestroyed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3195" title="All 2 branches missed.">                                    &amp;&amp; (m.getLocation() != Entity.LOC_NONE)) {</span>
<span class="nc" id="L3196">                                return CRIT_AMMO;</span>
                            }
<span class="nc" id="L3198">                        }</span>
                    case 12:
<span class="nc" id="L3200">                        return CRIT_TURRET_DESTROYED;</span>
                }
            } else {
<span class="nc bnc" id="L3203" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3205" title="All 2 branches missed.">                        if (getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L3206">                            return CRIT_CARGO;</span>
                        }
                    case 7:
<span class="nc bnc" id="L3209" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3210" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3211" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3212" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3213">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3215">                        }</span>
                    case 8:
<span class="nc bnc" id="L3217" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc bnc" id="L3218" title="All 4 branches missed.">                            if (isCommanderHit() &amp;&amp; isDriverHit()) {</span>
<span class="nc" id="L3219">                                return CRIT_CREW_KILLED;</span>
                            }
<span class="nc" id="L3221">                            return CRIT_CREW_STUNNED;</span>
                        }
                    case 9:
<span class="nc bnc" id="L3224" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3225" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3226" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3227">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3229">                            }</span>
                        }
                    case 10:
<span class="nc bnc" id="L3232" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3233" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3234" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3235">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3237">                        }</span>
                    case 11:
<span class="nc bnc" id="L3239" title="All 2 branches missed.">                        if (!engineHit) {</span>
<span class="nc bnc" id="L3240" title="All 2 branches missed.">                            return (hasEngine() ? CRIT_ENGINE : CRIT_NONE);</span>
                        }
                    case 12:
<span class="nc bnc" id="L3243" title="All 2 branches missed.">                        if (hasEngine()) {</span>
<span class="nc bnc" id="L3244" title="All 4 branches missed.">                            if (getEngine().isFusion() &amp;&amp; !engineHit) {</span>
<span class="nc" id="L3245">                                return CRIT_ENGINE;</span>
<span class="nc bnc" id="L3246" title="All 2 branches missed.">                            } else if (!getEngine().isFusion()) {</span>
<span class="nc" id="L3247">                                return CRIT_FUEL_TANK;</span>
                            }
                        } else {
<span class="nc" id="L3250">                            return CRIT_NONE;</span>
                        }
                }
            }
        }
<span class="nc" id="L3255">        return CRIT_NONE;</span>
    }

    /**
     * OmniVehicles have handles for Battle Armor squads to latch onto. Please
     * note, this method should only be called during this Tank's construction.
     * &lt;p/&gt;
     * Overrides &lt;code&gt;Entity#setOmni(boolean)&lt;/code&gt;
     */
    @Override
    public void setOmni(boolean omni) {

        // Perform the superclass' action.
<span class="nc" id="L3268">        super.setOmni(omni);</span>

        // Add BattleArmorHandles to OmniMechs.
<span class="nc bnc" id="L3271" title="All 4 branches missed.">        if (omni &amp;&amp; !hasBattleArmorHandles()) {</span>
<span class="nc" id="L3272">            addTransporter(new BattleArmorHandlesTank());</span>
        }
<span class="nc" id="L3274">    }</span>

    // Set whether a non-omni should have BA Grab Bars.
    public void setBAGrabBars() {
<span class="nc bnc" id="L3278" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L3279">            return;</span>
        }
        // TODO: I really hate this optional rule - what if some units are
        // already loaded?
        // if ba_grab_bars is on, then we need to add battlearmor handles,
        // otherwise clamp mounts
        // but first clear out whatever we have
<span class="nc" id="L3286">        Vector&lt;Transporter&gt; et = new Vector&lt;Transporter&gt;(getTransports());</span>
<span class="nc bnc" id="L3287" title="All 2 branches missed.">        for (Transporter t : et) {</span>
<span class="nc bnc" id="L3288" title="All 2 branches missed.">            if (t instanceof BattleArmorHandlesTank) {</span>
<span class="nc" id="L3289">                removeTransporter(t);</span>
            }
<span class="nc" id="L3291">        }</span>
<span class="nc bnc" id="L3292" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_BA_GRAB_BARS)) {</span>
<span class="nc" id="L3293">            addTransporter(new BattleArmorHandlesTank());</span>
        } else {
<span class="nc" id="L3295">            addTransporter(new ClampMountTank());</span>
        }
<span class="nc" id="L3297">    }</span>

    /**
     * Add a transporter for each trailer hitch the unit is equipped with, with a maximum of
     * one each in the front and the rear. Any tractor that does not have an explicit hitch
     * installed as equipment will get a rear-facing transporter.
     */
    public void setTrailerHitches() {
<span class="nc bnc" id="L3305" title="All 4 branches missed.">        if (isTractor() &amp;&amp; !hasTrailerHitchTransporter()) {</span>
            // look for explicit installed trailer hitches and note location
<span class="nc" id="L3307">            boolean front = false;</span>
<span class="nc" id="L3308">            boolean rear = false;</span>
<span class="nc bnc" id="L3309" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L3310" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_HITCH)) {</span>
<span class="nc bnc" id="L3311" title="All 4 branches missed.">                    if (m.getLocation() == Tank.LOC_FRONT &amp;&amp; !isTrailer()) {</span>
<span class="nc" id="L3312">                        front = true;</span>
                    } else {
<span class="nc" id="L3314">                        rear = true;</span>
                    }
                }
<span class="nc" id="L3317">            }</span>
            // Install a transporter anywhere there is an explicit hitch. If no hitch is found,
            // put it in the back.
<span class="nc bnc" id="L3320" title="All 2 branches missed.">            if (front) {</span>
<span class="nc" id="L3321">                addTransporter(new TankTrailerHitch(false));</span>
            }
<span class="nc bnc" id="L3323" title="All 4 branches missed.">            if (rear || !front) {</span>
<span class="nc" id="L3324">                addTransporter(new TankTrailerHitch(true));</span>
            }
        }
<span class="nc" id="L3327">    }</span>

    /**
     * Check to see if the unit has a trailer hitch transporter already
     * We need this to prevent duplicate transporters being created
     */
    protected boolean hasTrailerHitchTransporter() {
<span class="nc bnc" id="L3334" title="All 2 branches missed.">        for (Transporter t : getTransports()) {</span>
<span class="nc bnc" id="L3335" title="All 2 branches missed.">            if (t instanceof TankTrailerHitch) {</span>
<span class="nc" id="L3336">                return true;</span>
            }
<span class="nc" id="L3338">        }</span>
<span class="nc" id="L3339">        return false;</span>
    }

    /**
     * Tanks can't spot when stunned.
     */
    @Override
    public boolean canSpot() {
<span class="nc bnc" id="L3347" title="All 4 branches missed.">        return super.canSpot() &amp;&amp; (getStunnedTurns() == 0);</span>
    }

    /**
     * Convenience function that determines if this tank can issue an &quot;unjam weapon&quot; command.
     *
     * @return True if there are any jammed weapons and the crew isn't stunned
     */
    public boolean canUnjamWeapon() {
<span class="nc bnc" id="L3356" title="All 4 branches missed.">        return getJammedWeapons().size() &gt; 0 &amp;&amp; getStunnedTurns() &lt;= 0;</span>
    }

    /**
     * Convenience function that determines if this tank can issue a &quot;clear turret&quot; command.
     *
     * @return True if there are any jammed turrets and the crew isn't stunned
     */
    public boolean canClearTurret() {
<span class="nc bnc" id="L3365" title="All 6 branches missed.">        return (m_bTurretJammed || m_bDualTurretJammed) &amp;&amp; getStunnedTurns() &lt;= 0;</span>
    }

    public void addJammedWeapon(Mounted weapon) {
<span class="nc" id="L3369">        jammedWeapons.add(weapon);</span>
<span class="nc" id="L3370">    }</span>

    public ArrayList&lt;Mounted&gt; getJammedWeapons() {
<span class="nc" id="L3373">        return jammedWeapons;</span>
    }

    public void resetJammedWeapons() {
<span class="nc" id="L3377">        jammedWeapons = new ArrayList&lt;Mounted&gt;();</span>
<span class="nc" id="L3378">    }</span>

    /**
     * apply the effects of an &quot;engine hit&quot; crit
     */
    public void engineHit() {
<span class="nc" id="L3384">        engineHit = true;</span>
<span class="nc" id="L3385">        immobilize();</span>
<span class="nc" id="L3386">        lockTurret(getLocTurret());</span>
<span class="nc" id="L3387">        lockTurret(getLocTurret2());</span>
<span class="nc bnc" id="L3388" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc" id="L3389">            WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L3390" title="All 6 branches missed.">            if (wtype.hasFlag(WeaponType.F_ENERGY)</span>
                    // Chemical lasers still work even after an engine hit.
                    &amp;&amp; !(wtype instanceof CLChemicalLaserWeapon)
                    // And presumably vehicle flamers should, too; we can always
                    // remove this again if ruled otherwise.
                    &amp;&amp; !(wtype instanceof VehicleFlamerWeapon)) {
<span class="nc" id="L3396">                m.setBreached(true); // not destroyed, just unpowered</span>
            }
<span class="nc" id="L3398">        }</span>
<span class="nc" id="L3399">    }</span>

    public void engineFix() {
<span class="nc" id="L3402">        engineHit = false;</span>
<span class="nc" id="L3403">        unlockTurret();</span>
<span class="nc bnc" id="L3404" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc" id="L3405">            WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L3406" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc" id="L3407">                m.setBreached(false); // not destroyed, just</span>
                // unpowered
            }
<span class="nc" id="L3410">        }</span>
<span class="nc" id="L3411">    }</span>

    public boolean isEngineHit() {
<span class="nc" id="L3414">        return engineHit;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getTotalCommGearTons()
     */
    @Override
    public int getTotalCommGearTons() {
<span class="nc" id="L3424">        return 1 + getExtraCommGearTons();</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getIniBonus()
     */
    @Override
    public int getHQIniBonus() {
<span class="nc" id="L3434">        int bonus = super.getHQIniBonus();</span>
<span class="nc bnc" id="L3435" title="All 6 branches missed.">        if (((stabiliserHits &gt; 0) &amp;&amp; (mpUsedLastRound &gt; 0)) || commanderHit) {</span>
<span class="nc" id="L3436">            return 0;</span>
        }
<span class="nc" id="L3438">        return bonus;</span>
    }

    @Override
    public boolean hasArmoredEngine() {
<span class="nc bnc" id="L3443" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(LOC_BODY); slot++) {</span>
<span class="nc" id="L3444">            CriticalSlot cs = getCritical(LOC_BODY, slot);</span>
<span class="nc bnc" id="L3445" title="All 4 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L3446" title="All 2 branches missed.">                    &amp;&amp; (cs.getIndex() == Mech.SYSTEM_ENGINE)) {</span>
<span class="nc" id="L3447">                return cs.isArmored();</span>
            }
        }
<span class="nc" id="L3450">        return false;</span>
    }

    /**
     * see {@link Entity#getForwardArc()}
     */
    @Override
    public int getForwardArc() {
<span class="nc bnc" id="L3458" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L3459">            return Compute.ARC_NOSE;</span>
        }
<span class="nc" id="L3461">        return super.getForwardArc();</span>
    }

    /**
     * see {@link Entity#getRearArc()}
     */
    @Override
    public int getRearArc() {
<span class="nc bnc" id="L3469" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L3470">            return Compute.ARC_AFT;</span>
        }
<span class="nc" id="L3472">        return super.getRearArc();</span>
    }

    public boolean hasMovementDamage() {
<span class="nc bnc" id="L3476" title="All 2 branches missed.">        return motivePenalty &gt; 0;</span>
    }

    public void resetMovementDamage() {
<span class="nc" id="L3480">        motivePenalty = 0;</span>
<span class="nc" id="L3481">        motiveDamage = 0;</span>
<span class="nc" id="L3482">        minorMovementDamage = false;</span>
<span class="nc" id="L3483">        moderateMovementDamage = false;</span>
<span class="nc" id="L3484">        heavyMovementDamage = false;</span>
<span class="nc" id="L3485">        m_bImmobileHit = false;</span>
<span class="nc" id="L3486">        m_bImmobile = false;</span>
<span class="nc" id="L3487">    }</span>

    public void unlockTurret() {
<span class="nc" id="L3490">        m_bTurretLocked = false;</span>
<span class="nc" id="L3491">    }</span>

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     * currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    @Override
    public boolean isStealthActive() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L3506" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L3507">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L3508" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>

<span class="nc bnc" id="L3510" title="All 4 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;) &amp;&amp; hasActiveECM()) {</span>
                    // Return true if the mode is &quot;On&quot; and ECM is working
<span class="nc" id="L3512">                    return true;</span>
                }
            }
<span class="nc" id="L3515">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L3517">        return false;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     * currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    @Override
    public boolean isStealthOn() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L3533" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L3534">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L3535" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>
<span class="nc bnc" id="L3536" title="All 2 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;)) {</span>
                    // Return true if the mode is &quot;On&quot;
<span class="nc" id="L3538">                    return true;</span>
                }
            }
<span class="nc" id="L3541">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L3543">        return false;</span>
    }

    /**
     * get the total amount of item slots available for this tank
     *
     * @return
     */
    public int getTotalSlots() {
<span class="nc" id="L3552">        return 5 + (int) Math.floor(getWeight() / 5);</span>
    }

    /**
     * get the free item slots for this tank
     *
     * @return
     */
    public int getFreeSlots() {
<span class="nc" id="L3561">        int availableSlots = getTotalSlots();</span>
<span class="nc" id="L3562">        int usedSlots = 0;</span>
<span class="nc" id="L3563">        boolean addedCargo = false;</span>
<span class="nc bnc" id="L3564" title="All 2 branches missed.">        for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L3565" title="All 2 branches missed.">            if ((mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3566" title="All 2 branches missed.">                    &amp;&amp; mount.getType().hasFlag(MiscType.F_CARGO)) {</span>
<span class="nc bnc" id="L3567" title="All 2 branches missed.">                if (!addedCargo) {</span>
<span class="nc" id="L3568">                    usedSlots += mount.getType().getTankSlots(this);</span>
<span class="nc" id="L3569">                    addedCargo = true;</span>
<span class="nc" id="L3570">                    continue;</span>
                } else {
                    continue;
                }
            }
<span class="nc bnc" id="L3575" title="All 2 branches missed.">            if ((mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3576" title="All 2 branches missed.">                    &amp;&amp; (mount.getType().hasFlag(MiscType.F_JUMP_JET)</span>
<span class="nc bnc" id="L3577" title="All 2 branches missed.">                    || mount.getType().hasFlag(MiscType.F_FUEL))) {</span>
                // Only one slot each for all jump jets or fuel tanks, added later.
<span class="nc" id="L3579">                continue;</span>
            }
<span class="nc bnc" id="L3581" title="All 2 branches missed.">            if (!((mount.getType() instanceof AmmoType) || Arrays.asList(</span>
<span class="nc bnc" id="L3582" title="All 2 branches missed.">                    EquipmentType.armorNames).contains(</span>
<span class="nc" id="L3583">                    mount.getType().getName()))) {</span>
<span class="nc" id="L3584">                usedSlots += mount.getType().getTankSlots(this);</span>
            }
<span class="nc" id="L3586">        }</span>
        // JJs take just 1 slot
<span class="nc bnc" id="L3588" title="All 2 branches missed.">        if (this.getJumpMP(false) &gt; 0) {</span>
<span class="nc" id="L3589">            usedSlots++;</span>
        }
        // So do fuel tanks
<span class="nc bnc" id="L3592" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_FUEL)) {</span>
<span class="nc" id="L3593">            usedSlots++;</span>
        }
        // different engines take different amounts of slots
<span class="nc bnc" id="L3596" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().isFusion()) {</span>
<span class="nc bnc" id="L3597" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.LIGHT_ENGINE) {</span>
<span class="nc" id="L3598">                usedSlots++;</span>
            }
<span class="nc bnc" id="L3600" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.XL_ENGINE) {</span>
<span class="nc bnc" id="L3601" title="All 2 branches missed.">                if (getEngine().hasFlag(Engine.CLAN_ENGINE)) {</span>
<span class="nc" id="L3602">                    usedSlots++;</span>
                } else {
<span class="nc" id="L3604">                    usedSlots += 2;</span>
                }
            }
<span class="nc bnc" id="L3607" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.XXL_ENGINE) {</span>
<span class="nc bnc" id="L3608" title="All 2 branches missed.">                if (getEngine().hasFlag(Engine.CLAN_ENGINE)) {</span>
<span class="nc" id="L3609">                    usedSlots += 2;</span>
                } else {
<span class="nc" id="L3611">                    usedSlots += 4;</span>
                }
            }
        }
<span class="nc bnc" id="L3615" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().hasFlag(Engine.LARGE_ENGINE)) {</span>
<span class="nc" id="L3616">            usedSlots++;</span>
        }
<span class="nc bnc" id="L3618" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().getEngineType() == Engine.COMPACT_ENGINE) {</span>
<span class="nc" id="L3619">            usedSlots--;</span>
        }
        // for ammo, each type of ammo takes one slots, regardless of
        // submunition type
<span class="nc" id="L3623">        Set&lt;String&gt; foundAmmo = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3624" title="All 2 branches missed.">        for (Mounted ammo : getAmmo()) {</span>
            // don't count oneshot ammo
<span class="nc bnc" id="L3626" title="All 2 branches missed.">            if (ammo.isOneShotAmmo()) {</span>
<span class="nc" id="L3627">                continue;</span>
            }
<span class="nc" id="L3629">            AmmoType at = (AmmoType) ammo.getType();</span>
<span class="nc bnc" id="L3630" title="All 2 branches missed.">            if (!foundAmmo.contains(at.getAmmoType() + &quot;:&quot; + at.getRackSize())) {</span>
<span class="nc" id="L3631">                usedSlots++;</span>
<span class="nc" id="L3632">                foundAmmo.add(at.getAmmoType() + &quot;:&quot; + at.getRackSize());</span>
            }
<span class="nc" id="L3634">        }</span>
        // if a tank has an infantry bay, add 1 slots (multiple bays take 1 slot
        // total)
<span class="nc" id="L3637">        boolean infantryBayCounted = false;</span>
<span class="nc bnc" id="L3638" title="All 2 branches missed.">        for (Transporter transport : getTransports()) {</span>
<span class="nc bnc" id="L3639" title="All 2 branches missed.">            if (transport instanceof TroopSpace) {</span>
<span class="nc" id="L3640">                usedSlots++;</span>
<span class="nc" id="L3641">                infantryBayCounted = true;</span>
<span class="nc" id="L3642">                break;</span>
            }
<span class="nc" id="L3644">        }</span>
        // unit transport bays take 1 slot each
<span class="nc bnc" id="L3646" title="All 2 branches missed.">        for (Bay bay : getTransportBays()) {</span>
<span class="nc bnc" id="L3647" title="All 6 branches missed.">            if (((bay instanceof BattleArmorBay) || (bay instanceof InfantryBay))</span>
                    &amp;&amp; !infantryBayCounted) {
<span class="nc" id="L3649">                usedSlots++;</span>
<span class="nc" id="L3650">                infantryBayCounted = true;</span>
            } else {
<span class="nc" id="L3652">                usedSlots++;</span>
            }
<span class="nc" id="L3654">        }</span>
<span class="nc" id="L3655">        usedSlots += extraCrewSeats;</span>
        // different armor types take different amount of slots
<span class="nc bnc" id="L3657" title="All 2 branches missed.">        if (!hasPatchworkArmor()) {</span>
<span class="nc" id="L3658">            int type = getArmorType(1);</span>
<span class="nc bnc" id="L3659" title="All 6 branches missed.">            switch (type) {</span>
                case EquipmentType.T_ARMOR_FERRO_FIBROUS:
<span class="nc bnc" id="L3661" title="All 2 branches missed.">                    if (TechConstants.isClan(getArmorTechLevel(1))) {</span>
<span class="nc" id="L3662">                        usedSlots++;</span>
                    } else {
<span class="nc" id="L3664">                        usedSlots += 2;</span>
                    }
<span class="nc" id="L3666">                    break;</span>
                case EquipmentType.T_ARMOR_HEAVY_FERRO:
<span class="nc" id="L3668">                    usedSlots += 3;</span>
<span class="nc" id="L3669">                    break;</span>
                case EquipmentType.T_ARMOR_LIGHT_FERRO:
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_HARDENED:
                case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
                case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L3676">                    usedSlots++;</span>
<span class="nc" id="L3677">                    break;</span>
                case EquipmentType.T_ARMOR_STEALTH_VEHICLE:
<span class="nc" id="L3679">                    usedSlots += 2;</span>
<span class="nc" id="L3680">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
<span class="nc bnc" id="L3682" title="All 2 branches missed.">                    if (TechConstants.isClan(getArmorTechLevel(1))) {</span>
<span class="nc" id="L3683">                        usedSlots++;</span>
                    } else {
<span class="nc" id="L3685">                        usedSlots += 2;</span>
                    }
<span class="nc" id="L3687">                    break;</span>
                default:
                    break;
            }
<span class="nc" id="L3691">        } else {</span>
<span class="nc bnc" id="L3692" title="All 2 branches missed.">            for (int loc = 1; loc &lt; locations(); loc++) {</span>
<span class="nc bnc" id="L3693" title="All 3 branches missed.">                switch (getArmorType(loc)) {</span>
                    case EquipmentType.T_ARMOR_HEAVY_FERRO:
<span class="nc" id="L3695">                        usedSlots += 2;</span>
<span class="nc" id="L3696">                        break;</span>
                    case EquipmentType.T_ARMOR_FERRO_FIBROUS:
                    case EquipmentType.T_ARMOR_LIGHT_FERRO:
                    case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                    case EquipmentType.T_ARMOR_REFLECTIVE:
                    case EquipmentType.T_ARMOR_STEALTH_VEHICLE:
                    case EquipmentType.T_ARMOR_REACTIVE:
                    case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
                    case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L3705">                        usedSlots++;</span>
<span class="nc" id="L3706">                        break;</span>
                    default:
                        break;
                }
            }
        }
<span class="nc" id="L3712">        return availableSlots - usedSlots;</span>
    }

    @Override
    public void setArmorType(int armType) {
<span class="nc" id="L3717">        setArmorType(armType, true);</span>
<span class="nc" id="L3718">    }</span>

    public void setArmorType(int armType, boolean addMount) {
<span class="nc" id="L3721">        super.setArmorType(armType);</span>
<span class="nc bnc" id="L3722" title="All 4 branches missed.">        if ((armType == EquipmentType.T_ARMOR_STEALTH_VEHICLE) &amp;&amp; addMount) {</span>
            try {
<span class="nc" id="L3724">                this.addEquipment(EquipmentType.get(EquipmentType</span>
<span class="nc" id="L3725">                                .getArmorTypeName(</span>
                                        EquipmentType.T_ARMOR_STEALTH_VEHICLE, false)),
                        LOC_BODY);
<span class="nc" id="L3728">            } catch (LocationFullException e) {</span>
                // this should never happen
<span class="nc" id="L3730">            }</span>
        }
<span class="nc" id="L3732">    }</span>

    /**
     * Checks if a mech has an armed MASC system. Note that the mech will have
     * to exceed its normal run to actually engage the MASC system
     */
    public boolean hasArmedMASC() {
<span class="nc bnc" id="L3739" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L3740" title="All 2 branches missed.">            if (!m.isDestroyed()</span>
<span class="nc bnc" id="L3741" title="All 2 branches missed.">                    &amp;&amp; !m.isBreached()</span>
<span class="nc bnc" id="L3742" title="All 2 branches missed.">                    &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3743" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L3744" title="All 4 branches missed.">                    &amp;&amp; (m.curMode().equals(&quot;Armed&quot;) || m.getType().hasSubType(</span>
                    MiscType.S_JETBOOSTER))) {
<span class="nc" id="L3746">                return true;</span>
            }
<span class="nc" id="L3748">        }</span>
<span class="nc" id="L3749">        return false;</span>
    }

    /**
     * Returns this entity's running/flank mp as a string.
     */
    @Override
    public String getRunMPasString() {
<span class="nc bnc" id="L3757" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L3758">            return getRunMPwithoutMASC() + &quot;(&quot; + getRunMP() + &quot;)&quot;;</span>
        }
<span class="nc" id="L3760">        return Integer.toString(getRunMP());</span>
    }

    /**
     * Determine the stealth modifier for firing at this unit from the given
     * range. If the value supplied for &lt;code&gt;range&lt;/code&gt; is not one of the
     * &lt;code&gt;Entity&lt;/code&gt; class range constants, an
     * &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @param range - an &lt;code&gt;int&lt;/code&gt; value that must match one of the
     *              &lt;code&gt;Compute&lt;/code&gt; class range constants.
     * @param ae    - entity making the attack
     * @return a &lt;code&gt;TargetRoll&lt;/code&gt; value that contains the stealth
     * modifier for the given range.
     */
    @Override
    public TargetRoll getStealthModifier(int range, Entity ae) {
<span class="nc" id="L3779">        TargetRoll result = null;</span>

        // Stealth or null sig must be active.
<span class="nc bnc" id="L3782" title="All 2 branches missed.">        if (!isStealthActive()) {</span>
<span class="nc" id="L3783">            result = new TargetRoll(0, &quot;stealth not active&quot;);</span>
        }
        // Determine the modifier based upon the range.
        else {
<span class="nc bnc" id="L3787" title="All 5 branches missed.">            switch (range) {</span>
                case RangeType.RANGE_MINIMUM:
                case RangeType.RANGE_SHORT:
<span class="nc bnc" id="L3790" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3791">                        result = new TargetRoll(0, &quot;stealth&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L3794">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L3796">                    break;</span>
                case RangeType.RANGE_MEDIUM:
<span class="nc bnc" id="L3798" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3799">                        result = new TargetRoll(1, &quot;stealth&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L3802">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L3804">                    break;</span>
                case RangeType.RANGE_LONG:
                case RangeType.RANGE_EXTREME:
                case RangeType.RANGE_LOS:
<span class="nc bnc" id="L3808" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3809">                        result = new TargetRoll(2, &quot;stealth&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L3812">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L3814">                    break;</span>
                case RangeType.RANGE_OUT:
<span class="nc" id="L3816">                    break;</span>
                default:
<span class="nc" id="L3818">                    throw new IllegalArgumentException(&quot;Unknown range constant: &quot; + range);</span>
            }
        }

        // Return the result.
<span class="nc" id="L3823">        return result;</span>
    } // End public TargetRoll getStealthModifier( char )

    @Override
    public double getBaseBattleForceMovement() {
<span class="nc" id="L3828">        double move = getOriginalWalkMP();</span>

<span class="nc" id="L3830">        if (getMisc().stream().filter(m -&gt; m.getType().hasFlag(MiscType.F_MASC))</span>
<span class="nc" id="L3831">                .map(m -&gt; m.getType().getSubType())</span>
<span class="nc bnc" id="L3832" title="All 4 branches missed.">                .anyMatch(st -&gt; st == MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L3833">            move *= 1.25;</span>
        }

<span class="nc" id="L3836">        return move;</span>
    }

    @Override
    /**
     * returns the battle force structure points for a vehicle.
     * Composite and Reinforced structures are Mech only, so we don't need to worry
     */
    public int getBattleForceStructurePoints() {
<span class="nc" id="L3845">        int struct = 0;</span>
<span class="nc bnc" id="L3846" title="All 2 branches missed.">        for (int i = 0; i &lt; getLocationNames().length; i++) {</span>
<span class="nc" id="L3847">            struct += this.getInternal(i);</span>
        }
<span class="nc" id="L3849">        return (int) Math.ceil(struct / 10.0);</span>
    }

    /**
     * Separate turret weapons from body-mounted
     */
    @Override
    public int getNumBattleForceWeaponsLocations() {
<span class="nc bnc" id="L3857" title="All 2 branches missed.">        if (m_bHasNoTurret) {</span>
<span class="nc" id="L3858">            return 2;</span>
<span class="nc bnc" id="L3859" title="All 2 branches missed.">        } else if (m_bHasNoDualTurret) {</span>
<span class="nc" id="L3860">            return 3;</span>
        } else {
<span class="nc" id="L3862">            return 4;</span>
        }
    }

    @Override
    public String getBattleForceLocationName(int index) {
<span class="nc bnc" id="L3868" title="All 2 branches missed.">        if (index == 1) {</span>
<span class="nc" id="L3869">            return &quot;REAR&quot;;</span>
        }
<span class="nc bnc" id="L3871" title="All 2 branches missed.">        if (index &gt; 1) {</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">            if (m_bHasNoDualTurret) {</span>
<span class="nc" id="L3873">                return &quot;TUR&quot;;</span>
            } else {
<span class="nc" id="L3875">                return &quot;TUR&quot; + index;</span>
            }
        } else {
<span class="nc" id="L3878">            return &quot;&quot;;</span>
        }
    }

    /**
     * index 0 (Front, Left, Right)
     * index 1+ (Turret(s))
     */
    @Override
    public double getBattleForceLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc bnc" id="L3888" title="All 5 branches missed.">        switch (index) {</span>
            case 0:
<span class="nc bnc" id="L3890" title="All 4 branches missed.">                if (location &gt; LOC_BODY &amp;&amp; location &lt; LOC_TURRET) {</span>
<span class="nc" id="L3891">                    return 1.0;</span>
                }
                break;
            case 1:
<span class="nc bnc" id="L3895" title="All 2 branches missed.">                if (location == LOC_REAR) {</span>
<span class="nc" id="L3896">                    return 1.0;</span>
                }
                break;
            case 2:
<span class="nc bnc" id="L3900" title="All 2 branches missed.">                if (location == LOC_TURRET) {</span>
<span class="nc" id="L3901">                    return 1.0;</span>
                }
                break;
            case 3:
<span class="nc bnc" id="L3905" title="All 2 branches missed.">                if (location == LOC_TURRET_2) {</span>
<span class="nc" id="L3906">                    return 1.0;</span>
                }
                break;
        }
<span class="nc" id="L3910">        return 0;</span>
    }

    /**
     * AlphaStrike combines turrets with the overall (front) damage values.
     */
    @Override
    public double getAlphaStrikeLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc bnc" id="L3918" title="All 2 branches missed.">        if (index == 0) {</span>
<span class="nc bnc" id="L3919" title="All 2 branches missed.">            return location &gt; LOC_BODY ? 1.0 : 0.0;</span>
        }
<span class="nc" id="L3921">        return getBattleForceLocationMultiplier(index, location, rearMounted);</span>
    }

    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA, Integer&gt; specialAbilities) {
<span class="nc" id="L3925">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc bnc" id="L3926" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc" id="L3927">            specialAbilities.put(BattleForceSPA.SRCH, null);</span>
        }
<span class="nc bnc" id="L3929" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L3930" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ADVANCED_FIRECONTROL)) {</span>
<span class="nc" id="L3931">                specialAbilities.put(BattleForceSPA.AFC, null);</span>
<span class="nc bnc" id="L3932" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_BASIC_FIRECONTROL)) {</span>
<span class="nc" id="L3933">                specialAbilities.put(BattleForceSPA.BFC, null);</span>
<span class="nc bnc" id="L3934" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_AMPHIBIOUS)) {</span>
<span class="nc" id="L3935">                specialAbilities.put(BattleForceSPA.AMP, null);</span>
<span class="nc bnc" id="L3936" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L3937">                specialAbilities.put(BattleForceSPA.ARS, null);</span>
<span class="nc bnc" id="L3938" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L3939">                specialAbilities.put(BattleForceSPA.SEAL, null);</span>
<span class="nc bnc" id="L3940" title="All 4 branches missed.">                if (hasEngine() &amp;&amp; getEngine().getEngineType() != Engine.COMBUSTION_ENGINE</span>
<span class="nc bnc" id="L3941" title="All 2 branches missed.">                        &amp;&amp; getEngine().getEngineType() != Engine.STEAM) {</span>
<span class="nc" id="L3942">                    specialAbilities.put(BattleForceSPA.SOA, null);</span>
                }
<span class="nc bnc" id="L3944" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_VEHICLE_MINE_DISPENSER)) {</span>
<span class="nc" id="L3945">                specialAbilities.merge(BattleForceSPA.MDS, 1, Integer::sum);</span>
<span class="nc bnc" id="L3946" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L3947">                specialAbilities.put(BattleForceSPA.MSW, null);</span>
<span class="nc bnc" id="L3948" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MASH)) {</span>
<span class="nc" id="L3949">                specialAbilities.merge(BattleForceSPA.MASH, (int) m.getSize(), Integer::sum);</span>
<span class="nc bnc" id="L3950" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MOBILE_FIELD_BASE)) {</span>
<span class="nc" id="L3951">                specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L3952" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_COMMAND_CONSOLE)) {</span>
<span class="nc" id="L3953">                specialAbilities.merge(BattleForceSPA.MHQ, 1, Integer::sum);</span>
<span class="nc bnc" id="L3954" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L3955">                specialAbilities.put(BattleForceSPA.ORO, null);</span>
<span class="nc bnc" id="L3956" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_DUNE_BUGGY)) {</span>
<span class="nc" id="L3957">                specialAbilities.put(BattleForceSPA.DUN, null);</span>
<span class="nc bnc" id="L3958" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_TRACTOR_MODIFICATION)</span>
<span class="nc bnc" id="L3959" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_TRAILER_MODIFICATION)) {</span>
<span class="nc" id="L3960">                specialAbilities.put(BattleForceSPA.HTC, null);</span>
            }
            //TODO: Fire-resistant chassis mod
<span class="nc" id="L3963">        }</span>
<span class="nc" id="L3964">    }</span>

    @Override
    public boolean isBattleForceTurretLocation(int index) {
<span class="nc bnc" id="L3968" title="All 2 branches missed.">        return index &gt; 1;</span>
    }

    @Override
    public boolean isBattleForceRearLocation(int index) {
<span class="nc bnc" id="L3973" title="All 2 branches missed.">        return index == 1;</span>
    }

    @Override
    public int getEngineHits() {
<span class="nc bnc" id="L3978" title="All 2 branches missed.">        if (isEngineHit()) {</span>
<span class="nc" id="L3979">            return 1;</span>
        } else {
<span class="nc" id="L3981">            return 0;</span>
        }
    }

    @Override
    public String getLocationDamage(int loc) {
<span class="nc" id="L3987">        String toReturn = &quot;&quot;;</span>
<span class="nc" id="L3988">        boolean first = true;</span>
<span class="nc bnc" id="L3989" title="All 2 branches missed.">        if (getLocationStatus(loc) == ILocationExposureStatus.BREACHED) {</span>
<span class="nc" id="L3990">            toReturn += &quot;BREACH&quot;;</span>
<span class="nc" id="L3991">            first = false;</span>
        }
<span class="nc bnc" id="L3993" title="All 2 branches missed.">        if (isTurretLocked(loc)) {</span>
<span class="nc bnc" id="L3994" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3995">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L3997">            toReturn += &quot;Locked&quot;;</span>
<span class="nc" id="L3998">            first = false;</span>
        }
<span class="nc bnc" id="L4000" title="All 2 branches missed.">        if (isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L4001" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L4002">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L4004">            toReturn += &quot;Stabilizer hit&quot;;</span>
<span class="nc" id="L4005">            first = false;</span>
        }
<span class="nc" id="L4007">        return toReturn;</span>
    }

    @Override
    public boolean isCrippled() {
<span class="nc" id="L4012">        return isCrippled(true);</span>
    }

    @Override
    public boolean isCrippled(boolean checkCrew) {
<span class="nc bnc" id="L4017" title="All 4 branches missed.">        if ((getArmor(LOC_FRONT) &lt; 1) &amp;&amp; (getOArmor(LOC_FRONT) &gt; 0)) {</span>
<span class="nc" id="L4018">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Front armor destroyed.&quot;);</span>
<span class="nc" id="L4019">            return true;</span>
<span class="nc bnc" id="L4020" title="All 4 branches missed.">        } else if ((getArmor(LOC_RIGHT) &lt; 1) &amp;&amp; (getOArmor(LOC_RIGHT) &gt; 0)) {</span>
<span class="nc" id="L4021">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Right armor destroyed.&quot;);</span>
<span class="nc" id="L4022">            return true;</span>
<span class="nc bnc" id="L4023" title="All 4 branches missed.">        } else if ((getArmor(LOC_LEFT) &lt; 1) &amp;&amp; (getOArmor(LOC_LEFT) &gt; 0)) {</span>
<span class="nc" id="L4024">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Left armor destroyed.&quot;);</span>
<span class="nc" id="L4025">            return true;</span>
<span class="nc bnc" id="L4026" title="All 6 branches missed.">        } else if (!hasNoTurret() &amp;&amp; ((getArmor(getLocTurret()) &lt; 1) &amp;&amp; (getOArmor(getLocTurret()) &gt; 0))) {</span>
<span class="nc" id="L4027">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Turret destroyed.&quot;);</span>
<span class="nc" id="L4028">            return true;</span>
<span class="nc bnc" id="L4029" title="All 6 branches missed.">        } else if (!hasNoDualTurret() &amp;&amp; ((getArmor(getLocTurret2()) &lt; 1) &amp;&amp; (getOArmor(getLocTurret2()) &gt; 0))) {</span>
<span class="nc" id="L4030">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Front Turret destroyed.&quot;);</span>
<span class="nc" id="L4031">            return true;</span>
<span class="nc bnc" id="L4032" title="All 4 branches missed.">        } else if ((getArmor(LOC_REAR) &lt; 1) &amp;&amp; (getOArmor(LOC_REAR) &gt; 0)) {</span>
<span class="nc" id="L4033">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Rear armor destroyed.&quot;);</span>
<span class="nc" id="L4034">            return true;</span>
<span class="nc bnc" id="L4035" title="All 2 branches missed.">        } else if (isPermanentlyImmobilized(checkCrew)) {</span>
<span class="nc" id="L4036">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Immobilized.&quot;);</span>
<span class="nc" id="L4037">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4042" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4043">            return false;</span>
        }

        // no weapons can fire anymore, can cause no more than 5 points of
        // combined weapons damage,
        // or has no weapons with range greater than 5 hexes
<span class="nc bnc" id="L4049" title="All 2 branches missed.">        if (!hasViableWeapons()) {</span>
<span class="nc" id="L4050">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: has no more viable weapons.&quot;);</span>
<span class="nc" id="L4051">            return true;</span>
        }
<span class="nc" id="L4053">        return false;</span>
    }

    @Override
    public boolean isDmgHeavy() {
        // when checking if MP has been reduced, we want to ignore non-damage effects such as weather/gravity
<span class="nc bnc" id="L4059" title="All 2 branches missed.">        if (((double) getMotiveDamage() / getOriginalWalkMP()) &gt;= 0.5) {</span>
<span class="nc" id="L4060">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot; Lightly Damaged: Walk MP less than or equal to half the original Walk MP&quot;);
<span class="nc" id="L4062">            return true;</span>
<span class="nc bnc" id="L4063" title="All 4 branches missed.">        } else if ((getArmorRemainingPercent() &lt;= 0.33) &amp;&amp; (getArmorRemainingPercent() != IArmorState.ARMOR_NA)) {</span>
<span class="nc" id="L4064">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4065">                    + &quot; Heavily Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.33.&quot;);
<span class="nc" id="L4067">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4072" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4073">            return false;</span>
        }

<span class="nc" id="L4076">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4077">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4078" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4079" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4080">                totalInoperable++;</span>
            }
<span class="nc" id="L4082">        }</span>
<span class="nc bnc" id="L4083" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.75;</span>
    }

    @Override
    public boolean isDmgModerate() {
<span class="nc bnc" id="L4088" title="All 4 branches missed.">        if ((getArmorRemainingPercent() &lt;= 0.67) &amp;&amp; (getArmorRemainingPercent() != IArmorState.ARMOR_NA)) {</span>
<span class="nc" id="L4089">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4090">                    + &quot; Moderately Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.67.&quot;);
<span class="nc" id="L4092">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4097" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4098">            return false;</span>
        }

<span class="nc" id="L4101">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4102">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4103" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4104" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4105">                totalInoperable++;</span>
            }
<span class="nc" id="L4107">        }</span>

<span class="nc bnc" id="L4109" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.5;</span>
    }

    @Override
    public boolean isDmgLight() {
        // when checking if MP has been reduced, we want to ignore non-damage effects such as weather/gravity
<span class="nc bnc" id="L4115" title="All 2 branches missed.">        if (getMotiveDamage() &gt; 0) {</span>
<span class="nc" id="L4116">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot; Lightly Damaged: Walk MP less than the original Walk MP&quot;);
<span class="nc" id="L4118">            return true;</span>
<span class="nc bnc" id="L4119" title="All 4 branches missed.">        } else if ((getArmorRemainingPercent() &lt;= 0.8) &amp;&amp; (getArmorRemainingPercent() != IArmorState.ARMOR_NA)) {</span>
<span class="nc" id="L4120">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4121">                    + &quot; Lightly Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.8.&quot;);
<span class="nc" id="L4123">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4128" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4129">            return false;</span>
        }

<span class="nc" id="L4132">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4133">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4134" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4135" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4136">                totalInoperable++;</span>
            }
<span class="nc" id="L4138">        }</span>

<span class="nc bnc" id="L4140" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.25;</span>
    }

    /**
     * Returns the mass of the fuel, which is used for calculating operating range.
     * For combat vehicles this is considered part of the engine weight. For support vehicles it is in
     * addition to the engine weight.
     *
     * @return fuel tonnage
     */
    public double getFuelTonnage() {
<span class="nc bnc" id="L4151" title="All 2 branches missed.">        if (hasEngine()) {</span>
            // For combat vehicles the fuel tonnage is 10% of the engine.
<span class="nc" id="L4153">            return getEngine().getWeightEngine(this) * 0.1;</span>
        }
<span class="nc" id="L4155">        return 0.0;</span>
    }

    /**
     * Sets the fuel mass for support vehicles. Has no effect on combat vehicles.
     *
     * @param fuel The mass of the fuel in tons
     */
    public void setFuelTonnage(double fuel) {
        // do nothing
<span class="nc" id="L4165">    }</span>

    /**
     * Calculates the operating range of the vehicle based on engine type and fuel mass.
     * Vehicles that do not require fuel report an operating range of {@code Integer.MAX_VALUE}.
     *
     * @return The vehicle's operating range in km
     */
    public int operatingRange() {
<span class="nc bnc" id="L4174" title="All 2 branches missed.">        if (getFuelTonnage() &lt;= 0) {</span>
<span class="nc" id="L4175">            return 0;</span>
        }
<span class="nc" id="L4177">        double fuelUnit = fuelTonnagePer100km();</span>
<span class="nc bnc" id="L4178" title="All 2 branches missed.">        if (fuelUnit &gt; 0) {</span>
<span class="nc" id="L4179">            int range = (int) (getFuelTonnage() / fuelUnit * 100);</span>
<span class="nc" id="L4180">            int fuelTanks = countWorkingMisc(MiscType.F_FUEL);</span>
<span class="nc bnc" id="L4181" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.COMBUSTION_ENGINE) {</span>
<span class="nc" id="L4182">                range += fuelTanks * 600;</span>
<span class="nc bnc" id="L4183" title="All 2 branches missed.">            } else if (getEngine().getEngineType() == Engine.FUEL_CELL) {</span>
<span class="nc" id="L4184">                range += fuelTanks * 450;</span>
            }
<span class="nc" id="L4186">            return range;</span>
        }
<span class="nc" id="L4188">        return Integer.MAX_VALUE;</span>
    }

    /**
     * Calculates fuel mass based on engine type and mass. Engines that do not require allocating
     * fuel mass return a value of 0.0.
     *
     * @return The fuel mass required for every 100 km of vehicle range.
     */
    public double fuelTonnagePer100km() {
<span class="nc bnc" id="L4198" title="All 2 branches missed.">        if (!hasEngine()) {</span>
<span class="nc" id="L4199">            return 0.0;</span>
        }
<span class="nc bnc" id="L4201" title="All 5 branches missed.">        switch (getEngine().getEngineType()) {</span>
            case Engine.STEAM:
<span class="nc" id="L4203">                return getEngine().getWeightEngine(this) * 0.03;</span>
            case Engine.COMBUSTION_ENGINE:
<span class="nc bnc" id="L4205" title="All 2 branches missed.">                if (getICEFuelType() == FuelType.PETROCHEMICALS) {</span>
<span class="nc" id="L4206">                    return getEngine().getWeightEngine(this) * 0.01;</span>
                } else {
<span class="nc" id="L4208">                    return getEngine().getWeightEngine(this) * 0.0125;</span>
                }
            case Engine.BATTERY:
<span class="nc" id="L4211">                return getEngine().getWeightEngine(this) * 0.05;</span>
            case Engine.FUEL_CELL:
<span class="nc" id="L4213">                return getEngine().getWeightEngine(this) * 0.015;</span>
            default:
<span class="nc" id="L4215">                return 0.0;</span>
        }
    }

    /**
     * The type of fuel for internal combustion engines. This has no meaning for
     * other engine types.
     *
     * @return The ICE fuel type
     */
    public FuelType getICEFuelType() {
<span class="nc" id="L4226">        return fuelType;</span>
    }

    public void setICEFuelType(FuelType fuelType) {
<span class="nc" id="L4230">        this.fuelType = fuelType;</span>
<span class="nc" id="L4231">    }</span>

    /**
     * Tanks go Hull Down slightly differently, this method accounts for this
     *
     * @see megamek.common.Entity#setHullDown(boolean)
     */
    @Override
    public void setHullDown(boolean down) {
<span class="nc" id="L4240">        super.setHullDown(down);</span>
<span class="nc bnc" id="L4241" title="All 4 branches missed.">        if ((getMovedBackwards() == true) &amp;&amp; (down == true)) {</span>
<span class="nc" id="L4242">            m_bBackedIntoHullDown = true;</span>
<span class="nc bnc" id="L4243" title="All 4 branches missed.">        } else if ((getMovedBackwards() == false) &amp;&amp; (down == true)) {</span>
<span class="nc" id="L4244">            m_bBackedIntoHullDown = false;</span>
<span class="nc bnc" id="L4245" title="All 2 branches missed.">        } else if (down == false) {</span>
<span class="nc" id="L4246">            m_bBackedIntoHullDown = false;</span>
        }
<span class="nc" id="L4248">    }</span>

    /**
     * Returns True if this tank moved backwards before going Hull Down
     *
     * @return
     */
    public boolean isBackedIntoHullDown() {
<span class="nc" id="L4256">        return m_bBackedIntoHullDown;</span>
    }

    @Override
    public long getEntityType() {
<span class="nc" id="L4261">        return Entity.ETYPE_TANK;</span>
    }

    @Override
    public boolean isEjectionPossible() {
<span class="nc bnc" id="L4266" title="All 2 branches missed.">        return game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT)</span>
<span class="nc bnc" id="L4267" title="All 2 branches missed.">                &amp;&amp; getCrew().isActive()</span>
<span class="nc bnc" id="L4268" title="All 2 branches missed.">                &amp;&amp; !hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT);</span>
    }

    /**
     * Used for omni vehicles, which must set the weight of turrets
     * the base chassis, limiting the amount of pod space in the turret.
     *
     * @return The weight of the primary turret
     */
    public double getBaseChassisTurretWeight() {
<span class="nc" id="L4278">        return baseChassisTurretWeight;</span>
    }

    /**
     * Sets the fixed weight of the primary turret on a dual-turret omnivehicle.
     *
     * @param baseChassisTurretWeight The weight of the turret
     */
    public void setBaseChassisTurretWeight(double baseChassisTurretWeight) {
<span class="nc" id="L4287">        this.baseChassisTurretWeight = baseChassisTurretWeight;</span>
<span class="nc" id="L4288">    }</span>

    /**
     * Used for omni vehicles, which must set the weight of turrets
     * the base chassis, limiting the amount of pod space in the turret.
     *
     * @return The weight of the second turret
     */
    public double getBaseChassisTurret2Weight() {
<span class="nc" id="L4297">        return baseChassisTurret2Weight;</span>
    }

    /**
     * Sets the fixed weight of the second turret on a dual-turret omnivehicle.
     *
     * @param baseChassisTurret2Weight The weight of the turret
     */
    public void setBaseChassisTurret2Weight(double baseChassisTurret2Weight) {
<span class="nc" id="L4306">        this.baseChassisTurret2Weight = baseChassisTurret2Weight;</span>
<span class="nc" id="L4307">    }</span>

    /**
     * Used for omni vehicles, which must set the weight of sponson or pintle mounts in
     * the base chassis, limiting the amount of pod space in the turret(s).
     *
     * @return The weight of any pintle mounts (small support vee) or sponson mounts
     * (combat vee and M/L support vee)
     */
    public double getBaseChassisSponsonPintleWeight() {
<span class="nc" id="L4317">        return baseChassisSponsonPintleWeight;</span>
    }

    /**
     * Sets the fixed weight of any pintle (small SV) or sponson (CV, M/L SV) turrets
     * on an omnivehicle.
     *
     * @param baseChassisSponsonPintleWeight The weight of the sponson/pintle turrets.
     */
    public void setBaseChassisSponsonPintleWeight(double baseChassisSponsonPintleWeight) {
<span class="nc" id="L4327">        this.baseChassisSponsonPintleWeight = baseChassisSponsonPintleWeight;</span>
<span class="nc" id="L4328">    }</span>

    public boolean hasNoControlSystems() {
<span class="nc" id="L4331">        return hasNoControlSystems;</span>
    }

    public void setHasNoControlSystems(boolean hasNoControlSystems) {
<span class="nc" id="L4335">        this.hasNoControlSystems = hasNoControlSystems;</span>
<span class="nc" id="L4336">    }</span>

    /**
     * Used to determine the draw priority of different Entity subclasses.
     * This allows different unit types to always be draw above/below other
     * types.
     *
     * @return
     */
    public int getSpriteDrawPriority() {
<span class="nc" id="L4346">        return 4;</span>
    }

    //Specific road/rail train rules

    /**
     * Used to determine if this vehicle can be towed by a tractor
     *
     * @return Whether the unit is constructed as a trailer
     */
    @Override
    public boolean isTrailer() {
<span class="nc" id="L4358">        return trailer;</span>
    }

    /**
     * Marks whether the tank is constructed as a trailer. This has no effect on
     * support vehicles, which determine trailer status by the trailer chassis modification.
     *
     * @param trailer Whether the tank is constructed as a trailer.
     */
    public void setTrailer(boolean trailer) {
<span class="nc" id="L4368">        this.trailer = trailer;</span>
<span class="nc" id="L4369">    }</span>

    /**
     * Used to determine if this vehicle can be the engine/tractor
     * for a bunch of trailers
     *
     * @return
     */
    @Override
    public boolean isTractor() {
<span class="nc bnc" id="L4379" title="All 2 branches missed.">        if (getMovementMode().equals(EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L4380" title="All 2 branches missed.">                || getMovementMode().equals(EntityMovementMode.WHEELED)) {</span>
            // Any tracked or wheeled combat vehicle can be used as a tractor
            // if it is capable of independent operations or it is equipped with
            // a hitch (making it a trailer that is part of a train).
<span class="nc bnc" id="L4384" title="All 4 branches missed.">            return (hasEngine() &amp;&amp; !hasNoControlSystems())</span>
<span class="nc bnc" id="L4385" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_HITCH);</span>
        }
<span class="nc" id="L4387">        return false;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>