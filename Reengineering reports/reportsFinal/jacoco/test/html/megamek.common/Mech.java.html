<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Mech.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Mech.java</span></div><h1>Mech.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
* Copyright (C) 2018 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/

package megamek.common;

import java.io.PrintWriter;
import java.math.BigInteger;
import java.text.NumberFormat;
import java.util.*;

import megamek.MegaMek;
import megamek.common.loaders.MtfFile;
import megamek.common.options.OptionsConstants;
import megamek.common.preference.PreferenceManager;
import megamek.common.weapons.autocannons.ACWeapon;
import megamek.common.weapons.autocannons.HVACWeapon;
import megamek.common.weapons.autocannons.LBXACWeapon;
import megamek.common.weapons.autocannons.UACWeapon;
import megamek.common.weapons.gaussrifles.GaussWeapon;
import megamek.common.weapons.lasers.CLImprovedHeavyLaserLarge;
import megamek.common.weapons.lasers.CLImprovedHeavyLaserMedium;
import megamek.common.weapons.lasers.CLImprovedHeavyLaserSmall;
import megamek.common.weapons.lasers.ISRISCHyperLaser;
import megamek.common.weapons.other.ISMekTaser;
import megamek.common.weapons.other.TSEMPWeapon;
import megamek.common.weapons.ppc.PPCWeapon;
import megamek.common.weapons.prototypes.*;

/**
 * You know what mechs are, silly.
 */
public abstract class Mech extends Entity {
    /**
     *
     */
    private static final long serialVersionUID = -1929593228891136561L;

    // system designators for critical hits
    public static final int SYSTEM_LIFE_SUPPORT = 0;

    public static final int SYSTEM_SENSORS = 1;

    public static final int SYSTEM_COCKPIT = 2;

    public static final int SYSTEM_ENGINE = 3;

    public static final int SYSTEM_GYRO = 4;

    // actuators are systems too, for now
    public static final int ACTUATOR_SHOULDER = 7;

    public static final int ACTUATOR_UPPER_ARM = 8;

    public static final int ACTUATOR_LOWER_ARM = 9;

    public static final int ACTUATOR_HAND = 10;

    public static final int ACTUATOR_HIP = 11;

    public static final int ACTUATOR_UPPER_LEG = 12;

    public static final int ACTUATOR_LOWER_LEG = 13;

    public static final int ACTUATOR_FOOT = 14;

<span class="fc" id="L79">    public static final String[] systemNames = { &quot;Life Support&quot;, &quot;Sensors&quot;,</span>
            &quot;Cockpit&quot;, &quot;Engine&quot;, &quot;Gyro&quot;, null, null, &quot;Shoulder&quot;, &quot;Upper Arm&quot;,
            &quot;Lower Arm&quot;, &quot;Hand&quot;, &quot;Hip&quot;, &quot;Upper Leg&quot;, &quot;Lower Leg&quot;, &quot;Foot&quot;};

    // locations
    public static final int LOC_HEAD = 0;

    public static final int LOC_CT = 1;

    public static final int LOC_RT = 2;

    public static final int LOC_LT = 3;

    public static final int LOC_RARM = 4;

    public static final int LOC_LARM = 5;

    public static final int LOC_RLEG = 6;

    public static final int LOC_LLEG = 7;

    // center leg, for tripods
    public static final int LOC_CLEG = 8;

    // cockpit status
    public static final int COCKPIT_OFF = 0;

    public static final int COCKPIT_ON = 1;

    public static final int COCKPIT_AIMED_SHOT = 2;

    // gyro types
    public static final int GYRO_UNKNOWN = -1;

    public static final int GYRO_STANDARD = 0;

    public static final int GYRO_XL = 1;

    public static final int GYRO_COMPACT = 2;

    public static final int GYRO_HEAVY_DUTY = 3;

    public static final int GYRO_NONE = 4;

    public static final int GYRO_SUPERHEAVY = 5;

<span class="fc" id="L125">    public static final String[] GYRO_STRING = { &quot;Standard Gyro&quot;, &quot;XL Gyro&quot;,</span>
            &quot;Compact Gyro&quot;, &quot;Heavy Duty Gyro&quot;, &quot;None&quot;, &quot;Superheavy Gyro&quot; };

<span class="fc" id="L128">    public static final String[] GYRO_SHORT_STRING = { &quot;Standard&quot;, &quot;XL&quot;,</span>
            &quot;Compact&quot;, &quot;Heavy Duty&quot;, &quot;None&quot;, &quot;Superheavy&quot; };

    // cockpit types
    public static final int COCKPIT_UNKNOWN = -1;

    public static final int COCKPIT_STANDARD = 0;

    public static final int COCKPIT_SMALL = 1;

    public static final int COCKPIT_COMMAND_CONSOLE = 2;

    public static final int COCKPIT_TORSO_MOUNTED = 3;

    public static final int COCKPIT_DUAL = 4;

    public static final int COCKPIT_INDUSTRIAL = 5;

    public static final int COCKPIT_PRIMITIVE = 6;

    public static final int COCKPIT_PRIMITIVE_INDUSTRIAL = 7;

    public static final int COCKPIT_SUPERHEAVY = 8;

    public static final int COCKPIT_SUPERHEAVY_TRIPOD = 9;

    public static final int COCKPIT_TRIPOD = 10;

    public static final int COCKPIT_INTERFACE = 11;

    public static final int COCKPIT_VRRP = 12;

    public static final int COCKPIT_QUADVEE = 13;

    public static final int COCKPIT_SUPERHEAVY_INDUSTRIAL = 14;
    
    public static final int COCKPIT_SUPERHEAVY_COMMAND_CONSOLE = 15;
    
    public static final int COCKPIT_SMALL_COMMAND_CONSOLE = 16;

<span class="fc" id="L168">    public static final String[] COCKPIT_STRING = { &quot;Standard Cockpit&quot;,</span>
            &quot;Small Cockpit&quot;, &quot;Command Console&quot;, &quot;Torso-Mounted Cockpit&quot;,
            &quot;Dual Cockpit&quot;, &quot;Industrial Cockpit&quot;, &quot;Primitive Cockpit&quot;,
            &quot;Primitive Industrial Cockpit&quot;, &quot;Superheavy Cockpit&quot;,
            &quot;Superheavy Tripod Cockpit&quot;, &quot;Tripod Cockpit&quot;, &quot;Interface Cockpit&quot;,
            &quot;Virtual Reality Piloting Pod&quot;, &quot;QuadVee Cockpit&quot;,
            &quot;Superheavy Industrial Cockpit&quot;, &quot;Superheavy Command Console&quot;, 
	    &quot;Small Command Console&quot;};

<span class="fc" id="L177">    public static final String[] COCKPIT_SHORT_STRING = { &quot;Standard&quot;, &quot;Small&quot;,</span>
            &quot;Command Console&quot;, &quot;Torso Mounted&quot;, &quot;Dual&quot;, &quot;Industrial&quot;,
            &quot;Primitive&quot;, &quot;Primitive Industrial&quot;, &quot;Superheavy&quot;,
            &quot;Superheavy Tripod&quot;, &quot;Tripod&quot;, &quot;Interface&quot;, &quot;VRRP&quot;, &quot;Quadvee&quot;,
            &quot;Superheavy Industrial&quot;, &quot;Superheavy Command&quot;, 
            &quot;Small Command&quot;};

    public static final String FULL_HEAD_EJECT_STRING = &quot;Full Head Ejection System&quot;;

    // jump types
    public static final int JUMP_UNKNOWN = -1;
    public static final int JUMP_NONE = 0;
    public static final int JUMP_STANDARD = 1;
    public static final int JUMP_IMPROVED = 2;
    public static final int JUMP_PROTOTYPE = 3;
    public static final int JUMP_BOOSTER = 4;
    public static final int JUMP_DISPOSABLE = 5;
    // Type for Improved Jumpjet Prototype
    public static final int JUMP_PROTOTYPE_IMPROVED = 6;

    // Some &quot;has&quot; items only need be determined once
    public static final int HAS_FALSE = -1;

    public static final int HAS_UNKNOWN = 0;

    public static final int HAS_TRUE = 1;
    // rear armor
    private int[] rearArmor;

    private int[] orig_rearArmor;

    private boolean[] rearHardenedArmorDamaged;

    // for Harjel II/III
    private boolean[] armorDamagedThisTurn;

<span class="fc" id="L213">    private int sinksOn = -1;</span>

<span class="fc" id="L215">    private int sinksOnNextRound = -1;</span>

<span class="fc" id="L217">    private boolean autoEject = true;</span>

<span class="fc" id="L219">    private boolean condEjectAmmo = true;</span>

<span class="fc" id="L221">    private boolean condEjectEngine = true;</span>

<span class="fc" id="L223">    private boolean condEjectCTDest = true;</span>

<span class="fc" id="L225">    private boolean condEjectHeadshot = true;</span>

<span class="fc" id="L227">    private int cockpitStatus = COCKPIT_ON;</span>

<span class="fc" id="L229">    private int cockpitStatusNextRound = COCKPIT_ON;</span>

<span class="fc" id="L231">    private int jumpType = JUMP_UNKNOWN;</span>

<span class="fc" id="L233">    protected int gyroType = GYRO_STANDARD;</span>

<span class="fc" id="L235">    protected int cockpitType = COCKPIT_STANDARD;</span>

<span class="fc" id="L237">    private int cowlArmor = 3;</span>

<span class="fc" id="L239">    private int hasLaserHeatSinks = HAS_UNKNOWN;</span>

    // For grapple attacks
<span class="fc" id="L242">    private int grappled_id = Entity.NONE;</span>

<span class="fc" id="L244">    private boolean isGrappleAttacker = false;</span>

<span class="fc" id="L246">    private int grappledSide = Entity.GRAPPLE_BOTH;</span>

<span class="fc" id="L248">    private boolean grappledThisRound = false;</span>

<span class="fc" id="L250">    private boolean shouldDieAtEndOfTurnBecauseOfWater = false;</span>

<span class="fc" id="L252">    private boolean justMovedIntoIndustrialKillingWater = false;</span>

<span class="fc" id="L254">    private boolean stalled = false;</span>

<span class="fc" id="L256">    private boolean stalledThisTurn = false;</span>

<span class="fc" id="L258">    private boolean checkForCrit = false;</span>

<span class="fc" id="L260">    private int levelsFallen = 0;</span>

<span class="fc" id="L262">    private boolean fullHeadEject = false;</span>

<span class="fc" id="L264">    protected static int[] EMERGENCY_COOLANT_SYSTEM_FAILURE = {3, 5, 7, 10, 13, 13, 13};</span>

    // nCoolantSystemLevel is the # of turns RISC emergency coolant system has been used previously
<span class="fc" id="L267">    protected int nCoolantSystemLevel = 0;</span>

<span class="fc" id="L269">    protected boolean bCoolantWentUp = false;</span>

<span class="fc" id="L271">    protected boolean bUsedCoolantSystem = false; // Has emergency coolant system been used?</span>

<span class="fc" id="L273">    protected boolean bDamagedCoolantSystem = false; // is the emergency coolant system damaged?</span>

<span class="fc" id="L275">    protected int nCoolantSystemMOS = 0;</span>

    // Cooling System Flaws quirk
<span class="fc" id="L278">    private boolean coolingFlawActive = false;</span>

    // QuadVees, LAMs, and tracked 'Mechs can change movement mode.
<span class="fc" id="L281">    protected EntityMovementMode originalMovementMode = EntityMovementMode.BIPED;</span>

    /**
     * Construct a new, blank, mech.
     */
    public Mech() {
<span class="nc" id="L287">        this(Mech.GYRO_STANDARD, Mech.COCKPIT_STANDARD);</span>
<span class="nc" id="L288">    }</span>

    public Mech(int inGyroType, int inCockpitType) {
<span class="fc" id="L291">        super();</span>

<span class="fc" id="L293">        gyroType = inGyroType;</span>
<span class="fc" id="L294">        cockpitType = inCockpitType;</span>

<span class="fc" id="L296">        rearArmor = new int[locations()];</span>
<span class="fc" id="L297">        orig_rearArmor = new int[locations()];</span>
<span class="fc" id="L298">        rearHardenedArmorDamaged = new boolean[locations()];</span>
<span class="fc" id="L299">        armorDamagedThisTurn = new boolean[locations()];</span>

<span class="fc bfc" id="L301" title="All 2 branches covered.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">            if (!hasRearArmor(i)) {</span>
<span class="fc" id="L303">                initializeRearArmor(IArmorState.ARMOR_NA, i);</span>
            }
        }

        // Standard leg crits
<span class="fc" id="L308">        setCritical(LOC_RLEG, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_HIP));
<span class="fc" id="L310">        setCritical(LOC_RLEG, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_UPPER_LEG));
<span class="fc" id="L312">        setCritical(LOC_RLEG, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_LOWER_LEG));
<span class="fc" id="L314">        setCritical(LOC_RLEG, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_FOOT));

<span class="fc" id="L317">        setCritical(LOC_LLEG, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_HIP));
<span class="fc" id="L319">        setCritical(LOC_LLEG, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_UPPER_LEG));
<span class="fc" id="L321">        setCritical(LOC_LLEG, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_LOWER_LEG));
<span class="fc" id="L323">        setCritical(LOC_LLEG, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                ACTUATOR_FOOT));

        // Player setting specify whether their Meks' automatic
        // ejection systems are disabled by default or not.
<span class="fc" id="L328">        autoEject = !PreferenceManager.getClientPreferences()</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">                .defaultAutoejectDisabled();</span>

<span class="pc bpc" id="L331" title="5 of 6 branches missed.">        switch (inCockpitType) {</span>
        case COCKPIT_TRIPOD:
<span class="nc" id="L333">            setCrew(new Crew(CrewType.TRIPOD));</span>
<span class="nc" id="L334">            break;</span>
        case COCKPIT_SUPERHEAVY_TRIPOD:
<span class="nc" id="L336">            setCrew(new Crew(CrewType.SUPERHEAVY_TRIPOD));</span>
<span class="nc" id="L337">            break;</span>
        case COCKPIT_DUAL:
<span class="nc" id="L339">            setCrew(new Crew(CrewType.DUAL));</span>
<span class="nc" id="L340">            break;</span>
        case COCKPIT_COMMAND_CONSOLE:
	case COCKPIT_SUPERHEAVY_COMMAND_CONSOLE:
	case COCKPIT_SMALL_COMMAND_CONSOLE:
<span class="nc" id="L344">            setCrew(new Crew(CrewType.COMMAND_CONSOLE));</span>
<span class="nc" id="L345">            break;</span>
        case COCKPIT_QUADVEE:
<span class="nc" id="L347">            setCrew(new Crew(CrewType.QUADVEE));</span>
            break;
        }
<span class="fc" id="L350">    }</span>

    @Override
    public int getUnitType() {
<span class="nc" id="L354">        return UnitType.MEK;</span>
    }

    /**
     * @return if this mech cannot stand up from hulldown
     */
    public abstract boolean cannotStandUpFromHullDown();

    public int getCowlArmor() {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (hasCowl()) {</span>
<span class="nc" id="L364">            return cowlArmor;</span>
        }
<span class="nc" id="L366">        return 0;</span>
    }

    public boolean hasCowl() {
<span class="nc" id="L370">        return hasQuirk(OptionsConstants.QUIRK_POS_COWL);</span>
    }

    /**
     * Damage the cowl. Returns amount of excess damage
     *
     * @param amount
     * @return
     */
    public int damageCowl(int amount) {
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (hasCowl()) {</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (amount &lt; cowlArmor) {</span>
<span class="nc" id="L382">                cowlArmor -= amount;</span>
<span class="nc" id="L383">                return 0;</span>
            }
<span class="nc" id="L385">            amount -= cowlArmor;</span>
<span class="nc" id="L386">            cowlArmor = 0;</span>
<span class="nc" id="L387">            return amount;</span>
        }
<span class="nc" id="L389">        return amount; // No cowl - return full damage</span>
    }

    /**
     * Returns the location that transferred damage or crits will go to from a
     * given location.
     */
    public static int getInnerLocation(int location) {
<span class="nc bnc" id="L397" title="All 4 branches missed.">        switch (location) {</span>
            case Mech.LOC_RT:
            case Mech.LOC_LT:
            case Mech.LOC_CLEG:
<span class="nc" id="L401">                return Mech.LOC_CT;</span>
            case Mech.LOC_LLEG:
            case Mech.LOC_LARM:
<span class="nc" id="L404">                return Mech.LOC_LT;</span>
            case Mech.LOC_RLEG:
            case Mech.LOC_RARM:
<span class="nc" id="L407">                return Mech.LOC_RT;</span>
            default:
<span class="nc" id="L409">                return location;</span>
        }
    }

    /**
     * Returns the location with the most restrictive firing arc for a weapon.
     */
    public static int mostRestrictiveLoc(int location1, int location2) {
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (location1 == location2) {</span>
<span class="nc" id="L418">            return location1;</span>
<span class="nc" id="L419">        } else if (Mech.restrictScore(location1) &gt;= Mech</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                .restrictScore(location2)) {</span>
<span class="nc" id="L421">            return location1;</span>
        } else {
<span class="nc" id="L423">            return location2;</span>
        }
    }

    /**
     * find the least restrictive location of the two locations passed in
     *
     * @param location1
     * @param location2
     * @return
     */
    public static int leastRestrictiveLoc(int location1, int location2) {
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (location1 == location2) {</span>
<span class="nc" id="L436">            return location2;</span>
<span class="nc" id="L437">        } else if (Mech.restrictScore(location1) &gt;= Mech</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                .restrictScore(location2)) {</span>
<span class="nc" id="L439">            return location2;</span>
        } else {
<span class="nc" id="L441">            return location1;</span>
        }
    }

    /**
     * Helper function designed to give relative restrictiveness of locations.
     * Used for finding the most restrictive firing arc for a weapon.
     */
    public static int restrictScore(int location) {
<span class="nc bnc" id="L450" title="All 4 branches missed.">        switch (location) {</span>
            case Mech.LOC_RARM:
            case Mech.LOC_LARM:
<span class="nc" id="L453">                return 0;</span>
            case Mech.LOC_RT:
            case Mech.LOC_LT:
<span class="nc" id="L456">                return 1;</span>
            case Mech.LOC_CT:
<span class="nc" id="L458">                return 2;</span>
            default:
<span class="nc" id="L460">                return 3;</span>
        }
    }

    /**
     * OmniMechs have handles for Battle Armor squads to latch onto. Please
     * note, this method should only be called during this Mech's construction.
     * &lt;p/&gt;
     * Overrides &lt;code&gt;Entity#setOmni(boolean)&lt;/code&gt;
     */
    @Override
    public void setOmni(boolean omni) {

        // Perform the superclass' action.
<span class="fc" id="L474">        super.setOmni(omni);</span>

        // Add BattleArmorHandles to OmniMechs.
<span class="pc bpc" id="L477" title="3 of 4 branches missed.">        if (omni &amp;&amp; !hasBattleArmorHandles()) {</span>
<span class="nc" id="L478">            addTransporter(new BattleArmorHandles());</span>
        }
<span class="fc" id="L480">    }</span>

    // Set whether a non-omni should have BA Grab Bars.
    public void setBAGrabBars() {
<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L485">            return;</span>
        }
        // TODO: I really hate this optional rule - what if some units are
        // already loaded?
        // if ba_grab_bars is on, then we need to add battlearmor handles,
        // otherwise clamp mounts
        // but first clear out whatever we have
        // Removed the removal of transporters so that loaded units don't get ditched
        // This is an unofficial rule and it doesn't work well anyway as changing the option
        // does not affect units that are in the game
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_BA_GRAB_BARS)) {</span>
<span class="nc" id="L496">            addTransporter(new BattleArmorHandles());</span>
        } else {
<span class="nc" id="L498">            addTransporter(new ClampMountMech());</span>
        }
<span class="nc" id="L500">    }</span>

    public void setProtomechClampMounts() {
<span class="nc" id="L503">        boolean front = false;</span>
<span class="nc" id="L504">        boolean rear = false;</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        for (Transporter t: getTransports()) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            if (t instanceof ProtomechClampMount) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                front |= !((ProtomechClampMount) t).isRear();</span>
<span class="nc" id="L508">                rear |= ((ProtomechClampMount) t).isRear();</span>
            }
<span class="nc" id="L510">        }</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (!front) {</span>
<span class="nc" id="L512">            addTransporter(new ProtomechClampMount(false));</span>
        }
<span class="nc bnc" id="L514" title="All 2 branches missed.">        if (!rear) {</span>
<span class="nc" id="L515">            addTransporter(new ProtomechClampMount(true));</span>
        }
<span class="nc" id="L517">    }</span>

    @Override
    public void load(Entity unit, boolean checkElev, int bayNumber) {
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (unit.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">            boolean rear = bayNumber &gt; 0;</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">            for (Transporter t : getTransports()) {</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                if ((t instanceof ProtomechClampMount)</span>
<span class="nc bnc" id="L525" title="All 4 branches missed.">                        &amp;&amp; t.canLoad(unit)</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                        &amp;&amp; (!checkElev || (unit.getElevation() == getElevation()))</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                        &amp;&amp; (((ProtomechClampMount) t).isRear() == rear)) {</span>
<span class="nc" id="L528">                    t.load(unit);</span>
<span class="nc" id="L529">                    unit.setTargetBay(-1);</span>
<span class="nc" id="L530">                    return;</span>
                }
<span class="nc" id="L532">            }</span>
        }
<span class="nc" id="L534">        super.load(unit, checkElev, bayNumber);</span>
<span class="nc" id="L535">    }</span>

    /**
     * Returns the number of locations in the entity
     */
    @Override
    public int locations() {
<span class="fc" id="L542">        return 8;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#newRound(int)
     */
    @Override
    public void newRound(int roundNumber) {
        // Walk through the Mech's miscellaneous equipment before
        // we apply our parent class' newRound() functionality
        // because Mek Stealth is set by the Entity#newRound() method.
<span class="fc bfc" id="L555" title="All 2 branches covered.">        for (Mounted m : getMisc()) {</span>
<span class="fc" id="L556">            MiscType mtype = (MiscType) m.getType();</span>

            // Stealth can not be turned on if it's ECM is destroyed.
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">                    &amp;&amp; m.getLinked().isDestroyed()</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">                    &amp;&amp; m.getLinked().isBreached()) {</span>
<span class="nc" id="L562">                m.setMode(&quot;Off&quot;);</span>
            }
<span class="fc" id="L564">        } // Check the next piece of equipment.</span>

<span class="fc" id="L566">        super.newRound(roundNumber);</span>
        // If MASC was used last turn, increment the counter,
        // otherwise decrement. Then, clear the counter
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">        if (usedMASC) {</span>
<span class="nc" id="L570">            nMASCLevel++;</span>
<span class="nc" id="L571">            bMASCWentUp = true;</span>
        } else {
<span class="fc" id="L573">            nMASCLevel = Math.max(0, nMASCLevel - 1);</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">            if (bMASCWentUp) {</span>
<span class="nc" id="L575">                nMASCLevel = Math.max(0, nMASCLevel - 1);</span>
<span class="nc" id="L576">                bMASCWentUp = false;</span>
            }
        }

        // Clear the MASC flag
<span class="fc" id="L581">        usedMASC = false;</span>

        // If emergency cooling system was used last turn, increment the counter,
        // otherwise decrement. Then, clear the counter
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">        if (bUsedCoolantSystem) {</span>
<span class="nc" id="L586">            nCoolantSystemLevel++;</span>
<span class="nc" id="L587">            bCoolantWentUp = true;</span>
        } else {
<span class="fc" id="L589">            nCoolantSystemLevel = Math.max(0, nCoolantSystemLevel - 1);</span>
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">            if (bCoolantWentUp) {</span>
<span class="nc" id="L591">                nCoolantSystemLevel = Math.max(0, nCoolantSystemLevel - 1);</span>
<span class="nc" id="L592">                bCoolantWentUp = false;</span>
            }
        }

        // Clear the coolant system flag
<span class="fc" id="L597">        bUsedCoolantSystem = false;</span>


<span class="fc" id="L600">        setSecondaryFacing(getFacing());</span>

        // set heat sinks
<span class="fc" id="L603">        sinksOn = sinksOnNextRound;</span>

        // update cockpit status
<span class="fc" id="L606">        cockpitStatus = cockpitStatusNextRound;</span>

<span class="pc bpc" id="L608" title="1 of 2 branches missed.">        if (isJustMovedIntoIndustrialKillingWater()) {</span>
<span class="nc" id="L609">            shouldDieAtEndOfTurnBecauseOfWater = true;</span>
        } else {
<span class="fc" id="L611">            shouldDieAtEndOfTurnBecauseOfWater = false;</span>
        }
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">        if (stalledThisTurn) {</span>
<span class="nc" id="L614">            stalledThisTurn = false;</span>
        }
<span class="fc" id="L616">        levelsFallen = 0;</span>
<span class="fc" id="L617">        checkForCrit = false;</span>

<span class="fc" id="L619">        grappledThisRound = false;</span>

        // clear HarJel &quot;took damage this turn&quot; flags
<span class="fc bfc" id="L622" title="All 2 branches covered.">        for (int loc = 0; loc &lt; locations(); ++loc) {</span>
<span class="fc" id="L623">            setArmorDamagedThisTurn(loc, false);</span>
        }
<span class="fc" id="L625">    } // End public void newRound()</span>

    /**
     * Returns true if the location in question is a torso location
     */
    public boolean locationIsTorso(int loc) {
<span class="nc bnc" id="L631" title="All 6 branches missed.">        return (loc == LOC_CT) || (loc == LOC_RT) || (loc == LOC_LT);</span>
    }

    /**
     * Returns true if the location in question is a leg
     */
    @Override
    public boolean locationIsLeg(int loc) {
<span class="fc bfc" id="L639" title="All 4 branches covered.">        return (loc == LOC_LLEG) || (loc == LOC_RLEG);</span>
    }

    /**
     * Count the number of destroyed or breached legs on the mech
     */
    public int countBadLegs() {
<span class="fc" id="L646">        int badLegs = 0;</span>

<span class="fc bfc" id="L648" title="All 2 branches covered.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="pc bpc" id="L649" title="1 of 4 branches missed.">            badLegs += (locationIsLeg(i) &amp;&amp; isLocationBad(i)) ? 1 : 0;</span>
        }

<span class="fc" id="L652">        return badLegs;</span>
    }

    /**
     * Returns true if the entity has a hip crit.
     */
    @Override
    public boolean hasHipCrit() {
<span class="nc bnc" id="L660" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">            if (legHasHipCrit(loc)) {</span>
<span class="nc" id="L662">                return true;</span>
            }
        }
<span class="nc" id="L665">        return false;</span>
    }

    /**
     * Return true is the location is a leg and has a hip crit
     */
    public boolean legHasHipCrit(int loc) {
<span class="pc bpc" id="L672" title="1 of 2 branches missed.">        if (isLocationBad(loc)) {</span>
<span class="nc" id="L673">            return false;</span>
        }

<span class="pc bpc" id="L676" title="1 of 2 branches missed.">        if (locationIsLeg(loc)) {</span>
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">            return (getGoodCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.ACTUATOR_HIP, loc) == 0);
        }

<span class="nc" id="L681">        return false;</span>
    }

    /**
     * This function returns true iff the system is in perfect condition.
     *
     * @param system
     *            the system to check
     * @return false if the system is damaged.
     */
    public boolean isSystemIntact(int system) {
<span class="nc bnc" id="L692" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L693">            int numCrits = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">            for (int i = 0; i &lt; numCrits; i++) {</span>
<span class="nc" id="L695">                CriticalSlot ccs = getCritical(loc, i);</span>

<span class="nc bnc" id="L697" title="All 2 branches missed.">                if ((ccs != null)</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">                        &amp;&amp; (ccs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                        &amp;&amp; (ccs.getIndex() == system)) {</span>
<span class="nc bnc" id="L700" title="All 4 branches missed.">                    if (ccs.isDamaged() || ccs.isBreached()) {</span>
<span class="nc" id="L701">                        return false;</span>
                    }
                }
            }
        }

<span class="nc" id="L707">        return true;</span>
    }

    /**
     * Count non-hip leg actuator crits
     */
    public int countLegActuatorCrits(int loc) {
<span class="pc bpc" id="L714" title="1 of 2 branches missed.">        if (isLocationBad(loc)) {</span>
<span class="nc" id="L715">            return 0;</span>
        }

<span class="fc" id="L718">        int legCrits = 0;</span>

<span class="pc bpc" id="L720" title="1 of 2 branches missed.">        if (locationIsLeg(loc)) {</span>
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">            if (getGoodCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.ACTUATOR_UPPER_LEG, loc) == 0) {
<span class="nc" id="L723">                legCrits++;</span>
            }
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">            if (getGoodCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.ACTUATOR_LOWER_LEG, loc) == 0) {
<span class="nc" id="L727">                legCrits++;</span>
            }
<span class="pc bpc" id="L729" title="1 of 2 branches missed.">            if (getGoodCriticals(CriticalSlot.TYPE_SYSTEM, Mech.ACTUATOR_FOOT,</span>
                    loc) == 0) {
<span class="nc" id="L731">                legCrits++;</span>
            }
        }

<span class="fc" id="L735">        return legCrits;</span>
    }

    /**
     * does this mech have composite internal structure?
     *
     * @return
     */
    public boolean hasCompositeStructure() {
<span class="nc bnc" id="L744" title="All 2 branches missed.">        return (getStructureType() == EquipmentType.T_STRUCTURE_COMPOSITE);</span>
    }

    /**
     * does this mech have reinforced internal structure?
     *
     * @return
     */
    public boolean hasReinforcedStructure() {
<span class="nc bnc" id="L753" title="All 2 branches missed.">        return (getStructureType() == EquipmentType.T_STRUCTURE_REINFORCED);</span>
    }

    /**
     * does this mech mount MASC?
     *
     * @return
     */
    public boolean hasMASC() {
<span class="nc bnc" id="L762" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L763">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L764" title="All 4 branches missed.">            if (mtype.hasFlag(MiscType.F_MASC) &amp;&amp; !mEquip.isInoperable()) {</span>
<span class="nc" id="L765">                return true;</span>
            }
<span class="nc" id="L767">        }</span>
<span class="nc" id="L768">        return false;</span>
    }

    /**
     * checks if a mech has both a normal MASC system and a supercharger,
     * regardless of arming status
     */
    public boolean hasMASCAndSuperCharger() {
<span class="nc" id="L776">        boolean hasMASC = false;</span>
<span class="nc" id="L777">        boolean hasSuperCharger = false;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L779" title="All 4 branches missed.">            if (!m.isInoperable() &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasSubType(MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L782">                hasSuperCharger = true;</span>
            }
<span class="nc bnc" id="L784" title="All 4 branches missed.">            if (!m.isInoperable() &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">                    &amp;&amp; !m.getType().hasSubType(MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L787">                hasMASC = true;</span>
            }
<span class="nc" id="L789">        }</span>
<span class="nc bnc" id="L790" title="All 4 branches missed.">        return hasMASC &amp;&amp; hasSuperCharger;</span>
    }

    /**
     * does this mech have working jump boosters?
     *
     * @return
     */
    public boolean hasJumpBoosters() {
<span class="nc" id="L799">        boolean jumpBoosters = false;</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L801">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_JUMP_BOOSTER)) {</span>

                // one crit destroyed they all all screwed
                // --Torren
<span class="nc bnc" id="L806" title="All 4 branches missed.">                if (mEquip.isBreached() || mEquip.isDestroyed()</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">                        || mEquip.isMissing()) {</span>
<span class="nc" id="L808">                    return false;</span>
                }
<span class="nc" id="L810">                jumpBoosters = true;</span>
            }
<span class="nc" id="L812">        }</span>
<span class="nc" id="L813">        return jumpBoosters;</span>
    }

    /**
     * Checks if a mech has an armed MASC system. Note that the mech will have
     * to exceed its normal run to actually engage the MASC system
     */
    public boolean hasArmedMASC() {
<span class="fc bfc" id="L821" title="All 2 branches covered.">        for (Mounted m : getEquipment()) {</span>
<span class="pc bpc" id="L822" title="2 of 4 branches missed.">            if (!m.isDestroyed() &amp;&amp; !m.isBreached()</span>
<span class="fc bfc" id="L823" title="All 2 branches covered.">                    &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">                    &amp;&amp; m.curMode().equals(&quot;Armed&quot;)) {</span>
<span class="nc" id="L826">                return true;</span>
            }
<span class="fc" id="L828">        }</span>
<span class="fc" id="L829">        return false;</span>
    }

    /**
     * checks if a mech has both a normal armed MASC system and a armed super-
     * charger.
     */
    public boolean hasArmedMASCAndSuperCharger() {
<span class="fc" id="L837">        boolean hasMASC = false;</span>
<span class="fc" id="L838">        boolean hasSuperCharger = false;</span>
<span class="fc bfc" id="L839" title="All 2 branches covered.">        for (Mounted m : getEquipment()) {</span>
<span class="pc bpc" id="L840" title="2 of 4 branches missed.">            if (!m.isDestroyed() &amp;&amp; !m.isBreached()</span>
<span class="fc bfc" id="L841" title="All 2 branches covered.">                    &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                    &amp;&amp; m.curMode().equals(&quot;Armed&quot;)</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasSubType(MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L845">                hasSuperCharger = true;</span>
            }
<span class="pc bpc" id="L847" title="2 of 4 branches missed.">            if (!m.isDestroyed() &amp;&amp; !m.isBreached()</span>
<span class="fc bfc" id="L848" title="All 2 branches covered.">                    &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="pc bpc" id="L849" title="1 of 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">                    &amp;&amp; m.curMode().equals(&quot;Armed&quot;)</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">                    &amp;&amp; !m.getType().hasSubType(MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L852">                hasMASC = true;</span>
            }
<span class="fc" id="L854">        }</span>
<span class="pc bpc" id="L855" title="3 of 4 branches missed.">        return hasMASC &amp;&amp; hasSuperCharger;</span>
    }

    /**
     * Does this mech have an extended retractable blade in working condition?
     */
    public boolean hasExtendedRetractableBlade() {
<span class="nc bnc" id="L862" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L863" title="All 4 branches missed.">            if (!m.isInoperable() &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasSubType(MiscType.S_RETRACTABLE_BLADE)</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">                    &amp;&amp; m.curMode().equals(&quot;extended&quot;)) {</span>
<span class="nc" id="L867">                return true;</span>
            }
<span class="nc" id="L869">        }</span>
<span class="nc" id="L870">        return false;</span>
    }

    /**
     * Does the entity have a retracted blade in the given location? Only true
     * for biped mechs
     */
    public boolean hasRetractedBlade(int loc) {
<span class="nc" id="L878">        return false;</span>
    }

    /**
     * does this mech have TSM?
     */
    public boolean hasTSM() {
<span class="fc bfc" id="L885" title="All 2 branches covered.">        for (Mounted m : getEquipment()) {</span>
<span class="fc bfc" id="L886" title="All 2 branches covered.">            if ((m.getType() instanceof MiscType)</span>
<span class="pc bpc" id="L887" title="1 of 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_TSM)) {</span>
<span class="nc" id="L888">                return true;</span>
            }
<span class="fc" id="L890">        }</span>
<span class="fc" id="L891">        return false;</span>
    }

    /**
     * does this mech have SCM?
     */
    public boolean hasSCM() {
<span class="fc bfc" id="L898" title="All 2 branches covered.">        for (Mounted m : getEquipment()) {</span>
<span class="fc bfc" id="L899" title="All 2 branches covered.">            if ((m.getType() instanceof MiscType)</span>
<span class="pc bpc" id="L900" title="1 of 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_SCM)) {</span>
<span class="nc" id="L901">                return true;</span>
            }
<span class="fc" id="L903">        }</span>
<span class="fc" id="L904">        return false;</span>
    }

    /**
     * does this mech have industrial TSM=
     *
     * @return
     */
    public boolean hasIndustrialTSM() {
<span class="fc bfc" id="L913" title="All 2 branches covered.">        for (Mounted m : getEquipment()) {</span>
<span class="fc bfc" id="L914" title="All 2 branches covered.">            if ((m.getType() instanceof MiscType)</span>
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_INDUSTRIAL_TSM)) {</span>
<span class="nc" id="L916">                return true;</span>
            }
<span class="fc" id="L918">        }</span>
<span class="fc" id="L919">        return false;</span>
    }

    /**
     * does this mech have a null-sig-system?
     *
     * @return
     */
    public boolean hasNullSig() {
<span class="nc bnc" id="L928" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L929">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_NULLSIG)) {</span>
                // The Mek has Null-Sig
<span class="nc" id="L932">                return true;</span>
            }
<span class="nc" id="L934">        }</span>
<span class="nc" id="L935">        return false;</span>
    }

    /**
     * does this mech have a void-sig-system?
     *
     * @return
     */
    public boolean hasVoidSig() {
<span class="nc bnc" id="L944" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L945">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_VOIDSIG)) {</span>
                // The Mek has Void-Sig
<span class="nc" id="L948">                return true;</span>
            }
<span class="nc" id="L950">        }</span>
<span class="nc" id="L951">        return false;</span>
    }

    /**
     * Does this mech have tracks? Used for tracks as industrial equipment; QuadVees return false.
     *
     * @return
     */
    public boolean hasTracks() {
<span class="nc bnc" id="L960" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L961">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_TRACKS)) {</span>
                // The Mek has tracks
<span class="nc" id="L964">                return true;</span>
            }
<span class="nc" id="L966">        }</span>
<span class="nc" id="L967">        return false;</span>
    }

    /**
     * does this mech have a chameleon light polarization shield?
     *
     * @return
     */
    public boolean hasChameleonShield() {
<span class="nc bnc" id="L976" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L977">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_CHAMELEON_SHIELD)) {</span>
                // The Mek has Chameleon Light Polarization Field
<span class="nc" id="L980">                return true;</span>
            }
<span class="nc" id="L982">        }</span>
<span class="nc" id="L983">        return false;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getStandingHeat()
     */
    @Override
    public int getStandingHeat() {
<span class="nc bnc" id="L993" title="All 2 branches missed.">        return hasEngine() ? getEngine().getStandingHeat() : 0;</span>
    }

    /**
     * set this mech's &lt;code&gt;Engine&lt;/code&gt;
     *
     * @param e
     *            the &lt;code&gt;Engine&lt;/code&gt; to set
     */
    @Override
    public void setEngine(Engine e) {
<span class="fc" id="L1004">        super.setEngine(e);</span>
<span class="pc bpc" id="L1005" title="2 of 4 branches missed.">        if(hasEngine() &amp;&amp; getEngine().engineValid) {</span>
<span class="fc" id="L1006">            setOriginalWalkMP(calculateWalk());</span>
        }
<span class="fc" id="L1008">    }</span>

    /**
     * Used to set this Mech's original walk mp
     *
     * @return this units calculated walking speed, dependent on engine rating
     *         and weight
     */
    protected int calculateWalk() {
<span class="pc bpc" id="L1017" title="1 of 2 branches missed.">        if(!hasEngine()) {</span>
<span class="nc" id="L1018">            return 0;</span>
        }
<span class="pc bpc" id="L1020" title="1 of 2 branches missed.">        if (isPrimitive()) {</span>
<span class="nc" id="L1021">            double rating = getEngine().getRating();</span>
<span class="nc" id="L1022">            rating /= 1.2;</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">            if ((rating % 5) != 0) {</span>
<span class="nc" id="L1024">                return (int) ((rating - (rating % 5)) + 5) / (int) weight;</span>
            }
<span class="nc" id="L1026">            return (int) (rating / (int) weight);</span>

        }
<span class="fc" id="L1029">        return getEngine().getRating() / (int) weight;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getWalkHeat()
     */
    @Override
    public int getWalkHeat() {
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        int extra = bDamagedCoolantSystem?1:0;</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        return extra + (hasEngine() ? getEngine().getWalkHeat(this) : 0);</span>
    }

    /**
     * Returns whether this mech should use conditional ejection
     *
     * @return
     */
    /*
     * public boolean shouldUseConditionalEject() { if (game !=null &amp;&amp;
     * game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)) { return true; }
     *
     * return false; }
     */

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getRunMP(boolean, boolean, boolean)
     */
    @Override
    public int getRunMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="pc bpc" id="L1063" title="1 of 2 branches missed.">        if (hasArmedMASCAndSuperCharger()) {</span>
<span class="nc" id="L1064">            return ((int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                    ignoremodulararmor) * 2.5))
<span class="nc bnc" id="L1066" title="All 2 branches missed.">                    - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
        }
<span class="pc bpc" id="L1068" title="1 of 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L1069">            return (getWalkMP(gravity, ignoreheat, ignoremodulararmor) * 2)</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">                    - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
        }
<span class="fc" id="L1072">        return Math.max(0, super.getRunMP(gravity, ignoreheat, ignoremodulararmor)</span>
<span class="pc bpc" id="L1073" title="1 of 2 branches missed.">                - (hasMPReducingHardenedArmor() ? 1 : 0));</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getRunMPwithoutMASC(boolean, boolean, boolean)
     */
    @Override
    public int getRunMPwithoutMASC(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc" id="L1084">        return super.getRunMP(gravity, ignoreheat, ignoremodulararmor)</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">                - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
    }

    /**
     * @return The mech's run MP without MASC or supercharger, but with any reduction
     *         due to hardened armor.
     */
    public int getOriginalRunMPwithoutMASC() {
<span class="nc" id="L1093">        return super.getOriginalRunMP()</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
    }

    /**
     * Returns this entity's running/flank mp as a string.
     */
    @Override
    public String getRunMPasString() {
<span class="nc bnc" id="L1102" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L1103">            return getRunMPwithoutMASC() + &quot;(&quot; + getRunMP() + &quot;)&quot;;</span>
        }
<span class="nc" id="L1105">        return Integer.toString(getRunMP());</span>
    }

    /**
     * Depends on engine type
     */
    @Override
    public int getRunHeat() {
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        int extra = bDamagedCoolantSystem?1:0;</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">        return extra + (hasEngine() ? getEngine().getRunHeat(this) : 0);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMP()
     */
    @Override
    public int getSprintMP() {
<span class="nc bnc" id="L1124" title="All 2 branches missed.">        if (hasHipCrit()) {</span>
<span class="nc" id="L1125">            return getRunMP();</span>
        }
<span class="nc" id="L1127">        return getSprintMP(true, false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMP(boolean, boolean, boolean)
     */
    @Override
    public int getSprintMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc bnc" id="L1138" title="All 2 branches missed.">        if (hasHipCrit()) {</span>
<span class="nc" id="L1139">            return getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
        }
<span class="nc bnc" id="L1141" title="All 2 branches missed.">        if (hasArmedMASCAndSuperCharger()) {</span>
<span class="nc" id="L1142">            return ((int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                    ignoremodulararmor) * 3.0))
<span class="nc bnc" id="L1144" title="All 2 branches missed.">                    - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
        }
<span class="nc bnc" id="L1146" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L1147">            return ((int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                    ignoremodulararmor) * 2.5))
<span class="nc bnc" id="L1149" title="All 2 branches missed.">                    - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
        }
<span class="nc" id="L1151">        return getSprintMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMPwithoutMASC(boolean, boolean)
     */
    @Override
    public int getSprintMPwithoutMASC() {
<span class="nc" id="L1161">        return getSprintMPwithoutMASC(true, false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMPwithoutMASC(boolean, boolean,
     * boolean)
     */
    @Override
    public int getSprintMPwithoutMASC(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc bnc" id="L1173" title="All 2 branches missed.">        if (hasHipCrit()) {</span>
<span class="nc" id="L1174">            return getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
        }
<span class="nc" id="L1176">        return ((int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                ignoremodulararmor) * 2.0))
<span class="nc bnc" id="L1178" title="All 2 branches missed.">                - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
    }

    public int getOriginalSprintMPwithoutMASC() {
<span class="nc bnc" id="L1182" title="All 2 branches missed.">        return ((int) Math.ceil(getOriginalWalkMP() * 2.0)) - (hasMPReducingHardenedArmor() ? 1 : 0);</span>
    }

    /**
     * Returns this entity's Sprint mp as a string.
     */
    @Override
    public String getSprintMPasString() {
<span class="nc bnc" id="L1190" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L1191">            return getRunMPwithoutMASC() + &quot;(&quot; + getSprintMP() + &quot;)&quot;;</span>
        }
<span class="nc" id="L1193">        return Integer.toString(getSprintMP());</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getRunningGravityLimit()
     */
    @Override
    public int getRunningGravityLimit() {
<span class="nc bnc" id="L1203" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_SPRINT)) {</span>
<span class="nc" id="L1204">            return getSprintMP(false, false, false);</span>
        }
<span class="nc" id="L1206">        return getRunMP(false, false, false);</span>
    }

    /**
     * Depends on engine type
     */
    @Override
    public int getSprintHeat() {
<span class="nc bnc" id="L1214" title="All 2 branches missed.">        int extra = bDamagedCoolantSystem?1:0;</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">        return extra + (hasEngine() ? getEngine().getSprintHeat() : 0);</span>
    }

    /**
     * This mech's jumping MP modified for missing jump jets and gravity
     */
    @Override
    public int getJumpMP() {
<span class="nc" id="L1223">        return getJumpMP(true);</span>
    }

    /**
     * This mech's jumping MP modified for missing jump jets and possibly
     * gravity
     */
    @Override
    public int getJumpMP(boolean gravity) {
<span class="nc" id="L1232">        return getJumpMP(gravity, false);</span>
    }

    public int getJumpMP(boolean gravity, boolean ignoremodulararmor) {
<span class="nc" id="L1236">        int jump = 0;</span>

<span class="nc bnc" id="L1238" title="All 4 branches missed.">        if (hasShield() &amp;&amp; (getNumberOfShields(MiscType.S_SHIELD_LARGE) &gt; 0)) {</span>
<span class="nc" id="L1239">            return 0;</span>
        }

<span class="nc bnc" id="L1242" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_JUMP_JET)</span>
<span class="nc bnc" id="L1244" title="All 4 branches missed.">                    &amp;&amp; !mounted.isDestroyed() &amp;&amp; !mounted.isBreached()) {</span>
<span class="nc" id="L1245">                jump++;</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">            } else if (mounted.getType().hasFlag(MiscType.F_JUMP_BOOSTER)</span>
<span class="nc bnc" id="L1247" title="All 4 branches missed.">                    &amp;&amp; !mounted.isDestroyed() &amp;&amp; !mounted.isBreached()) {</span>
<span class="nc" id="L1248">                jump = getOriginalJumpMP();</span>
<span class="nc" id="L1249">                break;</span>
            }
<span class="nc" id="L1251">        }</span>

        // apply Partial Wing bonus if we have the ability to jump
<span class="nc bnc" id="L1254" title="All 2 branches missed.">        if (jump &gt; 0) {</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">            for (Mounted mount : getMisc()) {</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">                if (mount.getType().hasFlag(MiscType.F_PARTIAL_WING)) {</span>
<span class="nc" id="L1257">                    jump += getPartialWingJumpBonus(mount);</span>
<span class="nc" id="L1258">                    break;</span>
                }
<span class="nc" id="L1260">            }</span>
        }
        // Medium shield reduces jump mp by 1/shield
<span class="nc" id="L1263">        jump -= getNumberOfShields(MiscType.S_SHIELD_MEDIUM);</span>

<span class="nc bnc" id="L1265" title="All 4 branches missed.">        if (hasModularArmor() &amp;&amp; !ignoremodulararmor) {</span>
<span class="nc" id="L1266">            jump--;</span>
        }
        
<span class="nc bnc" id="L1269" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L1270">            return Math.max(applyGravityEffectsOnMP(jump), 0);</span>
        }
<span class="nc" id="L1272">        return Math.max(jump, 0);</span>
    }

    /**
     * Gives the bonus to Jump MP conferred by a mech partial wing.
     *
     * @param mount
     *            The mounted location of the Wing
     * @return The Jump MP bonus conferred by the wing
     */
    public int getPartialWingJumpBonus(Mounted mount) {
<span class="nc" id="L1283">        int bonus = 0;</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">        if (game != null) {</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">            if ((getWeightClass() &lt;= EntityWeightClass.WEIGHT_MEDIUM)) {</span>
<span class="nc bnc" id="L1286" title="All 7 branches missed.">                switch (game.getPlanetaryConditions().getAtmosphere()) {</span>
                    case PlanetaryConditions.ATMO_VACUUM:
<span class="nc" id="L1288">                        bonus = 0;</span>
<span class="nc" id="L1289">                        break;</span>
                    case PlanetaryConditions.ATMO_TRACE:
<span class="nc" id="L1291">                        bonus = 0;</span>
<span class="nc" id="L1292">                        break;</span>
                    case PlanetaryConditions.ATMO_THIN:
<span class="nc" id="L1294">                        bonus = 1;</span>
<span class="nc" id="L1295">                        break;</span>
                    case PlanetaryConditions.ATMO_STANDARD:
<span class="nc" id="L1297">                        bonus = 2;</span>
<span class="nc" id="L1298">                        break;</span>
                    case PlanetaryConditions.ATMO_HIGH:
<span class="nc" id="L1300">                        bonus = 2;</span>
<span class="nc" id="L1301">                        break;</span>

                    case PlanetaryConditions.ATMO_VHIGH:
<span class="nc" id="L1304">                        bonus = 3;</span>
<span class="nc" id="L1305">                        break;</span>
                    default:
<span class="nc" id="L1307">                        bonus = 2;</span>
                }
            } else {
<span class="nc bnc" id="L1310" title="All 7 branches missed.">                switch (game.getPlanetaryConditions().getAtmosphere()) {</span>
                    case PlanetaryConditions.ATMO_VACUUM:
<span class="nc" id="L1312">                        bonus = 0;</span>
<span class="nc" id="L1313">                        break;</span>
                    case PlanetaryConditions.ATMO_TRACE:
<span class="nc" id="L1315">                        bonus = 0;</span>
<span class="nc" id="L1316">                        break;</span>
                    case PlanetaryConditions.ATMO_THIN:
<span class="nc" id="L1318">                        bonus = 0;</span>
<span class="nc" id="L1319">                        break;</span>
                    case PlanetaryConditions.ATMO_STANDARD:
<span class="nc" id="L1321">                        bonus = 1;</span>
<span class="nc" id="L1322">                        break;</span>
                    case PlanetaryConditions.ATMO_HIGH:
<span class="nc" id="L1324">                        bonus = 2;</span>
<span class="nc" id="L1325">                        break;</span>
                    case PlanetaryConditions.ATMO_VHIGH:
<span class="nc" id="L1327">                        bonus = 2;</span>
<span class="nc" id="L1328">                        break;</span>
                    default:
<span class="nc" id="L1330">                        bonus = 1;</span>
                }
            }
        } else {
<span class="nc bnc" id="L1334" title="All 2 branches missed.">            if ((getWeightClass() &lt;= EntityWeightClass.WEIGHT_MEDIUM)) {</span>
<span class="nc" id="L1335">                bonus = 2;</span>
            } else {
<span class="nc" id="L1337">                bonus = 1;</span>
            }
        }

        // subtract jumping bonus for damaged criticals
<span class="nc" id="L1342">        bonus -= getBadCriticals(CriticalSlot.TYPE_EQUIPMENT,</span>
<span class="nc" id="L1343">                getEquipmentNum(mount), Mech.LOC_RT);</span>
<span class="nc" id="L1344">        bonus -= getBadCriticals(CriticalSlot.TYPE_EQUIPMENT,</span>
<span class="nc" id="L1345">                getEquipmentNum(mount), Mech.LOC_LT);</span>

<span class="nc bnc" id="L1347" title="All 2 branches missed.">        return bonus &gt; 0 ? bonus : 0;</span>
    }

    /**
     * Gives the heat capacity bonus conferred by a mech partial wing.
     *
     * @return the heat capacity bonus provided by the wing
     */
    private int getPartialWingHeatBonus() {
<span class="nc" id="L1356">        int bonus = 0;</span>
<span class="nc bnc" id="L1357" title="All 2 branches missed.">        if (game != null) {</span>
<span class="nc bnc" id="L1358" title="All 7 branches missed.">            switch (game.getPlanetaryConditions().getAtmosphere()) {</span>
                case PlanetaryConditions.ATMO_VACUUM:
<span class="nc" id="L1360">                    bonus = 0;</span>
<span class="nc" id="L1361">                    break;</span>
                case PlanetaryConditions.ATMO_TRACE:
<span class="nc" id="L1363">                    bonus = 1;</span>
<span class="nc" id="L1364">                    break;</span>
                case PlanetaryConditions.ATMO_THIN:
<span class="nc" id="L1366">                    bonus = 2;</span>
<span class="nc" id="L1367">                    break;</span>
                case PlanetaryConditions.ATMO_STANDARD:
<span class="nc" id="L1369">                    bonus = 3;</span>
<span class="nc" id="L1370">                    break;</span>
                case PlanetaryConditions.ATMO_HIGH:
<span class="nc" id="L1372">                    bonus = 3;</span>
<span class="nc" id="L1373">                    break;</span>
                case PlanetaryConditions.ATMO_VHIGH:
<span class="nc" id="L1375">                    bonus = 3;</span>
<span class="nc" id="L1376">                    break;</span>
                default:
<span class="nc" id="L1378">                    bonus = 3;</span>
            }
        } else {
<span class="nc" id="L1381">            bonus = 3;</span>
        }

<span class="nc" id="L1384">        return bonus;</span>
    }

    /**
     * Returns the type of jump jet system the mech has.
     */
    @Override
    public int getJumpType() {
<span class="nc" id="L1392">        jumpType = JUMP_NONE;</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">        for (Mounted m : miscList) {</span>
<span class="nc bnc" id="L1394" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_JUMP_JET)) {</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">                if (m.getType().hasSubType(MiscType.S_IMPROVED)</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">                        &amp;&amp; m.getType().hasSubType(MiscType.S_PROTOTYPE)) {</span>
<span class="nc" id="L1397">                    jumpType = JUMP_PROTOTYPE_IMPROVED;</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">                } else if (m.getType().hasSubType(MiscType.S_IMPROVED)) {</span>
<span class="nc" id="L1399">                    jumpType = JUMP_IMPROVED;</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">                } else if (m.getType().hasSubType(MiscType.S_PROTOTYPE)) {</span>
<span class="nc" id="L1401">                    jumpType = JUMP_PROTOTYPE;</span>
                } else {
<span class="nc" id="L1403">                    jumpType = JUMP_STANDARD;</span>
                }
<span class="nc" id="L1405">                break;</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_JUMP_BOOSTER)) {</span>
<span class="nc" id="L1407">                jumpType = JUMP_BOOSTER;</span>
<span class="nc" id="L1408">                break;</span>
            }
<span class="nc" id="L1410">        }</span>
<span class="nc" id="L1411">        return jumpType;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getJumpHeat(int)
     */
    @Override
    public int getJumpHeat(int movedMP) {

<span class="nc bnc" id="L1422" title="All 2 branches missed.">        int extra = bDamagedCoolantSystem?1:0;</span>

        // don't count movement granted by Partial Wing
<span class="nc bnc" id="L1425" title="All 2 branches missed.">        for (Mounted mount : getMisc()) {</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (mount.getType().hasFlag(MiscType.F_PARTIAL_WING)) {</span>
<span class="nc" id="L1427">                movedMP -= getPartialWingJumpBonus(mount);</span>
<span class="nc" id="L1428">                break;</span>
            }
<span class="nc" id="L1430">        }</span>

<span class="nc bnc" id="L1432" title="All 5 branches missed.">        switch (getJumpType()) {</span>
            case JUMP_IMPROVED:
<span class="nc bnc" id="L1434" title="All 2 branches missed.">                return extra + (hasEngine() ? getEngine().getJumpHeat((movedMP / 2) + (movedMP % 2)) : 0);</span>
            case JUMP_PROTOTYPE_IMPROVED:
                // min 6 heat, otherwise 2xJumpMp, XTRO:Succession Wars pg17
<span class="nc bnc" id="L1437" title="All 2 branches missed.">                return extra + (hasEngine() ? Math.max(6, getEngine().getJumpHeat(movedMP * 2)) : 0);</span>
            case JUMP_BOOSTER:
            case JUMP_DISPOSABLE:
<span class="nc" id="L1440">                return extra;</span>
            case JUMP_NONE:
<span class="nc" id="L1442">                return 0;</span>
            default:
<span class="nc bnc" id="L1444" title="All 2 branches missed.">                return extra + (hasEngine() ? getEngine().getJumpHeat(movedMP) : 0);</span>
        }
    }

    /**
     * Returns this mech's jumping MP, modified for missing &amp; underwater jets
     * and gravity.
     */
    @Override
    public int getJumpMPWithTerrain() {
<span class="nc bnc" id="L1454" title="All 6 branches missed.">        if ((getPosition() == null) || (game.getBoard().getHex(getPosition()) == null) || (getJumpType() == JUMP_BOOSTER)) {</span>
<span class="nc" id="L1455">            return getJumpMP();</span>
        }
<span class="nc" id="L1457">        int waterLevel = 0;</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">        if (!isOffBoard()) {</span>
<span class="nc" id="L1459">            waterLevel = game.getBoard().getHex(getPosition())</span>
<span class="nc" id="L1460">                    .terrainLevel(Terrains.WATER);</span>
        }
<span class="nc bnc" id="L1462" title="All 4 branches missed.">        if ((waterLevel &lt;= 0) || (getElevation() &gt;= 0)) {</span>
<span class="nc" id="L1463">            return getJumpMP();</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">        } else if (waterLevel &gt; 1) {</span>
<span class="nc" id="L1465">            return 0;</span>
        } else { // waterLevel == 1
<span class="nc" id="L1467">            return applyGravityEffectsOnMP(torsoJumpJets());</span>
        }
    }

    /**
     * Returns the number of (working) jump jets mounted in the torsos.
     */
    public int torsoJumpJets() {
<span class="nc" id="L1475">        int jump = 0;</span>

<span class="nc bnc" id="L1477" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_JUMP_JET)</span>
<span class="nc bnc" id="L1479" title="All 4 branches missed.">                    &amp;&amp; !mounted.isDestroyed() &amp;&amp; !mounted.isBreached()</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">                    &amp;&amp; locationIsTorso(mounted.getLocation())) {</span>
<span class="nc" id="L1481">                jump++;</span>
            }
<span class="nc" id="L1483">        }</span>

        // apply Partial Wing bonus if we have the ability to jump
<span class="nc bnc" id="L1486" title="All 2 branches missed.">        if (jump &gt; 0) {</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">            for (Mounted mount : getMisc()) {</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">                if (mount.getType().hasFlag(MiscType.F_PARTIAL_WING)) {</span>
<span class="nc" id="L1489">                    jump += getPartialWingJumpBonus(mount);</span>
<span class="nc" id="L1490">                    break;</span>
                }
<span class="nc" id="L1492">            }</span>
        }

<span class="nc" id="L1495">        return jump;</span>
    }

    @Override
    public boolean isEligibleForPavementBonus() {
        //eligible if using Mech tracks
<span class="nc bnc" id="L1501" title="All 2 branches missed.">        return movementMode == EntityMovementMode.TRACKED;</span>
    }

    @Override
    public EntityMovementMode nextConversionMode(EntityMovementMode afterMode) {
<span class="nc bnc" id="L1506" title="All 4 branches missed.">        if (hasTracks() &amp;&amp; afterMode != EntityMovementMode.TRACKED) {</span>
<span class="nc" id="L1507">            return EntityMovementMode.TRACKED;</span>
        } else {
<span class="nc" id="L1509">            return originalMovementMode;</span>
        }
    }

    /**
     * QuadVees and LAMs may not have to make PSRs to avoid falling depending on their mode,
     * and Mechs using tracks for movement do not have to make PSRs for damage to gyro or leg
     * actuators.
     *
     * @param gyroLegDamage Whether the PSR is due to damage to gyro or leg actuators
     * @return              true if the Mech can fall due to failed PSR.
     */
    @Override
    public boolean canFall(boolean gyroLegDamage) {
<span class="nc bnc" id="L1523" title="All 6 branches missed.">        return !isProne() &amp;&amp; !(gyroLegDamage &amp;&amp; movementMode == EntityMovementMode.TRACKED);</span>
    }

    /**
     * Return the height of this mech above the terrain.
     */
    @Override
    public int height() {
<span class="nc bnc" id="L1531" title="All 4 branches missed.">        return isProne() ? 0 : isSuperHeavy() ? 2 : 1;</span>
    }

    /**
     * Adds heat sinks to the engine. Uses clan/normal depending on the
     * currently set techLevel
     */
    public void addEngineSinks(int totalSinks, BigInteger heatSinkFlag) {
<span class="fc" id="L1539">        addEngineSinks(totalSinks, heatSinkFlag, isClan());</span>
<span class="fc" id="L1540">    }</span>

    /**
     * Adds heat sinks to the engine. Adds either the engine capacity, or the
     * entire number of heat sinks, whichever is less
     */
    public void addEngineSinks(int totalSinks, BigInteger heatSinkFlag,
            boolean clan) {
<span class="fc bfc" id="L1548" title="All 2 branches covered.">        if (heatSinkFlag == MiscType.F_DOUBLE_HEAT_SINK) {</span>
<span class="pc bpc" id="L1549" title="1 of 2 branches missed.">            addEngineSinks(totalSinks, clan ? EquipmentTypeLookup.CLAN_DOUBLE_HS</span>
<span class="fc" id="L1550">                    : EquipmentTypeLookup.IS_DOUBLE_HS);</span>
<span class="pc bpc" id="L1551" title="1 of 2 branches missed.">        } else if (heatSinkFlag == MiscType.F_COMPACT_HEAT_SINK) {</span>
<span class="nc" id="L1552">            addEngineSinks(totalSinks, EquipmentTypeLookup.COMPACT_HS_1);</span>
<span class="pc bpc" id="L1553" title="1 of 2 branches missed.">        } else if (heatSinkFlag == MiscType.F_LASER_HEAT_SINK) {</span>
<span class="nc" id="L1554">            addEngineSinks(totalSinks, EquipmentTypeLookup.LASER_HS);</span>
        } else {
<span class="fc" id="L1556">            addEngineSinks(totalSinks, EquipmentTypeLookup.SINGLE_HS);</span>
        }
<span class="fc" id="L1558">    }</span>

    /**
     * base for adding engine sinks. Newer method allows externals to say how
     * much are engine HS.
     *
     * @param totalSinks
     *            the amount of heatsinks to add to the engine
     * @param sinkName
     *            the &lt;code&gt;String&lt;/code&gt; determining the type of heatsink to
     *            add. must be a lookupname of a heatsinktype
     */
    public void addEngineSinks(int totalSinks, String sinkName) {
<span class="pc bpc" id="L1571" title="1 of 2 branches missed.">        if(!hasEngine()) {</span>
<span class="nc" id="L1572">            return;</span>
        }
<span class="fc" id="L1574">        EquipmentType sinkType = EquipmentType.get(sinkName);</span>

<span class="pc bpc" id="L1576" title="1 of 2 branches missed.">        if (sinkType == null) {</span>
<span class="nc" id="L1577">            System.out.println(&quot;Mech: can't find heat sink to add to engine&quot;);</span>
        }

<span class="fc" id="L1580">        int toAllocate = Math.min(</span>
                totalSinks,
<span class="fc" id="L1582">                getEngine().integralHeatSinkCapacity(</span>
<span class="fc" id="L1583">                        sinkType.hasFlag(MiscType.F_COMPACT_HEAT_SINK)));</span>
<span class="fc" id="L1584">        addEngineSinks(sinkName, toAllocate);</span>
<span class="fc" id="L1585">    }</span>

    /**
     * add heat sinks into the engine
     *
     * @param sinkName
     *            the &lt;code&gt;String&lt;/code&gt; determining the type of heatsink to
     *            add. must be a lookupname of a heatsinktype
     * @param toAllocate
     *            Number of hs to add to the Engine.
     */
    public void addEngineSinks(String sinkName, int toAllocate) {
        // this relies on these being the correct internalNames for these items
<span class="fc" id="L1598">        EquipmentType sinkType = EquipmentType.get(sinkName);</span>

<span class="pc bpc" id="L1600" title="1 of 2 branches missed.">        if (sinkType == null) {</span>
<span class="nc" id="L1601">            System.out.println(&quot;Mech: can't find heat sink to add to engine&quot;);</span>
        }

<span class="fc bfc" id="L1604" title="All 2 branches covered.">        for (int i = 0; i &lt; toAllocate; i++) {</span>
            try {
<span class="fc" id="L1606">                addEquipment(new Mounted(this, sinkType), Entity.LOC_NONE,</span>
                        false);
<span class="nc" id="L1608">            } catch (LocationFullException ex) {</span>
                // um, that's impossible.
<span class="fc" id="L1610">            }</span>
        }
<span class="fc" id="L1612">    }</span>

    /**
     * Returns extra heat generated by engine crits
     */
    @Override
    public int getEngineCritHeat() {
<span class="nc bnc" id="L1619" title="All 2 branches missed.">        if(!hasEngine()) {</span>
<span class="nc" id="L1620">            return 0;</span>
        }
<span class="nc" id="L1622">        int engineCritHeat = 0;</span>
<span class="nc bnc" id="L1623" title="All 4 branches missed.">        if (!isShutDown() &amp;&amp; getEngine().isFusion()) {</span>
<span class="nc" id="L1624">            engineCritHeat += 5 * getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.SYSTEM_ENGINE, Mech.LOC_CT);
<span class="nc" id="L1626">            engineCritHeat += 5 * getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.SYSTEM_ENGINE, Mech.LOC_LT);
<span class="nc" id="L1628">            engineCritHeat += 5 * getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.SYSTEM_ENGINE, Mech.LOC_RT);
        }
        // Partial Repairs of the engine cause additional heat
<span class="nc bnc" id="L1632" title="All 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;mech_reactor_3_crit&quot;)) {</span>
<span class="nc" id="L1633">            engineCritHeat += 8;</span>
        }
<span class="nc bnc" id="L1635" title="All 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;mech_reactor_2_crit&quot;)) {</span>
<span class="nc" id="L1636">            engineCritHeat += 5;</span>
        }
<span class="nc bnc" id="L1638" title="All 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;mech_reactor_1_crit&quot;)) {</span>
<span class="nc" id="L1639">            engineCritHeat += 3;</span>
        }
<span class="nc bnc" id="L1641" title="All 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;mech_engine_replace&quot;)) {</span>
<span class="nc" id="L1642">            engineCritHeat += 1;</span>
        }

        // add the partial repair heat here.
<span class="nc" id="L1646">        return engineCritHeat;</span>
    }

    /**
     * Returns the number of heat sinks, functional or not.
     */
    public int heatSinks() {
<span class="fc" id="L1653">        return heatSinks(true);</span>
    }

    /**
     * Returns the number of heat sinks, functional or not.
     *
     * @param countPrototypes
     *            Set TRUE to include Prototype Heat Sinks in the total.
     */
    public int heatSinks(boolean countPrototypes) {
<span class="fc" id="L1663">        int sinks = 0;</span>
<span class="fc bfc" id="L1664" title="All 2 branches covered.">        for (Mounted mounted : getMisc()) {</span>
<span class="fc" id="L1665">            EquipmentType etype = mounted.getType();</span>
<span class="pc bpc" id="L1666" title="1 of 2 branches missed.">            if (etype.hasFlag(MiscType.F_COMPACT_HEAT_SINK)</span>
<span class="nc bnc" id="L1667" title="All 2 branches missed.">                    &amp;&amp; (etype.hasFlag(MiscType.F_DOUBLE_HEAT_SINK) || (etype</span>
<span class="nc bnc" id="L1668" title="All 4 branches missed.">                            .hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE) &amp;&amp; countPrototypes))) {</span>
<span class="nc" id="L1669">                sinks += 2;</span>
<span class="fc bfc" id="L1670" title="All 2 branches covered.">            } else if (etype.hasFlag(MiscType.F_HEAT_SINK)</span>
<span class="fc bfc" id="L1671" title="All 2 branches covered.">                    || etype.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</span>
<span class="pc bpc" id="L1672" title="3 of 4 branches missed.">                    || (etype.hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE) &amp;&amp; countPrototypes)) {</span>
<span class="fc" id="L1673">                sinks++;</span>
            }
<span class="fc" id="L1675">        }</span>
<span class="fc" id="L1676">        return sinks;</span>
    }

    /**
     * Returns the number of destroyed heat sinks.
     */
    public int damagedHeatSinks() {
<span class="nc" id="L1683">        int sinks = 0;</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L1685">            EquipmentType etype = mounted.getType();</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">            if (!mounted.isDestroyed()) {</span>
<span class="nc" id="L1687">                continue;</span>
            }
<span class="nc bnc" id="L1689" title="All 2 branches missed.">            if (etype.hasFlag(MiscType.F_HEAT_SINK)</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {</span>
<span class="nc" id="L1692">                sinks++;</span>
            }
<span class="nc" id="L1694">        }</span>
<span class="nc" id="L1695">        return sinks;</span>
    }

    /**
     * Returns the about of heat that the entity can sink each turn.
     */
    @Override
    public int getHeatCapacity() {
<span class="nc" id="L1703">        return getHeatCapacity(true, true);</span>
    }

    @Override
    public int getHeatCapacity(boolean radicalHeatSink) {
<span class="nc" id="L1708">        return getHeatCapacity(true, radicalHeatSink);</span>
    }

    /**
     * Returns the name of the heat sinks mounted on this 'mech.
     *
     * @return
     */
    public String getHeatSinkTypeName() {
<span class="nc bnc" id="L1717" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
            // The MiscType name for compact heat sinks is formatted differently
<span class="nc bnc" id="L1719" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_COMPACT_HEAT_SINK)) {</span>
<span class="nc" id="L1720">                return &quot;Compact Heat Sink&quot;;</span>
            }
<span class="nc bnc" id="L1722" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_HEAT_SINK)</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_LASER_HEAT_SINK)) {</span>
<span class="nc" id="L1725">                return m.getName();</span>
            }
<span class="nc" id="L1727">        }</span>
        
        // if a mech has no heat sink equipment, we pretend like it has standard heat sinks.
<span class="nc" id="L1730">        return &quot;Heat Sink&quot;;</span>
    }

    public int getHeatCapacity(boolean includePartialWing,
            boolean includeRadicalHeatSink) {
<span class="nc" id="L1735">        int capacity = 0;</span>
<span class="nc" id="L1736">        int activeCount = getActiveSinks();</span>

<span class="nc bnc" id="L1738" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L1739" title="All 4 branches missed.">            if (mounted.isDestroyed() || mounted.isBreached()) {</span>
<span class="nc" id="L1740">                continue;</span>
            }
<span class="nc bnc" id="L1742" title="All 2 branches missed.">            if ((activeCount &gt; 0)</span>
<span class="nc bnc" id="L1743" title="All 2 branches missed.">                    &amp;&amp; mounted.getType().hasFlag(MiscType.F_HEAT_SINK)) {</span>
<span class="nc" id="L1744">                capacity++;</span>
<span class="nc" id="L1745">                activeCount--;</span>
<span class="nc bnc" id="L1746" title="All 2 branches missed.">            } else if ((activeCount &gt; 0)</span>
<span class="nc bnc" id="L1747" title="All 2 branches missed.">                    &amp;&amp; mounted.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)) {</span>
<span class="nc" id="L1748">                activeCount--;</span>
<span class="nc" id="L1749">                capacity += 2;</span>
<span class="nc bnc" id="L1750" title="All 2 branches missed.">            } else if (mounted.getType().hasFlag(</span>
                    MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {
<span class="nc" id="L1752">                capacity += 2;</span>
<span class="nc bnc" id="L1753" title="All 2 branches missed.">            } else if (includePartialWing</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">                    &amp;&amp; mounted.getType().hasFlag(MiscType.F_PARTIAL_WING)</span>
                    &amp;&amp; // unless
                       // all crits
                       // are
                       // destroyed,
                       // we get
                       // the bonus
<span class="nc bnc" id="L1761" title="All 2 branches missed.">                    ((getGoodCriticals(CriticalSlot.TYPE_EQUIPMENT,</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                            getEquipmentNum(mounted), Mech.LOC_RT) &gt; 0) || (getGoodCriticals(</span>
                            CriticalSlot.TYPE_EQUIPMENT,
<span class="nc" id="L1764">                            getEquipmentNum(mounted), Mech.LOC_LT) &gt; 0))) {</span>
<span class="nc" id="L1765">                capacity += getPartialWingHeatBonus();</span>
<span class="nc" id="L1766">                includePartialWing = false; // Only count the partial wing bonus</span>
                                            // once.
            }
<span class="nc" id="L1769">        }</span>
        // AirMech mode for LAMs confers the same heat benefits as a partial wing.
<span class="nc bnc" id="L1771" title="All 4 branches missed.">        if (includePartialWing &amp;&amp; movementMode == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L1772">            capacity += getPartialWingHeatBonus();</span>
        }
<span class="nc bnc" id="L1774" title="All 2 branches missed.">        if (includeRadicalHeatSink</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">                &amp;&amp; hasWorkingMisc(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L1776">            capacity += Math.ceil(getActiveSinks() * 0.4);</span>
        }

<span class="nc" id="L1779">        return capacity;</span>
    }

    /**
     * Returns the about of heat that the entity can sink each turn, factoring
     * for water.
     */
    @Override
    public int getHeatCapacityWithWater() {
<span class="nc bnc" id="L1788" title="All 2 branches missed.">        if (hasLaserHeatSinks()) {</span>
<span class="nc" id="L1789">            return getHeatCapacity(true, false);</span>
        }
<span class="nc" id="L1791">        return getHeatCapacity(true, false) + Math.min(sinksUnderwater(), 6);</span>
    }

    /**
     * Gets the number of heat sinks that are underwater.
     */
    private int sinksUnderwater() {
<span class="nc bnc" id="L1798" title="All 4 branches missed.">        if ((getPosition() == null) || isOffBoard()) {</span>
<span class="nc" id="L1799">            return 0;</span>
        }

<span class="nc" id="L1802">        IHex curHex = game.getBoard().getHex(getPosition());</span>
        // are we even in water? is it depth 1+
<span class="nc bnc" id="L1804" title="All 4 branches missed.">        if ((curHex.terrainLevel(Terrains.WATER) &lt;= 0) || (getElevation() &gt;= 0)) {</span>
<span class="nc" id="L1805">            return 0;</span>
        }

        // are we entirely underwater?
<span class="nc bnc" id="L1809" title="All 4 branches missed.">        if (isProne() || (curHex.terrainLevel(Terrains.WATER) &gt;= 2)) {</span>
<span class="nc" id="L1810">            return getHeatCapacity();</span>
        }

        // okay, count leg sinks
<span class="nc" id="L1814">        int sinksUnderwater = 0;</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L1816" title="All 4 branches missed.">            if (mounted.isDestroyed() || mounted.isBreached()</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">                    || !locationIsLeg(mounted.getLocation())) {</span>
<span class="nc" id="L1818">                continue;</span>
            }
<span class="nc bnc" id="L1820" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_HEAT_SINK)) {</span>
<span class="nc" id="L1821">                sinksUnderwater++;</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">            } else if (mounted.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)</span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">                    || mounted.getType().hasFlag(</span>
                            MiscType.F_IS_DOUBLE_HEAT_SINK_PROTOTYPE)) {
<span class="nc" id="L1825">                sinksUnderwater += 2;</span>
            }
<span class="nc" id="L1827">        }</span>
<span class="nc" id="L1828">        return sinksUnderwater;</span>
    }
    
    @Override
    public boolean tracksHeat() {
<span class="nc" id="L1833">        return true;</span>
    }

    /**
     * Returns the name of the type of movement used. This is mech-specific.
     */
    @Override
    public String getMovementString(EntityMovementType mtype) {
<span class="nc bnc" id="L1841" title="All 9 branches missed.">        switch (mtype) {</span>
            case MOVE_SKID:
<span class="nc" id="L1843">                return &quot;Skidded&quot;;</span>
            case MOVE_NONE:
            case MOVE_CAREFUL_STAND:
<span class="nc" id="L1846">                return &quot;None&quot;;</span>
            case MOVE_WALK:
<span class="nc" id="L1848">                return &quot;Walked&quot;;</span>
            case MOVE_RUN:
<span class="nc" id="L1850">                return &quot;Ran&quot;;</span>
            case MOVE_JUMP:
<span class="nc" id="L1852">                return &quot;Jumped&quot;;</span>
            case MOVE_SPRINT:
<span class="nc" id="L1854">                return &quot;Sprinted&quot;;</span>
            //LAM AirMech modes
            case MOVE_VTOL_WALK:
<span class="nc" id="L1857">                return &quot;Cruised&quot;;</span>
            case MOVE_VTOL_RUN:
<span class="nc" id="L1859">                return &quot;Flanked&quot;;</span>
            default:
<span class="nc" id="L1861">                return &quot;Unknown!&quot;;</span>
        }
    }

    /**
     * Returns the name of the type of movement used. This is mech-specific.
     */
    @Override
    public String getMovementAbbr(EntityMovementType mtype) {
<span class="nc bnc" id="L1870" title="All 9 branches missed.">        switch (mtype) {</span>
            case MOVE_SKID:
<span class="nc" id="L1872">                return &quot;S&quot;;</span>
            case MOVE_NONE:
<span class="nc" id="L1874">                return &quot;N&quot;;</span>
            case MOVE_WALK:
<span class="nc" id="L1876">                return &quot;W&quot;;</span>
            case MOVE_RUN:
<span class="nc" id="L1878">                return &quot;R&quot;;</span>
            case MOVE_JUMP:
<span class="nc" id="L1880">                return &quot;J&quot;;</span>
            case MOVE_SPRINT:
<span class="nc" id="L1882">                return &quot;Sp&quot;;</span>
            //LAM AirMech modes
            case MOVE_VTOL_WALK:
<span class="nc" id="L1885">                return &quot;C&quot;;</span>
            case MOVE_VTOL_RUN:
<span class="nc" id="L1887">                return &quot;F&quot;;</span>
            default:
<span class="nc" id="L1889">                return &quot;?&quot;;</span>
        }
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#canChangeSecondaryFacing()
     */
    @Override
    public boolean canChangeSecondaryFacing() {
<span class="nc bnc" id="L1900" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_NO_TWIST)) {</span>
<span class="nc" id="L1901">            return false;</span>
        }
<span class="nc bnc" id="L1903" title="All 2 branches missed.">        return !isProne();</span>
    }

    /**
     * Can this mech torso twist in the given direction?
     */
    @Override
    public boolean isValidSecondaryFacing(int dir) {
<span class="nc" id="L1911">        int rotate = dir - getFacing();</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">        if (canChangeSecondaryFacing()) {</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">            if (hasQuirk(OptionsConstants.QUIRK_POS_EXT_TWIST)) {</span>
<span class="nc bnc" id="L1914" title="All 18 branches missed.">                return (rotate == 0) || (rotate == 1) || (rotate == 2)</span>
                        || (rotate == -1) || (rotate == -2) || (rotate == -5)
                        || (rotate == -4) || (rotate == 5) || (rotate == 4);
            }
<span class="nc bnc" id="L1918" title="All 10 branches missed.">            return (rotate == 0) || (rotate == 1) || (rotate == -1)</span>
                    || (rotate == -5) || (rotate == 5);
        }
<span class="nc bnc" id="L1921" title="All 2 branches missed.">        return rotate == 0;</span>
    }

    /**
     * Return the nearest valid direction to torso twist in
     */
    @Override
    public int clipSecondaryFacing(int dir) {
<span class="nc bnc" id="L1929" title="All 2 branches missed.">        if (isValidSecondaryFacing(dir)) {</span>
<span class="nc" id="L1930">            return dir;</span>
        }
        // can't twist while prone
<span class="nc bnc" id="L1933" title="All 2 branches missed.">        if (!canChangeSecondaryFacing()) {</span>
<span class="nc" id="L1934">            return getFacing();</span>
        }
        // otherwise, twist once in the appropriate direction
<span class="nc" id="L1937">        final int rotate = (dir + (6 - getFacing())) % 6;</span>
<span class="nc bnc" id="L1938" title="All 4 branches missed.">        if ((rotate == 3) &amp;&amp; hasQuirk(OptionsConstants.QUIRK_POS_EXT_TWIST)) {</span>
            // if the unit can do an extended torso twist and the area chosen
            // was directly behind them, then just rotate one way
<span class="nc" id="L1941">            return (getFacing() + 2) % 6;</span>
        }
<span class="nc bnc" id="L1943" title="All 2 branches missed.">        return rotate &gt;= 3 ? (getFacing() + 5) % 6 : (getFacing() + 1) % 6;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#hasRearArmor(int)
     */
    @Override
    public boolean hasRearArmor(int loc) {
<span class="fc bfc" id="L1953" title="All 6 branches covered.">        return (loc == LOC_CT) || (loc == LOC_RT) || (loc == LOC_LT);</span>
    }

    /**
     * Returns the amount of armor in the location specified. Mech version,
     * handles rear armor.
     */
    @Override
    public int getArmor(int loc, boolean rear) {
<span class="pc bpc" id="L1962" title="1 of 2 branches missed.">        if (isLocationBlownOff(loc)) {</span>
<span class="nc" id="L1963">            return IArmorState.ARMOR_DESTROYED;</span>
        }
<span class="fc" id="L1965">        return getArmorForReal(loc, rear);</span>
    }

    @Override
    public int getArmorForReal(int loc, boolean rear) {
<span class="pc bpc" id="L1970" title="1 of 4 branches missed.">        if (rear &amp;&amp; hasRearArmor(loc)) {</span>
<span class="fc" id="L1971">            return rearArmor[loc];</span>
        }
<span class="fc" id="L1973">        return super.getArmorForReal(loc, rear);</span>
    }

    /**
     * Returns the original amount of armor in the location specified. Mech
     * version, handles rear armor.
     */
    @Override
    public int getOArmor(int loc, boolean rear) {
<span class="pc bpc" id="L1982" title="1 of 4 branches missed.">        if (rear &amp;&amp; hasRearArmor(loc)) {</span>
<span class="fc" id="L1983">            return orig_rearArmor[loc];</span>
        }
<span class="fc" id="L1985">        return super.getOArmor(loc, rear);</span>
    }

    /**
     * Sets the amount of armor in the location specified. Mech version, handles
     * rear armor.
     */
    @Override
    public void setArmor(int val, int loc, boolean rear) {
<span class="fc bfc" id="L1994" title="All 4 branches covered.">        if (rear &amp;&amp; hasRearArmor(loc)) {</span>
<span class="fc" id="L1995">            rearArmor[loc] = val;</span>
        } else {
<span class="fc" id="L1997">            super.setArmor(val, loc, rear);</span>
        }
<span class="fc" id="L1999">    }</span>

    /**
     * Initializes the rear armor on the mech. Sets the original and starting
     * point of the armor to the same number.
     */
    public void initializeRearArmor(int val, int loc) {
<span class="fc" id="L2006">        orig_rearArmor[loc] = val;</span>
<span class="fc" id="L2007">        setArmor(val, loc, true);</span>
<span class="fc" id="L2008">    }</span>

    @Override
    public void setHardenedArmorDamaged(HitData hit, boolean damaged) {
<span class="nc bnc" id="L2012" title="All 4 branches missed.">        if (hit.isRear() &amp;&amp; hasRearArmor(hit.getLocation())) {</span>
<span class="nc" id="L2013">            rearHardenedArmorDamaged[hit.getLocation()] = damaged;</span>
        } else {
<span class="nc" id="L2015">            hardenedArmorDamaged[hit.getLocation()] = damaged;</span>
        }
<span class="nc" id="L2017">    }</span>

    @Override
    public boolean isHardenedArmorDamaged(HitData hit) {
<span class="nc bnc" id="L2021" title="All 4 branches missed.">        if (hit.isRear() &amp;&amp; hasRearArmor(hit.getLocation())) {</span>
<span class="nc" id="L2022">            return rearHardenedArmorDamaged[hit.getLocation()];</span>
        } else {
<span class="nc" id="L2024">            return hardenedArmorDamaged[hit.getLocation()];</span>
        }
    }

    /**
     * did the armor in this location take damage which did not destroy it
     * at least once this turn?
     * this is used to decide whether to trigger Harjel II/III
     */
    public void setArmorDamagedThisTurn(int loc, boolean tookdamage) {
<span class="fc" id="L2034">        armorDamagedThisTurn[loc] = tookdamage;</span>
<span class="fc" id="L2035">    }</span>

    /**
     * did the armor in this location take damage which did not destroy it
     * at least once this turn?
     * this is used to decide whether to trigger Harjel II/III
     */
    public boolean isArmorDamagedThisTurn(int loc) {
<span class="nc" id="L2043">        return armorDamagedThisTurn[loc];</span>
    }

    /**
     * Returns the Compute.ARC that the weapon fires into.
     */
    @Override
    public int getWeaponArc(int wn) {
<span class="nc" id="L2051">        final Mounted mounted = getEquipment(wn);</span>

        // B-Pods need to be special-cased, the have 360 firing arc
<span class="nc bnc" id="L2054" title="All 2 branches missed.">        if ((mounted.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L2055" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L2056">            return Compute.ARC_360;</span>
        }
        // VGLs base arc on their facing
<span class="nc bnc" id="L2059" title="All 2 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L2060">            return Compute.firingArcFromVGLFacing(mounted.getFacing());</span>
        }
        // rear mounted?
<span class="nc bnc" id="L2063" title="All 2 branches missed.">        if (mounted.isRearMounted()) {</span>
<span class="nc" id="L2064">            return Compute.ARC_REAR;</span>
        }
        // front mounted
<span class="nc bnc" id="L2067" title="All 4 branches missed.">        switch (mounted.getLocation()) {</span>
            case LOC_HEAD:
            case LOC_CT:
            case LOC_RT:
            case LOC_LT:
            case LOC_RLEG:
            case LOC_LLEG:
<span class="nc" id="L2074">                return Compute.ARC_FORWARD;</span>
            case LOC_RARM:
<span class="nc bnc" id="L2076" title="All 2 branches missed.">                return getArmsFlipped() ? Compute.ARC_REAR</span>
<span class="nc" id="L2077">                        : Compute.ARC_RIGHTARM;</span>
            case LOC_LARM:
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                return getArmsFlipped() ? Compute.ARC_REAR</span>
<span class="nc" id="L2080">                        : Compute.ARC_LEFTARM;</span>
            default:
<span class="nc" id="L2082">                return Compute.ARC_360;</span>
        }
    }

    /**
     * Returns true if this weapon fires into the secondary facing arc. If
     * false, assume it fires into the primary.
     */
    @Override
    public boolean isSecondaryArcWeapon(int weaponId) {
        // leg-mounted weapons fire into the primary arc, always
<span class="nc bnc" id="L2093" title="All 2 branches missed.">        if ((getEquipment(weaponId).getLocation() == LOC_RLEG)</span>
<span class="nc bnc" id="L2094" title="All 2 branches missed.">                || (getEquipment(weaponId).getLocation() == LOC_LLEG)) {</span>
<span class="nc" id="L2095">            return false;</span>
        }
        // other weapons into the secondary
<span class="nc" id="L2098">        return true;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#rollHitLocation(int, int)
     */
    @Override
    public HitData rollHitLocation(int table, int side) {
<span class="nc" id="L2108">        return rollHitLocation(table, side, LOC_NONE,</span>
                IAimingModes.AIM_MODE_NONE, LosEffects.COVER_NONE);
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#rollHitLocation(int, int, int, int)
     */
    @Override
    public HitData rollHitLocation(int table, int side, int aimedLocation,
            int aimingMode, int cover) {
<span class="nc" id="L2120">        int roll = -1;</span>

<span class="nc bnc" id="L2122" title="All 4 branches missed.">        if ((aimedLocation != LOC_NONE)</span>
                &amp;&amp; (aimingMode != IAimingModes.AIM_MODE_NONE)) {

<span class="nc" id="L2125">            roll = Compute.d6(2);</span>

<span class="nc bnc" id="L2127" title="All 4 branches missed.">            if ((5 &lt; roll) &amp;&amp; (roll &lt; 9)) {</span>
<span class="nc bnc" id="L2128" title="All 2 branches missed.">                return new HitData(aimedLocation, side == ToHitData.SIDE_REAR,</span>
                        true);
            }
        }

<span class="nc bnc" id="L2133" title="All 4 branches missed.">        if ((table == ToHitData.HIT_NORMAL)</span>
                || (table == ToHitData.HIT_PARTIAL_COVER)) {
<span class="nc" id="L2135">            roll = Compute.d6(2);</span>
            try {
<span class="nc" id="L2137">                PrintWriter pw = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L2138">                        .getMekHitLocLog();</span>
<span class="nc bnc" id="L2139" title="All 2 branches missed.">                if (pw != null) {</span>
<span class="nc" id="L2140">                    pw.print(table);</span>
<span class="nc" id="L2141">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2142">                    pw.print(side);</span>
<span class="nc" id="L2143">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2144">                    pw.println(roll);</span>
                }
<span class="nc" id="L2146">            } catch (Throwable thrown) {</span>
<span class="nc" id="L2147">                thrown.printStackTrace();</span>
<span class="nc" id="L2148">            }</span>
<span class="nc bnc" id="L2149" title="All 2 branches missed.">            if (side == ToHitData.SIDE_FRONT) {</span>
                // normal front hits
<span class="nc bnc" id="L2151" title="All 10 branches missed.">                switch (roll) {</span>
                    case 2:
<span class="nc bnc" id="L2153" title="All 2 branches missed.">                        if ((getCrew().hasEdgeRemaining() &amp;&amp; getCrew()</span>
<span class="nc bnc" id="L2154" title="All 2 branches missed.">                                .getOptions().booleanOption(OptionsConstants.EDGE_WHEN_TAC))</span>
<span class="nc bnc" id="L2155" title="All 2 branches missed.">                                &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_NO_TAC)) {</span>
<span class="nc" id="L2156">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2157">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2159">                            result.setUndoneLocation(tac(table, side,</span>
                                    Mech.LOC_CT, cover, false));
<span class="nc" id="L2161">                            return result;</span>
                        } // if
<span class="nc" id="L2163">                        return tac(table, side, Mech.LOC_CT, cover, false);</span>
                    case 3:
                    case 4:
<span class="nc" id="L2166">                        return new HitData(Mech.LOC_RARM);</span>
                    case 5:
<span class="nc" id="L2168">                        return new HitData(Mech.LOC_RLEG);</span>
                    case 6:
<span class="nc" id="L2170">                        return new HitData(Mech.LOC_RT);</span>
                    case 7:
<span class="nc" id="L2172">                        return new HitData(Mech.LOC_CT);</span>
                    case 8:
<span class="nc" id="L2174">                        return new HitData(Mech.LOC_LT);</span>
                    case 9:
<span class="nc" id="L2176">                        return new HitData(Mech.LOC_LLEG);</span>
                    case 10:
                    case 11:
<span class="nc" id="L2179">                        return new HitData(Mech.LOC_LARM);</span>
                    case 12:
<span class="nc bnc" id="L2181" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2182" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2184">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2185">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2187">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD));</span>
<span class="nc" id="L2188">                            return result;</span>
                        } // if
<span class="nc" id="L2190">                        return new HitData(Mech.LOC_HEAD);</span>
                }
<span class="nc bnc" id="L2192" title="All 2 branches missed.">            } else if (side == ToHitData.SIDE_LEFT) {</span>
                // normal left side hits
<span class="nc bnc" id="L2194" title="All 11 branches missed.">                switch (roll) {</span>
                    case 2:
<span class="nc bnc" id="L2196" title="All 2 branches missed.">                        if ((getCrew().hasEdgeRemaining() &amp;&amp; getCrew()</span>
<span class="nc bnc" id="L2197" title="All 2 branches missed.">                                .getOptions().booleanOption(OptionsConstants.EDGE_WHEN_TAC))</span>
<span class="nc bnc" id="L2198" title="All 2 branches missed.">                                &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_NO_TAC)) {</span>
<span class="nc" id="L2199">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2200">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2202">                            result.setUndoneLocation(tac(table, side,</span>
                                    Mech.LOC_LT, cover, false));
<span class="nc" id="L2204">                            return result;</span>
                        } // if
<span class="nc" id="L2206">                        return tac(table, side, Mech.LOC_LT, cover, false);</span>
                    case 3:
<span class="nc" id="L2208">                        return new HitData(Mech.LOC_LLEG);</span>
                    case 4:
                    case 5:
<span class="nc" id="L2211">                        return new HitData(Mech.LOC_LARM);</span>
                    case 6:
<span class="nc" id="L2213">                        return new HitData(Mech.LOC_LLEG);</span>
                    case 7:
<span class="nc" id="L2215">                        return new HitData(Mech.LOC_LT);</span>
                    case 8:
<span class="nc bnc" id="L2217" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_TACOPS_ADVANCED_MECH_HIT_LOCATIONS)) {
<span class="nc" id="L2219">                            return new HitData(Mech.LOC_CT, true);</span>
                        }
<span class="nc" id="L2221">                        return new HitData(Mech.LOC_CT);</span>
                    case 9:
<span class="nc bnc" id="L2223" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_TACOPS_ADVANCED_MECH_HIT_LOCATIONS)) {
<span class="nc" id="L2225">                            return new HitData(Mech.LOC_RT, true);</span>
                        }
<span class="nc" id="L2227">                        return new HitData(Mech.LOC_RT);</span>
                    case 10:
<span class="nc" id="L2229">                        return new HitData(Mech.LOC_RARM);</span>
                    case 11:
<span class="nc" id="L2231">                        return new HitData(Mech.LOC_RLEG);</span>
                    case 12:
<span class="nc bnc" id="L2233" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2236">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2237">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2239">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD));</span>
<span class="nc" id="L2240">                            return result;</span>
                        } // if
<span class="nc" id="L2242">                        return new HitData(Mech.LOC_HEAD);</span>
                }
<span class="nc bnc" id="L2244" title="All 2 branches missed.">            } else if (side == ToHitData.SIDE_RIGHT) {</span>
                // normal right side hits
<span class="nc bnc" id="L2246" title="All 11 branches missed.">                switch (roll) {</span>
                    case 2:
<span class="nc bnc" id="L2248" title="All 2 branches missed.">                        if ((getCrew().hasEdgeRemaining() &amp;&amp; getCrew()</span>
<span class="nc bnc" id="L2249" title="All 2 branches missed.">                                .getOptions().booleanOption(OptionsConstants.EDGE_WHEN_TAC))</span>
<span class="nc bnc" id="L2250" title="All 2 branches missed.">                                &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_NO_TAC)) {</span>
<span class="nc" id="L2251">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2252">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2254">                            result.setUndoneLocation(tac(table, side,</span>
                                    Mech.LOC_RT, cover, false));
<span class="nc" id="L2256">                            return result;</span>
                        } // if
<span class="nc" id="L2258">                        return tac(table, side, Mech.LOC_RT, cover, false);</span>
                    case 3:
<span class="nc" id="L2260">                        return new HitData(Mech.LOC_RLEG);</span>
                    case 4:
                    case 5:
<span class="nc" id="L2263">                        return new HitData(Mech.LOC_RARM);</span>
                    case 6:
<span class="nc" id="L2265">                        return new HitData(Mech.LOC_RLEG);</span>
                    case 7:
<span class="nc" id="L2267">                        return new HitData(Mech.LOC_RT);</span>
                    case 8:
<span class="nc bnc" id="L2269" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_TACOPS_ADVANCED_MECH_HIT_LOCATIONS)) {
<span class="nc" id="L2271">                            return new HitData(Mech.LOC_CT, true);</span>
                        }
<span class="nc" id="L2273">                        return new HitData(Mech.LOC_CT);</span>
                    case 9:
<span class="nc bnc" id="L2275" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_TACOPS_ADVANCED_MECH_HIT_LOCATIONS)) {
<span class="nc" id="L2277">                            return new HitData(Mech.LOC_LT, true);</span>
                        }
<span class="nc" id="L2279">                        return new HitData(Mech.LOC_LT);</span>
                    case 10:
<span class="nc" id="L2281">                        return new HitData(Mech.LOC_LARM);</span>
                    case 11:
<span class="nc" id="L2283">                        return new HitData(Mech.LOC_LLEG);</span>
                    case 12:
<span class="nc bnc" id="L2285" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2286" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2288">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2289">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2291">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD));</span>
<span class="nc" id="L2292">                            return result;</span>
                        } // if
<span class="nc" id="L2294">                        return new HitData(Mech.LOC_HEAD);</span>
                }
<span class="nc bnc" id="L2296" title="All 2 branches missed.">            } else if (side == ToHitData.SIDE_REAR) {</span>
                // normal rear hits
<span class="nc bnc" id="L2298" title="All 2 branches missed.">                if (game.getOptions().booleanOption(</span>
                        OptionsConstants.ADVCOMBAT_TACOPS_ADVANCED_MECH_HIT_LOCATIONS)
<span class="nc bnc" id="L2300" title="All 2 branches missed.">                        &amp;&amp; isProne()) {</span>
<span class="nc bnc" id="L2301" title="All 10 branches missed.">                    switch (roll) {</span>
                        case 2:
<span class="nc bnc" id="L2303" title="All 2 branches missed.">                            if ((getCrew().hasEdgeRemaining() &amp;&amp; getCrew()</span>
<span class="nc" id="L2304">                                    .getOptions()</span>
<span class="nc bnc" id="L2305" title="All 2 branches missed.">                                    .booleanOption(OptionsConstants.EDGE_WHEN_TAC))</span>
<span class="nc bnc" id="L2306" title="All 2 branches missed.">                                    &amp;&amp; !game.getOptions().booleanOption(</span>
                                            OptionsConstants.ADVCOMBAT_NO_TAC)) {
<span class="nc" id="L2308">                                getCrew().decreaseEdge();</span>
<span class="nc" id="L2309">                                HitData result = rollHitLocation(table, side,</span>
                                        aimedLocation, aimingMode, cover);
<span class="nc" id="L2311">                                result.setUndoneLocation(tac(table, side,</span>
                                        Mech.LOC_CT, cover, true));
<span class="nc" id="L2313">                                return result;</span>
                            } // if
<span class="nc" id="L2315">                            return tac(table, side, Mech.LOC_CT, cover, true);</span>
                        case 3:
<span class="nc" id="L2317">                            return new HitData(Mech.LOC_RARM, true);</span>
                        case 4:
                        case 5:
<span class="nc" id="L2320">                            return new HitData(Mech.LOC_RLEG, true);</span>
                        case 6:
<span class="nc" id="L2322">                            return new HitData(Mech.LOC_RT, true);</span>
                        case 7:
<span class="nc" id="L2324">                            return new HitData(Mech.LOC_CT, true);</span>
                        case 8:
<span class="nc" id="L2326">                            return new HitData(Mech.LOC_LT, true);</span>
                        case 9:
                        case 10:
<span class="nc" id="L2329">                            return new HitData(Mech.LOC_LLEG, true);</span>
                        case 11:
<span class="nc" id="L2331">                            return new HitData(Mech.LOC_LARM, true);</span>
                        case 12:
<span class="nc bnc" id="L2333" title="All 2 branches missed.">                            if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2334" title="All 2 branches missed.">                                    &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                            OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2336">                                getCrew().decreaseEdge();</span>
<span class="nc" id="L2337">                                HitData result = rollHitLocation(table, side,</span>
                                        aimedLocation, aimingMode, cover);
<span class="nc" id="L2339">                                result.setUndoneLocation(new HitData(</span>
                                        Mech.LOC_HEAD, true));
<span class="nc" id="L2341">                                return result;</span>
                            } // if
<span class="nc" id="L2343">                            return new HitData(Mech.LOC_HEAD, true);</span>
                    }
                } else {
<span class="nc bnc" id="L2346" title="All 10 branches missed.">                    switch (roll) {</span>
                        case 2:
<span class="nc bnc" id="L2348" title="All 2 branches missed.">                            if ((getCrew().hasEdgeRemaining() &amp;&amp; getCrew()</span>
<span class="nc" id="L2349">                                    .getOptions()</span>
<span class="nc bnc" id="L2350" title="All 2 branches missed.">                                    .booleanOption(OptionsConstants.EDGE_WHEN_TAC))</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">                                    &amp;&amp; !game.getOptions().booleanOption(</span>
                                            OptionsConstants.ADVCOMBAT_NO_TAC)) {
<span class="nc" id="L2353">                                getCrew().decreaseEdge();</span>
<span class="nc" id="L2354">                                HitData result = rollHitLocation(table, side,</span>
                                        aimedLocation, aimingMode, cover);
<span class="nc" id="L2356">                                result.setUndoneLocation(tac(table, side,</span>
                                        Mech.LOC_CT, cover, true));
<span class="nc" id="L2358">                                return result;</span>
                            } // if
<span class="nc" id="L2360">                            return tac(table, side, Mech.LOC_CT, cover, true);</span>
                        case 3:
                        case 4:
<span class="nc" id="L2363">                            return new HitData(Mech.LOC_RARM, true);</span>
                        case 5:
<span class="nc" id="L2365">                            return new HitData(Mech.LOC_RLEG, true);</span>
                        case 6:
<span class="nc" id="L2367">                            return new HitData(Mech.LOC_RT, true);</span>
                        case 7:
<span class="nc" id="L2369">                            return new HitData(Mech.LOC_CT, true);</span>
                        case 8:
<span class="nc" id="L2371">                            return new HitData(Mech.LOC_LT, true);</span>
                        case 9:
<span class="nc" id="L2373">                            return new HitData(Mech.LOC_LLEG, true);</span>
                        case 10:
                        case 11:
<span class="nc" id="L2376">                            return new HitData(Mech.LOC_LARM, true);</span>
                        case 12:
<span class="nc bnc" id="L2378" title="All 2 branches missed.">                            if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2379" title="All 2 branches missed.">                                    &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                            OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2381">                                getCrew().decreaseEdge();</span>
<span class="nc" id="L2382">                                HitData result = rollHitLocation(table, side,</span>
                                        aimedLocation, aimingMode, cover);
<span class="nc" id="L2384">                                result.setUndoneLocation(new HitData(</span>
                                        Mech.LOC_HEAD, true));
<span class="nc" id="L2386">                                return result;</span>
                            } // if
<span class="nc" id="L2388">                            return new HitData(Mech.LOC_HEAD, true);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L2393" title="All 2 branches missed.">        if (table == ToHitData.HIT_PUNCH) {</span>
<span class="nc" id="L2394">            roll = Compute.d6(1);</span>
            try {
<span class="nc" id="L2396">                PrintWriter pw = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L2397">                        .getMekHitLocLog();</span>
<span class="nc bnc" id="L2398" title="All 2 branches missed.">                if (pw != null) {</span>
<span class="nc" id="L2399">                    pw.print(table);</span>
<span class="nc" id="L2400">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2401">                    pw.print(side);</span>
<span class="nc" id="L2402">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2403">                    pw.println(roll);</span>
                }
<span class="nc" id="L2405">            } catch (Throwable thrown) {</span>
<span class="nc" id="L2406">                thrown.printStackTrace();</span>
<span class="nc" id="L2407">            }</span>
<span class="nc bnc" id="L2408" title="All 2 branches missed.">            if (side == ToHitData.SIDE_FRONT) {</span>
                // front punch hits
<span class="nc bnc" id="L2410" title="All 7 branches missed.">                switch (roll) {</span>
                    case 1:
<span class="nc" id="L2412">                        return new HitData(Mech.LOC_LARM);</span>
                    case 2:
<span class="nc" id="L2414">                        return new HitData(Mech.LOC_LT);</span>
                    case 3:
<span class="nc" id="L2416">                        return new HitData(Mech.LOC_CT);</span>
                    case 4:
<span class="nc" id="L2418">                        return new HitData(Mech.LOC_RT);</span>
                    case 5:
<span class="nc" id="L2420">                        return new HitData(Mech.LOC_RARM);</span>
                    case 6:
<span class="nc bnc" id="L2422" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2425">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2426">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2428">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD));</span>
<span class="nc" id="L2429">                            return result;</span>
                        } // if
<span class="nc" id="L2431">                        return new HitData(Mech.LOC_HEAD);</span>
                }
            }
<span class="nc bnc" id="L2434" title="All 2 branches missed.">            if (side == ToHitData.SIDE_LEFT) {</span>
                // left side punch hits
<span class="nc bnc" id="L2436" title="All 5 branches missed.">                switch (roll) {</span>
                    case 1:
                    case 2:
<span class="nc" id="L2439">                        return new HitData(Mech.LOC_LT);</span>
                    case 3:
<span class="nc" id="L2441">                        return new HitData(Mech.LOC_CT);</span>
                    case 4:
                    case 5:
<span class="nc" id="L2444">                        return new HitData(Mech.LOC_LARM);</span>
                    case 6:
<span class="nc bnc" id="L2446" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2447" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2449">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2450">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2452">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD));</span>
<span class="nc" id="L2453">                            return result;</span>
                        } // if
<span class="nc" id="L2455">                        return new HitData(Mech.LOC_HEAD);</span>
                }
            }
<span class="nc bnc" id="L2458" title="All 2 branches missed.">            if (side == ToHitData.SIDE_RIGHT) {</span>
                // right side punch hits
<span class="nc bnc" id="L2460" title="All 5 branches missed.">                switch (roll) {</span>
                    case 1:
                    case 2:
<span class="nc" id="L2463">                        return new HitData(Mech.LOC_RT);</span>
                    case 3:
<span class="nc" id="L2465">                        return new HitData(Mech.LOC_CT);</span>
                    case 4:
                    case 5:
<span class="nc" id="L2468">                        return new HitData(Mech.LOC_RARM);</span>
                    case 6:
<span class="nc bnc" id="L2470" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2471" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2473">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2474">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2476">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD));</span>
<span class="nc" id="L2477">                            return result;</span>
                        } // if
<span class="nc" id="L2479">                        return new HitData(Mech.LOC_HEAD);</span>
                }
            }
<span class="nc bnc" id="L2482" title="All 2 branches missed.">            if (side == ToHitData.SIDE_REAR) {</span>
                // rear punch hits
<span class="nc bnc" id="L2484" title="All 7 branches missed.">                switch (roll) {</span>
                    case 1:
<span class="nc" id="L2486">                        return new HitData(Mech.LOC_LARM, true);</span>
                    case 2:
<span class="nc" id="L2488">                        return new HitData(Mech.LOC_LT, true);</span>
                    case 3:
<span class="nc" id="L2490">                        return new HitData(Mech.LOC_CT, true);</span>
                    case 4:
<span class="nc" id="L2492">                        return new HitData(Mech.LOC_RT, true);</span>
                    case 5:
<span class="nc" id="L2494">                        return new HitData(Mech.LOC_RARM, true);</span>
                    case 6:
<span class="nc bnc" id="L2496" title="All 2 branches missed.">                        if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2497" title="All 2 branches missed.">                                &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                        OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2499">                            getCrew().decreaseEdge();</span>
<span class="nc" id="L2500">                            HitData result = rollHitLocation(table, side,</span>
                                    aimedLocation, aimingMode, cover);
<span class="nc" id="L2502">                            result.setUndoneLocation(new HitData(Mech.LOC_HEAD,</span>
                                    true));
<span class="nc" id="L2504">                            return result;</span>
                        } // if
<span class="nc" id="L2506">                        return new HitData(Mech.LOC_HEAD, true);</span>
                }
            }
        }
<span class="nc bnc" id="L2510" title="All 2 branches missed.">        if (table == ToHitData.HIT_KICK) {</span>
<span class="nc" id="L2511">            roll = Compute.d6(1);</span>
            try {
<span class="nc" id="L2513">                PrintWriter pw = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L2514">                        .getMekHitLocLog();</span>
<span class="nc bnc" id="L2515" title="All 2 branches missed.">                if (pw != null) {</span>
<span class="nc" id="L2516">                    pw.print(table);</span>
<span class="nc" id="L2517">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2518">                    pw.print(side);</span>
<span class="nc" id="L2519">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2520">                    pw.println(roll);</span>
                }
<span class="nc" id="L2522">            } catch (Throwable thrown) {</span>
<span class="nc" id="L2523">                thrown.printStackTrace();</span>
<span class="nc" id="L2524">            }</span>
<span class="nc bnc" id="L2525" title="All 4 branches missed.">            if ((side == ToHitData.SIDE_FRONT) || (side == ToHitData.SIDE_REAR)) {</span>
                // front/rear kick hits
<span class="nc bnc" id="L2527" title="All 3 branches missed.">                switch (roll) {</span>
                    case 1:
                    case 2:
                    case 3:
<span class="nc bnc" id="L2531" title="All 2 branches missed.">                        return new HitData(Mech.LOC_RLEG,</span>
                                (side == ToHitData.SIDE_REAR));
                    case 4:
                    case 5:
                    case 6:
<span class="nc bnc" id="L2536" title="All 2 branches missed.">                        return new HitData(Mech.LOC_LLEG,</span>
                                (side == ToHitData.SIDE_REAR));
                }
            }
<span class="nc bnc" id="L2540" title="All 2 branches missed.">            if (side == ToHitData.SIDE_LEFT) {</span>
                // left side kick hits
<span class="nc" id="L2542">                return new HitData(Mech.LOC_LLEG);</span>
            }
<span class="nc bnc" id="L2544" title="All 2 branches missed.">            if (side == ToHitData.SIDE_RIGHT) {</span>
                // right side kick hits
<span class="nc" id="L2546">                return new HitData(Mech.LOC_RLEG);</span>
            }
        }
<span class="nc bnc" id="L2549" title="All 4 branches missed.">        if ((table == ToHitData.HIT_SWARM)</span>
                || (table == ToHitData.HIT_SWARM_CONVENTIONAL)) {
<span class="nc" id="L2551">            roll = Compute.d6(2);</span>
            int effects;
<span class="nc bnc" id="L2553" title="All 2 branches missed.">            if (table == ToHitData.HIT_SWARM_CONVENTIONAL) {</span>
<span class="nc" id="L2554">                effects = HitData.EFFECT_NONE;</span>
            } else {
<span class="nc" id="L2556">                effects = HitData.EFFECT_CRITICAL;</span>
            }
            try {
<span class="nc" id="L2559">                PrintWriter pw = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L2560">                        .getMekHitLocLog();</span>
<span class="nc bnc" id="L2561" title="All 2 branches missed.">                if (pw != null) {</span>
<span class="nc" id="L2562">                    pw.print(table);</span>
<span class="nc" id="L2563">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2564">                    pw.print(side);</span>
<span class="nc" id="L2565">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2566">                    pw.println(roll);</span>
                }
<span class="nc" id="L2568">            } catch (Throwable thrown) {</span>
<span class="nc" id="L2569">                thrown.printStackTrace();</span>
<span class="nc" id="L2570">            }</span>
            // Swarm attack locations.
<span class="nc bnc" id="L2572" title="All 12 branches missed.">            switch (roll) {</span>
                case 2:
<span class="nc bnc" id="L2574" title="All 2 branches missed.">                    if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                            &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                    OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2577">                        getCrew().decreaseEdge();</span>
<span class="nc" id="L2578">                        HitData result = rollHitLocation(table, side,</span>
                                aimedLocation, aimingMode, cover);
<span class="nc" id="L2580">                        result.setUndoneLocation(new HitData(Mech.LOC_HEAD,</span>
                                false, effects));
<span class="nc" id="L2582">                        return result;</span>
                    } // if
<span class="nc" id="L2584">                    return new HitData(Mech.LOC_HEAD, false, effects);</span>
                case 3:
<span class="nc" id="L2586">                    return new HitData(Mech.LOC_CT, true, effects);</span>
                case 4:
<span class="nc" id="L2588">                    return new HitData(Mech.LOC_RT, true, effects);</span>
                case 5:
<span class="nc" id="L2590">                    return new HitData(Mech.LOC_RT, false, effects);</span>
                case 6:
<span class="nc" id="L2592">                    return new HitData(Mech.LOC_RARM, false, effects);</span>
                case 7:
<span class="nc" id="L2594">                    return new HitData(Mech.LOC_CT, false, effects);</span>
                case 8:
<span class="nc" id="L2596">                    return new HitData(Mech.LOC_LARM, false, effects);</span>
                case 9:
<span class="nc" id="L2598">                    return new HitData(Mech.LOC_LT, false, effects);</span>
                case 10:
<span class="nc" id="L2600">                    return new HitData(Mech.LOC_LT, true, effects);</span>
                case 11:
<span class="nc" id="L2602">                    return new HitData(Mech.LOC_CT, true, effects);</span>
                case 12:
<span class="nc bnc" id="L2604" title="All 2 branches missed.">                    if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2605" title="All 2 branches missed.">                            &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                    OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2607">                        getCrew().decreaseEdge();</span>
<span class="nc" id="L2608">                        HitData result = rollHitLocation(table, side,</span>
                                aimedLocation, aimingMode, cover);
<span class="nc" id="L2610">                        result.setUndoneLocation(new HitData(Mech.LOC_HEAD,</span>
                                false, effects));
<span class="nc" id="L2612">                        return result;</span>
                    } // if
<span class="nc" id="L2614">                    return new HitData(Mech.LOC_HEAD, false, effects);</span>
            }
        }
<span class="nc bnc" id="L2617" title="All 2 branches missed.">        if (table == ToHitData.HIT_ABOVE) {</span>
<span class="nc" id="L2618">            roll = Compute.d6(1);</span>
            try {
<span class="nc" id="L2620">                PrintWriter pw = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L2621">                        .getMekHitLocLog();</span>
<span class="nc bnc" id="L2622" title="All 2 branches missed.">                if (pw != null) {</span>
<span class="nc" id="L2623">                    pw.print(table);</span>
<span class="nc" id="L2624">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2625">                    pw.print(side);</span>
<span class="nc" id="L2626">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2627">                    pw.println(roll);</span>
                }
<span class="nc" id="L2629">            } catch (Throwable thrown) {</span>
<span class="nc" id="L2630">                thrown.printStackTrace();</span>
<span class="nc" id="L2631">            }</span>
            // Hits from above.
<span class="nc bnc" id="L2633" title="All 7 branches missed.">            switch (roll) {</span>
                case 1:
<span class="nc bnc" id="L2635" title="All 2 branches missed.">                    return new HitData(Mech.LOC_LARM,</span>
                            (side == ToHitData.SIDE_REAR));
                case 2:
<span class="nc bnc" id="L2638" title="All 2 branches missed.">                    return new HitData(Mech.LOC_LT,</span>
                            (side == ToHitData.SIDE_REAR));
                case 3:
<span class="nc bnc" id="L2641" title="All 2 branches missed.">                    return new HitData(Mech.LOC_CT,</span>
                            (side == ToHitData.SIDE_REAR));
                case 4:
<span class="nc bnc" id="L2644" title="All 2 branches missed.">                    return new HitData(Mech.LOC_RT,</span>
                            (side == ToHitData.SIDE_REAR));
                case 5:
<span class="nc bnc" id="L2647" title="All 2 branches missed.">                    return new HitData(Mech.LOC_RARM,</span>
                            (side == ToHitData.SIDE_REAR));
                case 6:
<span class="nc bnc" id="L2650" title="All 2 branches missed.">                    if (getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L2651" title="All 2 branches missed.">                            &amp;&amp; getCrew().getOptions().booleanOption(</span>
                                    OptionsConstants.EDGE_WHEN_HEADHIT)) {
<span class="nc" id="L2653">                        getCrew().decreaseEdge();</span>
<span class="nc" id="L2654">                        HitData result = rollHitLocation(table, side,</span>
                                aimedLocation, aimingMode, cover);
<span class="nc bnc" id="L2656" title="All 2 branches missed.">                        result.setUndoneLocation(new HitData(Mech.LOC_HEAD,</span>
                                (side == ToHitData.SIDE_REAR)));
<span class="nc" id="L2658">                        return result;</span>
                    } // if
<span class="nc bnc" id="L2660" title="All 2 branches missed.">                    return new HitData(Mech.LOC_HEAD,</span>
                            (side == ToHitData.SIDE_REAR));
            }
        }
<span class="nc bnc" id="L2664" title="All 2 branches missed.">        if (table == ToHitData.HIT_BELOW) {</span>
<span class="nc" id="L2665">            roll = Compute.d6(1);</span>
            try {
<span class="nc" id="L2667">                PrintWriter pw = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L2668">                        .getMekHitLocLog();</span>
<span class="nc bnc" id="L2669" title="All 2 branches missed.">                if (pw != null) {</span>
<span class="nc" id="L2670">                    pw.print(table);</span>
<span class="nc" id="L2671">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2672">                    pw.print(side);</span>
<span class="nc" id="L2673">                    pw.print(&quot;\t&quot;);</span>
<span class="nc" id="L2674">                    pw.println(roll);</span>
                }
<span class="nc" id="L2676">            } catch (Throwable thrown) {</span>
<span class="nc" id="L2677">                thrown.printStackTrace();</span>
<span class="nc" id="L2678">            }</span>
            // Hits from below.
<span class="nc bnc" id="L2680" title="All 7 branches missed.">            switch (roll) {</span>
                case 1:
<span class="nc bnc" id="L2682" title="All 2 branches missed.">                    return new HitData(Mech.LOC_LLEG,</span>
                            (side == ToHitData.SIDE_REAR));
                case 2:
<span class="nc bnc" id="L2685" title="All 2 branches missed.">                    return new HitData(Mech.LOC_LLEG,</span>
                            (side == ToHitData.SIDE_REAR));
                case 3:
<span class="nc bnc" id="L2688" title="All 2 branches missed.">                    return new HitData(Mech.LOC_LT,</span>
                            (side == ToHitData.SIDE_REAR));
                case 4:
<span class="nc bnc" id="L2691" title="All 2 branches missed.">                    return new HitData(Mech.LOC_RT,</span>
                            (side == ToHitData.SIDE_REAR));
                case 5:
<span class="nc bnc" id="L2694" title="All 2 branches missed.">                    return new HitData(Mech.LOC_RLEG,</span>
                            (side == ToHitData.SIDE_REAR));
                case 6:
<span class="nc bnc" id="L2697" title="All 2 branches missed.">                    return new HitData(Mech.LOC_RLEG,</span>
                            (side == ToHitData.SIDE_REAR));
            }
        }
<span class="nc" id="L2701">        return null;</span>
    }

    /**
     * Called when a thru-armor-crit is rolled. Checks the game options and
     * either returns no critical hit, rolls a floating crit, or returns a TAC
     * in the specified location.
     */
    protected HitData tac(int table, int side, int location, int cover,
            boolean rear) {
<span class="nc bnc" id="L2711" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_NO_TAC)) {</span>
<span class="nc" id="L2712">            return new HitData(location, rear);</span>
<span class="nc bnc" id="L2713" title="All 2 branches missed.">        } else if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_FLOATING_CRITS)) {</span>
<span class="nc" id="L2714">            HitData hd = rollHitLocation(table, side);</span>
            // check for cover and keep rolling until you get something without
            // cover
<span class="nc" id="L2717">            int i = 0;</span>
<span class="nc bnc" id="L2718" title="All 4 branches missed.">            while (removePartialCoverHits(hd.getLocation(), cover, side)</span>
                    &amp;&amp; (i &lt; 500)) {
<span class="nc" id="L2720">                hd = rollHitLocation(table, side);</span>
<span class="nc" id="L2721">                i++;</span>
            }
<span class="nc" id="L2723">            return new HitData(hd.getLocation(), hd.isRear(),</span>
                    HitData.EFFECT_CRITICAL);
        } else {
<span class="nc" id="L2726">            return new HitData(location, rear, HitData.EFFECT_CRITICAL);</span>
        }
    }

    /**
     * Gets the location that excess damage transfers to
     */
    @Override
    public HitData getTransferLocation(HitData hit) {
<span class="nc bnc" id="L2735" title="All 5 branches missed.">        switch (hit.getLocation()) {</span>
            case LOC_RT:
            case LOC_LT:
            case LOC_CLEG:
<span class="nc" id="L2739">                return new HitData(LOC_CT, hit.isRear(), hit.getEffect(),</span>
<span class="nc" id="L2740">                        hit.hitAimedLocation(), hit.getSpecCritMod(),</span>
<span class="nc" id="L2741">                        hit.getSpecCrit(), hit.isFromFront(),</span>
<span class="nc" id="L2742">                        hit.getGeneralDamageType(), hit.glancingMod());</span>
            case LOC_LLEG:
            case LOC_LARM:
<span class="nc" id="L2745">                return new HitData(LOC_LT, hit.isRear(), hit.getEffect(),</span>
<span class="nc" id="L2746">                        hit.hitAimedLocation(), hit.getSpecCritMod(),</span>
<span class="nc" id="L2747">                        hit.getSpecCrit(), hit.isFromFront(),</span>
<span class="nc" id="L2748">                        hit.getGeneralDamageType(), hit.glancingMod());</span>
            case LOC_RLEG:
            case LOC_RARM:
<span class="nc" id="L2751">                return new HitData(LOC_RT, hit.isRear(), hit.getEffect(),</span>
<span class="nc" id="L2752">                        hit.hitAimedLocation(), hit.getSpecCritMod(),</span>
<span class="nc" id="L2753">                        hit.getSpecCrit(), hit.isFromFront(),</span>
<span class="nc" id="L2754">                        hit.getGeneralDamageType(), hit.glancingMod());</span>
            case LOC_HEAD:
<span class="nc bnc" id="L2756" title="All 2 branches missed.">                if (getCockpitType() == COCKPIT_TORSO_MOUNTED) {</span>
<span class="nc" id="L2757">                    return new HitData(LOC_NONE); // not destroyed by head loss</span>
                }
<span class="nc" id="L2759">                return new HitData(LOC_DESTROYED);</span>
            case LOC_CT:
            default:
<span class="nc" id="L2762">                return new HitData(LOC_DESTROYED);</span>
        }
    }

    /**
     * Gets the location that is destroyed recursively
     */
    @Override
    public int getDependentLocation(int loc) {
<span class="nc bnc" id="L2771" title="All 3 branches missed.">        switch (loc) {</span>
            case LOC_RT:
<span class="nc" id="L2773">                return LOC_RARM;</span>
            case LOC_LT:
<span class="nc" id="L2775">                return LOC_LARM;</span>
            case LOC_LLEG:
            case LOC_LARM:
            case LOC_RLEG:
            case LOC_RARM:
            case LOC_HEAD:
            case LOC_CT:
            default:
<span class="nc" id="L2783">                return LOC_NONE;</span>
        }
    }

    /**
     * Sets the internal structure for the mech.
     *
     * @param head
     *            head
     * @param ct
     *            center torso
     * @param t
     *            right/left torso
     * @param arm
     *            right/left arm
     * @param leg
     *            right/left leg
     */
    public abstract void setInternal(int head, int ct, int t, int arm, int leg);

    /**
     * Set the internal structure to the appropriate value for the mech's weight
     * class
     */
    @Override
    public void autoSetInternal() {
        // stupid irregular table... grr.
<span class="pc bpc" id="L2810" title="34 of 40 branches missed.">        switch ((int) weight) {</span>
        // H, CT,TSO,ARM,LEG
            case 10:
<span class="nc" id="L2813">                setInternal(3, 4, 3, 1, 2);</span>
<span class="nc" id="L2814">                break;</span>
            case 15:
<span class="nc" id="L2816">                setInternal(3, 5, 4, 2, 3);</span>
<span class="nc" id="L2817">                break;</span>
            case 20:
<span class="fc" id="L2819">                setInternal(3, 6, 5, 3, 4);</span>
<span class="fc" id="L2820">                break;</span>
            case 25:
<span class="fc" id="L2822">                setInternal(3, 8, 6, 4, 6);</span>
<span class="fc" id="L2823">                break;</span>
            case 30:
<span class="nc" id="L2825">                setInternal(3, 10, 7, 5, 7);</span>
<span class="nc" id="L2826">                break;</span>
            case 35:
<span class="fc" id="L2828">                setInternal(3, 11, 8, 6, 8);</span>
<span class="fc" id="L2829">                break;</span>
            case 40:
<span class="nc" id="L2831">                setInternal(3, 12, 10, 6, 10);</span>
<span class="nc" id="L2832">                break;</span>
            case 45:
<span class="nc" id="L2834">                setInternal(3, 14, 11, 7, 11);</span>
<span class="nc" id="L2835">                break;</span>
            case 50:
<span class="nc" id="L2837">                setInternal(3, 16, 12, 8, 12);</span>
<span class="nc" id="L2838">                break;</span>
            case 55:
<span class="nc" id="L2840">                setInternal(3, 18, 13, 9, 13);</span>
<span class="nc" id="L2841">                break;</span>
            case 60:
<span class="nc" id="L2843">                setInternal(3, 20, 14, 10, 14);</span>
<span class="nc" id="L2844">                break;</span>
            case 65:
<span class="fc" id="L2846">                setInternal(3, 21, 15, 10, 15);</span>
<span class="fc" id="L2847">                break;</span>
            case 70:
<span class="fc" id="L2849">                setInternal(3, 22, 15, 11, 15);</span>
<span class="fc" id="L2850">                break;</span>
            case 75:
<span class="nc" id="L2852">                setInternal(3, 23, 16, 12, 16);</span>
<span class="nc" id="L2853">                break;</span>
            case 80:
<span class="nc" id="L2855">                setInternal(3, 25, 17, 13, 17);</span>
<span class="nc" id="L2856">                break;</span>
            case 85:
<span class="nc" id="L2858">                setInternal(3, 27, 18, 14, 18);</span>
<span class="nc" id="L2859">                break;</span>
            case 90:
<span class="nc" id="L2861">                setInternal(3, 29, 19, 15, 19);</span>
<span class="nc" id="L2862">                break;</span>
            case 95:
<span class="nc" id="L2864">                setInternal(3, 30, 20, 16, 20);</span>
<span class="nc" id="L2865">                break;</span>
            case 100:
<span class="nc" id="L2867">                setInternal(3, 31, 21, 17, 21);</span>
<span class="nc" id="L2868">                break;</span>
            case 105:
<span class="nc" id="L2870">                setInternal(4, 32, 22, 17, 22);</span>
<span class="nc" id="L2871">                break;</span>
            case 110:
<span class="nc" id="L2873">                setInternal(4, 33, 23, 18, 23);</span>
<span class="nc" id="L2874">                break;</span>
            case 115:
<span class="nc" id="L2876">                setInternal(4, 35, 24, 19, 24);</span>
<span class="nc" id="L2877">                break;</span>
            case 120:
<span class="fc" id="L2879">                setInternal(4, 36, 25, 20, 25);</span>
<span class="fc" id="L2880">                break;</span>
            case 125:
<span class="nc" id="L2882">                setInternal(4, 38, 26, 21, 26);</span>
<span class="nc" id="L2883">                break;</span>
            case 130:
<span class="nc" id="L2885">                setInternal(4, 39, 27, 21, 27);</span>
<span class="nc" id="L2886">                break;</span>
            case 135:
<span class="nc" id="L2888">                setInternal(4, 41, 28, 22, 28);</span>
<span class="nc" id="L2889">                break;</span>
            case 140:
<span class="nc" id="L2891">                setInternal(4, 42, 29, 23, 29);</span>
<span class="nc" id="L2892">                break;</span>
            case 145:
<span class="nc" id="L2894">                setInternal(4, 44, 31, 24, 31);</span>
<span class="nc" id="L2895">                break;</span>
            case 150:
<span class="nc" id="L2897">                setInternal(4, 45, 32, 25, 32);</span>
<span class="nc" id="L2898">                break;</span>
            case 155:
<span class="nc" id="L2900">                setInternal(4, 47, 33, 26, 33);</span>
<span class="nc" id="L2901">                break;</span>
            case 160:
<span class="nc" id="L2903">                setInternal(4, 48, 34, 26, 34);</span>
<span class="nc" id="L2904">                break;</span>
            case 165:
<span class="nc" id="L2906">                setInternal(4, 50, 35, 27, 35);</span>
<span class="nc" id="L2907">                break;</span>
            case 170:
<span class="nc" id="L2909">                setInternal(4, 51, 36, 28, 36);</span>
<span class="nc" id="L2910">                break;</span>
            case 175:
<span class="nc" id="L2912">                setInternal(4, 53, 37, 29, 37);</span>
<span class="nc" id="L2913">                break;</span>
            case 180:
<span class="nc" id="L2915">                setInternal(4, 54, 38, 30, 38);</span>
<span class="nc" id="L2916">                break;</span>
            case 185:
<span class="nc" id="L2918">                setInternal(4, 56, 39, 31, 39);</span>
<span class="nc" id="L2919">                break;</span>
            case 190:
<span class="nc" id="L2921">                setInternal(4, 57, 40, 31, 40);</span>
<span class="nc" id="L2922">                break;</span>
            case 195:
<span class="nc" id="L2924">                setInternal(4, 59, 41, 32, 41);</span>
<span class="nc" id="L2925">                break;</span>
            case 200:
<span class="nc" id="L2927">                setInternal(4, 60, 42, 33, 42);</span>
                break;
        }
<span class="fc" id="L2930">    }</span>

    /**
     * Adds clan CASE in every location
     */
    public void addClanCase() {
<span class="nc" id="L2936">        boolean explosiveFound = false;</span>
<span class="nc" id="L2937">        EquipmentType clCase = EquipmentType.get(EquipmentTypeLookup.CLAN_CASE);</span>
<span class="nc bnc" id="L2938" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L2939">            explosiveFound = false;</span>
<span class="nc bnc" id="L2940" title="All 2 branches missed.">            for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L2941" title="All 4 branches missed.">                if (m.getType().isExplosive(m) &amp;&amp; (m.getLocation() == i)) {</span>
<span class="nc" id="L2942">                    explosiveFound = true;</span>
                }
<span class="nc" id="L2944">            }</span>
<span class="nc bnc" id="L2945" title="All 2 branches missed.">            if (explosiveFound) {</span>
                try {
<span class="nc" id="L2947">                    addEquipment(new Mounted(this, clCase), i, false);</span>
<span class="nc" id="L2948">                } catch (LocationFullException ex) {</span>
                    // um, that's impossible.
<span class="nc" id="L2950">                }</span>
            }
        }
<span class="nc" id="L2953">    }</span>

    public Mounted addEquipment(EquipmentType etype, EquipmentType etype2,
            int loc,  boolean omniPod, boolean armored) throws LocationFullException {
<span class="fc" id="L2957">        Mounted mounted = new Mounted(this, etype);</span>
<span class="fc" id="L2958">        Mounted mounted2 = new Mounted(this, etype2);</span>
<span class="fc" id="L2959">        mounted.setOmniPodMounted(omniPod);</span>
<span class="fc" id="L2960">        mounted2.setOmniPodMounted(omniPod);</span>
<span class="fc" id="L2961">        mounted.setArmored(armored);</span>
<span class="fc" id="L2962">        mounted2.setArmored(armored);</span>
        // check criticals for space
<span class="pc bpc" id="L2964" title="1 of 2 branches missed.">        if (getEmptyCriticals(loc) &lt; 1) {</span>
<span class="nc" id="L2965">            throw new LocationFullException(mounted.getName() + &quot; and &quot;</span>
<span class="nc" id="L2966">                    + mounted2.getName() + &quot; do not fit in &quot;</span>
<span class="nc" id="L2967">                    + getLocationAbbr(loc) + &quot; on &quot; + getDisplayName()</span>
                    + &quot;\n        free criticals in location: &quot;
<span class="nc" id="L2969">                    + getEmptyCriticals(loc) + &quot;, criticals needed: &quot; + 1);</span>
        }
<span class="fc" id="L2971">        super.addEquipment(mounted, loc, false);</span>
<span class="fc" id="L2972">        super.addEquipment(mounted2, loc, false);</span>
<span class="fc" id="L2973">        CriticalSlot cs = new CriticalSlot(mounted);</span>
<span class="fc" id="L2974">        cs.setMount2(mounted2);</span>
<span class="fc" id="L2975">        addCritical(loc, cs);</span>
<span class="fc" id="L2976">        return mounted;</span>
    }

    /**
     * Mounts the specified weapon in the specified location.
     */
    @Override
    public void addEquipment(Mounted mounted, int loc, boolean rearMounted)
            throws LocationFullException {
<span class="fc" id="L2985">        addEquipment(mounted,loc,rearMounted,-1);</span>
<span class="fc" id="L2986">    }</span>

    /**
     * Mounts the specified weapon in the specified location.
     */
    @Override
    public void addEquipment(Mounted mounted, int loc, boolean rearMounted,
            int critSlot)
            throws LocationFullException {
        // if there's no actual location or this is a LAM capital fighter weapons group,
        // or ammo for a LAM bomb weapon then don't add criticals
<span class="pc bpc" id="L2997" title="1 of 4 branches missed.">        if ((loc == LOC_NONE) || mounted.isWeaponGroup()</span>
<span class="pc bpc" id="L2998" title="1 of 2 branches missed.">                || (mounted.getType() instanceof BombType)) {</span>
<span class="fc" id="L2999">            super.addEquipment(mounted, loc, rearMounted);</span>
<span class="fc" id="L3000">            return;</span>
        }

        // spreadable or split equipment only gets added to 1 crit at a time,
        // since we don't know how many are in this location
<span class="fc" id="L3005">        int reqSlots = mounted.getCriticals();</span>
<span class="pc bpc" id="L3006" title="2 of 4 branches missed.">        if (mounted.getType().isSpreadable() || mounted.isSplitable()) {</span>
<span class="nc" id="L3007">            reqSlots = 1;</span>
        }
<span class="pc bpc" id="L3009" title="1 of 2 branches missed.">        if (isSuperHeavy()) {</span>
<span class="nc" id="L3010">            reqSlots = (int) Math.ceil(((double) reqSlots / 2.0f));</span>
        }
        // gauss and AC weapons on omni arms means no arm actuators, so we
        // remove them
<span class="pc bpc" id="L3014" title="7 of 8 branches missed.">        if (isOmni()</span>
                &amp;&amp; (this instanceof BipedMech)
                &amp;&amp; ((loc == LOC_LARM) || (loc == LOC_RARM))
<span class="nc bnc" id="L3017" title="All 2 branches missed.">                &amp;&amp; ((mounted.getType() instanceof GaussWeapon)</span>
<span class="nc bnc" id="L3018" title="All 2 branches missed.">                        || (mounted.getType() instanceof ACWeapon)</span>
<span class="nc bnc" id="L3019" title="All 2 branches missed.">                        || (mounted.getType() instanceof UACWeapon)</span>
<span class="nc bnc" id="L3020" title="All 2 branches missed.">                        || (mounted.getType() instanceof LBXACWeapon) || (mounted</span>
<span class="nc bnc" id="L3021" title="All 2 branches missed.">                            .getType() instanceof PPCWeapon))) {</span>
<span class="nc bnc" id="L3022" title="All 2 branches missed.">            if (hasSystem(Mech.ACTUATOR_LOWER_ARM, loc)) {</span>
<span class="nc" id="L3023">                setCritical(loc, 2, null);</span>
            }
<span class="nc bnc" id="L3025" title="All 2 branches missed.">            if (hasSystem(Mech.ACTUATOR_HAND, loc)) {</span>
<span class="nc" id="L3026">                setCritical(loc, 3, null);</span>
            }
        }

        // check criticals for space
<span class="pc bpc" id="L3031" title="1 of 2 branches missed.">        if (getEmptyCriticals(loc) &lt; reqSlots) {</span>
<span class="nc" id="L3032">            throw new LocationFullException(mounted.getName()</span>
<span class="nc" id="L3033">                    + &quot; does not fit in &quot; + getLocationAbbr(loc) + &quot; on &quot;</span>
<span class="nc" id="L3034">                    + getDisplayName()</span>
                    + &quot;\n        free criticals in location: &quot;
<span class="nc" id="L3036">                    + getEmptyCriticals(loc) + &quot;, criticals needed: &quot;</span>
                    + reqSlots);
        }
        // add it
<span class="pc bpc" id="L3040" title="1 of 2 branches missed.">        if (getEquipmentNum(mounted) == -1) {</span>
<span class="fc" id="L3041">            super.addEquipment(mounted, loc, rearMounted);</span>
        }

        // add criticals
<span class="pc bpc" id="L3045" title="1 of 2 branches missed.">        if (critSlot == -1){</span>
<span class="fc bfc" id="L3046" title="All 2 branches covered.">            for (int i = 0; i &lt; reqSlots; i++) {</span>
<span class="fc" id="L3047">                CriticalSlot cs = new CriticalSlot(mounted);</span>
<span class="fc" id="L3048">                addCritical(loc, cs);</span>
            }
        } else {
            // Need to ensure that we have enough contiguous critical slots
<span class="nc" id="L3052">            int iterations = 0;</span>
<span class="nc bnc" id="L3053" title="All 2 branches missed.">            while ((getContiguousNumberOfCrits(loc, critSlot) &lt; reqSlots) &amp;&amp;</span>
<span class="nc bnc" id="L3054" title="All 2 branches missed.">                    (iterations &lt; getNumberOfCriticals(loc))){</span>
<span class="nc" id="L3055">                critSlot = (critSlot + 1) % getNumberOfCriticals(loc);</span>
<span class="nc" id="L3056">                iterations++;</span>
            }
<span class="nc bnc" id="L3058" title="All 2 branches missed.">            if (iterations &gt;= getNumberOfCriticals(loc)){</span>
<span class="nc" id="L3059">                throw new LocationFullException(mounted.getName()</span>
<span class="nc" id="L3060">                        + &quot; does not fit in &quot; + getLocationAbbr(loc) + &quot; on &quot;</span>
<span class="nc" id="L3061">                        + getDisplayName()</span>
                        + &quot;\n    needs &quot;
<span class="nc" id="L3063">                        + getEmptyCriticals(loc)</span>
                        + &quot; free contiguous criticals&quot;);
            }
<span class="nc bnc" id="L3066" title="All 2 branches missed.">            for (int i = 0; i &lt; reqSlots; i++) {</span>
<span class="nc" id="L3067">                CriticalSlot cs = new CriticalSlot(mounted);</span>
<span class="nc" id="L3068">                addCritical(loc, cs, critSlot);</span>
<span class="nc" id="L3069">                critSlot = (critSlot + 1) % getNumberOfCriticals(loc);</span>
            }
        }
<span class="fc" id="L3072">    }</span>

    //From IO pg 50
    public static TechAdvancement getTechAdvancement(long etype, boolean primitive, boolean industrial, int weightClass) {
<span class="pc bpc" id="L3076" title="1 of 2 branches missed.">        if ((etype &amp; ETYPE_TRIPOD_MECH) != 0) {</span>
<span class="nc bnc" id="L3077" title="All 2 branches missed.">            if (weightClass != EntityWeightClass.WEIGHT_SUPER_HEAVY) {</span>
<span class="nc" id="L3078">                return new TechAdvancement(TECH_BASE_IS)</span>
<span class="nc" id="L3079">                        .setISAdvancement(2585, 2602).setISApproximate(true).setPrototypeFactions(F_TH)</span>
<span class="nc" id="L3080">                        .setProductionFactions(F_TH).setTechRating(RATING_D)</span>
<span class="nc" id="L3081">                        .setAvailability(RATING_F, RATING_F, RATING_F, RATING_E)</span>
<span class="nc" id="L3082">                        .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
            } else {
<span class="nc" id="L3084">                return new TechAdvancement(TECH_BASE_IS)</span>
<span class="nc" id="L3085">                        .setISAdvancement(2930, 2940).setISApproximate(true).setPrototypeFactions(F_FW)</span>
<span class="nc" id="L3086">                        .setProductionFactions(F_FW).setTechRating(RATING_D)</span>
<span class="nc" id="L3087">                        .setAvailability(RATING_X, RATING_F, RATING_X, RATING_F)</span>
<span class="nc" id="L3088">                        .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
            }
<span class="pc bpc" id="L3090" title="3 of 4 branches missed.">        } else if (primitive &amp;&amp; industrial) {</span>
<span class="nc" id="L3091">            return new TechAdvancement(TECH_BASE_IS)</span>
<span class="nc" id="L3092">                    .setISAdvancement(2300, 2350, 2425, 2520).setPrototypeFactions(F_TA)</span>
<span class="nc" id="L3093">                    .setProductionFactions(F_TH).setTechRating(RATING_D)</span>
<span class="nc" id="L3094">                    .setAvailability(RATING_D, RATING_X, RATING_F, RATING_F)</span>
<span class="nc" id="L3095">                    .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
<span class="pc bpc" id="L3096" title="1 of 2 branches missed.">        } else if (primitive) {</span>
<span class="nc" id="L3097">            return new TechAdvancement(TECH_BASE_IS)</span>
<span class="nc" id="L3098">                    .setISAdvancement(2439, 2443, 2470, 2520).setPrototypeFactions(F_TH)</span>
<span class="nc" id="L3099">                    .setProductionFactions(F_TH).setTechRating(RATING_C)</span>
<span class="nc" id="L3100">                    .setAvailability(RATING_C, RATING_X, RATING_F, RATING_F)</span>
<span class="nc" id="L3101">                    .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
<span class="pc bpc" id="L3102" title="3 of 4 branches missed.">        } else if (industrial &amp;&amp; (EntityWeightClass.WEIGHT_SUPER_HEAVY == weightClass)) {</span>
            // Superheavy industrialmechs don't have a separate entry on the tech advancement
            // table in IO, but the dates for the superheavy tripod are based on the
            // three-man digging machine, which is an industrialmech.
<span class="nc" id="L3106">            return new TechAdvancement(TECH_BASE_IS)</span>
<span class="nc" id="L3107">                    .setAdvancement(2930, 2940).setPrototypeFactions(F_FW)</span>
<span class="nc" id="L3108">                    .setProductionFactions(F_FW).setTechRating(RATING_D)</span>
<span class="nc" id="L3109">                    .setAvailability(RATING_X, RATING_F, RATING_X, RATING_F)</span>
<span class="nc" id="L3110">                    .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
<span class="pc bpc" id="L3111" title="1 of 2 branches missed.">        } else if (industrial) {</span>
<span class="nc" id="L3112">            return new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L3113">                    .setAdvancement(2460, 2470, 2500).setPrototypeFactions(F_TH)</span>
<span class="nc" id="L3114">                    .setProductionFactions(F_TH).setTechRating(RATING_C)</span>
<span class="nc" id="L3115">                    .setAvailability(RATING_C, RATING_C, RATING_C, RATING_B)</span>
<span class="nc" id="L3116">                    .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
<span class="fc bfc" id="L3117" title="All 2 branches covered.">        } else if (EntityWeightClass.WEIGHT_ULTRA_LIGHT == weightClass) {</span>
<span class="fc" id="L3118">            return new TechAdvancement(TECH_BASE_ALL)</span>
<span class="fc" id="L3119">                    .setAdvancement(2500, 2519, 3075).setPrototypeFactions(F_TH, F_FW)</span>
<span class="fc" id="L3120">                    .setProductionFactions(F_FW).setApproximate(true, false, true)</span>
<span class="fc" id="L3121">                    .setTechRating(RATING_D)</span>
<span class="fc" id="L3122">                    .setAvailability(RATING_E, RATING_F, RATING_E, RATING_E)</span>
<span class="fc" id="L3123">                    .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
<span class="fc bfc" id="L3124" title="All 2 branches covered.">        } else if (EntityWeightClass.WEIGHT_SUPER_HEAVY == weightClass) {</span>
<span class="fc" id="L3125">            return new TechAdvancement(TECH_BASE_IS)</span>
<span class="fc" id="L3126">                    .setISAdvancement(3077, 3078).setPrototypeFactions(F_WB)</span>
<span class="fc" id="L3127">                    .setProductionFactions(F_WB).setTechRating(RATING_D)</span>
<span class="fc" id="L3128">                    .setAvailability(RATING_X, RATING_F, RATING_F, RATING_F)</span>
<span class="fc" id="L3129">                    .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
        } else {
<span class="fc" id="L3131">            return new TechAdvancement(TECH_BASE_ALL)</span>
<span class="fc" id="L3132">                    .setAdvancement(2460, 2470, 2500).setPrototypeFactions(F_TH)</span>
<span class="fc" id="L3133">                    .setProductionFactions(F_TH).setTechRating(RATING_D)</span>
<span class="fc" id="L3134">                    .setAvailability(RATING_C, RATING_E, RATING_D, RATING_C)</span>
<span class="fc" id="L3135">                    .setStaticTechLevel(SimpleTechLevel.INTRO);</span>
        }
    }

    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="fc" id="L3141">        return getTechAdvancement(getEntityType(), isPrimitive(), isIndustrial(), getWeightClass());</span>
    }

<span class="fc" id="L3144">    private static final TechAdvancement[] GYRO_TA =  {</span>
<span class="fc" id="L3145">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2300, 2350, 2505)</span>
<span class="fc" id="L3146">                .setApproximate(true, false, false).setPrototypeFactions(F_TA)</span>
<span class="fc" id="L3147">                .setProductionFactions(F_TH).setTechRating(RATING_D)</span>
<span class="fc" id="L3148">                .setAvailability(RATING_C, RATING_C, RATING_C, RATING_C)</span>
<span class="fc" id="L3149">                .setStaticTechLevel(SimpleTechLevel.INTRO), //Standard</span>
<span class="fc" id="L3150">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3055, 3067, 3072)</span>
<span class="fc" id="L3151">                .setISApproximate(true, false, false).setPrototypeFactions(F_CS)</span>
<span class="fc" id="L3152">                .setProductionFactions(F_CS).setTechRating(RATING_E)</span>
<span class="fc" id="L3153">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="fc" id="L3154">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //XL</span>
<span class="fc" id="L3155">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3055, 3068, 3072)</span>
<span class="fc" id="L3156">                .setISApproximate(true, false, false).setPrototypeFactions(F_FS, F_LC)</span>
<span class="fc" id="L3157">                .setProductionFactions(F_FS, F_LC).setTechRating(RATING_E)</span>
<span class="fc" id="L3158">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="fc" id="L3159">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Compact</span>
<span class="fc" id="L3160">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3055, 3067, 3072)</span>
<span class="fc" id="L3161">                .setISApproximate(true, false, false).setPrototypeFactions(F_DC)</span>
<span class="fc" id="L3162">                .setProductionFactions(F_DC).setTechRating(RATING_E)</span>
<span class="fc" id="L3163">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="fc" id="L3164">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Heavy duty</span>
<span class="fc" id="L3165">            new TechAdvancement(TECH_BASE_IS).setAdvancement(DATE_NONE)</span>
<span class="fc" id="L3166">                .setTechRating(RATING_A)</span>
<span class="fc" id="L3167">                .setAvailability(RATING_A, RATING_A, RATING_A, RATING_A)</span>
<span class="fc" id="L3168">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //None (placeholder)</span>
<span class="fc" id="L3169">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(2905, 2940)</span>
<span class="fc" id="L3170">                .setISApproximate(true, false).setPrototypeFactions(F_FW)</span>
<span class="fc" id="L3171">                .setProductionFactions(F_FW).setTechRating(RATING_D)</span>
<span class="fc" id="L3172">                .setAvailability(RATING_X, RATING_F, RATING_F, RATING_F)</span>
<span class="fc" id="L3173">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Superheavy</span>
    };

<span class="fc" id="L3176">    private static final TechAdvancement[] COCKPIT_TA = {</span>
<span class="fc" id="L3177">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2468, 2470, 2487)</span>
<span class="fc" id="L3178">                .setApproximate(true, false, false).setTechRating(RATING_D)</span>
<span class="fc" id="L3179">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="fc" id="L3180">                .setAvailability(RATING_C, RATING_C, RATING_C, RATING_C)</span>
<span class="fc" id="L3181">                .setStaticTechLevel(SimpleTechLevel.INTRO), //Standard</span>
<span class="fc" id="L3182">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(3060, 3067, 3080)</span>
<span class="fc" id="L3183">                .setISApproximate(true, false, false)</span>
<span class="fc" id="L3184">                .setClanAdvancement(DATE_NONE, 3080, 3080).setTechRating(RATING_E)</span>
<span class="fc" id="L3185">                .setPrototypeFactions(F_FS).setProductionFactions(F_FS, F_CJF)</span>
<span class="fc" id="L3186">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="fc" id="L3187">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Small</span>
<span class="fc" id="L3188">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(2625, 2631, DATE_NONE, 2850, 3030)</span>
<span class="fc" id="L3189">                .setISApproximate(true, false, false, true, true)</span>
<span class="fc" id="L3190">                .setClanAdvancement(2625, 2631).setClanApproximate(true, false)</span>
<span class="fc" id="L3191">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="fc" id="L3192">                .setReintroductionFactions(F_FS).setTechRating(RATING_D)</span>
<span class="fc" id="L3193">                .setAvailability(RATING_C, RATING_F, RATING_E, RATING_D)</span>
<span class="fc" id="L3194">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Cockpit command console</span>
<span class="fc" id="L3195">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(3053, 3080, 3100)</span>
<span class="fc" id="L3196">                .setClanAdvancement(3055, 3080, 3100)</span>
<span class="fc" id="L3197">                .setPrototypeFactions(F_FS, F_LC, F_CSJ).setProductionFactions(F_LC)</span>
<span class="fc" id="L3198">                .setApproximate(false, true, false).setTechRating(RATING_D)</span>
<span class="fc" id="L3199">                .setAvailability(RATING_X, RATING_X, RATING_F, RATING_F)</span>
<span class="fc" id="L3200">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL), //Torso mounted</span>
            //FIXME: Dual is unofficial; these are stats for standard
<span class="fc" id="L3202">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2468, 2470, 2487)</span>
<span class="fc" id="L3203">                .setApproximate(true, false, false).setTechRating(RATING_D)</span>
<span class="fc" id="L3204">                .setAvailability(RATING_C, RATING_C, RATING_C, RATING_C)</span>
<span class="fc" id="L3205">                .setStaticTechLevel(SimpleTechLevel.UNOFFICIAL), //Dual</span>
<span class="fc" id="L3206">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2469, 2470, 2490)</span>
<span class="fc" id="L3207">                .setApproximate(true, false, false).setTechRating(RATING_C)</span>
<span class="fc" id="L3208">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="fc" id="L3209">                .setAvailability(RATING_B, RATING_C, RATING_C, RATING_B)</span>
<span class="fc" id="L3210">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Industrial</span>
<span class="fc" id="L3211">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2430, 2439)</span>
<span class="fc" id="L3212">                .setApproximate(true, false).setTechRating(RATING_D)</span>
<span class="fc" id="L3213">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="fc" id="L3214">                .setAvailability(RATING_D, RATING_X, RATING_X, RATING_F)</span>
<span class="fc" id="L3215">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Primitive</span>
<span class="fc" id="L3216">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2300, 2350, DATE_NONE, 2520)</span>
<span class="fc" id="L3217">                .setApproximate(true, false, false).setTechRating(RATING_C)</span>
<span class="fc" id="L3218">                .setPrototypeFactions(F_TA).setProductionFactions(F_TH)</span>
<span class="fc" id="L3219">                .setAvailability(RATING_C, RATING_X, RATING_X, RATING_F)</span>
<span class="fc" id="L3220">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Primitive industrial</span>
<span class="fc" id="L3221">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3060, 3076)</span>
<span class="fc" id="L3222">                .setISApproximate(true, false).setTechRating(RATING_E)</span>
<span class="fc" id="L3223">                .setPrototypeFactions(F_WB).setProductionFactions(F_WB)</span>
<span class="fc" id="L3224">                .setAvailability(RATING_X, RATING_X, RATING_F, RATING_E)</span>
<span class="fc" id="L3225">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Superheavy</span>
<span class="fc" id="L3226">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3130, 3135)</span>
<span class="fc" id="L3227">                .setISApproximate(true, false).setTechRating(RATING_E)</span>
<span class="fc" id="L3228">                .setPrototypeFactions(F_RS).setProductionFactions(F_RS)</span>
<span class="fc" id="L3229">                .setAvailability(RATING_X, RATING_F, RATING_X, RATING_F)</span>
<span class="fc" id="L3230">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Superheavy tripod</span>
<span class="fc" id="L3231">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(2590, 2702)</span>
<span class="fc" id="L3232">                .setISApproximate(true, false).setTechRating(RATING_F)</span>
<span class="fc" id="L3233">                .setPrototypeFactions(F_TH).setProductionFactions(F_TH)</span>
<span class="fc" id="L3234">                .setAvailability(RATING_X, RATING_X, RATING_X, RATING_F)</span>
<span class="fc" id="L3235">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Tripod</span>
<span class="fc" id="L3236">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(3074).setClanAdvancement(3083)</span>
<span class="fc" id="L3237">                .setApproximate(true).setTechRating(RATING_E)</span>
<span class="fc" id="L3238">                .setPrototypeFactions(F_WB, F_CHH)</span>
<span class="fc" id="L3239">                .setAvailability(RATING_X, RATING_X, RATING_F, RATING_F)</span>
<span class="fc" id="L3240">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL), //Cockpit interface</span>
<span class="fc" id="L3241">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3052, DATE_NONE, DATE_NONE, 3055)</span>
<span class="fc" id="L3242">                .setPrototypeFactions(F_FS, F_LC).setTechRating(RATING_E)</span>
<span class="fc" id="L3243">                .setAvailability(RATING_X, RATING_X, RATING_F, RATING_X)</span>
<span class="fc" id="L3244">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL), //VRRP</span>
<span class="fc" id="L3245">            new TechAdvancement(TECH_BASE_CLAN).setClanAdvancement(3130, 3135)</span>
<span class="fc" id="L3246">                .setClanApproximate(true, false).setTechRating(RATING_F)</span>
<span class="fc" id="L3247">                .setPrototypeFactions(F_CHH).setProductionFactions(F_CHH)</span>
<span class="fc" id="L3248">                .setAvailability(RATING_X, RATING_X, RATING_X, RATING_F)</span>
<span class="fc" id="L3249">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //QuadVee</span>
<span class="fc" id="L3250">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(2905, 2940)</span>
<span class="fc" id="L3251">                .setISApproximate(true, false).setTechRating(RATING_D)</span>
<span class="fc" id="L3252">                .setPrototypeFactions(F_FW).setProductionFactions(F_FW)</span>
<span class="fc" id="L3253">                .setAvailability(RATING_X, RATING_F, RATING_F, RATING_F)</span>
<span class="fc" id="L3254">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Superheavy industrial</span>
<span class="fc" id="L3255">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3060, 3076)</span>
<span class="fc" id="L3256">                .setISApproximate(true, false).setTechRating(RATING_E)</span>
<span class="fc" id="L3257">                .setPrototypeFactions(F_WB).setProductionFactions(F_WB)</span>
<span class="fc" id="L3258">                .setAvailability(RATING_X, RATING_X, RATING_F, RATING_E)</span>
<span class="fc" id="L3259">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Superheavy command console</span>
<span class="fc" id="L3260">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(3060, 3067, 3080)</span>
<span class="fc" id="L3261">                .setISApproximate(true, false, false)</span>
<span class="fc" id="L3262">                .setClanAdvancement(DATE_NONE, 3080, 3080).setTechRating(RATING_E)</span>
<span class="fc" id="L3263">                .setPrototypeFactions(F_FS).setProductionFactions(F_FS, F_CJF)</span>
<span class="fc" id="L3264">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="fc" id="L3265">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Small Command Console</span>
    };

    // Advanced fire control for industrial mechs is implemented with a standard cockpit,
    // but the tech progression is different.
    public static TechAdvancement getIndustrialAdvFireConTA() {
<span class="nc" id="L3271">        return new TechAdvancement(TECH_BASE_ALL).setAdvancement(2469, 2470, 2491)</span>
<span class="nc" id="L3272">                .setApproximate(true, false, false).setPrototypeFactions(F_TA)</span>
<span class="nc" id="L3273">                .setProductionFactions(F_TH).setTechRating(RATING_D)</span>
<span class="nc" id="L3274">                .setAvailability(RATING_D, RATING_E, RATING_E, RATING_D)</span>
<span class="nc" id="L3275">                .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
    }

    public static TechAdvancement getCockpitTechAdvancement(int cockpitType) {
<span class="pc bpc" id="L3279" title="2 of 4 branches missed.">        if (cockpitType &gt;= 0 &amp;&amp; cockpitType &lt; COCKPIT_TA.length) {</span>
<span class="fc" id="L3280">            return new TechAdvancement(COCKPIT_TA[cockpitType]);</span>
        }
<span class="nc" id="L3282">        return null;</span>
    }

    public TechAdvancement getCockpitTechAdvancement() {
<span class="pc bpc" id="L3286" title="3 of 4 branches missed.">        if (isIndustrial() &amp;&amp; (getCockpitType() == COCKPIT_STANDARD)) {</span>
<span class="nc" id="L3287">            return getIndustrialAdvFireConTA();</span>
        }
<span class="fc" id="L3289">        return getCockpitTechAdvancement(getCockpitType());</span>
    }

    public static TechAdvancement getGyroTechAdvancement(int gyroType) {
<span class="pc bpc" id="L3293" title="2 of 4 branches missed.">        if ((gyroType &gt;= 0) &amp;&amp; (gyroType &lt; GYRO_TA.length)) {</span>
<span class="fc" id="L3294">            return new TechAdvancement(GYRO_TA[gyroType]);</span>
        }
<span class="nc" id="L3296">        return null;</span>
    }

    public TechAdvancement getGyroTechAdvancement() {
<span class="fc" id="L3300">        return getGyroTechAdvancement(getGyroType());</span>
    }

    public static TechAdvancement getFullHeadEjectAdvancement() {
<span class="nc" id="L3304">        return new TechAdvancement(TECH_BASE_ALL).setISAdvancement(3020, 3023, 3100)</span>
<span class="nc" id="L3305">                .setClanAdvancement(DATE_NONE, 3052, 3100).setPrototypeFactions(F_LC)</span>
<span class="nc" id="L3306">                .setProductionFactions(F_LC, F_CWF).setTechRating(RATING_D)</span>
<span class="nc" id="L3307">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="nc" id="L3308">                .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
    }

    @Override
    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<span class="fc" id="L3313">        super.addSystemTechAdvancement(ctl);</span>
        // battlemechs with non-fusion engines are experimental
<span class="pc bpc" id="L3315" title="2 of 6 branches missed.">        if (hasEngine() &amp;&amp; !isIndustrial() &amp;&amp; !getEngine().isFusion()) {</span>
<span class="nc" id="L3316">            ctl.addComponent(new TechAdvancement().setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL));</span>
        }
<span class="pc bpc" id="L3318" title="1 of 2 branches missed.">        if (getGyroTechAdvancement() != null) {</span>
<span class="fc" id="L3319">            ctl.addComponent(getGyroTechAdvancement());</span>
        }
<span class="pc bpc" id="L3321" title="1 of 2 branches missed.">        if (getCockpitTechAdvancement() != null) {</span>
<span class="fc" id="L3322">            ctl.addComponent(getCockpitTechAdvancement());</span>
        }
<span class="pc bpc" id="L3324" title="1 of 2 branches missed.">        if (hasFullHeadEject()) {</span>
<span class="nc" id="L3325">            ctl.addComponent(getFullHeadEjectAdvancement());</span>
        }
        //FIXME: Clan interface cockpit has higher tech rating
        //if (getCockpitType() == COCKPIT_INTERFACE &amp;&amp; isClan()) {
        //    techAdvancement.setTechRating(Math.max(techAdvancement.getTechRating(), RATING_F));
        //}
<span class="fc" id="L3331">    }</span>

    /**
     * This method will return the number of contiguous criticals in the given
     * location, starting at the given critical slot
     *
     * @param loc           The location on the unit to check slots on
     * @param startingSlot  The critical slot to start at
     * @return
     */
    private int getContiguousNumberOfCrits(int loc, int startingSlot){

<span class="nc" id="L3343">        int numCritSlots = getNumberOfCriticals(loc);</span>
<span class="nc" id="L3344">        int contiguousCrits = 0;</span>

<span class="nc bnc" id="L3346" title="All 2 branches missed.">        for (int slot = startingSlot; slot &lt; numCritSlots; slot++) {</span>
<span class="nc bnc" id="L3347" title="All 2 branches missed.">            if (getCritical(loc, slot) == null) {</span>
<span class="nc" id="L3348">                contiguousCrits++;</span>
            } else {
               break;
            }
        }
<span class="nc" id="L3353">        return contiguousCrits;</span>
    }

    /**
     * Used in BV calculations. Any equipment that will destroy the unit or leg it if it explodes
     * decreases the defensive battle rating. This is anything in the head, CT, or leg,
     * or side torso if it has &gt;= 3 engine crits, or any location that can transfer damage to that
     * location.
     *
     * @param loc The location index
     * @return    Whether explosive equipment in the location should decrease BV
     */
    private boolean hasExplosiveEquipmentPenalty(int loc) {
<span class="nc bnc" id="L3366" title="All 4 branches missed.">        if ((loc == Entity.LOC_NONE) || hasCASEII(loc)) {</span>
<span class="nc" id="L3367">            return false;</span>
        }
<span class="nc bnc" id="L3369" title="All 6 branches missed.">        if (!entityIsQuad() &amp;&amp; ((loc == Mech.LOC_RARM) || (loc == Mech.LOC_LARM))) {</span>
<span class="nc bnc" id="L3370" title="All 4 branches missed.">            return !locationHasCase(loc) &amp;&amp; hasExplosiveEquipmentPenalty(getTransferLocation(loc));</span>
<span class="nc bnc" id="L3371" title="All 4 branches missed.">        } else if ((loc == Mech.LOC_RT) || (loc == Mech.LOC_LT)) {</span>
<span class="nc bnc" id="L3372" title="All 4 branches missed.">            return !locationHasCase(loc) || (getEngine().getSideTorsoCriticalSlots().length &gt;= 3);</span>
        } else {
<span class="nc" id="L3374">            return true;</span>
        }
    }

    /**
     * Calculates the battle value of this mech
     */
    @Override
    public int calculateBattleValue() {
<span class="nc bnc" id="L3383" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L3384">            return manualBV;</span>
        }
<span class="nc" id="L3386">        return calculateBattleValue(false, false);</span>
    }

    /**
     * Calculates the battle value of this mech. If the parameter is true, then
     * the battle value for c3 won't be added whether the mech is currently part
     * of a network or not.
     */
    @Override
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L3396" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L3397">            return manualBV;</span>
        }

<span class="nc" id="L3400">        bvText = new StringBuffer(</span>
                &quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Battle Value Calculations For &quot;);

<span class="nc" id="L3403">        bvText.append(getChassis());</span>
<span class="nc" id="L3404">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L3405">        bvText.append(getModel());</span>
<span class="nc" id="L3406">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L3407">        bvText.append(nl);</span>

<span class="nc" id="L3409">        bvText.append(&quot;&lt;b&gt;Defensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L3410">        bvText.append(nl);</span>

<span class="nc" id="L3412">        double dbv = 0; // defensive battle value</span>
<span class="nc" id="L3413">        double obv = 0; // offensive bv</span>

<span class="nc" id="L3415">        double armorMultiplier = 1.0;</span>
<span class="nc" id="L3416">        bvText.append(startTable);</span>
<span class="nc bnc" id="L3417" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
            // total armor points

<span class="nc bnc" id="L3420" title="All 6 branches missed.">            switch (getArmorType(loc)) {</span>
                case EquipmentType.T_ARMOR_COMMERCIAL:
<span class="nc" id="L3422">                    armorMultiplier = 0.5;</span>
<span class="nc" id="L3423">                    break;</span>
                case EquipmentType.T_ARMOR_HARDENED:
<span class="nc" id="L3425">                    armorMultiplier = 2.0;</span>
<span class="nc" id="L3426">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L3430">                    armorMultiplier = 1.5;</span>
<span class="nc" id="L3431">                    break;</span>
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
<span class="nc" id="L3434">                    armorMultiplier = 1.2;</span>
<span class="nc" id="L3435">                    break;</span>
                case EquipmentType.T_ARMOR_HEAT_DISSIPATING:
<span class="nc" id="L3437">                    armorMultiplier = 1.1;</span>
<span class="nc" id="L3438">                    break;</span>
                default:
<span class="nc" id="L3440">                    armorMultiplier = 1.0;</span>
                    break;
            }

<span class="nc bnc" id="L3444" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L3445">                armorMultiplier += 0.2;</span>
            }
<span class="nc bnc" id="L3447" title="All 2 branches missed.">            if (countWorkingMisc(MiscType.F_HARJEL_II, loc) &gt; 0) {</span>
<span class="nc" id="L3448">                armorMultiplier *= 1.1;</span>
            }
<span class="nc bnc" id="L3450" title="All 2 branches missed.">            if (countWorkingMisc(MiscType.F_HARJEL_III, loc) &gt; 0) {</span>
<span class="nc" id="L3451">                armorMultiplier *= 1.2;</span>
            }

            // BV for torso mounted cockpit.
<span class="nc bnc" id="L3455" title="All 4 branches missed.">            if ((getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED)</span>
                    &amp;&amp; (loc == LOC_CT)) {
<span class="nc" id="L3457">                bvText.append(startRow);</span>
<span class="nc" id="L3458">                bvText.append(startColumn);</span>
<span class="nc" id="L3459">                double cockpitArmor = this.getArmor(Mech.LOC_CT)</span>
<span class="nc" id="L3460">                        + this.getArmor(Mech.LOC_CT, true);</span>
<span class="nc" id="L3461">                cockpitArmor *= armorMultiplier;</span>
<span class="nc" id="L3462">                bvText.append(&quot;extra BV for torso mounted cockpit&quot;);</span>
<span class="nc" id="L3463">                bvText.append(endColumn);</span>
<span class="nc" id="L3464">                bvText.append(startColumn);</span>
<span class="nc" id="L3465">                bvText.append(cockpitArmor);</span>
<span class="nc" id="L3466">                bvText.append(endColumn);</span>
<span class="nc" id="L3467">                bvText.append(endRow);</span>
<span class="nc" id="L3468">                dbv += cockpitArmor;</span>
            }
<span class="nc" id="L3470">            int modularArmor = 0;</span>
<span class="nc bnc" id="L3471" title="All 2 branches missed.">            for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L3472" title="All 2 branches missed.">                if (mounted.getType().hasFlag(MiscType.F_MODULAR_ARMOR)</span>
<span class="nc bnc" id="L3473" title="All 2 branches missed.">                        &amp;&amp; (mounted.getLocation() == loc)) {</span>
<span class="nc" id="L3474">                    modularArmor += mounted.getBaseDamageCapacity()</span>
<span class="nc" id="L3475">                            - mounted.getDamageTaken();</span>
                }
<span class="nc" id="L3477">            }</span>
<span class="nc" id="L3478">            int armor = getArmor(loc)</span>
<span class="nc bnc" id="L3479" title="All 2 branches missed.">                    + (hasRearArmor(loc) ? getArmor(loc, true) : 0);</span>

<span class="nc" id="L3481">            bvText.append(startRow);</span>
<span class="nc" id="L3482">            bvText.append(startColumn);</span>
<span class="nc" id="L3483">            bvText.append(&quot;Total Armor &quot;</span>
<span class="nc" id="L3484">                    + this.getLocationAbbr(loc)</span>
                    + &quot; (&quot;
                    + armor
<span class="nc bnc" id="L3487" title="All 2 branches missed.">                    + (modularArmor &gt; 0 ? &quot; +&quot; + modularArmor + &quot; modular&quot; : &quot;&quot;)</span>
                    + &quot;) x &quot;);
<span class="nc" id="L3489">            bvText.append(armorMultiplier);</span>
<span class="nc" id="L3490">            bvText.append(endColumn);</span>
<span class="nc" id="L3491">            bvText.append(startColumn);</span>
<span class="nc" id="L3492">            double armorBV = (armor + modularArmor) * armorMultiplier;</span>
<span class="nc" id="L3493">            dbv += armorBV;</span>
<span class="nc" id="L3494">            bvText.append(armorBV);</span>
<span class="nc" id="L3495">            bvText.append(endColumn);</span>
<span class="nc" id="L3496">            bvText.append(endRow);</span>
        }
<span class="nc" id="L3498">        bvText.append(startRow);</span>
<span class="nc" id="L3499">        bvText.append(startColumn);</span>
<span class="nc" id="L3500">        bvText.append(&quot;Total modified armor BV x 2.5 &quot;);</span>
<span class="nc" id="L3501">        bvText.append(endColumn);</span>
<span class="nc" id="L3502">        bvText.append(startColumn);</span>
<span class="nc" id="L3503">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L3504">        dbv *= 2.5;</span>
<span class="nc" id="L3505">        bvText.append(dbv);</span>
<span class="nc" id="L3506">        bvText.append(endColumn);</span>
<span class="nc" id="L3507">        bvText.append(endRow);</span>

        // total internal structure
<span class="nc" id="L3510">        double internalMultiplier = 1.0;</span>
<span class="nc bnc" id="L3511" title="All 2 branches missed.">        if ((getStructureType() == EquipmentType.T_STRUCTURE_INDUSTRIAL)</span>
<span class="nc bnc" id="L3512" title="All 2 branches missed.">                || (getStructureType() == EquipmentType.T_STRUCTURE_COMPOSITE)) {</span>
<span class="nc" id="L3513">            internalMultiplier = 0.5;</span>
<span class="nc bnc" id="L3514" title="All 2 branches missed.">        } else if (getStructureType() == EquipmentType.T_STRUCTURE_REINFORCED) {</span>
<span class="nc" id="L3515">            internalMultiplier = 2.0;</span>
        }
<span class="nc bnc" id="L3517" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L3518">            internalMultiplier += 0.2;</span>
        }

<span class="nc" id="L3521">        dbv += getTotalInternal() * internalMultiplier * 1.5</span>
<span class="nc bnc" id="L3522" title="All 2 branches missed.">                * (hasEngine() ? getEngine().getBVMultiplier() : 1.0);</span>

<span class="nc" id="L3524">        bvText.append(startRow);</span>
<span class="nc" id="L3525">        bvText.append(startColumn);</span>
<span class="nc" id="L3526">        bvText.append(&quot;Total I.S. Points x IS Multipler x 1.5 x Engine Multipler&quot;);</span>

<span class="nc" id="L3528">        bvText.append(endColumn + startColumn);</span>
<span class="nc" id="L3529">        bvText.append(getTotalInternal());</span>
<span class="nc" id="L3530">        bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L3531">        bvText.append(internalMultiplier);</span>
<span class="nc" id="L3532">        bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L3533">        bvText.append(&quot;1.5 x &quot;);</span>
<span class="nc bnc" id="L3534" title="All 2 branches missed.">        bvText.append(hasEngine() ? getEngine().getBVMultiplier() : 1.0);</span>
<span class="nc" id="L3535">        bvText.append(endColumn);</span>
<span class="nc" id="L3536">        bvText.append(startColumn);</span>

<span class="nc" id="L3538">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L3539">        bvText.append(getTotalInternal() * internalMultiplier * 1.5</span>
<span class="nc bnc" id="L3540" title="All 2 branches missed.">                * (hasEngine() ? getEngine().getBVMultiplier() : 1.0));</span>
<span class="nc" id="L3541">        bvText.append(endColumn);</span>
<span class="nc" id="L3542">        bvText.append(endRow);</span>

        // add gyro
<span class="nc" id="L3545">        dbv += getWeight() * getGyroMultiplier();</span>

<span class="nc" id="L3547">        bvText.append(startRow);</span>
<span class="nc" id="L3548">        bvText.append(startColumn);</span>

<span class="nc" id="L3550">        bvText.append(&quot;Weight x Gyro Multipler &quot;);</span>
<span class="nc" id="L3551">        bvText.append(endColumn + startColumn);</span>
<span class="nc" id="L3552">        bvText.append(getWeight());</span>
<span class="nc" id="L3553">        bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L3554">        bvText.append(getGyroMultiplier());</span>
<span class="nc" id="L3555">        bvText.append(endColumn);</span>
<span class="nc" id="L3556">        bvText.append(startColumn);</span>

<span class="nc" id="L3558">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L3559">        bvText.append(getWeight() * getGyroMultiplier());</span>
<span class="nc" id="L3560">        bvText.append(endColumn);</span>
<span class="nc" id="L3561">        bvText.append(endRow);</span>

<span class="nc" id="L3563">        bvText.append(startRow);</span>
<span class="nc" id="L3564">        bvText.append(startColumn);</span>

<span class="nc" id="L3566">        bvText.append(&quot;Defensive Equipment:&quot;);</span>
<span class="nc" id="L3567">        bvText.append(endColumn);</span>
<span class="nc" id="L3568">        bvText.append(startColumn);</span>
<span class="nc" id="L3569">        bvText.append(endColumn);</span>
<span class="nc" id="L3570">        bvText.append(startColumn);</span>

<span class="nc" id="L3572">        bvText.append(endColumn);</span>
<span class="nc" id="L3573">        bvText.append(endRow);</span>
<span class="nc" id="L3574">        double amsAmmoBV = 0;</span>
<span class="nc bnc" id="L3575" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L3576">            AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L3577" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_AMS) || (atype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L3578">                amsAmmoBV += atype.getBV(this);</span>
            }
<span class="nc" id="L3580">        }</span>
<span class="nc" id="L3581">        double amsBV = 0;</span>
        // add defensive equipment
<span class="nc" id="L3583">        double dEquipmentBV = 0;</span>
<span class="nc bnc" id="L3584" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L3585">            EquipmentType etype = mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L3588" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L3589">                continue;</span>
            }

<span class="nc bnc" id="L3592" title="All 2 branches missed.">            if (((etype instanceof WeaponType) &amp;&amp; (etype</span>
<span class="nc bnc" id="L3593" title="All 2 branches missed.">                    .hasFlag(WeaponType.F_AMS)</span>
<span class="nc bnc" id="L3594" title="All 2 branches missed.">                    || etype.hasFlag(WeaponType.F_M_POD) || etype</span>
<span class="nc bnc" id="L3595" title="All 4 branches missed.">                        .hasFlag(WeaponType.F_B_POD)))</span>
                    || ((etype instanceof MiscType) &amp;&amp; (etype
<span class="nc bnc" id="L3597" title="All 2 branches missed.">                            .hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L3598" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L3599" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_VIRAL_JAMMER_DECOY)</span>
<span class="nc bnc" id="L3600" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_VIRAL_JAMMER_HOMING)</span>
<span class="nc bnc" id="L3601" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_AP_POD)</span>
<span class="nc bnc" id="L3602" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_MASS)</span>
<span class="nc bnc" id="L3603" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L3604" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L3605" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L3606" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_CHAFF_POD)</span>
<span class="nc bnc" id="L3607" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_HARJEL_II)</span>
<span class="nc bnc" id="L3608" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_HARJEL_III)</span>
<span class="nc bnc" id="L3609" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_SPIKES) || (etype</span>
<span class="nc bnc" id="L3610" title="All 2 branches missed.">                            .hasFlag(MiscType.F_CLUB) &amp;&amp; (etype</span>
<span class="nc bnc" id="L3611" title="All 2 branches missed.">                            .hasSubType(MiscType.S_SHIELD_LARGE)</span>
<span class="nc bnc" id="L3612" title="All 2 branches missed.">                            || etype.hasSubType(MiscType.S_SHIELD_MEDIUM) || etype</span>
<span class="nc bnc" id="L3613" title="All 2 branches missed.">                                .hasSubType(MiscType.S_SHIELD_SMALL)))))) {</span>
<span class="nc" id="L3614">                double bv = etype.getBV(this);</span>
<span class="nc bnc" id="L3615" title="All 2 branches missed.">                if (etype instanceof WeaponType) {</span>
<span class="nc" id="L3616">                    WeaponType wtype = (WeaponType) etype;</span>
<span class="nc bnc" id="L3617" title="All 2 branches missed.">                    if (wtype.hasFlag(WeaponType.F_AMS)</span>
<span class="nc bnc" id="L3618" title="All 4 branches missed.">                            &amp;&amp; ((wtype.getAmmoType() == AmmoType.T_AMS) || (wtype.getAmmoType() == AmmoType.T_APDS))) {</span>
<span class="nc" id="L3619">                        amsBV += bv;</span>
                    }
                }
<span class="nc" id="L3622">                dEquipmentBV += bv;</span>
<span class="nc" id="L3623">                bvText.append(startRow);</span>
<span class="nc" id="L3624">                bvText.append(startColumn);</span>

<span class="nc" id="L3626">                bvText.append(mounted.getName());</span>
<span class="nc" id="L3627">                bvText.append(endColumn);</span>
<span class="nc" id="L3628">                bvText.append(startColumn);</span>
<span class="nc" id="L3629">                bvText.append(endColumn);</span>
<span class="nc" id="L3630">                bvText.append(startColumn);</span>

<span class="nc" id="L3632">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L3633">                bvText.append(bv);</span>
<span class="nc" id="L3634">                bvText.append(endColumn);</span>
<span class="nc" id="L3635">                bvText.append(endRow);</span>
            }
<span class="nc" id="L3637">        }</span>
<span class="nc bnc" id="L3638" title="All 2 branches missed.">        if (amsAmmoBV &gt; 0) {</span>
<span class="nc" id="L3639">            bvText.append(startRow);</span>
<span class="nc" id="L3640">            bvText.append(startColumn);</span>

<span class="nc" id="L3642">            bvText.append(&quot;AMS Ammo (to a maximum of AMS BV)&quot;);</span>
<span class="nc" id="L3643">            bvText.append(endColumn);</span>
<span class="nc" id="L3644">            bvText.append(startColumn);</span>
<span class="nc" id="L3645">            bvText.append(endColumn);</span>
<span class="nc" id="L3646">            bvText.append(startColumn);</span>
<span class="nc" id="L3647">            bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L3648">            bvText.append(Math.min(amsBV, amsAmmoBV));</span>
<span class="nc" id="L3649">            bvText.append(endColumn);</span>
<span class="nc" id="L3650">            bvText.append(endRow);</span>
<span class="nc" id="L3651">            dEquipmentBV += Math.min(amsBV, amsAmmoBV);</span>
        }

<span class="nc" id="L3654">        dbv += dEquipmentBV;</span>

<span class="nc" id="L3656">        bvText.append(startRow);</span>
<span class="nc" id="L3657">        bvText.append(startColumn);</span>

<span class="nc" id="L3659">        double armoredBVCal = getArmoredComponentBV();</span>

<span class="nc bnc" id="L3661" title="All 2 branches missed.">        if (armoredBVCal &gt; 0) {</span>
<span class="nc" id="L3662">            bvText.append(&quot;Armored Components BV Modification&quot;);</span>
<span class="nc" id="L3663">            bvText.append(endColumn);</span>
<span class="nc" id="L3664">            bvText.append(startColumn);</span>
<span class="nc" id="L3665">            bvText.append(endColumn);</span>
<span class="nc" id="L3666">            bvText.append(startColumn);</span>

<span class="nc" id="L3668">            bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L3669">            bvText.append(armoredBVCal);</span>
<span class="nc" id="L3670">            bvText.append(endColumn);</span>
<span class="nc" id="L3671">            bvText.append(endRow);</span>
<span class="nc" id="L3672">            dbv += armoredBVCal;</span>
        }

<span class="nc" id="L3675">        bvText.append(&quot;Total BV of all Defensive Equipment &quot;);</span>
<span class="nc" id="L3676">        bvText.append(endColumn);</span>
<span class="nc" id="L3677">        bvText.append(startColumn);</span>
<span class="nc" id="L3678">        bvText.append(endColumn);</span>
<span class="nc" id="L3679">        bvText.append(startColumn);</span>

<span class="nc" id="L3681">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L3682">        bvText.append(dEquipmentBV);</span>
<span class="nc" id="L3683">        bvText.append(endColumn);</span>
<span class="nc" id="L3684">        bvText.append(endRow);</span>

        // subtract for explosive ammo
<span class="nc" id="L3687">        double ammoPenalty = 0;</span>
<span class="nc bnc" id="L3688" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L3689">            int loc = mounted.getLocation();</span>
<span class="nc" id="L3690">            int toSubtract = 15;</span>
<span class="nc" id="L3691">            EquipmentType etype = mounted.getType();</span>

            // only count explosive ammo
<span class="nc bnc" id="L3694" title="All 2 branches missed.">            if (!etype.isExplosive(mounted, true)) {</span>
<span class="nc" id="L3695">                continue;</span>
            }

            // don't count oneshot ammo
<span class="nc bnc" id="L3699" title="All 2 branches missed.">            if (loc == LOC_NONE) {</span>
<span class="nc" id="L3700">                continue;</span>
            }

<span class="nc bnc" id="L3703" title="All 4 branches missed.">            if (!hasExplosiveEquipmentPenalty(loc) &amp;&amp; !hasExplosiveEquipmentPenalty(mounted.getSecondLocation())) {</span>
<span class="nc" id="L3704">                continue;</span>
            }

            // gauss rifles only subtract 1 point per slot, same for HVACs and
            // iHeavy Lasers and mektasers
<span class="nc bnc" id="L3709" title="All 16 branches missed.">            if ((etype instanceof GaussWeapon) || (etype instanceof HVACWeapon)</span>
                    || (etype instanceof CLImprovedHeavyLaserLarge)
                    || (etype instanceof CLImprovedHeavyLaserMedium)
                    || (etype instanceof CLImprovedHeavyLaserSmall)
                    || (etype instanceof ISRISCHyperLaser)
                    || (etype instanceof TSEMPWeapon)
                    || (etype instanceof ISMekTaser)
<span class="nc bnc" id="L3716" title="All 2 branches missed.">                    || (etype.hasFlag(WeaponType.F_B_POD)</span>
<span class="nc bnc" id="L3717" title="All 2 branches missed.">                    || (etype.hasFlag(WeaponType.F_M_POD)))) {</span>
<span class="nc" id="L3718">                toSubtract = 1;</span>
            }

         // PPCs with capacitors subtract 1
<span class="nc bnc" id="L3722" title="All 2 branches missed.">            if (etype instanceof PPCWeapon) {</span>
<span class="nc bnc" id="L3723" title="All 2 branches missed.">                if (mounted.getLinkedBy() != null) {</span>
<span class="nc" id="L3724">                    toSubtract = 1;</span>
                } else {
                    continue;
                }
            }
<span class="nc bnc" id="L3729" title="All 2 branches missed.">            if ((etype instanceof MiscType)</span>
<span class="nc bnc" id="L3730" title="All 2 branches missed.">                    &amp;&amp; (etype.hasFlag(MiscType.F_PPC_CAPACITOR)</span>
<span class="nc bnc" id="L3731" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)</span>
<span class="nc bnc" id="L3732" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)</span>
<span class="nc bnc" id="L3733" title="All 2 branches missed.">                            || etype.hasFlag(MiscType.F_JUMP_JET))) {</span>
<span class="nc" id="L3734">                toSubtract = 1;</span>
            }

<span class="nc bnc" id="L3737" title="All 2 branches missed.">            if (etype instanceof AmmoType</span>
<span class="nc bnc" id="L3738" title="All 2 branches missed.">                    &amp;&amp; ((AmmoType)mounted.getType()).getAmmoType() == AmmoType.T_COOLANT_POD) {</span>
<span class="nc" id="L3739">                toSubtract = 1;</span>
            }


<span class="nc bnc" id="L3743" title="All 2 branches missed.">            if ((etype instanceof MiscType)</span>
<span class="nc bnc" id="L3744" title="All 2 branches missed.">                    &amp;&amp; etype.hasFlag(MiscType.F_BLUE_SHIELD)) {</span>
                // blue shield needs to be special cased, because it's one
                // mounted with lots of locations,
                // and some of those could be proteced by cas
<span class="nc" id="L3748">                toSubtract = 0;</span>
            }

            // RACs, LACs and ACs don't really count
<span class="nc bnc" id="L3752" title="All 4 branches missed.">            if ((etype instanceof WeaponType) &amp;&amp; ((((WeaponType) etype).getAmmoType() == AmmoType.T_AC_ROTARY)</span>
<span class="nc bnc" id="L3753" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_AC)</span>
<span class="nc bnc" id="L3754" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_LAC)</span>
<span class="nc bnc" id="L3755" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L3756" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_AC_PRIMITIVE)</span>
<span class="nc bnc" id="L3757" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_PAC))) {</span>
<span class="nc" id="L3758">                toSubtract = 0;</span>
            }

            // empty ammo shouldn't count
<span class="nc bnc" id="L3762" title="All 2 branches missed.">            if ((etype instanceof AmmoType)</span>
<span class="nc bnc" id="L3763" title="All 2 branches missed.">                    &amp;&amp; (mounted.getUsableShotsLeft() == 0)) {</span>
<span class="nc" id="L3764">                continue;</span>
            }

            // we subtract per critical slot
            int criticals;
<span class="nc bnc" id="L3769" title="All 2 branches missed.">            if (mounted.isSplit()) {</span>
<span class="nc" id="L3770">                criticals = 0;</span>
<span class="nc bnc" id="L3771" title="All 2 branches missed.">                for (int l = 0; l &lt; locations(); l++) {</span>
<span class="nc bnc" id="L3772" title="All 4 branches missed.">                    if (((l == mounted.getLocation()) || (l == mounted.getSecondLocation()))</span>
<span class="nc bnc" id="L3773" title="All 2 branches missed.">                            &amp;&amp; hasExplosiveEquipmentPenalty(l)) {</span>
<span class="nc bnc" id="L3774" title="All 2 branches missed.">                        for (int i = 0; i &lt; getNumberOfCriticals(l); i++) {</span>
<span class="nc" id="L3775">                            CriticalSlot slot = getCritical(l, i);</span>
<span class="nc bnc" id="L3776" title="All 4 branches missed.">                            if ((slot != null) &amp;&amp; mounted.equals(slot.getMount())) {</span>
<span class="nc" id="L3777">                                criticals++;</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L3782" title="All 2 branches missed.">            } else if (mounted.getType() instanceof HVACWeapon) {</span>
                // HVAC are only -1 total, regardless of number of crits. None are large enough to be splittable.
<span class="nc" id="L3784">                criticals = 1;</span>
            } else {
<span class="nc" id="L3786">                criticals = mounted.getCriticals();</span>
            }
<span class="nc" id="L3788">            toSubtract *= criticals;</span>
<span class="nc" id="L3789">            ammoPenalty += toSubtract;</span>
<span class="nc" id="L3790">        }</span>
        // special case for blueshield, need to check each non-head location
        // seperately for CASE
<span class="nc bnc" id="L3793" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L3794">            int unProtectedCrits = 0;</span>
<span class="nc bnc" id="L3795" title="All 2 branches missed.">            for (int loc = LOC_CT; loc &lt;= LOC_LLEG; loc++) {</span>
<span class="nc bnc" id="L3796" title="All 2 branches missed.">                if (hasCASEII(loc)) {</span>
<span class="nc" id="L3797">                    continue;</span>
                }
<span class="nc bnc" id="L3799" title="All 2 branches missed.">                if (isClan()) {</span>
                    // Clan mechs only count ammo in ct, legs or head (per
                    // BMRr).
                    // Also count ammo in side torsos if mech has xxl engine
                    // (extrapolated from rule intent - not covered in rules)
<span class="nc bnc" id="L3804" title="All 12 branches missed.">                    if (((loc != LOC_CT) &amp;&amp; (loc != LOC_RLEG)</span>
                            &amp;&amp; (loc != LOC_LLEG) &amp;&amp; (loc != LOC_HEAD))
<span class="nc bnc" id="L3806" title="All 2 branches missed.">                            &amp;&amp; !(((loc == LOC_RT) || (loc == LOC_LT)) &amp;&amp; hasEngine() &amp;&amp; (getEngine()</span>
<span class="nc bnc" id="L3807" title="All 2 branches missed.">                                    .getSideTorsoCriticalSlots().length &gt; 2))) {</span>
<span class="nc" id="L3808">                        continue;</span>
                    }
                } else {
                    // inner sphere with XL or XXL counts everywhere
<span class="nc bnc" id="L3812" title="All 4 branches missed.">                    if(hasEngine() &amp;&amp; (getEngine().getSideTorsoCriticalSlots().length &lt;= 2)) {</span>
                        // without XL or XXL, only count torsos if not CASEed,
                        // and arms if arm &amp; torso not CASEed
<span class="nc bnc" id="L3815" title="All 4 branches missed.">                        if (((loc == LOC_RT) || (loc == LOC_LT))</span>
<span class="nc bnc" id="L3816" title="All 2 branches missed.">                                &amp;&amp; locationHasCase(loc)) {</span>
<span class="nc" id="L3817">                            continue;</span>
<span class="nc bnc" id="L3818" title="All 2 branches missed.">                        } else if ((loc == LOC_LARM)</span>
<span class="nc bnc" id="L3819" title="All 4 branches missed.">                                &amp;&amp; (locationHasCase(loc) || locationHasCase(LOC_LT))) {</span>
<span class="nc" id="L3820">                            continue;</span>
<span class="nc bnc" id="L3821" title="All 2 branches missed.">                        } else if ((loc == LOC_RARM)</span>
<span class="nc bnc" id="L3822" title="All 4 branches missed.">                                &amp;&amp; (locationHasCase(loc) || locationHasCase(LOC_RT))) {</span>
<span class="nc" id="L3823">                            continue;</span>
                        }
                    }
                }
<span class="nc" id="L3827">                unProtectedCrits++;</span>
            }
<span class="nc" id="L3829">            ammoPenalty += unProtectedCrits;</span>
        }
<span class="nc" id="L3831">        dbv = Math.max(1, dbv - ammoPenalty);</span>

<span class="nc" id="L3833">        bvText.append(startRow);</span>
<span class="nc" id="L3834">        bvText.append(startColumn);</span>

<span class="nc" id="L3836">        bvText.append(&quot;Explosive Weapons/Equipment Penalty &quot;);</span>
<span class="nc" id="L3837">        bvText.append(endColumn);</span>
<span class="nc" id="L3838">        bvText.append(startColumn);</span>
<span class="nc" id="L3839">        bvText.append(endColumn);</span>
<span class="nc" id="L3840">        bvText.append(startColumn);</span>

<span class="nc" id="L3842">        bvText.append(&quot;= -&quot;);</span>
<span class="nc" id="L3843">        bvText.append(ammoPenalty);</span>
<span class="nc" id="L3844">        bvText.append(endColumn);</span>
<span class="nc" id="L3845">        bvText.append(endRow);</span>

<span class="nc" id="L3847">        bvText.append(startRow);</span>
<span class="nc" id="L3848">        bvText.append(startColumn);</span>
<span class="nc" id="L3849">        bvText.append(endColumn);</span>
<span class="nc" id="L3850">        bvText.append(startColumn);</span>
<span class="nc" id="L3851">        bvText.append(endColumn);</span>
<span class="nc" id="L3852">        bvText.append(startColumn);</span>

<span class="nc" id="L3854">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L3855">        bvText.append(endColumn);</span>
<span class="nc" id="L3856">        bvText.append(endRow);</span>

<span class="nc" id="L3858">        bvText.append(startRow);</span>
<span class="nc" id="L3859">        bvText.append(startColumn);</span>

<span class="nc" id="L3861">        bvText.append(endColumn);</span>
<span class="nc" id="L3862">        bvText.append(startColumn);</span>
<span class="nc" id="L3863">        bvText.append(endColumn);</span>
<span class="nc" id="L3864">        bvText.append(startColumn);</span>
<span class="nc" id="L3865">        bvText.append(dbv);</span>
<span class="nc" id="L3866">        bvText.append(endColumn);</span>
<span class="nc" id="L3867">        bvText.append(endRow);</span>

        // adjust for target movement modifier
        // we use full possible movement, ignoring gravity, heat and modular
        // armor, but taking into account hit actuators
<span class="nc" id="L3872">        int bvWalk = getWalkMP(false, true, true);</span>
<span class="nc" id="L3873">        int airmechMP = 0;</span>
<span class="nc bnc" id="L3874" title="All 2 branches missed.">        if (((getEntityType() &amp; ETYPE_LAND_AIR_MECH) != 0)) {</span>
<span class="nc" id="L3875">            bvWalk = ((LandAirMech)this).getBVWalkMP();</span>
<span class="nc bnc" id="L3876" title="All 2 branches missed.">            if (((LandAirMech)this).getLAMType() == LandAirMech.LAM_STANDARD) {</span>
<span class="nc" id="L3877">                airmechMP = ((LandAirMech)this).getAirMechFlankMP();</span>
            }
<span class="nc bnc" id="L3879" title="All 2 branches missed.">        } else if (((getEntityType() &amp; ETYPE_QUADVEE) != 0)</span>
<span class="nc bnc" id="L3880" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() == EntityMovementMode.WHEELED)) {</span>
            // Don't use bonus cruise MP in calculating BV
<span class="nc" id="L3882">            bvWalk = Math.max(0, walkMP);</span>
        }
        int runMP;
<span class="nc bnc" id="L3885" title="All 2 branches missed.">        if (hasTSM()) {</span>
<span class="nc" id="L3886">            bvWalk++;</span>
        }
<span class="nc bnc" id="L3888" title="All 2 branches missed.">        if (hasMASCAndSuperCharger()) {</span>
<span class="nc" id="L3889">            runMP = (int) Math.ceil(bvWalk * 2.5);</span>
<span class="nc bnc" id="L3890" title="All 2 branches missed.">        } else if (hasMASC()) {</span>
<span class="nc" id="L3891">            runMP = bvWalk * 2;</span>
        } else {
<span class="nc" id="L3893">            runMP = (int) Math.ceil(bvWalk * 1.5);</span>
        }
<span class="nc bnc" id="L3895" title="All 2 branches missed.">        if (hasMPReducingHardenedArmor()) {</span>
<span class="nc" id="L3896">            runMP--;</span>
        }
<span class="nc" id="L3898">        int tmmRan = Compute.getTargetMovementModifier(runMP, false, false,</span>
<span class="nc" id="L3899">                game).getValue();</span>
<span class="nc" id="L3900">        bvText.append(startRow);</span>
<span class="nc" id="L3901">        bvText.append(startColumn);</span>

<span class="nc" id="L3903">        bvText.append(&quot;Run MP&quot;);</span>
<span class="nc" id="L3904">        bvText.append(endColumn);</span>
<span class="nc" id="L3905">        bvText.append(startColumn);</span>
<span class="nc" id="L3906">        bvText.append(endColumn);</span>
<span class="nc" id="L3907">        bvText.append(startColumn);</span>

<span class="nc" id="L3909">        bvText.append(runMP);</span>
<span class="nc" id="L3910">        bvText.append(endColumn);</span>
<span class="nc" id="L3911">        bvText.append(endRow);</span>

<span class="nc" id="L3913">        bvText.append(startRow);</span>
<span class="nc" id="L3914">        bvText.append(startColumn);</span>

<span class="nc" id="L3916">        bvText.append(&quot;Target Movement Modifier For Run&quot;);</span>
<span class="nc" id="L3917">        bvText.append(endColumn);</span>
<span class="nc" id="L3918">        bvText.append(startColumn);</span>
<span class="nc" id="L3919">        bvText.append(endColumn);</span>
<span class="nc" id="L3920">        bvText.append(startColumn);</span>

<span class="nc" id="L3922">        bvText.append(tmmRan);</span>
<span class="nc" id="L3923">        bvText.append(endColumn);</span>
<span class="nc" id="L3924">        bvText.append(endRow);</span>

        // Calculate modifiers for jump and UMU movement where applicable.
<span class="nc" id="L3927">        final int jumpMP = Math.max(getJumpMP(false, true), airmechMP);</span>
<span class="nc bnc" id="L3928" title="All 2 branches missed.">        final int tmmJumped = (jumpMP &gt; 0) ? Compute.</span>
<span class="nc" id="L3929">                getTargetMovementModifier(jumpMP, true, false, game).getValue()</span>
<span class="nc" id="L3930">                : 0;</span>

<span class="nc" id="L3932">        final int umuMP = getActiveUMUCount();</span>
<span class="nc bnc" id="L3933" title="All 2 branches missed.">        final int tmmUMU = (umuMP &gt; 0) ? Compute.</span>
<span class="nc" id="L3934">                getTargetMovementModifier(umuMP, false, false, game).getValue()</span>
<span class="nc" id="L3935">                : 0;</span>

<span class="nc" id="L3937">        bvText.append(startRow);</span>
<span class="nc" id="L3938">        bvText.append(startColumn);</span>

<span class="nc bnc" id="L3940" title="All 2 branches missed.">        if (airmechMP == 0) {</span>
<span class="nc" id="L3941">            bvText.append(&quot;Target Movement Modifier For Jumping&quot;);</span>
        } else {
<span class="nc" id="L3943">            bvText.append(&quot;Target Movement Modifier For AirMech Flank&quot;);</span>
        }
<span class="nc" id="L3945">        bvText.append(endColumn);</span>
<span class="nc" id="L3946">        bvText.append(startColumn);</span>
<span class="nc" id="L3947">        bvText.append(endColumn);</span>
<span class="nc" id="L3948">        bvText.append(startColumn);</span>

<span class="nc" id="L3950">        bvText.append(tmmJumped);</span>
<span class="nc" id="L3951">        bvText.append(endColumn);</span>
<span class="nc" id="L3952">        bvText.append(endRow);</span>

<span class="nc" id="L3954">        bvText.append(&quot;Target Movement Modifier For UMUs&quot;);</span>
<span class="nc" id="L3955">        bvText.append(endColumn);</span>
<span class="nc" id="L3956">        bvText.append(startColumn);</span>
<span class="nc" id="L3957">        bvText.append(endColumn);</span>
<span class="nc" id="L3958">        bvText.append(startColumn);</span>

<span class="nc" id="L3960">        bvText.append(tmmUMU);</span>
<span class="nc" id="L3961">        bvText.append(endColumn);</span>
<span class="nc" id="L3962">        bvText.append(endRow);</span>

<span class="nc" id="L3964">        double targetMovementModifier = Math.max(tmmRan, Math.max(tmmJumped,</span>
                tmmUMU));

<span class="nc" id="L3967">        bvText.append(startRow);</span>
<span class="nc" id="L3968">        bvText.append(startColumn);</span>

<span class="nc" id="L3970">        bvText.append(&quot;Target Movement Modifier&quot;);</span>
<span class="nc" id="L3971">        bvText.append(endColumn);</span>
<span class="nc" id="L3972">        bvText.append(startColumn);</span>
<span class="nc" id="L3973">        bvText.append(endColumn);</span>
<span class="nc" id="L3974">        bvText.append(startColumn);</span>

<span class="nc" id="L3976">        bvText.append(targetMovementModifier);</span>
<span class="nc" id="L3977">        bvText.append(endColumn);</span>
<span class="nc" id="L3978">        bvText.append(endRow);</span>

        // Try to find a Mek Stealth or similar system.
<span class="nc bnc" id="L3981" title="All 4 branches missed.">        if (hasStealth() || hasNullSig()) {</span>
<span class="nc" id="L3982">            targetMovementModifier += 2;</span>
<span class="nc" id="L3983">            bvText.append(startRow);</span>
<span class="nc" id="L3984">            bvText.append(startColumn);</span>

<span class="nc" id="L3986">            bvText.append(&quot;Stealth +2&quot;);</span>
<span class="nc" id="L3987">            bvText.append(endColumn);</span>
<span class="nc" id="L3988">            bvText.append(startColumn);</span>

<span class="nc" id="L3990">            bvText.append(endColumn);</span>
<span class="nc" id="L3991">            bvText.append(startColumn);</span>

<span class="nc" id="L3993">            bvText.append(&quot;+2&quot;);</span>
<span class="nc" id="L3994">            bvText.append(endColumn);</span>
<span class="nc" id="L3995">            bvText.append(endRow);</span>

        }
<span class="nc bnc" id="L3998" title="All 2 branches missed.">        if (hasChameleonShield()) {</span>
<span class="nc" id="L3999">            targetMovementModifier += 2;</span>
<span class="nc" id="L4000">            bvText.append(startRow);</span>
<span class="nc" id="L4001">            bvText.append(startColumn);</span>

<span class="nc" id="L4003">            bvText.append(&quot;Chameleon +2&quot;);</span>
<span class="nc" id="L4004">            bvText.append(endColumn);</span>
<span class="nc" id="L4005">            bvText.append(startColumn);</span>
<span class="nc" id="L4006">            bvText.append(endColumn);</span>
<span class="nc" id="L4007">            bvText.append(startColumn);</span>

<span class="nc" id="L4009">            bvText.append(&quot;+2&quot;);</span>
<span class="nc" id="L4010">            bvText.append(endColumn);</span>
<span class="nc" id="L4011">            bvText.append(endRow);</span>

        }
<span class="nc bnc" id="L4014" title="All 2 branches missed.">        if (hasVoidSig()) {</span>
<span class="nc" id="L4015">            bvText.append(startRow);</span>
<span class="nc" id="L4016">            bvText.append(startColumn);</span>

<span class="nc" id="L4018">            bvText.append(&quot;Void Sig&quot;);</span>
<span class="nc" id="L4019">            bvText.append(endColumn);</span>
<span class="nc" id="L4020">            bvText.append(startColumn);</span>

<span class="nc" id="L4022">            bvText.append(endColumn);</span>
<span class="nc" id="L4023">            bvText.append(startColumn);</span>

<span class="nc bnc" id="L4025" title="All 2 branches missed.">            if (targetMovementModifier &lt; 3) {</span>
<span class="nc" id="L4026">                targetMovementModifier = 3;</span>
<span class="nc" id="L4027">                bvText.append(&quot;3&quot;);</span>
<span class="nc bnc" id="L4028" title="All 2 branches missed.">            } else if (targetMovementModifier == 3) {</span>
<span class="nc" id="L4029">                targetMovementModifier++;</span>
<span class="nc" id="L4030">                bvText.append(&quot;+1&quot;);</span>
            } else {
<span class="nc" id="L4032">                bvText.append(&quot;-&quot;);</span>
            }

<span class="nc" id="L4035">            bvText.append(endColumn);</span>
<span class="nc" id="L4036">            bvText.append(endRow);</span>
        }
<span class="nc" id="L4038">        double tmmFactor = 1 + (targetMovementModifier / 10);</span>
<span class="nc" id="L4039">        dbv *= tmmFactor;</span>

<span class="nc" id="L4041">        bvText.append(startRow);</span>
<span class="nc" id="L4042">        bvText.append(startColumn);</span>
<span class="nc" id="L4043">        bvText.append(&quot;Multiply by Defensive Movement Factor of &quot;);</span>
<span class="nc" id="L4044">        bvText.append(endColumn);</span>
<span class="nc" id="L4045">        bvText.append(startColumn);</span>

<span class="nc" id="L4047">        bvText.append(tmmFactor);</span>
<span class="nc" id="L4048">        bvText.append(endColumn);</span>
<span class="nc" id="L4049">        bvText.append(startColumn);</span>
<span class="nc" id="L4050">        bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L4051">        bvText.append(tmmFactor);</span>
<span class="nc" id="L4052">        bvText.append(endColumn);</span>
<span class="nc" id="L4053">        bvText.append(endRow);</span>

<span class="nc" id="L4055">        bvText.append(startRow);</span>
<span class="nc" id="L4056">        bvText.append(startColumn);</span>
<span class="nc" id="L4057">        bvText.append(endColumn);</span>
<span class="nc" id="L4058">        bvText.append(startColumn);</span>
<span class="nc" id="L4059">        bvText.append(endColumn);</span>
<span class="nc" id="L4060">        bvText.append(startColumn);</span>

<span class="nc" id="L4062">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L4063">        bvText.append(endColumn);</span>
<span class="nc" id="L4064">        bvText.append(endRow);</span>

<span class="nc" id="L4066">        bvText.append(startRow);</span>
<span class="nc" id="L4067">        bvText.append(startColumn);</span>

<span class="nc" id="L4069">        bvText.append(&quot;Defensive Battle Value&quot;);</span>
<span class="nc" id="L4070">        bvText.append(endColumn);</span>
<span class="nc" id="L4071">        bvText.append(startColumn);</span>
<span class="nc" id="L4072">        bvText.append(endColumn);</span>
<span class="nc" id="L4073">        bvText.append(startColumn);</span>

<span class="nc" id="L4075">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L4076">        bvText.append(dbv);</span>
<span class="nc" id="L4077">        bvText.append(endColumn);</span>
<span class="nc" id="L4078">        bvText.append(endRow);</span>

<span class="nc" id="L4080">        bvText.append(startRow);</span>
<span class="nc" id="L4081">        bvText.append(startColumn);</span>

<span class="nc" id="L4083">        bvText.append(endColumn);</span>
<span class="nc" id="L4084">        bvText.append(startColumn);</span>
<span class="nc" id="L4085">        bvText.append(endColumn);</span>
<span class="nc" id="L4086">        bvText.append(startColumn);</span>
<span class="nc" id="L4087">        bvText.append(endColumn);</span>
<span class="nc" id="L4088">        bvText.append(endRow);</span>

<span class="nc" id="L4090">        bvText.append(startRow);</span>
<span class="nc" id="L4091">        bvText.append(startColumn);</span>

<span class="nc" id="L4093">        bvText.append(&quot;&lt;b&gt;Offensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L4094">        bvText.append(endColumn);</span>
<span class="nc" id="L4095">        bvText.append(startColumn);</span>
<span class="nc" id="L4096">        bvText.append(endColumn);</span>
<span class="nc" id="L4097">        bvText.append(startColumn);</span>
<span class="nc" id="L4098">        bvText.append(endColumn);</span>
<span class="nc" id="L4099">        bvText.append(endRow);</span>
        // calculate heat efficiency
<span class="nc" id="L4101">        int mechHeatEfficiency = 6 + getHeatCapacity();</span>
<span class="nc bnc" id="L4102" title="All 4 branches missed.">        if ((this instanceof LandAirMech) &amp;&amp; (((LandAirMech) this).getLAMType() == LandAirMech.LAM_STANDARD)) {</span>
<span class="nc" id="L4103">            mechHeatEfficiency += 3;</span>
        }

<span class="nc" id="L4106">        bvText.append(startRow);</span>
<span class="nc" id="L4107">        bvText.append(startColumn);</span>

<span class="nc" id="L4109">        bvText.append(&quot;Base Heat Efficiency &quot;);</span>

<span class="nc" id="L4111">        double coolantPods = 0;</span>
<span class="nc bnc" id="L4112" title="All 2 branches missed.">        for (Mounted ammo : getAmmo()) {</span>
<span class="nc bnc" id="L4113" title="All 2 branches missed.">            if (((AmmoType) ammo.getType()).getAmmoType() == AmmoType.T_COOLANT_POD) {</span>
<span class="nc" id="L4114">                coolantPods++;</span>
            }
<span class="nc" id="L4116">        }</span>

        // account for coolant pods
<span class="nc bnc" id="L4119" title="All 2 branches missed.">        if (coolantPods &gt; 0) {</span>
<span class="nc" id="L4120">            mechHeatEfficiency += Math</span>
<span class="nc" id="L4121">                    .ceil((getNumberOfSinks() * coolantPods) / 5);</span>
<span class="nc" id="L4122">            bvText.append(&quot; + Coolant Pods &quot;);</span>
        }
<span class="nc bnc" id="L4124" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L4125">            mechHeatEfficiency += 4;</span>
<span class="nc" id="L4126">            bvText.append(&quot; + RISC Emergency Coolant System&quot;);</span>
        }

        int moveHeat;
<span class="nc bnc" id="L4130" title="All 4 branches missed.">        if ((this instanceof LandAirMech) &amp;&amp; (((LandAirMech) this).getLAMType()  == LandAirMech.LAM_STANDARD)) {</span>
<span class="nc" id="L4131">            moveHeat = (int) Math.round(((LandAirMech) this).getAirMechFlankMP(false, true) / 3.0);</span>
<span class="nc bnc" id="L4132" title="All 2 branches missed.">        } else if ((getJumpMP(false, true) &gt; 0)</span>
<span class="nc bnc" id="L4133" title="All 2 branches missed.">                &amp;&amp; (getJumpHeat(getJumpMP(false, true)) &gt; getRunHeat())) {</span>
<span class="nc" id="L4134">            moveHeat = getJumpHeat(getJumpMP(false, true));</span>
<span class="nc" id="L4135">            bvText.append(&quot; - Jump Heat &quot;);</span>
        } else {
<span class="nc" id="L4137">            moveHeat = getRunHeat();</span>
<span class="nc bnc" id="L4138" title="All 2 branches missed.">            if (hasSCM()) {</span>
<span class="nc" id="L4139">                moveHeat = 0;</span>
            }
<span class="nc" id="L4141">            bvText.append(&quot; - Run Heat &quot;);</span>
        }
<span class="nc" id="L4143">        mechHeatEfficiency -= moveHeat;</span>
<span class="nc bnc" id="L4144" title="All 2 branches missed.">        if (hasStealth()) {</span>
<span class="nc" id="L4145">            mechHeatEfficiency -= 10;</span>
<span class="nc" id="L4146">            bvText.append(&quot; - Stealth Heat &quot;);</span>
        }
<span class="nc bnc" id="L4148" title="All 2 branches missed.">        if (hasChameleonShield()) {</span>
<span class="nc" id="L4149">            mechHeatEfficiency -= 6;</span>
<span class="nc" id="L4150">            bvText.append(&quot; - Chameleon LPS Heat &quot;);</span>
        }
<span class="nc bnc" id="L4152" title="All 2 branches missed.">        if (hasNullSig()) {</span>
<span class="nc" id="L4153">            mechHeatEfficiency -= 10;</span>
<span class="nc" id="L4154">            bvText.append(&quot; - Null-signature system Heat &quot;);</span>
        }
<span class="nc bnc" id="L4156" title="All 2 branches missed.">        if (hasVoidSig()) {</span>
<span class="nc" id="L4157">            mechHeatEfficiency -= 10;</span>
<span class="nc" id="L4158">            bvText.append(&quot; - Void-signature system Heat &quot;);</span>
        }

<span class="nc" id="L4161">        bvText.append(endColumn);</span>
<span class="nc" id="L4162">        bvText.append(startColumn);</span>
<span class="nc" id="L4163">        bvText.append(6 + getHeatCapacity());</span>

<span class="nc bnc" id="L4165" title="All 2 branches missed.">        if (coolantPods &gt; 0) {</span>
<span class="nc" id="L4166">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L4167">            bvText.append(Math.ceil((getNumberOfSinks() * coolantPods) / 5));</span>
        }

<span class="nc bnc" id="L4170" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L4171">            mechHeatEfficiency += 4;</span>
<span class="nc" id="L4172">            bvText.append(&quot; + 4&quot;);</span>
        }

<span class="nc" id="L4175">        bvText.append(&quot; - &quot;).append(moveHeat);</span>
<span class="nc bnc" id="L4176" title="All 2 branches missed.">        if (hasStealth()) {</span>
<span class="nc" id="L4177">            bvText.append(&quot; - 10&quot;);</span>
        }

<span class="nc" id="L4180">        bvText.append(endColumn);</span>
<span class="nc" id="L4181">        bvText.append(startColumn);</span>

<span class="nc" id="L4183">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L4184">        bvText.append(mechHeatEfficiency);</span>
<span class="nc" id="L4185">        bvText.append(endColumn);</span>
<span class="nc" id="L4186">        bvText.append(endRow);</span>

<span class="nc" id="L4188">        bvText.append(startRow);</span>
<span class="nc" id="L4189">        bvText.append(startColumn);</span>
<span class="nc" id="L4190">        bvText.append(&quot;Unmodified Weapon BV:&quot;);</span>
<span class="nc" id="L4191">        bvText.append(endColumn);</span>
<span class="nc" id="L4192">        bvText.append(startColumn);</span>
<span class="nc" id="L4193">        bvText.append(endColumn);</span>
<span class="nc" id="L4194">        bvText.append(startColumn);</span>
<span class="nc" id="L4195">        bvText.append(endColumn);</span>
<span class="nc" id="L4196">        bvText.append(endRow);</span>

<span class="nc" id="L4198">        double weaponBV = 0;</span>
<span class="nc" id="L4199">        boolean hasTargComp = hasTargComp();</span>
        // first, add up front-faced and rear-faced unmodified BV,
        // to know wether front- or rear faced BV should be halved
<span class="nc" id="L4202">        double bvFront = 0, bvRear = 0, nonArmFront = 0, nonArmRear = 0, bvTurret = 0;</span>
<span class="nc" id="L4203">        ArrayList&lt;Mounted&gt; weapons = getWeaponList();</span>
<span class="nc bnc" id="L4204" title="All 2 branches missed.">        for (Mounted weapon : weapons) {</span>
<span class="nc" id="L4205">            WeaponType wtype = (WeaponType) weapon.getType();</span>
<span class="nc bnc" id="L4206" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_B_POD)</span>
<span class="nc bnc" id="L4207" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_M_POD)) {</span>
<span class="nc" id="L4208">                continue;</span>
            }
<span class="nc" id="L4210">            double dBV = wtype.getBV(this);</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L4213" title="All 2 branches missed.">            if (weapon.isDestroyed()) {</span>
<span class="nc" id="L4214">                continue;</span>
            }
            // don't count AMS, it's defensive
<span class="nc bnc" id="L4217" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L4218">                continue;</span>
            }
            // calc MG Array here:
<span class="nc bnc" id="L4221" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L4222">                double mgBV = 0;</span>
<span class="nc bnc" id="L4223" title="All 2 branches missed.">                for (int eqNum : weapon.getBayWeapons()) {</span>
<span class="nc" id="L4224">                    Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L4225" title="All 4 branches missed.">                    if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L4226">                        mgBV += mg.getType().getBV(this);</span>
                    }
<span class="nc" id="L4228">                }</span>
<span class="nc" id="L4229">                dBV = mgBV * 0.67;</span>
            }
<span class="nc" id="L4231">            String name = wtype.getName();</span>
            // artemis bumps up the value
            // PPC caps do, too
<span class="nc bnc" id="L4234" title="All 2 branches missed.">            if (weapon.getLinkedBy() != null) {</span>
                // check to see if the weapon is a PPC and has a Capacitor
                // attached to it
<span class="nc bnc" id="L4237" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_PPC)) {</span>
<span class="nc" id="L4238">                    dBV += ((MiscType) weapon.getLinkedBy().getType()).getBV(</span>
                            this, weapon);
<span class="nc" id="L4240">                    name = name.concat(&quot; with Capacitor&quot;);</span>
                }
<span class="nc" id="L4242">                Mounted mLinker = weapon.getLinkedBy();</span>
<span class="nc bnc" id="L4243" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4244" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</span>
<span class="nc" id="L4245">                    dBV *= 1.2;</span>
<span class="nc" id="L4246">                    name = name.concat(&quot; with Artemis IV&quot;);</span>
                }
<span class="nc bnc" id="L4248" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4249" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_PROTO)) {</span>
<span class="nc" id="L4250">                    dBV *= 1.2;</span>
<span class="nc" id="L4251">                    name = name.concat(&quot; with Artemis IV Prototype&quot;);</span>
                }
<span class="nc bnc" id="L4253" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4254" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</span>
<span class="nc" id="L4255">                    dBV *= 1.3;</span>
<span class="nc" id="L4256">                    name = name.concat(&quot; with Artemis V&quot;);</span>
                }
<span class="nc bnc" id="L4258" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4259" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</span>
<span class="nc" id="L4260">                    dBV *= 1.15;</span>
<span class="nc" id="L4261">                    name = name.concat(&quot; with Apollo&quot;);</span>
                }
<span class="nc bnc" id="L4263" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4264" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L4265">                    dBV *= 1.15;</span>
<span class="nc" id="L4266">                    name = name.concat(&quot; with RISC Laser Pulse Module&quot;);</span>
                }
            }

<span class="nc bnc" id="L4270" title="All 2 branches missed.">            if (hasFunctionalArmAES(weapon.getLocation())) {</span>
<span class="nc" id="L4271">                dBV *= 1.25;</span>
<span class="nc" id="L4272">                name = name.concat(&quot; augmented by AES&quot;);</span>
            }

<span class="nc" id="L4275">            bvText.append(startRow);</span>
<span class="nc" id="L4276">            bvText.append(startColumn);</span>

<span class="nc" id="L4278">            bvText.append(name);</span>
<span class="nc" id="L4279">            boolean rearVGL = false;</span>
<span class="nc bnc" id="L4280" title="All 2 branches missed.">            if (weapon.getType().hasFlag(WeaponType.F_VGL)) {</span>
                // vehicular grenade launchers facing to the rear sides count
                // for rear BV, too
<span class="nc bnc" id="L4283" title="All 4 branches missed.">                if ((weapon.getFacing() == 2) || (weapon.getFacing() == 4)) {</span>
<span class="nc" id="L4284">                    rearVGL = true;</span>
                }
            }
<span class="nc bnc" id="L4287" title="All 2 branches missed.">            if (weapon.isMechTurretMounted()) {</span>
<span class="nc" id="L4288">                bvTurret += dBV;</span>
<span class="nc" id="L4289">                bvText.append(&quot; (T)&quot;);</span>
<span class="nc bnc" id="L4290" title="All 4 branches missed.">            } else if (weapon.isRearMounted() || rearVGL) {</span>
<span class="nc" id="L4291">                bvRear += dBV;</span>
<span class="nc" id="L4292">                bvText.append(&quot; (R)&quot;);</span>
            } else {
<span class="nc" id="L4294">                bvFront += dBV;</span>
            }
<span class="nc bnc" id="L4296" title="All 4 branches missed.">            if (!isArm(weapon.getLocation()) &amp;&amp; !weapon.isMechTurretMounted()) {</span>
<span class="nc bnc" id="L4297" title="All 4 branches missed.">                if (weapon.isRearMounted() || rearVGL) {</span>
<span class="nc" id="L4298">                    nonArmRear += dBV;</span>
                } else {
<span class="nc" id="L4300">                    nonArmFront += dBV;</span>
                }
            }

<span class="nc" id="L4304">            bvText.append(endColumn);</span>
<span class="nc" id="L4305">            bvText.append(startColumn);</span>
<span class="nc" id="L4306">            bvText.append(endColumn);</span>
<span class="nc" id="L4307">            bvText.append(startColumn);</span>
<span class="nc" id="L4308">            bvText.append(dBV);</span>
<span class="nc" id="L4309">            bvText.append(endColumn);</span>
<span class="nc" id="L4310">            bvText.append(endRow);</span>
<span class="nc" id="L4311">        }</span>

<span class="nc" id="L4313">        bvText.append(startRow);</span>
<span class="nc" id="L4314">        bvText.append(startColumn);</span>
<span class="nc" id="L4315">        bvText.append(endColumn);</span>
<span class="nc" id="L4316">        bvText.append(startColumn);</span>
<span class="nc" id="L4317">        bvText.append(endColumn);</span>
<span class="nc" id="L4318">        bvText.append(startColumn);</span>

<span class="nc" id="L4320">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L4321">        bvText.append(endColumn);</span>
<span class="nc" id="L4322">        bvText.append(endRow);</span>

<span class="nc" id="L4324">        bvText.append(startRow);</span>
<span class="nc" id="L4325">        bvText.append(startColumn);</span>

<span class="nc" id="L4327">        bvText.append(&quot;Unmodified Front BV:&quot;);</span>
<span class="nc" id="L4328">        bvText.append(endColumn);</span>
<span class="nc" id="L4329">        bvText.append(startColumn);</span>
<span class="nc" id="L4330">        bvText.append(endColumn);</span>
<span class="nc" id="L4331">        bvText.append(startColumn);</span>

<span class="nc" id="L4333">        bvText.append(bvFront);</span>
<span class="nc" id="L4334">        bvText.append(endColumn);</span>
<span class="nc" id="L4335">        bvText.append(endRow);</span>

<span class="nc" id="L4337">        bvText.append(startRow);</span>
<span class="nc" id="L4338">        bvText.append(startColumn);</span>

<span class="nc" id="L4340">        bvText.append(&quot;Unmodfied Rear BV:&quot;);</span>
<span class="nc" id="L4341">        bvText.append(endColumn);</span>
<span class="nc" id="L4342">        bvText.append(startColumn);</span>
<span class="nc" id="L4343">        bvText.append(endColumn);</span>
<span class="nc" id="L4344">        bvText.append(startColumn);</span>

<span class="nc" id="L4346">        bvText.append(bvRear);</span>
<span class="nc" id="L4347">        bvText.append(endColumn);</span>
<span class="nc" id="L4348">        bvText.append(endRow);</span>

<span class="nc" id="L4350">        bvText.append(startRow);</span>
<span class="nc" id="L4351">        bvText.append(startColumn);</span>

<span class="nc" id="L4353">        bvText.append(&quot;Unmodfied Turret BV:&quot;);</span>
<span class="nc" id="L4354">        bvText.append(endColumn);</span>
<span class="nc" id="L4355">        bvText.append(startColumn);</span>
<span class="nc" id="L4356">        bvText.append(endColumn);</span>
<span class="nc" id="L4357">        bvText.append(startColumn);</span>

<span class="nc" id="L4359">        bvText.append(bvTurret);</span>
<span class="nc" id="L4360">        bvText.append(endColumn);</span>
<span class="nc" id="L4361">        bvText.append(endRow);</span>

<span class="nc" id="L4363">        bvText.append(startRow);</span>
<span class="nc" id="L4364">        bvText.append(startColumn);</span>

<span class="nc" id="L4366">        bvText.append(&quot;Total Unmodfied BV:&quot;);</span>
<span class="nc" id="L4367">        bvText.append(endColumn);</span>
<span class="nc" id="L4368">        bvText.append(startColumn);</span>
<span class="nc" id="L4369">        bvText.append(endColumn);</span>
<span class="nc" id="L4370">        bvText.append(startColumn);</span>

<span class="nc" id="L4372">        bvText.append(bvRear + bvFront + bvTurret);</span>
<span class="nc" id="L4373">        bvText.append(endColumn);</span>
<span class="nc" id="L4374">        bvText.append(endRow);</span>

<span class="nc" id="L4376">        bvText.append(&quot;Unmodified Front non-arm BV:&quot;);</span>
<span class="nc" id="L4377">        bvText.append(endColumn);</span>
<span class="nc" id="L4378">        bvText.append(startColumn);</span>
<span class="nc" id="L4379">        bvText.append(endColumn);</span>
<span class="nc" id="L4380">        bvText.append(startColumn);</span>

<span class="nc" id="L4382">        bvText.append(nonArmFront);</span>
<span class="nc" id="L4383">        bvText.append(endColumn);</span>
<span class="nc" id="L4384">        bvText.append(endRow);</span>

<span class="nc" id="L4386">        bvText.append(startRow);</span>
<span class="nc" id="L4387">        bvText.append(startColumn);</span>

<span class="nc" id="L4389">        bvText.append(&quot;Unmodfied Rear non-arm BV:&quot;);</span>
<span class="nc" id="L4390">        bvText.append(endColumn);</span>
<span class="nc" id="L4391">        bvText.append(startColumn);</span>
<span class="nc" id="L4392">        bvText.append(endColumn);</span>
<span class="nc" id="L4393">        bvText.append(startColumn);</span>

<span class="nc" id="L4395">        bvText.append(nonArmRear);</span>
<span class="nc" id="L4396">        bvText.append(endColumn);</span>
<span class="nc" id="L4397">        bvText.append(endRow);</span>

<span class="nc" id="L4399">        boolean halveRear = true;</span>
<span class="nc" id="L4400">        boolean turretFront = true;</span>
<span class="nc bnc" id="L4401" title="All 2 branches missed.">        if (nonArmFront &lt;= nonArmRear) {</span>
<span class="nc" id="L4402">            halveRear = false;</span>
<span class="nc" id="L4403">            turretFront = false;</span>
<span class="nc" id="L4404">            bvText.append(startRow);</span>
<span class="nc" id="L4405">            bvText.append(startColumn);</span>

<span class="nc" id="L4407">            bvText.append(&quot;halving front instead of rear weapon BVs&quot;);</span>
<span class="nc" id="L4408">            bvText.append(endColumn);</span>
<span class="nc" id="L4409">            bvText.append(endRow);</span>
<span class="nc" id="L4410">            bvText.append(startRow);</span>
<span class="nc" id="L4411">            bvText.append(startColumn);</span>

<span class="nc" id="L4413">            bvText.append(&quot;turret mounted weapon BVs count as rear firing&quot;);</span>
<span class="nc" id="L4414">            bvText.append(endColumn);</span>
<span class="nc" id="L4415">            bvText.append(endRow);</span>
        }

<span class="nc" id="L4418">        bvText.append(startRow);</span>
<span class="nc" id="L4419">        bvText.append(startColumn);</span>
<span class="nc" id="L4420">        bvText.append(&quot;Weapon Heat:&quot;);</span>
<span class="nc" id="L4421">        bvText.append(endColumn);</span>
<span class="nc" id="L4422">        bvText.append(startColumn);</span>
<span class="nc" id="L4423">        bvText.append(endColumn);</span>
<span class="nc" id="L4424">        bvText.append(startColumn);</span>
<span class="nc" id="L4425">        bvText.append(endColumn);</span>
<span class="nc" id="L4426">        bvText.append(endRow);</span>

        // here we store the modified BV and heat of all heat-using weapons,
        // to later be sorted by BV
<span class="nc" id="L4430">        ArrayList&lt;ArrayList&lt;Object&gt;&gt; heatBVs = new ArrayList&lt;ArrayList&lt;Object&gt;&gt;();</span>
        // BVs of non-heat-using weapons
<span class="nc" id="L4432">        ArrayList&lt;ArrayList&lt;Object&gt;&gt; nonHeatBVs = new ArrayList&lt;ArrayList&lt;Object&gt;&gt;();</span>
        // total up maximum heat generated
        // and add up BVs for ammo-using weapon types for excessive ammo rule
<span class="nc" id="L4435">        Map&lt;String, Double&gt; weaponsForExcessiveAmmo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L4436">        double maximumHeat = 0;</span>
<span class="nc bnc" id="L4437" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc" id="L4438">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L4439" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_B_POD)</span>
<span class="nc bnc" id="L4440" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_M_POD)) {</span>
<span class="nc" id="L4441">                continue;</span>
            }
<span class="nc" id="L4443">            double weaponHeat = wtype.getHeat();</span>

            // only count non-damaged equipment
<span class="nc bnc" id="L4446" title="All 6 branches missed.">            if (mounted.isMissing() || mounted.isHit() || mounted.isDestroyed()</span>
<span class="nc bnc" id="L4447" title="All 2 branches missed.">                    || mounted.isBreached()) {</span>
<span class="nc" id="L4448">                continue;</span>
            }

            // one shot weapons count 1/4
<span class="nc bnc" id="L4452" title="All 2 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_ROCKET_LAUNCHER)</span>
<span class="nc bnc" id="L4453" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_ONESHOT)) {</span>
<span class="nc" id="L4454">                weaponHeat *= 0.25;</span>
            }

            // double heat for ultras
<span class="nc bnc" id="L4458" title="All 2 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_AC_ULTRA)</span>
<span class="nc bnc" id="L4459" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)) {</span>
<span class="nc" id="L4460">                weaponHeat *= 2;</span>
            }

            // Six times heat for RAC
<span class="nc bnc" id="L4464" title="All 2 branches missed.">            if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L4465">                weaponHeat *= 6;</span>
            }

            // 1d6 extra heat; add half for heat calculations (1d3/+2 for small pulse)
<span class="nc bnc" id="L4469" title="All 8 branches missed.">            if ((wtype instanceof ISERLaserLargePrototype)</span>
                    || (wtype instanceof ISPulseLaserLargePrototype)
                    || (wtype instanceof ISPulseLaserMediumPrototype)
                    || (wtype instanceof ISPulseLaserMediumRecovered)) {
<span class="nc" id="L4473">                weaponHeat += 3;</span>
<span class="nc bnc" id="L4474" title="All 2 branches missed.">            } else if (wtype instanceof ISPulseLaserSmallPrototype) {</span>
<span class="nc" id="L4475">                weaponHeat += 2;</span>
            }

<span class="nc" id="L4478">            String name = wtype.getName();</span>


            // RISC laser pulse module adds 2 heat
<span class="nc bnc" id="L4482" title="All 4 branches missed.">            if ((wtype.hasFlag(WeaponType.F_LASER)) &amp;&amp; (mounted.getLinkedBy() != null)</span>
<span class="nc bnc" id="L4483" title="All 2 branches missed.">                    &amp;&amp; (mounted.getLinkedBy().getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4484" title="All 2 branches missed.">                    &amp;&amp; (mounted.getLinkedBy().getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE))) {</span>
<span class="nc" id="L4485">                name = name.concat(&quot; with RISC Laser Pulse Module&quot;);</span>
<span class="nc" id="L4486">                weaponHeat += 2;</span>
            }

            // laser insulator reduce heat by 1, to a minimum of 1
<span class="nc bnc" id="L4490" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_LASER)</span>
<span class="nc bnc" id="L4491" title="All 2 branches missed.">                    &amp;&amp; (mounted.getLinkedBy() != null)</span>
<span class="nc bnc" id="L4492" title="All 2 branches missed.">                    &amp;&amp; !mounted.getLinkedBy().isInoperable()</span>
<span class="nc bnc" id="L4493" title="All 2 branches missed.">                    &amp;&amp; (mounted.getLinkedBy().getType() instanceof MiscType)</span>
<span class="nc" id="L4494">                    &amp;&amp; mounted.getLinkedBy().getType()</span>
<span class="nc bnc" id="L4495" title="All 2 branches missed.">                            .hasFlag(MiscType.F_LASER_INSULATOR)) {</span>
<span class="nc" id="L4496">                weaponHeat -= 1;</span>
<span class="nc bnc" id="L4497" title="All 2 branches missed.">                if (weaponHeat == 0) {</span>
<span class="nc" id="L4498">                    weaponHeat++;</span>
                }
            }

            // half heat for streaks
<span class="nc bnc" id="L4503" title="All 2 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_SRM_STREAK)</span>
<span class="nc bnc" id="L4504" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_MRM_STREAK)</span>
<span class="nc bnc" id="L4505" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_LRM_STREAK)</span>
<span class="nc bnc" id="L4506" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_IATM)) {</span>
<span class="nc" id="L4507">                weaponHeat *= 0.5;</span>
            }
            // check to see if the weapon is a PPC and has a Capacitor attached
            // to it
<span class="nc bnc" id="L4511" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_PPC)</span>
<span class="nc bnc" id="L4512" title="All 2 branches missed.">                    &amp;&amp; (mounted.getLinkedBy() != null)) {</span>
<span class="nc" id="L4513">                name = name.concat(&quot; with Capacitor&quot;);</span>
<span class="nc" id="L4514">                weaponHeat += 5;</span>
            }

<span class="nc" id="L4517">            bvText.append(startRow);</span>
<span class="nc" id="L4518">            bvText.append(startColumn);</span>

<span class="nc" id="L4520">            bvText.append(name);</span>
<span class="nc" id="L4521">            bvText.append(endColumn);</span>
<span class="nc" id="L4522">            bvText.append(startColumn);</span>
<span class="nc" id="L4523">            bvText.append(endColumn);</span>
<span class="nc" id="L4524">            bvText.append(startColumn);</span>
<span class="nc" id="L4525">            bvText.append(&quot;+ &quot;);</span>
<span class="nc" id="L4526">            bvText.append(weaponHeat);</span>
<span class="nc" id="L4527">            bvText.append(endColumn);</span>
<span class="nc" id="L4528">            bvText.append(endRow);</span>

<span class="nc" id="L4530">            double dBV = wtype.getBV(this);</span>
<span class="nc bnc" id="L4531" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L4532">                dBV *= 0.8;</span>
            }
<span class="nc" id="L4534">            String weaponName = mounted.getName()</span>
<span class="nc bnc" id="L4535" title="All 2 branches missed.">                    + (mounted.isRearMounted() ? &quot;(R)&quot; : &quot;&quot;);</span>

            // don't count AMS, it's defensive
<span class="nc bnc" id="L4538" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L4539">                continue;</span>
            }
            // calc MG Array here:
<span class="nc bnc" id="L4542" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L4543">                double mgBV = 0;</span>
<span class="nc bnc" id="L4544" title="All 2 branches missed.">                for (int eqNum : mounted.getBayWeapons()) {</span>
<span class="nc" id="L4545">                    Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L4546" title="All 4 branches missed.">                    if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L4547">                        mgBV += mg.getType().getBV(this);</span>
                    }
<span class="nc" id="L4549">                }</span>
<span class="nc" id="L4550">                dBV = mgBV * 0.67;</span>
            }

            // artemis bumps up the value
            // PPC caps do, too
<span class="nc bnc" id="L4555" title="All 2 branches missed.">            if (mounted.getLinkedBy() != null) {</span>
                // check to see if the weapon is a PPC and has a Capacitor
                // attached to it
<span class="nc bnc" id="L4558" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_PPC)) {</span>
<span class="nc" id="L4559">                    dBV += ((MiscType) mounted.getLinkedBy().getType()).getBV(</span>
                            this, mounted);
<span class="nc" id="L4561">                    weaponName = weaponName.concat(&quot; with Capacitor&quot;);</span>
                }
<span class="nc" id="L4563">                Mounted mLinker = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L4564" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4565" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</span>
<span class="nc" id="L4566">                    dBV *= 1.2;</span>
<span class="nc" id="L4567">                    weaponName = weaponName.concat(&quot; with Artemis IV&quot;);</span>
                }
<span class="nc bnc" id="L4569" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4570" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</span>
<span class="nc" id="L4571">                    dBV *= 1.3;</span>
<span class="nc" id="L4572">                    weaponName = weaponName.concat(&quot; with Artemis V&quot;);</span>
                }
<span class="nc bnc" id="L4574" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4575" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</span>
<span class="nc" id="L4576">                    dBV *= 1.15;</span>
<span class="nc" id="L4577">                    weaponName = weaponName.concat(&quot; with Apollo&quot;);</span>
                }
<span class="nc bnc" id="L4579" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4580" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L4581">                    dBV *= 1.15;</span>
<span class="nc" id="L4582">                    weaponName = weaponName.concat(&quot; with RISC Laser Pulse Module&quot;);</span>
                }
            }
            // if linked to AES, multiply by 1.25
<span class="nc bnc" id="L4586" title="All 2 branches missed.">            if (hasFunctionalArmAES(mounted.getLocation())) {</span>
<span class="nc" id="L4587">                dBV *= 1.25;</span>
            }
            // and we'll add the tcomp here too
<span class="nc bnc" id="L4590" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; hasTargComp) {</span>
<span class="nc" id="L4591">                dBV *= 1.25;</span>
            }
            // half for being rear mounted (or front mounted, when more rear-
            // than front-mounted un-modded BV
            // or for being turret mounted, when more rear-mounted BV than front
            // mounted BV
<span class="nc bnc" id="L4597" title="All 2 branches missed.">            if ((!isArm(mounted.getLocation())</span>
<span class="nc bnc" id="L4598" title="All 2 branches missed.">                    &amp;&amp; !mounted.isMechTurretMounted() &amp;&amp; ((mounted</span>
<span class="nc bnc" id="L4599" title="All 8 branches missed.">                    .isRearMounted() &amp;&amp; halveRear) || (!mounted.isRearMounted() &amp;&amp; !halveRear)))</span>
<span class="nc bnc" id="L4600" title="All 10 branches missed.">                    || (mounted.isMechTurretMounted() &amp;&amp; ((!turretFront &amp;&amp; halveRear) || (turretFront &amp;&amp; !halveRear)))) {</span>
<span class="nc" id="L4601">                dBV /= 2;</span>
            }

            // ArrayList that stores weapon values
            // stores a double first (BV), then an Integer (heat),
            // then a String (weapon name)
            // for 0 heat weapons, just stores BV and name
<span class="nc" id="L4608">            ArrayList&lt;Object&gt; weaponValues = new ArrayList&lt;Object&gt;();</span>
<span class="nc bnc" id="L4609" title="All 2 branches missed.">            if (weaponHeat &gt; 0) {</span>
                // store heat and BV, for sorting a few lines down;
<span class="nc" id="L4611">                weaponValues.add(dBV);</span>
<span class="nc" id="L4612">                weaponValues.add(weaponHeat);</span>
<span class="nc" id="L4613">                weaponValues.add(weaponName);</span>
<span class="nc" id="L4614">                heatBVs.add(weaponValues);</span>
            } else {
<span class="nc" id="L4616">                weaponValues.add(dBV);</span>
<span class="nc" id="L4617">                weaponValues.add(weaponName);</span>
<span class="nc" id="L4618">                nonHeatBVs.add(weaponValues);</span>
            }

<span class="nc" id="L4621">            maximumHeat += weaponHeat;</span>
            // add up BV of ammo-using weapons for each type of weapon,
            // to compare with ammo BV later for excessive ammo BV rule
<span class="nc bnc" id="L4624" title="All 4 branches missed.">            if (!((wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !((wtype.getAmmoType() == AmmoType.T_PLASMA)</span>
<span class="nc bnc" id="L4625" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L4626" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_HEAVY_FLAMER) || (wtype</span>
<span class="nc bnc" id="L4627" title="All 2 branches missed.">                    .getAmmoType() == AmmoType.T_CHEMICAL_LASER)))</span>
<span class="nc bnc" id="L4628" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L4629" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_INFANTRY) || (wtype</span>
<span class="nc bnc" id="L4630" title="All 2 branches missed.">                        .getAmmoType() == AmmoType.T_NA))) {</span>
<span class="nc" id="L4631">                String key = wtype.getAmmoType() + &quot;:&quot; + wtype.getRackSize();</span>
<span class="nc bnc" id="L4632" title="All 2 branches missed.">                if (!weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L4633">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this));</span>
                } else {
<span class="nc" id="L4635">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this)</span>
<span class="nc" id="L4636">                            + weaponsForExcessiveAmmo.get(key));</span>
                }
            }
<span class="nc" id="L4639">        }</span>

<span class="nc bnc" id="L4641" title="All 2 branches missed.">        if (hasVibroblades()) {</span>

<span class="nc bnc" id="L4643" title="All 2 branches missed.">            for (int location = Mech.LOC_RARM; location &lt;= Mech.LOC_LARM; location++) {</span>
<span class="nc bnc" id="L4644" title="All 2 branches missed.">                for (int slot = 0; slot &lt; locations(); slot++) {</span>
<span class="nc" id="L4645">                    CriticalSlot cs = getCritical(location, slot);</span>

<span class="nc bnc" id="L4647" title="All 2 branches missed.">                    if ((cs != null)</span>
<span class="nc bnc" id="L4648" title="All 2 branches missed.">                            &amp;&amp; (cs.getType() == CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L4649">                        Mounted mount = cs.getMount();</span>
<span class="nc bnc" id="L4650" title="All 2 branches missed.">                        if ((mount.getType() instanceof MiscType)</span>
<span class="nc" id="L4651">                                &amp;&amp; ((MiscType) mount.getType())</span>
<span class="nc bnc" id="L4652" title="All 2 branches missed.">                                        .hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L4653" title="All 2 branches missed.">                                &amp;&amp; ((MiscType) mount.getType()).isVibroblade()) {</span>

<span class="nc" id="L4655">                            ArrayList&lt;Object&gt; weaponValues = new ArrayList&lt;Object&gt;();</span>
<span class="nc" id="L4656">                            double dBV = ((MiscType) mount.getType())</span>
<span class="nc" id="L4657">                                    .getBV(this);</span>
<span class="nc bnc" id="L4658" title="All 2 branches missed.">                            if (hasFunctionalArmAES(mount.getLocation())) {</span>
<span class="nc" id="L4659">                                dBV *= 1.25;</span>
                            }
<span class="nc" id="L4661">                            weaponValues.add(dBV);</span>
<span class="nc" id="L4662">                            weaponValues.add((double) getActiveVibrobladeHeat(</span>
                                    location, true));
<span class="nc" id="L4664">                            weaponValues.add(mount.getName());</span>
<span class="nc" id="L4665">                            heatBVs.add(weaponValues);</span>

<span class="nc" id="L4667">                            bvText.append(startRow);</span>
<span class="nc" id="L4668">                            bvText.append(startColumn);</span>

<span class="nc" id="L4670">                            bvText.append(mount.getName());</span>
<span class="nc" id="L4671">                            bvText.append(endColumn);</span>
<span class="nc" id="L4672">                            bvText.append(startColumn);</span>
<span class="nc" id="L4673">                            bvText.append(endColumn);</span>
<span class="nc" id="L4674">                            bvText.append(startColumn);</span>
<span class="nc" id="L4675">                            bvText.append(&quot;+ &quot;);</span>
<span class="nc" id="L4676">                            bvText.append(getActiveVibrobladeHeat(location,</span>
                                    true));
<span class="nc" id="L4678">                            bvText.append(endColumn);</span>
<span class="nc" id="L4679">                            bvText.append(endRow);</span>
<span class="nc" id="L4680">                            maximumHeat += getActiveVibrobladeHeat(location,</span>
                                    true);
<span class="nc" id="L4682">                            break;</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L4688">        bvText.append(startRow);</span>
<span class="nc" id="L4689">        bvText.append(startColumn);</span>
<span class="nc" id="L4690">        bvText.append(endColumn);</span>
<span class="nc" id="L4691">        bvText.append(startColumn);</span>
<span class="nc" id="L4692">        bvText.append(endColumn);</span>
<span class="nc" id="L4693">        bvText.append(startColumn);</span>

<span class="nc" id="L4695">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L4696">        bvText.append(endColumn);</span>
<span class="nc" id="L4697">        bvText.append(endRow);</span>

<span class="nc" id="L4699">        bvText.append(startRow);</span>
<span class="nc" id="L4700">        bvText.append(startColumn);</span>

<span class="nc" id="L4702">        bvText.append(&quot;Total Heat:&quot;);</span>
<span class="nc" id="L4703">        bvText.append(endColumn);</span>
<span class="nc" id="L4704">        bvText.append(startColumn);</span>
<span class="nc" id="L4705">        bvText.append(endColumn);</span>
<span class="nc" id="L4706">        bvText.append(startColumn);</span>
<span class="nc" id="L4707">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L4708">        bvText.append(maximumHeat);</span>
<span class="nc" id="L4709">        bvText.append(endColumn);</span>
<span class="nc" id="L4710">        bvText.append(endRow);</span>

<span class="nc" id="L4712">        bvText.append(startRow);</span>
<span class="nc" id="L4713">        bvText.append(startColumn);</span>
<span class="nc" id="L4714">        bvText.append(&quot;Weapons with no heat at full BV:&quot;);</span>
<span class="nc" id="L4715">        bvText.append(endColumn);</span>
<span class="nc" id="L4716">        bvText.append(endRow);</span>
        // count heat-free weapons always at full modified BV
<span class="nc bnc" id="L4718" title="All 2 branches missed.">        for (ArrayList&lt;Object&gt; nonHeatWeapon : nonHeatBVs) {</span>
<span class="nc" id="L4719">            weaponBV += (Double) nonHeatWeapon.get(0);</span>

<span class="nc" id="L4721">            bvText.append(startRow);</span>
<span class="nc" id="L4722">            bvText.append(startColumn);</span>
<span class="nc" id="L4723">            bvText.append(nonHeatWeapon.get(1));</span>
<span class="nc bnc" id="L4724" title="All 2 branches missed.">            if (nonHeatWeapon.get(1).toString().length() &lt; 8) {</span>
<span class="nc" id="L4725">                bvText.append(&quot;\t&quot;);</span>
            }
<span class="nc" id="L4727">            bvText.append(endColumn);</span>
<span class="nc" id="L4728">            bvText.append(startColumn);</span>
<span class="nc" id="L4729">            bvText.append(startColumn);</span>
<span class="nc" id="L4730">            bvText.append(endColumn);</span>
<span class="nc" id="L4731">            bvText.append(nonHeatWeapon.get(0));</span>
<span class="nc" id="L4732">            bvText.append(endColumn);</span>
<span class="nc" id="L4733">            bvText.append(endRow);</span>
<span class="nc" id="L4734">        }</span>

<span class="nc" id="L4736">        bvText.append(startRow);</span>
<span class="nc" id="L4737">        bvText.append(startColumn);</span>
<span class="nc" id="L4738">        bvText.append(&quot;Heat Modified Weapons BV: &quot;);</span>
<span class="nc" id="L4739">        bvText.append(endColumn);</span>
<span class="nc" id="L4740">        bvText.append(startColumn);</span>
<span class="nc" id="L4741">        bvText.append(endColumn);</span>
<span class="nc" id="L4742">        bvText.append(startColumn);</span>
<span class="nc" id="L4743">        bvText.append(endColumn);</span>
<span class="nc" id="L4744">        bvText.append(endRow);</span>

<span class="nc bnc" id="L4746" title="All 2 branches missed.">        if (maximumHeat &gt; mechHeatEfficiency) {</span>

<span class="nc" id="L4748">            bvText.append(startRow);</span>
<span class="nc" id="L4749">            bvText.append(startColumn);</span>

<span class="nc" id="L4751">            bvText.append(&quot;(Heat Exceeds Mech Heat Efficiency) &quot;);</span>

<span class="nc" id="L4753">            bvText.append(endColumn);</span>
<span class="nc" id="L4754">            bvText.append(startColumn);</span>
<span class="nc" id="L4755">            bvText.append(endColumn);</span>
<span class="nc" id="L4756">            bvText.append(startColumn);</span>
<span class="nc" id="L4757">            bvText.append(endColumn);</span>
<span class="nc" id="L4758">            bvText.append(endRow);</span>
        }

<span class="nc bnc" id="L4761" title="All 2 branches missed.">        if (maximumHeat &lt;= mechHeatEfficiency) {</span>

            // count all weapons equal
<span class="nc bnc" id="L4764" title="All 2 branches missed.">            for (ArrayList&lt;Object&gt; weaponValues : heatBVs) {</span>
                // name
<span class="nc" id="L4766">                bvText.append(startRow);</span>
<span class="nc" id="L4767">                bvText.append(startColumn);</span>

<span class="nc" id="L4769">                bvText.append(weaponValues.get(2));</span>
<span class="nc" id="L4770">                weaponBV += (Double) weaponValues.get(0);</span>
<span class="nc" id="L4771">                bvText.append(endColumn);</span>
<span class="nc" id="L4772">                bvText.append(startColumn);</span>
<span class="nc" id="L4773">                bvText.append(endColumn);</span>
<span class="nc" id="L4774">                bvText.append(startColumn);</span>

<span class="nc" id="L4776">                bvText.append(weaponValues.get(0));</span>
<span class="nc" id="L4777">                bvText.append(endColumn);</span>
<span class="nc" id="L4778">                bvText.append(endRow);</span>

<span class="nc" id="L4780">            }</span>
        } else {
            // this will count heat-generating weapons at full modified BV until
            // heatefficiency is reached or passed with one weapon

            // sort the heat-using weapons by modified BV
<span class="nc" id="L4786">            Collections.sort(heatBVs, new Comparator&lt;ArrayList&lt;Object&gt;&gt;() {</span>
                @Override
                public int compare(ArrayList&lt;Object&gt; obj1,
                        ArrayList&lt;Object&gt; obj2) {
<span class="nc" id="L4790">                    Double obj1BV = (Double) obj1.get(0); // BV</span>
<span class="nc" id="L4791">                    Double obj2BV = (Double) obj2.get(0); // BV</span>
                    
                    // first element in the the ArrayList is BV, second is heat
                    // if same BV, lower heat first
<span class="nc bnc" id="L4795" title="All 2 branches missed.">                    if(obj1BV.equals(obj2BV)) {</span>
<span class="nc" id="L4796">                        Double obj1Heat = (Double) obj1.get(1);</span>
<span class="nc" id="L4797">                        Double obj2Heat = (Double) obj2.get(1);</span>
                        
<span class="nc" id="L4799">                        return Double.compare(obj1Heat, obj2Heat);</span>
                    }
                    
                    // higher BV first
<span class="nc" id="L4803">                    return Double.compare(obj2BV, obj1BV);</span>
                }
            });
            // count heat-generating weapons at full modified BV until
            // heatefficiency is reached or
            // passed with one weapon
<span class="nc" id="L4809">            double heatAdded = 0;</span>
<span class="nc bnc" id="L4810" title="All 2 branches missed.">            for (ArrayList&lt;Object&gt; weaponValues : heatBVs) {</span>
<span class="nc" id="L4811">                bvText.append(startRow);</span>
<span class="nc" id="L4812">                bvText.append(startColumn);</span>

<span class="nc" id="L4814">                bvText.append(weaponValues.get(2));</span>
<span class="nc" id="L4815">                bvText.append(endColumn);</span>
<span class="nc" id="L4816">                bvText.append(startColumn);</span>

<span class="nc" id="L4818">                double dBV = (Double) weaponValues.get(0);</span>
<span class="nc bnc" id="L4819" title="All 2 branches missed.">                if (heatAdded &gt;= mechHeatEfficiency) {</span>
<span class="nc bnc" id="L4820" title="All 2 branches missed.">                    if (useReducedOverheatModifierBV()) {</span>
<span class="nc" id="L4821">                        dBV /= 10;</span>
                    } else {
<span class="nc" id="L4823">                        dBV /= 2;</span>
                    }
                }
<span class="nc bnc" id="L4826" title="All 2 branches missed.">                if (heatAdded &gt;= mechHeatEfficiency) {</span>
<span class="nc bnc" id="L4827" title="All 2 branches missed.">                    if (useReducedOverheatModifierBV()) {</span>
<span class="nc" id="L4828">                        bvText.append(&quot;Heat efficiency reached, BV * 0.1&quot;);</span>
                    } else {
<span class="nc" id="L4830">                    bvText.append(&quot;Heat efficiency reached, half BV&quot;);</span>
                    }
                }
<span class="nc" id="L4833">                heatAdded += (Double) weaponValues.get(1);</span>
<span class="nc" id="L4834">                weaponBV += dBV;</span>
<span class="nc" id="L4835">                bvText.append(endColumn);</span>
<span class="nc" id="L4836">                bvText.append(startColumn);</span>
<span class="nc" id="L4837">                bvText.append(dBV);</span>
<span class="nc" id="L4838">                bvText.append(endColumn);</span>
<span class="nc" id="L4839">                bvText.append(endRow);</span>
<span class="nc" id="L4840">                bvText.append(startRow);</span>
<span class="nc" id="L4841">                bvText.append(startColumn);</span>
<span class="nc" id="L4842">                bvText.append(&quot;Heat count: &quot; + heatAdded);</span>
<span class="nc" id="L4843">                bvText.append(endColumn);</span>
<span class="nc" id="L4844">                bvText.append(startColumn);</span>
<span class="nc" id="L4845">                bvText.append(endColumn);</span>
<span class="nc" id="L4846">                bvText.append(startColumn);</span>
<span class="nc" id="L4847">                bvText.append(endColumn);</span>
<span class="nc" id="L4848">                bvText.append(endRow);</span>
<span class="nc" id="L4849">            }</span>
        }
<span class="nc" id="L4851">        bvText.append(startRow);</span>
<span class="nc" id="L4852">        bvText.append(startColumn);</span>
<span class="nc" id="L4853">        bvText.append(endColumn);</span>
<span class="nc" id="L4854">        bvText.append(startColumn);</span>
<span class="nc" id="L4855">        bvText.append(endColumn);</span>
<span class="nc" id="L4856">        bvText.append(startColumn);</span>

<span class="nc" id="L4858">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L4859">        bvText.append(endColumn);</span>
<span class="nc" id="L4860">        bvText.append(endRow);</span>

<span class="nc" id="L4862">        bvText.append(startRow);</span>
<span class="nc" id="L4863">        bvText.append(startColumn);</span>

<span class="nc" id="L4865">        bvText.append(&quot;Total Weapons BV Adjusted For Heat:&quot;);</span>
<span class="nc" id="L4866">        bvText.append(endColumn);</span>
<span class="nc" id="L4867">        bvText.append(startColumn);</span>
<span class="nc" id="L4868">        bvText.append(endColumn);</span>
<span class="nc" id="L4869">        bvText.append(startColumn);</span>
<span class="nc" id="L4870">        bvText.append(weaponBV);</span>
<span class="nc" id="L4871">        bvText.append(endColumn);</span>
<span class="nc" id="L4872">        bvText.append(endRow);</span>

<span class="nc" id="L4874">        bvText.append(startRow);</span>
<span class="nc" id="L4875">        bvText.append(startColumn);</span>

<span class="nc" id="L4877">        bvText.append(&quot;Misc Offensive Equipment: &quot;);</span>
<span class="nc" id="L4878">        bvText.append(endColumn);</span>
<span class="nc" id="L4879">        bvText.append(startColumn);</span>
<span class="nc" id="L4880">        bvText.append(endColumn);</span>
<span class="nc" id="L4881">        bvText.append(startColumn);</span>
<span class="nc" id="L4882">        bvText.append(endColumn);</span>
<span class="nc" id="L4883">        bvText.append(endRow);</span>

        // add offensive misc. equipment BV (everything except AMS, A-Pod, ECM -
        // BMR p152)
<span class="nc" id="L4887">        double oEquipmentBV = 0;</span>
<span class="nc bnc" id="L4888" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L4889">            MiscType mtype = (MiscType) mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L4892" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L4893">                continue;</span>
            }
            // vibroblades have been counted under weapons
<span class="nc bnc" id="L4896" title="All 2 branches missed.">            if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L4897" title="All 2 branches missed.">                    &amp;&amp; ((MiscType) mounted.getType()).hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L4898" title="All 2 branches missed.">                    &amp;&amp; ((MiscType) mounted.getType()).isVibroblade()) {</span>
<span class="nc" id="L4899">                continue;</span>
            }

<span class="nc bnc" id="L4902" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L4903" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L4904" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_AP_POD)</span>
<span class="nc bnc" id="L4905" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_VIRAL_JAMMER_DECOY)</span>
<span class="nc bnc" id="L4906" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_VIRAL_JAMMER_HOMING)</span>
<span class="nc bnc" id="L4907" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_MASS)</span>
<span class="nc bnc" id="L4908" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L4909" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L4910" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L4911" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_CHAFF_POD)</span>
<span class="nc bnc" id="L4912" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_TARGCOMP)</span>
<span class="nc bnc" id="L4913" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_SPIKES)</span>
<span class="nc bnc" id="L4914" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_HARJEL_II)</span>
<span class="nc bnc" id="L4915" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_HARJEL_III)</span>
<span class="nc bnc" id="L4916" title="All 2 branches missed.">                    || (mtype.hasFlag(MiscType.F_CLUB) &amp;&amp; (mtype</span>
<span class="nc bnc" id="L4917" title="All 2 branches missed.">                            .hasSubType(MiscType.S_SHIELD_LARGE)</span>
<span class="nc bnc" id="L4918" title="All 2 branches missed.">                            || mtype.hasSubType(MiscType.S_SHIELD_MEDIUM) || mtype</span>
<span class="nc bnc" id="L4919" title="All 2 branches missed.">                                .hasSubType(MiscType.S_SHIELD_SMALL)))) {</span>
<span class="nc" id="L4920">                continue;</span>
            }
<span class="nc" id="L4922">            double bv = mtype.getBV(this);</span>
            // if physical weapon linked to AES, multiply by 1.25
<span class="nc bnc" id="L4924" title="All 2 branches missed.">            if ((mtype.hasFlag(MiscType.F_CLUB) || mtype</span>
<span class="nc bnc" id="L4925" title="All 2 branches missed.">                    .hasFlag(MiscType.F_HAND_WEAPON))</span>
<span class="nc bnc" id="L4926" title="All 2 branches missed.">                    &amp;&amp; hasFunctionalArmAES(mounted.getLocation())) {</span>
<span class="nc" id="L4927">                bv *= 1.25;</span>
            }

<span class="nc bnc" id="L4930" title="All 2 branches missed.">            if (bv &gt; 0) {</span>
<span class="nc" id="L4931">                bvText.append(startRow);</span>
<span class="nc" id="L4932">                bvText.append(startColumn);</span>

<span class="nc" id="L4934">                bvText.append(mounted.getName());</span>
<span class="nc" id="L4935">                bvText.append(endColumn);</span>
<span class="nc" id="L4936">                bvText.append(startColumn);</span>
<span class="nc" id="L4937">                bvText.append(endColumn);</span>
<span class="nc" id="L4938">                bvText.append(startColumn);</span>
<span class="nc" id="L4939">                bvText.append(bv);</span>
<span class="nc" id="L4940">                bvText.append(endColumn);</span>
<span class="nc" id="L4941">                bvText.append(endRow);</span>
            }

<span class="nc" id="L4944">            oEquipmentBV += bv;</span>
<span class="nc" id="L4945">        }</span>

<span class="nc" id="L4947">        bvText.append(startRow);</span>
<span class="nc" id="L4948">        bvText.append(startColumn);</span>

<span class="nc" id="L4950">        bvText.append(&quot;Total Misc Offensive Equipment BV: &quot;);</span>
<span class="nc" id="L4951">        bvText.append(endColumn);</span>
<span class="nc" id="L4952">        bvText.append(startColumn);</span>
<span class="nc" id="L4953">        bvText.append(endColumn);</span>
<span class="nc" id="L4954">        bvText.append(startColumn);</span>
<span class="nc" id="L4955">        bvText.append(oEquipmentBV);</span>
<span class="nc" id="L4956">        bvText.append(endColumn);</span>
<span class="nc" id="L4957">        bvText.append(endRow);</span>

<span class="nc" id="L4959">        weaponBV += oEquipmentBV;</span>

        // add ammo bv
<span class="nc" id="L4962">        double ammoBV = 0;</span>
        // extra BV for when we have semiguided LRMs and someone else has TAG on
        // our team
<span class="nc" id="L4965">        double tagBV = 0;</span>
<span class="nc" id="L4966">        Map&lt;String, Double&gt; ammo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L4967">        ArrayList&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L4968" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L4969">            AmmoType atype = (AmmoType) mounted.getType();</span>

            // don't count depleted ammo
<span class="nc bnc" id="L4972" title="All 2 branches missed.">            if (mounted.getUsableShotsLeft() == 0) {</span>
<span class="nc" id="L4973">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L4977" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_AMS) || (atype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L4978">                continue;</span>
            }

            // don't count oneshot ammo, it's considered part of the launcher.
<span class="nc bnc" id="L4982" title="All 2 branches missed.">            if (mounted.getLocation() == Entity.LOC_NONE) {</span>
                // assumption: ammo without a location is for a oneshot weapon
<span class="nc" id="L4984">                continue;</span>
            }
            // semiguided or homing ammo might count double
<span class="nc bnc" id="L4987" title="All 2 branches missed.">            if ((atype.getMunitionType() == AmmoType.M_SEMIGUIDED)</span>
<span class="nc bnc" id="L4988" title="All 2 branches missed.">                    || (atype.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L4989">                IPlayer tmpP = getOwner();</span>

<span class="nc bnc" id="L4991" title="All 2 branches missed.">                if (tmpP != null) {</span>
                    // Okay, actually check for friendly TAG.
<span class="nc bnc" id="L4993" title="All 2 branches missed.">                    if (tmpP.hasTAG()) {</span>
<span class="nc" id="L4994">                        tagBV += atype.getBV(this);</span>
<span class="nc bnc" id="L4995" title="All 4 branches missed.">                    } else if ((tmpP.getTeam() != IPlayer.TEAM_NONE)</span>
                            &amp;&amp; (game != null)) {
<span class="nc" id="L4997">                        for (Enumeration&lt;Team&gt; e = game.getTeams(); e</span>
<span class="nc bnc" id="L4998" title="All 2 branches missed.">                                .hasMoreElements();) {</span>
<span class="nc" id="L4999">                            Team m = e.nextElement();</span>
<span class="nc bnc" id="L5000" title="All 2 branches missed.">                            if (m.getId() == tmpP.getTeam()) {</span>
<span class="nc bnc" id="L5001" title="All 2 branches missed.">                                if (m.hasTAG(game)) {</span>
<span class="nc" id="L5002">                                    tagBV += atype.getBV(this);</span>
                                }
                                // A player can't be on two teams.
                                // If we check his team and don't give the
                                // penalty, that's it.
                                break;
                            }
<span class="nc" id="L5009">                        }</span>
                    }
                }
            }
<span class="nc" id="L5013">            String key = atype.getAmmoType() + &quot;:&quot; + atype.getRackSize();</span>
<span class="nc bnc" id="L5014" title="All 2 branches missed.">            if (!keys.contains(key)) {</span>
<span class="nc" id="L5015">                keys.add(key);</span>
            }
<span class="nc bnc" id="L5017" title="All 2 branches missed.">            if (!ammo.containsKey(key)) {</span>
<span class="nc" id="L5018">                ammo.put(key, atype.getBV(this));</span>
            } else {
<span class="nc" id="L5020">                ammo.put(key, atype.getBV(this) + ammo.get(key));</span>
            }
<span class="nc" id="L5022">        }</span>

        // Excessive ammo rule:
        // Only count BV for ammo for a weapontype until the BV of all weapons
        // of that
        // type on the mech is reached.
<span class="nc bnc" id="L5028" title="All 2 branches missed.">        for (String key : keys) {</span>

<span class="nc bnc" id="L5030" title="All 2 branches missed.">            if (weaponsForExcessiveAmmo.get(key) != null) {</span>
<span class="nc bnc" id="L5031" title="All 2 branches missed.">                if (ammo.get(key) &gt; weaponsForExcessiveAmmo.get(key)) {</span>
<span class="nc" id="L5032">                    ammoBV += weaponsForExcessiveAmmo.get(key);</span>
                } else {
<span class="nc" id="L5034">                    ammoBV += ammo.get(key);</span>
                }
            } else {
                // Ammo with no matching weapons counts 0, unless it's a coolant
                // pod
                // because coolant pods have no matching weapon
<span class="nc bnc" id="L5040" title="All 2 branches missed.">                if (key.equals(Integer.valueOf(AmmoType.T_COOLANT_POD).toString()</span>
                        + &quot;1&quot;)) {
<span class="nc" id="L5042">                    ammoBV += ammo.get(key);</span>
                }
            }
<span class="nc" id="L5045">        }</span>
<span class="nc" id="L5046">        weaponBV += ammoBV;</span>

<span class="nc" id="L5048">        bvText.append(startRow);</span>
<span class="nc" id="L5049">        bvText.append(startColumn);</span>

<span class="nc" id="L5051">        bvText.append(&quot;Total Ammo BV: &quot;);</span>
<span class="nc" id="L5052">        bvText.append(endColumn);</span>
<span class="nc" id="L5053">        bvText.append(startColumn);</span>
<span class="nc" id="L5054">        bvText.append(endColumn);</span>
<span class="nc" id="L5055">        bvText.append(startColumn);</span>

<span class="nc" id="L5057">        bvText.append(ammoBV);</span>
<span class="nc" id="L5058">        bvText.append(endColumn);</span>
<span class="nc" id="L5059">        bvText.append(endRow);</span>

<span class="nc" id="L5061">        double aesMultiplier = 1;</span>
<span class="nc bnc" id="L5062" title="All 2 branches missed.">        if (hasFunctionalArmAES(Mech.LOC_LARM)) {</span>
<span class="nc" id="L5063">            aesMultiplier += 0.1;</span>
        }
<span class="nc bnc" id="L5065" title="All 2 branches missed.">        if (hasFunctionalArmAES(Mech.LOC_RARM)) {</span>
<span class="nc" id="L5066">            aesMultiplier += 0.1;</span>
        }
<span class="nc bnc" id="L5068" title="All 2 branches missed.">        if (hasFunctionalLegAES()) {</span>
<span class="nc bnc" id="L5069" title="All 2 branches missed.">            if (this instanceof BipedMech) {</span>
<span class="nc" id="L5070">                aesMultiplier += 0.2;</span>
<span class="nc bnc" id="L5071" title="All 2 branches missed.">            } else if (this instanceof QuadMech) {</span>
<span class="nc" id="L5072">                aesMultiplier += 0.4;</span>
            }
        }

<span class="nc" id="L5076">        double weight = this.weight * aesMultiplier;</span>

<span class="nc bnc" id="L5078" title="All 2 branches missed.">        if (aesMultiplier &gt; 1) {</span>
<span class="nc" id="L5079">            bvText.append(startRow);</span>
<span class="nc" id="L5080">            bvText.append(startColumn);</span>

<span class="nc" id="L5082">            bvText.append(&quot;Weight x AES Multiplier &quot;);</span>
<span class="nc" id="L5083">            bvText.append(endColumn);</span>
<span class="nc" id="L5084">            bvText.append(startColumn);</span>

<span class="nc" id="L5086">            bvText.append(this.weight);</span>
<span class="nc" id="L5087">            bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L5088">            bvText.append(aesMultiplier);</span>
<span class="nc" id="L5089">            bvText.append(endColumn);</span>
<span class="nc" id="L5090">            bvText.append(startColumn);</span>
<span class="nc" id="L5091">            bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L5092">            bvText.append(weight);</span>
<span class="nc" id="L5093">            bvText.append(endColumn);</span>
<span class="nc" id="L5094">            bvText.append(endRow);</span>
        }
        // add tonnage, adjusted for TSM
<span class="nc bnc" id="L5097" title="All 2 branches missed.">        if (hasTSM()) {</span>
<span class="nc" id="L5098">            weaponBV += weight * 1.5;</span>
<span class="nc" id="L5099">            bvText.append(startRow);</span>
<span class="nc" id="L5100">            bvText.append(startColumn);</span>
<span class="nc" id="L5101">            bvText.append(&quot;Add weight + TSM Modifier&quot;);</span>
<span class="nc" id="L5102">            bvText.append(endColumn);</span>
<span class="nc" id="L5103">            bvText.append(startColumn);</span>

<span class="nc" id="L5105">            bvText.append(weight);</span>
<span class="nc" id="L5106">            bvText.append(&quot; * 1.5&quot;);</span>
<span class="nc" id="L5107">            bvText.append(endColumn);</span>
<span class="nc" id="L5108">            bvText.append(startColumn);</span>

<span class="nc" id="L5110">            bvText.append(weight * 1.5);</span>
<span class="nc" id="L5111">            bvText.append(endColumn);</span>
<span class="nc" id="L5112">            bvText.append(endRow);</span>
<span class="nc bnc" id="L5113" title="All 2 branches missed.">        } else if (hasIndustrialTSM()) {</span>
<span class="nc" id="L5114">            weaponBV += weight * 1.15;</span>
<span class="nc" id="L5115">            bvText.append(startRow);</span>
<span class="nc" id="L5116">            bvText.append(startColumn);</span>

<span class="nc" id="L5118">            bvText.append(&quot;Add weight + Industrial TSM Modifier&quot;);</span>
<span class="nc" id="L5119">            bvText.append(endColumn);</span>
<span class="nc" id="L5120">            bvText.append(startColumn);</span>

<span class="nc" id="L5122">            bvText.append(weight);</span>
<span class="nc" id="L5123">            bvText.append(&quot; * 1.115&quot;);</span>
<span class="nc" id="L5124">            bvText.append(endColumn);</span>
<span class="nc" id="L5125">            bvText.append(startColumn);</span>

<span class="nc" id="L5127">            bvText.append(weight * 1.15);</span>
<span class="nc" id="L5128">            bvText.append(endColumn);</span>
<span class="nc" id="L5129">            bvText.append(endRow);</span>
        } else {
<span class="nc" id="L5131">            weaponBV += weight;</span>
<span class="nc" id="L5132">            bvText.append(startRow);</span>
<span class="nc" id="L5133">            bvText.append(startColumn);</span>

<span class="nc" id="L5135">            bvText.append(&quot;Add weight&quot;);</span>
<span class="nc" id="L5136">            bvText.append(endColumn);</span>
<span class="nc" id="L5137">            bvText.append(startColumn);</span>
<span class="nc" id="L5138">            bvText.append(endColumn);</span>
<span class="nc" id="L5139">            bvText.append(startColumn);</span>
<span class="nc" id="L5140">            bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L5141">            bvText.append(weight);</span>
<span class="nc" id="L5142">            bvText.append(endColumn);</span>
<span class="nc" id="L5143">            bvText.append(endRow);</span>
        }

<span class="nc bnc" id="L5146" title="All 2 branches missed.">        if ((getCockpitType() == Mech.COCKPIT_INDUSTRIAL)</span>
<span class="nc bnc" id="L5147" title="All 2 branches missed.">                || (getCockpitType() == Mech.COCKPIT_PRIMITIVE_INDUSTRIAL)) {</span>
            // industrial without advanced firing control get's 0.9 mod to
            // offensive BV
<span class="nc" id="L5150">            bvText.append(&quot;Weapon BV * Firing Control Modifier&quot;);</span>
<span class="nc" id="L5151">            bvText.append(endColumn);</span>
<span class="nc" id="L5152">            bvText.append(startColumn);</span>
<span class="nc" id="L5153">            bvText.append(weaponBV);</span>
<span class="nc" id="L5154">            bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L5155">            bvText.append(&quot;0.9&quot;);</span>
<span class="nc" id="L5156">            bvText.append(endColumn);</span>
<span class="nc" id="L5157">            weaponBV *= 0.9;</span>
<span class="nc" id="L5158">            bvText.append(startColumn);</span>
<span class="nc" id="L5159">            bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L5160">            bvText.append(weaponBV);</span>
<span class="nc" id="L5161">            bvText.append(endColumn);</span>
<span class="nc" id="L5162">            bvText.append(endRow);</span>
        }

<span class="nc" id="L5165">        double speedFactor = Math</span>
<span class="nc" id="L5166">                .pow(1 + ((((double) runMP + (Math</span>
<span class="nc" id="L5167">                        .round(Math.max(jumpMP, umuMP) / 2.0))) - 5) / 10), 1.2);</span>
<span class="nc" id="L5168">        speedFactor = Math.round(speedFactor * 100) / 100.0;</span>

<span class="nc" id="L5170">        bvText.append(startRow);</span>
<span class="nc" id="L5171">        bvText.append(startColumn);</span>

<span class="nc" id="L5173">        bvText.append(&quot;Final Speed Factor: &quot;);</span>
<span class="nc" id="L5174">        bvText.append(endColumn);</span>
<span class="nc" id="L5175">        bvText.append(startColumn);</span>
<span class="nc" id="L5176">        bvText.append(endColumn);</span>
<span class="nc" id="L5177">        bvText.append(startColumn);</span>
<span class="nc" id="L5178">        bvText.append(speedFactor);</span>
<span class="nc" id="L5179">        bvText.append(endColumn);</span>
<span class="nc" id="L5180">        bvText.append(endRow);</span>

<span class="nc" id="L5182">        obv = weaponBV * speedFactor;</span>

<span class="nc" id="L5184">        bvText.append(startRow);</span>
<span class="nc" id="L5185">        bvText.append(startColumn);</span>

<span class="nc" id="L5187">        bvText.append(&quot;Weapons BV * Speed Factor &quot;);</span>
<span class="nc" id="L5188">        bvText.append(endColumn);</span>
<span class="nc" id="L5189">        bvText.append(startColumn);</span>

<span class="nc" id="L5191">        bvText.append(weaponBV);</span>
<span class="nc" id="L5192">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L5193">        bvText.append(speedFactor);</span>
<span class="nc" id="L5194">        bvText.append(endColumn);</span>
<span class="nc" id="L5195">        bvText.append(startColumn);</span>
<span class="nc" id="L5196">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L5197">        bvText.append(obv);</span>
<span class="nc" id="L5198">        bvText.append(endColumn);</span>
<span class="nc" id="L5199">        bvText.append(endRow);</span>

<span class="nc" id="L5201">        bvText.append(startRow);</span>
<span class="nc" id="L5202">        bvText.append(startColumn);</span>

<span class="nc bnc" id="L5204" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L5205">            bvText.append(&quot;2 * sqrt(Offensive BV * Defensive BV&quot;);</span>
        } else {
<span class="nc" id="L5207">            bvText.append(&quot;Offensive BV + Defensive BV&quot;);</span>
        }
<span class="nc" id="L5209">        bvText.append(endColumn);</span>
<span class="nc" id="L5210">        bvText.append(startColumn);</span>

        double finalBV;
<span class="nc bnc" id="L5213" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L5214">            finalBV = 2 * Math.sqrt(obv * dbv);</span>
<span class="nc bnc" id="L5215" title="All 2 branches missed.">            if (finalBV == 0) {</span>
<span class="nc" id="L5216">                finalBV = dbv + obv;</span>
            }
<span class="nc" id="L5218">            bvText.append(&quot;2 * sqrt(&quot;);</span>
<span class="nc" id="L5219">            bvText.append(obv);</span>
<span class="nc" id="L5220">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L5221">            bvText.append(dbv);</span>
<span class="nc" id="L5222">            bvText.append(&quot;)&quot;);</span>
        } else {
<span class="nc" id="L5224">            finalBV = dbv + obv;</span>
<span class="nc" id="L5225">            bvText.append(dbv);</span>
<span class="nc" id="L5226">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L5227">            bvText.append(obv);</span>
        }
<span class="nc" id="L5229">        double totalBV = finalBV;</span>

<span class="nc" id="L5231">        bvText.append(endColumn);</span>
<span class="nc" id="L5232">        bvText.append(startColumn);</span>
<span class="nc" id="L5233">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L5234">        bvText.append(finalBV);</span>
<span class="nc" id="L5235">        bvText.append(endColumn);</span>
<span class="nc" id="L5236">        bvText.append(endRow);</span>

<span class="nc" id="L5238">        bvText.append(startRow);</span>
<span class="nc" id="L5239">        bvText.append(startColumn);</span>

<span class="nc" id="L5241">        double cockpitMod = 1;</span>
<span class="nc bnc" id="L5242" title="All 2 branches missed.">        if ((getCockpitType() == Mech.COCKPIT_SMALL)</span>
<span class="nc bnc" id="L5243" title="All 2 branches missed.">                || (getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L5244" title="All 2 branches missed.">                || (getCockpitType() == Mech.COCKPIT_SMALL_COMMAND_CONSOLE)) {</span>
<span class="nc" id="L5245">            cockpitMod = 0.95;</span>
<span class="nc" id="L5246">            finalBV *= cockpitMod;</span>
<span class="nc bnc" id="L5247" title="All 2 branches missed.">        } else if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L5248">            finalBV *= 0.95;</span>
<span class="nc bnc" id="L5249" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_INTERFACE) {</span>
<span class="nc" id="L5250">            cockpitMod = 1.3;</span>
<span class="nc" id="L5251">            finalBV *= cockpitMod;</span>
        }
<span class="nc" id="L5253">        finalBV = Math.round(finalBV);</span>
<span class="nc" id="L5254">        bvText.append(&quot;Total BV * Cockpit Modifier&quot;);</span>
<span class="nc" id="L5255">        bvText.append(endColumn);</span>
<span class="nc" id="L5256">        bvText.append(startColumn);</span>
<span class="nc" id="L5257">        bvText.append(totalBV);</span>
<span class="nc" id="L5258">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L5259">        bvText.append(cockpitMod);</span>
<span class="nc" id="L5260">        bvText.append(endColumn);</span>
<span class="nc" id="L5261">        bvText.append(startColumn);</span>
<span class="nc" id="L5262">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L5263">        bvText.append(finalBV);</span>
<span class="nc" id="L5264">        bvText.append(endColumn);</span>
<span class="nc" id="L5265">        bvText.append(endRow);</span>

<span class="nc" id="L5267">        bvText.append(startRow);</span>
<span class="nc" id="L5268">        bvText.append(startColumn);</span>
<span class="nc" id="L5269">        bvText.append(endColumn);</span>
<span class="nc" id="L5270">        bvText.append(startColumn);</span>
<span class="nc" id="L5271">        bvText.append(endColumn);</span>
<span class="nc" id="L5272">        bvText.append(startColumn);</span>

<span class="nc" id="L5274">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L5275">        bvText.append(endColumn);</span>
<span class="nc" id="L5276">        bvText.append(endRow);</span>

<span class="nc" id="L5278">        bvText.append(startRow);</span>
<span class="nc" id="L5279">        bvText.append(startColumn);</span>
<span class="nc" id="L5280">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L5281">        bvText.append(endColumn);</span>
<span class="nc" id="L5282">        bvText.append(startColumn);</span>
<span class="nc" id="L5283">        bvText.append(endColumn);</span>
<span class="nc" id="L5284">        bvText.append(startColumn);</span>

<span class="nc" id="L5286">        bvText.append(finalBV);</span>
<span class="nc" id="L5287">        bvText.append(endColumn);</span>
<span class="nc" id="L5288">        bvText.append(endRow);</span>

<span class="nc" id="L5290">        bvText.append(endTable);</span>
<span class="nc" id="L5291">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>

        // we get extra bv from some stuff
<span class="nc" id="L5294">        double xbv = 0.0;</span>
        // extra BV for semi-guided lrm when TAG in our team
<span class="nc" id="L5296">        xbv += tagBV;</span>
<span class="nc bnc" id="L5297" title="All 2 branches missed.">        if (!ignoreC3) {</span>
<span class="nc" id="L5298">            xbv += getExtraC3BV((int) Math.round(finalBV));</span>
        }
<span class="nc" id="L5300">        finalBV = (int) Math.round(finalBV + xbv);</span>

        // and then factor in pilot
<span class="nc" id="L5303">        double pilotFactor = 1;</span>
<span class="nc bnc" id="L5304" title="All 2 branches missed.">        if (!ignorePilot) {</span>
<span class="nc" id="L5305">            pilotFactor = getCrew().getBVSkillMultiplier(game);</span>
        }

<span class="nc" id="L5308">        int retVal = (int) Math.round((finalBV) * pilotFactor);</span>

<span class="nc" id="L5310">        return retVal;</span>
    }

    /**
     * Calculate the C-bill cost of the mech. Passing null as the argument will
     * skip the detailed report processing.
     *
     * @return The cost in C-Bills of the 'Mech in question.
     */
    @Override
    public double getCost(boolean ignoreAmmo) {
<span class="nc" id="L5321">        double[] costs = new double[17 + locations()];</span>
<span class="nc" id="L5322">        int i = 0;</span>

<span class="nc" id="L5324">        double cockpitCost = 0;</span>
<span class="nc bnc" id="L5325" title="All 2 branches missed.">        if (getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED) {</span>
<span class="nc" id="L5326">            cockpitCost = 750000;</span>
<span class="nc bnc" id="L5327" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_DUAL) {</span>
            // Solaris VII - The Game World (German) This is not actually
            // canonical as it
            // has never been repeated in any English language source including
            // Tech Manual
<span class="nc" id="L5332">            cockpitCost = 40000;</span>
<span class="nc bnc" id="L5333" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_COMMAND_CONSOLE) {</span>
            // Command Consoles are listed as a cost of 500,000.
            // That appears to be in addition to the primary cockpit.
<span class="nc" id="L5336">            cockpitCost = 700000;</span>
<span class="nc bnc" id="L5337" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_SMALL) {</span>
<span class="nc" id="L5338">            cockpitCost = 175000;</span>
<span class="nc bnc" id="L5339" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_VRRP) {</span>
<span class="nc" id="L5340">            cockpitCost = 1250000;</span>
<span class="nc bnc" id="L5341" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_INDUSTRIAL) {</span>
<span class="nc" id="L5342">            cockpitCost = 100000;</span>
<span class="nc bnc" id="L5343" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_TRIPOD) {</span>
<span class="nc" id="L5344">            cockpitCost = 400000;</span>
<span class="nc bnc" id="L5345" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_QUADVEE) {</span>
<span class="nc" id="L5346">            cockpitCost = 375000;</span>
<span class="nc bnc" id="L5347" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_SUPERHEAVY) {</span>
<span class="nc" id="L5348">            cockpitCost = 300000;</span>
<span class="nc bnc" id="L5349" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_SUPERHEAVY_COMMAND_CONSOLE) {</span>
            // The cost is the sum of both superheavy cockpit and command console
<span class="nc" id="L5351">            cockpitCost = 800000;</span>
<span class="nc bnc" id="L5352" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_SUPERHEAVY_TRIPOD) {</span>
<span class="nc" id="L5353">            cockpitCost = 500000;</span>
<span class="nc bnc" id="L5354" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_SMALL_COMMAND_CONSOLE) {</span>
            // The cost is the sum of both small and command console
<span class="nc" id="L5356">            cockpitCost = 675000;            </span>
        } else {
<span class="nc" id="L5358">            cockpitCost = 200000;</span>
        }
<span class="nc bnc" id="L5360" title="All 2 branches missed.">        if (hasEiCockpit()</span>
<span class="nc bnc" id="L5361" title="All 4 branches missed.">                &amp;&amp; ((null != getCrew()) &amp;&amp; hasAbility(OptionsConstants.UNOFF_EI_IMPLANT))) {</span>
<span class="nc" id="L5362">            cockpitCost = 400000;</span>
        }
<span class="nc" id="L5364">        costs[i++] = cockpitCost;</span>
<span class="nc" id="L5365">        costs[i++] = 50000;// life support</span>
<span class="nc" id="L5366">        costs[i++] = weight * 2000;// sensors</span>
<span class="nc bnc" id="L5367" title="All 6 branches missed.">        int muscCost = hasSCM() ? 10000 : hasTSM() ? 16000 : hasIndustrialTSM() ? 12000 : 2000;</span>
<span class="nc" id="L5368">        costs[i++] = muscCost * weight;// musculature</span>
<span class="nc" id="L5369">        double structureCost = EquipmentType.getStructureCost(structureType) * weight;// IS</span>
<span class="nc" id="L5370">        costs[i++] = structureCost;</span>
<span class="nc" id="L5371">        costs[i++] = getActuatorCost();// arm and/or leg actuators</span>
<span class="nc bnc" id="L5372" title="All 2 branches missed.">        if(hasEngine()) {</span>
<span class="nc" id="L5373">            costs[i++] = (getEngine().getBaseCost() * getEngine().getRating() * weight) / 75.0;</span>
        }
<span class="nc bnc" id="L5375" title="All 2 branches missed.">        if (getGyroType() == Mech.GYRO_XL) {</span>
<span class="nc" id="L5376">            costs[i++] = 750000 * (int) Math</span>
<span class="nc" id="L5377">                    .ceil((getOriginalWalkMP() * weight) / 100f) * 0.5;</span>
<span class="nc bnc" id="L5378" title="All 2 branches missed.">        } else if (getGyroType() == Mech.GYRO_COMPACT) {</span>
<span class="nc" id="L5379">            costs[i++] = 400000 * (int) Math</span>
<span class="nc" id="L5380">                    .ceil((getOriginalWalkMP() * weight) / 100f) * 1.5;</span>
<span class="nc bnc" id="L5381" title="All 2 branches missed.">        } else if (getGyroType() == Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L5382">            costs[i++] = 500000 * (int) Math</span>
<span class="nc" id="L5383">                    .ceil((getOriginalWalkMP() * weight) / 100f) * 2;</span>
<span class="nc bnc" id="L5384" title="All 2 branches missed.">        } else if (getGyroType() == Mech.GYRO_STANDARD) {</span>
<span class="nc" id="L5385">            costs[i++] = 300000 * (int) Math</span>
<span class="nc" id="L5386">                    .ceil((getOriginalWalkMP() * weight) / 100f);</span>
        }
<span class="nc" id="L5388">        double jumpBaseCost = 200;</span>
        // You cannot have JJ's and UMU's on the same unit.
<span class="nc bnc" id="L5390" title="All 2 branches missed.">        if (hasUMU()) {</span>
<span class="nc" id="L5391">            costs[i++] = Math.pow(getAllUMUCount(), 2.0) * weight</span>
                    * jumpBaseCost;
            // We could have Jump boosters
<span class="nc bnc" id="L5394" title="All 2 branches missed.">            if (getJumpType() == Mech.JUMP_BOOSTER) {</span>
<span class="nc" id="L5395">                jumpBaseCost = 150;</span>
<span class="nc" id="L5396">                costs[i++] = Math.pow(getOriginalJumpMP(), 2.0) * weight</span>
                        * jumpBaseCost;
            }
        } else {
<span class="nc bnc" id="L5400" title="All 2 branches missed.">            if (getJumpType() == Mech.JUMP_BOOSTER) {</span>
<span class="nc" id="L5401">                jumpBaseCost = 150;</span>
<span class="nc bnc" id="L5402" title="All 2 branches missed.">            } else if (getJumpType() == Mech.JUMP_IMPROVED) {</span>
<span class="nc" id="L5403">                jumpBaseCost = 500;</span>
            }
<span class="nc" id="L5405">            costs[i++] = Math.pow(getOriginalJumpMP(), 2.0) * weight</span>
                    * jumpBaseCost;
        }
        // num of sinks we don't pay for
<span class="nc bnc" id="L5409" title="All 2 branches missed.">        int freeSinks = hasDoubleHeatSinks() ? 0 : 10;</span>
<span class="nc bnc" id="L5410" title="All 2 branches missed.">        int sinkCost = hasDoubleHeatSinks() ? 6000 : 2000;</span>
        // cost of sinks
<span class="nc" id="L5412">        costs[i++] = sinkCost * (heatSinks() - freeSinks);</span>
<span class="nc bnc" id="L5413" title="All 2 branches missed.">        costs[i++] = hasFullHeadEject() ? 1725000 : 0;</span>
        // armored components
<span class="nc" id="L5415">        int armoredCrits = 0;</span>
<span class="nc bnc" id="L5416" title="All 2 branches missed.">        for (int j = 0; j &lt; locations(); j++) {</span>
<span class="nc" id="L5417">            int numCrits = getNumberOfCriticals(j);</span>
<span class="nc bnc" id="L5418" title="All 2 branches missed.">            for (int k = 0; k &lt; numCrits; k++) {</span>
<span class="nc" id="L5419">                CriticalSlot ccs = getCritical(j, k);</span>
<span class="nc bnc" id="L5420" title="All 4 branches missed.">                if ((ccs != null) &amp;&amp; ccs.isArmored()</span>
<span class="nc bnc" id="L5421" title="All 2 branches missed.">                        &amp;&amp; (ccs.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L5422">                    armoredCrits++;</span>
                }
            }
        }
<span class="nc" id="L5426">        costs[i++] = armoredCrits * 150000;</span>

        // armor
<span class="nc bnc" id="L5429" title="All 2 branches missed.">        if (hasPatchworkArmor()) {</span>
<span class="nc bnc" id="L5430" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L5431">                costs[i++] += getArmorWeight(loc)</span>
<span class="nc" id="L5432">                        * EquipmentType.getArmorCost(armorType[loc]);</span>
            }
        } else {
<span class="nc" id="L5435">            costs[i++] += getArmorWeight()</span>
<span class="nc" id="L5436">                    * EquipmentType.getArmorCost(armorType[0]);</span>
        }

<span class="nc" id="L5439">        double weaponCost = getWeaponsAndEquipmentCost(ignoreAmmo);</span>
<span class="nc" id="L5440">        costs[i++] = weaponCost;</span>

<span class="nc bnc" id="L5442" title="All 2 branches missed.">        if (this instanceof LandAirMech) {</span>
<span class="nc" id="L5443">            costs[i++] = (structureCost + weaponCost)</span>
<span class="nc bnc" id="L5444" title="All 2 branches missed.">                    * (((LandAirMech)this).getLAMType() == LandAirMech.LAM_BIMODAL? 0.65 : 0.75);</span>
<span class="nc bnc" id="L5445" title="All 2 branches missed.">        } else if (this instanceof QuadVee) {</span>
<span class="nc" id="L5446">            costs[i++] = (structureCost + weaponCost) * 0.5;</span>
        } else {
<span class="nc" id="L5448">            costs[i++] = 0;</span>
        }

<span class="nc" id="L5451">        double cost = 0; // calculate the total</span>
<span class="nc bnc" id="L5452" title="All 2 branches missed.">        for (int x = 0; x &lt; i; x++) {</span>
<span class="nc" id="L5453">            cost += costs[x];</span>
        }
        // TODO Decouple cost calculation from addCostDetails and eliminate duplicate code in getPriceMultiplier
<span class="nc" id="L5456">        double quirkMultiplier = 0;</span>
<span class="nc bnc" id="L5457" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_GOOD_REP_1)) {</span>
<span class="nc" id="L5458">        	quirkMultiplier = 1.1f;</span>
<span class="nc" id="L5459">        	cost *= quirkMultiplier;</span>
<span class="nc bnc" id="L5460" title="All 2 branches missed.">        } else if (hasQuirk(OptionsConstants.QUIRK_POS_GOOD_REP_2)) {</span>
<span class="nc" id="L5461">        	quirkMultiplier = 1.25f;</span>
<span class="nc" id="L5462">        	cost *= quirkMultiplier;</span>
        }
<span class="nc" id="L5464">        costs[i++] = -quirkMultiplier; // negative just marks it as multiplier</span>

<span class="nc" id="L5466">        double omniMultiplier = 0;</span>
<span class="nc bnc" id="L5467" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L5468">            omniMultiplier = 1.25f;</span>
<span class="nc" id="L5469">            cost *= omniMultiplier;</span>
        }
<span class="nc" id="L5471">        costs[i++] = -omniMultiplier; // negative just marks it as multiplier</span>

<span class="nc" id="L5473">        double weightMultiplier = 1 + (weight / 100f);</span>
<span class="nc bnc" id="L5474" title="All 2 branches missed.">        if (isIndustrial()) {</span>
<span class="nc" id="L5475">            weightMultiplier = 1 + (weight / 400f);</span>
        }
<span class="nc" id="L5477">        costs[i++] = -weightMultiplier; // negative just marks it as multiplier</span>
<span class="nc" id="L5478">        cost = Math.round(cost * weightMultiplier);</span>
<span class="nc" id="L5479">        addCostDetails(cost, costs);</span>
<span class="nc" id="L5480">        return cost;</span>
    }

    @Override
    public double getPriceMultiplier() {
<span class="nc" id="L5485">        double priceMultiplier = 1.0f;</span>
<span class="nc bnc" id="L5486" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_GOOD_REP_1)) {</span>
<span class="nc" id="L5487">            priceMultiplier *= 1.1f;</span>
<span class="nc bnc" id="L5488" title="All 2 branches missed.">        } else if (hasQuirk(OptionsConstants.QUIRK_POS_GOOD_REP_2)) {</span>
<span class="nc" id="L5489">            priceMultiplier *= 1.25f;</span>
        }
        // TODO Negative price quirks (Bad Reputation)

<span class="nc bnc" id="L5493" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L5494">            priceMultiplier *= 1.25f;</span>
        }

        // Weight multiplier
<span class="nc" id="L5498">        priceMultiplier *= 1 + (weight / 100f);</span>
<span class="nc bnc" id="L5499" title="All 2 branches missed.">        if (isIndustrial()) {</span>
<span class="nc" id="L5500">            priceMultiplier = 1 + (weight / 400f);</span>
        }
<span class="nc" id="L5502">        return priceMultiplier;</span>
    }

    @Override
    protected int implicitClanCASE() {
<span class="nc bnc" id="L5507" title="All 2 branches missed.">        if (!isClan()) {</span>
<span class="nc" id="L5508">            return 0;</span>
        }
<span class="nc" id="L5510">        int explicit = 0;</span>
<span class="nc" id="L5511">        Set&lt;Integer&gt; caseLocations = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L5512" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5513" title="All 4 branches missed.">            if ((m.getType() instanceof MiscType) &amp;&amp; (m.getType().hasFlag(MiscType.F_CASE))) {</span>
<span class="nc" id="L5514">                explicit++;</span>
<span class="nc bnc" id="L5515" title="All 2 branches missed.">            } else if (m.getType().isExplosive(m)) {</span>
<span class="nc" id="L5516">                caseLocations.add(m.getLocation());</span>
<span class="nc bnc" id="L5517" title="All 2 branches missed.">                if (m.getSecondLocation() &gt;= 0) {</span>
<span class="nc" id="L5518">                    caseLocations.add(m.getSecondLocation());</span>
                }
            }
<span class="nc" id="L5521">        }</span>
<span class="nc" id="L5522">        return Math.max(0, caseLocations.size() - explicit);</span>
    }

    private void addCostDetails(double cost, double[] costs) {
<span class="nc" id="L5526">        bvText = new StringBuffer();</span>
<span class="nc" id="L5527">        String[] left = { &quot;Cockpit&quot;, &quot;Life Support&quot;, &quot;Sensors&quot;, &quot;Myomer&quot;,</span>
                &quot;Structure&quot;, &quot;Actuators&quot;, &quot;Engine&quot;, &quot;Gyro&quot;, &quot;Jump Jets&quot;,
                &quot;Heatsinks&quot;, &quot;Full Head Ejection System&quot;,
                &quot;Armored System Components&quot;, &quot;Armor&quot;, &quot;Equipment&quot;,
                &quot;Conversion Equipment&quot;, &quot;Quirk Multiplier&quot;, &quot;Omni Multiplier&quot;, &quot;Weight Multiplier&quot; };

<span class="nc" id="L5533">        NumberFormat commafy = NumberFormat.getInstance();</span>

<span class="nc" id="L5535">        bvText.append(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Cost Calculations For &quot;);</span>
<span class="nc" id="L5536">        bvText.append(getChassis());</span>
<span class="nc" id="L5537">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L5538">        bvText.append(getModel());</span>
<span class="nc" id="L5539">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L5540">        bvText.append(nl);</span>

<span class="nc" id="L5542">        bvText.append(startTable);</span>
        // find the maximum length of the columns.
<span class="nc bnc" id="L5544" title="All 2 branches missed.">        for (int l = 0; l &lt; left.length; l++) {</span>

<span class="nc bnc" id="L5546" title="All 2 branches missed.">            if (l == 13) {</span>
<span class="nc" id="L5547">                getWeaponsAndEquipmentCost(true);</span>
            } else {
<span class="nc" id="L5549">                bvText.append(startRow);</span>
<span class="nc" id="L5550">                bvText.append(startColumn);</span>
<span class="nc" id="L5551">                bvText.append(left[l]);</span>
<span class="nc" id="L5552">                bvText.append(endColumn);</span>
<span class="nc" id="L5553">                bvText.append(startColumn);</span>

<span class="nc bnc" id="L5555" title="All 2 branches missed.">                if (costs[l] == 0) {</span>
<span class="nc" id="L5556">                    bvText.append(&quot;N/A&quot;);</span>
<span class="nc bnc" id="L5557" title="All 2 branches missed.">                } else if (costs[l] &lt; 0) {</span>
<span class="nc" id="L5558">                    bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L5559">                    bvText.append(commafy.format(-costs[l]));</span>
                } else {
<span class="nc" id="L5561">                    bvText.append(commafy.format(costs[l]));</span>

                }
<span class="nc" id="L5564">                bvText.append(endColumn);</span>
<span class="nc" id="L5565">                bvText.append(endRow);</span>
            }
        }
<span class="nc" id="L5568">        bvText.append(startRow);</span>
<span class="nc" id="L5569">        bvText.append(startColumn);</span>
<span class="nc" id="L5570">        bvText.append(endColumn);</span>
<span class="nc" id="L5571">        bvText.append(startColumn);</span>
<span class="nc" id="L5572">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L5573">        bvText.append(endColumn);</span>
<span class="nc" id="L5574">        bvText.append(endRow);</span>

<span class="nc" id="L5576">        bvText.append(startRow);</span>
<span class="nc" id="L5577">        bvText.append(startColumn);</span>
<span class="nc" id="L5578">        bvText.append(&quot;Total Cost:&quot;);</span>
<span class="nc" id="L5579">        bvText.append(endColumn);</span>
<span class="nc" id="L5580">        bvText.append(startColumn);</span>
<span class="nc" id="L5581">        bvText.append(commafy.format(cost));</span>
<span class="nc" id="L5582">        bvText.append(endColumn);</span>
<span class="nc" id="L5583">        bvText.append(endRow);</span>

<span class="nc" id="L5585">        bvText.append(endTable);</span>
<span class="nc" id="L5586">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>
        /*
         * maxLeft += 5; // leave some padding in the middle maxRight =
         * Math.max(maxRight, commafy.format(cost).length()); for (int i = 0; i
         * &lt; left.length; i++) { String both; if (costs[i] &lt; 0) { // negative
         * marks it as a multiplier both = StringUtil.makeLength(left[i],
         * maxLeft) + StringUtil.makeLength(&quot;x&quot; + commafy.format(costs[i] -1),
         * maxRight, true); } else if (costs[i] == 0) { both =
         * StringUtil.makeLength(left[i], maxLeft) +
         * StringUtil.makeLength(&quot;N/A&quot;, maxRight, true); } else { both =
         * StringUtil.makeLength(left[i], maxLeft) +
         * StringUtil.makeLength(commafy.format(costs[i]), maxRight, true); }
         * detail.append(both + &quot;\n&quot;); totalLineLength = both.length(); } for
         * (int x = 0; x &lt; totalLineLength; x++) { detail.append(&quot;-&quot;); }
         * detail.append(&quot;\n&quot; + StringUtil.makeLength(&quot;Total Cost:&quot;, maxLeft) +
         * StringUtil.makeLength(commafy.format(cost), maxRight, true));
         */
<span class="nc" id="L5603">    }</span>

    protected double getActuatorCost() {
<span class="nc" id="L5606">        return getArmActuatorCost() + getLegActuatorCost();</span>
    }

    protected abstract double getArmActuatorCost();

    protected abstract double getLegActuatorCost();

    @Override
    public Vector&lt;Report&gt; victoryReport() {
<span class="nc" id="L5615">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>

<span class="nc" id="L5617">        Report r = new Report(7025);</span>
<span class="nc" id="L5618">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L5619">        r.addDesc(this);</span>
<span class="nc" id="L5620">        vDesc.addElement(r);</span>

<span class="nc" id="L5622">        r = new Report(7030);</span>
<span class="nc" id="L5623">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L5624">        r.newlines = 0;</span>
<span class="nc" id="L5625">        vDesc.addElement(r);</span>
<span class="nc" id="L5626">        vDesc.addAll(getCrew().getDescVector(false));</span>
<span class="nc" id="L5627">        r = new Report(7070, Report.PUBLIC);</span>
<span class="nc" id="L5628">        r.add(getKillNumber());</span>
<span class="nc" id="L5629">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L5631" title="All 2 branches missed.">        if (isDestroyed()) {</span>
<span class="nc" id="L5632">            Entity killer = game.getEntity(killerId);</span>
<span class="nc bnc" id="L5633" title="All 2 branches missed.">            if (killer == null) {</span>
<span class="nc" id="L5634">                killer = game.getOutOfGameEntity(killerId);</span>
            }
<span class="nc bnc" id="L5636" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L5637">                r = new Report(7072, Report.PUBLIC);</span>
<span class="nc" id="L5638">                r.addDesc(killer);</span>
            } else {
<span class="nc" id="L5640">                r = new Report(7073, Report.PUBLIC);</span>
            }
<span class="nc" id="L5642">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L5643" title="All 2 branches missed.">        } else if (getCrew().isEjected()){</span>
<span class="nc" id="L5644">            r = new Report(7074, Report.PUBLIC);</span>
<span class="nc" id="L5645">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L5647">        r.newlines = 2;</span>

<span class="nc" id="L5649">        return vDesc;</span>
    }

    /**
     * Add in any piloting skill mods
     */
    @Override
    public PilotingRollData addEntityBonuses(PilotingRollData roll) {
        // gyro hit?
<span class="nc bnc" id="L5658" title="All 2 branches missed.">        if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO,</span>
                Mech.LOC_CT) &gt; 0) {

<span class="nc bnc" id="L5661" title="All 2 branches missed.">            if (getGyroType() == Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc bnc" id="L5662" title="All 2 branches missed.">                if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO,</span>
                        Mech.LOC_CT) == 1) {
<span class="nc" id="L5664">                    roll.addModifier(1, &quot;HD Gyro damaged once&quot;);</span>
                } else {
<span class="nc" id="L5666">                    roll.addModifier(3, &quot;HD Gyro damaged twice&quot;);</span>
                }
            } else {
<span class="nc" id="L5669">                roll.addModifier(3, &quot;Gyro damaged&quot;);</span>
            }
        }

        // EI bonus?
<span class="nc bnc" id="L5674" title="All 2 branches missed.">        if (hasActiveEiCockpit()) {</span>
<span class="nc" id="L5675">            roll.addModifier(-1, &quot;Enhanced Imaging&quot;);</span>
        }

        // VDNI bonus?
<span class="nc bnc" id="L5679" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L5680" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L5681">            roll.addModifier(-1, &quot;VDNI&quot;);</span>
        }

        // Small/torso-mounted cockpit penalty?
<span class="nc bnc" id="L5685" title="All 4 branches missed.">        if (((getCockpitType() == Mech.COCKPIT_SMALL) || (getCockpitType() == Mech.COCKPIT_SMALL_COMMAND_CONSOLE))</span>
<span class="nc bnc" id="L5686" title="All 2 branches missed.">                &amp;&amp; (!hasAbility(OptionsConstants.MD_BVDNI)</span>
<span class="nc bnc" id="L5687" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.UNOFF_SMALL_PILOT))) {</span>
<span class="nc" id="L5688">            roll.addModifier(1, &quot;Small Cockpit&quot;);</span>
<span class="nc bnc" id="L5689" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED) {</span>
<span class="nc" id="L5690">            roll.addModifier(1, &quot;Torso-Mounted Cockpit&quot;);</span>
<span class="nc" id="L5691">            int sensorHits = getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.SYSTEM_SENSORS, Mech.LOC_HEAD);
<span class="nc" id="L5693">            int sensorHits2 = getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                    Mech.SYSTEM_SENSORS, Mech.LOC_CT);
<span class="nc bnc" id="L5695" title="All 2 branches missed.">            if ((sensorHits + sensorHits2) == 3) {</span>
<span class="nc" id="L5696">                roll.addModifier(4,</span>
                        &quot;Sensors Completely Destroyed for Torso-Mounted Cockpit&quot;);
<span class="nc bnc" id="L5698" title="All 2 branches missed.">            } else if (sensorHits == 2) {</span>
<span class="nc" id="L5699">                roll.addModifier(4,</span>
                        &quot;Head Sensors Destroyed for Torso-Mounted Cockpit&quot;);
            }
<span class="nc bnc" id="L5702" title="All 2 branches missed.">        } else if (getCockpitType() == Mech.COCKPIT_DUAL) {</span>
            //Dedicated pilot bonus is lost if pilot makes any attacks. Penalty for gunner acting as pilot.
<span class="nc bnc" id="L5704" title="All 2 branches missed.">            if (getCrew().getCurrentPilotIndex() != getCrew().getCrewType().getPilotPos()) {</span>
<span class="nc" id="L5705">                roll.addModifier(1, &quot;dual cockpit without active pilot&quot;);</span>
<span class="nc bnc" id="L5706" title="All 4 branches missed.">            } else if (getCrew().hasDedicatedGunner() || !isAttackingThisTurn()) {</span>
<span class="nc" id="L5707">                roll.addModifier(-1, &quot;dedicated pilot&quot;);</span>
            }
        }

<span class="nc bnc" id="L5711" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_CRAMPED_COCKPIT) &amp;&amp; !hasAbility(OptionsConstants.UNOFF_SMALL_PILOT)) {</span>
<span class="nc" id="L5712">            roll.addModifier(1, &quot;cramped cockpit&quot;);</span>
        }

<span class="nc bnc" id="L5715" title="All 2 branches missed.">        if (hasHardenedArmor()) {</span>
<span class="nc" id="L5716">            roll.addModifier(1, &quot;Hardened Armor&quot;);</span>
        }

<span class="nc bnc" id="L5719" title="All 2 branches missed.">        if (hasModularArmor()) {</span>
<span class="nc" id="L5720">            roll.addModifier(1, &quot;Modular Armor&quot;);</span>
        }
<span class="nc bnc" id="L5722" title="All 2 branches missed.">        if (hasIndustrialTSM()) {</span>
<span class="nc" id="L5723">            roll.addModifier(1, &quot;Industrial TSM&quot;);</span>
        }

<span class="nc" id="L5726">        return roll;</span>
    }

    @Override
    public int getMaxElevationChange() {
<span class="nc bnc" id="L5731" title="All 4 branches missed.">        if (movementMode == EntityMovementMode.TRACKED</span>
                || movementMode == EntityMovementMode.WIGE) {
<span class="nc" id="L5733">            return 1;</span>
        }
<span class="nc" id="L5735">        return 2;</span>
    }

    @Override
    public int getMaxElevationDown(int currElevation) {
<span class="nc bnc" id="L5740" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_LEAPING)) {</span>
<span class="nc" id="L5741">            return UNLIMITED_JUMP_DOWN;</span>
        }
<span class="nc" id="L5743">        return getMaxElevationChange();</span>
    }

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthActive() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L5759" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L5760">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L5761" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>

<span class="nc bnc" id="L5763" title="All 2 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;)</span>
<span class="nc bnc" id="L5764" title="All 2 branches missed.">                        &amp;&amp; hasActiveECM()) {</span>
                    // Return true if the mode is &quot;On&quot; and ECM is working
<span class="nc" id="L5766">                    return true;</span>
                }
            }
<span class="nc" id="L5769">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L5771">        return false;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthOn() {
        // Try to find a Mek Stealth system.
<span class="fc bfc" id="L5787" title="All 2 branches covered.">        for (Mounted mEquip : getMisc()) {</span>
<span class="fc" id="L5788">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="pc bpc" id="L5789" title="1 of 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>
<span class="nc bnc" id="L5790" title="All 2 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;)) {</span>
                    // Return true if the mode is &quot;On&quot;
<span class="nc" id="L5792">                    return true;</span>
                }
            }
<span class="fc" id="L5795">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="fc" id="L5797">        return false;</span>
    }

    /**
     * Does the mech have a functioning null signature system, or a void sig
     * that is acting as a a null sig because of externally carried BA?
     */
    @Override
    public boolean isNullSigActive() {
<span class="nc bnc" id="L5806" title="All 4 branches missed.">        if (isVoidSigOn() &amp;&amp; !isVoidSigActive()) {</span>
<span class="nc" id="L5807">            return true;</span>
        }
<span class="nc bnc" id="L5809" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5810" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5811">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5812" title="All 2 branches missed.">                if (type.hasFlag(MiscType.F_NULLSIG)</span>
<span class="nc bnc" id="L5813" title="All 4 branches missed.">                        &amp;&amp; m.curMode().equals(&quot;On&quot;) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L5814">                    return true;</span>
                }
<span class="nc" id="L5816">            }</span>
        }
<span class="nc" id="L5818">        return false;</span>
    }

    @Override
    public boolean isNullSigOn() {
<span class="nc bnc" id="L5823" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5824" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5825">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5826" title="All 2 branches missed.">                if (type.hasFlag(MiscType.F_NULLSIG)</span>
<span class="nc bnc" id="L5827" title="All 4 branches missed.">                        &amp;&amp; m.curMode().equals(&quot;On&quot;) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L5828">                    return true;</span>
                }
<span class="nc" id="L5830">            }</span>
        }
<span class="nc" id="L5832">        return false;</span>
    }

    /**
     * Does the mech have a functioning void signature system?
     */
    @Override
    public boolean isVoidSigActive() {
        // per the rules questions forum, externally mounted BA invalidates Void
        // Sig
<span class="nc bnc" id="L5842" title="All 2 branches missed.">        if (getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L5843">            return false;</span>
        }
<span class="nc bnc" id="L5845" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5846" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5847">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5848" title="All 2 branches missed.">                if (type.hasFlag(MiscType.F_VOIDSIG)</span>
<span class="nc bnc" id="L5849" title="All 4 branches missed.">                        &amp;&amp; m.curMode().equals(&quot;On&quot;) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L5850">                    return true;</span>
                }
<span class="nc" id="L5852">            }</span>
        }
<span class="nc" id="L5854">        return false;</span>
    }

    /**
     * Does the mech have a functioning void signature system?
     */
    @Override
    public boolean isVoidSigOn() {
<span class="nc bnc" id="L5862" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5863" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5864">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5865" title="All 2 branches missed.">                if (type.hasFlag(MiscType.F_VOIDSIG)</span>
<span class="nc bnc" id="L5866" title="All 4 branches missed.">                        &amp;&amp; m.curMode().equals(&quot;On&quot;) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L5867">                    return true;</span>
                }
<span class="nc" id="L5869">            }</span>
        }
<span class="nc" id="L5871">        return false;</span>
    }

    /**
     * Does the mech have a functioning Chameleon Light Polarization Field? For
     * a CLPS to be functioning it must be on and the unit can't have mounted
     * mechanized BattleArmor.
     */
    @Override
    public boolean isChameleonShieldActive() {
        // TO pg 300 states that generates heat but doesn't operate if the unit
        //  has mounted BA
<span class="nc bnc" id="L5883" title="All 2 branches missed.">        if (getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L5884">            return false;</span>
        }
<span class="nc bnc" id="L5886" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5887" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5888">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5889" title="All 2 branches missed.">                if (type.hasFlag(MiscType.F_CHAMELEON_SHIELD)</span>
<span class="nc bnc" id="L5890" title="All 4 branches missed.">                        &amp;&amp; m.curMode().equals(&quot;On&quot;) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L5891">                    return true;</span>
                }
<span class="nc" id="L5893">            }</span>
        }
<span class="nc" id="L5895">        return false;</span>
    }

    /**
     * Does the mech Chameleon Light Polarization Field turned on?  This is used
     * for heat generation purposes.  A CLPS can be on and generating heat but
     * not providing any benefit if the unit has mechanized BattleArmor.
     */
    @Override
    public boolean isChameleonShieldOn() {
<span class="nc bnc" id="L5905" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5906" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5907">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5908" title="All 2 branches missed.">                if (type.hasFlag(MiscType.F_CHAMELEON_SHIELD)</span>
<span class="nc bnc" id="L5909" title="All 4 branches missed.">                        &amp;&amp; m.curMode().equals(&quot;On&quot;) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L5910">                    return true;</span>
                }
<span class="nc" id="L5912">            }</span>
        }
<span class="nc" id="L5914">        return false;</span>
    }

    /**
     * Determine the stealth modifier for firing at this unit from the given
     * range. If the value supplied for &lt;code&gt;range&lt;/code&gt; is not one of the
     * &lt;code&gt;Entity&lt;/code&gt; class range constants, an
     * &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @param range
     *            - an &lt;code&gt;int&lt;/code&gt; value that must match one of the
     *            &lt;code&gt;Compute&lt;/code&gt; class range constants.
     * @param ae
     *            - entity making the attack
     * @return a &lt;code&gt;TargetRoll&lt;/code&gt; value that contains the stealth
     *         modifier for the given range.
     */
    @Override
    public TargetRoll getStealthModifier(int range, Entity ae) {
<span class="nc" id="L5935">        TargetRoll result = null;</span>

        // can't combine void sig and stealth or null-sig
<span class="nc bnc" id="L5938" title="All 2 branches missed.">        if (isVoidSigActive()) {</span>
<span class="nc" id="L5939">            int mmod = 3;</span>
<span class="nc bnc" id="L5940" title="All 2 branches missed.">            if (delta_distance &gt; 5) {</span>
<span class="nc" id="L5941">                mmod = 0;</span>
<span class="nc bnc" id="L5942" title="All 2 branches missed.">            } else if (delta_distance &gt; 2) {</span>
<span class="nc" id="L5943">                mmod = 1;</span>
<span class="nc bnc" id="L5944" title="All 2 branches missed.">            } else if (delta_distance &gt; 0) {</span>
<span class="nc" id="L5945">                mmod = 2;</span>
            }
<span class="nc" id="L5947">            return new TargetRoll(mmod, &quot;void signature&quot;);</span>
        }

<span class="nc" id="L5950">        final boolean isInfantry = ae.isConventionalInfantry();</span>
        // Stealth or null sig must be active.
<span class="nc bnc" id="L5952" title="All 6 branches missed.">        if (!isStealthActive() &amp;&amp; !isNullSigActive() &amp;&amp; !isChameleonShieldActive()) {</span>
<span class="nc" id="L5953">            result = new TargetRoll(0, &quot;stealth not active&quot;);</span>
        }
        // Determine the modifier based upon the range.
        // Infantry do not ignore Chameleon LPS!!!
        else {
<span class="nc bnc" id="L5958" title="All 5 branches missed.">            switch (range) {</span>
                case RangeType.RANGE_MINIMUM:
                case RangeType.RANGE_SHORT:
<span class="nc bnc" id="L5961" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5962">                        result = new TargetRoll(0, &quot;stealth&quot;);</span>
<span class="nc bnc" id="L5963" title="All 2 branches missed.">                    } else if (isChameleonShieldActive()) {</span>
<span class="nc" id="L5964">                        result = new TargetRoll(0, &quot;chameleon&quot;);</span>
<span class="nc bnc" id="L5965" title="All 4 branches missed.">                        if (isNullSigActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5966">                            result.addModifier(0, &quot;null-sig&quot;);</span>
                        }
<span class="nc bnc" id="L5968" title="All 4 branches missed.">                    } else if (isNullSigActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5969">                        result = new TargetRoll(0, &quot;null-sig&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L5972">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L5974">                    break;</span>
                case RangeType.RANGE_MEDIUM:
<span class="nc bnc" id="L5976" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5977">                        result = new TargetRoll(1, &quot;stealth&quot;);</span>
<span class="nc bnc" id="L5978" title="All 2 branches missed.">                    } else if (isChameleonShieldActive()) {</span>
<span class="nc" id="L5979">                        result = new TargetRoll(1, &quot;chameleon&quot;);</span>
<span class="nc bnc" id="L5980" title="All 4 branches missed.">                        if (isNullSigActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5981">                            result.addModifier(1, &quot;null-sig&quot;);</span>
                        }
<span class="nc bnc" id="L5983" title="All 4 branches missed.">                    } else if (isNullSigActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5984">                        result = new TargetRoll(1, &quot;null-sig&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L5987">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L5989">                    break;</span>
                case RangeType.RANGE_LONG:
                case RangeType.RANGE_EXTREME:
                case RangeType.RANGE_LOS:
<span class="nc bnc" id="L5993" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5994">                        result = new TargetRoll(2, &quot;stealth&quot;);</span>
<span class="nc bnc" id="L5995" title="All 2 branches missed.">                    } else if (isChameleonShieldActive()) {</span>
<span class="nc" id="L5996">                        result = new TargetRoll(2, &quot;chameleon&quot;);</span>
<span class="nc bnc" id="L5997" title="All 4 branches missed.">                        if (isNullSigActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L5998">                            result.addModifier(2, &quot;null-sig&quot;);</span>
                        }
<span class="nc bnc" id="L6000" title="All 4 branches missed.">                    } else if (isNullSigActive() &amp;&amp; !isInfantry) {</span>
<span class="nc" id="L6001">                        result = new TargetRoll(2, &quot;null-sig&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L6004">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L6006">                    break;</span>
                case RangeType.RANGE_OUT:
<span class="nc" id="L6008">                    break;</span>
                default:
<span class="nc" id="L6010">                    throw new IllegalArgumentException(&quot;Unknown range constant: &quot; + range);</span>
            }
        }

        // Return the result.
<span class="nc" id="L6015">        return result;</span>

    } // End public TargetRoll getStealthModifier( char )

    /**
     * Determine if the unit can be repaired, or only harvested for spares.
     *
     * @return A &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit can
     *         be repaired (given enough time and parts); if this value is
     *         &lt;code&gt;false&lt;/code&gt;, the unit is only a source of spares.
     * @see Entity#isSalvage()
     */
    @Override
    public boolean isRepairable() {
        // A Mech is repairable if it is salvageable,
        // and its CT internals are not gone.
<span class="nc" id="L6031">        int loc_is = this.getInternal(Mech.LOC_CT);</span>
<span class="nc bnc" id="L6032" title="All 6 branches missed.">        return isSalvage() &amp;&amp; (loc_is != IArmorState.ARMOR_DOOMED)</span>
                &amp;&amp; (loc_is != IArmorState.ARMOR_DESTROYED);
    }

    @Override
    public boolean canCharge() {
        // Mechs can charge, unless they are Clan and the &quot;no clan physicals&quot;
        // option is set
<span class="nc bnc" id="L6040" title="All 2 branches missed.">        return super.canCharge()</span>
<span class="nc bnc" id="L6041" title="All 4 branches missed.">                &amp;&amp; !(game.getOptions().booleanOption(OptionsConstants.ALLOWED_NO_CLAN_PHYSICAL) &amp;&amp; isClan());</span>
    }

    @Override
    public boolean canDFA() {
        // Mechs can DFA, unless they are Clan and the &quot;no clan physicals&quot;
        // option is set
<span class="nc bnc" id="L6048" title="All 2 branches missed.">        return super.canDFA()</span>
<span class="nc bnc" id="L6049" title="All 4 branches missed.">                &amp;&amp; !(game.getOptions().booleanOption(OptionsConstants.ALLOWED_NO_CLAN_PHYSICAL) &amp;&amp; isClan());</span>
    }

    // gives total number of sinks
    public int getNumberOfSinks() {
<span class="fc" id="L6054">        int sinks = 0;</span>
<span class="fc bfc" id="L6055" title="All 2 branches covered.">        for (Mounted mounted : getMisc()) {</span>
<span class="pc bpc" id="L6056" title="2 of 4 branches missed.">            if (mounted.isDestroyed() || mounted.isBreached()) {</span>
<span class="nc" id="L6057">                continue;</span>
            }
<span class="fc bfc" id="L6059" title="All 2 branches covered.">            if (mounted.getType().hasFlag(MiscType.F_HEAT_SINK)) {</span>
<span class="fc" id="L6060">                sinks++;</span>
<span class="fc bfc" id="L6061" title="All 2 branches covered.">            } else if (mounted.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)) {</span>
<span class="fc" id="L6062">                sinks++;</span>
            }
<span class="fc" id="L6064">        }</span>
<span class="fc" id="L6065">        return sinks;</span>
    }

    public boolean hasDoubleHeatSinks() {
<span class="nc bnc" id="L6069" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L6070" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_HEAT_SINK)) {</span>
<span class="nc" id="L6071">                return false;</span>
<span class="nc bnc" id="L6072" title="All 2 branches missed.">            } else if (mounted.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)) {</span>
<span class="nc" id="L6073">                return true;</span>
            }
<span class="nc" id="L6075">        }</span>
<span class="nc" id="L6076">        return false;</span>
    }

    public boolean hasLaserHeatSinks() {
<span class="nc bnc" id="L6080" title="All 2 branches missed.">        if (hasLaserHeatSinks == HAS_UNKNOWN) {</span>
<span class="nc bnc" id="L6081" title="All 2 branches missed.">            for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L6082" title="All 2 branches missed.">                if (mounted.getType().hasFlag(MiscType.F_HEAT_SINK)) {</span>
<span class="nc" id="L6083">                    hasLaserHeatSinks = HAS_FALSE;</span>
<span class="nc" id="L6084">                    break;</span>
<span class="nc" id="L6085">                } else if (mounted.getType()</span>
<span class="nc bnc" id="L6086" title="All 2 branches missed.">                        .hasFlag(MiscType.F_LASER_HEAT_SINK)) {</span>
<span class="nc" id="L6087">                    hasLaserHeatSinks = HAS_TRUE;</span>
<span class="nc" id="L6088">                    break;</span>
                }
<span class="nc" id="L6090">            }</span>
<span class="nc bnc" id="L6091" title="All 2 branches missed.">            if (hasLaserHeatSinks == HAS_UNKNOWN) {</span>
<span class="nc" id="L6092">                hasLaserHeatSinks = HAS_FALSE;</span>
            }
        }
<span class="nc bnc" id="L6095" title="All 2 branches missed.">        return hasLaserHeatSinks == HAS_TRUE;</span>
    }

    public void setActiveSinksNextRound(int sinks) {
<span class="nc" id="L6099">        sinksOnNextRound = sinks;</span>
<span class="nc" id="L6100">    }</span>

    public int getActiveSinks() {
<span class="pc bpc" id="L6103" title="1 of 2 branches missed.">        if (sinksOn &lt; 0) {</span>
<span class="fc" id="L6104">            sinksOn = getNumberOfSinks();</span>
<span class="fc" id="L6105">            sinksOnNextRound = sinksOn;</span>
        }
<span class="fc" id="L6107">        return sinksOn;</span>
    }

    public void resetSinks() {
<span class="nc" id="L6111">        sinksOn = getNumberOfSinks();</span>
<span class="nc" id="L6112">    }</span>

    public int getActiveSinksNextRound() {
<span class="nc bnc" id="L6115" title="All 2 branches missed.">        if (sinksOnNextRound &lt; 0) {</span>
<span class="nc" id="L6116">            return getActiveSinks();</span>
        }
<span class="nc" id="L6118">        return sinksOnNextRound;</span>
    }

    /**
     * @return Returns the autoEject.
     */
    public boolean isAutoEject() {
<span class="nc" id="L6125">        boolean hasEjectSeat = true;</span>
<span class="nc bnc" id="L6126" title="All 2 branches missed.">        if (getCockpitType() == COCKPIT_TORSO_MOUNTED</span>
<span class="nc bnc" id="L6127" title="All 2 branches missed.">                || hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT)) {</span>
<span class="nc" id="L6128">            hasEjectSeat = false;</span>
        }
<span class="nc bnc" id="L6130" title="All 2 branches missed.">        if (isIndustrial()) {</span>
            // industrials can only eject when they have an ejection seat
<span class="nc bnc" id="L6132" title="All 2 branches missed.">            for (Mounted misc : miscList) {</span>
<span class="nc bnc" id="L6133" title="All 2 branches missed.">                if (misc.getType().hasFlag(MiscType.F_EJECTION_SEAT)) {</span>
<span class="nc" id="L6134">                    hasEjectSeat = true;</span>
                }
<span class="nc" id="L6136">            }</span>
        }
<span class="nc bnc" id="L6138" title="All 4 branches missed.">        return autoEject &amp;&amp; hasEjectSeat;</span>
    }

    /**
     * @param autoEject
     *            The autoEject to set.
     */
    public void setAutoEject(boolean autoEject) {
<span class="nc" id="L6146">        this.autoEject = autoEject;</span>
<span class="nc" id="L6147">    }</span>

    /**
     * @return Conditional Ejection Ammo
     */
    public boolean isCondEjectAmmo() {
<span class="nc" id="L6153">        return condEjectAmmo;</span>
    }

    /**
     * @param condEjectAmmo
     *            The condEjectAmmo to set.
     */
    public void setCondEjectAmmo(boolean condEjectAmmo) {
<span class="nc" id="L6161">        this.condEjectAmmo = condEjectAmmo;</span>
<span class="nc" id="L6162">    }</span>

    /**
     * @return Conditional Ejection Engine
     */
    public boolean isCondEjectEngine() {
<span class="nc" id="L6168">        return condEjectEngine;</span>
    }

    /**
     * @param condEjectEngine
     *            The condEjectEngine to set.
     */
    public void setCondEjectEngine(boolean condEjectEngine) {
<span class="nc" id="L6176">        this.condEjectEngine = condEjectEngine;</span>
<span class="nc" id="L6177">    }</span>

    /**
     * @return Conditional Ejection CTDest
     */
    public boolean isCondEjectCTDest() {
<span class="nc" id="L6183">        return condEjectCTDest;</span>
    }

    /**
     * @param condEjectCTDest
     *            The condEjectCTDest to set.
     */
    public void setCondEjectCTDest(boolean condEjectCTDest) {
<span class="nc" id="L6191">        this.condEjectCTDest = condEjectCTDest;</span>
<span class="nc" id="L6192">    }</span>

    /**
     * @return Conditional Ejection Headshot
     */
    public boolean isCondEjectHeadshot() {
<span class="nc" id="L6198">        return condEjectHeadshot;</span>
    }

    /**
     * @param condEjectHeadshot
     *            The condEjectHeadshot to set.
     */
    public void setCondEjectHeadshot(boolean condEjectHeadshot) {
<span class="nc" id="L6206">        this.condEjectHeadshot = condEjectHeadshot;</span>
<span class="nc" id="L6207">    }</span>

    @Override
    public boolean removePartialCoverHits(int location, int cover, int side) {
        // left and right cover are from attacker's POV.
        // if hitting front arc, need to swap them

        // Handle upper cover specially, as treating it as a bitmask will lead
        //  to every location being covered
<span class="nc bnc" id="L6216" title="All 2 branches missed.">        if (cover  == LosEffects.COVER_UPPER) {</span>
<span class="nc bnc" id="L6217" title="All 4 branches missed.">            if ((location == Mech.LOC_LLEG) || (location == Mech.LOC_RLEG)) {</span>
<span class="nc" id="L6218">                return false;</span>
            } else {
<span class="nc" id="L6220">                return true;</span>
            }
        }

<span class="nc bnc" id="L6224" title="All 2 branches missed.">        if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc bnc" id="L6225" title="All 4 branches missed.">            if (((cover &amp; LosEffects.COVER_LOWRIGHT) != 0)</span>
                    &amp;&amp; (location == Mech.LOC_LLEG)) {
<span class="nc" id="L6227">                return true;</span>
            }
<span class="nc bnc" id="L6229" title="All 4 branches missed.">            if (((cover &amp; LosEffects.COVER_LOWLEFT) != 0)</span>
                    &amp;&amp; (location == Mech.LOC_RLEG)) {
<span class="nc" id="L6231">                return true;</span>
            }
<span class="nc bnc" id="L6233" title="All 8 branches missed.">            if (((cover &amp; LosEffects.COVER_RIGHT) != 0)</span>
                    &amp;&amp; ((location == Mech.LOC_LARM)
                            || (location == Mech.LOC_LT) || (location == Mech.LOC_LLEG))) {
<span class="nc" id="L6236">                return true;</span>
            }
<span class="nc bnc" id="L6238" title="All 8 branches missed.">            if (((cover &amp; LosEffects.COVER_LEFT) != 0)</span>
                    &amp;&amp; ((location == Mech.LOC_RARM)
                            || (location == Mech.LOC_RT) || (location == Mech.LOC_RLEG))) {
<span class="nc" id="L6241">                return true;</span>
            }
        } else {
<span class="nc bnc" id="L6244" title="All 4 branches missed.">            if (((cover &amp; LosEffects.COVER_LOWLEFT) != 0)</span>
                    &amp;&amp; (location == Mech.LOC_LLEG)) {
<span class="nc" id="L6246">                return true;</span>
            }
<span class="nc bnc" id="L6248" title="All 4 branches missed.">            if (((cover &amp; LosEffects.COVER_LOWRIGHT) != 0)</span>
                    &amp;&amp; (location == Mech.LOC_RLEG)) {
<span class="nc" id="L6250">                return true;</span>
            }
<span class="nc bnc" id="L6252" title="All 8 branches missed.">            if (((cover &amp; LosEffects.COVER_LEFT) != 0)</span>
                    &amp;&amp; ((location == Mech.LOC_LARM)
                            || (location == Mech.LOC_LT) || (location == Mech.LOC_LLEG))) {
<span class="nc" id="L6255">                return true;</span>
            }
<span class="nc bnc" id="L6257" title="All 8 branches missed.">            if (((cover &amp; LosEffects.COVER_RIGHT) != 0)</span>
                    &amp;&amp; ((location == Mech.LOC_LARM)
                            || (location == Mech.LOC_LT) || (location == Mech.LOC_LLEG))) {
<span class="nc" id="L6260">                return true;</span>
            }
        }
<span class="nc" id="L6263">        return false;</span>
    }

    @Override
    public boolean doomedInExtremeTemp() {
<span class="nc" id="L6268">        return false;</span>
    }

    @Override
    public boolean doomedInVacuum() {
<span class="nc" id="L6273">        return false;</span>
    }

    @Override
    public boolean doomedOnGround() {
<span class="nc" id="L6278">        return false;</span>
    }

    @Override
    public boolean doomedInAtmosphere() {
<span class="nc" id="L6283">        return true;</span>
    }

    @Override
    public boolean doomedInSpace() {
<span class="nc" id="L6288">        return true;</span>
    }

    @Override
    public boolean hasEiCockpit() {
<span class="nc bnc" id="L6293" title="All 4 branches missed.">        return isClan() || super.hasEiCockpit();</span>
    }

    @Override
    public boolean hasActiveEiCockpit() {
<span class="nc bnc" id="L6298" title="All 2 branches missed.">        if (cockpitStatus == COCKPIT_OFF) {</span>
<span class="nc" id="L6299">            return false;</span>
        }
<span class="nc bnc" id="L6301" title="All 2 branches missed.">        if (getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_SENSORS,</span>
                Mech.LOC_HEAD) &gt; 0) {
<span class="nc" id="L6303">            return false;</span>
        }
<span class="nc" id="L6305">        return super.hasActiveEiCockpit();</span>
    }

    public int getCockpitStatus() {
<span class="nc" id="L6309">        return cockpitStatus;</span>
    }

    public int getCockpitStatusNextRound() {
<span class="nc" id="L6313">        return cockpitStatusNextRound;</span>
    }

    public void setCockpitStatus(int state) {
<span class="nc" id="L6317">        cockpitStatusNextRound = state;</span>
        // on/off allowed only in end phase
<span class="nc bnc" id="L6319" title="All 4 branches missed.">        if ((state != COCKPIT_OFF) &amp;&amp; (cockpitStatus != COCKPIT_OFF)) {</span>
<span class="nc" id="L6320">            cockpitStatus = state;</span>
        }
<span class="nc" id="L6322">    }</span>

    @Override
    public int getGyroType() {
<span class="fc" id="L6326">        return gyroType;</span>
    }

    public int getCockpitType() {
<span class="fc" id="L6330">        return cockpitType;</span>
    }

    public void setGyroType(int type) {
<span class="nc" id="L6334">        gyroType = type;</span>
<span class="nc" id="L6335">    }</span>

    public void setCockpitType(int type) {
<span class="nc" id="L6338">        cockpitType = type;</span>
<span class="nc" id="L6339">    }</span>

    public String getGyroTypeString() {
<span class="nc" id="L6342">        return Mech.getGyroTypeString(getGyroType());</span>
    }

    public String getCockpitTypeString() {
<span class="nc" id="L6346">        return Mech.getCockpitTypeString(getCockpitType());</span>
    }

    public static String getGyroTypeString(int inGyroType) {
<span class="nc bnc" id="L6350" title="All 4 branches missed.">        if ((inGyroType &lt; 0) || (inGyroType &gt;= GYRO_STRING.length)) {</span>
<span class="nc" id="L6351">            return &quot;Unknown&quot;;</span>
        }
<span class="nc" id="L6353">        return GYRO_STRING[inGyroType];</span>
    }

    public static String getGyroTypeShortString(int inGyroType) {
<span class="nc bnc" id="L6357" title="All 4 branches missed.">        if ((inGyroType &lt; 0) || (inGyroType &gt;= GYRO_SHORT_STRING.length)) {</span>
<span class="nc" id="L6358">            return &quot;Unknown&quot;;</span>
        }
<span class="nc" id="L6360">        return GYRO_SHORT_STRING[inGyroType];</span>
    }

    public static String getCockpitTypeString(int inCockpitType) {
<span class="nc bnc" id="L6364" title="All 4 branches missed.">        if ((inCockpitType &lt; 0) || (inCockpitType &gt;= COCKPIT_STRING.length)) {</span>
<span class="nc" id="L6365">            return &quot;Unknown&quot;;</span>
        }
<span class="nc" id="L6367">        return COCKPIT_STRING[inCockpitType];</span>
    }

    public static int getGyroTypeForString(String inType) {
<span class="pc bpc" id="L6371" title="2 of 4 branches missed.">        if ((inType == null) || (inType.length() &lt; 1)) {</span>
<span class="nc" id="L6372">            return GYRO_UNKNOWN;</span>
        }
<span class="pc bpc" id="L6374" title="1 of 2 branches missed.">        for (int x = 0; x &lt; GYRO_STRING.length; x++) {</span>
<span class="pc bpc" id="L6375" title="1 of 2 branches missed.">            if ((inType.equals(GYRO_STRING[x]))</span>
<span class="pc bpc" id="L6376" title="1 of 2 branches missed.">                    || (inType.equals(GYRO_SHORT_STRING[x]))) {</span>
<span class="fc" id="L6377">                return x;</span>
            }
        }
<span class="nc" id="L6380">        return GYRO_UNKNOWN;</span>
    }

    public static int getCockpitTypeForString(String inType) {
<span class="pc bpc" id="L6384" title="2 of 4 branches missed.">        if ((inType == null) || (inType.length() &lt; 1)) {</span>
<span class="nc" id="L6385">            return COCKPIT_UNKNOWN;</span>
        }
<span class="pc bpc" id="L6387" title="1 of 2 branches missed.">        for (int x = 0; x &lt; COCKPIT_STRING.length; x++) {</span>
<span class="pc bpc" id="L6388" title="1 of 2 branches missed.">            if ((inType.equals(COCKPIT_STRING[x]))</span>
<span class="pc bpc" id="L6389" title="1 of 2 branches missed.">                    || (inType.equals(COCKPIT_SHORT_STRING[x]))) {</span>
<span class="fc" id="L6390">                return x;</span>
            }
        }
<span class="nc" id="L6393">        return COCKPIT_UNKNOWN;</span>
    }

    public String getSystemName(int index) {
<span class="nc bnc" id="L6397" title="All 2 branches missed.">        if (index == SYSTEM_GYRO) {</span>
<span class="nc" id="L6398">            return Mech.getGyroDisplayString(gyroType);</span>
        }
<span class="nc bnc" id="L6400" title="All 2 branches missed.">        if (index == SYSTEM_COCKPIT) {</span>
<span class="nc bnc" id="L6401" title="All 4 branches missed.">            if (isIndustrial() &amp;&amp; (cockpitType == Mech.COCKPIT_STANDARD)) {</span>
<span class="nc" id="L6402">                return &quot;Industrial Cockpit (adv. FCS)&quot;;</span>
            }
<span class="nc" id="L6404">            return Mech.getCockpitDisplayString(cockpitType);</span>
        }
<span class="nc" id="L6406">        return systemNames[index];</span>
    }

    public String getRawSystemName(int index) {
<span class="fc" id="L6410">        return systemNames[index];</span>
    }

    public static String getGyroDisplayString(int inType) {
<span class="nc" id="L6414">        String inName = &quot;&quot;;</span>
<span class="nc bnc" id="L6415" title="All 7 branches missed.">        switch (inType) {</span>
            case GYRO_XL:
<span class="nc" id="L6417">                inName = &quot;GYRO_XL&quot;;</span>
<span class="nc" id="L6418">                break;</span>
            case GYRO_COMPACT:
<span class="nc" id="L6420">                inName = &quot;GYRO_COMPACT&quot;;</span>
<span class="nc" id="L6421">                break;</span>
            case GYRO_HEAVY_DUTY:
<span class="nc" id="L6423">                inName = &quot;GYRO_HEAVY_DUTY&quot;;</span>
<span class="nc" id="L6424">                break;</span>
            case GYRO_STANDARD:
<span class="nc" id="L6426">                inName = &quot;GYRO_STANDARD&quot;;</span>
<span class="nc" id="L6427">                break;</span>
            case GYRO_NONE:
<span class="nc" id="L6429">                inName = &quot;GYRO_NONE&quot;;</span>
<span class="nc" id="L6430">                break;</span>
            case GYRO_SUPERHEAVY:
<span class="nc" id="L6432">                inName = &quot;GYRO_SUPERHEAVY&quot;;</span>
<span class="nc" id="L6433">                break;</span>
            default:
<span class="nc" id="L6435">                inName = &quot;GYRO_UNKNOWN&quot;;</span>
        }
<span class="nc" id="L6437">        String result = EquipmentMessages</span>
<span class="nc" id="L6438">                .getString(&quot;SystemType.Gyro.&quot; + inName);</span>
<span class="nc bnc" id="L6439" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L6440">            return result;</span>
        }
<span class="nc" id="L6442">        return inName;</span>
    }

    public static String getCockpitDisplayString(int inType) {
<span class="nc" id="L6446">        String inName = &quot;&quot;;</span>
<span class="nc bnc" id="L6447" title="All 18 branches missed.">        switch (inType) {</span>
            case COCKPIT_COMMAND_CONSOLE:
<span class="nc" id="L6449">                inName = &quot;COCKPIT_COMMAND_CONSOLE&quot;;</span>
<span class="nc" id="L6450">                break;</span>
            case COCKPIT_SMALL:
<span class="nc" id="L6452">                inName = &quot;COCKPIT_SMALL&quot;;</span>
<span class="nc" id="L6453">                break;</span>
            case COCKPIT_TORSO_MOUNTED:
<span class="nc" id="L6455">                inName = &quot;COCKPIT_TORSO_MOUNTED&quot;;</span>
<span class="nc" id="L6456">                break;</span>
            case COCKPIT_DUAL:
<span class="nc" id="L6458">                inName = &quot;COCKPIT_DUAL&quot;;</span>
<span class="nc" id="L6459">                break;</span>
            case COCKPIT_STANDARD:
<span class="nc" id="L6461">                inName = &quot;COCKPIT_STANDARD&quot;;</span>
<span class="nc" id="L6462">                break;</span>
            case COCKPIT_INDUSTRIAL:
<span class="nc" id="L6464">                inName = &quot;COCKPIT_INDUSTRIAL&quot;;</span>
<span class="nc" id="L6465">                break;</span>
            case COCKPIT_PRIMITIVE:
<span class="nc" id="L6467">                inName = &quot;COCKPIT_PRIMITIVE&quot;;</span>
<span class="nc" id="L6468">                break;</span>
            case COCKPIT_PRIMITIVE_INDUSTRIAL:
<span class="nc" id="L6470">                inName = &quot;COCKPIT_PRIMITIVE_INDUSTRIAL&quot;;</span>
<span class="nc" id="L6471">                break;</span>
            case COCKPIT_SUPERHEAVY:
<span class="nc" id="L6473">                inName = &quot;COCKPIT_SUPERHEAVY&quot;;</span>
<span class="nc" id="L6474">                break;</span>
            case COCKPIT_SUPERHEAVY_TRIPOD:
<span class="nc" id="L6476">                inName = &quot;COCKPIT_SUPERHEAVY_TRIPOD&quot;;</span>
<span class="nc" id="L6477">                break;</span>
            case COCKPIT_TRIPOD:
<span class="nc" id="L6479">                inName = &quot;COCKPIT_TRIPOD&quot;;</span>
<span class="nc" id="L6480">                break;</span>
            case COCKPIT_INTERFACE:
<span class="nc" id="L6482">                inName = &quot;COCKPIT_INTERFACE&quot;;</span>
<span class="nc" id="L6483">                break;</span>
            case COCKPIT_VRRP:
<span class="nc" id="L6485">                inName = &quot;COCKPIT_VRRP&quot;;</span>
<span class="nc" id="L6486">                break;</span>
            case COCKPIT_QUADVEE:
<span class="nc" id="L6488">                inName = &quot;COCKPIT_QUADVEE&quot;;</span>
<span class="nc" id="L6489">                break;</span>
            case COCKPIT_SUPERHEAVY_INDUSTRIAL:
<span class="nc" id="L6491">                inName = &quot;COCKPIT_SUPERHEAVY_INDUSTRIAL&quot;;</span>
<span class="nc" id="L6492">                break;</span>
            case COCKPIT_SUPERHEAVY_COMMAND_CONSOLE:
<span class="nc" id="L6494">                inName = &quot;COCKPIT_SUPERHEAVY_COMMAND_CONSOLE&quot;;</span>
<span class="nc" id="L6495">                break;</span>
            case COCKPIT_SMALL_COMMAND_CONSOLE:
<span class="nc" id="L6497">                inName = &quot;COCKPIT_SMALL_COMMAND_CONSOLE&quot;;</span>
<span class="nc" id="L6498">                break;</span>
            default:
<span class="nc" id="L6500">                inName = &quot;COCKPIT_UNKNOWN&quot;;</span>
        }
<span class="nc" id="L6502">        String result = EquipmentMessages.getString(&quot;SystemType.Cockpit.&quot;</span>
                + inName);
<span class="nc bnc" id="L6504" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L6505">            return result;</span>
        }
<span class="nc" id="L6507">        return inName;</span>
    }

    @Override
    public boolean canAssaultDrop() {
<span class="nc" id="L6512">        return true;</span>
    }

    @Override
    public boolean isLocationProhibited(Coords c, int currElevation) {
<span class="nc" id="L6517">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L6518" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.IMPASSABLE)) {</span>
<span class="nc" id="L6519">            return true;</span>
        }

<span class="nc bnc" id="L6522" title="All 4 branches missed.">        if (hex.containsTerrain(Terrains.SPACE) &amp;&amp; doomedInSpace()) {</span>
<span class="nc" id="L6523">            return true;</span>
        }

        // Additional restrictions for hidden units
<span class="nc bnc" id="L6527" title="All 2 branches missed.">        if (isHidden()) {</span>
            // Can't deploy in paved hexes
<span class="nc bnc" id="L6529" title="All 2 branches missed.">            if ((hex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L6530" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.ROAD))</span>
<span class="nc bnc" id="L6531" title="All 2 branches missed.">                    &amp;&amp; (!hex.containsTerrain(Terrains.BUILDING)</span>
<span class="nc bnc" id="L6532" title="All 2 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.RUBBLE))){</span>
<span class="nc" id="L6533">                return true;</span>
            }
            // Can't deploy on a bridge
<span class="nc bnc" id="L6536" title="All 2 branches missed.">            if ((hex.terrainLevel(Terrains.BRIDGE_ELEV) == currElevation)</span>
<span class="nc bnc" id="L6537" title="All 2 branches missed.">                    &amp;&amp; hex.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L6538">                return true;</span>
            }
            // mechs can deploy in water if the water covers them entirely
<span class="nc bnc" id="L6541" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WATER) &amp;&amp; (hex.terrainLevel(Terrains.WATER) &lt; (height() + 1))) {</span>
<span class="nc" id="L6542">                return true;</span>
            }
            // Can't deploy in clear hex
<span class="nc bnc" id="L6545" title="All 2 branches missed.">            if (hex.isClearHex()) {</span>
<span class="nc" id="L6546">                return true;</span>
            }
        }
        // Mechs using tracks and QuadVees in vehicle mode (or converting to or from) have the same
        // restrictions and combat vehicles with the exception that QuadVees can enter water hexes
        // except during conversion.
<span class="nc bnc" id="L6552" title="All 6 branches missed.">        if (movementMode == EntityMovementMode.TRACKED</span>
                || (this instanceof QuadVee &amp;&amp; convertingNow
<span class="nc bnc" id="L6554" title="All 2 branches missed.">                        &amp;&amp; ((QuadVee)this).getMotiveType() == QuadVee.MOTIVE_TRACK)) {</span>
<span class="nc bnc" id="L6555" title="All 2 branches missed.">                return (hex.terrainLevel(Terrains.WOODS) &gt; 1)</span>
<span class="nc bnc" id="L6556" title="All 2 branches missed.">                        || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L6557" title="All 6 branches missed.">                                &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                                &amp;&amp; (!(this instanceof QuadVee) || convertingNow))
<span class="nc bnc" id="L6559" title="All 2 branches missed.">                        || hex.containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L6560" title="All 2 branches missed.">                        || (hex.terrainLevel(Terrains.MAGMA) &gt; 1)</span>
<span class="nc bnc" id="L6561" title="All 2 branches missed.">                        || (hex.terrainLevel(Terrains.ROUGH) &gt; 1)</span>
<span class="nc bnc" id="L6562" title="All 2 branches missed.">                        || (hex.terrainLevel(Terrains.RUBBLE) &gt; 5);</span>
        }
<span class="nc bnc" id="L6564" title="All 6 branches missed.">        if (movementMode == EntityMovementMode.WHEELED</span>
                || (this instanceof QuadVee &amp;&amp; convertingNow
<span class="nc bnc" id="L6566" title="All 2 branches missed.">                        &amp;&amp; ((QuadVee)this).getMotiveType() == QuadVee.MOTIVE_WHEEL)) {</span>
<span class="nc bnc" id="L6567" title="All 2 branches missed.">            return hex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L6568" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L6569" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.RUBBLE)</span>
<span class="nc bnc" id="L6570" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L6571" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L6572" title="All 2 branches missed.">                    || (hex.terrainLevel(Terrains.SNOW) &gt; 1)</span>
<span class="nc bnc" id="L6573" title="All 2 branches missed.">                    || (hex.terrainLevel(Terrains.GEYSER) == 2)</span>
<span class="nc bnc" id="L6574" title="All 2 branches missed.">                    || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L6575" title="All 4 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                            &amp;&amp; convertingNow);
        }

<span class="nc bnc" id="L6579" title="All 2 branches missed.">        return (hex.terrainLevel(Terrains.WOODS) &gt; 2)</span>
<span class="nc bnc" id="L6580" title="All 2 branches missed.">                || (hex.terrainLevel(Terrains.JUNGLE) &gt; 2);</span>
    }

    /**
     * Get an '.mtf' file representation of the mech. This string can be
     * directly written to disk as a file and later loaded by the MtfFile class.
     * Known missing level 3 features: mixed tech, laser heatsinks
     */
    public String getMtf() {
<span class="fc" id="L6589">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L6590">        String newLine = &quot;\n&quot;;</span>

<span class="pc bpc" id="L6592" title="1 of 2 branches missed.">        boolean standard = (getCockpitType() == Mech.COCKPIT_STANDARD)</span>
<span class="pc bpc" id="L6593" title="1 of 2 branches missed.">                &amp;&amp; (getGyroType() == Mech.GYRO_STANDARD);</span>
<span class="fc" id="L6594">        boolean fullHead = hasFullHeadEject();</span>
<span class="pc bpc" id="L6595" title="2 of 4 branches missed.">        if (standard &amp;&amp; !fullHead) {</span>
<span class="fc" id="L6596">            sb.append(&quot;Version:1.0&quot;).append(newLine);</span>
<span class="nc bnc" id="L6597" title="All 2 branches missed.">        } else if (!fullHead) {</span>
<span class="nc" id="L6598">            sb.append(&quot;Version:1.1&quot;).append(newLine);</span>
        } else {
<span class="nc" id="L6600">            sb.append(&quot;Version:1.2&quot;).append(newLine);</span>
        }
<span class="fc" id="L6602">        sb.append(chassis).append(newLine);</span>
<span class="fc" id="L6603">        sb.append(model).append(newLine);</span>
<span class="fc" id="L6604">        sb.append(newLine);</span>

<span class="fc" id="L6606">        sb.append(&quot;Config:&quot;);</span>
<span class="pc bpc" id="L6607" title="1 of 2 branches missed.">        if (this instanceof LandAirMech) {</span>
<span class="nc" id="L6608">            sb.append(&quot;LAM&quot;);</span>
<span class="pc bpc" id="L6609" title="1 of 2 branches missed.">        } else if (this instanceof BipedMech) {</span>
<span class="fc" id="L6610">            sb.append(&quot;Biped&quot;);</span>
<span class="nc bnc" id="L6611" title="All 2 branches missed.">        } else if (this instanceof QuadVee) {</span>
<span class="nc" id="L6612">            sb.append(&quot;QuadVee&quot;);</span>
<span class="nc bnc" id="L6613" title="All 2 branches missed.">        } else if (this instanceof QuadMech) {</span>
<span class="nc" id="L6614">            sb.append(&quot;Quad&quot;);</span>
<span class="nc bnc" id="L6615" title="All 2 branches missed.">        } else if (this instanceof TripodMech) {</span>
<span class="nc" id="L6616">            sb.append(&quot;Tripod&quot;);</span>
        }

<span class="pc bpc" id="L6619" title="1 of 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L6620">            sb.append(&quot; Omnimech&quot;);</span>
        }

<span class="fc" id="L6623">        sb.append(newLine);</span>
<span class="fc" id="L6624">        sb.append(MtfFile.TECH_BASE);</span>
<span class="pc bpc" id="L6625" title="1 of 2 branches missed.">        if (isMixedTech()) {</span>
<span class="nc bnc" id="L6626" title="All 2 branches missed.">            if (isClan()) {</span>
<span class="nc" id="L6627">                sb.append(&quot;Mixed (Clan Chassis)&quot;);</span>
            } else {
<span class="nc" id="L6629">                sb.append(&quot;Mixed (IS Chassis)&quot;);</span>
            }
        } else {
<span class="fc" id="L6632">            sb.append(TechConstants.getTechName(techLevel));</span>
        }
<span class="fc" id="L6634">        sb.append(newLine);</span>
<span class="fc" id="L6635">        sb.append(MtfFile.ERA).append(year).append(newLine);</span>
<span class="pc bpc" id="L6636" title="2 of 4 branches missed.">        if ((source != null) &amp;&amp; (source.trim().length() &gt; 0)) {</span>
<span class="nc" id="L6637">            sb.append(MtfFile.SOURCE).append(source).append(newLine);</span>
        }
<span class="fc" id="L6639">        sb.append(MtfFile.RULES_LEVEL).append(</span>
                TechConstants.T_SIMPLE_LEVEL[techLevel]);
<span class="fc" id="L6641">        sb.append(newLine);</span>
<span class="fc" id="L6642">        sb.append(newLine);</span>

<span class="fc" id="L6644">        sb.append(MtfFile.MASS).append((int) weight).append(newLine);</span>
<span class="fc" id="L6645">        sb.append(MtfFile.ENGINE);</span>
<span class="pc bpc" id="L6646" title="1 of 2 branches missed.">        if(hasEngine()) {</span>
<span class="fc" id="L6647">                sb.append(getEngine().getEngineName())</span>
<span class="fc" id="L6648">                .append(&quot; Engine&quot;)</span>
<span class="pc bpc" id="L6649" title="3 of 4 branches missed.">                .append(!(getEngine().hasFlag(Engine.CLAN_ENGINE) &amp;&amp; isMixedTech()) ? (&quot;(IS)&quot;)</span>
<span class="nc" id="L6650">                        : &quot;&quot;);</span>
        } else {
<span class="nc" id="L6652">            sb.append(&quot;(none)&quot;);</span>
        }
<span class="fc" id="L6654">        sb.append(newLine);</span>
<span class="fc" id="L6655">        sb.append(MtfFile.STRUCTURE);</span>
<span class="fc" id="L6656">        sb.append(EquipmentType.getStructureTypeName(getStructureType(),</span>
<span class="fc" id="L6657">                TechConstants.isClan(structureTechLevel)));</span>
<span class="fc" id="L6658">        sb.append(newLine);</span>

<span class="fc" id="L6660">        sb.append(MtfFile.MYOMER);</span>
<span class="pc bpc" id="L6661" title="1 of 2 branches missed.">        if (hasTSM()) {</span>
<span class="nc" id="L6662">            sb.append(&quot;Triple-Strength&quot;);</span>
<span class="pc bpc" id="L6663" title="1 of 2 branches missed.">        } else if (hasIndustrialTSM()) {</span>
<span class="nc" id="L6664">            sb.append(&quot;Industrial Triple-Strength&quot;);</span>
<span class="pc bpc" id="L6665" title="1 of 2 branches missed.">        } else if (hasSCM()) {</span>
<span class="nc" id="L6666">            sb.append(&quot;Super-Cooled&quot;);</span>
        } else {
<span class="fc" id="L6668">            sb.append(&quot;Standard&quot;);</span>
        }
<span class="fc" id="L6670">        sb.append(newLine);</span>

<span class="pc bpc" id="L6672" title="1 of 2 branches missed.">        if (this instanceof LandAirMech) {</span>
<span class="nc" id="L6673">            sb.append(MtfFile.LAM);</span>
<span class="nc" id="L6674">            sb.append(((LandAirMech)this).getLAMTypeString());</span>
<span class="nc" id="L6675">            sb.append(newLine);</span>
<span class="pc bpc" id="L6676" title="1 of 2 branches missed.">        } else if (this instanceof QuadVee) {</span>
<span class="nc" id="L6677">            sb.append(MtfFile.MOTIVE);</span>
<span class="nc" id="L6678">            sb.append(((QuadVee)this).getMotiveTypeString());</span>
<span class="nc" id="L6679">            sb.append(newLine);</span>
        }


<span class="pc bpc" id="L6683" title="1 of 2 branches missed.">        if (!standard) {</span>
<span class="nc" id="L6684">            sb.append(MtfFile.COCKPIT);</span>
<span class="nc" id="L6685">            sb.append(getCockpitTypeString());</span>
<span class="nc" id="L6686">            sb.append(newLine);</span>

<span class="nc" id="L6688">            sb.append(MtfFile.GYRO);</span>
<span class="nc" id="L6689">            sb.append(getGyroTypeString());</span>
<span class="nc" id="L6690">            sb.append(newLine);</span>
        }
<span class="pc bpc" id="L6692" title="1 of 2 branches missed.">        if (hasFullHeadEject()) {</span>
<span class="nc" id="L6693">            sb.append(MtfFile.EJECTION);</span>
<span class="nc" id="L6694">            sb.append(Mech.FULL_HEAD_EJECT_STRING);</span>
<span class="nc" id="L6695">            sb.append(newLine);</span>
        }
<span class="fc" id="L6697">        sb.append(newLine);</span>

<span class="fc" id="L6699">        sb.append(MtfFile.HEAT_SINKS).append(heatSinks()).append(&quot; &quot;);</span>
<span class="fc" id="L6700">        Optional&lt;EquipmentType&gt; heatSink = getMisc().stream()</span>
<span class="pc bpc" id="L6701" title="1 of 2 branches missed.">                .filter(m -&gt; m.getType().hasFlag(MiscType.F_HEAT_SINK)</span>
<span class="pc bnc" id="L6702" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_DOUBLE_HEAT_SINK))</span>
<span class="fc" id="L6703">                .map(Mounted::getType).findFirst();</span>
        // If we didn't find any heat sinks we may have an ICE with no added sinks, or prototype
        // doubles (which have a different flag). In the latter case, we want to put single
        // here, since this determines what's installed as engine-integrated heat sinks.
<span class="fc bfc" id="L6707" title="All 2 branches covered.">        if (!heatSink.isPresent()) {</span>
<span class="fc" id="L6708">            sb.append(MtfFile.HS_SINGLE);</span>
<span class="pc bpc" id="L6709" title="1 of 2 branches missed.">        } else if (heatSink.get().hasFlag(MiscType.F_LASER_HEAT_SINK)) {</span>
<span class="nc" id="L6710">            sb.append(MtfFile.HS_LASER);</span>
<span class="pc bpc" id="L6711" title="1 of 2 branches missed.">        } else if (heatSink.get().hasFlag(MiscType.F_COMPACT_HEAT_SINK)) {</span>
<span class="nc" id="L6712">            sb.append(MtfFile.HS_COMPACT);</span>
<span class="pc bpc" id="L6713" title="1 of 2 branches missed.">        } else if (heatSink.get().hasFlag(MiscType.F_DOUBLE_HEAT_SINK)) {</span>
<span class="nc bnc" id="L6714" title="All 2 branches missed.">            sb.append(heatSink.get().isClan() ? MtfFile.TECH_BASE_CLAN : MtfFile.TECH_BASE_IS);</span>
<span class="nc" id="L6715">            sb.append(&quot; &quot;).append(MtfFile.HS_DOUBLE);</span>
        } else {
<span class="fc" id="L6717">            sb.append(MtfFile.HS_SINGLE);</span>
        }
<span class="fc" id="L6719">        sb.append(newLine);</span>

<span class="pc bpc" id="L6721" title="1 of 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L6722">            sb.append(MtfFile.BASE_CHASSIS_HEAT_SINKS);</span>
<span class="nc bnc" id="L6723" title="All 2 branches missed.">            sb.append(hasEngine() ? getEngine().getBaseChassisHeatSinks(hasCompactHeatSinks()) : 0);</span>
<span class="nc" id="L6724">            sb.append(newLine);</span>
        }
<span class="fc bfc" id="L6726" title="All 2 branches covered.">        for (Mounted mounted : getMisc()) {</span>
<span class="pc bpc" id="L6727" title="1 of 2 branches missed.">            if ((mounted.getCriticals() == 0)</span>
<span class="nc bnc" id="L6728" title="All 2 branches missed.">                    &amp;&amp; !mounted.getType().hasFlag(MiscType.F_CASE)</span>
<span class="nc bnc" id="L6729" title="All 2 branches missed.">                    &amp;&amp; !EquipmentType.isArmorType(mounted.getType())</span>
<span class="nc bnc" id="L6730" title="All 2 branches missed.">                    &amp;&amp; !EquipmentType.isStructureType(mounted.getType())) {</span>
<span class="nc" id="L6731">                sb.append(MtfFile.NO_CRIT).append(mounted.getType().getInternalName())</span>
<span class="nc" id="L6732">                        .append(&quot;:&quot;).append(getLocationAbbr(mounted.getLocation()))</span>
<span class="nc" id="L6733">                        .append(newLine);</span>
            }
<span class="fc" id="L6735">        }</span>

<span class="fc" id="L6737">        sb.append(MtfFile.WALK_MP).append(walkMP).append(newLine);</span>
<span class="fc" id="L6738">        sb.append(MtfFile.JUMP_MP).append(jumpMP).append(newLine);</span>
<span class="fc" id="L6739">        sb.append(newLine);</span>

<span class="pc bpc" id="L6741" title="1 of 2 branches missed.">        if (hasPatchworkArmor()) {</span>
<span class="nc" id="L6742">            sb.append(MtfFile.ARMOR).append(EquipmentType.getArmorTypeName(EquipmentType.T_ARMOR_PATCHWORK));</span>
        } else {
<span class="fc" id="L6744">            sb.append(MtfFile.ARMOR).append(EquipmentType.getArmorTypeName(getArmorType(0)))</span>
<span class="fc" id="L6745">                .append(&quot;(&quot;).append(TechConstants.getTechName(getArmorTechLevel(0))).append(&quot;)&quot;);</span>
        }
<span class="fc" id="L6747">        sb.append(newLine);</span>

<span class="fc bfc" id="L6749" title="All 2 branches covered.">        for (int element : MtfFile.locationOrder) {</span>
<span class="pc bpc" id="L6750" title="1 of 4 branches missed.">            if ((element == Mech.LOC_CLEG) &amp;&amp; !(this instanceof TripodMech)) {</span>
<span class="fc" id="L6751">                continue;</span>
            }
<span class="fc" id="L6753">            sb.append(getLocationAbbr(element)).append(&quot; &quot;).append(MtfFile.ARMOR);</span>
<span class="pc bpc" id="L6754" title="1 of 2 branches missed.">            if (hasPatchworkArmor()) {</span>
<span class="nc" id="L6755">                sb.append(EquipmentType.getArmorTypeName(getArmorType(element), isClan()))</span>
<span class="nc" id="L6756">                        .append('(').append(TechConstants.getTechName(getArmorTechLevel(element)))</span>
<span class="nc" id="L6757">                        .append(&quot;):&quot;);</span>
            }
<span class="fc" id="L6759">            sb.append(getOArmor(element, false)).append(newLine);</span>
        }
<span class="fc bfc" id="L6761" title="All 2 branches covered.">        for (int element : MtfFile.rearLocationOrder) {</span>
<span class="fc" id="L6762">            sb.append(&quot;RT&quot;).append(getLocationAbbr(element).charAt(0)).append(&quot; &quot;).append(MtfFile.ARMOR);</span>
<span class="fc" id="L6763">            sb.append(getOArmor(element, true)).append(newLine);</span>
        }
<span class="fc" id="L6765">        sb.append(newLine);</span>

<span class="fc" id="L6767">        sb.append(&quot;Weapons:&quot;).append(weaponList.size()).append(newLine);</span>
<span class="fc bfc" id="L6768" title="All 2 branches covered.">        for (Mounted m : weaponList) {</span>
<span class="fc" id="L6769">            sb.append(m.getName()).append(&quot;, &quot;)</span>
<span class="fc" id="L6770">                    .append(getLocationName(m.getLocation())).append(newLine);</span>
<span class="fc" id="L6771">        }</span>
<span class="fc" id="L6772">        sb.append(newLine);</span>
<span class="fc bfc" id="L6773" title="All 2 branches covered.">        for (int l : MtfFile.locationOrder) {</span>
<span class="pc bpc" id="L6774" title="1 of 4 branches missed.">            if ((l == Mech.LOC_CLEG) &amp;&amp; !(this instanceof TripodMech)) {</span>
<span class="fc" id="L6775">                continue;</span>
            }
<span class="fc" id="L6777">            String locationName = getLocationName(l);</span>
<span class="fc" id="L6778">            sb.append(locationName).append(&quot;:&quot;);</span>
<span class="fc" id="L6779">            sb.append(newLine);</span>
<span class="fc bfc" id="L6780" title="All 2 branches covered.">            for (int y = 0; y &lt; 12; y++) {</span>
<span class="fc bfc" id="L6781" title="All 2 branches covered.">                if (y &lt; getNumberOfCriticals(l)) {</span>
<span class="fc" id="L6782">                    sb.append(decodeCritical(getCritical(l, y)))</span>
<span class="fc" id="L6783">                            .append(newLine);</span>
                } else {
<span class="fc" id="L6785">                    sb.append(MtfFile.EMPTY).append(newLine);</span>
                }
            }
<span class="fc" id="L6788">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6791" title="1 of 2 branches missed.">        if (getFluff().getOverview().trim().length() &gt; 0) {</span>
<span class="nc" id="L6792">            sb.append(MtfFile.OVERVIEW);</span>
<span class="nc" id="L6793">            sb.append(getFluff().getOverview());</span>
<span class="nc" id="L6794">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6797" title="1 of 2 branches missed.">        if (getFluff().getCapabilities().trim().length() &gt; 0) {</span>
<span class="nc" id="L6798">            sb.append(MtfFile.CAPABILITIES);</span>
<span class="nc" id="L6799">            sb.append(getFluff().getCapabilities());</span>
<span class="nc" id="L6800">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6803" title="1 of 2 branches missed.">        if (getFluff().getDeployment().trim().length() &gt; 0) {</span>
<span class="nc" id="L6804">            sb.append(MtfFile.DEPLOYMENT);</span>
<span class="nc" id="L6805">            sb.append(getFluff().getDeployment());</span>
<span class="nc" id="L6806">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6809" title="1 of 2 branches missed.">        if (getFluff().getHistory().trim().length() &gt; 0) {</span>
<span class="nc" id="L6810">            sb.append(MtfFile.HISTORY);</span>
<span class="nc" id="L6811">            sb.append(getFluff().getHistory());</span>
<span class="nc" id="L6812">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6815" title="1 of 2 branches missed.">        if (getFluff().getManufacturer().trim().length() &gt; 0) {</span>
<span class="nc" id="L6816">            sb.append(MtfFile.MANUFACTURER);</span>
<span class="nc" id="L6817">            sb.append(getFluff().getManufacturer());</span>
<span class="nc" id="L6818">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6821" title="1 of 2 branches missed.">        if (getFluff().getPrimaryFactory().trim().length() &gt; 0) {</span>
<span class="nc" id="L6822">            sb.append(MtfFile.PRIMARY_FACTORY);</span>
<span class="nc" id="L6823">            sb.append(getFluff().getPrimaryFactory());</span>
<span class="nc" id="L6824">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6827" title="1 of 2 branches missed.">        if (getFluff().getNotes().trim().length() &gt; 0) {</span>
<span class="nc" id="L6828">            sb.append(MtfFile.NOTES);</span>
<span class="nc" id="L6829">            sb.append(getFluff().getNotes());</span>
<span class="nc" id="L6830">            sb.append(newLine);</span>
        }

<span class="pc bpc" id="L6833" title="1 of 2 branches missed.">        if (getFluff().getMMLImagePath().trim().length() &gt; 0) {</span>
<span class="nc" id="L6834">            sb.append(MtfFile.IMAGE_FILE);</span>
<span class="nc" id="L6835">            sb.append(getFluff().getMMLImagePath());</span>
<span class="nc" id="L6836">            sb.append(newLine);</span>
        }

<span class="fc bfc" id="L6839" title="All 2 branches covered.">        for (EntityFluff.System system : EntityFluff.System.values()) {</span>
<span class="pc bpc" id="L6840" title="1 of 2 branches missed.">        	if (getFluff().getSystemManufacturer(system).length() &gt; 0) {</span>
<span class="nc" id="L6841">        		sb.append(MtfFile.SYSTEM_MANUFACTURER);</span>
<span class="nc" id="L6842">        		sb.append(system.toString()).append(&quot;:&quot;);</span>
<span class="nc" id="L6843">        		sb.append(getFluff().getSystemManufacturer(system));</span>
<span class="nc" id="L6844">        		sb.append(newLine);</span>
        	}
<span class="pc bpc" id="L6846" title="1 of 2 branches missed.">        	if (getFluff().getSystemModel(system).length() &gt; 0) {</span>
<span class="nc" id="L6847">        		sb.append(MtfFile.SYSTEM_MODEL);</span>
<span class="nc" id="L6848">        		sb.append(system.toString()).append(&quot;:&quot;);</span>
<span class="nc" id="L6849">        		sb.append(getFluff().getSystemModel(system));</span>
<span class="nc" id="L6850">        		sb.append(newLine);</span>
        	}
        }

<span class="pc bpc" id="L6854" title="1 of 2 branches missed.">        if (getUseManualBV()) {</span>
<span class="nc" id="L6855">            sb.append(MtfFile.BV);</span>
<span class="nc" id="L6856">            sb.append(getManualBV());</span>
<span class="nc" id="L6857">            sb.append(newLine);</span>
        }

<span class="fc" id="L6860">        return sb.toString();</span>
    }

    private String decodeCritical(CriticalSlot cs) {
<span class="fc bfc" id="L6864" title="All 2 branches covered.">        if (cs == null) {</span>
<span class="fc" id="L6865">            return MtfFile.EMPTY;</span>
        }
<span class="fc" id="L6867">        int type = cs.getType();</span>
<span class="fc" id="L6868">        int index = cs.getIndex();</span>

<span class="fc" id="L6870">        StringBuilder toReturn = new StringBuilder();</span>
<span class="fc bfc" id="L6871" title="All 2 branches covered.">        if (type == CriticalSlot.TYPE_SYSTEM) {</span>
<span class="fc bfc" id="L6872" title="All 2 branches covered.">            if ((getRawSystemName(index).contains(&quot;Upper&quot;))</span>
<span class="fc bfc" id="L6873" title="All 2 branches covered.">                    || (getRawSystemName(index).contains(&quot;Lower&quot;))</span>
<span class="fc bfc" id="L6874" title="All 2 branches covered.">                    || (getRawSystemName(index).contains(&quot;Hand&quot;))</span>
<span class="fc bfc" id="L6875" title="All 2 branches covered.">                    || (getRawSystemName(index).contains(&quot;Foot&quot;))) {</span>
<span class="fc" id="L6876">                toReturn.append(getRawSystemName(index)).append(&quot; Actuator&quot;);</span>
<span class="pc bpc" id="L6877" title="1 of 2 branches missed.">            } else if (getRawSystemName(index).contains(&quot;Engine&quot;)) {</span>
<span class="nc" id="L6878">                toReturn.append(&quot;Fusion &quot;).append(getRawSystemName(index));</span>
            } else {
<span class="fc" id="L6880">                toReturn.append(getRawSystemName(index));</span>
            }
<span class="pc bpc" id="L6882" title="1 of 2 branches missed.">        } else if (type == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="fc" id="L6883">            final Mounted m = cs.getMount();</span>
<span class="fc" id="L6884">            toReturn.append(m.getType().getInternalName());</span>
            // Superheavy mechs can have a second ammo bin or heat sink in the same slot
<span class="fc bfc" id="L6886" title="All 2 branches covered.">            if (cs.getMount2() != null) {</span>
<span class="fc" id="L6887">                toReturn.append(&quot;|&quot;).append(cs.getMount2().getType().getInternalName());</span>
            }
<span class="fc bfc" id="L6889" title="All 2 branches covered.">            if ((m.getType() instanceof WeaponType)</span>
<span class="fc bfc" id="L6890" title="All 2 branches covered.">                    &amp;&amp; m.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="fc bfc" id="L6891" title="All 5 branches covered.">                switch (m.getFacing()) {</span>
                    case 1:
<span class="fc" id="L6893">                        toReturn.append(&quot; (FR)&quot;);</span>
<span class="fc" id="L6894">                        break;</span>
                    case 2:
<span class="fc" id="L6896">                        toReturn.append(&quot; (RR)&quot;);</span>
<span class="fc" id="L6897">                        break;</span>
                    // case 3:
                    // already handled by isRearMounted() above
                    case 4:
<span class="fc" id="L6901">                        toReturn.append(&quot; (RL)&quot;);</span>
<span class="fc" id="L6902">                        break;</span>
                    case 5:
<span class="fc" id="L6904">                        toReturn.append(&quot; (FL)&quot;);</span>
<span class="fc" id="L6905">                        break;</span>
                    default:
                        // forward facing
                        break;
                }
            }
<span class="fc bfc" id="L6911" title="All 2 branches covered.">            if (m.isRearMounted()) {</span>
<span class="fc" id="L6912">                toReturn.append(&quot; (R)&quot;);</span>
            }
<span class="fc bfc" id="L6914" title="All 2 branches covered.">            if (m.isMechTurretMounted()) {</span>
<span class="fc" id="L6915">                toReturn.append(&quot; (T)&quot;);</span>
            }
<span class="fc bfc" id="L6917" title="All 2 branches covered.">            if (m.isOmniPodMounted()) {</span>
<span class="fc" id="L6918">                toReturn.append(&quot; &quot;).append(MtfFile.OMNIPOD);</span>
            }
<span class="pc bpc" id="L6920" title="1 of 2 branches missed.">            if (m.getType().isVariableSize()) {</span>
<span class="nc" id="L6921">                toReturn.append(MtfFile.SIZE).append(m.getSize());</span>
            }
<span class="fc" id="L6923">        } else {</span>
<span class="nc" id="L6924">            return &quot;?&quot; + index;</span>
        }
<span class="fc bfc" id="L6926" title="All 2 branches covered.">        if (cs.isArmored()) {</span>
<span class="fc" id="L6927">            toReturn.append(&quot; &quot;).append(MtfFile.ARMORED);</span>
        }
<span class="fc" id="L6929">        return toReturn.toString();</span>
    }

    /**
     * Add the critical slots necessary for a standard cockpit. Note: This is
     * part of the mek creation public API, and might not be referenced by any
     * MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addCockpit() {
<span class="nc bnc" id="L6940" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 5) {</span>
<span class="nc" id="L6941">            return false;</span>
        }
<span class="nc" id="L6943">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L6945">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L6947">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L6949">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L6951">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc bnc" id="L6953" title="All 2 branches missed.">        if (isSuperHeavy()) {</span>
<span class="nc bnc" id="L6954" title="All 2 branches missed.">            if (this instanceof TripodMech) {</span>
<span class="nc" id="L6955">            setCockpitType(COCKPIT_SUPERHEAVY_TRIPOD);</span>
<span class="nc bnc" id="L6956" title="All 2 branches missed.">            } else if (isIndustrial()) {</span>
<span class="nc" id="L6957">                setCockpitType(COCKPIT_SUPERHEAVY_INDUSTRIAL);</span>
            } else {
<span class="nc" id="L6959">                setCockpitType(COCKPIT_SUPERHEAVY);</span>
            }
<span class="nc bnc" id="L6961" title="All 2 branches missed.">        } else if (this instanceof TripodMech) {</span>
<span class="nc" id="L6962">            setCockpitType(COCKPIT_TRIPOD);</span>
        } else {
<span class="nc" id="L6964">            setCockpitType(COCKPIT_STANDARD);</span>
        }

<span class="nc" id="L6967">        return true;</span>
    }

    /**
     * Add the critical slots necessary for an industrial cockpit. Note: This is
     * part of the mek creation public API, and might not be referenced by any
     * MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addIndustrialCockpit() {
<span class="nc bnc" id="L6978" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 5) {</span>
<span class="nc" id="L6979">            return false;</span>
        }
<span class="nc" id="L6981">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L6983">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L6985">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L6987">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L6989">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L6991">        setCockpitType(COCKPIT_INDUSTRIAL);</span>
<span class="nc" id="L6992">        return true;</span>
    }

    /**
     * Add the critical slots necessary for an industrial cockpit. Note: This is
     * part of the mek creation public API, and might not be referenced by any
     * MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addPrimitiveCockpit() {
<span class="nc bnc" id="L7003" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 5) {</span>
<span class="nc" id="L7004">            return false;</span>
        }
<span class="nc" id="L7006">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7008">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7010">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7012">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7014">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7016">        setCockpitType(COCKPIT_PRIMITIVE);</span>
<span class="nc" id="L7017">        return true;</span>
    }

    /**
     * Add the critical slots necessary for an industrial primitive cockpit.
     * Note: This is part of the mek creation public API, and might not be
     * referenced by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addIndustrialPrimitiveCockpit() {
<span class="nc bnc" id="L7028" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 5) {</span>
<span class="nc" id="L7029">            return false;</span>
        }
<span class="nc" id="L7031">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7033">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7035">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7037">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7039">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7041">        setCockpitType(COCKPIT_PRIMITIVE_INDUSTRIAL);</span>
<span class="nc" id="L7042">        return true;</span>
    }

    /**
     * Add the critical slots necessary for a small cockpit. Note: This is part
     * of the mek creation public API, and might not be referenced by any
     * MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addSmallCockpit() {
<span class="nc bnc" id="L7053" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 4) {</span>
<span class="nc" id="L7054">            return false;</span>
        }
<span class="nc" id="L7056">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7058">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7060">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7062">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7064">        setCockpitType(COCKPIT_SMALL);</span>
<span class="nc" id="L7065">        return true;</span>
    }

    /**
     * Add the critical slots necessary for a small cockpit. Note: This is part
     * of the mek creation public API, and might not be referenced by any
     * MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addInterfaceCockpit() {
<span class="nc bnc" id="L7076" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 6) {</span>
<span class="nc" id="L7077">            return false;</span>
        }
<span class="nc" id="L7079">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7081">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7083">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7085">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7087">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7089">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7091">        setCockpitType(COCKPIT_INTERFACE);</span>
<span class="nc" id="L7092">        return true;</span>
    }

    public boolean addCommandConsole() {
<span class="nc" id="L7096">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7098">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7100">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7102">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7104">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7106">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7108">        setCockpitType(COCKPIT_COMMAND_CONSOLE);</span>
<span class="nc" id="L7109">        return true;</span>
    }

    public boolean addQuadVeeCockpit() {
<span class="nc" id="L7113">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7115">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7117">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7119">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7121">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7123">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7125">        setCockpitType(COCKPIT_QUADVEE);</span>
<span class="nc" id="L7126">        return true;</span>
    }

    public boolean addDualCockpit() {
<span class="nc" id="L7130">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7132">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7134">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7136">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7138">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7140">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7142">        setCockpitType(COCKPIT_DUAL);</span>
<span class="nc" id="L7143">        return true;</span>
    }
	
    public boolean addSuperheavyIndustrialCockpit() {
<span class="nc bnc" id="L7147" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 5) {</span>
<span class="nc" id="L7148">            return false;</span>
        }
<span class="nc" id="L7150">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7152">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7154">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7156">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7158">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7160">        setCockpitType(COCKPIT_SUPERHEAVY_INDUSTRIAL);</span>
<span class="nc" id="L7161">        return true;</span>
    }
	
    public boolean addSuperheavyCommandConsole() {
<span class="nc" id="L7165">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7167">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7169">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7171">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7173">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7175">        addCritical(LOC_HEAD, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7177">        setCockpitType(COCKPIT_SUPERHEAVY_COMMAND_CONSOLE);</span>
<span class="nc" id="L7178">        return true;</span>
    }
    
    //The location of critical is based on small cockpit, but since command console requires two cockpit slots the second Sensor is return to the location 4.
    public boolean addSmallCommandConsole() {
<span class="nc bnc" id="L7183" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 5) {</span>
<span class="nc" id="L7184">            return false;</span>
        }
<span class="nc" id="L7186">        addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7188">        addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7190">        addCritical(LOC_HEAD, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7192">        addCritical(LOC_HEAD, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_COCKPIT));
<span class="nc" id="L7194">        addCritical(LOC_HEAD, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_SENSORS));
<span class="nc" id="L7196">        setCockpitType(COCKPIT_SMALL_COMMAND_CONSOLE);</span>
<span class="nc" id="L7197">        return true;</span>
    }

    /**
     * Add the critical slots necessary for a torso-mounted cockpit. Note: This
     * is part of the mek creation public API, and might not be referenced by
     * any MegaMek code.
     *
     * @param vrpp  if this is a VRPP rather than a standard torso-mounted cockpit
     * @return      false if insufficient critical space
     */
    public boolean addTorsoMountedCockpit(boolean vrpp) {
<span class="nc" id="L7209">        boolean success = true;</span>
<span class="nc bnc" id="L7210" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_HEAD) &lt; 2) {</span>
<span class="nc" id="L7211">            success = false;</span>
        } else {
<span class="nc" id="L7213">            addCritical(LOC_HEAD, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_SENSORS));
<span class="nc" id="L7215">            addCritical(LOC_HEAD, 1, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_SENSORS));
        }

<span class="nc bnc" id="L7219" title="All 4 branches missed.">        if ((getEmptyCriticals(LOC_CT) &lt; 2) || !success) {</span>
<span class="nc" id="L7220">            success = false;</span>
        } else {
<span class="nc" id="L7222">            addCritical(LOC_CT, getFirstEmptyCrit(LOC_CT), new CriticalSlot(</span>
                    CriticalSlot.TYPE_SYSTEM, SYSTEM_COCKPIT));
<span class="nc bnc" id="L7224" title="All 2 branches missed.">            if (vrpp) {</span>
<span class="nc" id="L7225">                addCritical(LOC_CT, getFirstEmptyCrit(LOC_CT), new CriticalSlot(</span>
                        CriticalSlot.TYPE_SYSTEM, SYSTEM_LIFE_SUPPORT));
            } else {
<span class="nc" id="L7228">                addCritical(LOC_CT, getFirstEmptyCrit(LOC_CT), new CriticalSlot(</span>
                        CriticalSlot.TYPE_SYSTEM, SYSTEM_SENSORS));
            }
        }

<span class="nc bnc" id="L7233" title="All 6 branches missed.">        if ((getEmptyCriticals(LOC_LT) &lt; 1) || (getEmptyCriticals(LOC_RT) &lt; 1)</span>
                || !success) {
<span class="nc" id="L7235">            success = false;</span>
        } else {
<span class="nc" id="L7237">            addCritical(LOC_LT, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7239">            addCritical(LOC_RT, 0, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_LIFE_SUPPORT));
        }

<span class="nc bnc" id="L7243" title="All 2 branches missed.">        if (success) {</span>
<span class="nc bnc" id="L7244" title="All 2 branches missed.">            if (vrpp) {</span>
<span class="nc" id="L7245">                setCockpitType(COCKPIT_VRRP);</span>
            } else {
<span class="nc" id="L7247">                setCockpitType(COCKPIT_TORSO_MOUNTED);</span>
            }
        }
<span class="nc" id="L7250">        return success;</span>
    }
    
    /**
     * Convenience function that returns the critical slot containing the cockpit
     * @return
     */
    public List&lt;CriticalSlot&gt; getCockpit() {
<span class="nc" id="L7258">        List&lt;CriticalSlot&gt; retVal = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L7260" title="All 3 branches missed.">        switch (cockpitType) {</span>
        // these always occupy slots 2 and 3 in the head
        case Mech.COCKPIT_COMMAND_CONSOLE:
        case Mech.COCKPIT_DUAL:
        case Mech.COCKPIT_SMALL_COMMAND_CONSOLE:
        case Mech.COCKPIT_INTERFACE:
        case Mech.COCKPIT_QUADVEE:
        case Mech.COCKPIT_SUPERHEAVY_COMMAND_CONSOLE:
<span class="nc" id="L7268">            retVal.add(getCritical(Mech.LOC_HEAD, 2));</span>
<span class="nc" id="L7269">            retVal.add(getCritical(Mech.LOC_HEAD, 3));</span>
<span class="nc" id="L7270">            break;</span>
        case Mech.COCKPIT_TORSO_MOUNTED:
<span class="nc bnc" id="L7272" title="All 2 branches missed.">            for (int critIndex = 0; critIndex &lt; getNumberOfCriticals(Mech.LOC_CT); critIndex++) {</span>
<span class="nc" id="L7273">                CriticalSlot slot = getCritical(Mech.LOC_CT, critIndex);</span>
<span class="nc bnc" id="L7274" title="All 2 branches missed.">                if (slot.getIndex() == SYSTEM_COCKPIT) {</span>
<span class="nc" id="L7275">                    retVal.add(slot);</span>
                }
            }
        default:
<span class="nc" id="L7279">            retVal.add(getCritical(Mech.LOC_HEAD, 2));</span>
        }
        
<span class="nc" id="L7282">        return retVal;</span>
    }

    /**
     * Determines which crew slot is associated with a particular cockpit critical.
     *
     * @param cs    A cockpit critical slot
     * @return      The crew slot index associated with this critical slot, or -1 to indicate the entire crew.
     */
    public int getCrewForCockpitSlot(int loc, CriticalSlot cs) {
        //For those with split cockpits, count the cockpit criticals in the location until we reach the correct
        //one.
<span class="nc bnc" id="L7294" title="All 2 branches missed.">        if (getCockpitType() == COCKPIT_COMMAND_CONSOLE</span>
<span class="nc bnc" id="L7295" title="All 2 branches missed.">                || getCockpitType() == COCKPIT_SUPERHEAVY_COMMAND_CONSOLE</span>
<span class="nc bnc" id="L7296" title="All 2 branches missed.">	            || getCockpitType() == COCKPIT_SMALL_COMMAND_CONSOLE</span>
<span class="nc bnc" id="L7297" title="All 2 branches missed.">                || getCockpitType() == COCKPIT_DUAL</span>
<span class="nc bnc" id="L7298" title="All 2 branches missed.">                || getCockpitType() == COCKPIT_QUADVEE) {</span>
<span class="nc" id="L7299">            int crewSlot = 0;</span>
<span class="nc bnc" id="L7300" title="All 2 branches missed.">            for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc bnc" id="L7301" title="All 2 branches missed.">                if (getCritical(loc, i) == cs) {</span>
<span class="nc" id="L7302">                    return crewSlot;</span>
<span class="nc bnc" id="L7303" title="All 2 branches missed.">                } else if (getCritical(loc, i).getIndex() == SYSTEM_COCKPIT) {</span>
<span class="nc" id="L7304">                    crewSlot++;</span>
                }
            }
        }
<span class="nc" id="L7308">        return -1;</span>
    }

    @Override
    public boolean hasCommandConsoleBonus() {
<span class="nc bnc" id="L7313" title="All 2 branches missed.">        return ((getCockpitType() == COCKPIT_COMMAND_CONSOLE) </span>
<span class="nc bnc" id="L7314" title="All 2 branches missed.">		|| (getCockpitType() == COCKPIT_SUPERHEAVY_COMMAND_CONSOLE) </span>
<span class="nc bnc" id="L7315" title="All 2 branches missed.">		|| (getCockpitType() == COCKPIT_SMALL_COMMAND_CONSOLE))</span>
<span class="nc bnc" id="L7316" title="All 2 branches missed.">                &amp;&amp; getCrew().hasActiveCommandConsole()</span>
<span class="nc bnc" id="L7317" title="All 2 branches missed.">                &amp;&amp; getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY</span>
<span class="nc bnc" id="L7318" title="All 4 branches missed.">                &amp;&amp; (!isIndustrial() || hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL));</span>
    }

    /**
     * Add the critical slots necessary for a standard gyro. Also set the gyro
     * type variable. Note: This is part of the mek creation public API, and
     * might not be referenced by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addGyro() {
<span class="nc bnc" id="L7329" title="All 4 branches missed.">        if (getEmptyCriticals(LOC_CT) &lt; (isSuperHeavy() ? 2 : 4)) {</span>
<span class="nc" id="L7330">            return false;</span>
        }
<span class="nc" id="L7332">        addCompactGyro();</span>
<span class="nc bnc" id="L7333" title="All 2 branches missed.">        if (!isSuperHeavy()) {</span>
<span class="nc" id="L7334">            addCritical(LOC_CT, 5, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_GYRO));
<span class="nc" id="L7336">            addCritical(LOC_CT, 6, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_GYRO));
<span class="nc" id="L7338">            setGyroType(GYRO_STANDARD);</span>
        } else {
<span class="nc" id="L7340">            setGyroType(GYRO_SUPERHEAVY);</span>
        }
<span class="nc" id="L7342">        return true;</span>
    }

    /**
     * Add the critical slots necessary for a standard gyro. Also set the gyro
     * type variable. Note: This is part of the mek creation public API, and
     * might not be referenced by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addSuperheavyGyro() {
<span class="nc bnc" id="L7353" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_CT) &lt; 2) {</span>
<span class="nc" id="L7354">            return false;</span>
        }
<span class="nc" id="L7356">        addCritical(LOC_CT, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_GYRO));
<span class="nc bnc" id="L7358" title="All 2 branches missed.">        if (getEngine().getEngineType() == Engine.COMPACT_ENGINE) {</span>
<span class="nc" id="L7359">            addCritical(LOC_CT, 2, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_GYRO));
        } else {
<span class="nc" id="L7362">            addCritical(LOC_CT, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_GYRO));
        }
<span class="nc" id="L7365">        setGyroType(GYRO_SUPERHEAVY);</span>
<span class="nc" id="L7366">        return true;</span>
    }

    /**
     * Add the critical slots necessary for a compact gyro. Also set the gyro
     * type variable. Note: This is part of the mek creation public API, and
     * might not be referenced by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addCompactGyro() {
<span class="nc bnc" id="L7377" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_CT) &lt; 2) {</span>
<span class="nc" id="L7378">            return false;</span>
        }
<span class="nc" id="L7380">        addCritical(LOC_CT, 3, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_GYRO));
<span class="nc" id="L7382">        addCritical(LOC_CT, 4, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_GYRO));
<span class="nc" id="L7384">        setGyroType(GYRO_COMPACT);</span>
<span class="nc" id="L7385">        return true;</span>
    }

    /**
     * Add the critical slots necessary for an extra-light gyro. Also set the
     * gyro type variable. Note: This is part of the mek creation public API,
     * and might not be referenced by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addXLGyro() {
<span class="nc bnc" id="L7396" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_CT) &lt; 6) {</span>
<span class="nc" id="L7397">            return false;</span>
        }
<span class="nc" id="L7399">        clearEngineCrits();</span>
<span class="nc" id="L7400">        addGyro();</span>
<span class="nc" id="L7401">        addCritical(LOC_CT, 7, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_GYRO));
<span class="nc" id="L7403">        addCritical(LOC_CT, 8, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                SYSTEM_GYRO));
<span class="nc" id="L7405">        setGyroType(GYRO_XL);</span>
<span class="nc" id="L7406">        addEngineCrits();</span>

<span class="nc" id="L7408">        return true;</span>
    }

    /**
     * Add the critical slots necessary for a heavy-duty gyro. Also set the gyro
     * type variable. Note: This is part of the mek creation public API, and
     * might not be referenced by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addHeavyDutyGyro() {
<span class="nc bnc" id="L7419" title="All 2 branches missed.">        if (addGyro()) {</span>
<span class="nc" id="L7420">            setGyroType(GYRO_HEAVY_DUTY);</span>
<span class="nc" id="L7421">            return true;</span>
        }
<span class="nc" id="L7423">        return false;</span>
    }

    /**
     * Add the critical slots necessary for the mek's engine. Calling this
     * method before setting a mek's engine object will result in a NPE. Note:
     * This is part of the mek creation public API, and might not be referenced
     * by any MegaMek code.
     *
     * @return false if insufficient critical space
     */
    public boolean addEngineCrits() {
<span class="nc bnc" id="L7435" title="All 2 branches missed.">        if(!hasEngine()) {</span>
<span class="nc" id="L7436">            return true;</span>
        }
<span class="nc" id="L7438">        boolean success = true;</span>

<span class="nc" id="L7440">        int centerSlots[] = getEngine().getCenterTorsoCriticalSlots(</span>
<span class="nc" id="L7441">                getGyroType());</span>
<span class="nc bnc" id="L7442" title="All 2 branches missed.">        if (getEmptyCriticals(LOC_CT) &lt; centerSlots.length) {</span>
<span class="nc" id="L7443">            success = false;</span>
        } else {
<span class="nc bnc" id="L7445" title="All 2 branches missed.">            for (int centerSlot : centerSlots) {</span>
<span class="nc" id="L7446">                addCritical(LOC_CT, centerSlot, new CriticalSlot(</span>
                        CriticalSlot.TYPE_SYSTEM, SYSTEM_ENGINE));
            }
        }
<span class="nc" id="L7450">        int sideSlots[] = getEngine().getSideTorsoCriticalSlots();</span>
<span class="nc bnc" id="L7451" title="All 2 branches missed.">        if ((getEmptyCriticals(LOC_LT) &lt; sideSlots.length)</span>
<span class="nc bnc" id="L7452" title="All 4 branches missed.">                || (getEmptyCriticals(LOC_RT) &lt; sideSlots.length) || !success) {</span>
<span class="nc" id="L7453">            success = false;</span>
        } else {
<span class="nc bnc" id="L7455" title="All 2 branches missed.">            for (int sideSlot : sideSlots) {</span>
<span class="nc" id="L7456">                addCritical(LOC_LT, sideSlot, new CriticalSlot(</span>
                        CriticalSlot.TYPE_SYSTEM, SYSTEM_ENGINE));
<span class="nc" id="L7458">                addCritical(LOC_RT, sideSlot, new CriticalSlot(</span>
                        CriticalSlot.TYPE_SYSTEM, SYSTEM_ENGINE));
            }
        }

<span class="nc" id="L7463">        return success;</span>
    }

    /**
     * Remove all engine critical slots from the mek. Note: This is part of the
     * mek creation public API, and might not be referenced by any MegaMek code.
     */
    public void clearEngineCrits() {
<span class="nc bnc" id="L7471" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L7472">            removeCriticals(i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_ENGINE));
        }
<span class="nc" id="L7475">    }</span>

    /**
     * Remove all cockpit critical slots from the mek. Note: This is part of the
     * mek creation public API, and might not be referenced by any MegaMek code.
     */
    public void clearCockpitCrits() {
<span class="nc bnc" id="L7482" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L7483">            removeCriticals(i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_LIFE_SUPPORT));
<span class="nc" id="L7485">            removeCriticals(i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_SENSORS));
<span class="nc" id="L7487">            removeCriticals(i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_COCKPIT));
        }
<span class="nc" id="L7490">    }</span>

    /**
     * Remove all gyro critical slots from the mek. Note: This is part of the
     * mek creation public API, and might not be referenced by any MegaMek code.
     */
    public void clearGyroCrits() {
<span class="nc bnc" id="L7497" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L7498">            removeCriticals(i, new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                    SYSTEM_GYRO));
        }
<span class="nc" id="L7501">    }</span>

    public int shieldAbsorptionDamage(int damage, int location, boolean rear) {
<span class="nc" id="L7504">        int damageAbsorption = damage;</span>
<span class="nc bnc" id="L7505" title="All 2 branches missed.">        if (this.hasActiveShield(location, rear)) {</span>
<span class="nc bnc" id="L7506" title="All 3 branches missed.">            switch (location) {</span>
                case Mech.LOC_CT:
                case Mech.LOC_HEAD:
<span class="nc bnc" id="L7509" title="All 2 branches missed.">                    if (this.hasActiveShield(Mech.LOC_RARM)) {</span>
<span class="nc" id="L7510">                        damageAbsorption = getAbsorptionRate(Mech.LOC_RARM,</span>
                                damageAbsorption);
                    }
<span class="nc bnc" id="L7513" title="All 2 branches missed.">                    if (this.hasActiveShield(Mech.LOC_LARM)) {</span>
<span class="nc" id="L7514">                        damageAbsorption = getAbsorptionRate(Mech.LOC_LARM,</span>
                                damageAbsorption);
                    }
                    break;
                case Mech.LOC_LARM:
                case Mech.LOC_LT:
                case Mech.LOC_LLEG:
<span class="nc bnc" id="L7521" title="All 2 branches missed.">                    if (this.hasActiveShield(Mech.LOC_LARM)) {</span>
<span class="nc" id="L7522">                        damageAbsorption = getAbsorptionRate(Mech.LOC_LARM,</span>
                                damageAbsorption);
                    }
                    break;
                default:
<span class="nc bnc" id="L7527" title="All 2 branches missed.">                    if (this.hasActiveShield(Mech.LOC_RARM)) {</span>
<span class="nc" id="L7528">                        damageAbsorption = getAbsorptionRate(Mech.LOC_RARM,</span>
                                damageAbsorption);
                    }
                    break;
            }
        }

<span class="nc bnc" id="L7535" title="All 2 branches missed.">        if (this.hasPassiveShield(location, rear)) {</span>
<span class="nc bnc" id="L7536" title="All 3 branches missed.">            switch (location) {</span>
                case Mech.LOC_LARM:
                case Mech.LOC_LT:
<span class="nc bnc" id="L7539" title="All 2 branches missed.">                    if (this.hasPassiveShield(Mech.LOC_LARM)) {</span>
<span class="nc" id="L7540">                        damageAbsorption = getAbsorptionRate(Mech.LOC_LARM,</span>
                                damageAbsorption);
                    }
                    break;
                case Mech.LOC_RARM:
                case Mech.LOC_RT:
<span class="nc bnc" id="L7546" title="All 2 branches missed.">                    if (this.hasPassiveShield(Mech.LOC_RARM)) {</span>
<span class="nc" id="L7547">                        damageAbsorption = getAbsorptionRate(Mech.LOC_RARM,</span>
                                damageAbsorption);
                    }
                    break;
                default:
                    break;
            }
        }
<span class="nc bnc" id="L7555" title="All 2 branches missed.">        if (hasNoDefenseShield(location)) {</span>
<span class="nc bnc" id="L7556" title="All 3 branches missed.">            switch (location) {</span>
                case Mech.LOC_LARM:
<span class="nc bnc" id="L7558" title="All 2 branches missed.">                    if (hasNoDefenseShield(Mech.LOC_LARM)) {</span>
<span class="nc" id="L7559">                        damageAbsorption = getAbsorptionRate(Mech.LOC_LARM,</span>
                                damageAbsorption);
                    }
                    break;
                case Mech.LOC_RARM:
<span class="nc bnc" id="L7564" title="All 2 branches missed.">                    if (hasNoDefenseShield(Mech.LOC_RARM)) {</span>
<span class="nc" id="L7565">                        damageAbsorption = getAbsorptionRate(Mech.LOC_RARM,</span>
                                damageAbsorption);
                    }
                    break;
                default:
                    break;
            }
        }

<span class="nc" id="L7574">        return Math.max(0, damageAbsorption);</span>
    }

    private int getAbsorptionRate(int location, int damage) {
<span class="nc" id="L7578">        int rate = damage;</span>

<span class="nc bnc" id="L7580" title="All 4 branches missed.">        if ((location != Mech.LOC_RARM) &amp;&amp; (location != Mech.LOC_LARM)) {</span>
<span class="nc" id="L7581">            return rate;</span>
        }

<span class="nc bnc" id="L7584" title="All 2 branches missed.">        if (damage &lt;= 0) {</span>
<span class="nc" id="L7585">            return 0;</span>
        }

<span class="nc bnc" id="L7588" title="All 2 branches missed.">        for (int slot = 0; slot &lt; this.getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L7589">            CriticalSlot cs = getCritical(location, slot);</span>

<span class="nc bnc" id="L7591" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L7592">                continue;</span>
            }

<span class="nc bnc" id="L7595" title="All 2 branches missed.">            if (cs.getType() != CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L7596">                continue;</span>
            }

<span class="nc bnc" id="L7599" title="All 2 branches missed.">            if (cs.isDamaged()) {</span>
<span class="nc" id="L7600">                continue;</span>
            }

<span class="nc" id="L7603">            Mounted m = cs.getMount();</span>

<span class="nc" id="L7605">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L7606" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; ((MiscType) type).isShield()) {</span>
<span class="nc" id="L7607">                rate -= m.getDamageAbsorption(this, m.getLocation());</span>
<span class="nc" id="L7608">                m.damageTaken++;</span>
<span class="nc" id="L7609">                return Math.max(0, rate);</span>
            }
        }

<span class="nc" id="L7613">        return rate;</span>
    }

    /**
     * Does this mech have an undamaged HarJel system in this location?
     *
     * @param loc
     *            the &lt;code&gt;int&lt;/code&gt; location to check
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating a present HarJel system
     */
    public boolean hasHarJelIIIn(int loc) {
<span class="nc bnc" id="L7624" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L7625" title="All 4 branches missed.">            if ((mounted.getLocation() == loc) &amp;&amp; mounted.isReady()</span>
<span class="nc bnc" id="L7626" title="All 2 branches missed.">                    &amp;&amp; (mounted.getType().hasFlag(MiscType.F_HARJEL_II))) {</span>
<span class="nc" id="L7627">                return true;</span>
            }
<span class="nc" id="L7629">        }</span>
<span class="nc" id="L7630">        return false;</span>
    }

    /**
     * Does this mech have an undamaged HarJel system in this location?
     *
     * @param loc
     *            the &lt;code&gt;int&lt;/code&gt; location to check
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating a present HarJel system
     */
    public boolean hasHarJelIIIIn(int loc) {
<span class="nc bnc" id="L7641" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L7642" title="All 4 branches missed.">            if ((mounted.getLocation() == loc) &amp;&amp; mounted.isReady()</span>
<span class="nc bnc" id="L7643" title="All 2 branches missed.">                    &amp;&amp; (mounted.getType().hasFlag(MiscType.F_HARJEL_III))) {</span>
<span class="nc" id="L7644">                return true;</span>
            }
<span class="nc" id="L7646">        }</span>
<span class="nc" id="L7647">        return false;</span>
    }

    @Override
    public void setGrappled(int id, boolean attacker) {
<span class="nc" id="L7652">        grappled_id = id;</span>
<span class="nc" id="L7653">        isGrappleAttacker = attacker;</span>
<span class="nc" id="L7654">    }</span>

    @Override
    public boolean isGrappleAttacker() {
<span class="nc" id="L7658">        return isGrappleAttacker;</span>
    }

    @Override
    public int getGrappled() {
<span class="nc" id="L7663">        return grappled_id;</span>
    }

    @Override
    public boolean isGrappledThisRound() {
<span class="nc" id="L7668">        return grappledThisRound;</span>
    }

    @Override
    public void setGrappledThisRound(boolean grappled) {
<span class="nc" id="L7673">        grappledThisRound = grappled;</span>
<span class="nc" id="L7674">    }</span>

    @Override
    public boolean isEligibleForMovement() {
        // For normal grapples, neither unit can move
        // If the grapple is caused by a chain whip, then the attacker can move
        // (this breaks the grapple), TO pg 289
<span class="nc bnc" id="L7681" title="All 2 branches missed.">        if ((grappled_id != Entity.NONE)</span>
<span class="nc bnc" id="L7682" title="All 4 branches missed.">                &amp;&amp; (!isChainWhipGrappled() || !isGrappleAttacker())) {</span>
<span class="nc" id="L7683">            return false;</span>
        }
<span class="nc" id="L7685">        return super.isEligibleForMovement();</span>
    }

    @Override
    public boolean isNuclearHardened() {
<span class="nc" id="L7690">        return true;</span>
    }

    @Override
    public void destroyLocation(int loc) {
<span class="nc" id="L7695">        destroyLocation(loc, false);</span>
<span class="nc" id="L7696">    }</span>

    @Override
    public void destroyLocation(int loc, boolean blownOff) {
        // If it's already destroyed, don't bother -- as of 12/06/28, super.
        // destroyLocation() will just return having done nothing itself and
        // then we'd potentially end up with a second PSR for an
        // already-destroyed
        // leg.
<span class="nc bnc" id="L7705" title="All 2 branches missed.">        if (getInternal(loc) &lt; 0) {</span>
<span class="nc" id="L7706">            return;</span>
        }
<span class="nc" id="L7708">        super.destroyLocation(loc, blownOff);</span>
        // if it's a leg, the entity falls
<span class="nc bnc" id="L7710" title="All 4 branches missed.">        if (locationIsLeg(loc) &amp;&amp; canFall()) {</span>
<span class="nc" id="L7711">            game.addPSR(new PilotingRollData(getId(),</span>
                    TargetRoll.AUTOMATIC_FAIL, 5, &quot;leg destroyed&quot;));
        }
<span class="nc" id="L7714">    }</span>

    @Override
    public boolean hasCASEII(int location) {

<span class="nc bnc" id="L7719" title="All 2 branches missed.">        for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L7720" title="All 2 branches missed.">            if ((mount.getLocation() == location)</span>
<span class="nc bnc" id="L7721" title="All 2 branches missed.">                    &amp;&amp; (mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L7722" title="All 2 branches missed.">                    &amp;&amp; ((MiscType) mount.getType()).hasFlag(MiscType.F_CASEII)) {</span>
<span class="nc" id="L7723">                return true;</span>
            }
<span class="nc" id="L7725">        }</span>

<span class="nc" id="L7727">        return false;</span>
    }

    /* Check to see if case II exists anywhere on the mech */
    public boolean hasCASEIIAnywhere() {

<span class="nc bnc" id="L7733" title="All 2 branches missed.">        for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L7734" title="All 2 branches missed.">            if ((mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L7735" title="All 2 branches missed.">                    &amp;&amp; ((MiscType) mount.getType()).hasFlag(MiscType.F_CASEII)) {</span>
<span class="nc" id="L7736">                return true;</span>
            }
<span class="nc" id="L7738">        }</span>

<span class="nc" id="L7740">        return false;</span>
    }

    @Override
    public void setGrappleSide(int side) {
<span class="nc" id="L7745">        grappledSide = side;</span>
<span class="nc" id="L7746">    }</span>

    @Override
    public int getGrappleSide() {
<span class="nc" id="L7750">        return grappledSide;</span>
    }

    @Override
    public boolean isCarefulStand() {
<span class="nc" id="L7755">        return isCarefulStanding;</span>
    }

    @Override
    public int getCoolantFailureAmount() {
<span class="nc" id="L7760">        return heatSinkCoolantFailureFactor;</span>
    }

    @Override
    public void addCoolantFailureAmount(int amount) {
<span class="nc" id="L7765">        heatSinkCoolantFailureFactor += amount;</span>
<span class="nc" id="L7766">    }</span>

    @Override
    public void resetCoolantFailureAmount() {
<span class="nc" id="L7770">        heatSinkCoolantFailureFactor = 0;</span>
<span class="nc" id="L7771">    }</span>

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getTotalCommGearTons()
     */
    @Override
    public int getTotalCommGearTons() {
<span class="nc" id="L7780">        return 1 + getExtraCommGearTons();</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getHQIniBonus()
     */
    @Override
    public int getHQIniBonus() {
<span class="nc" id="L7790">        int bonus = super.getHQIniBonus();</span>
<span class="nc bnc" id="L7791" title="All 6 branches missed.">        if (((getGyroHits() &gt; 0) || hasHipCrit()) &amp;&amp; (mpUsedLastRound &gt; 0)) {</span>
<span class="nc" id="L7792">            return 0;</span>
        }
<span class="nc" id="L7794">        return bonus;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getBARRating()
     */
    @Override
    public int getBARRating(int loc) {
<span class="nc bnc" id="L7804" title="All 2 branches missed.">        if (armorType[loc] == EquipmentType.T_ARMOR_COMMERCIAL) {</span>
<span class="nc" id="L7805">            return 5;</span>
        }
<span class="nc bnc" id="L7807" title="All 4 branches missed.">        if ((armorType[loc] == EquipmentType.T_ARMOR_INDUSTRIAL)</span>
                || (armorType[loc] == EquipmentType.T_ARMOR_HEAVY_INDUSTRIAL)) {
<span class="nc" id="L7809">            return 10;</span>
        }
<span class="nc" id="L7811">        return 10;</span>
    }

    /**
     * Is this an Industrial Mech?
     *
     * @return if this mech has an industrial inner structure
     */
    public boolean isIndustrial() {
<span class="pc bpc" id="L7820" title="1 of 2 branches missed.">        return getStructureType() == EquipmentType.T_STRUCTURE_INDUSTRIAL;</span>
    }

    /**
     * set if this mech just moved into water that would kill it because of the
     * lack of environmental sealing
     *
     * @param moved
     */
    public void setJustMovedIntoIndustrialKillingWater(boolean moved) {
<span class="nc" id="L7830">        justMovedIntoIndustrialKillingWater = moved;</span>
<span class="nc" id="L7831">    }</span>

    /**
     * did this mech just moved into water that would kill it because we lack
     * environmental sealing?
     *
     * @return
     */
    public boolean isJustMovedIntoIndustrialKillingWater() {
<span class="fc" id="L7840">        return justMovedIntoIndustrialKillingWater;</span>
    }

    /**
     * should this mech die at the end of turn because it's an IndustrialMech
     * without environmental sealing that moved into water last round and stayed
     * there?
     *
     * @return
     */
    public boolean shouldDieAtEndOfTurnBecauseOfWater() {
<span class="nc" id="L7851">        return shouldDieAtEndOfTurnBecauseOfWater;</span>
    }

    /**
     * Set if this Mech's ICE Engine is stalled or not should only be used for
     * industrial mechs carrying an ICE engine
     *
     * @param stalled
     */
    public void setStalled(boolean stalled) {
<span class="nc" id="L7861">        this.stalled = stalled;</span>
<span class="nc" id="L7862">        stalledThisTurn = true;</span>
<span class="nc" id="L7863">    }</span>

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#isStalled()
     */
    @Override
    public boolean isStalled() {
<span class="fc" id="L7872">        return stalled;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#isShutDown()
     */
    @Override
    public boolean isShutDown() {
<span class="pc bpc" id="L7882" title="2 of 4 branches missed.">        return super.isShutDown() || isStalled();</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#doCheckEngineStallRoll(java.util.Vector)
     */
    @Override
    public Vector&lt;Report&gt; doCheckEngineStallRoll(Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L7892" title="All 4 branches missed.">        if(hasEngine() &amp;&amp; (getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc" id="L7893">            Report r = new Report(2280);</span>
<span class="nc" id="L7894">            r.addDesc(this);</span>
<span class="nc" id="L7895">            r.subject = getId();</span>
<span class="nc" id="L7896">            r.add(1);</span>
<span class="nc" id="L7897">            r.add(&quot;ICE-Engine 'Mech failed a PSR&quot;);</span>
<span class="nc" id="L7898">            vPhaseReport.add(r);</span>
<span class="nc" id="L7899">            r = new Report(2285);</span>
<span class="nc" id="L7900">            r.subject = getId();</span>
            // Stall check is made against unmodified Piloting skill...
<span class="nc" id="L7902">            PilotingRollData base = new PilotingRollData(getId(), getCrew()</span>
<span class="nc" id="L7903">                    .getPiloting(), &quot;Base piloting skill&quot;);</span>
            // ...but dead or unconscious pilots should still auto-fail.
<span class="nc bnc" id="L7905" title="All 4 branches missed.">            if (getCrew().isDead() || getCrew().isDoomed()</span>
<span class="nc bnc" id="L7906" title="All 2 branches missed.">                    || (getCrew().getHits() &gt;= 6)) {</span>
<span class="nc" id="L7907">                base = new PilotingRollData(getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                        &quot;Pilot dead&quot;);
<span class="nc bnc" id="L7909" title="All 2 branches missed.">            } else if (!getCrew().isActive()) {</span>
<span class="nc" id="L7910">                base = new PilotingRollData(getId(), TargetRoll.IMPOSSIBLE,</span>
                        &quot;Pilot unconscious&quot;);
            }
<span class="nc" id="L7913">            r.add(base.getValueAsString());</span>
<span class="nc" id="L7914">            r.add(base.getDesc());</span>
<span class="nc" id="L7915">            vPhaseReport.add(r);</span>
<span class="nc" id="L7916">            r = new Report(2290);</span>
<span class="nc" id="L7917">            r.subject = getId();</span>
<span class="nc" id="L7918">            r.indent();</span>
<span class="nc" id="L7919">            r.newlines = 0;</span>
<span class="nc" id="L7920">            r.add(1);</span>
<span class="nc" id="L7921">            r.add(base.getPlainDesc());</span>
<span class="nc" id="L7922">            vPhaseReport.add(r);</span>
<span class="nc" id="L7923">            int diceRoll = getCrew().rollPilotingSkill();</span>
<span class="nc" id="L7924">            r = new Report(2300);</span>
<span class="nc" id="L7925">            r.subject = getId();</span>
<span class="nc" id="L7926">            r.add(base);</span>
<span class="nc" id="L7927">            r.add(diceRoll);</span>
<span class="nc bnc" id="L7928" title="All 2 branches missed.">            if (diceRoll &lt; base.getValue()) {</span>
<span class="nc" id="L7929">                r.choose(false);</span>
<span class="nc" id="L7930">                setStalled(true);</span>
<span class="nc" id="L7931">                r.newlines = 0;</span>
<span class="nc" id="L7932">                vPhaseReport.add(r);</span>
<span class="nc" id="L7933">                r = new Report(2303);</span>
<span class="nc" id="L7934">                r.subject = getId();</span>
<span class="nc" id="L7935">                vPhaseReport.add(r);</span>
            } else {
<span class="nc" id="L7937">                r.choose(true);</span>
<span class="nc" id="L7938">                vPhaseReport.add(r);</span>
            }
        }
<span class="nc" id="L7941">        return vPhaseReport;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#checkUnstall(java.util.Vector)
     */
    @Override
    public void checkUnstall(Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L7951" title="All 6 branches missed.">        if (stalled &amp;&amp; !stalledThisTurn &amp;&amp; hasEngine()</span>
<span class="nc bnc" id="L7952" title="All 2 branches missed.">                &amp;&amp; (getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc" id="L7953">            Report r = new Report(2280);</span>
<span class="nc" id="L7954">            r.addDesc(this);</span>
<span class="nc" id="L7955">            r.subject = getId();</span>
<span class="nc" id="L7956">            r.add(1);</span>
<span class="nc" id="L7957">            r.add(&quot;unstall stalled ICE engine&quot;);</span>
<span class="nc" id="L7958">            vPhaseReport.add(r);</span>
<span class="nc" id="L7959">            r = new Report(2285);</span>
<span class="nc" id="L7960">            r.subject = getId();</span>
            // Unstall check is made against unmodified Piloting skill...
<span class="nc" id="L7962">            PilotingRollData base = new PilotingRollData(getId(), getCrew()</span>
<span class="nc" id="L7963">                    .getPiloting(), &quot;Base piloting skill&quot;);</span>
            // ...but dead or unconscious pilots should still auto-fail, same as
            // for stalling.
<span class="nc bnc" id="L7966" title="All 4 branches missed.">            if (getCrew().isDead() || getCrew().isDoomed()</span>
<span class="nc bnc" id="L7967" title="All 2 branches missed.">                    || (getCrew().getHits() &gt;= 6)) {</span>
<span class="nc" id="L7968">                base = new PilotingRollData(getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                        &quot;Pilot dead&quot;);
<span class="nc bnc" id="L7970" title="All 2 branches missed.">            } else if (!getCrew().isActive()) {</span>
<span class="nc" id="L7971">                base = new PilotingRollData(getId(), TargetRoll.IMPOSSIBLE,</span>
                        &quot;Pilot unconscious&quot;);
            }
<span class="nc" id="L7974">            r.add(base.getValueAsString());</span>
<span class="nc" id="L7975">            r.add(base.getDesc());</span>
<span class="nc" id="L7976">            vPhaseReport.add(r);</span>
<span class="nc" id="L7977">            r = new Report(2290);</span>
<span class="nc" id="L7978">            r.subject = getId();</span>
<span class="nc" id="L7979">            r.indent();</span>
<span class="nc" id="L7980">            r.newlines = 0;</span>
<span class="nc" id="L7981">            r.add(1);</span>
<span class="nc" id="L7982">            r.add(base.getPlainDesc());</span>
<span class="nc" id="L7983">            vPhaseReport.add(r);</span>
<span class="nc" id="L7984">            int diceRoll = getCrew().rollPilotingSkill();</span>
<span class="nc" id="L7985">            r = new Report(2300);</span>
<span class="nc" id="L7986">            r.subject = getId();</span>
<span class="nc" id="L7987">            r.add(base);</span>
<span class="nc" id="L7988">            r.add(diceRoll);</span>
<span class="nc bnc" id="L7989" title="All 2 branches missed.">            if (diceRoll &lt; base.getValue()) {</span>
<span class="nc" id="L7990">                r.choose(false);</span>
<span class="nc" id="L7991">                vPhaseReport.add(r);</span>
            } else {
<span class="nc" id="L7993">                r.choose(true);</span>
<span class="nc" id="L7994">                r.newlines = 0;</span>
<span class="nc" id="L7995">                vPhaseReport.add(r);</span>
<span class="nc" id="L7996">                setStalled(false);</span>
<span class="nc" id="L7997">                r = new Report(2304);</span>
<span class="nc" id="L7998">                r.subject = getId();</span>
<span class="nc" id="L7999">                vPhaseReport.add(r);</span>
            }
        }
<span class="nc" id="L8002">    }</span>

    @Override
    public boolean isPrimitive() {
<span class="pc bpc" id="L8006" title="1 of 2 branches missed.">        return (getCockpitType() == Mech.COCKPIT_PRIMITIVE)</span>
<span class="pc bpc" id="L8007" title="1 of 2 branches missed.">                || (getCockpitType() == Mech.COCKPIT_PRIMITIVE_INDUSTRIAL);</span>
    }

    private int getFirstEmptyCrit(int Location) {
<span class="nc bnc" id="L8011" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(Location); i++) {</span>
<span class="nc bnc" id="L8012" title="All 2 branches missed.">            if (getCritical(Location, i) == null) {</span>
<span class="nc" id="L8013">                return i;</span>
            }
        }
<span class="nc" id="L8016">        return -1;</span>
    }

    public boolean hasArmoredCockpit() {

<span class="nc bnc" id="L8021" title="All 2 branches missed.">        int location = getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED ? Mech.LOC_CT</span>
<span class="nc" id="L8022">                : Mech.LOC_HEAD;</span>

<span class="nc bnc" id="L8024" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L8025">            CriticalSlot cs = getCritical(location, slot);</span>
<span class="nc bnc" id="L8026" title="All 4 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L8027" title="All 2 branches missed.">                    &amp;&amp; (cs.getIndex() == Mech.SYSTEM_COCKPIT)) {</span>
<span class="nc" id="L8028">                return cs.isArmored();</span>
            }
        }

<span class="nc" id="L8032">        return false;</span>
    }

    public boolean hasArmoredGyro() {
<span class="nc bnc" id="L8036" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(LOC_CT); slot++) {</span>
<span class="nc" id="L8037">            CriticalSlot cs = getCritical(LOC_CT, slot);</span>
<span class="nc bnc" id="L8038" title="All 4 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L8039" title="All 2 branches missed.">                    &amp;&amp; (cs.getIndex() == Mech.SYSTEM_GYRO)) {</span>
<span class="nc" id="L8040">                return cs.isArmored();</span>
            }
        }

<span class="nc" id="L8044">        return false;</span>
    }

    @Override
    public boolean hasArmoredEngine() {
<span class="nc bnc" id="L8049" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(LOC_CT); slot++) {</span>
<span class="nc" id="L8050">            CriticalSlot cs = getCritical(LOC_CT, slot);</span>
<span class="nc bnc" id="L8051" title="All 4 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L8052" title="All 2 branches missed.">                    &amp;&amp; (cs.getIndex() == Mech.SYSTEM_ENGINE)) {</span>
<span class="nc" id="L8053">                return cs.isArmored();</span>
            }
        }
<span class="nc" id="L8056">        return false;</span>
    }

    /**
     * should this mech check for a critical hit at the end of turn due to being
     * an industrial mech and having been the target of a succesfull physical
     * attack or for falling
     */
    public boolean isCheckForCrit() {
<span class="nc" id="L8065">        return checkForCrit;</span>
    }

    /**
     * how many levels did this mech fall this turn?
     *
     * @return
     */
    public int getLevelsFallen() {
<span class="nc" id="L8074">        return levelsFallen;</span>
    }

    public void setLevelsFallen(int levels) {
<span class="nc" id="L8078">        levelsFallen = levels;</span>
<span class="nc" id="L8079">    }</span>

    public void setCheckForCrit(boolean check) {
<span class="nc" id="L8082">        checkForCrit = check;</span>
<span class="nc" id="L8083">    }</span>

    /**
     * Is the passed in location an arm?
     *
     * @param loc
     * @return
     */
    public boolean isArm(int loc) {
<span class="nc bnc" id="L8092" title="All 4 branches missed.">        return (loc == Mech.LOC_LARM) || (loc == Mech.LOC_RARM);</span>
    }

    public double getArmoredComponentBV() {
<span class="nc" id="L8096">        double bv = 0.0f;</span>

        // all equipment gets 5% of BV cost per slot, or a flat +5 per slot
        // if BV is 0
<span class="nc bnc" id="L8100" title="All 2 branches missed.">        for (Mounted mount : getEquipment()) {</span>
<span class="nc bnc" id="L8101" title="All 2 branches missed.">            if (!mount.isArmored()</span>
<span class="nc bnc" id="L8102" title="All 2 branches missed.">                    || ((mount.getType() instanceof MiscType) &amp;&amp; ((MiscType) mount</span>
<span class="nc bnc" id="L8103" title="All 2 branches missed.">                            .getType()).hasFlag(MiscType.F_PPC_CAPACITOR))) {</span>
<span class="nc" id="L8104">                continue;</span>
            }
<span class="nc" id="L8106">            double mountBv = mount.getType().getBV(this);</span>
<span class="nc bnc" id="L8107" title="All 2 branches missed.">            if ((mount.getType() instanceof PPCWeapon)</span>
<span class="nc bnc" id="L8108" title="All 2 branches missed.">                    &amp;&amp; (mount.getLinkedBy() != null)) {</span>
<span class="nc" id="L8109">                mountBv += ((MiscType) mount.getLinkedBy().getType()).getBV(</span>
                        this, mount);
<span class="nc" id="L8111">                bv += mountBv * 0.05 * (mount.getCriticals() + 1);</span>
<span class="nc bnc" id="L8112" title="All 2 branches missed.">            } else if (mountBv &gt; 0) {</span>
<span class="nc" id="L8113">                bv += mountBv * 0.05 * mount.getCriticals();</span>
            } else {
<span class="nc" id="L8115">                bv += 5 * mount.getCriticals();</span>
            }
<span class="nc" id="L8117">        }</span>

<span class="nc bnc" id="L8119" title="All 2 branches missed.">        for (int location = 0; location &lt; locations(); location++) {</span>
<span class="nc bnc" id="L8120" title="All 2 branches missed.">            for (int slot = 0; slot &lt; getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L8121">                CriticalSlot cs = getCritical(location, slot);</span>
<span class="nc bnc" id="L8122" title="All 4 branches missed.">                if ((cs != null) &amp;&amp; cs.isArmored()</span>
<span class="nc bnc" id="L8123" title="All 2 branches missed.">                        &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
                    // gyro is the only system that has it's own BV
<span class="nc bnc" id="L8125" title="All 2 branches missed.">                    if ((cs.getIndex() == Mech.SYSTEM_GYRO)) {</span>
<span class="nc" id="L8126">                        bv += getWeight() * getGyroMultiplier() * 0.05;</span>
                    } else {
                        // System Crit that is armored but does not normally
                        // have a BV
<span class="nc" id="L8130">                        bv += 5;</span>
                    }
                }
            }
        }
<span class="nc" id="L8135">        return bv;</span>
    }

    public double getGyroMultiplier() {
<span class="nc bnc" id="L8139" title="All 2 branches missed.">        if ((getGyroType() == GYRO_HEAVY_DUTY)) {</span>
<span class="nc" id="L8140">            return 1.0;</span>
        }
<span class="nc bnc" id="L8142" title="All 4 branches missed.">        if (getGyroType() == GYRO_NONE &amp;&amp; getCockpitType() != COCKPIT_INTERFACE) {</span>
<span class="nc" id="L8143">            return 0;</span>
        }
<span class="nc" id="L8145">        return 0.5;</span>
    }

    public void setFullHeadEject(boolean fullHeadEject) {
<span class="fc" id="L8149">        this.fullHeadEject = fullHeadEject;</span>
<span class="fc" id="L8150">    }</span>

    public boolean hasFullHeadEject() {
<span class="fc" id="L8153">        return fullHeadEject;</span>
    }

    /**
     * Start of Battle Force Conversion Methods
     */

    @Override
    public double getBaseBattleForceMovement() {
<span class="nc" id="L8162">        double move = getOriginalWalkMP();</span>

<span class="nc bnc" id="L8164" title="All 2 branches missed.">        if (hasMASCAndSuperCharger()) {</span>
<span class="nc" id="L8165">            move *= 1.5;</span>
<span class="nc bnc" id="L8166" title="All 2 branches missed.">        } else if (hasMASC()) {</span>
<span class="nc" id="L8167">            move *= 1.25;</span>
        }

<span class="nc bnc" id="L8170" title="All 2 branches missed.">        if (hasMPReducingHardenedArmor()) {</span>
<span class="nc" id="L8171">            move--;</span>
        }

<span class="nc" id="L8174">        if (getMisc().stream().filter(m -&gt; m.getType().hasFlag(MiscType.F_CLUB))</span>
<span class="nc" id="L8175">        		.map(m -&gt; m.getType().getSubType())</span>
<span class="nc bnc" id="L8176" title="All 6 branches missed.">        		.anyMatch(st -&gt; st == MiscType.S_SHIELD_LARGE || st == MiscType.S_SHIELD_MEDIUM)) {</span>
<span class="nc" id="L8177">            move--;</span>
        }
<span class="nc" id="L8179">        return move;</span>
    }

    @Override
    /*
     * returns the battle force structure points for a mech
     */
    public int getBattleForceStructurePoints() {
<span class="nc" id="L8187">        int battleForceStructure = 0;</span>
<span class="nc" id="L8188">        int battleForceEngineType = 0;</span>

<span class="nc" id="L8190">        int[][] battleForceStructureTable = new int[][] {</span>
                { 1, 1, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 8, 8,
                    8, 8, 9, 9, 10, 10, 10, 11, 11, 11, 12, 12, 13, 13, 13, 14, 14, 14, 15, 15 },
                { 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 7, 7, 7, 8, 8, 9, 10, 10, 10,
                    11, 11, 12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20 },
                { 1, 1, 1, 2, 2, 2, 2, 3, 3, 4, 4, 4, 4, 5, 5, 5, 6, 6, 6,
                    6, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 10, 10, 10, 11, 11, 11, 11, 12, 12 },
                { 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5,
                    5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10 },
                { 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4,
                    5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 7, 7, 7, 7, 8 ,8, 8, 8, 8, 9 },
                { 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4,
                    4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 8 },
                { 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3,
                    3, 3, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6 },
                { 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3,
                    4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 7, 7 },
                { 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3,
                    3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5 } };

<span class="nc bnc" id="L8210" title="All 2 branches missed.">        if(hasEngine()) {</span>
<span class="nc bnc" id="L8211" title="All 2 branches missed.">            if (isClan()) {</span>
<span class="nc bnc" id="L8212" title="All 2 branches missed.">                if (getEngine().hasFlag(Engine.LARGE_ENGINE)) {</span>
<span class="nc bnc" id="L8213" title="All 3 branches missed.">                    switch (getEngine().getEngineType()) {</span>
                        case Engine.XL_ENGINE:
<span class="nc" id="L8215">                            battleForceEngineType = 5;</span>
<span class="nc" id="L8216">                            break;</span>
                        case Engine.XXL_ENGINE:
<span class="nc" id="L8218">                            battleForceEngineType = 8;</span>
<span class="nc" id="L8219">                            break;</span>
                    }
                } else {
<span class="nc bnc" id="L8222" title="All 3 branches missed.">                    switch (getEngine().getEngineType()) {</span>
                        case Engine.XL_ENGINE:
<span class="nc" id="L8224">                            battleForceEngineType = 4;</span>
<span class="nc" id="L8225">                            break;</span>
                        case Engine.XXL_ENGINE:
<span class="nc" id="L8227">                            battleForceEngineType = 6;</span>
<span class="nc" id="L8228">                            break;</span>
                        default:
<span class="nc" id="L8230">                            battleForceEngineType = 1;</span>
<span class="nc" id="L8231">                            break;</span>
                    }
                }
            } else {
<span class="nc bnc" id="L8235" title="All 2 branches missed.">                if (getEngine().hasFlag(Engine.LARGE_ENGINE)) {</span>
<span class="nc bnc" id="L8236" title="All 4 branches missed.">                    switch (getEngine().getEngineType()) {</span>
                        case Engine.XL_ENGINE:
<span class="nc" id="L8238">                            battleForceEngineType = 5;</span>
<span class="nc" id="L8239">                            break;</span>
                        case Engine.XXL_ENGINE:
<span class="nc" id="L8241">                            battleForceEngineType = 9;</span>
<span class="nc" id="L8242">                            break;</span>
                        case Engine.LIGHT_ENGINE:
<span class="nc" id="L8244">                            battleForceEngineType = 5;</span>
<span class="nc" id="L8245">                            break;</span>
                        default:
<span class="nc" id="L8247">                            battleForceEngineType = 3;</span>
<span class="nc" id="L8248">                            break;</span>
                    }
                } else {
<span class="nc bnc" id="L8251" title="All 5 branches missed.">                    switch (getEngine().getEngineType()) {</span>
                        case Engine.XL_ENGINE:
<span class="nc" id="L8253">                            battleForceEngineType = 5;</span>
<span class="nc" id="L8254">                            break;</span>
                        case Engine.COMPACT_ENGINE:
<span class="nc" id="L8256">                            battleForceEngineType = 2;</span>
<span class="nc" id="L8257">                            break;</span>
                        case Engine.LIGHT_ENGINE:
<span class="nc" id="L8259">                            battleForceEngineType = 4;</span>
<span class="nc" id="L8260">                            break;</span>
                        case Engine.XXL_ENGINE:
<span class="nc" id="L8262">                            battleForceEngineType = 7;</span>
<span class="nc" id="L8263">                            break;</span>
                        default:
<span class="nc" id="L8265">                            battleForceEngineType = 1;</span>
                            break;
                    }
                }
            }
        }

<span class="nc" id="L8272">        battleForceStructure = battleForceStructureTable[battleForceEngineType - 1][((int) getWeight() / 5) - 2];</span>

<span class="nc bnc" id="L8274" title="All 2 branches missed.">        if (getStructureType() == EquipmentType.T_STRUCTURE_COMPOSITE) {</span>
<span class="nc" id="L8275">            battleForceStructure = (int) Math.ceil(battleForceStructure * .5);</span>
<span class="nc bnc" id="L8276" title="All 2 branches missed.">        } else if (getStructureType() == EquipmentType.T_STRUCTURE_REINFORCED) {</span>
<span class="nc" id="L8277">            battleForceStructure *= 2;</span>
        }
<span class="nc" id="L8279">        return battleForceStructure;</span>

    }

    @Override
    public int getNumBattleForceWeaponsLocations() {
<span class="nc" id="L8285">        return 2;</span>
    }

    @Override
    public double getBattleForceLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc bnc" id="L8290" title="All 8 branches missed.">        if ((index == 0 &amp;&amp; !rearMounted</span>
                || (index == 1) &amp;&amp; rearMounted)) {
<span class="nc" id="L8292">            return 1.0;</span>
        }
<span class="nc" id="L8294">        return 0;</span>
    }

    @Override
    public String getBattleForceLocationName(int index) {
<span class="nc bnc" id="L8299" title="All 2 branches missed.">        if (index == 1) {</span>
<span class="nc" id="L8300">            return &quot;REAR&quot;;</span>
        }
<span class="nc" id="L8302">        return &quot;&quot;;</span>
    }

    @Override
    public boolean isBattleForceRearLocation(int index) {
<span class="nc bnc" id="L8307" title="All 2 branches missed.">        return index == 1;</span>
    }

    @Override
    public int getBattleForceTotalHeatGeneration(boolean allowRear) {
<span class="nc" id="L8312">        int totalHeat = 0;</span>

        // finish the max heat calculations
<span class="nc bnc" id="L8315" title="All 2 branches missed.">        if (this.getJumpMP() &gt; 0) {</span>
<span class="nc" id="L8316">            totalHeat += getJumpHeat(getJumpMP());</span>
<span class="nc bnc" id="L8317" title="All 4 branches missed.">        } else if (!isIndustrial() &amp;&amp; hasEngine()) {</span>
<span class="nc" id="L8318">            totalHeat += getEngine().getRunHeat(this);</span>
        }

<span class="nc bnc" id="L8321" title="All 2 branches missed.">        for (Mounted mount : getWeaponList()) {</span>
<span class="nc" id="L8322">            WeaponType weapon = (WeaponType) mount.getType();</span>
<span class="nc bnc" id="L8323" title="All 4 branches missed.">            if (weapon.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L8324" title="All 4 branches missed.">                || (allowRear &amp;&amp; !mount.isRearMounted())</span>
<span class="nc bnc" id="L8325" title="All 2 branches missed.">                || (!allowRear &amp;&amp; mount.isRearMounted())) {</span>
<span class="nc" id="L8326">                continue;</span>
            }
<span class="nc bnc" id="L8328" title="All 2 branches missed.">            if (weapon.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L8329">                totalHeat += weapon.getHeat() * 6;</span>
<span class="nc bnc" id="L8330" title="All 2 branches missed.">            } else if (weapon.getAmmoType() == AmmoType.T_AC_ULTRA</span>
<span class="nc bnc" id="L8331" title="All 2 branches missed.">                    || weapon.getAmmoType() == AmmoType.T_AC_ULTRA_THB) {</span>
<span class="nc" id="L8332">                totalHeat += weapon.getHeat() * 2;</span>
            } else {
<span class="nc" id="L8334">                totalHeat += weapon.getHeat();</span>
            }
<span class="nc" id="L8336">        }</span>

<span class="nc bnc" id="L8338" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_STEALTH, -1)) {</span>
<span class="nc" id="L8339">            totalHeat += 10;</span>
        }

<span class="nc" id="L8342">        return totalHeat;</span>
    }

    @Override
    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA,Integer&gt; specialAbilities) {
<span class="nc" id="L8347">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc" id="L8348">        specialAbilities.put(BattleForceSPA.SRCH, null);</span>
<span class="nc bnc" id="L8349" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L8350" title="All 2 branches missed.">            if (!(m.getType() instanceof MiscType)) {</span>
<span class="nc" id="L8351">                continue;</span>
            }
<span class="nc bnc" id="L8353" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_HARJEL)) {</span>
<span class="nc" id="L8354">                specialAbilities.put(BattleForceSPA.BHJ, null);</span>
<span class="nc bnc" id="L8355" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_HARJEL_II)) {</span>
<span class="nc" id="L8356">                specialAbilities.put(BattleForceSPA.BHJ2, null);</span>
<span class="nc bnc" id="L8357" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_HARJEL_III)) {</span>
<span class="nc" id="L8358">                specialAbilities.put(BattleForceSPA.BHJ3, null);</span>
<span class="nc bnc" id="L8359" title="All 2 branches missed.">            } else if (((MiscType)m.getType()).isShield()) {</span>
<span class="nc" id="L8360">                specialAbilities.put(BattleForceSPA.SHLD, null);</span>
<span class="nc bnc" id="L8361" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_INDUSTRIAL_TSM)) {</span>
<span class="nc" id="L8362">                specialAbilities.put(BattleForceSPA.ITSM, null);</span>
<span class="nc bnc" id="L8363" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_TSM)) {</span>
<span class="nc" id="L8364">                specialAbilities.put(BattleForceSPA.TSM, null);</span>
<span class="nc bnc" id="L8365" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_VOIDSIG)) {</span>
<span class="nc" id="L8366">                specialAbilities.put(BattleForceSPA.MAS, null);</span>
<span class="nc bnc" id="L8367" title="All 4 branches missed.">            } else if (isIndustrial() &amp;&amp; m.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)</span>
<span class="nc bnc" id="L8368" title="All 2 branches missed.">                    &amp;&amp; getEngine().getEngineType() != Engine.COMBUSTION_ENGINE) {</span>
<span class="nc" id="L8369">                specialAbilities.put(BattleForceSPA.SOA, null);</span>
<span class="nc bnc" id="L8370" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_NULLSIG)</span>
<span class="nc bnc" id="L8371" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_CHAMELEON_SHIELD)) {</span>
<span class="nc" id="L8372">                specialAbilities.put(BattleForceSPA.STL, null);</span>
<span class="nc" id="L8373">                specialAbilities.put(BattleForceSPA.ECM, null);</span>
<span class="nc bnc" id="L8374" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_UMU)) {</span>
<span class="nc" id="L8375">                specialAbilities.put(BattleForceSPA.UMU, null);</span>
<span class="nc bnc" id="L8376" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_BATTLEMECH_NIU)) {</span>
<span class="nc" id="L8377">                specialAbilities.put(BattleForceSPA.DN, null);</span>
            }
<span class="nc" id="L8379">        }</span>
<span class="nc bnc" id="L8380" title="All 2 branches missed.">        if (getCockpitType() == COCKPIT_COMMAND_CONSOLE) {</span>
<span class="nc" id="L8381">            specialAbilities.merge(BattleForceSPA.MHQ, 1, Integer::sum);</span>
<span class="nc bnc" id="L8382" title="All 2 branches missed.">        } else if (getCockpitType() == COCKPIT_SUPERHEAVY_COMMAND_CONSOLE) {</span>
<span class="nc" id="L8383">            specialAbilities.merge(BattleForceSPA.MHQ, 1, Integer::sum);</span>
<span class="nc bnc" id="L8384" title="All 2 branches missed.">        } else if (getCockpitType() == COCKPIT_SMALL_COMMAND_CONSOLE) {</span>
<span class="nc" id="L8385">            specialAbilities.merge(BattleForceSPA.MHQ, 1, Integer::sum);</span>
<span class="nc bnc" id="L8386" title="All 2 branches missed.">        } else if (getCockpitType() == COCKPIT_VRRP) {</span>
<span class="nc" id="L8387">            specialAbilities.merge(BattleForceSPA.VR, 1, Integer::sum);</span>
        }
<span class="nc bnc" id="L8389" title="All 2 branches missed.">        if (isIndustrial()) {</span>
<span class="nc bnc" id="L8390" title="All 2 branches missed.">            if (getCockpitType() == Mech.COCKPIT_STANDARD) {</span>
<span class="nc" id="L8391">                specialAbilities.put(BattleForceSPA.AFC, null);</span>
            } else {
<span class="nc" id="L8393">                specialAbilities.put(BattleForceSPA.BFC, null);</span>
            }
        } else {
<span class="nc" id="L8396">            specialAbilities.put(BattleForceSPA.SOA, null);</span>
        }
<span class="nc" id="L8398">    }</span>

    public abstract boolean hasMPReducingHardenedArmor();

    /**
     * End of Battle Force Conversion Methods
     */

    @Override
    public int getEngineHits() {
<span class="nc" id="L8408">        int engineHits = 0;</span>
<span class="nc" id="L8409">        engineHits += getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                Mech.SYSTEM_ENGINE, Mech.LOC_CT);
<span class="nc" id="L8411">        engineHits += getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                Mech.SYSTEM_ENGINE, Mech.LOC_RT);
<span class="nc" id="L8413">        engineHits += getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                Mech.SYSTEM_ENGINE, Mech.LOC_LT);
<span class="nc" id="L8415">        return engineHits;</span>
    }

    public int getGyroHits() {
<span class="nc" id="L8419">        return getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO,</span>
                Mech.LOC_CT);
    }

    @Override
    public boolean isGyroDestroyed() {
<span class="nc bnc" id="L8425" title="All 2 branches missed.">        if (getGyroType() == GYRO_HEAVY_DUTY) {</span>
<span class="nc bnc" id="L8426" title="All 2 branches missed.">            return getGyroHits() &gt; 2;</span>
        } else {
<span class="nc bnc" id="L8428" title="All 2 branches missed.">            return getGyroHits() &gt; 1;</span>
        }
    }

    @Override
    public String getLocationDamage(int loc) {
<span class="nc" id="L8434">        String toReturn = &quot;&quot;;</span>
<span class="nc" id="L8435">        boolean first = true;</span>
<span class="nc bnc" id="L8436" title="All 2 branches missed.">        if (isLocationBlownOff(loc)) {</span>
<span class="nc" id="L8437">            toReturn += &quot;BLOWN OFF&quot;;</span>
<span class="nc" id="L8438">            first = false;</span>
        }
<span class="nc bnc" id="L8440" title="All 2 branches missed.">        if (isLocationTrulyDestroyed(loc)) {</span>
<span class="nc" id="L8441">            return toReturn;</span>
        }
<span class="nc bnc" id="L8443" title="All 2 branches missed.">        if (getLocationStatus(loc) == ILocationExposureStatus.BREACHED) {</span>
<span class="nc bnc" id="L8444" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8445">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8447">            toReturn += &quot;BREACH&quot;;</span>
<span class="nc" id="L8448">            first = false;</span>
        }
<span class="nc bnc" id="L8450" title="All 2 branches missed.">        if (hasSystem(SYSTEM_LIFE_SUPPORT, loc)</span>
<span class="nc bnc" id="L8451" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        SYSTEM_LIFE_SUPPORT, loc) &gt; 0)) {
<span class="nc bnc" id="L8453" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8454">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8456">            toReturn += &quot;Life Spt.&quot;;</span>
<span class="nc" id="L8457">            first = false;</span>
        }
<span class="nc bnc" id="L8459" title="All 2 branches missed.">        if (hasSystem(SYSTEM_SENSORS, loc)</span>
<span class="nc bnc" id="L8460" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        SYSTEM_SENSORS, loc) &gt; 0)) {
<span class="nc bnc" id="L8462" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8463">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8465">            toReturn += &quot;Sensors&quot;;</span>
<span class="nc" id="L8466">            first = false;</span>
        }
<span class="nc bnc" id="L8468" title="All 2 branches missed.">        if (hasSystem(SYSTEM_COCKPIT, loc)</span>
<span class="nc bnc" id="L8469" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        SYSTEM_COCKPIT, loc) &gt; 0)) {
<span class="nc bnc" id="L8471" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8472">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8474">            toReturn += &quot;Cockpit&quot;;</span>
<span class="nc" id="L8475">            first = false;</span>
        }
<span class="nc bnc" id="L8477" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_SHOULDER, loc)</span>
<span class="nc bnc" id="L8478" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_SHOULDER, loc) &gt; 0)) {
<span class="nc bnc" id="L8480" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8481">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8483">            toReturn += &quot;Shoulder&quot;;</span>
<span class="nc" id="L8484">            first = false;</span>
        }
<span class="nc bnc" id="L8486" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_UPPER_ARM, loc)</span>
<span class="nc bnc" id="L8487" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_UPPER_ARM, loc) &gt; 0)) {
<span class="nc bnc" id="L8489" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8490">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8492">            toReturn += &quot;Upper Arm&quot;;</span>
<span class="nc" id="L8493">            first = false;</span>
        }
<span class="nc bnc" id="L8495" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_LOWER_ARM, loc)</span>
<span class="nc bnc" id="L8496" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_LOWER_ARM, loc) &gt; 0)) {
<span class="nc bnc" id="L8498" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8499">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8501">            toReturn += &quot;Lower Arm&quot;;</span>
<span class="nc" id="L8502">            first = false;</span>
        }
<span class="nc bnc" id="L8504" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_HAND, loc)</span>
<span class="nc bnc" id="L8505" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_HAND, loc) &gt; 0)) {
<span class="nc bnc" id="L8507" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8508">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8510">            toReturn += &quot;Hand&quot;;</span>
<span class="nc" id="L8511">            first = false;</span>
        }
<span class="nc bnc" id="L8513" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_HIP, loc)</span>
<span class="nc bnc" id="L8514" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM, ACTUATOR_HIP,</span>
                        loc) &gt; 0)) {
<span class="nc bnc" id="L8516" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8517">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8519">            toReturn += &quot;Hip&quot;;</span>
<span class="nc" id="L8520">            first = false;</span>
        }
<span class="nc bnc" id="L8522" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_UPPER_LEG, loc)</span>
<span class="nc bnc" id="L8523" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_UPPER_LEG, loc) &gt; 0)) {
<span class="nc bnc" id="L8525" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8526">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8528">            toReturn += &quot;Upper Leg&quot;;</span>
<span class="nc" id="L8529">            first = false;</span>
        }
<span class="nc bnc" id="L8531" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_LOWER_LEG, loc)</span>
<span class="nc bnc" id="L8532" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_LOWER_LEG, loc) &gt; 0)) {
<span class="nc bnc" id="L8534" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8535">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8537">            toReturn += &quot;Lower Leg&quot;;</span>
<span class="nc" id="L8538">            first = false;</span>
        }
<span class="nc bnc" id="L8540" title="All 2 branches missed.">        if (hasSystem(ACTUATOR_FOOT, loc)</span>
<span class="nc bnc" id="L8541" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        ACTUATOR_FOOT, loc) &gt; 0)) {
<span class="nc bnc" id="L8543" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8544">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8546">            toReturn += &quot;Foot&quot;;</span>
<span class="nc" id="L8547">            first = false;</span>
        }
<span class="nc bnc" id="L8549" title="All 2 branches missed.">        if ((getEntityType() &amp; ETYPE_QUADVEE) != 0</span>
<span class="nc bnc" id="L8550" title="All 2 branches missed.">                &amp;&amp; hasSystem(QuadVee.SYSTEM_CONVERSION_GEAR, loc)</span>
<span class="nc bnc" id="L8551" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        QuadVee.SYSTEM_CONVERSION_GEAR, loc) &gt; 0)) {
<span class="nc bnc" id="L8553" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8554">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8556">            toReturn += &quot;Conversion Gear&quot;;</span>
<span class="nc" id="L8557">            first = false;</span>
        }
<span class="nc bnc" id="L8559" title="All 2 branches missed.">        if ((getEntityType() &amp; ETYPE_LAND_AIR_MECH) != 0</span>
<span class="nc bnc" id="L8560" title="All 2 branches missed.">                &amp;&amp; hasSystem(LandAirMech.LAM_AVIONICS, loc)</span>
<span class="nc bnc" id="L8561" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        LandAirMech.LAM_AVIONICS, loc) &gt; 0)) {
<span class="nc bnc" id="L8563" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8564">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8566">            toReturn += &quot;Avionics&quot;;</span>
<span class="nc" id="L8567">            first = false;</span>
        }
<span class="nc bnc" id="L8569" title="All 2 branches missed.">        if ((getEntityType() &amp; ETYPE_LAND_AIR_MECH) != 0</span>
<span class="nc bnc" id="L8570" title="All 2 branches missed.">                &amp;&amp; hasSystem(LandAirMech.LAM_LANDING_GEAR, loc)</span>
<span class="nc bnc" id="L8571" title="All 2 branches missed.">                &amp;&amp; (getDamagedCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        LandAirMech.LAM_LANDING_GEAR, loc) &gt; 0)) {
<span class="nc bnc" id="L8573" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L8574">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L8576">            toReturn += &quot;Landing Gear&quot;;</span>
<span class="nc" id="L8577">            first = false;</span>
        }
<span class="nc" id="L8579">        return toReturn;</span>
    }

    @Override
    public boolean isCrippled() {
<span class="nc" id="L8584">        return isCrippled(false);</span>
    }

    @Override
    public boolean isCrippled(boolean checkCrew) {
<span class="nc bnc" id="L8589" title="All 2 branches missed.">        if (countInternalDamagedLimbs() &gt;= 3) {</span>
<span class="nc" id="L8590">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: 3+ limbs have taken internals.&quot;);</span>
<span class="nc" id="L8591">            return true;</span>
        }

<span class="nc bnc" id="L8594" title="All 2 branches missed.">        if (countInternalDamagedTorsos() &gt;= 2) {</span>
<span class="nc" id="L8595">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: 2+ torsos have taken internals.&quot;);</span>
<span class="nc" id="L8596">            return true;</span>
        }

<span class="nc bnc" id="L8599" title="All 2 branches missed.">        if (isLocationBad(LOC_LT)) {</span>
<span class="nc" id="L8600">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Left Torso destroyed.&quot;);</span>
<span class="nc" id="L8601">            return true;</span>
        }

<span class="nc bnc" id="L8604" title="All 2 branches missed.">        if (isLocationBad(LOC_RT)) {</span>
<span class="nc" id="L8605">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Right Torso destroyed.&quot;);</span>
<span class="nc" id="L8606">            return true;</span>
        }

<span class="nc bnc" id="L8609" title="All 2 branches missed.">        if (getEngineHits() &gt;= 2) {</span>
<span class="nc" id="L8610">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: 2 or more Engine Hits.&quot;);</span>
<span class="nc" id="L8611">            return true;</span>

        }

<span class="nc bnc" id="L8615" title="All 4 branches missed.">        if ((getEngineHits() == 1) &amp;&amp; (getGyroHits() == 1)) {</span>
<span class="nc" id="L8616">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Engine + Gyro hit.&quot;);</span>
<span class="nc" id="L8617">            return true;</span>
        }

<span class="nc bnc" id="L8620" title="All 2 branches missed.">        if (getHitCriticals(CriticalSlot.TYPE_SYSTEM, SYSTEM_SENSORS, LOC_HEAD) &gt; 1) {</span>
            // If the cockpit isn't torso-mounted, we're done; if it is, we
            // need to look at the CT sensor slot as well.
<span class="nc bnc" id="L8623" title="All 2 branches missed.">            if ((getCockpitType() != COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L8624" title="All 2 branches missed.">                    || (getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                            SYSTEM_SENSORS, LOC_CT) &gt; 0)) {
<span class="nc" id="L8626">                MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Sensors destroyed.&quot;);</span>
<span class="nc" id="L8627">                return true;</span>
            }
        }

<span class="nc bnc" id="L8631" title="All 4 branches missed.">        if ((getCrew() != null) &amp;&amp; (getCrew().getHits() &gt;= 4)) {</span>
<span class="nc" id="L8632">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Pilot has taken 4+ damage.&quot;);</span>
<span class="nc" id="L8633">            return true;</span>
        }

<span class="nc bnc" id="L8636" title="All 2 branches missed.">        if (isPermanentlyImmobilized(checkCrew)) {</span>
<span class="nc" id="L8637">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Immobilized.&quot;);</span>
<span class="nc" id="L8638">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L8642" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L8643">            return false;</span>
        }

        // no weapons can fire anymore, can cause no more than 5 points of
        // combined weapons damage,
        // or has no weapons with range greater than 5 hexes
<span class="nc bnc" id="L8649" title="All 2 branches missed.">        if (!hasViableWeapons()) {</span>
<span class="nc" id="L8650">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: has no more viable weapons.&quot;);</span>
<span class="nc" id="L8651">            return true;</span>
        }
<span class="nc" id="L8653">        return false;</span>
    }

    private int countInternalDamagedTorsos() {
<span class="nc" id="L8657">        int count = 0;</span>
<span class="nc bnc" id="L8658" title="All 2 branches missed.">        if ((getOInternal(LOC_CT) &gt; getInternal(LOC_CT))</span>
<span class="nc bnc" id="L8659" title="All 2 branches missed.">                &amp;&amp; (getArmor(LOC_CT) &lt; 1)) {</span>
<span class="nc" id="L8660">            count++;</span>
        }
<span class="nc bnc" id="L8662" title="All 2 branches missed.">        if ((getOInternal(LOC_LT) &gt; getInternal(LOC_LT))</span>
<span class="nc bnc" id="L8663" title="All 2 branches missed.">                &amp;&amp; (getArmor(LOC_LT) &lt; 1)) {</span>
<span class="nc" id="L8664">            count++;</span>
        }
<span class="nc bnc" id="L8666" title="All 2 branches missed.">        if ((getOInternal(LOC_RT) &gt; getInternal(LOC_RT))</span>
<span class="nc bnc" id="L8667" title="All 2 branches missed.">                &amp;&amp; (getArmor(LOC_RT) &lt; 1)) {</span>
<span class="nc" id="L8668">            count++;</span>
        }
<span class="nc" id="L8670">        return count;</span>
    }

    private int countInternalDamagedLimbs() {
<span class="nc" id="L8674">        int count = 0;</span>
<span class="nc bnc" id="L8675" title="All 2 branches missed.">        if (getOInternal(LOC_RLEG) &gt; getInternal(LOC_RLEG)) {</span>
<span class="nc" id="L8676">            count++;</span>
        }
<span class="nc bnc" id="L8678" title="All 2 branches missed.">        if (getOInternal(LOC_LLEG) &gt; getInternal(LOC_LLEG)) {</span>
<span class="nc" id="L8679">            count++;</span>
        }
<span class="nc bnc" id="L8681" title="All 2 branches missed.">        if (getOInternal(LOC_LARM) &gt; getInternal(LOC_LARM)) {</span>
<span class="nc" id="L8682">            count++;</span>
        }
<span class="nc bnc" id="L8684" title="All 2 branches missed.">        if (getOInternal(LOC_RARM) &gt; getInternal(LOC_RARM)) {</span>
<span class="nc" id="L8685">            count++;</span>
        }
<span class="nc" id="L8687">        return count;</span>
    }

    @Override
    public boolean canEscape() {
<span class="nc" id="L8692">        int hipHits = 0;</span>
<span class="nc" id="L8693">        int legsDestroyed = 0;</span>
<span class="nc bnc" id="L8694" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L8695" title="All 2 branches missed.">            if (locationIsLeg(i)) {</span>
<span class="nc bnc" id="L8696" title="All 2 branches missed.">                if (!isLocationBad(i)) {</span>
<span class="nc bnc" id="L8697" title="All 2 branches missed.">                    if (legHasHipCrit(i)) {</span>
<span class="nc" id="L8698">                        hipHits++;</span>
                    }
                } else {
<span class="nc" id="L8701">                    legsDestroyed++;</span>
                }
            }
        }
        //there is room for debate here but I think most people would agree that a
        //legged biped mech (and a double legged quad mech) or a hipped mech are not
        //escapable, although technically they still have as much MP as foot infantry which
        //can escape. We could also consider creating options to control this.
<span class="nc bnc" id="L8709" title="All 8 branches missed.">        if(((this instanceof BipedMech) &amp;&amp; (legsDestroyed &gt; 0))</span>
                || (legsDestroyed &gt; 1) || (hipHits &gt; 0)) {
<span class="nc" id="L8711">            return false;</span>
        }
<span class="nc" id="L8713">        return super.canEscape();</span>
    }

    @Override
    public boolean isPermanentlyImmobilized(boolean checkCrew) {
        // First check for conditions that would permanently immobilize *any*
        // entity; if we find any, we're already done.
<span class="nc bnc" id="L8720" title="All 2 branches missed.">        if (super.isPermanentlyImmobilized(checkCrew)) {</span>
<span class="nc" id="L8721">            return true;</span>
        }
        // If we're prone and base walking MP -- adjusted for gravity and
        // modular armor since they're reasonably permanent but ignoring heat
        // effects -- have dropped to 0, we're stuck even if we still have
        // jump jets because we can't get up anymore to *use* them.
<span class="nc bnc" id="L8727" title="All 4 branches missed.">        if ((getWalkMP(true, true, false) &lt;= 0) &amp;&amp; isProne()) {</span>
<span class="nc" id="L8728">            return true;</span>
        }
        // Gyro destroyed? TW p. 258 at least heavily implies that that counts
        // as being immobilized as well, which makes sense because the 'Mech
        // certainly isn't leaving that hex under its own power anymore.
<span class="nc bnc" id="L8733" title="All 2 branches missed.">        int hitsToDestroyGyro = (gyroType == GYRO_HEAVY_DUTY) ? 3 : 2;</span>
<span class="nc bnc" id="L8734" title="All 2 branches missed.">        if (getGyroHits() &gt;= hitsToDestroyGyro) {</span>
<span class="nc" id="L8735">            return true;</span>
        }
<span class="nc" id="L8737">        return false;</span>
    }

    @Override
    public boolean isDmgHeavy() {
<span class="nc bnc" id="L8742" title="All 2 branches missed.">        if (((double) getArmor(LOC_HEAD) / getOArmor(LOC_HEAD)) &lt;= 0.33) {</span>
<span class="nc" id="L8743">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Less than 1/3 head armor remaining&quot;);</span>
<span class="nc" id="L8744">            return true;</span>
        }

<span class="nc bnc" id="L8747" title="All 2 branches missed.">        if (getArmorRemainingPercent() &lt;= 0.25) {</span>
<span class="nc" id="L8748">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Less than 25% armor remaining&quot;);</span>
<span class="nc" id="L8749">            return true;</span>
        }

<span class="nc bnc" id="L8752" title="All 2 branches missed.">        if (countInternalDamagedLimbs() == 2) {</span>
<span class="nc" id="L8753">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Two limbs with internal damage&quot;);</span>
<span class="nc" id="L8754">            return true;</span>
        }

<span class="nc bnc" id="L8757" title="All 2 branches missed.">        if (countInternalDamagedTorsos() == 1) {</span>
<span class="nc" id="L8758">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Torso internal damage&quot;);</span>
<span class="nc" id="L8759">            return true;</span>
        }

<span class="nc bnc" id="L8762" title="All 2 branches missed.">        if (getEngineHits() == 1) {</span>
<span class="nc" id="L8763">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Engine hit&quot;);</span>
<span class="nc" id="L8764">            return true;</span>
        }

<span class="nc bnc" id="L8767" title="All 2 branches missed.">        if (getGyroHits() == 1) {</span>
<span class="nc" id="L8768">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Gyro hit&quot;);</span>
<span class="nc" id="L8769">            return true;</span>
        }

<span class="nc bnc" id="L8772" title="All 4 branches missed.">        if ((getCrew() != null) &amp;&amp; (getCrew().getHits() == 3)) {</span>
<span class="nc" id="L8773">            MegaMek.getLogger().debug(getDisplayName() + &quot; Three crew hits&quot;);</span>
<span class="nc" id="L8774">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L8778" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L8779">            return false;</span>
        }

<span class="nc" id="L8782">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L8783">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L8784" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L8785" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L8786">                totalInoperable++;</span>
            }
<span class="nc" id="L8788">        }</span>
<span class="nc bnc" id="L8789" title="All 2 branches missed.">        if (((double) totalInoperable / totalWeapons) &gt;= 0.75) {</span>
<span class="nc" id="L8790">            MegaMek.getLogger().debug(getDisplayName() + &quot; HEAVY DAMAGE: Less than 25% weapons operable&quot;);</span>
<span class="nc" id="L8791">            return true;</span>
        }
<span class="nc" id="L8793">        return false;</span>
    }

    @Override
    public boolean isDmgModerate() {
<span class="nc bnc" id="L8798" title="All 2 branches missed.">        if (((double) getArmor(LOC_HEAD) / getOArmor(LOC_HEAD)) &lt;= 0.67) {</span>
<span class="nc" id="L8799">            MegaMek.getLogger().debug(getDisplayName() + &quot; MODERATE DAMAGE: Less than 2/3 head armor&quot;);</span>
<span class="nc" id="L8800">            return true;</span>
        }

<span class="nc bnc" id="L8803" title="All 2 branches missed.">        if (getArmorRemainingPercent() &lt;= 0.5) {</span>
<span class="nc" id="L8804">            MegaMek.getLogger().debug(getDisplayName() + &quot; MODERATE DAMAGE: Less than 50% armor&quot;);</span>
<span class="nc" id="L8805">            return true;</span>
        }

<span class="nc bnc" id="L8808" title="All 2 branches missed.">        if (countInternalDamagedLimbs() == 1) {</span>
<span class="nc" id="L8809">            MegaMek.getLogger().debug(getDisplayName() + &quot; MODERATE DAMAGE: Limb with internal damage&quot;);</span>
<span class="nc" id="L8810">            return true;</span>
        }

<span class="nc bnc" id="L8813" title="All 4 branches missed.">        if ((getCrew() != null) &amp;&amp; (getCrew().getHits() == 2)) {</span>
<span class="nc" id="L8814">            MegaMek.getLogger().debug(getDisplayName() + &quot; MODERATE DAMAGE: 2 crew hits&quot;);</span>
<span class="nc" id="L8815">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L8819" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L8820">            return false;</span>
        }

<span class="nc" id="L8823">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L8824">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L8825" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L8826" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L8827">                totalInoperable++;</span>
            }
<span class="nc" id="L8829">        }</span>

<span class="nc bnc" id="L8831" title="All 2 branches missed.">        if (((double) totalInoperable / totalWeapons) &gt;= 0.5) {</span>
<span class="nc" id="L8832">            MegaMek.getLogger().debug(getDisplayName() + &quot; MODERATE DAMAGE: Less than 50% weapons operable&quot;);</span>
<span class="nc" id="L8833">            return true;</span>
        }
<span class="nc" id="L8835">        return false;</span>
    }

    @Override
    public boolean isDmgLight() {
<span class="nc bnc" id="L8840" title="All 2 branches missed.">        if (getArmor(LOC_HEAD) &lt; getOArmor(LOC_HEAD)) {</span>
<span class="nc" id="L8841">            MegaMek.getLogger().debug(getDisplayName() + &quot; LIGHT DAMAGE: head armor damaged&quot;);</span>
<span class="nc" id="L8842">            return true;</span>
        }

<span class="nc bnc" id="L8845" title="All 2 branches missed.">        if (getArmorRemainingPercent() &lt;= 0.75) {</span>
<span class="nc" id="L8846">            MegaMek.getLogger().debug(getDisplayName() + &quot; LIGHT DAMAGE: less than 75% armor remaining&quot;);</span>
<span class="nc" id="L8847">            return true;</span>
        }

<span class="nc bnc" id="L8850" title="All 4 branches missed.">        if ((getCrew() != null) &amp;&amp; (getCrew().getHits() == 1)) {</span>
<span class="nc" id="L8851">            MegaMek.getLogger().debug(getDisplayName() + &quot; LIGHT DAMAGE: crew hit&quot;);</span>
<span class="nc" id="L8852">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L8856" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L8857">            return false;</span>
        }

<span class="nc" id="L8860">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L8861">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L8862" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L8863" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L8864">                totalInoperable++;</span>
            }
<span class="nc" id="L8866">        }</span>

<span class="nc bnc" id="L8868" title="All 2 branches missed.">        if (((double) totalInoperable / totalWeapons) &gt;= 0.5) {</span>
<span class="nc" id="L8869">            MegaMek.getLogger().debug(getDisplayName() + &quot; LIGHT DAMAGE: Less than 75% weapons operable&quot;);</span>
<span class="nc" id="L8870">            return true;</span>
        }
<span class="nc" id="L8872">        return false;</span>
    }

    public boolean hasCompactHeatSinks() {
<span class="nc bnc" id="L8876" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L8877" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_COMPACT_HEAT_SINK)) {</span>
<span class="nc" id="L8878">                return true;</span>
            }
<span class="nc" id="L8880">        }</span>
<span class="nc" id="L8881">        return false;</span>
    }

    /**
     * Report the location as destroyed if blown off in a previous phase, doomed
     * if blown off in this one.
     */
    @Override
    public int getInternal(int loc) {
<span class="pc bpc" id="L8890" title="1 of 2 branches missed.">        if (isLocationBlownOff(loc)) {</span>
<span class="nc bnc" id="L8891" title="All 2 branches missed.">            return isLocationBlownOffThisPhase(loc) ? IArmorState.ARMOR_DOOMED</span>
<span class="nc" id="L8892">                    : IArmorState.ARMOR_DESTROYED;</span>
        }
<span class="fc" id="L8894">        return super.getInternal(loc);</span>
    }

    @Override
    public boolean isSuperHeavy() {
<span class="fc bfc" id="L8899" title="All 2 branches covered.">        return weight &gt; 100;</span>
    }

    @Override
    public long getEntityType() {
<span class="nc" id="L8904">        return Entity.ETYPE_MECH;</span>
    }

    @Override
    public boolean isEjectionPossible() {
<span class="nc bnc" id="L8909" title="All 2 branches missed.">        return (getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L8910" title="All 4 branches missed.">                &amp;&amp; getCrew().isActive() &amp;&amp; !hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT);</span>
    }

    /**
     * Check to see if a mech has a claw in one of its arms
     *
     * @param location
     *            (LOC_RARM or LOC_LARM)
     * @return True/False
     */
    public boolean hasClaw(int location) {
        // only arms have claws.
<span class="nc bnc" id="L8922" title="All 4 branches missed.">        if ((location != Mech.LOC_RARM) &amp;&amp; (location != Mech.LOC_LARM)) {</span>
<span class="nc" id="L8923">            return false;</span>
        }
<span class="nc bnc" id="L8925" title="All 2 branches missed.">        for (int slot = 0; slot &lt; this.getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L8926">            CriticalSlot cs = getCritical(location, slot);</span>

<span class="nc bnc" id="L8928" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L8929">                continue;</span>
            }
<span class="nc bnc" id="L8931" title="All 2 branches missed.">            if (cs.getType() != CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L8932">                continue;</span>
            }
<span class="nc" id="L8934">            Mounted m = cs.getMount();</span>
<span class="nc" id="L8935">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L8936" title="All 2 branches missed.">            if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L8937" title="All 2 branches missed.">                    &amp;&amp; type.hasFlag(MiscType.F_HAND_WEAPON)</span>
<span class="nc bnc" id="L8938" title="All 2 branches missed.">                    &amp;&amp; type.hasSubType(MiscType.S_CLAW)) {</span>
<span class="nc bnc" id="L8939" title="All 6 branches missed.">                return !(m.isDestroyed() || m.isMissing() || m.isBreached());</span>
            }
        }
<span class="nc" id="L8942">        return false;</span>
    }

    /**
     * Check whether a mech has intact heat-dissipating armor in every location
     * thus protecting it from external heat sources like fires or magma
     *
     * @return True/False
     */
    public boolean hasIntactHeatDissipatingArmor() {
<span class="nc bnc" id="L8952" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); ++loc) {</span>
<span class="nc bnc" id="L8953" title="All 2 branches missed.">            if ((getArmor(loc) &lt; 1)</span>
<span class="nc bnc" id="L8954" title="All 2 branches missed.">                || (getArmorType(loc) != EquipmentType.T_ARMOR_HEAT_DISSIPATING)) {</span>
<span class="nc" id="L8955">                return false;</span>
            }
        }
<span class="nc" id="L8958">        return true;</span>
    }


    /**
     * return if a RISC emergency coolant failed its roll
     * @param vDesc
     * @param vCriticals
     * @return
     */
    public boolean doRISCEmergencyCoolantCheckFor(Vector&lt;Report&gt; vDesc,
            HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; vCriticals) {
<span class="nc" id="L8970">        Mounted coolantSystem = null;</span>
<span class="nc bnc" id="L8971" title="All 2 branches missed.">        for (Mounted misc : getMisc()) {</span>
<span class="nc bnc" id="L8972" title="All 2 branches missed.">            if (misc.getType().hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)</span>
<span class="nc bnc" id="L8973" title="All 2 branches missed.">                    &amp;&amp; !misc.isInoperable()) {</span>
<span class="nc" id="L8974">                coolantSystem = misc;</span>
            }
<span class="nc" id="L8976">        }</span>
<span class="nc bnc" id="L8977" title="All 2 branches missed.">        if (coolantSystem != null) {</span>
<span class="nc" id="L8978">            boolean bFailure = false;</span>
<span class="nc" id="L8979">            int nRoll = Compute.d6(2);</span>
<span class="nc" id="L8980">            bUsedCoolantSystem = true;</span>
<span class="nc" id="L8981">            Report r = new Report(2365);</span>
<span class="nc" id="L8982">            r.subject = getId();</span>
<span class="nc" id="L8983">            r.addDesc(this);</span>
<span class="nc" id="L8984">            r.add(coolantSystem.getName());</span>
<span class="nc" id="L8985">            vDesc.addElement(r);</span>
<span class="nc" id="L8986">            r = new Report(2370);</span>
<span class="nc" id="L8987">            r.subject = getId();</span>
<span class="nc" id="L8988">            r.indent();</span>
<span class="nc" id="L8989">            r.add(EMERGENCY_COOLANT_SYSTEM_FAILURE[nCoolantSystemLevel]);</span>
<span class="nc" id="L8990">            r.add(nRoll);</span>

<span class="nc bnc" id="L8992" title="All 2 branches missed.">            if (nRoll &lt; EMERGENCY_COOLANT_SYSTEM_FAILURE[nCoolantSystemLevel]) {</span>
                // uh oh
<span class="nc" id="L8994">                bFailure = true;</span>
<span class="nc" id="L8995">                r.choose(false);</span>
<span class="nc" id="L8996">                vDesc.addElement(r);</span>
                // do the damage.
                // hit and auto crit to first engine crit in this location,
                // or the transfer location, if there's no hittable engine slot
                // in this location
<span class="nc" id="L9001">                coolantSystem.setHit(true);</span>
<span class="nc" id="L9002">                bDamagedCoolantSystem = true;</span>
<span class="nc" id="L9003">                int loc = coolantSystem.getLocation();</span>
<span class="nc" id="L9004">                boolean found = false;</span>
<span class="nc bnc" id="L9005" title="All 2 branches missed.">                for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L9006">                    CriticalSlot crit = getCritical(loc, i);</span>
<span class="nc bnc" id="L9007" title="All 2 branches missed.">                    if ((crit != null)</span>
<span class="nc bnc" id="L9008" title="All 2 branches missed.">                        &amp;&amp; crit.isHittable()</span>
<span class="nc bnc" id="L9009" title="All 2 branches missed.">                        &amp;&amp; (crit.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L9010" title="All 2 branches missed.">                        &amp;&amp; (crit.getIndex() == Mech.SYSTEM_ENGINE)) {</span>
<span class="nc" id="L9011">                        vCriticals.put(Integer.valueOf(loc),</span>
                                new LinkedList&lt;CriticalSlot&gt;());
<span class="nc" id="L9013">                        vCriticals.get(Integer.valueOf(loc)).add(crit);</span>
<span class="nc" id="L9014">                        found = true;</span>
<span class="nc" id="L9015">                        break;</span>
                    }
                }
<span class="nc bnc" id="L9018" title="All 2 branches missed.">                if (!found) {</span>
<span class="nc" id="L9019">                    loc = this.getTransferLocation(loc);</span>
<span class="nc bnc" id="L9020" title="All 2 branches missed.">                    for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L9021">                        CriticalSlot crit = getCritical(loc, i);</span>
<span class="nc bnc" id="L9022" title="All 2 branches missed.">                        if ((crit != null)</span>
<span class="nc bnc" id="L9023" title="All 2 branches missed.">                            &amp;&amp; crit.isHittable()</span>
<span class="nc bnc" id="L9024" title="All 2 branches missed.">                            &amp;&amp; (crit.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L9025" title="All 2 branches missed.">                            &amp;&amp; (crit.getIndex() == Mech.SYSTEM_ENGINE)) {</span>
<span class="nc" id="L9026">                            vCriticals.put(Integer.valueOf(loc),</span>
                                    new LinkedList&lt;CriticalSlot&gt;());
<span class="nc" id="L9028">                            vCriticals.get(Integer.valueOf(loc)).add(crit);</span>
<span class="nc" id="L9029">                            break;</span>
                        }
                    }
                }
<span class="nc" id="L9033">            } else {</span>
<span class="nc" id="L9034">                r.choose(true);</span>
<span class="nc" id="L9035">                vDesc.addElement(r);</span>
<span class="nc" id="L9036">                nCoolantSystemMOS = nRoll - EMERGENCY_COOLANT_SYSTEM_FAILURE[nCoolantSystemLevel];</span>
            }
<span class="nc" id="L9038">            return bFailure;</span>
        }
<span class="nc" id="L9040">        return false;</span>
    }

    public boolean hasDamagedCoolantSystem() {
<span class="nc" id="L9044">        return bDamagedCoolantSystem;</span>
    }

    public void setHasDamagedCoolantSystem(boolean hit) {
<span class="nc" id="L9048">        bDamagedCoolantSystem = hit;</span>
<span class="nc" id="L9049">    }</span>

    public int getCoolantSystemMOS() {
<span class="nc" id="L9052">        return nCoolantSystemMOS;</span>
    }

    public boolean isCoolingFlawActive() {
<span class="nc" id="L9056">        return coolingFlawActive;</span>
    }

    public void setCoolingFlawActive(boolean flawActive) {
<span class="nc" id="L9060">        coolingFlawActive = flawActive;</span>
<span class="nc" id="L9061">    }</span>

    /**
     * Used to determine the draw priority of different Entity subclasses.
     * This allows different unit types to always be draw above/below other
     * types.
     *
     * @return
     */
    @Override
    public int getSpriteDrawPriority() {
<span class="nc" id="L9072">        return 6;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>