<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Mounted.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Mounted.java</span></div><h1>Mounted.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

/*
 * Mounted.java
 *
 * Created on April 1, 2002, 1:29 PM
 */

package megamek.common;

import java.io.Serializable;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.Vector;

import megamek.MegaMek;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.options.OptionsConstants;
import megamek.common.options.WeaponQuirks;
import megamek.common.weapons.AmmoWeapon;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.WeaponHandler;
import megamek.common.weapons.bayweapons.AmmoBayWeapon;
import megamek.common.weapons.gaussrifles.GaussWeapon;

/**
 * This describes equipment mounted on a mech.
 *
 * @author Ben
 * @version
 */
public class Mounted implements Serializable, RoundUpdated, PhaseUpdated {

    private static final long serialVersionUID = 6438017987074691566L;
<span class="fc" id="L49">    private boolean usedThisRound = false;</span>
<span class="fc" id="L50">    private boolean destroyed = false;</span>
<span class="fc" id="L51">    private boolean hit = false;</span>
<span class="fc" id="L52">    private boolean missing = false;</span>
<span class="fc" id="L53">    private boolean jammed = false;</span>
<span class="fc" id="L54">    private boolean jammedThisPhase = false;</span>
<span class="fc" id="L55">    private boolean useless = false;</span>
<span class="fc" id="L56">    private boolean fired = false; // Only true for used OS stuff and TSEMP.</span>
<span class="fc" id="L57">    private boolean tsempDowntime = false; // Needed for &quot;every other turn&quot;</span>
                                           // TSEMP.
<span class="fc" id="L59">    private boolean rapidfire = false; // MGs in rapid-fire mode</span>
<span class="fc" id="L60">    private boolean hotloaded = false; // Hotloading for ammoType</span>
<span class="fc" id="L61">    private boolean repairable = true; // can the equipment mounted here be</span>
    // repaired
<span class="fc" id="L63">    private boolean mechTurretMounted = false; // is this mounted in a</span>
                                               // mechturret
<span class="fc" id="L65">    private boolean sponsonTurretMounted = false; // is this mounted in a</span>
                                                  // sponsonturret
<span class="fc" id="L67">    private boolean pintleTurretMounted = false; // is this mounted in a</span>
                                                 // pintleturret
<span class="fc" id="L69">    private int facing = -1; // facing for turrets</span>

    private int mode; // Equipment's current state. On or Off. Sixshot or
    // Fourshot, etc
<span class="fc" id="L73">    private int pendingMode = -1; // if mode changes happen at end of turn</span>
<span class="fc" id="L74">    private boolean modeSwitchable = true; // disallow mode switching</span>
    
    private int location;
    private boolean rearMounted;

<span class="fc" id="L79">    private Mounted linked = null; // for ammo, or artemis</span>
<span class="fc" id="L80">    private Mounted linkedBy = null; // reverse link for convenience</span>

<span class="fc" id="L82">    private Mounted crossLinkedBy = null; // Weapons with crossLinked capacitors</span>
<span class="fc" id="L83">    private int linkedBayId = -1;</span>

    private Entity entity; // what I'm mounted on

<span class="fc" id="L87">    private WeaponQuirks quirks = new WeaponQuirks();</span>

    private transient EquipmentType type;
    private String typeName;
<span class="fc" id="L91">    private double size = 1.0;</span>

    // ammo-specific stuff. Probably should be a subclass
    private int shotsLeft;
    // how many shots did we have originally?
    // only used for by-shot ammo
    private int originalShots;
    private boolean m_bPendingDump;
    private boolean m_bDumping;

    // A list of ids (equipment numbers) for the weapons and ammo linked to
    // this bay (if the mounted is of the BayWeapon type)
    // I can also use this for weapons of the same type on a capital fighter
    //and now Machine Gun Arrays too!
<span class="fc" id="L105">    private Vector&lt;Integer&gt; bayWeapons = new Vector&lt;Integer&gt;();</span>
<span class="fc" id="L106">    private Vector&lt;Integer&gt; bayAmmo = new Vector&lt;Integer&gt;();</span>
    
    // on capital fighters and squadrons some weapon mounts actually represent
    // multiple weapons of the same type
    // provide a boolean indicating this type of mount and the number of weapons
    // represented
<span class="fc" id="L112">    private boolean weaponGroup = false;</span>
<span class="fc" id="L113">    private int nweapons = 1;</span>

    // for ammo loaded by shot rather than ton, a boolean
<span class="fc" id="L116">    private boolean byShot = false;</span>

    // handle split weapons
<span class="fc" id="L119">    private boolean bSplit = false;</span>
<span class="fc" id="L120">    private int nFoundCrits = 0;</span>
<span class="fc" id="L121">    private int secondLocation = 0;</span>

    // bomb stuff
<span class="fc" id="L124">    private boolean bombMounted = false;</span>

    // mine type
<span class="fc" id="L127">    private int mineType = MINE_NONE;</span>
    // vibrabomb mine setting
<span class="fc" id="L129">    private int vibraSetting = 20;</span>

    //These arrays are used to track individual missing modular components on BA for MHQ
    //in MM they probably shouldn't need to be touched. They are used to keep track of
    //whether a modular mount is in use or not for a particular trooper.
<span class="fc" id="L134">    private boolean[] missingForTrooper = {false, false, false, false, false, false};</span>

    /**
     * Armor value, used for applicable equipment types like minesweepers.
     */
<span class="fc" id="L139">    private int armorValue = 0;</span>

<span class="fc" id="L141">    private IGame.Phase phase = IGame.Phase.PHASE_UNKNOWN;</span>

    public static final int MINE_NONE = -1;
    public static final int MINE_CONVENTIONAL = 0;
    public static final int MINE_VIBRABOMB = 1;
    public static final int MINE_ACTIVE = 2;
    public static final int MINE_INFERNO = 3;
    public static final int MINE_EMP = 4;
    public static final int MINE_COMMAND_DETONATED = 5;

    // New stuff for shields
<span class="fc" id="L152">    protected int baseDamageAbsorptionRate = 0;</span>
<span class="fc" id="L153">    protected int baseDamageCapacity = 0;</span>
<span class="fc" id="L154">    protected int damageTaken = 0;</span>

    /**
     * BA use locations for troopers, so we need a way to keep track of where
     *  a piece of equipment is moutned on BA
     */
<span class="fc" id="L160">    private int baMountLoc = BattleArmor.MOUNT_LOC_NONE;</span>

    /**
     *  For BA weapons, is this in a detachable weapon pack?
     */
<span class="fc" id="L165">    private boolean isDWPMounted = false;</span>

    /**
     * Does this Mounted represent a weapon that is mounted in an anti-personnel
     * weapon mount?
     */
<span class="fc" id="L171">    private boolean isAPMMounted = false;</span>
    
    /**
     * Does this Mounted represent equipmented that is pod mounted in an omni unit?
     */
<span class="fc" id="L176">    private boolean omniPodMounted = false;</span>

    // for Armored components
<span class="fc" id="L179">    private boolean armoredComponent = false;</span>

    // called shots status, sort of like another mode
<span class="fc" id="L182">    private CalledShot called = new CalledShot();</span>

    /**
     * Flag that keeps track of whether this &lt;code&gt;Mounted&lt;/code&gt; is mounted as
     * a squad support weapon on &lt;code&gt;BattleArmor&lt;/code&gt;.
     */
    private boolean squadSupportWeapon;

    /** Creates new Mounted */
<span class="fc" id="L191">    public Mounted(Entity entity, EquipmentType type) {</span>
<span class="fc" id="L192">        this.entity = entity;</span>
<span class="fc" id="L193">        this.type = type;</span>
<span class="fc" id="L194">        typeName = type.getInternalName();</span>

<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (type instanceof AmmoType) {</span>
<span class="fc" id="L197">            shotsLeft = ((AmmoType) type).getShots();</span>
<span class="fc" id="L198">            size = type.getTonnage(entity);</span>
        }
<span class="pc bpc" id="L200" title="1 of 4 branches missed.">        if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_MINE)) {</span>
<span class="nc" id="L201">            mineType = MINE_CONVENTIONAL;</span>
            // Used to keep track of the # of mines
<span class="nc" id="L203">            shotsLeft = 1;</span>
        }
<span class="fc bfc" id="L205" title="All 2 branches covered.">        if ((type instanceof MiscType) &amp;&amp;</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">                type.hasFlag(MiscType.F_VEHICLE_MINE_DISPENSER)) {</span>
<span class="nc" id="L207">            mineType = MINE_CONVENTIONAL;</span>
            // Used to keep track of the # of mines
<span class="nc" id="L209">            shotsLeft = 2;</span>
        }
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if ((type instanceof MiscType)</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">                &amp;&amp; type.hasFlag(MiscType.F_SENSOR_DISPENSER)) {</span>
<span class="nc" id="L213">            setShotsLeft(30);</span>
        }
<span class="fc bfc" id="L215" title="All 2 branches covered.">        if ((type instanceof MiscType)</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">                &amp;&amp; ((((MiscType) type).isShield() || type</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">                        .hasFlag(MiscType.F_MODULAR_ARMOR)))) {</span>
<span class="nc" id="L218">            MiscType shield = (MiscType) type;</span>
<span class="nc" id="L219">            baseDamageAbsorptionRate = shield.baseDamageAbsorptionRate;</span>
<span class="nc" id="L220">            baseDamageCapacity = shield.baseDamageCapacity;</span>
<span class="nc" id="L221">            damageTaken = shield.damageTaken;</span>
        }
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if ((type instanceof MiscType)</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">                &amp;&amp; type.hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L225">            armorValue = 30;</span>
        }

<span class="fc" id="L228">        quirks.initialize();</span>
<span class="fc" id="L229">    }</span>

    /**
     * Changing ammo loadouts allows updating AmmoTypes of existing bins. This
     * is the only circumstance under which this should happen.
     */

    public void changeAmmoType(AmmoType at) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!(type instanceof AmmoType)) {</span>
<span class="nc" id="L238">            System.out.println(&quot;Attempted to change ammo type of non-ammo&quot;);</span>
<span class="nc" id="L239">            return;</span>
        }
<span class="nc" id="L241">        type = at;</span>
<span class="nc" id="L242">        typeName = at.getInternalName();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (location == Entity.LOC_NONE) {</span>
            // Oneshot launcher
<span class="nc" id="L245">            shotsLeft = 1;</span>
        } else {
            // Regular launcher
<span class="nc" id="L248">            shotsLeft = at.getShots();</span>
        }
<span class="nc" id="L250">    }</span>

    /**
     * Restores the equipment from the name
     */
    public void restore() {
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">        if (typeName == null) {</span>
<span class="nc" id="L257">            typeName = type.getName();</span>
        } else {
<span class="fc" id="L259">            type = EquipmentType.get(typeName);</span>
        }

<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L263">            System.err</span>
<span class="nc" id="L264">                    .println(&quot;Mounted.restore: could not restore equipment type \&quot;&quot;</span>
                            + typeName + &quot;\&quot;&quot;);
        }
<span class="fc" id="L267">    }</span>

    public EquipmentType getType() {
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        return (null != type) ? type : (type = EquipmentType.get(typeName));</span>
    }
    
    /**
     * @return the current mode of the equipment, or &lt;code&gt;null&lt;/code&gt; if it's
     *         not available.
     */
    public EquipmentMode curMode() {
<span class="pc bpc" id="L278" title="2 of 4 branches missed.">        if ((mode &gt;= 0) &amp;&amp; (mode &lt; type.getModesCount())) {</span>
<span class="fc" id="L279">            return type.getMode(mode);</span>
        }
<span class="nc" id="L281">        return EquipmentMode.getMode(&quot;None&quot;);</span>
    }

    /**
     * @return the pending mode of the equipment.
     */
    public EquipmentMode pendingMode() {
<span class="nc bnc" id="L288" title="All 4 branches missed.">        if ((pendingMode &lt; 0) || (pendingMode &gt;= type.getModesCount())) {</span>
<span class="nc" id="L289">            return EquipmentMode.getMode(&quot;None&quot;);</span>
        }
<span class="nc" id="L291">        return type.getMode(pendingMode);</span>
    }

    /**
     * Switches the equipment mode to the next or previous available.
     *
     * @param forward
     *            Flag that determines whether the mode should be advanced
     *            forward or backwards.
     * @return new mode number, or &lt;code&gt;-1&lt;/code&gt; if it's not available.
     */
    public int switchMode(boolean forward) {
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (type.hasModes()) {</span>
<span class="nc" id="L304">            int nMode = 0;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (pendingMode &gt; -1) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                if (forward) {</span>
<span class="nc" id="L307">                    nMode = (pendingMode + 1) % type.getModesCount();</span>
                } else {
<span class="nc" id="L309">                    nMode = (pendingMode - 1);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                    if (nMode &lt; 0) {</span>
<span class="nc" id="L311">                        nMode = type.getModesCount() - 1;</span>
                    }
                }
            } else {
<span class="nc bnc" id="L315" title="All 2 branches missed.">                if (forward) {</span>
<span class="nc" id="L316">                    nMode = (mode + 1) % type.getModesCount();</span>
                } else {
<span class="nc" id="L318">                    nMode = (mode - 1);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                    if (nMode &lt; 0) {</span>
<span class="nc" id="L320">                        nMode = type.getModesCount() - 1;</span>
                    }
                }
            }
<span class="nc" id="L324">            setMode(nMode);</span>
<span class="nc" id="L325">            return nMode;</span>
        }
<span class="nc" id="L327">        return -1;</span>
    }

    /**
     * Sets the equipment mode to the mode denoted by the given mode name
     *
     * @param newMode
     *            the name of the desired new mode
     * @return new mode number on success, &lt;code&gt;-1&lt;code&gt; otherwise.
     */
    public int setMode(String newMode) {
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">        for (int x = 0, e = type.getModesCount(); x &lt; e; x++) {</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">            if (type.getMode(x).equals(newMode)) {</span>
<span class="fc" id="L340">                setMode(x);</span>
<span class="fc" id="L341">                return x;</span>
            }
        }
<span class="nc" id="L344">        return -1;</span>
    }

    /**
     * Sets the equipment mode to the mode denoted by the given mode number
     *
     * @param newMode
     *            the number of the desired new mode
     */
    public boolean setMode(int newMode) {
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">        if (type.hasModes()) {</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">            if (newMode &gt;= type.getModesCount()) {</span>
<span class="nc" id="L357">                return false;</span>
            }
            /*
             * megamek.debug.Assert.assertTrue(newMode &gt;= 0 &amp;&amp; newMode &lt;
             * type.getModesCount(), &quot;Invalid mode, mode=&quot; + newMode +
             * &quot;, modesCount=&quot; + type.getModesCount());
             */

<span class="pc bpc" id="L365" title="1 of 2 branches missed.">            if (canInstantSwitch(newMode)) {</span>
<span class="nc" id="L366">                mode = newMode;</span>
<span class="nc" id="L367">                pendingMode = -1;</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">            } else if (pendingMode != newMode) {</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">                if (mode == newMode) {</span>
<span class="nc" id="L370">                    pendingMode = -1;</span>
                } else {
<span class="fc" id="L372">                    pendingMode = newMode;</span>
                }
            }
        }
        // all communications equipment mounteds need to have the same mode at
        // all times
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">        if ((getType() instanceof MiscType)</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">                &amp;&amp; getType().hasFlag(MiscType.F_COMMUNICATIONS)) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                if (!m.equals(this)</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                        &amp;&amp; m.getType().hasFlag(MiscType.F_COMMUNICATIONS)) {</span>
<span class="nc" id="L383">                    m.setMode(newMode);</span>
                }
<span class="nc" id="L385">            }</span>
        }
<span class="fc" id="L387">        return true;</span>
    }

    /**
     * Can the switch from the current mode to the new mode happen instantly?
     *
     * @param newMode
     *            - integer for the new mode
     * @return
     */
    public boolean canInstantSwitch(int newMode) {
<span class="fc" id="L398">        String newModeName = type.getMode(newMode).getName();</span>
<span class="fc" id="L399">        String curModeName = curMode().getName();</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">        return getType().hasInstantModeSwitch()</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                &amp;&amp; !type.isNextTurnModeSwitch(newModeName)</span>
<span class="pc bnc" id="L402" title="All 2 branches missed.">                &amp;&amp; !type.isNextTurnModeSwitch(curModeName);</span>
    }

    public void newRound(int roundNumber) {
<span class="fc" id="L406">        setUsedThisRound(false);</span>

<span class="pc bpc" id="L408" title="1 of 6 branches missed.">        if ((type != null) &amp;&amp; (type.hasModes() &amp;&amp; (pendingMode != -1))) {</span>
<span class="fc" id="L409">            mode = pendingMode;</span>
<span class="fc" id="L410">            pendingMode = -1;</span>
        }
<span class="fc" id="L412">        called.reset();</span>
<span class="fc" id="L413">    }</span>

    public void newPhase(IGame.Phase phase) {
<span class="nc" id="L416">        jammed = jammedThisPhase;</span>
<span class="nc" id="L417">    }</span>

    /**
     * Shortcut to type.getName()
     */
    public String getName() {
<span class="fc" id="L423">        return type.getName(size);</span>
    }

    public String getShortName() {
<span class="nc" id="L427">        return type.getShortName(size);</span>
    }

    public String getDesc() {
        StringBuffer desc;
<span class="nc bnc" id="L432" title="All 6 branches missed.">        switch (getMineType()) {</span>
            case MINE_CONVENTIONAL:
<span class="nc" id="L434">                desc = new StringBuffer(</span>
<span class="nc" id="L435">                        Messages.getString(&quot;Mounted.ConventionalMine&quot;));</span>
<span class="nc" id="L436">                break;</span>
            case MINE_VIBRABOMB:
<span class="nc" id="L438">                desc = new StringBuffer(</span>
<span class="nc" id="L439">                        Messages.getString(&quot;Mounted.VibraBombMine&quot;));</span>
<span class="nc" id="L440">                break;</span>
            case MINE_COMMAND_DETONATED:
<span class="nc" id="L442">                desc = new StringBuffer(</span>
<span class="nc" id="L443">                        Messages.getString(&quot;Mounted.CommandDetonatedMine&quot;));</span>
<span class="nc" id="L444">                break;</span>
            case MINE_ACTIVE:
<span class="nc" id="L446">                desc = new StringBuffer(</span>
<span class="nc" id="L447">                        Messages.getString(&quot;Mounted.ActiveMine&quot;));</span>
<span class="nc" id="L448">                break;</span>
            case MINE_INFERNO:
<span class="nc" id="L450">                desc = new StringBuffer(</span>
<span class="nc" id="L451">                        Messages.getString(&quot;Mounted.InfernoMine&quot;));</span>
<span class="nc" id="L452">                break;</span>
            case -1:
            default:
<span class="nc" id="L455">                desc = new StringBuffer(type.getDesc(getSize()));</span>
        }
<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (isWeaponGroup()) {</span>
<span class="nc" id="L458">            desc.append(&quot; (&quot;).append(getNWeapons()).append(&quot;)&quot;);</span>
        }
<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (!repairable) {</span>
<span class="nc" id="L462">                desc.insert(0, &quot;**&quot;);</span>
            } else {
<span class="nc" id="L464">                desc.insert(0, &quot;*&quot;);</span>
            }
<span class="nc bnc" id="L466" title="All 2 branches missed.">        } else if (missing) {</span>
<span class="nc" id="L467">            desc.insert(0, &quot;x &quot;);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">        } else if (useless) {</span>
<span class="nc" id="L469">            desc.insert(0, &quot;x &quot;);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        } else if (usedThisRound) {</span>
<span class="nc" id="L471">            desc.insert(0, &quot;+&quot;);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">        } else if (jammed) {</span>
<span class="nc" id="L473">            desc.insert(0, &quot;j &quot;);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        } else if (fired) {</span>
<span class="nc" id="L475">            desc.insert(0, &quot;- &quot;);</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">        } else if (isPendingDump()) {</span>
<span class="nc" id="L477">            desc.insert(0, &quot;d &quot;);</span>
        }
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (rearMounted) {</span>
<span class="nc" id="L480">            desc.append(&quot; (R)&quot;);</span>
        }
<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (mechTurretMounted) {</span>
<span class="nc" id="L483">            desc.append(&quot; (T)&quot;);</span>
        }
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (sponsonTurretMounted) {</span>
<span class="nc" id="L486">            desc.append(&quot; (ST)&quot;);</span>
        }
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (pintleTurretMounted) {</span>
<span class="nc" id="L489">            desc.append(&quot; (PT)&quot;);</span>
        }
        // Append the facing for VGLs
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc bnc" id="L493" title="All 7 branches missed.">            switch (facing) {</span>
            case 0:
<span class="nc" id="L495">                desc.append(&quot; (F)&quot;);</span>
<span class="nc" id="L496">                break;</span>
            case 1:
<span class="nc" id="L498">                desc.append(&quot; (FR)&quot;);</span>
<span class="nc" id="L499">                break;</span>
            case 2:
<span class="nc" id="L501">                desc.append(&quot; (RR)&quot;);</span>
<span class="nc" id="L502">                break;</span>
            case 3:
<span class="nc" id="L504">                desc.append(&quot; (R)&quot;);</span>
<span class="nc" id="L505">                break;</span>
            case 4:
<span class="nc" id="L507">                desc.append(&quot; (RL)&quot;);</span>
<span class="nc" id="L508">                break;</span>
            case 5:
<span class="nc" id="L510">                desc.append(&quot; (FL)&quot;);</span>
                break;
            }
        }
<span class="nc bnc" id="L514" title="All 4 branches missed.">        if ((type instanceof AmmoType) &amp;&amp; (location != Entity.LOC_NONE)) {</span>

<span class="nc" id="L516">            desc.append(&quot; (&quot;);</span>
<span class="nc" id="L517">            desc.append(shotsLeft);</span>
<span class="nc" id="L518">            desc.append(&quot;)&quot;);</span>
        }
<span class="nc bnc" id="L520" title="All 2 branches missed.">        if (getEntity() instanceof BattleArmor) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (getBaMountLoc() == BattleArmor.MOUNT_LOC_BODY) {</span>
<span class="nc" id="L522">                desc.append(&quot; (Body)&quot;);</span>
            }
<span class="nc bnc" id="L524" title="All 2 branches missed.">            if (getBaMountLoc() == BattleArmor.MOUNT_LOC_LARM) {</span>
<span class="nc" id="L525">                desc.append(&quot; (Left arm)&quot;);</span>
            }
<span class="nc bnc" id="L527" title="All 2 branches missed.">            if (getBaMountLoc() == BattleArmor.MOUNT_LOC_RARM) {</span>
<span class="nc" id="L528">                desc.append(&quot; (Right arm)&quot;);</span>
            }
<span class="nc bnc" id="L530" title="All 2 branches missed.">            if (getBaMountLoc() == BattleArmor.MOUNT_LOC_TURRET) {</span>
<span class="nc" id="L531">                desc.append(&quot; (Turret)&quot;);</span>
            }
<span class="nc bnc" id="L533" title="All 2 branches missed.">            if (isDWPMounted()) {</span>
<span class="nc" id="L534">                desc.append(&quot; (DWP)&quot;);</span>
            }
<span class="nc bnc" id="L536" title="All 2 branches missed.">            if (isSquadSupportWeapon()) {</span>
<span class="nc" id="L537">                desc.append(&quot; (SSWM)&quot;);</span>
            }
<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (isAPMMounted()) {</span>
<span class="nc" id="L540">                desc.append(&quot; (APM)&quot;);</span>
            }
        }
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (isDumping()) {</span>
<span class="nc" id="L544">            desc.append(&quot; (dumping)&quot;);</span>
        }

<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (isArmored()){</span>
<span class="nc" id="L548">            desc.append(&quot; (armored)&quot;);</span>
        }
<span class="nc" id="L550">        return desc.toString();</span>
    }

    /**
     * @return The weight of the equipment in this mount, using the default rounding method for the {@link Entity}.
     */
    public double getTonnage() {
<span class="fc" id="L557">        return getTonnage(RoundWeight.STANDARD);</span>
    }

    /**
     * @param defaultRounding The method to use in rounding the weight
     * @return                The weight of the equipment in this mount
     */
    public double getTonnage(RoundWeight defaultRounding) {
<span class="pc bpc" id="L565" title="3 of 4 branches missed.">        if ((getType() instanceof MiscType) &amp;&amp; getType().hasFlag(MiscType.F_DUMPER)) {</span>
<span class="nc" id="L566">            final Bay bay = getEntity().getBayById(getLinkedBayId());</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (bay != null) {</span>
<span class="nc" id="L568">                return defaultRounding.round(bay.getCapacity() * 0.05, getEntity());</span>
            }
<span class="nc" id="L570">            MegaMek.getLogger().warning(&quot;Found dumper not linked to a cargo bay. Using zero for the weight.&quot;);</span>
<span class="nc" id="L571">            return 0.0;</span>
        }
<span class="fc" id="L573">        double retVal = getType().getTonnage(getEntity(), getLocation(), getSize(), defaultRounding);</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">        if (isDWPMounted()) {</span>
<span class="nc" id="L575">            return defaultRounding.round(retVal * 0.75, getEntity());</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">        } else if (isSquadSupportWeapon()) {</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">            retVal *= getEntity().isClan() ? 0.4 : 0.5;</span>
<span class="nc" id="L578">            return defaultRounding.round(retVal, getEntity());</span>
        }
<span class="fc" id="L580">        return retVal;</span>
    }

    public int getCriticals() {
<span class="fc" id="L584">        return getType().getCriticals(getEntity(), getSize());</span>
    }

    /**
     * @return The cost of the mounted equipment
     */
    public double getCost() {
<span class="nc" id="L591">        return getType().getCost(getEntity(), isArmored(), getLocation(), getSize());</span>
    }

    public boolean isReady() {
<span class="nc" id="L595">        return isReady(false);</span>
    }

    public boolean isReady(boolean isStrafing) {
<span class="nc bnc" id="L599" title="All 18 branches missed.">        return (!usedThisRound || isStrafing) &amp;&amp; !destroyed &amp;&amp; !missing</span>
                &amp;&amp; !jammed &amp;&amp; !useless &amp;&amp; !fired
<span class="nc bnc" id="L601" title="All 2 branches missed.">                &amp;&amp; (!isDWPMounted || (isDWPMounted &amp;&amp; (getLinkedBy() != null)));</span>
    }

    public boolean isUsedThisRound() {
<span class="nc" id="L605">        return usedThisRound;</span>
    }

    public void setUsedThisRound(boolean usedThisRound) {
<span class="fc" id="L609">        this.usedThisRound = usedThisRound;</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">        if (usedThisRound) {</span>
<span class="nc" id="L611">            phase = entity.game.getPhase();</span>
        } else {
<span class="fc" id="L613">            phase = IGame.Phase.PHASE_UNKNOWN;</span>
        }
<span class="fc" id="L615">    }</span>

    public IGame.Phase usedInPhase() {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (usedThisRound) {</span>
<span class="nc" id="L619">            return phase;</span>
        }
<span class="nc" id="L621">        return IGame.Phase.PHASE_UNKNOWN;</span>
    }

    public boolean isBreached() {
<span class="fc" id="L625">        return useless;</span>
    }

    public void setBreached(boolean breached) {
<span class="nc" id="L629">        useless = breached;</span>
<span class="nc" id="L630">    }</span>

    public boolean isDestroyed() {
<span class="fc" id="L633">        return destroyed;</span>
    }

    /**
     * Set this Mounted's destroyed status NOTE: only set this if this Mounted
     * cannot be used in the current phase anymore. If it still can, use setHit
     * instead
     *
     * @param destroyed
     * @see #setHit(boolean)
     */
    public void setDestroyed(boolean destroyed) {
<span class="nc" id="L645">        this.destroyed = destroyed;</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if ((destroyed == true)</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">                &amp;&amp; getType().hasFlag(MiscType.F_RADICAL_HEATSINK)){</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">            if (entity != null){</span>
<span class="nc" id="L649">                entity.setHasDamagedRHS(true);</span>
            }
        }
<span class="nc" id="L652">    }</span>

    public boolean isInoperable() {
<span class="pc bpc" id="L655" title="3 of 6 branches missed.">        return destroyed || missing || useless;</span>
    }

    public boolean isHit() {
<span class="nc" id="L659">        return hit;</span>
    }

    /**
     * set that this mounted was or was not hit with a crit this phase Note:
     * stuff that was hit in a phase can still be used in that phase, if that's
     * not desired, use setDestroyed instead
     *
     * @param hit
     * @see #setDestroyed(boolean)
     */
    public void setHit(boolean hit) {
<span class="nc" id="L671">        this.hit = hit;</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if ((hit == true)</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                &amp;&amp; getType().hasFlag(MiscType.F_RADICAL_HEATSINK)){</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">            if (entity != null){</span>
<span class="nc" id="L675">                entity.setHasDamagedRHS(true);</span>
            }
        }
<span class="nc" id="L678">    }</span>

    public boolean isMissing() {
<span class="nc" id="L681">        return missing;</span>
    }

    public void setMissing(boolean missing) {
<span class="nc" id="L685">        this.missing = missing;</span>
<span class="nc" id="L686">    }</span>

    public boolean isJammed() {
<span class="nc" id="L689">        return jammed;</span>
    }

    public void setJammed(boolean j) {
<span class="nc" id="L693">        jammedThisPhase = j;</span>
<span class="nc" id="L694">    }</span>

    public boolean jammedThisPhase() {
<span class="nc" id="L697">        return jammedThisPhase;</span>
    }

    /**
     * Clear all jam statuses - used by MHQ, because phase resetting doesn't work
     */
    public void resetJam() {
<span class="nc" id="L704">        jammed = false;</span>
<span class="nc" id="L705">        jammedThisPhase = false;</span>
<span class="nc" id="L706">    }</span>

    /**
     * The number of shots of ammunition currently stored in this Mounted
     * irregardless of its operational status. Or in other words, the straight
     * value last set by {@link #setShotsLeft(int)}, even if this ammo slot is
     * no longer functional or indeed notionally no longer part of the unit
     * formerly carrying it. This is the 'general' base value that should be
     * used for display, reporting, entity encoding and salvage purposes.
     *
     * @see #getHittableShotsLeft()
     * @see #getUsableShotsLeft()
     * @return The base 'true' number of shots in this slot.
     */
    public int getBaseShotsLeft() {
<span class="nc" id="L721">        return shotsLeft;</span>
    }

    /**
     * Convenience method returning the number of shots of ammunition in this
     * Mounted that may be affected by a critical hit. This method returns 0 if
     * this Mounted is marked as destroyed or missing and the same value as
     * {@link #getBaseShotsLeft()} otherwise.
     *
     * @see #getBaseShotsLeft()
     * @see #getUsableShotsLeft()
     * @return The number of 'hittable' shots in this slot.
     */
    public int getHittableShotsLeft() {
<span class="nc bnc" id="L735" title="All 4 branches missed.">        if (destroyed || missing) {</span>
<span class="nc" id="L736">            return 0;</span>
        }
<span class="nc" id="L738">        return shotsLeft;</span>
    }

    /**
     * Convenience method returning the number of shots of ammunition in this
     * Mounted that can actually be used &lt;em&gt;as&lt;/em&gt; ammunition. This method
     * returns 0 if this Mounted is marked as destroyed, missing, or breached
     * and thus nonfunctional and the same value as {@link #getBaseShotsLeft()}
     * otherwise.
     *
     * @see #getBaseShotsLeft()
     * @see #getHittableShotsLeft()
     * @return The number of usable shots in this slot.
     */
    public int getUsableShotsLeft() {
<span class="pc bpc" id="L753" title="3 of 6 branches missed.">        if (destroyed || missing || useless) {</span>
<span class="nc" id="L754">            return 0;</span>
        }
<span class="fc" id="L756">        return shotsLeft;</span>
    }

    public void setShotsLeft(int shotsLeft) {
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">        if (shotsLeft &lt; 0) {</span>
<span class="nc" id="L761">            shotsLeft = 0;</span>
        }
<span class="fc" id="L763">        this.shotsLeft = shotsLeft;</span>
<span class="fc" id="L764">    }</span>

    /**
     * Returns how many shots the weapon is using
     */
    public int getCurrentShots() {
<span class="nc" id="L770">        WeaponType wtype = (WeaponType) getType();</span>
<span class="nc" id="L771">        int nShots = getNumShots(wtype, curMode(), false);</span>
        // sets number of shots for MG arrays
<span class="nc bnc" id="L773" title="All 2 branches missed.">        if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L774">            nShots = 0;</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">            for(int eqn : getBayWeapons()) {</span>
<span class="nc" id="L776">                Mounted m = entity.getEquipment(eqn);</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                if(null == m) {</span>
<span class="nc" id="L778">                    continue;</span>
                }
<span class="nc bnc" id="L780" title="All 2 branches missed.">                if ((m.getLocation() == getLocation())</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">                        &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">                        &amp;&amp; !m.isBreached()</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">                        &amp;&amp; m.getType().hasFlag(WeaponType.F_MG)</span>
<span class="nc" id="L784">                        &amp;&amp; (((WeaponType) m.getType()).getRackSize() == ((WeaponType) getType())</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">                                .getRackSize())) {</span>
<span class="nc" id="L786">                    nShots++;</span>
                }
<span class="nc" id="L788">            }</span>
        }
<span class="nc" id="L790">        return nShots;</span>
    }

    /**
     * Returns how many shots a weapon type would use.  This can be used without
     * an instantiation of Mounted, which is useful for computing Aero heat.
     * If ignoreMode is true, then mode can be null.
     */
    public static int getNumShots(WeaponType wtype, EquipmentMode mode,
            boolean ignoreMode) {
        // figure out # of shots for variable-shot weapons
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (((wtype.getAmmoType() == AmmoType.T_AC_ULTRA) || (wtype</span>
<span class="nc bnc" id="L802" title="All 4 branches missed.">                .getAmmoType() == AmmoType.T_AC_ULTRA_THB))</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                &amp;&amp; (ignoreMode || mode.equals(Weapon.MODE_UAC_ULTRA))) {</span>
<span class="nc" id="L804">            return 2;</span>
        }
        // sets number of shots for AC rapid mode
<span class="nc bnc" id="L807" title="All 2 branches missed.">        else if (((wtype.getAmmoType() == AmmoType.T_AC) </span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">                || (wtype.getAmmoType() == AmmoType.T_LAC)</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                || (wtype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">                || (wtype.getAmmoType() == AmmoType.T_PAC))</span>
<span class="nc bnc" id="L811" title="All 4 branches missed.">                &amp;&amp; wtype.hasModes()</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                &amp;&amp; (ignoreMode || mode.equals(Weapon.MODE_AC_RAPID))) {</span>
<span class="nc" id="L813">            return 2;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        } else if ((wtype.getAmmoType() == AmmoType.T_AC_ROTARY)</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">                || wtype.getInternalName().equals(BattleArmor.MINE_LAUNCHER)) {</span>
<span class="nc bnc" id="L816" title="All 6 branches missed.">            if (ignoreMode || (mode == null) || mode.equals(Weapon.MODE_RAC_SIX_SHOT)) {</span>
<span class="nc" id="L817">                return 6;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">            } else if (mode.equals(Weapon.MODE_RAC_TWO_SHOT)) {</span>
<span class="nc" id="L819">                return 2;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">            } else if (mode.equals(Weapon.MODE_RAC_THREE_SHOT)) {</span>
<span class="nc" id="L821">                return 3;</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">            } else if (mode.equals(Weapon.MODE_RAC_FOUR_SHOT)) {</span>
<span class="nc" id="L823">                return 4;</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">            } else if (mode.equals(Weapon.MODE_RAC_FIVE_SHOT)) {</span>
<span class="nc" id="L825">                return 5;</span>
            }
        }
<span class="nc" id="L828">        return 1;</span>
    }

    public boolean isPendingDump() {
<span class="nc" id="L832">        return m_bPendingDump;</span>
    }

    public void setPendingDump(boolean b) {
<span class="nc" id="L836">        m_bPendingDump = b;</span>
<span class="nc" id="L837">    }</span>

    public boolean isDumping() {
<span class="fc" id="L840">        return m_bDumping;</span>
    }

    public void setDumping(boolean b) {
<span class="nc" id="L844">        m_bDumping = b;</span>
<span class="nc" id="L845">    }</span>

    /**
     * Used for equipment that can vary in size. This is not used for equipment for which
     * size is computed by outside factors such as unit weight or targeting computer-linked
     * weapons, but for equipment that comes in various weights, lengths, or capacities.
     * The meaning of the size varies according to the equipment. For robotic control systems,
     * this is the number of drones that can be controlled. For ladders this is the length in meters.
     * For most other variable equipment this is the weight in tons. Non-variable
     * equipment should return 1.0.
     *
     * @return The size of the mounted equipment
     */
    public double getSize() {
<span class="fc" id="L859">        return size;</span>
    }

    /**
     * Sets the size of variable-sized equipment.
     *
     * @param size
     * @see #getSize()
     */
    public void setSize(double size) {
<span class="nc" id="L869">        this.size = size;</span>
<span class="nc" id="L870">    }</span>
    
    /**
     * The capacity of an ammo bin may be different than the weight of the original shots
     * in the case of AR10s due to variable missile weight.
     * 
     * @return The capacity of a mounted ammo bin in tons.
     * @deprecated Use {@link #getSize()}
     */
    @Deprecated
    public double getAmmoCapacity() {
<span class="nc" id="L881">        return size;</span>
    }

    /**
     * Sets the maximum tonnage of ammo for a mounted ammo bin.
     * 
     * @param capacity The capacity of the bin in tons.
     * @deprecated Use {@link #setSize(double)}
     */
    @Deprecated
    public void setAmmoCapacity(double capacity) {
<span class="nc" id="L892">        size = capacity;</span>
<span class="nc" id="L893">    }</span>

    public boolean isRapidfire() {
<span class="nc" id="L896">        return rapidfire;</span>
    }

    public void setRapidfire(boolean rapidfire) {
<span class="nc" id="L900">        this.rapidfire = rapidfire;</span>
<span class="nc" id="L901">    }</span>
    
       
    /**
     * Checks to see if the current ammo for this weapon is hotloaded
     *
     * @return &lt;code&gt;true&lt;/code&gt; if ammo is hotloaded or &lt;code&gt;false&lt;/code&gt; if
     *         not
     */
    public boolean isHotLoaded() {

<span class="nc" id="L912">        boolean isHotLoaded = false;</span>

<span class="nc bnc" id="L914" title="All 2 branches missed.">        if (getType() instanceof WeaponType) {</span>
<span class="nc" id="L915">            Mounted link = getLinked();</span>
<span class="nc bnc" id="L916" title="All 4 branches missed.">            if ((link == null) || !(link.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L917">                return false;</span>
            }

<span class="nc" id="L920">            isHotLoaded = link.hotloaded;</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">            if (((AmmoType) link.getType()).getMunitionType() == AmmoType.M_DEAD_FIRE) {</span>
<span class="nc" id="L922">                return true;</span>
            }

            // Check to see if the ammo has its mode set to hotloaded.
            // This is for vehicles that can change hotload status during
            // combat.
<span class="nc bnc" id="L928" title="All 4 branches missed.">            if (!isHotLoaded &amp;&amp; link.getType().hasModes()</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">                    &amp;&amp; link.curMode().equals(&quot;HotLoad&quot;)) {</span>
<span class="nc" id="L930">                isHotLoaded = true;</span>
            }

<span class="nc" id="L933">            return isHotLoaded;</span>
        }

<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (getType() instanceof AmmoType) {</span>
<span class="nc" id="L937">            isHotLoaded = hotloaded;</span>

<span class="nc bnc" id="L939" title="All 2 branches missed.">            if (((AmmoType) getType()).getMunitionType() == AmmoType.M_DEAD_FIRE) {</span>
<span class="nc" id="L940">                return true;</span>
            }

            // Check to see if the ammo has its mode set to hotloaded.
            // This is for vehicles that can change hotload status during
            // combat.
<span class="nc bnc" id="L946" title="All 4 branches missed.">            if (!isHotLoaded &amp;&amp; getType().hasModes()</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                    &amp;&amp; curMode().equals(&quot;HotLoad&quot;)) {</span>
<span class="nc" id="L948">                isHotLoaded = true;</span>
            }

<span class="nc" id="L951">            return isHotLoaded;</span>
        }

<span class="nc" id="L954">        return false;</span>
    }

    /**
     * Sets the hotloading parameter for this weapons ammo.
     *
     * @param hotload
     */
    public void setHotLoad(boolean hotload) {

<span class="nc bnc" id="L964" title="All 2 branches missed.">        if (getType() instanceof WeaponType) {</span>
<span class="nc" id="L965">            Mounted link = getLinked();</span>
<span class="nc bnc" id="L966" title="All 4 branches missed.">            if ((link == null) || !(link.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L967">                return;</span>
            }
<span class="nc bnc" id="L969" title="All 2 branches missed.">            if (((AmmoType) link.getType()).hasFlag(AmmoType.F_HOTLOAD)) {</span>
<span class="nc" id="L970">                link.hotloaded = hotload;</span>
            }
        }
<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (getType() instanceof AmmoType) {</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">            if (((AmmoType) getType()).hasFlag(AmmoType.F_HOTLOAD)) {</span>
<span class="nc" id="L975">                hotloaded = hotload;</span>
            }
        }

<span class="nc" id="L979">    }</span>
    
    /** Returns true when m is a PPC Capacitor and not destroyed. */
    private boolean isWorkingCapacitor(Mounted m) {
<span class="nc bnc" id="L983" title="All 2 branches missed.">        return !m.isDestroyed()</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">        &amp;&amp; m.getType() instanceof MiscType</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">        &amp;&amp; ((MiscType) m.getType()).hasFlag(MiscType.F_PPC_CAPACITOR);</span>
    }

    /** 
     * Returns 1 or 2 if this Mounted has a linked
     * and charged (= set to charge in an earlier turn) 
     * PPC Capacitor.
     */
    public int hasChargedCapacitor() {
<span class="nc bnc" id="L994" title="All 2 branches missed.">        if (getCrossLinkedBy() != null</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">                &amp;&amp; isWorkingCapacitor(getCrossLinkedBy())</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">                &amp;&amp; getCrossLinkedBy().curMode().equals(&quot;Charge&quot;)) {</span>
<span class="nc" id="L997">            return 2;</span>
        }

<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if (getLinkedBy() != null</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">                &amp;&amp; isWorkingCapacitor(getLinkedBy())</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                &amp;&amp; getLinkedBy().curMode().equals(&quot;Charge&quot;)) {</span>
<span class="nc" id="L1003">            return 1;</span>
        }
<span class="nc" id="L1005">        return 0;</span>
    }

    /** 
     * Returns 1 or 2 if this Mounted has a linked
     * and charged (= set to charge in an earlier turn) 
     * or charging (= set to charge this turn)
     * PPC Capacitor. Used to determine heat. 
     */
    public int hasChargedOrChargingCapacitor() {
<span class="nc" id="L1015">        int isCharged = hasChargedCapacitor();</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">        if (isCharged != 0) {</span>
<span class="nc" id="L1017">            return isCharged;</span>
        } else {
            // When it has been set to charge this turn,
            // pendingMode is set
<span class="nc bnc" id="L1021" title="All 2 branches missed.">            if (getCrossLinkedBy() != null</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">                    &amp;&amp; isWorkingCapacitor(getCrossLinkedBy())</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">                    &amp;&amp; getCrossLinkedBy().pendingMode().equals(&quot;Charge&quot;)) {</span>
<span class="nc" id="L1024">                return 2;</span>
            }

<span class="nc bnc" id="L1027" title="All 2 branches missed.">            if (getLinkedBy() != null</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">                    &amp;&amp; isWorkingCapacitor(getLinkedBy())</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                    &amp;&amp; getLinkedBy().pendingMode().equals(&quot;Charge&quot;)) {</span>
<span class="nc" id="L1030">                return 1;</span>
            }
<span class="nc" id="L1032">            return 0;</span>
        }
    }

    public int getLocation() {
<span class="fc" id="L1037">        return location;</span>
    }

    public int getSecondLocation() {
<span class="nc bnc" id="L1041" title="All 2 branches missed.">        if (bSplit) {</span>
<span class="nc" id="L1042">            return secondLocation;</span>
        }
<span class="nc" id="L1044">        return -1;</span>
    }

    public boolean isRearMounted() {
<span class="fc" id="L1048">        return rearMounted;</span>
    }

    public void setLocation(int location) {
<span class="fc" id="L1052">        setLocation(location, false);</span>
<span class="fc" id="L1053">    }</span>

    public void setSecondLocation(int location) {
<span class="nc" id="L1056">        setSecondLocation(location, false);</span>
<span class="nc" id="L1057">    }</span>

    public void setLocation(int location, boolean rearMounted) {
<span class="fc" id="L1060">        this.location = location;</span>
<span class="fc" id="L1061">        this.rearMounted = rearMounted;</span>
<span class="fc" id="L1062">    }</span>

    public void setSecondLocation(int location, boolean rearMounted) {
<span class="nc" id="L1065">        secondLocation = location;</span>
<span class="nc" id="L1066">        this.rearMounted = rearMounted;</span>
<span class="nc" id="L1067">    }</span>

    public Mounted getLinked() {
<span class="fc" id="L1070">        return linked;</span>
    }

    public Mounted getLinkedBy() {
<span class="fc" id="L1074">        return linkedBy;</span>
    }

    public Mounted getCrossLinkedBy() {
<span class="nc" id="L1078">        return crossLinkedBy;</span>
    }

    public void setLinked(Mounted linked) {
<span class="fc" id="L1082">        this.linked = linked;</span>
<span class="pc bpc" id="L1083" title="1 of 2 branches missed.">        if (linked != null) {</span>
<span class="fc" id="L1084">            linked.setLinkedBy(this);</span>
        }
<span class="fc" id="L1086">    }</span>

    public void setCrossLinked(Mounted linked) {
<span class="nc" id="L1089">        this.linked = linked;</span>
<span class="nc" id="L1090">        linked.setCrossLinkedBy(this);</span>
<span class="nc" id="L1091">    }</span>

    // should only be called by setLinked(), or when dumping a DWP
    // in the case of a many-to-one relationship (like ammo) this is meaningless
    public void setLinkedBy(Mounted linker) {
<span class="pc bpc" id="L1096" title="2 of 4 branches missed.">        if ((linker != null) &amp;&amp; (linker.getLinked() != this)) {</span>
            // liar
<span class="nc" id="L1098">            return;</span>
        }
<span class="fc" id="L1100">        linkedBy = linker;</span>
<span class="fc" id="L1101">    }</span>

    // called by setCrossLinked() when using cross-linked capacitors.
    public void setCrossLinkedBy(Mounted linker) {
<span class="nc bnc" id="L1105" title="All 4 branches missed.">        if ((linker != null) &amp;&amp; (linker.getLinked() != this)) {</span>
            // liar
<span class="nc" id="L1107">            return;</span>
        }
<span class="nc" id="L1109">        crossLinkedBy = linker;</span>
<span class="nc" id="L1110">    }</span>

    /**
     * Used for associating the equipment mount with a cargo bay. This is for dumpers and transient bays
     * created on load for use by 'Mech cargo equipment.
     *
     * @return The index of the bay this mount is linked to, or -1 if it is not linked.
     * @see Entity#getBayById(int)
     */
    public int getLinkedBayId() {
<span class="nc" id="L1120">        return linkedBayId;</span>
    }

    public void setLinkedBayId(int id) {
<span class="nc" id="L1124">        linkedBayId = id;</span>
<span class="nc" id="L1125">    }</span>

    public int getFoundCrits() {
<span class="nc" id="L1128">        return nFoundCrits;</span>
    }

    public void setFoundCrits(int n) {
<span class="nc" id="L1132">        nFoundCrits = n;</span>
<span class="nc" id="L1133">    }</span>

    public boolean isSplit() {
<span class="nc" id="L1136">        return bSplit;</span>
    }

    public boolean isSplitable() {
<span class="pc bpc" id="L1140" title="1 of 6 branches missed.">        return (((getType() instanceof WeaponType) &amp;&amp; ((WeaponType)getType()).isSplitable()) || ((getType() instanceof MiscType) &amp;&amp; getType()</span>
<span class="pc bpc" id="L1141" title="1 of 2 branches missed.">                .hasFlag(MiscType.F_SPLITABLE)));</span>
    }

    public void setSplit(boolean b) {
<span class="nc" id="L1145">        bSplit = b;</span>
<span class="nc" id="L1146">    }</span>

    public int getExplosionDamage() {
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        if (type instanceof AmmoType) {</span>
<span class="nc" id="L1150">            AmmoType atype = (AmmoType) type;</span>
<span class="nc" id="L1151">            int rackSize = atype.getRackSize();</span>
<span class="nc" id="L1152">            int damagePerShot = atype.getDamagePerShot();</span>
            // Anti-ship EW bomb does no damage but deals a 5-point explosion if LAM bomb bay is hit
<span class="nc bnc" id="L1154" title="All 2 branches missed.">            if ((type instanceof BombType)</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">                    &amp;&amp; (((BombType)type).getBombType() == BombType.B_ASEW)) {</span>
<span class="nc" id="L1156">                damagePerShot = 5;</span>
            }
            
            //Capital missiles need a racksize for this
<span class="nc bnc" id="L1160" title="All 2 branches missed.">            if (type.hasFlag(AmmoType.F_CAP_MISSILE)) {</span>
<span class="nc" id="L1161">                rackSize = 1;</span>
            }
            
            //Screen launchers need a racksize. Damage is 15 per TW p251
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if (atype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER) {</span>
<span class="nc" id="L1166">                rackSize = 1;</span>
<span class="nc" id="L1167">                damagePerShot = 15;</span>
            }
            
<span class="nc" id="L1170">            long mType = atype.getMunitionType();</span>
            // both Dead-Fire and Tandem-charge SRM's do 3 points of damage per
            // shot when critted
            // Dead-Fire LRM's do 2 points of damage per shot when critted.
<span class="nc bnc" id="L1174" title="All 4 branches missed.">            if ((mType == AmmoType.M_DEAD_FIRE)</span>
                    || (mType == AmmoType.M_TANDEM_CHARGE)) {
<span class="nc" id="L1176">                damagePerShot++;</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">            } else if (atype.getAmmoType() == AmmoType.T_TASER) {</span>
<span class="nc" id="L1178">                damagePerShot = 6;</span>
            }

<span class="nc bnc" id="L1181" title="All 2 branches missed.">            if (atype.getAmmoType() == AmmoType.T_MEK_MORTAR) {</span>
<span class="nc bnc" id="L1182" title="All 6 branches missed.">                if ((mType == AmmoType.M_AIRBURST)</span>
                        || (mType == AmmoType.M_FLARE)
                        || (mType == AmmoType.M_SMOKE_WARHEAD)) {
<span class="nc" id="L1185">                    damagePerShot = 1;</span>
                } else {
<span class="nc" id="L1187">                    damagePerShot = 2;</span>
                }
            }

<span class="nc" id="L1191">            return damagePerShot * rackSize * shotsLeft;</span>
        }

<span class="nc bnc" id="L1194" title="All 2 branches missed.">        if (type instanceof WeaponType) {</span>
<span class="nc" id="L1195">            WeaponType wtype = (WeaponType) type;</span>
            // TacOps Gauss Weapon rule p. 102
<span class="nc bnc" id="L1197" title="All 4 branches missed.">            if ((type instanceof GaussWeapon) &amp;&amp; type.hasModes()</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">                    &amp;&amp; curMode().equals(&quot;Powered Down&quot;)) {</span>
<span class="nc" id="L1199">                return 0;</span>
            }
<span class="nc bnc" id="L1201" title="All 4 branches missed.">            if ((isHotLoaded() || hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_AMMO_FEED_PROBLEMS))</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">                    &amp;&amp; (getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L1203">                Mounted link = getLinked();</span>
<span class="nc" id="L1204">                AmmoType atype = ((AmmoType) link.getType());</span>
<span class="nc" id="L1205">                int damagePerShot = atype.getDamagePerShot();</span>
                // Launchers with Dead-Fire missles in them do an extra point of
                // damage per shot when critted
<span class="nc bnc" id="L1208" title="All 2 branches missed.">                if (atype.getAmmoType() == AmmoType.M_DEAD_FIRE) {</span>
<span class="nc" id="L1209">                    damagePerShot++;</span>
                }

<span class="nc" id="L1212">                int damage = wtype.getRackSize() * damagePerShot;</span>
<span class="nc" id="L1213">                return damage;</span>
            }

<span class="nc bnc" id="L1216" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_PPC) &amp;&amp; (hasChargedCapacitor() != 0)) {</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">                if (isFired()) {</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">                    if (hasChargedCapacitor() == 2) {</span>
<span class="nc" id="L1219">                        return 15;</span>
                    }
<span class="nc" id="L1221">                    return 0;</span>
                }
<span class="nc bnc" id="L1223" title="All 2 branches missed.">                if (hasChargedCapacitor() == 2) {</span>
<span class="nc" id="L1224">                    return 30;</span>
                }
<span class="nc" id="L1226">                return 15;</span>
            }

<span class="nc bnc" id="L1229" title="All 4 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_MPOD) &amp;&amp; isFired()) {</span>
<span class="nc" id="L1230">                return 0;</span>
            }

<span class="nc" id="L1233">            return wtype.getExplosionDamage();</span>

        }

<span class="nc bnc" id="L1237" title="All 2 branches missed.">        if (type instanceof MiscType) {</span>
<span class="nc" id="L1238">            MiscType mtype = (MiscType) type;</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc bnc" id="L1240" title="All 4 branches missed.">                if (curMode().equals(&quot;Charge&quot;) &amp;&amp; (linked != null)</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">                        &amp;&amp; !linked.isFired()) {</span>
<span class="nc" id="L1242">                    return 15;</span>
                }
            }
<span class="nc bnc" id="L1245" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_FUEL)) {</span>
<span class="nc" id="L1246">                return 20;</span>
            }
<span class="nc bnc" id="L1248" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L1249">                return 5;</span>
            }
<span class="nc bnc" id="L1251" title="All 6 branches missed.">            if (mtype.hasFlag(MiscType.F_JUMP_JET) &amp;&amp; mtype.hasSubType(MiscType.S_PROTOTYPE) &amp;&amp; mtype.hasSubType(MiscType.S_IMPROVED)) {</span>
<span class="nc" id="L1252">                return 10;</span>
            }
<span class="nc bnc" id="L1254" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L1255">                return 2;</span>
            }

<span class="nc bnc" id="L1258" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L1259">                return 5;</span>
            }
<span class="nc" id="L1261">            return 0;</span>
        }
        // um, otherwise, I'm not sure
<span class="nc" id="L1264">        MegaMek.getLogger().error(&quot;mounted: unable to determine explosion damage for &quot; + typeName);</span>
<span class="nc" id="L1265">        return 0;</span>
    }

    public boolean isFired() { // has a oneshot weapon been fired?
<span class="nc" id="L1269">        return fired;</span>
    }

    public void setFired(boolean val) {
<span class="nc" id="L1273">        fired = val;</span>
<span class="nc" id="L1274">    }</span>

    public boolean isTSEMPDowntime() { // is this the &quot;downtime&quot; turn for TSEMP?
<span class="nc" id="L1277">        return tsempDowntime;</span>
    }

    public void setTSEMPDowntime(boolean val) {
<span class="nc" id="L1281">        tsempDowntime = val;</span>
<span class="nc" id="L1282">    }</span>

    /**
     * Confirm that the given entity can fire the indicated equipment.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the equipment can be fired by the entity;
     *         &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean canFire() {
<span class="nc" id="L1291">        return canFire(false);</span>
    }

    public boolean canFire(boolean isStrafing) {

        // Equipment operational?
<span class="nc bnc" id="L1297" title="All 8 branches missed.">        if (!isReady(isStrafing) || isBreached() || isMissing() || isFired()) {</span>
<span class="nc" id="L1298">            return false;</span>
        }

        // Is the entity even active?
<span class="nc bnc" id="L1302" title="All 2 branches missed.">        if (entity.isShutDown()</span>
<span class="nc bnc" id="L1303" title="All 4 branches missed.">                || ((null != entity.getCrew()) &amp;&amp; !entity.getCrew().isActive())) {</span>
<span class="nc" id="L1304">            return false;</span>
        }

        // Otherwise, the equipment can be fired.
<span class="nc" id="L1308">        return true;</span>
    }

    /**
     * Determines whether this weapon should be considered crippled for damage
     * level purposes.
     *
     * @return {@code true} if the weapon is at least one of: destroyed,
     *         missing, breached, jammed, a detachable weapon no longer attached
     *         to its original battle armor, or simply out of ammo (includes
     *         discharged one-shot weapons), {@code false} otherwise.
     */
    public boolean isCrippled() {
        /*
         * Have to account for jammed weapons here because we're currently not
         * distinguishing between potentially temporary and permanent jams, and
         * a perma-jammed weapon definitely _is_ crippled. Moreover, even a
         * weapon that could be unjammed again may end up never getting there
         * and isn't contributing anything in the meantime, so it might as well
         * be considered &quot;crippled&quot; until the jam clears, if ever.
         */
<span class="pc bpc" id="L1329" title="5 of 10 branches missed.">        if (destroyed || jammed || missing || useless || fired) {</span>
<span class="nc" id="L1330">            return true;</span>
        }
<span class="pc bpc" id="L1332" title="1 of 4 branches missed.">        if ((type instanceof AmmoWeapon) || (type instanceof AmmoBayWeapon)) {</span>
<span class="pc bpc" id="L1333" title="1 of 2 branches missed.">            if ((getLinked() == null)</span>
<span class="pc bpc" id="L1334" title="1 of 2 branches missed.">                    || (entity.getTotalAmmoOfType(getLinked().getType()) &lt; 1)) {</span>
<span class="nc" id="L1335">                return true;</span>
            }
        }
<span class="pc bpc" id="L1338" title="3 of 4 branches missed.">        if (isDWPMounted &amp;&amp; (getLinkedBy() != null)) {</span>
<span class="nc" id="L1339">            return true;</span>
        }
<span class="fc" id="L1341">        return false;</span>
    }

    /**
     * Returns false if this ammo should not be loaded. Checks if the ammo is
     * already destroyed or missing, is being dumped, has been breached, is
     * already used up, or is locationless (oneshot ammo).
     */
    public boolean isAmmoUsable() {
<span class="pc bpc" id="L1350" title="6 of 12 branches missed.">        if (destroyed || missing || m_bDumping || useless || (shotsLeft &lt;= 0)</span>
                || (location == Entity.LOC_NONE)) {
<span class="nc" id="L1352">            return false;</span>
        }
<span class="fc" id="L1354">        return true;</span>
    }

    /**
     * @return the type of mine this mounted is, or &lt;code&gt;-1&lt;/code&gt; if it isn't
     *         a mine
     */
    public int getMineType() {
<span class="nc" id="L1362">        return mineType;</span>
    }

    /**
     * set the type of mine this should be
     *
     * @param mineType
     */
    public void setMineType(int mineType) {
<span class="nc" id="L1371">        this.mineType = mineType;</span>
<span class="nc" id="L1372">    }</span>

    /**
     * set the vibrabomb sensitivity
     *
     * @param vibraSetting
     *            the &lt;code&gt;int&lt;/code&gt; sensitivity to set
     */
    public void setVibraSetting(int vibraSetting) {
<span class="nc" id="L1381">        this.vibraSetting = vibraSetting;</span>
<span class="nc" id="L1382">    }</span>

    /**
     * get the vibrabomb sensitivity
     *
     * @return the &lt;code&gt;int&lt;/code&gt; vibrabomb sensitity this mine is set to.
     */
    public int getVibraSetting() {
<span class="nc" id="L1390">        return vibraSetting;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L1395">        return &quot;megamek.common.Mounted (&quot; + typeName + &quot;)&quot;;</span>
    }

    public int getBaseDamageAbsorptionRate() {
<span class="nc" id="L1399">        return baseDamageAbsorptionRate;</span>
    }

    public int getBaseDamageCapacity() {
<span class="nc" id="L1403">        return baseDamageCapacity;</span>
    }

    /**
     * Rules state that every time the shield takes a crit its damage absorption
     * for each attack is reduced by 1. Also for every Arm actuator critted
     * damage absorption is reduced by 1 and finally if the shoulder is hit the
     * damage absorption is reduced by 2 making it possble to kill a shield
     * before its gone through its full damage capacity.
     *
     * @param entity
     * @param location
     * @return
     */
    public int getDamageAbsorption(Entity entity, int location) {
        // Shields can only be used in arms so if you've got a shield in a
        // location
        // other then an arm your SOL --Torren.
<span class="nc bnc" id="L1421" title="All 4 branches missed.">        if ((location != Mech.LOC_RARM) &amp;&amp; (location != Mech.LOC_LARM)) {</span>
<span class="nc" id="L1422">            return 0;</span>
        }

<span class="nc" id="L1425">        int base = baseDamageAbsorptionRate;</span>

<span class="nc bnc" id="L1427" title="All 2 branches missed.">        for (int slot = 0; slot &lt; entity.getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L1428">            CriticalSlot cs = entity.getCritical(location, slot);</span>

<span class="nc bnc" id="L1430" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L1431">                continue;</span>
            }

<span class="nc bnc" id="L1434" title="All 2 branches missed.">            if (cs.getType() != CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L1435">                continue;</span>
            }

<span class="nc" id="L1438">            Mounted m = cs.getMount();</span>
<span class="nc" id="L1439">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L1440" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; ((MiscType) type).isShield()) {</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">                if (cs.isDamaged()) {</span>
<span class="nc" id="L1442">                    base--;</span>
                }
            }
        }

<span class="nc bnc" id="L1447" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_SHOULDER, location)) {</span>
<span class="nc" id="L1448">            base -= 2;</span>
        }

<span class="nc bnc" id="L1451" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_LOWER_ARM, location)) {</span>
<span class="nc" id="L1452">            base--;</span>
        }
<span class="nc bnc" id="L1454" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_UPPER_ARM, location)) {</span>
<span class="nc" id="L1455">            base--;</span>
        }
<span class="nc bnc" id="L1457" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_HAND, location)) {</span>
<span class="nc" id="L1458">            base--;</span>
        }

<span class="nc" id="L1461">        return Math.max(0, base);</span>
    }

    /**
     * Rules say every time a shield is critted it loses 5 points from its
     * Damage Capacity. basically count down from the top then subtract the
     * amount of damage its already take. The damage capacity is used to
     * determine if the shield is still viable.
     *
     * @param entity
     * @param location
     * @return damage capacity(no less then 0)
     */
    public int getCurrentDamageCapacity(Entity entity, int location) {
        // Shields can only be used in arms so if you've got a shield in a
        // location
        // other then an arm your SOL --Torren.
<span class="nc bnc" id="L1478" title="All 4 branches missed.">        if ((location != Mech.LOC_RARM) &amp;&amp; (location != Mech.LOC_LARM)) {</span>
<span class="nc" id="L1479">            return 0;</span>
        }

<span class="nc" id="L1482">        int base = baseDamageCapacity;</span>

<span class="nc bnc" id="L1484" title="All 2 branches missed.">        for (int slot = 0; slot &lt; entity.getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L1485">            CriticalSlot cs = entity.getCritical(location, slot);</span>

<span class="nc bnc" id="L1487" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L1488">                continue;</span>
            }

<span class="nc bnc" id="L1491" title="All 2 branches missed.">            if (cs.getType() != CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L1492">                continue;</span>
            }

<span class="nc" id="L1495">            Mounted m = cs.getMount();</span>
<span class="nc" id="L1496">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L1497" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; ((MiscType) type).isShield()) {</span>
<span class="nc bnc" id="L1498" title="All 2 branches missed.">                if (cs.isDamaged()) {</span>
<span class="nc" id="L1499">                    base -= 5;</span>
                }
            }
        }
<span class="nc bnc" id="L1503" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_SHOULDER, location)) {</span>
<span class="nc" id="L1504">            base -= 2;</span>
        }

<span class="nc bnc" id="L1507" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_LOWER_ARM, location)) {</span>
<span class="nc" id="L1508">            base--;</span>
        }
<span class="nc bnc" id="L1510" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_UPPER_ARM, location)) {</span>
<span class="nc" id="L1511">            base--;</span>
        }
<span class="nc bnc" id="L1513" title="All 2 branches missed.">        if (!entity.hasWorkingSystem(Mech.ACTUATOR_HAND, location)) {</span>
<span class="nc" id="L1514">            base--;</span>
        }

<span class="nc" id="L1517">        return Math.max(0, base - damageTaken);</span>
    }

    public int getDamageTaken() {
<span class="nc" id="L1521">        return damageTaken;</span>
    }

    public void addWeaponToBay(int w) {
<span class="fc" id="L1525">        bayWeapons.add(w);</span>
<span class="fc" id="L1526">    }</span>
    
    public Vector&lt;Integer&gt; getBayWeapons() {
<span class="fc" id="L1529">        return bayWeapons;</span>
    }

    public void addAmmoToBay(int a) {
<span class="nc" id="L1533">        bayAmmo.add(a);</span>
<span class="nc" id="L1534">    }</span>

    public Vector&lt;Integer&gt; getBayAmmo() {
<span class="nc" id="L1537">        return bayAmmo;</span>
    }

    public void setByShot(boolean b) {
<span class="nc" id="L1541">        byShot = b;</span>
<span class="nc" id="L1542">    }</span>

    public boolean byShot() {
<span class="nc" id="L1545">        return byShot;</span>
    }

    // bomb related
    public boolean isBombMounted() {
<span class="nc" id="L1550">        return bombMounted;</span>
    }

    public void setBombMounted(boolean b) {
<span class="nc" id="L1554">        bombMounted = b;</span>
<span class="nc" id="L1555">    }</span>

    /**
     * Convenience &quot;property&quot; to reduce typing, which returns true if the current
     * piece of equipment is a bomb capable of striking ground targets.
     * @return True if 
     */
    public boolean isGroundBomb() {
<span class="nc bnc" id="L1563" title="All 4 branches missed.">        return getType().hasFlag(WeaponType.F_DIVE_BOMB) || getType().hasFlag(WeaponType.F_ALT_BOMB) ||</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">                getType().hasFlag(AmmoType.F_GROUND_BOMB);</span>
    }
    
    // is ammo in the same bay as the weapon
    public boolean ammoInBay(int mAmmoId) {
<span class="nc bnc" id="L1569" title="All 2 branches missed.">        for (int nextAmmoId : bayAmmo) {</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">            if (nextAmmoId == mAmmoId) {</span>
<span class="nc" id="L1571">                return true;</span>
            }
<span class="nc" id="L1573">        }</span>
<span class="nc" id="L1574">        return false;</span>
    }

    /**
     * returns the heat for this weapon taking account of rapid-fire weapon
     * status
     */
    public int getCurrentHeat() {
<span class="nc bnc" id="L1582" title="All 2 branches missed.">        if (getType() instanceof WeaponType) {</span>
<span class="nc" id="L1583">            WeaponType wtype = (WeaponType) getType();</span>
<span class="nc" id="L1584">            int heat = wtype.getHeat();</span>

            // AR10's have heat based upon the loaded missile
<span class="nc bnc" id="L1587" title="All 2 branches missed.">            if (wtype.getName().equals(&quot;AR10&quot;)){</span>
<span class="nc" id="L1588">                AmmoType ammoType = (AmmoType)getLinked().getType();</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">                if (ammoType.hasFlag(AmmoType.F_AR10_BARRACUDA)){</span>
<span class="nc" id="L1590">                    return 10;</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">                }else if (ammoType.hasFlag(AmmoType.F_AR10_WHITE_SHARK)){</span>
<span class="nc" id="L1592">                    return 15;</span>
                } else { // AmmoType.F_AR10_KILLER_WHALTE
<span class="nc" id="L1594">                    return 20;</span>
                }
            }

<span class="nc bnc" id="L1598" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; wtype.hasModes()) {</span>
<span class="nc" id="L1599">                heat = Compute.dialDownHeat(this, wtype);</span>
            }
            // multiply by number of shots and number of weapons
<span class="nc" id="L1602">            heat = heat * getCurrentShots() * getNWeapons();</span>
<span class="nc bnc" id="L1603" title="All 2 branches missed.">            if (hasQuirk(OptionsConstants.QUIRK_WEAP_POS_IMP_COOLING)) {</span>
<span class="nc" id="L1604">                heat = Math.max(1, heat - 1);</span>
            }
<span class="nc bnc" id="L1606" title="All 2 branches missed.">            if (hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_POOR_COOLING)) {</span>
<span class="nc" id="L1607">                heat += 1;</span>
            }
<span class="nc bnc" id="L1609" title="All 2 branches missed.">            if (hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_NO_COOLING)) {</span>
<span class="nc" id="L1610">                heat += 2;</span>
            }
<span class="nc bnc" id="L1612" title="All 2 branches missed.">            if (hasChargedCapacitor() == 2) {</span>
<span class="nc" id="L1613">                heat += 10;</span>
            }
<span class="nc bnc" id="L1615" title="All 2 branches missed.">            if (hasChargedCapacitor() == 1) {</span>
<span class="nc" id="L1616">                heat += 5;</span>
            }
<span class="nc bnc" id="L1618" title="All 2 branches missed.">            if ((getLinkedBy() != null)</span>
<span class="nc bnc" id="L1619" title="All 2 branches missed.">                    &amp;&amp; !getLinkedBy().isInoperable()</span>
<span class="nc bnc" id="L1620" title="All 2 branches missed.">                    &amp;&amp; (getLinkedBy().getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1621" title="All 2 branches missed.">                    &amp;&amp; getLinkedBy().getType().hasFlag(</span>
                            MiscType.F_LASER_INSULATOR)) {
<span class="nc" id="L1623">                heat -= 1;</span>
<span class="nc bnc" id="L1624" title="All 2 branches missed.">                if (heat == 0) {</span>
<span class="nc" id="L1625">                    heat++;</span>
                }
            }

<span class="nc" id="L1629">            return heat;</span>
        }
<span class="nc" id="L1631">        return 0;</span>
    }

    public boolean isBodyMounted() {
<span class="nc bnc" id="L1635" title="All 4 branches missed.">        return (baMountLoc == BattleArmor.MOUNT_LOC_BODY)</span>
                || (baMountLoc == BattleArmor.MOUNT_LOC_TURRET);
    }

    public boolean isDWPMounted() {
<span class="fc" id="L1640">        return isDWPMounted;</span>
    }

    public void setDWPMounted(boolean dwpMounted) {
<span class="nc" id="L1644">        isDWPMounted = dwpMounted;</span>
<span class="nc" id="L1645">    }</span>

    public boolean isAPMMounted() {
<span class="nc" id="L1648">        return isAPMMounted;</span>
    }

    public void setAPMMounted(boolean apmMounted) {
<span class="nc" id="L1652">        isAPMMounted = apmMounted;</span>
<span class="nc" id="L1653">    }</span>
    
    public boolean isOmniPodMounted() {
<span class="fc" id="L1656">    	return omniPodMounted;</span>
    }
    
    public void setOmniPodMounted(boolean omniPodMounted) {
<span class="fc" id="L1660">    	this.omniPodMounted = omniPodMounted;</span>
<span class="fc" id="L1661">    }</span>

    public boolean isWeaponGroup() {
<span class="fc" id="L1664">        return weaponGroup;</span>
    }

    public void setWeaponGroup(boolean b) {
<span class="nc" id="L1668">        weaponGroup = b;</span>
<span class="nc" id="L1669">    }</span>

    public int getNWeapons() {
<span class="nc" id="L1672">        return nweapons;</span>
    }

    public void setNWeapons(int i) {
        // make sure this falls between 1 and 40
<span class="nc bnc" id="L1677" title="All 2 branches missed.">        if (i &lt; 0) {</span>
<span class="nc" id="L1678">            i = 1;</span>
        }
<span class="nc bnc" id="L1680" title="All 2 branches missed.">        if (i &gt; 40) {</span>
<span class="nc" id="L1681">            i = 40;</span>
        }
<span class="nc" id="L1683">        nweapons = i;</span>
<span class="nc" id="L1684">    }</span>

    public void unlink() {
<span class="nc" id="L1687">        linked = null;</span>
<span class="nc" id="L1688">    }</span>

    public void setArmored(boolean armored) {
        // Ammobins cannot be armored.
<span class="fc bfc" id="L1692" title="All 2 branches covered.">        if ((getType() instanceof AmmoType)</span>
<span class="pc bpc" id="L1693" title="1 of 2 branches missed.">                &amp;&amp; (((AmmoType) getType()).getAmmoType() != AmmoType.T_COOLANT_POD)) {</span>
<span class="fc" id="L1694">            armoredComponent = false;</span>
<span class="fc bfc" id="L1695" title="All 2 branches covered.">        } else if ((getType() instanceof MiscType)</span>
<span class="pc bpc" id="L1696" title="1 of 2 branches missed.">                &amp;&amp; (getType().hasFlag(MiscType.F_SPIKES)</span>
<span class="pc bpc" id="L1697" title="1 of 2 branches missed.">                        || getType().hasFlag(MiscType.F_REACTIVE)</span>
<span class="pc bpc" id="L1698" title="1 of 2 branches missed.">                        || getType().hasFlag(MiscType.F_MODULAR_ARMOR) || ((MiscType) getType())</span>
<span class="pc bpc" id="L1699" title="1 of 2 branches missed.">                            .isShield())) {</span>
<span class="nc" id="L1700">            armoredComponent = false;</span>
        } else {
<span class="fc" id="L1702">            armoredComponent = armored;</span>
        }
<span class="fc" id="L1704">    }</span>

    public boolean isArmored() {
<span class="fc" id="L1707">        return armoredComponent;</span>
    }

    public void setQuirks(WeaponQuirks quirks) {
<span class="nc" id="L1711">        this.quirks = quirks;</span>
<span class="nc" id="L1712">    }</span>

    /**
     * Retrieves the quirks object for mounted. DO NOT USE this to check boolean
     * options, as it will not check game options for quirks. Use
     * Mounted#hasQuirk instead
     *
     * @return
     */
    public WeaponQuirks getQuirks() {
<span class="nc" id="L1722">        return quirks;</span>
    }

    public boolean hasQuirk(String name) {
<span class="nc bnc" id="L1726" title="All 2 branches missed.">        if ((null == entity)</span>
<span class="nc bnc" id="L1727" title="All 2 branches missed.">                || (null == entity.getGame())</span>
<span class="nc" id="L1728">                || !entity.getGame().getOptions()</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">                        .booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L1730">            return false;</span>
        }
<span class="nc" id="L1732">        return quirks.booleanOption(name);</span>
    }

    /**
     * Count all the quirks for this &quot;mounted&quot; object, positive and negative
     */
    public int countQuirks() {
<span class="nc bnc" id="L1739" title="All 4 branches missed.">        if ((null == entity) || (null == entity.game)</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">                || !entity.game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L1741">            return 0;</span>
        }

<span class="nc" id="L1744">        return quirks.count();</span>
    }

    /**
     * Returns a string of all the quirk &quot;codes&quot; for this entity, using sep as
     * the separator
     */
    public String getQuirkList(String sep) {
<span class="nc bnc" id="L1752" title="All 4 branches missed.">        if ((null == entity) || (null == entity.game)</span>
<span class="nc bnc" id="L1753" title="All 2 branches missed.">                || !entity.game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L1754">            return &quot;&quot;;</span>
        }

<span class="nc" id="L1757">        return quirks.getOptionList(sep);</span>
    }

    public CalledShot getCalledShot() {
<span class="nc" id="L1761">        return called;</span>
    }

    public void setRepairable(boolean repair) {
<span class="nc" id="L1765">        repairable = repair;</span>
<span class="nc" id="L1766">    }</span>

    public boolean isRepairable() {
<span class="nc" id="L1769">        return repairable;</span>
    }

    public Entity getEntity() {
<span class="fc" id="L1773">        return entity;</span>
    }

    public boolean isMechTurretMounted() {
<span class="fc" id="L1777">        return mechTurretMounted;</span>
    }

    public void setMechTurretMounted(boolean turret) {
<span class="fc" id="L1781">        mechTurretMounted = turret;</span>
<span class="fc bfc" id="L1782" title="All 2 branches covered.">        if (mechTurretMounted) {</span>
<span class="fc" id="L1783">            setFacing(0);</span>
        }
<span class="fc" id="L1785">    }</span>

    public void setSponsonTurretMounted(boolean turret) {
<span class="fc" id="L1788">        sponsonTurretMounted = turret;</span>
<span class="fc" id="L1789">    }</span>

    public boolean isSponsonTurretMounted() {
<span class="nc" id="L1792">        return sponsonTurretMounted;</span>
    }

    public void setPintleTurretMounted(boolean turret) {
<span class="fc" id="L1796">        pintleTurretMounted = turret;</span>
<span class="fc" id="L1797">    }</span>

    public boolean isPintleTurretMounted() {
<span class="nc" id="L1800">        return pintleTurretMounted;</span>
    }

    public void setFacing(int facing) {
<span class="fc" id="L1804">        this.facing = facing;</span>
<span class="fc" id="L1805">    }</span>

    public int getFacing() {
<span class="fc" id="L1808">        return facing;</span>
    }

    public int getOriginalShots() {
<span class="nc" id="L1812">        return originalShots;</span>
    }

    public void setOriginalShots(int shots) {
<span class="fc" id="L1816">        originalShots = shots;</span>
<span class="fc" id="L1817">    }</span>

    public boolean isModeSwitchable() {
<span class="nc" id="L1820">        return modeSwitchable;</span>
    }

    public void setModeSwitchable(boolean b) {
<span class="nc" id="L1824">        modeSwitchable = b;</span>
<span class="nc" id="L1825">    }</span>
    
    /**
     * Method that checks to see if our capital missile bay is in bearings-only mode
     * Only available in space games
     * @return
     */
    public boolean isInBearingsOnlyMode() {
<span class="nc bnc" id="L1833" title="All 2 branches missed.">        if ((curMode().equals(Weapon.MODE_CAP_MISSILE_BEARING_EXT)</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_BEARING_LONG)</span>
<span class="nc bnc" id="L1835" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_BEARING_MED)</span>
<span class="nc bnc" id="L1836" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_BEARING_SHORT)</span>
<span class="nc bnc" id="L1837" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_EXT)</span>
<span class="nc bnc" id="L1838" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_LONG)</span>
<span class="nc bnc" id="L1839" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_MED)</span>
<span class="nc bnc" id="L1840" title="All 2 branches missed.">                    || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_SHORT))</span>
<span class="nc bnc" id="L1841" title="All 2 branches missed.">                &amp;&amp; getEntity().isSpaceborne()) {</span>
<span class="nc" id="L1842">            return true;</span>
        }
<span class="nc" id="L1844">        return false;</span>
    }
    
    /**
     * Method that checks to see if our capital missile bay is in waypoint launch mode
     * Only available in space games
     * @return
     */
    public boolean isInWaypointLaunchMode() {
<span class="nc bnc" id="L1853" title="All 2 branches missed.">        if ((curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_EXT)</span>
<span class="nc bnc" id="L1854" title="All 2 branches missed.">                || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_LONG)</span>
<span class="nc bnc" id="L1855" title="All 2 branches missed.">                || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_MED)</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">                || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_SHORT)</span>
<span class="nc bnc" id="L1857" title="All 2 branches missed.">                || curMode().equals(Weapon.MODE_CAP_MISSILE_WAYPOINT))</span>
<span class="nc bnc" id="L1858" title="All 2 branches missed.">            &amp;&amp; getEntity().isSpaceborne()) {</span>
<span class="nc" id="L1859">            return true;</span>
        }
<span class="nc" id="L1861">        return false;</span>
    }
    
    /**
     * Method that adds/removes available capital missile modes as we move between space and atmospheric maps
     * Called by Entity.setGameOptions(), which is in turn called during a mode change by server.
     */
    //Though we can't currently switch maps, this is needed to ensure space-only modes are removed on ground maps
    public void setModesForMapType() {
        //If the entity is not in space, remove these modes, which get set up based on game options in Weapon before game type is known
<span class="pc bpc" id="L1871" title="1 of 2 branches missed.">        if (!getEntity().isSpaceborne()) {</span>
<span class="fc" id="L1872">            getType().removeMode(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_EXT);</span>
<span class="fc" id="L1873">            getType().removeMode(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_LONG);</span>
<span class="fc" id="L1874">            getType().removeMode(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_MED);</span>
<span class="fc" id="L1875">            getType().removeMode(Weapon.MODE_CAP_MISSILE_WAYPOINT_BEARING_SHORT);</span>
<span class="fc" id="L1876">            getType().removeMode(Weapon.MODE_CAP_MISSILE_WAYPOINT);</span>
<span class="fc" id="L1877">            getType().removeMode(Weapon.MODE_CAP_MISSILE_TELE_OPERATED);</span>
<span class="fc" id="L1878">            getType().removeMode(Weapon.MODE_CAP_MISSILE_BEARING_EXT);</span>
<span class="fc" id="L1879">            getType().removeMode(Weapon.MODE_CAP_MISSILE_BEARING_LONG);</span>
<span class="fc" id="L1880">            getType().removeMode(Weapon.MODE_CAP_MISSILE_BEARING_MED);</span>
<span class="fc" id="L1881">            getType().removeMode(Weapon.MODE_CAP_MISSILE_BEARING_SHORT);</span>
        }
        /*
        //Placeholder. This will be used to add the space modes back when we're able to switch maps.
        if (getEntity().isSpaceborne()) {
            
        }
        */
<span class="fc" id="L1889">    }</span>
    
    public int getBaMountLoc() {
<span class="nc" id="L1892">        return baMountLoc;</span>
    }

    public void setBaMountLoc(int baMountLoc) {
<span class="fc" id="L1896">        this.baMountLoc = baMountLoc;</span>
<span class="fc" id="L1897">    }</span>

    /**
     * Returns true if this Mounted is a one-shot launcher of some kind
     * otherwise returns false.
     *
     * @return
     */
    public boolean isOneShotWeapon() {
<span class="nc bnc" id="L1906" title="All 4 branches missed.">        return (getType() instanceof WeaponType) &amp;&amp; getType().hasFlag(WeaponType.F_ONESHOT);</span>
    }
    
    /**
     * Checks whether this mount is either one a one-shot weapon or ammo for a one-shot weapon.
     * @return
     */
    public boolean isOneShot(){
<span class="nc bnc" id="L1914" title="All 2 branches missed.">        if (isOneShotWeapon()) {</span>
<span class="nc" id="L1915">            return true;</span>
<span class="nc bnc" id="L1916" title="All 4 branches missed.">        } else if ((getType() instanceof AmmoType) &amp;&amp; getLinkedBy() != null) {</span>
            // There should not be any circular references, but we should track where we've been just in case.
            // Do a couple checks first to avoid instantiating a set unnecessarily.
<span class="nc" id="L1919">            Set&lt;Mounted&gt; checked = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">            for (Mounted current = getLinkedBy(); current != null; current = current.getLinkedBy()) {</span>
<span class="nc bnc" id="L1921" title="All 2 branches missed.">                if (checked.contains(current)) {</span>
<span class="nc" id="L1922">                    return false;</span>
                }
<span class="nc bnc" id="L1924" title="All 2 branches missed.">                if (current.isOneShotWeapon()) {</span>
<span class="nc" id="L1925">                    return true;</span>
                }
<span class="nc" id="L1927">                checked.add(current);</span>
            }
        }
<span class="nc" id="L1930">        return false;</span>
    }
    
    /**
     * Check for whether this mount is linked by a one-shot weapon
     * 
     * @return {@code true} if this is one-shot ammo
     */
    public boolean isOneShotAmmo() {
<span class="nc bnc" id="L1939" title="All 2 branches missed.">        return (getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">                &amp;&amp; (getLinkedBy() != null)</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">                &amp;&amp; getLinkedBy().isOneShot();</span>
    }

    public boolean isSquadSupportWeapon() {
<span class="fc" id="L1945">        return squadSupportWeapon;</span>
    }

    public void setSquadSupportWeapon(boolean squadSupportWeapon) {
<span class="nc" id="L1949">        this.squadSupportWeapon = squadSupportWeapon;</span>
<span class="nc" id="L1950">    }</span>

    public int getArmorValue() {
<span class="nc" id="L1953">        return armorValue;</span>
    }

    public void setArmorValue(int armorValue) {
<span class="nc" id="L1957">        this.armorValue = armorValue;</span>
<span class="nc" id="L1958">    }</span>

    public void setMissingForTrooper(int trooper, boolean b) {
<span class="nc" id="L1961">        trooper = trooper-BattleArmor.LOC_TROOPER_1;</span>
<span class="nc bnc" id="L1962" title="All 4 branches missed.">        if((trooper &lt; 0) || (trooper &gt;= missingForTrooper.length)) {</span>
<span class="nc" id="L1963">            return;</span>
        }
<span class="nc" id="L1965">        missingForTrooper[trooper] = b;</span>
<span class="nc" id="L1966">    }</span>

    public boolean isMissingForTrooper(int trooper) {
<span class="nc" id="L1969">        trooper = trooper-BattleArmor.LOC_TROOPER_1;</span>
<span class="nc bnc" id="L1970" title="All 4 branches missed.">        if((trooper &lt; 0) || (trooper &gt;= missingForTrooper.length)) {</span>
<span class="nc" id="L1971">            return false;</span>
        }
<span class="nc" id="L1973">        return missingForTrooper[trooper];</span>
    }

    public boolean isAnyMissingTroopers() {
<span class="nc bnc" id="L1977" title="All 2 branches missed.">        for(int i = 0; i &lt; missingForTrooper.length; i++) {</span>
<span class="nc bnc" id="L1978" title="All 2 branches missed.">            if(missingForTrooper[i]) {</span>
<span class="nc" id="L1979">                return true;</span>
            }
        }
<span class="nc" id="L1982">        return false;</span>
    }

    public String getMissingTrooperString() {
<span class="nc" id="L1986">        StringBuffer missings = new StringBuffer();</span>
<span class="nc bnc" id="L1987" title="All 2 branches missed.">        for(int i = 0; i &lt; missingForTrooper.length; i++) {</span>
<span class="nc" id="L1988">            missings.append(missingForTrooper[i]).append(&quot;::&quot;);</span>
        }
<span class="nc" id="L1990">        return missings.toString();</span>
    }

    /**
     * Assign APDS systems to the most dangerous incoming missile attacks. This
     * should only be called once per turn, or AMS will get extra attacks
     */
    public WeaponAttackAction assignAPDS(List&lt;WeaponHandler&gt; vAttacks) {
        // Shouldn't have null entity, but if we do...
<span class="nc bnc" id="L1999" title="All 2 branches missed.">        if (getEntity() == null) {</span>
<span class="nc" id="L2000">            return null;</span>
        }

        // Ensure we only target attacks in our arc &amp; range
<span class="nc" id="L2004">        List&lt;WeaponAttackAction&gt; vAttacksInArc = new Vector&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L2005" title="All 2 branches missed.">        for (WeaponHandler wr : vAttacks) {</span>
<span class="nc" id="L2006">            boolean isInArc = Compute.isInArc(getEntity().getGame(),</span>
<span class="nc" id="L2007">                    getEntity().getId(), getEntity().getEquipmentNum(this),</span>
<span class="nc" id="L2008">                    getEntity().getGame().getEntity(wr.waa.getEntityId()));</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">            boolean isInRange = getEntity().getPosition().distance(</span>
<span class="nc" id="L2010">                    wr.getWaa().getTarget(getEntity().getGame()).getPosition()) &lt;= 3;</span>
<span class="nc bnc" id="L2011" title="All 4 branches missed.">            if (isInArc &amp;&amp; isInRange) {</span>
<span class="nc" id="L2012">                vAttacksInArc.add(wr.waa);</span>
            }
<span class="nc" id="L2014">        }</span>
        // find the most dangerous salvo by expected damage
<span class="nc" id="L2016">        WeaponAttackAction waa = Compute.getHighestExpectedDamage(getEntity()</span>
<span class="nc" id="L2017">                .getGame(), vAttacksInArc, true);</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">        if (waa != null) {</span>
<span class="nc" id="L2019">            waa.addCounterEquipment(this);</span>
<span class="nc" id="L2020">            return waa;</span>
        }
<span class="nc" id="L2022">        return null;</span>
    }

    /**
     * Returns true if this Mounted is an APDS.
     * @return
     */
    public boolean isAPDS() {
<span class="nc bnc" id="L2030" title="All 2 branches missed.">        if ((getEntity() instanceof BattleArmor)</span>
<span class="nc bnc" id="L2031" title="All 2 branches missed.">                &amp;&amp; getType().getInternalName().equals(&quot;ISBAAPDS&quot;)) {</span>
<span class="nc" id="L2032">            return true;</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">        } else if (getType() instanceof WeaponType) {</span>
<span class="nc bnc" id="L2034" title="All 2 branches missed.">            return ((WeaponType)getType()).getAmmoType() == AmmoType.T_APDS;</span>
        } else {
<span class="nc" id="L2036">            return false;</span>
        }
    }
    
    /**
     * Returns true if this Mounted is ammunition in homing mode.
     */
    public boolean isHomingAmmoInHomingMode() {
<span class="nc bnc" id="L2044" title="All 2 branches missed.">        if(!(getType() instanceof AmmoType)) {</span>
<span class="nc" id="L2045">            return false;</span>
        }
        
<span class="nc" id="L2048">        AmmoType ammoType = (AmmoType) getType();</span>
<span class="nc bnc" id="L2049" title="All 2 branches missed.">        return ammoType.getMunitionType() == AmmoType.M_HOMING &amp;&amp;</span>
<span class="nc bnc" id="L2050" title="All 2 branches missed.">                curMode().equals(&quot;Homing&quot;);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>