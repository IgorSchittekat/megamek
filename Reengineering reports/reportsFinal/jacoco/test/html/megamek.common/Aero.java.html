<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Aero.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Aero.java</span></div><h1>Aero.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000-2003 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */
package megamek.common;

import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;
import java.util.Vector;

import megamek.MegaMek;
import megamek.common.options.OptionsConstants;
import megamek.common.weapons.bayweapons.BayWeapon;
import megamek.common.weapons.ppc.PPCWeapon;

/**
 * Taharqa's attempt at creating an Aerospace entity
 */
public class Aero extends Entity implements IAero, IBomber {
    private static final long serialVersionUID = 7196307097459255187L;

    // locations
    public static final int LOC_NOSE = 0;
    public static final int LOC_LWING = 1;
    public static final int LOC_RWING = 2;
    public static final int LOC_AFT = 3;
    /** Location used for capital fighters and squadrons **/
    public static final int LOC_WINGS = 4;
    /** Location used for equipment not allocated to a firing arc **/
    public static final int LOC_FUSELAGE = 5;

    // ramming angles
    public static final int RAM_TOWARD_DIR = 0;
    public static final int RAM_TOWARD_OBL = 1;
    public static final int RAM_AWAY_OBL = 2;
    public static final int RAM_AWAY_DIR = 3;

    // heat type
    public static final int HEAT_SINGLE = 0;
    public static final int HEAT_DOUBLE = 1;

    // cockpit types
    public static final int COCKPIT_STANDARD = 0;
    public static final int COCKPIT_SMALL = 1;
    public static final int COCKPIT_COMMAND_CONSOLE = 2;
    public static final int COCKPIT_PRIMITIVE = 3;
<span class="fc" id="L65">    public static final String[] COCKPIT_STRING = { &quot;Standard Cockpit&quot;, &quot;Small Cockpit&quot;, &quot;Command Console&quot;,</span>
            &quot;Primitive Cockpit&quot; };
<span class="fc" id="L67">    public static final String[] COCKPIT_SHORT_STRING = { &quot;Standard&quot;, &quot;Small&quot;, &quot;Command Console&quot;, &quot;Primitive&quot; };</span>

    // critical hits
    public static final int CRIT_NONE = -1;
    public static final int CRIT_CREW = 0;
    public static final int CRIT_FCS = 1;
    public static final int CRIT_WEAPON = 2;
    public static final int CRIT_CONTROL = 3;
    public static final int CRIT_SENSOR = 4;
    public static final int CRIT_BOMB = 5;
    public static final int CRIT_ENGINE = 6;
    public static final int CRIT_FUEL_TANK = 7;
    public static final int CRIT_AVIONICS = 8;
    public static final int CRIT_GEAR = 9;
    public static final int CRIT_HEATSINK = 10;
    public static final int CRIT_CARGO = 11;
    public static final int CRIT_DOCK_COLLAR = 12;
    public static final int CRIT_DOOR = 13;
    public static final int CRIT_KF_BOOM = 14;
    public static final int CRIT_LIFE_SUPPORT = 15;
    public static final int CRIT_LEFT_THRUSTER = 16;
    public static final int CRIT_RIGHT_THRUSTER = 17;
    public static final int CRIT_CIC = 18;
    public static final int CRIT_KF_DRIVE = 19;
    public static final int CRIT_GRAV_DECK = 20;
    public static final int CRIT_WEAPON_BROAD = 21;

    // aeros have no critical slot limitations
    // this needs to be larger, it is too easy to go over when you get to
    // warships
    // and bombs and such
<span class="fc" id="L98">    private static final int[] NUM_OF_SLOTS = { 100, 100, 100, 100, 100, 100, 100 };</span>

<span class="fc" id="L100">    private static String[] LOCATION_ABBRS = { &quot;NOS&quot;, &quot;LWG&quot;, &quot;RWG&quot;, &quot;AFT&quot;, &quot;WNG&quot;, &quot;FSLG&quot; };</span>
<span class="fc" id="L101">    private static String[] LOCATION_NAMES = { &quot;Nose&quot;, &quot;Left Wing&quot;, &quot;Right Wing&quot;, &quot;Aft&quot;, &quot;Wings&quot;, &quot;Fuselage&quot; };</span>

    @Override
    public String[] getLocationAbbrs() {
<span class="nc" id="L105">        return LOCATION_ABBRS;</span>
    }

    @Override
    public String[] getLocationNames() {
<span class="nc" id="L110">        return LOCATION_NAMES;</span>
    }

<span class="fc" id="L113">    private int sensorHits = 0;</span>
<span class="fc" id="L114">    private int fcsHits = 0;</span>
<span class="fc" id="L115">    private int engineHits = 0;</span>
<span class="fc" id="L116">    private int avionicsHits = 0;</span>
<span class="fc" id="L117">    private int cicHits = 0;</span>
<span class="fc" id="L118">    private boolean fuelTankHit = false;</span>
<span class="fc" id="L119">    private boolean gearHit = false;</span>
    private int structIntegrity;
    private int orig_structIntegrity;
    // set up damage threshold
<span class="fc" id="L123">    protected int[] damThresh = { 0, 0, 0, 0, 0, 0 };</span>
    // set up an int for what the critical effect would be
<span class="fc" id="L125">    private int potCrit = CRIT_NONE;</span>

    // ignored crew hit for harjel
<span class="fc" id="L128">    private int ignoredCrewHits = 0;</span>
<span class="fc" id="L129">    private int cockpitType = COCKPIT_STANDARD;</span>
    
    //Autoejection
<span class="fc" id="L132">    private boolean autoEject = true;</span>
<span class="fc" id="L133">    private boolean condEjectAmmo = true;</span>
<span class="fc" id="L134">    private boolean condEjectFuel = true;</span>
<span class="fc" id="L135">    private boolean condEjectSIDest = true;</span>
    
<span class="fc" id="L137">    private boolean ejecting = false;</span>

    // track straight movement from last turn
<span class="fc" id="L140">    private int straightMoves = 0;</span>

    // are we tracking any altitude loss due to air-to-ground assaults
<span class="fc" id="L143">    private int altLoss = 0;</span>

    /**
     * Track how much altitude has been lost this turn. This is important for
     * properly making weapon attacks, so WeaponAttackActions knows what the
     * altitude was before the attack happened, since the altitude lose is
     * applied before the attack resolves.
     */
<span class="fc" id="L151">    private int altLossThisRound = 0;</span>

<span class="fc" id="L153">    private boolean spheroid = false;</span>

    // deal with heat
    private int heatSinksOriginal;
    private int heatSinks;
<span class="fc" id="L158">    private int heatType = HEAT_SINGLE;</span>

    // Track how many heat sinks are pod-mounted for omnifighters; these are
    // included in the total
    // This is provided for campaign use; MM does not distribute damage between
    // fixed and pod-mounted.
    private int podHeatSinks;

<span class="fc" id="L166">    protected int maxBombPoints = 0;</span>
<span class="fc" id="L167">    protected int[] bombChoices = new int[BombType.B_NUM];</span>

    // fuel - number of fuel points
<span class="fc" id="L170">    private int fuel = 0;</span>
<span class="fc" id="L171">    private int currentfuel = 0;</span>

    // these are used by more advanced aeros
<span class="fc" id="L174">    private boolean lifeSupport = true;</span>
<span class="fc" id="L175">    private int leftThrustHits = 0;</span>
<span class="fc" id="L176">    private int rightThrustHits = 0;</span>

    // out of control
<span class="fc" id="L179">    private boolean outControl = false;</span>
<span class="fc" id="L180">    private boolean outCtrlHeat = false;</span>
<span class="fc" id="L181">    private boolean randomMove = false;</span>

    // set up movement
<span class="fc" id="L184">    private int currentVelocity = 0;</span>
<span class="fc" id="L185">    private int nextVelocity = currentVelocity;</span>
<span class="fc" id="L186">    private boolean accLast = false;</span>
<span class="fc" id="L187">    private boolean rolled = false;</span>
<span class="fc" id="L188">    private boolean failedManeuver = false;</span>
<span class="fc" id="L189">    private boolean accDecNow = false;</span>

    // was the damage threshold exceeded this turn
<span class="fc" id="L192">    boolean critThresh = false;</span>

    // vstol status
<span class="fc" id="L195">    boolean vstol = false;</span>

    // Capital Fighter stuff
<span class="fc" id="L198">    private int capitalArmor = 0;</span>
<span class="fc" id="L199">    private int capitalArmor_orig = 0;</span>
<span class="fc" id="L200">    private int fatalThresh = 2;</span>
<span class="fc" id="L201">    private int currentDamage = 0;</span>
<span class="fc" id="L202">    private boolean wingsHit = false;</span>
    // a hash map of the current weapon groups - the key is the
    // location:internal name, and the value is the weapon id
<span class="fc" id="L205">    Map&lt;String, Integer&gt; weaponGroups = new HashMap&lt;&gt;();</span>

    /*
     * According to the rules if two units of the same type and with the same
     * velocity are in the same hex, you roll 2d6 randomly to see who is
     * considered back one step for purposes of targeting. THis is a bitch to
     * do, so instead we assign a large random variable to each aero unit at the
     * start of the round and we use that. It works out similarly except that
     * you don't roll separately for each pair of possibilities. That should
     * work well enough for our purposes.
     */
<span class="fc" id="L216">    private int whoFirst = 0;</span>

<span class="fc" id="L218">    private int eccmRoll = 0;</span>
    
    //List of escape craft used by this ship
<span class="fc" id="L221">    private Set&lt;String&gt; escapeCraftList = new HashSet&lt;&gt;();</span>
    
    //Maps unique id of each assigned marine to marine point value
    private Map&lt;UUID,Integer&gt; marines;

    public Aero() {
<span class="fc" id="L227">        super();</span>
        // need to set altitude to something different than entity
<span class="fc" id="L229">        altitude = 5;</span>
<span class="fc" id="L230">    }</span>

    @Override
    public int getUnitType() {
<span class="nc" id="L234">        return UnitType.AERO;</span>
    }

<span class="fc" id="L237">    protected static final TechAdvancement TA_ASF = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="fc" id="L238">            .setAdvancement(DATE_NONE, 2470, 2490).setProductionFactions(F_TH)</span>
<span class="fc" id="L239">            .setTechRating(RATING_D).setAvailability(RATING_C, RATING_E, RATING_D, RATING_C)</span>
<span class="fc" id="L240">            .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
<span class="fc" id="L241">    protected static final TechAdvancement TA_ASF_PRIMITIVE = new TechAdvancement(TECH_BASE_IS)</span>
<span class="fc" id="L242">            .setISAdvancement(DATE_ES, 2200, DATE_NONE, 2520)</span>
<span class="fc" id="L243">            .setISApproximate(false, true, false).setProductionFactions(F_TA)</span>
<span class="fc" id="L244">            .setTechRating(RATING_D).setAvailability(RATING_D, RATING_X, RATING_F, RATING_F)</span>
<span class="fc" id="L245">            .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>

    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (isPrimitive()) {</span>
<span class="nc" id="L250">            return TA_ASF_PRIMITIVE;</span>
        } else {
<span class="fc" id="L252">            return TA_ASF;</span>
        }
    }

<span class="fc" id="L256">    protected static final TechAdvancement[] COCKPIT_TA = {</span>
<span class="fc" id="L257">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(2460, 2470, 2491)</span>
<span class="fc" id="L258">                .setApproximate(true, false, false).setPrototypeFactions(F_TH)</span>
<span class="fc" id="L259">                .setPrototypeFactions(F_TH).setTechRating(RATING_C)</span>
<span class="fc" id="L260">                .setAvailability(RATING_C, RATING_C, RATING_C, RATING_C)</span>
<span class="fc" id="L261">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Standard</span>
<span class="fc" id="L262">            new TechAdvancement(TECH_BASE_IS).setISAdvancement(3065, 3070, 3080)</span>
<span class="fc" id="L263">                .setClanAdvancement(DATE_NONE, DATE_NONE, 3080)</span>
<span class="fc" id="L264">                .setISApproximate(true, false, false).setPrototypeFactions(F_WB)</span>
<span class="fc" id="L265">                .setPrototypeFactions(F_WB, F_CSR).setTechRating(RATING_E)</span>
<span class="fc" id="L266">                .setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="fc" id="L267">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Small</span>
<span class="fc" id="L268">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(2625, 2631, DATE_NONE, 2850, 3030)</span>
<span class="fc" id="L269">                .setISApproximate(true, false, false, true, true)</span>
<span class="fc" id="L270">                .setClanAdvancement(2625, 2631).setClanApproximate(true, false)</span>
<span class="fc" id="L271">                .setClanApproximate(true, false).setPrototypeFactions(F_TH)</span>
<span class="fc" id="L272">                .setPrototypeFactions(F_TH).setReintroductionFactions(F_FS).setTechRating(RATING_D)</span>
<span class="fc" id="L273">                .setAvailability(RATING_C, RATING_F, RATING_E, RATING_D)</span>
<span class="fc" id="L274">                .setStaticTechLevel(SimpleTechLevel.ADVANCED), //Cockpit command console</span>
<span class="fc" id="L275">            new TechAdvancement(TECH_BASE_ALL).setAdvancement(DATE_ES, 2300, DATE_NONE, 2520)</span>
<span class="fc" id="L276">                .setISApproximate(false, true, false, false)</span>
<span class="fc" id="L277">                .setPrototypeFactions(F_TA).setTechRating(RATING_C)</span>
<span class="fc" id="L278">                .setAvailability(RATING_D, RATING_X, RATING_X, RATING_F)</span>
<span class="fc" id="L279">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //Primitive</span>
    };

    public static TechAdvancement getCockpitTechAdvancement(int cockpitType) {
<span class="pc bpc" id="L283" title="2 of 4 branches missed.">        if (cockpitType &gt;= 0 &amp;&amp; cockpitType &lt; COCKPIT_TA.length) {</span>
<span class="fc" id="L284">            return new TechAdvancement(COCKPIT_TA[cockpitType]);</span>
        }
<span class="nc" id="L286">        return null;</span>
    }

    public TechAdvancement getCockpitTechAdvancement() {
<span class="fc" id="L290">        return getCockpitTechAdvancement(getCockpitType());</span>
    }

    @Override
    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<span class="fc" id="L295">        super.addSystemTechAdvancement(ctl);</span>
<span class="pc bpc" id="L296" title="1 of 4 branches missed.">        if (isFighter() &amp;&amp; (getCockpitTechAdvancement() != null)) {</span>
<span class="fc" id="L297">            ctl.addComponent(getCockpitTechAdvancement());</span>
        }
<span class="fc" id="L299">    }</span>

    // Is it Civilian or Military
    public static final int CIVILIAN = 0;
    public static final int MILITARY = 1;
<span class="fc" id="L304">    protected int designType = MILITARY;</span>

    /**
     * Sets the unit as either a civilian or military design
     */
    public void setDesignType(int design) {
<span class="nc" id="L310">        designType = design;</span>
<span class="nc" id="L311">    }</span>

    /**
     * Returns the unit's design type
     */
    public int getDesignType() {
<span class="nc" id="L317">        return designType;</span>
    }

    /**
     * A method to determine if an aero has suffered 3 sensor hits.
     * When double-blind is on, this affects both standard visibility and sensor rolls
     */
    public boolean isAeroSensorDestroyed() {
<span class="nc bnc" id="L325" title="All 2 branches missed.">        return getSensorHits() &gt;= 3;</span>
    }

    /**
     * Returns this entity's safe thrust, factored for heat, extreme
     * temperatures, gravity, partial repairs and bomb load.
     */
    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
<span class="fc" id="L334">        int j = getOriginalWalkMP();</span>
        // adjust for engine hits
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (engineHits &gt;= getMaxEngineHits()) {</span>
<span class="nc" id="L337">            return 0;</span>
        }
<span class="fc" id="L339">        int engineLoss = 2;</span>
<span class="pc bpc" id="L340" title="2 of 4 branches missed.">        if ((this instanceof SmallCraft) || (this instanceof Jumpship)) {</span>
<span class="nc" id="L341">            engineLoss = 1;</span>
        }
<span class="fc" id="L343">        j = Math.max(0, j - (engineHits * engineLoss));</span>
<span class="fc" id="L344">        j = Math.max(0, j - getCargoMpReduction(this));</span>
<span class="pc bpc" id="L345" title="2 of 4 branches missed.">        if ((null != game) &amp;&amp; gravity) {</span>
<span class="fc" id="L346">            int weatherMod = game.getPlanetaryConditions().getMovementMods(this);</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L348">                j = Math.max(j + weatherMod, 0);</span>
            }
        }
        // get bomb load
<span class="fc" id="L352">        j = Math.max(0, j - (int) Math.ceil(getBombPoints() / 5.0));</span>

<span class="pc bpc" id="L354" title="1 of 2 branches missed.">        if (hasModularArmor()) {</span>
<span class="nc" id="L355">            j--;</span>
        }
        // partially repaired engine
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;aero_engine_crit&quot;)) {</span>
<span class="nc" id="L359">        	j--;</span>
        }

        // if they are not airborne, then they get MP halved (aerodyne) or no MP
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">        if (!isAirborne()) {</span>
<span class="nc" id="L364">            j = j / 2;</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (isSpheroid()) {</span>
<span class="nc" id="L366">                j = 0;</span>
            }
        }

<span class="fc" id="L370">        return j;</span>
    }

    /**
     * This is the same as getWalkMP, but does not divide by 2 when grounded
     *
     * @return
     */
    @Override
    public int getCurrentThrust() {
<span class="nc" id="L380">        int j = getOriginalWalkMP();</span>
<span class="nc" id="L381">        j = Math.max(0, j - getCargoMpReduction(this));</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L383">            int weatherMod = game.getPlanetaryConditions().getMovementMods(this);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L385">                j = Math.max(j + weatherMod, 0);</span>
            }
        }
        // get bomb load
<span class="nc" id="L389">        j = Math.max(0, j - (int) Math.ceil(getBombPoints() / 5.0));</span>

<span class="nc bnc" id="L391" title="All 2 branches missed.">        if (hasModularArmor()) {</span>
<span class="nc" id="L392">            j--;</span>
        }
<span class="nc" id="L394">        return j;</span>
    }

    /**
     * Returns the number of locations in the entity
     */
    @Override
    public int locations() {
<span class="fc" id="L402">        return 6;</span>
    }

    @Override
    public int getBodyLocation() {
<span class="nc" id="L407">        return LOC_FUSELAGE;</span>
    }

    @Override
    public boolean canChangeSecondaryFacing() {
<span class="nc" id="L412">        return false;</span>
    }

    @Override
    public boolean isValidSecondaryFacing(int n) {
<span class="nc" id="L417">        return false;</span>
    }

    /**
     * Aeros really can't torso twist?
     */
    @Override
    public int clipSecondaryFacing(int n) {
<span class="nc" id="L425">        return getFacing();</span>
    }

    @Override
    public boolean isOutControlTotal() {
        // due to control roll, heat, shut down, or crew unconscious
<span class="nc bnc" id="L431" title="All 6 branches missed.">        return (outControl || shutDown || getCrew().isUnconscious());</span>
    }

    @Override
    public boolean isOutControl() {
<span class="nc" id="L436">        return outControl;</span>
    }

    @Override
    public boolean isOutCtrlHeat() {
<span class="nc" id="L441">        return outCtrlHeat;</span>
    }

    @Override
    public boolean isRandomMove() {
<span class="nc" id="L446">        return randomMove;</span>
    }

    @Override
    public boolean didAccLast() {
<span class="nc" id="L451">        return accLast;</span>
    }

    @Override
    public boolean hasLifeSupport() {
<span class="nc" id="L456">        return lifeSupport;</span>
    }

    public void setLifeSupport(boolean b) {
<span class="nc" id="L460">        lifeSupport = b;</span>
<span class="nc" id="L461">    }</span>

    @Override
    public boolean isRolled() {
<span class="nc" id="L465">        return rolled;</span>
    }

    @Override
    public void setOutControl(boolean ocontrol) {
<span class="nc" id="L470">        outControl = ocontrol;</span>
<span class="nc" id="L471">    }</span>

    @Override
    public void setOutCtrlHeat(boolean octrlheat) {
<span class="nc" id="L475">        outCtrlHeat = octrlheat;</span>
<span class="nc" id="L476">    }</span>

    @Override
    public void setRandomMove(boolean randmove) {
<span class="nc" id="L480">        randomMove = randmove;</span>
<span class="nc" id="L481">    }</span>

    @Override
    public void setRolled(boolean roll) {
<span class="nc" id="L485">        rolled = roll;</span>
<span class="nc" id="L486">    }</span>

    @Override
    public void setAccLast(boolean b) {
<span class="nc" id="L490">        accLast = b;</span>
<span class="nc" id="L491">    }</span>

    @Override
    public int getMaxBombPoints() {
<span class="nc" id="L495">        return maxBombPoints;</span>
    }

    public void autoSetMaxBombPoints() {
<span class="nc" id="L499">        maxBombPoints = (int) Math.round(getWeight() / 5);</span>
<span class="nc" id="L500">    }</span>

    @Override
    public int[] getBombChoices() {
<span class="nc" id="L504">        return bombChoices.clone();</span>
    }

    @Override
    public void setBombChoices(int[] bc) {
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (bc.length == bombChoices.length) {</span>
<span class="nc" id="L510">            bombChoices = bc;</span>
        }
<span class="nc" id="L512">    }</span>

    @Override
    public void clearBombChoices() {
<span class="nc" id="L516">        Arrays.fill(bombChoices, 0);</span>
<span class="nc" id="L517">    }</span>

    public void setWhoFirst() {
<span class="nc" id="L520">        whoFirst = Compute.randomInt(500);</span>
<span class="nc" id="L521">    }</span>

    public int getWhoFirst() {
<span class="nc" id="L524">        return whoFirst;</span>
    }

    @Override
    public int getCurrentVelocity() {
        // if using advanced movement then I just want to sum up
        // the different vectors
<span class="pc bpc" id="L531" title="2 of 4 branches missed.">        if ((game != null) &amp;&amp; game.useVectorMove()) {</span>
<span class="nc" id="L532">            return getVelocity();</span>
        }
<span class="fc" id="L534">        return currentVelocity;</span>
    }

    @Override
    public void setCurrentVelocity(int velocity) {
<span class="nc" id="L539">        currentVelocity = velocity;</span>
<span class="nc" id="L540">    }</span>

    @Override
    public int getNextVelocity() {
<span class="fc" id="L544">        return nextVelocity;</span>
    }

    @Override
    public void setNextVelocity(int velocity) {
<span class="nc" id="L549">        nextVelocity = velocity;</span>
<span class="nc" id="L550">    }</span>

    // need some way of retrieving true current velocity
    // even when using advanced movement
    @Override
    public int getCurrentVelocityActual() {
<span class="nc" id="L556">        return currentVelocity;</span>
    }

    public int getPotCrit() {
<span class="nc" id="L560">        return potCrit;</span>
    }

    public void setPotCrit(int crit) {
<span class="nc" id="L564">        potCrit = crit;</span>
<span class="nc" id="L565">    }</span>

    @Override
    public int getSI() {
<span class="nc" id="L569">        return structIntegrity;</span>
    }

    @Override
    public int get0SI() {
<span class="fc" id="L574">        return orig_structIntegrity;</span>
    }

    /**
     * Used to determine modifier for landing; different for Aero and LAM.
     */
    @Override
    public int getNoseArmor() {
<span class="nc" id="L582">        return getArmor(LOC_NOSE);</span>
    }

    @Override
    public int getCapArmor() {
<span class="nc" id="L587">        return capitalArmor;</span>
    }

    @Override
    public void setCapArmor(int i) {
<span class="nc" id="L592">        capitalArmor = i;</span>
<span class="nc" id="L593">    }</span>

    @Override
    public int getCap0Armor() {
<span class="nc" id="L597">        return capitalArmor_orig;</span>
    }

    @Override
    public int getFatalThresh() {
<span class="nc" id="L602">        return fatalThresh;</span>
    }

    @Override
    public int getCurrentDamage() {
<span class="nc" id="L607">        return currentDamage;</span>
    }

    @Override
    public void setCurrentDamage(int i) {
<span class="nc" id="L612">        currentDamage = i;</span>
<span class="nc" id="L613">    }</span>

    public void set0SI(int si) {
<span class="fc" id="L616">        orig_structIntegrity = si;</span>
<span class="fc" id="L617">        structIntegrity = si;</span>
<span class="fc" id="L618">    }</span>

    public void autoSetSI() {
<span class="nc" id="L621">        int siweight = (int) Math.floor(weight / 10.0);</span>
<span class="nc" id="L622">        int sithrust = getOriginalWalkMP();</span>
<span class="nc" id="L623">        initializeSI(Math.max(siweight, sithrust));</span>
<span class="nc" id="L624">    }</span>

    @Override
    public void autoSetCapArmor() {
<span class="nc" id="L628">        double divisor = 10.0;</span>
<span class="nc bnc" id="L629" title="All 4 branches missed.">        if ((null != game) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L630">            divisor = 1.0;</span>
        }
<span class="nc" id="L632">        capitalArmor_orig = (int) Math.round(getTotalOArmor() / divisor);</span>
<span class="nc" id="L633">        capitalArmor = (int) Math.round(getTotalArmor() / divisor);</span>
<span class="nc" id="L634">    }</span>

    @Override
    public void autoSetFatalThresh() {
<span class="nc" id="L638">        int baseThresh = 2;</span>
<span class="nc bnc" id="L639" title="All 4 branches missed.">        if ((null != game) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L640">            baseThresh = 20;</span>
        }
<span class="nc" id="L642">        fatalThresh = Math.max(baseThresh, (int) Math.ceil(capitalArmor / 4.0));</span>
<span class="nc" id="L643">    }</span>

    public void initializeSI(int val) {
<span class="nc" id="L646">        orig_structIntegrity = val;</span>
<span class="nc" id="L647">        setSI(val);</span>
<span class="nc" id="L648">    }</span>

    @Override
    public void setSI(int si) {
<span class="nc" id="L652">        structIntegrity = si;</span>
<span class="nc" id="L653">    }</span>

    @Override
    public int getSensorHits() {
<span class="nc" id="L657">        return sensorHits;</span>
    }

    public void setSensorHits(int hits) {
<span class="nc bnc" id="L661" title="All 2 branches missed.">        if (hits &gt; 3) {</span>
<span class="nc" id="L662">            hits = 3;</span>
        }
<span class="nc" id="L664">        sensorHits = hits;</span>
<span class="nc" id="L665">    }</span>

    @Override
    public int getFCSHits() {
<span class="nc" id="L669">        return fcsHits;</span>
    }

    public void setFCSHits(int hits) {
<span class="nc bnc" id="L673" title="All 2 branches missed.">        if (hits &gt; 3) {</span>
<span class="nc" id="L674">            hits = 3;</span>
        }
<span class="nc" id="L676">        fcsHits = hits;</span>
<span class="nc" id="L677">    }</span>
    
    public boolean fuelTankHit() {
<span class="nc" id="L680">        return fuelTankHit;</span>
    }
    
    public void setFuelTankHit(boolean value) {
<span class="nc" id="L684">        fuelTankHit = value;</span>
<span class="nc" id="L685">    }</span>

    public void setCICHits(int hits) {
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (hits &gt; 3) {</span>
<span class="nc" id="L689">            hits = 3;</span>
        }
<span class="nc" id="L691">        cicHits = hits;</span>
<span class="nc" id="L692">    }</span>

    public int getCICHits() {
<span class="nc" id="L695">        return cicHits;</span>
    }

    public void setIgnoredCrewHits(int hits) {
<span class="nc" id="L699">        ignoredCrewHits = hits;</span>
<span class="nc" id="L700">    }</span>

    public int getIgnoredCrewHits() {
<span class="nc" id="L703">        return ignoredCrewHits;</span>
    }

    @Override
    public int getEngineHits() {
<span class="nc" id="L708">        return engineHits;</span>
    }

    public void setEngineHits(int hits) {
<span class="nc" id="L712">        engineHits = hits;</span>
<span class="nc" id="L713">    }</span>

    @Override
    public int getAvionicsHits() {
<span class="nc" id="L717">        return avionicsHits;</span>
    }

    public void setAvionicsHits(int hits) {
<span class="nc" id="L721">        avionicsHits = hits;</span>
<span class="nc" id="L722">    }</span>

    public boolean isGearHit() {
<span class="nc" id="L725">        return gearHit;</span>
    }

    @Override
    public void setGearHit(boolean hit) {
<span class="nc" id="L730">        gearHit = hit;</span>
<span class="nc" id="L731">    }</span>

    /**
     * Modifier to landing or vertical takeoff roll for landing gear damage.
     *
     * @param vTakeoff
     *            true if this is for a vertical takeoff, false if for a landing
     * @return the control roll modifier
     */
    @Override
    public int getLandingGearMod(boolean vTakeoff) {
<span class="nc bnc" id="L742" title="All 2 branches missed.">        if (gearHit) {</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">            return vTakeoff ? 1 : 5;</span>
        } else {
<span class="nc" id="L745">        	return 0;</span>
        }
    }

    //Landing mods for partial repairs
    public int getLandingGearPartialRepairs() {
<span class="nc bnc" id="L751" title="All 2 branches missed.">    	if (getPartialRepairs().booleanOption(&quot;aero_gear_crit&quot;)) {</span>
<span class="nc" id="L752">        return 2;</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">    	} else if (getPartialRepairs().booleanOption(&quot;aero_gear_replace&quot;)) {</span>
<span class="nc" id="L754">        return 1;</span>
    	} else {
<span class="nc" id="L756">    	return 0;</span>
    	}
    }

    //Avionics mods for partial repairs
    public int getAvionicsMisreplaced() {
<span class="nc bnc" id="L762" title="All 2 branches missed.">    	if (getPartialRepairs().booleanOption(&quot;aero_avionics_replace&quot;)) {</span>
<span class="nc" id="L763">        return 1;</span>
    	} else {
<span class="nc" id="L765">    	return 0;</span>
    	}
    }

    public int getAvionicsMisrepaired() {
<span class="nc bnc" id="L770" title="All 2 branches missed.">    	if (getPartialRepairs().booleanOption(&quot;aero_avionics_crit&quot;)) {</span>
<span class="nc" id="L771">        return 1;</span>
    	} else {
<span class="nc" id="L773">    	return 0;</span>
    	}
    }

    public void setOHeatSinks(int hs) {
<span class="nc" id="L778">        heatSinksOriginal = hs;</span>
<span class="nc" id="L779">    }</span>

    public int getOHeatSinks() {
<span class="nc" id="L782">        return heatSinksOriginal;</span>
    }

    public void setHeatSinks(int hs) {
<span class="nc" id="L786">        heatSinks = hs;</span>
<span class="nc" id="L787">    }</span>

    @Override
    public int getHeatSinks() {
<span class="nc" id="L791">        return heatSinks;</span>
    }

    public int getHeatSinkHits() {
<span class="nc" id="L795">        return heatSinksOriginal - heatSinks;</span>
    }

    public void setHeatType(int hstype) {
<span class="nc" id="L799">        heatType = hstype;</span>
<span class="nc" id="L800">    }</span>

    public int getPodHeatSinks() {
<span class="nc" id="L803">        return podHeatSinks;</span>
    }

    public void setPodHeatSinks(int hs) {
<span class="nc" id="L807">        podHeatSinks = hs;</span>
<span class="nc" id="L808">    }</span>

    @Override
    public boolean tracksHeat() {
<span class="nc" id="L812">        return true;</span>
    }

    public void setLeftThrustHits(int hits) {
<span class="nc" id="L816">        leftThrustHits = hits;</span>
<span class="nc" id="L817">    }</span>

    @Override
    public int getLeftThrustHits() {
<span class="nc" id="L821">        return leftThrustHits;</span>
    }

    public void setRightThrustHits(int hits) {
<span class="nc" id="L825">        rightThrustHits = hits;</span>
<span class="nc" id="L826">    }</span>

    @Override
    public int getRightThrustHits() {
<span class="nc" id="L830">        return rightThrustHits;</span>
    }

    public int getOriginalFuel() {
<span class="nc" id="L834">        return fuel;</span>
    }

    public int getFuel() {
<span class="nc bnc" id="L838" title="All 2 branches missed.">        if ((getPartialRepairs().booleanOption(&quot;aero_asf_fueltank_crit&quot;))</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">        		|| (getPartialRepairs().booleanOption(&quot;aero_fueltank_crit&quot;))) {</span>
<span class="nc" id="L840">        	return (int) (fuel * 0.9);</span>
        } else {
<span class="nc" id="L842">        	return fuel;</span>
        }
    }

    public int getCurrentFuel() {
<span class="nc bnc" id="L847" title="All 2 branches missed.">        if ((getPartialRepairs().booleanOption(&quot;aero_asf_fueltank_crit&quot;))</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">            	|| (getPartialRepairs().booleanOption(&quot;aero_fueltank_crit&quot;))) {</span>
<span class="nc" id="L849">            return (int) (currentfuel * 0.9);</span>
        } else {
<span class="nc" id="L851">        	return currentfuel;</span>
        }
    }

    /**
     * Sets the number of fuel points.
     *
     * @param gas
     *            Number of fuel points.
     */
    public void setFuel(int gas) {
<span class="nc" id="L862">        fuel = gas;</span>
<span class="nc" id="L863">        currentfuel = gas;</span>
<span class="nc" id="L864">    }</span>

    public void setCurrentFuel(int gas) {
<span class="nc" id="L867">    	currentfuel = gas;</span>
<span class="nc" id="L868">    }</span>

    public double getFuelPointsPerTon() {
<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (isPrimitive()) {</span>
<span class="nc" id="L872">            return 80 / primitiveFuelFactor();</span>
        }
<span class="nc" id="L874">        return 80;</span>
    }

    /**
     * Set number of fuel points based on fuel tonnage.
     *
     * @param fuelTons
     *            The number of tons of fuel
     */
    @Override
    public void setFuelTonnage(double fuelTons) {
<span class="nc" id="L885">        double pointsPerTon = getFuelPointsPerTon();</span>
<span class="nc" id="L886">        fuel = (int) Math.floor(pointsPerTon * fuelTons + 0.001);</span>
<span class="nc" id="L887">    }</span>

    /**
     * Gets the fuel for this Aero in terms of tonnage.
     *
     * @return The number of tons of fuel on this Aero.
     */
    @Override
    public double getFuelTonnage() {
        // Rounding required for primitive small craft/dropship fuel multipliers.
        // The reason this is rounded normally instead of up is that the fuel points are actually calculated
        // from the tonnage and rounded down.
<span class="nc" id="L899">        return Math.round(2.0 * fuel / getFuelPointsPerTon()) / 2.0;</span>
    }

    /**
     * Used by SmallCraft and Jumpship and their child classes.
     *
     * @return The tons of fuel burned in a day at 1G using strategic movement.
     */
    public double getStrategicFuelUse() {
<span class="nc" id="L908">        return 0.0;</span>
    }

    /**
     * Some primitve aerospace units have their fuel efficiency reduced by a factor based
     * on construction year.
     *
     * @return The primitive fuel factor for the build year.
     */
    public double primitiveFuelFactor() {
<span class="nc" id="L918">        return 1.0;</span>
    }

    public int getHeatType() {
<span class="nc" id="L922">        return heatType;</span>
    }

    @Override
    public boolean wasCritThresh() {
<span class="nc" id="L927">        return critThresh;</span>
    }

    @Override
    public void setCritThresh(boolean b) {
<span class="nc" id="L932">        critThresh = b;</span>
<span class="nc" id="L933">    }</span>

    @Override
    public boolean isImmobile() {
        // aeros are never immobile when in the air or space
<span class="pc bpc" id="L938" title="3 of 4 branches missed.">        if (isAirborne() || isSpaceborne()) {</span>
<span class="fc" id="L939">            return false;</span>
        }
<span class="nc" id="L941">        return super.isImmobile();</span>
    }

    @Override
    public void newRound(int roundNumber) {
<span class="nc" id="L946">        super.newRound(roundNumber);</span>

        // reset threshold critted
<span class="nc" id="L949">        setCritThresh(false);</span>

        // reset maneuver status
<span class="nc" id="L952">        setFailedManeuver(false);</span>
        // reset acc/dec this turn
<span class="nc" id="L954">        setAccDecNow(false);</span>

<span class="nc" id="L956">        updateBays();</span>

        // update recovery turn if in recovery
<span class="nc bnc" id="L959" title="All 2 branches missed.">        if (getRecoveryTurn() &gt; 0) {</span>
<span class="nc" id="L960">            setRecoveryTurn(getRecoveryTurn() - 1);</span>
        }

        // if in atmosphere, then halve next turn's velocity
<span class="nc bnc" id="L964" title="All 6 branches missed.">        if (!game.getBoard().inSpace() &amp;&amp; isDeployed() &amp;&amp; (roundNumber &gt; 0)) {</span>
<span class="nc" id="L965">            setNextVelocity((int) Math.floor(getNextVelocity() / 2.0));</span>
        }

        // update velocity
<span class="nc" id="L969">        setCurrentVelocity(getNextVelocity());</span>

        // if using variable damage thresholds then autoset them
<span class="nc bnc" id="L972" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_VARIABLE_DAMAGE_THRESH)) {</span>
<span class="nc" id="L973">            autoSetThresh();</span>
<span class="nc" id="L974">            autoSetFatalThresh();</span>
        }

        // if they are out of control due to heat, then apply this and reset
<span class="nc bnc" id="L978" title="All 2 branches missed.">        if (isOutCtrlHeat()) {</span>
<span class="nc" id="L979">            setOutControl(true);</span>
<span class="nc" id="L980">            setOutCtrlHeat(false);</span>
        }

        // reset eccm bonus
<span class="nc" id="L984">        setECCMRoll(Compute.d6(2));</span>

        // get new random whofirst
<span class="nc" id="L987">        setWhoFirst();</span>

<span class="nc" id="L989">        resetAltLossThisRound();</span>
<span class="nc" id="L990">    }</span>

    /**
     * Returns the name of the type of movement used. This is tank-specific.
     */
    @Override
    public String getMovementString(EntityMovementType mtype) {
<span class="nc bnc" id="L997" title="All 7 branches missed.">        switch (mtype) {</span>
        case MOVE_SKID:
<span class="nc" id="L999">            return &quot;Skidded&quot;;</span>
        case MOVE_NONE:
<span class="nc" id="L1001">            return &quot;None&quot;;</span>
        case MOVE_WALK:
<span class="nc" id="L1003">            return &quot;Cruised&quot;;</span>
        case MOVE_RUN:
<span class="nc" id="L1005">            return &quot;Flanked&quot;;</span>
        case MOVE_SAFE_THRUST:
<span class="nc" id="L1007">            return &quot;Safe Thrust&quot;;</span>
        case MOVE_OVER_THRUST:
<span class="nc" id="L1009">            return &quot;Over Thrust&quot;;</span>
        default:
<span class="nc" id="L1011">            return &quot;Unknown!&quot;;</span>
        }
    }

    /**
     * Returns the name of the type of movement used. This is tank-specific.
     */
    @Override
    public String getMovementAbbr(EntityMovementType mtype) {
<span class="nc bnc" id="L1020" title="All 4 branches missed.">        switch (mtype) {</span>
        case MOVE_NONE:
<span class="nc" id="L1022">            return &quot;N&quot;;</span>
        case MOVE_SAFE_THRUST:
<span class="nc" id="L1024">            return &quot;S&quot;;</span>
        case MOVE_OVER_THRUST:
<span class="nc" id="L1026">            return &quot;O&quot;;</span>
        default:
<span class="nc" id="L1028">            return &quot;?&quot;;</span>
        }
    }

    @Override
    public boolean hasRearArmor(int loc) {
<span class="fc" id="L1034">        return false;</span>
    }

    /**
     * Returns the Compute.ARC that the weapon fires into.
     */
    // need to figure out aft-pointed wing weapons
    // need to figure out new arcs
    @Override
    public int getWeaponArc(int wn) {
<span class="nc" id="L1044">        final Mounted mounted = getEquipment(wn);</span>
<span class="nc bnc" id="L1045" title="All 4 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_SPACE_BOMB) || mounted.getType().hasFlag(WeaponType.F_DIVE_BOMB)</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">                || mounted.getType().hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L1047">            return Compute.ARC_360;</span>
        }
        int arc;
<span class="nc bnc" id="L1050" title="All 5 branches missed.">        switch (mounted.getLocation()) {</span>
            case LOC_NOSE:
            case LOC_WINGS:
<span class="nc" id="L1053">                arc = Compute.ARC_NOSE;</span>
<span class="nc" id="L1054">                break;</span>
            case LOC_RWING:
<span class="nc bnc" id="L1056" title="All 2 branches missed.">                if (mounted.isRearMounted()) {</span>
<span class="nc" id="L1057">                    arc = Compute.ARC_RWINGA;</span>
                } else {
<span class="nc" id="L1059">                    arc = Compute.ARC_RWING;</span>
                }
<span class="nc" id="L1061">                break;</span>
            case LOC_LWING:
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                if (mounted.isRearMounted()) {</span>
<span class="nc" id="L1064">                    arc = Compute.ARC_LWINGA;</span>
                } else {
<span class="nc" id="L1066">                    arc = Compute.ARC_LWING;</span>
                }
<span class="nc" id="L1068">                break;</span>
            case LOC_AFT:
<span class="nc" id="L1070">                arc = Compute.ARC_AFT;</span>
<span class="nc" id="L1071">                break;</span>
            default:
<span class="nc" id="L1073">                arc = Compute.ARC_360;</span>
        }

<span class="nc" id="L1076">        return rollArcs(arc);</span>
    }

    /**
     * Returns true if this weapon fires into the secondary facing arc. If
     * false, assume it fires into the primary.
     */
    @Override
    public boolean isSecondaryArcWeapon(int weaponId) {
        // just leave true for now in case we implement rolls or
        // newtonian movement this way
<span class="nc" id="L1087">        return true;</span>
    }

    /**
     * Rolls up a hit location
     */
    @Override
    public HitData rollHitLocation(int table, int side, int aimedLocation, int aimingMode, int cover) {
<span class="nc" id="L1095">        return rollHitLocation(table, side);</span>
    }

    @Override
    public HitData rollHitLocation(int table, int side) {

        /*
         * Unlike other units, ASFs determine potential crits based on the
         * to-hit roll so I need to set this potential value as well as return
         * the to hit data
         */

<span class="nc" id="L1107">        int roll = Compute.d6(2);</span>

        // first check for above/below
<span class="nc bnc" id="L1110" title="All 4 branches missed.">        if ((table == ToHitData.HIT_ABOVE) || (table == ToHitData.HIT_BELOW)) {</span>

            // have to decide which wing
<span class="nc" id="L1113">            int wingloc = LOC_RWING;</span>
<span class="nc" id="L1114">            int wingroll = Compute.d6(1);</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">            if (wingroll &gt; 3) {</span>
<span class="nc" id="L1116">                wingloc = LOC_LWING;</span>
            }
<span class="nc bnc" id="L1118" title="All 12 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1120">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1121">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 3:
<span class="nc" id="L1123">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1124">                return new HitData(wingloc, false, HitData.EFFECT_NONE);</span>
            case 4:
<span class="nc" id="L1126">                setPotCrit(CRIT_SENSOR);</span>
<span class="nc" id="L1127">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 5:
<span class="nc" id="L1129">                setPotCrit(CRIT_CREW);</span>
<span class="nc" id="L1130">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 6:
<span class="nc" id="L1132">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1133">                return new HitData(wingloc, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1135">                setPotCrit(CRIT_AVIONICS);</span>
<span class="nc" id="L1136">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 8:
<span class="nc" id="L1138">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1139">                return new HitData(wingloc, false, HitData.EFFECT_NONE);</span>
            case 9:
<span class="nc" id="L1141">                setPotCrit(CRIT_CONTROL);</span>
<span class="nc" id="L1142">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 10:
<span class="nc" id="L1144">                setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1145">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 11:
<span class="nc" id="L1147">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1148">                return new HitData(wingloc, false, HitData.EFFECT_NONE);</span>
            case 12:
<span class="nc" id="L1150">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1151">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            }
        }

<span class="nc bnc" id="L1155" title="All 2 branches missed.">        if (side == ToHitData.SIDE_FRONT) {</span>
            // normal front hits
<span class="nc bnc" id="L1157" title="All 12 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1159">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1160">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 3:
<span class="nc" id="L1162">                setPotCrit(CRIT_SENSOR);</span>
<span class="nc" id="L1163">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 4:
<span class="nc" id="L1165">                setPotCrit(CRIT_HEATSINK);</span>
<span class="nc" id="L1166">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 5:
<span class="nc" id="L1168">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1169">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 6:
<span class="nc" id="L1171">                setPotCrit(CRIT_AVIONICS);</span>
<span class="nc" id="L1172">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1174">                setPotCrit(CRIT_CONTROL);</span>
<span class="nc" id="L1175">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 8:
<span class="nc" id="L1177">                setPotCrit(CRIT_FCS);</span>
<span class="nc" id="L1178">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 9:
<span class="nc" id="L1180">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1181">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 10:
<span class="nc" id="L1183">                setPotCrit(CRIT_HEATSINK);</span>
<span class="nc" id="L1184">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 11:
<span class="nc" id="L1186">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1187">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 12:
<span class="nc" id="L1189">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1190">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            }
<span class="nc bnc" id="L1192" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_LEFT) {</span>
            // normal left-side hits
<span class="nc bnc" id="L1194" title="All 12 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1196">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1197">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 3:
<span class="nc" id="L1199">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1200">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 4:
<span class="nc" id="L1202">                setPotCrit(CRIT_SENSOR);</span>
<span class="nc" id="L1203">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 5:
<span class="nc" id="L1205">                setPotCrit(CRIT_CREW);</span>
<span class="nc" id="L1206">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 6:
<span class="nc" id="L1208">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1209">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1211">                setPotCrit(CRIT_AVIONICS);</span>
<span class="nc" id="L1212">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 8:
<span class="nc" id="L1214">                setPotCrit(CRIT_BOMB);</span>
<span class="nc" id="L1215">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 9:
<span class="nc" id="L1217">                setPotCrit(CRIT_CONTROL);</span>
<span class="nc" id="L1218">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 10:
<span class="nc" id="L1220">                setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1221">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 11:
<span class="nc" id="L1223">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1224">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 12:
<span class="nc" id="L1226">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1227">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            }
<span class="nc bnc" id="L1229" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_RIGHT) {</span>
            // normal right-side hits
<span class="nc bnc" id="L1231" title="All 12 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1233">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1234">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 3:
<span class="nc" id="L1236">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1237">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 4:
<span class="nc" id="L1239">                setPotCrit(CRIT_SENSOR);</span>
<span class="nc" id="L1240">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 5:
<span class="nc" id="L1242">                setPotCrit(CRIT_CREW);</span>
<span class="nc" id="L1243">                return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
            case 6:
<span class="nc" id="L1245">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1246">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1248">                setPotCrit(CRIT_AVIONICS);</span>
<span class="nc" id="L1249">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 8:
<span class="nc" id="L1251">                setPotCrit(CRIT_BOMB);</span>
<span class="nc" id="L1252">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 9:
<span class="nc" id="L1254">                setPotCrit(CRIT_CONTROL);</span>
<span class="nc" id="L1255">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 10:
<span class="nc" id="L1257">                setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1258">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 11:
<span class="nc" id="L1260">                setPotCrit(CRIT_GEAR);</span>
<span class="nc" id="L1261">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 12:
<span class="nc" id="L1263">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1264">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            }
<span class="nc bnc" id="L1266" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_REAR) {</span>
            // normal aft hits
<span class="nc bnc" id="L1268" title="All 12 branches missed.">            switch (roll) {</span>
            case 2:
<span class="nc" id="L1270">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1271">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 3:
<span class="nc" id="L1273">                setPotCrit(CRIT_HEATSINK);</span>
<span class="nc" id="L1274">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 4:
<span class="nc" id="L1276">                setPotCrit(CRIT_FUEL_TANK);</span>
<span class="nc" id="L1277">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 5:
<span class="nc" id="L1279">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1280">                return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</span>
            case 6:
<span class="nc" id="L1282">                setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1283">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 7:
<span class="nc" id="L1285">                setPotCrit(CRIT_CONTROL);</span>
<span class="nc" id="L1286">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 8:
<span class="nc" id="L1288">                setPotCrit(CRIT_ENGINE);</span>
<span class="nc" id="L1289">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 9:
<span class="nc" id="L1291">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1292">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 10:
<span class="nc" id="L1294">                setPotCrit(CRIT_FUEL_TANK);</span>
<span class="nc" id="L1295">                return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</span>
            case 11:
<span class="nc" id="L1297">                setPotCrit(CRIT_HEATSINK);</span>
<span class="nc" id="L1298">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            case 12:
<span class="nc" id="L1300">                setPotCrit(CRIT_WEAPON);</span>
<span class="nc" id="L1301">                return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</span>
            }
        }
<span class="nc" id="L1304">        return new HitData(LOC_NOSE, false, HitData.EFFECT_NONE);</span>
    }

    /**
     * Gets the location that excess damage transfers to
     */
    @Override
    public HitData getTransferLocation(HitData hit) {
<span class="nc" id="L1312">        return new HitData(LOC_DESTROYED);</span>
    }

    /**
     * Gets the location that is destroyed recursively
     */
    @Override
    public int getDependentLocation(int loc) {
<span class="nc" id="L1320">        return LOC_NONE;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#calculateBattleValue()
     */
    @Override
    public int calculateBattleValue() {
<span class="nc bnc" id="L1330" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L1331">            return manualBV;</span>
        }

<span class="nc" id="L1334">        return calculateBattleValue(false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#calculateBattleValue(boolean, boolean)
     */
    @Override
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L1344" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L1345">            return manualBV;</span>
        }

<span class="nc" id="L1348">        bvText = new StringBuffer(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Battle Value Calculations For &quot;);</span>

<span class="nc" id="L1350">        bvText.append(getChassis());</span>
<span class="nc" id="L1351">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L1352">        bvText.append(getModel());</span>
<span class="nc" id="L1353">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L1354">        bvText.append(nl);</span>

<span class="nc" id="L1356">        bvText.append(&quot;&lt;b&gt;Defensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1357">        bvText.append(nl);</span>

<span class="nc" id="L1359">        double dbv = 0; // defensive battle value</span>
<span class="nc" id="L1360">        double obv = 0; // offensive bv</span>

<span class="nc" id="L1362">        double armorMultiplier = 1.0;</span>

<span class="nc" id="L1364">        boolean blueShield = hasWorkingMisc(MiscType.F_BLUE_SHIELD);</span>

        // Ignore any hull/fuselage or capital fighter wing locations
<span class="nc bnc" id="L1367" title="All 4 branches missed.">        for (int loc = 0; loc &lt; locations() - ((this instanceof SmallCraft) ? 1 : 2); loc++) {</span>
<span class="nc" id="L1368">            int modularArmor = 0;</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">            for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L1370" title="All 4 branches missed.">                if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_MODULAR_ARMOR)</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">                        &amp;&amp; (mounted.getLocation() == loc)) {</span>
<span class="nc" id="L1372">                    modularArmor += mounted.getBaseDamageCapacity() - mounted.getDamageTaken();</span>
                }
<span class="nc" id="L1374">            }</span>
            // total armor points

<span class="nc bnc" id="L1377" title="All 5 branches missed.">            switch (getArmorType(loc)) {</span>
                case EquipmentType.T_ARMOR_COMMERCIAL:
<span class="nc" id="L1379">                    armorMultiplier = 0.5;</span>
<span class="nc" id="L1380">                    break;</span>
                case EquipmentType.T_ARMOR_HARDENED:
<span class="nc" id="L1382">                    armorMultiplier = 2.0;</span>
<span class="nc" id="L1383">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L1387">                    armorMultiplier = 1.5;</span>
<span class="nc" id="L1388">                    break;</span>
                case EquipmentType.T_ARMOR_LC_LAMELLOR_FERRO_CARBIDE:
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
<span class="nc" id="L1392">                    armorMultiplier = 1.2;</span>
<span class="nc" id="L1393">                    break;</span>
                default:
<span class="nc" id="L1395">                    armorMultiplier = 1.0;</span>
                    break;
            }
<span class="nc bnc" id="L1398" title="All 2 branches missed.">            if (hasBARArmor(loc)) {</span>
<span class="nc" id="L1399">                armorMultiplier *= getBARRating(loc) / 10.0;</span>
            }

<span class="nc bnc" id="L1402" title="All 2 branches missed.">            if (blueShield) {</span>
<span class="nc" id="L1403">                armorMultiplier += 0.2;</span>
            }
<span class="nc" id="L1405">            bvText.append(startRow);</span>
<span class="nc" id="L1406">            bvText.append(startColumn);</span>

<span class="nc" id="L1408">            int armor = getArmor(loc) + modularArmor;</span>
<span class="nc" id="L1409">            bvText.append(&quot;Total Armor &quot; + this.getLocationAbbr(loc) + &quot; (&quot; + armor + &quot;) x &quot;);</span>
<span class="nc" id="L1410">            bvText.append(armorMultiplier);</span>
<span class="nc" id="L1411">            bvText.append(endColumn);</span>
<span class="nc" id="L1412">            bvText.append(startColumn);</span>
<span class="nc" id="L1413">            bvText.append(endColumn);</span>
<span class="nc" id="L1414">            bvText.append(startColumn);</span>
<span class="nc" id="L1415">            double armorBV = (getArmor(loc) + modularArmor) * armorMultiplier;</span>
<span class="nc" id="L1416">            bvText.append(armorBV);</span>
<span class="nc" id="L1417">            dbv += armorBV;</span>
<span class="nc" id="L1418">            bvText.append(endColumn);</span>
        }
<span class="nc" id="L1420">        bvText.append(startRow);</span>
<span class="nc" id="L1421">        bvText.append(startColumn);</span>
<span class="nc" id="L1422">        bvText.append(&quot;Total modified armor BV x 2.5 &quot;);</span>
<span class="nc" id="L1423">        bvText.append(endColumn);</span>
<span class="nc" id="L1424">        bvText.append(startColumn);</span>
<span class="nc" id="L1425">        bvText.append(endColumn);</span>
<span class="nc" id="L1426">        bvText.append(startColumn);</span>
<span class="nc" id="L1427">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1428">        dbv *= 2.5;</span>
<span class="nc" id="L1429">        bvText.append(dbv);</span>
<span class="nc" id="L1430">        bvText.append(endColumn);</span>
<span class="nc" id="L1431">        bvText.append(endRow);</span>

<span class="nc" id="L1433">        bvText.append(startRow);</span>
<span class="nc" id="L1434">        bvText.append(startColumn);</span>

<span class="nc" id="L1436">        bvText.append(&quot;Total SI x 2 x SI modifier&quot;);</span>
<span class="nc" id="L1437">        bvText.append(endColumn);</span>
<span class="nc" id="L1438">        bvText.append(startColumn);</span>

<span class="nc bnc" id="L1440" title="All 2 branches missed.">        double dbvSI = getSI() * 2.0 * (blueShield ? 1.2 : 1);</span>
<span class="nc" id="L1441">        dbv += dbvSI;</span>

<span class="nc" id="L1443">        bvText.append(getSI());</span>
<span class="nc" id="L1444">        bvText.append(&quot; x 2 x &quot;);</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">        bvText.append(blueShield ? 1.2 : 1);</span>
<span class="nc" id="L1446">        bvText.append(endColumn);</span>
<span class="nc" id="L1447">        bvText.append(startColumn);</span>
<span class="nc" id="L1448">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1449">        bvText.append(dbvSI);</span>
<span class="nc" id="L1450">        bvText.append(endColumn);</span>
<span class="nc" id="L1451">        bvText.append(endRow);</span>

        // add defensive equipment
<span class="nc" id="L1454">        double amsBV = 0;</span>
<span class="nc" id="L1455">        double amsAmmoBV = 0;</span>
<span class="nc" id="L1456">        double screenBV = 0;</span>
<span class="nc" id="L1457">        double screenAmmoBV = 0;</span>
<span class="nc" id="L1458">        double defEqBV = 0;</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L1460">            EquipmentType etype = mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1463" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1464">                continue;</span>
            }
            // don't count weapon groups
<span class="nc bnc" id="L1467" title="All 2 branches missed.">            if (mounted.isWeaponGroup()) {</span>
<span class="nc" id="L1468">                continue;</span>
            }
<span class="nc bnc" id="L1470" title="All 4 branches missed.">            if (((etype instanceof WeaponType) &amp;&amp; (etype.hasFlag(WeaponType.F_AMS)))) {</span>
<span class="nc" id="L1471">                amsBV += etype.getBV(this);</span>
<span class="nc" id="L1472">                bvText.append(startRow);</span>
<span class="nc" id="L1473">                bvText.append(startColumn);</span>
<span class="nc" id="L1474">                bvText.append(etype.getName());</span>
<span class="nc" id="L1475">                bvText.append(endColumn);</span>
<span class="nc" id="L1476">                bvText.append(startColumn);</span>
<span class="nc" id="L1477">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1478">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1479">                bvText.append(endColumn);</span>
<span class="nc" id="L1480">                bvText.append(startColumn);</span>
<span class="nc" id="L1481">                bvText.append(endColumn);</span>
<span class="nc" id="L1482">                bvText.append(endRow);</span>
<span class="nc bnc" id="L1483" title="All 4 branches missed.">            } else if ((etype instanceof AmmoType) &amp;&amp; (((AmmoType) etype).getAmmoType() == AmmoType.T_AMS)) {</span>
<span class="nc" id="L1484">                amsAmmoBV += etype.getBV(this);</span>
<span class="nc" id="L1485">                bvText.append(startRow);</span>
<span class="nc" id="L1486">                bvText.append(startColumn);</span>
<span class="nc" id="L1487">                bvText.append(etype.getName());</span>
<span class="nc" id="L1488">                bvText.append(endColumn);</span>
<span class="nc" id="L1489">                bvText.append(startColumn);</span>
<span class="nc" id="L1490">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1491">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1492">                bvText.append(endColumn);</span>
<span class="nc" id="L1493">                bvText.append(startColumn);</span>
<span class="nc" id="L1494">                bvText.append(endColumn);</span>
<span class="nc" id="L1495">                bvText.append(endRow);</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">            } else if ((etype instanceof AmmoType)</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">                    &amp;&amp; (((AmmoType) etype).getAmmoType() == AmmoType.T_SCREEN_LAUNCHER)) {</span>
<span class="nc" id="L1498">                screenAmmoBV += etype.getBV(this);</span>
<span class="nc" id="L1499">                bvText.append(startRow);</span>
<span class="nc" id="L1500">                bvText.append(startColumn);</span>
<span class="nc" id="L1501">                bvText.append(etype.getName());</span>
<span class="nc" id="L1502">                bvText.append(endColumn);</span>
<span class="nc" id="L1503">                bvText.append(startColumn);</span>
<span class="nc" id="L1504">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1505">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1506">                bvText.append(endColumn);</span>
<span class="nc" id="L1507">                bvText.append(startColumn);</span>
<span class="nc" id="L1508">                bvText.append(endColumn);</span>
<span class="nc" id="L1509">                bvText.append(endRow);</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">            } else if ((etype instanceof WeaponType)</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">                    &amp;&amp; (((WeaponType) etype).getAtClass() == WeaponType.CLASS_SCREEN)) {</span>
<span class="nc" id="L1512">                screenBV += etype.getBV(this);</span>
<span class="nc" id="L1513">                bvText.append(startRow);</span>
<span class="nc" id="L1514">                bvText.append(startColumn);</span>
<span class="nc" id="L1515">                bvText.append(etype.getName());</span>
<span class="nc" id="L1516">                bvText.append(endColumn);</span>
<span class="nc" id="L1517">                bvText.append(startColumn);</span>
<span class="nc" id="L1518">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1519">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1520">                bvText.append(endColumn);</span>
<span class="nc" id="L1521">                bvText.append(startColumn);</span>
<span class="nc" id="L1522">                bvText.append(endColumn);</span>
<span class="nc" id="L1523">                bvText.append(endRow);</span>
<span class="nc bnc" id="L1524" title="All 6 branches missed.">            } else if ((etype instanceof MiscType) &amp;&amp; (etype.hasFlag(MiscType.F_ECM) || etype.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_CHAFF_POD))) {</span>
<span class="nc" id="L1526">                defEqBV += etype.getBV(this);</span>
<span class="nc" id="L1527">                bvText.append(startRow);</span>
<span class="nc" id="L1528">                bvText.append(startColumn);</span>
<span class="nc" id="L1529">                bvText.append(mounted.getName());</span>
<span class="nc" id="L1530">                bvText.append(endColumn);</span>
<span class="nc" id="L1531">                bvText.append(startColumn);</span>
<span class="nc" id="L1532">                bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1533">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1534">                bvText.append(endColumn);</span>
<span class="nc" id="L1535">                bvText.append(startColumn);</span>
<span class="nc" id="L1536">                bvText.append(endColumn);</span>
<span class="nc" id="L1537">                bvText.append(endRow);</span>
            }
<span class="nc" id="L1539">        }</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">        if (amsBV &gt; 0) {</span>
<span class="nc" id="L1541">            bvText.append(startRow);</span>
<span class="nc" id="L1542">            bvText.append(startColumn);</span>
<span class="nc" id="L1543">            bvText.append(&quot;Total AMS BV:&quot;);</span>
<span class="nc" id="L1544">            bvText.append(endColumn);</span>
<span class="nc" id="L1545">            bvText.append(startColumn);</span>
<span class="nc" id="L1546">            bvText.append(endColumn);</span>
<span class="nc" id="L1547">            bvText.append(startColumn);</span>
<span class="nc" id="L1548">            bvText.append(amsBV);</span>
<span class="nc" id="L1549">            dbv += amsBV;</span>
<span class="nc" id="L1550">            bvText.append(endColumn);</span>
<span class="nc" id="L1551">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L1553" title="All 2 branches missed.">        if (screenBV &gt; 0) {</span>
<span class="nc" id="L1554">            bvText.append(startRow);</span>
<span class="nc" id="L1555">            bvText.append(startColumn);</span>
<span class="nc" id="L1556">            bvText.append(&quot;Total Screen BV:&quot;);</span>
<span class="nc" id="L1557">            bvText.append(endColumn);</span>
<span class="nc" id="L1558">            bvText.append(startColumn);</span>
<span class="nc" id="L1559">            bvText.append(endColumn);</span>
<span class="nc" id="L1560">            bvText.append(startColumn);</span>
<span class="nc" id="L1561">            bvText.append(screenBV);</span>
<span class="nc" id="L1562">            dbv += screenBV;</span>
<span class="nc" id="L1563">            bvText.append(endColumn);</span>
<span class="nc" id="L1564">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L1566" title="All 2 branches missed.">        if (amsAmmoBV &gt; 0) {</span>
<span class="nc" id="L1567">            bvText.append(startRow);</span>
<span class="nc" id="L1568">            bvText.append(startColumn);</span>
<span class="nc" id="L1569">            bvText.append(&quot;Total AMS Ammo BV (to a maximum of AMS BV):&quot;);</span>
<span class="nc" id="L1570">            bvText.append(endColumn);</span>
<span class="nc" id="L1571">            bvText.append(startColumn);</span>
<span class="nc" id="L1572">            bvText.append(endColumn);</span>
<span class="nc" id="L1573">            bvText.append(startColumn);</span>
<span class="nc" id="L1574">            bvText.append(Math.min(amsBV, amsAmmoBV));</span>
<span class="nc" id="L1575">            dbv += Math.min(amsBV, amsAmmoBV);</span>
<span class="nc" id="L1576">            bvText.append(endColumn);</span>
<span class="nc" id="L1577">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L1579" title="All 2 branches missed.">        if (screenAmmoBV &gt; 0) {</span>
<span class="nc" id="L1580">            bvText.append(startRow);</span>
<span class="nc" id="L1581">            bvText.append(startColumn);</span>
<span class="nc" id="L1582">            bvText.append(&quot;Total Screen Ammo BV (to a maximum of Screen BV):&quot;);</span>
<span class="nc" id="L1583">            bvText.append(endColumn);</span>
<span class="nc" id="L1584">            bvText.append(startColumn);</span>
<span class="nc" id="L1585">            bvText.append(endColumn);</span>
<span class="nc" id="L1586">            bvText.append(startColumn);</span>
<span class="nc" id="L1587">            bvText.append(Math.min(screenBV, screenAmmoBV));</span>
<span class="nc" id="L1588">            dbv += Math.min(screenBV, screenAmmoBV);</span>
<span class="nc" id="L1589">            bvText.append(endColumn);</span>
<span class="nc" id="L1590">            bvText.append(endRow);</span>
        }
<span class="nc bnc" id="L1592" title="All 2 branches missed.">        if (defEqBV &gt; 0) {</span>
<span class="nc" id="L1593">            bvText.append(startRow);</span>
<span class="nc" id="L1594">            bvText.append(startColumn);</span>
<span class="nc" id="L1595">            bvText.append(&quot;Total misc defensive equipment BV:&quot;);</span>
<span class="nc" id="L1596">            bvText.append(endColumn);</span>
<span class="nc" id="L1597">            bvText.append(startColumn);</span>
<span class="nc" id="L1598">            bvText.append(endColumn);</span>
<span class="nc" id="L1599">            bvText.append(startColumn);</span>
<span class="nc" id="L1600">            bvText.append(defEqBV);</span>
<span class="nc" id="L1601">            dbv += defEqBV;</span>
<span class="nc" id="L1602">            bvText.append(endColumn);</span>
<span class="nc" id="L1603">            bvText.append(endRow);</span>
        }

<span class="nc" id="L1606">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L1607">        bvText.append(endColumn);</span>
<span class="nc" id="L1608">        bvText.append(endRow);</span>

<span class="nc" id="L1610">        bvText.append(startRow);</span>
<span class="nc" id="L1611">        bvText.append(startColumn);</span>

<span class="nc" id="L1613">        bvText.append(endColumn);</span>
<span class="nc" id="L1614">        bvText.append(startColumn);</span>
<span class="nc" id="L1615">        bvText.append(endColumn);</span>
<span class="nc" id="L1616">        bvText.append(startColumn);</span>
<span class="nc" id="L1617">        bvText.append(dbv);</span>
<span class="nc" id="L1618">        bvText.append(endColumn);</span>
<span class="nc" id="L1619">        bvText.append(endRow);</span>

        // subtract for explosive ammo
<span class="nc" id="L1622">        double explosivePenalty = 0;</span>
        // FIXME: Consider new AmmoType::equals / BombType::equals
<span class="nc" id="L1624">        Map&lt;AmmoType, Boolean&gt; ammos = new HashMap&lt;AmmoType, Boolean&gt;();</span>
<span class="nc bnc" id="L1625" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L1626">            int loc = mounted.getLocation();</span>
<span class="nc" id="L1627">            int toSubtract = 1;</span>
<span class="nc" id="L1628">            EquipmentType etype = mounted.getType();</span>

<span class="nc bnc" id="L1630" title="All 2 branches missed.">            if (mounted.isWeaponGroup()) {</span>
<span class="nc" id="L1631">                continue;</span>
            }

            // only count explosive ammo
<span class="nc bnc" id="L1635" title="All 2 branches missed.">            if (!etype.isExplosive(mounted, true)) {</span>
<span class="nc" id="L1636">                continue;</span>
            }
            // PPCs with capacitors subtract 1
<span class="nc bnc" id="L1639" title="All 2 branches missed.">            if (etype instanceof PPCWeapon) {</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">                if (mounted.getLinkedBy() == null) {</span>
<span class="nc" id="L1641">                    continue;</span>
                }
            }

            // PPC capacitor does not count separately, it's already counted for
            // with the PPC
<span class="nc bnc" id="L1647" title="All 4 branches missed.">            if ((etype instanceof MiscType) &amp;&amp; etype.hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc" id="L1648">                continue;</span>
            }

            // don't count oneshot ammo
<span class="nc bnc" id="L1652" title="All 2 branches missed.">            if (loc == LOC_NONE) {</span>
<span class="nc" id="L1653">                continue;</span>
            }

            // CASE means no subtraction
<span class="nc bnc" id="L1657" title="All 4 branches missed.">            if (hasWorkingMisc(MiscType.F_CASE) || isClan()) {</span>
<span class="nc" id="L1658">                continue;</span>
            }

            // RACs, LACs and ACs don't really count
<span class="nc bnc" id="L1662" title="All 4 branches missed.">            if ((etype instanceof WeaponType) &amp;&amp; ((((WeaponType) etype).getAmmoType() == AmmoType.T_AC_ROTARY)</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_AC)</span>
<span class="nc bnc" id="L1664" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L1665" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_AC_PRIMITIVE)</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_PAC)</span>
<span class="nc bnc" id="L1667" title="All 2 branches missed.">                    || (((WeaponType) etype).getAmmoType() == AmmoType.T_LAC))) {</span>
<span class="nc" id="L1668">                toSubtract = 0;</span>
            }

            // empty ammo shouldn't count
<span class="nc bnc" id="L1672" title="All 4 branches missed.">            if ((etype instanceof AmmoType) &amp;&amp; (mounted.getUsableShotsLeft() == 0)) {</span>
<span class="nc" id="L1673">                continue;</span>
            }
<span class="nc bnc" id="L1675" title="All 2 branches missed.">            if (etype instanceof AmmoType) {</span>
<span class="nc" id="L1676">                ammos.put((AmmoType) etype, true);</span>
            } else {
<span class="nc" id="L1678">                explosivePenalty += toSubtract;</span>
            }
<span class="nc" id="L1680">        }</span>
<span class="nc" id="L1681">        explosivePenalty += ammos.size() * 15;</span>
<span class="nc" id="L1682">        dbv = Math.max(1, dbv - explosivePenalty);</span>

<span class="nc" id="L1684">        bvText.append(startRow);</span>
<span class="nc" id="L1685">        bvText.append(startColumn);</span>

<span class="nc" id="L1687">        bvText.append(&quot;Explosive Weapons/Equipment Penalty &quot;);</span>
<span class="nc" id="L1688">        bvText.append(endColumn);</span>
<span class="nc" id="L1689">        bvText.append(startColumn);</span>
<span class="nc" id="L1690">        bvText.append(endColumn);</span>
<span class="nc" id="L1691">        bvText.append(startColumn);</span>

<span class="nc" id="L1693">        bvText.append(&quot;= -&quot;);</span>
<span class="nc" id="L1694">        bvText.append(explosivePenalty);</span>
<span class="nc" id="L1695">        bvText.append(endColumn);</span>
<span class="nc" id="L1696">        bvText.append(endRow);</span>

<span class="nc" id="L1698">        bvText.append(startRow);</span>
<span class="nc" id="L1699">        bvText.append(startColumn);</span>
<span class="nc" id="L1700">        bvText.append(endColumn);</span>
<span class="nc" id="L1701">        bvText.append(startColumn);</span>
<span class="nc" id="L1702">        bvText.append(endColumn);</span>
<span class="nc" id="L1703">        bvText.append(startColumn);</span>

<span class="nc" id="L1705">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L1706">        bvText.append(endColumn);</span>
<span class="nc" id="L1707">        bvText.append(endRow);</span>

<span class="nc" id="L1709">        bvText.append(startRow);</span>
<span class="nc" id="L1710">        bvText.append(startColumn);</span>

<span class="nc" id="L1712">        bvText.append(endColumn);</span>
<span class="nc" id="L1713">        bvText.append(startColumn);</span>
<span class="nc" id="L1714">        bvText.append(endColumn);</span>
<span class="nc" id="L1715">        bvText.append(startColumn);</span>
<span class="nc" id="L1716">        bvText.append(dbv);</span>
<span class="nc" id="L1717">        bvText.append(endColumn);</span>
<span class="nc" id="L1718">        bvText.append(endRow);</span>

<span class="nc" id="L1720">        bvText.append(startRow);</span>
<span class="nc" id="L1721">        bvText.append(startColumn);</span>
<span class="nc" id="L1722">        bvText.append(&quot;Multiply by Unit Type Modifier&quot;);</span>
<span class="nc" id="L1723">        bvText.append(endColumn);</span>
<span class="nc" id="L1724">        bvText.append(startColumn);</span>
<span class="nc" id="L1725">        bvText.append(getBVTypeModifier());</span>
<span class="nc bnc" id="L1726" title="All 2 branches missed.">        if (hasStealth()) {</span>
<span class="nc" id="L1727">            bvText.append(&quot;+ 0.3 for Stealth&quot;);</span>
        }
<span class="nc" id="L1729">        bvText.append(endColumn);</span>
        // unit type multiplier
<span class="nc bnc" id="L1731" title="All 2 branches missed.">        dbv *= (getBVTypeModifier() + (hasStealth() ? 0.3 : 0));</span>
<span class="nc" id="L1732">        bvText.append(startColumn);</span>
<span class="nc bnc" id="L1733" title="All 2 branches missed.">        bvText.append(&quot;x&quot; + (getBVTypeModifier() + (hasStealth() ? 0.3 : 0)));</span>
<span class="nc" id="L1734">        bvText.append(endColumn);</span>
<span class="nc" id="L1735">        bvText.append(endRow);</span>

<span class="nc" id="L1737">        bvText.append(startRow);</span>
<span class="nc" id="L1738">        bvText.append(startColumn);</span>
<span class="nc" id="L1739">        bvText.append(endColumn);</span>
<span class="nc" id="L1740">        bvText.append(startColumn);</span>
<span class="nc" id="L1741">        bvText.append(endColumn);</span>
<span class="nc" id="L1742">        bvText.append(startColumn);</span>
<span class="nc" id="L1743">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L1744">        bvText.append(endColumn);</span>
<span class="nc" id="L1745">        bvText.append(endRow);</span>

<span class="nc" id="L1747">        bvText.append(startRow);</span>
<span class="nc" id="L1748">        bvText.append(startColumn);</span>
<span class="nc" id="L1749">        bvText.append(endColumn);</span>
<span class="nc" id="L1750">        bvText.append(startColumn);</span>
<span class="nc" id="L1751">        bvText.append(endColumn);</span>
<span class="nc" id="L1752">        bvText.append(startColumn);</span>
<span class="nc" id="L1753">        bvText.append(dbv);</span>
<span class="nc" id="L1754">        bvText.append(endColumn);</span>
<span class="nc" id="L1755">        bvText.append(endRow);</span>

<span class="nc" id="L1757">        bvText.append(startRow);</span>
<span class="nc" id="L1758">        bvText.append(startColumn);</span>

<span class="nc" id="L1760">        bvText.append(&quot;&lt;b&gt;Offensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1761">        bvText.append(endColumn);</span>
<span class="nc" id="L1762">        bvText.append(startColumn);</span>
<span class="nc" id="L1763">        bvText.append(endColumn);</span>
<span class="nc" id="L1764">        bvText.append(startColumn);</span>
<span class="nc" id="L1765">        bvText.append(endColumn);</span>
<span class="nc" id="L1766">        bvText.append(endRow);</span>

        // calculate heat efficiency
<span class="nc" id="L1769">        int aeroHeatEfficiency = 6 + getHeatCapacity();</span>

<span class="nc" id="L1771">        bvText.append(startRow);</span>
<span class="nc" id="L1772">        bvText.append(startColumn);</span>

<span class="nc" id="L1774">        bvText.append(&quot;Base Heat Efficiency &quot;);</span>

<span class="nc" id="L1776">        bvText.append(endColumn);</span>
<span class="nc" id="L1777">        bvText.append(startColumn);</span>
<span class="nc" id="L1778">        bvText.append(aeroHeatEfficiency);</span>

<span class="nc" id="L1780">        bvText.append(endColumn);</span>
<span class="nc" id="L1781">        bvText.append(endRow);</span>

<span class="nc" id="L1783">        bvText.append(startRow);</span>
<span class="nc" id="L1784">        bvText.append(startColumn);</span>
<span class="nc" id="L1785">        bvText.append(&quot;Unmodified Weapon BV:&quot;);</span>
<span class="nc" id="L1786">        bvText.append(endColumn);</span>
<span class="nc" id="L1787">        bvText.append(startColumn);</span>
<span class="nc" id="L1788">        bvText.append(endColumn);</span>
<span class="nc" id="L1789">        bvText.append(startColumn);</span>
<span class="nc" id="L1790">        bvText.append(endColumn);</span>
<span class="nc" id="L1791">        bvText.append(endRow);</span>

<span class="nc" id="L1793">        double weaponBV = 0;</span>
<span class="nc" id="L1794">        boolean hasTargComp = hasTargComp();</span>

<span class="nc" id="L1796">        double targetingSystemBVMod = 1.0;</span>

<span class="nc bnc" id="L1798" title="All 2 branches missed.">        if (this instanceof FixedWingSupport) {</span>
<span class="nc bnc" id="L1799" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL)) {</span>
<span class="nc" id="L1800">                targetingSystemBVMod = 1.0;</span>
<span class="nc bnc" id="L1801" title="All 2 branches missed.">            } else if (hasWorkingMisc(MiscType.F_BASIC_FIRECONTROL)) {</span>
<span class="nc" id="L1802">                targetingSystemBVMod = .9;</span>
            } else {
<span class="nc" id="L1804">                targetingSystemBVMod = .8;</span>
            }
        }

        // first, add up front-faced and rear-faced unmodified BV,
        // to know wether front- or rear faced BV should be halved
<span class="nc" id="L1810">        double bvFront = 0, bvRear = 0;</span>
<span class="nc" id="L1811">        List&lt;Mounted&gt; weapons = getTotalWeaponList();</span>
<span class="nc bnc" id="L1812" title="All 2 branches missed.">        for (Mounted weapon : weapons) {</span>
<span class="nc" id="L1813">            WeaponType wtype = (WeaponType) weapon.getType();</span>
<span class="nc" id="L1814">            double dBV = wtype.getBV(this);</span>
            // don't count destroyed equipment
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            if (weapon.isDestroyed()) {</span>
<span class="nc" id="L1817">                continue;</span>
            }
            // don't count AMS, it's defensive
<span class="nc bnc" id="L1820" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L1821">                continue;</span>
            }
            // don't count screen launchers, they are defensive
<span class="nc bnc" id="L1824" title="All 2 branches missed.">            if (wtype.getAtClass() == WeaponType.CLASS_SCREEN) {</span>
<span class="nc" id="L1825">                continue;</span>
            }
            // do not count weapon groups
<span class="nc bnc" id="L1828" title="All 2 branches missed.">            if (weapon.isWeaponGroup()) {</span>
<span class="nc" id="L1829">                continue;</span>
            }

<span class="nc" id="L1832">            String name = wtype.getName();</span>
            // PPC caps bump up the value
<span class="nc bnc" id="L1834" title="All 2 branches missed.">            if (weapon.getLinkedBy() != null) {</span>
                // check to see if the weapon is a PPC and has a Capacitor
                // attached to it
<span class="nc bnc" id="L1837" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_PPC)) {</span>
<span class="nc" id="L1838">                    dBV += ((MiscType) weapon.getLinkedBy().getType()).getBV(this, weapon);</span>
<span class="nc" id="L1839">                    name = name.concat(&quot; with Capacitor&quot;);</span>
                }
            }
            // calc MG Array here:
<span class="nc bnc" id="L1843" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L1844">                double mgBV = 0;</span>
<span class="nc bnc" id="L1845" title="All 2 branches missed.">                for (int eqNum : weapon.getBayWeapons()) {</span>
<span class="nc" id="L1846">                    Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L1847" title="All 4 branches missed.">                    if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L1848">                        mgBV += mg.getType().getBV(this);</span>
                    }
<span class="nc" id="L1850">                }</span>
<span class="nc" id="L1851">                dBV = mgBV * 0.67;</span>
            }
<span class="nc" id="L1853">            bvText.append(startRow);</span>
<span class="nc" id="L1854">            bvText.append(startColumn);</span>

<span class="nc" id="L1856">            bvText.append(name);</span>
<span class="nc bnc" id="L1857" title="All 4 branches missed.">            if (weapon.isRearMounted() || (weapon.getLocation() == LOC_AFT)) {</span>
<span class="nc" id="L1858">                bvRear += dBV;</span>
<span class="nc" id="L1859">                bvText.append(&quot; (R)&quot;);</span>
            } else {
<span class="nc" id="L1861">                bvFront += dBV;</span>
            }
<span class="nc" id="L1863">            bvText.append(endColumn);</span>
<span class="nc" id="L1864">            bvText.append(startColumn);</span>
<span class="nc" id="L1865">            bvText.append(endColumn);</span>
<span class="nc" id="L1866">            bvText.append(startColumn);</span>
<span class="nc" id="L1867">            bvText.append(dBV);</span>
<span class="nc" id="L1868">            bvText.append(endColumn);</span>
<span class="nc" id="L1869">            bvText.append(endRow);</span>
<span class="nc" id="L1870">        }</span>
<span class="nc" id="L1871">        boolean halveRear = true;</span>
<span class="nc bnc" id="L1872" title="All 2 branches missed.">        if (bvFront &lt;= bvRear) {</span>
<span class="nc" id="L1873">            halveRear = false;</span>

<span class="nc" id="L1875">            bvText.append(startRow);</span>
<span class="nc" id="L1876">            bvText.append(startColumn);</span>

<span class="nc" id="L1878">            bvText.append(&quot;halving front instead of rear weapon BVs&quot;);</span>
<span class="nc" id="L1879">            bvText.append(endColumn);</span>
<span class="nc" id="L1880">            bvText.append(endRow);</span>
<span class="nc" id="L1881">            bvText.append(startRow);</span>
<span class="nc" id="L1882">            bvText.append(startColumn);</span>
        }

<span class="nc" id="L1885">        bvText.append(startRow);</span>
<span class="nc" id="L1886">        bvText.append(startColumn);</span>
<span class="nc" id="L1887">        bvText.append(&quot;Weapon Heat:&quot;);</span>
<span class="nc" id="L1888">        bvText.append(endColumn);</span>
<span class="nc" id="L1889">        bvText.append(startColumn);</span>
<span class="nc" id="L1890">        bvText.append(endColumn);</span>
<span class="nc" id="L1891">        bvText.append(startColumn);</span>
<span class="nc" id="L1892">        bvText.append(endColumn);</span>
<span class="nc" id="L1893">        bvText.append(endRow);</span>

        // here we store the modified BV and heat of all heat-using weapons,
        // to later be sorted by BV
<span class="nc" id="L1897">        ArrayList&lt;ArrayList&lt;Object&gt;&gt; heatBVs = new ArrayList&lt;&gt;();</span>
        // BVs of non-heat-using weapons
<span class="nc" id="L1899">        ArrayList&lt;ArrayList&lt;Object&gt;&gt; nonHeatBVs = new ArrayList&lt;&gt;();</span>
        // total up maximum heat generated
        // and add up BVs for ammo-using weapon types for excessive ammo rule
<span class="nc" id="L1902">        Map&lt;String, Double&gt; weaponsForExcessiveAmmo = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1903">        double maximumHeat = 0;</span>
<span class="nc bnc" id="L1904" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc" id="L1905">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L1906">            double weaponHeat = wtype.getHeat();</span>

            // only count non-damaged equipment
<span class="nc bnc" id="L1909" title="All 8 branches missed.">            if (mounted.isMissing() || mounted.isHit() || mounted.isDestroyed() || mounted.isBreached()) {</span>
<span class="nc" id="L1910">                continue;</span>
            }

            // do not count weapon groups
<span class="nc bnc" id="L1914" title="All 2 branches missed.">            if (mounted.isWeaponGroup()) {</span>
<span class="nc" id="L1915">                continue;</span>
            }

            // one shot weapons count 1/4
<span class="nc bnc" id="L1919" title="All 4 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_ROCKET_LAUNCHER) || wtype.hasFlag(WeaponType.F_ONESHOT)) {</span>
<span class="nc" id="L1920">                weaponHeat *= 0.25;</span>
            }

            // double heat for ultras
<span class="nc bnc" id="L1924" title="All 4 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_AC_ULTRA) || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)) {</span>
<span class="nc" id="L1925">                weaponHeat *= 2;</span>
            }

            // Six times heat for RAC
<span class="nc bnc" id="L1929" title="All 2 branches missed.">            if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L1930">                weaponHeat *= 6;</span>
            }

            // laser insulator reduce heat by 1, to a minimum of 1
<span class="nc bnc" id="L1934" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_LASER) &amp;&amp; (mounted.getLinkedBy() != null)</span>
<span class="nc bnc" id="L1935" title="All 2 branches missed.">                    &amp;&amp; !mounted.getLinkedBy().isInoperable()</span>
<span class="nc bnc" id="L1936" title="All 2 branches missed.">                    &amp;&amp; mounted.getLinkedBy().getType().hasFlag(MiscType.F_LASER_INSULATOR)) {</span>
<span class="nc" id="L1937">                weaponHeat -= 1;</span>
<span class="nc bnc" id="L1938" title="All 2 branches missed.">                if (weaponHeat == 0) {</span>
<span class="nc" id="L1939">                    weaponHeat++;</span>
                }
            }

            // half heat for streaks
<span class="nc bnc" id="L1944" title="All 4 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_SRM_STREAK) || (wtype.getAmmoType() == AmmoType.T_MRM_STREAK)</span>
<span class="nc bnc" id="L1945" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_LRM_STREAK)) {</span>
<span class="nc" id="L1946">                weaponHeat *= 0.5;</span>
            }
<span class="nc" id="L1948">            String name = wtype.getName();</span>

            // check to see if the weapon is a PPC and has a Capacitor attached
            // to it
<span class="nc bnc" id="L1952" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_PPC) &amp;&amp; (mounted.getLinkedBy() != null)) {</span>
<span class="nc" id="L1953">                name = name.concat(&quot; with Capacitor&quot;);</span>
<span class="nc" id="L1954">                weaponHeat += 5;</span>
            }

<span class="nc" id="L1957">            bvText.append(startRow);</span>
<span class="nc" id="L1958">            bvText.append(startColumn);</span>

<span class="nc" id="L1960">            bvText.append(name);</span>
<span class="nc" id="L1961">            bvText.append(endColumn);</span>
<span class="nc" id="L1962">            bvText.append(startColumn);</span>
<span class="nc" id="L1963">            bvText.append(endColumn);</span>
<span class="nc" id="L1964">            bvText.append(startColumn);</span>
<span class="nc" id="L1965">            bvText.append(&quot;+ &quot;);</span>
<span class="nc" id="L1966">            bvText.append(weaponHeat);</span>
<span class="nc" id="L1967">            bvText.append(endColumn);</span>
<span class="nc" id="L1968">            bvText.append(endRow);</span>

<span class="nc" id="L1970">            double dBV = wtype.getBV(this);</span>

<span class="nc bnc" id="L1972" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L1973">                dBV *= 0.8;</span>
            }

<span class="nc bnc" id="L1976" title="All 2 branches missed.">            String weaponName = mounted.getName() + (mounted.isRearMounted() ? &quot;(R)&quot; : &quot;&quot;);</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1979" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1980">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L1984" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L1985">                continue;</span>
            }
            // don't count screen launchers, they are defensive
<span class="nc bnc" id="L1988" title="All 2 branches missed.">            if (wtype.getAtClass() == WeaponType.CLASS_SCREEN) {</span>
<span class="nc" id="L1989">                continue;</span>
            }
            // do not count weapon groups
<span class="nc bnc" id="L1992" title="All 2 branches missed.">            if (mounted.isWeaponGroup()) {</span>
<span class="nc" id="L1993">                continue;</span>
            }
            // calc MG Array here:
<span class="nc bnc" id="L1996" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L1997">                double mgBV = 0;</span>
<span class="nc bnc" id="L1998" title="All 2 branches missed.">                for (int eqNum : mounted.getBayWeapons()) {</span>
<span class="nc" id="L1999">                    Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L2000" title="All 4 branches missed.">                    if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L2001">                        mgBV += mg.getType().getBV(this);</span>
                    }
<span class="nc" id="L2003">                }</span>
<span class="nc" id="L2004">                dBV = mgBV * 0.67;</span>
            }
            // artemis bumps up the value
            // PPC caps do, too
<span class="nc bnc" id="L2008" title="All 2 branches missed.">            if (mounted.getLinkedBy() != null) {</span>
                // check to see if the weapon is a PPC and has a Capacitor
                // attached to it
<span class="nc bnc" id="L2011" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_PPC)) {</span>
<span class="nc" id="L2012">                    dBV += ((MiscType) mounted.getLinkedBy().getType()).getBV(this, mounted);</span>
<span class="nc" id="L2013">                    name = name.concat(&quot; with Capacitor&quot;);</span>
                }
<span class="nc" id="L2015">                Mounted mLinker = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L2016" title="All 4 branches missed.">                if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</span>
<span class="nc" id="L2017">                    dBV *= 1.2;</span>
<span class="nc" id="L2018">                    name = name.concat(&quot; with Artemis IV&quot;);</span>
                }
<span class="nc bnc" id="L2020" title="All 4 branches missed.">                if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</span>
<span class="nc" id="L2021">                    dBV *= 1.3;</span>
<span class="nc" id="L2022">                    name = name.concat(&quot; with Artemis V&quot;);</span>
                }
<span class="nc bnc" id="L2024" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L2025" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_PROTO)) {</span>
<span class="nc" id="L2026">                    dBV *= 1.1;</span>
<span class="nc" id="L2027">                    name = name.concat(&quot; with Artemis IV Prototype&quot;);</span>
                }
<span class="nc bnc" id="L2029" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L2030" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</span>
<span class="nc" id="L2031">                    dBV *= 1.15;</span>
<span class="nc" id="L2032">                    name = name.concat(&quot; with Apollo&quot;);</span>
                }
<span class="nc bnc" id="L2034" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L2036">                    dBV *= 1.15;</span>
<span class="nc" id="L2037">                    name = name.concat(&quot; with RISC Laser Pulse Module&quot;);</span>
                }
            }

            // and we'll add the tcomp here too
<span class="nc bnc" id="L2042" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; hasTargComp) {</span>
<span class="nc" id="L2043">                dBV *= 1.25;</span>
<span class="nc bnc" id="L2044" title="All 4 branches missed.">            } else if ((this instanceof FixedWingSupport) &amp;&amp; !wtype.hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L2045">                dBV *= targetingSystemBVMod;</span>
            }

            // half for being rear mounted (or front mounted, when more rear-
            // than front-mounted un-modded BV
<span class="nc bnc" id="L2050" title="All 6 branches missed.">            if (((mounted.isRearMounted() || (mounted.getLocation() == LOC_AFT)) &amp;&amp; halveRear)</span>
<span class="nc bnc" id="L2051" title="All 6 branches missed.">                    || (!(mounted.isRearMounted() || (mounted.getLocation() == LOC_AFT)) &amp;&amp; !halveRear)) {</span>
<span class="nc" id="L2052">                dBV /= 2;</span>
            }

            // ArrayList that stores weapon values
            // stores a double first (BV), then an Integer (heat),
            // then a String (weapon name)
            // for 0 heat weapons, just stores BV and name
<span class="nc" id="L2059">            ArrayList&lt;Object&gt; weaponValues = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2060" title="All 2 branches missed.">            if (weaponHeat &gt; 0) {</span>
                // store heat and BV, for sorting a few lines down;
<span class="nc" id="L2062">                weaponValues.add(dBV);</span>
<span class="nc" id="L2063">                weaponValues.add(weaponHeat);</span>
<span class="nc" id="L2064">                weaponValues.add(weaponName);</span>
<span class="nc" id="L2065">                heatBVs.add(weaponValues);</span>
            } else {
<span class="nc" id="L2067">                weaponValues.add(dBV);</span>
<span class="nc" id="L2068">                weaponValues.add(weaponName);</span>
<span class="nc" id="L2069">                nonHeatBVs.add(weaponValues);</span>
            }

<span class="nc" id="L2072">            maximumHeat += weaponHeat;</span>
            // add up BV of ammo-using weapons for each type of weapon,
            // to compare with ammo BV later for excessive ammo BV rule
<span class="nc bnc" id="L2075" title="All 4 branches missed.">            if (!((wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !(wtype.getAmmoType() == AmmoType.T_PLASMA))</span>
<span class="nc bnc" id="L2076" title="All 4 branches missed.">                    || wtype.hasFlag(WeaponType.F_ONESHOT) || wtype.hasFlag(WeaponType.F_INFANTRY)</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_NA))) {</span>
<span class="nc" id="L2078">                String key = wtype.getAmmoType() + &quot;:&quot; + wtype.getRackSize();</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                if (!weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L2080">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this));</span>
                } else {
<span class="nc" id="L2082">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this) + weaponsForExcessiveAmmo.get(key));</span>
                }
            }
<span class="nc" id="L2085">        }</span>

<span class="nc" id="L2087">        bvText.append(startRow);</span>
<span class="nc" id="L2088">        bvText.append(startColumn);</span>
<span class="nc" id="L2089">        bvText.append(endColumn);</span>
<span class="nc" id="L2090">        bvText.append(startColumn);</span>
<span class="nc" id="L2091">        bvText.append(endColumn);</span>
<span class="nc" id="L2092">        bvText.append(startColumn);</span>

<span class="nc" id="L2094">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2095">        bvText.append(endColumn);</span>
<span class="nc" id="L2096">        bvText.append(endRow);</span>

<span class="nc" id="L2098">        bvText.append(startRow);</span>
<span class="nc" id="L2099">        bvText.append(startColumn);</span>

<span class="nc" id="L2101">        bvText.append(&quot;Total Heat:&quot;);</span>
<span class="nc" id="L2102">        bvText.append(endColumn);</span>
<span class="nc" id="L2103">        bvText.append(startColumn);</span>
<span class="nc" id="L2104">        bvText.append(endColumn);</span>
<span class="nc" id="L2105">        bvText.append(startColumn);</span>
<span class="nc" id="L2106">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L2107">        bvText.append(maximumHeat);</span>
<span class="nc" id="L2108">        bvText.append(endColumn);</span>
<span class="nc" id="L2109">        bvText.append(endRow);</span>

<span class="nc" id="L2111">        bvText.append(startRow);</span>
<span class="nc" id="L2112">        bvText.append(startColumn);</span>
<span class="nc" id="L2113">        bvText.append(&quot;Weapons with no heat at full BV:&quot;);</span>
<span class="nc" id="L2114">        bvText.append(endColumn);</span>
<span class="nc" id="L2115">        bvText.append(endRow);</span>
        // count heat-free weapons always at full modified BV
<span class="nc bnc" id="L2117" title="All 2 branches missed.">        for (ArrayList&lt;Object&gt; nonHeatWeapon : nonHeatBVs) {</span>
<span class="nc" id="L2118">            weaponBV += (Double) nonHeatWeapon.get(0);</span>

<span class="nc" id="L2120">            bvText.append(startRow);</span>
<span class="nc" id="L2121">            bvText.append(startColumn);</span>
<span class="nc" id="L2122">            bvText.append(nonHeatWeapon.get(1));</span>
<span class="nc bnc" id="L2123" title="All 2 branches missed.">            if (nonHeatWeapon.get(1).toString().length() &lt; 8) {</span>
<span class="nc" id="L2124">                bvText.append(&quot;\t&quot;);</span>
            }
<span class="nc" id="L2126">            bvText.append(endColumn);</span>
<span class="nc" id="L2127">            bvText.append(startColumn);</span>
<span class="nc" id="L2128">            bvText.append(startColumn);</span>
<span class="nc" id="L2129">            bvText.append(endColumn);</span>
<span class="nc" id="L2130">            bvText.append(nonHeatWeapon.get(0));</span>
<span class="nc" id="L2131">            bvText.append(endColumn);</span>
<span class="nc" id="L2132">            bvText.append(endRow);</span>
<span class="nc" id="L2133">        }</span>

<span class="nc" id="L2135">        bvText.append(startRow);</span>
<span class="nc" id="L2136">        bvText.append(startColumn);</span>
<span class="nc" id="L2137">        bvText.append(&quot;Heat Modified Weapons BV: &quot;);</span>
<span class="nc" id="L2138">        bvText.append(endColumn);</span>
<span class="nc" id="L2139">        bvText.append(startColumn);</span>
<span class="nc" id="L2140">        bvText.append(endColumn);</span>
<span class="nc" id="L2141">        bvText.append(startColumn);</span>
<span class="nc" id="L2142">        bvText.append(endColumn);</span>
<span class="nc" id="L2143">        bvText.append(endRow);</span>

<span class="nc bnc" id="L2145" title="All 2 branches missed.">        if (maximumHeat &gt; aeroHeatEfficiency) {</span>

<span class="nc" id="L2147">            bvText.append(startRow);</span>
<span class="nc" id="L2148">            bvText.append(startColumn);</span>

<span class="nc" id="L2150">            bvText.append(&quot;(Heat Exceeds Aero Heat Efficiency) &quot;);</span>

<span class="nc" id="L2152">            bvText.append(endColumn);</span>
<span class="nc" id="L2153">            bvText.append(startColumn);</span>
<span class="nc" id="L2154">            bvText.append(endColumn);</span>
<span class="nc" id="L2155">            bvText.append(startColumn);</span>
<span class="nc" id="L2156">            bvText.append(endColumn);</span>
<span class="nc" id="L2157">            bvText.append(endRow);</span>
        }

<span class="nc bnc" id="L2160" title="All 2 branches missed.">        if (maximumHeat &lt;= aeroHeatEfficiency) {</span>
            // count all weapons equal, adjusting for rear-firing and excessive
            // ammo
<span class="nc bnc" id="L2163" title="All 2 branches missed.">            for (ArrayList&lt;Object&gt; weaponValues : heatBVs) {</span>
<span class="nc" id="L2164">                bvText.append(startRow);</span>
<span class="nc" id="L2165">                bvText.append(startColumn);</span>

<span class="nc" id="L2167">                bvText.append(weaponValues.get(2));</span>
<span class="nc" id="L2168">                weaponBV += (Double) weaponValues.get(0);</span>
<span class="nc" id="L2169">                bvText.append(endColumn);</span>
<span class="nc" id="L2170">                bvText.append(startColumn);</span>
<span class="nc" id="L2171">                bvText.append(endColumn);</span>
<span class="nc" id="L2172">                bvText.append(startColumn);</span>

<span class="nc" id="L2174">                bvText.append(weaponValues.get(0));</span>
<span class="nc" id="L2175">                bvText.append(endColumn);</span>
<span class="nc" id="L2176">                bvText.append(endRow);</span>
<span class="nc" id="L2177">            }</span>
        } else {
            // this will count heat-generating weapons at full modified BV until
            // heatefficiency is reached or passed with one weapon

            // sort the heat-using weapons by modified BV
<span class="nc" id="L2183">            Collections.sort(heatBVs, (obj1, obj2) -&gt; {</span>
<span class="nc" id="L2184">                Double obj1BV = (Double) obj1.get(0); // BV</span>
<span class="nc" id="L2185">                Double obj2BV = (Double) obj2.get(0); // BV</span>

                // first element in the the ArrayList is BV, second is heat
                // if same BV, lower heat first
<span class="nc bnc" id="L2189" title="All 2 branches missed.">                if(obj1BV.equals(obj2BV)) {</span>
<span class="nc" id="L2190">                    Double obj1Heat = (Double) obj1.get(1);</span>
<span class="nc" id="L2191">                    Double obj2Heat = (Double) obj2.get(1);</span>

<span class="nc" id="L2193">                    return Double.compare(obj1Heat, obj2Heat);</span>
                }

                // higher BV first
<span class="nc" id="L2197">                return Double.compare(obj2BV, obj1BV);</span>
            });

            // count heat-generating weapons at full modified BV until
            // heatefficiency is reached or
            // passed with one weapon
<span class="nc" id="L2203">            double heatAdded = 0;</span>
<span class="nc bnc" id="L2204" title="All 2 branches missed.">            for (ArrayList&lt;Object&gt; weaponValues : heatBVs) {</span>
<span class="nc" id="L2205">                bvText.append(startRow);</span>
<span class="nc" id="L2206">                bvText.append(startColumn);</span>

<span class="nc" id="L2208">                bvText.append(weaponValues.get(2));</span>
<span class="nc" id="L2209">                bvText.append(endColumn);</span>
<span class="nc" id="L2210">                bvText.append(startColumn);</span>

<span class="nc" id="L2212">                double dBV = (Double) weaponValues.get(0);</span>
<span class="nc bnc" id="L2213" title="All 2 branches missed.">                if (heatAdded &gt;= aeroHeatEfficiency) {</span>
<span class="nc" id="L2214">                    dBV /= 2;</span>
                }
<span class="nc bnc" id="L2216" title="All 2 branches missed.">                if (heatAdded &gt;= aeroHeatEfficiency) {</span>
<span class="nc" id="L2217">                    bvText.append(&quot;Heat efficiency reached, half BV&quot;);</span>
                }
<span class="nc" id="L2219">                heatAdded += (Double) weaponValues.get(1);</span>
<span class="nc" id="L2220">                weaponBV += dBV;</span>
<span class="nc" id="L2221">                bvText.append(endColumn);</span>
<span class="nc" id="L2222">                bvText.append(startColumn);</span>
<span class="nc" id="L2223">                bvText.append(dBV);</span>
<span class="nc" id="L2224">                bvText.append(endColumn);</span>
<span class="nc" id="L2225">                bvText.append(endRow);</span>
<span class="nc" id="L2226">                bvText.append(startRow);</span>
<span class="nc" id="L2227">                bvText.append(startColumn);</span>
<span class="nc" id="L2228">                bvText.append(&quot;Heat count: &quot; + heatAdded);</span>
<span class="nc" id="L2229">                bvText.append(endColumn);</span>
<span class="nc" id="L2230">                bvText.append(startColumn);</span>
<span class="nc" id="L2231">                bvText.append(endColumn);</span>
<span class="nc" id="L2232">                bvText.append(startColumn);</span>
<span class="nc" id="L2233">                bvText.append(endColumn);</span>
<span class="nc" id="L2234">                bvText.append(endRow);</span>
<span class="nc" id="L2235">            }</span>
        }
<span class="nc" id="L2237">        bvText.append(startRow);</span>
<span class="nc" id="L2238">        bvText.append(startColumn);</span>
<span class="nc" id="L2239">        bvText.append(endColumn);</span>
<span class="nc" id="L2240">        bvText.append(startColumn);</span>
<span class="nc" id="L2241">        bvText.append(endColumn);</span>
<span class="nc" id="L2242">        bvText.append(startColumn);</span>

<span class="nc" id="L2244">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2245">        bvText.append(endColumn);</span>
<span class="nc" id="L2246">        bvText.append(endRow);</span>

<span class="nc" id="L2248">        bvText.append(startRow);</span>
<span class="nc" id="L2249">        bvText.append(startColumn);</span>

<span class="nc" id="L2251">        bvText.append(&quot;Total Weapons BV Adjusted For Heat:&quot;);</span>
<span class="nc" id="L2252">        bvText.append(endColumn);</span>
<span class="nc" id="L2253">        bvText.append(startColumn);</span>
<span class="nc" id="L2254">        bvText.append(endColumn);</span>
<span class="nc" id="L2255">        bvText.append(startColumn);</span>
<span class="nc" id="L2256">        bvText.append(weaponBV);</span>
<span class="nc" id="L2257">        bvText.append(endColumn);</span>
<span class="nc" id="L2258">        bvText.append(endRow);</span>

<span class="nc" id="L2260">        bvText.append(startRow);</span>
<span class="nc" id="L2261">        bvText.append(startColumn);</span>

<span class="nc" id="L2263">        bvText.append(&quot;Misc Offensive Equipment: &quot;);</span>
<span class="nc" id="L2264">        bvText.append(endColumn);</span>
<span class="nc" id="L2265">        bvText.append(startColumn);</span>
<span class="nc" id="L2266">        bvText.append(endColumn);</span>
<span class="nc" id="L2267">        bvText.append(startColumn);</span>
<span class="nc" id="L2268">        bvText.append(endColumn);</span>
<span class="nc" id="L2269">        bvText.append(endRow);</span>

        // add offensive misc. equipment BV
<span class="nc" id="L2272">        double oEquipmentBV = 0;</span>
<span class="nc bnc" id="L2273" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L2274">            MiscType mtype = (MiscType) mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L2277" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L2278">                continue;</span>
            }

<span class="nc bnc" id="L2281" title="All 6 branches missed.">            if (mtype.hasFlag(MiscType.F_TARGCOMP) || mtype.hasFlag(MiscType.F_ECM) || mtype.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_CHAFF_POD)) {</span>
<span class="nc" id="L2283">                continue;</span>
            }
<span class="nc" id="L2285">            double bv = mtype.getBV(this);</span>
<span class="nc bnc" id="L2286" title="All 2 branches missed.">            if (bv &gt; 0) {</span>
<span class="nc" id="L2287">                bvText.append(startRow);</span>
<span class="nc" id="L2288">                bvText.append(startColumn);</span>

<span class="nc" id="L2290">                bvText.append(mounted.getName());</span>
<span class="nc" id="L2291">                bvText.append(endColumn);</span>
<span class="nc" id="L2292">                bvText.append(startColumn);</span>
<span class="nc" id="L2293">                bvText.append(endColumn);</span>
<span class="nc" id="L2294">                bvText.append(startColumn);</span>
<span class="nc" id="L2295">                bvText.append(bv);</span>
<span class="nc" id="L2296">                bvText.append(endColumn);</span>
<span class="nc" id="L2297">                bvText.append(endRow);</span>
            }
<span class="nc" id="L2299">            oEquipmentBV += bv;</span>
<span class="nc" id="L2300">        }</span>
<span class="nc" id="L2301">        bvText.append(startRow);</span>
<span class="nc" id="L2302">        bvText.append(startColumn);</span>

<span class="nc" id="L2304">        bvText.append(&quot;Total Misc Offensive Equipment BV: &quot;);</span>
<span class="nc" id="L2305">        bvText.append(endColumn);</span>
<span class="nc" id="L2306">        bvText.append(startColumn);</span>
<span class="nc" id="L2307">        bvText.append(endColumn);</span>
<span class="nc" id="L2308">        bvText.append(startColumn);</span>
<span class="nc" id="L2309">        bvText.append(oEquipmentBV);</span>
<span class="nc" id="L2310">        bvText.append(endColumn);</span>
<span class="nc" id="L2311">        bvText.append(endRow);</span>

<span class="nc" id="L2313">        weaponBV += oEquipmentBV;</span>

        // add ammo bv
<span class="nc" id="L2316">        double ammoBV = 0;</span>
        // extra BV for when we have semiguided LRMs and someone else has TAG on
        // our team
<span class="nc" id="L2319">        double tagBV = 0;</span>
<span class="nc" id="L2320">        Map&lt;String, Double&gt; ammo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L2321">        ArrayList&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L2322" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L2323">            AmmoType atype = (AmmoType) mounted.getType();</span>

            // don't count depleted ammo
<span class="nc bnc" id="L2326" title="All 2 branches missed.">            if (mounted.getUsableShotsLeft() == 0) {</span>
<span class="nc" id="L2327">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L2331" title="All 2 branches missed.">            if (atype.getAmmoType() == AmmoType.T_AMS) {</span>
<span class="nc" id="L2332">                continue;</span>
            }
            // don't count screen launchers, they are defensive
<span class="nc bnc" id="L2335" title="All 2 branches missed.">            if (atype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER) {</span>
<span class="nc" id="L2336">                continue;</span>
            }

            // don't count oneshot ammo, it's considered part of the launcher.
<span class="nc bnc" id="L2340" title="All 2 branches missed.">            if (mounted.getLocation() == Entity.LOC_NONE) {</span>
                // assumption: ammo without a location is for a oneshot weapon
<span class="nc" id="L2342">                continue;</span>
            }
            // semiguided or homing ammo might count double
<span class="nc bnc" id="L2345" title="All 4 branches missed.">            if ((atype.getMunitionType() == AmmoType.M_SEMIGUIDED) || (atype.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L2346">                IPlayer tmpP = getOwner();</span>

<span class="nc bnc" id="L2348" title="All 2 branches missed.">                if (tmpP != null) {</span>
                    // Okay, actually check for friendly TAG.
<span class="nc bnc" id="L2350" title="All 2 branches missed.">                    if (tmpP.hasTAG()) {</span>
<span class="nc" id="L2351">                        tagBV += atype.getBV(this);</span>
<span class="nc bnc" id="L2352" title="All 4 branches missed.">                    } else if ((tmpP.getTeam() != IPlayer.TEAM_NONE) &amp;&amp; (game != null)) {</span>
<span class="nc bnc" id="L2353" title="All 2 branches missed.">                        for (Enumeration&lt;Team&gt; e = game.getTeams(); e.hasMoreElements();) {</span>
<span class="nc" id="L2354">                            Team m = e.nextElement();</span>
<span class="nc bnc" id="L2355" title="All 2 branches missed.">                            if (m.getId() == tmpP.getTeam()) {</span>
<span class="nc bnc" id="L2356" title="All 2 branches missed.">                                if (m.hasTAG(game)) {</span>
<span class="nc" id="L2357">                                    tagBV += atype.getBV(this);</span>
                                }
                                // A player can't be on two teams.
                                // If we check his team and don't give the
                                // penalty, that's it.
                                break;
                            }
<span class="nc" id="L2364">                        }</span>
                    }
                }
            }
<span class="nc" id="L2368">            String key = atype.getAmmoType() + &quot;:&quot; + atype.getRackSize();</span>
<span class="nc bnc" id="L2369" title="All 2 branches missed.">            if (!keys.contains(key)) {</span>
<span class="nc" id="L2370">                keys.add(key);</span>
            }
<span class="nc bnc" id="L2372" title="All 2 branches missed.">            if (!ammo.containsKey(key)) {</span>
<span class="nc" id="L2373">                ammo.put(key, atype.getBV(this));</span>
            } else {
<span class="nc" id="L2375">                ammo.put(key, atype.getBV(this) + ammo.get(key));</span>
            }
<span class="nc" id="L2377">        }</span>

        // Excessive ammo rule:
        // Only count BV for ammo for a weapontype until the BV of all weapons
        // of that
        // type on the mech is reached.
<span class="nc bnc" id="L2383" title="All 2 branches missed.">        for (String key : keys) {</span>
<span class="nc bnc" id="L2384" title="All 2 branches missed.">            if (weaponsForExcessiveAmmo.get(key) != null) {</span>
<span class="nc bnc" id="L2385" title="All 2 branches missed.">                if (ammo.get(key) &gt; weaponsForExcessiveAmmo.get(key)) {</span>
<span class="nc" id="L2386">                    ammoBV += weaponsForExcessiveAmmo.get(key);</span>
                } else {
<span class="nc" id="L2388">                    ammoBV += ammo.get(key);</span>
                }
            }
<span class="nc" id="L2391">        }</span>
<span class="nc" id="L2392">        weaponBV += ammoBV;</span>

<span class="nc" id="L2394">        bvText.append(startRow);</span>
<span class="nc" id="L2395">        bvText.append(startColumn);</span>

<span class="nc" id="L2397">        bvText.append(&quot;Total Ammo BV: &quot;);</span>
<span class="nc" id="L2398">        bvText.append(endColumn);</span>
<span class="nc" id="L2399">        bvText.append(startColumn);</span>
<span class="nc" id="L2400">        bvText.append(endColumn);</span>
<span class="nc" id="L2401">        bvText.append(startColumn);</span>

<span class="nc" id="L2403">        bvText.append(ammoBV);</span>
<span class="nc" id="L2404">        bvText.append(endColumn);</span>
<span class="nc" id="L2405">        bvText.append(endRow);</span>

        // adjust further for speed factor
<span class="nc" id="L2408">        double speedFactor = Math.pow(1 + (((double) getRunMP() - 5) / 10), 1.2);</span>
<span class="nc" id="L2409">        speedFactor = Math.round(speedFactor * 100) / 100.0;</span>

<span class="nc" id="L2411">        bvText.append(startRow);</span>
<span class="nc" id="L2412">        bvText.append(startColumn);</span>

<span class="nc" id="L2414">        bvText.append(&quot;Final Speed Factor: &quot;);</span>
<span class="nc" id="L2415">        bvText.append(endColumn);</span>
<span class="nc" id="L2416">        bvText.append(startColumn);</span>
<span class="nc" id="L2417">        bvText.append(endColumn);</span>
<span class="nc" id="L2418">        bvText.append(startColumn);</span>
<span class="nc" id="L2419">        bvText.append(speedFactor);</span>
<span class="nc" id="L2420">        bvText.append(endColumn);</span>
<span class="nc" id="L2421">        bvText.append(endRow);</span>

<span class="nc" id="L2423">        obv = weaponBV * speedFactor;</span>

<span class="nc" id="L2425">        bvText.append(startRow);</span>
<span class="nc" id="L2426">        bvText.append(startColumn);</span>

<span class="nc" id="L2428">        bvText.append(&quot;Weapons BV * Speed Factor &quot;);</span>
<span class="nc" id="L2429">        bvText.append(endColumn);</span>
<span class="nc" id="L2430">        bvText.append(startColumn);</span>

<span class="nc" id="L2432">        bvText.append(weaponBV);</span>
<span class="nc" id="L2433">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L2434">        bvText.append(speedFactor);</span>
<span class="nc" id="L2435">        bvText.append(endColumn);</span>
<span class="nc" id="L2436">        bvText.append(startColumn);</span>
<span class="nc" id="L2437">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L2438">        bvText.append(obv);</span>
<span class="nc" id="L2439">        bvText.append(endColumn);</span>
<span class="nc" id="L2440">        bvText.append(endRow);</span>

<span class="nc" id="L2442">        bvText.append(startRow);</span>
<span class="nc" id="L2443">        bvText.append(startColumn);</span>

<span class="nc bnc" id="L2445" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L2446">            bvText.append(&quot;2 * sqrt(Offensive BV * Defensive BV&quot;);</span>
        } else {
<span class="nc" id="L2448">            bvText.append(&quot;Offensive BV + Defensive BV&quot;);</span>
        }
<span class="nc" id="L2450">        bvText.append(endColumn);</span>
<span class="nc" id="L2451">        bvText.append(startColumn);</span>

        double finalBV;
<span class="nc bnc" id="L2454" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L2455">            finalBV = 2 * Math.sqrt(obv * dbv);</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">            if (finalBV == 0) {</span>
<span class="nc" id="L2457">                finalBV = dbv + obv;</span>
            }
<span class="nc" id="L2459">            bvText.append(&quot;2 * sqrt(&quot;);</span>
<span class="nc" id="L2460">            bvText.append(obv);</span>
<span class="nc" id="L2461">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L2462">            bvText.append(dbv);</span>
<span class="nc" id="L2463">            bvText.append(&quot;)&quot;);</span>
        } else {
<span class="nc" id="L2465">            finalBV = dbv + obv;</span>
<span class="nc" id="L2466">            bvText.append(dbv);</span>
<span class="nc" id="L2467">            bvText.append(&quot; + &quot;);</span>
<span class="nc" id="L2468">            bvText.append(obv);</span>
        }
<span class="nc" id="L2470">        double totalBV = finalBV;</span>

<span class="nc" id="L2472">        bvText.append(endColumn);</span>
<span class="nc" id="L2473">        bvText.append(startColumn);</span>
<span class="nc" id="L2474">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L2475">        bvText.append(finalBV);</span>
<span class="nc" id="L2476">        bvText.append(endColumn);</span>
<span class="nc" id="L2477">        bvText.append(endRow);</span>

<span class="nc" id="L2479">        bvText.append(startRow);</span>
<span class="nc" id="L2480">        bvText.append(startColumn);</span>

<span class="nc" id="L2482">        double cockpitMod = 1;</span>
<span class="nc bnc" id="L2483" title="All 2 branches missed.">        if (getCockpitType() == Aero.COCKPIT_SMALL) {</span>
<span class="nc" id="L2484">            cockpitMod = 0.95;</span>
<span class="nc" id="L2485">            finalBV *= cockpitMod;</span>
<span class="nc bnc" id="L2486" title="All 2 branches missed.">        } else if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L2487">            finalBV *= 0.95;</span>
        }
<span class="nc" id="L2489">        finalBV = Math.round(finalBV);</span>
<span class="nc" id="L2490">        bvText.append(&quot;Total BV * Cockpit Modifier&quot;);</span>
<span class="nc" id="L2491">        bvText.append(endColumn);</span>
<span class="nc" id="L2492">        bvText.append(startColumn);</span>
<span class="nc" id="L2493">        bvText.append(totalBV);</span>
<span class="nc" id="L2494">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L2495">        bvText.append(cockpitMod);</span>
<span class="nc" id="L2496">        bvText.append(endColumn);</span>
<span class="nc" id="L2497">        bvText.append(startColumn);</span>
<span class="nc" id="L2498">        bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L2499">        bvText.append(finalBV);</span>
<span class="nc" id="L2500">        bvText.append(endColumn);</span>
<span class="nc" id="L2501">        bvText.append(endRow);</span>

<span class="nc" id="L2503">        bvText.append(startRow);</span>
<span class="nc" id="L2504">        bvText.append(startColumn);</span>
<span class="nc" id="L2505">        bvText.append(endColumn);</span>
<span class="nc" id="L2506">        bvText.append(startColumn);</span>
<span class="nc" id="L2507">        bvText.append(endColumn);</span>
<span class="nc" id="L2508">        bvText.append(startColumn);</span>

<span class="nc" id="L2510">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2511">        bvText.append(endColumn);</span>
<span class="nc" id="L2512">        bvText.append(endRow);</span>

<span class="nc" id="L2514">        bvText.append(startRow);</span>
<span class="nc" id="L2515">        bvText.append(startColumn);</span>
<span class="nc" id="L2516">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L2517">        bvText.append(endColumn);</span>
<span class="nc" id="L2518">        bvText.append(startColumn);</span>
<span class="nc" id="L2519">        bvText.append(endColumn);</span>
<span class="nc" id="L2520">        bvText.append(startColumn);</span>

<span class="nc" id="L2522">        bvText.append(finalBV);</span>
<span class="nc" id="L2523">        bvText.append(endColumn);</span>
<span class="nc" id="L2524">        bvText.append(endRow);</span>

        // We need to consider external stores. Per TechManual Pg314,
        // TM BV Errata Pg23, the external stores BV is added to the
        // units base BV
<span class="nc" id="L2529">        boolean hasBombs = false;</span>
<span class="nc" id="L2530">        double bombBV = 0;</span>
<span class="nc bnc" id="L2531" title="All 2 branches missed.">        for (int bombType = 0; bombType &lt; BombType.B_NUM; bombType++) {</span>
<span class="nc" id="L2532">            BombType bomb = BombType.createBombByType(bombType);</span>
<span class="nc" id="L2533">            bombBV += bomb.bv * bombChoices[bombType];</span>
<span class="nc bnc" id="L2534" title="All 2 branches missed.">            if (bombChoices[bombType] &gt; 0) {</span>
<span class="nc" id="L2535">                hasBombs = true;</span>
            }
        }
<span class="nc" id="L2538">        finalBV += bombBV;</span>
<span class="nc bnc" id="L2539" title="All 2 branches missed.">        if (hasBombs) {</span>
<span class="nc" id="L2540">            bvText.append(startRow);</span>
<span class="nc" id="L2541">            bvText.append(startColumn);</span>
<span class="nc" id="L2542">            bvText.append(&quot;External Stores BV&quot;);</span>
<span class="nc" id="L2543">            bvText.append(endColumn);</span>
<span class="nc" id="L2544">            bvText.append(startColumn);</span>
<span class="nc" id="L2545">            bvText.append(endColumn);</span>
<span class="nc" id="L2546">            bvText.append(startColumn);</span>

<span class="nc" id="L2548">            bvText.append(bombBV);</span>
<span class="nc" id="L2549">            bvText.append(endColumn);</span>
<span class="nc" id="L2550">            bvText.append(endRow);</span>

<span class="nc" id="L2552">            bvText.append(startRow);</span>
<span class="nc" id="L2553">            bvText.append(startColumn);</span>
<span class="nc" id="L2554">            bvText.append(endColumn);</span>
<span class="nc" id="L2555">            bvText.append(startColumn);</span>
<span class="nc" id="L2556">            bvText.append(endColumn);</span>
<span class="nc" id="L2557">            bvText.append(startColumn);</span>

<span class="nc" id="L2559">            bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2560">            bvText.append(endColumn);</span>
<span class="nc" id="L2561">            bvText.append(endRow);</span>

<span class="nc" id="L2563">            bvText.append(startRow);</span>
<span class="nc" id="L2564">            bvText.append(startColumn);</span>
<span class="nc" id="L2565">            bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L2566">            bvText.append(endColumn);</span>
<span class="nc" id="L2567">            bvText.append(startColumn);</span>
<span class="nc" id="L2568">            bvText.append(endColumn);</span>
<span class="nc" id="L2569">            bvText.append(startColumn);</span>

<span class="nc" id="L2571">            bvText.append(finalBV);</span>
<span class="nc" id="L2572">            bvText.append(endColumn);</span>
<span class="nc" id="L2573">            bvText.append(endRow);</span>
        }

<span class="nc" id="L2576">        bvText.append(endTable);</span>
<span class="nc" id="L2577">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>

        // we get extra bv from some stuff
<span class="nc" id="L2580">        double xbv = 0.0;</span>
        // extra BV for semi-guided lrm when TAG in our team
<span class="nc" id="L2582">        xbv += tagBV;</span>
        // extra from c3 networks. a valid network requires at least 2 members
        // some hackery and magic numbers here. could be better
        // also, each 'has' loops through all equipment. inefficient to do it 3
        // times
<span class="nc bnc" id="L2587" title="All 4 branches missed.">        if (!ignoreC3 &amp;&amp; (game != null)) {</span>

<span class="nc" id="L2589">            xbv += getExtraC3BV((int) Math.round(finalBV));</span>
        }
<span class="nc" id="L2591">        finalBV += xbv;</span>

        // and then factor in pilot
<span class="nc" id="L2594">        double pilotFactor = 1;</span>
<span class="nc bnc" id="L2595" title="All 2 branches missed.">        if (!ignorePilot) {</span>
<span class="nc" id="L2596">            pilotFactor = getCrew().getBVSkillMultiplier(game);</span>
        }

<span class="nc" id="L2599">        int retVal = (int) Math.round((finalBV) * pilotFactor);</span>

<span class="nc" id="L2601">        return retVal;</span>
    }

    public double getBVTypeModifier() {
<span class="nc" id="L2605">        return 1.2;</span>
    }

    @Override
    public PilotingRollData addEntityBonuses(PilotingRollData prd) {
        // this is a control roll. Affected by:
        // avionics damage
    	// partial repairs
        // pilot damage
        // current velocity
<span class="nc" id="L2615">        int avihits = getAvionicsHits();</span>
<span class="nc" id="L2616">        int pilothits = getCrew().getHits();</span>

<span class="nc bnc" id="L2618" title="All 4 branches missed.">        if ((avihits &gt; 0) &amp;&amp; (avihits &lt; 3)) {</span>
<span class="nc" id="L2619">            prd.addModifier(avihits, &quot;Avionics Damage&quot;);</span>
        }

        // this should probably be replaced with some kind of AVI_DESTROYED
        // boolean
<span class="nc bnc" id="L2624" title="All 2 branches missed.">        if (avihits &gt;= 3) {</span>
<span class="nc" id="L2625">            prd.addModifier(5, &quot;Avionics Destroyed&quot;);</span>
        }

        // partial repairs to avionics system, but only if the avionics aren't already destroyed
<span class="nc bnc" id="L2629" title="All 4 branches missed.">        if ((getPartialRepairs() != null) &amp;&amp; (avihits &lt; 3)) {</span>
<span class="nc bnc" id="L2630" title="All 2 branches missed.">            if (getPartialRepairs().booleanOption(&quot;aero_avionics_crit&quot;)) {</span>
<span class="nc" id="L2631">                prd.addModifier(1, &quot;Partial repair of Avionics&quot;);</span>
            }
<span class="nc bnc" id="L2633" title="All 2 branches missed.">            if (getPartialRepairs().booleanOption(&quot;aero_avionics_replace&quot;)) {</span>
<span class="nc" id="L2634">                prd.addModifier(1, &quot;Misreplaced Avionics&quot;);</span>
            }
        }

<span class="nc bnc" id="L2638" title="All 2 branches missed.">        if (pilothits &gt; 0) {</span>
<span class="nc" id="L2639">            prd.addModifier(pilothits, &quot;Pilot Hits&quot;);</span>
        }

        // movement effects
        // some question as to whether &quot;above safe thrust&quot; applies to thrust or
        // velocity
        // I will treat it as thrust until it is resolved
<span class="nc bnc" id="L2646" title="All 2 branches missed.">        if (moved == EntityMovementType.MOVE_OVER_THRUST) {</span>
<span class="nc" id="L2647">            prd.addModifier(+1, &quot;Used more than safe thrust&quot;);</span>
        }
<span class="nc" id="L2649">        int vel = getCurrentVelocity();</span>
<span class="nc" id="L2650">        int vmod = vel - (2 * getWalkMP());</span>
<span class="nc bnc" id="L2651" title="All 4 branches missed.">        if (!getGame().getBoard().inSpace() &amp;&amp; (vmod &gt; 0)) {</span>
<span class="nc" id="L2652">            prd.addModifier(vmod, &quot;Velocity greater than 2x safe thrust&quot;);</span>
        }

<span class="nc" id="L2655">        int atmoCond = game.getPlanetaryConditions().getAtmosphere();</span>
        // add in atmospheric effects later
<span class="nc bnc" id="L2657" title="All 6 branches missed.">        if (!(game.getBoard().inSpace() || (atmoCond == PlanetaryConditions.ATMO_VACUUM)) &amp;&amp; isAirborne()) {</span>
<span class="nc" id="L2658">            prd.addModifier(+2, &quot;Atmospheric operations&quot;);</span>

            // check type
<span class="nc bnc" id="L2661" title="All 2 branches missed.">            if (this instanceof Dropship) {</span>
<span class="nc bnc" id="L2662" title="All 2 branches missed.">                if (isSpheroid()) {</span>
<span class="nc" id="L2663">                    prd.addModifier(+1, &quot;spheroid dropship&quot;);</span>
                } else {
<span class="nc" id="L2665">                    prd.addModifier(0, &quot;aerodyne dropship&quot;);</span>
                }
            } else {
<span class="nc" id="L2668">                prd.addModifier(-1, &quot;fighter/small craft&quot;);</span>
            }
        }

        // life support (only applicable to non-ASFs
<span class="nc bnc" id="L2673" title="All 2 branches missed.">        if (!hasLifeSupport()) {</span>
<span class="nc" id="L2674">            prd.addModifier(+2, &quot;No life support&quot;);</span>
        }

<span class="nc bnc" id="L2677" title="All 2 branches missed.">        if (hasModularArmor()) {</span>
<span class="nc" id="L2678">            prd.addModifier(1, &quot;Modular Armor&quot;);</span>
        }
        // VDNI bonus?
<span class="nc bnc" id="L2681" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L2682" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L2683">            prd.addModifier(-1, &quot;VDNI&quot;);</span>
        }

        // Small/torso-mounted cockpit penalty?
<span class="nc bnc" id="L2687" title="All 2 branches missed.">        if ((getCockpitType() == Aero.COCKPIT_SMALL)</span>
<span class="nc bnc" id="L2688" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)</span>
<span class="nc bnc" id="L2689" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.UNOFF_SMALL_PILOT)) {</span>
<span class="nc" id="L2690">            prd.addModifier(1, &quot;Small Cockpit&quot;);</span>
        }

        // quirks?
<span class="nc bnc" id="L2694" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_ATMO_FLYER) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L2695">            prd.addModifier(-1, &quot;atmospheric flyer&quot;);</span>
        }
<span class="nc bnc" id="L2697" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_ATMO_INSTABILITY) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L2698">            prd.addModifier(+1, &quot;atmospheric flight instability&quot;);</span>
        }
<span class="nc bnc" id="L2700" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_CRAMPED_COCKPIT) &amp;&amp; !hasAbility(OptionsConstants.UNOFF_SMALL_PILOT)) {</span>
<span class="nc" id="L2701">            prd.addModifier(1, &quot;cramped cockpit&quot;);</span>
        }

<span class="nc" id="L2704">        return prd;</span>
    }

    @Override
    public Vector&lt;Report&gt; victoryReport() {
<span class="nc" id="L2709">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>

<span class="nc" id="L2711">        Report r = new Report(7025);</span>
<span class="nc" id="L2712">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L2713">        r.addDesc(this);</span>
<span class="nc" id="L2714">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L2716" title="All 4 branches missed.">        if (((getEntityType() &amp; Entity.ETYPE_DROPSHIP) == 0) || ((getEntityType() &amp; Entity.ETYPE_SMALL_CRAFT) == 0)</span>
<span class="nc bnc" id="L2717" title="All 2 branches missed.">                || ((getEntityType() &amp; Entity.ETYPE_FIGHTER_SQUADRON) == 0)</span>
<span class="nc bnc" id="L2718" title="All 2 branches missed.">                || ((getEntityType() &amp; Entity.ETYPE_JUMPSHIP) == 0)</span>
<span class="nc bnc" id="L2719" title="All 2 branches missed.">                || ((getEntityType() &amp; Entity.ETYPE_SPACE_STATION) == 0)) {</span>
<span class="nc" id="L2720">            r = new Report(7036);</span>
        } else {
<span class="nc" id="L2722">            r = new Report(7030);</span>
        }
<span class="nc" id="L2724">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L2725">        r.newlines = 0;</span>
<span class="nc" id="L2726">        vDesc.addElement(r);</span>
<span class="nc" id="L2727">        vDesc.addAll(getCrew().getDescVector(false));</span>
<span class="nc" id="L2728">        r = new Report(7070, Report.PUBLIC);</span>
<span class="nc" id="L2729">        r.add(getKillNumber());</span>
<span class="nc" id="L2730">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L2732" title="All 2 branches missed.">        if (isDestroyed()) {</span>
<span class="nc" id="L2733">            Entity killer = game.getEntity(killerId);</span>
<span class="nc bnc" id="L2734" title="All 2 branches missed.">            if (killer == null) {</span>
<span class="nc" id="L2735">                killer = game.getOutOfGameEntity(killerId);</span>
            }
<span class="nc bnc" id="L2737" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L2738">                r = new Report(7072, Report.PUBLIC);</span>
<span class="nc" id="L2739">                r.addDesc(killer);</span>
            } else {
<span class="nc bnc" id="L2741" title="All 2 branches missed.">                if (this instanceof FighterSquadron) {</span>
<span class="nc" id="L2742">                    r = new Report(7076, Report.PUBLIC);</span>
                } else {
<span class="nc" id="L2744">                    r = new Report(7073, Report.PUBLIC);</span>
                }
            }
<span class="nc" id="L2747">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L2748" title="All 2 branches missed.">        } else if (getCrew().isEjected()) {</span>
<span class="nc" id="L2749">            r = new Report(7074, Report.PUBLIC);</span>
<span class="nc" id="L2750">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L2752">        r.newlines = 2;</span>

<span class="nc" id="L2754">        return vDesc;</span>
    }

    @Override
    public int[] getNoOfSlots() {
<span class="fc" id="L2759">        return NUM_OF_SLOTS;</span>
    }

    /**
     * Fighters don't have MASC
     */
    @Override
    public int getRunMPwithoutMASC(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
<span class="nc" id="L2767">        return getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    @Override
    public int getRunMP(boolean gravity, boolean ignoreheat, boolean ignoremodulararmor) {
        // if aeros are on the ground, they can only move at cruising speed
<span class="nc bnc" id="L2773" title="All 2 branches missed.">        if (!isAirborne()) {</span>
<span class="nc" id="L2774">            return getWalkMP(gravity, ignoreheat, ignoremodulararmor);</span>
        }
<span class="nc" id="L2776">        return super.getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    @Override
    public int getHeatCapacity(boolean includeRadicalHeatSink) {
<span class="nc" id="L2781">        int capacity = (getHeatSinks() * (getHeatType() + 1));</span>
<span class="nc bnc" id="L2782" title="All 4 branches missed.">        if (includeRadicalHeatSink &amp;&amp; hasWorkingMisc(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L2783">            capacity += Math.ceil(getHeatSinks() * 0.4);</span>
        }
<span class="nc" id="L2785">        return capacity;</span>
    }

    // If the aero is in the water, it is dead so no worries
    @Override
    public int getHeatCapacityWithWater() {
<span class="nc" id="L2791">        return getHeatCapacity(false);</span>
    }

    @Override
    public int getEngineCritHeat() {
        // Engine hits cause excess heat for fighters, TW pg 240
<span class="nc bnc" id="L2797" title="All 4 branches missed.">        if (!((this instanceof SmallCraft) || (this instanceof Jumpship))) {</span>
<span class="nc" id="L2798">            return 2 * getEngineHits();</span>
        } else {
<span class="nc" id="L2800">            return 0;</span>
        }
    }

    @Override
    public void autoSetInternal() {
        // should be no internals because only one SI
        // It doesn't seem to be screwing anything up yet.
        // Need to figure out how destruction of entity is determined
<span class="nc" id="L2809">        int nInternal = (int) Math.ceil(weight / 10.0);</span>
<span class="nc" id="L2810">        nInternal = 0;</span>
        // I need to look at safe thrust as well at some point

<span class="nc bnc" id="L2813" title="All 2 branches missed.">        for (int x = 0; x &lt; locations(); x++) {</span>
<span class="nc" id="L2814">            initializeInternal(nInternal, x);</span>
        }
<span class="nc" id="L2816">    }</span>

    // initialize the Damage threshold
    public void autoSetThresh() {
<span class="nc bnc" id="L2820" title="All 2 branches missed.">        for (int x = 0; x &lt; locations(); x++) {</span>
<span class="nc" id="L2821">            initializeThresh(x);</span>
        }
<span class="nc" id="L2823">    }</span>

    public void setThresh(int val, int loc) {
<span class="nc bnc" id="L2826" title="All 2 branches missed.">        if (loc &lt; damThresh.length) {</span>
<span class="nc" id="L2827">            damThresh[loc] = val;</span>
        }
<span class="nc" id="L2829">    }</span>

    public void initializeThresh(int loc) {
<span class="nc" id="L2832">        int nThresh = (int) Math.ceil(getArmor(loc) / 10.0);</span>
<span class="nc" id="L2833">        setThresh(nThresh, loc);</span>
<span class="nc" id="L2834">    }</span>

    @Override
    public int getThresh(int loc) {
<span class="nc bnc" id="L2838" title="All 2 branches missed.">        if (isCapitalFighter()) {</span>
<span class="nc bnc" id="L2839" title="All 4 branches missed.">            if ((null != game) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc bnc" id="L2840" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_VARIABLE_DAMAGE_THRESH)) {</span>
<span class="nc" id="L2841">                    return (int) Math.round(getCapArmor() / 40.0) + 1;</span>
                } else {
<span class="nc" id="L2843">                    return (int) Math.round(getCap0Armor() / 40.0) + 1;</span>
                }
            } else {
<span class="nc" id="L2846">                return 2;</span>
            }
<span class="nc bnc" id="L2848" title="All 2 branches missed.">        } else if (loc &lt; damThresh.length) {</span>
<span class="nc" id="L2849">            return damThresh[loc];</span>
        }
<span class="nc" id="L2851">        return 0;</span>
    }

    /**
     * Determine if the unit can be repaired, or only harvested for spares.
     *
     * @return A &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit can
     *         be repaired (given enough time and parts); if this value is
     *         &lt;code&gt;false&lt;/code&gt;, the unit is only a source of spares.
     * @see Entity#isSalvage()
     */
    @Override
    public boolean isRepairable() {
<span class="nc" id="L2864">        return true; // deal with this later</span>
    }

    @Override
    public boolean canCharge() {
        // ramming is resolved differently than charging
<span class="nc" id="L2870">        return false;</span>
    }

    @Override
    public boolean canDFA() {
        // Aero can't DFA
<span class="nc" id="L2876">        return false;</span>
    }

    @Override
    public boolean canRam() {
<span class="nc bnc" id="L2881" title="All 4 branches missed.">        return !isImmobile() &amp;&amp; (getWalkMP() &gt; 0);</span>
    }

    /**
     * @return suspension factor of vehicle
     */
    // Doesn't really do anything so just return 0
    public int getSuspensionFactor() {
<span class="nc" id="L2889">        return 0;</span>
    }

    /**
     * There is a mistake in some of the AT2r costs for some reason they added
     * ammo twice for a lot of the level 2 designs, leading to costs that are
     * too high
     */
    @Override
    public double getCost(boolean ignoreAmmo) {

<span class="nc" id="L2900">        double cost = 0;</span>

        // add in cockpit
<span class="nc" id="L2903">        cost += 200000 + 50000 + (2000 * weight);</span>

        // Structural integrity
<span class="nc" id="L2906">        cost += 50000 * getSI();</span>

        // additional flight systems (attitude thruster and landing gear)
<span class="nc" id="L2909">        cost += 25000 + (10 * getWeight());</span>

        // engine
<span class="nc bnc" id="L2912" title="All 2 branches missed.">        if (hasEngine()) {</span>
<span class="nc" id="L2913">            cost += (getEngine().getBaseCost() * getEngine().getRating() * weight) / 75.0;</span>
        }

        // fuel tanks
<span class="nc" id="L2917">        cost += (200 * getFuel()) / 80.0;</span>

        // armor
<span class="nc bnc" id="L2920" title="All 2 branches missed.">        if (hasPatchworkArmor()) {</span>
<span class="nc bnc" id="L2921" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L2922">                cost += getArmorWeight(loc) * EquipmentType.getArmorCost(armorType[loc]);</span>
            }

        } else {
<span class="nc" id="L2926">            cost += getArmorWeight() * EquipmentType.getArmorCost(armorType[0]);</span>
        }

        // heat sinks
<span class="nc" id="L2930">        int sinkCost = 2000 + (4000 * getHeatType());// == HEAT_DOUBLE ? 6000:</span>
        // 2000;
<span class="nc" id="L2932">        cost += sinkCost * getHeatSinks();</span>

        // weapons
<span class="nc" id="L2935">        cost += getWeaponsAndEquipmentCost(ignoreAmmo);</span>

<span class="nc" id="L2937">        return Math.round(cost * getPriceMultiplier());</span>
    }

    @Override
    public double getPriceMultiplier() {
<span class="nc" id="L2942">        double priceModifier = 1.0;</span>
<span class="nc bnc" id="L2943" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L2944">            priceModifier *= 1.25f;</span>
        }
<span class="nc" id="L2946">        priceModifier *= 1 + (weight / 200f);</span>
<span class="nc" id="L2947">        return priceModifier;</span>
    }

    @Override
    protected int implicitClanCASE() {
<span class="nc bnc" id="L2952" title="All 4 branches missed.">        if (!isClan() || !isFighter()) {</span>
<span class="nc" id="L2953">            return 0;</span>
        }
        // Ammo is actually supposed to be assigned to a fuselage location rather than one of the four
        // weapon arcs. We will use LOC_NONE to record the existence of non-weapon explosive equipment.
<span class="nc" id="L2957">        Set&lt;Integer&gt; caseLocations = new HashSet&lt;&gt;();</span>
<span class="nc" id="L2958">        int explicit = 0;</span>
<span class="nc bnc" id="L2959" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L2960" title="All 4 branches missed.">            if ((m.getType() instanceof MiscType) &amp;&amp; (m.getType().hasFlag(MiscType.F_CASE))) {</span>
<span class="nc" id="L2961">                explicit++;</span>
<span class="nc bnc" id="L2962" title="All 2 branches missed.">            } else if (m.getType().isExplosive(m)) {</span>
<span class="nc bnc" id="L2963" title="All 2 branches missed.">                if (m.getType() instanceof WeaponType) {</span>
<span class="nc" id="L2964">                    caseLocations.add(m.getLocation());</span>
                } else {
<span class="nc" id="L2966">                    caseLocations.add(LOC_NONE);</span>
                }
            }
<span class="nc" id="L2969">        }</span>
<span class="nc" id="L2970">        return Math.max(0, caseLocations.size() - explicit);</span>
    }

    @Override
    public boolean doomedInExtremeTemp() {
<span class="nc" id="L2975">        return false;</span>
    }

    @Override
    public boolean doomedInVacuum() {
<span class="nc" id="L2980">        return false;</span>
    }

    @Override
    public boolean doomedOnGround() {
<span class="nc bnc" id="L2985" title="All 2 branches missed.">        return !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_GROUND_MOVE);</span>
    }

    @Override
    public boolean doomedInAtmosphere() {
<span class="nc" id="L2990">        return false;</span>
    }

    @Override
    public boolean doomedInSpace() {
<span class="nc" id="L2995">        return false;</span>
    }

    @Override
    public boolean canGoHullDown() {
<span class="nc" id="L3000">        return false;</span>
    }

    /*
     * public void addMovementDamage(int level) { movementDamage += level; }
     */

    @Override
    public void setEngine(Engine e) {
<span class="nc" id="L3009">        super.setEngine(e);</span>
<span class="nc bnc" id="L3010" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().engineValid) {</span>
<span class="nc" id="L3011">            setOriginalWalkMP(calculateWalk());</span>
        }
<span class="nc" id="L3013">    }</span>

    /**
     * Returns the percent of the SI remaining
     */
    @Override
    public double getInternalRemainingPercent() {
<span class="nc" id="L3020">        return ((double) getSI() / (double) get0SI());</span>
    }

    protected int calculateWalk() {
<span class="nc bnc" id="L3024" title="All 2 branches missed.">        if (!hasEngine()) {</span>
<span class="nc" id="L3025">            return 0;</span>
        }
<span class="nc bnc" id="L3027" title="All 2 branches missed.">        if (isPrimitive()) {</span>
<span class="nc" id="L3028">            double rating = getEngine().getRating();</span>
<span class="nc" id="L3029">            rating /= 1.2;</span>
<span class="nc bnc" id="L3030" title="All 2 branches missed.">            if ((rating % 5) != 0) {</span>
<span class="nc" id="L3031">                return (int) (((rating - (rating % 5)) + 5) / (int) weight) + 2;</span>
            }
<span class="nc" id="L3033">            return (int) (rating / (int) weight) + 2;</span>
        }
<span class="nc" id="L3035">        return (getEngine().getRating() / (int) weight) + 2;</span>
    }

    @Override
    public boolean isNuclearHardened() {
<span class="nc" id="L3040">        return true;</span>
    }

    @Override
    public void addEquipment(Mounted mounted, int loc, boolean rearMounted) throws LocationFullException {
<span class="pc bpc" id="L3045" title="1 of 2 branches missed.">        if (getEquipmentNum(mounted) == -1) {</span>
<span class="fc" id="L3046">            super.addEquipment(mounted, loc, rearMounted);</span>
        }
        // Add the piece equipment to our slots.
<span class="fc" id="L3049">        addCritical(loc, new CriticalSlot(mounted));</span>
<span class="fc" id="L3050">    }</span>

    /**
     * get the type of critical caused by a critical roll, taking account of
     * existing damage
     *
     * @param roll
     *            the final dice roll
     * @param target
     *            the hit location
     * @return a critical type
     */
    public int getCriticalEffect(int roll, int target) {
        // just grab the latest potential crit
<span class="nc bnc" id="L3064" title="All 2 branches missed.">        if (roll &lt; target) {</span>
<span class="nc" id="L3065">            return CRIT_NONE;</span>
        }

<span class="nc" id="L3068">        int critical = getPotCrit();</span>
<span class="nc" id="L3069">        return critical;</span>
    }

    /**

     */
    @Override
    public void setOmni(boolean omni) {

        // Perform the superclass' action.
<span class="nc" id="L3079">        super.setOmni(omni);</span>

<span class="nc" id="L3081">    }</span>

    /**
     * Adds clan CASE in every location
     */
    public void addClanCase() {
<span class="nc" id="L3087">        boolean explosiveFound = false;</span>
<span class="nc" id="L3088">        EquipmentType clCase = EquipmentType.get(EquipmentTypeLookup.CLAN_CASE);</span>
<span class="nc bnc" id="L3089" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
            // Ignore wings location: it's not a valid loc to put equipment in
<span class="nc bnc" id="L3091" title="All 2 branches missed.">            if (i == LOC_WINGS) {</span>
<span class="nc" id="L3092">                continue;</span>
            }
<span class="nc" id="L3094">            explosiveFound = false;</span>
<span class="nc bnc" id="L3095" title="All 2 branches missed.">            for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L3096" title="All 4 branches missed.">                if (m.getType().isExplosive(m) &amp;&amp; (m.getLocation() == i)) {</span>
<span class="nc" id="L3097">                    explosiveFound = true;</span>
                }
<span class="nc" id="L3099">            }</span>
<span class="nc bnc" id="L3100" title="All 2 branches missed.">            if (explosiveFound) {</span>
                try {
<span class="nc" id="L3102">                    addEquipment(new Mounted(this, clCase), i, false);</span>
<span class="nc" id="L3103">                } catch (LocationFullException ex) {</span>
                    // um, that's impossible.
<span class="nc" id="L3105">                }</span>
            }
        }

<span class="nc" id="L3109">    }</span>

    /**
     * check to see if case is available anywhere
     *
     * @return
     */
    @Override
    public boolean hasCase() {

<span class="nc" id="L3119">        boolean hasCase = false;</span>

<span class="nc bnc" id="L3121" title="All 2 branches missed.">        for (int x = 0; x &lt; locations(); x++) {</span>
<span class="nc bnc" id="L3122" title="All 2 branches missed.">            if (!hasCase) {</span>
<span class="nc" id="L3123">                hasCase = locationHasCase(x);</span>
            }
        }
<span class="nc" id="L3126">        return hasCase;</span>
    }

    /**
     * Used to determine net velocity of ramming attack
     *
     */
    @Override
    public int sideTableRam(Coords src) {
<span class="nc" id="L3135">        int side = super.sideTableRam(src);</span>
<span class="nc bnc" id="L3136" title="All 4 branches missed.">        if (game.useVectorMove() &amp;&amp; game.getBoard().inSpace()) {</span>
<span class="nc" id="L3137">            int newside = chooseSideRam(src);</span>
<span class="nc bnc" id="L3138" title="All 2 branches missed.">            if (newside != -1) {</span>
<span class="nc" id="L3139">                side = newside;</span>
            }
        }
<span class="nc" id="L3142">        return side;</span>

    }

    public int chooseSideRam(Coords src) {
        // loop through directions and if we have a non-zero vector, then
        // compute
        // the targetsidetable. If we come to a higher vector, then replace. If
        // we come to an equal vector then take it if it is better
<span class="nc" id="L3151">        int thrust = 0;</span>
<span class="nc" id="L3152">        int high = -1;</span>
<span class="nc" id="L3153">        int side = -1;</span>
<span class="nc bnc" id="L3154" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L3155">            thrust = getVector(dir);</span>
<span class="nc bnc" id="L3156" title="All 2 branches missed.">            if (thrust == 0) {</span>
<span class="nc" id="L3157">                continue;</span>
            }

<span class="nc bnc" id="L3160" title="All 2 branches missed.">            if (thrust &gt; high) {</span>
<span class="nc" id="L3161">                high = thrust;</span>
<span class="nc" id="L3162">                side = sideTableRam(src, dir);</span>
            }

            // what if they tie
<span class="nc bnc" id="L3166" title="All 2 branches missed.">            if (thrust == high) {</span>
<span class="nc" id="L3167">                int newside = sideTableRam(src, dir);</span>
                // choose the better
<span class="nc bnc" id="L3169" title="All 2 branches missed.">                if (newside &gt; side) {</span>
<span class="nc" id="L3170">                    newside = side;</span>
                }
                // that should be the only case, because it can't shift you from
                // front
                // to aft or vice-versa
            }

        }
<span class="nc" id="L3178">        return side;</span>
    }

    public int getMaxEngineHits() {
<span class="fc" id="L3182">        return 3;</span>
    }

    @Override
    public int getMaxElevationChange() {
<span class="nc bnc" id="L3187" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc" id="L3188">            return UNLIMITED_JUMP_DOWN;</span>
        }
<span class="nc" id="L3190">        return 1;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthActive() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L3206" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L3207">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L3208" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>

<span class="nc bnc" id="L3210" title="All 4 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;) &amp;&amp; hasActiveECM()) {</span>
                    // Return true if the mode is &quot;On&quot; and ECM is working
<span class="nc" id="L3212">                    return true;</span>
                }
            }
<span class="nc" id="L3215">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L3217">        return false;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthOn() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L3233" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L3234">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L3235" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>
<span class="nc bnc" id="L3236" title="All 2 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;)) {</span>
                    // Return true if the mode is &quot;On&quot;
<span class="nc" id="L3238">                    return true;</span>
                }
            }
<span class="nc" id="L3241">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L3243">        return false;</span>
    }

    /**
     * Determine the stealth modifier for firing at this unit from the given
     * range. If the value supplied for &lt;code&gt;range&lt;/code&gt; is not one of the
     * &lt;code&gt;Entity&lt;/code&gt; class range constants, an
     * &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @param range
     *            - an &lt;code&gt;int&lt;/code&gt; value that must match one of the
     *            &lt;code&gt;Compute&lt;/code&gt; class range constants.
     * @param ae
     *            - entity making the attack
     * @return a &lt;code&gt;TargetRoll&lt;/code&gt; value that contains the stealth
     *         modifier for the given range.
     */
    @Override
    public TargetRoll getStealthModifier(int range, Entity ae) {
<span class="nc" id="L3264">        TargetRoll result = null;</span>

        // Stealth or null sig must be active.
<span class="nc bnc" id="L3267" title="All 2 branches missed.">        if (!isStealthActive()) {</span>
<span class="nc" id="L3268">            result = new TargetRoll(0, &quot;stealth not active&quot;);</span>
        }
        // Determine the modifier based upon the range.
        // Infantry do not ignore Chameleon LPS!!!
        else {
<span class="nc bnc" id="L3273" title="All 5 branches missed.">            switch (range) {</span>
            case RangeType.RANGE_MINIMUM:
            case RangeType.RANGE_SHORT:
<span class="nc bnc" id="L3276" title="All 2 branches missed.">                if (!ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3277">                    result = new TargetRoll(0, &quot;stealth&quot;);</span>
                } else {
<span class="nc" id="L3279">                    result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                }
<span class="nc" id="L3281">                break;</span>
            case RangeType.RANGE_MEDIUM:
<span class="nc bnc" id="L3283" title="All 2 branches missed.">                if (!ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3284">                    result = new TargetRoll(1, &quot;stealth&quot;);</span>
                } else {
<span class="nc" id="L3286">                    result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                }
<span class="nc" id="L3288">                break;</span>
            case RangeType.RANGE_LONG:
            case RangeType.RANGE_EXTREME:
            case RangeType.RANGE_LOS:
<span class="nc bnc" id="L3292" title="All 2 branches missed.">                if (!ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3293">                    result = new TargetRoll(2, &quot;stealth&quot;);</span>
                } else {
<span class="nc" id="L3295">                    result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                }
<span class="nc" id="L3297">                break;</span>
            case RangeType.RANGE_OUT:
<span class="nc" id="L3299">                break;</span>
            default:
<span class="nc" id="L3301">                throw new IllegalArgumentException(&quot;Unknown range constant: &quot; + range);</span>
            }
        }

        // Return the result.
<span class="nc" id="L3306">        return result;</span>

    } // End public TargetRoll getStealthModifier( char )

    @Override
    public void setArmorType(int armType) {
<span class="fc" id="L3312">        setArmorType(armType, true);</span>
<span class="fc" id="L3313">    }</span>

    public void setArmorType(int armType, boolean addMount) {
<span class="fc" id="L3316">        super.setArmorType(armType);</span>
<span class="pc bpc" id="L3317" title="3 of 4 branches missed.">        if ((armType == EquipmentType.T_ARMOR_STEALTH_VEHICLE) &amp;&amp; addMount) {</span>
            try {
<span class="nc" id="L3319">                this.addEquipment(</span>
<span class="nc" id="L3320">                        EquipmentType.get(EquipmentType.getArmorTypeName(EquipmentType.T_ARMOR_STEALTH_VEHICLE, false)),</span>
                        LOC_AFT);
<span class="nc" id="L3322">            } catch (LocationFullException e) {</span>
                // this should never happen
<span class="nc" id="L3324">            }</span>
        }
<span class="fc" id="L3326">    }</span>

    @Override
    public boolean isLocationProhibited(Coords c, int currElevation) {
<span class="nc bnc" id="L3330" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc" id="L3331">            return false;</span>
        }

<span class="nc" id="L3334">        IHex hex = game.getBoard().getHex(c);</span>

        // Additional restrictions for hidden units
<span class="nc bnc" id="L3337" title="All 2 branches missed.">        if (isHidden()) {</span>
            // Can't deploy in paved hexes
<span class="nc bnc" id="L3339" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.PAVEMENT) || hex.containsTerrain(Terrains.ROAD)) {</span>
<span class="nc" id="L3340">                return true;</span>
            }
            // Can't deploy on a bridge
<span class="nc bnc" id="L3343" title="All 4 branches missed.">            if ((hex.terrainLevel(Terrains.BRIDGE_ELEV) == currElevation) &amp;&amp; hex.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L3344">                return true;</span>
            }
            // Can't deploy on the surface of water
<span class="nc bnc" id="L3347" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WATER) &amp;&amp; (currElevation == 0)) {</span>
<span class="nc" id="L3348">                return true;</span>
            }
        }

        // grounded aeros have the same prohibitions as wheeled tanks
<span class="nc bnc" id="L3353" title="All 4 branches missed.">        return hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L3354" title="All 4 branches missed.">                || ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L3355" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.RUBBLE) || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L3356" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.JUNGLE) || (hex.terrainLevel(Terrains.SNOW) &gt; 1)</span>
<span class="nc bnc" id="L3357" title="All 2 branches missed.">                || (hex.terrainLevel(Terrains.GEYSER) == 2);</span>
    }

    @Override
    public boolean isSpheroid() {
<span class="fc" id="L3362">        return spheroid;</span>
    }

    public void setSpheroid(boolean b) {
<span class="nc" id="L3366">        spheroid = b;</span>
<span class="nc" id="L3367">    }</span>

    @Override
    public int height() {
<span class="nc" id="L3371">        return 0;</span>
    }

    @Override
    public int getStraightMoves() {
<span class="fc" id="L3376">        return straightMoves;</span>
    }

    @Override
    public void setStraightMoves(int i) {
<span class="nc" id="L3381">        straightMoves = i;</span>
<span class="nc" id="L3382">    }</span>

    @Override
    public boolean isVSTOL() {
<span class="nc" id="L3386">        return vstol;</span>
    }

    @Override
    public boolean isSTOL() {
<span class="nc" id="L3391">        return false;</span>
    }

    public void setVSTOL(boolean b) {
<span class="nc" id="L3395">        vstol = b;</span>
<span class="nc" id="L3396">    }</span>

    @Override
    public boolean didFailManeuver() {
<span class="nc" id="L3400">        return failedManeuver;</span>
    }

    @Override
    public void setFailedManeuver(boolean b) {
<span class="nc" id="L3405">        failedManeuver = b;</span>
<span class="nc" id="L3406">    }</span>

    @Override
    public void setAccDecNow(boolean b) {
<span class="nc" id="L3410">        accDecNow = b;</span>
<span class="nc" id="L3411">    }</span>

    @Override
    public boolean didAccDecNow() {
<span class="nc" id="L3415">        return accDecNow;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getTotalCommGearTons()
     */
    @Override
    public int getTotalCommGearTons() {
<span class="nc" id="L3425">        return 1 + getExtraCommGearTons();</span>
    }

    /**
     * The number of critical slots that are destroyed in the component.
     */
    @Override
    public int getBadCriticals(int type, int index, int loc) {
<span class="nc" id="L3433">        return 0;</span>
    }

    public int getCockpitType() {
<span class="fc" id="L3437">        return cockpitType;</span>
    }

    public void setCockpitType(int type) {
<span class="nc" id="L3441">        cockpitType = type;</span>
<span class="nc bnc" id="L3442" title="All 2 branches missed.">        if (type == COCKPIT_COMMAND_CONSOLE) {</span>
<span class="nc" id="L3443">            setCrew(new Crew(CrewType.COMMAND_CONSOLE));</span>
        } else {
<span class="nc" id="L3445">            setCrew(new Crew(CrewType.SINGLE));</span>
        }
<span class="nc" id="L3447">    }</span>

    public String getCockpitTypeString() {
<span class="nc" id="L3450">        return Aero.getCockpitTypeString(getCockpitType());</span>
    }

    public static String getCockpitTypeString(int inCockpitType) {
<span class="nc bnc" id="L3454" title="All 4 branches missed.">        if ((inCockpitType &lt; 0) || (inCockpitType &gt;= COCKPIT_STRING.length)) {</span>
<span class="nc" id="L3455">            return &quot;Unknown&quot;;</span>
        }
<span class="nc" id="L3457">        return COCKPIT_STRING[inCockpitType];</span>
    }

    @Override
    public boolean hasCommandConsoleBonus() {
<span class="nc bnc" id="L3462" title="All 4 branches missed.">        return getCockpitType() == COCKPIT_COMMAND_CONSOLE &amp;&amp; getCrew().hasActiveCommandConsole()</span>
<span class="nc bnc" id="L3463" title="All 2 branches missed.">                &amp;&amp; getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY;</span>
    }

    @Override
    public double getArmorRemainingPercent() {
<span class="nc" id="L3468">        int armor0 = getTotalOArmor();</span>
<span class="nc" id="L3469">        int armor = getTotalArmor();</span>
<span class="nc bnc" id="L3470" title="All 2 branches missed.">        if (isCapitalFighter()) {</span>
<span class="nc" id="L3471">            armor0 = getCap0Armor();</span>
<span class="nc" id="L3472">            armor = getCapArmor();</span>
        }
<span class="nc bnc" id="L3474" title="All 2 branches missed.">        if (armor0 == 0) {</span>
<span class="nc" id="L3475">            return IArmorState.ARMOR_NA;</span>
        }
<span class="nc" id="L3477">        return ((double) armor / (double) armor0);</span>
    }

    /**
     * keep track of whether the wings have suffered a weapon critical hit
     */
    public boolean areWingsHit() {
<span class="nc" id="L3484">        return wingsHit;</span>
    }

    public void setWingsHit(boolean b) {
<span class="nc" id="L3488">        wingsHit = b;</span>
<span class="nc" id="L3489">    }</span>

    /**
     * what location is opposite the given one
     */
    public int getOppositeLocation(int loc) {
<span class="nc bnc" id="L3495" title="All 5 branches missed.">        switch (loc) {</span>
        case Aero.LOC_NOSE:
<span class="nc" id="L3497">            return Aero.LOC_AFT;</span>
        case Aero.LOC_LWING:
<span class="nc" id="L3499">            return Aero.LOC_RWING;</span>
        case Aero.LOC_RWING:
<span class="nc" id="L3501">            return Aero.LOC_LWING;</span>
        case Aero.LOC_AFT:
<span class="nc" id="L3503">            return Aero.LOC_NOSE;</span>
        default:
<span class="nc" id="L3505">            return Aero.LOC_NOSE;</span>
        }
    }

    /**
     * get modifications to the cluster hit table for critical hits
     */
    @Override
    public int getClusterMods() {
<span class="nc" id="L3514">        return -1 * (getFCSHits() + getSensorHits());</span>
    }

    /**
     * What's the range of the ECM equipment?
     *
     * @return the &lt;code&gt;int&lt;/code&gt; range of this unit's ECM. This value will be
     *         &lt;code&gt;Entity.NONE&lt;/code&gt; if no ECM is active.
     */
    @Override
    public int getECMRange() {
<span class="nc bnc" id="L3525" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</span>
<span class="nc bnc" id="L3526" title="All 2 branches missed.">                || !game.getBoard().inSpace()) {</span>
<span class="nc" id="L3527">            return super.getECMRange();</span>
        }
<span class="nc" id="L3529">        return Math.min(super.getECMRange(), 0);</span>
    }

    /**
     * @return the strength of the ECCM field this unit emits
     */
    @Override
    public double getECCMStrength() {
<span class="nc bnc" id="L3537" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</span>
<span class="nc bnc" id="L3538" title="All 2 branches missed.">                || !game.getBoard().inSpace()) {</span>
<span class="nc" id="L3539">            return super.getECCMStrength();</span>
        }
<span class="nc bnc" id="L3541" title="All 2 branches missed.">        if (hasActiveECCM()) {</span>
<span class="nc" id="L3542">            return 1;</span>
        }
<span class="nc" id="L3544">        return 0;</span>
    }

    public void setECCMRoll(int i) {
<span class="nc" id="L3548">        eccmRoll = i;</span>
<span class="nc" id="L3549">    }</span>

    public int getECCMRoll() {
<span class="nc" id="L3552">        return eccmRoll;</span>
    }

    public int getECCMTarget() {
<span class="nc" id="L3556">        return getCrew().getPiloting() + getSensorHits() + getCICHits() + getFCSHits();</span>
    }

    public int getECCMBonus() {
<span class="nc" id="L3560">        return Math.max(0, eccmRoll - getECCMTarget());</span>
    }

    /**
     * @return is the crew of this vessel protected from gravitational effects,
     *         see StratOps, pg. 36
     */
    public boolean isCrewProtected() {
<span class="nc" id="L3568">        return true;</span>
    }

    public int getGravSecondaryThreshold() {
<span class="nc" id="L3572">        int thresh = 6;</span>
<span class="nc bnc" id="L3573" title="All 2 branches missed.">        if (isCrewProtected()) {</span>
<span class="nc" id="L3574">            thresh = 12;</span>
        }
        // TODO: clan phenotypes
<span class="nc" id="L3577">        return thresh;</span>
    }

    public int getGravPrimaryThreshold() {
<span class="nc" id="L3581">        int thresh = 12;</span>
<span class="nc bnc" id="L3582" title="All 2 branches missed.">        if (isCrewProtected()) {</span>
<span class="nc" id="L3583">            thresh = 22;</span>
        }
        // TODO: clan phenotypes
<span class="nc" id="L3586">        return thresh;</span>
    }

    /**
     * Determines if this object can accept the given unit. The unit may not be
     * of the appropriate type or there may be no room for the unit.
     *
     * @param unit
     *            - the &lt;code&gt;Entity&lt;/code&gt; to be loaded.
     * @return &lt;code&gt;true&lt;/code&gt; if the unit can be loaded, &lt;code&gt;false&lt;/code&gt;
     *         otherwise.
     */
    @Override
    public boolean canLoad(Entity unit, boolean checkFalse) {
        // capital fighters can load other capital fighters (becoming squadrons)
        // but not in the deployment phase
<span class="nc bnc" id="L3602" title="All 8 branches missed.">        if (isCapitalFighter() &amp;&amp; !unit.isEnemyOf(this) &amp;&amp; unit.isCapitalFighter() &amp;&amp; (getId() != unit.getId())</span>
<span class="nc bnc" id="L3603" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3604">            return true;</span>
        }

<span class="nc" id="L3607">        return super.canLoad(unit, checkFalse);</span>
    }

    @Override
    public Map&lt;String, Integer&gt; getWeaponGroups() {
<span class="nc" id="L3612">        return weaponGroups;</span>
    }

    /**
     * Iterate through current weapons and count the number in each capital
     * fighter location.
     *
     * @return A map with keys in the format &quot;weaponName:loc&quot;, with the number
     *         of weapons of that type in that location as the value.
     */
    @Override
    public Map&lt;String, Integer&gt; groupWeaponsByLocation() {
<span class="nc" id="L3624">        Map&lt;String, Integer&gt; groups = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L3625" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc" id="L3626">            int loc = mounted.getLocation();</span>
<span class="nc bnc" id="L3627" title="All 6 branches missed.">            if (isFighter() &amp;&amp; ((loc == Aero.LOC_RWING) || (loc == Aero.LOC_LWING))) {</span>
<span class="nc" id="L3628">                loc = Aero.LOC_WINGS;</span>
            }
<span class="nc bnc" id="L3630" title="All 2 branches missed.">            if (mounted.isRearMounted()) {</span>
<span class="nc" id="L3631">                loc = Aero.LOC_AFT;</span>
            }
<span class="nc" id="L3633">            String key = mounted.getType().getInternalName() + &quot;:&quot; + loc;</span>
<span class="nc bnc" id="L3634" title="All 2 branches missed.">            if (null == groups.get(key)) {</span>
<span class="nc" id="L3635">                groups.put(key, mounted.getNWeapons());</span>
            } else {
<span class="nc" id="L3637">                groups.put(key, groups.get(key) + mounted.getNWeapons());</span>
            }
<span class="nc" id="L3639">        }</span>
<span class="nc" id="L3640">        return groups;</span>
    }

    /**
     * In cases where another unit occupies the same hex, determine if this Aero
     * should be moved back a hex for targeting purposes
     *
     * @param other
     * @return
     */
    public boolean shouldMoveBackHex(Aero other) {
<span class="nc bnc" id="L3651" title="All 2 branches missed.">        if (null == getPosition()) {</span>
<span class="nc" id="L3652">            return false;</span>
        }
<span class="nc bnc" id="L3654" title="All 2 branches missed.">        if (null == other.getPosition()) {</span>
<span class="nc" id="L3655">            return false;</span>
        }
<span class="nc bnc" id="L3657" title="All 2 branches missed.">        if (!getPosition().equals(other.getPosition())) {</span>
<span class="nc" id="L3658">            return false;</span>
        }
<span class="nc" id="L3660">        int type = this.getUnitType();</span>
<span class="nc" id="L3661">        int otherType = other.getUnitType();</span>
<span class="nc" id="L3662">        int vel = getCurrentVelocity();</span>
<span class="nc" id="L3663">        int otherVel = other.getCurrentVelocity();</span>
<span class="nc bnc" id="L3664" title="All 2 branches missed.">        if (type &gt; otherType) {</span>
<span class="nc" id="L3665">            return false;</span>
<span class="nc bnc" id="L3666" title="All 2 branches missed.">        } else if (type &lt; otherType) {</span>
<span class="nc" id="L3667">            return true;</span>
        }
        // if we are still here then type is the same so compare velocity
<span class="nc bnc" id="L3670" title="All 2 branches missed.">        if (vel &lt; otherVel) {</span>
<span class="nc" id="L3671">            return false;</span>
<span class="nc bnc" id="L3672" title="All 2 branches missed.">        } else if (vel &gt; otherVel) {</span>
<span class="nc" id="L3673">            return true;</span>
        }
        // if we are still here then type and velocity same, so roll for it
<span class="nc bnc" id="L3676" title="All 2 branches missed.">        if (getWhoFirst() &lt; other.getWhoFirst()) {</span>
<span class="nc" id="L3677">            return false;</span>
        }
<span class="nc" id="L3679">        return true;</span>
    }

    @Override
    public boolean hasArmoredEngine() {
<span class="nc bnc" id="L3684" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(LOC_AFT); slot++) {</span>
<span class="nc" id="L3685">            CriticalSlot cs = getCritical(LOC_AFT, slot);</span>
<span class="nc bnc" id="L3686" title="All 6 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM) &amp;&amp; (cs.getIndex() == Mech.SYSTEM_ENGINE)) {</span>
<span class="nc" id="L3687">                return cs.isArmored();</span>
            }
        }
<span class="nc" id="L3690">        return false;</span>
    }

    /**
     * see {@link Entity#getForwardArc()}
     */
    @Override
    public int getForwardArc() {
<span class="nc" id="L3698">        return Compute.ARC_NOSE;</span>
    }

    /**
     * see {@link Entity#getRearArc()}
     */
    @Override
    public int getRearArc() {
<span class="nc" id="L3706">        return Compute.ARC_AFT;</span>
    }

    @Override
    public int getAltLoss() {
<span class="nc" id="L3711">        return altLoss;</span>
    }

    @Override
    public void setAltLoss(int i) {
<span class="nc" id="L3716">        altLoss = i;</span>
<span class="nc" id="L3717">    }</span>

    @Override
    public void resetAltLoss() {
<span class="nc" id="L3721">        altLoss = 0;</span>
<span class="nc" id="L3722">    }</span>

    @Override
    public int getAltLossThisRound() {
<span class="nc" id="L3726">        return altLossThisRound;</span>
    }

    @Override
    public void setAltLossThisRound(int i) {
<span class="nc" id="L3731">        altLossThisRound = i;</span>
<span class="nc" id="L3732">    }</span>

    @Override
    public void resetAltLossThisRound() {
<span class="nc" id="L3736">        altLossThisRound = 0;</span>
<span class="nc" id="L3737">    }</span>

    @Override
    public int getElevation() {
<span class="pc bpc" id="L3741" title="2 of 4 branches missed.">        if ((game != null) &amp;&amp; game.getBoard().inSpace()) {</span>
<span class="nc" id="L3742">            return 0;</span>
        }
        // Altitude is not the same as elevation. If an aero is at 0 altitude,
        // then it is
        // grounded and uses elevation normally. Otherwise, just set elevation
        // to a very
        // large number so that a flying aero won't interact with the ground
        // maps in any way
<span class="pc bpc" id="L3750" title="1 of 2 branches missed.">        if (isAirborne()) {</span>
<span class="fc" id="L3751">            return 999;</span>
        }
<span class="nc" id="L3753">        return super.getElevation();</span>
    }

    @Override
    public boolean canGoDown() {
<span class="nc" id="L3758">        return canGoDown(altitude, getPosition());</span>
    }

    @Override
    public void setAlphaStrikeMovement(Map&lt;String, Integer&gt; moves) {
<span class="nc" id="L3763">        moves.put(getMovementModeAsBattleForceString(), getWalkMP());</span>
<span class="nc" id="L3764">    }</span>

    @Override
    public int getBattleForceArmorPoints() {
<span class="nc bnc" id="L3768" title="All 2 branches missed.">        if (isCapitalFighter()) {</span>
<span class="nc" id="L3769">            return (int) Math.round(getCapArmor() / 3.0);</span>
        }
<span class="nc" id="L3771">        return super.getBattleForceArmorPoints();</span>
    }

    @Override
    public String getBattleForceDamageThresholdString() {
<span class="nc" id="L3776">        return &quot;-&quot; + (int) Math.ceil(getBattleForceArmorPoints() / 10.0);</span>
    }

    @Override
    public int getBattleForceStructurePoints() {
<span class="nc" id="L3781">        return (int) Math.ceil(getSI() * 0.50);</span>
    }

    @Override
    public int getNumBattleForceWeaponsLocations() {
<span class="nc" id="L3786">        return 2;</span>
    }

    @Override
    public double getBattleForceLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc bnc" id="L3791" title="All 12 branches missed.">        if ((index == 0 &amp;&amp; location != LOC_AFT &amp;&amp; !rearMounted)</span>
                || (index == 1 &amp;&amp; (location == LOC_AFT || rearMounted))) {
<span class="nc" id="L3793">            return 1.0;</span>
        }
<span class="nc" id="L3795">        return 0;</span>
    }

    @Override
    public String getBattleForceLocationName(int index) {
<span class="nc bnc" id="L3800" title="All 2 branches missed.">        if (index == 1) {</span>
<span class="nc" id="L3801">            return &quot;REAR&quot;;</span>
        }
<span class="nc" id="L3803">        return &quot;&quot;;</span>
    }

    /**
     * We need to check whether the weapon is mounted in LOC_AFT in addition to
     * isRearMounted()
     */
    @Override
    public int getBattleForceTotalHeatGeneration(boolean allowRear) {
<span class="nc" id="L3812">        int totalHeat = 0;</span>

<span class="nc bnc" id="L3814" title="All 2 branches missed.">        for (Mounted mount : getWeaponList()) {</span>
<span class="nc" id="L3815">            WeaponType weapon = (WeaponType) mount.getType();</span>
<span class="nc bnc" id="L3816" title="All 2 branches missed.">            if (weapon instanceof BayWeapon) {</span>
<span class="nc bnc" id="L3817" title="All 2 branches missed.">                for (int index : mount.getBayWeapons()) {</span>
<span class="nc" id="L3818">                    totalHeat += ((WeaponType) (getEquipment(index).getType())).getHeat();</span>
<span class="nc" id="L3819">                }</span>
            }
<span class="nc bnc" id="L3821" title="All 4 branches missed.">            if (weapon.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L3822" title="All 6 branches missed.">                    || (allowRear &amp;&amp; !mount.isRearMounted() &amp;&amp; mount.getLocation() != LOC_AFT)</span>
<span class="nc bnc" id="L3823" title="All 4 branches missed.">                    || (!allowRear &amp;&amp; (mount.isRearMounted() || mount.getLocation() == LOC_AFT))) {</span>
<span class="nc" id="L3824">                continue;</span>
            }
<span class="nc" id="L3826">            totalHeat += weapon.getHeat();</span>
<span class="nc" id="L3827">        }</span>

<span class="nc" id="L3829">        return totalHeat;</span>
    }

    @Override
    public int getBattleForceTotalHeatGeneration(int location) {
<span class="nc" id="L3834">        int totalHeat = 0;</span>

<span class="nc bnc" id="L3836" title="All 2 branches missed.">        for (Mounted mount : getWeaponList()) {</span>
<span class="nc" id="L3837">            WeaponType weapon = (WeaponType) mount.getType();</span>
<span class="nc bnc" id="L3838" title="All 2 branches missed.">            if (weapon.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L3839" title="All 2 branches missed.">                    || getBattleForceLocationMultiplier(location, mount.getLocation(), mount.isRearMounted()) == 0) {</span>
<span class="nc" id="L3840">                continue;</span>
            }
<span class="nc" id="L3842">            totalHeat += weapon.getHeat();</span>
<span class="nc" id="L3843">        }</span>

<span class="nc" id="L3845">        return totalHeat;</span>
    }

    @Override
    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA, Integer&gt; specialAbilities) {
<span class="nc" id="L3850">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc bnc" id="L3851" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L3852" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_SPACE_MINE_DISPENSER)) {</span>
<span class="nc" id="L3853">                specialAbilities.merge(BattleForceSPA.MDS, 1, Integer::sum);</span>
            }
<span class="nc" id="L3855">        }</span>
<span class="nc bnc" id="L3856" title="All 2 branches missed.">        if ((getEntityType() &amp; (ETYPE_SMALL_CRAFT | ETYPE_JUMPSHIP | ETYPE_FIXED_WING_SUPPORT)) == 0) {</span>
<span class="nc" id="L3857">            specialAbilities.put(BattleForceSPA.BOMB, getWeightClass() + 1);</span>
        }
<span class="nc bnc" id="L3859" title="All 2 branches missed.">        if ((getEntityType() &amp; (ETYPE_JUMPSHIP | ETYPE_CONV_FIGHTER)) == 0) {</span>
<span class="nc" id="L3860">            specialAbilities.put(BattleForceSPA.SPC, null);</span>
        }
<span class="nc bnc" id="L3862" title="All 2 branches missed.">        if (isVSTOL()) {</span>
<span class="nc" id="L3863">            specialAbilities.put(BattleForceSPA.VSTOL, null);</span>
        }
<span class="nc" id="L3865">    }</span>

    @Override
    public boolean isPrimitive() {
<span class="pc bpc" id="L3869" title="1 of 2 branches missed.">        return (getCockpitType() == Aero.COCKPIT_PRIMITIVE);</span>
    }

    @Override
    public String getLocationDamage(int loc) {
<span class="nc" id="L3874">        return &quot;&quot;;</span>
    }

    public String getCritDamageString() {
<span class="nc" id="L3878">        StringBuilder toReturn = new StringBuilder();</span>
<span class="nc" id="L3879">        boolean first = true;</span>
<span class="nc bnc" id="L3880" title="All 2 branches missed.">        if (getSensorHits() &gt; 0) {</span>
<span class="nc bnc" id="L3881" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3882">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3884">            toReturn.append(String.format(Messages.getString(&quot;Aero.sensorDamageString&quot;), getSensorHits()));</span>
<span class="nc" id="L3885">            first = false;</span>
        }
<span class="nc bnc" id="L3887" title="All 2 branches missed.">        if (getAvionicsHits() &gt; 0) {</span>
<span class="nc bnc" id="L3888" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3889">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3891">            toReturn.append(String.format(Messages.getString(&quot;Aero.avionicsDamageString&quot;), getAvionicsHits()));</span>
<span class="nc" id="L3892">            first = false;</span>
        }
<span class="nc bnc" id="L3894" title="All 2 branches missed.">        if (getFCSHits() &gt; 0) {</span>
<span class="nc bnc" id="L3895" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3896">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3898">            toReturn.append(String.format(Messages.getString(&quot;Aero.fcsDamageString&quot;), getFCSHits()));</span>
<span class="nc" id="L3899">            first = false;</span>
        }
<span class="nc bnc" id="L3901" title="All 2 branches missed.">        if (getCICHits() &gt; 0) {</span>
<span class="nc bnc" id="L3902" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3903">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3905">            toReturn.append(String.format(Messages.getString(&quot;Aero.cicDamageString&quot;), getCICHits()));</span>
<span class="nc" id="L3906">            first = false;</span>
        }
<span class="nc bnc" id="L3908" title="All 2 branches missed.">        if (isGearHit()) {</span>
<span class="nc bnc" id="L3909" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3910">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3912">            toReturn.append(Messages.getString(&quot;Aero.landingGearDamageString&quot;));</span>
<span class="nc" id="L3913">            first = false;</span>
        }
<span class="nc bnc" id="L3915" title="All 2 branches missed.">        if (!hasLifeSupport()) {</span>
<span class="nc bnc" id="L3916" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3917">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3919">            toReturn.append(Messages.getString(&quot;Aero.lifeSupportDamageString&quot;));</span>
<span class="nc" id="L3920">            first = false;</span>
        }
<span class="nc bnc" id="L3922" title="All 2 branches missed.">        if (getLeftThrustHits() &gt; 0) {</span>
<span class="nc bnc" id="L3923" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3924">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3926">            toReturn.append(String.format(Messages.getString(&quot;Aero.leftThrusterDamageString&quot;), getLeftThrustHits()));</span>
<span class="nc" id="L3927">            first = false;</span>
        }
<span class="nc bnc" id="L3929" title="All 2 branches missed.">        if (getRightThrustHits() &gt; 0) {</span>
<span class="nc bnc" id="L3930" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L3931">                toReturn.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L3933">            toReturn.append(String.format(Messages.getString(&quot;Aero.rightThrusterDamageString&quot;), getRightThrustHits()));</span>
<span class="nc" id="L3934">            first = false;</span>
        }
        // Cargo bays and bay doors for large craft
<span class="nc bnc" id="L3937" title="All 2 branches missed.">        for (Bay next : getTransportBays()) {</span>
<span class="nc bnc" id="L3938" title="All 2 branches missed.">        	if (next.getBayDamage() &gt; 0) {</span>
<span class="nc bnc" id="L3939" title="All 2 branches missed.">        	    if (!first) {</span>
<span class="nc" id="L3940">                    toReturn.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L3942">        	toReturn.append(String.format(Messages.getString(&quot;Aero.bayDamageString&quot;), next.getType(), next.getBayNumber()));</span>
<span class="nc" id="L3943">        	first = false;</span>
        	}
<span class="nc bnc" id="L3945" title="All 2 branches missed.">        	if (next.getCurrentDoors() &lt; next.getDoors()) {</span>
<span class="nc bnc" id="L3946" title="All 2 branches missed.">        	    if (!first) {</span>
<span class="nc" id="L3947">                    toReturn.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L3949">        	toReturn.append(String.format(Messages.getString(&quot;Aero.bayDoorDamageString&quot;), next.getType(), next.getBayNumber(), (next.getDoors() - next.getCurrentDoors())));</span>
<span class="nc" id="L3950">        	first = false;</span>
        	}
<span class="nc" id="L3952">        }</span>
<span class="nc" id="L3953">        return toReturn.toString();</span>
    }

    @Override
    public boolean isCrippled() {
<span class="nc" id="L3958">        return isCrippled(true);</span>
    }

    @Override
    public boolean isCrippled(boolean checkCrew) {
<span class="nc bnc" id="L3963" title="All 2 branches missed.">        if (isEjecting()) {</span>
<span class="nc" id="L3964">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: The crew is currently ejecting.&quot;);</span>
<span class="nc" id="L3965">            return true;</span>
<span class="nc bnc" id="L3966" title="All 2 branches missed.">        } else if (getInternalRemainingPercent() &lt; 0.5) {</span>
<span class="nc" id="L3967">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Only &quot;</span>
<span class="nc" id="L3968">                    + NumberFormat.getPercentInstance().format(getInternalRemainingPercent()) + &quot; internals remaining.&quot;);</span>
<span class="nc" id="L3969">            return true;</span>
<span class="nc bnc" id="L3970" title="All 2 branches missed.">        } else if (getEngineHits() &gt; 0) {</span>
<span class="nc" id="L3971">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: &quot; + engineHits + &quot; Engine Hits.&quot;);</span>
<span class="nc" id="L3972">            return true;</span>
<span class="nc bnc" id="L3973" title="All 2 branches missed.">        } else if (fuelTankHit()) {</span>
<span class="nc" id="L3974">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Fuel Tank Hit&quot;);</span>
<span class="nc" id="L3975">            return true;</span>
<span class="nc bnc" id="L3976" title="All 6 branches missed.">        } else if (checkCrew &amp;&amp; (getCrew() != null) &amp;&amp; (getCrew().getHits() &gt;= 4)) {</span>
<span class="nc" id="L3977">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: &quot; + getCrew().getHits() + &quot; Crew Hits taken.&quot;);</span>
<span class="nc" id="L3978">            return true;</span>
<span class="nc bnc" id="L3979" title="All 2 branches missed.">        } else if (getFCSHits() &gt;= 3) {</span>
<span class="nc" id="L3980">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Fire Control Destroyed by taking &quot; + fcsHits);</span>
<span class="nc" id="L3981">            return true;</span>
<span class="nc bnc" id="L3982" title="All 2 branches missed.">        } else if (getCICHits() &gt;= 3) {</span>
<span class="nc" id="L3983">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Combat Information Center Destroyed by taking &quot; + cicHits);</span>
<span class="nc" id="L3984">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L3988" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L3989">            return false;</span>
        }

<span class="nc bnc" id="L3992" title="All 2 branches missed.">        if (!hasViableWeapons()) {</span>
<span class="nc" id="L3993">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: No more viable weapons.&quot;);</span>
<span class="nc" id="L3994">            return true;</span>
        } else {
<span class="nc" id="L3996">            return false;</span>
        }
    }

    @Override
    public boolean isDmgHeavy() {
<span class="nc bnc" id="L4002" title="All 2 branches missed.">        if (getArmorRemainingPercent() &lt;= 0.33) {</span>
<span class="nc" id="L4003">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4004">                    + &quot; Heavily Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.33.&quot;);
<span class="nc" id="L4006">            return true;</span>
<span class="nc bnc" id="L4007" title="All 2 branches missed.">        } else if (getInternalRemainingPercent() &lt; 0.67) {</span>
<span class="nc" id="L4008">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4009">                    + &quot; Heavily Damaged: Internal Structure Remaining percent of &quot; + getInternalRemainingPercent()</span>
                    + &quot; is less than 0.67.&quot;);
<span class="nc" id="L4011">            return true;</span>
<span class="nc bnc" id="L4012" title="All 4 branches missed.">        } else if ((getCrew() != null) &amp;&amp; (getCrew().getHits() == 3)) {</span>
<span class="nc" id="L4013">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot;Moderately Damaged: The crew has taken a minimum of three hits.&quot;);
<span class="nc" id="L4015">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L4019" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4020">            return false;</span>
        }

<span class="nc" id="L4023">        List&lt;Mounted&gt; weaponList = getTotalWeaponList();</span>
<span class="nc" id="L4024">        int totalWeapons = weaponList.size();</span>
<span class="nc" id="L4025">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4026" title="All 2 branches missed.">        for (Mounted weap : weaponList) {</span>
<span class="nc bnc" id="L4027" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4028">                totalInoperable++;</span>
            }
<span class="nc" id="L4030">        }</span>
<span class="nc bnc" id="L4031" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.75;</span>
    }

    @Override
    public boolean isDmgModerate() {
<span class="nc bnc" id="L4036" title="All 2 branches missed.">        if (getArmorRemainingPercent() &lt;= 0.5) {</span>
<span class="nc" id="L4037">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4038">                    + &quot; Moderately Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.50.&quot;);
<span class="nc" id="L4040">            return true;</span>
<span class="nc bnc" id="L4041" title="All 2 branches missed.">        } else if (getInternalRemainingPercent() &lt; 0.75) {</span>
<span class="nc" id="L4042">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4043">                    + &quot; Moderately Damaged: Internal Structure Remaining percent of &quot; + getInternalRemainingPercent()</span>
                    + &quot; is less than 0.75.&quot;);
<span class="nc" id="L4045">            return true;</span>
<span class="nc bnc" id="L4046" title="All 4 branches missed.">        } else if ((getCrew() != null) &amp;&amp; (getCrew().getHits() == 2)) {</span>
<span class="nc" id="L4047">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot; Moderately Damaged: The crew has taken a minimum of two hits.&quot;);
<span class="nc" id="L4049">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L4053" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4054">            return false;</span>
        }

<span class="nc" id="L4057">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4058">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4059" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4060" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4061">                totalInoperable++;</span>
            }
<span class="nc" id="L4063">        }</span>
<span class="nc bnc" id="L4064" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.5;</span>
    }

    @Override
    public boolean isDmgLight() {
<span class="nc bnc" id="L4069" title="All 2 branches missed.">        if (getArmorRemainingPercent() &lt;= 0.75) {</span>
<span class="nc" id="L4070">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4071">                    + &quot; Lightly Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.75.&quot;);
<span class="nc" id="L4073">            return true;</span>
<span class="nc bnc" id="L4074" title="All 2 branches missed.">        } else if (getInternalRemainingPercent() &lt; 0.9) {</span>
<span class="nc" id="L4075">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4076">                    + &quot; Lightly Damaged: Internal Structure Remaining percent of &quot; + getInternalRemainingPercent()</span>
                    + &quot; is less than 0.9.&quot;);
<span class="nc" id="L4078">            return true;</span>
<span class="nc bnc" id="L4079" title="All 4 branches missed.">        } else if ((getCrew() != null) &amp;&amp; (getCrew().getHits() == 1)) {</span>
<span class="nc" id="L4080">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot; Lightly Damaged: The crew has taken a minimum of one hit.&quot;);
<span class="nc" id="L4082">            return true;</span>
        }

        // If this is not a military unit, we don't care about weapon status.
<span class="nc bnc" id="L4086" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4087">            return false;</span>
        }

<span class="nc" id="L4090">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4091">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4092" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4093" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4094">                totalInoperable++;</span>
            }
<span class="nc" id="L4096">        }</span>
<span class="nc bnc" id="L4097" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.25;</span>
    }

    @Override
    public boolean canSpot() {
        // per a recent ruling on the official forums, aero units can't spot
        // for indirect LRM fire, unless they have a recon cam, an infrared or
        // hyperspec imager, or a high-res imager and it's not night
<span class="nc bnc" id="L4105" title="All 6 branches missed.">        if (!isAirborne() || hasWorkingMisc(MiscType.F_RECON_CAMERA) || hasWorkingMisc(MiscType.F_INFRARED_IMAGER)</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">                || hasWorkingMisc(MiscType.F_HYPERSPECTRAL_IMAGER)</span>
<span class="nc bnc" id="L4107" title="All 2 branches missed.">                || (hasWorkingMisc(MiscType.F_HIRES_IMAGER)</span>
<span class="nc bnc" id="L4108" title="All 2 branches missed.">                        &amp;&amp; ((game.getPlanetaryConditions().getLight() == PlanetaryConditions.L_DAY)</span>
<span class="nc bnc" id="L4109" title="All 2 branches missed.">                                || (game.getPlanetaryConditions().getLight() == PlanetaryConditions.L_DUSK)))) {</span>
<span class="nc" id="L4110">            return true;</span>
        } else {
<span class="nc" id="L4112">            return false;</span>
        }
    }

    // Damage a fighter that was part of a squadron when splitting it. Per
    // StratOps pg. 32 &amp; 34
    @Override
    public void doDisbandDamage() {

<span class="nc" id="L4121">        int dealt = 0;</span>

        // Check for critical threshold and if so damage all armor on one facing
        // of the fighter completely,
        // reduce SI by half, and mark three engine hits.
<span class="nc bnc" id="L4126" title="All 4 branches missed.">        if (isDestroyed() || isDoomed()) {</span>
<span class="nc" id="L4127">            int loc = Compute.randomInt(4);</span>
<span class="nc" id="L4128">            dealt = getArmor(loc);</span>
<span class="nc" id="L4129">            setArmor(0, loc);</span>
<span class="nc" id="L4130">            int finalSI = Math.min(getSI(), getSI() / 2);</span>
<span class="nc" id="L4131">            dealt += getSI() - finalSI;</span>
<span class="nc" id="L4132">            setSI(finalSI);</span>
<span class="nc" id="L4133">            setEngineHits(Math.max(3, getEngineHits()));</span>
        }

        // Move on to actual damage...
<span class="nc" id="L4137">        int damage = getCap0Armor() - getCapArmor();</span>
        // Fix for #587. Only multiply if Aero Sanity is off
<span class="nc bnc" id="L4139" title="All 4 branches missed.">        if ((null != game) &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L4140">            damage *= 10;</span>
        }
<span class="nc" id="L4142">        damage -= dealt; // We already dealt a bunch of damage, move on.</span>
<span class="nc bnc" id="L4143" title="All 2 branches missed.">        if (damage &lt; 1) {</span>
<span class="nc" id="L4144">            return;</span>
        }
<span class="nc" id="L4146">        int hits = (int) Math.ceil(damage / 5.0);</span>
<span class="nc" id="L4147">        int damPerHit = 5;</span>
<span class="nc bnc" id="L4148" title="All 2 branches missed.">        for (int i = 0; i &lt; hits; i++) {</span>
<span class="nc" id="L4149">            int loc = Compute.randomInt(4);</span>
            // Fix for #587. Apply in 5 point groups unless damage remainder is less.
<span class="nc" id="L4151">            setArmor(getArmor(loc) - Math.min(damPerHit, damage), loc);</span>
            // We did too much damage, so we need to damage the SI, but we wont
            // reduce the SI below 1 here
            // unless the fighter is destroyed.
<span class="nc bnc" id="L4155" title="All 2 branches missed.">            if (getArmor(loc) &lt; 0) {</span>
<span class="nc bnc" id="L4156" title="All 2 branches missed.">                if (getSI() &gt; 1) {</span>
<span class="nc" id="L4157">                    int si = getSI() + (getArmor(loc) / 2);</span>
<span class="nc bnc" id="L4158" title="All 4 branches missed.">                    si = Math.max(si, isDestroyed() || isDoomed() ? 0 : 1);</span>
<span class="nc" id="L4159">                    setSI(si);</span>
                }
<span class="nc" id="L4161">                setArmor(0, loc);</span>
            }
<span class="nc" id="L4163">            damage -= damPerHit;</span>
        }
<span class="nc" id="L4165">    }</span>

    /**
     * Damage a capital fighter's weapons. WeaponGroups are damaged by critical hits.
     * This matches up the individual fighter's weapons and critical slots and damages those
     * for MHQ resolution
     * @param loc - Int corresponding to the location struck
     */
    public void damageCapFighterWeapons(int loc) {
<span class="nc bnc" id="L4174" title="All 2 branches missed.">        for (Mounted weapon : weaponList) {</span>
<span class="nc bnc" id="L4175" title="All 2 branches missed.">            if (weapon.getLocation() == loc) {</span>
                //Damage the weapon
<span class="nc" id="L4177">                weapon.setHit(true);</span>
                //Damage the critical slot
<span class="nc bnc" id="L4179" title="All 2 branches missed.">                for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4180">                    CriticalSlot slot1 = getCritical(loc, i);</span>
<span class="nc bnc" id="L4181" title="All 2 branches missed.">                    if ((slot1 == null) ||</span>
<span class="nc bnc" id="L4182" title="All 2 branches missed.">                            (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L4183">                        continue;</span>
                    }
<span class="nc" id="L4185">                    Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L4186" title="All 2 branches missed.">                    if (mounted.equals(weapon)) {</span>
<span class="nc" id="L4187">                        hitAllCriticals(loc, i);</span>
<span class="nc" id="L4188">                        break;</span>
                    }
                }
            }
<span class="nc" id="L4192">        }</span>
<span class="nc" id="L4193">    }</span>

    /**
     * @return The total number of crew available to supplement marines on boarding actions.
     *         Includes officers, enlisted, and bay personnel, but not marines/ba or passengers.
     */
    @Override
    public int getNCrew() {
<span class="nc" id="L4201">        return 1;</span>
    }
    
    @Override
    public void setNCrew(int crew) {
<span class="nc" id="L4206">    }</span>

    /**
     * @return The total number of officers for vessels.
     */
    public int getNOfficers() {
<span class="nc" id="L4212">        return 0;</span>
    }

    /**
     * @return The total number of gunners for vessels.
     */
    public int getNGunners() {
<span class="nc" id="L4219">        return 0;</span>
    }

    /**
     * Returns the number of passengers on this unit
     * Intended for spacecraft, where we want to get the crews of transported units
     * plus actual passengers assigned to quarters
     * @return
     */
    @Override
    public int getNPassenger() {
<span class="nc" id="L4230">        return 0;</span>
    }
    
    @Override
    public void setNPassenger(int pass) {
<span class="nc" id="L4235">    }</span>
    
    /**
     * Returns the list of Entity IDs used by this ship as escape craft
     * @return
     */
    public Set&lt;String&gt; getEscapeCraft() {
<span class="nc" id="L4242">        return escapeCraftList;</span>
    }
    
    /**
     * Adds an Escape Craft. Used by MHQ to track where escaped crew and passengers end up.
     * @param id The Entity ID of the ship to add.
     */
    public void addEscapeCraft(String id) {
<span class="nc" id="L4250">        escapeCraftList.add(id);</span>
<span class="nc" id="L4251">    }</span>
    
    /**
     * Removes an Escape Craft. Used by MHQ to track where escaped crew and passengers end up.
     * @param id The Entity ID of the ship to remove.
     */
    public void removeEscapeCraft(String id) {
<span class="nc" id="L4258">        escapeCraftList.remove(id);</span>
<span class="nc" id="L4259">    }</span>

    /**
     * @return The number battlearmored marines available to vessels for boarding actions.
     */
    public int getNBattleArmor() {
<span class="nc" id="L4265">        return 0;</span>
    }

    /**
     * @return The number conventional marines available to vessels for boarding actions.
     */
    public int getNMarines() {
<span class="nc" id="L4272">        return 0;</span>
    }
    
    /**
     * Updates the number of marines aboard
     * @param marines The number of marines to add/subtract
     */
    @Override
    public void setNMarines(int marines) {
<span class="nc" id="L4281">    }</span>
    
    /**
     * Returns our list of unique individuals being transported as marines
     * @return
     */
    public Map&lt;UUID,Integer&gt; getMarines() {
<span class="nc" id="L4288">        return marines;</span>
    }
    
    /**
     * Adds a marine. Used by MHQ to track where a given person ends up. 
     * Also used by MM to move marines around between ships
     * @param personId The unique ID of the person to add.
     * @param pointValue The marine point value of the person being added
     */
    public void addMarine(UUID personId, int pointValue) {
<span class="nc" id="L4298">        marines.put(personId, pointValue);</span>
<span class="nc" id="L4299">    }</span>
    
    /**
     * Removes a marine. Used by MHQ to track where a given person ends up.
     * Also used by MM to move marines around between ships
     * @param personId The unique ID of the person to remove.
     */
    public void removeMarine(UUID personId) {
<span class="nc" id="L4307">        marines.remove(personId);</span>
<span class="nc" id="L4308">    }</span>
    
    /**
     * Returns the number of marines assigned to a unit
     * Used for abandoning a unit
     * @return
     */
    public int getMarineCount() {
<span class="nc" id="L4316">        return 0;</span>
    }
    
    /**
     * Convenience method that compiles the total number of people aboard a ship - Crew, Marines, Passengers...
     * @return An integer representing everyone aboard
     */
    public int getTotalAboard() {
<span class="nc" id="L4324">        return (getNCrew() + getNPassenger() + getMarineCount());</span>
    }

    /**
     * @return The number of escape pods carried by the unit
     */
    public int getEscapePods() {
<span class="nc" id="L4331">        return 0;</span>
    }
    
    /**
     * Convenience method to return the number of escape pods remaining
     * @return
     */
    public int getPodsLeft() {
<span class="nc" id="L4339">        return getEscapePods() - getLaunchedEscapePods();</span>
    }

    /**
     * @return The number of lifeboats carried by the unit
     */
    public int getLifeBoats() {
<span class="nc" id="L4346">        return 0;</span>
    }
    
    /**
     * Returns the total number of escape pods launched so far
     */
    public int getLaunchedEscapePods() {
<span class="nc" id="L4353">        return 0;</span>
    }
    
    /**
     * Updates the total number of escape pods launched so far
     * @param n The number to change
     */
    public void setLaunchedEscapePods(int n) {
<span class="nc" id="L4361">    }</span>
    
    /**
     * Returns the total number of life boats launched so far
     */
    public int getLaunchedLifeBoats() {
<span class="nc" id="L4367">        return 0;</span>
    }
    
    /**
     * Convenience method to return the number of life boats remaining
     * @return
     */
    public int getLifeBoatsLeft() {
<span class="nc" id="L4375">        return getLifeBoats() - getLaunchedLifeBoats();</span>
    }
    
    /**
     * Updates the total number of life boats launched so far
     * @param n The number to change
     */
    public void setLaunchedLifeBoats(int n) {
<span class="nc" id="L4383">    }</span>
    
    /**
     * Calculates whether this ship has any available escape systems remaining
     * return
     */
    public boolean hasEscapeSystemsLeft() {
<span class="nc bnc" id="L4390" title="All 2 branches missed.">        return ((getLaunchedLifeBoats() &lt; getLifeBoats()) </span>
<span class="nc bnc" id="L4391" title="All 2 branches missed.">                || (getLaunchedEscapePods() &lt; getEscapePods())</span>
<span class="nc bnc" id="L4392" title="All 2 branches missed.">                || !getLaunchableSmallCraft().isEmpty());</span>
    }
    
    /**
     * Calculates the total number of people that can be carried in this unit's escape systems
     * 6 people per lifeboat/escape pod + troop capacity of any small craft
     * Most small craft use cargo space instead of infantry bays, so we'll assume 0.1 tons/person
     * (Taken from Infantry.getWeight() - foot trooper + .015t for the spacesuit everyone aboard is wearing ;) )
     * @return The total escape count for the unit
     */
    public int getEscapeCapacity() {
<span class="nc" id="L4403">        int people = 0;</span>
        // We can cram 6 people in an escape pod
<span class="nc" id="L4405">        people += getEscapePods() * 6;</span>
        // Lifeboats hold 6 comfortably
<span class="nc" id="L4407">        people += getLifeBoats() * 6;</span>
        
        // Any small craft aboard and able to launch?
<span class="nc bnc" id="L4410" title="All 2 branches missed.">        for (Entity sc : getLaunchableSmallCraft()) {</span>
            // There could be an ASF in the bay...
<span class="nc bnc" id="L4412" title="All 2 branches missed.">            if (sc instanceof SmallCraft) {</span>
<span class="nc bnc" id="L4413" title="All 2 branches missed.">                for (Bay b : sc.getTransportBays()) {</span>
<span class="nc bnc" id="L4414" title="All 6 branches missed.">                    if (b instanceof InfantryBay || b instanceof BattleArmorBay || b instanceof CargoBay) {</span>
                        // Use the available tonnage
<span class="nc" id="L4416">                        people += (b.getCapacity() / 0.1);</span>
                    }
<span class="nc" id="L4418">                }</span>
            }
<span class="nc" id="L4420">        }</span>
<span class="nc" id="L4421">        return people;</span>
    }

    @Override
    public long getEntityType() {
<span class="fc" id="L4426">        return Entity.ETYPE_AERO;</span>
    }

    public boolean isInASquadron() {
<span class="nc" id="L4430">        return game.getEntity(getTransportId()) instanceof FighterSquadron;</span>
    }

    @Override
    public boolean isAero() {
<span class="fc" id="L4435">        return true;</span>
    }

    @Override
    public boolean isBomber() {
<span class="nc" id="L4440">        return isFighter();</span>
    }

    @Override
    public int availableBombLocation(int cost) {
<span class="nc" id="L4445">        return LOC_NOSE;</span>
    }

    /**
     * Used to determine the draw priority of different Entity subclasses. This
     * allows different unit types to always be draw above/below other types.
     *
     * @return
     */
    @Override
    public int getSpriteDrawPriority() {
<span class="nc" id="L4456">        return 10;</span>
    }

    @Override
    public List&lt;Mounted&gt; getActiveAMS() {
        //Large craft use AMS and Point Defense bays
<span class="nc bnc" id="L4462" title="All 8 branches missed.">        if ((this instanceof Dropship)</span>
                || (this instanceof Jumpship)
                || (this instanceof Warship)
                || (this instanceof SpaceStation)) {

<span class="nc" id="L4467">            ArrayList&lt;Mounted&gt; ams = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L4468" title="All 2 branches missed.">            for (Mounted weapon : getWeaponBayList()) {</span>
                // Skip anything that's not an AMS, AMS Bay or Point Defense Bay
<span class="nc bnc" id="L4470" title="All 2 branches missed.">                if (!weapon.getType().hasFlag(WeaponType.F_AMS)</span>
<span class="nc bnc" id="L4471" title="All 2 branches missed.">                        &amp;&amp; !weapon.getType().hasFlag(WeaponType.F_AMSBAY)</span>
<span class="nc bnc" id="L4472" title="All 2 branches missed.">                        &amp;&amp; !weapon.getType().hasFlag(WeaponType.F_PDBAY))  {</span>
<span class="nc" id="L4473">                    continue;</span>
                }

                // Make sure the AMS is good to go
<span class="nc bnc" id="L4477" title="All 4 branches missed.">                if (!weapon.isReady() || weapon.isMissing()</span>
<span class="nc bnc" id="L4478" title="All 2 branches missed.">                        || weapon.curMode().equals(&quot;Off&quot;)</span>
<span class="nc bnc" id="L4479" title="All 2 branches missed.">                        || weapon.curMode().equals(&quot;Normal&quot;)) {</span>
<span class="nc" id="L4480">                    continue;</span>
                }

                // AMS blocked by transported units can not fire
<span class="nc bnc" id="L4484" title="All 2 branches missed.">                if (isWeaponBlockedAt(weapon.getLocation(),</span>
<span class="nc" id="L4485">                        weapon.isRearMounted())) {</span>
<span class="nc" id="L4486">                    continue;</span>
                }

                // Make sure ammo is loaded
<span class="nc bnc" id="L4490" title="All 2 branches missed.">                for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L4491">                    Mounted bayW = getEquipment(wId);</span>
<span class="nc" id="L4492">                    Mounted bayWAmmo = bayW.getLinked();</span>
<span class="nc bnc" id="L4493" title="All 4 branches missed.">                    if (!(weapon.getType().hasFlag(WeaponType.F_ENERGY))</span>
<span class="nc bnc" id="L4494" title="All 2 branches missed.">                            &amp;&amp; ((bayWAmmo == null) || (bayWAmmo.getUsableShotsLeft() == 0)</span>
<span class="nc bnc" id="L4495" title="All 2 branches missed.">                                    || bayWAmmo.isDumping())) {</span>
<span class="nc" id="L4496">                        loadWeapon(weapon);</span>
<span class="nc" id="L4497">                        bayWAmmo = weapon.getLinked();</span>
                    }

                    // try again
<span class="nc bnc" id="L4501" title="All 4 branches missed.">                    if (!(weapon.getType().hasFlag(WeaponType.F_ENERGY))</span>
<span class="nc bnc" id="L4502" title="All 2 branches missed.">                            &amp;&amp; ((bayWAmmo == null) || (bayWAmmo.getUsableShotsLeft() == 0)</span>
<span class="nc bnc" id="L4503" title="All 2 branches missed.">                                    || bayWAmmo.isDumping())) {</span>
                        // No ammo for this AMS.
<span class="nc" id="L4505">                        continue;</span>
                    }
<span class="nc" id="L4507">                }</span>
<span class="nc" id="L4508">                ams.add(weapon);</span>
<span class="nc" id="L4509">            }</span>
<span class="nc" id="L4510">            return ams;</span>
        }
        //ASFs and Small Craft should use regular old AMS...
<span class="nc" id="L4513">        return super.getActiveAMS();</span>
    }

    /**
     * A method to add/remove sensors that only work in space as we transition in and out of an atmosphere
     */
    @Override
    public void updateSensorOptions() {
        //Prevent adding duplicates
<span class="nc" id="L4522">        boolean hasSpacecraftThermal = false;</span>
<span class="nc" id="L4523">        boolean hasAeroThermal = false;</span>
<span class="nc" id="L4524">        boolean hasESM = false;</span>
<span class="nc bnc" id="L4525" title="All 2 branches missed.">        for (Sensor sensor : getSensors()) {</span>
<span class="nc bnc" id="L4526" title="All 2 branches missed.">            if (sensor.getType() == Sensor.TYPE_SPACECRAFT_THERMAL) {</span>
<span class="nc" id="L4527">                hasSpacecraftThermal = true;</span>
            }
<span class="nc bnc" id="L4529" title="All 2 branches missed.">            if (sensor.getType() == Sensor.TYPE_AERO_THERMAL) {</span>
<span class="nc" id="L4530">                hasAeroThermal = true;</span>
            }
<span class="nc bnc" id="L4532" title="All 2 branches missed.">            if (sensor.getType() == Sensor.TYPE_SPACECRAFT_ESM) {</span>
<span class="nc" id="L4533">                hasESM = true;</span>
            }
<span class="nc" id="L4535">        }</span>
        //Remove everything but Radar if we're not in space
<span class="nc bnc" id="L4537" title="All 2 branches missed.">        if (!isSpaceborne()) {</span>
<span class="nc" id="L4538">            Vector&lt;Sensor&gt; sensorsToRemove = new Vector&lt;Sensor&gt;();</span>
<span class="nc bnc" id="L4539" title="All 2 branches missed.">            if (hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc bnc" id="L4540" title="All 2 branches missed.">                for (Sensor sensor : getSensors()) {</span>
<span class="nc bnc" id="L4541" title="All 2 branches missed.">                    if (sensor.getType() == Sensor.TYPE_SPACECRAFT_ESM) {</span>
<span class="nc" id="L4542">                        hasESM = false;</span>
<span class="nc" id="L4543">                        sensorsToRemove.add(sensor);</span>
                    }
<span class="nc bnc" id="L4545" title="All 2 branches missed.">                    if (sensor.getType() == Sensor.TYPE_SPACECRAFT_THERMAL) {</span>
<span class="nc" id="L4546">                        hasSpacecraftThermal = false;</span>
<span class="nc" id="L4547">                        sensorsToRemove.add(sensor);</span>
                    }
<span class="nc" id="L4549">                }</span>
<span class="nc bnc" id="L4550" title="All 2 branches missed.">            } else if (hasETypeFlag(Entity.ETYPE_AERO)) {</span>
<span class="nc bnc" id="L4551" title="All 2 branches missed.">                for (Sensor sensor : getSensors()) {</span>
<span class="nc bnc" id="L4552" title="All 2 branches missed.">                    if (sensor.getType() == Sensor.TYPE_AERO_THERMAL) {</span>
<span class="nc" id="L4553">                        hasAeroThermal = false;</span>
<span class="nc" id="L4554">                        sensorsToRemove.add(sensor);</span>
                    }
<span class="nc" id="L4556">                }</span>
            }
<span class="nc" id="L4558">            getSensors().removeAll(sensorsToRemove);</span>
<span class="nc bnc" id="L4559" title="All 2 branches missed.">            if (sensorsToRemove.size() &gt;= 1) {</span>
<span class="nc" id="L4560">            setNextSensor(getSensors().firstElement());</span>
            }
        }
        //If we are in space, add them back...
<span class="nc bnc" id="L4564" title="All 2 branches missed.">        if (isSpaceborne()) {</span>
<span class="nc bnc" id="L4565" title="All 2 branches missed.">            if (hasETypeFlag(Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L4566" title="All 2 branches missed.">                    || hasETypeFlag(Entity.ETYPE_SPACE_STATION)</span>
<span class="nc bnc" id="L4567" title="All 2 branches missed.">                    || hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L4568" title="All 2 branches missed.">                    || hasETypeFlag(Entity.ETYPE_WARSHIP)) {</span>
                //Large craft get thermal/optical sensors
<span class="nc bnc" id="L4570" title="All 2 branches missed.">                if (!hasSpacecraftThermal) {</span>
<span class="nc" id="L4571">                    getSensors().add(new Sensor(Sensor.TYPE_SPACECRAFT_THERMAL));</span>
<span class="nc" id="L4572">                    hasSpacecraftThermal = true;</span>
                }
                //Only military craft get ESM, which detects active radar
<span class="nc bnc" id="L4575" title="All 2 branches missed.">                if (getDesignType() == Aero.MILITARY) {</span>
<span class="nc bnc" id="L4576" title="All 2 branches missed.">                    if (!hasESM) {</span>
<span class="nc" id="L4577">                        getSensors().add(new Sensor(Sensor.TYPE_SPACECRAFT_ESM));</span>
<span class="nc" id="L4578">                        hasESM = true;</span>
                    }
                }
<span class="nc bnc" id="L4581" title="All 2 branches missed.">            } else if (hasETypeFlag(Entity.ETYPE_AERO)</span>
<span class="nc bnc" id="L4582" title="All 2 branches missed.">                        || hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
                //ASFs and small craft get thermal/optical sensors
<span class="nc bnc" id="L4584" title="All 2 branches missed.">                if (!hasAeroThermal) {</span>
<span class="nc" id="L4585">                    getSensors().add(new Sensor(Sensor.TYPE_AERO_THERMAL));</span>
<span class="nc" id="L4586">                    hasAeroThermal = true;</span>
                }
            }
        }
<span class="nc" id="L4590">    }</span>
    
    // autoejection methods
    /**
     * @return Returns the autoEject.
     */
    public boolean isAutoEject() {
<span class="nc bnc" id="L4597" title="All 2 branches missed.">        boolean hasEjectSeat = !hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT);</span>

<span class="nc bnc" id="L4599" title="All 4 branches missed.">        return autoEject &amp;&amp; hasEjectSeat;</span>
    }

    /**
     * @param autoEject
     *            Turn the master autoejection system on or off
     */
    public void setAutoEject(boolean autoEject) {
<span class="nc" id="L4607">        this.autoEject = autoEject;</span>
<span class="nc" id="L4608">    }</span>
    
    /**
     * Is autoejection enabled for ammo explosions?
     * @return
     */
    public boolean isCondEjectAmmo() {
<span class="nc" id="L4615">        return condEjectAmmo;</span>
    }

    /**
     * Used by Conditional Auto Ejection - will we eject when an ammo explosion is triggered?
     * @param  condEjectAmmo  Sets autoejection for ammo explosions
     */
    public void setCondEjectAmmo(boolean condEjectAmmo) {
<span class="nc" id="L4623">        this.condEjectAmmo = condEjectAmmo;</span>
<span class="nc" id="L4624">    }</span>

    /**
     * Is autoejection enabled for fuel explosions?
     * @return
     */
    public boolean isCondEjectFuel() {
<span class="nc" id="L4631">        return condEjectFuel;</span>
    }

    /**
     * Used by Conditional Auto Ejection - will we eject when a fuel explosion is triggered?
     * @param  condEjectFuel   Sets autoejection for fuel tank explosions
     */
    public void setCondEjectFuel(boolean condEjectFuel) {
<span class="nc" id="L4639">        this.condEjectFuel = condEjectFuel;</span>
<span class="nc" id="L4640">    }</span>

    /**
     * Is autoejection enabled for SI destruction (Fighter only)?
     * @return
     */
    public boolean isCondEjectSIDest() {
<span class="nc" id="L4647">        return condEjectSIDest;</span>
    }

    /**
     * Used by Conditional Auto Ejection - will we eject when structural integrity is reduced to 0?
     * @param  condEjectSIDest   Sets autoejection for structural integrity destruction
     */
    public void setCondEjectSIDest(boolean condEjectSIDest) {
<span class="nc" id="L4655">        this.condEjectSIDest = condEjectSIDest;</span>
<span class="nc" id="L4656">    }</span>
    
    /**
     * Intended for large craft. Indicates that the ship is being abandoned.
     * @return
     */
    public boolean isEjecting() {
<span class="nc" id="L4663">        return ejecting;</span>
    }

    /**
     * Changes the ejecting flag when the order to abandon ship is given
     * @param ejecting Change to the ejecting status of this ship
     */
    public void setEjecting(boolean ejecting) {
<span class="nc" id="L4671">        this.ejecting = ejecting;</span>
<span class="nc" id="L4672">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>