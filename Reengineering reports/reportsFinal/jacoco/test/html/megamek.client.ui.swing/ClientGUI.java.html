<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClientGUI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">ClientGUI.java</span></div><h1>ClientGUI.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000,2001,2002,2003,2004 Ben Mazur (bmazur@sev.org)
 * Copyright 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 * for more details.
 */
package megamek.client.ui.swing;

import java.applet.Applet;
import java.applet.AudioClip;
import java.awt.BorderLayout;
import java.awt.CardLayout;
import java.awt.Component;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.GraphicsConfiguration;
import java.awt.GraphicsDevice;
import java.awt.GraphicsEnvironment;
import java.awt.GridBagConstraints;
import java.awt.Image;
import java.awt.Rectangle;
import java.awt.SystemColor;
import java.awt.event.*;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.*;

import javax.imageio.ImageIO;
import javax.swing.*;
import javax.swing.filechooser.FileFilter;
import javax.swing.filechooser.FileNameExtensionFilter;

import megamek.MegaMek;
import megamek.client.Client;
import megamek.client.TimerSingleton;
import megamek.client.bot.BotClient;
import megamek.client.bot.TestBot;
import megamek.client.bot.princess.Princess;
import megamek.client.event.BoardViewEvent;
import megamek.client.event.BoardViewListener;
import megamek.client.ui.GBC;
import megamek.client.ui.IBoardView;
import megamek.client.ui.Messages;
import megamek.client.ui.dialogs.helpDialogs.AbstractHelpDialog;
import megamek.client.ui.dialogs.helpDialogs.MMReadMeHelpDialog;
import megamek.client.ui.swing.boardview.BoardView1;
import megamek.client.ui.swing.dialog.AbstractUnitSelectorDialog;
import megamek.client.ui.swing.dialog.MegaMekUnitSelectorDialog;
import megamek.client.ui.swing.unitDisplay.UnitDisplay;
import megamek.client.ui.swing.util.BASE64ToolKit;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.common.Configuration;
import megamek.common.Coords;
import megamek.common.Entity;
import megamek.common.EntityListFile;
import megamek.common.IBomber;
import megamek.common.IGame;
import megamek.common.IGame.Phase;
import megamek.common.IPlayer;
import megamek.common.MechSummaryCache;
import megamek.common.Mounted;
import megamek.common.MovePath;
import megamek.common.MovePath.MoveStepType;
import megamek.common.Targetable;
import megamek.common.WeaponOrderHandler;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.event.GameCFREvent;
import megamek.common.event.GameEndEvent;
import megamek.common.event.GameListener;
import megamek.common.event.GameListenerAdapter;
import megamek.common.event.GameMapQueryEvent;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GamePlayerChangeEvent;
import megamek.common.event.GamePlayerChatEvent;
import megamek.common.event.GamePlayerConnectedEvent;
import megamek.common.event.GamePlayerDisconnectedEvent;
import megamek.common.event.GameReportEvent;
import megamek.common.event.GameSettingsChangeEvent;
import megamek.common.icons.Camouflage;
import megamek.common.net.Packet;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.AddBotUtil;
import megamek.common.util.Distractable;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.util.StringUtil;

public class ClientGUI extends JPanel implements WindowListener, BoardViewListener, ActionListener, ComponentListener {
    //region Variable Declarations
    private static final long serialVersionUID = 3913466735610109147L;

    private static final String FILENAME_ICON_16X16 = &quot;megamek-icon-16x16.png&quot;;
    private static final String FILENAME_ICON_32X32 = &quot;megamek-icon-32x32.png&quot;;
    private static final String FILENAME_ICON_48X48 = &quot;megamek-icon-48x48.png&quot;;
    private static final String FILENAME_ICON_256X256 = &quot;megamek-icon-256x256.png&quot;;

    //region action commands
    //region main menu
    //Note: anything located in menu bars is not located here but in their menu
    public static final String MAIN_SKIN_NEW = &quot;mainSkinNew&quot;;
    public static final String MAIN_QUIT = &quot;mainQuit&quot;;
    //region file menu
    //game submenu
    public static final String FILE_GAME_NEW = &quot;fileGameNew&quot;;
    public static final String FILE_GAME_OPEN = &quot;fileGameOpen&quot;;
    public static final String FILE_GAME_SAVE = &quot;fileGameSave&quot;;
    public static final String FILE_GAME_SAVE_SERVER = &quot;fileGameSaveServer&quot;;
    public static final String FILE_GAME_SCENARIO = &quot;fileGameScenario&quot;;
    public static final String FILE_GAME_CONNECT_BOT = &quot;fileGameConnectBot&quot;;
    public static final String FILE_GAME_CONNECT = &quot;fileGameConnect&quot;;
    public static final String FILE_GAME_REPLACE_PLAYER = &quot;replacePlayer&quot;;
    //board submenu
    public static final String FILE_BOARD_NEW = &quot;fileBoardNew&quot;;
    public static final String FILE_BOARD_OPEN = &quot;fileBoardOpen&quot;;
    public static final String FILE_BOARD_SAVE = &quot;fileBoardSave&quot;;
    public static final String FILE_BOARD_SAVE_AS = &quot;fileBoardSaveAs&quot;;
    public static final String FILE_BOARD_SAVE_AS_IMAGE = &quot;fileBoardSaveAsImage&quot;;
    public static final String FILE_BOARD_SAVE_AS_IMAGE_UNITS = &quot;fileBoardSaveAsImageUnits&quot;;
    //unit list submenu
    public static final String FILE_UNITS_REINFORCE = &quot;fileUnitsReinforce&quot;;
    public static final String FILE_UNITS_REINFORCE_RAT = &quot;fileUnitsReinforceRAT&quot;;
    public static final String FILE_REFRESH_CACHE = &quot;fileRefreshCache&quot;;
    public static final String FILE_UNITS_OPEN = &quot;fileUnitsOpen&quot;;
    public static final String FILE_UNITS_CLEAR = &quot;fileUnitsClear&quot;;
    public static final String FILE_UNITS_SAVE = &quot;fileUnitsSave&quot;;
    //endregion file menu

    //region view menu
    public static final String VIEW_MEK_DISPLAY = &quot;viewMekDisplay&quot;;
    public static final String VIEW_ACCESSIBILITY_WINDOW = &quot;viewAccessibilityWindow&quot;;
    public static final String VIEW_KEYBINDS_OVERLAY = &quot;viewKeyboardShortcuts&quot;;
    public static final String VIEW_MINI_MAP = &quot;viewMiniMap&quot;;
    public static final String VIEW_UNIT_OVERVIEW = &quot;viewUnitOverview&quot;;
    public static final String VIEW_ZOOM_IN = &quot;viewZoomIn&quot;;
    public static final String VIEW_ZOOM_OUT = &quot;viewZoomOut&quot;;
    public static final String VIEW_TOGGLE_ISOMETRIC = &quot;viewToggleIsometric&quot;;
    public static final String VIEW_TOGGLE_FIELD_OF_FIRE = &quot;viewToggleFieldOfFire&quot;;
    public static final String VIEW_TOGGLE_FOV_DARKEN = &quot;viewToggleFovDarken&quot;;
    public static final String VIEW_TOGGLE_FOV_HIGHLIGHT = &quot;viewToggleFovHighlight&quot;;
    public static final String VIEW_TOGGLE_FIRING_SOLUTIONS = &quot;viewToggleFiringSolutions&quot;;
    public static final String VIEW_MOVE_ENV = &quot;viewMovementEnvelope&quot;;
    public static final String VIEW_MOVE_MOD_ENV = &quot;viewMovModEnvelope&quot;;
    public static final String VIEW_CHANGE_THEME = &quot;viewChangeTheme&quot;;
    public static final String VIEW_ROUND_REPORT = &quot;viewRoundReport&quot;;
    public static final String VIEW_GAME_OPTIONS = &quot;viewGameOptions&quot;;
    public static final String VIEW_CLIENT_SETTINGS = &quot;viewClientSettings&quot;;
    public static final String VIEW_LOS_SETTING = &quot;viewLOSSetting&quot;;
    public static final String VIEW_PLAYER_SETTINGS = &quot;viewPlayerSettings&quot;;
    public static final String VIEW_PLAYER_LIST = &quot;viewPlayerList&quot;;
    public static final String VIEW_RESET_WINDOW_POSITIONS = &quot;viewResetWindowPos&quot;;
    //endregion view menu

    //region fire menu
    public static final String FIRE_SAVE_WEAPON_ORDER = &quot;saveWeaponOrder&quot;;
    //endregion fire menu

    //region help menu
    public static final String HELP_CONTENTS = &quot;helpContents&quot;;
    public static final String HELP_SKINNING = &quot;helpSkinning&quot;;
    public static final String HELP_ABOUT = &quot;helpAbout&quot;;
    //endregion help menu
    //endregion action commands

    // a frame, to show stuff in
    public JFrame frame;

    // A menu bar to contain all actions.
    protected CommonMenuBar menuBar;
    private CommonAboutDialog about;
    private AbstractHelpDialog help;
    private CommonSettingsDialog setdlg;
    private AccessibilityWindow aw;

    public MegaMekController controller;
    private ChatterBox cb;
    public ChatterBox2 cb2;
    public BoardView1 bv;
    private Component bvc;
    public JDialog mechW;
    public UnitDisplay mechD;
    public JDialog minimapW;
    public MiniMap minimap;
    private MapMenu popup;
    private UnitOverview uo;
    private Ruler ruler;
    protected JComponent curPanel;
    public ChatLounge chatlounge;
    private OffBoardTargetOverlay offBoardOverlay;

    // some dialogs...
    private GameOptionsDialog gameOptionsDialog;
    private AbstractUnitSelectorDialog mechSelectorDialog;
    private StartingPositionDialog startingPositionDialog;
    private PlayerListDialog playerListDialog;
    private RandomArmyDialog randomArmyDialog;
    private RandomSkillDialog randomSkillDialog;
    private PlanetaryConditionsDialog conditionsDialog;
    /**
     * Save and Open dialogs for MegaMek Unit List (mul) files.
     */
    private JFileChooser dlgLoadList;
    private JFileChooser dlgSaveList;
    private Client client;

    private File curfileBoardImage;
    private File curfileBoard;

    /**
     * Cache for the &quot;bing&quot; soundclip.
     */
    private AudioClip bingClip;

    /**
     * Map each phase to the name of the card for the main display area.
     */
<span class="fc" id="L227">    private Map&lt;String, String&gt; mainNames = new HashMap&lt;&gt;();</span>

    /**
     * The &lt;code&gt;JPanel&lt;/code&gt; containing the main display area.
     */
<span class="fc" id="L232">    private JPanel panMain = new JPanel();</span>

    /**
     * The &lt;code&gt;CardLayout&lt;/code&gt; of the main display area.
     */
<span class="fc" id="L237">    private CardLayout cardsMain = new CardLayout();</span>

    /**
     * Map each phase to the name of the card for the secondary area.
     */
<span class="fc" id="L242">    private Map&lt;String, String&gt; secondaryNames = new HashMap&lt;&gt;();</span>

    /**
     * The &lt;code&gt;JPanel&lt;/code&gt; containing the secondary display area.
     */
<span class="fc" id="L247">    private JPanel panSecondary = new JPanel();</span>

    private StatusBarPhaseDisplay currPhaseDisplay;

    /**
     * The &lt;code&gt;CardLayout&lt;/code&gt; of the secondary display area.
     */
<span class="fc" id="L254">    private CardLayout cardsSecondary = new CardLayout();</span>

    /**
     * Map phase component names to phase component objects.
     */
<span class="fc" id="L259">    private Map&lt;String, JComponent&gt; phaseComponents = new HashMap&lt;&gt;();</span>

    /**
     * Current Selected entity
     */
<span class="fc" id="L264">    private int selectedEntityNum = Entity.NONE;</span>

    /**
     * Flag that indicates whether hotkeys should be ignored or not.  This is
     * used for disabling hot keys when various dialogs are displayed.
     */
<span class="fc" id="L270">    private boolean ignoreHotKeys = false;</span>

    /**
     * Keeps track of the Entity ID for the entity currently taking a pointblank
     * shot.
     */
<span class="fc" id="L276">    private int pointblankEID = Entity.NONE;</span>
    //endregion Variable Declarations

    /**
     * Construct a client which will display itself in a new frame. It will not
     * try to connect to a server yet. When the frame closes, this client will
     * clean up after itself as much as possible, but will not call
     * System.exit().
     */
    public ClientGUI(Client client, MegaMekController c) {
<span class="fc" id="L286">        super(new BorderLayout());</span>
<span class="fc" id="L287">        this.addComponentListener(this);</span>
<span class="fc" id="L288">        this.client = client;</span>
<span class="fc" id="L289">        controller = c;</span>
<span class="fc" id="L290">        loadSoundClip();</span>
<span class="fc" id="L291">        panMain.setLayout(cardsMain);</span>
<span class="fc" id="L292">        panSecondary.setLayout(cardsSecondary);</span>
<span class="fc" id="L293">        JPanel panDisplay = new JPanel(new BorderLayout());</span>
<span class="fc" id="L294">        panDisplay.add(panMain, BorderLayout.CENTER);</span>
<span class="fc" id="L295">        panDisplay.add(panSecondary, BorderLayout.SOUTH);</span>
<span class="fc" id="L296">        add(panDisplay, BorderLayout.CENTER);</span>
<span class="fc" id="L297">    }</span>

    public IBoardView getBoardView() {
<span class="nc" id="L300">        return bv;</span>
    }

    /**
     * Try to load the &quot;bing&quot; sound clip.
     */
    private void loadSoundClip() {
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">        if (GUIPreferences.getInstance().getSoundBingFilename() == null) {</span>
<span class="nc" id="L308">            return;</span>
        }
        try {
<span class="fc" id="L311">            File file = new File(GUIPreferences.getInstance().getSoundBingFilename());</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">            if (!file.exists()) {</span>
<span class="nc" id="L313">                MegaMek.getLogger().error(&quot;Failed to load audio file: &quot; + GUIPreferences.getInstance().getSoundBingFilename());</span>
<span class="nc" id="L314">                return;</span>
            }
<span class="fc" id="L316">            bingClip = Applet.newAudioClip(file.toURI().toURL());</span>
<span class="nc" id="L317">        } catch (Exception e) {</span>
<span class="nc" id="L318">            MegaMek.getLogger().error(e);</span>
<span class="fc" id="L319">        }</span>
<span class="fc" id="L320">    }</span>

    /**
     * Display a system message in the chat box.
     *
     * @param message the &lt;code&gt;String&lt;/code&gt; message to be shown.
     */
    public void systemMessage(String message) {
<span class="nc" id="L328">        cb.systemMessage(message);</span>
<span class="nc" id="L329">        cb2.addChatMessage(&quot;Megamek: &quot; + message);</span>
<span class="nc" id="L330">    }</span>

    /**
     * @return the 'virtual bounds' of the screen. That is, the union of the displayable space on
     * all available screen devices.
     */
    private Rectangle getVirtualBounds() {
<span class="nc" id="L337">        Rectangle virtualBounds = new Rectangle();</span>
<span class="nc" id="L338">        GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();</span>
<span class="nc" id="L339">        GraphicsDevice[] gs = ge.getScreenDevices();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        for (GraphicsDevice gd : gs) {</span>
<span class="nc" id="L341">            GraphicsConfiguration[] gc = gd.getConfigurations();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            for (GraphicsConfiguration element : gc) {</span>
<span class="nc" id="L343">                virtualBounds = virtualBounds.union(element.getBounds());</span>
            }
        }
<span class="nc" id="L346">        return virtualBounds;</span>
    }

    /**
     * Initializes a number of things about this frame.
     */
    private void initializeFrame() {
<span class="nc" id="L353">        frame = new JFrame(Messages.getString(&quot;ClientGUI.title&quot;));</span>
<span class="nc" id="L354">        menuBar.setGame(client.getGame());</span>
<span class="nc" id="L355">        frame.setJMenuBar(menuBar);</span>
<span class="nc" id="L356">        Rectangle virtualBounds = getVirtualBounds();</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getWindowSizeHeight() != 0) {</span>
<span class="nc" id="L358">            int x = GUIPreferences.getInstance().getWindowPosX();</span>
<span class="nc" id="L359">            int y = GUIPreferences.getInstance().getWindowPosY();</span>
<span class="nc" id="L360">            int w = GUIPreferences.getInstance().getWindowSizeWidth();</span>
<span class="nc" id="L361">            int h = GUIPreferences.getInstance().getWindowSizeHeight();</span>
<span class="nc bnc" id="L362" title="All 4 branches missed.">            if ((x &lt; virtualBounds.getMinX()) || ((x + w) &gt; virtualBounds.getMaxX())) {</span>
<span class="nc" id="L363">                x = 0;</span>
            }
<span class="nc bnc" id="L365" title="All 4 branches missed.">            if ((y &lt; virtualBounds.getMinY()) || ((y + h) &gt; virtualBounds.getMaxY())) {</span>
<span class="nc" id="L366">                y = 0;</span>
            }
<span class="nc bnc" id="L368" title="All 2 branches missed.">            if (w &gt; virtualBounds.getWidth()) {</span>
<span class="nc" id="L369">                w = (int) virtualBounds.getWidth();</span>
            }
<span class="nc bnc" id="L371" title="All 2 branches missed.">            if (h &gt; virtualBounds.getHeight()) {</span>
<span class="nc" id="L372">                h = (int) virtualBounds.getHeight();</span>
            }
<span class="nc" id="L374">            frame.setLocation(x, y);</span>
<span class="nc" id="L375">            frame.setSize(w, h);</span>
<span class="nc" id="L376">        } else {</span>
<span class="nc" id="L377">            frame.setSize(800, 600);</span>
        }
<span class="nc" id="L379">        frame.setMinimumSize(new Dimension(640,480));</span>
<span class="nc" id="L380">        frame.setBackground(SystemColor.menu);</span>
<span class="nc" id="L381">        frame.setForeground(SystemColor.menuText);</span>
<span class="nc" id="L382">        List&lt;Image&gt; iconList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L383">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L384">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_16X16).toString()</span>
        ));
<span class="nc" id="L386">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L387">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_32X32).toString()</span>
        ));
<span class="nc" id="L389">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L390">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_48X48).toString()</span>
        ));
<span class="nc" id="L392">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L393">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_256X256).toString()</span>
        ));
<span class="nc" id="L395">        frame.setIconImages(iconList);</span>
<span class="nc" id="L396">    }</span>

    /**
     * Lays out the frame by setting this Client object to take up the full
     * frame display area.
     */
    private void layoutFrame() {
<span class="nc" id="L403">        frame.setTitle(client.getName() + Messages.getString(&quot;ClientGUI.clientTitleSuffix&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L404">        frame.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L405">        frame.getContentPane().add(this, BorderLayout.CENTER);</span>
<span class="nc" id="L406">        frame.validate();</span>
<span class="nc" id="L407">    }</span>

    /**
     * Have the client register itself as a listener wherever it's needed.
     * &lt;p/&gt;
     * According to
     * http://www-106.ibm.com/developerworks/java/library/j-jtp0618.html it is a
     * major bad no-no to perform these registrations before the constructor
     * finishes, so this function has to be called after the &lt;code&gt;Client&lt;/code&gt;
     * is created.
     */
    public void initialize() {
<span class="nc" id="L419">        menuBar = new CommonMenuBar(getClient());</span>
<span class="nc" id="L420">        initializeFrame();</span>
        try {
<span class="nc" id="L422">            client.getGame().addGameListener(gameListener);</span>
            // Create the board viewer.
<span class="nc" id="L424">            bv = new BoardView1(client.getGame(), controller, this);</span>
<span class="nc" id="L425">            bv.setPreferredSize(getSize());</span>
<span class="nc" id="L426">            bvc = bv.getComponent();</span>
<span class="nc" id="L427">            bvc.setName(&quot;BoardView&quot;);</span>
<span class="nc" id="L428">            bv.addBoardViewListener(this);</span>
<span class="nc" id="L429">            client.setBoardView(bv);</span>
<span class="nc" id="L430">        } catch (Exception e) {</span>
<span class="nc" id="L431">            MegaMek.getLogger().fatal(e);</span>
<span class="nc" id="L432">            doAlertDialog(Messages.getString(&quot;ClientGUI.FatalError.title&quot;),</span>
<span class="nc" id="L433">                    Messages.getString(&quot;ClientGUI.FatalError.message&quot;) + e);</span>
<span class="nc" id="L434">            die();</span>
<span class="nc" id="L435">        }</span>

<span class="nc" id="L437">        layoutFrame();</span>
<span class="nc" id="L438">        menuBar.addActionListener(this);</span>
<span class="nc" id="L439">        frame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L440">        frame.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L443">                ignoreHotKeys = true;</span>
<span class="nc" id="L444">                int savePrompt = JOptionPane.showConfirmDialog(null,</span>
                        &quot;Do you want to save the game before quitting MegaMek?&quot;,
                        &quot;Save First?&quot;,
                        JOptionPane.YES_NO_CANCEL_OPTION,
                        JOptionPane.WARNING_MESSAGE);
<span class="nc" id="L449">                ignoreHotKeys = false;</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                if (savePrompt == JOptionPane.YES_OPTION) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                    if (!saveGame()) {</span>
                        // When the user did not actually save the game, don't close MM
<span class="nc" id="L453">                        return;</span>
                    }
                }
<span class="nc bnc" id="L456" title="All 4 branches missed.">                if ((savePrompt == JOptionPane.NO_OPTION) || (savePrompt == JOptionPane.YES_OPTION)) {</span>
<span class="nc" id="L457">                    frame.setVisible(false);</span>
<span class="nc" id="L458">                    saveSettings();</span>
<span class="nc" id="L459">                    die();</span>
                }
<span class="nc" id="L461">            }</span>
        });
<span class="nc" id="L463">        cb2 = new ChatterBox2(this, bv, controller);</span>
<span class="nc" id="L464">        bv.addDisplayable(cb2);</span>
<span class="nc" id="L465">        bv.addKeyListener(cb2);</span>
<span class="nc" id="L466">        uo = new UnitOverview(this);</span>
<span class="nc" id="L467">        offBoardOverlay = new OffBoardTargetOverlay(this);</span>

<span class="nc" id="L469">        aw = new AccessibilityWindow(this);</span>
<span class="nc" id="L470">        aw.setLocation(0, 0);</span>
<span class="nc" id="L471">        aw.addWindowListener(this);</span>
<span class="nc" id="L472">        aw.setSize(300, 300);</span>

<span class="nc" id="L474">        bv.addDisplayable(uo);</span>
<span class="nc" id="L475">        bv.addDisplayable(offBoardOverlay);</span>
        int x;
        int y;
        int h;
        int w;
<span class="nc" id="L480">        mechW = new JDialog(frame, Messages.getString(&quot;ClientGUI.MechDisplay&quot;), false) {</span>
            /**
             * In addition to the default Dialog processKeyEvent, this method
             * dispatches a KeyEvent to the client gui.
             * This enables all of the gui hotkeys.
             */
            @Override
            protected void processKeyEvent(KeyEvent e) {
                //menuBar.dispatchEvent(e);
                // Make the source be the ClientGUI and not the dialog
                // This prevents a ClassCastException in ToolTipManager
<span class="nc" id="L491">                e.setSource(ClientGUI.this);</span>
<span class="nc" id="L492">                curPanel.dispatchEvent(e);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                if (!e.isConsumed()) {</span>
<span class="nc" id="L494">                    super.processKeyEvent(e);</span>
                }
<span class="nc" id="L496">            }</span>
        };
<span class="nc" id="L498">        Rectangle virtualBounds = getVirtualBounds();</span>
<span class="nc" id="L499">        x = GUIPreferences.getInstance().getDisplayPosX();</span>
<span class="nc" id="L500">        y = GUIPreferences.getInstance().getDisplayPosY();</span>
<span class="nc" id="L501">        h = GUIPreferences.getInstance().getDisplaySizeHeight();</span>
<span class="nc" id="L502">        w = GUIPreferences.getInstance().getDisplaySizeWidth();</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">        if ((x + w) &gt; virtualBounds.getWidth()) {</span>
<span class="nc" id="L504">            x = 0;</span>
<span class="nc" id="L505">            w = Math.min(w, (int)virtualBounds.getWidth());</span>
        }
<span class="nc bnc" id="L507" title="All 2 branches missed.">        if ((y + h) &gt; virtualBounds.getHeight()) {</span>
<span class="nc" id="L508">            y = 0;</span>
<span class="nc" id="L509">            h = Math.min(h, (int)virtualBounds.getHeight());</span>
        }
<span class="nc" id="L511">        mechW.setLocation(x, y);</span>
<span class="nc" id="L512">        mechW.setSize(w, h);</span>
<span class="nc" id="L513">        mechW.setResizable(true);</span>
<span class="nc" id="L514">        mechW.addWindowListener(this);</span>
<span class="nc" id="L515">        mechD = new UnitDisplay(this, controller);</span>
<span class="nc" id="L516">        mechD.addMechDisplayListener(bv);</span>
<span class="nc" id="L517">        mechW.add(mechD);</span>

<span class="nc" id="L519">        Ruler.color1 = GUIPreferences.getInstance().getRulerColor1();</span>
<span class="nc" id="L520">        Ruler.color2 = GUIPreferences.getInstance().getRulerColor2();</span>
<span class="nc" id="L521">        ruler = new Ruler(frame, client, bv);</span>
<span class="nc" id="L522">        x = GUIPreferences.getInstance().getRulerPosX();</span>
<span class="nc" id="L523">        y = GUIPreferences.getInstance().getRulerPosY();</span>
<span class="nc" id="L524">        h = GUIPreferences.getInstance().getRulerSizeHeight();</span>
<span class="nc" id="L525">        w = GUIPreferences.getInstance().getRulerSizeWidth();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if ((x + w) &gt; virtualBounds.getWidth()) {</span>
<span class="nc" id="L527">            x = 0;</span>
<span class="nc" id="L528">            w = Math.min(w, (int)virtualBounds.getWidth());</span>
        }
<span class="nc bnc" id="L530" title="All 2 branches missed.">        if ((y + h) &gt; virtualBounds.getHeight()) {</span>
<span class="nc" id="L531">            y = 0;</span>
<span class="nc" id="L532">            h = Math.min(h, (int)virtualBounds.getHeight());</span>
        }
<span class="nc" id="L534">        ruler.setLocation(x, y);</span>
<span class="nc" id="L535">        ruler.setSize(w, h);</span>
        // minimap
<span class="nc" id="L537">        minimapW = new JDialog(frame, Messages.getString(&quot;ClientGUI.MiniMap&quot;), false) {</span>
            /**
             * In addition to the default Dialog processKeyEvent, this method
             * dispatches a KeyEvent to the client gui.
             * This enables all of the gui hotkeys.
             */
            @Override
            protected void processKeyEvent(KeyEvent e) {
                //menuBar.dispatchEvent(e);
<span class="nc" id="L546">                e.setSource(ClientGUI.this);// avoid ClassCastException in TooltipManager</span>
<span class="nc" id="L547">                curPanel.dispatchEvent(e);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">                if (!e.isConsumed()) {</span>
<span class="nc" id="L549">                    super.processKeyEvent(e);</span>
                }
<span class="nc" id="L551">            }</span>
        };

<span class="nc" id="L554">        x = GUIPreferences.getInstance().getMinimapPosX();</span>
<span class="nc" id="L555">        y = GUIPreferences.getInstance().getMinimapPosY();</span>
        try {
<span class="nc" id="L557">            minimap = new MiniMap(minimapW, this, bv);</span>
<span class="nc" id="L558">        } catch (IOException e) {</span>
<span class="nc" id="L559">            MegaMek.getLogger().fatal(e);</span>
<span class="nc" id="L560">            doAlertDialog(Messages.getString(&quot;ClientGUI.FatalError.title&quot;),</span>
<span class="nc" id="L561">                    Messages.getString(&quot;ClientGUI.FatalError.message1&quot;) + e);</span>
<span class="nc" id="L562">            die();</span>
<span class="nc" id="L563">        }</span>
<span class="nc" id="L564">        h = minimap.getSize().height;</span>
<span class="nc" id="L565">        w = minimap.getSize().width;</span>
<span class="nc bnc" id="L566" title="All 4 branches missed.">        if (((x + 10) &gt;= virtualBounds.getWidth()) || ((x + w) &lt; 10)) {</span>
<span class="nc" id="L567">            x = (int)virtualBounds.getWidth() - w;</span>
        }
<span class="nc bnc" id="L569" title="All 4 branches missed.">        if (((y + 10) &gt; virtualBounds.getHeight()) || ((y + h) &lt; 10)) {</span>
<span class="nc" id="L570">            y = (int)virtualBounds.getHeight() - h;</span>
        }
<span class="nc" id="L572">        minimapW.setLocation(x, y);</span>
<span class="nc" id="L573">        minimapW.addWindowListener(this);</span>
<span class="nc" id="L574">        minimapW.add(minimap);</span>
<span class="nc" id="L575">        cb = new ChatterBox(this);</span>
<span class="nc" id="L576">        cb.setChatterBox2(cb2);</span>
<span class="nc" id="L577">        cb2.setChatterBox(cb);</span>
<span class="nc" id="L578">        client.changePhase(IGame.Phase.PHASE_UNKNOWN);</span>
<span class="nc" id="L579">        UnitLoadingDialog unitLoadingDialog = new UnitLoadingDialog(frame);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (!MechSummaryCache.getInstance().isInitialized()) {</span>
<span class="nc" id="L581">            unitLoadingDialog.setVisible(true);</span>
        }
<span class="nc" id="L583">        mechSelectorDialog = new MegaMekUnitSelectorDialog(this, unitLoadingDialog);</span>
<span class="nc" id="L584">        randomArmyDialog = new RandomArmyDialog(this);</span>
<span class="nc" id="L585">        randomSkillDialog = new RandomSkillDialog(this);</span>
<span class="nc" id="L586">        new Thread(mechSelectorDialog, &quot;Mech Selector Dialog&quot;).start();</span>
<span class="nc" id="L587">        frame.setVisible(true);</span>
<span class="nc" id="L588">    }</span>

    /**
     * Get the menu bar for this client.
     *
     * @return the &lt;code&gt;CommonMenuBar&lt;/code&gt; of this client.
     */
    public CommonMenuBar getMenuBar() {
<span class="nc" id="L596">        return menuBar;</span>
    }

    /**
     * Called when the user selects the &quot;Help-&gt;About&quot; menu item.
     */
    private void showAbout() {
        // Do we need to create the &quot;about&quot; dialog?
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (about == null) {</span>
<span class="nc" id="L605">            about = new CommonAboutDialog(frame);</span>
        }

        // Show the about dialog.
<span class="nc" id="L609">        about.setVisible(true);</span>
<span class="nc" id="L610">    }</span>

    /**
     * Called when the user selects the &quot;Help-&gt;Contents&quot; menu item.
     * &lt;p/&gt;
     * This method can be called by subclasses.
     */
    private void showHelp() {
        // Do we need to create the &quot;help&quot; dialog?
<span class="nc bnc" id="L619" title="All 2 branches missed.">        if (help == null) {</span>
<span class="nc" id="L620">            help = new MMReadMeHelpDialog(frame);</span>
        }
        // Show the help dialog.
<span class="nc" id="L623">        help.setVisible(true);</span>
<span class="nc" id="L624">    }</span>

    private void showSkinningHowTo() {
        try {
            // Get the correct help file.
<span class="nc" id="L629">            StringBuilder helpPath = new StringBuilder(&quot;file:///&quot;);</span>
<span class="nc" id="L630">            helpPath.append(System.getProperty(&quot;user.dir&quot;));</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            if (!helpPath.toString().endsWith(File.separator)) {</span>
<span class="nc" id="L632">                helpPath.append(File.separator);</span>
            }
<span class="nc" id="L634">            helpPath.append(Messages.getString(&quot;ClientGUI.skinningHelpPath&quot;));</span>
<span class="nc" id="L635">            URL helpUrl = new URL(helpPath.toString());</span>

            // Launch the help dialog.
<span class="nc" id="L638">            HelpDialog helpDialog = new HelpDialog(</span>
<span class="nc" id="L639">                    Messages.getString(&quot;ClientGUI.skinningHelpPath.title&quot;),</span>
                    helpUrl);
<span class="nc" id="L641">            helpDialog.setVisible(true);</span>
<span class="nc" id="L642">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L643">            JOptionPane.showMessageDialog(this, e.getMessage(), &quot;ERROR&quot;,</span>
                    JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L645">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L646">        }</span>
<span class="nc" id="L647">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Client Settings&quot; menu item.
     */
    private void showSettings() {
        // Do we need to create the &quot;settings&quot; dialog?
<span class="nc bnc" id="L654" title="All 2 branches missed.">        if (setdlg == null) {</span>
<span class="nc" id="L655">            setdlg = new CommonSettingsDialog(frame, this);</span>
        }

        // Show the settings dialog.
<span class="nc" id="L659">        setdlg.setVisible(true);</span>
<span class="nc" id="L660">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Game Options&quot; menu item.
     */
    private void showOptions() {
<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (client.getGame().getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L667">            getGameOptionsDialog().setEditable(true);</span>
        } else {
<span class="nc" id="L669">            getGameOptionsDialog().setEditable(false);</span>
        }
        // Display the game options dialog.
<span class="nc" id="L672">        getGameOptionsDialog().update(client.getGame().getOptions());</span>
<span class="nc" id="L673">        getGameOptionsDialog().setVisible(true);</span>
<span class="nc" id="L674">    }</span>

    public void customizePlayer() {
<span class="nc" id="L677">        PlayerSettingsDialog psd = new PlayerSettingsDialog(this, client);</span>
<span class="nc" id="L678">        psd.setVisible(true);</span>
<span class="nc" id="L679">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Player List&quot; menu item.
     */
    private void showPlayerList() {
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (playerListDialog == null) {</span>
<span class="nc" id="L686">            playerListDialog = new PlayerListDialog(frame, client);</span>
        }
<span class="nc" id="L688">        playerListDialog.setVisible(true);</span>
<span class="nc" id="L689">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Round Report&quot; menu item.
     */
    private void showRoundReport() {
<span class="nc" id="L695">        ignoreHotKeys = true;</span>
<span class="nc" id="L696">        new MiniReportDisplay(frame, client).setVisible(true);</span>
<span class="nc" id="L697">        ignoreHotKeys = false;</span>
<span class="nc" id="L698">    }</span>

    /**
     * Implement the &lt;code&gt;ActionListener&lt;/code&gt; interface.
     */
    public void actionPerformed(ActionEvent event) {
<span class="nc bnc" id="L704" title="All 40 branches missed.">        switch (event.getActionCommand()) {</span>
            case VIEW_RESET_WINDOW_POSITIONS:
<span class="nc" id="L706">                minimapW.setBounds(0, 0, minimapW.getWidth(), minimapW.getHeight());</span>
<span class="nc" id="L707">                mechW.setBounds(0, 0, mechD.getWidth(), mechD.getHeight());</span>
<span class="nc" id="L708">                break;</span>
            case FILE_GAME_SAVE:
<span class="nc" id="L710">                saveGame();</span>
<span class="nc" id="L711">                break;</span>
            case FILE_GAME_SAVE_SERVER:
<span class="nc" id="L713">                ignoreHotKeys = true;</span>
<span class="nc" id="L714">                String filename = (String) JOptionPane.showInputDialog(frame, Messages.getString(&quot;ClientGUI.FileSaveServerDialog.message&quot;), Messages.getString(&quot;ClientGUI.FileSaveServerDialog.title&quot;), JOptionPane.QUESTION_MESSAGE, null, null, &quot;savegame.sav&quot;);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">                if (filename != null) {</span>
<span class="nc" id="L716">                    client.sendChat(&quot;/save &quot; + filename);</span>
                }
<span class="nc" id="L718">                ignoreHotKeys = false;</span>
<span class="nc" id="L719">                break;</span>
            case HELP_ABOUT:
<span class="nc" id="L721">                showAbout();</span>
<span class="nc" id="L722">                break;</span>
            case HELP_SKINNING:
<span class="nc" id="L724">                showSkinningHowTo();</span>
<span class="nc" id="L725">                break;</span>
            case HELP_CONTENTS:
<span class="nc" id="L727">                showHelp();</span>
<span class="nc" id="L728">                break;</span>
            case FILE_UNITS_SAVE:
<span class="nc" id="L730">                ignoreHotKeys = true;</span>
<span class="nc" id="L731">                doSaveUnit();</span>
<span class="nc" id="L732">                ignoreHotKeys = false;</span>
<span class="nc" id="L733">                break;</span>
            case FILE_UNITS_OPEN:
<span class="nc" id="L735">                ignoreHotKeys = true;</span>
<span class="nc" id="L736">                loadListFile();</span>
<span class="nc" id="L737">                ignoreHotKeys = false;</span>
<span class="nc" id="L738">                break;</span>
            case FILE_UNITS_CLEAR:
<span class="nc" id="L740">                deleteAllUnits(client);</span>
<span class="nc" id="L741">                break;</span>
            case FILE_UNITS_REINFORCE:
<span class="nc" id="L743">                ignoreHotKeys = true;</span>
<span class="nc" id="L744">                loadListFile(client.getLocalPlayer(), true);</span>
<span class="nc" id="L745">                ignoreHotKeys = false;</span>
<span class="nc" id="L746">                break;</span>
            case FILE_UNITS_REINFORCE_RAT:
<span class="nc" id="L748">                ignoreHotKeys = true;</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">                if (client.getLocalPlayer().getTeam() == IPlayer.TEAM_UNASSIGNED) {</span>
<span class="nc" id="L750">                    String title = Messages.getString(</span>
                            &quot;ClientGUI.openUnitListFileDialog.noReinforceTitle&quot;); //$NON-NLS-1$
<span class="nc" id="L752">                    String msg = Messages.getString(</span>
                            &quot;ClientGUI.openUnitListFileDialog.noReinforceMessage&quot;);  //$NON-NLS-1$
<span class="nc" id="L754">                    JOptionPane.showMessageDialog(frame, msg, title,</span>
                            JOptionPane.OK_OPTION, null);
<span class="nc" id="L756">                    return;</span>
                }
<span class="nc" id="L758">                getRandomArmyDialog().setVisible(true);</span>
<span class="nc" id="L759">                ignoreHotKeys = false;</span>
<span class="nc" id="L760">                break;</span>
            case FILE_REFRESH_CACHE:
<span class="nc" id="L762">                MechSummaryCache.refreshUnitData(false);</span>
<span class="nc" id="L763">                new Thread(mechSelectorDialog, &quot;Mech Selector Dialog&quot;).start();</span>
<span class="nc" id="L764">                break;</span>
            case VIEW_CLIENT_SETTINGS:
<span class="nc" id="L766">                showSettings();</span>
<span class="nc" id="L767">                break;</span>
            case VIEW_GAME_OPTIONS:
<span class="nc" id="L769">                showOptions();</span>
<span class="nc" id="L770">                break;</span>
            case VIEW_PLAYER_SETTINGS:
<span class="nc" id="L772">                customizePlayer();</span>
<span class="nc" id="L773">                break;</span>
            case VIEW_PLAYER_LIST:
<span class="nc" id="L775">                showPlayerList();</span>
<span class="nc" id="L776">                break;</span>
            case VIEW_ROUND_REPORT:
<span class="nc" id="L778">                showRoundReport();</span>
<span class="nc" id="L779">                break;</span>
            case FILE_BOARD_SAVE:
<span class="nc" id="L781">                ignoreHotKeys = true;</span>
<span class="nc" id="L782">                boardSave();</span>
<span class="nc" id="L783">                ignoreHotKeys = false;</span>
<span class="nc" id="L784">                break;</span>
            case FILE_BOARD_SAVE_AS:
<span class="nc" id="L786">                ignoreHotKeys = true;</span>
<span class="nc" id="L787">                boardSaveAs();</span>
<span class="nc" id="L788">                ignoreHotKeys = false;</span>
<span class="nc" id="L789">                break;</span>
            case FILE_BOARD_SAVE_AS_IMAGE:
<span class="nc" id="L791">                ignoreHotKeys = true;</span>
<span class="nc" id="L792">                boardSaveAsImage(true);</span>
<span class="nc" id="L793">                ignoreHotKeys = false;</span>
<span class="nc" id="L794">                break;</span>
            case FILE_BOARD_SAVE_AS_IMAGE_UNITS:
<span class="nc" id="L796">                ignoreHotKeys = true;</span>
<span class="nc" id="L797">                boardSaveAsImage(false);</span>
<span class="nc" id="L798">                ignoreHotKeys = false;</span>
<span class="nc" id="L799">                break;</span>
            case FILE_GAME_REPLACE_PLAYER:
<span class="nc" id="L801">                replacePlayer();</span>
<span class="nc" id="L802">                break;</span>
            case VIEW_MEK_DISPLAY:
<span class="nc" id="L804">                toggleDisplay();</span>
<span class="nc" id="L805">                break;</span>
            case VIEW_ACCESSIBILITY_WINDOW:
<span class="nc" id="L807">                toggleAccessibilityWindow();</span>
<span class="nc" id="L808">                break;</span>
            case VIEW_KEYBINDS_OVERLAY:
<span class="nc" id="L810">                bv.toggleKeybindsOverlay();</span>
<span class="nc" id="L811">                break;</span>
            case VIEW_MINI_MAP:
<span class="nc" id="L813">                toggleMap();</span>
<span class="nc" id="L814">                break;</span>
            case VIEW_UNIT_OVERVIEW:
<span class="nc" id="L816">                toggleUnitOverview();</span>
<span class="nc" id="L817">                break;</span>
            case VIEW_LOS_SETTING:
<span class="nc" id="L819">                showLOSSettingDialog();</span>
<span class="nc" id="L820">                break;</span>
            case VIEW_ZOOM_IN:
<span class="nc" id="L822">                bv.zoomIn();</span>
<span class="nc" id="L823">                break;</span>
            case VIEW_ZOOM_OUT:
<span class="nc" id="L825">                bv.zoomOut();</span>
<span class="nc" id="L826">                break;</span>
            case VIEW_TOGGLE_ISOMETRIC:
<span class="nc" id="L828">                GUIPreferences.getInstance().setIsometricEnabled(bv.toggleIsometric());</span>
<span class="nc" id="L829">                break;</span>
            case VIEW_TOGGLE_FOV_HIGHLIGHT:
<span class="nc" id="L831">                GUIPreferences.getInstance().setFovHighlight(</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                        !GUIPreferences.getInstance().getFovHighlight());</span>
<span class="nc" id="L833">                bv.refreshDisplayables();</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                if (client.getGame().getPhase() == Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L835">                    bv.clearHexImageCache();</span>
                }
                break;
            case VIEW_TOGGLE_FIELD_OF_FIRE:
<span class="nc" id="L839">                GUIPreferences.getInstance().setShowFieldOfFire(</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">                        !GUIPreferences.getInstance().getShowFieldOfFire());</span>
<span class="nc" id="L841">                bv.repaint();</span>
<span class="nc" id="L842">                break;</span>
            case VIEW_TOGGLE_FOV_DARKEN:
<span class="nc bnc" id="L844" title="All 2 branches missed.">                GUIPreferences.getInstance().setFovDarken(!GUIPreferences.getInstance().getFovDarken());</span>
<span class="nc" id="L845">                bv.refreshDisplayables();</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">                if (client.getGame().getPhase() == Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L847">                    bv.clearHexImageCache();</span>
                }
                break;
            case VIEW_TOGGLE_FIRING_SOLUTIONS:
<span class="nc" id="L851">                GUIPreferences.getInstance().setFiringSolutions(</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                        !GUIPreferences.getInstance().getFiringSolutions());</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                if (!GUIPreferences.getInstance().getFiringSolutions()) {</span>
<span class="nc" id="L854">                    bv.clearFiringSolutionData();</span>
                } else {
<span class="nc bnc" id="L856" title="All 2 branches missed.">                    if (curPanel instanceof FiringDisplay) {</span>
<span class="nc" id="L857">                        ((FiringDisplay) curPanel).setFiringSolutions();</span>
                    }
                }
<span class="nc" id="L860">                bv.refreshDisplayables();</span>
<span class="nc" id="L861">                break;</span>
            case VIEW_MOVE_ENV:
<span class="nc bnc" id="L863" title="All 2 branches missed.">                if (curPanel instanceof MovementDisplay) {</span>
<span class="nc" id="L864">                    GUIPreferences.getInstance().setMoveEnvelope(</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">                            !GUIPreferences.getInstance().getMoveEnvelope());</span>
<span class="nc" id="L866">                    ((MovementDisplay) curPanel).computeMovementEnvelope(mechD.getCurrentEntity());</span>
                }
                break;
            case VIEW_MOVE_MOD_ENV:
<span class="nc bnc" id="L870" title="All 2 branches missed.">                if (curPanel instanceof MovementDisplay) {</span>
<span class="nc" id="L871">                    ((MovementDisplay) curPanel).computeModifierEnvelope();</span>
                }
                break;
            case VIEW_CHANGE_THEME:
<span class="nc" id="L875">                bv.changeTheme();</span>
<span class="nc" id="L876">                break;</span>
            case FIRE_SAVE_WEAPON_ORDER:
<span class="nc" id="L878">                Entity ent = mechD.getCurrentEntity();</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">                if (ent != null) {</span>
<span class="nc" id="L880">                    WeaponOrderHandler.setWeaponOrder(ent.getChassis(),</span>
<span class="nc" id="L881">                            ent.getModel(), ent.getWeaponSortOrder(),</span>
<span class="nc" id="L882">                            ent.getCustomWeaponOrder());</span>
<span class="nc" id="L883">                    getMenuBar().updateSaveWeaponOrderMenuItem();</span>
<span class="nc" id="L884">                    client.sendEntityWeaponOrderUpdate(ent);</span>
                }
                break;
        }
<span class="nc" id="L888">    }</span>

    /**
     * Save all the current in use Entities each grouped by
     * player name
     * &lt;p/&gt;
     * and a file for salvage
     */
    public void doSaveUnit() {
<span class="nc bnc" id="L897" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; iter = getClient().getGame().getPlayers(); iter.hasMoreElements(); ) {</span>
<span class="nc" id="L898">            IPlayer p = iter.nextElement();</span>
<span class="nc" id="L899">            ArrayList&lt;Entity&gt; l = getClient().getGame().getPlayerEntities(p, false);</span>
            // Be sure to include all units that have retreated.
<span class="nc bnc" id="L901" title="All 2 branches missed.">            for (Enumeration&lt;Entity&gt; iter2 = getClient().getGame().getRetreatedEntities(); iter2.hasMoreElements(); ) {</span>
<span class="nc" id="L902">                Entity e = iter2.nextElement();</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                if (e.getOwnerId() == p.getId()) {</span>
<span class="nc" id="L904">                    l.add(e);</span>
                }
<span class="nc" id="L906">            }</span>
<span class="nc" id="L907">            saveListFile(l, p.getName());</span>
<span class="nc" id="L908">        }</span>

        // save all destroyed units in a separate &quot;salvage MUL&quot;
<span class="nc" id="L911">        ArrayList&lt;Entity&gt; destroyed = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L912">        Enumeration&lt;Entity&gt; graveyard = getClient().getGame().getGraveyardEntities();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">        while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L914">            Entity entity = graveyard.nextElement();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            if (entity.isSalvage()) {</span>
<span class="nc" id="L916">                destroyed.add(entity);</span>
            }
<span class="nc" id="L918">        }</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">        if (destroyed.size() &gt; 0) {</span>
<span class="nc" id="L920">            String sLogDir = PreferenceManager.getClientPreferences().getLogDirectory();</span>
<span class="nc" id="L921">            File logDir = new File(sLogDir);</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (!logDir.exists()) {</span>
<span class="nc" id="L923">                logDir.mkdir();</span>
            }
            // TODO : Salvage file name shouldn't be inline
<span class="nc" id="L926">            String fileName = &quot;salvage.mul&quot;;</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">            if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L928">                fileName = StringUtil.addDateTimeStamp(fileName);</span>
            }
<span class="nc" id="L930">            File unitFile = new File(sLogDir + File.separator + fileName);</span>
            try {
                // Save the destroyed entities to the file.
<span class="nc" id="L933">                EntityListFile.saveTo(unitFile, destroyed);</span>
<span class="nc" id="L934">            } catch (IOException e) {</span>
<span class="nc" id="L935">                MegaMek.getLogger().error(e);</span>
<span class="nc" id="L936">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), e.getMessage());</span>
<span class="nc" id="L937">            }</span>
        }
<span class="nc" id="L939">    }</span>


    /**
     * Saves the current settings to the cfg file.
     */
    void saveSettings() {
        // save frame location
<span class="nc" id="L947">        GUIPreferences.getInstance().setWindowPosX(frame.getLocation().x);</span>
<span class="nc" id="L948">        GUIPreferences.getInstance().setWindowPosY(frame.getLocation().y);</span>
<span class="nc" id="L949">        GUIPreferences.getInstance().setWindowSizeWidth(frame.getSize().width);</span>
<span class="nc" id="L950">        GUIPreferences.getInstance().setWindowSizeHeight(frame.getSize().height);</span>

        // also minimap
<span class="nc bnc" id="L953" title="All 4 branches missed.">        if ((minimapW != null) &amp;&amp; ((minimapW.getSize().width * minimapW.getSize().height) &gt; 0)) {</span>
<span class="nc" id="L954">            GUIPreferences.getInstance().setMinimapPosX(minimapW.getLocation().x);</span>
<span class="nc" id="L955">            GUIPreferences.getInstance().setMinimapPosY(minimapW.getLocation().y);</span>
<span class="nc" id="L956">            GUIPreferences.getInstance().setMinimapZoom(minimap.getZoom());</span>
        }

        // also mech display
<span class="nc bnc" id="L960" title="All 4 branches missed.">        if ((mechW != null) &amp;&amp; ((mechW.getSize().width * mechW.getSize().height) &gt; 0)) {</span>
<span class="nc" id="L961">            GUIPreferences.getInstance().setDisplayPosX(mechW.getLocation().x);</span>
<span class="nc" id="L962">            GUIPreferences.getInstance().setDisplayPosY(mechW.getLocation().y);</span>
<span class="nc" id="L963">            GUIPreferences.getInstance().setDisplaySizeWidth(mechW.getSize().width);</span>
<span class="nc" id="L964">            GUIPreferences.getInstance().setDisplaySizeHeight(mechW.getSize().height);</span>
        }

        // also ruler display
<span class="nc bnc" id="L968" title="All 6 branches missed.">        if ((ruler != null) &amp;&amp; (ruler.getSize().width != 0) &amp;&amp; (ruler.getSize().height != 0)) {</span>
<span class="nc" id="L969">            GUIPreferences.getInstance().setRulerPosX(ruler.getLocation().x);</span>
<span class="nc" id="L970">            GUIPreferences.getInstance().setRulerPosY(ruler.getLocation().y);</span>
<span class="nc" id="L971">            GUIPreferences.getInstance().setRulerSizeWidth(ruler.getSize().width);</span>
<span class="nc" id="L972">            GUIPreferences.getInstance().setRulerSizeHeight(ruler.getSize().height);</span>
        }
<span class="nc" id="L974">    }</span>

    /**
     * Shuts down threads and sockets
     */
    void die() {
        // Tell all the displays to remove themselves as listeners.
<span class="nc" id="L981">        boolean reportHandled = false;</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">        if (bv != null) {</span>
            //cleanup our timers first
<span class="nc" id="L984">            bv.die();</span>
        }
<span class="nc bnc" id="L986" title="All 2 branches missed.">        for (String s : phaseComponents.keySet()) {</span>
<span class="nc" id="L987">            JComponent component = phaseComponents.get(s);</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">            if (component instanceof ReportDisplay) {</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">                if (reportHandled) {</span>
<span class="nc" id="L990">                    continue;</span>
                }
<span class="nc" id="L992">                reportHandled = true;</span>
            }
<span class="nc bnc" id="L994" title="All 2 branches missed.">            if (component instanceof Distractable) {</span>
<span class="nc" id="L995">                ((Distractable) component).removeAllListeners();</span>
            }
<span class="nc" id="L997">        } // Handle the next component</span>
<span class="nc" id="L998">        phaseComponents.clear();</span>

<span class="nc" id="L1000">        frame.removeAll();</span>
<span class="nc" id="L1001">        frame.setVisible(false);</span>
        try {
<span class="nc" id="L1003">            frame.dispose();</span>
<span class="nc" id="L1004">        } catch (Throwable error) {</span>
<span class="nc" id="L1005">            error.printStackTrace();</span>
<span class="nc" id="L1006">        }</span>
<span class="nc" id="L1007">        client.die();</span>

        // TODO Is there a better solution?
        // This is required because the ChatLounge adds the listener to the
        // MechSummaryCache that must be removed explicitly.
<span class="nc bnc" id="L1012" title="All 2 branches missed.">        if (chatlounge != null) {</span>
<span class="nc" id="L1013">            chatlounge.die();</span>
        }
<span class="nc" id="L1015">        TimerSingleton.getInstance().killTimer();</span>

<span class="nc bnc" id="L1017" title="All 2 branches missed.">        if (controller != null) {</span>
<span class="nc" id="L1018">            controller.removeAllActions();</span>
<span class="nc" id="L1019">            controller.clientgui = null;</span>
        }

<span class="nc bnc" id="L1022" title="All 2 branches missed.">        if (menuBar != null) {</span>
<span class="nc" id="L1023">            menuBar.die();</span>
<span class="nc" id="L1024">            menuBar = null;</span>
        }
<span class="nc" id="L1026">    }</span>

    public GameOptionsDialog getGameOptionsDialog() {
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (gameOptionsDialog == null) {</span>
<span class="nc" id="L1030">            gameOptionsDialog = new GameOptionsDialog(this);</span>
        }
<span class="nc" id="L1032">        return gameOptionsDialog;</span>
    }

    public AbstractUnitSelectorDialog getMechSelectorDialog() {
<span class="nc" id="L1036">        return mechSelectorDialog;</span>
    }

    public StartingPositionDialog getStartingPositionDialog() {
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (startingPositionDialog == null) {</span>
<span class="nc" id="L1041">            startingPositionDialog = new StartingPositionDialog(this);</span>
        }
<span class="nc" id="L1043">        return startingPositionDialog;</span>
    }

    public PlanetaryConditionsDialog getPlanetaryConditionsDialog() {
<span class="nc bnc" id="L1047" title="All 2 branches missed.">        if (conditionsDialog == null) {</span>
<span class="nc" id="L1048">            conditionsDialog = new PlanetaryConditionsDialog(this);</span>
        }
<span class="nc" id="L1050">        return conditionsDialog;</span>
    }

    void switchPanel(IGame.Phase phase) {
        // Clear the old panel's listeners.
<span class="nc bnc" id="L1055" title="All 2 branches missed.">        if (curPanel instanceof BoardViewListener) {</span>
<span class="nc" id="L1056">            bv.removeBoardViewListener((BoardViewListener) curPanel);</span>
        }
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        if (curPanel instanceof ActionListener) {</span>
<span class="nc" id="L1059">            menuBar.removeActionListener((ActionListener) curPanel);</span>
        }
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        if (curPanel instanceof Distractable) {</span>
<span class="nc" id="L1062">            ((Distractable) curPanel).setIgnoringEvents(true);</span>
        }

        // Get the new panel.
<span class="nc" id="L1066">        String name = String.valueOf(phase);</span>
<span class="nc" id="L1067">        curPanel = phaseComponents.get(name);</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">        if (curPanel == null) {</span>
<span class="nc" id="L1069">            curPanel = initializePanel(phase);</span>
        }

        // Handle phase-specific items.
<span class="nc bnc" id="L1073" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
                // reset old report tabs and images, if any
<span class="nc" id="L1076">                ReportDisplay rD = (ReportDisplay) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">                if (rD != null) {</span>
<span class="nc" id="L1078">                    rD.resetTabs();</span>
                }
<span class="nc" id="L1080">                ChatLounge cl = (ChatLounge) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_LOUNGE));</span>
<span class="nc" id="L1081">                cb.setDoneButton(cl.butDone);</span>
<span class="nc" id="L1082">                cl.add(cb.getComponent(), BorderLayout.SOUTH);</span>
<span class="nc" id="L1083">                getBoardView().getTilesetManager().reset();</span>
<span class="nc" id="L1084">                mechW.setVisible(false);</span>
<span class="nc" id="L1085">                setMapVisible(false);</span>
<span class="nc" id="L1086">                break;</span>
            case PHASE_POINTBLANK_SHOT:
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_TARGETING:
            case PHASE_MOVEMENT:
            case PHASE_OFFBOARD:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
<span class="nc bnc" id="L1096" title="All 4 branches missed.">                if (GUIPreferences.getInstance().getMinimapEnabled() &amp;&amp; !minimapW.isVisible()) {</span>
<span class="nc" id="L1097">                    setMapVisible(true);</span>
                }
                break;
            case PHASE_INITIATIVE_REPORT:
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
            case PHASE_VICTORY:
<span class="nc" id="L1108">                rD = (ReportDisplay) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</span>
<span class="nc" id="L1109">                cb.setDoneButton(rD.butDone);</span>
<span class="nc" id="L1110">                rD.add(cb.getComponent(), GBC.eol().fill(GridBagConstraints.HORIZONTAL));</span>
<span class="nc" id="L1111">                setMapVisible(false);</span>
<span class="nc" id="L1112">                mechW.setVisible(false);</span>
<span class="nc" id="L1113">                break;</span>
            default:
                break;
        }

<span class="nc" id="L1118">        cardsMain.show(panMain, mainNames.get(name));</span>
<span class="nc" id="L1119">        String secondaryToShow = secondaryNames.get(name);</span>
        // only show the secondary component if there is one to show
<span class="nc bnc" id="L1121" title="All 2 branches missed.">        if (secondaryToShow != null) {</span>
<span class="nc" id="L1122">            panSecondary.setVisible(true);</span>
<span class="nc" id="L1123">            cardsSecondary.show(panSecondary, secondaryNames.get(name));</span>
        } else {
            // otherwise, hide the panel
<span class="nc" id="L1126">            panSecondary.setVisible(false);</span>
        }

        // Set the new panel's listeners
<span class="nc bnc" id="L1130" title="All 2 branches missed.">        if (curPanel instanceof BoardViewListener) {</span>
<span class="nc" id="L1131">            bv.addBoardViewListener((BoardViewListener) curPanel);</span>
        }
<span class="nc bnc" id="L1133" title="All 2 branches missed.">        if (curPanel instanceof ActionListener) {</span>
<span class="nc" id="L1134">            menuBar.addActionListener((ActionListener) curPanel);</span>
        }
<span class="nc bnc" id="L1136" title="All 2 branches missed.">        if (curPanel instanceof Distractable) {</span>
<span class="nc" id="L1137">            ((Distractable) curPanel).setIgnoringEvents(false);</span>
        }

        // Make the new panel the focus, if the Client option says so
<span class="nc bnc" id="L1141" title="All 4 branches missed.">        if (GUIPreferences.getInstance().getFocus() &amp;&amp; !(client instanceof TestBot)) {</span>
<span class="nc" id="L1142">            curPanel.requestFocus();</span>
        }
<span class="nc" id="L1144">    }</span>

    public void updateButtonPanel(IGame.Phase phase) {
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if ((currPhaseDisplay != null)</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">                &amp;&amp; client.getGame().getPhase().equals(phase)) {</span>
<span class="nc" id="L1149">            currPhaseDisplay.setupButtonPanel();</span>
        }
<span class="nc" id="L1151">    }</span>

    private JComponent initializePanel(IGame.Phase phase) {
        // Create the components for this phase.
<span class="nc" id="L1155">        String name = String.valueOf(phase);</span>
        JComponent component;
<span class="nc" id="L1157">        String secondary = null;</span>
        String main;
<span class="nc bnc" id="L1159" title="All 15 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L1161">                component = new ChatLounge(this);</span>
<span class="nc" id="L1162">                chatlounge = (ChatLounge) component;</span>
<span class="nc" id="L1163">                main = &quot;ChatLounge&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1164">                component.setName(main);</span>
<span class="nc" id="L1165">                panMain.add(component, main);</span>
<span class="nc" id="L1166">                break;</span>
            case PHASE_STARTING_SCENARIO:
<span class="nc" id="L1168">                component = new JLabel(Messages.getString(&quot;ClientGUI.StartingScenario&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1169">                main = &quot;JLabel-StartingScenario&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1170">                component.setName(main);</span>
<span class="nc" id="L1171">                panMain.add(component, main);</span>
<span class="nc" id="L1172">                break;</span>
            case PHASE_EXCHANGE:
<span class="nc" id="L1174">                component = new JLabel(Messages.getString(&quot;ClientGUI.TransmittingData&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1175">                main = &quot;JLabel-Exchange&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1176">                component.setName(main);</span>
<span class="nc" id="L1177">                panMain.add(component, main);</span>
<span class="nc" id="L1178">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L1180">                component = new SelectArtyAutoHitHexDisplay(this);</span>
<span class="nc" id="L1181">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1182">                secondary = &quot;SelectArtyAutoHitHexDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1183">                component.setName(secondary);</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1185">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1187">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1188">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1189">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L1191">                component = new DeployMinefieldDisplay(this);</span>
<span class="nc" id="L1192">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1193">                secondary = &quot;DeployMinefieldDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1194">                component.setName(secondary);</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1196">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1198">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1199">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1200">                break;</span>
            case PHASE_DEPLOYMENT:
<span class="nc" id="L1202">                component = new DeploymentDisplay(this);</span>
<span class="nc" id="L1203">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1204">                secondary = &quot;DeploymentDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1205">                component.setName(secondary);</span>
<span class="nc bnc" id="L1206" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1207">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1209">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1210">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1211">                break;</span>
            case PHASE_TARGETING:
<span class="nc" id="L1213">                component = new TargetingPhaseDisplay(this, false);</span>
<span class="nc" id="L1214">                ((TargetingPhaseDisplay) component).initializeListeners();</span>
<span class="nc" id="L1215">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1216">                secondary = &quot;TargetingPhaseDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1217">                component.setName(secondary);</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1219">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1221">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1222">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1223">                offBoardOverlay.setTargetingPhaseDisplay((TargetingPhaseDisplay) component);</span>
<span class="nc" id="L1224">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc" id="L1226">                component = new MovementDisplay(this);</span>
<span class="nc" id="L1227">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1228">                secondary = &quot;MovementDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1229">                component.setName(secondary);</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1231">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1233">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1234">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1235">                break;</span>
            case PHASE_OFFBOARD:
<span class="nc" id="L1237">                component = new TargetingPhaseDisplay(this, true);</span>
<span class="nc" id="L1238">                ((TargetingPhaseDisplay) component).initializeListeners();</span>
<span class="nc" id="L1239">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1240">                secondary = &quot;OffboardDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1241">                component.setName(secondary);</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1243">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1245">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1246">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1247">                break;</span>
            case PHASE_FIRING:
<span class="nc" id="L1249">                component = new FiringDisplay(this);</span>
<span class="nc" id="L1250">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1251">                secondary = &quot;FiringDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1252">                component.setName(secondary);</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1254">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1256">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1257">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1258">                break;</span>
            case PHASE_POINTBLANK_SHOT:
<span class="nc" id="L1260">                component = new PointblankShotDisplay(this);</span>
<span class="nc" id="L1261">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1262">                secondary = &quot;PointblankShotDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1263">                component.setName(secondary);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1265">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1267">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1268">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1269">                break;</span>
            case PHASE_PHYSICAL:
<span class="nc" id="L1271">                component = new PhysicalDisplay(this);</span>
<span class="nc" id="L1272">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1273">                secondary = &quot;PhysicalDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1274">                component.setName(secondary);</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1276">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1278">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1279">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1280">                break;</span>
            case PHASE_INITIATIVE_REPORT:
<span class="nc" id="L1282">                component = new ReportDisplay(this);</span>
<span class="nc" id="L1283">                main = &quot;ReportDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1284">                component.setName(main);</span>
<span class="nc" id="L1285">                panMain.add(main, component);</span>
<span class="nc" id="L1286">                break;</span>
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
            case PHASE_VICTORY:
                // Try to reuse the ReportDisplay for other phases...
<span class="nc" id="L1295">                component = phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">                if (component == null) {</span>
                    // no ReportDisplay to reuse -- get a new one
<span class="nc" id="L1298">                    component = initializePanel(IGame.Phase.PHASE_INITIATIVE_REPORT);</span>
                }
<span class="nc" id="L1300">                main = &quot;ReportDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1301">                break;</span>
            default:
<span class="nc" id="L1303">                component = new JLabel(Messages.getString(&quot;ClientGUI.waitingOnTheServer&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1304">                main = &quot;JLabel-Default&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1305">                secondary = main;</span>
<span class="nc" id="L1306">                component.setName(main);</span>
<span class="nc" id="L1307">                panMain.add(main, component);</span>
        }
<span class="nc" id="L1309">        phaseComponents.put(name, component);</span>
<span class="nc" id="L1310">        mainNames.put(name, main);</span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (secondary != null) {</span>
<span class="nc" id="L1312">            secondaryNames.put(name, secondary);</span>
        }
<span class="nc" id="L1314">        return component;</span>
    }

    protected void showBoardPopup(Coords c) {
<span class="nc bnc" id="L1318" title="All 2 branches missed.">        if (fillPopup(c)) {</span>
<span class="nc" id="L1319">            bv.showPopup(popup, c);</span>
        }
<span class="nc" id="L1321">    }</span>

    /** Switches the Minimap and the MechDisplay an and off together.
     *  If the MechDisplay is active, both will be hidden, else
     *  both will be shown.
     */
    public void toggleMMUDDisplays() {
<span class="nc bnc" id="L1328" title="All 2 branches missed.">        if (mechW.isVisible()) {</span>
<span class="nc" id="L1329">            setDisplayVisible(false);</span>
<span class="nc" id="L1330">            setMapVisible(false);</span>
        } else {
<span class="nc" id="L1332">            setDisplayVisible(true);</span>
<span class="nc" id="L1333">            setMapVisible(true);</span>
        }
<span class="nc" id="L1335">    }</span>

    /**
     * Toggles the entity display window
     */
    private void toggleDisplay() {
<span class="nc bnc" id="L1341" title="All 2 branches missed.">        mechW.setVisible(!mechW.isVisible());</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        if (mechW.isVisible()) {</span>
<span class="nc" id="L1343">            frame.requestFocus();</span>
        }
<span class="nc" id="L1345">    }</span>

    /**
     * Toggles the accessibility window
     */
    private void toggleAccessibilityWindow() {
<span class="nc bnc" id="L1351" title="All 2 branches missed.">        aw.setVisible(!aw.isVisible());</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">        if (aw.isVisible()) {</span>
<span class="nc" id="L1353">            frame.requestFocus();</span>
        }
<span class="nc" id="L1355">    }</span>

    /**
     * Sets the visibility of the entity display window
     */
    public void setDisplayVisible(boolean visible) {
        // If no unit displayed, select a unit so display can be safely shown
        // This can happen when using mouse button 4
<span class="nc" id="L1363">        Entity unitToSelect = null;</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">        IGame game = (getClient() != null) ? getClient().getGame() : null;</span>
<span class="nc bnc" id="L1365" title="All 4 branches missed.">        if ((mechD.getCurrentEntity() == null) &amp;&amp; (game != null)) {</span>
<span class="nc" id="L1366">            List&lt;Entity&gt; es = getClient().getGame().getEntitiesVector();</span>
<span class="nc bnc" id="L1367" title="All 4 branches missed.">            if ((es != null) &amp;&amp; (es.size() &gt; 0)) {</span>
<span class="nc" id="L1368">                unitToSelect = es.get(0);</span>
            }
        }

<span class="nc" id="L1372">        mechW.setVisible(visible);</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">        if (unitToSelect != null) {</span>
<span class="nc" id="L1374">            mechD.displayEntity(unitToSelect);</span>
        }
<span class="nc bnc" id="L1376" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L1377">            frame.requestFocus();</span>
        }
<span class="nc" id="L1379">    }</span>

    private void toggleUnitOverview() {
<span class="nc bnc" id="L1382" title="All 2 branches missed.">        uo.setVisible(!uo.isVisible());</span>
<span class="nc" id="L1383">        GUIPreferences.getInstance().setShowUnitOverview(uo.isVisible());</span>
<span class="nc" id="L1384">        bv.refreshDisplayables();</span>
<span class="nc" id="L1385">    }</span>

    /**
     * Toggles the minimap window Also, toggles the minimap enabled setting
     */
    private void toggleMap() {
<span class="nc bnc" id="L1391" title="All 2 branches missed.">        minimapW.setVisible(!minimapW.isVisible());</span>
<span class="nc" id="L1392">        GUIPreferences.getInstance().setMinimapEnabled(minimapW.isVisible());</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">        if (minimapW.isVisible()) {</span>
<span class="nc" id="L1394">            frame.requestFocus();</span>
        }
<span class="nc" id="L1396">    }</span>

    /**
     * Sets the visibility of the minimap window
     */
    void setMapVisible(boolean visible) {
<span class="nc" id="L1402">        minimapW.setVisible(visible);</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L1404">            frame.requestFocus();</span>
        }
<span class="nc" id="L1406">    }</span>

    private boolean fillPopup(Coords coords) {
<span class="nc" id="L1409">        popup = new MapMenu(coords, client, curPanel, this);</span>
<span class="nc" id="L1410">        return popup.getHasMenu();</span>
    }

    /**
     * Pops up a dialog box giving the player a series of choices that are not
     * mutually exclusive.
     *
     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
     *                 answer. The question will be split across multiple line on the
     *                 '\n' characters.
     * @param choices  the array of &lt;code&gt;String&lt;/code&gt; choices that the player can
     *                 select from.
     * @return The array of the &lt;code&gt;int&lt;/code&gt; indexes of the from the input
     *         array that match the selected choices. If no choices were
     *         available, if the player did not select a choice, or if the
     *         player canceled the choice, a &lt;code&gt;null&lt;/code&gt; value is
     *         returned.
     */
    public int[] doChoiceDialog(String title, String question, String[] choices) {
<span class="nc" id="L1430">        ChoiceDialog choice = new ChoiceDialog(frame, title, question, choices);</span>
<span class="nc" id="L1431">        choice.setVisible(true);</span>
<span class="nc" id="L1432">        return choice.getChoices();</span>
    }

    /**
     * Pops up a dialog box showing an alert
     */
    public void doAlertDialog(String title, String message) {
<span class="nc" id="L1439">        JTextPane textArea = new JTextPane();</span>
<span class="nc" id="L1440">        ReportDisplay.setupStylesheet(textArea);</span>
<span class="nc" id="L1441">        BASE64ToolKit toolKit = new BASE64ToolKit();</span>
<span class="nc" id="L1442">        textArea.setEditorKit(toolKit);</span>
<span class="nc" id="L1443">        textArea.setEditable(false);</span>
<span class="nc" id="L1444">        JScrollPane scrollPane = new JScrollPane(textArea,</span>
                ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,
                ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L1447">        textArea.setText(&quot;&lt;pre&gt;&quot; + message + &quot;&lt;/pre&gt;&quot;);</span>
<span class="nc" id="L1448">        scrollPane.setPreferredSize(new Dimension(</span>
<span class="nc" id="L1449">                (int) (getSize().getWidth() / 1.5), (int) (getSize()</span>
<span class="nc" id="L1450">                        .getHeight() / 1.5)));</span>
<span class="nc" id="L1451">        JOptionPane.showMessageDialog(frame, scrollPane, title,</span>
                JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1453">    }</span>

    /**
     * Pops up a dialog box asking a yes/no question
     *
     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
     *                 answer. The question will be split across multiple line on the
     *                 '\n' characters.
     * @return &lt;code&gt;true&lt;/code&gt; if yes
     */
    public boolean doYesNoDialog(String title, String question) {
<span class="nc" id="L1465">        ConfirmDialog confirm = new ConfirmDialog(frame, title, question);</span>
<span class="nc" id="L1466">        confirm.setVisible(true);</span>
<span class="nc" id="L1467">        return confirm.getAnswer();</span>
    }

    /**
     * Pops up a dialog box asking a yes/no question
     * &lt;p/&gt;
     * The player will be given a chance to not show the dialog again.
     *
     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
     *                 answer. The question will be split across multiple line on the
     *                 '\n' characters.
     * @return the &lt;code&gt;ConfirmDialog&lt;/code&gt; containing the player's responses.
     *         The dialog will already have been shown to the player, and is
     *         only being returned so the calling function can see the answer to
     *         the question and the state of the &quot;Show again?&quot; question.
     */
    public ConfirmDialog doYesNoBotherDialog(String title, String question) {
<span class="nc" id="L1485">        ConfirmDialog confirm = new ConfirmDialog(frame, title, question, true);</span>
<span class="nc" id="L1486">        confirm.setVisible(true);</span>
<span class="nc" id="L1487">        return confirm;</span>
    }

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     */
    protected void loadListFile() {
<span class="nc" id="L1498">        loadListFile(client.getLocalPlayer());</span>
<span class="nc" id="L1499">    }</span>

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     *
     * @param c
     */
    protected void loadListFile(Client c) {
<span class="nc" id="L1511">        loadListFile(c.getLocalPlayer());</span>
<span class="nc" id="L1512">    }</span>

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     *
     * @param player
     */
    protected void loadListFile(IPlayer player) {
<span class="nc" id="L1524">        loadListFile(player, false);</span>
<span class="nc" id="L1525">    }</span>

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     *
     * @param player
     */
    protected void loadListFile(IPlayer player, boolean reinforce) {
<span class="nc" id="L1537">        boolean addedUnits = false;</span>

<span class="nc bnc" id="L1539" title="All 4 branches missed.">        if (reinforce &amp;&amp; player.getTeam() == IPlayer.TEAM_UNASSIGNED){</span>
<span class="nc" id="L1540">            String title = Messages.getString(</span>
                    &quot;ClientGUI.openUnitListFileDialog.noReinforceTitle&quot;); //$NON-NLS-1$
<span class="nc" id="L1542">            String msg = Messages.getString(</span>
                    &quot;ClientGUI.openUnitListFileDialog.noReinforceMessage&quot;);  //$NON-NLS-1$
<span class="nc" id="L1544">            JOptionPane.showMessageDialog(frame, msg, title,</span>
                    JOptionPane.OK_OPTION, null);
<span class="nc" id="L1546">            return;</span>
        }
        // Build the &quot;load unit&quot; dialog, if necessary.
<span class="nc bnc" id="L1549" title="All 2 branches missed.">        if (dlgLoadList == null) {</span>
<span class="nc" id="L1550">            dlgLoadList = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1551">            dlgLoadList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1552">            dlgLoadList.setDialogTitle(Messages.getString(&quot;ClientGUI.openUnitListFileDialog.title&quot;));</span>
<span class="nc" id="L1553">            dlgLoadList.setFileFilter(new FileFilter() {</span>
                @Override
                public boolean accept(File dir) {
<span class="nc bnc" id="L1556" title="All 4 branches missed.">                    return (dir.getName().endsWith(&quot;.mul&quot;) || dir.isDirectory()); //$NON-NLS-1$</span>
                }

                @Override
                public String getDescription() {
<span class="nc" id="L1561">                    return &quot;*.mul&quot;;</span>
                }
            });
            // Default to the player's name.
<span class="nc" id="L1565">            dlgLoadList.setSelectedFile(new File(player.getName() + &quot;.mul&quot;)); //$NON-NLS-1$</span>
        }

<span class="nc" id="L1568">        int returnVal = dlgLoadList.showOpenDialog(frame);</span>
<span class="nc bnc" id="L1569" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgLoadList.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1571">            return;</span>
        }

        // Did the player select a file?
<span class="nc" id="L1575">        File unitFile = dlgLoadList.getSelectedFile();</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">        if (unitFile != null) {</span>
            try {
                // Read the units from the file.
<span class="nc" id="L1579">                Vector&lt;Entity&gt; loadedUnits = EntityListFile.loadFrom(unitFile);</span>

                // Add the units from the file.
<span class="nc bnc" id="L1582" title="All 2 branches missed.">                for (Entity entity : loadedUnits) {</span>
<span class="nc" id="L1583">                    entity.setOwner(player);</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">                    if (reinforce) {</span>
<span class="nc" id="L1585">                        entity.setDeployRound(client.getGame().getRoundCount()+1);</span>
<span class="nc" id="L1586">                        entity.setGame(client.getGame());</span>
                        // Set these to true, otherwise units reinforced in
                        // the movement turn are considered selectable
<span class="nc" id="L1589">                        entity.setDone(true);</span>
<span class="nc" id="L1590">                        entity.setUnloaded(true);</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">                        if (entity instanceof IBomber) {</span>
<span class="nc" id="L1592">                            ((IBomber)entity).applyBombs();</span>
                        }
                    }
<span class="nc" id="L1595">                }</span>
<span class="nc bnc" id="L1596" title="All 2 branches missed.">                if (loadedUnits.size() &gt; 0){</span>
<span class="nc" id="L1597">                    client.sendAddEntity(loadedUnits);</span>
<span class="nc" id="L1598">                    addedUnits = true;</span>
                }
<span class="nc" id="L1600">            } catch (IOException excep) {</span>
<span class="nc" id="L1601">                excep.printStackTrace(System.err);</span>
<span class="nc" id="L1602">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorLoadingFile&quot;), excep.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1603">            }</span>
        }

        // If we've added reinforcements, then we need to set the round deployment up again.
<span class="nc bnc" id="L1607" title="All 4 branches missed.">        if (addedUnits &amp;&amp; reinforce) {</span>
<span class="nc" id="L1608">            client.getGame().setupRoundDeployment();</span>
<span class="nc" id="L1609">            client.sendResetRoundDeployment();</span>
        }
<span class="nc" id="L1611">    }</span>

    public void deleteAllUnits(Client c) {
<span class="nc" id="L1614">        ArrayList&lt;Entity&gt; currentUnits = c.getGame().getPlayerEntities(</span>
<span class="nc" id="L1615">                c.getLocalPlayer(), false);</span>
<span class="nc" id="L1616">        ArrayList&lt;Integer&gt; ids = new ArrayList&lt;&gt;(currentUnits.size());</span>
<span class="nc bnc" id="L1617" title="All 2 branches missed.">        for (Entity e : currentUnits){</span>
<span class="nc" id="L1618">            ids.add(e.getId());</span>
<span class="nc" id="L1619">        }</span>
<span class="nc" id="L1620">        c.sendDeleteEntities(ids);</span>
<span class="nc" id="L1621">    }</span>

    private boolean saveGame() {
<span class="nc" id="L1624">        ignoreHotKeys = true;</span>
<span class="nc" id="L1625">        JFileChooser fc = new JFileChooser(&quot;./savegames&quot;);</span>
<span class="nc" id="L1626">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1627">        fc.setDialogTitle(Messages.getString(&quot;ClientGUI.FileSaveDialog.title&quot;));</span>

<span class="nc" id="L1629">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc" id="L1630">        ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1631" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1633">            return false;</span>
        }
<span class="nc bnc" id="L1635" title="All 2 branches missed.">        if (fc.getSelectedFile() != null) {</span>
<span class="nc" id="L1636">            String file = fc.getSelectedFile().getName();</span>
            // stupid hack to allow for savegames in folders with spaces in
            // the name
<span class="nc" id="L1639">            String path = fc.getSelectedFile().getParentFile().getPath();</span>
<span class="nc" id="L1640">            path = path.replace(&quot; &quot;, &quot;|&quot;);</span>
<span class="nc" id="L1641">            client.sendChat(&quot;/localsave &quot; + file + &quot; &quot; + path); //$NON-NLS-1$</span>
<span class="nc" id="L1642">            return true;</span>
        }
<span class="nc" id="L1644">        return false;</span>
    }

    /**
     * Allow the player to save a list of entities to a MegaMek Unit List file.
     * A &quot;Save As&quot; dialog will be displayed that allows the user to select the
     * file's name and directory. The player can later load this file to quickly
     * select the units for a new game. The file will record damage sustained,
     * non-standard munitions selected, and ammunition expended during the
     * course of the current engagement.
     *
     * @param unitList - the &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Entity&lt;/code&gt;s to be saved
     *                 to a file. If this value is &lt;code&gt;null&lt;/code&gt; or empty, the
     *                 &quot;Save As&quot; dialog will not be displayed.
     */
    protected void saveListFile(ArrayList&lt;Entity&gt; unitList) {
<span class="nc" id="L1660">        saveListFile(unitList, client.getLocalPlayer().getName());</span>
<span class="nc" id="L1661">    }</span>

    protected void saveListFile(ArrayList&lt;Entity&gt; unitList, String filename) {
        // Handle empty lists.
<span class="nc bnc" id="L1665" title="All 4 branches missed.">        if ((unitList == null) || unitList.isEmpty()) {</span>
<span class="nc" id="L1666">            return;</span>
        }

        // Build the &quot;save unit&quot; dialog, if necessary.
<span class="nc bnc" id="L1670" title="All 2 branches missed.">        if (dlgSaveList == null) {</span>
<span class="nc" id="L1671">            dlgSaveList = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1672">            dlgSaveList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1673">            dlgSaveList.setDialogTitle(Messages.getString(&quot;ClientGUI.saveUnitListFileDialog.title&quot;));</span>
<span class="nc" id="L1674">            FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Mul Files&quot;, &quot;mul&quot;);</span>
<span class="nc" id="L1675">            dlgSaveList.setFileFilter(filter);</span>
        }
        // Default to the player's name.
<span class="nc" id="L1678">        dlgSaveList.setSelectedFile(new File(filename + &quot;.mul&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L1680">        int returnVal = dlgSaveList.showSaveDialog(frame);</span>
<span class="nc bnc" id="L1681" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgSaveList.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1683">            return;</span>
        }

        // Did the player select a file?
<span class="nc" id="L1687">        File unitFile = dlgSaveList.getSelectedFile();</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">        if (unitFile != null) {</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">            if (!(unitFile.getName().toLowerCase().endsWith(&quot;.mul&quot;) //$NON-NLS-1$</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">                    || unitFile.getName().toLowerCase().endsWith(&quot;.xml&quot;))) { //$NON-NLS-1$</span>
                try {
<span class="nc" id="L1692">                    unitFile = new File(unitFile.getCanonicalPath() + &quot;.mul&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1693">                } catch (IOException ie) {</span>
                    // nothing needs to be done here
<span class="nc" id="L1695">                    return;</span>
<span class="nc" id="L1696">                }</span>
            }
            try {
                // Save the player's entities to the file.
<span class="nc" id="L1700">                EntityListFile.saveTo(unitFile, unitList);</span>
<span class="nc" id="L1701">            } catch (IOException excep) {</span>
<span class="nc" id="L1702">                excep.printStackTrace(System.err);</span>
<span class="nc" id="L1703">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), excep.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1704">            }</span>
        }
<span class="nc" id="L1706">    }</span>

    protected void saveVictoryList() {
<span class="nc" id="L1709">        String filename = client.getLocalPlayer().getName();</span>

        // Build the &quot;save unit&quot; dialog, if necessary.
<span class="nc bnc" id="L1712" title="All 2 branches missed.">        if (dlgSaveList == null) {</span>
<span class="nc" id="L1713">            dlgSaveList = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1714">            dlgSaveList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1715">            dlgSaveList.setDialogTitle(Messages.getString(&quot;ClientGUI.saveUnitListFileDialog.title&quot;));</span>
<span class="nc" id="L1716">            FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Mul Files&quot;, &quot;mul&quot;);</span>
<span class="nc" id="L1717">            dlgSaveList.setFileFilter(filter);</span>
        }
        // Default to the player's name.
<span class="nc" id="L1720">        dlgSaveList.setSelectedFile(new File(filename + &quot;.mul&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L1722">        int returnVal = dlgSaveList.showSaveDialog(frame);</span>
<span class="nc bnc" id="L1723" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgSaveList.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1725">            return;</span>
        }

        // Did the player select a file?
<span class="nc" id="L1729">        File unitFile = dlgSaveList.getSelectedFile();</span>
<span class="nc bnc" id="L1730" title="All 2 branches missed.">        if (unitFile != null) {</span>
<span class="nc bnc" id="L1731" title="All 2 branches missed.">            if (!(unitFile.getName().toLowerCase().endsWith(&quot;.mul&quot;) //$NON-NLS-1$</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">                    || unitFile.getName().toLowerCase().endsWith(&quot;.xml&quot;))) { //$NON-NLS-1$</span>
                try {
<span class="nc" id="L1734">                    unitFile = new File(unitFile.getCanonicalPath() + &quot;.mul&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1735">                } catch (IOException ie) {</span>
                    // nothing needs to be done here
<span class="nc" id="L1737">                    return;</span>
<span class="nc" id="L1738">                }</span>
            }
            try {
                // Save the player's entities to the file.
<span class="nc" id="L1742">                EntityListFile.saveTo(unitFile, getClient());</span>
<span class="nc" id="L1743">            } catch (IOException excep) {</span>
<span class="nc" id="L1744">                excep.printStackTrace(System.err);</span>
<span class="nc" id="L1745">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), excep.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1746">            }</span>
        }
<span class="nc" id="L1748">    }</span>

    //region Window Listeners
    @Override
    public void windowActivated(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1754">    }</span>

    @Override
    public void windowClosed(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1759">    }</span>

    @Override
    public void windowClosing(WindowEvent windowEvent) {
<span class="nc bnc" id="L1763" title="All 2 branches missed.">        if (windowEvent.getWindow().equals(minimapW)) {</span>
<span class="nc" id="L1764">            setMapVisible(false);</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">        } else if (windowEvent.getWindow().equals(mechW)) {</span>
<span class="nc" id="L1766">            setDisplayVisible(false);</span>
        }
<span class="nc" id="L1768">    }</span>

    @Override
    public void windowDeactivated(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1773">    }</span>

    @Override
    public void windowDeiconified(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1778">    }</span>

    @Override
    public void windowIconified(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1783">    }</span>

    @Override
    public void windowOpened(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1788">    }</span>
    //endregion Window Listeners

    /**
     * @return the frame this client is displayed in
     */
    public JFrame getFrame() {
<span class="nc" id="L1795">        return frame;</span>
    }

    /**
     * Shows a dialog where the player can select the entity types
     * used in the LOS tool.
     */
    private void showLOSSettingDialog() {
<span class="nc" id="L1803">        GUIPreferences gp = GUIPreferences.getInstance();</span>
<span class="nc" id="L1804">        LOSDialog ld = new LOSDialog(frame, gp.getMechInFirst(), gp.getMechInSecond());</span>
<span class="nc" id="L1805">        ld.setVisible(true);</span>
<span class="nc" id="L1806">        gp.setMechInFirst(ld.getMechInFirst());</span>
<span class="nc" id="L1807">        gp.setMechInSecond(ld.getMechInSecond());</span>
<span class="nc" id="L1808">    }</span>

    /**
     * Loads a preview image of the unit into the BufferedPanel.
     *
     * @param bp
     * @param entity
     */
    public void loadPreviewImage(JLabel bp, Entity entity) {
<span class="nc" id="L1817">        IPlayer player = client.getGame().getPlayer(entity.getOwnerId());</span>
<span class="nc" id="L1818">        loadPreviewImage(bp, entity, player);</span>
<span class="nc" id="L1819">    }</span>

    public void loadPreviewImage(JLabel bp, Entity entity, IPlayer player) {
<span class="nc" id="L1822">        final Camouflage camouflage = entity.getCamouflageOrElse(player.getCamouflage());</span>
<span class="nc" id="L1823">        Image icon = bv.getTilesetManager().loadPreviewImage(entity, camouflage, bp);</span>
<span class="nc bnc" id="L1824" title="All 2 branches missed.">        bp.setIcon((icon == null) ? null : new ImageIcon(icon));</span>
<span class="nc" id="L1825">    }</span>

    /**
     * Make a &quot;bing&quot; sound.
     */
    void bing() {
<span class="nc bnc" id="L1831" title="All 4 branches missed.">        if (!GUIPreferences.getInstance().getSoundMute() &amp;&amp; (bingClip != null)) {</span>
<span class="nc" id="L1832">            bingClip.play();</span>
        }
<span class="nc" id="L1834">    }</span>

<span class="fc" id="L1836">    private GameListener gameListener = new GameListenerAdapter() {</span>
        @Override
        public void gamePlayerChange(GamePlayerChangeEvent e){
<span class="nc bnc" id="L1839" title="All 2 branches missed.">             if (playerListDialog != null) {</span>
<span class="nc" id="L1840">                 playerListDialog.refreshPlayerList();</span>
             }

<span class="nc bnc" id="L1843" title="All 4 branches missed.">             if ((curPanel instanceof ReportDisplay) &amp;&amp; !client.getLocalPlayer().isDone()) {</span>
<span class="nc" id="L1844">                 ((ReportDisplay) curPanel).resetReadyButton();</span>
             }
<span class="nc" id="L1846">        }</span>

        @Override
        public void gamePlayerDisconnected(GamePlayerDisconnectedEvent e) {
<span class="nc" id="L1850">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L1851">                Messages.getString(&quot;ClientGUI.Disconnected.message&quot;),</span>
<span class="nc" id="L1852">                Messages.getString(&quot;ClientGUI.Disconnected.title&quot;),</span>
                JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1854">            frame.setVisible(false);</span>
<span class="nc" id="L1855">            die();</span>
<span class="nc" id="L1856">        }</span>

        @Override
        public void gamePlayerChat(GamePlayerChatEvent e) {
<span class="nc" id="L1860">            bing();</span>
<span class="nc" id="L1861">        }</span>

        @Override
        public void gamePhaseChange(GamePhaseChangeEvent e) {
            // This is a really lame place for this, but I couldn't find a
            // better one without making massive changes (which didn't seem
            // worth it for one little feature).
<span class="nc bnc" id="L1868" title="All 2 branches missed.">            if (bv.getLocalPlayer() != client.getLocalPlayer()) {</span>
                // The adress based comparison is somewhat important.
                //  Use of the /reset command can cause the player to get reset,
                //  and the equals function of Player isn't powerful enough.
<span class="nc" id="L1872">                bv.setLocalPlayer(client.getLocalPlayer());</span>
            }
            // Make sure the ChatterBox starts out deactived.
<span class="nc" id="L1875">            bv.setChatterBoxActive(false);            </span>

            // Swap to this phase's panel.
<span class="nc" id="L1878">            switchPanel(getClient().getGame().getPhase());</span>

<span class="nc" id="L1880">            menuBar.setPhase(getClient().getGame().getPhase());</span>
<span class="nc" id="L1881">            validate();</span>
<span class="nc" id="L1882">            cb.moveToEnd();</span>
<span class="nc" id="L1883">        }</span>

        @Override
        public void gamePlayerConnected(GamePlayerConnectedEvent e) {
<span class="nc" id="L1887">            System.err.println(&quot;gamePlayerConnected&quot;);</span>
<span class="nc" id="L1888">            System.err.flush();</span>
<span class="nc bnc" id="L1889" title="All 2 branches missed.">            if (curPanel instanceof ReportDisplay) {</span>
<span class="nc" id="L1890">                ((ReportDisplay) curPanel).resetReadyButton();</span>
<span class="nc" id="L1891">                System.err.println(&quot;resetReadyButton&quot;);</span>
<span class="nc" id="L1892">                System.err.flush();</span>
            }
<span class="nc" id="L1894">        }</span>

        @Override
        public void gameReport(GameReportEvent e) {
            // Normally the Report Display is updated when the panel is
            // switched during a phase change.
            // This update is for reports that get sent at odd times,
            // currently Tactical Genius reroll requests and when
            // a player wishes to continue moving after a fall.
<span class="nc bnc" id="L1903" title="All 2 branches missed.">            if (curPanel instanceof ReportDisplay) {</span>
                // Tactical Genius
<span class="nc" id="L1905">                ((ReportDisplay) curPanel).appendReportTab(getClient().phaseReport);</span>
<span class="nc" id="L1906">                ((ReportDisplay) curPanel).resetReadyButton();</span>
                // Check if the player deserves an active reroll button
                // (possible, if he gets one which he didn't use, and his
                // opponent got and used one) and if so activates it.
<span class="nc bnc" id="L1910" title="All 2 branches missed.">                if (getClient().getGame().hasTacticalGenius(getClient().getLocalPlayer())) {</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">                    if (!((ReportDisplay) curPanel).hasRerolled()) {</span>
<span class="nc" id="L1912">                        ((ReportDisplay) curPanel).resetRerollButton();</span>
                    }
                }
                // Show a popup to the players so that we know whats up!
<span class="nc bnc" id="L1916" title="All 2 branches missed.">                if (!(getClient() instanceof TestBot)) {</span>
<span class="nc" id="L1917">                    doAlertDialog(&quot;Tactical Genius Report&quot;, e.getReport());</span>
                }
            } else {
                // Continued movement after getting up
<span class="nc bnc" id="L1921" title="All 2 branches missed.">                if (!(getClient() instanceof TestBot)) {</span>
<span class="nc" id="L1922">                    doAlertDialog(&quot;Movement Report&quot;, e.getReport());</span>
                }
            }
<span class="nc" id="L1925">        }</span>


        @Override
        public void gameEnd(GameEndEvent e) {
<span class="nc" id="L1930">            bv.clearMovementData();</span>
<span class="nc" id="L1931">            bv.clearFieldofF();</span>
            /*
            The next lines are removed, in order to keep the rating system for bots over several games
            for (Client client2 : getBots().values()) {
                client2.die();
            }
            getBots().clear();
             */

            // Make a list of the player's living units.
<span class="nc" id="L1941">            ArrayList&lt;Entity&gt; living = getClient().getGame().getPlayerEntities(getClient().getLocalPlayer(), false);</span>

            // Be sure to include all units that have retreated.
<span class="nc bnc" id="L1944" title="All 2 branches missed.">            for (Enumeration&lt;Entity&gt; iter = getClient().getGame().getRetreatedEntities(); iter.hasMoreElements(); ) {</span>
<span class="nc" id="L1945">                Entity ent = iter.nextElement();</span>
<span class="nc bnc" id="L1946" title="All 2 branches missed.">                if (ent.getOwnerId() == getClient().getLocalPlayer().getId()) {</span>
<span class="nc" id="L1947">                    living.add(ent);</span>
                }
<span class="nc" id="L1949">            }</span>

            // Allow players to save their living units to a file.
            // Don't bother asking if none survived.
<span class="nc bnc" id="L1953" title="All 4 branches missed.">            if (!living.isEmpty() &amp;&amp; doYesNoDialog(Messages.getString(&quot;ClientGUI.SaveUnitsDialog.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1954">                    Messages.getString(&quot;ClientGUI.SaveUnitsDialog.message&quot;))) { //$NON-NLS-1$</span>

                // Allow the player to save the units to a file.
<span class="nc" id="L1957">                saveVictoryList();</span>
            } // End user-wants-a-MUL

            // save all destroyed units in a separate &quot;salvage MUL&quot;
<span class="nc" id="L1961">            ArrayList&lt;Entity&gt; destroyed = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1962">            Enumeration&lt;Entity&gt; graveyard = getClient().getGame().getGraveyardEntities();</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">            while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1964">                Entity entity = graveyard.nextElement();</span>
<span class="nc bnc" id="L1965" title="All 2 branches missed.">                if (entity.isSalvage()) {</span>
<span class="nc" id="L1966">                    destroyed.add(entity);</span>
                }
<span class="nc" id="L1968">            }</span>
<span class="nc bnc" id="L1969" title="All 2 branches missed.">            if (destroyed.size() &gt; 0) {</span>
<span class="nc" id="L1970">                String sLogDir = PreferenceManager.getClientPreferences().getLogDirectory();</span>
<span class="nc" id="L1971">                File logDir = new File(sLogDir);</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">                if (!logDir.exists()) {</span>
<span class="nc" id="L1973">                    logDir.mkdir();</span>
                }
<span class="nc" id="L1975">                String fileName = &quot;salvage.mul&quot;;</span>
<span class="nc bnc" id="L1976" title="All 2 branches missed.">                if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L1977">                    fileName = StringUtil.addDateTimeStamp(fileName);</span>
                }
<span class="nc" id="L1979">                File unitFile = new File(sLogDir + File.separator + fileName);</span>
                try {
                    // Save the destroyed entities to the file.
<span class="nc" id="L1982">                    EntityListFile.saveTo(unitFile, destroyed);</span>
<span class="nc" id="L1983">                } catch (IOException ex) {</span>
<span class="nc" id="L1984">                    MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L1985">                    doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), ex.getMessage());</span>
<span class="nc" id="L1986">                }</span>
            }

<span class="nc" id="L1989">        }</span>

        @Override
        public void gameSettingsChange(GameSettingsChangeEvent e) {
<span class="nc bnc" id="L1993" title="All 4 branches missed.">            if ((gameOptionsDialog != null) &amp;&amp; gameOptionsDialog.isVisible() &amp;&amp;</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">                    !e.isMapSettingsOnlyChange()) {</span>
<span class="nc" id="L1995">                gameOptionsDialog.update(getClient().getGame().getOptions());</span>
            }
<span class="nc bnc" id="L1997" title="All 2 branches missed.">            if (curPanel instanceof ChatLounge) {</span>
<span class="nc" id="L1998">                ChatLounge cl = (ChatLounge) curPanel;</span>
<span class="nc" id="L1999">                cl.updateMapSettings(getClient().getMapSettings());</span>
            }
<span class="nc" id="L2001">        }</span>

        @Override
        public void gameMapQuery(GameMapQueryEvent e) {

<span class="nc" id="L2006">        }</span>
        
        @Override
        public void gameClientFeedbackRequest(GameCFREvent evt) {
<span class="nc" id="L2010">            Entity e = client.getGame().getEntity(evt.getEntityId());</span>
            Object result;
<span class="nc bnc" id="L2012" title="All 7 branches missed.">            switch (evt.getCFRType()){</span>
                case Packet.COMMAND_CFR_DOMINO_EFFECT:                    
                    // If the client connects to a game as a bot, it's possible
                    // to have the bot respond AND have the client ask the
                    // player. This is bad, ignore this if the client is a bot
<span class="nc bnc" id="L2017" title="All 2 branches missed.">                    if (client instanceof BotClient){</span>
<span class="nc" id="L2018">                        return;</span>
                    }
<span class="nc" id="L2020">                    MovePath stepForward = new MovePath(client.getGame(), e);</span>
<span class="nc" id="L2021">                    MovePath stepBackward = new MovePath(client.getGame(), e);</span>
<span class="nc" id="L2022">                    stepForward.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L2023">                    stepBackward.addStep(MoveStepType.BACKWARDS);</span>
<span class="nc" id="L2024">                    stepForward.compile(client.getGame(), e, false);</span>
<span class="nc" id="L2025">                    stepBackward.compile(client.getGame(), e, false);</span>
                    
<span class="nc" id="L2027">                    String title = Messages.getString(&quot;CFRDomino.Title&quot;);</span>
<span class="nc" id="L2028">                    String msg = Messages.getString(&quot;CFRDomino.Message&quot;, e.getDisplayName());</span>
                    int choice;
                    Object[] options;
                    MovePath[] paths;
                    int optionType;
<span class="nc bnc" id="L2033" title="All 2 branches missed.">                    if (stepForward.isMoveLegal() </span>
<span class="nc bnc" id="L2034" title="All 2 branches missed.">                            &amp;&amp; stepBackward.isMoveLegal()){</span>
<span class="nc" id="L2035">                        options = new Object[3];</span>
<span class="nc" id="L2036">                        paths = new MovePath[3];</span>
<span class="nc" id="L2037">                        options[0] = Messages.getString(&quot;CFRDomino.Forward&quot;, stepForward.getMpUsed());</span>
<span class="nc" id="L2038">                        options[1] = Messages.getString(&quot;CFRDomino.Backward&quot;, stepForward.getMpUsed());</span>
<span class="nc" id="L2039">                        options[2] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</span>
<span class="nc" id="L2040">                        paths[0] = stepForward;</span>
<span class="nc" id="L2041">                        paths[1] = stepBackward;</span>
<span class="nc" id="L2042">                        paths[2] = null;</span>
<span class="nc" id="L2043">                        optionType = JOptionPane.YES_NO_CANCEL_OPTION;</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">                    } else if (stepForward.isMoveLegal()){</span>
<span class="nc" id="L2045">                        options = new Object[2];</span>
<span class="nc" id="L2046">                        paths = new MovePath[2];</span>
<span class="nc" id="L2047">                        options[0] = Messages.getString(&quot;CFRDomino.Forward&quot;,</span>
<span class="nc" id="L2048">                                new Object[] { stepForward.getMpUsed() });</span>
<span class="nc" id="L2049">                        options[1] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</span>
<span class="nc" id="L2050">                        paths[0] = stepForward;</span>
<span class="nc" id="L2051">                        paths[1] = null;</span>
<span class="nc" id="L2052">                        optionType = JOptionPane.YES_NO_OPTION;</span>
                    } else { // No request is sent if both moves are illegal
<span class="nc" id="L2054">                        options = new Object[2];</span>
<span class="nc" id="L2055">                        paths = new MovePath[2];</span>
<span class="nc" id="L2056">                        options[0] = Messages.getString(&quot;CFRDomino.Backward&quot;,</span>
<span class="nc" id="L2057">                                new Object[] { stepForward.getMpUsed() });</span>
<span class="nc" id="L2058">                        options[1] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</span>
<span class="nc" id="L2059">                        paths[0] = stepBackward;</span>
<span class="nc" id="L2060">                        paths[1] = null;</span>
<span class="nc" id="L2061">                        optionType = JOptionPane.YES_NO_OPTION;</span>
                    }            
<span class="nc" id="L2063">                    choice = JOptionPane.showOptionDialog(frame, msg, title, </span>
                            optionType, JOptionPane.QUESTION_MESSAGE, null, 
                            options, options[0]);
                    // If they closed it, assume no action
<span class="nc bnc" id="L2067" title="All 2 branches missed.">                    if (choice == JOptionPane.CLOSED_OPTION){</span>
<span class="nc" id="L2068">                        choice = options.length - 1;</span>
                    }
<span class="nc" id="L2070">                    client.sendDominoCFRResponse(paths[choice]);</span>
<span class="nc" id="L2071">                    break;</span>
                case Packet.COMMAND_CFR_AMS_ASSIGN:
<span class="nc" id="L2073">                    ArrayList&lt;String&gt; amsOptions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2074">                    amsOptions.add(&quot;None&quot;);</span>
<span class="nc bnc" id="L2075" title="All 2 branches missed.">                    for (WeaponAttackAction waa : evt.getWAAs()) {</span>
<span class="nc" id="L2076">                        Entity ae = waa.getEntity(client.getGame());</span>
                        String waaMsg;
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                        if (ae != null) {</span>
<span class="nc" id="L2079">                            Mounted weapon = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L2080">                            waaMsg = weapon.getDesc() + &quot; from &quot;</span>
<span class="nc" id="L2081">                                    + ae.getDisplayName();</span>
<span class="nc" id="L2082">                        } else {</span>
<span class="nc" id="L2083">                            waaMsg = &quot;Missiles from unknown attacker&quot;;</span>
                        }
<span class="nc" id="L2085">                        amsOptions.add(waaMsg);</span>
<span class="nc" id="L2086">                    }</span>
                    
<span class="nc" id="L2088">                    optionType = JOptionPane.OK_CANCEL_OPTION;</span>
<span class="nc" id="L2089">                    title = Messages.getString(&quot;CFRAMSAssign.Title&quot;,</span>
<span class="nc" id="L2090">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2091">                    msg = Messages.getString(&quot;CFRAMSAssign.Message&quot;,</span>
<span class="nc" id="L2092">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2093">                    result = JOptionPane.showInputDialog(frame, msg, title,</span>
                            JOptionPane.QUESTION_MESSAGE, null, 
<span class="nc" id="L2095">                           amsOptions.toArray(), null);</span>
                    // If they closed it, assume no action
<span class="nc bnc" id="L2097" title="All 4 branches missed.">                    if ((result == null) || result.equals(&quot;None&quot;)) {</span>
<span class="nc" id="L2098">                        client.sendAMSAssignCFRResponse(null);</span>
                    } else {
<span class="nc" id="L2100">                        client.sendAMSAssignCFRResponse(</span>
<span class="nc" id="L2101">                                amsOptions.indexOf(result) - 1);                 </span>
                    }
<span class="nc" id="L2103">                    break;</span>
                case Packet.COMMAND_CFR_APDS_ASSIGN:
<span class="nc" id="L2105">                    ArrayList&lt;String&gt; apdsOptions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2106">                    apdsOptions.add(&quot;None&quot;);</span>
<span class="nc" id="L2107">                    Iterator&lt;Integer&gt; distIt = evt.getApdsDists().iterator();</span>
<span class="nc bnc" id="L2108" title="All 2 branches missed.">                    for (WeaponAttackAction waa : evt.getWAAs()) {</span>
<span class="nc" id="L2109">                        Entity ae = waa.getEntity(client.getGame());</span>
<span class="nc" id="L2110">                        int dist = distIt.next();</span>
                        String waaMsg;
<span class="nc bnc" id="L2112" title="All 2 branches missed.">                        if (ae != null) {</span>
<span class="nc" id="L2113">                            Mounted weapon = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L2114">                            waaMsg = weapon.getDesc() + &quot; from &quot;</span>
<span class="nc" id="L2115">                                    + ae.getDisplayName() + &quot; (distance: &quot;</span>
                                    + dist + &quot;)&quot;;
<span class="nc" id="L2117">                        } else {</span>
<span class="nc" id="L2118">                            waaMsg = &quot;Missiles from unknown attacker&quot;;</span>
                        }
<span class="nc" id="L2120">                        apdsOptions.add(waaMsg);</span>
<span class="nc" id="L2121">                    }</span>

<span class="nc" id="L2123">                    optionType = JOptionPane.OK_CANCEL_OPTION;</span>
<span class="nc" id="L2124">                    title = Messages.getString(&quot;CFRAPDSAssign.Title&quot;,</span>
<span class="nc" id="L2125">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2126">                    msg = Messages.getString(&quot;CFRAPDSAssign.Message&quot;,</span>
<span class="nc" id="L2127">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2128">                    result = JOptionPane.showInputDialog(frame, msg, title,</span>
                            JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2130">                            apdsOptions.toArray(), null);</span>
                    // If they closed it, assume no action
<span class="nc bnc" id="L2132" title="All 4 branches missed.">                    if ((result == null) || result.equals(&quot;None&quot;)) {</span>
<span class="nc" id="L2133">                        client.sendAPDSAssignCFRResponse(null);</span>
                    } else {
<span class="nc" id="L2135">                        client.sendAPDSAssignCFRResponse(</span>
<span class="nc" id="L2136">                                apdsOptions.indexOf(result) - 1);</span>
                    }
<span class="nc" id="L2138">                    break;</span>
                case Packet.COMMAND_CFR_HIDDEN_PBS:
<span class="nc" id="L2140">                    Entity attacker = client.getGame().getEntity(</span>
<span class="nc" id="L2141">                            evt.getEntityId());</span>
<span class="nc" id="L2142">                    Entity target = client.getGame().getEntity(</span>
<span class="nc" id="L2143">                            evt.getTargetId());</span>
                    // Are we not the client handling the PBS?
<span class="nc bnc" id="L2145" title="All 4 branches missed.">                    if ((attacker == null) || (target == null)) {</span>
<span class="nc bnc" id="L2146" title="All 2 branches missed.">                        if (curPanel instanceof StatusBarPhaseDisplay) {</span>
<span class="nc" id="L2147">                            ((StatusBarPhaseDisplay) curPanel)</span>
<span class="nc" id="L2148">                                    .setStatusBarText(Messages</span>
<span class="nc" id="L2149">                                            .getString(&quot;StatusBarPhaseDisplay.pointblankShot&quot;));</span>
                        }
<span class="nc" id="L2151">                        return;</span>
                    }
                    // If this is the client to handle the PBS, take care of it
<span class="nc" id="L2154">                    bv.centerOnHex(attacker.getPosition());</span>
<span class="nc" id="L2155">                    bv.highlight(attacker.getPosition());</span>
<span class="nc" id="L2156">                    bv.select(target.getPosition());</span>
<span class="nc" id="L2157">                    bv.cursor(target.getPosition());</span>
<span class="nc" id="L2158">                    msg = Messages.getString(&quot;ClientGUI.PointBlankShot.Message&quot;,</span>
<span class="nc" id="L2159">                            target.getShortName(), attacker.getShortName());</span>
<span class="nc" id="L2160">                    title = Messages.getString(&quot;ClientGUI.PointBlankShot.Title&quot;);</span>
                    // Ask whether the player wants to take a PBS or not
<span class="nc" id="L2162">                    int pbsChoice = JOptionPane.showConfirmDialog(frame, msg,</span>
                            title, JOptionPane.YES_NO_OPTION,
                            JOptionPane.QUESTION_MESSAGE);
                    // Process the PBS - switch to PointblankShotDisplay
<span class="nc bnc" id="L2166" title="All 2 branches missed.">                    if (pbsChoice == JOptionPane.YES_OPTION) {</span>
                        // Send a non-null response to indicate PBS is accepted
                        // This allows the servers to notify the clients,
                        // as they may be in for a wait
<span class="nc" id="L2170">                        client.sendHiddenPBSCFRResponse(new Vector&lt;&gt;());</span>
                        // Used to indicate it's this player's turn
<span class="nc" id="L2172">                        setPointblankEID(evt.getEntityId());</span>
                        // Switch to the right display
<span class="nc" id="L2174">                        switchPanel(IGame.Phase.PHASE_POINTBLANK_SHOT);</span>
<span class="nc" id="L2175">                        PointblankShotDisplay curDisp = ((PointblankShotDisplay) curPanel);</span>
                        // Set targeting info
<span class="nc" id="L2177">                        curDisp.beginMyTurn();</span>
<span class="nc" id="L2178">                        curDisp.selectEntity(evt.getEntityId());</span>
<span class="nc" id="L2179">                        curDisp.target(target);</span>
<span class="nc" id="L2180">                        bv.select(target.getPosition());</span>
<span class="nc" id="L2181">                    } else { // PBS declined</span>
<span class="nc" id="L2182">                        client.sendHiddenPBSCFRResponse(null);</span>
                    }
<span class="nc" id="L2184">                    break;</span>
                case Packet.COMMAND_CFR_TELEGUIDED_TARGET:
<span class="nc" id="L2186">                    List&lt;Integer&gt; targetIds = evt.getTelemissileTargetIds();</span>
<span class="nc" id="L2187">                    List&lt;Integer&gt; toHitValues = evt.getTmToHitValues();</span>
<span class="nc" id="L2188">                    List&lt;String&gt; targetDescriptions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2189" title="All 2 branches missed.">                    for (int i = 0; i &lt; targetIds.size(); i++) {</span>
<span class="nc" id="L2190">                        int id = targetIds.get(i);</span>
<span class="nc" id="L2191">                        int th = toHitValues.get(i);</span>
<span class="nc" id="L2192">                        Entity tgt = client.getGame().getEntity(id);</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">                        if (tgt != null) {</span>
<span class="nc" id="L2194">                            targetDescriptions.add(String.format(Messages.getString(&quot;TeleMissileTargetDialog.target&quot;), tgt.getDisplayName(), th));</span>
                        }
                    }
                    //Set up the selection pane
<span class="nc" id="L2198">                    String i18nString = &quot;TeleMissileTargetDialog.message&quot;; //$NON-NLS-1$;</span>
<span class="nc" id="L2199">                    msg = Messages.getString(i18nString);</span>
<span class="nc" id="L2200">                    i18nString = &quot;TeleMissileTargetDialog.title&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L2201">                    title = Messages.getString(i18nString);</span>
<span class="nc" id="L2202">                    String input = (String) JOptionPane.showInputDialog(frame, msg,</span>
                            title, JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2204">                            targetDescriptions.toArray(), targetDescriptions.get(0));</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">                    if (input != null) {</span>
<span class="nc bnc" id="L2206" title="All 2 branches missed.">                        for (int i = 0; i &lt; targetDescriptions.size(); i++) {</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">                            if (input.equals(targetDescriptions.get(i))) {</span>
<span class="nc" id="L2208">                                client.sendTelemissileTargetCFRResponse(i);</span>
<span class="nc" id="L2209">                                break;</span>
                            }
                        }
                    } else {
                        //If input IS null, as in the case of pressing the close or cancel buttons...
                        //Just pick the first target in the list, or server will be left waiting indefinitely.
<span class="nc" id="L2215">                        client.sendTelemissileTargetCFRResponse(0);</span>
                    }
                case Packet.COMMAND_CFR_TAG_TARGET:
<span class="nc" id="L2218">                    List&lt;Integer&gt; TAGTargets = evt.getTAGTargets();</span>
<span class="nc" id="L2219">                    List&lt;Integer&gt; TAGTargetTypes = evt.getTAGTargetTypes();</span>
<span class="nc" id="L2220">                    List&lt;String&gt; TAGTargetDescriptions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2221" title="All 2 branches missed.">                    for (int i = 0; i &lt; TAGTargets.size(); i++) {</span>
<span class="nc" id="L2222">                        int id = TAGTargets.get(i);</span>
<span class="nc" id="L2223">                        int nType = TAGTargetTypes.get(i);</span>
<span class="nc" id="L2224">                        Targetable tgt = client.getGame().getTarget(nType, id);</span>
<span class="nc bnc" id="L2225" title="All 2 branches missed.">                        if (tgt != null) {</span>
<span class="nc" id="L2226">                            TAGTargetDescriptions.add(tgt.getDisplayName());</span>
                        }
                    }
                    //Set up the selection pane
<span class="nc" id="L2230">                    i18nString = &quot;TAGTargetDialog.message&quot;; //$NON-NLS-1$;</span>
<span class="nc" id="L2231">                    msg = Messages.getString(i18nString);</span>
<span class="nc" id="L2232">                    i18nString = &quot;TAGTargetDialog.title&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L2233">                    title = Messages.getString(i18nString);</span>
<span class="nc" id="L2234">                    input = (String) JOptionPane.showInputDialog(frame, msg,</span>
                            title, JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2236">                            TAGTargetDescriptions.toArray(), TAGTargetDescriptions.get(0));</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">                    if (input != null) {</span>
<span class="nc bnc" id="L2238" title="All 2 branches missed.">                        for (int i = 0; i &lt; TAGTargetDescriptions.size(); i++) {</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">                            if (input.equals(TAGTargetDescriptions.get(i))) {</span>
<span class="nc" id="L2240">                                client.sendTAGTargetCFRResponse(i);</span>
<span class="nc" id="L2241">                                break;</span>
                            }
                        }
                    } else {
                        //If input IS null, as in the case of pressing the close or cancel buttons...
                        //Just pick the first target in the list, or server will be left waiting indefinitely.
<span class="nc" id="L2247">                        client.sendTAGTargetCFRResponse(0);</span>
                    }
            }
<span class="nc" id="L2250">        }</span>
    };

    public Client getClient() {
<span class="nc" id="L2254">        return client;</span>
    }

    public Map&lt;String, Client&gt; getBots() {
<span class="nc" id="L2258">        return client.bots;</span>
    }

    /**
     * @return Returns the selectedEntityNum.
     */
    public int getSelectedEntityNum() {
<span class="nc" id="L2265">        return selectedEntityNum;</span>
    }

    /**
     * @param selectedEntityNum The selectedEntityNum to set.
     */
    public void setSelectedEntityNum(int selectedEntityNum) {
<span class="nc" id="L2272">        this.selectedEntityNum = selectedEntityNum;</span>
<span class="nc" id="L2273">        bv.selectEntity(client.getGame().getEntity(selectedEntityNum));</span>
<span class="nc" id="L2274">    }</span>

    public RandomArmyDialog getRandomArmyDialog() {
<span class="nc" id="L2277">        return randomArmyDialog;</span>
    }

    public RandomSkillDialog getRandomSkillDialog() {
<span class="nc" id="L2281">        return randomSkillDialog;</span>
    }

    public RandomNameDialog getRandomNameDialog() {
<span class="nc" id="L2285">        return new RandomNameDialog(this);</span>
    }

    /**
     * Checks to see if there is already a path and name stored; if not, calls
     * &quot;save as&quot;; otherwise, saves the board to the specified file.
     */
    private void boardSave() {
<span class="nc bnc" id="L2293" title="All 2 branches missed.">        if (curfileBoard == null) {</span>
<span class="nc" id="L2294">            boardSaveAs();</span>
<span class="nc" id="L2295">            return;</span>
        }
        // save!
<span class="nc" id="L2298">        try (OutputStream os = new FileOutputStream(curfileBoard)) {</span>
<span class="nc" id="L2299">            client.getGame().getBoard().save(os);</span>
<span class="nc" id="L2300">        } catch (IOException e) {</span>
<span class="nc" id="L2301">            MegaMek.getLogger().error(&quot;Error opening file to save!&quot;, e);</span>
<span class="nc" id="L2302">        }</span>
<span class="nc" id="L2303">    }</span>

    /**
     * Saves the board in PNG image format.
     */
    private void boardSaveImage(boolean ignoreUnits) {
<span class="nc bnc" id="L2309" title="All 2 branches missed.">        if (curfileBoardImage == null) {</span>
<span class="nc" id="L2310">            boardSaveAsImage(ignoreUnits);</span>
<span class="nc" id="L2311">            return;</span>
        }
<span class="nc" id="L2313">        JDialog waitD = new JDialog(frame, Messages.getString(&quot;BoardEditor.waitDialog.title&quot;));</span>
<span class="nc" id="L2314">        waitD.add(new JLabel(Messages.getString(&quot;BoardEditor.waitDialog.message&quot;)));</span>
<span class="nc" id="L2315">        waitD.setSize(250, 130);</span>
        // move to middle of screen
<span class="nc" id="L2317">        waitD.setLocation(</span>
<span class="nc" id="L2318">                (frame.getSize().width / 2) - (waitD.getSize().width / 2), (frame</span>
<span class="nc" id="L2319">                .getSize().height</span>
<span class="nc" id="L2320">                / 2) - (waitD.getSize().height / 2));</span>
<span class="nc" id="L2321">        waitD.setVisible(true);</span>
<span class="nc" id="L2322">        frame.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L2323">        waitD.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
        // save!
        try {
<span class="nc" id="L2326">            ImageIO.write(bv.getEntireBoardImage(ignoreUnits), &quot;png&quot;, curfileBoardImage);</span>
<span class="nc" id="L2327">        } catch (IOException e) {</span>
<span class="nc" id="L2328">            e.printStackTrace();</span>
<span class="nc" id="L2329">        }</span>
<span class="nc" id="L2330">        waitD.setVisible(false);</span>
<span class="nc" id="L2331">        frame.setCursor(Cursor.getDefaultCursor());</span>
<span class="nc" id="L2332">    }</span>

    /**
     * Opens a file dialog box to select a file to save as; saves the board to
     * the file.
     */
    private void boardSaveAs() {
<span class="nc" id="L2339">        JFileChooser fc = new JFileChooser(&quot;data&quot; + File.separator + &quot;boards&quot;);</span>
<span class="nc" id="L2340">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L2341">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveBoardAs&quot;));</span>
<span class="nc" id="L2342">        fc.setFileFilter(new BoardFileFilter());</span>
<span class="nc" id="L2343">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc bnc" id="L2344" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L2346">            return;</span>
        }
<span class="nc" id="L2348">        curfileBoard = fc.getSelectedFile();</span>

        // make sure the file ends in board
<span class="nc bnc" id="L2351" title="All 2 branches missed.">        if (!curfileBoard.getName().toLowerCase(Locale.ENGLISH).endsWith(&quot;.board&quot;)) {</span>
            try {
<span class="nc" id="L2353">                curfileBoard = new File(curfileBoard.getCanonicalPath() + &quot;.board&quot;);</span>
<span class="nc" id="L2354">            } catch (IOException ie) {</span>
                // failure!
<span class="nc" id="L2356">                return;</span>
<span class="nc" id="L2357">            }</span>
        }
<span class="nc" id="L2359">        boardSave();</span>
<span class="nc" id="L2360">    }</span>

    /**
     * Opens a file dialog box to select a file to save as; saves the board to
     * the file as an image. Useful for printing boards.
     */
    private void boardSaveAsImage(boolean ignoreUnits) {
<span class="nc" id="L2367">        JFileChooser fc = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L2368">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L2369">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveAsImage&quot;));</span>
<span class="nc" id="L2370">        fc.setFileFilter(new FileFilter() {</span>
            @Override
            public boolean accept(File dir) {
<span class="nc bnc" id="L2373" title="All 4 branches missed.">                return (dir.getName().endsWith(&quot;.png&quot;) || dir.isDirectory());</span>
            }

            @Override
            public String getDescription() {
<span class="nc" id="L2378">                return &quot;.png&quot;;</span>
            }
        });
<span class="nc" id="L2381">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc bnc" id="L2382" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L2384">            return;</span>
        }
<span class="nc" id="L2386">        curfileBoardImage = fc.getSelectedFile();</span>

        // make sure the file ends in png
<span class="nc bnc" id="L2389" title="All 2 branches missed.">        if (!curfileBoardImage.getName().toLowerCase(Locale.ENGLISH).endsWith(&quot;.png&quot;)) {</span>
            try {
<span class="nc" id="L2391">                curfileBoardImage = new File(curfileBoardImage.getCanonicalPath() + &quot;.png&quot;);</span>
<span class="nc" id="L2392">            } catch (IOException ie) {</span>
                // failure!
<span class="nc" id="L2394">                return;</span>
<span class="nc" id="L2395">            }</span>
        }
<span class="nc" id="L2397">        boardSaveImage(ignoreUnits);</span>
<span class="nc" id="L2398">    }</span>

    @Override
    public void hexMoused(BoardViewEvent b) {
<span class="nc bnc" id="L2402" title="All 2 branches missed.">        if (b.getType() == BoardViewEvent.BOARD_HEX_POPUP) {</span>
<span class="nc" id="L2403">            showBoardPopup(b.getCoords());</span>
        }
<span class="nc" id="L2405">    }</span>

    @Override
    public void hexCursor(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2410">    }</span>

    @Override
    public void boardHexHighlighted(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2415">    }</span>

    @Override
    public void hexSelected(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2420">    }</span>

    @Override
    public void firstLOSHex(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2425">    }</span>

    @Override
    public void secondLOSHex(BoardViewEvent b, Coords c) {
        // ignored
<span class="nc" id="L2430">    }</span>

    @Override
    public void finishedMovingUnits(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2435">    }</span>

    @Override
    public void unitSelected(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2440">    }</span>
    
    /**
     * Returns true if a dialog is visible on top of the &lt;code&gt;ClientGUI&lt;/code&gt;.
     * For example, the &lt;code&gt;MegaMekController&lt;/code&gt; should ignore hotkeys
     * if there is a dialog, like the &lt;code&gt;CommonSettingsDialog&lt;/code&gt;, open.
     * @return
     */
    public boolean shouldIgnoreHotKeys(){
<span class="nc bnc" id="L2449" title="All 4 branches missed.">        return ignoreHotKeys </span>
<span class="nc bnc" id="L2450" title="All 4 branches missed.">                || ((gameOptionsDialog != null) &amp;&amp; gameOptionsDialog.isVisible())</span>
<span class="nc bnc" id="L2451" title="All 4 branches missed.">                || ((about != null) &amp;&amp; about.isVisible())</span>
<span class="nc bnc" id="L2452" title="All 4 branches missed.">                || ((help != null) &amp;&amp; help.isVisible())</span>
<span class="nc bnc" id="L2453" title="All 4 branches missed.">                || ((setdlg != null) &amp;&amp; setdlg.isVisible())</span>
<span class="nc bnc" id="L2454" title="All 2 branches missed.">                || ((aw != null) &amp;&amp; aw.isVisible());</span>
    }

    @Override
    public void componentHidden(ComponentEvent arg0) {

<span class="nc" id="L2460">    }</span>

    @Override
    public void componentMoved(ComponentEvent arg0) {

<span class="nc" id="L2465">    }</span>

    @Override
    public void componentResized(ComponentEvent arg0) {
<span class="nc" id="L2469">        bv.setPreferredSize(getSize());        </span>
<span class="nc" id="L2470">    }</span>

    @Override
    public void componentShown(ComponentEvent arg0) {

<span class="nc" id="L2475">    }</span>

    void replacePlayer() {
<span class="nc" id="L2478">        Set&lt;IPlayer&gt; ghostPlayers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">        for (IPlayer p : client.getGame().getPlayersVector()) {</span>
<span class="nc bnc" id="L2480" title="All 2 branches missed.">            if (p.isGhost()) {</span>
<span class="nc" id="L2481">                ghostPlayers.add(p);</span>
            }
<span class="nc" id="L2483">        }</span>
<span class="nc bnc" id="L2484" title="All 2 branches missed.">        if (ghostPlayers.isEmpty()) {</span>
<span class="nc" id="L2485">            JOptionPane.showMessageDialog(this, &quot;No ghost players to replace.&quot;, &quot;No Ghosts&quot;,</span>
                                          JOptionPane.INFORMATION_MESSAGE);
<span class="nc" id="L2487">            return;</span>
        }

<span class="nc" id="L2490">        BotConfigDialog botConfigDialog = new BotConfigDialog(this.frame, ghostPlayers);</span>
<span class="nc" id="L2491">        botConfigDialog.setModal(true);</span>
<span class="nc" id="L2492">        botConfigDialog.setVisible(true);</span>
<span class="nc bnc" id="L2493" title="All 2 branches missed.">        if (botConfigDialog.dialogAborted) {</span>
<span class="nc" id="L2494">            return;</span>
        }
<span class="nc" id="L2496">        AddBotUtil util = new AddBotUtil();</span>
<span class="nc" id="L2497">        BotClient botClient = botConfigDialog.getSelectedBot(client.getHost(), client.getPort());</span>
        String[] args;
<span class="nc" id="L2499">        Collection&lt;String&gt; playersToReplace = botConfigDialog.getPlayerToReplace();</span>
<span class="nc" id="L2500">        Collection&lt;String[]&gt; replaceCommands = new HashSet&lt;&gt;(playersToReplace.size());</span>
<span class="nc bnc" id="L2501" title="All 2 branches missed.">        if (botClient instanceof Princess) {</span>
<span class="nc bnc" id="L2502" title="All 2 branches missed.">            for (String player : playersToReplace) {</span>
<span class="nc" id="L2503">                args = new String[]{</span>
                        &quot;/replacePlayer&quot;,
                        &quot;-b:Princess&quot;,
<span class="nc" id="L2506">                        &quot;-c:&quot; + ((Princess) botClient).getBehaviorSettings().getDescription(),</span>
<span class="nc" id="L2507">                        &quot;-v:&quot; + ((Princess) botClient).getVerbosity(),</span>
                        &quot;-p:&quot; + player
                };
<span class="nc" id="L2510">                replaceCommands.add(args);</span>
<span class="nc" id="L2511">            }</span>
        } else {
<span class="nc bnc" id="L2513" title="All 2 branches missed.">            for (String player : playersToReplace) {</span>
<span class="nc" id="L2514">                args = new String[]{</span>
                        &quot;/replacePlayer&quot;,
                        player
                };
<span class="nc" id="L2518">                replaceCommands.add(args);</span>
<span class="nc" id="L2519">            }</span>
        }
<span class="nc" id="L2521">        botClient.die();</span>
<span class="nc bnc" id="L2522" title="All 2 branches missed.">        for (String[] cmd : replaceCommands) {</span>
<span class="nc" id="L2523">            util.addBot(cmd, client.getGame(), client.getHost(), client.getPort());</span>
<span class="nc" id="L2524">        }</span>
<span class="nc" id="L2525">    }</span>
    
    /**
     * Returns the panel for the current phase.  The ClientGUI is split into
     * the main panel (view) at the top, which takes up the majority of the view
     * and the the &quot;current panel&quot; which has different controls  based on the
     * phase.
     * 
     * @return
     */
    public JComponent getCurrentPanel() {
<span class="nc" id="L2536">        return curPanel;</span>
    }

    public boolean isProcessingPointblankShot() {
<span class="nc bnc" id="L2540" title="All 2 branches missed.">        return pointblankEID != Entity.NONE;</span>
    }

    public void setPointblankEID(int eid) {
<span class="nc" id="L2544">        this.pointblankEID = eid;</span>
<span class="nc" id="L2545">    }</span>

    public int getPointblankEID() {
<span class="nc" id="L2548">        return pointblankEID;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>