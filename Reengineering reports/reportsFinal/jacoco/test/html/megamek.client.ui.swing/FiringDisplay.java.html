<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FiringDisplay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">FiringDisplay.java</span></div><h1>FiringDisplay.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

package megamek.client.ui.swing;

import megamek.client.event.BoardViewEvent;
import megamek.client.ui.Messages;
import megamek.client.ui.SharedUtility;
import megamek.client.ui.swing.util.CommandAction;
import megamek.client.ui.swing.util.KeyCommandBind;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.client.ui.swing.widget.MegamekButton;
import megamek.client.ui.swing.widget.SkinSpecification;
import megamek.common.*;
import megamek.common.IGame.Phase;
import megamek.common.actions.*;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GameTurnChangeEvent;
import megamek.common.options.OptionsConstants;
import megamek.common.util.FiringSolution;
import megamek.client.ui.swing.util.TurnTimer;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.capitalweapons.CapitalMissileWeapon;

import javax.swing.*;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import java.awt.event.ActionEvent;
import java.awt.event.InputEvent;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.util.*;

public class FiringDisplay extends StatusBarPhaseDisplay implements
        ItemListener, ListSelectionListener {
    /**
     *
     */
    private static final long serialVersionUID = -5586388490027013723L;

    /**
     * timer that ends turn if time limit set in options is over
     */
    private TurnTimer tt;

    /**
     * This enumeration lists all of the possible ActionCommands that can be
     * carried out during the firing phase.  Each command has a string for the
     * command plus a flag that determines what unit type it is appropriate for.
     *
     * @author arlith
     */
<span class="nc" id="L65">    public static enum FiringCommand implements PhaseCommand {</span>
<span class="nc" id="L66">        FIRE_NEXT(&quot;fireNext&quot;),</span>
<span class="nc" id="L67">        FIRE_TWIST(&quot;fireTwist&quot;),</span>
<span class="nc" id="L68">        FIRE_FIRE(&quot;fireFire&quot;),</span>
<span class="nc" id="L69">        FIRE_SKIP(&quot;fireSkip&quot;),</span>
<span class="nc" id="L70">        FIRE_NEXT_TARG(&quot;fireNextTarg&quot;),</span>
<span class="nc" id="L71">        FIRE_MODE(&quot;fireMode&quot;),</span>
<span class="nc" id="L72">        FIRE_SPOT(&quot;fireSpot&quot;),</span>
<span class="nc" id="L73">        FIRE_FLIP_ARMS(&quot;fireFlipArms&quot;),</span>
<span class="nc" id="L74">        FIRE_FIND_CLUB(&quot;fireFindClub&quot;),</span>
<span class="nc" id="L75">        FIRE_STRAFE(&quot;fireStrafe&quot;),</span>
<span class="nc" id="L76">        FIRE_SEARCHLIGHT(&quot;fireSearchlight&quot;),</span>
<span class="nc" id="L77">        FIRE_CLEAR_TURRET(&quot;fireClearTurret&quot;),</span>
<span class="nc" id="L78">        FIRE_CLEAR_WEAPON(&quot;fireClearWeaponJam&quot;),</span>
<span class="nc" id="L79">        FIRE_CALLED(&quot;fireCalled&quot;),</span>
<span class="nc" id="L80">        FIRE_CANCEL(&quot;fireCancel&quot;),</span>
<span class="nc" id="L81">        FIRE_MORE(&quot;fireMore&quot;);</span>

        String cmd;

        /**
         * Priority that determines this buttons order
         */
        public int priority;

<span class="nc" id="L90">        private FiringCommand(String c) {</span>
<span class="nc" id="L91">            cmd = c;</span>
<span class="nc" id="L92">        }</span>

        public String getCmd() {
<span class="nc" id="L95">            return cmd;</span>
        }

        public int getPriority() {
<span class="nc" id="L99">            return priority;</span>
        }

        public void setPriority(int p) {
<span class="nc" id="L103">            priority = p;</span>
<span class="nc" id="L104">        }</span>

        public String toString() {
<span class="nc" id="L107">            return Messages.getString(&quot;FiringDisplay.&quot; + getCmd());</span>
        }
    }

    // buttons
    private Map&lt;FiringCommand, MegamekButton&gt; buttons;

    // let's keep track of what we're shooting and at what, too
<span class="nc" id="L115">    protected int cen = Entity.NONE; // current entity number</span>

    Targetable target; // target

    // HACK : track when we wan to show the target choice dialog.
<span class="nc" id="L120">    protected boolean showTargetChoice = true;</span>

    // shots we have so far.
    protected Vector&lt;AbstractEntityAction&gt; attacks;

    // is the shift key held?
    protected boolean shiftheld;

    protected boolean twisting;

<span class="nc" id="L130">    protected Entity[] visibleTargets = null;</span>

<span class="nc" id="L132">    protected int lastTargetID = -1;</span>

    protected AimedShotHandler ash;
    
<span class="nc" id="L136">    protected boolean isStrafing = false;</span>
    
    /**
     * Keeps track of the Coords that are in a strafing run.
     */
<span class="nc" id="L141">    private ArrayList&lt;Coords&gt; strafingCoords = new ArrayList&lt;Coords&gt;(5);</span>

    /**
     * Creates and lays out a new firing phase display for the specified
     * clientgui.getClient().
     */
    public FiringDisplay(final ClientGUI clientgui) {
<span class="nc" id="L148">        super(clientgui);</span>
<span class="nc" id="L149">        clientgui.getClient().getGame().addGameListener(this);</span>

<span class="nc" id="L151">        clientgui.getBoardView().addBoardViewListener(this);</span>

<span class="nc" id="L153">        shiftheld = false;</span>

        // fire
<span class="nc" id="L156">        attacks = new Vector&lt;AbstractEntityAction&gt;();</span>

<span class="nc" id="L158">        setupStatusBar(Messages</span>
<span class="nc" id="L159">                .getString(&quot;FiringDisplay.waitingForFiringPhase&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L161">        buttons = new HashMap&lt;FiringCommand, MegamekButton&gt;(</span>
<span class="nc" id="L162">                (int) (FiringCommand.values().length * 1.25 + 0.5));</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        for (FiringCommand cmd : FiringCommand.values()) {</span>
<span class="nc" id="L164">            String title = Messages.getString(&quot;FiringDisplay.&quot; //$NON-NLS-1$</span>
<span class="nc" id="L165">                    + cmd.getCmd());</span>
<span class="nc" id="L166">            MegamekButton newButton = new MegamekButton(title,</span>
<span class="nc" id="L167">                    SkinSpecification.UIComponents.PhaseDisplayButton.getComp());</span>
<span class="nc" id="L168">            String ttKey = &quot;FiringDisplay.&quot; + cmd.getCmd() + &quot;.tooltip&quot;;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (Messages.keyExists(ttKey)) {</span>
<span class="nc" id="L170">                newButton.setToolTipText(Messages.getString(ttKey));</span>
            }
<span class="nc" id="L172">            newButton.addActionListener(this);</span>
<span class="nc" id="L173">            newButton.setActionCommand(cmd.getCmd());</span>
<span class="nc" id="L174">            newButton.setEnabled(false);</span>
<span class="nc" id="L175">            buttons.put(cmd, newButton);</span>
        }
<span class="nc" id="L177">        numButtonGroups =</span>
<span class="nc" id="L178">                (int) Math.ceil((buttons.size() + 0.0) / buttonsPerGroup);</span>

<span class="nc" id="L180">        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString( //$NON-NLS-1$</span>
                &quot;FiringDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$ //$NON-NLS-2$
<span class="nc" id="L182">        butDone.setEnabled(false);</span>

<span class="nc" id="L184">        layoutScreen();</span>

<span class="nc" id="L186">        setupButtonPanel();</span>

<span class="nc" id="L188">        clientgui.bv.addKeyListener(this);</span>

        // mech display.
<span class="nc" id="L191">        clientgui.mechD.wPan.weaponList.addListSelectionListener(this);</span>
<span class="nc" id="L192">        clientgui.mechD.wPan.weaponList.addKeyListener(this);</span>

<span class="nc" id="L194">        ash = new AimedShotHandler(this);</span>

<span class="nc" id="L196">        registerKeyCommands();</span>
<span class="nc" id="L197">    }</span>

    /**
     * Register all of the &lt;code&gt;CommandAction&lt;/code&gt;s for this panel display.
     */
    protected void registerKeyCommands() {
<span class="nc" id="L203">        MegaMekController controller = clientgui.controller;</span>
<span class="nc" id="L204">        final StatusBarPhaseDisplay display = this;</span>
        // Register the action for UNDO
<span class="nc" id="L206">        controller.registerCommandAction(KeyCommandBind.UNDO.cmd,</span>
<span class="nc" id="L207">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L211" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L215">                            return false;</span>
                        } else {
<span class="nc" id="L217">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L223">                        removeLastFiring();</span>
<span class="nc" id="L224">                    }</span>
                });

        // Register the action for TWIST_LEFT
<span class="nc" id="L228">        controller.registerCommandAction(KeyCommandBind.TWIST_LEFT.cmd,</span>
<span class="nc" id="L229">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L233" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L237">                            return false;</span>
                        } else {
<span class="nc" id="L239">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L245">                        updateFlipArms(false);</span>
<span class="nc" id="L246">                        torsoTwist(0);</span>
<span class="nc" id="L247">                    }</span>
                });

        // Register the action for TWIST_RIGHT
<span class="nc" id="L251">        controller.registerCommandAction(KeyCommandBind.TWIST_RIGHT.cmd,</span>
<span class="nc" id="L252">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L256" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L260">                            return false;</span>
                        } else {
<span class="nc" id="L262">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L268">                        updateFlipArms(false);</span>
<span class="nc" id="L269">                        torsoTwist(1);</span>
<span class="nc" id="L270">                    }</span>
                });

        // Register the action for FIRE
<span class="nc" id="L274">        controller.registerCommandAction(KeyCommandBind.FIRE.cmd,</span>
<span class="nc" id="L275">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L279" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc" id="L283">                                || !buttons.get(FiringCommand.FIRE_FIRE)</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                                        .isEnabled()) {</span>
<span class="nc" id="L285">                            return false;</span>
                        } else {
<span class="nc" id="L287">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L293">                        fire();</span>
<span class="nc" id="L294">                    }</span>
                });

        // Register the action for NEXT_WEAPON
<span class="nc" id="L298">        controller.registerCommandAction(KeyCommandBind.NEXT_WEAPON.cmd,</span>
<span class="nc" id="L299">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L303" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L307">                            return false;</span>
                        } else {
<span class="nc" id="L309">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L315">                        nextWeapon();</span>
<span class="nc" id="L316">                    }</span>
                });

        // Register the action for PREV_WEAPON
<span class="nc" id="L320">        controller.registerCommandAction(KeyCommandBind.PREV_WEAPON.cmd,</span>
<span class="nc" id="L321">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L325" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L329">                            return false;</span>
                        } else {
<span class="nc" id="L331">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L337">                        prevWeapon();</span>
<span class="nc" id="L338">                    }</span>
                });

        // Register the action for NEXT_UNIT
<span class="nc" id="L342">        controller.registerCommandAction(KeyCommandBind.NEXT_UNIT.cmd,</span>
<span class="nc" id="L343">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L347" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L351">                            return false;</span>
                        } else {
<span class="nc" id="L353">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L359">                        selectEntity(clientgui.getClient()</span>
<span class="nc" id="L360">                                .getNextEntityNum(cen));</span>
<span class="nc" id="L361">                    }</span>
                });

        // Register the action for PREV_UNIT
<span class="nc" id="L365">        controller.registerCommandAction(KeyCommandBind.PREV_UNIT.cmd,</span>
<span class="nc" id="L366">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L370" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L374">                            return false;</span>
                        } else {
<span class="nc" id="L376">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L382">                        selectEntity(clientgui.getClient()</span>
<span class="nc" id="L383">                                .getPrevEntityNum(cen));</span>
<span class="nc" id="L384">                    }</span>
                });

        // Register the action for NEXT_TARGET
<span class="nc" id="L388">        controller.registerCommandAction(KeyCommandBind.NEXT_TARGET.cmd,</span>
<span class="nc" id="L389">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L393" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L397">                            return false;</span>
                        } else {
<span class="nc" id="L399">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L405">                        jumpToTarget(true, false, false);</span>
<span class="nc" id="L406">                    }</span>
                });

        // Register the action for PREV_TARGET
<span class="nc" id="L410">        controller.registerCommandAction(KeyCommandBind.PREV_TARGET.cmd,</span>
<span class="nc" id="L411">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L415" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L419">                            return false;</span>
                        } else {
<span class="nc" id="L421">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L427">                        jumpToTarget(false, false, false);</span>
<span class="nc" id="L428">                    }</span>
                });

        // Register the action for NEXT_TARGET
<span class="nc" id="L432">        controller.registerCommandAction(KeyCommandBind.NEXT_TARGET_VALID.cmd,</span>
<span class="nc" id="L433">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L437" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L441">                            return false;</span>
                        } else {
<span class="nc" id="L443">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L449">                        jumpToTarget(true, true, false);</span>
<span class="nc" id="L450">                    }</span>
                });

        // Register the action for PREV_TARGET
<span class="nc" id="L454">        controller.registerCommandAction(KeyCommandBind.PREV_TARGET_VALID.cmd,</span>
<span class="nc" id="L455">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L459" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L463">                            return false;</span>
                        } else {
<span class="nc" id="L465">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L471">                        jumpToTarget(false, true, false);</span>
<span class="nc" id="L472">                    }</span>
                });

        // Register the action for NEXT_TARGET
<span class="nc" id="L476">        controller.registerCommandAction(KeyCommandBind.NEXT_TARGET_NOALLIES.cmd,</span>
<span class="nc" id="L477">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L481" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L485">                            return false;</span>
                        } else {
<span class="nc" id="L487">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L493">                        jumpToTarget(true, false, true);</span>
<span class="nc" id="L494">                    }</span>
                });

        // Register the action for PREV_TARGET
<span class="nc" id="L498">        controller.registerCommandAction(KeyCommandBind.PREV_TARGET_NOALLIES.cmd,</span>
<span class="nc" id="L499">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L503" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L507">                            return false;</span>
                        } else {
<span class="nc" id="L509">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L515">                        jumpToTarget(false, false, true);</span>
<span class="nc" id="L516">                    }</span>
                });

        // Register the action for NEXT_TARGET
<span class="nc" id="L520">        controller.registerCommandAction(KeyCommandBind.NEXT_TARGET_VALID_NO_ALLIES.cmd,</span>
<span class="nc" id="L521">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L525" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L529">                            return false;</span>
                        } else {
<span class="nc" id="L531">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L537">                        jumpToTarget(true, true, true);</span>
<span class="nc" id="L538">                    }</span>
                });

        // Register the action for PREV_TARGET
<span class="nc" id="L542">        controller.registerCommandAction(KeyCommandBind.PREV_TARGET_VALID_NO_ALLIES.cmd,</span>
<span class="nc" id="L543">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L547" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L551">                            return false;</span>
                        } else {
<span class="nc" id="L553">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L559">                        jumpToTarget(false, true, true);</span>
<span class="nc" id="L560">                    }</span>
                });
        // Register the action for NEXT_MODE
<span class="nc" id="L563">        controller.registerCommandAction(KeyCommandBind.NEXT_MODE.cmd,</span>
<span class="nc" id="L564">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L568" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L572">                            return false;</span>
                        } else {
<span class="nc" id="L574">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L580">                        changeMode(true);</span>
<span class="nc" id="L581">                    }</span>
                });

        // Register the action for PREV_MODE
<span class="nc" id="L585">        controller.registerCommandAction(KeyCommandBind.PREV_MODE.cmd,</span>
<span class="nc" id="L586">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L590" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L594">                            return false;</span>
                        } else {
<span class="nc" id="L596">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L602">                        changeMode(false);</span>
<span class="nc" id="L603">                    }</span>
                });

        // Register the action for CLEAR
<span class="nc" id="L607">        controller.registerCommandAction(KeyCommandBind.CANCEL.cmd,</span>
<span class="nc" id="L608">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L612" title="All 2 branches missed.">                        if (clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L615">                            return false;</span>
                        } else {
<span class="nc" id="L617">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L623">                        clear();</span>
<span class="nc" id="L624">                    }</span>
                });

<span class="nc" id="L627">    }</span>

    protected ArrayList&lt;MegamekButton&gt; getButtonList() {
<span class="nc" id="L630">        ArrayList&lt;MegamekButton&gt; buttonList = new ArrayList&lt;MegamekButton&gt;();</span>
<span class="nc" id="L631">        int i = 0;</span>
<span class="nc" id="L632">        FiringCommand commands[] = FiringCommand.values();</span>
<span class="nc" id="L633">        CommandComparator comparator = new CommandComparator();</span>
<span class="nc" id="L634">        Arrays.sort(commands, comparator);</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">        for (FiringCommand cmd : commands) {</span>
<span class="nc bnc" id="L636" title="All 6 branches missed.">            if (cmd == FiringCommand.FIRE_NEXT</span>
                    || cmd == FiringCommand.FIRE_MORE
                    || cmd == FiringCommand.FIRE_CANCEL) {
<span class="nc" id="L639">                continue;</span>
            }
<span class="nc bnc" id="L641" title="All 2 branches missed.">            if (i % buttonsPerGroup == 0) {</span>
<span class="nc" id="L642">                buttonList.add(buttons.get(FiringCommand.FIRE_NEXT));</span>
<span class="nc" id="L643">                i++;</span>
            }

<span class="nc" id="L646">            buttonList.add(buttons.get(cmd));</span>
<span class="nc" id="L647">            i++;</span>

<span class="nc bnc" id="L649" title="All 2 branches missed.">            if ((i + 1) % buttonsPerGroup == 0) {</span>
<span class="nc" id="L650">                buttonList.add(buttons.get(FiringCommand.FIRE_MORE));</span>
<span class="nc" id="L651">                i++;</span>
            }
        }
<span class="nc" id="L654">        if (!buttonList.get(i - 1).getActionCommand()</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                .equals(FiringCommand.FIRE_MORE.getCmd())) {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">            while ((i + 1) % buttonsPerGroup != 0) {</span>
<span class="nc" id="L657">                buttonList.add(null);</span>
<span class="nc" id="L658">                i++;</span>
            }
<span class="nc" id="L660">            buttonList.add(buttons.get(FiringCommand.FIRE_MORE));</span>
        }
<span class="nc" id="L662">        return buttonList;</span>
    }


    /**
     * Selects an entity, by number, for firing.
     */
    public void selectEntity(int en) {
        // clear any previously considered attacks
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (en != cen) {</span>
<span class="nc" id="L672">            target(null);</span>
<span class="nc" id="L673">            clearAttacks();</span>
<span class="nc" id="L674">            refreshAll();</span>
        }
        
<span class="nc bnc" id="L677" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L678">            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</span>
        }
        
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L682">            setStatusBarText(Messages</span>
<span class="nc" id="L683">                    .getString(&quot;FiringDisplay.its_your_turn&quot;)); //$NON-NLS-1$</span>
        }

<span class="nc bnc" id="L686" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getEntity(en) != null) {</span>

<span class="nc" id="L688">            cen = en;</span>
<span class="nc" id="L689">            clientgui.setSelectedEntityNum(en);</span>
<span class="nc" id="L690">            clientgui.mechD.displayEntity(ce());</span>

            // If the selected entity is not on the board, use the next one.
            // ASSUMPTION: there will always be *at least one* entity on map.
<span class="nc bnc" id="L694" title="All 2 branches missed.">            if (ce().getPosition() == null) {</span>

                // Walk through the list of entities for this player.
<span class="nc" id="L697">                for (int nextId = clientgui.getClient().getNextEntityNum(en);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">                     nextId != en; nextId = clientgui</span>
<span class="nc" id="L699">                        .getClient().getNextEntityNum(nextId)) {</span>

<span class="nc" id="L701">                    if (clientgui.getClient().getGame().getEntity(nextId)</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">                                 .getPosition() != null) {</span>
<span class="nc" id="L703">                        cen = nextId;</span>
<span class="nc" id="L704">                        break;</span>
                    }

                } // Check the player's next entity.

                // We were *supposed* to have found an on-board entity.
<span class="nc bnc" id="L710" title="All 2 branches missed.">                if (ce().getPosition() == null) {</span>
<span class="nc" id="L711">                    System.err.println(&quot;FiringDisplay: could &quot; + //$NON-NLS-1$</span>
                            &quot;not find an on-board entity: &quot; + en); //$NON-NLS-1$
<span class="nc" id="L713">                    return;</span>
                }

            } // End ce()-not-on-board

<span class="nc bnc" id="L718" title="All 2 branches missed.">            if (ce().isMakingVTOLGroundAttack()) {</span>
<span class="nc" id="L719">                this.updateVTOLGroundTarget();</span>
            } else {
                // Need to clear attacks again in case previous en was making VTOL ground attack
<span class="nc" id="L722">                clearAttacks();</span>
<span class="nc" id="L723">                int lastTarget = ce().getLastTarget();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">                if (ce() instanceof Mech) {</span>
<span class="nc" id="L725">                    int grapple = ((Mech) ce()).getGrappled();</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                    if (grapple != Entity.NONE) {</span>
<span class="nc" id="L727">                        lastTarget = grapple;</span>
                    }
                }
<span class="nc" id="L730">                Entity t = clientgui.getClient().getGame().getEntity(lastTarget);</span>
<span class="nc" id="L731">                target(t);</span>
            }

<span class="nc bnc" id="L734" title="All 2 branches missed.">            if (!ce().isOffBoard()) {</span>
<span class="nc" id="L735">                clientgui.getBoardView().highlight(ce().getPosition());</span>
            }
<span class="nc" id="L737">            clientgui.getBoardView().select(null);</span>
<span class="nc" id="L738">            clientgui.getBoardView().cursor(null);</span>

<span class="nc" id="L740">            refreshAll();</span>
<span class="nc" id="L741">            cacheVisibleTargets();</span>

<span class="nc bnc" id="L743" title="All 2 branches missed.">            if (!ce().isOffBoard()) {</span>
<span class="nc" id="L744">                clientgui.bv.centerOnHex(ce().getPosition());</span>
            }

            // Update the menu bar.
<span class="nc" id="L748">            clientgui.getMenuBar().setEntity(ce());</span>

            // only twist if crew conscious
<span class="nc bnc" id="L751" title="All 2 branches missed.">            setTwistEnabled(ce().canChangeSecondaryFacing()</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                            &amp;&amp; ce().getCrew().isActive());</span>

<span class="nc" id="L754">            setFindClubEnabled(FindClubAction.canMechFindClub(</span>
<span class="nc" id="L755">                    clientgui.getClient().getGame(), en));</span>
<span class="nc" id="L756">            setFlipArmsEnabled(ce().canFlipArms());</span>
<span class="nc" id="L757">            updateSearchlight();</span>
<span class="nc" id="L758">            updateClearTurret();</span>
<span class="nc" id="L759">            updateClearWeaponJam();</span>
<span class="nc" id="L760">            updateStrafe();</span>

            // Hidden units can only spot
<span class="nc bnc" id="L763" title="All 4 branches missed.">            if ((ce() != null) &amp;&amp; ce().isHidden()) {</span>
<span class="nc" id="L764">                setFireEnabled(false);</span>
<span class="nc" id="L765">                setTwistEnabled(false);</span>
<span class="nc" id="L766">                setFindClubEnabled(false);</span>
<span class="nc" id="L767">                setFlipArmsEnabled(false);</span>
<span class="nc" id="L768">                setStrafeEnabled(false);</span>
<span class="nc" id="L769">                clientgui.mechD.wPan.toHitText</span>
<span class="nc" id="L770">                .setText(&quot;Hidden units are only allowed to spot!&quot;);</span>
            }
        } else {
<span class="nc" id="L773">            System.err.println(&quot;FiringDisplay: tried to &quot; + //$NON-NLS-1$</span>
                    &quot;select non-existant entity: &quot; + en); //$NON-NLS-1$
        }
        

<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getBoolean(&quot;FiringSolutions&quot;)) {</span>
<span class="nc" id="L779">            setFiringSolutions();</span>
        } else {
<span class="nc" id="L781">            clientgui.getBoardView().clearFiringSolutionData();</span>
        }
<span class="nc" id="L783">    }</span>

    public void setFiringSolutions() {
        // If no Entity is selected, exit
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (cen == Entity.NONE) {</span>
<span class="nc" id="L788">            return;</span>
        }

<span class="nc" id="L791">        IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L792">        IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">        if (!GUIPreferences.getInstance().getFiringSolutions()) {</span>
<span class="nc" id="L794">            return;</span>
        }

        // Determine which entities are spotted
<span class="nc" id="L798">        Set&lt;Integer&gt; spottedEntities = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L800" title="All 4 branches missed.">            if (!target.isEnemyOf(ce()) &amp;&amp; target.isSpotting()) {</span>
<span class="nc" id="L801">                spottedEntities.add(target.getSpotTargetId());</span>
            }
<span class="nc" id="L803">        }</span>

        // Calculate firing solutions
<span class="nc" id="L806">        Map&lt;Integer, FiringSolution&gt; fs = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector()) {</span>
<span class="nc" id="L808">            boolean friendlyFire = game.getOptions().booleanOption(</span>
                    OptionsConstants.BASE_FRIENDLY_FIRE); //$NON-NLS-1$
<span class="nc" id="L810">            boolean enemyTarget = target.getOwner().isEnemyOf(ce().getOwner());</span>
<span class="nc bnc" id="L811" title="All 8 branches missed.">            if ((target.getId() != cen)</span>
                &amp;&amp; (friendlyFire || enemyTarget)
<span class="nc bnc" id="L813" title="All 2 branches missed.">                &amp;&amp; (!enemyTarget || EntityVisibilityUtils.detectedOrHasVisual(localPlayer, game, target))</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">                &amp;&amp; target.isTargetable()) {</span>
<span class="nc" id="L815">                ToHitData thd = WeaponAttackAction.toHit(game, cen, target);</span>
<span class="nc" id="L816">                thd.setLocation(target.getPosition());</span>
<span class="nc" id="L817">                thd.setRange(ce().getPosition().distance(target.getPosition()));</span>
<span class="nc" id="L818">                fs.put(target.getId(), new FiringSolution(thd, spottedEntities.contains(target.getId())));</span>
            }
<span class="nc" id="L820">        }</span>
<span class="nc" id="L821">        clientgui.getBoardView().setFiringSolutions(ce(), fs);</span>
<span class="nc" id="L822">    }</span>

    /**
     * Does turn start stuff
     */
    protected void beginMyTurn() {
<span class="nc" id="L828">        target = null;</span>

<span class="nc bnc" id="L830" title="All 2 branches missed.">        if (!clientgui.bv.isMovingUnits()) {</span>
<span class="nc" id="L831">            clientgui.setDisplayVisible(true);</span>
        }
<span class="nc" id="L833">        clientgui.bv.clearFieldofF();</span>

<span class="nc" id="L835">        selectEntity(clientgui.getClient().getFirstEntityNum());</span>

<span class="nc" id="L837">        GameTurn turn = clientgui.getClient().getMyTurn();</span>
        // There's special processing for triggering AP Pods.
<span class="nc bnc" id="L839" title="All 4 branches missed.">        if ((turn instanceof GameTurn.TriggerAPPodTurn) &amp;&amp; (ce() != null)) {</span>
<span class="nc" id="L840">            disableButtons();</span>
<span class="nc" id="L841">            TriggerAPPodDialog dialog = new TriggerAPPodDialog(</span>
<span class="nc" id="L842">                    clientgui.getFrame(), ce());</span>
<span class="nc" id="L843">            dialog.setVisible(true);</span>
<span class="nc" id="L844">            attacks.removeAllElements();</span>
<span class="nc" id="L845">            Enumeration&lt;TriggerAPPodAction&gt; actions = dialog.getActions();</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">            while (actions.hasMoreElements()) {</span>
<span class="nc" id="L847">                attacks.addElement(actions.nextElement());</span>
            }
<span class="nc" id="L849">            ready();</span>
<span class="nc bnc" id="L850" title="All 4 branches missed.">        } else if ((turn instanceof GameTurn.TriggerBPodTurn) &amp;&amp; (null != ce())) {</span>
<span class="nc" id="L851">            disableButtons();</span>
<span class="nc" id="L852">            TriggerBPodDialog dialog = new TriggerBPodDialog(clientgui, ce(),</span>
<span class="nc" id="L853">                    ((GameTurn.TriggerBPodTurn) turn).getAttackType());</span>
<span class="nc" id="L854">            dialog.setVisible(true);</span>
<span class="nc" id="L855">            attacks.removeAllElements();</span>
<span class="nc" id="L856">            Enumeration&lt;TriggerBPodAction&gt; actions = dialog.getActions();</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">            while (actions.hasMoreElements()) {</span>
<span class="nc" id="L858">                attacks.addElement(actions.nextElement());</span>
            }
<span class="nc" id="L860">            ready();</span>
<span class="nc" id="L861">        } else {</span>
<span class="nc" id="L862">            setNextEnabled(true);</span>
<span class="nc" id="L863">            butDone.setEnabled(true);</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">            if (numButtonGroups &gt; 1)</span>
<span class="nc" id="L865">                buttons.get(FiringCommand.FIRE_MORE).setEnabled(true);</span>
<span class="nc" id="L866">            setFireCalledEnabled(clientgui.getClient().getGame().getOptions()</span>
<span class="nc" id="L867">                    .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CALLED_SHOTS));</span>
<span class="nc" id="L868">            clientgui.getBoardView().select(null);</span>
        }
        //check if there should be a turn timer running
<span class="nc" id="L871">        tt = TurnTimer.init(this, clientgui.getClient());</span>
<span class="nc" id="L872">    }</span>

    /**
     * Does end turn stuff.
     */
    protected void endMyTurn() {
        //get rid of still running timer, if turn is concluded before time is up
<span class="nc bnc" id="L879" title="All 2 branches missed.">        if (tt != null) {</span>
<span class="nc" id="L880">            tt.stopTimer();</span>
<span class="nc" id="L881">            tt = null;</span>
        }
        // end my turn, then.
<span class="nc" id="L884">        IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L885">        Entity next = game.getNextEntity(game.getTurnIndex());</span>
<span class="nc bnc" id="L886" title="All 4 branches missed.">        if ((game.getPhase() == IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">            &amp;&amp; (next != null) &amp;&amp; (ce() != null)</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">            &amp;&amp; (next.getOwnerId() != ce().getOwnerId())) {</span>
<span class="nc" id="L889">            clientgui.setDisplayVisible(false);</span>
        }
<span class="nc" id="L891">        cen = Entity.NONE;</span>
<span class="nc" id="L892">        target(null);</span>
<span class="nc" id="L893">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L894">        clientgui.getBoardView().highlight(null);</span>
<span class="nc" id="L895">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L896">        clientgui.bv.clearMovementData();</span>
<span class="nc" id="L897">        clientgui.bv.clearFiringSolutionData();</span>
<span class="nc" id="L898">        clientgui.bv.clearStrafingCoords();</span>
<span class="nc" id="L899">        clientgui.bv.clearFieldofF();</span>
<span class="nc" id="L900">        clientgui.setSelectedEntityNum(Entity.NONE);</span>
<span class="nc" id="L901">        disableButtons();</span>

<span class="nc" id="L903">        clearVisibleTargets();</span>
<span class="nc" id="L904">    }</span>

    /**
     * Disables all buttons in the interface
     */
    protected void disableButtons() {
<span class="nc" id="L910">        setFireEnabled(false);</span>
<span class="nc" id="L911">        setSkipEnabled(false);</span>
<span class="nc" id="L912">        setTwistEnabled(false);</span>
<span class="nc" id="L913">        setSpotEnabled(false);</span>
<span class="nc" id="L914">        setFindClubEnabled(false);</span>
<span class="nc" id="L915">        buttons.get(FiringCommand.FIRE_MORE).setEnabled(false);</span>
<span class="nc" id="L916">        setNextEnabled(false);</span>
<span class="nc" id="L917">        butDone.setEnabled(false);</span>
<span class="nc" id="L918">        setNextTargetEnabled(false);</span>
<span class="nc" id="L919">        setFlipArmsEnabled(false);</span>
<span class="nc" id="L920">        setFireModeEnabled(false);</span>
<span class="nc" id="L921">        setFireCalledEnabled(false);</span>
<span class="nc" id="L922">        setFireClearTurretEnabled(false);</span>
<span class="nc" id="L923">        setFireClearWeaponJamEnabled(false);</span>
<span class="nc" id="L924">        setStrafeEnabled(false);</span>
<span class="nc" id="L925">    }</span>

    /**
     * Fire Mode - Adds a Fire Mode Change to the current Attack Action
     */
    protected void changeMode(boolean forward) {
<span class="nc" id="L931">        int wn = clientgui.mechD.wPan.getSelectedWeaponNum();</span>

        // Do nothing we have no unit selected.
<span class="nc bnc" id="L934" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L935">            return;</span>
        }

        // If the weapon does not have modes, just exit.
<span class="nc" id="L939">        Mounted m = ce().getEquipment(wn);</span>
<span class="nc bnc" id="L940" title="All 4 branches missed.">        if ((m == null) || !m.getType().hasModes()) {</span>
<span class="nc" id="L941">            return;</span>
        }

        // Aeros cannot switch modes under standard rules
        /*
         * if (ce() instanceof Aero) { return; }
         */

        // send change to the server
<span class="nc" id="L950">        int nMode = m.switchMode(forward);</span>
        // BattleArmor can fire popup-mine launchers individually. The mode determines
        // how many will be fired, but we don't want to set the mode higher than the
        // number of troopers in the squad.
<span class="nc bnc" id="L954" title="All 2 branches missed.">        if ((ce() instanceof BattleArmor)</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                &amp;&amp; (m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">                &amp;&amp; ((WeaponType)m.getType()).hasFlag(WeaponType.F_BA_INDIVIDUAL)</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                &amp;&amp; (m.curMode().getName().contains(&quot;-shot&quot;))</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">                &amp;&amp; (Integer.parseInt(m.curMode().getName().replace(&quot;-shot&quot;, &quot;&quot;)) &gt; ce().getTotalInternal())) {</span>
<span class="nc" id="L959">            m.setMode(0);</span>
        }
<span class="nc" id="L961">        clientgui.getClient().sendModeChange(cen, wn, nMode);</span>

        // notify the player
<span class="nc bnc" id="L964" title="All 2 branches missed.">        if (m.canInstantSwitch(nMode)) {</span>
<span class="nc" id="L965">            clientgui.systemMessage(Messages.getString(</span>
<span class="nc" id="L966">                    &quot;FiringDisplay.switched&quot;, new Object[] { m.getName(),</span>
<span class="nc" id="L967">                            m.curMode().getDisplayableName(true) })); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L969">            clientgui.systemMessage(Messages.getString(</span>
<span class="nc" id="L970">                    &quot;FiringDisplay.willSwitch&quot;, new Object[] { m.getName(), //$NON-NLS-1$</span>
<span class="nc" id="L971">                            m.pendingMode().getDisplayableName(true) }));</span>
        }

<span class="nc" id="L974">        updateTarget();</span>
<span class="nc" id="L975">        clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L976">        clientgui.mechD.wPan.selectWeapon(wn);</span>
<span class="nc" id="L977">    }</span>

    /**
     * Called Shots - changes the current called shots selection
     */
    protected void changeCalled() {
<span class="nc" id="L983">        int wn = clientgui.mechD.wPan.getSelectedWeaponNum();</span>

        // Do nothing we have no unit selected.
<span class="nc bnc" id="L986" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L987">            return;</span>
        }

<span class="nc" id="L990">        Mounted m = ce().getEquipment(wn);</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">        if ((m == null)) {</span>
<span class="nc" id="L992">            return;</span>
        }

        // send change to the server
<span class="nc" id="L996">        m.getCalledShot().switchCalledShot();</span>
<span class="nc" id="L997">        clientgui.getClient().sendCalledShotChange(cen, wn);</span>

<span class="nc" id="L999">        updateTarget();</span>
<span class="nc" id="L1000">        clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L1001">        clientgui.mechD.wPan.selectWeapon(wn);</span>
<span class="nc" id="L1002">    }</span>

    /**
     * Cache the list of visible targets. This is used for the 'next target'
     * button.
     * &lt;p/&gt;
     * We'll sort it by range to us.
     */
    private void cacheVisibleTargets() {
<span class="nc" id="L1011">        clearVisibleTargets();</span>

<span class="nc" id="L1013">        List&lt;Entity&gt; vec = clientgui.getClient().getGame()</span>
<span class="nc" id="L1014">                .getValidTargets(ce());</span>
<span class="nc" id="L1015">        Comparator&lt;Entity&gt; sortComp = new Comparator&lt;Entity&gt;() {</span>
            public int compare(Entity entX, Entity entY) {
<span class="nc" id="L1017">                int rangeToX = ce().getPosition().distance(entX.getPosition());</span>
<span class="nc" id="L1018">                int rangeToY = ce().getPosition().distance(entY.getPosition());</span>

<span class="nc bnc" id="L1020" title="All 2 branches missed.">                if (rangeToX == rangeToY) {</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">                    return ((entX.getId() &lt; entY.getId()) ? -1 : 1);</span>
                }

<span class="nc bnc" id="L1024" title="All 2 branches missed.">                return ((rangeToX &lt; rangeToY) ? -1 : 1);</span>
            }
        };

        // put the vector in the TreeSet first to sort it.
<span class="nc" id="L1029">        TreeSet&lt;Entity&gt; tree = new TreeSet&lt;Entity&gt;(sortComp);</span>
<span class="nc" id="L1030">        visibleTargets = new Entity[vec.size()];</span>

<span class="nc bnc" id="L1032" title="All 2 branches missed.">        for (int i = 0; i &lt; vec.size(); i++) {</span>
<span class="nc" id="L1033">            tree.add(vec.get(i));</span>
        }

        // not go through the sorted Set to cache the targets.
<span class="nc" id="L1037">        Iterator&lt;Entity&gt; it = tree.iterator();</span>
<span class="nc" id="L1038">        int count = 0;</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L1040">            visibleTargets[count++] = it.next();</span>
        }

<span class="nc bnc" id="L1043" title="All 2 branches missed.">        setNextTargetEnabled(visibleTargets.length &gt; 0);</span>
<span class="nc" id="L1044">    }</span>

    private void clearVisibleTargets() {
<span class="nc" id="L1047">        visibleTargets = null;</span>
<span class="nc" id="L1048">        lastTargetID = -1;</span>
<span class="nc" id="L1049">        setNextTargetEnabled(false);</span>
<span class="nc" id="L1050">    }</span>

    /**
     * Get the next target. Return null if we don't have any targets.
     */
    private Entity getNextTarget(boolean nextOrPrev, boolean onlyValid,
            boolean ignoreAllies) {
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (visibleTargets == null) {</span>
<span class="nc" id="L1058">            return null;</span>
        }

<span class="nc" id="L1061">        Entity result = null;</span>
<span class="nc" id="L1062">        boolean done = false;</span>
<span class="nc" id="L1063">        int count = 0;</span>
        // Loop until we hit an exit criteria
        //  Default is one iteration, but may need to skip invalid or allies
<span class="nc bnc" id="L1066" title="All 2 branches missed.">        while (!done) {</span>
            // Increment or decrement target index
<span class="nc bnc" id="L1068" title="All 2 branches missed.">            if (nextOrPrev) {</span>
<span class="nc" id="L1069">                lastTargetID++;</span>
            } else {
<span class="nc" id="L1071">                lastTargetID--;</span>
            }
            // Check bounds
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            if (lastTargetID &lt; 0) {</span>
<span class="nc" id="L1075">                lastTargetID = visibleTargets.length - 1;</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">            } else if (lastTargetID &gt;= visibleTargets.length) {</span>
<span class="nc" id="L1077">                lastTargetID = 0;</span>
            }
            //If we've cycled through all visible targets without finding a valid one, stop looping
<span class="nc" id="L1080">            count++;</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">            if (count &gt; visibleTargets.length) {</span>
<span class="nc" id="L1082">            	return null;</span>
            }
            // Store target
<span class="nc" id="L1085">            result = visibleTargets[lastTargetID];</span>
<span class="nc" id="L1086">            done = true;</span>
            // Check done
<span class="nc bnc" id="L1088" title="All 2 branches missed.">            if (onlyValid) {</span>
<span class="nc" id="L1089">                ToHitData toHit = WeaponAttackAction.toHit(</span>
<span class="nc" id="L1090">                        clientgui.getClient().getGame(), ce().getId(), result,</span>
<span class="nc" id="L1091">                        clientgui.mechD.wPan.getSelectedWeaponNum(),</span>
                        isStrafing);
<span class="nc bnc" id="L1093" title="All 2 branches missed.">                done &amp;= toHit.getValue() != TargetRoll.AUTOMATIC_FAIL</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                        &amp;&amp; toHit.getValue() != TargetRoll.IMPOSSIBLE</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                        &amp;&amp; toHit.getValue() &lt;= 12;</span>
            }
<span class="nc bnc" id="L1097" title="All 2 branches missed.">            if (ignoreAllies) {</span>
<span class="nc" id="L1098">                done &amp;= result.isEnemyOf(ce());</span>
            }
        }
<span class="nc" id="L1101">        return result;</span>
    }

    /**
     * Jump to our next target. If there isn't one, well, don't do anything.
     */
    private void jumpToTarget(boolean nextTarg, boolean onlyValid,
            boolean ignoreAllies) {
<span class="nc" id="L1109">        Entity targ = getNextTarget(nextTarg, onlyValid, ignoreAllies);</span>

<span class="nc bnc" id="L1111" title="All 2 branches missed.">        if (targ == null) {</span>
<span class="nc" id="L1112">            return;</span>
        }

        // HACK : don't show the choice dialog.
<span class="nc" id="L1116">        showTargetChoice = false;</span>

<span class="nc" id="L1118">        clientgui.bv.centerOnHex(targ.getPosition());</span>
<span class="nc" id="L1119">        clientgui.getBoardView().select(targ.getPosition());</span>

        // HACK : show the choice dialog again.
<span class="nc" id="L1122">        showTargetChoice = true;</span>
<span class="nc" id="L1123">        target(targ);</span>
<span class="nc" id="L1124">    }</span>

    /**
     * Called when the current entity is done firing. Send out our attack queue
     * to the server.
     */
    @Override
    public void ready() {
<span class="nc bnc" id="L1132" title="All 2 branches missed.">        if (attacks.isEmpty()</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">                &amp;&amp; GUIPreferences.getInstance().getNagForNoAction()) {</span>
            // comfirm this action
<span class="nc" id="L1135">            String title = Messages</span>
<span class="nc" id="L1136">                    .getString(&quot;FiringDisplay.DontFireDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1137">            String body = Messages</span>
<span class="nc" id="L1138">                    .getString(&quot;FiringDisplay.DontFireDialog.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1139">            ConfirmDialog response = clientgui.doYesNoBotherDialog(title, body);</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">            if (!response.getShowAgain()) {</span>
<span class="nc" id="L1141">                GUIPreferences.getInstance().setNagForNoAction(false);</span>
            }
<span class="nc bnc" id="L1143" title="All 2 branches missed.">            if (!response.getAnswer()) {</span>
<span class="nc" id="L1144">                return;</span>
            }
        }

        // We need to nag for overheat on capital fighters
<span class="nc bnc" id="L1149" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isCapitalFighter()</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getNagForOverheat()) {</span>
<span class="nc" id="L1151">            int totalheat = 0;</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">            for (EntityAction action : attacks) {</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">                if (action instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1154">                    Mounted weapon = ce().getEquipment(</span>
<span class="nc" id="L1155">                            ((WeaponAttackAction) action).getWeaponId());</span>
<span class="nc" id="L1156">                    totalheat += weapon.getCurrentHeat();</span>
                }
<span class="nc" id="L1158">            }</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">            if (totalheat &gt; ce().getHeatCapacity()) {</span>
                // comfirm this action
<span class="nc" id="L1161">                String title = Messages</span>
<span class="nc" id="L1162">                        .getString(&quot;FiringDisplay.OverheatNag.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1163">                String body = Messages</span>
<span class="nc" id="L1164">                        .getString(&quot;FiringDisplay.OverheatNag.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1165">                ConfirmDialog response = clientgui.doYesNoBotherDialog(title,</span>
                        body);
<span class="nc bnc" id="L1167" title="All 2 branches missed.">                if (!response.getShowAgain()) {</span>
<span class="nc" id="L1168">                    GUIPreferences.getInstance().setNagForOverheat(false);</span>
                }
<span class="nc bnc" id="L1170" title="All 2 branches missed.">                if (!response.getAnswer()) {</span>
<span class="nc" id="L1171">                    return;</span>
                }
            }
        }

        // stop further input (hopefully)
<span class="nc" id="L1177">        disableButtons();</span>

        // remove temporary attacks from game &amp; board
<span class="nc" id="L1180">        removeTempAttacks();</span>

        // For bug 1002223
        // Re-compute the to-hit numbers by adding in correct order.
<span class="nc" id="L1184">        Vector&lt;EntityAction&gt; newAttacks = new Vector&lt;EntityAction&gt;();</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">        for (EntityAction o : attacks) {</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">            if (o instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L1187">                newAttacks.addElement(o);</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">            } else if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1189">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L1190">                Entity attacker = waa</span>
<span class="nc" id="L1191">                        .getEntity(clientgui.getClient().getGame());</span>
<span class="nc" id="L1192">                Targetable target1 = waa.getTarget(clientgui.getClient()</span>
<span class="nc" id="L1193">                        .getGame());</span>
<span class="nc" id="L1194">                boolean curInFrontArc = Compute.isInArc(attacker.getPosition(),</span>
<span class="nc" id="L1195">                        attacker.getSecondaryFacing(), target1,</span>
<span class="nc" id="L1196">                        attacker.getForwardArc());</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">                if (curInFrontArc) {</span>
<span class="nc" id="L1198">                    WeaponAttackAction waa2 = new WeaponAttackAction(</span>
<span class="nc" id="L1199">                            waa.getEntityId(), waa.getTargetType(),</span>
<span class="nc" id="L1200">                            waa.getTargetId(), waa.getWeaponId());</span>
<span class="nc" id="L1201">                    waa2.setAimedLocation(waa.getAimedLocation());</span>
<span class="nc" id="L1202">                    waa2.setAimingMode(waa.getAimingMode());</span>
<span class="nc" id="L1203">                    waa2.setOtherAttackInfo(waa.getOtherAttackInfo());</span>
<span class="nc" id="L1204">                    waa2.setAmmoId(waa.getAmmoId());</span>
<span class="nc" id="L1205">                    waa2.setAmmoCarrier(waa.getAmmoCarrier());</span>
<span class="nc" id="L1206">                    waa2.setBombPayload(waa.getBombPayload());</span>
<span class="nc" id="L1207">                    waa2.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L1208">                    waa2.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L1209">                    newAttacks.addElement(waa2);</span>
                }
<span class="nc" id="L1211">            } else {</span>
<span class="nc" id="L1212">                newAttacks.addElement(o);</span>
            }
<span class="nc" id="L1214">        }</span>
        // now add the attacks in rear/arm arcs
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        for (EntityAction o : attacks) {</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">            if (o instanceof ArtilleryAttackAction) {</span>
                // newAttacks.addElement(o);
<span class="nc" id="L1219">                continue;</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">            } else if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1221">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L1222">                Entity attacker = waa</span>
<span class="nc" id="L1223">                        .getEntity(clientgui.getClient().getGame());</span>
<span class="nc" id="L1224">                Targetable target1 = waa.getTarget(clientgui.getClient()</span>
<span class="nc" id="L1225">                        .getGame());</span>
<span class="nc" id="L1226">                boolean curInFrontArc = Compute.isInArc(attacker.getPosition(),</span>
<span class="nc" id="L1227">                        attacker.getSecondaryFacing(), target1,</span>
<span class="nc" id="L1228">                        attacker.getForwardArc());</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">                if (!curInFrontArc) {</span>
<span class="nc" id="L1230">                    WeaponAttackAction waa2 = new WeaponAttackAction(</span>
<span class="nc" id="L1231">                            waa.getEntityId(), waa.getTargetType(),</span>
<span class="nc" id="L1232">                            waa.getTargetId(), waa.getWeaponId());</span>
<span class="nc" id="L1233">                    waa2.setAimedLocation(waa.getAimedLocation());</span>
<span class="nc" id="L1234">                    waa2.setAimingMode(waa.getAimingMode());</span>
<span class="nc" id="L1235">                    waa2.setOtherAttackInfo(waa.getOtherAttackInfo());</span>
<span class="nc" id="L1236">                    waa2.setAmmoId(waa.getAmmoId());</span>
<span class="nc" id="L1237">                    waa2.setAmmoCarrier(waa.getAmmoCarrier());</span>
<span class="nc" id="L1238">                    waa2.setBombPayload(waa.getBombPayload());</span>
<span class="nc" id="L1239">                    waa2.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L1240">                    waa2.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L1241">                    newAttacks.addElement(waa2);</span>
                }
            }
<span class="nc" id="L1244">        }</span>
        
        // If the user picked a hex along the flight path, server needs to know
<span class="nc bnc" id="L1247" title="All 4 branches missed.">        if ((target instanceof Entity) &amp;&amp; Compute.isGroundToAir(ce(), target)) {</span>
<span class="nc" id="L1248">            Coords targetPos = ((Entity)target).getPlayerPickedPassThrough(cen);</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">            if (targetPos != null) {</span>
<span class="nc" id="L1250">                clientgui.getClient().sendPlayerPickedPassThrough(</span>
<span class="nc" id="L1251">                        ((Entity) target).getId(), cen, targetPos);</span>
            }
        }

        // send out attacks
<span class="nc" id="L1256">        clientgui.getClient().sendAttackData(cen, newAttacks);</span>

        // clear queue
<span class="nc" id="L1259">        attacks.removeAllElements();</span>

        // Clear the menu bar.
<span class="nc" id="L1262">        clientgui.getMenuBar().setEntity(null);</span>

        // close aimed shot display, if any
<span class="nc" id="L1265">        ash.closeDialog();</span>

<span class="nc bnc" id="L1267" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L1268">            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</span>
        }
<span class="nc" id="L1270">        endMyTurn();</span>
<span class="nc" id="L1271">    }</span>

    /**
     * clear turret
     */
    private void doClearTurret() {
<span class="nc" id="L1277">        String title = Messages.getString(&quot;FiringDisplay.ClearTurret.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1278">        String body = Messages.getString(&quot;FiringDisplay.ClearTurret.message&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">        if (!clientgui.doYesNoDialog(title, body)) {</span>
<span class="nc" id="L1280">            return;</span>
        }
<span class="nc bnc" id="L1282" title="All 4 branches missed.">        if ((((attacks.size() == 0) &amp;&amp; (ce() instanceof Tank) &amp;&amp; (((Tank) ce())</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">                .isTurretJammed(((Tank) ce()).getLocTurret()))) || ((Tank) ce())</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">                .isTurretJammed(((Tank) ce()).getLocTurret2()))) {</span>
<span class="nc" id="L1285">            UnjamTurretAction uta = new UnjamTurretAction(ce().getId());</span>
<span class="nc" id="L1286">            attacks.add(uta);</span>
<span class="nc" id="L1287">            ready();</span>
        }
<span class="nc" id="L1289">    }</span>

    /**
     * clear weapon jam
     */
    private void doClearWeaponJam() {
<span class="nc" id="L1295">        ArrayList&lt;Mounted&gt; weapons = ((Tank) ce()).getJammedWeapons();</span>
<span class="nc" id="L1296">        String[] names = new String[weapons.size()];</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        for (int loop = 0; loop &lt; names.length; loop++) {</span>
<span class="nc" id="L1298">            names[loop] = weapons.get(loop).getDesc();</span>
        }
<span class="nc" id="L1300">        String input = (String) JOptionPane.showInputDialog(clientgui, Messages</span>
<span class="nc" id="L1301">                .getString(&quot;FiringDisplay.ClearWeaponJam&quot; + &quot;.question&quot;), //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L1302">                Messages.getString(&quot;FiringDisplay.ClearWeaponJam.title&quot;), //$NON-NLS-1$</span>
                //$NON-NLS-1$
                JOptionPane.QUESTION_MESSAGE, null, names, null);

<span class="nc bnc" id="L1306" title="All 2 branches missed.">        if (input != null) {</span>
<span class="nc bnc" id="L1307" title="All 2 branches missed.">            for (int loop = 0; loop &lt; names.length; loop++) {</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">                if (input.equals(names[loop])) {</span>
<span class="nc" id="L1309">                    RepairWeaponMalfunctionAction rwma = new RepairWeaponMalfunctionAction(</span>
<span class="nc" id="L1310">                            ce().getId(), ce().getEquipmentNum(</span>
<span class="nc" id="L1311">                                    weapons.get(loop)));</span>
<span class="nc" id="L1312">                    attacks.add(rwma);</span>
<span class="nc" id="L1313">                    ready();</span>
                }
            }
        }
<span class="nc" id="L1317">    }</span>

    /**
     * fire searchlight
     */
    protected void doSearchlight() {
        // validate
<span class="nc bnc" id="L1324" title="All 4 branches missed.">        if ((ce() == null) || (target == null)) {</span>
<span class="nc" id="L1325">            throw new IllegalArgumentException(</span>
                    &quot;current searchlight parameters are invalid&quot;); //$NON-NLS-1$
        }

<span class="nc bnc" id="L1329" title="All 2 branches missed.">        if (!SearchlightAttackAction.isPossible(</span>
<span class="nc" id="L1330">                clientgui.getClient().getGame(), cen, target, null)) {</span>
<span class="nc" id="L1331">            return;</span>
        }

        // create and queue a searchlight action
<span class="nc" id="L1335">        SearchlightAttackAction saa = new SearchlightAttackAction(cen,</span>
<span class="nc" id="L1336">                target.getTargetType(), target.getTargetId());</span>
<span class="nc" id="L1337">        attacks.addElement(saa);</span>

        // and add it into the game, temporarily
<span class="nc" id="L1340">        clientgui.getClient().getGame().addAction(saa);</span>
<span class="nc" id="L1341">        clientgui.bv.addAttack(saa);</span>
<span class="nc" id="L1342">        clientgui.minimap.drawMap();</span>

        // refresh weapon panel, as bth will have changed
<span class="nc" id="L1345">        updateTarget();</span>
<span class="nc" id="L1346">    }</span>
    
    private void doStrafe() {
<span class="nc" id="L1349">        target(null);</span>
<span class="nc" id="L1350">        clearAttacks();        </span>
<span class="nc" id="L1351">        isStrafing = true;</span>
<span class="nc" id="L1352">        setStatusBarText(Messages</span>
<span class="nc" id="L1353">                .getString(&quot;FiringDisplay.Strafing.StatusLabel&quot;));</span>
<span class="nc" id="L1354">        refreshAll();</span>
<span class="nc" id="L1355">    }</span>
    
    private void updateStrafingTargets() {
<span class="nc" id="L1358">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L1359">        final int weaponId = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L1360">        final Mounted m = ce().getEquipment(weaponId);</span>
        ToHitData toHit;
<span class="nc" id="L1362">        StringBuffer toHitBuff = new StringBuffer();</span>
<span class="nc" id="L1363">        setFireEnabled(true);</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">        for (Coords c : strafingCoords) {</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">            for (Entity t : game.getEntitiesVector(c)) {</span>
                // Airborne units cannot be strafed
<span class="nc bnc" id="L1367" title="All 2 branches missed.">                if (t.isAirborne()) {</span>
<span class="nc" id="L1368">                    continue;</span>
                }
                // Can't shoot at infantry in the building
                // Instead, strafe will hit the building, which could damage Inf
<span class="nc bnc" id="L1372" title="All 4 branches missed.">                if (Compute.isInBuilding(game, t) &amp;&amp; (t instanceof Infantry)) {</span>
<span class="nc" id="L1373">                    continue;</span>
                }
                
<span class="nc" id="L1376">                toHit = WeaponAttackAction.toHit(game, cen, t, weaponId,</span>
                        Entity.LOC_NONE, IAimingModes.AIM_MODE_NONE, true);
<span class="nc" id="L1378">                toHitBuff.append(t.getShortName() + &quot;: &quot;);</span>
<span class="nc" id="L1379">                toHitBuff.append(toHit.getDesc());</span>
<span class="nc" id="L1380">                toHitBuff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L1381" title="All 2 branches missed.">                if (m.getType().hasFlag(WeaponType.F_AUTO_TARGET)</span>
<span class="nc bnc" id="L1382" title="All 2 branches missed.">                        || (toHit.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L1383">                    setFireEnabled(false);</span>
                }
<span class="nc" id="L1385">            }</span>
<span class="nc" id="L1386">            Building bldg = game.getBoard().getBuildingAt(c); </span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">            if (bldg != null) {</span>
<span class="nc" id="L1388">                Targetable t = new BuildingTarget(c, game.getBoard(), false);</span>
<span class="nc" id="L1389">                toHit = WeaponAttackAction.toHit(game, cen, t, weaponId,</span>
                        Entity.LOC_NONE, IAimingModes.AIM_MODE_NONE, true);
<span class="nc" id="L1391">                toHitBuff.append(t.getDisplayName() + &quot;: &quot;);</span>
<span class="nc" id="L1392">                toHitBuff.append(toHit.getDesc());</span>
<span class="nc" id="L1393">                toHitBuff.append(&quot;\n&quot;);</span>
            }
<span class="nc" id="L1395">            Targetable hexTarget = new HexTarget(c, game.getBoard(),</span>
                    HexTarget.TYPE_HEX_CLEAR);
<span class="nc" id="L1397">            toHit = WeaponAttackAction.toHit(game, cen, hexTarget, weaponId,</span>
                    Entity.LOC_NONE, IAimingModes.AIM_MODE_NONE, true);
<span class="nc bnc" id="L1399" title="All 2 branches missed.">            if (m.getType().hasFlag(WeaponType.F_AUTO_TARGET)</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">                    || (toHit.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L1401">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">                if (toHitBuff.length() &lt; 1) {</span>
<span class="nc" id="L1403">                    toHitBuff.append(toHit.getDesc());</span>
                }
            }
            // Could check legality on buildings, but I don't believe there are
            // any weapons that are still legal that aren't legal on buildings            
<span class="nc" id="L1408">        }</span>
<span class="nc" id="L1409">        clientgui.mechD.wPan.toHitText.setText(toHitBuff.toString());</span>
<span class="nc" id="L1410">    }</span>

    private int[] getBombPayload(boolean isSpace, int limit) {
<span class="nc" id="L1413">        int[] payload = new int[BombType.B_NUM];</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">        if (!ce().isBomber()) {</span>
<span class="nc" id="L1415">            return payload;</span>
        }
<span class="nc" id="L1417">        int[] loadout = ce().getBombLoadout();</span>
        // this part is ugly, but we need to find any other bombing attacks by
        // this
        // entity in the attack list and subtract those payloads from the
        // loadout
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        for (EntityAction o : attacks) {</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">            if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1424">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">                if (waa.getEntityId() == ce().getId()) {</span>
<span class="nc" id="L1426">                    int[] priorLoad = waa.getBombPayload();</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">                    for (int i = 0; i &lt; priorLoad.length; i++) {</span>
<span class="nc" id="L1428">                        loadout[i] = loadout[i] - priorLoad[i];</span>
                    }
                }
            }
<span class="nc" id="L1432">        }</span>

<span class="nc" id="L1434">        int numFighters = ce().getActiveSubEntities().orElse(Collections.emptyList()).size();</span>
<span class="nc" id="L1435">        BombPayloadDialog bombsDialog = new BombPayloadDialog(</span>
                clientgui.frame,
<span class="nc" id="L1437">                Messages.getString(&quot;FiringDisplay.BombNumberDialog&quot; + &quot;.title&quot;), //$NON-NLS-1$</span>
                loadout, isSpace, false, limit, numFighters);
<span class="nc" id="L1439">        bombsDialog.setVisible(true);</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">        if (bombsDialog.getAnswer()) {</span>
<span class="nc" id="L1441">            payload = bombsDialog.getChoices();</span>
        }
<span class="nc" id="L1443">        return payload;</span>
    }

    /**
     * Adds a weapon attack with the currently selected weapon to the attack
     * queue.
     */
    void fire() {
<span class="nc" id="L1451">        final IGame game = clientgui.getClient().getGame();</span>
        // get the selected weaponnum
<span class="nc" id="L1453">        final int weaponNum = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L1454">        Mounted mounted = ce().getEquipment(weaponNum);</span>

        // validate
<span class="nc bnc" id="L1457" title="All 6 branches missed.">        if ((ce() == null)</span>
<span class="nc bnc" id="L1458" title="All 4 branches missed.">                || (target == null &amp;&amp; (!isStrafing || strafingCoords.size() == 0))</span>
                || (mounted == null)
<span class="nc bnc" id="L1460" title="All 2 branches missed.">                || !(mounted.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L1461">            throw new IllegalArgumentException(</span>
                    &quot;current fire parameters are invalid&quot;); //$NON-NLS-1$
        }
        // check if we now shoot at a target in the front arc and previously
        // shot a target in side/rear arc that then was primary target
        // if so, ask and tell the user that to-hits will change
<span class="nc bnc" id="L1467" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_NO_FORCED_PRIMARY_TARGETS)</span>
<span class="nc bnc" id="L1468" title="All 4 branches missed.">                &amp;&amp; (ce() instanceof Mech) || (ce() instanceof Tank)</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">                || (ce() instanceof Protomech)) {</span>
<span class="nc" id="L1470">            EntityAction lastAction = null;</span>
            try {
<span class="nc" id="L1472">                lastAction = attacks.lastElement();</span>
<span class="nc" id="L1473">            } catch (NoSuchElementException ex) {</span>
                // ignore
<span class="nc" id="L1475">            }</span>
<span class="nc bnc" id="L1476" title="All 4 branches missed.">            if ((lastAction != null)</span>
                    &amp;&amp; (lastAction instanceof WeaponAttackAction)) {
<span class="nc" id="L1478">                WeaponAttackAction oldWaa = (WeaponAttackAction) lastAction;</span>
<span class="nc" id="L1479">                Targetable oldTarget = oldWaa.getTarget(game);</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">                if (!oldTarget.equals(target)) {</span>
<span class="nc" id="L1481">                    boolean oldInFront = Compute.isInArc(ce().getPosition(),</span>
<span class="nc" id="L1482">                            ce().getSecondaryFacing(), oldTarget, ce()</span>
<span class="nc" id="L1483">                                    .getForwardArc());</span>
<span class="nc" id="L1484">                    boolean curInFront = Compute.isInArc(ce().getPosition(),</span>
<span class="nc" id="L1485">                            ce().getSecondaryFacing(), target, ce()</span>
<span class="nc" id="L1486">                                    .getForwardArc());</span>
<span class="nc bnc" id="L1487" title="All 4 branches missed.">                    if (!oldInFront &amp;&amp; curInFront) {</span>
<span class="nc" id="L1488">                        String title = Messages</span>
<span class="nc" id="L1489">                                .getString(&quot;FiringDisplay.SecondaryTargetToHitChange.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1490">                        String body = Messages</span>
<span class="nc" id="L1491">                                .getString(&quot;FiringDisplay.SecondaryTargetToHitChange.message&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1492" title="All 2 branches missed.">                        if (!clientgui.doYesNoDialog(title, body)) {</span>
<span class="nc" id="L1493">                            return;</span>
                        }
                    }
                }
            }
        }

        // declare searchlight, if possible
<span class="nc bnc" id="L1501" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getAutoDeclareSearchlight()</span>
<span class="nc bnc" id="L1502" title="All 2 branches missed.">            &amp;&amp; ce().isUsingSpotlight()) {</span>
<span class="nc" id="L1503">            doSearchlight();</span>
        }

<span class="nc" id="L1506">        ArrayList&lt;Targetable&gt; targets = new ArrayList&lt;Targetable&gt;();</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">        if (isStrafing) {</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">            for (Coords c : strafingCoords) {</span>
<span class="nc" id="L1509">                targets.add(new HexTarget(c, game.getBoard(),</span>
                        Targetable.TYPE_HEX_CLEAR));
<span class="nc" id="L1511">                Building bldg = game.getBoard().getBuildingAt(c); </span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">                if (bldg != null) {</span>
<span class="nc" id="L1513">                    targets.add(new BuildingTarget(c, game.getBoard(), false));</span>
                }
                // Target all ground units (non-airborne, VTOLs still count)
<span class="nc bnc" id="L1516" title="All 2 branches missed.">                for (Entity t : game.getEntitiesVector(c)) {</span>
<span class="nc bnc" id="L1517" title="All 4 branches missed.">                    boolean infInBuilding = Compute.isInBuilding(game, t)</span>
                            &amp;&amp; (t instanceof Infantry);
<span class="nc bnc" id="L1519" title="All 4 branches missed.">                    if (!t.isAirborne() &amp;&amp; !infInBuilding) {</span>
<span class="nc" id="L1520">                        targets.add(t);</span>
                    }
<span class="nc" id="L1522">                }</span>
<span class="nc" id="L1523">            }</span>
        } else {
<span class="nc" id="L1525">            targets.add(target);</span>
        }
        
<span class="nc" id="L1528">        boolean firstShot = true;</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">        for (Targetable t : targets) {</span>
        
            WeaponAttackAction waa;
<span class="nc bnc" id="L1532" title="All 2 branches missed.">            if (!(mounted.getType().hasFlag(WeaponType.F_ARTILLERY)</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">                    || (mounted.getType() instanceof CapitalMissileWeapon</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">                            &amp;&amp; Compute.isGroundToGround(ce(), t)))){</span>
<span class="nc" id="L1535">                waa = new WeaponAttackAction(cen, t.getTargetType(),</span>
<span class="nc" id="L1536">                        t.getTargetId(), weaponNum);</span>
            } else {
<span class="nc" id="L1538">                waa = new ArtilleryAttackAction(cen, t.getTargetType(),</span>
<span class="nc" id="L1539">                        t.getTargetId(), weaponNum, game);</span>
            }

            // check for a bomb payload dialog
<span class="nc bnc" id="L1543" title="All 2 branches missed.">            if (mounted.getType().hasFlag(WeaponType.F_SPACE_BOMB)) {</span>
<span class="nc" id="L1544">                int[] payload = getBombPayload(true, -1);</span>
<span class="nc" id="L1545">                waa.setBombPayload(payload);</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">            } else if (mounted.getType().hasFlag(WeaponType.F_DIVE_BOMB)) {</span>
<span class="nc" id="L1547">                int[] payload = getBombPayload(false, -1);</span>
<span class="nc" id="L1548">                waa.setBombPayload(payload);</span>
<span class="nc bnc" id="L1549" title="All 2 branches missed.">            } else if (mounted.getType().hasFlag(WeaponType.F_ALT_BOMB)) {</span>
                // if the user cancels, then return
<span class="nc" id="L1551">                int[] payload = getBombPayload(false, 2);</span>
<span class="nc" id="L1552">                waa.setBombPayload(payload);</span>
            }

<span class="nc bnc" id="L1555" title="All 2 branches missed.">            if ((mounted.getLinked() != null)</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">                    &amp;&amp; (((WeaponType) mounted.getType()).getAmmoType() != AmmoType.T_NA)</span>
<span class="nc bnc" id="L1557" title="All 2 branches missed.">                    &amp;&amp; (mounted.getLinked().getType() instanceof AmmoType)) {</span>
<span class="nc" id="L1558">                Mounted ammoMount = mounted.getLinked();</span>
<span class="nc" id="L1559">                AmmoType ammoType = (AmmoType) ammoMount.getType();</span>
<span class="nc" id="L1560">                waa.setAmmoId(ammoMount.getEntity().getEquipmentNum(ammoMount));</span>
<span class="nc" id="L1561">                waa.setAmmoCarrier(ammoMount.getEntity().getId());</span>
<span class="nc bnc" id="L1562" title="All 2 branches missed.">                if (((ammoType.getMunitionType() == AmmoType.M_THUNDER_VIBRABOMB) &amp;&amp; </span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">                        ((ammoType.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L1565" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MML)))</span>
<span class="nc bnc" id="L1566" title="All 2 branches missed.">                        || (ammoType.getMunitionType() == AmmoType.M_VIBRABOMB_IV)) {</span>
<span class="nc" id="L1567">                    VibrabombSettingDialog vsd = new VibrabombSettingDialog(</span>
                            clientgui.frame);
<span class="nc" id="L1569">                    vsd.setVisible(true);</span>
<span class="nc" id="L1570">                    waa.setOtherAttackInfo(vsd.getSetting());</span>
                }
            }

<span class="nc bnc" id="L1574" title="All 4 branches missed.">            if (ash.allowAimedShotWith(mounted) &amp;&amp; ash.inAimingMode()</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">                    &amp;&amp; ash.isAimingAtLocation()) {</span>
<span class="nc" id="L1576">                waa.setAimedLocation(ash.getAimingAt());</span>
<span class="nc" id="L1577">                waa.setAimingMode(ash.getAimingMode());</span>
            } else {
<span class="nc" id="L1579">                waa.setAimedLocation(Entity.LOC_NONE);</span>
<span class="nc" id="L1580">                waa.setAimingMode(IAimingModes.AIM_MODE_NONE);</span>
            }
<span class="nc" id="L1582">            waa.setStrafing(isStrafing);</span>
<span class="nc" id="L1583">            waa.setStrafingFirstShot(firstShot);</span>
<span class="nc" id="L1584">            firstShot = false;</span>

            // add the attack to our temporary queue
<span class="nc" id="L1587">            attacks.addElement(waa);</span>

            // and add it into the game, temporarily
<span class="nc" id="L1590">            game.addAction(waa);</span>
        
<span class="nc" id="L1592">        }</span>
<span class="nc" id="L1593">        clientgui.minimap.drawMap();</span>

        // set the weapon as used
<span class="nc" id="L1596">        mounted.setUsedThisRound(true);</span>

        // find the next available weapon
<span class="nc" id="L1599">        int nextWeapon = clientgui.mechD.wPan.getNextWeaponNum();</span>

        // we fired a weapon, can't clear turret jams or weapon jams anymore
<span class="nc" id="L1602">        updateClearTurret();</span>
<span class="nc" id="L1603">        updateClearWeaponJam();</span>

        // check; if there are no ready weapons, you're done.
<span class="nc bnc" id="L1606" title="All 2 branches missed.">        if ((nextWeapon == -1)</span>
<span class="nc bnc" id="L1607" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getAutoEndFiring()) {</span>
<span class="nc" id="L1608">            ready();</span>
<span class="nc" id="L1609">            return;</span>
        }

        // otherwise, display firing info for the next weapon
<span class="nc" id="L1613">        clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L1614">        Mounted nextMounted = ce().getEquipment(nextWeapon);</span>
<span class="nc bnc" id="L1615" title="All 4 branches missed.">        if (!mounted.getType().hasFlag(WeaponType.F_VGL)</span>
                &amp;&amp; (nextMounted != null)
<span class="nc bnc" id="L1617" title="All 2 branches missed.">                &amp;&amp; nextMounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L1618">            clientgui.mechD.wPan.setPrevTarget(target);</span>
        }
<span class="nc" id="L1620">        clientgui.mechD.wPan.selectWeapon(nextWeapon);</span>
<span class="nc" id="L1621">        updateTarget();</span>

<span class="nc" id="L1623">    }</span>

    /**
     * Skips to the next weapon
     */
    void nextWeapon() {
<span class="nc bnc" id="L1629" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1630">            return;</span>
        }
<span class="nc" id="L1632">        clientgui.mechD.wPan.selectNextWeapon();</span>

<span class="nc bnc" id="L1634" title="All 2 branches missed.">        if (ce().getId() != clientgui.mechD.wPan.getSelectedEntityId()) {</span>
<span class="nc" id="L1635">            clientgui.mechD.wPan.displayMech(ce());</span>
        }

<span class="nc" id="L1638">        updateTarget();</span>
<span class="nc" id="L1639">    }</span>

    /**
     * Skips to the previous weapon
     */
    void prevWeapon() {
<span class="nc bnc" id="L1645" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1646">            return;</span>
        }

<span class="nc" id="L1649">        clientgui.mechD.wPan.selectPrevWeapon();</span>

<span class="nc bnc" id="L1651" title="All 2 branches missed.">        if (ce().getId() != clientgui.mechD.wPan.getSelectedEntityId()) {</span>
<span class="nc" id="L1652">            clientgui.mechD.wPan.displayMech(ce());</span>
        }

<span class="nc" id="L1655">        updateTarget();</span>
<span class="nc" id="L1656">    }</span>

    /**
     * The entity spends the rest of its turn finding a club
     */
    private void findClub() {
<span class="nc bnc" id="L1662" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1663">            return;</span>
        }

        // comfirm this action
<span class="nc" id="L1667">        String title = Messages.getString(&quot;FiringDisplay.FindClubDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1668">        String body = Messages</span>
<span class="nc" id="L1669">                .getString(&quot;FiringDisplay.FindClubDialog.message&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1670" title="All 2 branches missed.">        if (!clientgui.doYesNoDialog(title, body)) {</span>
<span class="nc" id="L1671">            return;</span>
        }

<span class="nc" id="L1674">        attacks.removeAllElements();</span>
<span class="nc" id="L1675">        attacks.addElement(new FindClubAction(cen));</span>

<span class="nc" id="L1677">        ready();</span>
<span class="nc" id="L1678">    }</span>

    /**
     * The entity spends the rest of its turn spotting
     */
    protected void doSpot() {
<span class="nc bnc" id="L1684" title="All 4 branches missed.">        if ((ce() == null) || (target == null)) {</span>
<span class="nc" id="L1685">            return;</span>
        }
<span class="nc bnc" id="L1687" title="All 2 branches missed.">        if (ce().isINarcedWith(INarcPod.HAYWIRE)) {</span>
<span class="nc" id="L1688">            String title = Messages</span>
<span class="nc" id="L1689">                    .getString(&quot;FiringDisplay.CantSpotDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1690">            String body = Messages</span>
<span class="nc" id="L1691">                    .getString(&quot;FiringDisplay.CantSpotDialog.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1692">            clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L1693">            return;</span>
        }
        // comfirm this action
<span class="nc" id="L1696">        String title = Messages</span>
<span class="nc" id="L1697">                .getString(&quot;FiringDisplay.SpotForInderectDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1698">        String body = Messages</span>
<span class="nc" id="L1699">                .getString(&quot;FiringDisplay.SpotForInderectDialog.message&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1700" title="All 2 branches missed.">        if (!clientgui.doYesNoDialog(title, body)) {</span>
<span class="nc" id="L1701">            return;</span>
        }
<span class="nc" id="L1703">        attacks.addElement(new SpotAction(cen, target.getTargetId()));</span>

<span class="nc" id="L1705">    }</span>

    /**
     * Removes all current fire
     */
    protected void clearAttacks() {
<span class="nc" id="L1711">        isStrafing = false;</span>
<span class="nc" id="L1712">        strafingCoords.clear();</span>
<span class="nc" id="L1713">        clientgui.bv.clearStrafingCoords();</span>
        
        // We may not have an entity selected yet (race condition).
<span class="nc bnc" id="L1716" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1717">            return;</span>
        }
        
        // remove attacks, set weapons available again
<span class="nc" id="L1721">        Enumeration&lt;AbstractEntityAction&gt; i = attacks.elements();</span>
<span class="nc bnc" id="L1722" title="All 2 branches missed.">        while (i.hasMoreElements()) {</span>
<span class="nc" id="L1723">            Object o = i.nextElement();</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">            if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1725">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L1726">                ce().getEquipment(waa.getWeaponId()).setUsedThisRound(false);</span>
            }
<span class="nc" id="L1728">        }</span>
<span class="nc" id="L1729">        attacks.removeAllElements();</span>

        // remove temporary attacks from game &amp; board
<span class="nc" id="L1732">        removeTempAttacks();</span>

        // restore any other movement to default
<span class="nc" id="L1735">        ce().setSecondaryFacing(ce().getFacing());</span>
<span class="nc" id="L1736">        ce().setArmsFlipped(false);</span>
<span class="nc" id="L1737">    }</span>

    /**
     * Removes temp attacks from the game and board
     */
    protected void removeTempAttacks() {
        // remove temporary attacks from game &amp; board
<span class="nc" id="L1744">        clientgui.getClient().getGame().removeActionsFor(cen);</span>
<span class="nc" id="L1745">        clientgui.bv.removeAttacksFor(ce());</span>
<span class="nc" id="L1746">    }</span>

    /**
     * removes the last action
     */
    protected void removeLastFiring() {
<span class="nc bnc" id="L1752" title="All 2 branches missed.">        if (!attacks.isEmpty()) {</span>
<span class="nc" id="L1753">            Object o = attacks.lastElement();</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">            if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1755">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L1756">                ce().getEquipment(waa.getWeaponId()).setUsedThisRound(false);</span>
<span class="nc" id="L1757">                attacks.removeElement(o);</span>
<span class="nc" id="L1758">                clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L1759">                clientgui.getClient().getGame().removeAction(o);</span>
<span class="nc" id="L1760">                clientgui.bv.refreshAttacks();</span>
<span class="nc" id="L1761">                clientgui.minimap.drawMap();</span>
            }
        }
<span class="nc" id="L1764">    }</span>

    /**
     * Refreshes all displays.
     */
    protected void refreshAll() {
<span class="nc bnc" id="L1770" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1771">            return;</span>
        }
<span class="nc" id="L1773">        clientgui.bv.redrawEntity(ce());</span>
<span class="nc" id="L1774">        clientgui.mechD.displayEntity(ce());</span>
<span class="nc" id="L1775">        clientgui.mechD.showPanel(&quot;weapons&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1776">        clientgui.mechD.wPan.selectFirstWeapon();</span>
<span class="nc bnc" id="L1777" title="All 2 branches missed.">        if (ce().isMakingVTOLGroundAttack()) {</span>
<span class="nc" id="L1778">            this.updateVTOLGroundTarget();</span>
        }
<span class="nc" id="L1780">        updateTarget();</span>
<span class="nc" id="L1781">    }</span>

    /**
     * Targets something
     */
    public void target(Targetable t) {
<span class="nc bnc" id="L1787" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1788">            return;</span>
        }
<span class="nc" id="L1790">        final int weaponId = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L1791">        Mounted weapon = ce().getEquipment(weaponId); </span>
        // Some weapons pick an automatic target
<span class="nc bnc" id="L1793" title="All 4 branches missed.">        if ((weapon != null) &amp;&amp; weapon.getType().hasFlag(WeaponType.F_VGL)) {</span>
            int facing;
<span class="nc bnc" id="L1795" title="All 2 branches missed.">            if (ce().isSecondaryArcWeapon(weaponId)) {</span>
<span class="nc" id="L1796">                facing = ce().getSecondaryFacing();</span>
            } else {
<span class="nc" id="L1798">                facing = ce().getFacing();</span>
            }
<span class="nc" id="L1800">            facing = (facing + weapon.getFacing()) % 6;</span>
<span class="nc" id="L1801">            Coords c = ce().getPosition().translated(facing);</span>
<span class="nc" id="L1802">            Targetable hexTarget = </span>
                    new HexTarget(c, Targetable.TYPE_HEX_CLEAR);
            // Ignore events that will be generated by the select/cursor calls
<span class="nc" id="L1805">            setIgnoringEvents(true);</span>
<span class="nc" id="L1806">            clientgui.getBoardView().select(c);</span>
<span class="nc" id="L1807">            setIgnoringEvents(false);</span>
<span class="nc" id="L1808">            target = hexTarget;</span>
<span class="nc" id="L1809">        } else {</span>
<span class="nc" id="L1810">            target = t;</span>
<span class="nc bnc" id="L1811" title="All 4 branches missed.">            if ((visibleTargets != null) &amp;&amp; (target != null)) {</span>
                // Set last target ID, so next/prev target behaves correctly
<span class="nc bnc" id="L1813" title="All 2 branches missed.">                for (int i = 0; i &lt; visibleTargets.length; i++) {</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">                    if (visibleTargets[i].getId() == target.getTargetId()) {</span>
<span class="nc" id="L1815">                        lastTargetID = i;</span>
<span class="nc" id="L1816">                        break;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L1821" title="All 4 branches missed.">        if ((target instanceof Entity) &amp;&amp; Compute.isGroundToAir(ce(), target)) {</span>
<span class="nc" id="L1822">            Coords targetPos = Compute.getClosestFlightPath(cen, ce()</span>
<span class="nc" id="L1823">                    .getPosition(), (Entity) target);</span>
<span class="nc" id="L1824">            clientgui.getBoardView().cursor(targetPos);</span>
        }
<span class="nc" id="L1826">        ash.setAimingMode();</span>
<span class="nc" id="L1827">        updateTarget();</span>
<span class="nc" id="L1828">        ash.showDialog();</span>
<span class="nc" id="L1829">    }</span>

    /**
     * Targets something
     */
    public void updateTarget() {
<span class="nc" id="L1835">        setFireEnabled(false);</span>
<span class="nc" id="L1836">        IGame game = clientgui.getClient().getGame();</span>
        // allow spotting
<span class="nc bnc" id="L1838" title="All 8 branches missed.">        if ((ce() != null) &amp;&amp; !ce().isSpotting() &amp;&amp; ce().canSpot() &amp;&amp; (target != null)</span>
<span class="nc bnc" id="L1839" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.BASE_INDIRECT_FIRE)) { //$NON-NLS-1$)</span>
<span class="nc" id="L1840">            boolean hasLos = LosEffects.calculateLos(game, cen, target)</span>
<span class="nc" id="L1841">                    .canSee();</span>
            // In double blind, we need to &quot;spot&quot; the target as well as LoS
<span class="nc bnc" id="L1843" title="All 2 branches missed.">            if (hasLos</span>
<span class="nc bnc" id="L1844" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L1845" title="All 2 branches missed.">                    &amp;&amp; !Compute.inVisualRange(game, ce(), target)</span>
<span class="nc bnc" id="L1846" title="All 2 branches missed.">                    &amp;&amp; !Compute.inSensorRange(game, ce(), target, null)) {</span>
<span class="nc" id="L1847">                hasLos = false;</span>
            }
<span class="nc" id="L1849">            setSpotEnabled(hasLos);</span>
<span class="nc" id="L1850">        } else {</span>
<span class="nc" id="L1851">            setSpotEnabled(false);</span>
        }

        // update target panel
<span class="nc" id="L1855">        final int weaponId = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc bnc" id="L1856" title="All 4 branches missed.">        if (isStrafing &amp;&amp; weaponId != -1) {</span>
<span class="nc" id="L1857">            clientgui.mechD.wPan.wTargetR.setText(Messages</span>
<span class="nc" id="L1858">                    .getString(&quot;FiringDisplay.Strafing.TargetLabel&quot;));</span>
<span class="nc" id="L1859">            updateStrafingTargets();</span>
<span class="nc bnc" id="L1860" title="All 6 branches missed.">        } else if ((target != null) &amp;&amp; (target.getPosition() != null)</span>
<span class="nc bnc" id="L1861" title="All 2 branches missed.">            &amp;&amp; (weaponId != -1) &amp;&amp; (ce() != null)) {</span>
            ToHitData toHit;
<span class="nc bnc" id="L1863" title="All 2 branches missed.">            if (ash.inAimingMode()) {</span>
<span class="nc" id="L1864">                Mounted weapon = ce().getEquipment(weaponId);</span>
<span class="nc bnc" id="L1865" title="All 2 branches missed.">                boolean aiming = ash.isAimingAtLocation()</span>
<span class="nc bnc" id="L1866" title="All 2 branches missed.">                        &amp;&amp; ash.allowAimedShotWith(weapon);</span>
<span class="nc" id="L1867">                ash.setEnableAll(aiming);</span>
<span class="nc bnc" id="L1868" title="All 2 branches missed.">                if (aiming) {</span>
<span class="nc" id="L1869">                    toHit = WeaponAttackAction.toHit(game, cen, target,</span>
<span class="nc" id="L1870">                            weaponId, ash.getAimingAt(), ash.getAimingMode(),</span>
                            false);
<span class="nc" id="L1872">                    clientgui.mechD.wPan.wTargetR.setText(target</span>
<span class="nc" id="L1873">                            .getDisplayName()</span>
<span class="nc" id="L1874">                            + &quot; (&quot; + ash.getAimingLocation() + &quot;)&quot;); //$NON-NLS-1$ // $NON-NLS-2$</span>
                } else {
<span class="nc" id="L1876">                    toHit = WeaponAttackAction.toHit(game, cen, target,</span>
                            weaponId, Entity.LOC_NONE,
                            IAimingModes.AIM_MODE_NONE, false);
<span class="nc" id="L1879">                    clientgui.mechD.wPan.wTargetR.setText(target</span>
<span class="nc" id="L1880">                            .getDisplayName());</span>
                }
<span class="nc" id="L1882">                ash.setPartialCover(toHit.getCover());</span>
<span class="nc" id="L1883">            } else {</span>
<span class="nc" id="L1884">                toHit = WeaponAttackAction.toHit(game, cen, target, weaponId,</span>
                        Entity.LOC_NONE, IAimingModes.AIM_MODE_NONE, false);
<span class="nc" id="L1886">                clientgui.mechD.wPan.wTargetR.setText(target.getDisplayName());</span>
            }
<span class="nc" id="L1888">            int effectiveDistance = Compute.effectiveDistance(</span>
<span class="nc" id="L1889">                    game, ce(), target);</span>
<span class="nc" id="L1890">            clientgui.mechD.wPan.wRangeR.setText(&quot;&quot; + effectiveDistance); //$NON-NLS-1$</span>
<span class="nc" id="L1891">            Mounted m = ce().getEquipment(weaponId);</span>
            // If we have a Centurion Weapon System selected, we may need to
            //  update ranges.
<span class="nc bnc" id="L1894" title="All 2 branches missed.">            if (m.getType().hasFlag(WeaponType.F_CWS)) {</span>
<span class="nc" id="L1895">                clientgui.mechD.wPan.selectWeapon(weaponId);</span>
            }
<span class="nc bnc" id="L1897" title="All 2 branches missed.">            if (m.isUsedThisRound()) {</span>
<span class="nc" id="L1898">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L1899">                        .getString(&quot;FiringDisplay.alreadyFired&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1900">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1901" title="All 4 branches missed.">            } else if ((m.getType().hasFlag(WeaponType.F_AUTO_TARGET) &amp;&amp; !m.curMode().equals(Weapon.MODE_AMS_MANUAL))</span>
<span class="nc bnc" id="L1902" title="All 4 branches missed.">            			|| (m.getType().hasModes() &amp;&amp; m.curMode().equals(&quot;Point Defense&quot;))) {</span>
<span class="nc" id="L1903">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L1904">                        .getString(&quot;FiringDisplay.autoFiringWeapon&quot;));</span>
                //$NON-NLS-1$
<span class="nc" id="L1906">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">            } else if (m.isInBearingsOnlyMode()) {</span>
<span class="nc" id="L1908">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L1909">                        .getString(&quot;FiringDisplay.bearingsOnlyWrongPhase&quot;));</span>
                //$NON-NLS-1$
<span class="nc" id="L1911">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">            } else if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L1913">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString());</span>
<span class="nc" id="L1914">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">            } else if (toHit.getValue() == TargetRoll.AUTOMATIC_FAIL) {</span>
<span class="nc" id="L1916">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString());</span>
<span class="nc" id="L1917">                setFireEnabled(true);</span>
            } else {
<span class="nc" id="L1919">                boolean natAptGunnery = ce().hasAbility(OptionsConstants.PILOT_APTITUDE_GUNNERY);</span>
<span class="nc" id="L1920">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString()</span>
                        + &quot; (&quot;
<span class="nc" id="L1922">                        + Compute.oddsAbove(toHit.getValue(), natAptGunnery)</span>
                        + &quot;%)&quot;); //$NON-NLS-1$
                // $NON-NLS-2$
<span class="nc" id="L1925">                setFireEnabled(true);</span>
            }
<span class="nc" id="L1927">            clientgui.mechD.wPan.toHitText.setText(toHit.getDesc());</span>
<span class="nc" id="L1928">            setSkipEnabled(true);</span>
<span class="nc" id="L1929">        } else {</span>
<span class="nc" id="L1930">            clientgui.mechD.wPan.wTargetR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1931">            clientgui.mechD.wPan.wRangeR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1932">            clientgui.mechD.wPan.wToHitR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1933">            clientgui.mechD.wPan.toHitText.setText(&quot;&quot;); //$NON-NLS-1$</span>
        }

<span class="nc bnc" id="L1936" title="All 6 branches missed.">        if ((weaponId != -1) &amp;&amp; (ce() != null) &amp;&amp; !isStrafing) {</span>
<span class="nc" id="L1937">            adaptFireModeEnabled(ce().getEquipment(weaponId));</span>
        } else {
<span class="nc" id="L1939">            setFireModeEnabled(false);</span>
        } 

<span class="nc" id="L1942">        updateSearchlight();</span>

        // Hidden units can only spot
<span class="nc bnc" id="L1945" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isHidden()) {</span>
<span class="nc" id="L1946">            setFireEnabled(false);</span>
<span class="nc" id="L1947">            setTwistEnabled(false);</span>
<span class="nc" id="L1948">            setFindClubEnabled(false);</span>
<span class="nc" id="L1949">            setFlipArmsEnabled(false);</span>
<span class="nc" id="L1950">            setStrafeEnabled(false);</span>
<span class="nc" id="L1951">            clientgui.mechD.wPan.toHitText</span>
<span class="nc" id="L1952">                    .setText(&quot;Hidden units are only allowed to spot!&quot;);</span>
        }
<span class="nc" id="L1954">    }</span>

    /**
     * A VTOL or LAM in airmech mode making a bombing or strafing attack already has the target set
     * during the movement phase. 
     */
    void updateVTOLGroundTarget() {
<span class="nc" id="L1961">        clientgui.bv.clearStrafingCoords();</span>
<span class="nc" id="L1962">        target(null);</span>
<span class="nc" id="L1963">        isStrafing = false;</span>
<span class="nc" id="L1964">        strafingCoords.clear();</span>
<span class="nc bnc" id="L1965" title="All 4 branches missed.">        if (ce().isBomber() &amp;&amp; ((IBomber)ce()).isVTOLBombing()) {</span>
<span class="nc" id="L1966">            target(((IBomber)ce()).getVTOLBombTarget());</span>
<span class="nc" id="L1967">            clientgui.bv.addStrafingCoords(target.getPosition());</span>
<span class="nc bnc" id="L1968" title="All 4 branches missed.">        } else if ((ce() instanceof VTOL) &amp;&amp; ((VTOL)ce()).getStrafingCoords().size() &gt; 0) {</span>
<span class="nc" id="L1969">            strafingCoords.addAll(((VTOL)ce()).getStrafingCoords());</span>
<span class="nc" id="L1970">            strafingCoords.forEach(c -&gt; clientgui.bv.addStrafingCoords(c));</span>
<span class="nc" id="L1971">            isStrafing = true;</span>
        }
<span class="nc" id="L1973">    }</span>
    
    /**
     * Torso twist in the proper direction.
     */
    void torsoTwist(Coords twistTarget) {
<span class="nc" id="L1979">        int direction = ce().getFacing();</span>

<span class="nc bnc" id="L1981" title="All 2 branches missed.">        if (twistTarget != null) {</span>
<span class="nc" id="L1982">            direction = ce().clipSecondaryFacing(</span>
<span class="nc" id="L1983">                    ce().getPosition().direction(twistTarget));</span>
        }

<span class="nc bnc" id="L1986" title="All 2 branches missed.">        if (direction != ce().getSecondaryFacing()) {</span>
<span class="nc" id="L1987">            clearAttacks();</span>
<span class="nc" id="L1988">            attacks.addElement(new TorsoTwistAction(cen, direction));</span>
<span class="nc" id="L1989">            ce().setSecondaryFacing(direction);</span>
<span class="nc" id="L1990">            refreshAll();</span>
        }
<span class="nc" id="L1992">    }</span>

    /**
     * Torso twist to the left or right
     *
     * @param twistDir An &lt;code&gt;int&lt;/code&gt; specifying wether we're twisting left or
     *                 right, 0 if we're twisting to the left, 1 if to the right.
     */

    void torsoTwist(int twistDir) {
<span class="nc" id="L2002">        int direction = ce().getSecondaryFacing();</span>
<span class="nc bnc" id="L2003" title="All 2 branches missed.">        if (twistDir == 0) {</span>
<span class="nc" id="L2004">            clearAttacks();</span>
<span class="nc" id="L2005">            direction = ce().clipSecondaryFacing((direction + 5) % 6);</span>
<span class="nc" id="L2006">            attacks.addElement(new TorsoTwistAction(cen, direction));</span>
<span class="nc" id="L2007">            ce().setSecondaryFacing(direction);</span>
<span class="nc" id="L2008">            refreshAll();</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">        } else if (twistDir == 1) {</span>
<span class="nc" id="L2010">            clearAttacks();</span>
<span class="nc" id="L2011">            direction = ce().clipSecondaryFacing((direction + 7) % 6);</span>
<span class="nc" id="L2012">            attacks.addElement(new TorsoTwistAction(cen, direction));</span>
<span class="nc" id="L2013">            ce().setSecondaryFacing(direction);</span>
<span class="nc" id="L2014">            refreshAll();</span>
        }
<span class="nc" id="L2016">    }</span>

    /**
     * Returns the current entity.
     */
    Entity ce() {
<span class="nc" id="L2022">        return clientgui.getClient().getGame().getEntity(cen);</span>
    }

    //
    // BoardListener
    //
    @Override
    public void hexMoused(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L2032" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2033">            return;</span>
        }

        // ignore buttons other than 1
<span class="nc bnc" id="L2037" title="All 2 branches missed.">        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L2038" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.BUTTON1_MASK) == 0)) {</span>
<span class="nc" id="L2039">            return;</span>
        }
        // control pressed means a line of sight check.
        // added ALT_MASK by kenn
<span class="nc bnc" id="L2043" title="All 2 branches missed.">        if (((b.getModifiers() &amp; InputEvent.CTRL_MASK) != 0)</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.ALT_MASK) != 0)) {</span>
<span class="nc" id="L2045">            return;</span>
        }
        // check for shifty goodness
<span class="nc bnc" id="L2048" title="All 4 branches missed.">        if (shiftheld != ((b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0)) {</span>
<span class="nc bnc" id="L2049" title="All 2 branches missed.">            shiftheld = (b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0;</span>
        }

<span class="nc bnc" id="L2052" title="All 2 branches missed.">        if (b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) {</span>
<span class="nc bnc" id="L2053" title="All 4 branches missed.">            if (shiftheld || twisting) {</span>
<span class="nc" id="L2054">                updateFlipArms(false);</span>
<span class="nc" id="L2055">                torsoTwist(b.getCoords());</span>
            }
<span class="nc" id="L2057">            clientgui.getBoardView().cursor(b.getCoords());</span>
<span class="nc bnc" id="L2058" title="All 2 branches missed.">        } else if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</span>
<span class="nc" id="L2059">            twisting = false;</span>
<span class="nc bnc" id="L2060" title="All 2 branches missed.">            if (!shiftheld) {</span>
<span class="nc" id="L2061">                clientgui.getBoardView().select(b.getCoords());</span>
            }
        }
<span class="nc" id="L2064">    }</span>

    @Override
    public void hexSelected(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L2070" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2071">            return;</span>
        }

<span class="nc" id="L2074">        Coords evtCoords = b.getCoords();</span>
<span class="nc bnc" id="L2075" title="All 4 branches missed.">        if (clientgui.getClient().isMyTurn() &amp;&amp; (evtCoords != null)</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">            &amp;&amp; (ce() != null)) {</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">            if (isStrafing) {</span>
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                if (validStrafingCoord(evtCoords)) {</span>
<span class="nc" id="L2079">                    strafingCoords.add(evtCoords);</span>
<span class="nc" id="L2080">                    clientgui.bv.addStrafingCoords(evtCoords);</span>
<span class="nc" id="L2081">                    updateStrafingTargets();</span>
                }
<span class="nc bnc" id="L2083" title="All 2 branches missed.">            } else if (!evtCoords.equals(ce().getPosition())){</span>
                // HACK : sometimes we don't show the target choice window
<span class="nc" id="L2085">                Targetable targ = null;</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">                if (showTargetChoice) {</span>
<span class="nc" id="L2087">                    targ = chooseTarget(evtCoords);</span>
                }
<span class="nc bnc" id="L2089" title="All 2 branches missed.">                if (shiftheld) {</span>
<span class="nc" id="L2090">                    updateFlipArms(false);</span>
<span class="nc" id="L2091">                    torsoTwist(b.getCoords());</span>
<span class="nc bnc" id="L2092" title="All 4 branches missed.">                } else if (targ != null &amp;&amp; !ce().isMakingVTOLGroundAttack()) {</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">                    if ((targ instanceof Entity) </span>
<span class="nc bnc" id="L2094" title="All 2 branches missed.">                            &amp;&amp; Compute.isGroundToAir(ce(), targ)) {</span>
<span class="nc" id="L2095">                        Entity entTarg = (Entity)targ;</span>
<span class="nc" id="L2096">                        boolean alreadyShotAt = false;</span>
<span class="nc" id="L2097">                        List&lt;EntityAction&gt; actions = clientgui.getClient()</span>
<span class="nc" id="L2098">                                .getGame().getActionsVector();</span>
<span class="nc bnc" id="L2099" title="All 2 branches missed.">                        for (EntityAction action : actions) {</span>
<span class="nc bnc" id="L2100" title="All 2 branches missed.">                            if (!(action instanceof AttackAction)) {</span>
<span class="nc" id="L2101">                                continue;</span>
                            }
<span class="nc" id="L2103">                            AttackAction aa = (AttackAction)action;</span>
<span class="nc bnc" id="L2104" title="All 2 branches missed.">                            if ((action.getEntityId() == cen) </span>
<span class="nc bnc" id="L2105" title="All 2 branches missed.">                                    &amp;&amp; (aa.getTargetId() == entTarg.getId())) {</span>
<span class="nc" id="L2106">                                alreadyShotAt = true;</span>
                            }
<span class="nc" id="L2108">                        }</span>
<span class="nc bnc" id="L2109" title="All 2 branches missed.">                        if (!alreadyShotAt) {</span>
<span class="nc" id="L2110">                            entTarg.setPlayerPickedPassThrough(cen, evtCoords);</span>
                        }
                    }
<span class="nc" id="L2113">                    target(targ);</span>
                }
            }
        }
<span class="nc" id="L2117">    }</span>

    //
    // GameListener
    //
    @Override
    public void gameTurnChange(GameTurnChangeEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L2125" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2126">            return;</span>
        }
        // On simultaneous phases, each player ending their turn will generalte a turn change
        // We want to ignore turns from other players and only listen to events we generated
        // Except on the first turn
<span class="nc bnc" id="L2131" title="All 2 branches missed.">        if (clientgui.getClient().getGame().isPhaseSimultaneous()</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">                &amp;&amp; (e.getPreviousPlayerId() != clientgui.getClient().getLocalPlayerNumber())</span>
<span class="nc bnc" id="L2133" title="All 2 branches missed.">                &amp;&amp; (clientgui.getClient().getGame().getTurnIndex() != 0)) {</span>
<span class="nc" id="L2134">            return;</span>
        }
        
<span class="nc bnc" id="L2137" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() == IGame.Phase.PHASE_FIRING) {</span>
<span class="nc bnc" id="L2138" title="All 2 branches missed.">            if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc bnc" id="L2139" title="All 2 branches missed.">                if (cen == Entity.NONE) {</span>
<span class="nc" id="L2140">                    beginMyTurn();</span>
                }
<span class="nc" id="L2142">                setStatusBarText(Messages</span>
<span class="nc" id="L2143">                        .getString(&quot;FiringDisplay.its_your_turn&quot;)); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2145">                endMyTurn();</span>
                String playerName;
<span class="nc bnc" id="L2147" title="All 2 branches missed.">                if (e.getPlayer() != null) {</span>
<span class="nc" id="L2148">                    playerName = e.getPlayer().getName();</span>
                } else {
<span class="nc" id="L2150">                    playerName = &quot;Unknown&quot;;</span>
                }
<span class="nc" id="L2152">                setStatusBarText(Messages.getString(</span>
                        &quot;FiringDisplay.its_others_turn&quot;, //$NON-NLS-1$
                        new Object[] { playerName }));
            }
        }
<span class="nc" id="L2157">    }</span>

    @Override
    public void gamePhaseChange(GamePhaseChangeEvent e) {

        // In case of a /reset command, ensure the state gets reset
<span class="nc bnc" id="L2163" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() </span>
                == IGame.Phase.PHASE_LOUNGE) {
<span class="nc" id="L2165">            endMyTurn();</span>
        }

        // Are we ignoring events?
<span class="nc bnc" id="L2169" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2170">            return;</span>
        }

<span class="nc bnc" id="L2173" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L2174" title="All 2 branches missed.">                &amp;&amp; (clientgui.getClient().getGame().getPhase() </span>
                        != IGame.Phase.PHASE_FIRING)) {
<span class="nc" id="L2176">            endMyTurn();</span>
        }
        // if we're ending the firing phase, unregister stuff.
<span class="nc bnc" id="L2179" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() </span>
                == IGame.Phase.PHASE_FIRING) {
<span class="nc" id="L2181">            setStatusBarText(Messages</span>
<span class="nc" id="L2182">                    .getString(&quot;FiringDisplay.waitingForFiringPhase&quot;)); //$NON-NLS-1$</span>
        }
<span class="nc" id="L2184">    }</span>

    //
    // ActionListener
    //
    public void actionPerformed(ActionEvent ev) {
        // Are we ignoring events?
<span class="nc bnc" id="L2191" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2192">            return;</span>
        }

<span class="nc bnc" id="L2195" title="All 2 branches missed.">        if (statusBarActionPerformed(ev, clientgui.getClient())) {</span>
<span class="nc" id="L2196">            return;</span>
        }

<span class="nc bnc" id="L2199" title="All 2 branches missed.">        if (!clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L2200">            return;</span>
        }

<span class="nc bnc" id="L2203" title="All 2 branches missed.">        if (ev.getActionCommand().equals(FiringCommand.FIRE_FIRE.getCmd())) {</span>
<span class="nc" id="L2204">            fire();</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_SKIP.getCmd())) {</span>
<span class="nc" id="L2206">            nextWeapon();</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_TWIST.getCmd())) {</span>
<span class="nc" id="L2208">            twisting = true;</span>
<span class="nc bnc" id="L2209" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_NEXT.getCmd())) {</span>
<span class="nc" id="L2210">            selectEntity(clientgui.getClient().getNextEntityNum(cen));</span>
<span class="nc bnc" id="L2211" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_MORE.getCmd())) {</span>
<span class="nc" id="L2212">            currentButtonGroup++;</span>
<span class="nc" id="L2213">            currentButtonGroup %= numButtonGroups;</span>
<span class="nc" id="L2214">            setupButtonPanel();</span>
<span class="nc bnc" id="L2215" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_FIND_CLUB.getCmd())) {</span>
<span class="nc" id="L2216">            findClub();</span>
<span class="nc bnc" id="L2217" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_SPOT.getCmd())) {</span>
<span class="nc" id="L2218">            doSpot();</span>
<span class="nc bnc" id="L2219" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_NEXT_TARG.getCmd())) {</span>
<span class="nc bnc" id="L2220" title="All 2 branches missed.">            boolean onlyValidTargets = (ev.getModifiers() &amp; ActionEvent.SHIFT_MASK) &gt; 0;</span>
<span class="nc bnc" id="L2221" title="All 2 branches missed.">            boolean ignoreAllies = (ev.getModifiers() &amp; ActionEvent.CTRL_MASK) &gt; 0;</span>
<span class="nc" id="L2222">            jumpToTarget(true, onlyValidTargets, ignoreAllies);</span>
<span class="nc bnc" id="L2223" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_FLIP_ARMS.getCmd())) {</span>
<span class="nc bnc" id="L2224" title="All 2 branches missed.">            updateFlipArms(!ce().getArmsFlipped());</span>
            // Fire Mode - More Fire Mode button handling - Rasia
<span class="nc bnc" id="L2226" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_MODE.getCmd())) {</span>
<span class="nc" id="L2227">            changeMode(true);</span>
<span class="nc bnc" id="L2228" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_CALLED.getCmd())) {</span>
<span class="nc" id="L2229">            changeCalled();</span>
<span class="nc bnc" id="L2230" title="All 2 branches missed.">        } else if ((&quot;changeSinks&quot;.equalsIgnoreCase(ev.getActionCommand()))</span>
<span class="nc bnc" id="L2231" title="All 2 branches missed.">                   || (ev.getActionCommand().equals(FiringCommand.FIRE_CANCEL.getCmd()))) {</span>
<span class="nc" id="L2232">            clear();</span>
<span class="nc bnc" id="L2233" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_SEARCHLIGHT.getCmd())) {</span>
<span class="nc" id="L2234">            doSearchlight();</span>
<span class="nc bnc" id="L2235" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_CLEAR_TURRET.getCmd())) {</span>
<span class="nc" id="L2236">            doClearTurret();</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_CLEAR_WEAPON.getCmd())) {</span>
<span class="nc" id="L2238">            doClearWeaponJam();</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_STRAFE.getCmd())) {</span>
<span class="nc" id="L2240">            doStrafe();</span>
        }
<span class="nc" id="L2242">    }</span>

    /**
     * update for change of arms-flipping status
     *
     * @param armsFlipped
     */
    void updateFlipArms(boolean armsFlipped) {
<span class="nc bnc" id="L2250" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L2251">            return;</span>
        }
<span class="nc bnc" id="L2253" title="All 2 branches missed.">        if (armsFlipped == ce().getArmsFlipped()) {</span>
<span class="nc" id="L2254">            return;</span>
        }

<span class="nc" id="L2257">        twisting = false;</span>

<span class="nc" id="L2259">        torsoTwist(null);</span>

<span class="nc" id="L2261">        clearAttacks();</span>
<span class="nc" id="L2262">        ce().setArmsFlipped(armsFlipped);</span>
<span class="nc" id="L2263">        attacks.addElement(new FlipArmsAction(cen, armsFlipped));</span>
<span class="nc" id="L2264">        updateTarget();</span>
<span class="nc" id="L2265">        refreshAll();</span>
<span class="nc" id="L2266">    }</span>

    protected void updateSearchlight() {
<span class="nc bnc" id="L2269" title="All 4 branches missed.">        setSearchlightEnabled((ce() != null)</span>
                &amp;&amp; (target != null)
<span class="nc bnc" id="L2271" title="All 2 branches missed.">                &amp;&amp; ce().isUsingSpotlight()</span>
<span class="nc bnc" id="L2272" title="All 2 branches missed.">                &amp;&amp; ce().getCrew().isActive()</span>
<span class="nc bnc" id="L2273" title="All 2 branches missed.">                &amp;&amp; !ce().isHidden()</span>
<span class="nc bnc" id="L2274" title="All 2 branches missed.">                &amp;&amp; SearchlightAttackAction.isPossible(clientgui.getClient()</span>
<span class="nc" id="L2275">                        .getGame(), cen, target, null)</span>
<span class="nc bnc" id="L2276" title="All 4 branches missed.">                &amp;&amp; !((ce() instanceof Tank) &amp;&amp; (((Tank) ce()).getStunnedTurns() &gt; 0)));</span>
<span class="nc" id="L2277">    }</span>

    private void updateClearTurret() {
<span class="nc bnc" id="L2280" title="All 2 branches missed.">        setFireClearTurretEnabled((ce() instanceof Tank)</span>
<span class="nc bnc" id="L2281" title="All 2 branches missed.">                &amp;&amp; ((Tank) ce()).canClearTurret()</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">                &amp;&amp; (attacks.size() == 0));</span>
<span class="nc" id="L2283">    }</span>

    private void updateClearWeaponJam() {
<span class="nc bnc" id="L2286" title="All 2 branches missed.">        setFireClearWeaponJamEnabled((ce() instanceof Tank)</span>
<span class="nc bnc" id="L2287" title="All 2 branches missed.">                &amp;&amp; ((Tank) ce()).canUnjamWeapon()</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">                &amp;&amp; (attacks.size() == 0));</span>
<span class="nc" id="L2289">    }</span>

    private void updateStrafe() {
<span class="nc bnc" id="L2292" title="All 2 branches missed.">        if (ce().isAero()) {</span>
<span class="nc bnc" id="L2293" title="All 4 branches missed.">            setStrafeEnabled(ce().getAltitude() &lt;= 3 &amp;&amp; !((IAero)ce()).isSpheroid());</span>
        } else {
<span class="nc" id="L2295">            setStrafeEnabled(false);</span>
        }
<span class="nc" id="L2297">    }</span>

    protected void setFireEnabled(boolean enabled) {
<span class="nc" id="L2300">        buttons.get(FiringCommand.FIRE_FIRE).setEnabled(enabled);</span>
<span class="nc" id="L2301">        clientgui.getMenuBar().setFireFireEnabled(enabled);</span>
<span class="nc" id="L2302">    }</span>

    protected void setTwistEnabled(boolean enabled) {
<span class="nc" id="L2305">        buttons.get(FiringCommand.FIRE_TWIST).setEnabled(enabled);</span>
<span class="nc" id="L2306">        clientgui.getMenuBar().setFireTwistEnabled(enabled);</span>
<span class="nc" id="L2307">    }</span>

    protected void setSkipEnabled(boolean enabled) {
<span class="nc" id="L2310">        buttons.get(FiringCommand.FIRE_SKIP).setEnabled(enabled);</span>
<span class="nc" id="L2311">        clientgui.getMenuBar().setFireSkipEnabled(enabled);</span>
<span class="nc" id="L2312">    }</span>

    protected void setFindClubEnabled(boolean enabled) {
<span class="nc" id="L2315">        buttons.get(FiringCommand.FIRE_FIND_CLUB).setEnabled(enabled);</span>
<span class="nc" id="L2316">        clientgui.getMenuBar().setFireFindClubEnabled(enabled);</span>
<span class="nc" id="L2317">    }</span>

    protected void setNextTargetEnabled(boolean enabled) {
<span class="nc" id="L2320">        buttons.get(FiringCommand.FIRE_NEXT_TARG).setEnabled(enabled);</span>
<span class="nc" id="L2321">        clientgui.getMenuBar().setFireNextTargetEnabled(enabled);</span>
<span class="nc" id="L2322">    }</span>

    protected void setFlipArmsEnabled(boolean enabled) {
<span class="nc" id="L2325">        buttons.get(FiringCommand.FIRE_FLIP_ARMS).setEnabled(enabled);</span>
<span class="nc" id="L2326">        clientgui.getMenuBar().setFireFlipArmsEnabled(enabled);</span>
<span class="nc" id="L2327">    }</span>

    protected void setSpotEnabled(boolean enabled) {
<span class="nc" id="L2330">        buttons.get(FiringCommand.FIRE_SPOT).setEnabled(enabled);</span>
<span class="nc" id="L2331">        clientgui.getMenuBar().setFireSpotEnabled(enabled);</span>
<span class="nc" id="L2332">    }</span>

    protected void setSearchlightEnabled(boolean enabled) {
<span class="nc" id="L2335">        buttons.get(FiringCommand.FIRE_SEARCHLIGHT).setEnabled(enabled);</span>
<span class="nc" id="L2336">        clientgui.getMenuBar().setFireSearchlightEnabled(enabled);</span>
<span class="nc" id="L2337">    }</span>

    protected void setFireModeEnabled(boolean enabled) {
<span class="nc" id="L2340">        buttons.get(FiringCommand.FIRE_MODE).setEnabled(enabled);</span>
<span class="nc" id="L2341">        clientgui.getMenuBar().setFireModeEnabled(enabled);</span>
<span class="nc" id="L2342">    }</span>
    
    /**
     * Enables the mode button when mode switching is allowed
     * (always true except for LAMs with certain weapons) and
     * the weapon has modes. Disables otherwise.
     *  
     * @param m The active weapon
     */
    protected void adaptFireModeEnabled(Mounted m) {
<span class="nc" id="L2352">        setFireModeEnabled(m.isModeSwitchable() &amp; m.getType().hasModes());</span>
<span class="nc" id="L2353">    }</span>

    protected void setFireCalledEnabled(boolean enabled) {
<span class="nc" id="L2356">        buttons.get(FiringCommand.FIRE_CALLED).setEnabled(enabled);</span>
<span class="nc" id="L2357">        clientgui.getMenuBar().setFireCalledEnabled(enabled);</span>
<span class="nc" id="L2358">    }</span>

    protected void setFireClearTurretEnabled(boolean enabled) {
<span class="nc" id="L2361">        buttons.get(FiringCommand.FIRE_CLEAR_TURRET).setEnabled(enabled);</span>
<span class="nc" id="L2362">        clientgui.getMenuBar().setFireClearTurretEnabled(enabled);</span>
<span class="nc" id="L2363">    }</span>

    protected void setFireClearWeaponJamEnabled(boolean enabled) {
<span class="nc" id="L2366">        buttons.get(FiringCommand.FIRE_CLEAR_WEAPON).setEnabled(enabled);</span>
<span class="nc" id="L2367">        clientgui.getMenuBar().setFireClearWeaponJamEnabled(enabled);</span>
<span class="nc" id="L2368">    }</span>

    protected void setStrafeEnabled(boolean enabled) {
<span class="nc" id="L2371">        buttons.get(FiringCommand.FIRE_STRAFE).setEnabled(enabled);</span>
<span class="nc" id="L2372">        clientgui.getMenuBar().setFireClearWeaponJamEnabled(enabled);</span>
<span class="nc" id="L2373">    }    </span>
    

    protected void setNextEnabled(boolean enabled) {
<span class="nc" id="L2377">        buttons.get(FiringCommand.FIRE_NEXT).setEnabled(enabled);</span>
<span class="nc" id="L2378">        clientgui.getMenuBar().setFireNextEnabled(enabled);</span>
<span class="nc" id="L2379">    }</span>

    @Override
    public void clear() {
<span class="nc bnc" id="L2383" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L2384">            setStatusBarText(Messages</span>
<span class="nc" id="L2385">                    .getString(&quot;FiringDisplay.its_your_turn&quot;)); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L2387" title="All 2 branches missed.">        if ((target instanceof Entity) </span>
<span class="nc bnc" id="L2388" title="All 2 branches missed.">                &amp;&amp; Compute.isGroundToAir(ce(), target)) {</span>
<span class="nc" id="L2389">            ((Entity)target).setPlayerPickedPassThrough(cen, null);</span>
        }
<span class="nc bnc" id="L2391" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; !ce().isMakingVTOLGroundAttack()) {</span>
<span class="nc" id="L2392">            target(null);</span>
        }
<span class="nc" id="L2394">        clearAttacks();        </span>
<span class="nc" id="L2395">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L2396">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L2397">        refreshAll();</span>
<span class="nc" id="L2398">    }</span>

    //
    // ItemListener
    //
    public void itemStateChanged(ItemEvent ev) {

        // Are we ignoring events?
<span class="nc bnc" id="L2406" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2407">            return;</span>
        }
<span class="nc" id="L2409">    }</span>

    // board view listener
    @Override
    public void finishedMovingUnits(BoardViewEvent b) {
        // Are we ignoring events?
<span class="nc bnc" id="L2415" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2416">            return;</span>
        }

<span class="nc bnc" id="L2419" title="All 4 branches missed.">        if (clientgui.getClient().isMyTurn() &amp;&amp; (ce() != null)) {</span>
<span class="nc" id="L2420">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L2421">            clientgui.bv.centerOnHex(ce().getPosition());</span>
        }
<span class="nc" id="L2423">    }</span>

    @Override
    public void unitSelected(BoardViewEvent b) {
        // Are we ignoring events?
<span class="nc bnc" id="L2428" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2429">            return;</span>
        }

<span class="nc" id="L2432">        Entity e = clientgui.getClient().getGame().getEntity(b.getEntityId());</span>
<span class="nc bnc" id="L2433" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L2434">            if (clientgui.getClient().getMyTurn()</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">                         .isValidEntity(e, clientgui.getClient().getGame())) {</span>
<span class="nc" id="L2436">                selectEntity(e.getId());</span>
            }
        } else {
<span class="nc" id="L2439">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L2440">            clientgui.mechD.displayEntity(e);</span>
<span class="nc bnc" id="L2441" title="All 2 branches missed.">            if (e.isDeployed()) {</span>
<span class="nc" id="L2442">                clientgui.bv.centerOnHex(e.getPosition());</span>
            }
        }
<span class="nc" id="L2445">    }</span>

    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L2448" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L2449">            return;</span>
        }
<span class="nc bnc" id="L2451" title="All 2 branches missed.">        if (event.getSource().equals(clientgui.mechD.wPan.weaponList)</span>
<span class="nc bnc" id="L2452" title="All 2 branches missed.">                &amp;&amp; (clientgui.getClient().getGame().getPhase() == Phase.PHASE_FIRING)) {</span>
            // If we aren't in the firing phase, there's no guarantee that cen
            // is set properly, hence we can't update

            // update target data in weapon display
<span class="nc" id="L2457">            updateTarget();</span>
        }
<span class="nc" id="L2459">    }</span>

    /**
     * Stop just ignoring events and actually stop listening to them.
     */
    public void removeAllListeners() {
<span class="nc" id="L2465">        clientgui.getClient().getGame().removeGameListener(this);</span>
<span class="nc" id="L2466">        clientgui.getBoardView().removeBoardViewListener(this);</span>
<span class="nc" id="L2467">        clientgui.mechD.wPan.weaponList.removeListSelectionListener(this);</span>
<span class="nc" id="L2468">    }</span>

    /**
     * Have the player select a target from the entities at the given coords.
     *
     * @param pos - the &lt;code&gt;Coords&lt;/code&gt; containing targets.
     */
    private Targetable chooseTarget(Coords pos) {
<span class="nc" id="L2476">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L2477">        boolean friendlyFire = game.getOptions().booleanOption(OptionsConstants.BASE_FRIENDLY_FIRE); //$NON-NLS-1$</span>
        // Assume that we have *no* choice.
<span class="nc" id="L2479">        Targetable choice = null;</span>
        Iterator&lt;Entity&gt; choices;

<span class="nc" id="L2482">        int wn = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L2483">        Mounted weap = ce().getEquipment(wn);</span>
        
        // Check for weapon/ammo types that should automatically target hexes
<span class="nc bnc" id="L2486" title="All 4 branches missed.">        if ((weap != null) &amp;&amp; (weap.getLinked() != null) </span>
<span class="nc bnc" id="L2487" title="All 2 branches missed.">                &amp;&amp; (weap.getLinked().getType() instanceof AmmoType)) {</span>
<span class="nc" id="L2488">            AmmoType aType = (AmmoType)weap.getLinked().getType();</span>
<span class="nc" id="L2489">            long munitionType = aType.getMunitionType();</span>
            // Mek mortar flares should default to deliver flare
<span class="nc bnc" id="L2491" title="All 4 branches missed.">            if ((aType.getAmmoType() == AmmoType.T_MEK_MORTAR) </span>
                    &amp;&amp; (munitionType == AmmoType.M_FLARE)) {
<span class="nc" id="L2493">                return new HexTarget(pos, game.getBoard(),</span>
                        Targetable.TYPE_FLARE_DELIVER);
            // Certain mek mortar types and LRMs should target hexes
<span class="nc bnc" id="L2496" title="All 2 branches missed.">            } else if (((aType.getAmmoType() == AmmoType.T_MEK_MORTAR)</span>
<span class="nc bnc" id="L2497" title="All 2 branches missed.">                    || (aType.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L2498" title="All 6 branches missed.">                    || (aType.getAmmoType() == AmmoType.T_LRM_IMP))</span>
                    &amp;&amp; ((munitionType == AmmoType.M_AIRBURST) 
                            || (munitionType == AmmoType.M_SMOKE_WARHEAD))) {
<span class="nc" id="L2501">                return new HexTarget(pos, game.getBoard(),</span>
                        Targetable.TYPE_HEX_CLEAR);
<span class="nc bnc" id="L2503" title="All 2 branches missed.">            } else if (munitionType == AmmoType.M_MINE_CLEARANCE) {</span>
<span class="nc" id="L2504">                return new HexTarget(pos, game.getBoard(),</span>
                        Targetable.TYPE_HEX_CLEAR);
            }
        }
        // Get the available choices, depending on friendly fire
<span class="nc bnc" id="L2509" title="All 2 branches missed.">        if (friendlyFire) {</span>
<span class="nc" id="L2510">            choices = game.getEntities(pos);</span>
        } else {
<span class="nc" id="L2512">            choices = game.getEnemyEntities(pos, ce());</span>
        }

        // Convert the choices into a List of targets.
<span class="nc" id="L2516">        List&lt;Targetable&gt; targets = new ArrayList&lt;Targetable&gt;();</span>
<span class="nc" id="L2517">        final IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">        while (choices.hasNext()) {</span>
<span class="nc" id="L2519">            Targetable t = choices.next();</span>
<span class="nc" id="L2520">            boolean isSensorReturn = false;</span>
<span class="nc" id="L2521">            boolean isVisible = true;</span>
<span class="nc" id="L2522">            boolean isHidden = false;</span>
<span class="nc bnc" id="L2523" title="All 2 branches missed.">            if (t instanceof Entity) {</span>
<span class="nc" id="L2524">                isSensorReturn = ((Entity) t).isSensorReturn(localPlayer);</span>
<span class="nc" id="L2525">                isVisible = ((Entity) t).hasSeenEntity(localPlayer);</span>
<span class="nc" id="L2526">                isHidden = ((Entity) t).isHidden();</span>
            }
<span class="nc bnc" id="L2528" title="All 8 branches missed.">            if (!ce().equals(t) &amp;&amp; !isSensorReturn &amp;&amp; isVisible &amp;&amp; !isHidden) {</span>
<span class="nc" id="L2529">                targets.add(t);</span>
            }
<span class="nc" id="L2531">        }</span>
        
        // If there aren't other targets, check for targets flying over pos
<span class="nc bnc" id="L2534" title="All 2 branches missed.">        if (targets.size() == 0) {</span>
<span class="nc" id="L2535">            List&lt;Entity&gt; flyovers = </span>
<span class="nc" id="L2536">                    clientgui.getBoardView().getEntitiesFlyingOver(pos);</span>
<span class="nc bnc" id="L2537" title="All 2 branches missed.">            for (Entity e : flyovers) {</span>
<span class="nc bnc" id="L2538" title="All 2 branches missed.">                if (!targets.contains(e)) {</span>
<span class="nc" id="L2539">                    targets.add(e);</span>
                }
<span class="nc" id="L2541">            }</span>
        }

        // Is there a building in the hex?
<span class="nc" id="L2545">        Building bldg = clientgui.getClient().getGame().getBoard()</span>
<span class="nc" id="L2546">                .getBuildingAt(pos);</span>
<span class="nc bnc" id="L2547" title="All 2 branches missed.">        if (bldg != null) {</span>
<span class="nc" id="L2548">            targets.add(new BuildingTarget(pos, clientgui.getClient().getGame()</span>
<span class="nc" id="L2549">                    .getBoard(), false));</span>
        }
        
        // If we clicked on a wooded hex with no other targets, clear woods
<span class="nc bnc" id="L2553" title="All 2 branches missed.">        if (targets.size() == 0) {</span>
<span class="nc" id="L2554">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L2555" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L2556" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L2557">                targets.add(new HexTarget(pos, game.getBoard(),</span>
                        Targetable.TYPE_HEX_CLEAR));
            }
        }

        // Do we have a single choice?
<span class="nc bnc" id="L2563" title="All 2 branches missed.">        if (targets.size() == 1) {</span>

            // Return that choice.
<span class="nc" id="L2566">            choice = targets.get(0);</span>

        }

        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L2571" title="All 2 branches missed.">        else if (targets.size() &gt; 1) {</span>
<span class="nc" id="L2572">            String input = (String) JOptionPane</span>
<span class="nc" id="L2573">                    .showInputDialog(clientgui,</span>
<span class="nc" id="L2574">                            Messages.getString(</span>
                                    &quot;FiringDisplay.ChooseTargetDialog.message&quot;,
<span class="nc" id="L2576">                                    new Object[] { pos.getBoardNum() }),</span>
                            //$NON-NLS-1$                            JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2578">                            Messages.getString(&quot;FiringDisplay.ChooseTargetDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L2580">                                    .getDisplayArray(targets), null);</span>
<span class="nc" id="L2581">            choice = SharedUtility.getTargetPicked(targets, input);</span>
        } // End have-choices

        // Return the chosen unit.
<span class="nc" id="L2585">        return choice;</span>

    } // End private Targetable chooseTarget( Coords )

    public Targetable getTarget() {
<span class="nc" id="L2590">        return target;</span>
    }
    
    private boolean validStrafingCoord(Coords newCoord) {
        // Only Aeros can strafe...
<span class="nc bnc" id="L2595" title="All 4 branches missed.">        if (ce() == null || !ce().isAero()) {</span>
<span class="nc" id="L2596">            return false;</span>
        }
        
        // Can't update strafe hexes after weapons are fired, otherwise we'd
        // have to have a way to update the attacks vector
<span class="nc bnc" id="L2601" title="All 2 branches missed.">        if (attacks.size() &gt; 0) {</span>
<span class="nc" id="L2602">            return false;</span>
        }
        
        // Can only strafe hexes that were flown over
<span class="nc bnc" id="L2606" title="All 2 branches missed.">        if (!ce().passedThrough(newCoord)) {</span>
<span class="nc" id="L2607">            return false;</span>
        }
        
        // No more limitations if it's the first hex
<span class="nc bnc" id="L2611" title="All 2 branches missed.">        if (strafingCoords.size() == 0) {</span>
<span class="nc" id="L2612">            return true;</span>
        }
        
        // We can only select at most 5 hexes
<span class="nc bnc" id="L2616" title="All 2 branches missed.">        if (strafingCoords.size() &gt;= 5) {</span>
<span class="nc" id="L2617">            return false;</span>
        }
        
        // Can't strafe the same hex twice
<span class="nc bnc" id="L2621" title="All 2 branches missed.">        if (strafingCoords.contains(newCoord)) {</span>
<span class="nc" id="L2622">            return false;</span>
        }
        
<span class="nc" id="L2625">        boolean isConsecutive = false;</span>
<span class="nc bnc" id="L2626" title="All 2 branches missed.">        for (Coords c : strafingCoords) {</span>
<span class="nc bnc" id="L2627" title="All 2 branches missed.">            isConsecutive |= (c.distance(newCoord) == 1);</span>
<span class="nc" id="L2628">        }</span>
        
<span class="nc" id="L2630">        boolean isInaLine = true;</span>
        // If there is only one other coord, then they're linear
<span class="nc bnc" id="L2632" title="All 2 branches missed.">        if (strafingCoords.size() &gt; 1) {</span>
<span class="nc" id="L2633">            IdealHex newHex = new IdealHex(newCoord);</span>
<span class="nc" id="L2634">            IdealHex start = new IdealHex(strafingCoords.get(0));</span>
            // Define the vector formed by the new coords and the first coords
<span class="nc bnc" id="L2636" title="All 2 branches missed.">            for (int i = 1; i &lt; strafingCoords.size(); i++) {</span>
<span class="nc" id="L2637">                IdealHex iHex = new IdealHex(strafingCoords.get(i));</span>
<span class="nc" id="L2638">                isInaLine &amp;= iHex.isIntersectedBy(start.cx, start.cy, newHex.cx,</span>
                        newHex.cy);
            }
        }
<span class="nc bnc" id="L2642" title="All 4 branches missed.">        return isConsecutive &amp;&amp; isInaLine;</span>
    }
    
    public void FieldofFire(Entity unit, int[][] ranges, int arc, int loc, int facing) {
        // do nothing here outside the movement phase
<span class="nc bnc" id="L2647" title="All 2 branches missed.">        if (!(clientgui.getClient().getGame().getPhase() == Phase.PHASE_FIRING)) return;</span>
        
<span class="nc" id="L2649">        clientgui.bv.fieldofFireUnit = unit;</span>
<span class="nc" id="L2650">        clientgui.bv.fieldofFireRanges = ranges;</span>
<span class="nc" id="L2651">        clientgui.bv.fieldofFireWpArc = arc;</span>
<span class="nc" id="L2652">        clientgui.bv.fieldofFireWpLoc = loc;</span>
        
<span class="nc" id="L2654">        clientgui.bv.setWeaponFieldofFire(facing, unit.getPosition());</span>
<span class="nc" id="L2655">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>