<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TargetingPhaseDisplay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">TargetingPhaseDisplay.java</span></div><h1>TargetingPhaseDisplay.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2004 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

package megamek.client.ui.swing;

import java.awt.event.ActionEvent;
import java.awt.event.InputEvent;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.KeyListener;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import java.util.Vector;

import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

import megamek.client.Client;
import megamek.client.event.BoardViewEvent;
import megamek.client.ui.Messages;
import megamek.client.ui.SharedUtility;
import megamek.client.ui.swing.util.CommandAction;
import megamek.client.ui.swing.util.KeyCommandBind;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.client.ui.swing.widget.MegamekButton;
import megamek.client.ui.swing.widget.SkinSpecification;
import megamek.common.*;
import megamek.common.actions.*;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GameTurnChangeEvent;
import megamek.common.IGame.Phase;
import megamek.common.options.OptionsConstants;
import megamek.common.util.FiringSolution;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.artillery.ArtilleryWeapon;
import megamek.common.weapons.bayweapons.TeleOperatedMissileBayWeapon;
import megamek.common.weapons.capitalweapons.CapitalMissileWeapon;

/*
 * Targeting Phase Display. Breaks naming convention because TargetingDisplay is too easy to confuse
 * with something else
 */

public class TargetingPhaseDisplay extends StatusBarPhaseDisplay implements
        KeyListener, ItemListener, ListSelectionListener {
    /**
     *
     */
    private static final long serialVersionUID = 3441669419807288865L;

    /**
     * This enumeration lists all of the possible ActionCommands that can be
     * carried out during the deploy minefield phase.  Each command has a string
     * for the command plus a flag that determines what unit type it is
     * appropriate for.
     *
     * @author arlith
     */
<span class="nc" id="L80">    public static enum TargetingCommand implements PhaseCommand {</span>
<span class="nc" id="L81">        FIRE_NEXT(&quot;fireNext&quot;),</span>
<span class="nc" id="L82">        FIRE_TWIST(&quot;fireTwist&quot;),</span>
<span class="nc" id="L83">        FIRE_FIRE(&quot;fireFire&quot;),</span>
<span class="nc" id="L84">        FIRE_SKIP(&quot;fireSkip&quot;),</span>
<span class="nc" id="L85">        FIRE_NEXT_TARG(&quot;fireNextTarg&quot;),</span>
<span class="nc" id="L86">        FIRE_MODE(&quot;fireMode&quot;),</span>
<span class="nc" id="L87">        FIRE_FLIP_ARMS(&quot;fireFlipArms&quot;),</span>
<span class="nc" id="L88">        FIRE_SEARCHLIGHT(&quot;fireSearchlight&quot;),</span>
<span class="nc" id="L89">        FIRE_CANCEL(&quot;fireCancel&quot;),</span>
<span class="nc" id="L90">        FIRE_DISENGAGE(&quot;fireDisengage&quot;);</span>

        String cmd;

        /**
         * Priority that determines this buttons order
         */
        public int priority;

<span class="nc" id="L99">        private TargetingCommand(String c) {</span>
<span class="nc" id="L100">            cmd = c;</span>
<span class="nc" id="L101">        }</span>

        public String getCmd() {
<span class="nc" id="L104">            return cmd;</span>
        }

        public int getPriority() {
<span class="nc" id="L108">            return priority;</span>
        }

        public void setPriority(int p) {
<span class="nc" id="L112">            priority = p;</span>
<span class="nc" id="L113">        }</span>

        public String toString() {
<span class="nc" id="L116">            return Messages.getString(&quot;TargetingPhaseDisplay.&quot; + getCmd());</span>
        }
    }

    // buttons
    protected Map&lt;TargetingCommand, MegamekButton&gt; buttons;

    // let's keep track of what we're shooting and at what, too
<span class="nc" id="L124">    private int cen = Entity.NONE; // current entity number</span>

    private Targetable target; // target

    // shots we have so far.
    private Vector&lt;EntityAction&gt; attacks;

    // is the shift key held?
    private boolean shiftheld;

    private boolean twisting;

    private final IGame.Phase phase;

    private Entity[] visibleTargets;

<span class="nc" id="L140">    private int lastTargetID = -1;</span>

    /**
     * Creates and lays out a new targeting phase display for the specified
     * clientgui.getClient().
     */
    public TargetingPhaseDisplay(final ClientGUI clientgui, boolean offboard) {
<span class="nc" id="L147">        super(clientgui);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        phase = offboard ? IGame.Phase.PHASE_OFFBOARD</span>
<span class="nc" id="L149">                : IGame.Phase.PHASE_TARGETING;</span>
<span class="nc" id="L150">        shiftheld = false;</span>

        // fire
<span class="nc" id="L153">        attacks = new Vector&lt;EntityAction&gt;();</span>

<span class="nc" id="L155">        setupStatusBar(Messages</span>
<span class="nc" id="L156">                .getString(&quot;TargetingPhaseDisplay.waitingForTargetingPhase&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L158">        buttons = new HashMap&lt;TargetingCommand, MegamekButton&gt;(</span>
<span class="nc" id="L159">                (int) (TargetingCommand.values().length * 1.25 + 0.5));</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        for (TargetingCommand cmd : TargetingCommand.values()) {</span>
<span class="nc" id="L161">            String title = Messages.getString(&quot;TargetingPhaseDisplay.&quot;</span>
<span class="nc" id="L162">                    + cmd.getCmd());</span>
<span class="nc" id="L163">            MegamekButton newButton = new MegamekButton(title,</span>
<span class="nc" id="L164">                    SkinSpecification.UIComponents.PhaseDisplayButton.getComp());</span>
<span class="nc" id="L165">            String ttKey = &quot;TargetingPhaseDisplay.&quot; + cmd.getCmd() + &quot;.tooltip&quot;;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (Messages.keyExists(ttKey)) {</span>
<span class="nc" id="L167">                newButton.setToolTipText(Messages.getString(ttKey));</span>
            }
<span class="nc" id="L169">            newButton.addActionListener(this);</span>
<span class="nc" id="L170">            newButton.setActionCommand(cmd.getCmd());</span>
<span class="nc" id="L171">            newButton.setEnabled(false);</span>
<span class="nc" id="L172">            buttons.put(cmd, newButton);</span>
        }
<span class="nc" id="L174">        numButtonGroups = (int) Math.ceil((buttons.size() + 0.0)</span>
                / buttonsPerGroup);

<span class="nc" id="L177">        butDone.setText(Messages.getString(&quot;TargetingPhaseDisplay.Done&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L178">        butDone.setEnabled(false);</span>

<span class="nc" id="L180">        layoutScreen();</span>

<span class="nc" id="L182">        setupButtonPanel();</span>
        
<span class="nc" id="L184">        MegaMekController controller = clientgui.controller;</span>
<span class="nc" id="L185">        final StatusBarPhaseDisplay display = this;</span>
        // Register the action for UNDO
<span class="nc" id="L187">        controller.registerCommandAction(KeyCommandBind.UNDO.cmd,</span>
<span class="nc" id="L188">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L192" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L196">                            return false;</span>
                        } else {
<span class="nc" id="L198">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L204">                        removeLastFiring();</span>
<span class="nc" id="L205">                    }</span>
                });
        // Register the action for TWIST_LEFT
<span class="nc" id="L208">        controller.registerCommandAction(KeyCommandBind.TWIST_LEFT.cmd,</span>
<span class="nc" id="L209">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L213" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L217">                            return false;</span>
                        } else {
<span class="nc" id="L219">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L225">                        updateFlipArms(false);</span>
<span class="nc" id="L226">                        torsoTwist(0);</span>
<span class="nc" id="L227">                    }</span>
                });

        // Register the action for TWIST_RIGHT
<span class="nc" id="L231">        controller.registerCommandAction(KeyCommandBind.TWIST_RIGHT.cmd,</span>
<span class="nc" id="L232">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L236" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L240">                            return false;</span>
                        } else {
<span class="nc" id="L242">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L248">                        updateFlipArms(false);</span>
<span class="nc" id="L249">                        torsoTwist(1);</span>
<span class="nc" id="L250">                    }</span>
                });
     // Register the action for FIRE
<span class="nc" id="L253">        controller.registerCommandAction(KeyCommandBind.FIRE.cmd,</span>
<span class="nc" id="L254">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L258" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc" id="L262">                                || !buttons.get(TargetingCommand.FIRE_FIRE)</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                                        .isEnabled()) {</span>
<span class="nc" id="L264">                            return false;</span>
                        } else {
<span class="nc" id="L266">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L272">                        fire();</span>
<span class="nc" id="L273">                    }</span>
                });

        // Register the action for NEXT_WEAPON
<span class="nc" id="L277">        controller.registerCommandAction(KeyCommandBind.NEXT_WEAPON.cmd,</span>
<span class="nc" id="L278">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L282" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L286">                            return false;</span>
                        } else {
<span class="nc" id="L288">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L294">                        nextWeapon();</span>
<span class="nc" id="L295">                    }</span>
                });

        // Register the action for PREV_WEAPON
<span class="nc" id="L299">        controller.registerCommandAction(KeyCommandBind.PREV_WEAPON.cmd,</span>
<span class="nc" id="L300">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L304" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L308">                            return false;</span>
                        } else {
<span class="nc" id="L310">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L316">                        prevWeapon();</span>
<span class="nc" id="L317">                    }</span>
                });

        // Register the action for NEXT_UNIT
<span class="nc" id="L321">        controller.registerCommandAction(KeyCommandBind.NEXT_UNIT.cmd,</span>
<span class="nc" id="L322">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L326" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L330">                            return false;</span>
                        } else {
<span class="nc" id="L332">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L338">                        selectEntity(clientgui.getClient()</span>
<span class="nc" id="L339">                                .getNextEntityNum(cen));</span>
<span class="nc" id="L340">                    }</span>
                });

        // Register the action for PREV_UNIT
<span class="nc" id="L344">        controller.registerCommandAction(KeyCommandBind.PREV_UNIT.cmd,</span>
<span class="nc" id="L345">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L349" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L353">                            return false;</span>
                        } else {
<span class="nc" id="L355">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L361">                        selectEntity(clientgui.getClient()</span>
<span class="nc" id="L362">                                .getPrevEntityNum(cen));</span>
<span class="nc" id="L363">                    }</span>
                });

        // Register the action for NEXT_TARGET
<span class="nc" id="L367">        controller.registerCommandAction(KeyCommandBind.NEXT_TARGET.cmd,</span>
<span class="nc" id="L368">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L372" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L376">                            return false;</span>
                        } else {
<span class="nc" id="L378">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L384">                        jumpToNextTarget();</span>
<span class="nc" id="L385">                    }</span>
                });

        // Register the action for PREV_TARGET
<span class="nc" id="L389">        controller.registerCommandAction(KeyCommandBind.PREV_TARGET.cmd,</span>
<span class="nc" id="L390">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L394" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L398">                            return false;</span>
                        } else {
<span class="nc" id="L400">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L406">                        jumpToPrevTarget();</span>
<span class="nc" id="L407">                    }</span>
                });

        // Register the action for NEXT_MODE
<span class="nc" id="L411">        controller.registerCommandAction(KeyCommandBind.NEXT_MODE.cmd,</span>
<span class="nc" id="L412">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L416" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L420">                            return false;</span>
                        } else {
<span class="nc" id="L422">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L428">                        changeMode(true);</span>
<span class="nc" id="L429">                    }</span>
                });

        // Register the action for PREV_MODE
<span class="nc" id="L433">        controller.registerCommandAction(KeyCommandBind.PREV_MODE.cmd,</span>
<span class="nc" id="L434">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L438" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L442">                            return false;</span>
                        } else {
<span class="nc" id="L444">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L450">                        changeMode(false);</span>
<span class="nc" id="L451">                    }</span>
                });

        // Register the action for CLEAR
<span class="nc" id="L455">        controller.registerCommandAction(KeyCommandBind.CANCEL.cmd,</span>
<span class="nc" id="L456">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L460" title="All 2 branches missed.">                        if (clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L463">                            return false;</span>
                        } else {
<span class="nc" id="L465">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L471">                        clear();</span>
<span class="nc" id="L472">                    }</span>
                });
        
<span class="nc" id="L475">    }</span>

    /**
     * Have the panel register itself as a listener wherever it's needed.
     * &lt;p/&gt;
     * According to
     * http://www-106.ibm.com/developerworks/java/library/j-jtp0618.html it is a
     * major bad no-no to perform these registrations before the constructor
     * finishes, so this function has to be called after the panel is created.
     * Please note, this restriction only applies to listeners for objects that
     * aren't on the panel itself.
     */
    public void initializeListeners() {

<span class="nc" id="L489">        clientgui.getClient().getGame().addGameListener(this);</span>
<span class="nc" id="L490">        clientgui.getBoardView().addBoardViewListener(this);</span>

<span class="nc" id="L492">        clientgui.bv.addKeyListener(this);</span>

        // mech display.
<span class="nc" id="L495">        clientgui.mechD.wPan.weaponList.addListSelectionListener(this);</span>
<span class="nc" id="L496">        clientgui.mechD.wPan.weaponList.addKeyListener(this);</span>
<span class="nc" id="L497">    }</span>

    protected ArrayList&lt;MegamekButton&gt; getButtonList() {
<span class="nc" id="L500">        ArrayList&lt;MegamekButton&gt; buttonList = new ArrayList&lt;MegamekButton&gt;();</span>
<span class="nc" id="L501">        TargetingCommand commands[] = TargetingCommand.values();</span>
<span class="nc" id="L502">        CommandComparator comparator = new CommandComparator();</span>
<span class="nc" id="L503">        Arrays.sort(commands, comparator);</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">        for (TargetingCommand cmd : commands) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">            if (cmd == TargetingCommand.FIRE_CANCEL) {</span>
<span class="nc" id="L506">                continue;</span>
            }
<span class="nc bnc" id="L508" title="All 6 branches missed.">            if ((cmd == TargetingCommand.FIRE_DISENGAGE) &amp;&amp; ((ce() == null) || !ce().isOffBoard())) {</span>
<span class="nc" id="L509">                continue;</span>
            }
<span class="nc" id="L511">            buttonList.add(buttons.get(cmd));</span>
        }
<span class="nc" id="L513">        return buttonList;</span>
    }

    /**
     * Selects an entity, by number, for targeting.
     */
    private void selectEntity(int en) {
        // clear any previously considered attacks
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (en != cen) {</span>
<span class="nc" id="L522">            clearAttacks();</span>
<span class="nc" id="L523">            refreshAll();</span>
        }
<span class="nc" id="L525">        Client client = clientgui.getClient();</span>
<span class="nc bnc" id="L526" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp;ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L527">            client.sendEntityWeaponOrderUpdate(ce());</span>
        }

<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (client.getGame().getEntity(en) != null) {</span>

<span class="nc" id="L532">            cen = en;</span>
<span class="nc" id="L533">            clientgui.setSelectedEntityNum(en);</span>

            // If the selected entity is not on the board, use the next one.
            // ASSUMPTION: there will always be *at least one* entity on map.
<span class="nc bnc" id="L537" title="All 2 branches missed.">            if (null == ce().getPosition()) {</span>

                // Walk through the list of entities for this player.
<span class="nc bnc" id="L540" title="All 2 branches missed.">                for (int nextId = client.getNextEntityNum(en); nextId != en; </span>
<span class="nc" id="L541">                        nextId = client.getNextEntityNum(nextId)) {</span>

<span class="nc" id="L543">                    if (null != clientgui.getClient().getGame()</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                            .getEntity(nextId).getPosition()) {</span>
<span class="nc" id="L545">                        cen = nextId;</span>
<span class="nc" id="L546">                        break;</span>
                    }

                } // Check the player's next entity.

                // We were *supposed* to have found an on-board entity.
<span class="nc bnc" id="L552" title="All 2 branches missed.">                if (null == ce().getPosition()) {</span>
<span class="nc" id="L553">                    System.err.println(&quot;FiringDisplay: could not find &quot; //$NON-NLS-1$</span>
                            + &quot;an on-board entity: &quot; + //$NON-NLS-1$
                            en);
<span class="nc" id="L556">                    return;</span>
                }

            } // End ce()-not-on-board

<span class="nc" id="L561">            target(null);</span>
<span class="nc" id="L562">            clientgui.getBoardView().highlight(ce().getPosition());</span>
<span class="nc" id="L563">            clientgui.getBoardView().select(null);</span>
<span class="nc" id="L564">            clientgui.getBoardView().cursor(null);</span>

<span class="nc" id="L566">            refreshAll();</span>
<span class="nc" id="L567">            cacheVisibleTargets();</span>

<span class="nc bnc" id="L569" title="All 4 branches missed.">            if (!clientgui.bv.isMovingUnits() &amp;&amp; !ce().isOffBoard()) {</span>
<span class="nc" id="L570">                clientgui.bv.centerOnHex(ce().getPosition());</span>
            }

            // Update the menu bar.
<span class="nc" id="L574">            clientgui.getMenuBar().setEntity(ce());</span>

            // 2003-12-29, nemchenk -- only twist if crew conscious
<span class="nc bnc" id="L577" title="All 2 branches missed.">            setTwistEnabled(ce().canChangeSecondaryFacing()</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                            &amp;&amp; ce().getCrew().isActive());</span>
<span class="nc" id="L579">            setFlipArmsEnabled(ce().canFlipArms());</span>
<span class="nc" id="L580">            updateSearchlight();</span>

<span class="nc" id="L582">            setFireModeEnabled(true);</span>

<span class="nc bnc" id="L584" title="All 2 branches missed.">            if (GUIPreferences.getInstance().getBoolean(&quot;FiringSolutions&quot;)</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">                    &amp;&amp; !ce().isOffBoard()) {</span>
<span class="nc" id="L586">                setFiringSolutions();</span>
            } else {
<span class="nc" id="L588">                clientgui.getBoardView().clearFiringSolutionData();</span>
            }
        } else {
<span class="nc" id="L591">            System.err.println(&quot;TargetingPhaseDisplay: &quot; //$NON-NLS-1$</span>
                    + &quot;tried to select non-existant entity: &quot; + en); //$NON-NLS-1$
        }
<span class="nc" id="L594">    }</span>

    public void setFiringSolutions() {
        // If no Entity is selected, exit
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (cen == Entity.NONE) {</span>
<span class="nc" id="L599">            return;</span>
        }

<span class="nc" id="L602">        IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L603">        IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (!GUIPreferences.getInstance().getFiringSolutions()) {</span>
<span class="nc" id="L605">            return;</span>
        }

        // Determine which entities are spotted
<span class="nc" id="L609">        Set&lt;Integer&gt; spottedEntities = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">            if (!target.isEnemyOf(ce()) &amp;&amp; target.isSpotting()) {</span>
<span class="nc" id="L612">                spottedEntities.add(target.getSpotTargetId());</span>
            }
<span class="nc" id="L614">        }</span>

        // Calculate firing solutions
<span class="nc" id="L617">        Map&lt;Integer, FiringSolution&gt; fs = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector()) {</span>
<span class="nc" id="L619">            boolean friendlyFire = game.getOptions().booleanOption(</span>
                    OptionsConstants.BASE_FRIENDLY_FIRE); //$NON-NLS-1$
<span class="nc" id="L621">            boolean enemyTarget = target.getOwner().isEnemyOf(ce().getOwner());</span>
<span class="nc bnc" id="L622" title="All 8 branches missed.">            if ((target.getId() != cen)</span>
                &amp;&amp; (friendlyFire || enemyTarget)
<span class="nc bnc" id="L624" title="All 2 branches missed.">                &amp;&amp; (!enemyTarget || target.hasSeenEntity(localPlayer)</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                    || target.hasDetectedEntity(localPlayer))</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                &amp;&amp; target.isTargetable()) {</span>
<span class="nc" id="L627">                ToHitData thd = WeaponAttackAction.toHit(game, cen, target);</span>
<span class="nc" id="L628">                thd.setLocation(target.getPosition());</span>
<span class="nc" id="L629">                thd.setRange(ce().getPosition().distance(target.getPosition()));</span>
<span class="nc" id="L630">                fs.put(target.getId(), new FiringSolution(thd, spottedEntities.contains(target.getId())));</span>
            }
<span class="nc" id="L632">        }</span>
<span class="nc" id="L633">        clientgui.getBoardView().setFiringSolutions(ce(), fs);</span>
<span class="nc" id="L634">    }</span>

    /**
     * Does turn start stuff
     */
    private void beginMyTurn() {
<span class="nc" id="L640">        target = null;</span>

<span class="nc bnc" id="L642" title="All 2 branches missed.">        if (!clientgui.bv.isMovingUnits()) {</span>
<span class="nc" id="L643">            clientgui.setDisplayVisible(true);</span>
        }
<span class="nc" id="L645">        clientgui.bv.clearFieldofF();</span>

<span class="nc" id="L647">        selectEntity(clientgui.getClient().getFirstEntityNum());</span>
<span class="nc bnc" id="L648" title="All 6 branches missed.">        setDisengageEnabled((ce() != null) &amp;&amp; attacks.isEmpty() &amp;&amp; ce().canFlee());</span>

<span class="nc" id="L650">        GameTurn turn = clientgui.getClient().getMyTurn();</span>
        // There's special processing for triggering AP Pods.
<span class="nc bnc" id="L652" title="All 4 branches missed.">        if ((turn instanceof GameTurn.TriggerAPPodTurn) &amp;&amp; (null != ce())) {</span>
<span class="nc" id="L653">            disableButtons();</span>
<span class="nc" id="L654">            TriggerAPPodDialog dialog = new TriggerAPPodDialog(</span>
<span class="nc" id="L655">                    clientgui.getFrame(), ce());</span>
<span class="nc" id="L656">            dialog.setVisible(true);</span>
<span class="nc" id="L657">            attacks.removeAllElements();</span>
<span class="nc" id="L658">            Enumeration&lt;TriggerAPPodAction&gt; actions = dialog.getActions();</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">            while (actions.hasMoreElements()) {</span>
<span class="nc" id="L660">                attacks.addElement(actions.nextElement());</span>
            }
<span class="nc" id="L662">            ready();</span>
<span class="nc bnc" id="L663" title="All 4 branches missed.">        } else if ((turn instanceof GameTurn.TriggerBPodTurn) &amp;&amp; (null != ce())) {</span>
<span class="nc" id="L664">            disableButtons();</span>
<span class="nc" id="L665">            TriggerBPodDialog dialog = new TriggerBPodDialog(clientgui, ce(),</span>
<span class="nc" id="L666">                    ((GameTurn.TriggerBPodTurn) turn).getAttackType());</span>
<span class="nc" id="L667">            dialog.setVisible(true);</span>
<span class="nc" id="L668">            attacks.removeAllElements();</span>
<span class="nc" id="L669">            Enumeration&lt;TriggerBPodAction&gt; actions = dialog.getActions();</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">            while (actions.hasMoreElements()) {</span>
<span class="nc" id="L671">                attacks.addElement(actions.nextElement());</span>
            }
<span class="nc" id="L673">            ready();</span>
<span class="nc" id="L674">        } else {</span>
<span class="nc" id="L675">            setNextEnabled(true);</span>
<span class="nc" id="L676">            butDone.setEnabled(true);</span>
<span class="nc" id="L677">            clientgui.getBoardView().select(null);</span>
        }
<span class="nc" id="L679">        setupButtonPanel();</span>
<span class="nc" id="L680">    }</span>

    /**
     * Does end turn stuff.
     */
    private void endMyTurn() {
        // end my turn, then.
<span class="nc" id="L687">        Entity next = clientgui.getClient().getGame()</span>
<span class="nc" id="L688">                .getNextEntity(clientgui.getClient().getGame().getTurnIndex());</span>
<span class="nc bnc" id="L689" title="All 4 branches missed.">        if ((phase == clientgui.getClient().getGame().getPhase())</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                &amp;&amp; (null != next) &amp;&amp; (null != ce())</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">                &amp;&amp; (next.getOwnerId() != ce().getOwnerId())) {</span>
<span class="nc" id="L692">            clientgui.setDisplayVisible(false);</span>
        }
<span class="nc" id="L694">        cen = Entity.NONE;</span>
<span class="nc" id="L695">        target(null);</span>
<span class="nc" id="L696">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L697">        clientgui.getBoardView().highlight(null);</span>
<span class="nc" id="L698">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L699">        clientgui.bv.clearFiringSolutionData();</span>
<span class="nc" id="L700">        clientgui.bv.clearMovementData();</span>
<span class="nc" id="L701">        clientgui.bv.clearFieldofF();</span>
<span class="nc" id="L702">        clientgui.setSelectedEntityNum(Entity.NONE);</span>
<span class="nc" id="L703">        disableButtons();</span>

<span class="nc" id="L705">    }</span>

    /**
     * Disables all buttons in the interface
     */
    private void disableButtons() {
<span class="nc" id="L711">        setFireEnabled(false);</span>
<span class="nc" id="L712">        setSkipEnabled(false);</span>
<span class="nc" id="L713">        setTwistEnabled(false);</span>
<span class="nc" id="L714">        setNextEnabled(false);</span>
<span class="nc" id="L715">        butDone.setEnabled(false);</span>
<span class="nc" id="L716">        setFlipArmsEnabled(false);</span>
<span class="nc" id="L717">        setFireModeEnabled(false);</span>
<span class="nc" id="L718">        setNextTargetEnabled(false);</span>
<span class="nc" id="L719">        setDisengageEnabled(false);</span>
<span class="nc" id="L720">    }</span>

    /**
     * Fire Mode - Adds a Fire Mode Change to the current Attack Action
     */
    private void changeMode(boolean forward) {
<span class="nc" id="L726">        int wn = clientgui.mechD.wPan.getSelectedWeaponNum();</span>

        // Do nothing we have no unit selected.
<span class="nc bnc" id="L729" title="All 2 branches missed.">        if (null == ce()) {</span>
<span class="nc" id="L730">            return;</span>
        }

        // If the weapon does not have modes, just exit.
<span class="nc" id="L734">        Mounted m = ce().getEquipment(wn);</span>
<span class="nc bnc" id="L735" title="All 4 branches missed.">        if ((m == null) || !m.getType().hasModes()) {</span>
<span class="nc" id="L736">            return;</span>
        }

        // Dropship Artillery cannot be switched to &quot;Direct&quot; Fire
<span class="nc" id="L740">        final WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L741" title="All 4 branches missed.">        if ((ce() instanceof Dropship) &amp;&amp; (wtype instanceof ArtilleryWeapon)) {</span>
<span class="nc" id="L742">            return;</span>
        }

        // send change to the server
<span class="nc" id="L746">        int nMode = m.switchMode(forward);</span>
<span class="nc" id="L747">        clientgui.getClient().sendModeChange(cen, wn, nMode);</span>

        // notify the player
<span class="nc bnc" id="L750" title="All 2 branches missed.">        if (m.canInstantSwitch(nMode)) {</span>
<span class="nc" id="L751">            clientgui.systemMessage(Messages.getString(</span>
<span class="nc" id="L752">                    &quot;FiringDisplay.switched&quot;, new Object[] { m.getName(),</span>
<span class="nc" id="L753">                            m.curMode().getDisplayableName() }));</span>
            //$NON-NLS-1$
        } else {
<span class="nc" id="L756">            clientgui.systemMessage(Messages.getString(</span>
<span class="nc" id="L757">                    &quot;FiringDisplay.willSwitch&quot;, new Object[] { m.getName(),</span>
<span class="nc" id="L758">                            m.pendingMode().getDisplayableName() })); //$NON-NLS-1$</span>
        }

<span class="nc" id="L761">        updateTarget();</span>
<span class="nc" id="L762">        clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L763">        clientgui.mechD.wPan.selectWeapon(wn);</span>
<span class="nc" id="L764">    }</span>

    /**
     * Called when the current entity is done firing. Send out our attack queue
     * to the server.
     */
    @Override
    public void ready() {
<span class="nc bnc" id="L772" title="All 2 branches missed.">        if (attacks.isEmpty()</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getNagForNoAction()) {</span>
            // comfirm this action
<span class="nc" id="L775">            String title = Messages</span>
<span class="nc" id="L776">                    .getString(&quot;TargetingPhaseDisplay.DontFireDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L777">            String body = Messages</span>
<span class="nc" id="L778">                    .getString(&quot;TargetingPhaseDisplay.DontFireDialog.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L779">            ConfirmDialog response = clientgui.doYesNoBotherDialog(title, body);</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">            if (!response.getShowAgain()) {</span>
<span class="nc" id="L781">                GUIPreferences.getInstance().setNagForNoAction(false);</span>
            }
<span class="nc bnc" id="L783" title="All 2 branches missed.">            if (!response.getAnswer()) {</span>
<span class="nc" id="L784">                return;</span>
            }
        }

        // stop further input (hopefully)
<span class="nc" id="L789">        disableButtons();</span>

        // remove temporary attacks from game &amp; board
<span class="nc" id="L792">        removeTempAttacks();</span>

        // send out attacks
<span class="nc" id="L795">        clientgui.getClient().sendAttackData(cen, attacks);</span>

        // clear queue
<span class="nc" id="L798">        attacks.removeAllElements();</span>

        // Clear the menu bar.
<span class="nc" id="L801">        clientgui.getMenuBar().setEntity(null);</span>
<span class="nc bnc" id="L802" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L803">            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</span>
        }
<span class="nc" id="L805">        endMyTurn();</span>
<span class="nc" id="L806">    }</span>

    private void doSearchlight() {
        // validate
<span class="nc bnc" id="L810" title="All 4 branches missed.">        if ((ce() == null) || (target == null)) {</span>
<span class="nc" id="L811">            throw new IllegalArgumentException(</span>
                    &quot;current searchlight parameters are invalid&quot;); //$NON-NLS-1$
        }

<span class="nc bnc" id="L815" title="All 2 branches missed.">        if (!SearchlightAttackAction.isPossible(clientgui.getClient().getGame(), cen, target, null)) {</span>
<span class="nc" id="L816">            return;</span>
        }

        // create and queue a searchlight action
<span class="nc" id="L820">        SearchlightAttackAction saa = new SearchlightAttackAction(cen, target</span>
<span class="nc" id="L821">                .getTargetType(), target.getTargetId());</span>
<span class="nc" id="L822">        attacks.addElement(saa);</span>

        // and add it into the game, temporarily
<span class="nc" id="L825">        clientgui.getClient().getGame().addAction(saa);</span>
<span class="nc" id="L826">        clientgui.bv.addAttack(saa);</span>
<span class="nc" id="L827">        clientgui.minimap.drawMap();</span>

        // refresh weapon panel, as bth will have changed
<span class="nc" id="L830">        updateTarget();</span>
<span class="nc" id="L831">    }</span>

    /**
     * Adds a weapon attack with the currently selected weapon to the attack
     * queue.
     */
    private void fire() {
        // get the selected weaponnum
<span class="nc" id="L839">        int weaponNum = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L840">        Mounted mounted = ce().getEquipment(weaponNum);</span>

        // validate
<span class="nc bnc" id="L843" title="All 6 branches missed.">        if ((ce() == null) || (target == null) || (mounted == null)</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                || !(mounted.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L845">            throw new IllegalArgumentException(</span>
                    &quot;current fire parameters are invalid&quot;); //$NON-NLS-1$
        }

        // declare searchlight, if possible
<span class="nc bnc" id="L850" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getAutoDeclareSearchlight()) {</span>
<span class="nc" id="L851">            doSearchlight();</span>
        }

<span class="nc" id="L854">        WeaponAttackAction waa = new WeaponAttackAction(cen,</span>
<span class="nc" id="L855">                target.getTargetType(), target.getTargetId(), weaponNum);</span>
<span class="nc" id="L856">        IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L857">        int distance = Compute.effectiveDistance(game, waa.getEntity(game),</span>
<span class="nc" id="L858">                waa.getTarget(game));</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">        if ((mounted.getType().hasFlag(WeaponType.F_ARTILLERY))</span>
<span class="nc bnc" id="L860" title="All 4 branches missed.">                || (mounted.isInBearingsOnlyMode()</span>
                            &amp;&amp; distance &gt;= RangeType.RANGE_BEARINGS_ONLY_MINIMUM)
<span class="nc bnc" id="L862" title="All 2 branches missed.">                || (mounted.getType() instanceof CapitalMissileWeapon</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">                                &amp;&amp; Compute.isGroundToGround(ce(), target))) {</span>
<span class="nc" id="L864">            waa = new ArtilleryAttackAction(cen, target.getTargetType(),</span>
<span class="nc" id="L865">                    target.getTargetId(), weaponNum, clientgui.getClient()</span>
<span class="nc" id="L866">                            .getGame());</span>
            // Get the launch velocity for bearings-only telemissiles
<span class="nc bnc" id="L868" title="All 2 branches missed.">            if (mounted.getType() instanceof TeleOperatedMissileBayWeapon) {                </span>
<span class="nc" id="L869">                TeleMissileSettingDialog tsd = new TeleMissileSettingDialog(clientgui.frame, clientgui.getClient().getGame());</span>
<span class="nc" id="L870">                tsd.setVisible(true);</span>
<span class="nc" id="L871">                waa.setLaunchVelocity(tsd.getSetting());</span>
<span class="nc" id="L872">                waa.updateTurnsTilHit(clientgui.getClient().getGame());</span>
            } 
        }
        
<span class="nc" id="L876">        updateDisplayForPendingAttack(mounted, waa);</span>
<span class="nc" id="L877">    }</span>
    
    /**
     * Worker function that handles setting associated ammo and other bookkeeping/UI updates
     * for a pending weapon attack action.
     */
    public void updateDisplayForPendingAttack(Mounted mounted, WeaponAttackAction waa) {
        // put this and the rest of the method into a separate function for access externally.
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if ((null != mounted.getLinked())</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">                &amp;&amp; (((WeaponType) mounted.getType()).getAmmoType() != AmmoType.T_NA)) {</span>
<span class="nc" id="L887">            Mounted ammoMount = mounted.getLinked();</span>
<span class="nc" id="L888">            waa.setAmmoId(ammoMount.getEntity().getEquipmentNum(ammoMount));</span>
<span class="nc" id="L889">            waa.setAmmoCarrier(ammoMount.getEntity().getId());</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">            if (((AmmoType) ammoMount.getType()).getMunitionType() == AmmoType.M_VIBRABOMB_IV) {</span>
<span class="nc" id="L891">                VibrabombSettingDialog vsd = new VibrabombSettingDialog(</span>
                        clientgui.frame);
<span class="nc" id="L893">                vsd.setVisible(true);</span>
<span class="nc" id="L894">                waa.setOtherAttackInfo(vsd.getSetting());</span>
            }
        }

        // add the attack to our temporary queue
<span class="nc" id="L899">        attacks.addElement(waa);</span>

        // and add it into the game, temporarily
<span class="nc" id="L902">        clientgui.getClient().getGame().addAction(waa);</span>
<span class="nc" id="L903">        clientgui.minimap.drawMap();</span>

        // set the weapon as used
<span class="nc" id="L906">        mounted.setUsedThisRound(true);</span>

        // find the next available weapon
<span class="nc" id="L909">        int nextWeapon = clientgui.mechD.wPan.selectNextWeapon();</span>

        // check; if there are no ready weapons, you're done.
<span class="nc bnc" id="L912" title="All 4 branches missed.">        if ((nextWeapon == -1) &amp;&amp; GUIPreferences.getInstance().getAutoEndFiring()) {</span>
<span class="nc" id="L913">            ready();</span>
<span class="nc" id="L914">            return;</span>
        }

        // otherwise, display firing info for the next weapon
<span class="nc" id="L918">        clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L919">        clientgui.mechD.wPan.selectWeapon(nextWeapon);</span>
<span class="nc" id="L920">        updateTarget();</span>
<span class="nc" id="L921">        setDisengageEnabled(false);</span>
<span class="nc" id="L922">    }</span>

    /**
     * Skips to the next weapon
     */
    private void nextWeapon() {
<span class="nc bnc" id="L928" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L929">            return;</span>
        }
<span class="nc" id="L931">        int weaponId = clientgui.mechD.wPan.selectNextWeapon();</span>

<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (ce().getId() != clientgui.mechD.wPan.getSelectedEntityId()) {</span>
<span class="nc" id="L934">            clientgui.mechD.wPan.displayMech(ce());</span>
        }
        
<span class="nc bnc" id="L937" title="All 2 branches missed.">        if (weaponId == -1) {</span>
<span class="nc" id="L938">            setFireModeEnabled(false);</span>
        } else {
<span class="nc" id="L940">            Mounted m = ce().getEquipment(weaponId);</span>
<span class="nc" id="L941">            setFireModeEnabled(m.isModeSwitchable());</span>
        }
<span class="nc" id="L943">        updateTarget();</span>
<span class="nc" id="L944">    }</span>
    
    /**
     * Skips to the previous weapon
     */
    void prevWeapon() {
<span class="nc bnc" id="L950" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L951">            return;</span>
        }
<span class="nc" id="L953">        int weaponId = clientgui.mechD.wPan.selectPrevWeapon();</span>

<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (ce().getId() != clientgui.mechD.wPan.getSelectedEntityId()) {</span>
<span class="nc" id="L956">            clientgui.mechD.wPan.displayMech(ce());</span>
        }

<span class="nc bnc" id="L959" title="All 2 branches missed.">        if (weaponId == -1) {</span>
<span class="nc" id="L960">            setFireModeEnabled(false);</span>
        } else {
<span class="nc" id="L962">            Mounted m = ce().getEquipment(weaponId);</span>
<span class="nc" id="L963">            setFireModeEnabled(m.isModeSwitchable());</span>
        }
<span class="nc" id="L965">        updateTarget();</span>
<span class="nc" id="L966">    }    </span>

    /**
     * Removes all current fire
     */
    private void clearAttacks() {
        // We may not have an entity selected yet (race condition).
<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L974">            return;</span>
        }

        // remove attacks, set weapons available again
<span class="nc" id="L978">        Enumeration&lt;EntityAction&gt; i = attacks.elements();</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">        while (i.hasMoreElements()) {</span>
<span class="nc" id="L980">            Object o = i.nextElement();</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">            if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L982">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L983">                ce().getEquipment(waa.getWeaponId()).setUsedThisRound(false);</span>
            }
<span class="nc" id="L985">        }</span>
<span class="nc" id="L986">        attacks.removeAllElements();</span>

        // remove temporary attacks from game &amp; board
<span class="nc" id="L989">        removeTempAttacks();</span>

        // restore any other movement to default
<span class="nc" id="L992">        ce().setSecondaryFacing(ce().getFacing());</span>
<span class="nc" id="L993">        ce().setArmsFlipped(false);</span>
<span class="nc bnc" id="L994" title="All 4 branches missed.">        setDisengageEnabled(ce().isOffBoard() &amp;&amp; ce().canFlee());</span>
<span class="nc" id="L995">    }</span>

    /**
     * Removes temp attacks from the game and board
     */
    private void removeTempAttacks() {
        // remove temporary attacks from game &amp; board
<span class="nc" id="L1002">        clientgui.getClient().getGame().removeActionsFor(cen);</span>
<span class="nc" id="L1003">        clientgui.bv.removeAttacksFor(ce());</span>

<span class="nc" id="L1005">    }</span>
    
    /**
     * removes the last action
     */
    private void removeLastFiring() {
<span class="nc bnc" id="L1011" title="All 2 branches missed.">        if (!attacks.isEmpty()) {</span>
<span class="nc" id="L1012">            Object o = attacks.lastElement();</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">            if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1014">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L1015">                ce().getEquipment(waa.getWeaponId()).setUsedThisRound(false);</span>
<span class="nc" id="L1016">                attacks.removeElement(o);</span>
<span class="nc bnc" id="L1017" title="All 6 branches missed.">                setDisengageEnabled(attacks.isEmpty() &amp;&amp; ce().isOffBoard() &amp;&amp; ce().canFlee());</span>
<span class="nc" id="L1018">                clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L1019">                clientgui.getClient().getGame().removeAction(o);</span>
<span class="nc" id="L1020">                clientgui.bv.refreshAttacks();</span>
<span class="nc" id="L1021">                clientgui.minimap.drawMap();</span>
            }
        }
<span class="nc" id="L1024">    }    </span>

    /**
     * Refeshes all displays.
     */
    private void refreshAll() {
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1031">            return;</span>
        }
<span class="nc" id="L1033">        clientgui.bv.redrawEntity(ce());</span>
<span class="nc" id="L1034">        clientgui.mechD.displayEntity(ce());</span>
<span class="nc" id="L1035">        clientgui.mechD.showPanel(&quot;weapons&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1036">        clientgui.mechD.wPan.selectFirstWeapon();</span>
<span class="nc" id="L1037">        updateTarget();</span>
<span class="nc" id="L1038">    }</span>

    /**
     * Targets something
     */
    void target(Targetable t) {
<span class="nc" id="L1044">        target = t;</span>
<span class="nc" id="L1045">        updateTarget();</span>

<span class="nc" id="L1047">    }</span>

    /**
     * Targets something
     */
    public void updateTarget() {
<span class="nc" id="L1053">        setFireEnabled(false);</span>

        // update target panel
<span class="nc" id="L1056">        final int weaponId = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc bnc" id="L1057" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (weaponId != -1)) {</span>
            ToHitData toHit;
<span class="nc" id="L1059">            Mounted m = ce().getEquipment(weaponId);</span>

<span class="nc" id="L1061">            int targetDistance = ce().getPosition().distance(target.getPosition()); </span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            boolean isArtilleryAttack = ((WeaponType) m.getType()).hasFlag(WeaponType.F_ARTILLERY)</span>
                    // For other weapons that can make artillery attacks
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                    || target.getTargetType() == Targetable.TYPE_HEX_ARTILLERY;            </span>
            
<span class="nc" id="L1066">            toHit = WeaponAttackAction.toHit(clientgui.getClient().getGame(),</span>
                    cen, target, weaponId, Entity.LOC_NONE, 0, false);
            
<span class="nc" id="L1069">            String flightTimeText = &quot;&quot;; </span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">            if(isArtilleryAttack) {</span>
<span class="nc" id="L1071">                ArtilleryAttackAction aaa = new ArtilleryAttackAction(ce().getId(), target.getTargetType(),</span>
<span class="nc" id="L1072">                        target.getTargetId(), weaponId, clientgui.getClient().getGame());</span>
<span class="nc" id="L1073">                flightTimeText = String.format(&quot;(%d turns)&quot;, aaa.getTurnsTilHit());</span>
            }
            
<span class="nc" id="L1076">            clientgui.mechD.wPan.wTargetR.setText(target.getDisplayName());</span>
<span class="nc" id="L1077">            clientgui.mechD.wPan.wRangeR</span>
<span class="nc" id="L1078">                    .setText(String.format(&quot;%d %s&quot;, targetDistance, flightTimeText)); //$NON-NLS-1$</span>
            
<span class="nc" id="L1080">            IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L1081">            int distance = Compute.effectiveDistance(game, ce(),</span>
                    target);
<span class="nc bnc" id="L1083" title="All 2 branches missed.">            if (m.isUsedThisRound()) {</span>
<span class="nc" id="L1084">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L1085">                        .getString(&quot;TargetingPhaseDisplay.alreadyFired&quot;));</span>
                //$NON-NLS-1$
<span class="nc" id="L1087">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1088" title="All 4 branches missed.">            } else if (m.isInBearingsOnlyMode() &amp;&amp; distance &lt; RangeType.RANGE_BEARINGS_ONLY_MINIMUM) {</span>
<span class="nc" id="L1089">                clientgui.mechD.wPan.wToHitR.setText(Messages.getString(&quot;TargetingPhaseDisplay.bearingsOnlyMinRange&quot;));</span>
<span class="nc" id="L1090">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1091" title="All 4 branches missed.">            } else if ((m.getType().hasFlag(WeaponType.F_AUTO_TARGET) &amp;&amp; !m.curMode().equals(Weapon.MODE_AMS_MANUAL))) {</span>
<span class="nc" id="L1092">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L1093">                        .getString(&quot;TargetingPhaseDisplay.autoFiringWeapon&quot;));</span>
                //$NON-NLS-1$
<span class="nc" id="L1095">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">            } else if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L1097">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString());</span>
<span class="nc" id="L1098">                setFireEnabled(false);</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">            } else if (toHit.getValue() == TargetRoll.AUTOMATIC_FAIL) {</span>
<span class="nc" id="L1100">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString());</span>
<span class="nc" id="L1101">                setFireEnabled(true);</span>
            } else {
<span class="nc" id="L1103">                clientgui.mechD.wPan.wToHitR</span>
<span class="nc" id="L1104">                        .setText(toHit.getValueAsString()</span>
                                + &quot; (&quot;
<span class="nc" id="L1106">                                + Compute.oddsAbove(</span>
<span class="nc" id="L1107">                                        toHit.getValue(),</span>
<span class="nc" id="L1108">                                        ce().hasAbility(OptionsConstants.PILOT_APTITUDE_GUNNERY))</span>
                                + &quot;%)&quot;); //$NON-NLS-1$ //$NON-NLS-2$
<span class="nc" id="L1110">                setFireEnabled(true);</span>
            }
<span class="nc" id="L1112">            clientgui.mechD.wPan.toHitText.setText(toHit.getDesc());</span>
<span class="nc" id="L1113">            setSkipEnabled(true);</span>
<span class="nc" id="L1114">        } else {</span>
<span class="nc" id="L1115">            clientgui.mechD.wPan.wTargetR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1116">            clientgui.mechD.wPan.wRangeR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1117">            clientgui.mechD.wPan.wToHitR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1118">            clientgui.mechD.wPan.toHitText.setText(&quot;&quot;); //$NON-NLS-1$</span>
        }
<span class="nc" id="L1120">        updateSearchlight();</span>
<span class="nc" id="L1121">    }</span>

    /**
     * Torso twist in the proper direction.
     */
    void torsoTwist(Coords cTarget) {
<span class="nc" id="L1127">        int direction = ce().getFacing();</span>

<span class="nc bnc" id="L1129" title="All 2 branches missed.">        if (null != cTarget) {</span>
<span class="nc" id="L1130">            direction = ce().clipSecondaryFacing(</span>
<span class="nc" id="L1131">                    ce().getPosition().direction(cTarget));</span>
        }

<span class="nc bnc" id="L1134" title="All 2 branches missed.">        if (direction != ce().getSecondaryFacing()) {</span>
<span class="nc" id="L1135">            clearAttacks();</span>
<span class="nc" id="L1136">            attacks.addElement(new TorsoTwistAction(cen, direction));</span>
<span class="nc" id="L1137">            ce().setSecondaryFacing(direction);</span>
<span class="nc" id="L1138">            refreshAll();</span>
        }
<span class="nc" id="L1140">    }</span>

    /**
     * Torso twist to the left or right
     *
     * @param twistDirection An &lt;code&gt;int&lt;/code&gt; specifying wether we're twisting left or
     *                       right, 0 if we're twisting to the left, 1 if to the right.
     */

    void torsoTwist(int twistDirection) {
<span class="nc" id="L1150">        int direction = ce().getSecondaryFacing();</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">        if (twistDirection == 0) {</span>
<span class="nc" id="L1152">            clearAttacks();</span>
<span class="nc" id="L1153">            direction = ce().clipSecondaryFacing((direction + 5) % 6);</span>
<span class="nc" id="L1154">            attacks.addElement(new TorsoTwistAction(cen, direction));</span>
<span class="nc" id="L1155">            ce().setSecondaryFacing(direction);</span>
<span class="nc" id="L1156">            refreshAll();</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">        } else if (twistDirection == 1) {</span>
<span class="nc" id="L1158">            clearAttacks();</span>
<span class="nc" id="L1159">            direction = ce().clipSecondaryFacing((direction + 7) % 6);</span>
<span class="nc" id="L1160">            attacks.addElement(new TorsoTwistAction(cen, direction));</span>
<span class="nc" id="L1161">            ce().setSecondaryFacing(direction);</span>
<span class="nc" id="L1162">            refreshAll();</span>
        }
<span class="nc" id="L1164">    }</span>

    /**
     * Cache the list of visible targets. This is used for the 'next target'
     * button.
     * &lt;p/&gt;
     * We'll sort it by range to us.
     */
    private void cacheVisibleTargets() {
<span class="nc" id="L1173">        clearVisibleTargets();</span>

<span class="nc" id="L1175">        List&lt;Entity&gt; vec = clientgui.getClient().getGame().getValidTargets(ce());</span>
<span class="nc" id="L1176">        Comparator&lt;Entity&gt; sortComp = new Comparator&lt;Entity&gt;() {</span>
            public int compare(Entity x, Entity y) {

<span class="nc" id="L1179">                int rangeToX = ce().getPosition().distance(x.getPosition());</span>
<span class="nc" id="L1180">                int rangeToY = ce().getPosition().distance(y.getPosition());</span>

<span class="nc bnc" id="L1182" title="All 2 branches missed.">                if (rangeToX == rangeToY) {</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">                    return x.getId() &lt; y.getId() ? -1 : 1;</span>
                }

<span class="nc bnc" id="L1186" title="All 2 branches missed.">                return rangeToX &lt; rangeToY ? -1 : 1;</span>
            }
        };

<span class="nc" id="L1190">        TreeSet&lt;Entity&gt; tree = new TreeSet&lt;Entity&gt;(sortComp);</span>
<span class="nc" id="L1191">        visibleTargets = new Entity[vec.size()];</span>

<span class="nc bnc" id="L1193" title="All 2 branches missed.">        for (int i = 0; i &lt; vec.size(); i++) {</span>
<span class="nc" id="L1194">            tree.add(vec.get(i));</span>
        }

<span class="nc" id="L1197">        Iterator&lt;Entity&gt; it = tree.iterator();</span>
<span class="nc" id="L1198">        int count = 0;</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L1200">            visibleTargets[count++] = it.next();</span>
        }

<span class="nc bnc" id="L1203" title="All 2 branches missed.">        setNextTargetEnabled(visibleTargets.length &gt; 0);</span>
<span class="nc" id="L1204">    }</span>

    private void clearVisibleTargets() {
<span class="nc" id="L1207">        visibleTargets = null;</span>
<span class="nc" id="L1208">        lastTargetID = -1;</span>
<span class="nc" id="L1209">        setNextTargetEnabled(false);</span>
<span class="nc" id="L1210">    }</span>

    /**
     * Get the next target. Return null if we don't have any targets.
     */
    private Entity getNextTarget() {
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        if (null == visibleTargets) {</span>
<span class="nc" id="L1217">            return null;</span>
        }

<span class="nc" id="L1220">        lastTargetID++;</span>

<span class="nc bnc" id="L1222" title="All 2 branches missed.">        if (lastTargetID &gt;= visibleTargets.length) {</span>
<span class="nc" id="L1223">            lastTargetID = 0;</span>
        }

<span class="nc" id="L1226">        return visibleTargets[lastTargetID];</span>
    }

    /**
     * Jump to our next target. If there isn't one, well, don't do anything.
     */
    private void jumpToNextTarget() {
<span class="nc" id="L1233">        Entity targ = getNextTarget();</span>

<span class="nc bnc" id="L1235" title="All 2 branches missed.">        if (null == targ) {</span>
<span class="nc" id="L1236">            return;</span>
        }

<span class="nc" id="L1239">        clientgui.bv.centerOnHex(targ.getPosition());</span>
<span class="nc" id="L1240">        clientgui.getBoardView().select(targ.getPosition());</span>

<span class="nc" id="L1242">        target(targ);</span>
<span class="nc" id="L1243">    }</span>
    
    /**
     * Get the next target. Return null if we don't have any targets.
     */
    private Entity getPrevTarget() {
<span class="nc bnc" id="L1249" title="All 2 branches missed.">        if (visibleTargets == null) {</span>
<span class="nc" id="L1250">            return null;</span>
        }

<span class="nc" id="L1253">        lastTargetID--;</span>

<span class="nc bnc" id="L1255" title="All 2 branches missed.">        if (lastTargetID &lt; 0) {</span>
<span class="nc" id="L1256">            lastTargetID = visibleTargets.length - 1;</span>
        }

<span class="nc" id="L1259">        return visibleTargets[lastTargetID];</span>
    }
    
    /**
     * Jump to our next target. If there isn't one, well, don't do anything.
     */
    private void jumpToPrevTarget() {
<span class="nc" id="L1266">        Entity targ = getPrevTarget();</span>

<span class="nc bnc" id="L1268" title="All 2 branches missed.">        if (targ == null) {</span>
<span class="nc" id="L1269">            return;</span>
        }

<span class="nc" id="L1272">        clientgui.bv.centerOnHex(targ.getPosition());</span>
<span class="nc" id="L1273">        clientgui.getBoardView().select(targ.getPosition());</span>

<span class="nc" id="L1275">        target(targ);</span>
<span class="nc" id="L1276">    }    </span>

    /**
     * Returns the current entity.
     */
    Entity ce() {
<span class="nc" id="L1282">        return clientgui.getClient().getGame().getEntity(cen);</span>
    }

    //
    // BoardListener
    //
    @Override
    public void hexMoused(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L1292" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1293">            return;</span>
        }

        // ignore buttons other than 1
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.BUTTON1_MASK) == 0)) {</span>
<span class="nc" id="L1299">            return;</span>
        }
        // control pressed means a line of sight check.
        // added ALT_MASK by kenn
<span class="nc bnc" id="L1303" title="All 2 branches missed.">        if (((b.getModifiers() &amp; InputEvent.CTRL_MASK) != 0)</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.ALT_MASK) != 0)) {</span>
<span class="nc" id="L1305">            return;</span>
        }
        // check for shifty goodness
<span class="nc bnc" id="L1308" title="All 4 branches missed.">        if (shiftheld != ((b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0)) {</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">            shiftheld = (b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0;</span>
        }

<span class="nc bnc" id="L1312" title="All 2 branches missed.">        if (b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) {</span>
<span class="nc bnc" id="L1313" title="All 4 branches missed.">            if (shiftheld || twisting) {</span>
<span class="nc" id="L1314">                updateFlipArms(false);</span>
<span class="nc" id="L1315">                torsoTwist(b.getCoords());</span>
            }
<span class="nc" id="L1317">            clientgui.getBoardView().cursor(b.getCoords());</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">        } else if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</span>
<span class="nc" id="L1319">            twisting = false;</span>
<span class="nc" id="L1320">            clientgui.getBoardView().select(b.getCoords());</span>
        }
<span class="nc" id="L1322">    }</span>

    @Override
    public void hexSelected(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L1328" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1329">            return;</span>
        }
<span class="nc" id="L1331">        final Client client = clientgui.getClient();</span>

<span class="nc bnc" id="L1333" title="All 4 branches missed.">        if (client.isMyTurn() &amp;&amp; (b.getCoords() != null)</span>
<span class="nc bnc" id="L1334" title="All 4 branches missed.">                &amp;&amp; (ce() != null) &amp;&amp; !b.getCoords().equals(ce().getPosition())) {</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">            if (shiftheld) {</span>
<span class="nc" id="L1336">                updateFlipArms(false);</span>
<span class="nc" id="L1337">                torsoTwist(b.getCoords());</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">            } else if (phase == IGame.Phase.PHASE_TARGETING) {</span>
<span class="nc" id="L1339">                target(new HexTarget(b.getCoords(), ce().getGame().getBoard(),</span>
                        Targetable.TYPE_HEX_ARTILLERY));
            } else {
<span class="nc" id="L1342">                target(chooseTarget(b.getCoords()));</span>
            }
        }
<span class="nc" id="L1345">    }</span>

    /**
     * Have the player select a target from the entities at the given coords.
     *
     * @param pos - the &lt;code&gt;Coords&lt;/code&gt; containing targets.
     */
    private Targetable chooseTarget(Coords pos) {

<span class="nc" id="L1354">        boolean friendlyFire = clientgui.getClient().getGame().getOptions()</span>
<span class="nc" id="L1355">                .booleanOption(OptionsConstants.BASE_FRIENDLY_FIRE); //$NON-NLS-1$</span>
        // Assume that we have *no* choice.
<span class="nc" id="L1357">        Targetable choice = null;</span>
        Iterator&lt;Entity&gt; choices;

        // Get the available choices, depending on friendly fire
<span class="nc bnc" id="L1361" title="All 2 branches missed.">        if (friendlyFire) {</span>
<span class="nc" id="L1362">            choices = clientgui.getClient().getGame().getEntities(pos);</span>
        } else {
<span class="nc" id="L1364">            choices = clientgui.getClient().getGame()</span>
<span class="nc" id="L1365">                    .getEnemyEntities(pos, ce());</span>
        }

        // Convert the choices into a List of targets.
<span class="nc" id="L1369">        List&lt;Targetable&gt; targets = new ArrayList&lt;Targetable&gt;();</span>
<span class="nc" id="L1370">        final IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">        while (choices.hasNext()) {</span>
<span class="nc" id="L1372">            Targetable t = choices.next();</span>
<span class="nc" id="L1373">            boolean isSensorReturn = false;</span>
<span class="nc" id="L1374">            boolean isVisible = true;</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">            if (t instanceof Entity) {</span>
<span class="nc" id="L1376">                isSensorReturn = ((Entity) t).isSensorReturn(localPlayer);</span>
<span class="nc" id="L1377">                isVisible = ((Entity) t).hasSeenEntity(localPlayer);</span>
            }
<span class="nc bnc" id="L1379" title="All 6 branches missed.">            if (!ce().equals(t) &amp;&amp; !isSensorReturn &amp;&amp; isVisible) {</span>
<span class="nc" id="L1380">                targets.add(t);</span>
            }
<span class="nc" id="L1382">        }</span>

        // Is there a building in the hex?
<span class="nc" id="L1385">        Building bldg = clientgui.getClient().getGame().getBoard()</span>
<span class="nc" id="L1386">                .getBuildingAt(pos);</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">        if (bldg != null) {</span>
<span class="nc" id="L1388">            targets.add(new BuildingTarget(pos, clientgui.getClient().getGame()</span>
<span class="nc" id="L1389">                    .getBoard(), Targetable.TYPE_BLDG_TAG));</span>
        }

<span class="nc" id="L1392">        targets.add(new HexTarget(pos, clientgui.getClient().getGame()</span>
<span class="nc" id="L1393">                .getBoard(), Targetable.TYPE_HEX_TAG));</span>

        // Do we have a single choice?
<span class="nc bnc" id="L1396" title="All 2 branches missed.">        if (targets.size() == 1) {</span>
            // Return that choice.
<span class="nc" id="L1398">            choice = targets.get(0);</span>
        }

        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L1402" title="All 2 branches missed.">        else if (targets.size() &gt; 1) {</span>
<span class="nc" id="L1403">            String input = (String) JOptionPane</span>
<span class="nc" id="L1404">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L1406">                            Messages.getString(</span>
                                    &quot;FiringDisplay.ChooseTargetDialog.message&quot;, //$NON-NLS-1$ 
<span class="nc" id="L1408">                                    new Object[] { pos.getBoardNum() }),</span>
<span class="nc" id="L1409">                            Messages.getString(&quot;FiringDisplay.ChooseTargetDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L1411">                                    .getDisplayArray(targets), null);</span>
<span class="nc" id="L1412">            choice = SharedUtility.getTargetPicked(targets, input);</span>
        } // End have-choices

        // Return the chosen unit.
<span class="nc" id="L1416">        return choice;</span>

    } // End private Targetable chooseTarget( Coords )

    //
    // GameListener
    //
    @Override
    public void gameTurnChange(GameTurnChangeEvent e) {

        // In case of a /reset command, ensure the state gets reset
<span class="nc bnc" id="L1427" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1428">            endMyTurn();</span>
        }
        // On simultaneous phases, each player ending their turn will generalte a turn change
        // We want to ignore turns from other players and only listen to events we generated
        // Except on the first turn
<span class="nc bnc" id="L1433" title="All 2 branches missed.">        if (clientgui.getClient().getGame().isPhaseSimultaneous()</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">                &amp;&amp; (e.getPreviousPlayerId() != clientgui.getClient().getLocalPlayerNumber())</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">                &amp;&amp; (clientgui.getClient().getGame().getTurnIndex() != 0)) {</span>
<span class="nc" id="L1436">            return;</span>
        }

        // Are we ignoring events?
<span class="nc bnc" id="L1440" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1441">            return;</span>
        }

<span class="nc bnc" id="L1444" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() == phase) {</span>

<span class="nc bnc" id="L1446" title="All 2 branches missed.">            if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">                if (cen == Entity.NONE) {</span>
<span class="nc" id="L1448">                    beginMyTurn();</span>
                }
<span class="nc" id="L1450">                setStatusBarText(Messages</span>
<span class="nc" id="L1451">                        .getString(&quot;TargetingPhaseDisplay.its_your_turn&quot;)); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L1453">                endMyTurn();</span>
<span class="nc bnc" id="L1454" title="All 2 branches missed.">                if (e.getPlayer() != null) {</span>
<span class="nc" id="L1455">                    setStatusBarText(Messages.getString(</span>
                            &quot;TargetingPhaseDisplay.its_others_turn&quot;, //$NON-NLS-1$
<span class="nc" id="L1457">                            new Object[] { e.getPlayer().getName() }));</span>
                }

            }
        }
<span class="nc" id="L1462">    }</span>

    @Override
    public void gamePhaseChange(GamePhaseChangeEvent e) {

        // Are we ignoring events?
<span class="nc bnc" id="L1468" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1469">            return;</span>
        }

<span class="nc bnc" id="L1472" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">                &amp;&amp; (clientgui.getClient().getGame().getPhase() != phase)) {</span>
<span class="nc" id="L1474">            endMyTurn();</span>
        }
        // if we're ending the firing phase, unregister stuff.
<span class="nc bnc" id="L1477" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() == phase) {</span>
<span class="nc" id="L1478">            setStatusBarText(Messages</span>
<span class="nc" id="L1479">                    .getString(&quot;TargetingPhaseDisplay.waitingForFiringPhase&quot;)); //$NON-NLS-1$</span>
        }
<span class="nc" id="L1481">    }</span>

    //
    // ActionListener
    //
    public void actionPerformed(ActionEvent ev) {

        // Are we ignoring events?
<span class="nc bnc" id="L1489" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1490">            return;</span>
        }

<span class="nc bnc" id="L1493" title="All 2 branches missed.">        if (statusBarActionPerformed(ev, clientgui.getClient())) {</span>
<span class="nc" id="L1494">            return;</span>
        }

<span class="nc bnc" id="L1497" title="All 2 branches missed.">        if (!clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L1498">            return;</span>
        }

<span class="nc bnc" id="L1501" title="All 2 branches missed.">        if (ev.getActionCommand().equals(TargetingCommand.FIRE_FIRE.getCmd())) {</span>
<span class="nc" id="L1502">            fire();</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_SKIP.getCmd())) {</span>
<span class="nc" id="L1504">            nextWeapon();</span>
<span class="nc bnc" id="L1505" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_TWIST.getCmd())) {</span>
<span class="nc" id="L1506">            twisting = true;</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_NEXT.getCmd())) {</span>
<span class="nc" id="L1508">            selectEntity(clientgui.getClient().getNextEntityNum(cen));</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_NEXT_TARG.getCmd())) {</span>
<span class="nc" id="L1510">            jumpToNextTarget();</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_FLIP_ARMS.getCmd())) {</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">            updateFlipArms(!ce().getArmsFlipped());</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_MODE.getCmd())) {</span>
<span class="nc" id="L1514">            changeMode(true);</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_CANCEL.getCmd())) {</span>
<span class="nc" id="L1516">            clear();</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_SEARCHLIGHT.getCmd())) {</span>
<span class="nc" id="L1518">            doSearchlight();</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(TargetingCommand.FIRE_DISENGAGE.getCmd())</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">                &amp;&amp; clientgui.doYesNoDialog(Messages.getString(&quot;MovementDisplay.EscapeDialog.title&quot;),</span>
<span class="nc" id="L1521">                        Messages.getString(&quot;MovementDisplay.EscapeDialog.message&quot;))) {</span>
<span class="nc" id="L1522">            clear();</span>
<span class="nc" id="L1523">            attacks.add(new DisengageAction(cen));</span>
<span class="nc" id="L1524">            ready();</span>
        }
<span class="nc" id="L1526">    }</span>

    private void updateFlipArms(boolean armsFlipped) {
<span class="nc bnc" id="L1529" title="All 2 branches missed.">        if (armsFlipped == ce().getArmsFlipped()) {</span>
<span class="nc" id="L1530">            return;</span>
        }

<span class="nc" id="L1533">        twisting = false;</span>

<span class="nc" id="L1535">        torsoTwist(null);</span>

<span class="nc" id="L1537">        clearAttacks();</span>
<span class="nc" id="L1538">        ce().setArmsFlipped(armsFlipped);</span>
<span class="nc" id="L1539">        attacks.addElement(new FlipArmsAction(cen, armsFlipped));</span>
<span class="nc" id="L1540">        updateTarget();</span>
<span class="nc" id="L1541">        refreshAll();</span>
<span class="nc" id="L1542">    }</span>

    private void updateSearchlight() {
<span class="nc bnc" id="L1545" title="All 4 branches missed.">        setSearchlightEnabled((ce() != null)</span>
                &amp;&amp; (target != null)
<span class="nc bnc" id="L1547" title="All 2 branches missed.">                &amp;&amp; ce().isUsingSpotlight()</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">                &amp;&amp; ce().getCrew().isActive()</span>
<span class="nc bnc" id="L1549" title="All 2 branches missed.">                &amp;&amp; SearchlightAttackAction.isPossible(clientgui.getClient()</span>
<span class="nc" id="L1550">                        .getGame(), cen, target, null));</span>
<span class="nc" id="L1551">    }</span>

    private void setFireEnabled(boolean enabled) {
<span class="nc" id="L1554">        buttons.get(TargetingCommand.FIRE_FIRE).setEnabled(enabled);</span>
<span class="nc" id="L1555">        clientgui.getMenuBar().setFireFireEnabled(enabled);</span>
<span class="nc" id="L1556">    }</span>

    private void setTwistEnabled(boolean enabled) {
<span class="nc" id="L1559">        buttons.get(TargetingCommand.FIRE_TWIST).setEnabled(enabled);</span>
<span class="nc" id="L1560">        clientgui.getMenuBar().setFireTwistEnabled(enabled);</span>
<span class="nc" id="L1561">    }</span>

    private void setSkipEnabled(boolean enabled) {
<span class="nc" id="L1564">        buttons.get(TargetingCommand.FIRE_SKIP).setEnabled(enabled);</span>
<span class="nc" id="L1565">        clientgui.getMenuBar().setFireSkipEnabled(enabled);</span>
<span class="nc" id="L1566">    }</span>

    private void setFlipArmsEnabled(boolean enabled) {
<span class="nc" id="L1569">        buttons.get(TargetingCommand.FIRE_FLIP_ARMS).setEnabled(enabled);</span>
<span class="nc" id="L1570">        clientgui.getMenuBar().setFireFlipArmsEnabled(enabled);</span>
<span class="nc" id="L1571">    }</span>

    private void setNextEnabled(boolean enabled) {
<span class="nc" id="L1574">        buttons.get(TargetingCommand.FIRE_NEXT).setEnabled(enabled);</span>
<span class="nc" id="L1575">        clientgui.getMenuBar().setFireNextEnabled(enabled);</span>
<span class="nc" id="L1576">    }</span>

    private void setSearchlightEnabled(boolean enabled) {
<span class="nc" id="L1579">        buttons.get(TargetingCommand.FIRE_SEARCHLIGHT).setEnabled(enabled);</span>
<span class="nc" id="L1580">        clientgui.getMenuBar().setFireSearchlightEnabled(enabled);</span>
<span class="nc" id="L1581">    }</span>

    private void setFireModeEnabled(boolean enabled) {
<span class="nc" id="L1584">        buttons.get(TargetingCommand.FIRE_MODE).setEnabled(enabled);</span>
<span class="nc" id="L1585">        clientgui.getMenuBar().setFireModeEnabled(enabled);</span>
<span class="nc" id="L1586">    }</span>

    private void setNextTargetEnabled(boolean enabled) {
<span class="nc" id="L1589">        buttons.get(TargetingCommand.FIRE_NEXT_TARG).setEnabled(enabled);</span>
<span class="nc" id="L1590">        clientgui.getMenuBar().setFireNextTargetEnabled(enabled);</span>
<span class="nc" id="L1591">    }</span>

    private void setDisengageEnabled(boolean enabled) {
<span class="nc bnc" id="L1594" title="All 2 branches missed.">        if (buttons.containsKey(TargetingCommand.FIRE_DISENGAGE)) {</span>
<span class="nc" id="L1595">            buttons.get(TargetingCommand.FIRE_DISENGAGE).setEnabled(enabled);</span>
        }
<span class="nc" id="L1597">    }</span>

    @Override
    public void clear() {
<span class="nc" id="L1601">        clearAttacks();</span>
<span class="nc" id="L1602">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L1603">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L1604">        refreshAll();</span>
<span class="nc" id="L1605">    }</span>

    //
    // ItemListener
    //
    public void itemStateChanged(ItemEvent ev) {

        // Are we ignoring events?
<span class="nc bnc" id="L1613" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1614">            return;</span>
        }

<span class="nc" id="L1617">    }</span>

    // board view listener
    @Override
    public void finishedMovingUnits(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L1624" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1625">            return;</span>
        }

<span class="nc bnc" id="L1628" title="All 4 branches missed.">        if (clientgui.getClient().isMyTurn() &amp;&amp; (ce() != null)) {</span>
<span class="nc" id="L1629">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L1630">            clientgui.bv.centerOnHex(ce().getPosition());</span>
        }
<span class="nc" id="L1632">    }</span>

    @Override
    public void unitSelected(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L1638" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1639">            return;</span>
        }

<span class="nc" id="L1642">        Entity e = clientgui.getClient().getGame().getEntity(b.getEntityId());</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L1644">            if (clientgui.getClient().getMyTurn()</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">                    .isValidEntity(e, clientgui.getClient().getGame())) {</span>
<span class="nc" id="L1646">                selectEntity(e.getId());</span>
            }
        } else {
<span class="nc" id="L1649">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L1650">            clientgui.mechD.displayEntity(e);</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">            if (e.isDeployed()) {</span>
<span class="nc" id="L1652">                clientgui.bv.centerOnHex(e.getPosition());</span>
            }
        }
<span class="nc" id="L1655">    }</span>

    /**
     * Stop just ignoring events and actually stop listening to them.
     */
    public void removeAllListeners() {
<span class="nc" id="L1661">        clientgui.getClient().getGame().removeGameListener(this);</span>
<span class="nc" id="L1662">        clientgui.getBoardView().removeBoardViewListener(this);</span>
<span class="nc" id="L1663">        clientgui.mechD.wPan.weaponList.removeListSelectionListener(this);</span>
<span class="nc" id="L1664">    }</span>

    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L1667" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L1668">            return;</span>
        }
<span class="nc bnc" id="L1670" title="All 2 branches missed.">        if (event.getSource().equals(clientgui.mechD.wPan.weaponList)) {</span>
            // update target data in weapon display
<span class="nc" id="L1672">            updateTarget();</span>
        }
<span class="nc" id="L1674">    }</span>
    
    public void FieldofFire(Entity unit, int[][] ranges, int arc, int loc, int facing) {
        // do nothing here outside the arty targeting phase
<span class="nc bnc" id="L1678" title="All 2 branches missed.">        if (!(clientgui.getClient().getGame().getPhase() == Phase.PHASE_TARGETING)) return;</span>
        
<span class="nc" id="L1680">        clientgui.bv.fieldofFireUnit = unit;</span>
<span class="nc" id="L1681">        clientgui.bv.fieldofFireRanges = ranges;</span>
<span class="nc" id="L1682">        clientgui.bv.fieldofFireWpArc = arc;</span>
<span class="nc" id="L1683">        clientgui.bv.fieldofFireWpLoc = loc;</span>
        
<span class="nc" id="L1685">        clientgui.bv.setWeaponFieldofFire(facing, unit.getPosition());</span>
<span class="nc" id="L1686">    }</span>
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>