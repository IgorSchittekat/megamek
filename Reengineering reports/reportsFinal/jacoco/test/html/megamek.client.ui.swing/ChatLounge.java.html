<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChatLounge.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">ChatLounge.java</span></div><h1>ChatLounge.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005,2006 Ben Mazur (bmazur@sev.org)
 * Copyright Â© 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 * for more details.
 */
package megamek.client.ui.swing;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Image;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TreeSet;
import java.util.Vector;

import javax.swing.*;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.MouseInputAdapter;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;

import megamek.MegaMek;
import megamek.client.Client;
import megamek.client.generator.RandomGenderGenerator;
import megamek.client.generator.RandomNameGenerator;
import megamek.client.bot.BotClient;
import megamek.client.bot.princess.Princess;
import megamek.client.bot.ui.swing.BotGUI;
import megamek.client.generator.RandomCallsignGenerator;
import megamek.client.ui.Messages;
import megamek.client.ui.swing.boardview.BoardView1;
import megamek.client.ui.swing.dialog.imageChooser.CamoChooserDialog;
import megamek.client.ui.swing.util.MenuScroller;
import megamek.client.ui.swing.widget.SkinSpecification;
import megamek.common.*;
import megamek.common.enums.Gender;
import megamek.common.event.GameCFREvent;
import megamek.common.event.GameEntityNewEvent;
import megamek.common.event.GameEntityRemoveEvent;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GamePlayerChangeEvent;
import megamek.common.event.GameSettingsChangeEvent;
import megamek.common.icons.Camouflage;
import megamek.common.icons.Portrait;
import megamek.common.options.GameOptions;
import megamek.common.options.IOption;
import megamek.common.options.IOptionGroup;
import megamek.common.options.OptionsConstants;
import megamek.common.options.PilotOptions;
import megamek.common.options.Quirks;
import megamek.common.util.BoardUtilities;
import megamek.common.util.fileUtils.MegaMekFile;

public class ChatLounge extends AbstractPhaseDisplay implements ActionListener, ItemListener,
        ListSelectionListener, MouseListener, IMapSettingsObserver {
    private static final long serialVersionUID = 1454736776730903786L;

    private JButton butOptions;
    private JLabel lblMapSummary;
    private JLabel lblGameYear;
    private JLabel lblTechLevel;

    private JTabbedPane panTabs;
    private JPanel panMain;
    private JPanel panMap;

    /* Unit Configuration Panel */
    private JPanel panUnitInfo;
    JButton butLoad;
    JButton butArmy;
    JButton butSkills;
    JButton butNames;
    private JButton butLoadList;
    private JButton butSaveList;
    private JButton butDeleteAll;

    /* Unit Table */
    JTable tableEntities;
    private JScrollPane scrEntities;
    private JToggleButton butCompact;

    private MekTableModel mekModel;

    /* Player Configuration Panel */
    private JPanel panPlayerInfo;
    private JComboBox&lt;String&gt; choTeam;
    private JButton butCamo;
    private JButton butAddBot;
    private JButton butRemoveBot;
    private JButton butChangeStart;
    private JTable tablePlayers;
    private JScrollPane scrPlayers;
    private PlayerTableModel playerModel;

    /* Map Settings Panel */
    private MapSettings mapSettings;
    private JButton butConditions;
    private JPanel panGroundMap;
    private JPanel panSpaceMap;
    private JComboBox&lt;String&gt; comboMapType;
    @SuppressWarnings(&quot;rawtypes&quot;)
    private JComboBox&lt;Comparable&gt; comboMapSizes;
    private JButton butMapSize;
    private JButton butRandomMap;
    private JButton buttonBoardPreview;
    private JScrollPane scrMapButtons;
    private JPanel panMapButtons;
    private JLabel labBoardsSelected;
    private JList&lt;String&gt; lisBoardsSelected;
    private JScrollPane scrBoardsSelected;
    private JButton butChange;
    private JLabel labBoardsAvailable;
    private JList&lt;String&gt; lisBoardsAvailable;
    private JScrollPane scrBoardsAvailable;
    private JCheckBox chkRotateBoard;
    private JCheckBox chkIncludeGround;
    private JCheckBox chkIncludeSpace;
    private JButton butSpaceSize;
<span class="nc" id="L158">    private Set&lt;BoardDimensions&gt; mapSizes = new TreeSet&lt;&gt;();</span>

<span class="nc" id="L160">    boolean resetAvailBoardSelection = false;</span>
<span class="nc" id="L161">    boolean resetSelectedBoards = true;</span>

    JPanel mapPreviewPanel;
<span class="nc" id="L164">    MiniMap miniMap = null;</span>
    ClientDialog boardPreviewW;
<span class="nc" id="L166">    private Game boardPreviewGame = new Game();</span>

<span class="nc" id="L168">    private String cmdSelectedTab = null;</span>

<span class="nc" id="L170">    private MechSummaryCache.Listener mechSummaryCacheListener = new MechSummaryCache.Listener() {</span>
        @Override
        public void doneLoading() {
<span class="nc" id="L173">            butLoad.setEnabled(true);</span>
<span class="nc" id="L174">            butArmy.setEnabled(true);</span>
<span class="nc" id="L175">            butLoadList.setEnabled(true);</span>
<span class="nc" id="L176">        }</span>
    };

    //endregion Action Commands

    /**
     * Creates a new chat lounge for the clientgui.getClient().
     */
    public ChatLounge(ClientGUI clientgui) {
<span class="nc" id="L185">        super(clientgui, SkinSpecification.UIComponents.ChatLounge.getComp(),</span>
<span class="nc" id="L186">                SkinSpecification.UIComponents.ChatLoungeDoneButton.getComp());</span>

        // Create a tabbed panel to hold our components.
<span class="nc" id="L189">        panTabs = new JTabbedPane();</span>
<span class="nc" id="L190">        Font tabPanelFont = new Font(&quot;Dialog&quot;, Font.BOLD, //$NON-NLS-1$</span>
<span class="nc" id="L191">                GUIPreferences.getInstance().getInt(&quot;AdvancedChatLoungeTabFontSize&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L192">        panTabs.setFont(tabPanelFont);</span>

<span class="nc" id="L194">        clientgui.getClient().getGame().addGameListener(this);</span>
<span class="nc" id="L195">        clientgui.getBoardView().addBoardViewListener(this);</span>

<span class="nc" id="L197">        butOptions = new JButton(Messages.getString(&quot;ChatLounge.butOptions&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L198">        butOptions.addActionListener(this);</span>

<span class="nc" id="L200">        lblMapSummary = new JLabel(&quot;&quot;);</span>
<span class="nc" id="L201">        lblGameYear = new JLabel(&quot;&quot;);</span>
<span class="nc" id="L202">        lblGameYear.setToolTipText(Messages.getString(&quot;ChatLounge.GameYearLabelToolTip&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L204">        lblTechLevel = new JLabel(&quot;&quot;);</span>
<span class="nc" id="L205">        lblTechLevel.setToolTipText(Messages.getString(&quot;ChatLounge.TechLevelLabelToolTip&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L207">        butCompact = new JToggleButton(Messages.getString(&quot;ChatLounge.butCompact&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L208">        butCompact.addActionListener(this);</span>

<span class="nc" id="L210">        butDone.setText(Messages.getString(&quot;ChatLounge.butDone&quot;));</span>
<span class="nc" id="L211">        Font font = null;</span>
        try {
<span class="nc" id="L213">            font = new Font(&quot;sanserif&quot;, Font.BOLD, 12);</span>
<span class="nc" id="L214">        } catch (Exception exp) {</span>
<span class="nc" id="L215">            MegaMek.getLogger().error(exp);</span>
<span class="nc" id="L216">        }</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (font == null) {</span>
<span class="nc" id="L218">            MegaMek.getLogger().error(&quot;Couldn't find the new font for the 'Done' button.&quot;);</span>
        } else {
<span class="nc" id="L220">            butDone.setFont(font);</span>
        }

<span class="nc" id="L223">        setupPlayerInfo();</span>

<span class="nc" id="L225">        refreshGameSettings();</span>

<span class="nc" id="L227">        setupEntities();</span>
<span class="nc" id="L228">        setupUnitConfiguration();</span>

<span class="nc" id="L230">        refreshEntities();</span>

<span class="nc" id="L232">        setupMainPanel();</span>

        // layout main thing
<span class="nc" id="L235">        setLayout(new BorderLayout());</span>

<span class="nc" id="L237">        refreshMapSummaryLabel();</span>
<span class="nc" id="L238">        refreshGameYearLabel();</span>
<span class="nc" id="L239">        refreshTechLevelLabel();</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getChatLoungeTabs()) {</span>
<span class="nc" id="L242">            add(panTabs, BorderLayout.CENTER);</span>
        } else {
<span class="nc" id="L244">            add(panMain, BorderLayout.CENTER);</span>
        }
<span class="nc" id="L246">    }</span>

    public PlayerTableModel getPlayerModel() {
<span class="nc" id="L249">        return playerModel;</span>
    }

    public JTable getTablePlayers() {
<span class="nc" id="L253">        return tablePlayers;</span>
    }

    public JToggleButton getButCompact() {
<span class="nc" id="L257">        return butCompact;</span>
    }

    public JTable getTableEntities() {
<span class="nc" id="L261">        return tableEntities;</span>
    }

    public MekTableModel getMekModel() {
<span class="nc" id="L265">        return mekModel;</span>
    }

    /**
     * Sets up the entities table
     */
    private void setupEntities() {
<span class="nc" id="L272">        mekModel = new MekTableModel(this);</span>
<span class="nc" id="L273">        tableEntities = new JTable();</span>
<span class="nc" id="L274">        tableEntities.setModel(mekModel);</span>
<span class="nc" id="L275">        tableEntities.setRowHeight(80);</span>
<span class="nc" id="L276">        tableEntities.setIntercellSpacing(new Dimension(0, 0));</span>
<span class="nc" id="L277">        tableEntities.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);</span>
<span class="nc" id="L278">        TableColumn column = null;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        for (int i = 0; i &lt; MekTableModel.N_COL; i++) {</span>
<span class="nc" id="L280">            tableEntities.getColumnModel().getColumn(i).setCellRenderer(new MekTableModelRenderer(this));</span>
<span class="nc" id="L281">            column = tableEntities.getColumnModel().getColumn(i);</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">            if ((i == MekTableModel.COL_UNIT) || (i == MekTableModel.COL_PILOT)) {</span>
<span class="nc" id="L283">                column.setPreferredWidth(170);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            } else if (i == MekTableModel.COL_PLAYER) {</span>
<span class="nc" id="L285">                column.setPreferredWidth(50);</span>
            } else {
<span class="nc" id="L287">                column.setPreferredWidth(10);</span>
            }
        }
<span class="nc" id="L290">        tableEntities.addMouseListener(new MekTableMouseAdapter(this));</span>
<span class="nc" id="L291">        tableEntities.addKeyListener(new MekTableKeyAdapter(this));</span>
<span class="nc" id="L292">        tableEntities.getSelectionModel().addListSelectionListener(this);</span>
<span class="nc" id="L293">        scrEntities = new JScrollPane(tableEntities);</span>
<span class="nc" id="L294">        scrEntities.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);</span>

<span class="nc" id="L296">    }</span>

    /**
     * Sets up the unit configuration panel
     */
    private void setupUnitConfiguration() {
<span class="nc" id="L302">        butLoadList = new JButton(Messages.getString(&quot;ChatLounge.butLoadList&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L303">        butLoadList.setActionCommand(&quot;load_list&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L304">        butLoadList.addActionListener(this);</span>

<span class="nc" id="L306">        butSaveList = new JButton(Messages.getString(&quot;ChatLounge.butSaveList&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L307">        butSaveList.setActionCommand(&quot;save_list&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L308">        butSaveList.addActionListener(this);</span>
<span class="nc" id="L309">        butSaveList.setEnabled(false);</span>

<span class="nc" id="L311">        butLoad = new JButton(Messages.getString(&quot;ChatLounge.butLoad&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L312">        butArmy = new JButton(Messages.getString(&quot;ChatLounge.butArmy&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L313">        butSkills = new JButton(Messages.getString(&quot;ChatLounge.butSkills&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L314">        butNames = new JButton(Messages.getString(&quot;ChatLounge.butNames&quot;)); //$NON-NLS-1$</span>

        // Initialize the RandomNameGenerator and RandomCallsignGenerator
<span class="nc" id="L317">        RandomNameGenerator.getInstance();</span>
<span class="nc" id="L318">        RandomCallsignGenerator.getInstance();</span>

<span class="nc" id="L320">        MechSummaryCache mechSummaryCache = MechSummaryCache.getInstance();</span>
<span class="nc" id="L321">        mechSummaryCache.addListener(mechSummaryCacheListener);</span>
<span class="nc" id="L322">        boolean mscLoaded = mechSummaryCache.isInitialized();</span>
<span class="nc" id="L323">        butLoad.setEnabled(mscLoaded);</span>
<span class="nc" id="L324">        butArmy.setEnabled(mscLoaded);</span>
<span class="nc" id="L325">        butLoadList.setEnabled(mscLoaded);</span>
<span class="nc" id="L326">        butSkills.setEnabled(true);</span>
<span class="nc" id="L327">        butNames.setEnabled(true);</span>

<span class="nc" id="L329">        Font font = new Font(&quot;Sans Serif&quot;, Font.BOLD, 18); //$NON-NLS-1$</span>
<span class="nc" id="L330">        butLoad.setFont(font);</span>
<span class="nc" id="L331">        butLoad.setActionCommand(&quot;load_mech&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L332">        butLoad.addActionListener(this);</span>
<span class="nc" id="L333">        butArmy.addActionListener(this);</span>
<span class="nc" id="L334">        butSkills.addActionListener(this);</span>
<span class="nc" id="L335">        butNames.addActionListener(this);</span>

<span class="nc" id="L337">        butDeleteAll = new JButton(Messages.getString(&quot;ChatLounge.butDeleteAll&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L338">        butDeleteAll.setActionCommand(&quot;delete_all&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L339">        butDeleteAll.addActionListener(this);</span>
<span class="nc" id="L340">        butDeleteAll.setEnabled(false);</span>

<span class="nc" id="L342">        panUnitInfo = new JPanel();</span>
<span class="nc" id="L343">        panUnitInfo.setBorder(BorderFactory.createTitledBorder(&quot;Unit Setup&quot;));</span>

        // layout
<span class="nc" id="L346">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L347">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L348">        panUnitInfo.setLayout(gridbag);</span>

<span class="nc" id="L350">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L351">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L352">        c.gridx = 0;</span>
<span class="nc" id="L353">        c.gridy = 0;</span>
<span class="nc" id="L354">        c.weightx = 1.0;</span>
<span class="nc" id="L355">        c.weighty = 0.0;</span>
<span class="nc" id="L356">        c.gridwidth = 2;</span>
<span class="nc" id="L357">        c.gridheight = 1;</span>
<span class="nc" id="L358">        gridbag.setConstraints(butLoad, c);</span>
<span class="nc" id="L359">        panUnitInfo.add(butLoad);</span>

<span class="nc" id="L361">        c.gridx = 0;</span>
<span class="nc" id="L362">        c.gridy = 1;</span>
<span class="nc" id="L363">        c.gridwidth = 1;</span>
<span class="nc" id="L364">        c.gridheight = 1;</span>
<span class="nc" id="L365">        gridbag.setConstraints(butArmy, c);</span>
<span class="nc" id="L366">        panUnitInfo.add(butArmy);</span>

<span class="nc" id="L368">        c.gridx = 0;</span>
<span class="nc" id="L369">        c.gridy = 2;</span>
<span class="nc" id="L370">        gridbag.setConstraints(butSkills, c);</span>
<span class="nc" id="L371">        panUnitInfo.add(butSkills);</span>

<span class="nc" id="L373">        c.gridx = 0;</span>
<span class="nc" id="L374">        c.gridy = 3;</span>
<span class="nc" id="L375">        gridbag.setConstraints(butNames, c);</span>
<span class="nc" id="L376">        panUnitInfo.add(butNames);</span>

<span class="nc" id="L378">        c.gridx = 1;</span>
<span class="nc" id="L379">        c.gridy = 1;</span>
<span class="nc" id="L380">        gridbag.setConstraints(butLoadList, c);</span>
<span class="nc" id="L381">        panUnitInfo.add(butLoadList);</span>

<span class="nc" id="L383">        c.gridx = 1;</span>
<span class="nc" id="L384">        c.gridy = 2;</span>
<span class="nc" id="L385">        gridbag.setConstraints(butSaveList, c);</span>
<span class="nc" id="L386">        panUnitInfo.add(butSaveList);</span>

<span class="nc" id="L388">        c.gridx = 1;</span>
<span class="nc" id="L389">        c.gridy = 3;</span>
<span class="nc" id="L390">        gridbag.setConstraints(butDeleteAll, c);</span>
<span class="nc" id="L391">        panUnitInfo.add(butDeleteAll);</span>
<span class="nc" id="L392">    }</span>

    /**
     * Sets up the player info (team, camo) panel
     */
    private void setupPlayerInfo() {

<span class="nc" id="L399">        playerModel = new PlayerTableModel(this);</span>
<span class="nc" id="L400">        tablePlayers = playerModel.createPlayersTable();</span>
<span class="nc" id="L401">        tablePlayers.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L402">        tablePlayers.getSelectionModel().addListSelectionListener(this);</span>

<span class="nc" id="L404">        tablePlayers.setModel(playerModel);</span>
<span class="nc" id="L405">        playerModel.setupColumnWidths(tablePlayers);</span>

<span class="nc" id="L407">        tablePlayers.addMouseListener(new PlayerTableMouseAdapter(this));</span>

<span class="nc" id="L409">        scrPlayers = new JScrollPane(tablePlayers);</span>
<span class="nc" id="L410">        scrPlayers.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);</span>

<span class="nc" id="L412">        panPlayerInfo = new JPanel();</span>
<span class="nc" id="L413">        panPlayerInfo.setBorder(BorderFactory.createTitledBorder(&quot;Player Setup&quot;));</span>

<span class="nc" id="L415">        butAddBot = new JButton(Messages.getString(&quot;ChatLounge.butAddBot&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L416">        butAddBot.setActionCommand(&quot;add_bot&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L417">        butAddBot.addActionListener(this);</span>

<span class="nc" id="L419">        butRemoveBot = new JButton(Messages.getString(&quot;ChatLounge.butRemoveBot&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L420">        butRemoveBot.setEnabled(false);</span>
<span class="nc" id="L421">        butRemoveBot.setActionCommand(&quot;remove_bot&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L422">        butRemoveBot.addActionListener(this);</span>

<span class="nc" id="L424">        choTeam = new JComboBox&lt;String&gt;();</span>
<span class="nc" id="L425">        setupTeams();</span>
<span class="nc" id="L426">        choTeam.addItemListener(this);</span>

<span class="nc" id="L428">        butCamo = new JButton();</span>
<span class="nc" id="L429">        butCamo.setPreferredSize(new Dimension(84, 72));</span>
<span class="nc" id="L430">        butCamo.setActionCommand(&quot;camo&quot;);</span>
<span class="nc" id="L431">        butCamo.addActionListener(e -&gt; {</span>
            // Show the CamoChooserDialog for the selected player
<span class="nc" id="L433">            IPlayer player = getPlayerSelected().getLocalPlayer();</span>
<span class="nc" id="L434">            CamoChooserDialog ccd = new CamoChooserDialog(clientgui.getFrame(), player.getCamouflage());</span>

            // If the dialog was canceled or nothing selected, do nothing
<span class="nc bnc" id="L437" title="All 4 branches missed.">            if ((ccd.showDialog() == JOptionPane.CANCEL_OPTION) || (ccd.getSelectedItem() == null)) {</span>
<span class="nc" id="L438">                return;</span>
            }

            // Update the player from the camo selection
<span class="nc" id="L442">            player.setCamouflage(ccd.getSelectedItem());</span>
<span class="nc" id="L443">            butCamo.setIcon(player.getCamouflage().getImageIcon());</span>
<span class="nc" id="L444">            getPlayerSelected().sendPlayerInfo();</span>
<span class="nc" id="L445">        });</span>
<span class="nc" id="L446">        refreshCamos();</span>

<span class="nc" id="L448">        butChangeStart = new JButton(Messages.getString(&quot;ChatLounge.butChangeStart&quot;));</span>
<span class="nc" id="L449">        butChangeStart.addActionListener(this);</span>

        // layout
<span class="nc" id="L452">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L453">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L454">        panPlayerInfo.setLayout(gridbag);</span>

<span class="nc" id="L456">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L457">        c.insets = new Insets(1, 1, 1, 1);</span>

<span class="nc" id="L459">        c.gridx = 0;</span>
<span class="nc" id="L460">        c.gridy = 0;</span>
<span class="nc" id="L461">        c.gridwidth = 1;</span>
<span class="nc" id="L462">        c.gridheight = 1;</span>
<span class="nc" id="L463">        c.weightx = 1.0;</span>
<span class="nc" id="L464">        c.weighty = 0.0;</span>
<span class="nc" id="L465">        gridbag.setConstraints(choTeam, c);</span>
<span class="nc" id="L466">        panPlayerInfo.add(choTeam);</span>

<span class="nc" id="L468">        c.gridx = 0;</span>
<span class="nc" id="L469">        c.gridy = 1;</span>
<span class="nc" id="L470">        c.gridwidth = 1;</span>
<span class="nc" id="L471">        c.gridheight = 1;</span>
<span class="nc" id="L472">        c.weightx = 1.0;</span>
<span class="nc" id="L473">        c.weighty = 0.0;</span>
<span class="nc" id="L474">        gridbag.setConstraints(butChangeStart, c);</span>
<span class="nc" id="L475">        panPlayerInfo.add(butChangeStart);</span>

<span class="nc" id="L477">        c.gridx = 0;</span>
<span class="nc" id="L478">        c.gridy = 2;</span>
<span class="nc" id="L479">        c.gridwidth = 1;</span>
<span class="nc" id="L480">        c.gridheight = 1;</span>
<span class="nc" id="L481">        c.weightx = 1.0;</span>
<span class="nc" id="L482">        c.weighty = 0.0;</span>
<span class="nc" id="L483">        gridbag.setConstraints(butAddBot, c);</span>
<span class="nc" id="L484">        panPlayerInfo.add(butAddBot);</span>

<span class="nc" id="L486">        c.gridx = 0;</span>
<span class="nc" id="L487">        c.gridy = 3;</span>
<span class="nc" id="L488">        c.gridwidth = 1;</span>
<span class="nc" id="L489">        c.gridheight = 1;</span>
<span class="nc" id="L490">        c.weightx = 1.0;</span>
<span class="nc" id="L491">        c.weighty = 0.0;</span>
<span class="nc" id="L492">        gridbag.setConstraints(butRemoveBot, c);</span>
<span class="nc" id="L493">        panPlayerInfo.add(butRemoveBot);</span>

<span class="nc" id="L495">        c.gridx = 1;</span>
<span class="nc" id="L496">        c.gridy = 0;</span>
<span class="nc" id="L497">        c.gridwidth = 1;</span>
<span class="nc" id="L498">        c.gridheight = 4;</span>
<span class="nc" id="L499">        c.weightx = 1.0;</span>
<span class="nc" id="L500">        c.weighty = 1.0;</span>
<span class="nc" id="L501">        gridbag.setConstraints(butCamo, c);</span>
<span class="nc" id="L502">        panPlayerInfo.add(butCamo);</span>

<span class="nc" id="L504">        refreshPlayerInfo();</span>
<span class="nc" id="L505">    }</span>

    private void setupMainPanel() {
<span class="nc" id="L508">        setupMap();</span>

<span class="nc" id="L510">        panMain = new JPanel();</span>

        // layout
<span class="nc" id="L513">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L514">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L515">        panMain.setLayout(gridbag);</span>

<span class="nc" id="L517">        c.fill = GridBagConstraints.VERTICAL;</span>
<span class="nc" id="L518">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L519">        c.gridx = 0;</span>
<span class="nc" id="L520">        c.gridy = 0;</span>
<span class="nc" id="L521">        c.weightx = 0.0;</span>
<span class="nc" id="L522">        c.weighty = 0.0;</span>
<span class="nc" id="L523">        c.gridwidth = 1;</span>
<span class="nc" id="L524">        gridbag.setConstraints(butOptions, c);</span>
<span class="nc" id="L525">        panMain.add(butOptions);</span>

<span class="nc" id="L527">        JPanel panel1 = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L528">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L529">        c.gridx = 0;</span>
<span class="nc" id="L530">        c.gridy = 0;</span>
<span class="nc" id="L531">        c.weightx = 1;</span>
<span class="nc" id="L532">        c.weighty = 0.0;</span>
<span class="nc" id="L533">        c.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L534">        panel1.add(lblMapSummary, c);</span>
<span class="nc" id="L535">        c.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L536">        c.gridx = 1;</span>
<span class="nc" id="L537">        c.weightx = 0;</span>
<span class="nc" id="L538">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L539">        c.insets = new Insets(0, 0, 0, 20);</span>
<span class="nc" id="L540">        panel1.add(lblGameYear, c);</span>
<span class="nc" id="L541">        c.gridx = 2;</span>
<span class="nc" id="L542">        panel1.add(lblTechLevel, c);</span>
<span class="nc" id="L543">        c.insets = new Insets(0, 0, 0, 0);</span>
<span class="nc" id="L544">        c.fill = GridBagConstraints.VERTICAL;</span>
<span class="nc" id="L545">        c.gridx = 3;</span>
<span class="nc" id="L546">        c.gridy = 0;</span>
<span class="nc" id="L547">        c.weightx = 0;</span>
<span class="nc" id="L548">        c.weighty = 0.0;</span>
<span class="nc" id="L549">        c.anchor = GridBagConstraints.NORTHEAST;</span>
<span class="nc" id="L550">        panel1.add(butCompact, c);</span>

<span class="nc" id="L552">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L553">        c.gridx = 1;</span>
<span class="nc" id="L554">        c.gridy = 0;</span>
<span class="nc" id="L555">        c.weightx = 0.0;</span>
<span class="nc" id="L556">        c.weighty = 0.0;</span>
<span class="nc" id="L557">        c.gridwidth = 1;</span>
<span class="nc" id="L558">        c.anchor = GridBagConstraints.NORTHEAST;</span>
<span class="nc" id="L559">        panMain.add(panel1, c);</span>

<span class="nc" id="L561">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L562">        c.gridx = 1;</span>
<span class="nc" id="L563">        c.gridy = 1;</span>
<span class="nc" id="L564">        c.weightx = 1.0;</span>
<span class="nc" id="L565">        c.weighty = 1.0;</span>
<span class="nc" id="L566">        c.gridwidth = 1;</span>
<span class="nc" id="L567">        c.gridheight = 3;</span>
<span class="nc" id="L568">        gridbag.setConstraints(scrEntities, c);</span>
<span class="nc" id="L569">        panMain.add(scrEntities);</span>

<span class="nc" id="L571">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L572">        c.gridx = 0;</span>
<span class="nc" id="L573">        c.gridy = 1;</span>
<span class="nc" id="L574">        c.weightx = 0.0;</span>
<span class="nc" id="L575">        c.weighty = 0.0;</span>
<span class="nc" id="L576">        c.gridwidth = 1;</span>
<span class="nc" id="L577">        c.gridheight = 1;</span>
<span class="nc" id="L578">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L579">        gridbag.setConstraints(panUnitInfo, c);</span>
<span class="nc" id="L580">        panMain.add(panUnitInfo);</span>

<span class="nc" id="L582">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L583">        c.gridx = 0;</span>
<span class="nc" id="L584">        c.gridy = 2;</span>
<span class="nc" id="L585">        c.weightx = 0.0;</span>
<span class="nc" id="L586">        c.weighty = 0.0;</span>
<span class="nc" id="L587">        c.gridwidth = 1;</span>
<span class="nc" id="L588">        c.gridheight = 1;</span>
<span class="nc" id="L589">        gridbag.setConstraints(panPlayerInfo, c);</span>
<span class="nc" id="L590">        panMain.add(panPlayerInfo);</span>

<span class="nc" id="L592">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L593">        c.gridx = 0;</span>
<span class="nc" id="L594">        c.gridy = 3;</span>
<span class="nc" id="L595">        c.weightx = 0.0;</span>
<span class="nc" id="L596">        c.weighty = 1.0;</span>
<span class="nc" id="L597">        c.gridwidth = 1;</span>
<span class="nc" id="L598">        c.gridheight = 1;</span>
<span class="nc" id="L599">        gridbag.setConstraints(scrPlayers, c);</span>
<span class="nc" id="L600">        panMain.add(scrPlayers);</span>

<span class="nc" id="L602">        panTabs.add(&quot;Select Units&quot;, panMain); //$NON-NLS-1$</span>
<span class="nc" id="L603">        panTabs.add(&quot;Select Map&quot;, panMap); //$NON-NLS-1$</span>
<span class="nc" id="L604">    }</span>

    private void setupMap() {

<span class="nc" id="L608">        panMap = new JPanel();</span>

<span class="nc" id="L610">        mapSettings = MapSettings.getInstance(clientgui.getClient().getMapSettings());</span>

<span class="nc" id="L612">        butConditions = new JButton(Messages.getString(&quot;ChatLounge.butConditions&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L613">        butConditions.addActionListener(this);</span>

<span class="nc" id="L615">        butRandomMap = new JButton(Messages.getString(&quot;BoardSelectionDialog.GeneratedMapSettings&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L616">        butRandomMap.addActionListener(this);</span>

<span class="nc" id="L618">        chkIncludeGround = new JCheckBox(Messages.getString(&quot;ChatLounge.IncludeGround&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L619">        chkIncludeGround.addActionListener(this);</span>

<span class="nc" id="L621">        chkIncludeSpace = new JCheckBox(Messages.getString(&quot;ChatLounge.IncludeSpace&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L622">        chkIncludeSpace.addActionListener(this);</span>

<span class="nc" id="L624">        setupGroundMap();</span>
<span class="nc" id="L625">        setupSpaceMap();</span>
<span class="nc" id="L626">        refreshSpaceGround();</span>

<span class="nc" id="L628">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L629">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L630">        panMap.setLayout(gridbag);</span>

<span class="nc" id="L632">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L633">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L634">        c.weightx = 0.0;</span>
<span class="nc" id="L635">        c.weighty = 0.0;</span>
<span class="nc" id="L636">        c.gridx = 0;</span>
<span class="nc" id="L637">        c.gridy = 0;</span>
<span class="nc" id="L638">        c.gridwidth = 1;</span>
<span class="nc" id="L639">        c.gridheight = 1;</span>
<span class="nc" id="L640">        c.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L641">        gridbag.setConstraints(butConditions, c);</span>
<span class="nc" id="L642">        panMap.add(butConditions);</span>

<span class="nc" id="L644">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L645">        c.weightx = 0.0;</span>
<span class="nc" id="L646">        c.weighty = 0.0;</span>
<span class="nc" id="L647">        c.gridx = 1;</span>
<span class="nc" id="L648">        c.gridy = 0;</span>
<span class="nc" id="L649">        c.gridwidth = 1;</span>
<span class="nc" id="L650">        c.gridheight = 1;</span>
<span class="nc" id="L651">        c.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L652">        gridbag.setConstraints(butRandomMap, c);</span>
<span class="nc" id="L653">        panMap.add(butRandomMap);</span>

<span class="nc" id="L655">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L656">        c.insets = new Insets(4, 4, 4, 4);</span>
<span class="nc" id="L657">        c.weightx = 1.0;</span>
<span class="nc" id="L658">        c.weighty = 0.75;</span>
<span class="nc" id="L659">        c.gridx = 0;</span>
<span class="nc" id="L660">        c.gridy = 1;</span>
<span class="nc" id="L661">        c.gridwidth = 2;</span>
<span class="nc" id="L662">        c.gridheight = 1;</span>
<span class="nc" id="L663">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L664">        gridbag.setConstraints(panGroundMap, c);</span>
<span class="nc" id="L665">        panMap.add(panGroundMap);</span>

<span class="nc" id="L667">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L668">        c.weightx = 1.0;</span>
<span class="nc" id="L669">        c.weighty = 0.25;</span>
<span class="nc" id="L670">        c.gridx = 0;</span>
<span class="nc" id="L671">        c.gridy = 2;</span>
<span class="nc" id="L672">        c.gridwidth = 2;</span>
<span class="nc" id="L673">        c.gridheight = 1;</span>
<span class="nc" id="L674">        gridbag.setConstraints(panSpaceMap, c);</span>
<span class="nc" id="L675">        panMap.add(panSpaceMap);</span>

<span class="nc" id="L677">    }</span>

    /**
     * Sets up the ground map selection panel
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
    private void setupGroundMap() {

<span class="nc" id="L685">        panGroundMap = new JPanel();</span>
<span class="nc" id="L686">        panGroundMap.setBorder(BorderFactory.createTitledBorder(&quot;Planetary Map&quot;));</span>

<span class="nc" id="L688">        panMapButtons = new JPanel();</span>

<span class="nc" id="L690">        comboMapType = new JComboBox&lt;String&gt;();</span>
<span class="nc" id="L691">        setupMapChoice();</span>

<span class="nc" id="L693">        butMapSize = new JButton(Messages.getString(&quot;ChatLounge.MapSize&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L694">        butMapSize.addActionListener(this);</span>

<span class="nc" id="L696">        comboMapSizes = new JComboBox&lt;Comparable&gt;();</span>
<span class="nc" id="L697">        setupMapSizes();</span>

<span class="nc" id="L699">        buttonBoardPreview = new JButton(Messages.getString(&quot;BoardSelectionDialog.ViewGameBoard&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L700">        buttonBoardPreview.addActionListener(this);</span>
<span class="nc" id="L701">        buttonBoardPreview.setToolTipText(Messages.getString(&quot;BoardSelectionDialog.ViewGameBoardTooltip&quot;));//$NON-NLS-1$</span>

<span class="nc" id="L703">        butChange = new JButton(&quot;&lt;&lt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L704">        butChange.addActionListener(this);</span>

<span class="nc" id="L706">        labBoardsSelected = new JLabel(Messages.getString(&quot;BoardSelectionDialog.MapsSelected&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L707">        labBoardsAvailable = new JLabel(Messages.getString(&quot;BoardSelectionDialog.mapsAvailable&quot;), //$NON-NLS-1$</span>
                SwingConstants.CENTER);

<span class="nc" id="L710">        lisBoardsSelected = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</span>
<span class="nc" id="L711">        lisBoardsSelected.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L712">        lisBoardsAvailable = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</span>
<span class="nc" id="L713">        refreshBoardsSelected();</span>
<span class="nc" id="L714">        refreshBoardsAvailable();</span>
<span class="nc" id="L715">        lisBoardsAvailable.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L716">        lisBoardsAvailable.addMouseListener(this);</span>
<span class="nc" id="L717">        lisBoardsAvailable.addListSelectionListener(this);</span>

<span class="nc" id="L719">        chkRotateBoard = new JCheckBox(Messages.getString(&quot;BoardSelectionDialog.RotateBoard&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L720">        chkRotateBoard.addActionListener(this);</span>

        // layout
<span class="nc" id="L723">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L724">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L725">        panGroundMap.setLayout(gridbag);</span>

<span class="nc" id="L727">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L728">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L729">        c.weightx = 0.0;</span>
<span class="nc" id="L730">        c.weighty = 0.0;</span>
<span class="nc" id="L731">        c.gridx = 0;</span>
<span class="nc" id="L732">        c.gridy = 0;</span>
<span class="nc" id="L733">        c.gridwidth = 1;</span>
<span class="nc" id="L734">        c.gridheight = 1;</span>
<span class="nc" id="L735">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L736">        gridbag.setConstraints(chkIncludeGround, c);</span>
<span class="nc" id="L737">        panGroundMap.add(chkIncludeGround);</span>

<span class="nc" id="L739">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L740">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L741">        c.weightx = 0.0;</span>
<span class="nc" id="L742">        c.weighty = 0.0;</span>
<span class="nc" id="L743">        c.gridx = 0;</span>
<span class="nc" id="L744">        c.gridy = 1;</span>
<span class="nc" id="L745">        c.gridwidth = 1;</span>
<span class="nc" id="L746">        c.gridheight = 1;</span>
<span class="nc" id="L747">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L748">        gridbag.setConstraints(comboMapType, c);</span>
<span class="nc" id="L749">        panGroundMap.add(comboMapType);</span>

<span class="nc" id="L751">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L752">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L753">        c.weightx = 0.0;</span>
<span class="nc" id="L754">        c.weighty = 0.0;</span>
<span class="nc" id="L755">        c.gridx = 0;</span>
<span class="nc" id="L756">        c.gridy = 2;</span>
<span class="nc" id="L757">        c.gridwidth = 1;</span>
<span class="nc" id="L758">        c.gridheight = 1;</span>
<span class="nc" id="L759">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L760">        gridbag.setConstraints(comboMapSizes, c);</span>
<span class="nc" id="L761">        panGroundMap.add(comboMapSizes);</span>

<span class="nc" id="L763">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L764">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L765">        c.weightx = 0.0;</span>
<span class="nc" id="L766">        c.weighty = 0.0;</span>
<span class="nc" id="L767">        c.gridx = 0;</span>
<span class="nc" id="L768">        c.gridy = 3;</span>
<span class="nc" id="L769">        c.gridwidth = 1;</span>
<span class="nc" id="L770">        c.gridheight = 1;</span>
<span class="nc" id="L771">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L772">        gridbag.setConstraints(butMapSize, c);</span>
<span class="nc" id="L773">        panGroundMap.add(butMapSize);</span>

<span class="nc" id="L775">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L776">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L777">        c.weightx = 0.0;</span>
<span class="nc" id="L778">        c.weighty = 0.0;</span>
<span class="nc" id="L779">        c.gridx = 0;</span>
<span class="nc" id="L780">        c.gridy = 4;</span>
<span class="nc" id="L781">        c.gridwidth = 1;</span>
<span class="nc" id="L782">        c.gridheight = 1;</span>
<span class="nc" id="L783">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L784">        gridbag.setConstraints(buttonBoardPreview, c);</span>
<span class="nc" id="L785">        panGroundMap.add(buttonBoardPreview);</span>

<span class="nc" id="L787">        scrMapButtons = new JScrollPane(panMapButtons);</span>
<span class="nc" id="L788">        refreshMapButtons();</span>
<span class="nc" id="L789">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L790">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L791">        c.weightx = 0.0;</span>
<span class="nc" id="L792">        c.weighty = 1.0;</span>
<span class="nc" id="L793">        c.gridx = 0;</span>
<span class="nc" id="L794">        c.gridy = 5;</span>
<span class="nc" id="L795">        c.gridwidth = 1;</span>
<span class="nc" id="L796">        c.gridheight = 1;</span>
<span class="nc" id="L797">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L798">        gridbag.setConstraints(scrMapButtons, c);</span>
<span class="nc" id="L799">        panGroundMap.add(scrMapButtons);</span>

<span class="nc" id="L801">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L802">        c.weightx = 0.0;</span>
<span class="nc" id="L803">        c.weighty = 0.0;</span>
<span class="nc" id="L804">        c.gridx = 1;</span>
<span class="nc" id="L805">        c.gridy = 1;</span>
<span class="nc" id="L806">        c.gridwidth = 1;</span>
<span class="nc" id="L807">        c.gridheight = 1;</span>
<span class="nc" id="L808">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L809">        gridbag.setConstraints(labBoardsSelected, c);</span>
<span class="nc" id="L810">        panGroundMap.add(labBoardsSelected);</span>

<span class="nc" id="L812">        scrBoardsSelected = new JScrollPane(lisBoardsSelected);</span>
<span class="nc" id="L813">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L814">        c.weightx = 1.0;</span>
<span class="nc" id="L815">        c.weighty = 1.0;</span>
<span class="nc" id="L816">        c.gridx = 1;</span>
<span class="nc" id="L817">        c.gridy = 2;</span>
<span class="nc" id="L818">        c.gridwidth = 1;</span>
<span class="nc" id="L819">        c.gridheight = 4;</span>
<span class="nc" id="L820">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L821">        gridbag.setConstraints(scrBoardsSelected, c);</span>
<span class="nc" id="L822">        panGroundMap.add(scrBoardsSelected);</span>

<span class="nc" id="L824">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L825">        c.weightx = 0.0;</span>
<span class="nc" id="L826">        c.weighty = 0.0;</span>
<span class="nc" id="L827">        c.gridx = 2;</span>
<span class="nc" id="L828">        c.gridy = 2;</span>
<span class="nc" id="L829">        c.gridwidth = 1;</span>
<span class="nc" id="L830">        c.gridheight = 1;</span>
<span class="nc" id="L831">        c.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L832">        gridbag.setConstraints(butChange, c);</span>
<span class="nc" id="L833">        panGroundMap.add(butChange);</span>

<span class="nc" id="L835">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L836">        c.weightx = 0.0;</span>
<span class="nc" id="L837">        c.weighty = 0.0;</span>
<span class="nc" id="L838">        c.gridx = 3;</span>
<span class="nc" id="L839">        c.gridy = 1;</span>
<span class="nc" id="L840">        c.gridwidth = 1;</span>
<span class="nc" id="L841">        c.gridheight = 1;</span>
<span class="nc" id="L842">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L843">        gridbag.setConstraints(labBoardsAvailable, c);</span>
<span class="nc" id="L844">        panGroundMap.add(labBoardsAvailable);</span>

<span class="nc" id="L846">        scrBoardsAvailable = new JScrollPane(lisBoardsAvailable);</span>
<span class="nc" id="L847">        c.weightx = 1.0;</span>
<span class="nc" id="L848">        c.weighty = 1.0;</span>
<span class="nc" id="L849">        c.gridx = 3;</span>
<span class="nc" id="L850">        c.gridy = 2;</span>
<span class="nc" id="L851">        c.gridwidth = 1;</span>
<span class="nc" id="L852">        c.gridheight = 4;</span>
<span class="nc" id="L853">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L854">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L855">        gridbag.setConstraints(scrBoardsAvailable, c);</span>
<span class="nc" id="L856">        panGroundMap.add(scrBoardsAvailable);</span>

<span class="nc" id="L858">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L859">        c.weightx = 0.0;</span>
<span class="nc" id="L860">        c.weighty = 0.0;</span>
<span class="nc" id="L861">        c.gridx = 4;</span>
<span class="nc" id="L862">        c.gridy = 1;</span>
<span class="nc" id="L863">        c.gridwidth = 1;</span>
<span class="nc" id="L864">        c.gridheight = 1;</span>
<span class="nc" id="L865">        c.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L866">        gridbag.setConstraints(chkRotateBoard, c);</span>
<span class="nc" id="L867">        panGroundMap.add(chkRotateBoard);</span>

<span class="nc" id="L869">        mapPreviewPanel = new JPanel();</span>

<span class="nc" id="L871">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L872">        c.weightx = 1.0;</span>
<span class="nc" id="L873">        c.weighty = 1.0;</span>
<span class="nc" id="L874">        c.gridx = 4;</span>
<span class="nc" id="L875">        c.gridy = 2;</span>
<span class="nc" id="L876">        c.gridwidth = 1;</span>
<span class="nc" id="L877">        c.gridheight = 4;</span>
<span class="nc" id="L878">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L879">        gridbag.setConstraints(mapPreviewPanel, c);</span>
<span class="nc" id="L880">        panGroundMap.add(mapPreviewPanel);</span>

        try {
<span class="nc" id="L883">            miniMap = new MiniMap(mapPreviewPanel, null);</span>
            // Set a default size for the minimap object to ensure it will have
            // space on the screen to be drawn.
<span class="nc" id="L886">            miniMap.setSize(160, 200);</span>
<span class="nc" id="L887">            miniMap.setZoom(2);</span>
<span class="nc" id="L888">        } catch (IOException e) {</span>
<span class="nc" id="L889">            JOptionPane.showMessageDialog(this, Messages.getString(&quot;BoardEditor.CouldNotInitialiseMinimap&quot;) + e,</span>
<span class="nc" id="L890">                    Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); // $NON-NLS-1$</span>
            // //$NON-NLS-2$
<span class="nc" id="L892">        }</span>
<span class="nc" id="L893">        mapPreviewPanel.add(miniMap);</span>

        // setup the board preview window.
<span class="nc" id="L896">        boardPreviewW = new ClientDialog(clientgui.frame, </span>
<span class="nc" id="L897">                Messages.getString(&quot;BoardSelectionDialog.ViewGameBoard&quot;), //$NON-NLS-1$</span>
                false);
<span class="nc" id="L899">        boardPreviewW.setLocationRelativeTo(clientgui.frame);</span>
<span class="nc" id="L900">        boardPreviewW.setVisible(false);</span>

        try {
<span class="nc" id="L903">            BoardView1 bv = new BoardView1(boardPreviewGame, null, null);</span>
<span class="nc" id="L904">            bv.setDisplayInvalidHexInfo(false);</span>
<span class="nc" id="L905">            bv.setUseLOSTool(false);</span>
<span class="nc" id="L906">            boardPreviewW.add(bv.getComponent(true));</span>
<span class="nc" id="L907">            boardPreviewW.setSize(clientgui.frame.getWidth()/2, clientgui.frame.getHeight()/2);</span>
<span class="nc" id="L908">            bv.zoomOut();</span>
<span class="nc" id="L909">            bv.zoomOut();</span>
<span class="nc" id="L910">            bv.zoomOut();</span>
<span class="nc" id="L911">            bv.zoomOut();</span>
<span class="nc" id="L912">            boardPreviewW.center();</span>
<span class="nc" id="L913">        } catch (IOException e) {</span>
<span class="nc" id="L914">            JOptionPane.showMessageDialog(this,</span>
<span class="nc" id="L915">                            Messages.getString(&quot;BoardEditor.CouldntInitialize&quot;) + e,</span>
<span class="nc" id="L916">                            Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); //$NON-NLS-1$</span>
            //$NON-NLS-2$
<span class="nc" id="L918">        }</span>

<span class="nc" id="L920">    }</span>

    private void setupSpaceMap() {

<span class="nc" id="L924">        panSpaceMap = new JPanel();</span>
<span class="nc" id="L925">        panSpaceMap.setBorder(BorderFactory.createTitledBorder(&quot;Space Map&quot;));</span>

<span class="nc" id="L927">        butSpaceSize = new JButton(Messages.getString(&quot;ChatLounge.MapSize&quot;));</span>
<span class="nc" id="L928">        butSpaceSize.addActionListener(this);</span>

        // layout
<span class="nc" id="L931">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L932">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L933">        panSpaceMap.setLayout(gridbag);</span>

<span class="nc" id="L935">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L936">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L937">        c.weightx = 1.0;</span>
<span class="nc" id="L938">        c.weighty = 0.0;</span>
<span class="nc" id="L939">        c.gridx = 0;</span>
<span class="nc" id="L940">        c.gridy = 0;</span>
<span class="nc" id="L941">        c.gridwidth = 1;</span>
<span class="nc" id="L942">        c.gridheight = 1;</span>
<span class="nc" id="L943">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L944">        gridbag.setConstraints(chkIncludeSpace, c);</span>
<span class="nc" id="L945">        panSpaceMap.add(chkIncludeSpace);</span>

<span class="nc" id="L947">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L948">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L949">        c.weightx = 1.0;</span>
<span class="nc" id="L950">        c.weighty = 1.0;</span>
<span class="nc" id="L951">        c.gridx = 0;</span>
<span class="nc" id="L952">        c.gridy = 1;</span>
<span class="nc" id="L953">        c.gridwidth = 1;</span>
<span class="nc" id="L954">        c.gridheight = 1;</span>
<span class="nc" id="L955">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L956">        gridbag.setConstraints(butSpaceSize, c);</span>
<span class="nc" id="L957">        panSpaceMap.add(butSpaceSize);</span>

<span class="nc" id="L959">    }</span>

    /**
     * Set up the map chooser panel
     */
    private void setupMapChoice() {
<span class="nc" id="L965">        comboMapType.addItem(MapSettings.getMediumName(MapSettings.MEDIUM_GROUND));</span>
<span class="nc" id="L966">        comboMapType.addItem(MapSettings.getMediumName(MapSettings.MEDIUM_ATMOSPHERE));</span>
<span class="nc" id="L967">        comboMapType.addActionListener(this);</span>
<span class="nc" id="L968">        refreshMapChoice();</span>
<span class="nc" id="L969">    }</span>

    private void setupMapSizes() {
<span class="nc" id="L972">        int oldSelection = comboMapSizes.getSelectedIndex();</span>
<span class="nc" id="L973">        mapSizes = clientgui.getClient().getAvailableMapSizes();</span>
<span class="nc" id="L974">        comboMapSizes.removeActionListener(this);</span>
<span class="nc" id="L975">        comboMapSizes.removeAllItems();</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">        for (BoardDimensions size : mapSizes) {</span>
<span class="nc" id="L977">            comboMapSizes.addItem(size);</span>
<span class="nc" id="L978">        }</span>
<span class="nc" id="L979">        comboMapSizes.addItem(Messages.getString(&quot;ChatLounge.CustomMapSize&quot;));</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">        comboMapSizes.setSelectedIndex(oldSelection != -1 ? oldSelection : 0);</span>
<span class="nc" id="L981">        comboMapSizes.addActionListener(this);</span>
<span class="nc" id="L982">    }</span>

    private void refreshMapChoice() {
<span class="nc" id="L985">        comboMapType.removeActionListener(this);</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">        if (mapSettings.getMedium() &lt; MapSettings.MEDIUM_SPACE) {</span>
<span class="nc" id="L987">            comboMapType.setSelectedIndex(mapSettings.getMedium());</span>
        }
<span class="nc" id="L989">        comboMapType.addActionListener(this);</span>
<span class="nc" id="L990">    }</span>

    private void refreshSpaceGround() {
<span class="nc" id="L993">        chkIncludeGround.removeActionListener(this);</span>
<span class="nc" id="L994">        chkIncludeSpace.removeActionListener(this);</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">        boolean inSpace = mapSettings.getMedium() == MapSettings.MEDIUM_SPACE;</span>
<span class="nc" id="L996">        chkIncludeSpace.setSelected(inSpace);</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">        chkIncludeGround.setSelected(!inSpace);</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">        comboMapType.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">        butMapSize.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        comboMapSizes.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        buttonBoardPreview.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">        lisBoardsSelected.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">        butChange.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        lisBoardsAvailable.setEnabled(!inSpace);</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">        chkRotateBoard.setEnabled(!inSpace);</span>
<span class="nc" id="L1006">        butSpaceSize.setEnabled(inSpace);</span>
<span class="nc" id="L1007">        chkIncludeGround.addActionListener(this);</span>
<span class="nc" id="L1008">        chkIncludeSpace.addActionListener(this);</span>
<span class="nc" id="L1009">    }</span>

    private void refreshBoardsAvailable() {
<span class="nc" id="L1012">        int selectedRow = lisBoardsAvailable.getSelectedIndex();</span>
<span class="nc" id="L1013">        ((DefaultListModel&lt;String&gt;) lisBoardsAvailable.getModel()).removeAllElements();</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">        for (String s : mapSettings.getBoardsAvailableVector()) {</span>
<span class="nc" id="L1015">            ((DefaultListModel&lt;String&gt;) lisBoardsAvailable.getModel()).addElement(s);</span>
<span class="nc" id="L1016">        }</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">        if (resetAvailBoardSelection) {</span>
<span class="nc" id="L1018">            lisBoardsAvailable.setSelectedIndex(0);</span>
<span class="nc" id="L1019">            resetAvailBoardSelection = false;</span>
        } else {
<span class="nc" id="L1021">            lisBoardsAvailable.setSelectedIndex(selectedRow);</span>
        }
<span class="nc" id="L1023">    }</span>

    private void refreshBoardsSelected() {
<span class="nc" id="L1026">        int selectedRow = lisBoardsSelected.getSelectedIndex();</span>
<span class="nc" id="L1027">        ((DefaultListModel&lt;String&gt;) lisBoardsSelected.getModel()).removeAllElements();</span>
<span class="nc" id="L1028">        int index = 0;</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        for (Iterator&lt;String&gt; i = mapSettings.getBoardsSelected(); i.hasNext();) {</span>
<span class="nc" id="L1030">            ((DefaultListModel&lt;String&gt;) lisBoardsSelected.getModel()).addElement(index++ + &quot;: &quot; + i.next()); //$NON-NLS-1$</span>
        }
<span class="nc" id="L1032">        lisBoardsSelected.setSelectedIndex(selectedRow);</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">        if (resetSelectedBoards) {</span>
<span class="nc" id="L1034">            lisBoardsSelected.setSelectedIndex(0);</span>
<span class="nc" id="L1035">            resetSelectedBoards = false;</span>
        } else {
<span class="nc" id="L1037">            lisBoardsSelected.setSelectedIndex(selectedRow);</span>
        }
<span class="nc" id="L1039">    }</span>

    /**
     * Fills the Map Buttons scroll pane with the appropriate amount of buttons
     * in the appropriate layout
     */
    private void refreshMapButtons() {
<span class="nc" id="L1046">        panMapButtons.removeAll();</span>

<span class="nc" id="L1048">        panMapButtons.setLayout(new GridLayout(mapSettings.getMapHeight(), mapSettings.getMapWidth()));</span>

<span class="nc bnc" id="L1050" title="All 2 branches missed.">        for (int i = 0; i &lt; mapSettings.getMapHeight(); i++) {</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">            for (int j = 0; j &lt; mapSettings.getMapWidth(); j++) {</span>
<span class="nc" id="L1052">                JButton button = new JButton(Integer.toString((i * mapSettings.getMapWidth()) + j));</span>
<span class="nc" id="L1053">                button.addActionListener(this);</span>
<span class="nc" id="L1054">                panMapButtons.add(button);</span>
            }
        }

<span class="nc" id="L1058">        scrMapButtons.validate();</span>

<span class="nc" id="L1060">        labBoardsAvailable.setText(mapSettings.getBoardWidth() + &quot;x&quot; + mapSettings.getBoardHeight() + &quot; &quot;</span>
<span class="nc" id="L1061">                + Messages.getString(&quot;BoardSelectionDialog.mapsAvailable&quot;));</span>
<span class="nc" id="L1062">        comboMapSizes.removeActionListener(this);</span>
<span class="nc" id="L1063">        int items = comboMapSizes.getItemCount();</span>

<span class="nc" id="L1065">        boolean mapSizeSelected = false;</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">        for (int i = 0; i &lt; (items - 1); i++) {</span>
<span class="nc" id="L1067">            BoardDimensions size = (BoardDimensions) comboMapSizes.getItemAt(i);</span>

<span class="nc bnc" id="L1069" title="All 4 branches missed.">            if ((size.width() == mapSettings.getBoardWidth()) &amp;&amp; (size.height() == mapSettings.getBoardHeight())) {</span>
<span class="nc" id="L1070">                comboMapSizes.setSelectedIndex(i);</span>
<span class="nc" id="L1071">                mapSizeSelected = true;</span>
            }
        }
        // If we didn't select a size, select the last item: 'Custom Size'
<span class="nc bnc" id="L1075" title="All 2 branches missed.">        if (!mapSizeSelected) {</span>
<span class="nc" id="L1076">            comboMapSizes.setSelectedIndex(items - 1);</span>
        }
<span class="nc" id="L1078">        comboMapSizes.addActionListener(this);</span>

<span class="nc" id="L1080">    }</span>

    public void previewMapsheet() {
<span class="nc" id="L1083">        String boardName = lisBoardsAvailable.getSelectedValue();</span>
<span class="nc bnc" id="L1084" title="All 2 branches missed.">        if (lisBoardsAvailable.getSelectedIndex() &gt; 2) {</span>
<span class="nc" id="L1085">            IBoard board = new Board(16, 17);</span>
<span class="nc" id="L1086">            board.load(new MegaMekFile(Configuration.boardsDir(), boardName + &quot;.board&quot;).getFile());</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">            if (chkRotateBoard.isSelected()) {</span>
<span class="nc" id="L1088">                BoardUtilities.flip(board, true, true);</span>
            }
<span class="nc bnc" id="L1090" title="All 2 branches missed.">            if (board.isValid())</span>
<span class="nc" id="L1091">                miniMap.setBoard(board);</span>
        }
<span class="nc" id="L1093">    }</span>

    public void previewGameBoard() {
<span class="nc" id="L1096">        MapSettings temp = mapSettings;</span>
<span class="nc" id="L1097">        temp.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L1098">        temp.replaceBoardWithRandom(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L1099">        IBoard[] sheetBoards = new IBoard[temp.getMapWidth() * temp.getMapHeight()];</span>
<span class="nc" id="L1100">        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">        for (int i = 0; i &lt; (temp.getMapWidth() * temp.getMapHeight()); i++) {</span>
<span class="nc" id="L1102">            sheetBoards[i] = new Board();</span>
<span class="nc" id="L1103">            String name = temp.getBoardsSelectedVector().get(i);</span>
<span class="nc" id="L1104">            boolean isRotated = false;</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">            if (name.startsWith(Board.BOARD_REQUEST_ROTATION)) {</span>
                // only rotate boards with an even width
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                if ((temp.getBoardWidth() % 2) == 0) {</span>
<span class="nc" id="L1108">                    isRotated = true;</span>
                }
<span class="nc" id="L1110">                name = name.substring(Board.BOARD_REQUEST_ROTATION.length());</span>
            }
<span class="nc bnc" id="L1112" title="All 4 branches missed.">            if (name.startsWith(MapSettings.BOARD_GENERATED) || (temp.getMedium() == MapSettings.MEDIUM_SPACE)) {</span>
<span class="nc" id="L1113">                sheetBoards[i] = BoardUtilities.generateRandom(temp);</span>
            } else {
<span class="nc" id="L1115">                sheetBoards[i].load(new MegaMekFile(Configuration.boardsDir(), name</span>
<span class="nc" id="L1116">                        + &quot;.board&quot;).getFile());</span>
<span class="nc" id="L1117">                BoardUtilities.flip(sheetBoards[i], isRotated, isRotated);</span>
            }
<span class="nc" id="L1119">            rotateBoard.add(isRotated);</span>
        }

<span class="nc" id="L1122">        IBoard newBoard = BoardUtilities.combine(temp.getBoardWidth(), temp.getBoardHeight(), temp.getMapWidth(),</span>
<span class="nc" id="L1123">                temp.getMapHeight(), sheetBoards, rotateBoard, temp.getMedium());</span>
        
<span class="nc" id="L1125">        boardPreviewGame.setBoard(newBoard);</span>
<span class="nc" id="L1126">        boardPreviewW.setVisible(true);</span>
<span class="nc" id="L1127">    }</span>

    /**
     * Refreshes the game settings with new info from the client
     */
    private void refreshGameSettings() {
<span class="nc" id="L1133">        refreshTeams();</span>
<span class="nc" id="L1134">        refreshDoneButton();</span>
<span class="nc" id="L1135">    }</span>

    /**
     * Refreshes the entities from the client
     */
    public void refreshEntities() {
<span class="nc" id="L1141">        mekModel.clearData();</span>
<span class="nc" id="L1142">        boolean localUnits = false;</span>

        /*
         * We will attempt to sort by the following criteria: My units first,
         * then my teamates units, then other teams units. We will also sort by
         * player name within the forementioned categories. Finally, a players
         * units will be sorted by the order they were &quot;added&quot; to the list.
         */
<span class="nc" id="L1150">        ArrayList&lt;Entity&gt; allEntities = new ArrayList&lt;Entity&gt;();</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">        for (Entity ent : clientgui.getClient().getEntitiesVector()) {</span>
<span class="nc" id="L1152">            allEntities.add(ent);</span>
<span class="nc" id="L1153">        }</span>

<span class="nc" id="L1155">        Collections.sort(allEntities, new Comparator&lt;Entity&gt;() {</span>
            @Override
            public int compare(final Entity a, final Entity b) {
                // entity.getOwner() does not work properly because teams are
                // not updated for
                // entities when the user switches teams
<span class="nc" id="L1161">                final IPlayer p_a = clientgui.getClient().getGame().getPlayer(a.getOwnerId());// a.getOwner();</span>
<span class="nc" id="L1162">                final IPlayer p_b = clientgui.getClient().getGame().getPlayer(b.getOwnerId());// b.getOwner();</span>
<span class="nc" id="L1163">                final IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</span>
<span class="nc" id="L1164">                final int t_a = p_a.getTeam();</span>
<span class="nc" id="L1165">                final int t_b = p_b.getTeam();</span>
<span class="nc" id="L1166">                final int tr_a = a.getTransportId();</span>
<span class="nc" id="L1167">                final int tr_b = b.getTransportId();</span>
<span class="nc bnc" id="L1168" title="All 4 branches missed.">                if (p_a.equals(localPlayer) &amp;&amp; !p_b.equals(localPlayer)) {</span>
<span class="nc" id="L1169">                    return -1;</span>
<span class="nc bnc" id="L1170" title="All 4 branches missed.">                } else if (!p_a.equals(localPlayer) &amp;&amp; p_b.equals(localPlayer)) {</span>
<span class="nc" id="L1171">                    return 1;</span>
<span class="nc bnc" id="L1172" title="All 4 branches missed.">                } else if ((t_a == localPlayer.getTeam()) &amp;&amp; (t_b != localPlayer.getTeam())) {</span>
<span class="nc" id="L1173">                    return -1;</span>
<span class="nc bnc" id="L1174" title="All 4 branches missed.">                } else if ((t_b == localPlayer.getTeam()) &amp;&amp; (t_a != localPlayer.getTeam())) {</span>
<span class="nc" id="L1175">                    return 1;</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">                } else if (t_a != t_b) {</span>
<span class="nc" id="L1177">                    return t_a - t_b;</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">                } else if (!p_a.equals(p_b)) {</span>
<span class="nc" id="L1179">                    return p_a.getName().compareTo(p_b.getName());</span>
                } else {
<span class="nc" id="L1181">                    int a_id = a.getId();</span>
<span class="nc" id="L1182">                    int b_id = b.getId();</span>
                    // loaded units should be put immediately below their parent
                    // unit
                    // if a unit's transport ID is not none, then it should
                    // replace their actual id
<span class="nc bnc" id="L1187" title="All 2 branches missed.">                    if (tr_a == tr_b) {</span>
                        // either they are both not being transported, or they
                        // are being transported
                        // by the same unit
<span class="nc" id="L1191">                        return a_id - b_id;</span>
                    }

<span class="nc bnc" id="L1194" title="All 2 branches missed.">                    if (tr_b != Entity.NONE) {</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                        if (tr_b == a_id) {</span>
                            // b is loaded on a
<span class="nc" id="L1197">                            return -1;</span>
                        }
<span class="nc" id="L1199">                        b_id = tr_b;</span>
                    }
<span class="nc bnc" id="L1201" title="All 2 branches missed.">                    if (tr_a != Entity.NONE) {</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">                        if (tr_a == b_id) {</span>
                            // a is loaded on b
<span class="nc" id="L1204">                            return 1;</span>
                        }
<span class="nc" id="L1206">                        a_id = tr_a;</span>
                    }
<span class="nc" id="L1208">                    return a_id - b_id;</span>
                }
            }
        });

<span class="nc bnc" id="L1213" title="All 2 branches missed.">        for (Entity entity : allEntities) {</span>
            // Remember if the local player has units.
<span class="nc bnc" id="L1215" title="All 4 branches missed.">            if (!localUnits &amp;&amp; entity.getOwner().equals(clientgui.getClient().getLocalPlayer())) {</span>
<span class="nc" id="L1216">                localUnits = true;</span>
            }

<span class="nc bnc" id="L1219" title="All 2 branches missed.">            if (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_PILOT_ADVANTAGES)) { // $NON-NLS-1$</span>
<span class="nc" id="L1220">                entity.getCrew().clearOptions(PilotOptions.LVL3_ADVANTAGES);</span>
            }

<span class="nc bnc" id="L1223" title="All 2 branches missed.">            if (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.EDGE)) { // $NON-NLS-1$</span>
<span class="nc" id="L1224">                entity.getCrew().clearOptions(PilotOptions.EDGE_ADVANTAGES);</span>
            }

<span class="nc bnc" id="L1227" title="All 2 branches missed.">            if (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_MANEI_DOMINI)) { // $NON-NLS-1$</span>
<span class="nc" id="L1228">                entity.getCrew().clearOptions(PilotOptions.MD_ADVANTAGES);</span>
            }

<span class="nc" id="L1231">            if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">                    .booleanOption(OptionsConstants.ADVANCED_STRATOPS_PARTIALREPAIRS)) { // $NON-NLS-1$</span>
<span class="nc" id="L1233">                entity.clearPartialRepairs();</span>
            }
            // Handle the &quot;Blind Drop&quot; option.
<span class="nc bnc" id="L1236" title="All 2 branches missed.">            if (!entity.getOwner().equals(clientgui.getClient().getLocalPlayer())</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">                    &amp;&amp; clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) // $NON-NLS-1$</span>
<span class="nc" id="L1238">                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">                    .booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) { // $NON-NLS-1$</span>

<span class="nc" id="L1241">                mekModel.addUnit(entity);</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            } else if (entity.getOwner().equals(clientgui.getClient().getLocalPlayer())</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">                    || (!clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) // $NON-NLS-1$</span>
<span class="nc" id="L1244">                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">                    .booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP))) { // $NON-NLS-1$</span>
<span class="nc" id="L1246">                mekModel.addUnit(entity);</span>
            }
<span class="nc" id="L1248">        }</span>

        // Enable the &quot;Save Unit List...&quot; and &quot;Delete All&quot;
        // buttons if the local player has units.
<span class="nc" id="L1252">        butSaveList.setEnabled(localUnits);</span>
<span class="nc" id="L1253">        butDeleteAll.setEnabled(localUnits);</span>
<span class="nc" id="L1254">        clientgui.getMenuBar().setUnitList(localUnits);</span>
<span class="nc" id="L1255">    }</span>

    public static String formatPilotTooltip(Crew pilot, boolean command, boolean init, boolean tough, boolean rpgSkills) {

<span class="nc" id="L1259">        String value = &quot;&lt;html&gt;&quot;;</span>
<span class="nc" id="L1260">        value += &quot;&lt;b&gt;&quot; + pilot.getDesc() + &quot;&lt;/b&gt;&lt;br&gt;&quot;;</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">        if (pilot.getNickname().length() &gt; 0) {</span>
<span class="nc" id="L1262">            value += &quot;&lt;i&gt;&quot; + pilot.getNickname() + &quot;&lt;/i&gt;&lt;br&gt;&quot;;</span>
        }
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (pilot.getHits() &gt; 0) {</span>
<span class="nc" id="L1265">            value += &quot;&lt;font color='red'&gt;&quot; + Messages.getString(&quot;ChatLounge.Hits&quot;) + pilot.getHits() + &quot;&lt;/font&gt;&lt;br&gt;&quot;;</span>
        }
<span class="nc" id="L1267">        value += &quot;&quot; + pilot.getSkillsAsString(rpgSkills) + &quot;&lt;br&gt;&quot;;</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">        if (tough) {</span>
<span class="nc" id="L1269">            value += Messages.getString(&quot;ChatLounge.Tough&quot;) + pilot.getToughness(0) + &quot;&lt;br&gt;&quot;;</span>
        }
<span class="nc bnc" id="L1271" title="All 2 branches missed.">        if (command) {</span>
<span class="nc" id="L1272">            value += Messages.getString(&quot;ChatLounge.Command&quot;) + pilot.getCommandBonus() + &quot;&lt;br&gt;&quot;;</span>
        }
<span class="nc bnc" id="L1274" title="All 2 branches missed.">        if (init) {</span>
<span class="nc" id="L1275">            value += Messages.getString(&quot;ChatLounge.Initiative&quot;) + pilot.getInitBonus() + &quot;&lt;br&gt;&quot;;</span>
        }
<span class="nc" id="L1277">        value += &quot;&lt;br&gt;&quot;;</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">        for (Enumeration&lt;IOptionGroup&gt; advGroups = pilot.getOptions().getGroups(); advGroups.hasMoreElements();) {</span>
<span class="nc" id="L1279">            IOptionGroup advGroup = advGroups.nextElement();</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">            if (pilot.countOptions(advGroup.getKey()) &gt; 0) {</span>
<span class="nc" id="L1281">                value += &quot;&lt;b&gt;&quot; + advGroup.getDisplayableName() + &quot;&lt;/b&gt;&lt;br&gt;&quot;;</span>
<span class="nc bnc" id="L1282" title="All 2 branches missed.">                for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</span>
<span class="nc" id="L1283">                    IOption adv = advs.nextElement();</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">                    if (adv.booleanValue()) {</span>
<span class="nc" id="L1285">                        value += &quot;  &quot; + adv.getDisplayableNameWithValue() + &quot;&lt;br&gt;&quot;;</span>
                    }
<span class="nc" id="L1287">                }</span>
            }
<span class="nc" id="L1289">        }</span>
<span class="nc" id="L1290">        value += &quot;&lt;/html&gt;&quot;;</span>
<span class="nc" id="L1291">        return value;</span>

    }

    private static StringBuffer tooltipString;
    private static final boolean BR = true;
    private static final boolean NOBR = false;

    /**
     * Adds a resource string to the entity tooltip
     *
     * @param ttSName
     *            The resource string name. &quot;BoardView1.Tooltip.&quot; will be added
     *            in front, so &quot;Pilot&quot; will retrieve BoardView1.Tooltip.Pilot
     * @param startBR
     *            = true will start the string with a &amp;lt;BR&amp;gt;; The constants
     *            BR and NOBR can be used here.
     * @param ttO
     *            a list of Objects to insert into the {x} places in the
     *            resource.
     */
    private static void addToTT(String ttSName, boolean startBR, Object... ttO) {
<span class="nc bnc" id="L1313" title="All 2 branches missed.">        if (startBR == BR)</span>
<span class="nc" id="L1314">            tooltipString.append(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">        if (ttO != null) {</span>
<span class="nc" id="L1316">            tooltipString.append(Messages.getString(&quot;BoardView1.Tooltip.&quot; + ttSName, ttO));</span>
        } else {
<span class="nc" id="L1318">            tooltipString.append(Messages.getString(&quot;BoardView1.Tooltip.&quot; + ttSName));</span>
        }
<span class="nc" id="L1320">    }</span>

    /**
     * Adds a resource string to the entity tooltip
     *
     * @param ttSName
     *            The resource string name. &quot;BoardView1.Tooltip.&quot; will be added
     *            in front, so &quot;Pilot&quot; will retrieve BoardView1.Tooltip.Pilot
     * @param startBR
     *            = true will start the string with a &amp;lt;BR&amp;gt;; The constants
     *            BR and NOBR can be used here.
     */
    private static void addToTT(String ttSName, boolean startBR) {
<span class="nc" id="L1333">        addToTT(ttSName, startBR, (Object[]) null);</span>
<span class="nc" id="L1334">    }</span>

    public static String formatUnitTooltip(Entity entity) {

<span class="nc" id="L1338">        GunEmplacement thisGunEmp = null;</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">        if (entity instanceof GunEmplacement)</span>
<span class="nc" id="L1340">            thisGunEmp = (GunEmplacement) entity;</span>

<span class="nc" id="L1342">        tooltipString = new StringBuffer();</span>
<span class="nc" id="L1343">        tooltipString.append(&quot;&lt;HTML&gt;&quot;);</span>

        // Unit Chassis and Player
<span class="nc" id="L1346">        addToTT(&quot;Unit&quot;, NOBR, entity.getOwner().getColour().getHexString(),</span>
<span class="nc" id="L1347">                entity.getChassis(), entity.getOwner().getName());</span>

        // Pilot Info
        // Nickname &gt; Name &gt; &quot;Pilot&quot;
<span class="nc bnc" id="L1351" title="All 2 branches missed.">        for (int i = 0; i &lt; entity.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">            if (entity.getCrew().isMissing(i)) {</span>
<span class="nc" id="L1353">                continue;</span>
            }
<span class="nc" id="L1355">            String pnameStr = entity.getCrew().getCrewType().getRoleName(i);</span>

<span class="nc bnc" id="L1357" title="All 4 branches missed.">            if ((entity.getCrew().getName(i) != null) &amp;&amp; !entity.getCrew().getName(i).equals(&quot;&quot;))</span>
<span class="nc" id="L1358">                pnameStr = entity.getCrew().getName(i);</span>

<span class="nc bnc" id="L1360" title="All 4 branches missed.">            if ((entity.getCrew().getNickname(i) != null) &amp;&amp; !entity.getCrew().getNickname(i).equals(&quot;&quot;))</span>
<span class="nc" id="L1361">                pnameStr = &quot;'&quot; + entity.getCrew().getNickname(i) + &quot;'&quot;;</span>

<span class="nc bnc" id="L1363" title="All 2 branches missed.">            if (entity.getCrew().getSlotCount() &gt; 1) {</span>
<span class="nc" id="L1364">                pnameStr += &quot; (&quot; + entity.getCrew().getCrewType().getRoleName(i) + &quot;)&quot;;</span>
            }

<span class="nc" id="L1367">            addToTT(&quot;Pilot&quot;, BR, pnameStr, entity.getCrew().getGunnery(i), entity.getCrew().getPiloting(i));</span>

            // Pilot Status
<span class="nc bnc" id="L1370" title="All 2 branches missed.">            if (!entity.getCrew().getStatusDesc(i).equals(&quot;&quot;))</span>
<span class="nc" id="L1371">                addToTT(&quot;PilotStatus&quot;, NOBR, entity.getCrew().getStatusDesc(i));</span>
        }

        // Pilot Advantages
<span class="nc" id="L1375">        int numAdv = entity.getCrew().countOptions(PilotOptions.LVL3_ADVANTAGES);</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">        if (numAdv == 1)</span>
<span class="nc" id="L1377">            addToTT(&quot;Adv1&quot;, NOBR, numAdv);</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">        else if (numAdv &gt; 1)</span>
<span class="nc" id="L1379">            addToTT(&quot;Advs&quot;, NOBR, numAdv);</span>

        // Pilot Manei Domini
<span class="nc bnc" id="L1382" title="All 2 branches missed.">        if ((entity.getCrew().countOptions(PilotOptions.MD_ADVANTAGES) &gt; 0))</span>
<span class="nc" id="L1383">            addToTT(&quot;MD&quot;, NOBR);</span>

        // Unit movement ability
<span class="nc bnc" id="L1386" title="All 2 branches missed.">        if (thisGunEmp == null) {</span>
<span class="nc" id="L1387">            addToTT(&quot;Movement&quot;, BR, entity.getWalkMP(), entity.getRunMPasString());</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">            if (entity.getJumpMP() &gt; 0)</span>
<span class="nc" id="L1389">                tooltipString.append(&quot;/&quot; + entity.getJumpMP());</span>
        }

        // Armor and Internals
<span class="nc" id="L1393">        addToTT(&quot;ArmorInternals&quot;, BR,</span>
<span class="nc" id="L1394">                entity.getTotalArmor()</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">                        + ((entity.getTotalArmor() != entity.getTotalOArmor()) ? &quot;/&quot; + entity.getTotalOArmor() : &quot;&quot;),</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">                entity.getTotalInternal() + ((entity.getTotalInternal() != entity.getTotalOInternal())</span>
<span class="nc" id="L1397">                        ? &quot;/&quot; + entity.getTotalOInternal() : &quot;&quot;));</span>

        // Weapon List
<span class="nc bnc" id="L1400" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getBoolean(GUIPreferences.SHOW_WPS_IN_TT)) {</span>

<span class="nc" id="L1402">            ArrayList&lt;Mounted&gt; weapons = entity.getWeaponList();</span>
<span class="nc" id="L1403">            HashMap&lt;String, Integer&gt; wpNames = new HashMap&lt;String, Integer&gt;();</span>

            // Gather names, counts, Clan/IS
            // When clan then the number will be stored as negative
<span class="nc bnc" id="L1407" title="All 2 branches missed.">            for (Mounted curWp : weapons) {</span>
<span class="nc" id="L1408">                String weapDesc = curWp.getDesc();</span>
                // Append ranges
<span class="nc" id="L1410">                WeaponType wtype = (WeaponType) curWp.getType();</span>
                int ranges[];
<span class="nc bnc" id="L1412" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L1413">                    ranges = wtype.getATRanges();</span>
                } else {
<span class="nc" id="L1415">                    ranges = wtype.getRanges(curWp);</span>
                }
<span class="nc" id="L1417">                String rangeString = &quot;(&quot;;</span>
<span class="nc bnc" id="L1418" title="All 4 branches missed.">                if ((ranges[RangeType.RANGE_MINIMUM] != WeaponType.WEAPON_NA)</span>
                        &amp;&amp; (ranges[RangeType.RANGE_MINIMUM] != 0)) {
<span class="nc" id="L1420">                    rangeString += ranges[RangeType.RANGE_MINIMUM] + &quot;/&quot;;</span>
                } else {
<span class="nc" id="L1422">                    rangeString += &quot;-/&quot;;</span>
                }
<span class="nc" id="L1424">                int maxRange = RangeType.RANGE_LONG;</span>

<span class="nc bnc" id="L1426" title="All 2 branches missed.">                if ((entity.getGame() != null)</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">                        &amp;&amp; entity.getGame().getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_RANGE)) {</span>
<span class="nc" id="L1428">                    maxRange = RangeType.RANGE_EXTREME;</span>
                }
<span class="nc bnc" id="L1430" title="All 2 branches missed.">                for (int i = RangeType.RANGE_SHORT; i &lt;= maxRange; i++) {</span>
<span class="nc" id="L1431">                    rangeString += ranges[i];</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">                    if (i != maxRange) {</span>
<span class="nc" id="L1433">                        rangeString += &quot;/&quot;;</span>
                    }
                }

<span class="nc" id="L1437">                weapDesc += rangeString + &quot;)&quot;;</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">                if (wpNames.containsKey(weapDesc)) {</span>
<span class="nc" id="L1439">                    int number = wpNames.get(weapDesc);</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">                    if (number &gt; 0)</span>
<span class="nc" id="L1441">                        wpNames.put(weapDesc, number + 1);</span>
                    else
<span class="nc" id="L1443">                        wpNames.put(weapDesc, number - 1);</span>
<span class="nc" id="L1444">                } else {</span>
<span class="nc" id="L1445">                    WeaponType wpT = ((WeaponType) curWp.getType());</span>

<span class="nc bnc" id="L1447" title="All 4 branches missed.">                    if (entity.isClan() &amp;&amp; TechConstants.isClan(wpT.getTechLevel(entity.getYear())))</span>
<span class="nc" id="L1448">                        wpNames.put(weapDesc, -1);</span>
                    else
<span class="nc" id="L1450">                        wpNames.put(weapDesc, 1);</span>
                }
<span class="nc" id="L1452">            }</span>

            // Print to Tooltip
<span class="nc" id="L1455">            tooltipString.append(&quot;&lt;FONT SIZE=\&quot;-2\&quot;&gt;&quot;);</span>

<span class="nc bnc" id="L1457" title="All 2 branches missed.">            for (Entry&lt;String, Integer&gt; entry : wpNames.entrySet()) {</span>
                // Check if weapon is destroyed, text gray and strikethrough if
                // so, remove the &quot;x &quot;/&quot;*&quot;
                // Also remove &quot;+&quot;, means currently selected for firing
<span class="nc" id="L1461">                boolean wpDest = false;</span>
<span class="nc" id="L1462">                String nameStr = entry.getKey();</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">                if (entry.getKey().startsWith(&quot;x &quot;)) {</span>
<span class="nc" id="L1464">                    nameStr = entry.getKey().substring(2, entry.getKey().length());</span>
<span class="nc" id="L1465">                    wpDest = true;</span>
                }

<span class="nc bnc" id="L1468" title="All 2 branches missed.">                if (entry.getKey().startsWith(&quot;*&quot;)) {</span>
<span class="nc" id="L1469">                    nameStr = entry.getKey().substring(1, entry.getKey().length());</span>
<span class="nc" id="L1470">                    wpDest = true;</span>
                }

<span class="nc bnc" id="L1473" title="All 2 branches missed.">                if (entry.getKey().startsWith(&quot;+&quot;)) {</span>
<span class="nc" id="L1474">                    nameStr = entry.getKey().substring(1, entry.getKey().length());</span>
<span class="nc" id="L1475">                    nameStr = nameStr.concat(&quot; &lt;I&gt;(Firing)&lt;/I&gt;&quot;);</span>
                }

                // normal coloring
<span class="nc" id="L1479">                tooltipString.append(&quot;&lt;FONT COLOR=#8080FF&gt;&quot;);</span>
                // but: color gray and strikethrough when weapon destroyed
<span class="nc bnc" id="L1481" title="All 2 branches missed.">                if (wpDest)</span>
<span class="nc" id="L1482">                    tooltipString.append(&quot;&lt;FONT COLOR=#a0a0a0&gt;&lt;S&gt;&quot;);</span>

<span class="nc" id="L1484">                String clanStr = &quot;&quot;;</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">                if (entry.getValue() &lt; 0)</span>
<span class="nc" id="L1486">                    clanStr = Messages.getString(&quot;BoardView1.Tooltip.Clan&quot;);</span>

                // when more than 5 weapons are present, they will be grouped
                // and listed with a multiplier
<span class="nc bnc" id="L1490" title="All 2 branches missed.">                if (weapons.size() &gt; 5) {</span>
<span class="nc" id="L1491">                    addToTT(&quot;WeaponN&quot;, BR, Math.abs(entry.getValue()), clanStr, nameStr);</span>

                } else { // few weapons: list each weapon separately
<span class="nc bnc" id="L1494" title="All 2 branches missed.">                    for (int i = 0; i &lt; Math.abs(entry.getValue()); i++) {</span>
<span class="nc" id="L1495">                        addToTT(&quot;Weapon&quot;, BR, Math.abs(entry.getValue()), clanStr, nameStr);</span>
                    }
                }
                // Weapon destroyed? End strikethrough
<span class="nc bnc" id="L1499" title="All 2 branches missed.">                if (wpDest)</span>
<span class="nc" id="L1500">                    tooltipString.append(&quot;&lt;/S&gt;&quot;);</span>
<span class="nc" id="L1501">                tooltipString.append(&quot;&lt;/FONT&gt;&quot;);</span>
<span class="nc" id="L1502">            }</span>
<span class="nc" id="L1503">            tooltipString.append(&quot;&lt;/FONT&gt;&quot;);</span>
        }

        // Add StratOps quirks, if activated
<span class="nc bnc" id="L1507" title="All 2 branches missed.">        if ((entity.getGame() != null)</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">                &amp;&amp; entity.getGame().getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">            for (Enumeration&lt;IOptionGroup&gt; advGroups = entity.getQuirks().getGroups(); advGroups.hasMoreElements();) {</span>
<span class="nc" id="L1510">                IOptionGroup advGroup = advGroups.nextElement();</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">                if (entity.countQuirks(advGroup.getKey()) &gt; 0) {</span>
<span class="nc" id="L1512">                    tooltipString.append(&quot;&lt;BR&gt;&lt;i&gt;&quot; + advGroup.getDisplayableName() + &quot;:&lt;/i&gt;&quot;);</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">                    for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</span>
<span class="nc" id="L1514">                        IOption adv = advs.nextElement();</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">                        if (adv.booleanValue()) {</span>
<span class="nc" id="L1516">                            tooltipString.append(&quot;&lt;BR&gt;&amp;nbsp;&quot; + adv.getDisplayableNameWithValue());</span>
                        }
<span class="nc" id="L1518">                    }</span>
                }
<span class="nc" id="L1520">            }</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">            for (Mounted weapon : entity.getWeaponList()) {</span>
<span class="nc" id="L1522">                for (Enumeration&lt;IOptionGroup&gt; advGroups = weapon.getQuirks().getGroups(); advGroups</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">                        .hasMoreElements();) {</span>
<span class="nc" id="L1524">                    IOptionGroup advGroup = advGroups.nextElement();</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                    if (weapon.countQuirks() &gt; 0) {</span>
<span class="nc" id="L1526">                        tooltipString.append(&quot;&lt;BR&gt;&lt;i&gt;&quot; + weapon.getDesc() + &quot;:&lt;/i&gt;&quot;);</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">                        for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</span>
<span class="nc" id="L1528">                            IOption adv = advs.nextElement();</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">                            if (adv.booleanValue()) {</span>
<span class="nc" id="L1530">                                tooltipString.append(&quot;&lt;BR&gt;&amp;nbsp;&quot; + adv.getDisplayableNameWithValue());</span>
                            }
<span class="nc" id="L1532">                        }</span>
                    }
<span class="nc" id="L1534">                }</span>
<span class="nc" id="L1535">            }</span>
        }

        // Add partial repairs, if activated
<span class="nc" id="L1539">        for (Enumeration&lt;IOptionGroup&gt; advGroups = entity.getPartialRepairs().getGroups(); advGroups</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">                .hasMoreElements();) {</span>
<span class="nc" id="L1541">            IOptionGroup advGroup = advGroups.nextElement();</span>
<span class="nc bnc" id="L1542" title="All 2 branches missed.">            if (entity.countPartialRepairs() &gt; 0) {</span>
<span class="nc" id="L1543">                tooltipString.append(&quot;&lt;BR&gt;&lt;i&gt;&quot; + advGroup.getDisplayableName() + &quot;:&lt;/i&gt;&lt;br&gt;&quot;);</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">                for (Enumeration&lt;IOption&gt; advs = advGroup.getOptions(); advs.hasMoreElements();) {</span>
<span class="nc" id="L1545">                    IOption adv = advs.nextElement();</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">                    if (adv.booleanValue()) {</span>
<span class="nc" id="L1547">                        tooltipString.append(&quot;&amp;nbsp;&quot; + adv.getDisplayableNameWithValue() + &quot;&lt;br&gt;&quot;);</span>
                    }
<span class="nc" id="L1549">                }</span>
            }
<span class="nc" id="L1551">        }</span>

<span class="nc" id="L1553">        tooltipString.append(&quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L1554">        return tooltipString.toString();</span>
    }

    /**
     * Refreshes the player info
     */
    public void refreshPlayerInfo() {
<span class="nc" id="L1561">        playerModel.clearData();</span>
<span class="nc bnc" id="L1562" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = clientgui.getClient().getPlayers(); i.hasMoreElements();) {</span>
<span class="nc" id="L1563">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">            if (player == null) {</span>
<span class="nc" id="L1565">                continue;</span>
            }
<span class="nc" id="L1567">            playerModel.addPlayer(player);</span>
<span class="nc" id="L1568">        }</span>
<span class="nc" id="L1569">    }</span>

    private void refreshCamos() {
<span class="nc" id="L1572">        butCamo.setIcon(getPlayerSelected().getLocalPlayer().getCamouflage().getImageIcon());</span>
<span class="nc" id="L1573">    }</span>

    /**
     * Setup the team choice box
     */
    private void setupTeams() {
<span class="nc" id="L1579">        choTeam.removeAllItems();</span>
<span class="nc bnc" id="L1580" title="All 2 branches missed.">        for (int i = 0; i &lt; IPlayer.MAX_TEAMS; i++) {</span>
<span class="nc" id="L1581">            choTeam.addItem(IPlayer.teamNames[i]);</span>
        }
<span class="nc bnc" id="L1583" title="All 2 branches missed.">        if (clientgui.getClient().getLocalPlayer() != null) {</span>
<span class="nc" id="L1584">            choTeam.setSelectedIndex(clientgui.getClient().getLocalPlayer().getTeam());</span>
        } else {
<span class="nc" id="L1586">            choTeam.setSelectedIndex(0);</span>
        }
<span class="nc" id="L1588">    }</span>

    /**
     * Highlight the team the player is playing on.
     */
    private void refreshTeams() {
<span class="nc" id="L1594">        choTeam.setSelectedIndex(clientgui.getClient().getLocalPlayer().getTeam());</span>
<span class="nc" id="L1595">    }</span>

    /**
     * Refreshes the done button. The label will say the opposite of the
     * player's &quot;done&quot; status, indicating that clicking it will reverse the
     * condition.
     */
    private void refreshDoneButton(boolean done) {
<span class="nc bnc" id="L1603" title="All 2 branches missed.">        butDone.setText(done ? Messages.getString(&quot;ChatLounge.notDone&quot;) : Messages.getString(&quot;ChatLounge.imDone&quot;));</span>
        // $NON-NLS-1$ //$NON-NLS-2$
<span class="nc" id="L1605">    }</span>

    private void refreshDoneButton() {
<span class="nc" id="L1608">        refreshDoneButton(clientgui.getClient().getLocalPlayer().isDone());</span>
<span class="nc" id="L1609">    }</span>

    /**
     * Change local player team.
     */
    private void changeTeam(int team) {
<span class="nc" id="L1615">        Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L1616" title="All 4 branches missed.">        if ((c != null) &amp;&amp; (c.getLocalPlayer().getTeam() != team)) {</span>
<span class="nc" id="L1617">            c.getLocalPlayer().setTeam(team);</span>
<span class="nc" id="L1618">            c.sendPlayerInfo();</span>

            // WIP on getting entities to be able to be loaded by teammates
<span class="nc bnc" id="L1621" title="All 2 branches missed.">            for (Entity unit : c.getGame().getPlayerEntities(c.getLocalPlayer(), false)) {</span>
                // If unit has empty bays it needs to be updated in order for
                // other entities to be able to load into it.
<span class="nc bnc" id="L1624" title="All 4 branches missed.">                if ((unit.getTransports().size() &gt; 0) &amp;&amp; (unit.getLoadedUnits().isEmpty())</span>
<span class="nc bnc" id="L1625" title="All 2 branches missed.">                        &amp;&amp; (unit.getTransportId() == Entity.NONE)) {</span>
<span class="nc" id="L1626">                    c.sendUpdateEntity(unit);</span>
                }

                // Unload this unit if its being transported.
<span class="nc bnc" id="L1630" title="All 2 branches missed.">                if (unit.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L1631">                    unloader(unit);</span>
                }
<span class="nc" id="L1633">            }</span>

            // Loop through everyone elses entities and if they no longer have a
            // legal loading, remove them.
            // I am aware this is an odd way to do it, however I couldn't get it
            // to work by looping through the
            // unit.getLoadedUnits() - it always returned with an empty list
            // even when there was loaded units.
<span class="nc bnc" id="L1641" title="All 2 branches missed.">            for (Entity unit : c.getGame().getEntitiesVector()) {</span>
<span class="nc bnc" id="L1642" title="All 2 branches missed.">                if (unit.getOwner().equals(c.getLocalPlayer())) {</span>
<span class="nc" id="L1643">                    continue;</span>
                }

<span class="nc bnc" id="L1646" title="All 2 branches missed.">                if ((unit.getTransportId() != Entity.NONE) &amp;&amp; (c.getGame().getEntity(unit.getTransportId()).getOwner()</span>
<span class="nc bnc" id="L1647" title="All 2 branches missed.">                        .getTeam() != unit.getOwner().getTeam())) {</span>
<span class="nc" id="L1648">                    unloader(unit);</span>
                }
<span class="nc" id="L1650">            }</span>
        }
<span class="nc" id="L1652">    }</span>

    /**
     * Pop up the customize mech dialog
     */

    private void customizeMech() {
<span class="nc bnc" id="L1659" title="All 2 branches missed.">        if (tableEntities.getSelectedRow() == -1) {</span>
<span class="nc" id="L1660">            return;</span>
        }
<span class="nc" id="L1662">        customizeMech(mekModel.getEntityAt(tableEntities.getSelectedRow()));</span>
<span class="nc" id="L1663">    }</span>

    /**
     * Load one unit into another in the chat lounge
     *
     * @param loadee
     *            - an Entity that should be loaded
     * @param loaderId
     *            - the id of the entity that will load
     */
    public void loader(Entity loadee, int loaderId, int bayNumber) {
<span class="nc" id="L1674">        Client c = clientgui.getBots().get(loadee.getOwner().getName());</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1676">            c = clientgui.getClient();</span>
        }
<span class="nc" id="L1678">        Entity loader = clientgui.getClient().getGame().getEntity(loaderId);</span>
<span class="nc bnc" id="L1679" title="All 2 branches missed.">        if (loader == null) {</span>
<span class="nc" id="L1680">            return;</span>
        }

        // We need to make sure our current bomb choices fit onto the new
        // fighter
<span class="nc bnc" id="L1685" title="All 2 branches missed.">        if (loader instanceof FighterSquadron) {</span>
<span class="nc" id="L1686">            FighterSquadron fSquad = (FighterSquadron) loader;</span>
            // We can't use Aero.getBombPoints() because the bombs haven't been
            // loaded yet, only selected, so we have to count the choices
<span class="nc" id="L1689">            int[] bombChoice = fSquad.getBombChoices();</span>
<span class="nc" id="L1690">            int numLoadedBombs = 0;</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">            for (int i = 0; i &lt; bombChoice.length; i++) {</span>
<span class="nc" id="L1692">                numLoadedBombs += bombChoice[i];</span>
            }
            // We can't load all of the squadrons bombs
<span class="nc bnc" id="L1695" title="All 2 branches missed.">            if (numLoadedBombs &gt; ((IBomber)loadee).getMaxBombPoints()) {</span>
<span class="nc" id="L1696">                JOptionPane.showMessageDialog(clientgui.frame, Messages.getString(&quot;FighterSquadron.bomberror&quot;),</span>
<span class="nc" id="L1697">                        Messages.getString(&quot;FighterSquadron.error&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L1698">                return;</span>
            }
        }
<span class="nc" id="L1701">        c.sendLoadEntity(loadee.getId(), loaderId, bayNumber);</span>
        // TODO: it would probably be a good idea to reset deployment
        // info to equal that of the loader, and disable it in customMechDialog
        // I tried doing this but I cant quite figure out the client/server
        // interaction in CustomMechDialog.java
<span class="nc" id="L1706">    }</span>

    /**
     * Unload a unit in the chat lounge
     *
     * @param unloadee
     *            - the Entity to be unloaded
     */
    public void unloader(Entity unloadee) {
<span class="nc" id="L1715">        Client c = clientgui.getBots().get(unloadee.getOwner().getName());</span>
<span class="nc bnc" id="L1716" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1717">            c = clientgui.getClient();</span>
        }
<span class="nc" id="L1719">        Entity unloader = clientgui.getClient().getGame().getEntity(unloadee.getTransportId());</span>
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        if (null == unloader) {</span>
<span class="nc" id="L1721">            return;</span>
        }
<span class="nc" id="L1723">        unloader.unload(unloadee);</span>
<span class="nc" id="L1724">        unloadee.setTransportId(Entity.NONE);</span>
<span class="nc" id="L1725">        c.sendUpdateEntity(unloadee);</span>
<span class="nc" id="L1726">        c.sendUpdateEntity(unloader);</span>
<span class="nc" id="L1727">    }</span>

    /**
     * swap pilots from one entity to another
     *
     * @param swapee
     *            - an Entity that should be swapped from
     * @param swapperId
     *            - the id of the entity that should be swapped to
     */
    public void swapPilots(Entity swapee, int swapperId) {
<span class="nc" id="L1738">        Client c = clientgui.getBots().get(swapee.getOwner().getName());</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1740">            c = clientgui.getClient();</span>
        }
<span class="nc" id="L1742">        Entity swapper = clientgui.getClient().getGame().getEntity(swapperId);</span>
<span class="nc bnc" id="L1743" title="All 2 branches missed.">        if (swapper == null) {</span>
<span class="nc" id="L1744">            return;</span>
        }
<span class="nc" id="L1746">        Crew temp = swapper.getCrew();</span>
<span class="nc" id="L1747">        swapper.setCrew(swapee.getCrew());</span>
<span class="nc" id="L1748">        swapee.setCrew(temp);</span>
<span class="nc" id="L1749">        c.sendUpdateEntity(swapee);</span>
<span class="nc" id="L1750">        c.sendUpdateEntity(swapper);</span>
<span class="nc" id="L1751">    }</span>

    /**
     * Change the entities controller from one player to another
     *
     * @param e
     *            - an Entity that should that will have its owner changed
     * @param player_id
     *            - the id of the player that should now own the entity
     */
    public void changeEntityOwner(Entity e, int player_id) {
<span class="nc" id="L1762">        Client c = clientgui.getBots().get(e.getOwner().getName());</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1764">            c = clientgui.getClient();</span>
        }
<span class="nc" id="L1766">        IPlayer new_owner = c.getGame().getPlayer(player_id);</span>
        // We if the unit is switching teams, we need to unload it
<span class="nc bnc" id="L1768" title="All 2 branches missed.">        if (e.getOwner().getTeam() != new_owner.getTeam()) {</span>
<span class="nc" id="L1769">            List&lt;Entity&gt; loadedUnits = e.getLoadedUnits();</span>
<span class="nc bnc" id="L1770" title="All 2 branches missed.">            for (Entity loadee : loadedUnits) {</span>
<span class="nc" id="L1771">                unloader(loadee);</span>
<span class="nc" id="L1772">            }</span>
        }
<span class="nc" id="L1774">        e.setOwner(new_owner);</span>
<span class="nc" id="L1775">        c.sendUpdateEntity(e);</span>
<span class="nc" id="L1776">    }</span>

    /**
     * Delete an entity from the lobby
     *
     * @param entity
     */
    public void delete(Entity entity) {
<span class="nc" id="L1784">        Client c = clientgui.getBots().get(entity.getOwner().getName());</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1786">            c = clientgui.getClient();</span>
        }
        // first unload any units from this unit
<span class="nc bnc" id="L1789" title="All 2 branches missed.">        if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc bnc" id="L1790" title="All 2 branches missed.">            for (Entity loaded : entity.getLoadedUnits()) {</span>
<span class="nc" id="L1791">                entity.unload(loaded);</span>
<span class="nc" id="L1792">                loaded.setTransportId(Entity.NONE);</span>
<span class="nc" id="L1793">                c.sendUpdateEntity(loaded);</span>
<span class="nc" id="L1794">            }</span>
<span class="nc" id="L1795">            c.sendUpdateEntity(entity);</span>
        }
        // unload this unit from any other units it might be loaded onto
<span class="nc bnc" id="L1798" title="All 2 branches missed.">        if (entity.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L1799">            Entity loader = clientgui.getClient().getGame().getEntity(entity.getTransportId());</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">            if (null != loader) {</span>
<span class="nc" id="L1801">                loader.unload(entity);</span>
<span class="nc" id="L1802">                entity.setTransportId(Entity.NONE);</span>
<span class="nc" id="L1803">                c.sendUpdateEntity(loader);</span>
<span class="nc" id="L1804">                c.sendUpdateEntity(entity);</span>
            }
        }
<span class="nc" id="L1807">        c.sendDeleteEntity(entity.getId());</span>
<span class="nc" id="L1808">    }</span>

    /**
     *
     * @param entities
     */
    public void customizeMechs(List&lt;Entity&gt; entities) {
        // Only call this for when selecting a valid list of entities
<span class="nc bnc" id="L1816" title="All 2 branches missed.">        if (entities.size() &lt; 1) {</span>
<span class="nc" id="L1817">            return;</span>
        }
<span class="nc" id="L1819">        Set&lt;String&gt; owners = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1820">        String ownerName = &quot;&quot;;</span>
<span class="nc" id="L1821">        int ownerId = -1;</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">        for (Entity e : entities) {</span>
<span class="nc" id="L1823">            ownerName = e.getOwner().getName();</span>
<span class="nc" id="L1824">            ownerId = e.getOwner().getId();</span>
<span class="nc" id="L1825">            owners.add(ownerName);</span>
<span class="nc" id="L1826">        }</span>

        // Error State
<span class="nc bnc" id="L1829" title="All 2 branches missed.">        if (owners.size() &gt; 1) {</span>
<span class="nc" id="L1830">            return;</span>
        }

<span class="nc bnc" id="L1833" title="All 2 branches missed.">        boolean editable = clientgui.getBots().get(ownerName) != null;</span>
        Client client;
<span class="nc bnc" id="L1835" title="All 2 branches missed.">        if (editable) {</span>
<span class="nc" id="L1836">            client = clientgui.getBots().get(ownerName);</span>
        } else {
<span class="nc bnc" id="L1838" title="All 2 branches missed.">            editable |= ownerId == clientgui.getClient().getLocalPlayer().getId();</span>
<span class="nc" id="L1839">            client = clientgui.getClient();</span>
        }

<span class="nc" id="L1842">        CustomMechDialog cmd = new CustomMechDialog(clientgui, client, entities, editable);</span>
<span class="nc" id="L1843">        cmd.setSize(new Dimension(GUIPreferences.getInstance().getCustomUnitWidth(),</span>
<span class="nc" id="L1844">                GUIPreferences.getInstance().getCustomUnitHeight()));</span>
<span class="nc" id="L1845">        cmd.setTitle(Messages.getString(&quot;ChatLounge.CustomizeUnits&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1846">        cmd.setVisible(true);</span>
<span class="nc" id="L1847">        GUIPreferences.getInstance().setCustomUnitHeight(cmd.getSize().height);</span>
<span class="nc" id="L1848">        GUIPreferences.getInstance().setCustomUnitWidth(cmd.getSize().width);</span>
<span class="nc bnc" id="L1849" title="All 4 branches missed.">        if (editable &amp;&amp; cmd.isOkay()) {</span>
            // send changes
<span class="nc bnc" id="L1851" title="All 2 branches missed.">            for (Entity entity : entities) {</span>
                // If a LAM with mechanized BA was changed to non-mech mode, unload the BA.
<span class="nc bnc" id="L1853" title="All 2 branches missed.">                if ((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L1854" title="All 2 branches missed.">                        &amp;&amp; entity.getConversionMode() != LandAirMech.CONV_MODE_MECH) {</span>
<span class="nc bnc" id="L1855" title="All 2 branches missed.">                    for (Entity loadee : entity.getLoadedUnits()) {</span>
<span class="nc" id="L1856">                        entity.unload(loadee);</span>
<span class="nc" id="L1857">                        loadee.setTransportId(Entity.NONE);</span>
<span class="nc" id="L1858">                        client.sendUpdateEntity(loadee);</span>
<span class="nc" id="L1859">                    }</span>
                }

<span class="nc" id="L1862">                client.sendUpdateEntity(entity);</span>

                // Changing state to a transporting unit can update state of
                // transported units, so update those as well
<span class="nc bnc" id="L1866" title="All 2 branches missed.">                for (Transporter transport : entity.getTransports()) {</span>
<span class="nc bnc" id="L1867" title="All 2 branches missed.">                    for (Entity loaded : transport.getLoadedUnits()) {</span>
<span class="nc" id="L1868">                        client.sendUpdateEntity(loaded);</span>
<span class="nc" id="L1869">                    }</span>
<span class="nc" id="L1870">                }</span>

                // Customizations to a Squadron can effect the fighters
<span class="nc bnc" id="L1873" title="All 2 branches missed.">                if (entity instanceof FighterSquadron) {</span>
<span class="nc" id="L1874">                    entity.getSubEntities().ifPresent(ents -&gt; ents.forEach(client::sendUpdateEntity));</span>
                }
<span class="nc" id="L1876">            }</span>
        }
<span class="nc bnc" id="L1878" title="All 4 branches missed.">        if (cmd.isOkay() &amp;&amp; (cmd.getStatus() != CustomMechDialog.DONE)) {</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">            Entity nextEnt = cmd.getNextEntity(cmd.getStatus() == CustomMechDialog.NEXT);</span>
<span class="nc" id="L1880">            customizeMech(nextEnt);</span>
        }
<span class="nc" id="L1882">    }</span>

    public void setCMDSelectedTab(String tab) {
<span class="nc" id="L1885">        cmdSelectedTab = tab;</span>
<span class="nc" id="L1886">    }</span>

    /**
     *
     * @param entity
     */
    public void customizeMech(Entity entity) {
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        boolean editable = clientgui.getBots().get(entity.getOwner().getName()) != null;</span>
        Client c;
<span class="nc bnc" id="L1895" title="All 2 branches missed.">        if (editable) {</span>
<span class="nc" id="L1896">            c = clientgui.getBots().get(entity.getOwner().getName());</span>
        } else {
<span class="nc bnc" id="L1898" title="All 2 branches missed.">            editable |= entity.getOwnerId() == clientgui.getClient().getLocalPlayer().getId();</span>
<span class="nc" id="L1899">            c = clientgui.getClient();</span>
        }
        // When we customize a single entity's C3 network setting,
        // **ALL** members of the network may get changed.
<span class="nc" id="L1903">        Entity c3master = entity.getC3Master();</span>
<span class="nc" id="L1904">        ArrayList&lt;Entity&gt; c3members = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1905">        Iterator&lt;Entity&gt; playerUnits = c.getGame().getPlayerEntities(c.getLocalPlayer(), false).iterator();</span>
<span class="nc bnc" id="L1906" title="All 2 branches missed.">        while (playerUnits.hasNext()) {</span>
<span class="nc" id="L1907">            Entity unit = playerUnits.next();</span>
<span class="nc bnc" id="L1908" title="All 4 branches missed.">            if (!entity.equals(unit) &amp;&amp; entity.onSameC3NetworkAs(unit)) {</span>
<span class="nc" id="L1909">                c3members.add(unit);</span>
            }
<span class="nc" id="L1911">        }</span>

<span class="nc" id="L1913">        boolean doneCustomizing = false;</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">        while (!doneCustomizing) {</span>
            // display dialog
<span class="nc" id="L1916">            List&lt;Entity&gt; entities = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1917">            entities.add(entity);</span>
<span class="nc" id="L1918">            CustomMechDialog cmd = new CustomMechDialog(clientgui, c, entities, editable);</span>
<span class="nc" id="L1919">            cmd.setSize(new Dimension(GUIPreferences.getInstance().getCustomUnitWidth(),</span>
<span class="nc" id="L1920">                    GUIPreferences.getInstance().getCustomUnitHeight()));</span>
<span class="nc" id="L1921">            cmd.refreshOptions();</span>
<span class="nc" id="L1922">            cmd.refreshQuirks();</span>
<span class="nc" id="L1923">            cmd.refreshPartReps();</span>
<span class="nc" id="L1924">            cmd.setTitle(entity.getShortName());</span>
<span class="nc bnc" id="L1925" title="All 2 branches missed.">            if (cmdSelectedTab != null) {</span>
<span class="nc" id="L1926">                cmd.setSelectedTab(cmdSelectedTab);</span>
            }
<span class="nc" id="L1928">            cmd.setVisible(true);</span>
<span class="nc" id="L1929">            GUIPreferences.getInstance().setCustomUnitHeight(cmd.getSize().height);</span>
<span class="nc" id="L1930">            GUIPreferences.getInstance().setCustomUnitWidth(cmd.getSize().width);</span>
<span class="nc" id="L1931">            cmdSelectedTab = cmd.getSelectedTab();</span>
<span class="nc bnc" id="L1932" title="All 4 branches missed.">            if (editable &amp;&amp; cmd.isOkay()) {</span>
                // If a LAM with mechanized BA was changed to non-mech mode, unload the BA.
<span class="nc bnc" id="L1934" title="All 2 branches missed.">                if ((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L1935" title="All 2 branches missed.">                        &amp;&amp; entity.getConversionMode() != LandAirMech.CONV_MODE_MECH) {</span>
<span class="nc bnc" id="L1936" title="All 2 branches missed.">                    for (Entity loadee : entity.getLoadedUnits()) {</span>
<span class="nc" id="L1937">                        entity.unload(loadee);</span>
<span class="nc" id="L1938">                        loadee.setTransportId(Entity.NONE);</span>
<span class="nc" id="L1939">                        c.sendUpdateEntity(loadee);</span>
<span class="nc" id="L1940">                    }</span>
                }

                // send changes
<span class="nc" id="L1944">                c.sendUpdateEntity(entity);</span>

                // Changing state to a transporting unit can update state of
                // transported units, so update those as well
<span class="nc bnc" id="L1948" title="All 2 branches missed.">                for (Transporter transport : entity.getTransports()) {</span>
<span class="nc bnc" id="L1949" title="All 2 branches missed.">                    for (Entity loaded : transport.getLoadedUnits()) {</span>
<span class="nc" id="L1950">                        c.sendUpdateEntity(loaded);</span>
<span class="nc" id="L1951">                    }</span>
<span class="nc" id="L1952">                }</span>

                // Customizations to a Squadron can effect the fighters
<span class="nc bnc" id="L1955" title="All 2 branches missed.">                if (entity instanceof FighterSquadron) {</span>
<span class="nc" id="L1956">                    entity.getSubEntities().ifPresent(ents -&gt; ents.forEach(c::sendUpdateEntity));</span>
                }

                // Do we need to update the members of our C3 network?
<span class="nc bnc" id="L1960" title="All 6 branches missed.">                if (((c3master != null) &amp;&amp; !c3master.equals(entity.getC3Master()))</span>
<span class="nc bnc" id="L1961" title="All 2 branches missed.">                        || ((c3master == null) &amp;&amp; (entity.getC3Master() != null))) {</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">                    for (Entity unit : c3members) {</span>
<span class="nc" id="L1963">                        c.sendUpdateEntity(unit);</span>
<span class="nc" id="L1964">                    }</span>
                }
            }
<span class="nc bnc" id="L1967" title="All 4 branches missed.">            if (cmd.isOkay() &amp;&amp; (cmd.getStatus() != CustomMechDialog.DONE)) {</span>
<span class="nc bnc" id="L1968" title="All 2 branches missed.">                entity = cmd.getNextEntity(cmd.getStatus() == CustomMechDialog.NEXT);</span>
            } else {
<span class="nc" id="L1970">                doneCustomizing = true;</span>
            }
<span class="nc" id="L1972">        }</span>
<span class="nc" id="L1973">    }</span>

    /** 
     * Displays a CamoChooserDialog to choose an individual camo for
     * the given vector of entities. The camo will only be applied
     * to units configurable by the local player, i.e. his own units
     * or those of his bots.
     */
    public void mechCamo(Vector&lt;Entity&gt; entities) {
<span class="nc bnc" id="L1982" title="All 2 branches missed.">        if (entities.size() &lt; 1) {</span>
<span class="nc" id="L1983">            return;</span>
        }

<span class="nc" id="L1986">        final Entity entity = entities.get(0);</span>
        // Display the CamoChooserDialog and await the result
        // The dialog is preset to the first selected unit's settings
<span class="nc" id="L1989">        CamoChooserDialog ccd = new CamoChooserDialog(clientgui.getFrame(),</span>
<span class="nc" id="L1990">                entity.getCamouflageOrElse(entity.getOwner().getCamouflage()), true);</span>

        // If the dialog was canceled or nothing was selected, do nothing
<span class="nc bnc" id="L1993" title="All 4 branches missed.">        if ((ccd.showDialog() == JOptionPane.CANCEL_OPTION) || (ccd.getSelectedItem() == null)) {</span>
<span class="nc" id="L1994">            return;</span>
        }

        // Choosing the player camouflage resets the units to have no individual camouflage.
<span class="nc" id="L1998">        final Camouflage selectedItem = ccd.getSelectedItem();</span>
<span class="nc" id="L1999">        final boolean noIndividualCamo = selectedItem.equals(entity.getOwner().getCamouflage());</span>
        // Update all allowed entities with the camouflage
<span class="nc bnc" id="L2001" title="All 2 branches missed.">        for (Entity ent : entities) {</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">            if (isEditable(ent)) {</span>
<span class="nc bnc" id="L2003" title="All 2 branches missed.">                ent.setCamouflage(noIndividualCamo ? new Camouflage() : selectedItem.clone());</span>
<span class="nc" id="L2004">                getLocalClient(ent).sendUpdateEntity(ent);</span>
            }
<span class="nc" id="L2006">        }</span>
<span class="nc" id="L2007">    }</span>
    
    /** 
     * Returns true when the given entity may be configured
     * by the local player, i.e. if it is his own unit or one
     * of his bot's units.
     */
    private boolean isEditable(Entity entity) {
<span class="nc bnc" id="L2015" title="All 2 branches missed.">        return clientgui.getBots().containsKey(entity.getOwner().getName())</span>
<span class="nc bnc" id="L2016" title="All 2 branches missed.">                || (entity.getOwnerId() == clientgui.getClient().getLocalPlayer().getId());</span>
    }
    
    /** 
     * Returns the Client associated with a given entity that may be configured
     * by the local player (his own unit or one of his bot's units).
     */
    private Client getLocalClient(Entity entity) {
<span class="nc bnc" id="L2024" title="All 2 branches missed.">        if (clientgui.getBots().containsKey(entity.getOwner().getName())) {</span>
<span class="nc" id="L2025">            return clientgui.getBots().get(entity.getOwner().getName());</span>
        } else {
<span class="nc" id="L2027">            return clientgui.getClient();</span>
        }
    }

    public void mechEdit(Entity entity) {
<span class="nc bnc" id="L2032" title="All 2 branches missed.">        boolean editable = clientgui.getBots().get(entity.getOwner().getName()) != null;</span>
        Client c;
<span class="nc bnc" id="L2034" title="All 2 branches missed.">        if (editable) {</span>
<span class="nc" id="L2035">            c = clientgui.getBots().get(entity.getOwner().getName());</span>
        } else {
<span class="nc bnc" id="L2037" title="All 2 branches missed.">            editable |= entity.getOwnerId() == clientgui.getClient().getLocalPlayer().getId();</span>
<span class="nc" id="L2038">            c = clientgui.getClient();</span>
        }

        // display dialog
<span class="nc" id="L2042">        UnitEditorDialog med = new UnitEditorDialog(clientgui.getFrame(), entity);</span>
        // med.setPlayer(c.getLocalPlayer());
<span class="nc" id="L2044">        med.setVisible(true);</span>
<span class="nc" id="L2045">        c.sendUpdateEntity(entity);</span>
        /*
         * if (editable &amp;&amp; med.isSelect()) { // send changes
         * c.sendUpdateEntity(entity); }
         */
<span class="nc" id="L2050">    }</span>

    public void customizePlayer() {
<span class="nc" id="L2053">        Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2054" title="All 2 branches missed.">        if (null != c) {</span>
<span class="nc" id="L2055">            PlayerSettingsDialog psd = new PlayerSettingsDialog(clientgui, c);</span>
<span class="nc" id="L2056">            psd.setVisible(true);</span>
        }
<span class="nc" id="L2058">    }</span>

    /**
     * Pop up the view mech dialog
     */
    public void mechReadout(Entity entity) {
<span class="nc" id="L2064">        final JDialog dialog = new JDialog(clientgui.frame, Messages.getString(&quot;ChatLounge.quickView&quot;), false); //$NON-NLS-1$</span>
<span class="nc" id="L2065">        dialog.addKeyListener(new KeyAdapter() {</span>
            @Override
            public void keyPressed(KeyEvent e) {
<span class="nc" id="L2068">                int code = e.getKeyCode();</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">                if (code == KeyEvent.VK_SPACE) {</span>
<span class="nc" id="L2070">                    e.consume();</span>
<span class="nc" id="L2071">                    dialog.setVisible(false);</span>
<span class="nc bnc" id="L2072" title="All 2 branches missed.">                } else if (code == KeyEvent.VK_ENTER) {</span>
<span class="nc" id="L2073">                    e.consume();</span>
<span class="nc" id="L2074">                    dialog.setVisible(false);</span>
                }
<span class="nc" id="L2076">            }</span>
        });
        // FIXME: this isn't working right, but is necessary for the key
        // listener to work right
        // dialog.setFocusable(true);
<span class="nc" id="L2081">        dialog.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L2084">                dialog.setVisible(false);</span>
<span class="nc" id="L2085">            }</span>
        });
<span class="nc" id="L2087">        MechViewPanel mvp = new MechViewPanel();</span>
<span class="nc" id="L2088">        mvp.setMech(entity);</span>
<span class="nc" id="L2089">        JButton btn = new JButton(Messages.getString(&quot;Okay&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L2090">        btn.addActionListener(e -&gt; dialog.setVisible(false));</span>

<span class="nc" id="L2092">        dialog.getContentPane().setLayout(new GridBagLayout());</span>
        GridBagConstraints c;

<span class="nc" id="L2095">        c = new GridBagConstraints();</span>
<span class="nc" id="L2096">        c.gridx = 0;</span>
<span class="nc" id="L2097">        c.gridy = 0;</span>
<span class="nc" id="L2098">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2099">        c.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L2100">        c.weightx = 1.0;</span>
<span class="nc" id="L2101">        c.weighty = 1.0;</span>
<span class="nc" id="L2102">        dialog.getContentPane().add(mvp, c);</span>

<span class="nc" id="L2104">        c = new GridBagConstraints();</span>
<span class="nc" id="L2105">        c.gridx = 0;</span>
<span class="nc" id="L2106">        c.gridy = 1;</span>
<span class="nc" id="L2107">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L2108">        c.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L2109">        c.weightx = 0.0;</span>
<span class="nc" id="L2110">        c.weighty = 0.0;</span>
<span class="nc" id="L2111">        dialog.getContentPane().add(btn, c);</span>
<span class="nc" id="L2112">        dialog.setSize(mvp.getBestWidth(), mvp.getBestHeight() + 75);</span>
<span class="nc" id="L2113">        dialog.validate();</span>
<span class="nc" id="L2114">        dialog.setVisible(true);</span>
<span class="nc" id="L2115">    }</span>

    /**
     * @param entity the entity to display the BV Calculation for
     */
    public void mechBVDisplay(Entity entity) {
<span class="nc" id="L2121">        final JDialog dialog = new JDialog(clientgui.frame, &quot;BV Calculation Display&quot;, false);</span>
<span class="nc" id="L2122">        dialog.getContentPane().setLayout(new GridBagLayout());</span>

<span class="nc" id="L2124">        final int width = 500;</span>
<span class="nc" id="L2125">        final int height = 400;</span>
<span class="nc" id="L2126">        Dimension size = new Dimension(width, height);</span>

<span class="nc" id="L2128">        JEditorPane tEditorPane = new JEditorPane();</span>
<span class="nc" id="L2129">        tEditorPane.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L2130">        tEditorPane.setEditable(false);</span>
<span class="nc" id="L2131">        tEditorPane.setBorder(null);</span>
<span class="nc" id="L2132">        entity.calculateBattleValue();</span>
<span class="nc" id="L2133">        tEditorPane.setText(entity.getBVText());</span>
<span class="nc" id="L2134">        tEditorPane.setCaretPosition(0);</span>

<span class="nc" id="L2136">        JScrollPane tScroll = new JScrollPane(tEditorPane,</span>
                JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED,
                JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L2139">        tScroll.setBorder(null);</span>
<span class="nc" id="L2140">        tScroll.setPreferredSize(size);</span>
<span class="nc" id="L2141">        tScroll.setMinimumSize(size);</span>

<span class="nc" id="L2143">        GridBagConstraints gridBagConstraints = new GridBagConstraints();</span>
<span class="nc" id="L2144">        gridBagConstraints.gridx = 0;</span>
<span class="nc" id="L2145">        gridBagConstraints.gridy = 0;</span>
<span class="nc" id="L2146">        gridBagConstraints.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2147">        gridBagConstraints.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L2148">        gridBagConstraints.weightx = 0.0;</span>
<span class="nc" id="L2149">        gridBagConstraints.weighty = 1.0;</span>
<span class="nc" id="L2150">        dialog.getContentPane().add(tScroll, gridBagConstraints);</span>

<span class="nc" id="L2152">        JButton button = new JButton(Messages.getString(&quot;Okay&quot;));</span>
<span class="nc" id="L2153">        button.addActionListener(e -&gt; dialog.setVisible(false));</span>
<span class="nc" id="L2154">        gridBagConstraints.gridy = 1;</span>
<span class="nc" id="L2155">        gridBagConstraints.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L2156">        gridBagConstraints.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L2157">        gridBagConstraints.weighty = 0.0;</span>
<span class="nc" id="L2158">        dialog.getContentPane().add(button, gridBagConstraints);</span>

<span class="nc" id="L2160">        dialog.setSize(new Dimension(width + 25, height + 75));</span>
<span class="nc" id="L2161">        dialog.validate();</span>
<span class="nc" id="L2162">        dialog.setVisible(true);</span>
<span class="nc" id="L2163">    }</span>

    /**
     * Pop up the dialog to load a mech
     */
    private void loadMech() {
<span class="nc" id="L2169">        clientgui.getMechSelectorDialog().updateOptionValues();</span>
<span class="nc" id="L2170">        clientgui.getMechSelectorDialog().setVisible(true);</span>
<span class="nc" id="L2171">    }</span>

    public void loadFS(Vector&lt;Integer&gt; fighterIds) {
<span class="nc" id="L2174">        String name = JOptionPane.showInputDialog(clientgui.frame, &quot;Choose a squadron designation&quot;);</span>
<span class="nc bnc" id="L2175" title="All 4 branches missed.">        if ((name == null) || (name.trim().length() == 0)) {</span>
<span class="nc" id="L2176">            name = &quot;Flying Circus&quot;;</span>
        }
<span class="nc" id="L2178">        FighterSquadron fs = new FighterSquadron(name);</span>
<span class="nc" id="L2179">        fs.setOwner(clientgui.getClient().getGame().getEntity(fighterIds.firstElement()).getOwner());</span>
<span class="nc" id="L2180">        clientgui.getClient().sendAddSquadron(fs, fighterIds);</span>
<span class="nc" id="L2181">    }</span>

    private void loadArmy() {
<span class="nc" id="L2184">        clientgui.getRandomArmyDialog().setVisible(true);</span>
<span class="nc" id="L2185">    }</span>

    public void loadRandomSkills() {
<span class="nc" id="L2188">        clientgui.getRandomSkillDialog().showDialog(clientgui.getClient().getGame().getEntitiesVector());</span>
<span class="nc" id="L2189">    }</span>

    public void loadRandomNames() {
<span class="nc" id="L2192">        clientgui.getRandomNameDialog().showDialog(clientgui.getClient().getGame().getEntitiesVector());</span>
<span class="nc" id="L2193">    }</span>

    /**
     * Changes all selected boards to be the specified board
     */
    private void changeMap(String board) {
<span class="nc" id="L2199">        int[] selected = lisBoardsSelected.getSelectedIndices();</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">        for (final int newVar : selected) {</span>
<span class="nc" id="L2201">            String name = board;</span>
<span class="nc bnc" id="L2202" title="All 4 branches missed.">            if (!MapSettings.BOARD_RANDOM.equals(name) &amp;&amp; !MapSettings.BOARD_SURPRISE.equals(name)</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                    &amp;&amp; chkRotateBoard.isSelected()) {</span>
<span class="nc" id="L2204">                name = Board.BOARD_REQUEST_ROTATION + name;</span>
            }

            // Validate the map
<span class="nc" id="L2208">            IBoard b = new Board(16, 17);</span>
<span class="nc bnc" id="L2209" title="All 4 branches missed.">            if (!MapSettings.BOARD_GENERATED.equals(board) &amp;&amp; !MapSettings.BOARD_RANDOM.equals(board)</span>
<span class="nc bnc" id="L2210" title="All 2 branches missed.">                    &amp;&amp; !MapSettings.BOARD_SURPRISE.equals(board)) {</span>
<span class="nc" id="L2211">                b.load(new MegaMekFile(Configuration.boardsDir(), board + &quot;.board&quot;).getFile());</span>
<span class="nc bnc" id="L2212" title="All 2 branches missed.">                if (!b.isValid()) {</span>
<span class="nc" id="L2213">                    JOptionPane.showMessageDialog(this, &quot;The Selected board is invalid, please select another.&quot;);</span>
<span class="nc" id="L2214">                    return;</span>
                }
            }
<span class="nc" id="L2217">            ((DefaultListModel&lt;String&gt;) lisBoardsSelected.getModel()).setElementAt(newVar + &quot;: &quot; + name, newVar); //$NON-NLS-1$</span>
<span class="nc" id="L2218">            mapSettings.getBoardsSelectedVector().set(newVar, name);</span>
        }
<span class="nc" id="L2220">        lisBoardsSelected.setSelectedIndices(selected);</span>
<span class="nc" id="L2221">        clientgui.getClient().sendMapSettings(mapSettings);</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">        if (boardPreviewW.isVisible()) {</span>
<span class="nc" id="L2223">            previewGameBoard();</span>
        }
<span class="nc" id="L2225">    }</span>

    //
    // GameListener
    //
    @Override
    public void gamePlayerChange(GamePlayerChangeEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L2233" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2234">            return;</span>
        }
<span class="nc" id="L2236">        refreshDoneButton();</span>
<span class="nc" id="L2237">        clientgui.getClient().getGame().setupTeams();</span>
<span class="nc" id="L2238">        refreshPlayerInfo();</span>
<span class="nc" id="L2239">        refreshEntities();</span>
<span class="nc" id="L2240">    }</span>

    @Override
    public void gamePhaseChange(GamePhaseChangeEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L2245" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2246">            return;</span>
        }
<span class="nc bnc" id="L2248" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L2249">            refreshDoneButton();</span>
<span class="nc" id="L2250">            refreshGameSettings();</span>
<span class="nc" id="L2251">            refreshPlayerInfo();</span>
<span class="nc" id="L2252">            refreshTeams();</span>
<span class="nc" id="L2253">            refreshCamos();</span>
<span class="nc" id="L2254">            refreshEntities();</span>
        }
<span class="nc" id="L2256">    }</span>

    @Override
    public void gameEntityNew(GameEntityNewEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L2261" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2262">            return;</span>
        }
<span class="nc" id="L2264">        refreshEntities();</span>
<span class="nc" id="L2265">        refreshPlayerInfo();</span>
<span class="nc" id="L2266">    }</span>

    @Override
    public void gameEntityRemove(GameEntityRemoveEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L2271" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2272">            return;</span>
        }
<span class="nc" id="L2274">        refreshEntities();</span>
<span class="nc" id="L2275">        refreshPlayerInfo();</span>
<span class="nc" id="L2276">    }</span>

    @Override
    public void gameSettingsChange(GameSettingsChangeEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L2281" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2282">            return;</span>
        }
<span class="nc" id="L2284">        refreshGameSettings();</span>
<span class="nc" id="L2285">        refreshEntities();</span>
<span class="nc" id="L2286">        refreshPlayerInfo();</span>
<span class="nc" id="L2287">        setupMapSizes();</span>
<span class="nc" id="L2288">    }</span>

    @Override
    public void gameClientFeedbackRequest(GameCFREvent evt) {
        // Do nothing
<span class="nc" id="L2293">    }</span>

    /*
     * NOTE: On linux, this gets called even when programatically updating the
     * list box selected item. Do not let this go into an infinite loop. Do not
     * update the selected item (even indirectly, by sending player info) if it
     * is already selected.
     */
    @Override
    public void itemStateChanged(ItemEvent ev) {

        // Are we ignoring events?
<span class="nc bnc" id="L2305" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2306">            return;</span>
        }

<span class="nc bnc" id="L2309" title="All 2 branches missed.">        if (ev.getSource().equals(choTeam)) {</span>
<span class="nc" id="L2310">            changeTeam(choTeam.getSelectedIndex());</span>
        }
<span class="nc" id="L2312">    }</span>

    //
    // ActionListener
    //
    @Override
    public void actionPerformed(ActionEvent ev) {

        // Are we ignoring events?
<span class="nc bnc" id="L2321" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L2322">            return;</span>
        }

<span class="nc bnc" id="L2325" title="All 2 branches missed.">        if (ev.getSource().equals(butLoad)) {</span>
<span class="nc" id="L2326">            loadMech();</span>
<span class="nc bnc" id="L2327" title="All 2 branches missed.">        } else if (ev.getSource().equals(butArmy)) {</span>
<span class="nc" id="L2328">            loadArmy();</span>
<span class="nc bnc" id="L2329" title="All 2 branches missed.">        } else if (ev.getSource().equals(butSkills)) {</span>
<span class="nc" id="L2330">            loadRandomSkills();</span>
<span class="nc bnc" id="L2331" title="All 2 branches missed.">        } else if (ev.getSource().equals(butNames)) {</span>
<span class="nc" id="L2332">            loadRandomNames();</span>
<span class="nc bnc" id="L2333" title="All 2 branches missed.">        } else if (ev.getSource().equals(tableEntities)) {</span>
<span class="nc" id="L2334">            customizeMech();</span>
<span class="nc bnc" id="L2335" title="All 2 branches missed.">        } else if (ev.getSource().equals(tablePlayers)) {</span>
<span class="nc" id="L2336">            customizePlayer();</span>
<span class="nc bnc" id="L2337" title="All 2 branches missed.">        } else if (ev.getSource().equals(butDeleteAll)) {</span>
            // Build a Vector of this player's entities.
<span class="nc" id="L2339">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2340" title="All 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L2341">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</span>
<span class="nc" id="L2342">                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2343">                return;</span>
            }
<span class="nc" id="L2345">            clientgui.deleteAllUnits(c);</span>
<span class="nc bnc" id="L2346" title="All 2 branches missed.">        } else if (ev.getSource().equals(butOptions)) {</span>
            // Make sure the game options dialog is editable.
<span class="nc bnc" id="L2348" title="All 2 branches missed.">            if (!clientgui.getGameOptionsDialog().isEditable()) {</span>
<span class="nc" id="L2349">                clientgui.getGameOptionsDialog().setEditable(true);</span>
            }
            // Display the game options dialog.
<span class="nc" id="L2352">            clientgui.getGameOptionsDialog().update(clientgui.getClient().getGame().getOptions());</span>
<span class="nc" id="L2353">            clientgui.getGameOptionsDialog().setVisible(true);</span>
<span class="nc bnc" id="L2354" title="All 2 branches missed.">        } else if (ev.getSource().equals(butCompact)) {</span>
<span class="nc bnc" id="L2355" title="All 2 branches missed.">            if (butCompact.isSelected()) {</span>
<span class="nc" id="L2356">                tableEntities.setRowHeight(15);</span>
            } else {
<span class="nc" id="L2358">                tableEntities.setRowHeight(80);</span>
            }
<span class="nc" id="L2360">            refreshEntities();</span>
<span class="nc bnc" id="L2361" title="All 2 branches missed.">        } else if (ev.getSource().equals(butChangeStart)) {</span>
<span class="nc" id="L2362">            clientgui.getStartingPositionDialog().update();</span>
<span class="nc" id="L2363">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L2365">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</span>
<span class="nc" id="L2366">                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2367">                return;</span>
            }
<span class="nc" id="L2369">            clientgui.getStartingPositionDialog().setClient(c);</span>
<span class="nc" id="L2370">            clientgui.getStartingPositionDialog().setVisible(true);</span>
<span class="nc bnc" id="L2371" title="All 2 branches missed.">        } else if (ev.getSource().equals(butLoadList)) {</span>
            // Allow the player to replace their current
            // list of entities with a list from a file.
<span class="nc" id="L2374">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2375" title="All 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L2376">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</span>
<span class="nc" id="L2377">                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2378">                return;</span>
            }
<span class="nc" id="L2380">            clientgui.loadListFile(c.getLocalPlayer());</span>
<span class="nc bnc" id="L2381" title="All 2 branches missed.">        } else if (ev.getSource().equals(butSaveList)) {</span>
            // Allow the player to save their current
            // list of entities to a file.
<span class="nc" id="L2384">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2385" title="All 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L2386">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</span>
<span class="nc" id="L2387">                        Messages.getString(&quot;ChatLounge.SelectBotOrPlayer&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2388">                return;</span>
            }
<span class="nc" id="L2390">            clientgui.saveListFile(c.getGame().getPlayerEntities(c.getLocalPlayer(), false),</span>
<span class="nc" id="L2391">                    c.getLocalPlayer().getName());</span>
<span class="nc bnc" id="L2392" title="All 2 branches missed.">        } else if (ev.getSource().equals(butAddBot)) {</span>
<span class="nc" id="L2393">            BotConfigDialog bcd = new BotConfigDialog(clientgui.frame);</span>
<span class="nc" id="L2394">            bcd.setVisible(true);</span>
<span class="nc bnc" id="L2395" title="All 2 branches missed.">            if (bcd.dialogAborted) {</span>
<span class="nc" id="L2396">                return; // user didn't click 'ok', add no bot</span>
            }
<span class="nc bnc" id="L2398" title="All 2 branches missed.">            if (clientgui.getBots().containsKey(bcd.getBotName())) {</span>
<span class="nc" id="L2399">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.AlertExistsBot.title&quot;),</span>
<span class="nc" id="L2400">                        Messages.getString(&quot;ChatLounge.AlertExistsBot.message&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
            } else {
<span class="nc" id="L2402">                BotClient c = bcd.getSelectedBot(clientgui.getClient().getHost(), clientgui.getClient().getPort());</span>
<span class="nc" id="L2403">                c.setClientGUI(clientgui);</span>
<span class="nc" id="L2404">                c.getGame().addGameListener(new BotGUI(c));</span>
                try {
<span class="nc" id="L2406">                    c.connect();</span>
<span class="nc" id="L2407">                } catch (Exception e) {</span>
<span class="nc" id="L2408">                    clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.AlertBot.title&quot;),</span>
<span class="nc" id="L2409">                            Messages.getString(&quot;ChatLounge.AlertBot.message&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2410">                }</span>
<span class="nc" id="L2411">                clientgui.getBots().put(bcd.getBotName(), c);</span>
            }
<span class="nc bnc" id="L2413" title="All 2 branches missed.">        } else if (ev.getSource().equals(butRemoveBot)) {</span>
<span class="nc" id="L2414">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2415" title="All 4 branches missed.">            if ((c == null) || c.equals(clientgui.getClient())) {</span>
<span class="nc" id="L2416">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ImproperCommand&quot;),</span>
<span class="nc" id="L2417">                        Messages.getString(&quot;ChatLounge.SelectBo&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2418">                return;</span>
            }
<span class="nc" id="L2420">            c.die();</span>
<span class="nc" id="L2421">            clientgui.getBots().remove(c.getName());</span>
<span class="nc bnc" id="L2422" title="All 2 branches missed.">        } else if (ev.getSource() == butConditions) {</span>
<span class="nc" id="L2423">            clientgui.getPlanetaryConditionsDialog().update(clientgui.getClient().getGame().getPlanetaryConditions());</span>
<span class="nc" id="L2424">            clientgui.getPlanetaryConditionsDialog().setVisible(true);</span>
<span class="nc bnc" id="L2425" title="All 2 branches missed.">        } else if (ev.getSource() == butRandomMap) {</span>
<span class="nc" id="L2426">            RandomMapDialog rmd = new RandomMapDialog(clientgui.frame, this, clientgui.getClient(), mapSettings);</span>
<span class="nc" id="L2427">            rmd.activateDialog(clientgui.getBoardView().getTilesetManager().getThemes());</span>
<span class="nc bnc" id="L2428" title="All 2 branches missed.">        } else if (ev.getSource().equals(butChange)) {</span>
<span class="nc bnc" id="L2429" title="All 2 branches missed.">            if (lisBoardsAvailable.getSelectedIndex() != -1) {</span>
<span class="nc" id="L2430">                changeMap(lisBoardsAvailable.getSelectedValue());</span>
<span class="nc" id="L2431">                lisBoardsSelected.setSelectedIndex(lisBoardsSelected.getSelectedIndex() + 1);</span>
            }
<span class="nc bnc" id="L2433" title="All 2 branches missed.">        } else if (ev.getSource().equals(buttonBoardPreview)) {</span>
<span class="nc" id="L2434">            previewGameBoard();</span>
<span class="nc bnc" id="L2435" title="All 4 branches missed.">        } else if (ev.getSource().equals(butMapSize) || ev.getSource().equals(butSpaceSize)) {</span>
<span class="nc" id="L2436">            MapDimensionsDialog mdd = new MapDimensionsDialog(clientgui, mapSettings);</span>
<span class="nc" id="L2437">            mdd.setVisible(true);</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">        } else if (ev.getSource().equals(comboMapSizes)) {</span>
<span class="nc bnc" id="L2439" title="All 2 branches missed.">            if ((comboMapSizes.getSelectedItem() != null)</span>
<span class="nc bnc" id="L2440" title="All 2 branches missed.">                    &amp;&amp; !comboMapSizes.getSelectedItem().equals(Messages.getString(&quot;ChatLounge.CustomMapSize&quot;))) {</span>
<span class="nc" id="L2441">                BoardDimensions size = (BoardDimensions) comboMapSizes.getSelectedItem();</span>
<span class="nc" id="L2442">                mapSettings.setBoardSize(size.width(), size.height());</span>
<span class="nc" id="L2443">                resetAvailBoardSelection = true;</span>
<span class="nc" id="L2444">                resetSelectedBoards = true;</span>
<span class="nc" id="L2445">                clientgui.getClient().sendMapSettings(mapSettings);</span>
<span class="nc" id="L2446">            }</span>
<span class="nc bnc" id="L2447" title="All 4 branches missed.">        } else if (ev.getSource().equals(chkRotateBoard) &amp;&amp; (lisBoardsAvailable.getSelectedIndex() != -1)) {</span>
<span class="nc" id="L2448">            previewMapsheet();</span>
<span class="nc bnc" id="L2449" title="All 2 branches missed.">        } else if (ev.getSource().equals(comboMapType)) {</span>
<span class="nc" id="L2450">            mapSettings.setMedium(comboMapType.getSelectedIndex());</span>
<span class="nc" id="L2451">            clientgui.getClient().sendMapSettings(mapSettings);</span>
<span class="nc bnc" id="L2452" title="All 2 branches missed.">        } else if (ev.getSource().equals(chkIncludeGround)) {</span>
<span class="nc bnc" id="L2453" title="All 2 branches missed.">            if (chkIncludeGround.isSelected()) {</span>
<span class="nc" id="L2454">                mapSettings.setMedium(comboMapType.getSelectedIndex());</span>
            } else {
<span class="nc" id="L2456">                mapSettings.setMedium(MapSettings.MEDIUM_SPACE);</span>
                // set default size for space maps
<span class="nc" id="L2458">                mapSettings.setBoardSize(50, 50);</span>
<span class="nc" id="L2459">                mapSettings.setMapSize(1, 1);</span>
            }
<span class="nc" id="L2461">            clientgui.getClient().sendMapDimensions(mapSettings);</span>
<span class="nc bnc" id="L2462" title="All 2 branches missed.">        } else if (ev.getSource().equals(chkIncludeSpace)) {</span>
<span class="nc bnc" id="L2463" title="All 2 branches missed.">            if (chkIncludeSpace.isSelected()) {</span>
<span class="nc" id="L2464">                mapSettings.setMedium(MapSettings.MEDIUM_SPACE);</span>
                // set default size for space maps
<span class="nc" id="L2466">                mapSettings.setBoardSize(50, 50);</span>
<span class="nc" id="L2467">                mapSettings.setMapSize(1, 1);</span>
            } else {
<span class="nc" id="L2469">                mapSettings.setMedium(comboMapType.getSelectedIndex());</span>
            }
<span class="nc" id="L2471">            clientgui.getClient().sendMapDimensions(mapSettings);</span>
        }
<span class="nc" id="L2473">    }</span>

    @Override
    public void mouseClicked(MouseEvent arg0) {
<span class="nc bnc" id="L2477" title="All 4 branches missed.">        if ((arg0.getClickCount() == 1) &amp;&amp; arg0.getSource().equals(lisBoardsAvailable)) {</span>
<span class="nc" id="L2478">            previewMapsheet();</span>
        }
<span class="nc bnc" id="L2480" title="All 4 branches missed.">        if ((arg0.getClickCount() == 2) &amp;&amp; arg0.getSource().equals(lisBoardsAvailable)) {</span>
<span class="nc bnc" id="L2481" title="All 2 branches missed.">            if (lisBoardsAvailable.getSelectedIndex() != -1) {</span>
<span class="nc" id="L2482">                changeMap(lisBoardsAvailable.getSelectedValue());</span>
            }
        }
<span class="nc" id="L2485">    }</span>

    @Override
    public void mouseEntered(MouseEvent arg0) {
        // ignore
<span class="nc" id="L2490">    }</span>

    @Override
    public void mouseExited(MouseEvent arg0) {
        // ignore
<span class="nc" id="L2495">    }</span>

    @Override
    public void mousePressed(MouseEvent arg0) {
        // ignore
<span class="nc" id="L2500">    }</span>

    @Override
    public void mouseReleased(MouseEvent arg0) {
        // ignore
<span class="nc" id="L2505">    }</span>

    /**
     * Updates to show the map settings that have, presumably, just been sent by
     * the server.
     */
    @Override
    public void updateMapSettings(MapSettings newSettings) {
<span class="nc" id="L2513">        mapSettings = MapSettings.getInstance(newSettings);</span>
<span class="nc" id="L2514">        refreshMapButtons();</span>
<span class="nc" id="L2515">        refreshMapChoice();</span>
<span class="nc" id="L2516">        refreshSpaceGround();</span>
<span class="nc" id="L2517">        refreshBoardsSelected();</span>
<span class="nc" id="L2518">        refreshBoardsAvailable();</span>
<span class="nc" id="L2519">        refreshMapSummaryLabel();</span>
<span class="nc" id="L2520">        refreshGameYearLabel();</span>
<span class="nc" id="L2521">        refreshTechLevelLabel();</span>
<span class="nc" id="L2522">    }</span>

    public void refreshMapSummaryLabel() {
<span class="nc" id="L2525">        String txt = Messages.getString(&quot;ChatLounge.MapSummary&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2526">        txt = txt + &quot; &quot; //$NON-NLS-1$</span>
<span class="nc" id="L2527">                + (mapSettings.getBoardWidth() * mapSettings.getMapWidth()) + &quot; x &quot; //$NON-NLS-1$</span>
<span class="nc" id="L2528">                + (mapSettings.getBoardHeight() * mapSettings.getMapHeight());</span>
<span class="nc bnc" id="L2529" title="All 2 branches missed.">        if (chkIncludeGround.isSelected()) {</span>
<span class="nc" id="L2530">            txt = txt + &quot; &quot; + comboMapType.getSelectedItem();</span>
        } else {
<span class="nc" id="L2532">            txt = txt + &quot; &quot; + &quot;Space Map&quot;; //$NON-NLS-1$</span>
        }
<span class="nc" id="L2534">        lblMapSummary.setText(txt);</span>

<span class="nc" id="L2536">        StringBuilder selectedMaps = new StringBuilder();</span>
<span class="nc" id="L2537">        selectedMaps.append(&quot;&lt;html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2538">        selectedMaps.append(Messages.getString(&quot;ChatLounge.MapSummarySelectedMaps&quot;));</span>
<span class="nc" id="L2539">        selectedMaps.append(&quot;&lt;br&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2540">        ListModel&lt;String&gt; model = lisBoardsSelected.getModel();</span>
<span class="nc bnc" id="L2541" title="All 2 branches missed.">        for (int i = 0; i &lt; model.getSize(); i++) {</span>
<span class="nc" id="L2542">            String map = model.getElementAt(i);</span>
<span class="nc" id="L2543">            selectedMaps.append(map);</span>
<span class="nc bnc" id="L2544" title="All 2 branches missed.">            if ((i + 1) &lt; model.getSize()) {</span>
<span class="nc" id="L2545">                selectedMaps.append(&quot;&lt;br&gt;&quot;); //$NON-NLS-1$</span>
            }
        }
<span class="nc" id="L2548">        lblMapSummary.setToolTipText(selectedMaps.toString());</span>
<span class="nc" id="L2549">    }</span>

    public void refreshGameYearLabel() {
<span class="nc" id="L2552">        String txt = Messages.getString(&quot;ChatLounge.GameYear&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2553">        txt = txt + &quot; &quot; //$NON-NLS-1$</span>
<span class="nc" id="L2554">                + clientgui.getClient().getGame().getOptions().intOption(OptionsConstants.ALLOWED_YEAR); // $NON-NLS-1$</span>
<span class="nc" id="L2555">        lblGameYear.setText(txt);</span>
<span class="nc" id="L2556">    }</span>

    public void refreshTechLevelLabel() {
        String tlString;
<span class="nc" id="L2560">        IOption tlOpt = clientgui.getClient().getGame().getOptions().getOption(&quot;techlevel&quot;);</span>
<span class="nc bnc" id="L2561" title="All 2 branches missed.">        if (tlOpt != null) {</span>
<span class="nc" id="L2562">            tlString = tlOpt.stringValue();</span>

        } else {
<span class="nc" id="L2565">            tlString = TechConstants.getLevelDisplayableName(TechConstants.T_TECH_UNKNOWN);</span>
        }
<span class="nc" id="L2567">        String txt = Messages.getString(&quot;ChatLounge.TechLevel&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2568">        txt = txt + &quot; &quot; + tlString; //$NON-NLS-1$</span>
<span class="nc" id="L2569">        lblTechLevel.setText(txt);</span>
<span class="nc" id="L2570">    }</span>

    @Override
    public void ready() {
<span class="nc" id="L2574">        final Client client = clientgui.getClient();</span>
<span class="nc" id="L2575">        final IGame game = client.getGame();</span>
<span class="nc" id="L2576">        final GameOptions gOpts = game.getOptions();</span>
        // enforce exclusive deployment zones in double blind
<span class="nc bnc" id="L2578" title="All 2 branches missed.">        if (gOpts.booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND) // $NON-NLS-1$</span>
<span class="nc bnc" id="L2579" title="All 2 branches missed.">                &amp;&amp; gOpts.booleanOption(OptionsConstants.BASE_EXCLUSIVE_DB_DEPLOYMENT)) { // $NON-NLS-1$</span>
<span class="nc" id="L2580">            int i = client.getLocalPlayer().getStartingPos();</span>
<span class="nc bnc" id="L2581" title="All 2 branches missed.">            if (i == 0) {</span>
<span class="nc" id="L2582">                clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.ExclusiveDeploy.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L2583">                        Messages.getString(&quot;ChatLounge.ExclusiveDeploy.msg&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L2584">                return;</span>
            }
<span class="nc bnc" id="L2586" title="All 2 branches missed.">            for (Enumeration&lt;IPlayer&gt; e = client.getGame().getPlayers(); e.hasMoreElements();) {</span>
<span class="nc" id="L2587">                IPlayer player = e.nextElement();</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">                if (player.getStartingPos() == 0) {</span>
<span class="nc" id="L2589">                    continue;</span>
                }
                // CTR and EDG don't overlap
<span class="nc bnc" id="L2592" title="All 8 branches missed.">                if (((player.getStartingPos() == 9) &amp;&amp; (i == 10)) || ((player.getStartingPos() == 10) &amp;&amp; (i == 9))) {</span>
<span class="nc" id="L2593">                    continue;</span>
                }

                // check for overlapping starting directions
<span class="nc bnc" id="L2597" title="All 4 branches missed.">                if (((player.getStartingPos() == i) || ((player.getStartingPos() + 1) == i)</span>
<span class="nc bnc" id="L2598" title="All 2 branches missed.">                        || ((player.getStartingPos() - 1) == i))</span>
<span class="nc bnc" id="L2599" title="All 2 branches missed.">                        &amp;&amp; (player.getId() != client.getLocalPlayer().getId())) {</span>
<span class="nc" id="L2600">                    clientgui.doAlertDialog(Messages.getString(&quot;ChatLounge.OverlapDeploy.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L2601">                            Messages.getString(&quot;ChatLounge.OverlapDeploy.msg&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L2602">                    return;</span>
                }
<span class="nc" id="L2604">            }</span>
        }

        // Make sure player has a commander if Commander killed victory is on
<span class="nc bnc" id="L2608" title="All 2 branches missed.">        if (gOpts.booleanOption(OptionsConstants.VICTORY_COMMANDER_KILLED)) {</span>
<span class="nc" id="L2609">            List&lt;String&gt; players = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2610" title="All 2 branches missed.">            if ((game.getLiveCommandersOwnedBy(client.getLocalPlayer()) &lt; 1)</span>
<span class="nc bnc" id="L2611" title="All 2 branches missed.">                    &amp;&amp; (game.getEntitiesOwnedBy(client.getLocalPlayer()) &gt; 0)) {</span>
<span class="nc" id="L2612">                players.add(client.getLocalPlayer().getName());</span>
            }
<span class="nc bnc" id="L2614" title="All 2 branches missed.">            for (Client bc : clientgui.getBots().values()) {</span>
<span class="nc bnc" id="L2615" title="All 2 branches missed.">                if ((game.getLiveCommandersOwnedBy(bc.getLocalPlayer()) &lt; 1)</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">                        &amp;&amp; (game.getEntitiesOwnedBy(bc.getLocalPlayer()) &gt; 0)) {</span>
<span class="nc" id="L2617">                    players.add(bc.getLocalPlayer().getName());</span>
                }
<span class="nc" id="L2619">            }</span>
<span class="nc bnc" id="L2620" title="All 2 branches missed.">            if (players.size() &gt; 0) {</span>
<span class="nc" id="L2621">                String title = Messages.getString(&quot;ChatLounge.noCmdr.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2622">                String msg = Messages.getString(&quot;ChatLounge.noCmdr.msg&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2623" title="All 2 branches missed.">                for (String player : players) {</span>
<span class="nc" id="L2624">                    msg += player + &quot;\n&quot;;</span>
<span class="nc" id="L2625">                }</span>
<span class="nc" id="L2626">                clientgui.doAlertDialog(title, msg);</span>
<span class="nc" id="L2627">                return;</span>
            }

        }

<span class="nc bnc" id="L2632" title="All 2 branches missed.">        boolean done = !client.getLocalPlayer().isDone();</span>
<span class="nc" id="L2633">        client.sendDone(done);</span>
<span class="nc" id="L2634">        refreshDoneButton(done);</span>
<span class="nc bnc" id="L2635" title="All 2 branches missed.">        for (Client client2 : clientgui.getBots().values()) {</span>
<span class="nc" id="L2636">            client2.sendDone(done);</span>
<span class="nc" id="L2637">        }</span>
<span class="nc" id="L2638">    }</span>

    Client getPlayerSelected() {
<span class="nc bnc" id="L2641" title="All 4 branches missed.">        if ((tablePlayers == null) || (tablePlayers.getSelectedRow() == -1)) {</span>
<span class="nc" id="L2642">            return clientgui.getClient();</span>
        }
<span class="nc" id="L2644">        String name = (String) tablePlayers.getValueAt(tablePlayers.getSelectedRow(), 0);</span>
<span class="nc" id="L2645">        BotClient c = (BotClient) clientgui.getBots().get(name);</span>
<span class="nc bnc" id="L2646" title="All 4 branches missed.">        if ((c == null) &amp;&amp; clientgui.getClient().getName().equals(name)) {</span>
<span class="nc" id="L2647">            return clientgui.getClient();</span>
        }
<span class="nc" id="L2649">        return c;</span>
    }

    /**
     * Stop just ignoring events and actually stop listening to them.
     */
    @Override
    public void removeAllListeners() {
<span class="nc" id="L2657">        clientgui.getClient().getGame().removeGameListener(this);</span>
<span class="nc" id="L2658">        clientgui.getBoardView().removeBoardViewListener(this);</span>
<span class="nc" id="L2659">    }</span>

    /*
     * This is required because the ChatLounge adds the listener to the
     * MechSummaryCache that must be removed explicitly.
     */
    public void die() {
<span class="nc" id="L2666">        MechSummaryCache.getInstance().removeListener(mechSummaryCacheListener);</span>
<span class="nc" id="L2667">    }</span>

    /**
     * Returns true if the given list of entities can be configured as a group.
     * This requires that they all have the same owner, and that none of the
     * units are being transported.
     *
     * @param entities
     * @return
     */
    public boolean canConfigureAll(List&lt;Entity&gt; entities) {
<span class="nc bnc" id="L2678" title="All 2 branches missed.">        if (entities.size() == 1) {</span>
<span class="nc" id="L2679">            return true;</span>
        }

<span class="nc" id="L2682">        Set&lt;Integer&gt; owners = new HashSet&lt;&gt;();</span>
<span class="nc" id="L2683">        boolean containsTransportedUnit = false;</span>
<span class="nc bnc" id="L2684" title="All 2 branches missed.">        for (Entity e : entities) {</span>
<span class="nc bnc" id="L2685" title="All 2 branches missed.">            containsTransportedUnit |= e.getTransportId() != Entity.NONE;</span>
<span class="nc" id="L2686">            owners.add(e.getOwner().getId());</span>
<span class="nc" id="L2687">        }</span>
<span class="nc bnc" id="L2688" title="All 4 branches missed.">        return (owners.size() == 1) &amp;&amp; !containsTransportedUnit;</span>
    }

    /**
     *
     */
    @Override
    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L2696" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L2697">            return;</span>
        }
<span class="nc bnc" id="L2699" title="All 2 branches missed.">        if (event.getSource().equals(butRemoveBot)) {</span>
<span class="nc" id="L2700">            butRemoveBot.setEnabled(false);</span>
<span class="nc" id="L2701">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2702" title="All 2 branches missed.">            if (c == null) {</span>

<span class="nc" id="L2704">                tablePlayers.removeRowSelectionInterval(tablePlayers.getSelectedRow(), tablePlayers.getSelectedRow());</span>
<span class="nc" id="L2705">                return;</span>
            }
<span class="nc bnc" id="L2707" title="All 2 branches missed.">            if (c instanceof BotClient) {</span>
<span class="nc" id="L2708">                butRemoveBot.setEnabled(true);</span>
            }
<span class="nc" id="L2710">            choTeam.setSelectedIndex(c.getLocalPlayer().getTeam());</span>
<span class="nc bnc" id="L2711" title="All 2 branches missed.">        } else if (event.getSource().equals(tablePlayers.getSelectionModel())) {</span>
<span class="nc" id="L2712">            butRemoveBot.setEnabled(false);</span>
<span class="nc" id="L2713">            Client c = getPlayerSelected();</span>
<span class="nc bnc" id="L2714" title="All 2 branches missed.">            if (c == null) {</span>
<span class="nc" id="L2715">                tablePlayers.removeRowSelectionInterval(tablePlayers.getSelectedRow(), tablePlayers.getSelectedRow());</span>
<span class="nc" id="L2716">                return;</span>
            }
<span class="nc bnc" id="L2718" title="All 2 branches missed.">            if (c instanceof BotClient) {</span>
<span class="nc" id="L2719">                butRemoveBot.setEnabled(true);</span>
            }
<span class="nc bnc" id="L2721" title="All 2 branches missed.">            boolean tf = (!c.getGame().getPlayerEntities(c.getLocalPlayer(), false).isEmpty());</span>
<span class="nc" id="L2722">            butDeleteAll.setEnabled(tf);</span>
<span class="nc" id="L2723">            butSaveList.setEnabled(tf);</span>
<span class="nc" id="L2724">            refreshCamos();</span>
<span class="nc" id="L2725">            choTeam.setSelectedIndex(c.getLocalPlayer().getTeam());</span>
<span class="nc bnc" id="L2726" title="All 2 branches missed.">        } else if (event.getSource().equals(lisBoardsAvailable)) {</span>
<span class="nc" id="L2727">            previewMapsheet();</span>
        }
<span class="nc" id="L2729">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>