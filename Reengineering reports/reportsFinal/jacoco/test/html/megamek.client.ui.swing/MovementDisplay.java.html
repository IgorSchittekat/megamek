<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MovementDisplay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">MovementDisplay.java</span></div><h1>MovementDisplay.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur
 * (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */
package megamek.client.ui.swing;

import java.awt.Color;
import java.awt.event.ActionEvent;
import java.awt.event.InputEvent;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.Vector;
import java.util.stream.Collectors;

import javax.swing.JOptionPane;

import megamek.MegaMek;
import megamek.client.event.BoardViewEvent;
import megamek.client.ui.Messages;
import megamek.client.ui.SharedUtility;
import megamek.client.ui.swing.util.CommandAction;
import megamek.client.ui.swing.util.KeyCommandBind;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.client.ui.swing.widget.MegamekButton;
import megamek.client.ui.swing.widget.SkinSpecification;
import megamek.common.*;
import megamek.common.IGame.Phase;
import megamek.common.MovePath.MoveStepType;
import megamek.common.actions.AirmechRamAttackAction;
import megamek.common.actions.ChargeAttackAction;
import megamek.common.actions.DfaAttackAction;
import megamek.common.actions.RamAttackAction;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GameTurnChangeEvent;
import megamek.common.options.GameOptions;
import megamek.common.options.IOptions;
import megamek.common.options.OptionsConstants;
import megamek.common.pathfinder.AbstractPathFinder;
import megamek.common.pathfinder.LongestPathFinder;
import megamek.common.pathfinder.ShortestPathFinder;
import megamek.common.preference.PreferenceManager;
import megamek.client.ui.swing.util.TurnTimer;

public class MovementDisplay extends StatusBarPhaseDisplay {
    private static final long serialVersionUID = -7246715124042905688L;
    
    // Defines for the different flags
    public static final int CMD_NONE = 0;
    public static final int CMD_MECH = 1;
    public static final int CMD_TANK = 1 &lt;&lt; 1;
    public static final int CMD_VTOL = 1 &lt;&lt; 2;
    public static final int CMD_INF = 1 &lt;&lt; 3;
    public static final int CMD_AERO = 1 &lt;&lt; 4;
    public static final int CMD_AERO_VECTORED = 1 &lt;&lt; 5;
    public static final int CMD_CONVERTER = 1 &lt;&lt; 6;
    public static final int CMD_AIRMECH = 1 &lt;&lt; 7;
    // Command used only in menus and has no associated button
    public static final int CMD_NO_BUTTON = 1 &lt;&lt; 8;
    // Convenience defines for common combinations
    public static final int CMD_AERO_BOTH = CMD_AERO | CMD_AERO_VECTORED;
    public static final int CMD_GROUND = CMD_MECH | CMD_TANK | CMD_VTOL
                                         | CMD_INF;
    public static final int CMD_NON_VECTORED = CMD_MECH | CMD_TANK | CMD_VTOL
                                               | CMD_INF | CMD_AERO;
    public static final int CMD_ALL = CMD_MECH | CMD_TANK | CMD_VTOL | CMD_INF
                                      | CMD_AERO | CMD_AERO_VECTORED;
    public static final int CMD_NON_INF = CMD_MECH | CMD_TANK | CMD_VTOL
                                          | CMD_AERO | CMD_AERO_VECTORED;
    private TurnTimer tt;

    /**
     * This enumeration lists all of the possible ActionCommands that can be
     * carried out during the movement phase. Each command has a string for the
     * command plus a flag that determines what unit type it is appropriate for.
     *
     * @author arlith
     */
<span class="nc" id="L96">    public enum MoveCommand implements PhaseCommand {</span>
<span class="nc" id="L97">        MOVE_NEXT(&quot;moveNext&quot;, CMD_NONE), //$NON-NLS-1$</span>
<span class="nc" id="L98">        MOVE_TURN(&quot;moveTurn&quot;, CMD_GROUND | CMD_AERO), //$NON-NLS-1$</span>
<span class="nc" id="L99">        MOVE_WALK(&quot;moveWalk&quot;, CMD_GROUND), //$NON-NLS-1$</span>
<span class="nc" id="L100">        MOVE_JUMP(&quot;moveJump&quot;, CMD_MECH | CMD_TANK | CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L101">        MOVE_BACK_UP(&quot;moveBackUp&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L102">        MOVE_GET_UP(&quot;moveGetUp&quot;, CMD_MECH), //$NON-NLS-1$</span>
<span class="nc" id="L103">        MOVE_FORWARD_INI(&quot;moveForwardIni&quot;, CMD_ALL), //$NON-NLS-1$</span>
<span class="nc" id="L104">        MOVE_CHARGE(&quot;moveCharge&quot;, CMD_MECH | CMD_TANK), //$NON-NLS-1$</span>
<span class="nc" id="L105">        MOVE_DFA(&quot;moveDFA&quot;, CMD_MECH), //$NON-NLS-1$</span>
<span class="nc" id="L106">        MOVE_GO_PRONE(&quot;moveGoProne&quot;, CMD_MECH), //$NON-NLS-1$</span>
<span class="nc" id="L107">        MOVE_FLEE(&quot;moveFlee&quot;, CMD_ALL), //$NON-NLS-1$</span>
<span class="nc" id="L108">        MOVE_EJECT(&quot;moveEject&quot;, CMD_ALL), //$NON-NLS-1$</span>
<span class="nc" id="L109">        MOVE_LOAD(&quot;moveLoad&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L110">        MOVE_UNLOAD(&quot;moveUnload&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L111">        MOVE_MOUNT(&quot;moveMount&quot;, CMD_GROUND), //$NON-NLS-1$</span>
<span class="nc" id="L112">        MOVE_TOW(&quot;moveTow&quot;, CMD_TANK), //$NON-NLS-1$</span>
<span class="nc" id="L113">        MOVE_DISCONNECT(&quot;moveDisconnect&quot;, CMD_TANK), //$NON-NLS-1$</span>
<span class="nc" id="L114">        MOVE_UNJAM(&quot;moveUnjam&quot;, CMD_NON_INF), //$NON-NLS-1$</span>
<span class="nc" id="L115">        MOVE_CLEAR(&quot;moveClear&quot;, CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L116">        MOVE_CANCEL(&quot;moveCancel&quot;, CMD_NONE), //$NON-NLS-1$</span>
<span class="nc" id="L117">        MOVE_RAISE_ELEVATION(&quot;moveRaiseElevation&quot;, CMD_NON_VECTORED), //$NON-NLS-1$</span>
<span class="nc" id="L118">        MOVE_LOWER_ELEVATION(&quot;moveLowerElevation&quot;, CMD_NON_VECTORED), //$NON-NLS-1$</span>
<span class="nc" id="L119">        MOVE_SEARCHLIGHT(&quot;moveSearchlight&quot;, CMD_GROUND), //$NON-NLS-1$</span>
<span class="nc" id="L120">        MOVE_LAY_MINE(&quot;moveLayMine&quot;, CMD_TANK | CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L121">        MOVE_HULL_DOWN(&quot;moveHullDown&quot;, CMD_MECH | CMD_TANK), //$NON-NLS-1$</span>
<span class="nc" id="L122">        MOVE_CLIMB_MODE(&quot;moveClimbMode&quot;, CMD_MECH | CMD_TANK | CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L123">        MOVE_SWIM(&quot;moveSwim&quot;, CMD_MECH), //$NON-NLS-1$</span>
<span class="nc" id="L124">        MOVE_SHAKE_OFF(&quot;moveShakeOff&quot;, CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
        //Convert command for a single button, which can cycle through modes because MovePath state is available
<span class="nc" id="L126">        MOVE_MODE_CONVERT(&quot;moveModeConvert&quot;, CMD_CONVERTER), //$NON-NLS-1$</span>
        //Convert commands used for menus, where the MovePath state is unknown.
<span class="nc" id="L128">        MOVE_MODE_LEG(&quot;moveModeLeg&quot;, CMD_NO_BUTTON), //$NON-NLS-1$</span>
<span class="nc" id="L129">        MOVE_MODE_VEE(&quot;moveModeVee&quot;, CMD_NO_BUTTON), //$NON-NLS-1$</span>
<span class="nc" id="L130">        MOVE_MODE_AIR(&quot;moveModeAir&quot;, CMD_NO_BUTTON), //$NON-NLS-1$</span>
<span class="nc" id="L131">        MOVE_RECKLESS(&quot;moveReckless&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L132">        MOVE_CAREFUL_STAND(&quot;moveCarefulStand&quot;, CMD_NONE), //$NON-NLS-1$</span>
<span class="nc" id="L133">        MOVE_EVADE(&quot;MoveEvade&quot;, CMD_MECH | CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L134">        MOVE_BOOTLEGGER(&quot;moveBootlegger&quot;, CMD_TANK | CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L135">        MOVE_SHUTDOWN(&quot;moveShutDown&quot;, CMD_NON_INF), //$NON-NLS-1$</span>
<span class="nc" id="L136">        MOVE_STARTUP(&quot;moveStartup&quot;, CMD_NON_INF), //$NON-NLS-1$</span>
<span class="nc" id="L137">        MOVE_SELF_DESTRUCT(&quot;moveSelfDestruct&quot;, CMD_NON_INF), //$NON-NLS-1$</span>
        // Infantry only
<span class="nc" id="L139">        MOVE_DIG_IN(&quot;moveDigIn&quot;, CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L140">        MOVE_FORTIFY(&quot;moveFortify&quot;, CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L141">        MOVE_TAKE_COVER(&quot;moveTakeCover&quot;, CMD_INF), //$NON-NLS-1$</span>
<span class="nc" id="L142">        MOVE_CALL_SUPPORT(&quot;moveCallSuport&quot;, CMD_INF), //$NON-NLS-1$</span>
        // VTOL attacks, declared in the movement phase
<span class="nc" id="L144">        MOVE_STRAFE(&quot;moveStrafe&quot;, CMD_VTOL), //$NON-NLS-1$</span>
<span class="nc" id="L145">        MOVE_BOMB(&quot;moveBomb&quot;, CMD_VTOL | CMD_AIRMECH), //$NON-NLS-1$</span>
        // Aero Movement
<span class="nc" id="L147">        MOVE_ACC(&quot;MoveAccelerate&quot;, CMD_AERO), //$NON-NLS-1$</span>
<span class="nc" id="L148">        MOVE_DEC(&quot;MoveDecelerate&quot;, CMD_AERO), //$NON-NLS-1$</span>
<span class="nc" id="L149">        MOVE_EVADE_AERO(&quot;MoveEvadeAero&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L150">        MOVE_ACCN(&quot;MoveAccNext&quot;, CMD_AERO), //$NON-NLS-1$</span>
<span class="nc" id="L151">        MOVE_DECN(&quot;MoveDecNext&quot;, CMD_AERO), //$NON-NLS-1$</span>
<span class="nc" id="L152">        MOVE_ROLL(&quot;MoveRoll&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L153">        MOVE_LAUNCH(&quot;MoveLaunch&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L154">        MOVE_DOCK(&quot;MoveDock&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L155">        MOVE_RECOVER(&quot;MoveRecover&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L156">        MOVE_DROP(&quot;MoveDrop&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L157">        MOVE_DUMP(&quot;MoveDump&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L158">        MOVE_RAM(&quot;MoveRam&quot;, CMD_AERO_BOTH | CMD_AIRMECH), //$NON-NLS-1$</span>
<span class="nc" id="L159">        MOVE_HOVER(&quot;MoveHover&quot;, CMD_AERO | CMD_AIRMECH), //$NON-NLS-1$</span>
<span class="nc" id="L160">        MOVE_MANEUVER(&quot;MoveManeuver&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L161">        MOVE_JOIN(&quot;MoveJoin&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L162">        MOVE_FLY_OFF(&quot;MoveOff&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L163">        MOVE_TAKE_OFF(&quot;MoveTakeOff&quot;, CMD_TANK), //$NON-NLS-1$</span>
<span class="nc" id="L164">        MOVE_VERT_TAKE_OFF(&quot;MoveVertTakeOff&quot;, CMD_TANK), //$NON-NLS-1$</span>
<span class="nc" id="L165">        MOVE_LAND(&quot;MoveLand&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
<span class="nc" id="L166">        MOVE_VERT_LAND(&quot;MoveVLand&quot;, CMD_AERO_BOTH), //$NON-NLS-1$</span>
        // Aero Vector Movement
<span class="nc" id="L168">        MOVE_TURN_LEFT(&quot;MoveTurnLeft&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</span>
<span class="nc" id="L169">        MOVE_TURN_RIGHT(&quot;MoveTurnRight&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</span>
<span class="nc" id="L170">        MOVE_THRUST(&quot;MoveThrust&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</span>
<span class="nc" id="L171">        MOVE_YAW(&quot;MoveYaw&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</span>
<span class="nc" id="L172">        MOVE_END_OVER(&quot;MoveEndOver&quot;, CMD_AERO_VECTORED), //$NON-NLS-1$</span>
        // Move envelope
<span class="nc" id="L174">        MOVE_ENVELOPE(&quot;MoveEnvelope&quot;, CMD_NONE), //$NON-NLS-1$</span>
<span class="nc" id="L175">        MOVE_LONGEST_RUN(&quot;MoveLongestRun&quot;, CMD_NONE), //$NON-NLS-1$</span>
<span class="nc" id="L176">        MOVE_LONGEST_WALK(&quot;MoveLongestWalk&quot;, CMD_NONE), //$NON-NLS-1$</span>
        // Traitor
<span class="nc" id="L178">        MOVE_TRAITOR(&quot;Traitor&quot;, CMD_NONE), MOVE_MORE(&quot;MoveMore&quot;, CMD_NONE); //$NON-NLS-1$</span>

        /**
         * The command text.
         */
        public final String cmd;

        /**
         * Flag that determines what unit types can use a command.
         */
        public final int flag;

        /**
         * Priority that determines this buttons order
         */
        public int priority;

<span class="nc" id="L195">        MoveCommand(String c, int f) {</span>
<span class="nc" id="L196">            cmd = c;</span>
<span class="nc" id="L197">            flag = f;</span>
<span class="nc" id="L198">            priority = ordinal();</span>
<span class="nc" id="L199">        }</span>

        public String getCmd() {
<span class="nc" id="L202">            return cmd;</span>
        }

        public int getPriority() {
<span class="nc" id="L206">            return priority;</span>
        }

        public void setPriority(int p) {
<span class="nc" id="L210">            priority = p;</span>
<span class="nc" id="L211">        }</span>

        public String toString() {
<span class="nc" id="L214">            return Messages.getString(&quot;MovementDisplay.&quot; + getCmd());</span>
        }

        /**
         * Return a list of valid commands for the given parameters.
         *
         * @param f          The unit flag to specify what unit type the commands are
         *                   for.
         * @param opts       A GameOptions reference for checking game options
         * @param forwardIni A flag to see if we can pass the turn to a teammate
         * @return An array of valid commands for the given parameters
         */
        public static MoveCommand[] values(int f, GameOptions opts,
                boolean forwardIni) {
<span class="nc" id="L228">            boolean manualShutdown = false, selfDestruct = false, advVehicle = false, vtolStrafe = false;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (opts != null) {</span>
<span class="nc" id="L230">                manualShutdown = opts.booleanOption(OptionsConstants.RPG_MANUAL_SHUTDOWN);</span>
<span class="nc" id="L231">                selfDestruct = opts.booleanOption(OptionsConstants.ADVANCED_TACOPS_SELF_DESTRUCT);</span>
<span class="nc" id="L232">                advVehicle = opts.booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS);</span>
<span class="nc" id="L233">                vtolStrafe = opts.booleanOption(OptionsConstants.ADVCOMBAT_VTOL_STRAFING);</span>
            }
<span class="nc" id="L235">            ArrayList&lt;MoveCommand&gt; flaggedCmds = new ArrayList&lt;MoveCommand&gt;();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            for (MoveCommand cmd : MoveCommand.values()) {</span>
                // Check for movements that with disabled game options
<span class="nc bnc" id="L238" title="All 6 branches missed.">                if ((cmd == MOVE_SHUTDOWN || cmd == MOVE_STARTUP)</span>
                    &amp;&amp; !manualShutdown) {
<span class="nc" id="L240">                    continue;</span>
                }
<span class="nc bnc" id="L242" title="All 4 branches missed.">                if (cmd == MOVE_SELF_DESTRUCT</span>
                    &amp;&amp; !selfDestruct) {
<span class="nc" id="L244">                    continue;</span>
                }

<span class="nc bnc" id="L247" title="All 4 branches missed.">                if (cmd == MOVE_FORWARD_INI &amp;&amp; !forwardIni) {</span>
<span class="nc" id="L248">                    continue;</span>
                }
                
<span class="nc bnc" id="L251" title="All 4 branches missed.">                if (cmd == MOVE_BOOTLEGGER &amp;&amp; !advVehicle) {</span>
<span class="nc" id="L252">                    continue;</span>
                }
                
<span class="nc bnc" id="L255" title="All 4 branches missed.">                if (cmd == MOVE_STRAFE &amp;&amp; !vtolStrafe) {</span>
<span class="nc" id="L256">                    continue;</span>
                }

                // Check unit type flag
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if ((cmd.flag &amp; f) != 0) {</span>
<span class="nc" id="L261">                    flaggedCmds.add(cmd);</span>
                }
            }
<span class="nc" id="L264">            return flaggedCmds.toArray(new MoveCommand[0]);</span>
        }

    }

    // buttons
    private Map&lt;MoveCommand, MegamekButton&gt; buttons;

    // let's keep track of what we're moving, too
<span class="nc" id="L273">    private int cen = Entity.NONE; // current entity number</span>
    private MovePath cmd; // considering movement data
    // what &quot;gear&quot; is our mech in?
    private int gear;
    // is the shift key held?
    private boolean shiftheld;
    /**
     * A local copy of the current entity's loaded units.
     */
<span class="nc" id="L282">    private List&lt;Entity&gt; loadedUnits = null;</span>
    
    /**
     * A local copy of the current entity's towed trailers.
     */
<span class="nc" id="L287">    private List&lt;Entity&gt; towedUnits = null;</span>

    public static final int GEAR_LAND = 0;
    public static final int GEAR_BACKUP = 1;
    public static final int GEAR_JUMP = 2;
    public static final int GEAR_CHARGE = 3;
    public static final int GEAR_DFA = 4;
    public static final int GEAR_TURN = 5;
    public static final int GEAR_SWIM = 6;
    public static final int GEAR_RAM = 7;
    public static final int GEAR_IMMEL = 8;
    public static final int GEAR_SPLIT_S = 9;
    public static final int GEAR_LONGEST_RUN = 10;
    public static final int GEAR_LONGEST_WALK = 11;
    public static final int GEAR_STRAFE = 12;

    /**
     * Creates and lays out a new movement phase display for the specified
     * clientgui.getClient().
     */
    public MovementDisplay(final ClientGUI clientgui) {
<span class="nc" id="L308">        super(clientgui);</span>

<span class="nc" id="L310">        this.clientgui = clientgui;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (clientgui != null) {</span>
<span class="nc" id="L312">            clientgui.getClient().getGame().addGameListener(this);</span>
<span class="nc" id="L313">            clientgui.getBoardView().addBoardViewListener(this);</span>
<span class="nc" id="L314">            clientgui.getClient().getGame().setupTeams();</span>
<span class="nc" id="L315">            clientgui.bv.addKeyListener(this);</span>
        }

<span class="nc" id="L318">        setupStatusBar(Messages.getString(&quot;MovementDisplay.waitingForMovementPhase&quot;)); //$NON-NLS-1$</span>

        // Create all of the buttons
<span class="nc" id="L321">        buttons = new HashMap&lt;MoveCommand, MegamekButton&gt;(</span>
<span class="nc" id="L322">                (int) (MoveCommand.values().length * 1.25 + 0.5));</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        for (MoveCommand cmd : MoveCommand.values()) {</span>
<span class="nc" id="L324">            String title = Messages</span>
<span class="nc" id="L325">                    .getString(&quot;MovementDisplay.&quot; + cmd.getCmd());</span>
<span class="nc" id="L326">            MegamekButton newButton = new MegamekButton(title,</span>
<span class="nc" id="L327">                    SkinSpecification.UIComponents.PhaseDisplayButton.getComp());</span>
<span class="nc" id="L328">            String ttKey = &quot;MovementDisplay.&quot; + cmd.getCmd() + &quot;.tooltip&quot;;</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">            if (Messages.keyExists(ttKey)) {</span>
<span class="nc" id="L330">                newButton.setToolTipText(Messages.getString(ttKey));</span>
            }
<span class="nc" id="L332">            newButton.addActionListener(this);</span>
<span class="nc" id="L333">            newButton.setActionCommand(cmd.getCmd());</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (clientgui != null) {</span>
<span class="nc" id="L335">                newButton.setEnabled(false);</span>
            } else {
<span class="nc" id="L337">                newButton.setEnabled(true);</span>
            }
<span class="nc" id="L339">            buttons.put(cmd, newButton);</span>
        }

<span class="nc" id="L342">        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</span>
<span class="nc" id="L343">                        + Messages.getString(&quot;MovementDisplay.butDone&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L344">        butDone.setEnabled(false);</span>

<span class="nc" id="L346">        layoutScreen();</span>
<span class="nc" id="L347">        setupButtonPanel();</span>

<span class="nc" id="L349">        gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L350">        shiftheld = false;</span>
        
<span class="nc" id="L352">        registerKeyCommands();</span>
<span class="nc" id="L353">    }</span>

    /**
     * Register all of the &lt;code&gt;CommandAction&lt;/code&gt;s for this panel display.
     */
    private void registerKeyCommands() {
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (clientgui == null) {</span>
<span class="nc" id="L360">            return;</span>
        }

<span class="nc" id="L363">        MegaMekController controller = clientgui.controller;</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (controller == null) {</span>
<span class="nc" id="L366">            return;</span>
        }

<span class="nc" id="L369">        final StatusBarPhaseDisplay display = this;</span>
        // Register the action for TURN_LEFT
<span class="nc" id="L371">        controller.registerCommandAction(KeyCommandBind.TURN_LEFT.cmd,</span>
<span class="nc" id="L372">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L376" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L380">                            return false;</span>
                        } else {
<span class="nc" id="L382">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L388">                        int curDir = cmd.getFinalFacing();</span>
<span class="nc" id="L389">                        int dir = curDir;</span>
<span class="nc" id="L390">                        dir = (dir + 5) % 6;</span>
<span class="nc" id="L391">                        Coords curPos = cmd.getFinalCoords();</span>
<span class="nc" id="L392">                        Coords target = curPos.translated(dir);</span>
                        // We need to set this to get the rotate behavior
<span class="nc" id="L394">                        shiftheld = true;</span>
<span class="nc" id="L395">                        currentMove(target);</span>
<span class="nc" id="L396">                        shiftheld = false;</span>
<span class="nc" id="L397">                        clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L398">                    }</span>
                });

        // Register the action for TURN_RIGHT
<span class="nc" id="L402">        controller.registerCommandAction(KeyCommandBind.TURN_RIGHT.cmd,</span>
<span class="nc" id="L403">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L407" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L411">                            return false;</span>
                        } else {
<span class="nc" id="L413">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L419">                        int curDir = cmd.getFinalFacing();</span>
<span class="nc" id="L420">                        int dir = curDir;</span>
<span class="nc" id="L421">                        dir = (dir + 7) % 6;</span>
<span class="nc" id="L422">                        Coords curPos = cmd.getFinalCoords();</span>
<span class="nc" id="L423">                        Coords target = curPos.translated(dir);</span>
                        // We need to set this to get the rotate behavior
<span class="nc" id="L425">                        shiftheld = true;</span>
<span class="nc" id="L426">                        currentMove(target);</span>
<span class="nc" id="L427">                        shiftheld = false;</span>
<span class="nc" id="L428">                        clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L429">                    }</span>
                });

        // Register the action for UNDO
<span class="nc" id="L433">        controller.registerCommandAction(KeyCommandBind.UNDO.cmd,</span>
<span class="nc" id="L434">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L438" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L442">                            return false;</span>
                        } else {
<span class="nc" id="L444">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L450">                        removeLastStep();</span>
<span class="nc" id="L451">                        computeMovementEnvelope(ce());</span>
<span class="nc" id="L452">                    }</span>
                });

        // Register the action for NEXT_UNIT
<span class="nc" id="L456">        controller.registerCommandAction(KeyCommandBind.NEXT_UNIT.cmd,</span>
<span class="nc" id="L457">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L461" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L465">                            return false;</span>
                        } else {
<span class="nc" id="L467">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L473">                        selectEntity(clientgui.getClient()</span>
<span class="nc" id="L474">                                .getNextEntityNum(cen));</span>
<span class="nc" id="L475">                    }</span>
                });

        // Register the action for PREV_UNIT
<span class="nc" id="L479">        controller.registerCommandAction(KeyCommandBind.PREV_UNIT.cmd,</span>
<span class="nc" id="L480">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L484" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L488">                            return false;</span>
                        } else {
<span class="nc" id="L490">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L496">                        selectEntity(clientgui.getClient()</span>
<span class="nc" id="L497">                                .getPrevEntityNum(cen));</span>
<span class="nc" id="L498">                    }</span>
                });

        // Register the action for MOVE_ENVELOPE
<span class="nc" id="L502">        controller.registerCommandAction(KeyCommandBind.MOVE_ENVELOPE.cmd,</span>
<span class="nc" id="L503">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L507" title="All 2 branches missed.">                        if (clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L510">                            return false;</span>
                        } else {
<span class="nc" id="L512">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L518">                        GUIPreferences.getInstance().setMoveEnvelope(</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                                !GUIPreferences.getInstance().getMoveEnvelope());</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                        if (GUIPreferences.getInstance().getMoveEnvelope()) {</span>
<span class="nc" id="L521">                            computeMovementEnvelope(clientgui.mechD</span>
<span class="nc" id="L522">                                    .getCurrentEntity());</span>
                        } else {
<span class="nc" id="L524">                            clientgui.bv.clearMovementEnvelope();</span>
                        }
<span class="nc" id="L526">                    }</span>
                });

        // Register the action for CLEAR
<span class="nc" id="L530">        controller.registerCommandAction(KeyCommandBind.CANCEL.cmd,</span>
<span class="nc" id="L531">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L535" title="All 2 branches missed.">                        if (clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L538">                            return false;</span>
                        } else {
<span class="nc" id="L540">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L546">                        clear();</span>
<span class="nc" id="L547">                        computeMovementEnvelope(ce());</span>
<span class="nc" id="L548">                    }</span>
                });
        
        // Command to toggle between jumping and walk/run
<span class="nc" id="L552">        controller.registerCommandAction(KeyCommandBind.TOGGLE_MOVEMODE.cmd,</span>
<span class="nc" id="L553">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L557" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L561">                            return false;</span>
                        } else {
<span class="nc" id="L563">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L569">                        final Entity ce = ce();</span>
<span class="nc" id="L570">                        boolean isAero = ce.isAero();</span>
                        // first check if jumping is available at all
<span class="nc bnc" id="L572" title="All 6 branches missed.">                        if (!isAero &amp;&amp; !ce.isImmobile() &amp;&amp; (ce.getJumpMP() &gt; 0)</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">                                &amp;&amp; !(ce.isStuck() &amp;&amp; !ce.canUnstickByJumping())) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                            if (gear != MovementDisplay.GEAR_JUMP) {</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                                if (!((cmd.getLastStep() != null)</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                                        &amp;&amp; cmd.getLastStep().isFirstStep() </span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                                        &amp;&amp; (cmd.getLastStep().getType() </span>
                                                == MoveStepType.LAY_MINE))) {
<span class="nc" id="L579">                                    clear();</span>
                                }
<span class="nc bnc" id="L581" title="All 2 branches missed.">                                if (!cmd.isJumping()) {</span>
<span class="nc" id="L582">                                    cmd.addStep(MoveStepType.START_JUMP);</span>
                                }
<span class="nc" id="L584">                                gear = MovementDisplay.GEAR_JUMP;</span>
<span class="nc" id="L585">                                Color jumpColor = GUIPreferences.getInstance().getColor(</span>
                                        GUIPreferences.ADVANCED_MOVE_JUMP_COLOR);
<span class="nc" id="L587">                                clientgui.getBoardView().setHighlightColor(jumpColor);</span>
<span class="nc" id="L588">                            } else {</span>
<span class="nc" id="L589">                                Color walkColor = GUIPreferences.getInstance().getColor(</span>
                                        GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<span class="nc" id="L591">                                clientgui.getBoardView().setHighlightColor(walkColor);</span>
<span class="nc" id="L592">                                gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L593">                                clear();</span>
<span class="nc" id="L594">                            }</span>
                        } else {
<span class="nc" id="L596">                            Color walkColor = GUIPreferences.getInstance().getColor(</span>
                                    GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<span class="nc" id="L598">                            clientgui.getBoardView().setHighlightColor(walkColor);</span>
<span class="nc" id="L599">                            gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L600">                            clear();</span>
                        }
<span class="nc" id="L602">                        computeMovementEnvelope(ce); </span>
<span class="nc" id="L603">                    }</span>
        });

        // Register the action for mode conversion
<span class="nc" id="L607">        controller.registerCommandAction(KeyCommandBind.TOGGLE_CONVERSIONMODE.cmd,</span>
<span class="nc" id="L608">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L612" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L616">                            return false;</span>
                        } else {
<span class="nc" id="L618">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L624">                        EntityMovementMode nextMode = ce().nextConversionMode(cmd.getFinalConversionMode());</span>
                        // LAMs may have to skip the next mode due to damage
<span class="nc bnc" id="L626" title="All 2 branches missed.">                        if (ce() instanceof LandAirMech) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                            if (!((LandAirMech)ce()).canConvertTo(nextMode)) {</span>
<span class="nc" id="L628">                                nextMode = ce().nextConversionMode(nextMode);</span>
                            }
<span class="nc bnc" id="L630" title="All 2 branches missed.">                            if (!((LandAirMech)ce()).canConvertTo(nextMode)) {</span>
<span class="nc" id="L631">                                nextMode = ce().getMovementMode();</span>
                            }
                        }
<span class="nc" id="L634">                        adjustConvertSteps(nextMode);</span>
<span class="nc" id="L635">                        clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L636">                    }</span>
                });

<span class="nc" id="L639">    }</span>

    /**
     * Return the button list: we need to determine what unit type is selected
     * and then get a button list appropriate for that unit.
     */
    protected ArrayList&lt;MegamekButton&gt; getButtonList() {
        int flag;

<span class="nc" id="L648">        final Entity ce = ce();</span>
<span class="nc" id="L649">        flag = CMD_MECH;</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (ce != null) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (ce instanceof Infantry) {</span>
<span class="nc" id="L652">                flag = CMD_INF;</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">            } else if (ce instanceof VTOL) {</span>
<span class="nc" id="L654">                flag = CMD_VTOL;</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            } else if (ce instanceof Tank) {</span>
<span class="nc" id="L656">                flag = CMD_TANK;</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">            } else if (ce.isAero()) {</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                if (ce.isAirborne()</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">                    &amp;&amp; clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc" id="L660">                    flag = CMD_AERO_VECTORED;</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                } else if (ce.isAirborne()</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">                           &amp;&amp; !clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc" id="L663">                    flag = CMD_AERO;</span>
                } else {
<span class="nc" id="L665">                    flag = CMD_TANK;</span>
                }
<span class="nc bnc" id="L667" title="All 2 branches missed.">                if (ce instanceof LandAirMech) {</span>
<span class="nc" id="L668">                    flag |= CMD_CONVERTER;</span>
                }
<span class="nc bnc" id="L670" title="All 2 branches missed.">            } else if (ce instanceof QuadVee) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                if (ce.getConversionMode() == QuadVee.CONV_MODE_MECH) {</span>
<span class="nc" id="L672">                    flag = CMD_MECH | CMD_CONVERTER;</span>
                } else {
<span class="nc" id="L674">                    flag = CMD_TANK | CMD_CONVERTER;</span>
                }
<span class="nc bnc" id="L676" title="All 2 branches missed.">            } else if (ce instanceof LandAirMech) {</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                if (ce.getConversionMode() == LandAirMech.CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L678">                    flag = CMD_TANK | CMD_CONVERTER | CMD_AIRMECH;</span>
                } else {
<span class="nc" id="L680">                    flag = CMD_MECH | CMD_CONVERTER;</span>
                }
<span class="nc bnc" id="L682" title="All 4 branches missed.">            } else if (ce instanceof Mech &amp;&amp; ((Mech)ce).hasTracks()) {</span>
<span class="nc" id="L683">                flag = CMD_MECH | CMD_CONVERTER;</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">            } else if (ce instanceof Protomech &amp;&amp; ce.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L685">                flag = CMD_MECH | CMD_AIRMECH;</span>
            }
        }
<span class="nc" id="L688">        return getButtonList(flag);</span>
    }

    private ArrayList&lt;MegamekButton&gt; getButtonList(int flag) {
<span class="nc" id="L692">        boolean forwardIni = false;</span>
<span class="nc" id="L693">        GameOptions opts = null;</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (clientgui != null) {</span>
<span class="nc" id="L695">            IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L696">            IPlayer localPlayer = clientgui.getClient().getLocalPlayer();</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">            forwardIni = (game.getTeamForPlayer(localPlayer) != null)</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">                    &amp;&amp; (game.getTeamForPlayer(localPlayer).getSize() &gt; 1);</span>
<span class="nc" id="L699">            opts = game.getOptions();</span>
        }

<span class="nc" id="L702">        ArrayList&lt;MegamekButton&gt; buttonList = new ArrayList&lt;MegamekButton&gt;();</span>

<span class="nc" id="L704">        int i = 0;</span>
<span class="nc" id="L705">        MoveCommand commands[] = MoveCommand.values(flag, opts, forwardIni);</span>
<span class="nc" id="L706">        CommandComparator comparator = new CommandComparator();</span>
<span class="nc" id="L707">        Arrays.sort(commands, comparator);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">        for (MoveCommand cmd : commands) {</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">            if (i % buttonsPerGroup == 0) {</span>
<span class="nc" id="L710">                buttonList.add(getBtn(MoveCommand.MOVE_NEXT));</span>
<span class="nc" id="L711">                i++;</span>
            }

<span class="nc" id="L714">            buttonList.add(buttons.get(cmd));</span>
<span class="nc" id="L715">            i++;</span>

<span class="nc bnc" id="L717" title="All 2 branches missed.">            if ((i + 1) % buttonsPerGroup == 0) {</span>
<span class="nc" id="L718">                buttonList.add(getBtn(MoveCommand.MOVE_MORE));</span>
<span class="nc" id="L719">                i++;</span>
            }
        }
<span class="nc" id="L722">        if (!buttonList.get(i - 1).getActionCommand()</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                       .equals(MoveCommand.MOVE_MORE.getCmd())) {</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">            while ((i + 1) % buttonsPerGroup != 0) {</span>
<span class="nc" id="L725">                buttonList.add(null);</span>
<span class="nc" id="L726">                i++;</span>
            }
<span class="nc" id="L728">            buttonList.add(getBtn(MoveCommand.MOVE_MORE));</span>
        }
<span class="nc" id="L730">        numButtonGroups = (int) Math.ceil((buttonList.size() + 0.0)</span>
                                          / buttonsPerGroup);
<span class="nc" id="L732">        return buttonList;</span>
    }

    /**
     * Hands over the current turn to the next valid player on the same team as
     * the supplied player. If no player on the team apart from this player has
     * any turns left it activates this player again.
     */
    public synchronized void selectNextPlayer() {
<span class="nc" id="L741">        clientgui.getClient().sendNextPlayer();</span>
        // endMyTurn();
<span class="nc" id="L743">    }</span>

    /**
     * Selects an entity, by number, for movement.
     */
    public synchronized void selectEntity(int en) {
<span class="nc" id="L749">        final Entity ce = clientgui.getClient().getGame().getEntity(en);</span>

        // hmm, sometimes this gets called when there's no ready entities?
<span class="nc bnc" id="L752" title="All 2 branches missed.">        if (ce == null) {</span>
<span class="nc" id="L753">            System.err.println(&quot;MovementDisplay: tried to &quot;</span>
                               + &quot;select non-existant entity: &quot; + en); //$NON-NLS-1$
<span class="nc" id="L755">            return;</span>
        }

<span class="nc bnc" id="L758" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L759">            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</span>
        }

<span class="nc" id="L762">        cen = en;</span>
<span class="nc" id="L763">        clientgui.setSelectedEntityNum(en);</span>
<span class="nc" id="L764">        gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L765">        Color walkColor = GUIPreferences.getInstance().getColor(</span>
                GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<span class="nc" id="L767">        clientgui.getBoardView().setHighlightColor(walkColor);</span>
<span class="nc" id="L768">        clear();</span>
        
<span class="nc" id="L770">        updateButtons();</span>
        // Update the menu bar.
<span class="nc" id="L772">        clientgui.getMenuBar().setEntity(ce);</span>
<span class="nc" id="L773">        clientgui.getBoardView().highlight(ce.getPosition());</span>
<span class="nc" id="L774">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L775">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L776">        clientgui.mechD.displayEntity(ce);</span>
<span class="nc" id="L777">        clientgui.mechD.showPanel(&quot;movement&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">        if (!clientgui.bv.isMovingUnits()) {</span>
<span class="nc" id="L779">            clientgui.bv.centerOnHex(ce.getPosition());</span>
        }

<span class="nc" id="L782">        String yourTurnMsg = Messages</span>
<span class="nc" id="L783">                .getString(&quot;MovementDisplay.its_your_turn&quot;);</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">        if (ce.hasQuirk(OptionsConstants.QUIRK_NEG_POOR_PERFORMANCE)) {</span>
            String poorPerfMsg;
<span class="nc bnc" id="L786" title="All 2 branches missed.">            if (ce.getMpUsedLastRound() &lt; ce.getWalkMP()) {</span>
<span class="nc" id="L787">                poorPerfMsg = Messages</span>
<span class="nc" id="L788">                        .getString(&quot;MovementDisplay.NotUpToSpeed&quot;);</span>
            } else {
<span class="nc" id="L790">                poorPerfMsg = Messages.getString(&quot;MovementDisplay.UpToSpeed&quot;);</span>
            }
<span class="nc" id="L792">            setStatusBarText(&quot;&lt;html&gt;&lt;center&gt;&quot; + yourTurnMsg + &quot;&lt;br&gt;&quot;</span>
                             + poorPerfMsg + &quot;&lt;/center&gt;&lt;/html&gt;&quot;);
<span class="nc" id="L794">        } else {</span>
<span class="nc" id="L795">            setStatusBarText(yourTurnMsg);</span>
        }
<span class="nc" id="L797">        clientgui.bv.clearFieldofF();</span>
<span class="nc" id="L798">        computeMovementEnvelope(ce);</span>
<span class="nc" id="L799">    }</span>

    private MegamekButton getBtn(MoveCommand c) {
<span class="nc" id="L802">        return buttons.get(c);</span>
    }

    private boolean isEnabled(MoveCommand c) {
<span class="nc" id="L806">        return buttons.get(c).isEnabled();</span>
    }

    /**
     * Sets the buttons to their proper states
     */
    private void updateButtons() {
<span class="nc" id="L813">        final GameOptions gOpts = clientgui.getClient().getGame().getOptions();</span>
<span class="nc" id="L814">        final Entity ce = ce();</span>
<span class="nc" id="L815">        boolean isMech = (ce instanceof Mech);</span>
<span class="nc" id="L816">        boolean isInfantry = (ce instanceof Infantry);</span>
        // boolean isProtomech = (ce instanceof Protomech);
<span class="nc" id="L818">        boolean isAero = ce.isAero();</span>

<span class="nc bnc" id="L820" title="All 2 branches missed.">        if (numButtonGroups &gt; 1)</span>
<span class="nc" id="L821">            getBtn(MoveCommand.MOVE_MORE).setEnabled(true);</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">        setWalkEnabled(!ce.isImmobile()</span>
<span class="nc bnc" id="L823" title="All 4 branches missed.">                       &amp;&amp; ((ce.getWalkMP() &gt; 0) || (ce.getRunMP() &gt; 0))</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                       &amp;&amp; !ce.isStuck());</span>
<span class="nc bnc" id="L825" title="All 6 branches missed.">        setJumpEnabled(!isAero &amp;&amp; !ce.isImmobile() &amp;&amp; (ce.getJumpMP() &gt; 0)</span>
<span class="nc bnc" id="L826" title="All 4 branches missed.">                       &amp;&amp; !(ce.isStuck() &amp;&amp; !ce.canUnstickByJumping()));</span>
<span class="nc bnc" id="L827" title="All 6 branches missed.">        setSwimEnabled(!isAero &amp;&amp; !ce.isImmobile() &amp;&amp; ce.getActiveUMUCount() &gt; 0</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">                       &amp;&amp; ce.isUnderwater());</span>
<span class="nc bnc" id="L829" title="All 4 branches missed.">        setBackUpEnabled(!isAero &amp;&amp; isEnabled(MoveCommand.MOVE_WALK));</span>
<span class="nc" id="L830">        setChargeEnabled(ce.canCharge());</span>
<span class="nc" id="L831">        setDFAEnabled(ce.canDFA());</span>
<span class="nc" id="L832">        setRamEnabled(ce.canRam());</span>

<span class="nc bnc" id="L834" title="All 2 branches missed.">        if (isInfantry) {</span>
<span class="nc" id="L835">            if (clientgui.getClient().getGame()</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                         .containsMinefield(ce.getPosition())) {</span>
<span class="nc" id="L837">                setClearEnabled(true);</span>
            } else {
<span class="nc" id="L839">                setClearEnabled(false);</span>
            }
        } else {
<span class="nc" id="L842">            setClearEnabled(false);</span>
        }
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if ((ce.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">            || (ce.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">            || (ce.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">            || (ce.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">            || (ce.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">            || (ce.getMovementMode() == EntityMovementMode.BIPED_SWIM)</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">            || (ce.getMovementMode() == EntityMovementMode.QUAD_SWIM)) {</span>
<span class="nc" id="L851">            getBtn(MoveCommand.MOVE_CLIMB_MODE).setEnabled(false);</span>
        } else {
<span class="nc" id="L853">            getBtn(MoveCommand.MOVE_CLIMB_MODE).setEnabled(true);</span>
        }
<span class="nc" id="L855">        updateTurnButton();</span>

<span class="nc" id="L857">        updateProneButtons();</span>
<span class="nc" id="L858">        updateRACButton();</span>
<span class="nc" id="L859">        updateSearchlightButton();</span>
<span class="nc" id="L860">        updateLoadButtons();</span>
<span class="nc" id="L861">        updateElevationButtons();</span>
<span class="nc" id="L862">        updateTakeOffButtons();</span>
<span class="nc" id="L863">        updateLandButtons();</span>
<span class="nc" id="L864">        updateJoinButton();</span>
<span class="nc" id="L865">        updateRecoveryButton();</span>
<span class="nc" id="L866">        updateDumpButton();</span>
<span class="nc" id="L867">        updateEvadeButton();</span>
<span class="nc" id="L868">        updateBootleggerButton();</span>
<span class="nc" id="L869">        updateLayMineButton();</span>

<span class="nc" id="L871">        updateStartupButton();</span>
<span class="nc" id="L872">        updateShutdownButton();</span>

<span class="nc" id="L874">        updateAeroButtons();</span>

<span class="nc" id="L876">        updateSpeedButtons();</span>
<span class="nc" id="L877">        updateThrustButton();</span>
<span class="nc" id="L878">        updateRollButton();</span>
<span class="nc" id="L879">        checkFuel();</span>
<span class="nc" id="L880">        checkOOC();</span>
<span class="nc" id="L881">        checkAtmosphere();</span>
<span class="nc" id="L882">        updateFlyOffButton();</span>
<span class="nc" id="L883">        updateLaunchButton();</span>
<span class="nc" id="L884">        updateDropButton();</span>
<span class="nc" id="L885">        updateConvertModeButton();</span>
<span class="nc" id="L886">        updateRecklessButton();</span>
<span class="nc" id="L887">        updateHoverButton();</span>
<span class="nc" id="L888">        updateManeuverButton();</span>
<span class="nc" id="L889">        updateStrafeButton();</span>
<span class="nc" id="L890">        updateBombButton();</span>

        // Infantry - Fortify
<span class="nc bnc" id="L893" title="All 2 branches missed.">        if (isInfantry</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">            &amp;&amp; ce.hasWorkingMisc(MiscType.F_TOOLS, MiscType.S_VIBROSHOVEL)) {</span>
            // Crews adrift in space or atmosphere can't do this
<span class="nc bnc" id="L896" title="All 6 branches missed.">            if (ce instanceof EjectedCrew &amp;&amp; (ce.isSpaceborne() || ce.isAirborne())) {</span>
<span class="nc" id="L897">                getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</span>
            } else {
<span class="nc" id="L899">                getBtn(MoveCommand.MOVE_FORTIFY).setEnabled(true);</span>
            }
        } else {
<span class="nc" id="L902">            getBtn(MoveCommand.MOVE_FORTIFY).setEnabled(false);</span>
        }
        // Infantry - Digging in
<span class="nc bnc" id="L905" title="All 4 branches missed.">        if (isInfantry &amp;&amp; gOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_DIG_IN)) {</span>
            // Crews adrift in space or atmosphere can't do this
<span class="nc bnc" id="L907" title="All 6 branches missed.">            if (ce instanceof EjectedCrew &amp;&amp; (ce.isSpaceborne() || ce.isAirborne())) {</span>
<span class="nc" id="L908">                getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</span>
            } else {
                // Allow infantry to dig in if they aren't currently dug in
<span class="nc" id="L911">                int dugInState = ((Infantry) ce).getDugIn();</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">                getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(</span>
                        dugInState == Infantry.DUG_IN_NONE);
<span class="nc" id="L914">            }</span>
        } else {
<span class="nc" id="L916">            getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</span>
        }
        // Infantry - Take Cover
        // Crews adrift in space or atmosphere can't do this
<span class="nc bnc" id="L920" title="All 6 branches missed.">        if (ce instanceof EjectedCrew &amp;&amp; (ce.isSpaceborne() || ce.isAirborne())) {</span>
<span class="nc" id="L921">            getBtn(MoveCommand.MOVE_TAKE_COVER).setEnabled(false);</span>
        } else {
<span class="nc" id="L923">            updateTakeCoverButton();</span>
        }

        // Infantry - Urban Guerrilla calling for support
<span class="nc bnc" id="L927" title="All 4 branches missed.">        if (isInfantry &amp;&amp; ce.hasAbility(OptionsConstants.INFANTRY_URBAN_GUERRILLA)</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">                &amp;&amp; ((Infantry) ce).getCanCallSupport()) {</span>
<span class="nc" id="L929">            getBtn(MoveCommand.MOVE_CALL_SUPPORT).setEnabled(true);</span>
        } else {
<span class="nc" id="L931">            getBtn(MoveCommand.MOVE_CALL_SUPPORT).setEnabled(false);</span>
        }

<span class="nc bnc" id="L934" title="All 2 branches missed.">        getBtn(MoveCommand.MOVE_SHAKE_OFF).setEnabled(</span>
                (ce instanceof Tank)
<span class="nc bnc" id="L936" title="All 2 branches missed.">                &amp;&amp; (ce.getSwarmAttackerId() != Entity.NONE));</span>

<span class="nc" id="L938">        setFleeEnabled(ce.canFlee());</span>
<span class="nc bnc" id="L939" title="All 4 branches missed.">        if (gOpts.booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT) &amp;&amp; (ce instanceof Tank)) {</span>
            // Vehicle don't have ejection systems so crews abandon, and must 
            // enter a valid hex, if they cannot they can't abandon TO pg 197
<span class="nc" id="L942">            Coords pos = ce().getPosition();</span>
<span class="nc" id="L943">            Infantry inf = new Infantry();</span>
<span class="nc" id="L944">            inf.setGame(clientgui.getClient().getGame());</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            boolean hasLegalHex = !inf.isLocationProhibited(pos);</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                hasLegalHex |= !inf.isLocationProhibited(pos.translated(i));</span>
            }
<span class="nc" id="L949">            setEjectEnabled(hasLegalHex);</span>
<span class="nc" id="L950">        } else {</span>
<span class="nc bnc" id="L951" title="All 6 branches missed.">            setEjectEnabled(((isMech &amp;&amp; (((Mech) ce).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED)) || isAero)</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">                    &amp;&amp; ce.isActive()</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">                    &amp;&amp; !ce.hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT));</span>
        }

        // if dropping unit only allow turning
<span class="nc bnc" id="L957" title="All 4 branches missed.">        if (!ce.isAero() &amp;&amp; cmd.getFinalAltitude() &gt; 0) {</span>
<span class="nc" id="L958">            disableButtons();</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">            if (ce instanceof LandAirMech) {</span>
<span class="nc" id="L960">                updateConvertModeButton();</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">                if (ce.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">                        &amp;&amp; ce.getAltitude() &lt;= 3) {</span>
<span class="nc" id="L963">                    updateHoverButton();</span>
                }
<span class="nc bnc" id="L965" title="All 2 branches missed.">                getBtn(MoveCommand.MOVE_MORE).setEnabled(numButtonGroups &gt; 1);</span>
            }
<span class="nc" id="L967">            butDone.setEnabled(true);</span>
        }


        // if small craft/dropship that has unloaded units, then only allowed
        // to unload more
<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (ce.hasUnloadedUnitsFromBays()) {</span>
<span class="nc" id="L974">            disableButtons();</span>
<span class="nc" id="L975">            updateLoadButtons();</span>
        }

<span class="nc" id="L978">        setupButtonPanel();</span>
<span class="nc" id="L979">    }</span>
    
    private void updateAeroButtons() {
<span class="nc bnc" id="L982" title="All 4 branches missed.">        if (ce() != null &amp;&amp; ce().isAero()) {</span>
<span class="nc" id="L983">            getBtn(MoveCommand.MOVE_THRUST).setEnabled(true);</span>
<span class="nc" id="L984">            getBtn(MoveCommand.MOVE_YAW).setEnabled(true);</span>
<span class="nc" id="L985">            getBtn(MoveCommand.MOVE_END_OVER).setEnabled(true);</span>
<span class="nc" id="L986">            getBtn(MoveCommand.MOVE_TURN_LEFT).setEnabled(true);</span>
<span class="nc" id="L987">            getBtn(MoveCommand.MOVE_TURN_RIGHT).setEnabled(true);</span>
<span class="nc bnc" id="L988" title="All 4 branches missed.">            setEvadeAeroEnabled(cmd != null &amp;&amp; !cmd.contains(MoveStepType.EVADE));</span>
<span class="nc" id="L989">            setEjectEnabled(true);</span>
            // no turning for spheroids in atmosphere
<span class="nc bnc" id="L991" title="All 2 branches missed.">            if ((((IAero) ce()).isSpheroid() || clientgui.getClient().getGame()</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">                    .getPlanetaryConditions().isVacuum())</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">                    &amp;&amp; !clientgui.getClient().getGame().getBoard().inSpace()) {</span>
<span class="nc" id="L994">                setTurnEnabled(false);</span>
            }
        }
<span class="nc" id="L997">    }</span>

    /**
     * Enables relevant buttons and sets up for your turn.
     */
    private void beginMyTurn() {
<span class="nc" id="L1003">        setStatusBarText(Messages.getString(&quot;MovementDisplay.its_your_turn&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1004">        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1005">        butDone.setEnabled(true);</span>
<span class="nc" id="L1006">        setNextEnabled(true);</span>
<span class="nc" id="L1007">        setForwardIniEnabled(true);</span>
<span class="nc" id="L1008">        clientgui.bv.clearFieldofF();</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">        if (numButtonGroups &gt; 1)</span>
<span class="nc" id="L1010">            getBtn(MoveCommand.MOVE_MORE).setEnabled(true);</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">        if (!clientgui.bv.isMovingUnits()) {</span>
<span class="nc" id="L1012">            clientgui.setDisplayVisible(true);</span>
        }
<span class="nc" id="L1014">        selectEntity(clientgui.getClient().getFirstEntityNum());</span>
        //check if there should be a turn timer running
<span class="nc" id="L1016">        tt = TurnTimer.init(this, clientgui.getClient());</span>
<span class="nc" id="L1017">    }</span>

    /**
     * Clears out old movement data and disables relevant buttons.
     */
    private synchronized void endMyTurn() {
<span class="nc" id="L1023">        final Entity ce = ce();</span>

        //get rid of still running timer, if turn is concluded before time is up
<span class="nc bnc" id="L1026" title="All 2 branches missed.">        if (tt != null) {</span>
<span class="nc" id="L1027">            tt.stopTimer();</span>
<span class="nc" id="L1028">            tt = null;</span>
        }

        // end my turn, then.
<span class="nc" id="L1032">        disableButtons();</span>
<span class="nc" id="L1033">        Entity next = clientgui.getClient().getGame()</span>
<span class="nc" id="L1034">                .getNextEntity(clientgui.getClient().getGame().getTurnIndex());</span>
<span class="nc" id="L1035">        if ((IGame.Phase.PHASE_MOVEMENT == clientgui.getClient().getGame()</span>
<span class="nc bnc" id="L1036" title="All 6 branches missed.">                .getPhase())</span>
                &amp;&amp; (null != next)
                &amp;&amp; (null != ce)
<span class="nc bnc" id="L1039" title="All 2 branches missed.">                &amp;&amp; (next.getOwnerId() != ce.getOwnerId())) {</span>
<span class="nc" id="L1040">            clientgui.setDisplayVisible(false);</span>
        }
<span class="nc" id="L1042">        cen = Entity.NONE;</span>
<span class="nc" id="L1043">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L1044">        clientgui.getBoardView().highlight(null);</span>
        // Return the highlight sprite back to its original color
<span class="nc" id="L1046">        clientgui.getBoardView().setHighlightColor(Color.white);</span>
<span class="nc" id="L1047">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L1048">        clientgui.getBoardView().selectEntity(null);</span>
<span class="nc" id="L1049">        clientgui.setSelectedEntityNum(Entity.NONE);</span>
<span class="nc" id="L1050">        clientgui.bv.clearMovementData();</span>
<span class="nc" id="L1051">        clientgui.bv.clearFieldofF();</span>
<span class="nc" id="L1052">    }</span>

    /**
     * Disables all buttons in the interface
     */
    private void disableButtons() {
<span class="nc" id="L1058">        setWalkEnabled(false);</span>
<span class="nc" id="L1059">        setJumpEnabled(false);</span>
<span class="nc" id="L1060">        setBackUpEnabled(false);</span>
<span class="nc" id="L1061">        setTurnEnabled(false);</span>
<span class="nc" id="L1062">        setFleeEnabled(false);</span>
<span class="nc" id="L1063">        setFlyOffEnabled(false);</span>
<span class="nc" id="L1064">        setEjectEnabled(false);</span>
<span class="nc" id="L1065">        setUnjamEnabled(false);</span>
<span class="nc" id="L1066">        setSearchlightEnabled(false, false);</span>
<span class="nc" id="L1067">        setGetUpEnabled(false);</span>
<span class="nc" id="L1068">        setGoProneEnabled(false);</span>
<span class="nc" id="L1069">        setChargeEnabled(false);</span>
<span class="nc" id="L1070">        setDFAEnabled(false);</span>
<span class="nc" id="L1071">        setNextEnabled(false);</span>
<span class="nc" id="L1072">        setForwardIniEnabled(false);</span>
<span class="nc" id="L1073">        getBtn(MoveCommand.MOVE_MORE).setEnabled(false);</span>
<span class="nc" id="L1074">        butDone.setEnabled(false);</span>
<span class="nc" id="L1075">        setLoadEnabled(false);</span>
<span class="nc" id="L1076">        setMountEnabled(false);</span>
<span class="nc" id="L1077">        setTowEnabled(false);</span>
<span class="nc" id="L1078">        setUnloadEnabled(false);</span>
<span class="nc" id="L1079">        setDisconnectEnabled(false);</span>
<span class="nc" id="L1080">        setClearEnabled(false);</span>
<span class="nc" id="L1081">        setHullDownEnabled(false);</span>
<span class="nc" id="L1082">        setSwimEnabled(false);</span>
<span class="nc" id="L1083">        setModeConvertEnabled(false);</span>
<span class="nc" id="L1084">        setAccEnabled(false);</span>
<span class="nc" id="L1085">        setDecEnabled(false);</span>
<span class="nc" id="L1086">        setEvadeEnabled(false);</span>
<span class="nc" id="L1087">        setBootleggerEnabled(false);</span>
<span class="nc" id="L1088">        setShutdownEnabled(false);</span>
<span class="nc" id="L1089">        setStartupEnabled(false);</span>
<span class="nc" id="L1090">        setSelfDestructEnabled(false);</span>
<span class="nc" id="L1091">        setTraitorEnabled(false);</span>
<span class="nc" id="L1092">        setEvadeAeroEnabled(false);</span>
<span class="nc" id="L1093">        setAccNEnabled(false);</span>
<span class="nc" id="L1094">        setDecNEnabled(false);</span>
<span class="nc" id="L1095">        setRollEnabled(false);</span>
<span class="nc" id="L1096">        setLaunchEnabled(false);</span>
<span class="nc" id="L1097">        setDockEnabled(false);</span>
<span class="nc" id="L1098">        setDropEnabled(false);</span>
<span class="nc" id="L1099">        setThrustEnabled(false);</span>
<span class="nc" id="L1100">        setYawEnabled(false);</span>
<span class="nc" id="L1101">        setEndOverEnabled(false);</span>
<span class="nc" id="L1102">        setTurnLeftEnabled(false);</span>
<span class="nc" id="L1103">        setTurnRightEnabled(false);</span>
<span class="nc" id="L1104">        setDumpEnabled(false);</span>
<span class="nc" id="L1105">        setRamEnabled(false);</span>
<span class="nc" id="L1106">        setHoverEnabled(false);</span>
<span class="nc" id="L1107">        setJoinEnabled(false);</span>
<span class="nc" id="L1108">        setTakeOffEnabled(false);</span>
<span class="nc" id="L1109">        setVTakeOffEnabled(false);</span>
<span class="nc" id="L1110">        setLandEnabled(false);</span>
<span class="nc" id="L1111">        setVLandEnabled(false);</span>
<span class="nc" id="L1112">        setLowerEnabled(false);</span>
<span class="nc" id="L1113">        setRaiseEnabled(false);</span>
<span class="nc" id="L1114">        setRecklessEnabled(false);</span>
<span class="nc" id="L1115">        setGoProneEnabled(false);</span>
<span class="nc" id="L1116">        setManeuverEnabled(false);</span>
<span class="nc" id="L1117">        setStrafeEnabled(false);</span>
<span class="nc" id="L1118">        setBombEnabled(false);</span>

<span class="nc" id="L1120">        getBtn(MoveCommand.MOVE_CLIMB_MODE).setEnabled(false);</span>
<span class="nc" id="L1121">        getBtn(MoveCommand.MOVE_DIG_IN).setEnabled(false);</span>
<span class="nc" id="L1122">        getBtn(MoveCommand.MOVE_CALL_SUPPORT).setEnabled(false);</span>
<span class="nc" id="L1123">    }</span>

    /**
     * Clears out the currently selected movement data and resets it.
     */
    @Override
    public void clear() {
<span class="nc" id="L1130">        final Entity ce = ce();</span>

        // clear board cursors
<span class="nc" id="L1133">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L1134">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L1135">        clientgui.getBoardView().clearMovementEnvelope();</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">        if (ce == null) {</span>
<span class="nc" id="L1138">            return;</span>
        }

        // Remove Careful stand, in case it was set
<span class="nc" id="L1142">        ce.setCarefulStand(false);</span>
<span class="nc" id="L1143">        ce.setIsJumpingNow(false);</span>
<span class="nc" id="L1144">        ce.setConvertingNow(false);</span>
<span class="nc" id="L1145">        ce.setClimbMode(GUIPreferences.getInstance().getBoolean(GUIPreferences.ADVANCED_MOVE_DEFAULT_CLIMB_MODE));</span>

        // switch back from swimming to normal mode.
<span class="nc bnc" id="L1148" title="All 2 branches missed.">        if (ce.getMovementMode() == EntityMovementMode.BIPED_SWIM) {</span>
<span class="nc" id="L1149">            ce.setMovementMode(EntityMovementMode.BIPED);</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">        } else if (ce.getMovementMode() == EntityMovementMode.QUAD_SWIM) {</span>
<span class="nc" id="L1151">            ce.setMovementMode(EntityMovementMode.QUAD);</span>
        }
        
        // create new current and considered paths
<span class="nc" id="L1155">        cmd = new MovePath(clientgui.getClient().getGame(), ce);</span>
<span class="nc" id="L1156">        clientgui.bv.setWeaponFieldofFire(ce, cmd);</span>

        // set to &quot;walk,&quot; or the equivalent
<span class="nc bnc" id="L1159" title="All 2 branches missed.">        if (gear != MovementDisplay.GEAR_JUMP) {</span>
<span class="nc" id="L1160">            gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L1161">            Color walkColor = GUIPreferences.getInstance().getColor(</span>
                    GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<span class="nc" id="L1163">            clientgui.getBoardView().setHighlightColor(walkColor);</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">        } else if (!cmd.isJumping()) {</span>
<span class="nc" id="L1165">            cmd.addStep(MoveStepType.START_JUMP);</span>
        }

        // update some GUI elements
<span class="nc" id="L1169">        clientgui.bv.clearMovementData();</span>
<span class="nc" id="L1170">        butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</span>
<span class="nc" id="L1171">                        + Messages.getString(&quot;MovementDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1172">        updateProneButtons();</span>
<span class="nc" id="L1173">        updateRACButton();</span>
<span class="nc" id="L1174">        updateSearchlightButton();</span>
<span class="nc" id="L1175">        updateElevationButtons();</span>
<span class="nc" id="L1176">        updateTakeOffButtons();</span>
<span class="nc" id="L1177">        updateLandButtons();</span>
<span class="nc" id="L1178">        updateFlyOffButton();</span>
<span class="nc" id="L1179">        updateLaunchButton();</span>
<span class="nc" id="L1180">        updateDropButton();</span>
<span class="nc" id="L1181">        updateConvertModeButton();</span>
<span class="nc" id="L1182">        updateRecklessButton();</span>
<span class="nc" id="L1183">        updateHoverButton();</span>
<span class="nc" id="L1184">        updateManeuverButton();</span>
<span class="nc" id="L1185">        updateAeroButtons();</span>
<span class="nc" id="L1186">        updateLayMineButton();</span>

<span class="nc" id="L1188">        loadedUnits = ce.getLoadedUnits();</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">        if (ce instanceof Aero) {</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">            for (Entity e : ce.getUnitsUnloadableFromBays()) {</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">                if (!loadedUnits.contains(e)) {</span>
<span class="nc" id="L1192">                    loadedUnits.add(e);</span>
                }
<span class="nc" id="L1194">            }</span>
        }
<span class="nc" id="L1196">        towedUnits = ce.getLoadedTrailers();</span>

<span class="nc" id="L1198">        updateLoadButtons();</span>
<span class="nc" id="L1199">        updateJoinButton();</span>
<span class="nc" id="L1200">        updateRecoveryButton();</span>
<span class="nc" id="L1201">        updateSpeedButtons();</span>
<span class="nc" id="L1202">        updateThrustButton();</span>
<span class="nc" id="L1203">        updateRollButton();</span>
<span class="nc" id="L1204">        checkFuel();</span>
<span class="nc" id="L1205">        checkOOC();</span>
<span class="nc" id="L1206">        checkAtmosphere();</span>

        // if dropping unit only allow turning
<span class="nc bnc" id="L1209" title="All 4 branches missed.">        if (!ce.isAero() &amp;&amp; cmd.getFinalAltitude() &gt; 0) {</span>
<span class="nc" id="L1210">            disableButtons();</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">            if (ce instanceof LandAirMech) {</span>
<span class="nc" id="L1212">                updateConvertModeButton();</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">                if (ce.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">                        &amp;&amp; ce.getAltitude() &lt;= 3) {</span>
<span class="nc" id="L1215">                    updateHoverButton();</span>
                }
<span class="nc bnc" id="L1217" title="All 2 branches missed.">                getBtn(MoveCommand.MOVE_MORE).setEnabled(numButtonGroups &gt; 1);</span>
            } else {
<span class="nc" id="L1219">                gear = MovementDisplay.GEAR_TURN;</span>
            }
<span class="nc" id="L1221">            butDone.setEnabled(true);</span>
        }

        // if small craft/dropship that has unloaded units, then only allowed
        // to unload more
<span class="nc bnc" id="L1226" title="All 2 branches missed.">        if (ce.hasUnloadedUnitsFromBays()) {</span>
<span class="nc" id="L1227">            disableButtons();</span>
<span class="nc" id="L1228">            updateLoadButtons();</span>
<span class="nc" id="L1229">            butDone.setEnabled(true);</span>
        }
        
<span class="nc" id="L1232">    }</span>

    private void removeLastStep() {
<span class="nc" id="L1235">        cmd.removeLastStep();</span>
<span class="nc" id="L1236">        final Entity entity = ce();</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L1238">            MegaMek.getLogger().warning(&quot;Cannot process removeLastStep for a null entity.&quot;);</span>
<span class="nc" id="L1239">            return;</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">        } else if (cmd.length() == 0) {</span>
<span class="nc" id="L1241">            clear();</span>
<span class="nc bnc" id="L1242" title="All 4 branches missed.">            if ((gear == MovementDisplay.GEAR_JUMP) &amp;&amp; !cmd.isJumping()) {</span>
<span class="nc" id="L1243">                cmd.addStep(MoveStepType.START_JUMP);</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">            } else if (entity.isConvertingNow()) {</span>
<span class="nc" id="L1245">                cmd.addStep(MoveStepType.CONVERT_MODE);</span>
            }
        } else {
            // clear board cursors
<span class="nc" id="L1249">            clientgui.getBoardView().select(cmd.getFinalCoords());</span>
<span class="nc" id="L1250">            clientgui.getBoardView().cursor(cmd.getFinalCoords());</span>
<span class="nc" id="L1251">            clientgui.getBoardView().drawMovementData(entity, cmd);</span>
<span class="nc" id="L1252">            clientgui.bv.setWeaponFieldofFire(entity, cmd);</span>

            // Set the button's label to &quot;Done&quot;
            // if the entire move is impossible.
<span class="nc" id="L1256">            MovePath possible = cmd.clone();</span>
<span class="nc" id="L1257">            possible.clipToPossible();</span>
<span class="nc bnc" id="L1258" title="All 2 branches missed.">            if (possible.length() == 0) {</span>
<span class="nc" id="L1259">                butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Done&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;);</span>
            }
        }
<span class="nc" id="L1262">        updateButtons();</span>
<span class="nc" id="L1263">    }</span>

    /**
     * Sends a data packet indicating the chosen movement.
     */
    @Override
    public synchronized void ready() {
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L1271">            return;</span>
        }

<span class="nc" id="L1274">        cmd.clipToPossible();</span>
<span class="nc bnc" id="L1275" title="All 4 branches missed.">        if ((cmd.length() == 0) &amp;&amp; !ce().isAirborne()</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getNagForNoAction()) {</span>
            // Hmm....no movement steps, comfirm this action
<span class="nc" id="L1278">            String title = Messages</span>
<span class="nc" id="L1279">                    .getString(&quot;MovementDisplay.ConfirmNoMoveDlg.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1280">            String body = Messages</span>
<span class="nc" id="L1281">                    .getString(&quot;MovementDisplay.ConfirmNoMoveDlg.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1282">            ConfirmDialog response = clientgui.doYesNoBotherDialog(title, body);</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">            if (!response.getShowAgain()) {</span>
<span class="nc" id="L1284">                GUIPreferences.getInstance().setNagForNoAction(false);</span>
            }
<span class="nc bnc" id="L1286" title="All 2 branches missed.">            if (!response.getAnswer()) {</span>
<span class="nc" id="L1287">                return;</span>
            }
        }

<span class="nc bnc" id="L1291" title="All 4 branches missed.">        if (cmd.hasActiveMASC() &amp;&amp; GUIPreferences.getInstance().getNagForMASC()) {</span>
            // pop up are you sure dialog
<span class="nc bnc" id="L1293" title="All 4 branches missed.">            if (!((ce() instanceof VTOL) &amp;&amp; ce().hasWorkingMisc(</span>
                    MiscType.F_JET_BOOSTER))) {
<span class="nc" id="L1295">                ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1296">                        Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1297">                        Messages.getString(</span>
                                &quot;MovementDisplay.ConfirmMoveRoll&quot;,
<span class="nc" id="L1299">                                new Object[] { Integer.valueOf(ce().getMASCTarget()) }), //$NON-NLS-1$</span>
                        true);
<span class="nc" id="L1301">                nag.setVisible(true);</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">                if (nag.getAnswer()) {</span>
                    // do they want to be bothered again?
<span class="nc bnc" id="L1304" title="All 2 branches missed.">                    if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1305">                        GUIPreferences.getInstance().setNagForMASC(false);</span>
                    }
                } else {
<span class="nc" id="L1308">                    return;</span>
                }
            }
        }

<span class="nc bnc" id="L1313" title="All 2 branches missed.">        if ((cmd.getLastStepMovementType() == EntityMovementType.MOVE_SPRINT</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">                || cmd.getLastStepMovementType() == EntityMovementType.MOVE_VTOL_SPRINT)</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">                &amp;&amp; GUIPreferences.getInstance().getNagForSprint()</span>
                // no need to nag for vehicles using overdrive if they already get a PSR nag
<span class="nc bnc" id="L1317" title="All 2 branches missed.">                &amp;&amp; !((cmd.getEntity() instanceof Tank</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                        || (cmd.getEntity() instanceof QuadVee</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">                                &amp;&amp; cmd.getEntity().getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">                        &amp;&amp; GUIPreferences.getInstance().getNagForPSR()))) {</span>
<span class="nc" id="L1321">            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1322">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1323">                    Messages.getString(&quot;MovementDisplay.ConfirmSprint&quot;), true);</span>
<span class="nc" id="L1324">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1327" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1328">                    GUIPreferences.getInstance().setNagForSprint(false);</span>
                }
            } else {
<span class="nc" id="L1331">                return;</span>
            }
        }
<span class="nc" id="L1334">        String check = SharedUtility.doPSRCheck(cmd);</span>
<span class="nc bnc" id="L1335" title="All 4 branches missed.">        if ((check.length() &gt; 0) &amp;&amp; GUIPreferences.getInstance().getNagForPSR()) {</span>
<span class="nc" id="L1336">            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1337">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1338">                    Messages.getString(&quot;MovementDisplay.ConfirmPilotingRoll&quot;) +</span>
                    //$NON-NLS-1$
                            check, true);
<span class="nc" id="L1341">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1344" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1345">                    GUIPreferences.getInstance().setNagForPSR(false);</span>
                }
            } else {
<span class="nc" id="L1348">                return;</span>
            }
        }

        // Should we nag about taking fall damage with mechanical jump boosters?
<span class="nc bnc" id="L1353" title="All 2 branches missed.">        if (cmd.shouldMechanicalJumpCauseFallDamage()</span>
<span class="nc" id="L1354">                &amp;&amp; GUIPreferences.getInstance()</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">                        .getNagForMechanicalJumpFallDamage()) {</span>
<span class="nc" id="L1356">            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1357">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1358">                    Messages.getString(</span>
                            &quot;MovementDisplay.ConfirmMechanicalJumpFallDamage&quot;,
                            new Object[] {
<span class="nc" id="L1361">                                    cmd.getJumpMaxElevationChange(),</span>
<span class="nc" id="L1362">                                    ce().getJumpMP(),</span>
<span class="nc" id="L1363">                                    cmd.getJumpMaxElevationChange()</span>
<span class="nc" id="L1364">                                            - ce().getJumpMP() }), true);</span>
<span class="nc" id="L1365">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1366" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1368" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1369">                    GUIPreferences.getInstance()</span>
<span class="nc" id="L1370">                            .setNagForMechanicalJumpFallDamage(false);</span>
                }
            } else {
<span class="nc" id="L1373">                return;</span>
            }
        }

        // check for G-forces
<span class="nc" id="L1378">        check = SharedUtility.doThrustCheck(cmd, clientgui.getClient());</span>
<span class="nc bnc" id="L1379" title="All 4 branches missed.">        if ((check.length() &gt; 0) &amp;&amp; GUIPreferences.getInstance().getNagForPSR()) {</span>
<span class="nc" id="L1380">            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1381">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1382">                    Messages.getString(&quot;MovementDisplay.ConfirmPilotingRoll&quot;) +</span>
                    //$NON-NLS-1$
                            check, true);
<span class="nc" id="L1385">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1388" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1389">                    GUIPreferences.getInstance().setNagForPSR(false);</span>
                }
            } else {
<span class="nc" id="L1392">                return;</span>
            }
        }

        // check for unsafe takeoffs
<span class="nc bnc" id="L1397" title="All 2 branches missed.">        if (cmd.contains(MoveStepType.VTAKEOFF)</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">                || cmd.contains(MoveStepType.TAKEOFF)) {</span>
<span class="nc" id="L1399">            boolean unsecure = false;</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">            for (Entity loaded : ce().getLoadedUnits()) {</span>
<span class="nc bnc" id="L1401" title="All 4 branches missed.">                if (loaded.wasLoadedThisTurn() &amp;&amp; !(loaded instanceof Infantry)) {</span>
<span class="nc" id="L1402">                    unsecure = true;</span>
<span class="nc" id="L1403">                    break;</span>
                }
<span class="nc" id="L1405">            }</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            if (unsecure) {</span>
<span class="nc" id="L1407">                ConfirmDialog nag = new ConfirmDialog(</span>
                        clientgui.frame,
<span class="nc" id="L1409">                        Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1410">                        Messages.getString(&quot;MovementDisplay.UnsecuredTakeoff&quot;),</span>
                        true);
<span class="nc" id="L1412">                nag.setVisible(true);</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">                if (nag.getAnswer()) {</span>
                    // do they want to be bothered again?
<span class="nc bnc" id="L1415" title="All 2 branches missed.">                    if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1416">                        GUIPreferences.getInstance().setNagForPSR(false);</span>
                    }
                } else {
<span class="nc" id="L1419">                    return;</span>
                }
            }
        }

        // check to see if spheroids will drop elevation
        // they will do so if they're not hovering, landing, or changing altitude voluntarily.
<span class="nc bnc" id="L1426" title="All 2 branches missed.">        if (Compute.useSpheroidAtmosphere(clientgui.getClient().getGame(), ce()) </span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">                &amp;&amp; !cmd.contains(MoveStepType.HOVER) </span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">                &amp;&amp; !cmd.contains(MoveStepType.VLAND)</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">                &amp;&amp; !cmd.contains(MoveStepType.UP)</span>
<span class="nc bnc" id="L1430" title="All 2 branches missed.">                &amp;&amp; !cmd.contains(MoveStepType.DOWN)) {</span>
<span class="nc" id="L1431">            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1432">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1433">                    Messages.getString(&quot;MovementDisplay.SpheroidAltitudeLoss&quot;) +</span>
                    //$NON-NLS-1$
                            check, true);
<span class="nc" id="L1436">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1439" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1440">                    GUIPreferences.getInstance().setNagForPSR(false);</span>
                }
            } else {
<span class="nc" id="L1443">                return;</span>
            }
        }
        
<span class="nc bnc" id="L1447" title="All 4 branches missed.">        if (ce().isAirborne() || ce().isSpaceborne()) {</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            if (!clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc bnc" id="L1449" title="All 4 branches missed.">                if (ce().isAero() &amp;&amp; !((IAero)ce()).isOutControlTotal()) {</span>
                    // check for underuse of velocity
<span class="nc" id="L1451">                    boolean unusedVelocity = false;</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">                    if (null != cmd.getLastStep()) {</span>
<span class="nc bnc" id="L1453" title="All 2 branches missed.">                        unusedVelocity = cmd.getLastStep().getVelocityLeft() &gt; 0;</span>
                    } else {
<span class="nc bnc" id="L1455" title="All 2 branches missed.">                        unusedVelocity = (((IAero) ce()).getCurrentVelocity() &gt; 0) &amp;&amp;</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">                                (ce().delta_distance == 0);</span>
                    }
<span class="nc" id="L1458">                    boolean flyoff = false;</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">                    if ((null != cmd)</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">                            &amp;&amp; (cmd.contains(MoveStepType.OFF) || cmd</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">                                    .contains(MoveStepType.RETURN))) {</span>
<span class="nc" id="L1462">                        flyoff = true;</span>
                    }
<span class="nc" id="L1464">                    boolean landing = false;</span>
<span class="nc bnc" id="L1465" title="All 4 branches missed.">                    if ((null != cmd) &amp;&amp; cmd.contains(MoveStepType.LAND)) {</span>
<span class="nc" id="L1466">                        landing = true;</span>
                    }
<span class="nc" id="L1468">                    boolean ejecting = false;</span>
<span class="nc bnc" id="L1469" title="All 4 branches missed.">                    if ((null != cmd) &amp;&amp; cmd.contains(MoveStepType.EJECT)) {</span>
<span class="nc" id="L1470">                        ejecting = true;</span>
                    }
<span class="nc bnc" id="L1472" title="All 8 branches missed.">                    if (unusedVelocity &amp;&amp; !flyoff &amp;&amp; !landing &amp;&amp; !ejecting) {</span>
<span class="nc" id="L1473">                        String title = Messages</span>
<span class="nc" id="L1474">                                .getString(&quot;MovementDisplay.VelocityLeft.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1475">                        String body = Messages</span>
<span class="nc" id="L1476">                                .getString(&quot;MovementDisplay.VelocityLeft.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1477">                        clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L1478">                        return;</span>
                    }
                }
            }
            // depending on the rules and location (i.e. space v. atmosphere),
            // Aeros might need to have additional move steps tacked on
            // This must be done after all prompts, otherwise a user who cancels
            // will still have steps added to the movepath.
<span class="nc" id="L1486">            cmd = SharedUtility.moveAero(cmd, clientgui.getClient());</span>
        }

<span class="nc bnc" id="L1489" title="All 2 branches missed.">        if (cmd.willCrushBuildings()</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getNagForCrushingBuildings()) {</span>
<span class="nc" id="L1491">            ConfirmDialog nag = new ConfirmDialog(</span>
                    clientgui.frame,
<span class="nc" id="L1493">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1494">                    Messages.getString(&quot;MovementDisplay.ConfirmCrushingBuildings&quot;),</span>
                    true);
<span class="nc" id="L1496">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1499" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1500">                    GUIPreferences.getInstance().setNagForCrushingBuildings(</span>
                            false);
                }
            } else {
<span class="nc" id="L1504">                return;</span>
            }
        }

        // check to see if spheroids will drop an elevation
<span class="nc bnc" id="L1509" title="All 4 branches missed.">        if (ce() instanceof LandAirMech &amp;&amp; ce().isAssaultDropInProgress()</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">                &amp;&amp; cmd.getFinalConversionMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L1511">            ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L1512">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1513">                    Messages.getString(&quot;MovementDisplay.insufficientAltitudeForConversion&quot;) +</span>
                    //$NON-NLS-1$
                            check, false);
<span class="nc" id="L1516">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">            if (!nag.getAnswer()) {</span>
<span class="nc" id="L1518">                return;</span>
            }
        }
        
<span class="nc bnc" id="L1522" title="All 4 branches missed.">        if ((ce() instanceof Infantry) &amp;&amp; ((Infantry) ce()).hasMicrolite()</span>
<span class="nc bnc" id="L1523" title="All 4 branches missed.">                &amp;&amp; (ce().isAirborneVTOLorWIGE() || (ce().getElevation() != cmd.getFinalElevation()))</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">                &amp;&amp; !cmd.contains(MoveStepType.FORWARDS)</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                &amp;&amp; cmd.getFinalElevation() &gt; 0</span>
<span class="nc" id="L1526">                &amp;&amp; ce().getGame().getBoard().getHex(cmd.getFinalCoords())</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">                    .terrainLevel(Terrains.BLDG_ELEV) &lt; cmd.getFinalElevation()</span>
<span class="nc" id="L1528">                &amp;&amp; ce().getGame().getBoard().getHex(cmd.getFinalCoords())</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">                    .terrainLevel(Terrains.BRIDGE_ELEV) &lt; cmd.getFinalElevation()) {</span>
<span class="nc" id="L1530">            String title = Messages</span>
<span class="nc" id="L1531">                    .getString(&quot;MovementDisplay.MicroliteMove.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1532">            String body = Messages</span>
<span class="nc" id="L1533">                    .getString(&quot;MovementDisplay.MicroliteMove.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1534">            clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L1535">            return;            	</span>
        }
        
<span class="nc bnc" id="L1538" title="All 2 branches missed.">        if (cmd.automaticWiGELanding(true)</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">                &amp;&amp; GUIPreferences.getInstance().getNagForWiGELanding()  ) {</span>
<span class="nc" id="L1540">            ConfirmDialog nag = new ConfirmDialog(</span>
                    clientgui.frame,
<span class="nc" id="L1542">                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1543">                    Messages.getString(&quot;MovementDisplay.ConfirmWiGELanding&quot;),</span>
                    true);
<span class="nc" id="L1545">            nag.setVisible(true);</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">            if (nag.getAnswer()) {</span>
                // do they want to be bothered again?
<span class="nc bnc" id="L1548" title="All 2 branches missed.">                if (!nag.getShowAgain()) {</span>
<span class="nc" id="L1549">                    GUIPreferences.getInstance().setNagForWiGELanding(false);</span>
                }
            } else {
<span class="nc" id="L1552">                return;</span>
            }
        }

<span class="nc" id="L1556">        disableButtons();</span>
<span class="nc" id="L1557">        clientgui.bv.clearMovementData();</span>
<span class="nc" id="L1558">        clientgui.bv.clearMovementEnvelope();</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">        if (ce().hasUMU()) {</span>
<span class="nc" id="L1560">            clientgui.getClient().sendUpdateEntity(ce());</span>
        }
<span class="nc" id="L1562">        clientgui.getClient().moveEntity(cen, cmd);</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">        if (ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L1564">            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</span>
        }
<span class="nc" id="L1566">        endMyTurn();</span>
<span class="nc" id="L1567">    }</span>

    /**
     * Returns the current entity.
     */
    private synchronized Entity ce() {
<span class="nc bnc" id="L1573" title="All 2 branches missed.">        if (clientgui != null) {</span>
<span class="nc" id="L1574">            return clientgui.getClient().getGame().getEntity(cen);</span>
        } else {
<span class="nc" id="L1576">            return null;</span>
        }
    }
    
    /**
     * Returns new MovePath for the currently selected movement type
     */
    private void currentMove(Coords dest) {
<span class="nc bnc" id="L1584" title="All 4 branches missed.">        if (shiftheld || (gear == GEAR_TURN)) {</span>
<span class="nc" id="L1585">            cmd.rotatePathfinder(cmd.getFinalCoords().direction(dest), false);</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">        } else if ((gear == GEAR_JUMP)</span>
<span class="nc bnc" id="L1587" title="All 2 branches missed.">                   &amp;&amp; (ce().getJumpType() == Mech.JUMP_BOOSTER)) {</span>
            // Jumps with mechanical jump boosters are special
            Coords src;
<span class="nc bnc" id="L1590" title="All 2 branches missed.">            if (cmd.getLastStep() != null) {</span>
<span class="nc" id="L1591">                src = cmd.getLastStep().getPosition();</span>
            } else {
<span class="nc" id="L1593">                src = ce().getPosition();</span>
            }
<span class="nc" id="L1595">            int dir = src.direction(dest);</span>
<span class="nc" id="L1596">            int facing = ce().getFacing();</span>
            // Adjust dir based upon facing
            // Java does mod different from how we want...
<span class="nc" id="L1599">            dir = (((dir - facing) % 6) + 6) % 6;</span>
<span class="nc bnc" id="L1600" title="All 7 branches missed.">            switch (dir) {</span>
                case 0:
<span class="nc" id="L1602">                    cmd.findSimplePathTo(dest, MoveStepType.FORWARDS,</span>
<span class="nc" id="L1603">                            src.direction(dest), ce().getFacing());</span>
<span class="nc" id="L1604">                    break;</span>
                case 1:
<span class="nc" id="L1606">                    cmd.findSimplePathTo(dest, MoveStepType.LATERAL_RIGHT,</span>
<span class="nc" id="L1607">                            src.direction(dest), ce().getFacing());</span>
<span class="nc" id="L1608">                    break;</span>
                case 2:
                    // TODO: backwards lateral shifts are switched:
                    // LATERAL_LEFT_BACKWARDS moves back+right and vice-versa
<span class="nc" id="L1612">                    cmd.findSimplePathTo(dest,</span>
                            MoveStepType.LATERAL_LEFT_BACKWARDS,
<span class="nc" id="L1614">                            src.direction(dest), ce().getFacing());</span>
<span class="nc" id="L1615">                    break;</span>
                case 3:
<span class="nc" id="L1617">                    cmd.findSimplePathTo(dest, MoveStepType.BACKWARDS,</span>
<span class="nc" id="L1618">                            src.direction(dest), ce().getFacing());</span>
<span class="nc" id="L1619">                    break;</span>
                case 4:
                    // TODO: backwards lateral shifts are switched:
                    // LATERAL_LEFT_BACKWARDS moves back+right and vice-versa
<span class="nc" id="L1623">                    cmd.findSimplePathTo(dest,</span>
                            MoveStepType.LATERAL_RIGHT_BACKWARDS,
<span class="nc" id="L1625">                            src.direction(dest), ce().getFacing());</span>
<span class="nc" id="L1626">                    break;</span>
                case 5:
<span class="nc" id="L1628">                    cmd.findSimplePathTo(dest, MoveStepType.LATERAL_LEFT,</span>
<span class="nc" id="L1629">                            src.direction(dest), ce().getFacing());</span>
                    break;
            }
<span class="nc bnc" id="L1632" title="All 2 branches missed.">        } else if (gear == GEAR_STRAFE) {</span>
            // Only set the steps that enter new hexes.
<span class="nc" id="L1634">            int start = cmd.length();</span>
<span class="nc" id="L1635">            cmd.findPathTo(dest, MoveStepType.FORWARDS);</span>
            // Skip turns at the beginning of the new part of the path unless we're extending
            // an existing strafing pattern.
<span class="nc bnc" id="L1638" title="All 4 branches missed.">            if (start &gt; 0 &amp;&amp; !cmd.getStep(start - 1).isStrafingStep()) {</span>
<span class="nc bnc" id="L1639" title="All 2 branches missed.">                while (start &lt; cmd.length()</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">                        &amp;&amp; cmd.getStep(start).getType() != MoveStepType.FORWARDS) {</span>
<span class="nc" id="L1641">                    start++;</span>
                }
            }
<span class="nc bnc" id="L1644" title="All 2 branches missed.">            for (int i = cmd.length() - 1; i &gt;= start; i--) {</span>
<span class="nc" id="L1645">                cmd.setStrafingStep(cmd.getStep(i).getPosition());</span>
            }
<span class="nc" id="L1647">            cmd.compile(clientgui.getClient().getGame(), ce(), false);</span>
<span class="nc" id="L1648">            gear = GEAR_LAND;</span>
<span class="nc bnc" id="L1649" title="All 4 branches missed.">        } else if ((gear == GEAR_LAND) || (gear == GEAR_JUMP)) {</span>
<span class="nc" id="L1650">            cmd.findPathTo(dest, MoveStepType.FORWARDS);</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">        } else if (gear == GEAR_BACKUP) {</span>
<span class="nc" id="L1652">            cmd.findPathTo(dest, MoveStepType.BACKWARDS);</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">        } else if (gear == GEAR_CHARGE) {</span>
<span class="nc" id="L1654">            cmd.findPathTo(dest, MoveStepType.CHARGE);</span>
            // The path planner shouldn't actually add the charge step
<span class="nc bnc" id="L1656" title="All 2 branches missed.">            if (cmd.getFinalCoords().equals(dest)</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">                &amp;&amp; (cmd.getLastStep().getType() != MoveStepType.CHARGE)) {</span>
<span class="nc" id="L1658">                cmd.removeLastStep();</span>
<span class="nc" id="L1659">                cmd.addStep(MoveStepType.CHARGE);</span>
            }
<span class="nc bnc" id="L1661" title="All 2 branches missed.">        } else if (gear == GEAR_DFA) {</span>
<span class="nc" id="L1662">            cmd.findPathTo(dest, MoveStepType.DFA);</span>
            // The path planner shouldn't actually add the DFA step
<span class="nc bnc" id="L1664" title="All 2 branches missed.">            if (cmd.getFinalCoords().equals(dest)</span>
<span class="nc bnc" id="L1665" title="All 2 branches missed.">                &amp;&amp; (cmd.getLastStep().getType() != MoveStepType.DFA)) {</span>
<span class="nc" id="L1666">                cmd.removeLastStep();</span>
<span class="nc" id="L1667">                cmd.addStep(MoveStepType.DFA);</span>
            }
<span class="nc bnc" id="L1669" title="All 2 branches missed.">        } else if (gear == GEAR_SWIM) {</span>
<span class="nc" id="L1670">            cmd.findPathTo(dest, MoveStepType.SWIM);</span>
<span class="nc bnc" id="L1671" title="All 2 branches missed.">        } else if (gear == GEAR_RAM) {</span>
<span class="nc" id="L1672">            cmd.findPathTo(dest, MoveStepType.FORWARDS);</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">        } else if (gear == GEAR_IMMEL) {</span>
<span class="nc" id="L1674">            cmd.addStep(MoveStepType.UP, true, true);</span>
<span class="nc" id="L1675">            cmd.addStep(MoveStepType.UP, true, true);</span>
<span class="nc" id="L1676">            cmd.addStep(MoveStepType.DEC, true, true);</span>
<span class="nc" id="L1677">            cmd.addStep(MoveStepType.DEC, true, true);</span>
<span class="nc" id="L1678">            cmd.rotatePathfinder(cmd.getFinalCoords().direction(dest), true);</span>
<span class="nc" id="L1679">            gear = GEAR_LAND;</span>
<span class="nc bnc" id="L1680" title="All 2 branches missed.">        } else if (gear == GEAR_SPLIT_S) {</span>
<span class="nc" id="L1681">            cmd.addStep(MoveStepType.DOWN, true, true);</span>
<span class="nc" id="L1682">            cmd.addStep(MoveStepType.DOWN, true, true);</span>
<span class="nc" id="L1683">            cmd.addStep(MoveStepType.ACC, true, true);</span>
<span class="nc" id="L1684">            cmd.rotatePathfinder(cmd.getFinalCoords().direction(dest), true);</span>
<span class="nc" id="L1685">            gear = GEAR_LAND;</span>
        }
<span class="nc bnc" id="L1687" title="All 4 branches missed.">        if (gear == GEAR_LONGEST_WALK || gear == GEAR_LONGEST_RUN) {</span>
            int maxMp;
            MoveStepType stepType;
<span class="nc bnc" id="L1690" title="All 2 branches missed.">            if (gear == GEAR_LONGEST_WALK) {</span>
<span class="nc" id="L1691">                maxMp = ce().getWalkMP();</span>
<span class="nc" id="L1692">                stepType = MoveStepType.BACKWARDS;</span>
<span class="nc" id="L1693">                gear = GEAR_BACKUP;</span>
            } else {
<span class="nc" id="L1695">                maxMp = ce().getRunMPwithoutMASC();</span>
<span class="nc" id="L1696">                stepType = MoveStepType.FORWARDS;</span>
<span class="nc" id="L1697">                gear = GEAR_LAND;</span>
            }

            LongestPathFinder lpf;
<span class="nc bnc" id="L1701" title="All 2 branches missed.">            if (ce().isAero()) {</span>
<span class="nc" id="L1702">                lpf = LongestPathFinder.newInstanceOfAeroPath(maxMp, ce()</span>
<span class="nc" id="L1703">                        .getGame());</span>
            } else {
<span class="nc" id="L1705">                lpf = LongestPathFinder.newInstanceOfLongestPath(maxMp,</span>
<span class="nc" id="L1706">                                                                 stepType, ce().getGame());</span>
            }
<span class="nc" id="L1708">            final int timeLimit = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L1709">                                                   .getMaxPathfinderTime();</span>
<span class="nc" id="L1710">            lpf.addStopCondition(new AbstractPathFinder.StopConditionTimeout&lt;MovePath&gt;(</span>
                    timeLimit * 4));

<span class="nc" id="L1713">            lpf.run(cmd);</span>
<span class="nc" id="L1714">            MovePath lPath = lpf.getComputedPath(dest);</span>
<span class="nc bnc" id="L1715" title="All 2 branches missed.">            if (lPath != null) {</span>
<span class="nc" id="L1716">                cmd = lPath;</span>
            }
        }
<span class="nc" id="L1719">        clientgui.bv.setWeaponFieldofFire(ce(), cmd);</span>
<span class="nc" id="L1720">    }</span>

    //
    // BoardListener
    //
    @Override
    public synchronized void hexMoused(BoardViewEvent b) {
<span class="nc bnc" id="L1727" title="All 2 branches missed.">        if (clientgui == null) {</span>
<span class="nc" id="L1728">            return;</span>
        }

<span class="nc" id="L1731">        final Entity ce = ce();</span>

        // Are we ignoring events?
<span class="nc bnc" id="L1734" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1735">            return;</span>
        }

        // don't make a movement path for aeros if advanced movement is on
<span class="nc bnc" id="L1739" title="All 4 branches missed.">        boolean nopath = (ce != null &amp;&amp; ce.isAero())</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">                         &amp;&amp; clientgui.getClient().getGame().useVectorMove();</span>

        // ignore buttons other than 1
<span class="nc bnc" id="L1743" title="All 2 branches missed.">        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L1744" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.BUTTON1_MASK) == 0)) {</span>
<span class="nc" id="L1745">            return;</span>
        }
        // control pressed means a line of sight check.
        // added ALT_MASK by kenn
<span class="nc bnc" id="L1749" title="All 2 branches missed.">        if (((b.getModifiers() &amp; InputEvent.CTRL_MASK) != 0)</span>
<span class="nc bnc" id="L1750" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.ALT_MASK) != 0)) {</span>
<span class="nc" id="L1751">            return;</span>
        }
        // check for shifty goodness
<span class="nc bnc" id="L1754" title="All 4 branches missed.">        if (shiftheld != ((b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0)) {</span>
<span class="nc bnc" id="L1755" title="All 2 branches missed.">            shiftheld = (b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0;</span>
        }
<span class="nc bnc" id="L1757" title="All 2 branches missed.">        Coords currPosition = cmd != null ? cmd.getFinalCoords()</span>
<span class="nc bnc" id="L1758" title="All 2 branches missed.">                                          : ce != null ? ce.getPosition() : null;</span>

<span class="nc bnc" id="L1760" title="All 4 branches missed.">        if ((b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) &amp;&amp; !nopath) {</span>
<span class="nc bnc" id="L1761" title="All 6 branches missed.">            if (!b.getCoords().equals(currPosition) || shiftheld</span>
                || (gear == MovementDisplay.GEAR_TURN)) {
<span class="nc" id="L1763">                clientgui.getBoardView().cursor(b.getCoords());</span>
                // either turn or move
<span class="nc bnc" id="L1765" title="All 2 branches missed.">                if (ce != null) {</span>
<span class="nc" id="L1766">                    currentMove(b.getCoords());</span>
<span class="nc" id="L1767">                    clientgui.bv.drawMovementData(ce(), cmd);</span>
                }
            }
<span class="nc bnc" id="L1770" title="All 2 branches missed.">        } else if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</span>
<span class="nc" id="L1771">            Coords moveto = b.getCoords();</span>
<span class="nc" id="L1772">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L1773" title="All 4 branches missed.">            if (shiftheld || (gear == MovementDisplay.GEAR_TURN)) {</span>
<span class="nc" id="L1774">                butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</span>
<span class="nc" id="L1775">                        + Messages.getString(&quot;MovementDisplay.Move&quot;)</span>
                        + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$

                // Set the button's label to &quot;Done&quot;
                // if the entire move is impossible.
<span class="nc" id="L1780">                MovePath possible = cmd.clone();</span>
<span class="nc" id="L1781">                possible.clipToPossible();</span>
<span class="nc bnc" id="L1782" title="All 2 branches missed.">                if (possible.length() == 0) {</span>
<span class="nc" id="L1783">                    butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot;</span>
<span class="nc" id="L1784">                            + Messages.getString(&quot;MovementDisplay.Done&quot;)</span>
                            + &quot;&lt;/b&gt;&lt;/html&gt;&quot;);
                    //$NON-NLS-1$
                }
<span class="nc" id="L1788">                return;</span>
            } else {
<span class="nc" id="L1790">                clientgui.getBoardView().select(b.getCoords());</span>
            }
<span class="nc bnc" id="L1792" title="All 2 branches missed.">            if (gear == MovementDisplay.GEAR_RAM) {</span>
                // check if target is valid
<span class="nc" id="L1794">                final Targetable target = chooseTarget(b.getCoords());</span>
<span class="nc bnc" id="L1795" title="All 4 branches missed.">                if ((target == null) || target.equals(ce)</span>
<span class="nc bnc" id="L1796" title="All 2 branches missed.">                        || !target.isAero()) {</span>
<span class="nc" id="L1797">                    clientgui.doAlertDialog(</span>
<span class="nc" id="L1798">                            Messages.getString(&quot;MovementDisplay.CantRam&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1799">                            Messages.getString(&quot;MovementDisplay.NoTarget&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1800">                    clear();</span>
<span class="nc" id="L1801">                    return;</span>
                }

                // check if it's a valid ram
                // First I need to add moves to the path if advanced
<span class="nc bnc" id="L1806" title="All 2 branches missed.">                if (ce.isAero()</span>
<span class="nc bnc" id="L1807" title="All 2 branches missed.">                        &amp;&amp; clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc" id="L1808">                    cmd.clipToPossible();</span>
                    // cmd = addSteps(cmd, ce, clientgui.getClient());
                }

<span class="nc" id="L1812">                cmd.addStep(MoveStepType.RAM);</span>

<span class="nc" id="L1814">                ToHitData toHit = new RamAttackAction(cen,</span>
<span class="nc" id="L1815">                        target.getTargetType(), target.getTargetId(),</span>
<span class="nc" id="L1816">                        target.getPosition()).toHit(clientgui.getClient()</span>
<span class="nc" id="L1817">                        .getGame(), cmd);</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">                if (toHit.getValue() != TargetRoll.IMPOSSIBLE) {</span>

                    // Determine how much damage the charger will take.
<span class="nc" id="L1821">                    IAero ta = (IAero) target;</span>
<span class="nc" id="L1822">                    IAero ae = (IAero) ce;</span>
<span class="nc" id="L1823">                    int toAttacker = RamAttackAction.getDamageTakenBy(ae, (Entity)ta,</span>
<span class="nc" id="L1824">                            cmd.getSecondFinalPosition(ce.getPosition()),</span>
<span class="nc" id="L1825">                            cmd.getHexesMoved(), ta.getCurrentVelocity());</span>
<span class="nc" id="L1826">                    int toDefender = RamAttackAction.getDamageFor(ae, (Entity)ta,</span>
<span class="nc" id="L1827">                            cmd.getSecondFinalPosition(ce.getPosition()),</span>
<span class="nc" id="L1828">                            cmd.getHexesMoved(), ta.getCurrentVelocity());</span>

                    // Ask the player if they want to charge.
<span class="nc" id="L1831">                    if (clientgui</span>
<span class="nc bnc" id="L1832" title="All 2 branches missed.">                            .doYesNoDialog(</span>
<span class="nc" id="L1833">                                    Messages.getString(</span>
                                            &quot;MovementDisplay.RamDialog.title&quot;,
                                            new Object[] { target
<span class="nc" id="L1836">                                                    .getDisplayName() }), //$NON-NLS-1$</span>
<span class="nc" id="L1837">                                    Messages.getString(</span>
                                            &quot;MovementDisplay.RamDialog.message&quot;, new Object[] { //$NON-NLS-1$
<span class="nc" id="L1839">                                                    toHit.getValueAsString(),</span>
<span class="nc" id="L1840">                                                    Double.valueOf(</span>
<span class="nc" id="L1841">                                                            Compute.oddsAbove(</span>
<span class="nc" id="L1842">                                                                    toHit.getValue(),</span>
<span class="nc" id="L1843">                                                                    ce().hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING))),</span>
<span class="nc" id="L1844">                                                    toHit.getDesc(),</span>
<span class="nc" id="L1845">                                                    Integer.valueOf(toDefender),</span>
<span class="nc" id="L1846">                                                    toHit.getTableDesc(),</span>
<span class="nc" id="L1847">                                                    Integer.valueOf(toAttacker) }))) {</span>
                        // if they answer yes, charge the target.
<span class="nc" id="L1849">                        cmd.getLastStep().setTarget(target);</span>
<span class="nc" id="L1850">                        ready();</span>
                    } else {
                        // else clear movement
<span class="nc" id="L1853">                        clear();</span>
                    }
<span class="nc" id="L1855">                    return;</span>
                }
                // if not valid, tell why
<span class="nc" id="L1858">                clientgui.doAlertDialog(</span>
<span class="nc" id="L1859">                        Messages.getString(&quot;MovementDisplay.CantRam&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1860">                        toHit.getDesc());</span>
<span class="nc" id="L1861">                clear();</span>
<span class="nc" id="L1862">                return;</span>
<span class="nc bnc" id="L1863" title="All 2 branches missed.">            } else if (gear == MovementDisplay.GEAR_CHARGE) {</span>
                // check if target is valid
<span class="nc" id="L1865">                final Targetable target = chooseTarget(b.getCoords());</span>
<span class="nc bnc" id="L1866" title="All 4 branches missed.">                if ((target == null) || target.equals(ce)) {</span>
<span class="nc" id="L1867">                    clientgui.doAlertDialog(</span>
<span class="nc bnc" id="L1868" title="All 2 branches missed.">                            Messages.getString(ce.isAirborneVTOLorWIGE()?</span>
<span class="nc" id="L1869">                                    &quot;MovementDisplay.CantRam&quot;:&quot;MovementDisplay.CantCharge&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1870">                            Messages.getString(&quot;MovementDisplay.NoTarget&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1871">                    clear();</span>
<span class="nc" id="L1872">                    computeMovementEnvelope(ce);</span>
<span class="nc" id="L1873">                    return;</span>
                }

                // check if it's a valid charge
<span class="nc" id="L1877">                ToHitData toHit = null;</span>
<span class="nc bnc" id="L1878" title="All 2 branches missed.">                if (ce.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L1879">                    toHit = new AirmechRamAttackAction(cen,</span>
<span class="nc" id="L1880">                            target.getTargetType(), target.getTargetId(),</span>
<span class="nc" id="L1881">                            target.getPosition()).toHit(clientgui.getClient()</span>
<span class="nc" id="L1882">                                    .getGame(), cmd);</span>
                } else {
<span class="nc" id="L1884">                    toHit = new ChargeAttackAction(cen,</span>
<span class="nc" id="L1885">                            target.getTargetType(), target.getTargetId(),</span>
<span class="nc" id="L1886">                            target.getPosition()).toHit(clientgui.getClient()</span>
<span class="nc" id="L1887">                                    .getGame(), cmd);</span>
                }
<span class="nc bnc" id="L1889" title="All 2 branches missed.">                if (toHit.getValue() != TargetRoll.IMPOSSIBLE) {</span>
                    // Determine how much damage the charger will take.
<span class="nc" id="L1891">                    int toDefender = 0;</span>
<span class="nc" id="L1892">                    int toAttacker = 0;</span>
<span class="nc bnc" id="L1893" title="All 2 branches missed.">                    if (ce.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L1894">                        toAttacker = AirmechRamAttackAction.getDamageTakenBy(ce, target, cmd.getHexesMoved());</span>
<span class="nc" id="L1895">                        toDefender = AirmechRamAttackAction.getDamageFor(ce, cmd.getHexesMoved());</span>
                    } else {
<span class="nc" id="L1897">                        toDefender = ChargeAttackAction.getDamageFor(</span>
<span class="nc" id="L1898">                                        ce, clientgui.getClient().getGame().getOptions()</span>
<span class="nc" id="L1899">                                                .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
<span class="nc" id="L1900">                                        cmd.getHexesMoved());</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">                        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L1902">                            Entity te = (Entity) target;</span>
<span class="nc" id="L1903">                            toAttacker = ChargeAttackAction.getDamageTakenBy(ce,</span>
                                    te,
<span class="nc" id="L1905">                                    clientgui.getClient().getGame().getOptions()</span>
<span class="nc" id="L1906">                                            .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE), //$NON-NLS-1$</span>
<span class="nc" id="L1907">                                    cmd.getHexesMoved());</span>
<span class="nc bnc" id="L1908" title="All 2 branches missed.">                        } else if ((target.getTargetType() == Targetable.TYPE_FUEL_TANK)</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">                                   || (target.getTargetType() == Targetable.TYPE_BUILDING)) {</span>
<span class="nc" id="L1910">                            Building bldg = clientgui.getClient().getGame()</span>
<span class="nc" id="L1911">                                                     .getBoard().getBuildingAt(moveto);</span>
<span class="nc" id="L1912">                            toAttacker = ChargeAttackAction.getDamageTakenBy(ce,</span>
                                                                             bldg, moveto);
                        }
                    }

<span class="nc" id="L1917">                    String title = &quot;MovementDisplay.ChargeDialog.title&quot;;</span>
<span class="nc" id="L1918">                    String msg = &quot;MovementDisplay.ChargeDialog.message&quot;;</span>
<span class="nc bnc" id="L1919" title="All 2 branches missed.">                    if (ce.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L1920">                        title = &quot;MovementDisplay.AirmechRamDialog.title&quot;;</span>
<span class="nc" id="L1921">                        msg = &quot;MovementDisplay.AirmechRamDialog.message&quot;;</span>
                    }
                    // Ask the player if they want to charge.
<span class="nc" id="L1924">                    if (clientgui</span>
<span class="nc bnc" id="L1925" title="All 2 branches missed.">                            .doYesNoDialog(Messages.getString(title, new Object[] { target.getDisplayName() }), //$NON-NLS-1$</span>
<span class="nc" id="L1926">                                    Messages.getString(msg,new Object[] {//$NON-NLS-1$</span>
<span class="nc" id="L1927">                                            toHit.getValueAsString(),</span>
<span class="nc" id="L1928">                                            Double.valueOf(</span>
<span class="nc" id="L1929">                                                    Compute.oddsAbove(toHit</span>
<span class="nc" id="L1930">                                                            .getValue())),</span>
<span class="nc" id="L1931">                                            toHit.getDesc(),</span>
<span class="nc" id="L1932">                                            toDefender,</span>
<span class="nc" id="L1933">                                            toHit.getTableDesc(),</span>
<span class="nc" id="L1934">                                            Integer.valueOf(toAttacker) }))) {</span>
                        // if they answer yes, charge the target.
<span class="nc" id="L1936">                        cmd.getLastStep().setTarget(target);</span>
<span class="nc" id="L1937">                        ready();</span>
                    } else {
                        // else clear movement
<span class="nc" id="L1940">                        clear();</span>
                    }
<span class="nc" id="L1942">                    return;</span>
                }
                // if not valid, tell why
<span class="nc" id="L1945">                clientgui.doAlertDialog(</span>
<span class="nc" id="L1946">                        Messages.getString(&quot;MovementDisplay.CantCharge&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1947">                        toHit.getDesc());</span>
<span class="nc" id="L1948">                clear();</span>
<span class="nc" id="L1949">                computeMovementEnvelope(ce);</span>
<span class="nc" id="L1950">                return;</span>
<span class="nc bnc" id="L1951" title="All 2 branches missed.">            } else if (gear == MovementDisplay.GEAR_DFA) {</span>
                // check if target is valid
<span class="nc" id="L1953">                final Targetable target = chooseTarget(b.getCoords());</span>
<span class="nc bnc" id="L1954" title="All 4 branches missed.">                if ((target == null) || target.equals(ce)) {</span>
<span class="nc" id="L1955">                    clientgui.doAlertDialog(</span>
<span class="nc" id="L1956">                            Messages.getString(&quot;MovementDisplay.CantDFA&quot;),</span>
<span class="nc" id="L1957">                            Messages.getString(&quot;MovementDisplay.NoTarget&quot;));</span>
<span class="nc" id="L1958">                    clear();</span>
<span class="nc" id="L1959">                    computeMovementEnvelope(ce);</span>
<span class="nc" id="L1960">                    return;</span>
                }

                // check if it's a valid DFA
<span class="nc" id="L1964">                ToHitData toHit = DfaAttackAction.toHit(clientgui.getClient().getGame(), cen, target, cmd);</span>
<span class="nc bnc" id="L1965" title="All 2 branches missed.">                if (toHit.getValue() != TargetRoll.IMPOSSIBLE) {</span>
                    // if yes, ask them if they want to DFA
<span class="nc bnc" id="L1967" title="All 2 branches missed.">                    if (clientgui.doYesNoDialog(</span>
<span class="nc" id="L1968">                            Messages.getString(&quot;MovementDisplay.DFADialog.title&quot;,</span>
<span class="nc" id="L1969">                                    target.getDisplayName()),</span>
<span class="nc" id="L1970">                            Messages.getString(&quot;MovementDisplay.DFADialog.message&quot;,</span>
<span class="nc" id="L1971">                                    toHit.getValueAsString(), Compute.oddsAbove(toHit.getValue()),</span>
<span class="nc" id="L1972">                                    toHit.getDesc(),</span>
<span class="nc" id="L1973">                                    DfaAttackAction.getDamageFor(ce, target.isConventionalInfantry()),</span>
<span class="nc" id="L1974">                                    toHit.getTableDesc(), DfaAttackAction.getDamageTakenBy(ce)))) {</span>
                        // if they answer yes, DFA the target
<span class="nc" id="L1976">                        cmd.getLastStep().setTarget(target);</span>
<span class="nc" id="L1977">                        ready();</span>
                    } else {
                        // else clear movement
<span class="nc" id="L1980">                        clear();</span>
                    }
<span class="nc" id="L1982">                    return;</span>
                }
                // if not valid, tell why
<span class="nc" id="L1985">                clientgui.doAlertDialog(Messages.getString(&quot;MovementDisplay.CantDFA&quot;), toHit.getDesc());</span>
<span class="nc" id="L1986">                clear();</span>
<span class="nc" id="L1987">                return;</span>
            }
<span class="nc" id="L1989">            butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L1990">            updateProneButtons();</span>
<span class="nc" id="L1991">            updateRACButton();</span>
<span class="nc" id="L1992">            updateSearchlightButton();</span>
<span class="nc" id="L1993">            updateLoadButtons();</span>
<span class="nc" id="L1994">            updateElevationButtons();</span>
<span class="nc" id="L1995">            updateTakeOffButtons();</span>
<span class="nc" id="L1996">            updateLandButtons();</span>
<span class="nc" id="L1997">            updateEvadeButton();</span>
<span class="nc" id="L1998">            updateBootleggerButton();</span>
<span class="nc" id="L1999">            updateShutdownButton();</span>
<span class="nc" id="L2000">            updateStartupButton();</span>
<span class="nc" id="L2001">            updateSelfDestructButton();</span>
<span class="nc" id="L2002">            updateTraitorButton();</span>
<span class="nc" id="L2003">            updateFlyOffButton();</span>
<span class="nc" id="L2004">            updateLaunchButton();</span>
<span class="nc" id="L2005">            updateDropButton();</span>
<span class="nc" id="L2006">            updateConvertModeButton();</span>
<span class="nc" id="L2007">            updateRecklessButton();</span>
<span class="nc" id="L2008">            updateHoverButton();</span>
<span class="nc" id="L2009">            updateManeuverButton();</span>
<span class="nc" id="L2010">            updateSpeedButtons();</span>
<span class="nc" id="L2011">            updateThrustButton();</span>
<span class="nc" id="L2012">            updateRollButton();</span>
<span class="nc" id="L2013">            updateTurnButton();</span>
<span class="nc" id="L2014">            updateTakeCoverButton();</span>
<span class="nc" id="L2015">            updateLayMineButton();</span>
<span class="nc" id="L2016">            checkFuel();</span>
<span class="nc" id="L2017">            checkOOC();</span>
<span class="nc" id="L2018">            checkAtmosphere();</span>
        }
<span class="nc" id="L2020">    }</span>
    
    private void updateTakeCoverButton() {
<span class="nc" id="L2023">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L2024">        final GameOptions gOpts = game.getOptions();</span>
<span class="nc" id="L2025">        boolean isInfantry = (ce() instanceof Infantry);</span>
        
        // Infantry - Taking Cover
<span class="nc bnc" id="L2028" title="All 4 branches missed.">        if (isInfantry &amp;&amp; gOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_TAKE_COVER)) {</span>
            // Determine the current position of the infantry
            Coords pos;
            int elevation;
<span class="nc bnc" id="L2032" title="All 2 branches missed.">            if (cmd == null) {</span>
<span class="nc" id="L2033">                pos = ce().getPosition();</span>
<span class="nc" id="L2034">                elevation = ce().getElevation();</span>
            } else {
<span class="nc" id="L2036">                pos = cmd.getFinalCoords();</span>
<span class="nc" id="L2037">                elevation = cmd.getFinalElevation();</span>
            }
<span class="nc" id="L2039">            getBtn(MoveCommand.MOVE_TAKE_COVER).setEnabled(</span>
<span class="nc" id="L2040">                    Infantry.hasValidCover(game, pos, elevation));</span>
<span class="nc" id="L2041">        } else {</span>
<span class="nc" id="L2042">            getBtn(MoveCommand.MOVE_TAKE_COVER).setEnabled(false);</span>
        }
<span class="nc" id="L2044">    }</span>

    private synchronized void updateProneButtons() {
<span class="nc" id="L2047">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">        if (ce != null) {</span>
<span class="nc" id="L2049">            boolean isMech = ce instanceof Mech;</span>

<span class="nc bnc" id="L2051" title="All 2 branches missed.">            if (cmd.getFinalProne()) {</span>
<span class="nc bnc" id="L2052" title="All 4 branches missed.">                setGetUpEnabled(!ce.isImmobile() &amp;&amp; !ce.isStuck());</span>
<span class="nc" id="L2053">                setGoProneEnabled(false);</span>
<span class="nc" id="L2054">                setHullDownEnabled(true);</span>
<span class="nc bnc" id="L2055" title="All 2 branches missed.">            } else if (cmd.getFinalHullDown()) {</span>
<span class="nc bnc" id="L2056" title="All 2 branches missed.">                if (isMech) {</span>
<span class="nc bnc" id="L2057" title="All 4 branches missed.">                    setGetUpEnabled(!ce.isImmobile() &amp;&amp; !ce.isStuck()</span>
<span class="nc bnc" id="L2058" title="All 2 branches missed.">                                    &amp;&amp; !((Mech) ce).cannotStandUpFromHullDown());</span>
                } else {
<span class="nc bnc" id="L2060" title="All 4 branches missed.">                    setGetUpEnabled(!ce.isImmobile() &amp;&amp; !ce.isStuck());</span>
                }
<span class="nc bnc" id="L2062" title="All 6 branches missed.">                setGoProneEnabled(!ce.isImmobile() &amp;&amp; isMech &amp;&amp; !ce.isStuck());</span>
<span class="nc" id="L2063">                setHullDownEnabled(false);</span>
            } else {
<span class="nc" id="L2065">                setGetUpEnabled(false);</span>
<span class="nc bnc" id="L2066" title="All 6 branches missed.">                setGoProneEnabled(!ce.isImmobile() &amp;&amp; isMech &amp;&amp; !ce.isStuck()</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">                                  &amp;&amp; !(getBtn(MoveCommand.MOVE_GET_UP).isEnabled()));</span>
<span class="nc bnc" id="L2068" title="All 4 branches missed.">                if (!(ce instanceof Tank) &amp;&amp; !(ce instanceof QuadVee</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">                        &amp;&amp; ce.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)) {</span>
<span class="nc" id="L2070">                    setHullDownEnabled(ce.canGoHullDown());</span>
                } else {
                    // So that vehicle can move and go hull-down, we have to
                    // check if it's moved into a fortified position
<span class="nc bnc" id="L2074" title="All 2 branches missed.">                    if (cmd.getLastStep() != null) {</span>
<span class="nc" id="L2075">                        boolean hullDownEnabled = clientgui.getClient()</span>
<span class="nc" id="L2076">                                                           .getGame().getOptions()</span>
<span class="nc" id="L2077">                                                           .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_HULL_DOWN);</span>
<span class="nc" id="L2078">                        IHex occupiedHex = clientgui.getClient().getGame()</span>
<span class="nc" id="L2079">                                                    .getBoard()</span>
<span class="nc" id="L2080">                                                    .getHex(cmd.getLastStep().getPosition());</span>
<span class="nc" id="L2081">                        boolean fortifiedHex = occupiedHex</span>
<span class="nc" id="L2082">                                .containsTerrain(Terrains.FORTIFIED);</span>
<span class="nc bnc" id="L2083" title="All 4 branches missed.">                        setHullDownEnabled(hullDownEnabled &amp;&amp; fortifiedHex);</span>
<span class="nc" id="L2084">                    } else {</span>
                        // If there's queued up movement, we can call the
                        // canGoHullDown() method in the Tank class.
<span class="nc" id="L2087">                        setHullDownEnabled(ce.canGoHullDown());</span>
                    }

                }
            }
<span class="nc" id="L2092">        } else {</span>
<span class="nc" id="L2093">            setGetUpEnabled(false);</span>
<span class="nc" id="L2094">            setGoProneEnabled(false);</span>
<span class="nc" id="L2095">            setHullDownEnabled(false);</span>
        }
<span class="nc" id="L2097">    }</span>

    private void updateRACButton() {
<span class="nc" id="L2100">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2101" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2102">            return;</span>
        }
<span class="nc" id="L2104">        GameOptions opts = clientgui.getClient().getGame().getOptions();</span>
<span class="nc bnc" id="L2105" title="All 8 branches missed.">        setUnjamEnabled(ce.canUnjamRAC()</span>
                &amp;&amp; ((gear == MovementDisplay.GEAR_LAND)
                        || (gear == MovementDisplay.GEAR_TURN) 
                        || (gear == MovementDisplay.GEAR_BACKUP))
<span class="nc bnc" id="L2109" title="All 2 branches missed.">                &amp;&amp; ((cmd.getMpUsed() &lt;= ce.getWalkMP()) </span>
<span class="nc bnc" id="L2110" title="All 2 branches missed.">                        || (cmd.getLastStep().isOnlyPavement() </span>
<span class="nc bnc" id="L2111" title="All 2 branches missed.">                                &amp;&amp; (cmd.getMpUsed() &lt;= (ce.getWalkMP() + 1))))</span>
<span class="nc bnc" id="L2112" title="All 2 branches missed.">                &amp;&amp; !(opts.booleanOption(&quot;tacops_tank_crews&quot;)</span>
<span class="nc bnc" id="L2113" title="All 4 branches missed.">                        &amp;&amp; (cmd.getMpUsed() &gt; 0) &amp;&amp; (ce instanceof Tank) </span>
<span class="nc bnc" id="L2114" title="All 2 branches missed.">                        &amp;&amp; (ce.getCrew().getSize() &lt; 2)));</span>
<span class="nc" id="L2115">    }</span>

    private void updateSearchlightButton() {
<span class="nc" id="L2118">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2119" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2120">            return;</span>
        }
<span class="nc" id="L2122">        setSearchlightEnabled(</span>
<span class="nc bnc" id="L2123" title="All 4 branches missed.">                ce.hasSpotlight() &amp;&amp; !cmd.contains(MoveStepType.SEARCHLIGHT),</span>
<span class="nc" id="L2124">                ce().isUsingSpotlight());</span>
<span class="nc" id="L2125">    }</span>

    private synchronized void updateElevationButtons() {
<span class="nc" id="L2128">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2129" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2130">            return;</span>
        }

<span class="nc bnc" id="L2133" title="All 2 branches missed.">        if (ce.isAirborne()) {</span>
            // then use altitude not elevation
<span class="nc" id="L2135">            setRaiseEnabled(ce.canGoUp(cmd.getFinalAltitude(),</span>
<span class="nc" id="L2136">                                       cmd.getFinalCoords()));</span>
<span class="nc" id="L2137">            setLowerEnabled(ce.canGoDown(cmd.getFinalAltitude(),</span>
<span class="nc" id="L2138">                                         cmd.getFinalCoords()));</span>
<span class="nc" id="L2139">            return;</span>
        }
        // WiGEs (and LAMs and glider protomechs) cannot go up if they've used ground movement.
<span class="nc bnc" id="L2142" title="All 2 branches missed.">        if ((ce.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">                &amp;&amp; !ce.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">                &amp;&amp; (cmd.getMpUsed() &gt; 0)</span>
<span class="nc bnc" id="L2145" title="All 2 branches missed.">                &amp;&amp; !cmd.contains(MoveStepType.UP)) {</span>
<span class="nc" id="L2146">            setRaiseEnabled(false);</span>
        } else {
<span class="nc" id="L2148">            setRaiseEnabled(ce.canGoUp(cmd.getFinalElevation(),</span>
<span class="nc" id="L2149">                                       cmd.getFinalCoords()));</span>
        }
<span class="nc" id="L2151">        setLowerEnabled(ce.canGoDown(cmd.getFinalElevation(),</span>
<span class="nc" id="L2152">                                     cmd.getFinalCoords()));</span>
<span class="nc" id="L2153">    }</span>

    private synchronized void updateTakeOffButtons() {

<span class="nc bnc" id="L2157" title="All 4 branches missed.">        if ((null != cmd) &amp;&amp; (cmd.length() &gt; 0)) {</span>
            // you can't take off if you have already moved
            // http://www.classicbattletech.com/forums/index.php?topic=54112.0
<span class="nc" id="L2160">            setTakeOffEnabled(false);</span>
<span class="nc" id="L2161">            setVTakeOffEnabled(false);</span>
<span class="nc" id="L2162">            return;</span>
        }

<span class="nc" id="L2165">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2166" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2167">            return;</span>
        }

<span class="nc bnc" id="L2170" title="All 2 branches missed.">        if (ce.isAero()) {</span>
<span class="nc bnc" id="L2171" title="All 2 branches missed.">            if (ce.isAirborne()) {</span>
<span class="nc" id="L2172">                setTakeOffEnabled(false);</span>
<span class="nc" id="L2173">                setVTakeOffEnabled(false);</span>
<span class="nc bnc" id="L2174" title="All 2 branches missed.">            } else if (!ce.isShutDown()) {</span>
<span class="nc" id="L2175">                setTakeOffEnabled(((IAero) ce).canTakeOffHorizontally());</span>
<span class="nc" id="L2176">                setVTakeOffEnabled(((IAero) ce).canTakeOffVertically());</span>
            }
        } else {
<span class="nc" id="L2179">            setTakeOffEnabled(false);</span>
<span class="nc" id="L2180">            setVTakeOffEnabled(false);</span>
        }
<span class="nc" id="L2182">    }</span>

    private synchronized void updateLandButtons() {

<span class="nc bnc" id="L2186" title="All 4 branches missed.">        if ((null != cmd) &amp;&amp; (cmd.length() &gt; 0)) {</span>
            // According to the link below, you can move in the air and then
            // land
            // but I have personal message to Welshman right now asking that
            // this be changed
            // because it creates all kinds of rules problems, the number one
            // being
            // the ability to use spheroid dropships to perform insta-Death From
            // Above attacks
            // that cannot be defended against
            // So we are going to disallow it
            // http://www.classicbattletech.com/forums/index.php?topic=54112.0
<span class="nc" id="L2198">            setLandEnabled(false);</span>
<span class="nc" id="L2199">            return;</span>
        }

<span class="nc" id="L2202">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2204">            return;</span>
        }

        // only allow landing on the ground map not atmosphere or space map
<span class="nc bnc" id="L2208" title="All 2 branches missed.">        if (!clientgui.getClient().getGame().getBoard().onGround()) {</span>
<span class="nc" id="L2209">            return;</span>
        }

<span class="nc bnc" id="L2212" title="All 2 branches missed.">        if (ce.isAero()) {</span>
<span class="nc bnc" id="L2213" title="All 4 branches missed.">            if (ce.isAirborne() &amp;&amp; (cmd.getFinalAltitude() == 1)) {</span>
<span class="nc" id="L2214">                setLandEnabled(((IAero) ce).canLandHorizontally());</span>
<span class="nc" id="L2215">                setVLandEnabled(((IAero) ce).canLandVertically());</span>
            }
        }

<span class="nc" id="L2219">    }</span>

    private void updateRollButton() {
<span class="nc" id="L2222">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2223" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2224">            return;</span>
        }

<span class="nc bnc" id="L2227" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L2228">            return;</span>
        }

<span class="nc" id="L2231">        setRollEnabled(true);</span>

<span class="nc bnc" id="L2233" title="All 2 branches missed.">        if (!clientgui.getClient().getGame().getBoard().inSpace()) {</span>
<span class="nc" id="L2234">            setRollEnabled(false);</span>
        }

<span class="nc bnc" id="L2237" title="All 2 branches missed.">        if (cmd.contains(MoveStepType.ROLL)) {</span>
<span class="nc" id="L2238">            setRollEnabled(false);</span>
        }

<span class="nc" id="L2241">        return;</span>

    }

    private void updateHoverButton() {
<span class="nc" id="L2246">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2247" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2248">            return;</span>
        }
        
<span class="nc bnc" id="L2251" title="All 2 branches missed.">        if (ce.isAero()) {</span>
<span class="nc bnc" id="L2252" title="All 2 branches missed.">            if (!((IAero)ce).isVSTOL()) {</span>
<span class="nc" id="L2253">                return;</span>
            }
<span class="nc bnc" id="L2255" title="All 2 branches missed.">            if (clientgui.getClient().getGame().getBoard().inSpace()) {</span>
<span class="nc" id="L2256">                return;</span>
            }
<span class="nc bnc" id="L2258" title="All 4 branches missed.">        } else if (!(ce instanceof Protomech) &amp;&amp; !(ce instanceof LandAirMech</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">                &amp;&amp; (((LandAirMech)ce).getConversionMode() == LandAirMech.CONV_MODE_AIRMECH))</span>
<span class="nc bnc" id="L2260" title="All 2 branches missed.">                &amp;&amp; (ce.getAltitude() &lt;= 3)) {</span>
<span class="nc" id="L2261">            return;</span>
        }

<span class="nc bnc" id="L2264" title="All 2 branches missed.">        if (!cmd.contains(MoveStepType.HOVER)) {</span>
<span class="nc" id="L2265">            setHoverEnabled(true);</span>
        } else {
<span class="nc" id="L2267">            setHoverEnabled(false);</span>
        }
<span class="nc" id="L2269">    }</span>

    private void updateThrustButton() {
<span class="nc" id="L2272">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2273" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2274">            return;</span>
        }

<span class="nc bnc" id="L2277" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L2278">            return;</span>
        }

        // only allow thrust if there is thrust left to spend
<span class="nc" id="L2282">        int mpUsed = 0;</span>
<span class="nc" id="L2283">        MoveStep last = cmd.getLastStep();</span>
<span class="nc bnc" id="L2284" title="All 2 branches missed.">        if (null != last) {</span>
<span class="nc" id="L2285">            mpUsed = last.getMpUsed();</span>
        }

<span class="nc bnc" id="L2288" title="All 2 branches missed.">        if (mpUsed &gt;= ce.getRunMP()) {</span>
<span class="nc" id="L2289">            setThrustEnabled(false);</span>
        } else {
<span class="nc" id="L2291">            setThrustEnabled(true);</span>
        }

<span class="nc" id="L2294">        return;</span>
    }

    private synchronized void updateSpeedButtons() {
<span class="nc" id="L2298">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2299" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2300">            return;</span>
        }

<span class="nc bnc" id="L2303" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L2304">            return;</span>
        }

<span class="nc" id="L2307">        IAero a = (IAero) ce;</span>

        // only allow acceleration and deceleration if the cmd is empty or the
        // last step was
        // acc/dec

<span class="nc" id="L2313">        setAccEnabled(false);</span>
<span class="nc" id="L2314">        setDecEnabled(false);</span>
<span class="nc" id="L2315">        MoveStep last = cmd.getLastStep();</span>
        // figure out implied velocity so you can't decelerate below zero
<span class="nc" id="L2317">        int vel = a.getCurrentVelocity();</span>
<span class="nc" id="L2318">        int veln = a.getNextVelocity();</span>
<span class="nc bnc" id="L2319" title="All 2 branches missed.">        if (null != last) {</span>
<span class="nc" id="L2320">            vel = last.getVelocity();</span>
<span class="nc" id="L2321">            veln = last.getVelocityN();</span>
        }

<span class="nc bnc" id="L2324" title="All 2 branches missed.">        if (null == last) {</span>
<span class="nc" id="L2325">            setAccEnabled(true);</span>
<span class="nc bnc" id="L2326" title="All 2 branches missed.">            if (vel &gt; 0) {</span>
<span class="nc" id="L2327">                setDecEnabled(true);</span>
            }
<span class="nc bnc" id="L2329" title="All 2 branches missed.">        } else if (last.getType() == MoveStepType.ACC) {</span>
<span class="nc" id="L2330">            setAccEnabled(true);</span>
<span class="nc bnc" id="L2331" title="All 4 branches missed.">        } else if ((last.getType() == MoveStepType.DEC) &amp;&amp; (vel &gt; 0)) {</span>
<span class="nc" id="L2332">            setDecEnabled(true);</span>
        }

        // if the aero has failed a maneuver this turn, then don't allow
<span class="nc bnc" id="L2336" title="All 2 branches missed.">        if (a.didFailManeuver()) {</span>
<span class="nc" id="L2337">            setAccEnabled(false);</span>
<span class="nc" id="L2338">            setDecEnabled(false);</span>
        }

        // if accelerated/decelerate at the end of last turn then disable
<span class="nc bnc" id="L2342" title="All 2 branches missed.">        if (a.didAccLast()) {</span>
<span class="nc" id="L2343">            setAccEnabled(false);</span>
<span class="nc" id="L2344">            setDecEnabled(false);</span>
        }

        // allow acc/dec next if acceleration/deceleration hasn't been used
<span class="nc" id="L2348">        setAccNEnabled(false);</span>
<span class="nc" id="L2349">        setDecNEnabled(false);</span>
<span class="nc bnc" id="L2350" title="All 4 branches missed.">        if (!cmd.contains(MoveStepType.ACC) &amp;&amp; !cmd.contains(MoveStepType.DEC)</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">            &amp;&amp; !cmd.contains(MoveStepType.DECN)) {</span>
<span class="nc" id="L2352">            setAccNEnabled(true);</span>
        }

<span class="nc bnc" id="L2355" title="All 4 branches missed.">        if (!cmd.contains(MoveStepType.ACC) &amp;&amp; !cmd.contains(MoveStepType.DEC)</span>
<span class="nc bnc" id="L2356" title="All 4 branches missed.">            &amp;&amp; !cmd.contains(MoveStepType.ACCN) &amp;&amp; (veln &gt; 0)) {</span>
<span class="nc" id="L2357">            setDecNEnabled(true);</span>
        }

        // acc/dec next needs to be disabled if acc/dec used before a failed
        // maneuver
<span class="nc bnc" id="L2362" title="All 4 branches missed.">        if (a.didFailManeuver() &amp;&amp; a.didAccDecNow()) {</span>
<span class="nc" id="L2363">            setDecNEnabled(false);</span>
<span class="nc" id="L2364">            setAccNEnabled(false);</span>
        }

        // if in atmosphere, limit acceleration to 2x safe thrust
<span class="nc bnc" id="L2368" title="All 2 branches missed.">        if (!clientgui.getClient().getGame().getBoard().inSpace()</span>
<span class="nc bnc" id="L2369" title="All 2 branches missed.">            &amp;&amp; (vel == (2 * ce.getWalkMP()))) {</span>
<span class="nc" id="L2370">            setAccEnabled(false);</span>
        }
        // velocity next will get halved before next turn so allow up to 4 times
<span class="nc bnc" id="L2373" title="All 2 branches missed.">        if (!clientgui.getClient().getGame().getBoard().inSpace()</span>
<span class="nc bnc" id="L2374" title="All 2 branches missed.">            &amp;&amp; (veln == (4 * ce.getWalkMP()))) {</span>
<span class="nc" id="L2375">            setAccNEnabled(false);</span>
        }

        // if this is a tele-operated missile then it can't decelerate no matter
        // what
<span class="nc bnc" id="L2380" title="All 2 branches missed.">        if (a instanceof TeleMissile) {</span>
<span class="nc" id="L2381">            setDecEnabled(false);</span>
<span class="nc" id="L2382">            setDecNEnabled(false);</span>
        }

<span class="nc" id="L2385">        return;</span>
    }

    private void updateDumpButton() {
        /*
         * if (ce() instanceof Aero) { Aero a = (Aero) ce();
         * setDumpEnabled(a.hasBombs() &amp;&amp; cmd.length() == 0); } else {
         * setDumpEnabled(false); }
         */
<span class="nc" id="L2394">    }</span>

    private void updateFlyOffButton() {
<span class="nc" id="L2397">        final Entity ce = ce();</span>

        // Aeros should be able to fly off if they reach a border hex with
        // velocity remaining and facing the right direction
<span class="nc bnc" id="L2401" title="All 6 branches missed.">        if ((ce == null) || !ce.isAero() || !ce.isAirborne()) {</span>
<span class="nc" id="L2402">            setFlyOffEnabled(false);</span>
<span class="nc" id="L2403">            return;</span>
        }

<span class="nc" id="L2406">        IAero a = (IAero) ce;</span>
<span class="nc" id="L2407">        MoveStep step = cmd.getLastStep();</span>
<span class="nc" id="L2408">        Coords position = ce.getPosition();</span>
<span class="nc" id="L2409">        int facing = ce.getFacing();</span>

<span class="nc" id="L2411">        int velocityLeft = a.getCurrentVelocity();</span>
<span class="nc bnc" id="L2412" title="All 2 branches missed.">        if (step != null) {</span>
<span class="nc" id="L2413">            position = step.getPosition();</span>
<span class="nc" id="L2414">            facing = step.getFacing();</span>
<span class="nc" id="L2415">            velocityLeft = step.getVelocityLeft();</span>
        }

<span class="nc" id="L2418">        final IBoard board = clientgui.getClient().getGame().getBoard();</span>
        // for spheroids in atmosphere we just need to check being on the edge
<span class="nc bnc" id="L2420" title="All 4 branches missed.">        if (a.isSpheroid() &amp;&amp; !board.inSpace()) {</span>
<span class="nc bnc" id="L2421" title="All 4 branches missed.">            setFlyOffEnabled((position != null) &amp;&amp; (ce.getWalkMP() &gt; 0)</span>
<span class="nc bnc" id="L2422" title="All 2 branches missed.">                    &amp;&amp; ((position.getX() == 0)</span>
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                            || (position.getX() == (board.getWidth() - 1))</span>
<span class="nc bnc" id="L2424" title="All 2 branches missed.">                            || (position.getY() == 0)</span>
<span class="nc bnc" id="L2425" title="All 2 branches missed.">                            || (position.getY() == (board.getHeight() - 1))));</span>
<span class="nc" id="L2426">            return;</span>
        }

        // for all aerodynes and spheroids in space it is more complicated - the
        // nose of the aircraft
        // must be facing in the righ direction and there must be velocity
        // remaining

<span class="nc bnc" id="L2434" title="All 2 branches missed.">        boolean evenx = (position.getX() % 2) == 0;</span>
<span class="nc bnc" id="L2435" title="All 8 branches missed.">        if ((velocityLeft &gt; 0) &amp;&amp; (((position.getX() == 0) &amp;&amp; ((facing == 5) || (facing == 4)))</span>
<span class="nc bnc" id="L2436" title="All 6 branches missed.">                || ((position.getX() == (board.getWidth() - 1))</span>
                        &amp;&amp; ((facing == 1) || (facing == 2)))
<span class="nc bnc" id="L2438" title="All 10 branches missed.">                || ((position.getY() == 0) &amp;&amp; ((facing == 1) || (facing == 5) || (facing == 0)) &amp;&amp; evenx)</span>
<span class="nc bnc" id="L2439" title="All 4 branches missed.">                || ((position.getY() == 0) &amp;&amp; (facing == 0))</span>
<span class="nc bnc" id="L2440" title="All 10 branches missed.">                || ((position.getY() == (board.getHeight() - 1))</span>
                        &amp;&amp; ((facing == 2) || (facing == 3) || (facing == 4)) &amp;&amp; !evenx)
<span class="nc bnc" id="L2442" title="All 4 branches missed.">                || ((position.getY() == (board.getHeight() - 1))</span>
                        &amp;&amp; (facing == 3)))) {
<span class="nc" id="L2444">            setFlyOffEnabled(true);</span>
        } else {
<span class="nc" id="L2446">            setFlyOffEnabled(false);</span>
        }
<span class="nc" id="L2448">    }</span>

    private void updateLaunchButton() {

<span class="nc" id="L2452">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2454" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2455">            return;</span>
        }

<span class="nc bnc" id="L2458" title="All 2 branches missed.">        setLaunchEnabled((ce.getLaunchableFighters().size() &gt; 0)</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">                || (ce.getLaunchableSmallCraft().size() &gt; 0)</span>
<span class="nc bnc" id="L2460" title="All 2 branches missed.">                || (ce.getLaunchableDropships().size() &gt; 0));</span>

<span class="nc" id="L2462">    }</span>

    // private void updateDockButton() {
    //
    // final Entity ce = ce();
    //
    // if (null == ce) {
    // return;
    // }
    //
    // updateRecoveryButton();
    //
    // }

    private void updateDropButton() {

<span class="nc" id="L2478">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2480" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2481">            return;</span>
        }

<span class="nc bnc" id="L2484" title="All 4 branches missed.">        setDropEnabled(ce.isAirborne() &amp;&amp; (ce.getDroppableUnits().size() &gt; 0));</span>

<span class="nc" id="L2486">    }</span>

    private void updateEvadeButton() {

<span class="nc" id="L2490">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2492" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2493">            return;</span>
        }

<span class="nc" id="L2496">        if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2497" title="All 2 branches missed.">                      .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_EVADE)) {</span>
<span class="nc" id="L2498">            return;</span>
        }

<span class="nc bnc" id="L2501" title="All 4 branches missed.">        if (!((ce instanceof Mech) || (ce instanceof Tank))) {</span>
<span class="nc" id="L2502">            return;</span>
        }

<span class="nc bnc" id="L2505" title="All 2 branches missed.">        setEvadeEnabled((cmd.getLastStepMovementType() != EntityMovementType.MOVE_JUMP)</span>
<span class="nc bnc" id="L2506" title="All 2 branches missed.">                        &amp;&amp; (cmd.getLastStepMovementType() != EntityMovementType.MOVE_SPRINT));</span>
<span class="nc" id="L2507">    }</span>

    private void updateBootleggerButton() {

<span class="nc" id="L2511">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2513" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2514">            return;</span>
        }

<span class="nc" id="L2517">        if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">                      .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2519">            return;</span>
        }
        
<span class="nc bnc" id="L2522" title="All 4 branches missed.">        if (!(ce instanceof Tank || ce instanceof QuadVee)) {</span>
<span class="nc" id="L2523">            return;</span>
        }
                
<span class="nc bnc" id="L2526" title="All 2 branches missed.">        if (ce.getMovementMode() != EntityMovementMode.WHEELED</span>
<span class="nc bnc" id="L2527" title="All 2 branches missed.">                &amp;&amp; ce.getMovementMode() != EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L2528" title="All 2 branches missed.">                &amp;&amp; ce.getMovementMode() != EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2529">            return;</span>
        }

<span class="nc bnc" id="L2532" title="All 4 branches missed.">        setBootleggerEnabled(cmd.getLastStep() != null &amp;&amp; cmd.getLastStep().getNStraight() &gt;= 3);</span>
<span class="nc" id="L2533">    }</span>

    private void updateShutdownButton() {

<span class="nc" id="L2537">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2539" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2540">            return;</span>
        }

<span class="nc" id="L2543">        if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2544" title="All 2 branches missed.">                      .booleanOption(OptionsConstants.RPG_MANUAL_SHUTDOWN)) {</span>
<span class="nc" id="L2545">            return;</span>
        }

<span class="nc bnc" id="L2548" title="All 2 branches missed.">        if (ce instanceof Infantry) {</span>
<span class="nc" id="L2549">            return;</span>
        }

<span class="nc bnc" id="L2552" title="All 4 branches missed.">        setShutdownEnabled(!ce.isManualShutdown() &amp;&amp; !ce.isStartupThisPhase());</span>
<span class="nc" id="L2553">    }</span>

    private void updateStartupButton() {

<span class="nc" id="L2557">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2559" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2560">            return;</span>
        }

<span class="nc" id="L2563">        if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2564" title="All 2 branches missed.">                      .booleanOption(OptionsConstants.RPG_MANUAL_SHUTDOWN)) {</span>
<span class="nc" id="L2565">            return;</span>
        }

<span class="nc bnc" id="L2568" title="All 2 branches missed.">        if (ce instanceof Infantry) {</span>
<span class="nc" id="L2569">            return;</span>
        }

<span class="nc bnc" id="L2572" title="All 4 branches missed.">        setStartupEnabled(ce.isManualShutdown() &amp;&amp; !ce.isShutDownThisPhase());</span>
<span class="nc" id="L2573">    }</span>

    private void updateSelfDestructButton() {

<span class="nc" id="L2577">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2579" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2580">            return;</span>
        }

<span class="nc" id="L2583">        if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2584" title="All 2 branches missed.">                      .booleanOption(OptionsConstants.ADVANCED_TACOPS_SELF_DESTRUCT)) {</span>
<span class="nc" id="L2585">            return;</span>
        }

<span class="nc bnc" id="L2588" title="All 2 branches missed.">        if (ce instanceof Infantry) {</span>
<span class="nc" id="L2589">            return;</span>
        }

<span class="nc bnc" id="L2592" title="All 4 branches missed.">        setSelfDestructEnabled(ce.hasEngine() &amp;&amp; ce.getEngine().isFusion()</span>
<span class="nc bnc" id="L2593" title="All 4 branches missed.">                               &amp;&amp; !ce.getSelfDestructing() &amp;&amp; !ce.getSelfDestructInitiated());</span>
<span class="nc" id="L2594">    }</span>

    private void updateTraitorButton() {

<span class="nc" id="L2598">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2600" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2601">            return;</span>
        }

<span class="nc" id="L2604">        setTraitorEnabled(true);</span>
<span class="nc" id="L2605">    }</span>
    
    private void updateConvertModeButton() {

<span class="nc bnc" id="L2609" title="All 4 branches missed.">        if (cmd.length() &gt; 0 &amp;&amp; cmd.getLastStep().getType() != MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L2610">            setModeConvertEnabled(false);</span>
<span class="nc" id="L2611">            return;</span>
        }
        
<span class="nc" id="L2614">        final Entity ce = ce();</span>
        
<span class="nc bnc" id="L2616" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2617">            setModeConvertEnabled(false);</span>
<span class="nc" id="L2618">            return;</span>
        }
        
<span class="nc bnc" id="L2621" title="All 2 branches missed.">        if (ce instanceof LandAirMech) {</span>
<span class="nc" id="L2622">            boolean canConvert = false;</span>
<span class="nc bnc" id="L2623" title="All 2 branches missed.">            for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc bnc" id="L2624" title="All 2 branches missed.">                if (i != ce.getConversionMode()</span>
<span class="nc bnc" id="L2625" title="All 2 branches missed.">                        &amp;&amp; ((LandAirMech)ce).canConvertTo(ce.getConversionMode(), i)) {</span>
<span class="nc" id="L2626">                    canConvert = true;</span>
                }
            }
<span class="nc bnc" id="L2629" title="All 2 branches missed.">            if (!canConvert) {</span>
<span class="nc" id="L2630">                setModeConvertEnabled(false);</span>
<span class="nc" id="L2631">                return;</span>
            }
<span class="nc bnc" id="L2633" title="All 4 branches missed.">        } else if (!(ce instanceof QuadVee</span>
<span class="nc bnc" id="L2634" title="All 2 branches missed.">                || (ce instanceof Mech &amp;&amp; ((Mech)ce).hasTracks()))) {</span>
<span class="nc" id="L2635">            setModeConvertEnabled(false);</span>
<span class="nc" id="L2636">            return;</span>
        }
        
<span class="nc" id="L2639">        IHex currHex =  clientgui.getClient().getGame().getBoard().getHex(ce.getPosition());</span>
<span class="nc bnc" id="L2640" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">                &amp;&amp; ce.getElevation() &lt; 0) {</span>
<span class="nc" id="L2642">            setModeConvertEnabled(false);</span>
<span class="nc" id="L2643">            return;</span>
        }
        
<span class="nc bnc" id="L2646" title="All 4 branches missed.">        if (ce instanceof LandAirMech &amp;&amp; ce.isGyroDestroyed()) {</span>
<span class="nc" id="L2647">            setModeConvertEnabled(false);</span>
<span class="nc" id="L2648">            return;</span>
        }
        
<span class="nc bnc" id="L2651" title="All 4 branches missed.">        if (ce instanceof QuadVee &amp;&amp; ((QuadVee)ce).conversionCost() &gt; ce.getRunMP()) {</span>
<span class="nc" id="L2652">            setModeConvertEnabled(false);</span>
<span class="nc" id="L2653">            return;</span>
        }
        
<span class="nc" id="L2656">        setModeConvertEnabled(true);</span>
<span class="nc" id="L2657">    }</span>

    private void updateRecklessButton() {

<span class="nc" id="L2661">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2663" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2664">            return;</span>
        }
        
<span class="nc bnc" id="L2667" title="All 2 branches missed.">        if (ce.isAirborne()) {</span>
<span class="nc" id="L2668">            setRecklessEnabled(false);</span>
        }

<span class="nc bnc" id="L2671" title="All 2 branches missed.">        if (ce instanceof Protomech) {</span>
<span class="nc" id="L2672">            setRecklessEnabled(false);</span>
        } else {
<span class="nc bnc" id="L2674" title="All 4 branches missed.">            setRecklessEnabled((null == cmd) || (cmd.length() == 0));</span>
        }
<span class="nc" id="L2676">    }</span>

    private void updateManeuverButton() {

<span class="nc" id="L2680">        final Entity ce = ce();</span>

<span class="nc bnc" id="L2682" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2683">            return;</span>
        }

<span class="nc bnc" id="L2686" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getBoard().inSpace()) {</span>
<span class="nc" id="L2687">            return;</span>
        }

<span class="nc bnc" id="L2690" title="All 2 branches missed.">        if (!ce.isAirborne()) {</span>
<span class="nc" id="L2691">            return;</span>
        }

<span class="nc bnc" id="L2694" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L2695">            return;</span>
        }

<span class="nc" id="L2698">        IAero a = (IAero) ce;</span>

<span class="nc bnc" id="L2700" title="All 2 branches missed.">        if (a.isSpheroid()) {</span>
<span class="nc" id="L2701">            return;</span>
        }

<span class="nc bnc" id="L2704" title="All 2 branches missed.">        if (a.didFailManeuver()) {</span>
<span class="nc" id="L2705">            setManeuverEnabled(false);</span>
        }

<span class="nc bnc" id="L2708" title="All 4 branches missed.">        if ((null != cmd) &amp;&amp; cmd.contains(MoveStepType.MANEUVER)) {</span>
<span class="nc" id="L2709">            setManeuverEnabled(false);</span>
        } else {
<span class="nc" id="L2711">            setManeuverEnabled(true);</span>
        }
<span class="nc" id="L2713">    }</span>
    
    private void updateStrafeButton() {
<span class="nc" id="L2716">        if (!clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2717" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVCOMBAT_VTOL_STRAFING)) {</span>
<span class="nc" id="L2718">            return;</span>
        }
        
<span class="nc" id="L2721">        setStrafeEnabled(ce() instanceof VTOL);</span>
<span class="nc" id="L2722">    }</span>
    
    private void updateBombButton() {
<span class="nc" id="L2725">        MoveStep lastStep = cmd.getLastStep();</span>
<span class="nc bnc" id="L2726" title="All 2 branches missed.">        if ((lastStep == null)</span>
<span class="nc bnc" id="L2727" title="All 2 branches missed.">                &amp;&amp; !ce().isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L2728">            setBombEnabled(false);</span>
<span class="nc" id="L2729">            return;</span>
        }
        
<span class="nc bnc" id="L2732" title="All 2 branches missed.">        if (lastStep != null</span>
<span class="nc bnc" id="L2733" title="All 2 branches missed.">                &amp;&amp; lastStep.getClearance() &lt;= 0) {</span>
<span class="nc" id="L2734">            setBombEnabled(false);</span>
<span class="nc" id="L2735">            return;</span>
        }
        
<span class="nc bnc" id="L2738" title="All 2 branches missed.">        if (ce().isBomber()</span>
<span class="nc bnc" id="L2739" title="All 2 branches missed.">                &amp;&amp; ((ce() instanceof LandAirMech)</span>
<span class="nc" id="L2740">                        || clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L2741" title="All 2 branches missed.">                        .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VTOL_ATTACKS))</span>
<span class="nc bnc" id="L2742" title="All 2 branches missed.">                &amp;&amp; ((IBomber)ce()).getBombPoints() &gt; 0) {</span>
<span class="nc" id="L2743">            setBombEnabled(true);</span>
        }
<span class="nc" id="L2745">    }</span>
    
    private synchronized void updateLoadButtons() {
<span class="nc" id="L2748">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L2749">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2750" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2751">            return;</span>
        }

<span class="nc bnc" id="L2754" title="All 2 branches missed.">        if (ce instanceof SmallCraft) {</span>
<span class="nc bnc" id="L2755" title="All 2 branches missed.">            setUnloadEnabled((ce.getUnitsUnloadableFromBays().size() &gt; 0)</span>
<span class="nc bnc" id="L2756" title="All 2 branches missed.">                             &amp;&amp; !ce.isAirborne());</span>
<span class="nc" id="L2757">            setLoadEnabled(false);</span>
<span class="nc" id="L2758">            setMountEnabled(false);</span>
<span class="nc" id="L2759">            return;</span>
        }

        // can this unit mount a dropship/small craft/train?
<span class="nc" id="L2763">        setMountEnabled(false);</span>
<span class="nc" id="L2764">        Coords pos = ce.getPosition();</span>
<span class="nc" id="L2765">        int elev = ce.getElevation();</span>
<span class="nc" id="L2766">        int mpUsed = ce.mpUsed;</span>
<span class="nc bnc" id="L2767" title="All 2 branches missed.">        if (null != cmd) {</span>
<span class="nc" id="L2768">            pos = cmd.getFinalCoords();</span>
<span class="nc" id="L2769">            elev = cmd.getFinalElevation();</span>
<span class="nc" id="L2770">            mpUsed = cmd.getMpUsed();</span>
        }
<span class="nc bnc" id="L2772" title="All 2 branches missed.">        if (!ce.isAirborne()</span>
<span class="nc bnc" id="L2773" title="All 2 branches missed.">                &amp;&amp; (mpUsed &lt;= Math.ceil((ce.getWalkMP() / 2.0)))</span>
<span class="nc" id="L2774">                &amp;&amp; !Compute.getMountableUnits(ce, pos,</span>
<span class="nc bnc" id="L2775" title="All 2 branches missed.">                    elev + game.getBoard().getHex(pos).surface(), game).isEmpty()) {</span>
<span class="nc" id="L2776">            setMountEnabled(true);</span>
        }

<span class="nc bnc" id="L2779" title="All 8 branches missed.">        boolean legalGear = ((gear == MovementDisplay.GEAR_LAND)</span>
                             || (gear == MovementDisplay.GEAR_TURN)
                             || (gear == MovementDisplay.GEAR_BACKUP)
                             || (gear == MovementDisplay.GEAR_JUMP));
<span class="nc" id="L2783">        int unloadEl = cmd.getFinalElevation();</span>
<span class="nc" id="L2784">        IHex hex = ce.getGame().getBoard().getHex(cmd.getFinalCoords());</span>
        
<span class="nc" id="L2786">        boolean finalCoordinatesOnBoard = ce.getGame().getBoard().contains(cmd.getFinalCoords());</span>
<span class="nc" id="L2787">        boolean canUnloadHere = false;</span>
        
        // if the path's final coordinate are off-board (as could be the case on space maps with advanced movement)
        // we will say that it is not possible to unload units in such a situation.
<span class="nc bnc" id="L2791" title="All 2 branches missed.">        if(finalCoordinatesOnBoard) {</span>
<span class="nc bnc" id="L2792" title="All 2 branches missed.">            for (Entity en : loadedUnits) {</span>
<span class="nc bnc" id="L2793" title="All 4 branches missed.">                if (en.isElevationValid(unloadEl, hex) || (en.getJumpMP() &gt; 0)) {</span>
<span class="nc" id="L2794">                    canUnloadHere = true;</span>
<span class="nc" id="L2795">                    break;</span>
                }
                // Zip lines, TO pg 219
<span class="nc bnc" id="L2798" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_ZIPLINES)</span>
<span class="nc bnc" id="L2799" title="All 4 branches missed.">                        &amp;&amp; (ce() instanceof VTOL) &amp;&amp; (en instanceof Infantry) </span>
<span class="nc bnc" id="L2800" title="All 2 branches missed.">                        &amp;&amp; !((Infantry)en).isMechanized()) {</span>
<span class="nc" id="L2801">                    canUnloadHere = true;</span>
<span class="nc" id="L2802">                    break;</span>
                }
<span class="nc" id="L2804">            }</span>
        }
        
        // Disable the &quot;Unload&quot; button if we're in the wrong
        // gear or if the entity is not transporting units.
<span class="nc bnc" id="L2809" title="All 6 branches missed.">        setUnloadEnabled(legalGear &amp;&amp; canUnloadHere &amp;&amp; !loadedUnits.isEmpty());</span>

<span class="nc" id="L2811">        boolean canDropTrailerHere = false;</span>
<span class="nc bnc" id="L2812" title="All 2 branches missed.">        if(finalCoordinatesOnBoard) {</span>
<span class="nc bnc" id="L2813" title="All 2 branches missed.">            for (Entity en : towedUnits) {</span>
<span class="nc bnc" id="L2814" title="All 2 branches missed.">                if (en.isElevationValid(unloadEl, hex)) {</span>
<span class="nc" id="L2815">                    canDropTrailerHere = true;</span>
<span class="nc" id="L2816">                    break;</span>
                }
<span class="nc" id="L2818">            }</span>
        }
        
        // Disable the &quot;Disconnect&quot; button if we're in the wrong
        // gear or if the entity is not transporting units.
<span class="nc bnc" id="L2823" title="All 6 branches missed.">        setDisconnectEnabled(legalGear &amp;&amp; canDropTrailerHere &amp;&amp; !towedUnits.isEmpty());</span>

        // If the current entity has moved, disable &quot;Load&quot; and &quot;Tow&quot; buttons.
<span class="nc" id="L2826">        setLoadEnabled(false);</span>
<span class="nc" id="L2827">        setTowEnabled(false);</span>
<span class="nc bnc" id="L2828" title="All 4 branches missed.">        if ((cmd.length() == 0) &amp;&amp; (cen != Entity.NONE)) {</span>
            // Check the other entities in the current hex for friendly units.
<span class="nc bnc" id="L2830" title="All 2 branches missed.">            for (Entity other : game.getEntitiesVector(ce.getPosition())) {</span>
                // If the other unit is friendly and not the current entity
                // and the current entity has at least 1 MP, if it can
                // transport the other unit, and if the other hasn't moved
                // then enable the &quot;Load&quot; button. Towing gets handled later,
                // and we don't want both buttons enabled.
<span class="nc bnc" id="L2836" title="All 4 branches missed.">                if ((ce.getWalkMP() &gt; 0) &amp;&amp; ce.canLoad(other)</span>
<span class="nc bnc" id="L2837" title="All 4 branches missed.">                    &amp;&amp; other.isLoadableThisTurn() &amp;&amp; !ce.canTow(other.getId())) {</span>
<span class="nc" id="L2838">                    setLoadEnabled(true);</span>
<span class="nc" id="L2839">                    break;</span>
                }
<span class="nc" id="L2841">            } // Check the next entity in this position.</span>
            //Now check all eligible hexes for towable trailers
<span class="nc bnc" id="L2843" title="All 2 branches missed.">            for (Coords c : ce.getHitchLocations()) {</span>
<span class="nc bnc" id="L2844" title="All 2 branches missed.">                for (Entity other : game.getEntitiesVector(c)) {</span>
                    // If the other unit is friendly and not the current entity
                    // if it can tow the other unit, and if the other hasn't moved
                    // then enable the &quot;Tow&quot; button.
<span class="nc bnc" id="L2848" title="All 2 branches missed.">                    if (ce.canTow(other.getId())) {</span>
<span class="nc" id="L2849">                        setTowEnabled(true);</span>
<span class="nc" id="L2850">                        break;</span>
                    }
<span class="nc" id="L2852">                } // Check the next entity.</span>
<span class="nc" id="L2853">            }</span>
        } // End ce-hasn't-moved
<span class="nc" id="L2855">    } // private void updateLoadButtons</span>

    private void updateLayMineButton() {
<span class="nc" id="L2858">        final Entity ce = ce();</span>
<span class="nc bnc" id="L2859" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L2860">            return;</span>
        }

<span class="nc bnc" id="L2863" title="All 4 branches missed.">        if (!ce.canLayMine() || cmd.contains(MoveStepType.LAY_MINE)) {</span>
<span class="nc" id="L2864">            setLayMineEnabled(false);</span>
<span class="nc bnc" id="L2865" title="All 2 branches missed.">        } else if (ce instanceof BattleArmor) {</span>
<span class="nc bnc" id="L2866" title="All 2 branches missed.">            setLayMineEnabled(cmd.getLastStep() == null</span>
<span class="nc bnc" id="L2867" title="All 2 branches missed.">                || cmd.isJumping()</span>
<span class="nc bnc" id="L2868" title="All 2 branches missed.">                || cmd.getLastStepMovementType().equals(EntityMovementType.MOVE_VTOL_WALK));</span>
        } else {
<span class="nc" id="L2870">            setLayMineEnabled(true);</span>
        }
<span class="nc" id="L2872">    }</span>

    private Entity getMountedUnit() {
<span class="nc" id="L2875">        Entity ce = ce();</span>
<span class="nc" id="L2876">        Entity choice = null;</span>
<span class="nc" id="L2877">        Coords pos = ce.getPosition();</span>
<span class="nc" id="L2878">        int elev = ce.getElevation();</span>
<span class="nc bnc" id="L2879" title="All 2 branches missed.">        if (null != cmd) {</span>
<span class="nc" id="L2880">            pos = cmd.getFinalCoords();</span>
<span class="nc" id="L2881">            elev = cmd.getFinalElevation();</span>
        }
<span class="nc" id="L2883">        IHex hex = clientgui.getClient().getGame().getBoard().getHex(pos);</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">        if (null != hex) {</span>
<span class="nc" id="L2885">            elev += hex.getLevel();</span>
        }

<span class="nc" id="L2888">        List&lt;Entity&gt; mountableUnits = Compute.getMountableUnits(ce, pos, elev, clientgui.getClient().getGame());</span>

        // Handle error condition.
<span class="nc bnc" id="L2891" title="All 2 branches missed.">        if (mountableUnits.isEmpty()) {</span>
<span class="nc" id="L2892">            System.err.println(&quot;MovementDisplay#getMountedUnit() &quot; +</span>
                               &quot;called without mountable units.&quot;); //$NON-NLS-1$
        }

        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L2897" title="All 2 branches missed.">        else if (mountableUnits.size() &gt; 1) {</span>
<span class="nc" id="L2898">            String input = (String) JOptionPane</span>
<span class="nc" id="L2899">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L2901">                            Messages.getString(</span>
                                    &quot;MovementDisplay.MountUnitDialog.message&quot;, new Object[]{//$NON-NLS-1$
<span class="nc" id="L2903">                                                                                            ce.getShortName()}),</span>
<span class="nc" id="L2904">                            Messages.getString(&quot;MovementDisplay.MountUnitDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L2906">                                    .getDisplayArray(mountableUnits), null);</span>
<span class="nc" id="L2907">            choice = (Entity) SharedUtility.getTargetPicked(mountableUnits,</span>
                                                            input);
<span class="nc" id="L2909">        } // End have-choices</span>

        // Only one choice.
        else {
<span class="nc" id="L2913">            choice = mountableUnits.get(0);</span>
        }

<span class="nc bnc" id="L2916" title="All 2 branches missed.">        if (!(ce instanceof Infantry)) {</span>
<span class="nc" id="L2917">            Vector&lt;Integer&gt; bayChoices = new Vector&lt;Integer&gt;();</span>
<span class="nc bnc" id="L2918" title="All 2 branches missed.">            for (Transporter t : choice.getTransports()) {</span>
<span class="nc bnc" id="L2919" title="All 4 branches missed.">                if (t.canLoad(ce) &amp;&amp; (t instanceof Bay)) {</span>
<span class="nc" id="L2920">                    bayChoices.add(((Bay) t).getBayNumber());</span>
                }
<span class="nc" id="L2922">            }</span>
<span class="nc" id="L2923">            String[] retVal = new String[bayChoices.size()];</span>
<span class="nc" id="L2924">            int i = 0;</span>
<span class="nc bnc" id="L2925" title="All 2 branches missed.">            for (Integer bn : bayChoices) {</span>
<span class="nc" id="L2926">                retVal[i++] = bn.toString() + &quot; (Free Slots: &quot;</span>
<span class="nc" id="L2927">                              + (int) choice.getBayById(bn).getUnused() + &quot;)&quot;;</span>
<span class="nc" id="L2928">            }</span>
<span class="nc bnc" id="L2929" title="All 2 branches missed.">            if (bayChoices.size() &gt; 1) {</span>
<span class="nc" id="L2930">                String bayString = (String) JOptionPane</span>
<span class="nc" id="L2931">                        .showInputDialog(</span>
                                clientgui,
<span class="nc" id="L2933">                                Messages.getString(</span>
                                        &quot;MovementDisplay.MountUnitBayNumberDialog.message&quot;,
<span class="nc" id="L2935">                                        new Object[]{choice.getShortName()}), //$NON-NLS-1$</span>
<span class="nc" id="L2936">                                Messages.getString(&quot;MovementDisplay.MountUnitBayNumberDialog.title&quot;), //$NON-NLS-1$</span>
                                JOptionPane.QUESTION_MESSAGE, null, retVal,
                                null);
<span class="nc" id="L2939">                ce.setTargetBay(Integer.parseInt(bayString.substring(0,</span>
<span class="nc" id="L2940">                                                                     bayString.indexOf(&quot; &quot;))));</span>
                // We need to update the entity here so that the server knows
                // about our target bay
<span class="nc" id="L2943">                clientgui.getClient().sendUpdateEntity(ce);</span>
<span class="nc" id="L2944">            } else {</span>
<span class="nc" id="L2945">                ce.setTargetBay(-1); // Safety set!</span>
            }
<span class="nc" id="L2947">        } else {</span>
<span class="nc" id="L2948">            ce.setTargetBay(-1); // Safety set!</span>
        }

        // Return the chosen unit.
<span class="nc" id="L2952">        return choice;</span>
    }

    private Entity getLoadedUnit() {
<span class="nc" id="L2956">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L2957">        Entity choice = null;</span>

<span class="nc" id="L2959">        Vector&lt;Entity&gt; choices = new Vector&lt;Entity&gt;();</span>
<span class="nc bnc" id="L2960" title="All 2 branches missed.">        for (Entity other : game.getEntitiesVector(ce().getPosition())) {</span>
<span class="nc bnc" id="L2961" title="All 4 branches missed.">            if (other.isLoadableThisTurn() &amp;&amp; (ce() != null)</span>
<span class="nc bnc" id="L2962" title="All 2 branches missed.">                &amp;&amp; ce().canLoad(other, false)) {</span>
<span class="nc" id="L2963">                choices.addElement(other);</span>
            }
<span class="nc" id="L2965">        }</span>

        // Handle error condition.
<span class="nc bnc" id="L2968" title="All 2 branches missed.">        if (choices.size() == 0) {</span>
<span class="nc" id="L2969">            System.err</span>
<span class="nc" id="L2970">                    .println(&quot;MovementDisplay#getLoadedUnit() called without loadable units.&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2971">            return null;</span>
        }

        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L2975" title="All 2 branches missed.">        if (choices.size() &gt; 1) {</span>
<span class="nc" id="L2976">            String input = (String) JOptionPane</span>
<span class="nc" id="L2977">                    .showInputDialog(clientgui,</span>
<span class="nc" id="L2978">                                     Messages.getString(</span>
                                             &quot;DeploymentDisplay.loadUnitDialog.message&quot;,
<span class="nc" id="L2980">                                             new Object[]{ce().getShortName(),</span>
<span class="nc" id="L2981">                                                          ce().getUnusedString()}), //$NON-NLS-1$</span>
<span class="nc" id="L2982">                                     Messages.getString(&quot;DeploymentDisplay.loadUnitDialog.title&quot;), //$NON-NLS-1$</span>
                                     JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L2984">                                    .getDisplayArray(choices), null);</span>
<span class="nc" id="L2985">            choice = (Entity) SharedUtility.getTargetPicked(choices, input);</span>
<span class="nc" id="L2986">        } // End have-choices</span>

        // Only one choice.
        else {
<span class="nc" id="L2990">            choice = choices.get(0);</span>
        }

<span class="nc bnc" id="L2993" title="All 2 branches missed.">        if (!(choice instanceof Infantry)) {</span>
<span class="nc" id="L2994">            List&lt;Integer&gt; bayChoices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2995" title="All 2 branches missed.">            for (Transporter t : ce().getTransports()) {</span>
<span class="nc bnc" id="L2996" title="All 4 branches missed.">                if (t.canLoad(choice) &amp;&amp; (t instanceof Bay)) {</span>
<span class="nc" id="L2997">                    bayChoices.add(((Bay) t).getBayNumber());</span>
                }
<span class="nc" id="L2999">            }</span>
<span class="nc bnc" id="L3000" title="All 2 branches missed.">            if (bayChoices.size() &gt; 1) {</span>
<span class="nc" id="L3001">                String[] retVal = new String[bayChoices.size()];</span>
<span class="nc" id="L3002">                int i = 0;</span>
<span class="nc bnc" id="L3003" title="All 2 branches missed.">                for (Integer bn : bayChoices) {</span>
<span class="nc" id="L3004">                    retVal[i++] = bn.toString() + &quot; (Free Slots: &quot;</span>
<span class="nc" id="L3005">                            + (int) ce().getBayById(bn).getUnused() + &quot;)&quot;;</span>
<span class="nc" id="L3006">                }</span>
<span class="nc" id="L3007">                String bayString = (String) JOptionPane</span>
<span class="nc" id="L3008">                        .showInputDialog(</span>
                                clientgui,
<span class="nc" id="L3010">                                Messages.getString(</span>
                                        &quot;MovementDisplay.loadUnitBayNumberDialog.message&quot;,
<span class="nc" id="L3012">                                        new Object[]{ce().getShortName()}), //$NON-NLS-1$</span>
<span class="nc" id="L3013">                                Messages.getString(&quot;MovementDisplay.loadUnitBayNumberDialog.title&quot;), //$NON-NLS-1$</span>
                                JOptionPane.QUESTION_MESSAGE, null, retVal,
                                null);
<span class="nc" id="L3016">                choice.setTargetBay(Integer.parseInt(bayString.substring(0,</span>
<span class="nc" id="L3017">                        bayString.indexOf(&quot; &quot;))));</span>
                // We need to update the entity here so that the server knows
                // about our target bay
<span class="nc" id="L3020">                clientgui.getClient().sendUpdateEntity(choice);</span>
<span class="nc bnc" id="L3021" title="All 2 branches missed.">            } else if (choice.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L3022">                bayChoices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L3023" title="All 2 branches missed.">                for (Transporter t : ce().getTransports()) {</span>
<span class="nc bnc" id="L3024" title="All 2 branches missed.">                    if ((t instanceof ProtomechClampMount)</span>
<span class="nc bnc" id="L3025" title="All 2 branches missed.">                                &amp;&amp; t.canLoad(choice)) {</span>
<span class="nc bnc" id="L3026" title="All 2 branches missed.">                        bayChoices.add(((ProtomechClampMount) t).isRear()? 1 : 0);</span>
                    }
<span class="nc" id="L3028">                }</span>
<span class="nc bnc" id="L3029" title="All 2 branches missed.">                if (bayChoices.size() &gt; 1) {</span>
<span class="nc" id="L3030">                    String[] retVal = new String[bayChoices.size()];</span>
<span class="nc" id="L3031">                    int i = 0;</span>
<span class="nc bnc" id="L3032" title="All 2 branches missed.">                    for (Integer bn : bayChoices) {</span>
<span class="nc bnc" id="L3033" title="All 2 branches missed.">                        retVal[i++] = bn &gt; 0?</span>
<span class="nc" id="L3034">                                Messages.getString(&quot;MovementDisplay.loadProtoClampMountDialog.rear&quot;) :</span>
<span class="nc" id="L3035">                                    Messages.getString(&quot;MovementDisplay.loadProtoClampMountDialog.front&quot;);</span>
<span class="nc" id="L3036">                    }</span>
<span class="nc" id="L3037">                    String bayString = (String) JOptionPane</span>
<span class="nc" id="L3038">                            .showInputDialog(</span>
                                    clientgui,
<span class="nc" id="L3040">                                    Messages.getString(</span>
                                            &quot;MovementDisplay.loadProtoClampMountDialog.message&quot;,
<span class="nc" id="L3042">                                            new Object[]{ce().getShortName()}), //$NON-NLS-1$</span>
<span class="nc" id="L3043">                                    Messages.getString(&quot;MovementDisplay.loadProtoClampMountDialog.title&quot;), //$NON-NLS-1$</span>
                                    JOptionPane.QUESTION_MESSAGE, null, retVal,
                                    null);
<span class="nc bnc" id="L3046" title="All 2 branches missed.">                    choice.setTargetBay(bayString.equals(Messages</span>
<span class="nc" id="L3047">                            .getString(&quot;MovementDisplay.loadProtoClampMountDialog.front&quot;))? 0 : 1);</span>
                    // We need to update the entity here so that the server knows
                    // about our target bay
<span class="nc" id="L3050">                    clientgui.getClient().sendUpdateEntity(choice);</span>
<span class="nc" id="L3051">                } else {</span>
<span class="nc" id="L3052">                    choice.setTargetBay(-1); // Safety set!</span>
                }
            }
<span class="nc" id="L3055">        } else {</span>
<span class="nc" id="L3056">            choice.setTargetBay(-1); // Safety set!</span>
        }

        // Return the chosen unit.
<span class="nc" id="L3060">        return choice;</span>
    }
    
    /**
     * Get the unit (trailer) that the player wants to connect. This method will add the
     * trailer to our local copy of loaded units.
     *
     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to tow. This
     * value may be null if there are no eligible targets
     */
    private Entity getTowedUnit() {
<span class="nc" id="L3071">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L3072">        Entity choice = null;</span>

<span class="nc" id="L3074">        List&lt;Entity&gt; choices = new ArrayList&lt;Entity&gt;();</span>
        
        //We have to account for the positions of the whole train when looking to add new trailers
<span class="nc bnc" id="L3077" title="All 2 branches missed.">        for (Coords pos : ce().getHitchLocations()) {</span>
<span class="nc bnc" id="L3078" title="All 2 branches missed.">            for (Entity other : game.getEntitiesVector(pos)) {</span>
<span class="nc bnc" id="L3079" title="All 4 branches missed.">                if (ce() != null &amp;&amp; ce().canTow(other.getId())) {</span>
<span class="nc" id="L3080">                    choices.add(other);</span>
                }
<span class="nc" id="L3082">            }</span>
<span class="nc" id="L3083">        }</span>
        
        // Handle error condition.
<span class="nc bnc" id="L3086" title="All 2 branches missed.">        if (choices.size() == 0) {</span>
<span class="nc" id="L3087">            MegaMek.getLogger().debug(&quot;Method called without towable units.&quot;);</span>
<span class="nc" id="L3088">            return null;</span>
        }

        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L3092" title="All 2 branches missed.">        if (choices.size() &gt; 1) {</span>
<span class="nc" id="L3093">            String input = (String) JOptionPane</span>
<span class="nc" id="L3094">                    .showInputDialog(clientgui,</span>
<span class="nc" id="L3095">                                     Messages.getString(</span>
                                             &quot;DeploymentDisplay.towUnitDialog.message&quot;,
<span class="nc" id="L3097">                                             new Object[]{ce().getShortName()}), //$NON-NLS-1$</span>
<span class="nc" id="L3098">                                     Messages.getString(&quot;DeploymentDisplay.towUnitDialog.title&quot;), //$NON-NLS-1$</span>
                                     JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L3100">                                    .getDisplayArray(choices), null);</span>
<span class="nc" id="L3101">            choice = (Entity) SharedUtility.getTargetPicked(choices, input);</span>
<span class="nc" id="L3102">        } // End have-choices</span>

        // Only one choice.
        else {
<span class="nc" id="L3106">            choice = choices.get(0);</span>
        }
        
        //Set up the correct hitch/transporter to use
        //We need lots of data about the hitch to store in different places. Save that here
        final class HitchChoice {
            private final int id;
            private final int number;
            private final TankTrailerHitch hitch;

<span class="nc" id="L3116">            private HitchChoice(int id, int number, TankTrailerHitch t) {</span>
<span class="nc" id="L3117">                this.id = id;</span>
<span class="nc" id="L3118">                this.number = number;</span>
<span class="nc" id="L3119">                this.hitch = t;</span>
<span class="nc" id="L3120">            }</span>

            private int getId() {
<span class="nc" id="L3123">                return id;</span>
            }

            private int getNumber() {
<span class="nc" id="L3127">                return number;</span>
            }
            
            private TankTrailerHitch getHitch() {
<span class="nc" id="L3131">                return hitch;</span>
            }

            @Override
            public String toString() {
                // the string should tell the user if the hitch is mounted front or rear
<span class="nc bnc" id="L3137" title="All 2 branches missed.">                if (getHitch().getRearMounted()) {</span>
<span class="nc" id="L3138">                    return String.format(&quot;%s Trailer Hitch #[%d] (rear)&quot;, game.getEntity(id).getShortName(), getNumber());</span>
                }
<span class="nc" id="L3140">                return String.format(&quot;%s Trailer Hitch #[%d] (front)&quot;, game.getEntity(id).getShortName(), getNumber());</span>
            }
        }
        
        //Create a collection to keep my choices in
<span class="nc" id="L3145">        List&lt;HitchChoice&gt; hitchChoices = new ArrayList&lt;&gt;();</span>
        
        //next, set up a list of all the entities in this train
<span class="nc" id="L3148">        ArrayList&lt;Entity&gt; thisTrain = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3149">        thisTrain.add(ce());</span>
<span class="nc bnc" id="L3150" title="All 2 branches missed.">        for (int id : ce().getAllTowedUnits()) {</span>
<span class="nc" id="L3151">            Entity tr = game.getEntity(id);</span>
<span class="nc" id="L3152">            thisTrain.add(tr);</span>
<span class="nc" id="L3153">        }</span>
        //and store all the valid Hitch transporters that each one has
        //really, there shouldn't be but one per entity. &quot;Towing&quot; front and rear with the
        //tractor in the center isn't going to work well...
<span class="nc bnc" id="L3157" title="All 2 branches missed.">        for (Entity e : thisTrain) {</span>
<span class="nc bnc" id="L3158" title="All 2 branches missed.">            for (Transporter t : e.getTransports()) {</span>
<span class="nc bnc" id="L3159" title="All 2 branches missed.">                if (t.canTow(choice)) {</span>
<span class="nc" id="L3160">                    TankTrailerHitch h = (TankTrailerHitch) t;</span>
<span class="nc" id="L3161">                    HitchChoice hitch = new HitchChoice(e.getId(), e.getTransports().indexOf(t), h);</span>
<span class="nc" id="L3162">                    hitchChoices.add(hitch);</span>
                }
<span class="nc" id="L3164">            }</span>
<span class="nc" id="L3165">        }</span>
        
        //Gah, multiple choice test! 
<span class="nc bnc" id="L3168" title="All 2 branches missed.">        if (hitchChoices.size() &gt; 1) {</span>
            //Set up a dialog box for the hitch options
<span class="nc" id="L3170">            String[] retVal = new String[hitchChoices.size()];</span>
<span class="nc" id="L3171">            int i = 0;</span>
<span class="nc bnc" id="L3172" title="All 2 branches missed.">            for (HitchChoice hc : hitchChoices) {</span>
<span class="nc" id="L3173">                retVal[i++] = hc.toString();</span>
<span class="nc" id="L3174">            }</span>
<span class="nc" id="L3175">            String selection = (String) JOptionPane</span>
<span class="nc" id="L3176">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L3178">                            Messages.getString(</span>
                                    &quot;MovementDisplay.loadUnitHitchDialog.message&quot;,
<span class="nc" id="L3180">                                    new Object[]{ce().getShortName()}), //$NON-NLS-1$</span>
<span class="nc" id="L3181">                            Messages.getString(&quot;MovementDisplay.loadUnitHitchDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, retVal,
                            null);
<span class="nc" id="L3184">            HitchChoice hc = null;</span>
<span class="nc bnc" id="L3185" title="All 2 branches missed.">            if (selection != null) {</span>
<span class="nc bnc" id="L3186" title="All 2 branches missed.">                for (int loop = 0; loop &lt; hitchChoices.size(); loop++) {</span>
<span class="nc bnc" id="L3187" title="All 2 branches missed.">                    if (selection.equals(hitchChoices.get(loop).toString())) {</span>
<span class="nc" id="L3188">                        hc = hitchChoices.get(loop);</span>
<span class="nc" id="L3189">                        break;</span>
                    }
                }
            }
            //Set the transporter number in the towed entity from the selection
<span class="nc" id="L3194">            choice.setTargetBay(hc.getNumber());</span>
            //and then the Entity id the transporter is attached to...
<span class="nc" id="L3196">            choice.setTowedBy(hc.getId());</span>
<span class="nc" id="L3197">        } else {</span>
            //and in case there's just one choice...
<span class="nc" id="L3199">            choice.setTargetBay(hitchChoices.get(0).getNumber());</span>
<span class="nc" id="L3200">            choice.setTowedBy(hitchChoices.get(0).getId());</span>
        }

        // We need to update the entities here so that the server knows
        // about our changes
<span class="nc" id="L3205">        ce().setTowing(choice.getId());</span>
<span class="nc" id="L3206">        clientgui.getClient().sendUpdateEntity(ce());</span>
<span class="nc" id="L3207">        clientgui.getClient().sendUpdateEntity(choice);</span>

        // Return the chosen unit.
<span class="nc" id="L3210">        return choice;</span>
    }
    
    /**
     * Get the unit that the player wants to unload. This method will remove the
     * unit from our local copy of loaded units.
     *
     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
     * value will not be &lt;code&gt;null&lt;/code&gt;.
     */
    private Entity getDisconnectedUnit() {
<span class="nc" id="L3221">        Entity ce = ce();</span>
<span class="nc" id="L3222">        Entity choice = null;</span>
        
        // Handle error condition.
<span class="nc bnc" id="L3225" title="All 2 branches missed.">        if (ce.getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L3226">            MegaMek.getLogger().debug(&quot;Method called without any towed units.&quot;);</span>
<span class="nc" id="L3227">            return null;</span>
        }
        
        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L3231" title="All 2 branches missed.">        else if (ce.getAllTowedUnits().size() &gt; 1) {</span>
<span class="nc" id="L3232">            String input = (String) JOptionPane</span>
<span class="nc" id="L3233">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L3235">                            Messages.getString(</span>
                                    &quot;MovementDisplay.DisconnectUnitDialog.message&quot;, new Object[]{//$NON-NLS-1$
<span class="nc" id="L3237">                                                                                             ce.getShortName(), ce.getUnusedString()}),</span>
<span class="nc" id="L3238">                            Messages.getString(&quot;MovementDisplay.DisconnectUnitDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L3240">                                    .getDisplayArray(towedUnits), null);</span>
<span class="nc" id="L3241">            choice = (Entity) SharedUtility.getTargetPicked(towedUnits, input);</span>
<span class="nc" id="L3242">        } // End have-choices</span>

        // Only one choice.
        else {
<span class="nc" id="L3246">            choice = towedUnits.get(0);</span>
<span class="nc" id="L3247">            towedUnits.remove(0);</span>
        }

        // Return the chosen unit.
<span class="nc" id="L3251">        return choice;</span>
    }

    /**
     * Get the unit that the player wants to unload. This method will remove the
     * unit from our local copy of loaded units.
     *
     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
     * value will not be &lt;code&gt;null&lt;/code&gt;.
     */
    private Entity getUnloadedUnit() {
<span class="nc" id="L3262">        Entity ce = ce();</span>
<span class="nc" id="L3263">        Entity choice = null;</span>
        // Handle error condition.
<span class="nc bnc" id="L3265" title="All 2 branches missed.">        if (loadedUnits.size() == 0) {</span>
<span class="nc" id="L3266">            System.err</span>
<span class="nc" id="L3267">                    .println(&quot;MovementDisplay#getUnloadedUnit() called without loaded units.&quot;); //$NON-NLS-1$</span>
        }
        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L3270" title="All 2 branches missed.">        else if (loadedUnits.size() &gt; 1) {</span>
<span class="nc" id="L3271">            String input = (String) JOptionPane</span>
<span class="nc" id="L3272">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L3274">                            Messages.getString(</span>
                                    &quot;MovementDisplay.UnloadUnitDialog.message&quot;, new Object[]{//$NON-NLS-1$
<span class="nc" id="L3276">                                                                                             ce.getShortName(), ce.getUnusedString()}),</span>
<span class="nc" id="L3277">                            Messages.getString(&quot;MovementDisplay.UnloadUnitDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L3279">                                    .getDisplayArray(loadedUnits), null);</span>
<span class="nc" id="L3280">            choice = (Entity) SharedUtility.getTargetPicked(loadedUnits, input);</span>
<span class="nc" id="L3281">        } // End have-choices</span>

        // Only one choice.
        else {
<span class="nc" id="L3285">            choice = loadedUnits.get(0);</span>
<span class="nc" id="L3286">            loadedUnits.remove(0);</span>
        }

        // Return the chosen unit.
<span class="nc" id="L3290">        return choice;</span>
    }

    private Coords getUnloadPosition(Entity unloaded) {
<span class="nc" id="L3294">        Entity ce = ce();</span>
        // we need to allow the user to select a hex for offloading
<span class="nc" id="L3296">        Coords pos = ce.getPosition();</span>
<span class="nc bnc" id="L3297" title="All 2 branches missed.">        if (null != cmd) {</span>
<span class="nc" id="L3298">            pos = cmd.getFinalCoords();</span>
        }
<span class="nc" id="L3300">        int elev = clientgui.getClient().getGame().getBoard().getHex(pos)</span>
<span class="nc" id="L3301">                            .getLevel()</span>
<span class="nc" id="L3302">                   + ce.getElevation();</span>
<span class="nc" id="L3303">        List&lt;Coords&gt; ring = pos.allAdjacent();</span>
<span class="nc bnc" id="L3304" title="All 2 branches missed.">        if (ce instanceof Dropship) {</span>
<span class="nc" id="L3305">            ring = pos.allAtDistance(2);</span>
        }
        // ok now we need to go through the ring and identify available
        // Positions
<span class="nc" id="L3309">        ring = Compute.getAcceptableUnloadPositions(ring, unloaded, clientgui</span>
<span class="nc" id="L3310">                .getClient().getGame(), elev);</span>
        //If we're a train, eliminate positions held by any unit in the train. 
        //You get stacking violation weirdness if this isn't done.
<span class="nc" id="L3313">        Set&lt;Coords&gt; toRemove = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3314" title="All 2 branches missed.">        if (ce.getTowing() != Entity.NONE) {</span>
<span class="nc bnc" id="L3315" title="All 2 branches missed.">            for (int i : ce.getAllTowedUnits()) {</span>
<span class="nc" id="L3316">                Entity e = ce.getGame().getEntity(i);</span>
<span class="nc bnc" id="L3317" title="All 4 branches missed.">                if (e != null &amp;&amp; e.getPosition() != null) {</span>
<span class="nc" id="L3318">                    toRemove.add(e.getPosition());</span>
                }
<span class="nc" id="L3320">            }</span>
<span class="nc bnc" id="L3321" title="All 2 branches missed.">        } else if (ce.getTractor() != Entity.NONE) {</span>
<span class="nc" id="L3322">            Entity tractor = ce.getGame().getEntity(ce.getTractor());</span>
<span class="nc bnc" id="L3323" title="All 4 branches missed.">            if (tractor != null &amp;&amp; tractor.getPosition() != null) {</span>
<span class="nc" id="L3324">                toRemove.add(tractor.getPosition());</span>
<span class="nc bnc" id="L3325" title="All 2 branches missed.">                for (int i : tractor.getAllTowedUnits()) {</span>
<span class="nc" id="L3326">                    Entity e = ce.getGame().getEntity(i);</span>
<span class="nc bnc" id="L3327" title="All 4 branches missed.">                    if (e != null &amp;&amp; e.getPosition() != null) {</span>
<span class="nc" id="L3328">                        toRemove.add(e.getPosition());</span>
                    }
<span class="nc" id="L3330">                }</span>
            }
        }
<span class="nc" id="L3333">        ring.removeAll(toRemove);</span>
        
<span class="nc bnc" id="L3335" title="All 2 branches missed.">        if (ring.size() &lt; 1) {</span>
<span class="nc" id="L3336">            String title = Messages</span>
<span class="nc" id="L3337">                    .getString(&quot;MovementDisplay.NoPlaceToUnload.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L3338">            String body = Messages</span>
<span class="nc" id="L3339">                    .getString(&quot;MovementDisplay.NoPlaceToUnload.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L3340">            clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L3341">            return null;</span>
        }
<span class="nc" id="L3343">        String[] choices = new String[ring.size()];</span>
<span class="nc" id="L3344">        int i = 0;</span>
<span class="nc bnc" id="L3345" title="All 2 branches missed.">        for (Coords c : ring) {</span>
<span class="nc" id="L3346">            choices[i++] = c.toString();</span>
<span class="nc" id="L3347">        }</span>
<span class="nc" id="L3348">        String selected = (String) JOptionPane.showInputDialog(clientgui,</span>
<span class="nc" id="L3349">                                                               Messages.getString(</span>
                                                                       &quot;MovementDisplay.ChooseHex&quot; + &quot;.message&quot;, new Object[]{//$NON-NLS-1$
<span class="nc" id="L3351">                                                                                                                              ce.getShortName(), ce.getUnusedString()}), Messages</span>
<span class="nc" id="L3352">                                                                       .getString(&quot;MovementDisplay.ChooseHex.title&quot;),</span>
                                                               //$NON-NLS-1$
                                                               JOptionPane.QUESTION_MESSAGE, null, choices, null);
<span class="nc" id="L3355">        Coords choice = null;</span>
<span class="nc bnc" id="L3356" title="All 2 branches missed.">        if (selected == null) {</span>
<span class="nc" id="L3357">            return choice;</span>
        }
<span class="nc bnc" id="L3359" title="All 2 branches missed.">        for (Coords c : ring) {</span>
<span class="nc bnc" id="L3360" title="All 2 branches missed.">            if (selected.equals(c.toString())) {</span>
<span class="nc" id="L3361">                choice = c;</span>
<span class="nc" id="L3362">                break;</span>
            }
<span class="nc" id="L3364">        }</span>
<span class="nc" id="L3365">        return choice;</span>
    }
    
    /**
     * Uses player input to find a legal hex where an EjectedCrew unit can be placed
     * @param abandoned - The vessel we're escaping from
     * @return
     */
    private Coords getEjectPosition(Entity abandoned) {
        // we need to allow the user to select a hex for offloading the unit's crew
<span class="nc" id="L3375">        Coords pos = abandoned.getPosition();</span>
        //Create a bogus crew entity to use for legal hex calculation
<span class="nc" id="L3377">        Entity crew = new EjectedCrew();</span>
<span class="nc" id="L3378">        crew.setId(clientgui.getClient().getGame().getNextEntityId());</span>
<span class="nc" id="L3379">        crew.setGame(clientgui.getClient().getGame());</span>
<span class="nc" id="L3380">        int elev = clientgui.getClient().getGame().getBoard().getHex(pos).getLevel() + abandoned.getElevation();</span>
<span class="nc" id="L3381">        List&lt;Coords&gt; ring = pos.allAdjacent();</span>
<span class="nc bnc" id="L3382" title="All 2 branches missed.">        if (abandoned instanceof Dropship) {</span>
<span class="nc" id="L3383">            ring = pos.allAtDistance(2);</span>
        }
        // ok now we need to go through the ring and identify available
        // Positions
<span class="nc" id="L3387">        ring = Compute.getAcceptableUnloadPositions(ring, crew, clientgui</span>
<span class="nc" id="L3388">                .getClient().getGame(), elev);</span>
<span class="nc bnc" id="L3389" title="All 2 branches missed.">        if (ring.size() &lt; 1) {</span>
<span class="nc" id="L3390">            String title = Messages</span>
<span class="nc" id="L3391">                    .getString(&quot;MovementDisplay.NoPlaceToEject.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L3392">            String body = Messages</span>
<span class="nc" id="L3393">                    .getString(&quot;MovementDisplay.NoPlaceToEject.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L3394">            clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L3395">            return null;</span>
        }
<span class="nc" id="L3397">        String[] choices = new String[ring.size()];</span>
<span class="nc" id="L3398">        int i = 0;</span>
<span class="nc bnc" id="L3399" title="All 2 branches missed.">        for (Coords c : ring) {</span>
<span class="nc" id="L3400">            choices[i++] = c.toString();</span>
<span class="nc" id="L3401">        }</span>
<span class="nc" id="L3402">        String selected = (String) JOptionPane.showInputDialog(clientgui,</span>
<span class="nc" id="L3403">                                                               Messages.getString(</span>
                                                                       &quot;MovementDisplay.ChooseEjectHex.message&quot;, new Object[]{//$NON-NLS-1$
<span class="nc" id="L3405">                                                                               abandoned.getShortName(), abandoned.getUnusedString()}), Messages</span>
<span class="nc" id="L3406">                                                                       .getString(&quot;MovementDisplay.ChooseHex.title&quot;),</span>
                                                               //$NON-NLS-1$
                                                               JOptionPane.QUESTION_MESSAGE, null, choices, null);
<span class="nc" id="L3409">        Coords choice = null;</span>
<span class="nc bnc" id="L3410" title="All 2 branches missed.">        if (selected == null) {</span>
<span class="nc" id="L3411">            return choice;</span>
        }
<span class="nc bnc" id="L3413" title="All 2 branches missed.">        for (Coords c : ring) {</span>
<span class="nc bnc" id="L3414" title="All 2 branches missed.">            if (selected.equals(c.toString())) {</span>
<span class="nc" id="L3415">                choice = c;</span>
<span class="nc" id="L3416">                break;</span>
            }
<span class="nc" id="L3418">        }</span>
<span class="nc" id="L3419">        return choice;</span>
    }

    /**
     * FIGHTER RECOVERY fighter recovery will be handled differently than
     * loading other units. Namely, it will be an action of the fighter not the
     * carrier. So the fighter just flies right up to a carrier whose movement
     * is ended and hops on. need a new function
     */
    private synchronized void updateRecoveryButton() {
<span class="nc" id="L3429">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L3430">        final Entity ce = ce();</span>
<span class="nc bnc" id="L3431" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L3432">            return;</span>
        }

        // I also want to handle fighter recovery here. If using advanced
        // movement
        // it is not a function of where carrier is but where the carrier will
        // be at the end
        // of its move
<span class="nc bnc" id="L3440" title="All 2 branches missed.">        if (ce.isAero()) {</span>
<span class="nc" id="L3441">            Coords loadeePos = cmd.getFinalCoords();</span>
<span class="nc bnc" id="L3442" title="All 2 branches missed.">            if (clientgui.getClient().getGame().useVectorMove()) {</span>
                // not where you are, but where you will be
<span class="nc" id="L3444">                loadeePos = Compute.getFinalPosition(ce.getPosition(),</span>
<span class="nc" id="L3445">                                                     cmd.getFinalVectors());</span>
            }
<span class="nc" id="L3447">            boolean isGood = false;</span>
<span class="nc bnc" id="L3448" title="All 2 branches missed.">            for (Entity other : game.getEntitiesVector(loadeePos)) {</span>
                // Is the other unit friendly and not the current entity?
                // must be done with its movement
                // it also must be same heading and velocity
<span class="nc bnc" id="L3452" title="All 4 branches missed.">                if ((other instanceof Aero) &amp;&amp; other.isDone()</span>
<span class="nc bnc" id="L3453" title="All 2 branches missed.">                    &amp;&amp; other.canLoad(ce)</span>
<span class="nc bnc" id="L3454" title="All 2 branches missed.">                    &amp;&amp; (cmd.getFinalFacing() == other.getFacing())</span>
<span class="nc bnc" id="L3455" title="All 2 branches missed.">                    &amp;&amp; !other.isCapitalFighter()) {</span>
                    // now lets check velocity
                    // depends on movement rules
<span class="nc" id="L3458">                    Aero oa = (Aero) other;</span>
<span class="nc bnc" id="L3459" title="All 2 branches missed.">                    if (clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc bnc" id="L3460" title="All 2 branches missed.">                        if (Compute.sameVectors(cmd.getFinalVectors(),</span>
<span class="nc" id="L3461">                                                oa.getVectors())) {</span>
<span class="nc bnc" id="L3462" title="All 2 branches missed.">                            if (ce instanceof Dropship) {</span>
<span class="nc" id="L3463">                                setDockEnabled(true);</span>
                            } else {
<span class="nc" id="L3465">                                setRecoverEnabled(true);</span>
                            }
<span class="nc" id="L3467">                            isGood = true;</span>

                            // We can stop looking now.
<span class="nc" id="L3470">                            break;</span>
                        }
<span class="nc" id="L3472">                    } else if (cmd.getFinalVelocity() == oa</span>
<span class="nc bnc" id="L3473" title="All 2 branches missed.">                            .getCurrentVelocity()) {</span>
<span class="nc bnc" id="L3474" title="All 2 branches missed.">                        if (ce instanceof Dropship) {</span>
<span class="nc" id="L3475">                            setDockEnabled(true);</span>
                        } else {
<span class="nc" id="L3477">                            setRecoverEnabled(true);</span>
                        }
<span class="nc" id="L3479">                        isGood = true;</span>

                        // We can stop looking now.
<span class="nc" id="L3482">                        break;</span>
                    }
                }
                // Nope. Discard it.
<span class="nc" id="L3486">                other = null;</span>
<span class="nc" id="L3487">            } // Check the next entity in this position.</span>
<span class="nc bnc" id="L3488" title="All 2 branches missed.">            if (!isGood) {</span>
<span class="nc" id="L3489">                setRecoverEnabled(false);</span>
<span class="nc" id="L3490">                setDockEnabled(false);</span>
            }
        }

<span class="nc" id="L3494">    }</span>

    /**
     * Joining a squadron - Similar to fighter recovery. You can fly up and join
     * a squadron or another solo fighter
     */
    private synchronized void updateJoinButton() {
<span class="nc" id="L3501">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc bnc" id="L3502" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_CAPITAL_FIGHTER)) {</span>
<span class="nc" id="L3503">            return;</span>
        }

<span class="nc" id="L3506">        final Entity ce = ce();</span>
<span class="nc bnc" id="L3507" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L3508">            return;</span>
        }

<span class="nc bnc" id="L3511" title="All 2 branches missed.">        if (!ce.isCapitalFighter()) {</span>
<span class="nc" id="L3512">            return;</span>
        }

<span class="nc" id="L3515">        Coords loadeePos = cmd.getFinalCoords();</span>
<span class="nc bnc" id="L3516" title="All 2 branches missed.">        if (game.useVectorMove()) {</span>
            // not where you are, but where you will be
<span class="nc" id="L3518">            loadeePos = Compute.getFinalPosition(ce.getPosition(),</span>
<span class="nc" id="L3519">                                                 cmd.getFinalVectors());</span>
        }
<span class="nc" id="L3521">        boolean isGood = false;</span>
<span class="nc bnc" id="L3522" title="All 2 branches missed.">        for (Entity other : game.getEntitiesVector(loadeePos)) {</span>
            // Is the other unit friendly and not the current entity?
            // must be done with its movement
            // it also must be same heading and velocity
<span class="nc bnc" id="L3526" title="All 2 branches missed.">            if (ce.getOwner().equals(other.getOwner())</span>
<span class="nc bnc" id="L3527" title="All 4 branches missed.">                &amp;&amp; other.isCapitalFighter() &amp;&amp; other.isDone()</span>
<span class="nc bnc" id="L3528" title="All 2 branches missed.">                &amp;&amp; other.canLoad(ce)</span>
<span class="nc bnc" id="L3529" title="All 2 branches missed.">                &amp;&amp; (cmd.getFinalFacing() == other.getFacing())) {</span>
                // now lets check velocity
                // depends on movement rules
<span class="nc" id="L3532">                Aero oa = (Aero) other;</span>
<span class="nc bnc" id="L3533" title="All 2 branches missed.">                if (game.useVectorMove()) {</span>
                    // can you do equality with vectors?
<span class="nc bnc" id="L3535" title="All 2 branches missed.">                    if (Compute.sameVectors(cmd.getFinalVectors(),</span>
<span class="nc" id="L3536">                                            oa.getVectors())) {</span>
<span class="nc" id="L3537">                        setJoinEnabled(true);</span>
<span class="nc" id="L3538">                        isGood = true;</span>

                        // We're done looping now...
<span class="nc" id="L3541">                        break;</span>
                    }
<span class="nc bnc" id="L3543" title="All 2 branches missed.">                } else if (cmd.getFinalVelocity() == oa.getCurrentVelocity()) {</span>
<span class="nc" id="L3544">                    setJoinEnabled(true);</span>
<span class="nc" id="L3545">                    isGood = true;</span>

                    // We're done looping now...
<span class="nc" id="L3548">                    break;</span>
                }
            }
            // Nope. Discard it.
<span class="nc" id="L3552">            other = null;</span>
<span class="nc" id="L3553">        } // Check the next entity in this position.</span>
<span class="nc bnc" id="L3554" title="All 2 branches missed.">        if (!isGood) {</span>
<span class="nc" id="L3555">            setJoinEnabled(false);</span>
        }
<span class="nc" id="L3557">    }</span>

    /**
     * Get the unit that the player wants to unload. This method will remove the
     * unit from our local copy of loaded units.
     *
     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
     * value will not be &lt;code&gt;null&lt;/code&gt;.
     */
    private TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getLaunchedUnits() {
<span class="nc" id="L3567">        Entity ce = ce();</span>
<span class="nc" id="L3568">        TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; choices = new TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt;();</span>

<span class="nc" id="L3570">        Vector&lt;Entity&gt; launchableFighters = ce.getLaunchableFighters();</span>
<span class="nc" id="L3571">        Vector&lt;Entity&gt; launchableSmallCraft = ce.getLaunchableSmallCraft();</span>
<span class="nc" id="L3572">        Vector&lt;Entity&gt; launchableDropships = ce.getLaunchableDropships();</span>

        // Handle error condition.
<span class="nc bnc" id="L3575" title="All 2 branches missed.">        if ((launchableFighters.size() &lt;= 0)</span>
<span class="nc bnc" id="L3576" title="All 2 branches missed.">            &amp;&amp; (launchableSmallCraft.size() &lt;= 0)</span>
<span class="nc bnc" id="L3577" title="All 2 branches missed.">            &amp;&amp; (launchableDropships.size() &lt;= 0)) {</span>
<span class="nc" id="L3578">            System.err</span>
<span class="nc" id="L3579">                    .println(&quot;MovementDisplay#getLaunchedUnits() called without loaded units.&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L3580">            return choices;</span>
        }

        // cycle through the fighter bays and then the small craft bays
<span class="nc" id="L3584">        int bayNum = 1;</span>
<span class="nc" id="L3585">        int i = 0;</span>
        Bay currentBay;
<span class="nc" id="L3587">        Vector&lt;Entity&gt; currentFighters = new Vector&lt;Entity&gt;();</span>
<span class="nc" id="L3588">        int doors = 0;</span>
<span class="nc" id="L3589">        Vector&lt;Bay&gt; FighterBays = ce.getFighterBays();</span>
<span class="nc bnc" id="L3590" title="All 2 branches missed.">        for (i = 0; i &lt; FighterBays.size(); i++) {</span>
<span class="nc" id="L3591">            currentBay = FighterBays.elementAt(i);</span>
<span class="nc" id="L3592">            Vector&lt;Integer&gt; bayChoices = new Vector&lt;Integer&gt;();</span>
<span class="nc" id="L3593">            currentFighters = currentBay.getLaunchableUnits();</span>
            /*
             * We will assume that if more fighters are launched than is safe,
             * that these excess fighters will be distributed equally among
             * available doors
             */
<span class="nc" id="L3599">            doors = currentBay.getCurrentDoors();</span>
<span class="nc bnc" id="L3600" title="All 2 branches missed.">            if (currentFighters.size() == 0) {</span>
<span class="nc" id="L3601">                bayNum++;</span>
<span class="nc" id="L3602">                continue;</span>
            }
<span class="nc" id="L3604">            String[] names = new String[currentFighters.size()];</span>
<span class="nc" id="L3605">            String question = Messages</span>
<span class="nc" id="L3606">                    .getString(</span>
                            &quot;MovementDisplay.LaunchFighterDialog.message&quot;, new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3608">                                                                                         ce.getShortName(), doors * 2, bayNum});</span>
<span class="nc bnc" id="L3609" title="All 2 branches missed.">            for (int loop = 0; loop &lt; names.length; loop++) {</span>
<span class="nc" id="L3610">                names[loop] = currentFighters.elementAt(loop).getShortName();</span>
            }

<span class="nc" id="L3613">            boolean doIt = false;</span>
<span class="nc" id="L3614">            ChoiceDialog choiceDialog = null;</span>
<span class="nc bnc" id="L3615" title="All 2 branches missed.">            while (!doIt) {</span>
<span class="nc" id="L3616">                choiceDialog = new ChoiceDialog(</span>
                        clientgui.frame,
<span class="nc" id="L3618">                        Messages.getString(</span>
                                &quot;MovementDisplay.LaunchFighterDialog.title&quot;, new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3620">                                                                                           currentBay.getType(), bayNum}), question,</span>
                        names);
<span class="nc" id="L3622">                choiceDialog.setVisible(true);</span>
<span class="nc bnc" id="L3623" title="All 2 branches missed.">                if (choiceDialog.getChoices() == null) {</span>
<span class="nc" id="L3624">                    doIt = true;</span>
<span class="nc" id="L3625">                    continue;</span>
                }
<span class="nc" id="L3627">                int numChoices = choiceDialog.getChoices().length;</span>
<span class="nc bnc" id="L3628" title="All 2 branches missed.">                if ((numChoices &gt; currentBay.getSafeLaunchRate())</span>
<span class="nc bnc" id="L3629" title="All 2 branches missed.">                    &amp;&amp; GUIPreferences.getInstance().getNagForLaunchDoors()) {</span>
<span class="nc" id="L3630">                    int aerosPerDoor = numChoices / doors;</span>
<span class="nc" id="L3631">                    int remainder = numChoices % doors;</span>
                    // Determine PSRs
<span class="nc" id="L3633">                    StringBuilder psrs = new StringBuilder();</span>
<span class="nc bnc" id="L3634" title="All 2 branches missed.">                    for (int choice = 0; choice &lt; numChoices; choice++) {</span>
<span class="nc" id="L3635">                        int modifier = aerosPerDoor - 2;</span>
<span class="nc bnc" id="L3636" title="All 2 branches missed.">                        if ((choice / aerosPerDoor) &gt;= (doors - 1)) {</span>
<span class="nc" id="L3637">                            modifier += remainder;</span>
                        }
<span class="nc" id="L3639">                        modifier += currentFighters.get(choice).getCrew()</span>
<span class="nc" id="L3640">                                                   .getPiloting();</span>
<span class="nc" id="L3641">                        String damageMsg = Messages</span>
<span class="nc" id="L3642">                                .getString(</span>
                                        &quot;MovementDisplay.LaunchFighterDialog.controlroll&quot;,
                                        //$NON-NLS-1$
<span class="nc" id="L3645">                                        new Object[]{names[choice], modifier});</span>
<span class="nc" id="L3646">                        psrs.append(&quot;\t&quot; + damageMsg + &quot;\n&quot;);</span>
                    }
<span class="nc" id="L3648">                    ConfirmDialog nag = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L3649">                                                          Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L3650">                                                          Messages.getString(&quot;MovementDisplay.ConfirmLaunch&quot;)</span>
<span class="nc" id="L3651">                                                          + psrs.toString(), true);</span>
<span class="nc" id="L3652">                    nag.setVisible(true);</span>
<span class="nc" id="L3653">                    doIt = nag.getAnswer();</span>
<span class="nc bnc" id="L3654" title="All 2 branches missed.">                    if (!nag.getShowAgain()) {</span>
<span class="nc" id="L3655">                        GUIPreferences.getInstance()</span>
<span class="nc" id="L3656">                                      .setNagForLaunchDoors(false);</span>
                    }
<span class="nc" id="L3658">                } else {</span>
<span class="nc" id="L3659">                    doIt = true;</span>
                }
<span class="nc" id="L3661">            }</span>
<span class="nc bnc" id="L3662" title="All 4 branches missed.">            if ((choiceDialog.getAnswer() == true) &amp;&amp; doIt) {</span>
                // load up the choices
<span class="nc" id="L3664">                int[] unitsLaunched = choiceDialog.getChoices();</span>
<span class="nc bnc" id="L3665" title="All 2 branches missed.">                for (int element : unitsLaunched) {</span>
<span class="nc" id="L3666">                    bayChoices.add(currentFighters.elementAt(element).getId());</span>
                    //Prompt the player to load passengers aboard small craft
<span class="nc" id="L3668">                    Entity en = clientgui.getClient().getGame().getEntity(currentFighters.elementAt(element).getId());</span>
<span class="nc bnc" id="L3669" title="All 2 branches missed.">                    if (en instanceof SmallCraft) {</span>
<span class="nc" id="L3670">                        loadPassengerAtLaunch(en);</span>
                    }
                }
<span class="nc" id="L3673">                choices.put(i, bayChoices);</span>
                // now remove them (must be a better way?)
<span class="nc bnc" id="L3675" title="All 2 branches missed.">                for (int l = unitsLaunched.length; l &gt; 0; l--) {</span>
<span class="nc" id="L3676">                    currentFighters.remove(unitsLaunched[l - 1]);</span>
                }
            }

<span class="nc" id="L3680">            bayNum++;</span>
        }
<span class="nc" id="L3682">        return choices;</span>
    }

    /**
     * Get the unit that the player wants to unload. This method will remove the
     * unit from our local copy of loaded units.
     *
     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
     * value will not be &lt;code&gt;null&lt;/code&gt;.
     */
    private TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getUndockedUnits() {
<span class="nc" id="L3693">        Entity ce = ce();</span>
<span class="nc" id="L3694">        TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; choices = new TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt;();</span>

<span class="nc" id="L3696">        Vector&lt;Entity&gt; launchableFighters = ce.getLaunchableFighters();</span>
<span class="nc" id="L3697">        Vector&lt;Entity&gt; launchableSmallCraft = ce.getLaunchableSmallCraft();</span>
<span class="nc" id="L3698">        Vector&lt;Entity&gt; launchableDropships = ce.getLaunchableDropships();</span>

        // Handle error condition.
<span class="nc bnc" id="L3701" title="All 2 branches missed.">        if ((launchableFighters.size() &lt;= 0)</span>
<span class="nc bnc" id="L3702" title="All 2 branches missed.">            &amp;&amp; (launchableSmallCraft.size() &lt;= 0)</span>
<span class="nc bnc" id="L3703" title="All 2 branches missed.">            &amp;&amp; (launchableDropships.size() &lt;= 0)) {</span>
<span class="nc" id="L3704">            System.err</span>
<span class="nc" id="L3705">                    .println(&quot;MovementDisplay#getUndockedUnits() called without loaded units.&quot;); //$NON-NLS-1$</span>

        } else {
            // cycle through the docking collars
<span class="nc" id="L3709">            int i = 0;</span>
<span class="nc" id="L3710">            int collarNum = 1;</span>
<span class="nc" id="L3711">            Vector&lt;Entity&gt; currentDropships = new Vector&lt;Entity&gt;();</span>
<span class="nc bnc" id="L3712" title="All 2 branches missed.">            for (DockingCollar collar : ce.getDockingCollars()) {</span>
<span class="nc" id="L3713">                currentDropships = collar.getLaunchableUnits();</span>
<span class="nc" id="L3714">                Vector&lt;Integer&gt; collarChoices = new Vector&lt;Integer&gt;();</span>
<span class="nc bnc" id="L3715" title="All 2 branches missed.">                if (currentDropships.size() &gt; 0) {</span>
<span class="nc" id="L3716">                    String[] names = new String[currentDropships.size()];</span>
<span class="nc" id="L3717">                    String question = Messages</span>
<span class="nc" id="L3718">                            .getString(</span>
                                    &quot;MovementDisplay.LaunchDropshipDialog.message&quot;, new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3720">                                                                                                  ce.getShortName(), 1, collarNum});</span>
<span class="nc bnc" id="L3721" title="All 2 branches missed.">                    for (int loop = 0; loop &lt; names.length; loop++) {</span>
<span class="nc" id="L3722">                        names[loop] = currentDropships.elementAt(loop)</span>
<span class="nc" id="L3723">                                                      .getShortName();</span>
                    }

<span class="nc" id="L3726">                    boolean doIt = false;</span>
<span class="nc" id="L3727">                    ChoiceDialog choiceDialog = new ChoiceDialog(</span>
                            clientgui.frame,
<span class="nc" id="L3729">                            Messages.getString(</span>
                                    &quot;MovementDisplay.LaunchDropshipDialog.title&quot;, new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3731">                                                                                                collar.getType(), collarNum}), question,</span>
                            names);
<span class="nc bnc" id="L3733" title="All 2 branches missed.">                    while (!doIt) {</span>
<span class="nc" id="L3734">                        choiceDialog = new ChoiceDialog(</span>
                                clientgui.frame,
<span class="nc" id="L3736">                                Messages.getString(</span>
                                        &quot;MovementDisplay.LaunchDropshipDialog.title&quot;,
                                        new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3739">                                                      collar.getType(), collarNum}),</span>
                                question, names);
<span class="nc" id="L3741">                        choiceDialog.setVisible(true);</span>
<span class="nc bnc" id="L3742" title="All 2 branches missed.">                        if ((choiceDialog.getChoices() != null)</span>
<span class="nc bnc" id="L3743" title="All 2 branches missed.">                            &amp;&amp; (choiceDialog.getChoices().length &gt; (1))) {</span>
<span class="nc" id="L3744">                            ConfirmDialog nag = new ConfirmDialog(</span>
                                    clientgui.frame,
<span class="nc" id="L3746">                                    Messages.getString(&quot;MovementDisplay.areYouSure&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L3747">                                    Messages.getString(&quot;MovementDisplay.ConfirmLaunch&quot;),</span>
                                    true);
<span class="nc" id="L3749">                            nag.setVisible(true);</span>
<span class="nc" id="L3750">                            doIt = nag.getAnswer();</span>
<span class="nc" id="L3751">                        } else {</span>
<span class="nc" id="L3752">                            doIt = true;</span>
                        }
                    }
<span class="nc bnc" id="L3755" title="All 4 branches missed.">                    if ((choiceDialog.getAnswer() == true) &amp;&amp; doIt) {</span>
                        // load up the choices
<span class="nc" id="L3757">                        int[] unitsLaunched = choiceDialog.getChoices();</span>
<span class="nc bnc" id="L3758" title="All 2 branches missed.">                        for (int element : unitsLaunched) {</span>
<span class="nc" id="L3759">                            collarChoices.add(currentDropships.elementAt(</span>
<span class="nc" id="L3760">                                    element).getId());</span>
                            //Prompt the player to load passengers aboard the launching ship(s)
<span class="nc" id="L3762">                            Entity en = clientgui.getClient().getGame().getEntity(currentDropships.elementAt(element).getId());</span>
<span class="nc bnc" id="L3763" title="All 2 branches missed.">                            if (en instanceof SmallCraft) {</span>
<span class="nc" id="L3764">                                loadPassengerAtLaunch(en);</span>
                            }
                        }
<span class="nc" id="L3767">                        choices.put(i, collarChoices);</span>
                        // now remove them (must be a better way?)
<span class="nc bnc" id="L3769" title="All 2 branches missed.">                        for (int l = unitsLaunched.length; l &gt; 0; l--) {</span>
<span class="nc" id="L3770">                            currentDropships.remove(unitsLaunched[l - 1]);</span>
                        }
                    }
                }
<span class="nc" id="L3774">                collarNum++;</span>
<span class="nc" id="L3775">                i++;</span>
<span class="nc" id="L3776">            }</span>
        }// End have-choices
        // Return the chosen unit.
<span class="nc" id="L3779">        return choices;</span>
    }
    
    /**
     * Worker function that consolidates code for loading dropships/small craft with passengers
     * 
     * @param en - The launching entity, which has already been tested to see if it's a small craft
     */
     private void loadPassengerAtLaunch(Entity en) {
<span class="nc" id="L3788">         SmallCraft craft = (SmallCraft) en;</span>
<span class="nc" id="L3789">         int space = 0;</span>
<span class="nc bnc" id="L3790" title="All 2 branches missed.">         for (Bay b : craft.getTransportBays()) {</span>
<span class="nc bnc" id="L3791" title="All 6 branches missed.">             if (b instanceof CargoBay || b instanceof InfantryBay || b instanceof BattleArmorBay) {</span>
                 // Assume a passenger takes up 0.1 tons per single infantryman weight calculations
<span class="nc" id="L3793">                 space += (b.getUnused() / 0.1);</span>
             }
<span class="nc" id="L3795">         }</span>
         //Passengers don't actually 'load' into bays to consume space, so update what's available for anyone
         //already aboard
<span class="nc" id="L3798">         space -= ((craft.getTotalOtherCrew() + craft.getTotalPassengers()) * 0.1);</span>
         //Make sure the text displays either the carrying capacity or the number of passengers left aboard
<span class="nc" id="L3800">         space = Math.min(space, ce().getNPassenger());</span>
<span class="nc" id="L3801">         ConfirmDialog takePassenger = new ConfirmDialog(clientgui.frame,</span>
<span class="nc" id="L3802">                 Messages.getString(&quot;MovementDisplay.FillSmallCraftPassengerDialog.Title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L3803">                 Messages.getString(&quot;MovementDisplay.FillSmallCraftPassengerDialog.message&quot;,</span>
<span class="nc" id="L3804">                         new Object[]{craft.getShortName(), space, ce().getShortName() + &quot;'&quot;, ce().getNPassenger()}), false);</span>
<span class="nc" id="L3805">         takePassenger.setVisible(true);</span>
<span class="nc bnc" id="L3806" title="All 2 branches missed.">         if (takePassenger.getAnswer()) {</span>
             //Move the passengers
<span class="nc" id="L3808">             ce().setNPassenger(ce().getNPassenger() - space);</span>
<span class="nc bnc" id="L3809" title="All 2 branches missed.">             if (ce() instanceof Aero) {</span>
<span class="nc" id="L3810">                 ((Aero)ce()).addEscapeCraft(craft.getExternalIdAsString());</span>
             }
<span class="nc" id="L3812">             clientgui.getClient().sendUpdateEntity(ce());</span>
<span class="nc" id="L3813">             craft.addPassengers(ce().getExternalIdAsString(), space);</span>
<span class="nc" id="L3814">             clientgui.getClient().sendUpdateEntity(craft);</span>
         }
<span class="nc" id="L3816">     }</span>

    /**
     * Get the unit that the player wants to drop. This method will remove the
     * unit from our local copy of loaded units.
     *
     * @return The &lt;code&gt;Entity&lt;/code&gt; that the player wants to unload. This
     * value will not be &lt;code&gt;null&lt;/code&gt;.
     */
    private TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getDroppedUnits() {
<span class="nc" id="L3826">        Entity ce = ce();</span>
<span class="nc" id="L3827">        TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; choices = new TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt;();</span>

<span class="nc" id="L3829">        Vector&lt;Entity&gt; droppableUnits = ce.getDroppableUnits();</span>
<span class="nc" id="L3830">        Set&lt;Integer&gt; alreadyDropped = cmd.getDroppedUnits();</span>

        // Handle error condition.
<span class="nc bnc" id="L3833" title="All 2 branches missed.">        if (droppableUnits.size() &lt;= 0) {</span>
<span class="nc" id="L3834">            System.err</span>
<span class="nc" id="L3835">                    .println(&quot;MovementDisplay#getDroppedUnits() called without loaded units.&quot;); //$NON-NLS-1$</span>

        } else {
            // cycle through the bays
<span class="nc" id="L3839">            int bayNum = 1;</span>
            Bay currentBay;
<span class="nc" id="L3841">            List&lt;Entity&gt; currentUnits = new ArrayList&lt;Entity&gt;();</span>
<span class="nc" id="L3842">            int doors = 0;</span>
<span class="nc" id="L3843">            Vector&lt;Bay&gt; Bays = ce.getTransportBays();</span>
<span class="nc bnc" id="L3844" title="All 2 branches missed.">            for (int i = 0; i &lt; Bays.size(); i++) {</span>
<span class="nc" id="L3845">                currentBay = Bays.elementAt(i);</span>
<span class="nc" id="L3846">                Vector&lt;Integer&gt; bayChoices = new Vector&lt;Integer&gt;();</span>
<span class="nc" id="L3847">                currentUnits = currentBay.getDroppableUnits().stream()</span>
<span class="nc bnc" id="L3848" title="All 2 branches missed.">                        .filter(e -&gt; !alreadyDropped.contains(e.getId()))</span>
<span class="nc" id="L3849">                        .collect(Collectors.toList());</span>

<span class="nc" id="L3851">                doors = currentBay.getCurrentDoors();</span>
<span class="nc bnc" id="L3852" title="All 4 branches missed.">                if ((currentUnits.size() &gt; 0) &amp;&amp; (doors &gt; 0)) {</span>
<span class="nc" id="L3853">                    String[] names = new String[currentUnits.size()];</span>
<span class="nc" id="L3854">                    String question = Messages</span>
<span class="nc" id="L3855">                            .getString(</span>
                                    &quot;MovementDisplay.DropUnitDialog.message&quot;, new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3857">                                                                                            doors, bayNum});</span>
<span class="nc bnc" id="L3858" title="All 2 branches missed.">                    for (int loop = 0; loop &lt; names.length; loop++) {</span>
<span class="nc" id="L3859">                        names[loop] = currentUnits.get(loop)</span>
<span class="nc" id="L3860">                                                  .getShortName();</span>
                    }
<span class="nc" id="L3862">                    ChoiceDialog choiceDialog = new ChoiceDialog(</span>
                            clientgui.frame,
<span class="nc" id="L3864">                            Messages.getString(</span>
                                    &quot;MovementDisplay.DropUnitDialog.title&quot;, new Object[]{ //$NON-NLS-1$
<span class="nc" id="L3866">                                                                                          currentBay.getType(), bayNum}), question,</span>
                            names, false, doors);
<span class="nc" id="L3868">                    choiceDialog.setVisible(true);</span>
<span class="nc bnc" id="L3869" title="All 2 branches missed.">                    if (choiceDialog.getAnswer() == true) {</span>
                        // load up the choices
<span class="nc" id="L3871">                        int[] unitsLaunched = choiceDialog.getChoices();</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">                        for (int element : unitsLaunched) {</span>
<span class="nc" id="L3873">                            bayChoices.add(currentUnits.get(element)</span>
<span class="nc" id="L3874">                                                       .getId());</span>
                        }
<span class="nc" id="L3876">                        choices.put(i, bayChoices);</span>
                        // now remove them (must be a better way?)
<span class="nc bnc" id="L3878" title="All 2 branches missed.">                        for (int l = unitsLaunched.length; l &gt; 0; l--) {</span>
<span class="nc" id="L3879">                            currentUnits.remove(unitsLaunched[l - 1]);</span>
                        }
                    }
                }
<span class="nc" id="L3883">                bayNum++;</span>
            }
        }// End have-choices
        // Return the chosen unit.
<span class="nc" id="L3887">        return choices;</span>
    }

    /**
     * get the unit id that the player wants to be recovered by
     */
    private int getRecoveryUnit() {
<span class="nc" id="L3894">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L3895">        final Entity ce = ce();</span>
<span class="nc" id="L3896">        List&lt;Entity&gt; choices = new ArrayList&lt;Entity&gt;();</span>

        // collect all possible choices
<span class="nc" id="L3899">        Coords loadeePos = cmd.getFinalCoords();</span>
<span class="nc bnc" id="L3900" title="All 2 branches missed.">        if (clientgui.getClient().getGame().useVectorMove()) {</span>
            // not where you are, but where you will be
<span class="nc" id="L3902">            loadeePos = Compute.getFinalPosition(ce.getPosition(),</span>
<span class="nc" id="L3903">                                                 cmd.getFinalVectors());</span>
        }
<span class="nc bnc" id="L3905" title="All 2 branches missed.">        for (Entity other : game.getEntitiesVector(loadeePos)) {</span>
            // Is the other unit friendly and not the current entity?
            // must be done with its movement
            // it also must be same heading and velocity
<span class="nc bnc" id="L3909" title="All 4 branches missed.">            if ((other instanceof Aero) &amp;&amp; !((Aero) other).isOutControlTotal()</span>
<span class="nc bnc" id="L3910" title="All 4 branches missed.">                &amp;&amp; other.isDone() &amp;&amp; other.canLoad(ce)</span>
<span class="nc bnc" id="L3911" title="All 2 branches missed.">                &amp;&amp; ce.isLoadableThisTurn()</span>
<span class="nc bnc" id="L3912" title="All 2 branches missed.">                &amp;&amp; (cmd.getFinalFacing() == other.getFacing())) {</span>

                // now lets check velocity
                // depends on movement rules
<span class="nc" id="L3916">                Aero oa = (Aero) other;</span>
<span class="nc bnc" id="L3917" title="All 2 branches missed.">                if (clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc bnc" id="L3918" title="All 2 branches missed.">                    if (Compute.sameVectors(cmd.getFinalVectors(),</span>
<span class="nc" id="L3919">                                            oa.getVectors())) {</span>
<span class="nc" id="L3920">                        choices.add(other);</span>
                    }
<span class="nc bnc" id="L3922" title="All 2 branches missed.">                } else if (cmd.getFinalVelocity() == oa.getCurrentVelocity()) {</span>
<span class="nc" id="L3923">                    choices.add(other);</span>
                }
            }
            // Nope. Discard it.
<span class="nc" id="L3927">            other = null;</span>
<span class="nc" id="L3928">        } // Check the next entity in this position.</span>

<span class="nc bnc" id="L3930" title="All 2 branches missed.">        if (choices.size() &lt; 1) {</span>
<span class="nc" id="L3931">            return -1;</span>
        }

<span class="nc bnc" id="L3934" title="All 2 branches missed.">        if (choices.size() == 1) {</span>
<span class="nc bnc" id="L3935" title="All 2 branches missed.">            if (choices.get(0).mpUsed &gt; 0) {</span>
<span class="nc" id="L3936">                if (clientgui</span>
<span class="nc bnc" id="L3937" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L3938">                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L3939">                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.message&quot;) //$NON-NLS-1$</span>
                                      )) {
<span class="nc" id="L3941">                    return choices.get(0).getId();</span>
                }
            } else {
<span class="nc" id="L3944">                return choices.get(0).getId();</span>
            }
<span class="nc" id="L3946">            return -1;</span>
        }

<span class="nc" id="L3949">        String input = (String) JOptionPane</span>
<span class="nc" id="L3950">                .showInputDialog(</span>
                        clientgui,
<span class="nc" id="L3952">                        Messages.getString(&quot;MovementDisplay.RecoverFighterDialog.message&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L3953">                        Messages.getString(&quot;MovementDisplay.RecoverFighterDialog.title&quot;), //$NON-NLS-1$</span>
                        JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L3955">                                .getDisplayArray(choices), null);</span>
<span class="nc" id="L3956">        Entity picked = (Entity) SharedUtility.getTargetPicked(choices, input);</span>

<span class="nc bnc" id="L3958" title="All 2 branches missed.">        if (picked != null) {</span>
            // if this unit is thrusting, make sure they are aware
<span class="nc bnc" id="L3960" title="All 2 branches missed.">            if (picked.mpUsed &gt; 0) {</span>
<span class="nc" id="L3961">                if (clientgui</span>
<span class="nc bnc" id="L3962" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L3963">                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L3964">                                Messages.getString(&quot;MovementDisplay.RecoverSureDialog.message&quot;) //$NON-NLS-1$</span>
                                      )) {
<span class="nc" id="L3966">                    return picked.getId();</span>
                }
            } else {
<span class="nc" id="L3969">                return picked.getId();</span>
            }
        }
<span class="nc" id="L3972">        return -1;</span>
    }

    /**
     * @return the unit id that the player wants to join
     */
    private int getUnitJoined() {
<span class="nc" id="L3979">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L3980">        final Entity ce = ce();</span>
<span class="nc" id="L3981">        List&lt;Entity&gt; choices = new ArrayList&lt;Entity&gt;();</span>

        // collect all possible choices
<span class="nc" id="L3984">        Coords loadeePos = cmd.getFinalCoords();</span>
<span class="nc bnc" id="L3985" title="All 2 branches missed.">        if (clientgui.getClient().getGame().useVectorMove()) {</span>
            // not where you are, but where you will be
<span class="nc" id="L3987">            loadeePos = Compute.getFinalPosition(ce.getPosition(),</span>
<span class="nc" id="L3988">                                                 cmd.getFinalVectors());</span>
        }
<span class="nc bnc" id="L3990" title="All 2 branches missed.">        for (Entity other : game.getEntitiesVector(loadeePos)) {</span>
            // Is the other unit friendly and not the current entity?
            // must be done with its movement
            // it also must be same heading and velocity
<span class="nc bnc" id="L3994" title="All 4 branches missed.">            if ((other instanceof Aero) &amp;&amp; !((Aero) other).isOutControlTotal()</span>
<span class="nc bnc" id="L3995" title="All 4 branches missed.">                &amp;&amp; other.isDone() &amp;&amp; other.canLoad(ce)</span>
<span class="nc bnc" id="L3996" title="All 2 branches missed.">                &amp;&amp; ce.isLoadableThisTurn()</span>
<span class="nc bnc" id="L3997" title="All 2 branches missed.">                &amp;&amp; (cmd.getFinalFacing() == other.getFacing())) {</span>

                // now lets check velocity
                // depends on movement rules
<span class="nc" id="L4001">                Aero oa = (Aero) other;</span>
<span class="nc bnc" id="L4002" title="All 2 branches missed.">                if (clientgui.getClient().getGame().useVectorMove()) {</span>
<span class="nc bnc" id="L4003" title="All 2 branches missed.">                    if (Compute.sameVectors(cmd.getFinalVectors(),</span>
<span class="nc" id="L4004">                                            oa.getVectors())) {</span>
<span class="nc" id="L4005">                        choices.add(other);</span>
                    }
<span class="nc bnc" id="L4007" title="All 2 branches missed.">                } else if (cmd.getFinalVelocity() == oa.getCurrentVelocity()) {</span>
<span class="nc" id="L4008">                    choices.add(other);</span>
                }
            }
            // Nope. Discard it.
<span class="nc" id="L4012">            other = null;</span>
<span class="nc" id="L4013">        } // Check the next entity in this position.</span>

<span class="nc bnc" id="L4015" title="All 2 branches missed.">        if (choices.size() &lt; 1) {</span>
<span class="nc" id="L4016">            return -1;</span>
        }

<span class="nc bnc" id="L4019" title="All 2 branches missed.">        if (choices.size() == 1) {</span>
<span class="nc" id="L4020">            return choices.get(0).getId();</span>
        }

<span class="nc" id="L4023">        String input = (String) JOptionPane.showInputDialog(</span>
                clientgui,
<span class="nc" id="L4025">                Messages.getString(&quot;MovementDisplay.JoinSquadronDialog&quot;</span>
                                   + &quot;.message&quot;), //$NON-NLS-1$
<span class="nc" id="L4027">                Messages.getString(&quot;MovementDisplay.JoinSquadronDialog&quot;</span>
                                   + &quot;.title&quot;), //$NON-NLS-1$
                JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L4030">                SharedUtility.getDisplayArray(choices), null);</span>
<span class="nc" id="L4031">        Entity picked = (Entity) SharedUtility.getTargetPicked(choices, input);</span>
<span class="nc bnc" id="L4032" title="All 2 branches missed.">        if (picked != null) {</span>
<span class="nc" id="L4033">            return picked.getId();</span>
        }
<span class="nc" id="L4035">        return -1;</span>
    }

    /**
     * check for out of control and adjust buttons
     */
    private void checkOOC() {
<span class="nc" id="L4042">        final Entity ce = ce();</span>
<span class="nc bnc" id="L4043" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L4044">            return;</span>
        }

<span class="nc bnc" id="L4047" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L4048">            return;</span>
        }

<span class="nc" id="L4051">        IAero a = (IAero) ce;</span>

<span class="nc bnc" id="L4053" title="All 4 branches missed.">        if (a.isOutControlTotal() &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L4054">            disableButtons();</span>
<span class="nc" id="L4055">            butDone.setEnabled(true);</span>
<span class="nc bnc" id="L4056" title="All 2 branches missed.">            if (numButtonGroups &gt; 1)</span>
<span class="nc" id="L4057">                getBtn(MoveCommand.MOVE_MORE).setEnabled(true);</span>
<span class="nc" id="L4058">            getBtn(MoveCommand.MOVE_NEXT).setEnabled(true);</span>
<span class="nc" id="L4059">            setForwardIniEnabled(true);</span>
<span class="nc bnc" id="L4060" title="All 2 branches missed.">            if (ce instanceof Aero) {</span>
<span class="nc bnc" id="L4061" title="All 2 branches missed.">                setLaunchEnabled((((Aero)ce).getLaunchableFighters().size() &gt; 0)</span>
<span class="nc bnc" id="L4062" title="All 2 branches missed.">                        || (((Aero)ce).getLaunchableSmallCraft().size() &gt; 0)</span>
<span class="nc bnc" id="L4063" title="All 2 branches missed.">                        || (((Aero)ce).getLaunchableDropships().size() &gt; 0));</span>
            }
        }
<span class="nc" id="L4066">        return;</span>
    }

    /**
     * check for fuel and adjust buttons
     */
    private void checkFuel() {
<span class="nc" id="L4073">        final Entity ce = ce();</span>
<span class="nc bnc" id="L4074" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L4075">            return;</span>
        }

<span class="nc bnc" id="L4078" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L4079">            return;</span>
        }

<span class="nc" id="L4082">        IAero a = (IAero) ce;</span>
<span class="nc bnc" id="L4083" title="All 2 branches missed.">        if (a.getCurrentFuel() &lt; 1) {</span>
<span class="nc" id="L4084">            disableButtons();</span>
<span class="nc" id="L4085">            butDone.setEnabled(true);</span>
<span class="nc" id="L4086">            getBtn(MoveCommand.MOVE_NEXT).setEnabled(true);</span>
<span class="nc" id="L4087">            setForwardIniEnabled(true);</span>
<span class="nc bnc" id="L4088" title="All 2 branches missed.">            if (ce instanceof Aero) {</span>
<span class="nc bnc" id="L4089" title="All 2 branches missed.">                setLaunchEnabled((((Aero)ce).getLaunchableFighters().size() &gt; 0)</span>
<span class="nc bnc" id="L4090" title="All 2 branches missed.">                        || (((Aero)ce).getLaunchableSmallCraft().size() &gt; 0)</span>
<span class="nc bnc" id="L4091" title="All 2 branches missed.">                        || (((Aero)ce).getLaunchableDropships().size() &gt; 0));</span>
            }
<span class="nc" id="L4093">            updateRACButton();</span>
<span class="nc" id="L4094">            updateJoinButton();</span>
<span class="nc" id="L4095">            updateRecoveryButton();</span>
<span class="nc" id="L4096">            updateDumpButton();</span>
        }
<span class="nc" id="L4098">        return;</span>
    }

    /**
     * check for atmosphere and adjust buttons
     */
    private void checkAtmosphere() {
<span class="nc" id="L4105">        final Entity ce = ce();</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L4107">            return;</span>
        }

<span class="nc bnc" id="L4110" title="All 2 branches missed.">        if (!ce.isAero()) {</span>
<span class="nc" id="L4111">            return;</span>
        }

<span class="nc" id="L4114">        IAero a = (IAero) ce;</span>
<span class="nc bnc" id="L4115" title="All 2 branches missed.">        if (!clientgui.getClient().getGame().getBoard().inSpace()) {</span>
<span class="nc bnc" id="L4116" title="All 2 branches missed.">            if (a.isSpheroid()</span>
<span class="nc" id="L4117">                || clientgui.getClient().getGame().getPlanetaryConditions()</span>
<span class="nc bnc" id="L4118" title="All 2 branches missed.">                            .isVacuum()) {</span>
<span class="nc" id="L4119">                getBtn(MoveCommand.MOVE_ACC).setEnabled(false);</span>
<span class="nc" id="L4120">                getBtn(MoveCommand.MOVE_DEC).setEnabled(false);</span>
<span class="nc" id="L4121">                getBtn(MoveCommand.MOVE_ACCN).setEnabled(false);</span>
<span class="nc" id="L4122">                getBtn(MoveCommand.MOVE_DECN).setEnabled(false);</span>
            }
        }
<span class="nc" id="L4125">        return;</span>
    }

    /**
     * Have the player select a target from the entities at the given coords.
     *
     * @param pos - the &lt;code&gt;Coords&lt;/code&gt; containing targets.
     */
    private Targetable chooseTarget(Coords pos) {
<span class="nc" id="L4134">        final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L4135">        final Entity ce = ce();</span>

        // Assume that we have *no* choice.
<span class="nc" id="L4138">        Targetable choice = null;</span>

        // Get the available choices.

        // Convert the choices into a List of targets.
<span class="nc" id="L4143">        ArrayList&lt;Targetable&gt; targets = new ArrayList&lt;Targetable&gt;();</span>
<span class="nc bnc" id="L4144" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector(pos)) {</span>
<span class="nc bnc" id="L4145" title="All 4 branches missed.">            if ((ce == null) || !ce.equals(ent)) {</span>
<span class="nc" id="L4146">                targets.add(ent);</span>
            }
<span class="nc" id="L4148">        }</span>

        // Is there a building in the hex?
<span class="nc" id="L4151">        Building bldg = clientgui.getClient().getGame().getBoard()</span>
<span class="nc" id="L4152">                                 .getBuildingAt(pos);</span>
<span class="nc bnc" id="L4153" title="All 2 branches missed.">        if (bldg != null) {</span>
<span class="nc" id="L4154">            targets.add(new BuildingTarget(pos, clientgui.getClient().getGame()</span>
<span class="nc" id="L4155">                                                         .getBoard(), false));</span>
        }

        // Do we have a single choice?
<span class="nc bnc" id="L4159" title="All 2 branches missed.">        if (targets.size() == 1) {</span>
            // Return that choice.
<span class="nc" id="L4161">            choice = targets.get(0);</span>
        }

        // If we have multiple choices, display a selection dialog.
<span class="nc bnc" id="L4165" title="All 2 branches missed.">        else if (targets.size() &gt; 1) {</span>
<span class="nc" id="L4166">            String input = (String) JOptionPane</span>
<span class="nc" id="L4167">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L4169">                            Messages.getString(</span>
                                    &quot;MovementDisplay.ChooseTargetDialog.message&quot;, new Object[]{//$NON-NLS-1$
<span class="nc" id="L4171">                                                                                               pos.getBoardNum()}),</span>
<span class="nc" id="L4172">                            Messages.getString(&quot;MovementDisplay.ChooseTargetDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, SharedUtility
<span class="nc" id="L4174">                                    .getDisplayArray(targets), null);</span>
<span class="nc" id="L4175">            choice = SharedUtility.getTargetPicked(targets, input);</span>
        } // End have-choices

        // Return the chosen unit.
<span class="nc" id="L4179">        return choice;</span>
    } // End private Targetable chooseTarget( Coords )

    private int chooseMineToLay() {
<span class="nc" id="L4183">        MineLayingDialog mld = new MineLayingDialog(clientgui.frame, ce());</span>
<span class="nc" id="L4184">        mld.setVisible(true);</span>
<span class="nc bnc" id="L4185" title="All 2 branches missed.">        if (mld.getAnswer()) {</span>
<span class="nc" id="L4186">            return mld.getMine();</span>
        }
<span class="nc" id="L4188">        return -1;</span>
    }

    private void dumpBombs() {

<span class="nc bnc" id="L4193" title="All 2 branches missed.">        if (!ce().isAero()) {</span>
<span class="nc" id="L4194">            return;</span>
        }

<span class="nc" id="L4197">        EntityMovementType overallMoveType = EntityMovementType.MOVE_NONE;</span>
<span class="nc bnc" id="L4198" title="All 2 branches missed.">        if (null != cmd) {</span>
<span class="nc" id="L4199">            overallMoveType = cmd.getLastStepMovementType();</span>
        }
        // bring up dialog to dump bombs, then make a control roll and report
        // success or failure
        // should update mp available
<span class="nc" id="L4204">        int numFighters = ce().getActiveSubEntities().orElse(Collections.emptyList()).size();</span>
<span class="nc" id="L4205">        BombPayloadDialog dumpBombsDialog = new BombPayloadDialog(</span>
                clientgui.frame,
<span class="nc" id="L4207">                Messages.getString(&quot;MovementDisplay.BombDumpDialog.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L4208">                ce().getBombLoadout(), false, true, -1, numFighters);</span>
<span class="nc" id="L4209">        dumpBombsDialog.setVisible(true);</span>
<span class="nc bnc" id="L4210" title="All 2 branches missed.">        if (dumpBombsDialog.getAnswer()) {</span>
            // int[] bombsDumped =
<span class="nc" id="L4212">            dumpBombsDialog.getChoices();</span>
            // first make a control roll
<span class="nc" id="L4214">            PilotingRollData psr = ce().getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L4215">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L4216">            Report r = new Report(9500);</span>
<span class="nc" id="L4217">            r.subject = ce().getId();</span>
<span class="nc" id="L4218">            r.add(ce().getDisplayName());</span>
<span class="nc" id="L4219">            r.add(psr);</span>
<span class="nc" id="L4220">            r.add(ctrlroll);</span>
<span class="nc" id="L4221">            r.newlines = 0;</span>
<span class="nc" id="L4222">            r.indent(1);</span>
<span class="nc bnc" id="L4223" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L4224">                r.choose(false);</span>
                // addReport(r);
<span class="nc" id="L4226">                String title = Messages</span>
<span class="nc" id="L4227">                        .getString(&quot;MovementDisplay.DumpingBombs.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L4228">                String body = Messages</span>
<span class="nc" id="L4229">                        .getString(&quot;MovementDisplay.DumpFailure.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L4230">                clientgui.doAlertDialog(title, body);</span>
                // failed the roll, so dump all bombs
                // bombsDumped =
<span class="nc" id="L4233">                ce().getBombLoadout();</span>
<span class="nc" id="L4234">            } else {</span>
                // avoided damage
<span class="nc" id="L4236">                r.choose(true);</span>
<span class="nc" id="L4237">                String title = Messages</span>
<span class="nc" id="L4238">                        .getString(&quot;MovementDisplay.DumpingBombs.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L4239">                String body = Messages</span>
<span class="nc" id="L4240">                        .getString(&quot;MovementDisplay.DumpSuccessful.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L4241">                clientgui.doAlertDialog(title, body);</span>
                // addReport(r);
            }
            /*
             * // now unload the bombs for (int j = 0; j &lt; bombsDumped.length;
             * j++) { if (bombsDumped[j] &gt; 0) { a.removeBombs(bombsDumped[j],
             * j); // Report r = new Report(5115); r.subject = ce().getId();
             * r.addDesc(ce()); r.add(&quot;&quot; + bombsDumped[j] + &quot; &quot; +
             * Aero.bombNames[j] + &quot;(s)&quot;); // addReport(r); } } // update the
             * bomb load immediately a.updateBombLoad();
             * clientgui.getClient().sendUpdateEntity(ce());
             */
            // not sure how to update mech display, but everything else is
            // working
        }

<span class="nc" id="L4257">    }</span>

    /**
     * based on maneuver type add the appropriate steps return true if we should
     * redraw the movement data
     */
    private boolean addManeuver(int type) {
<span class="nc" id="L4264">        cmd.addManeuver(type);</span>
<span class="nc bnc" id="L4265" title="All 10 branches missed.">        switch (type) {</span>
            case (ManeuverType.MAN_HAMMERHEAD):
<span class="nc" id="L4267">                cmd.addStep(MoveStepType.YAW, true, true);</span>
<span class="nc" id="L4268">                return true;</span>
            case (ManeuverType.MAN_HALF_ROLL):
<span class="nc" id="L4270">                cmd.addStep(MoveStepType.ROLL, true, true);</span>
<span class="nc" id="L4271">                return true;</span>
            case (ManeuverType.MAN_BARREL_ROLL):
<span class="nc" id="L4273">                cmd.addStep(MoveStepType.DEC, true, true);</span>
<span class="nc" id="L4274">                return true;</span>
            case (ManeuverType.MAN_IMMELMAN):
<span class="nc" id="L4276">                gear = MovementDisplay.GEAR_IMMEL;</span>
<span class="nc" id="L4277">                return false;</span>
            case (ManeuverType.MAN_SPLIT_S):
<span class="nc" id="L4279">                gear = MovementDisplay.GEAR_SPLIT_S;</span>
<span class="nc" id="L4280">                return false;</span>
            case (ManeuverType.MAN_VIFF):
<span class="nc bnc" id="L4282" title="All 2 branches missed.">                if (!ce().isAero()) {</span>
<span class="nc" id="L4283">                    return false;</span>
                }
<span class="nc" id="L4285">                IAero a = (IAero) ce();</span>
<span class="nc" id="L4286">                MoveStep last = cmd.getLastStep();</span>
<span class="nc" id="L4287">                int vel = a.getCurrentVelocity();</span>
<span class="nc bnc" id="L4288" title="All 2 branches missed.">                if (null != last) {</span>
<span class="nc" id="L4289">                    vel = last.getVelocityLeft();</span>
                }
<span class="nc bnc" id="L4291" title="All 2 branches missed.">                while (vel &gt; 0) {</span>
<span class="nc" id="L4292">                    cmd.addStep(MoveStepType.DEC, true, true);</span>
<span class="nc" id="L4293">                    vel--;</span>
                }
<span class="nc" id="L4295">                cmd.addStep(MoveStepType.UP);</span>
<span class="nc" id="L4296">                return true;</span>
            case (ManeuverType.MAN_SIDE_SLIP_LEFT):
                // If we are on a ground map, slide slip works slightly
                // differently
                // See Total Warfare pg 85
<span class="nc bnc" id="L4301" title="All 2 branches missed.">                if (clientgui.getClient().getGame().getBoard().getType() == Board.T_GROUND) {</span>
<span class="nc bnc" id="L4302" title="All 2 branches missed.">                    for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc" id="L4303">                        cmd.addStep(MoveStepType.LATERAL_LEFT, true, true);</span>
                    }
<span class="nc bnc" id="L4305" title="All 2 branches missed.">                    for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc" id="L4306">                        cmd.addStep(MoveStepType.FORWARDS, true, true);</span>
                    }
                } else {
<span class="nc" id="L4309">                    cmd.addStep(MoveStepType.LATERAL_LEFT, true, true);</span>
                }
<span class="nc" id="L4311">                return true;</span>
            case (ManeuverType.MAN_SIDE_SLIP_RIGHT):
                // If we are on a ground map, slide slip works slightly
                // differently
                // See Total Warfare pg 85
<span class="nc bnc" id="L4316" title="All 2 branches missed.">                if (clientgui.getClient().getGame().getBoard().getType() == Board.T_GROUND) {</span>
<span class="nc bnc" id="L4317" title="All 2 branches missed.">                    for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc" id="L4318">                        cmd.addStep(MoveStepType.LATERAL_RIGHT, true, true);</span>
                    }
<span class="nc bnc" id="L4320" title="All 2 branches missed.">                    for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc" id="L4321">                        cmd.addStep(MoveStepType.FORWARDS, true, true);</span>
                    }
                } else {
<span class="nc" id="L4324">                    cmd.addStep(MoveStepType.LATERAL_RIGHT, true, true);</span>
                }
<span class="nc" id="L4326">                return true;</span>
            case (ManeuverType.MAN_LOOP):
<span class="nc" id="L4328">                cmd.addStep(MoveStepType.LOOP, true, true);</span>
<span class="nc" id="L4329">                return true;</span>
            default:
<span class="nc" id="L4331">                return false;</span>
        }
    }

    //
    // GameListener
    //
    @Override
    public void gameTurnChange(GameTurnChangeEvent e) {
        // Are we ignoring events?
<span class="nc bnc" id="L4341" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L4342">            return;</span>
        }
        // On simultaneous phases, each player ending their turn will generalte a turn change
        // We want to ignore turns from other players and only listen to events we generated
        // Except on the first turn
<span class="nc bnc" id="L4347" title="All 2 branches missed.">        if (clientgui.getClient().getGame().isPhaseSimultaneous()</span>
<span class="nc bnc" id="L4348" title="All 2 branches missed.">                &amp;&amp; (e.getPreviousPlayerId() != clientgui.getClient().getLocalPlayerNumber())</span>
<span class="nc bnc" id="L4349" title="All 2 branches missed.">                &amp;&amp; (clientgui.getClient().getGame().getTurnIndex() != 0)) {</span>
<span class="nc" id="L4350">            return;</span>
        }

<span class="nc bnc" id="L4353" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
            // ignore
<span class="nc" id="L4355">            return;</span>
        }

<span class="nc bnc" id="L4358" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()) {</span>
            // Can the player unload entities stranded on immobile transports?
<span class="nc bnc" id="L4360" title="All 2 branches missed.">            if (clientgui.getClient().canUnloadStranded()) {</span>
<span class="nc" id="L4361">                unloadStranded();</span>
<span class="nc bnc" id="L4362" title="All 2 branches missed.">            } else if (cen == Entity.NONE) {</span>
<span class="nc" id="L4363">                beginMyTurn();</span>
            }
        } else {
<span class="nc" id="L4366">            endMyTurn();</span>
<span class="nc bnc" id="L4367" title="All 2 branches missed.">            if ((e.getPlayer() == null)</span>
<span class="nc bnc" id="L4368" title="All 2 branches missed.">                    &amp;&amp; (clientgui.getClient().getGame().getTurn() instanceof GameTurn.UnloadStrandedTurn)) {</span>
<span class="nc" id="L4369">                setStatusBarText(Messages</span>
<span class="nc" id="L4370">                        .getString(&quot;MovementDisplay.waitForAnother&quot;)); //$NON-NLS-1$</span>
            } else {
                String playerName;
<span class="nc bnc" id="L4373" title="All 2 branches missed.">                if (e.getPlayer() != null) {</span>
<span class="nc" id="L4374">                    playerName = e.getPlayer().getName();</span>
                } else {
<span class="nc" id="L4376">                    playerName = &quot;Unknown&quot;;</span>
                }
<span class="nc" id="L4378">                setStatusBarText(Messages.getString(</span>
                        &quot;MovementDisplay.its_others_turn&quot;, //$NON-NLS-1$
                        new Object[] { playerName }));
            }
        }
<span class="nc" id="L4383">    }</span>

    @Override
    public void gamePhaseChange(GamePhaseChangeEvent e) {
        // In case of a /reset command, ensure the state gets reset
<span class="nc bnc" id="L4388" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() </span>
                == IGame.Phase.PHASE_LOUNGE) {
<span class="nc" id="L4390">            endMyTurn();</span>
        }
        
        // Are we ignoring events?
<span class="nc bnc" id="L4394" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L4395">            return;</span>
        }
<span class="nc bnc" id="L4397" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L4398" title="All 2 branches missed.">            &amp;&amp; (clientgui.getClient().getGame().getPhase() != IGame.Phase.PHASE_MOVEMENT)) {</span>
<span class="nc" id="L4399">            endMyTurn();</span>
        }
<span class="nc bnc" id="L4401" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getPhase() == IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L4402">            setStatusBarText(Messages</span>
<span class="nc" id="L4403">                                     .getString(&quot;MovementDisplay.waitingForMovementPhase&quot;)); //$NON-NLS-1$</span>
        }
<span class="nc" id="L4405">    }</span>
    
    /**
     * Computes all of the possible moves for an Entity in a particular gear.
     * The Entity can either be a suggested Entity or the currently selected 
     * one.  If there is a selected entity (which implies it's the current 
     * players turn), then the current gear is used (which is set by the user).
     * If there is no selected entity, then the current gear is invalid, and it
     * defaults to GEAR_LAND (standard &quot;walk forward&quot;).
     * 
     * @param suggestion  The suggested Entity to use to compute the movement
     *                      envelope.  If used, the gear will be set to 
     *                      GEAR_LAND.  This takes precendence over the
     *                      currently selected unit. 
     * @param suggestion
     */
    public void computeMovementEnvelope(Entity suggestion) {
        // do nothing if deactivated in the settings
<span class="nc" id="L4423">        if (!GUIPreferences.getInstance()</span>
<span class="nc bnc" id="L4424" title="All 2 branches missed.">                .getBoolean(GUIPreferences.MOVE_ENVELOPE)) {</span>
<span class="nc" id="L4425">            clientgui.bv.clearMovementEnvelope();</span>
<span class="nc" id="L4426">            return;</span>
        }
        
<span class="nc" id="L4429">        Entity en = ce();</span>
<span class="nc" id="L4430">        int mvMode = gear;</span>
<span class="nc bnc" id="L4431" title="All 4 branches missed.">        if ((en == null) &amp;&amp; (suggestion == null)) {</span>
<span class="nc" id="L4432">            return;</span>
<span class="nc bnc" id="L4433" title="All 2 branches missed.">        } else if (en == null) {</span>
<span class="nc" id="L4434">            en = suggestion;</span>
<span class="nc" id="L4435">            mvMode = GEAR_LAND;</span>
        } else {
<span class="nc" id="L4437">            en = suggestion;</span>
        }
<span class="nc bnc" id="L4439" title="All 2 branches missed.">        if (en.isDone()) {</span>
<span class="nc" id="L4440">            return;</span>
        }
        
<span class="nc" id="L4443">        Map&lt;Coords, MovePath&gt; mvEnvData = new HashMap&lt;Coords, MovePath&gt;();</span>
<span class="nc" id="L4444">        MovePath mp = new MovePath(clientgui.getClient().getGame(), en);</span>

        int maxMP;
<span class="nc bnc" id="L4447" title="All 4 branches missed.">        if (mvMode == GEAR_JUMP || mvMode == GEAR_DFA) {</span>
<span class="nc" id="L4448">            maxMP = en.getJumpMP();</span>
<span class="nc bnc" id="L4449" title="All 2 branches missed.">        } else if (mvMode == GEAR_BACKUP) {</span>
<span class="nc" id="L4450">            maxMP = en.getWalkMP();</span>
<span class="nc bnc" id="L4451" title="All 4 branches missed.">        } else if (ce() instanceof Mech &amp;&amp; !(ce() instanceof QuadVee)</span>
<span class="nc bnc" id="L4452" title="All 2 branches missed.">                &amp;&amp; ce().getMovementMode() == EntityMovementMode.TRACKED) {</span>
            //A non-QuadVee 'Mech that is using tracked movement is limited to walking
<span class="nc" id="L4454">            maxMP = en.getWalkMP();</span>
        } else {
<span class="nc" id="L4456">            if (clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L4457" title="All 2 branches missed.">                         .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_SPRINT)) {</span>
<span class="nc" id="L4458">                maxMP = en.getSprintMP();</span>
            } else {
<span class="nc" id="L4460">                maxMP = en.getRunMP();</span>
            }
        }
<span class="nc bnc" id="L4463" title="All 2 branches missed.">        MoveStepType stepType = (mvMode == GEAR_BACKUP) ? MoveStepType.BACKWARDS</span>
<span class="nc" id="L4464">                : MoveStepType.FORWARDS;</span>
<span class="nc bnc" id="L4465" title="All 4 branches missed.">        if (mvMode == GEAR_JUMP || mvMode == GEAR_DFA) {</span>
<span class="nc" id="L4466">            mp.addStep(MoveStepType.START_JUMP);</span>
        }

<span class="nc" id="L4469">        ShortestPathFinder pf = ShortestPathFinder.newInstanceOfOneToAll(maxMP,</span>
<span class="nc" id="L4470">                stepType, en.getGame());</span>
<span class="nc" id="L4471">        pf.run(mp);</span>
<span class="nc" id="L4472">        mvEnvData = pf.getAllComputedPaths();</span>
<span class="nc" id="L4473">        Map&lt;Coords, Integer&gt; mvEnvMP = new HashMap&lt;Coords, Integer&gt;(</span>
<span class="nc" id="L4474">                (int) ((mvEnvData.size() * 1.25) + 1));</span>
<span class="nc bnc" id="L4475" title="All 2 branches missed.">        for (Coords c : mvEnvData.keySet()) {</span>
<span class="nc bnc" id="L4476" title="All 2 branches missed.">            mvEnvMP.put(c, mvEnvData.get(c).countMp(mvMode == GEAR_JUMP));</span>
<span class="nc" id="L4477">        }</span>
<span class="nc" id="L4478">        clientgui.bv.setMovementEnvelope(mvEnvMP, en.getWalkMP(), en</span>
<span class="nc" id="L4479">                .getRunMP(), en.getJumpMP(), mvMode);</span>
<span class="nc" id="L4480">    }</span>

    public void computeModifierEnvelope() {
<span class="nc bnc" id="L4483" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L4484">            return;</span>
        }
        int maxMP;
<span class="nc bnc" id="L4487" title="All 2 branches missed.">        if (gear == GEAR_JUMP) {</span>
<span class="nc" id="L4488">            maxMP = ce().getJumpMP();</span>
<span class="nc bnc" id="L4489" title="All 2 branches missed.">        } else if (gear == GEAR_BACKUP) {</span>
<span class="nc" id="L4490">            maxMP = ce().getWalkMP();</span>
<span class="nc bnc" id="L4491" title="All 4 branches missed.">        } else if (ce() instanceof Mech &amp;&amp; !(ce() instanceof QuadVee)</span>
<span class="nc bnc" id="L4492" title="All 2 branches missed.">                &amp;&amp; ce().getMovementMode() == EntityMovementMode.TRACKED){</span>
            //A non-QuadVee 'Mech that is using tracked movement (or converting to it) is limited to walking
<span class="nc" id="L4494">            maxMP = ce().getWalkMP();</span>
        } else {
<span class="nc" id="L4496">            maxMP = ce().getRunMP();</span>
        }
<span class="nc bnc" id="L4498" title="All 2 branches missed.">        MoveStepType stepType = (gear == GEAR_BACKUP) ? MoveStepType.BACKWARDS</span>
<span class="nc" id="L4499">                                                      : MoveStepType.FORWARDS;</span>
<span class="nc" id="L4500">        MovePath mp = new MovePath(clientgui.getClient().getGame(), ce());</span>
<span class="nc bnc" id="L4501" title="All 2 branches missed.">        if (gear == GEAR_JUMP) {</span>
<span class="nc" id="L4502">            mp.addStep(MoveStepType.START_JUMP);</span>
        }
<span class="nc" id="L4504">        LongestPathFinder lpf = LongestPathFinder.newInstanceOfLongestPath(</span>
<span class="nc" id="L4505">                maxMP, stepType, ce().getGame());</span>
<span class="nc" id="L4506">        final int timeLimit = PreferenceManager.getClientPreferences()</span>
<span class="nc" id="L4507">                                               .getMaxPathfinderTime();</span>
<span class="nc" id="L4508">        AbstractPathFinder.StopConditionTimeout&lt;MovePath&gt; timeoutCondition = new AbstractPathFinder.StopConditionTimeout&lt;&gt;(</span>
                timeLimit * 10);
<span class="nc" id="L4510">        lpf.addStopCondition(timeoutCondition);</span>
<span class="nc" id="L4511">        lpf.run(mp);</span>
<span class="nc" id="L4512">        clientgui.bv.setMovementModifierEnvelope(lpf.getLongestComputedPaths());</span>
<span class="nc" id="L4513">    }</span>

    //
    // ActionListener
    //
    public synchronized void actionPerformed(ActionEvent ev) {
<span class="nc" id="L4519">        final Entity ce = ce();</span>

<span class="nc bnc" id="L4521" title="All 2 branches missed.">        if (ce == null) {</span>
<span class="nc" id="L4522">            return;</span>
        }

        // Are we ignoring events?
<span class="nc bnc" id="L4526" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L4527">            return;</span>
        }
<span class="nc bnc" id="L4529" title="All 2 branches missed.">        if (statusBarActionPerformed(ev, clientgui.getClient())) {</span>
<span class="nc" id="L4530">            return;</span>
        }
<span class="nc bnc" id="L4532" title="All 2 branches missed.">        if (!clientgui.getClient().isMyTurn()) {</span>
            // odd...
<span class="nc" id="L4534">            return;</span>
        }
<span class="nc" id="L4536">        final String actionCmd = ev.getActionCommand();</span>
<span class="nc" id="L4537">        final IOptions opts = clientgui.getClient().getGame().getOptions();</span>
<span class="nc bnc" id="L4538" title="All 2 branches missed.">        if (actionCmd.equals(MoveCommand.MOVE_NEXT.getCmd())) {</span>
<span class="nc" id="L4539">            selectEntity(clientgui.getClient().getNextEntityNum(cen));</span>
<span class="nc bnc" id="L4540" title="All 2 branches missed.">        } else if (actionCmd.equals(</span>
<span class="nc" id="L4541">                MoveCommand.MOVE_FORWARD_INI.getCmd())) {</span>
<span class="nc" id="L4542">            selectNextPlayer();</span>
<span class="nc bnc" id="L4543" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_CANCEL.getCmd())) {</span>
<span class="nc" id="L4544">            clear();</span>
<span class="nc" id="L4545">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4546" title="All 2 branches missed.">        } else if (ev.getSource().equals(getBtn(MoveCommand.MOVE_MORE))) {</span>
<span class="nc" id="L4547">            currentButtonGroup++;</span>
<span class="nc" id="L4548">            currentButtonGroup %= numButtonGroups;</span>
<span class="nc" id="L4549">            setupButtonPanel();</span>
<span class="nc bnc" id="L4550" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_UNJAM.getCmd())) {</span>
<span class="nc" id="L4551">            String title = Messages</span>
<span class="nc" id="L4552">                    .getString(&quot;MovementDisplay.UnjamRAC.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L4553">            String msg = Messages.getString(</span>
                    &quot;MovementDisplay.UnjamRAC.message&quot;); //$NON-NLS-1$
<span class="nc bnc" id="L4555" title="All 6 branches missed.">            if ((gear == MovementDisplay.GEAR_JUMP)</span>
                    || (gear == MovementDisplay.GEAR_CHARGE)
                    || (gear == MovementDisplay.GEAR_DFA)
<span class="nc bnc" id="L4558" title="All 2 branches missed.">                    || ((cmd.getMpUsed() &gt; ce.getWalkMP()) </span>
<span class="nc bnc" id="L4559" title="All 2 branches missed.">                            &amp;&amp; !(cmd.getLastStep().isOnlyPavement() </span>
<span class="nc bnc" id="L4560" title="All 2 branches missed.">                                    &amp;&amp; (cmd.getMpUsed() &lt;= (ce.getWalkMP() + 1))))</span>
<span class="nc bnc" id="L4561" title="All 2 branches missed.">                    || (opts.booleanOption(&quot;tacops_tank_crews&quot;)</span>
<span class="nc bnc" id="L4562" title="All 4 branches missed.">                            &amp;&amp; (cmd.getMpUsed() &gt; 0) &amp;&amp; (ce instanceof Tank) </span>
<span class="nc bnc" id="L4563" title="All 6 branches missed.">                            &amp;&amp; (ce.getCrew().getSize() &lt; 2))</span>
                    || (gear == MovementDisplay.GEAR_SWIM)
                    || (gear == MovementDisplay.GEAR_RAM)) {
                // in the wrong gear
                // clearAllMoves();
                // gear = Compute.GEAR_LAND;
<span class="nc" id="L4569">                setUnjamEnabled(false);</span>
<span class="nc bnc" id="L4570" title="All 2 branches missed.">            } else  if (clientgui.doYesNoDialog(title, msg)) {</span>
<span class="nc" id="L4571">                cmd.addStep(MoveStepType.UNJAM_RAC);</span>
<span class="nc" id="L4572">                ready();</span>
                // If ready() fires, it will call endMyTurn, which sets cen to
                // Entity.NONE.  If this doesn't happen, it means that the
                // ready() was cancelled (ie, not all Velocity is spent), if it
                // is cancelled we have to ensure the UNJAM_RAC step is removed,
                // otherwise it can fire multiple times.
<span class="nc bnc" id="L4578" title="All 2 branches missed.">                if (cen != Entity.NONE) {</span>
<span class="nc" id="L4579">                    cmd.removeLastStep();</span>
                }
            }
<span class="nc bnc" id="L4582" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_SEARCHLIGHT.getCmd())) {</span>
<span class="nc" id="L4583">            cmd.addStep(MoveStepType.SEARCHLIGHT);</span>
<span class="nc bnc" id="L4584" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_WALK.getCmd())) {</span>
<span class="nc bnc" id="L4585" title="All 4 branches missed.">            if ((gear == MovementDisplay.GEAR_JUMP)</span>
                    || (gear == MovementDisplay.GEAR_SWIM)) {
<span class="nc" id="L4587">                gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L4588">                clear();</span>
            }
<span class="nc" id="L4590">            Color walkColor = GUIPreferences.getInstance().getColor(</span>
                    GUIPreferences.ADVANCED_MOVE_DEFAULT_COLOR);
<span class="nc" id="L4592">            clientgui.getBoardView().setHighlightColor(walkColor);</span>
<span class="nc" id="L4593">            gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc" id="L4594">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4595" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_JUMP.getCmd())) {</span>
<span class="nc bnc" id="L4596" title="All 2 branches missed.">            if ((gear != MovementDisplay.GEAR_JUMP)</span>
<span class="nc bnc" id="L4597" title="All 2 branches missed.">                    &amp;&amp; !((cmd.getLastStep() != null)</span>
<span class="nc bnc" id="L4598" title="All 2 branches missed.">                            &amp;&amp; cmd.getLastStep().isFirstStep() </span>
<span class="nc bnc" id="L4599" title="All 2 branches missed.">                            &amp;&amp; (cmd.getLastStep().getType() </span>
                                    == MoveStepType.LAY_MINE))) {
<span class="nc" id="L4601">                clear();</span>
            }
<span class="nc bnc" id="L4603" title="All 2 branches missed.">            if (!cmd.isJumping()) {</span>
<span class="nc" id="L4604">                cmd.addStep(MoveStepType.START_JUMP);</span>
            }
<span class="nc" id="L4606">            gear = MovementDisplay.GEAR_JUMP;</span>
<span class="nc" id="L4607">            Color jumpColor = GUIPreferences.getInstance().getColor(</span>
                    GUIPreferences.ADVANCED_MOVE_JUMP_COLOR);
<span class="nc" id="L4609">            clientgui.getBoardView().setHighlightColor(jumpColor);</span>
<span class="nc" id="L4610">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4611" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_SWIM.getCmd())) {</span>
<span class="nc bnc" id="L4612" title="All 2 branches missed.">            if (gear != MovementDisplay.GEAR_SWIM) {</span>
<span class="nc" id="L4613">                clear();</span>
            }
            // dcmd.addStep(MoveStepType.SWIM);
<span class="nc" id="L4616">            gear = MovementDisplay.GEAR_SWIM;</span>
<span class="nc bnc" id="L4617" title="All 2 branches missed.">            ce.setMovementMode((ce instanceof BipedMech) ? EntityMovementMode.BIPED_SWIM</span>
<span class="nc" id="L4618">                    : EntityMovementMode.QUAD_SWIM);</span>
<span class="nc bnc" id="L4619" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_CONVERT.getCmd())) {</span>
<span class="nc" id="L4620">            EntityMovementMode nextMode = ce.nextConversionMode(cmd.getFinalConversionMode());</span>
            // LAMs may have to skip the next mode due to damage
<span class="nc bnc" id="L4622" title="All 2 branches missed.">            if (ce instanceof LandAirMech) {</span>
<span class="nc bnc" id="L4623" title="All 2 branches missed.">                if (!((LandAirMech)ce).canConvertTo(nextMode)) {</span>
<span class="nc" id="L4624">                    nextMode = ce.nextConversionMode(nextMode);</span>
                }
<span class="nc bnc" id="L4626" title="All 2 branches missed.">                if (!((LandAirMech)ce).canConvertTo(nextMode)) {</span>
<span class="nc" id="L4627">                    nextMode = ce.getMovementMode();</span>
                }
            }
<span class="nc" id="L4630">            adjustConvertSteps(nextMode);</span>
<span class="nc" id="L4631">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4632" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_LEG.getCmd())) {</span>
<span class="nc bnc" id="L4633" title="All 2 branches missed.">            if ((ce.getEntityType() &amp; Entity.ETYPE_QUAD_MECH) == Entity.ETYPE_QUAD_MECH) {</span>
<span class="nc" id="L4634">                adjustConvertSteps(EntityMovementMode.QUAD);                </span>
<span class="nc bnc" id="L4635" title="All 2 branches missed.">            } else if ((ce.getEntityType() &amp; Entity.ETYPE_TRIPOD_MECH) == Entity.ETYPE_TRIPOD_MECH) {</span>
<span class="nc" id="L4636">                adjustConvertSteps(EntityMovementMode.TRIPOD);</span>
<span class="nc bnc" id="L4637" title="All 2 branches missed.">            } else if ((ce.getEntityType() &amp; Entity.ETYPE_BIPED_MECH) == Entity.ETYPE_BIPED_MECH) {</span>
<span class="nc" id="L4638">                adjustConvertSteps(EntityMovementMode.BIPED);</span>
            }
<span class="nc" id="L4640">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4641" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_VEE.getCmd())) {</span>
<span class="nc bnc" id="L4642" title="All 4 branches missed.">            if (ce instanceof QuadVee &amp;&amp; ((QuadVee)ce).getMotiveType() == QuadVee.MOTIVE_WHEEL) {</span>
<span class="nc" id="L4643">                adjustConvertSteps(EntityMovementMode.WHEELED);</span>
<span class="nc bnc" id="L4644" title="All 6 branches missed.">            } else if ((ce instanceof Mech &amp;&amp; ((Mech)ce).hasTracks())</span>
                    || ce instanceof QuadVee) {
<span class="nc" id="L4646">                adjustConvertSteps(EntityMovementMode.TRACKED);</span>
<span class="nc bnc" id="L4647" title="All 2 branches missed.">            } else if (ce instanceof LandAirMech</span>
<span class="nc bnc" id="L4648" title="All 2 branches missed.">                    &amp;&amp; ((LandAirMech)ce).getLAMType() == LandAirMech.LAM_STANDARD) {</span>
<span class="nc" id="L4649">                adjustConvertSteps(EntityMovementMode.WIGE);</span>
            }
<span class="nc" id="L4651">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4652" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_MODE_AIR.getCmd())) {</span>
<span class="nc bnc" id="L4653" title="All 2 branches missed.">            if (ce instanceof LandAirMech) {</span>
<span class="nc" id="L4654">                adjustConvertSteps(EntityMovementMode.AERODYNE);</span>
            }
<span class="nc" id="L4656">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4657" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TURN.getCmd())) {</span>
<span class="nc" id="L4658">            gear = MovementDisplay.GEAR_TURN;</span>
<span class="nc bnc" id="L4659" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_BACK_UP.getCmd())) {</span>
<span class="nc bnc" id="L4660" title="All 2 branches missed.">            if (gear == MovementDisplay.GEAR_JUMP) {</span>
<span class="nc" id="L4661">                gear = MovementDisplay.GEAR_BACKUP; // on purpose...</span>
<span class="nc" id="L4662">                clear();</span>
            }
<span class="nc" id="L4664">            gear = MovementDisplay.GEAR_BACKUP; // on purpose...</span>
<span class="nc" id="L4665">            Color backColor = GUIPreferences.getInstance().getColor(</span>
                    GUIPreferences.ADVANCED_MOVE_BACK_COLOR);
<span class="nc" id="L4667">            clientgui.getBoardView().setHighlightColor(backColor);</span>
<span class="nc" id="L4668">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4669" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LONGEST_RUN.getCmd())) {</span>
<span class="nc bnc" id="L4670" title="All 2 branches missed.">            if (gear == MovementDisplay.GEAR_JUMP) {</span>
<span class="nc" id="L4671">                clear();</span>
            }
<span class="nc" id="L4673">            gear = MovementDisplay.GEAR_LONGEST_RUN;</span>
<span class="nc bnc" id="L4674" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LONGEST_WALK.getCmd())) {</span>
<span class="nc bnc" id="L4675" title="All 2 branches missed.">            if (gear == MovementDisplay.GEAR_JUMP) {</span>
<span class="nc" id="L4676">                clear();</span>
            }
<span class="nc" id="L4678">            gear = MovementDisplay.GEAR_LONGEST_WALK;</span>
<span class="nc bnc" id="L4679" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_CLEAR.getCmd())) {</span>
<span class="nc" id="L4680">            clear();</span>
<span class="nc" id="L4681">            if (!clientgui.getClient().getGame()</span>
<span class="nc bnc" id="L4682" title="All 2 branches missed.">                    .containsMinefield(ce.getPosition())) {</span>
<span class="nc" id="L4683">                clientgui.doAlertDialog(Messages</span>
<span class="nc" id="L4684">                        .getString(&quot;MovementDisplay.CantClearMinefield&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L4685">                        Messages.getString(&quot;MovementDisplay.NoMinefield&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L4686">                return;</span>
            }

            // Does the entity has a minesweeper?
<span class="nc" id="L4690">            int clear = Minefield.CLEAR_NUMBER_INFANTRY;</span>
<span class="nc" id="L4691">            int boom = Minefield.CLEAR_NUMBER_INFANTRY_ACCIDENT;</span>
            // Check for Minesweeping Engineers
<span class="nc bnc" id="L4693" title="All 2 branches missed.">            if ((ce() instanceof Infantry)) {</span>
<span class="nc" id="L4694">                Infantry inf = (Infantry) ce();</span>
<span class="nc bnc" id="L4695" title="All 2 branches missed.">                if (inf.hasSpecialization(Infantry.MINE_ENGINEERS)) {</span>
<span class="nc" id="L4696">                    clear = Minefield.CLEAR_NUMBER_INF_ENG;</span>
<span class="nc" id="L4697">                    boom = Minefield.CLEAR_NUMBER_INF_ENG_ACCIDENT;</span>
                }
            }
            // Check for Mine clearance manipulators on BA
<span class="nc bnc" id="L4701" title="All 2 branches missed.">            if ((ce() instanceof BattleArmor)) {</span>
<span class="nc" id="L4702">                BattleArmor ba = (BattleArmor) ce();</span>
<span class="nc" id="L4703">                String mcmName = BattleArmor.MANIPULATOR_TYPE_STRINGS</span>
                        [BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE];
<span class="nc bnc" id="L4705" title="All 2 branches missed.">                if (ba.getLeftManipulatorName().equals(mcmName)) {</span>
<span class="nc" id="L4706">                    clear = Minefield.CLEAR_NUMBER_BA_SWEEPER;</span>
<span class="nc" id="L4707">                    boom = Minefield.CLEAR_NUMBER_BA_SWEEPER_ACCIDENT;</span>
                }
            }

            // need to choose a mine
<span class="nc" id="L4712">            List&lt;Minefield&gt; mfs = clientgui.getClient().getGame()</span>
<span class="nc" id="L4713">                    .getMinefields(ce.getPosition());</span>
<span class="nc" id="L4714">            String[] choices = new String[mfs.size()];</span>
<span class="nc bnc" id="L4715" title="All 2 branches missed.">            for (int loop = 0; loop &lt; choices.length; loop++) {</span>
<span class="nc" id="L4716">                choices[loop] = Minefield.getDisplayableName(mfs.get(loop)</span>
<span class="nc" id="L4717">                        .getType());</span>
            }
<span class="nc" id="L4719">            String input = (String) JOptionPane</span>
<span class="nc" id="L4720">                    .showInputDialog(</span>
                            clientgui,
<span class="nc" id="L4722">                            Messages.getString(&quot;MovementDisplay.ChooseMinefieldDialog.message&quot;),//$NON-NLS-1$</span>
<span class="nc" id="L4723">                            Messages.getString(&quot;MovementDisplay.ChooseMinefieldDialog.title&quot;), //$NON-NLS-1$</span>
                            JOptionPane.QUESTION_MESSAGE, null, choices, null);
<span class="nc" id="L4725">            Minefield mf = null;</span>
<span class="nc bnc" id="L4726" title="All 2 branches missed.">            if (input != null) {</span>
<span class="nc bnc" id="L4727" title="All 2 branches missed.">                for (int loop = 0; loop &lt; choices.length; loop++) {</span>
<span class="nc bnc" id="L4728" title="All 2 branches missed.">                    if (input.equals(choices[loop])) {</span>
<span class="nc" id="L4729">                        mf = mfs.get(loop);</span>
<span class="nc" id="L4730">                        break;</span>
                    }
                }
            }
<span class="nc" id="L4734">            String title = Messages</span>
<span class="nc" id="L4735">                    .getString(&quot;MovementDisplay.ClearMinefieldDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L4736">            String msg = Messages.getString(</span>
                    &quot;MovementDisplay.ClearMinefieldDialog.message&quot;, //$NON-NLS-1$
                    new Object[] {
<span class="nc" id="L4739">                    Integer.valueOf(clear), Integer.valueOf(boom) });</span>
<span class="nc bnc" id="L4740" title="All 4 branches missed.">            if ((null != mf) &amp;&amp; clientgui.doYesNoDialog(title, msg)) {</span>
<span class="nc" id="L4741">                cmd.addStep(MoveStepType.CLEAR_MINEFIELD, mf);</span>
<span class="nc" id="L4742">                ready();</span>
            }
<span class="nc bnc" id="L4744" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_CHARGE.getCmd())) {</span>
<span class="nc bnc" id="L4745" title="All 2 branches missed.">            if (gear != MovementDisplay.GEAR_LAND) {</span>
<span class="nc" id="L4746">                clear();</span>
            }
<span class="nc" id="L4748">            gear = MovementDisplay.GEAR_CHARGE;</span>
<span class="nc" id="L4749">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4750" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DFA.getCmd())) {</span>
<span class="nc bnc" id="L4751" title="All 2 branches missed.">            if (gear != MovementDisplay.GEAR_JUMP) {</span>
<span class="nc" id="L4752">                clear();</span>
            }
<span class="nc" id="L4754">            gear = MovementDisplay.GEAR_DFA;</span>
<span class="nc" id="L4755">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4756" title="All 2 branches missed.">            if (!cmd.isJumping()) {</span>
<span class="nc" id="L4757">                cmd.addStep(MoveStepType.START_JUMP);</span>
            }
<span class="nc bnc" id="L4759" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_RAM.getCmd())) {</span>
<span class="nc bnc" id="L4760" title="All 2 branches missed.">            if (gear != MovementDisplay.GEAR_LAND) {</span>
<span class="nc" id="L4761">                clear();</span>
            }
<span class="nc bnc" id="L4763" title="All 2 branches missed.">            if (ce.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L4764">                gear = MovementDisplay.GEAR_CHARGE;</span>
            } else {
<span class="nc" id="L4766">                gear = MovementDisplay.GEAR_RAM;</span>
            }
<span class="nc" id="L4768">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4769" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_GET_UP.getCmd())) {</span>
            // if the unit has a hull down step
            // then don't clear the moves
<span class="nc bnc" id="L4772" title="All 2 branches missed.">            if (!cmd.contains(MoveStepType.HULL_DOWN)) {</span>
<span class="nc" id="L4773">                clear();</span>
            }

<span class="nc bnc" id="L4776" title="All 2 branches missed.">            if (opts.booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_CAREFUL_STAND)</span>
<span class="nc bnc" id="L4777" title="All 2 branches missed.">                    &amp;&amp; (ce.getWalkMP() &gt; 2)) {</span>
<span class="nc" id="L4778">                ConfirmDialog response = clientgui</span>
<span class="nc" id="L4779">                        .doYesNoBotherDialog(</span>
<span class="nc" id="L4780">                                Messages.getString(&quot;MovementDisplay.CarefulStand.title&quot;),//$NON-NLS-1$</span>
<span class="nc" id="L4781">                                Messages.getString(&quot;MovementDisplay.CarefulStand.message&quot;));</span>
<span class="nc bnc" id="L4782" title="All 2 branches missed.">                if (response.getAnswer()) {</span>
<span class="nc" id="L4783">                    ce.setCarefulStand(true);</span>
<span class="nc bnc" id="L4784" title="All 4 branches missed.">                    if (cmd.getFinalProne() || cmd.getFinalHullDown()) {</span>
<span class="nc" id="L4785">                        cmd.addStep(MoveStepType.CAREFUL_STAND);</span>
                    }
                } else {
<span class="nc bnc" id="L4788" title="All 4 branches missed.">                    if (cmd.getFinalProne() || cmd.getFinalHullDown()) {</span>
<span class="nc" id="L4789">                        cmd.addStep(MoveStepType.GET_UP);</span>
                    }
                }
<span class="nc" id="L4792">            } else {</span>
<span class="nc" id="L4793">                butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L4794" title="All 4 branches missed.">                if (cmd.getFinalProne() || cmd.getFinalHullDown()) {</span>
<span class="nc" id="L4795">                    cmd.addStep(MoveStepType.GET_UP);</span>
                }
            }

<span class="nc" id="L4799">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4800" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_GO_PRONE.getCmd())) {</span>
<span class="nc" id="L4801">            gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc bnc" id="L4802" title="All 2 branches missed.">            if (!cmd.getFinalProne()) {</span>
<span class="nc" id="L4803">                cmd.addStep(MoveStepType.GO_PRONE);</span>
            }
<span class="nc" id="L4805">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L4806">            butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L4807" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_HULL_DOWN.getCmd())) {</span>
<span class="nc" id="L4808">            gear = MovementDisplay.GEAR_LAND;</span>
<span class="nc bnc" id="L4809" title="All 2 branches missed.">            if (!cmd.getFinalHullDown()) {</span>
<span class="nc" id="L4810">                cmd.addStep(MoveStepType.HULL_DOWN);</span>
            }
<span class="nc" id="L4812">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L4813">            butDone.setText(&quot;&lt;html&gt;&lt;b&gt;&quot; + Messages.getString(&quot;MovementDisplay.Move&quot;) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L4814" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_FLEE.getCmd())</span>
<span class="nc bnc" id="L4815" title="All 2 branches missed.">                &amp;&amp; clientgui.doYesNoDialog(Messages</span>
<span class="nc" id="L4816">                        .getString(&quot;MovementDisplay.EscapeDialog.title&quot;),</span>
<span class="nc" id="L4817">                        Messages.getString(&quot;MovementDisplay&quot; + &quot;.EscapeDialog&quot;</span>
                                + &quot;.message&quot;))) {
            //$NON-NLS-1$
            // $NON-NLS-2$
<span class="nc" id="L4821">            clear();</span>
<span class="nc" id="L4822">            cmd.addStep(MoveStepType.FLEE);</span>
<span class="nc" id="L4823">            ready();</span>
<span class="nc bnc" id="L4824" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_FLY_OFF.getCmd())</span>
<span class="nc bnc" id="L4825" title="All 2 branches missed.">                &amp;&amp; clientgui.doYesNoDialog(Messages</span>
<span class="nc" id="L4826">                        .getString(&quot;MovementDisplay.FlyOffDialog.title&quot;),</span>
<span class="nc" id="L4827">                        Messages.getString(&quot;MovementDisplay&quot; + &quot;.FlyOffDialog&quot;</span>
                                + &quot;.message&quot;))) {
            //$NON-NLS-1$
            // $NON-NLS-2$
            // clear();
<span class="nc bnc" id="L4832" title="All 2 branches missed.">            if (opts.booleanOption(OptionsConstants.ADVAERORULES_RETURN_FLYOVER)</span>
                    &amp;&amp; clientgui
<span class="nc bnc" id="L4834" title="All 2 branches missed.">                            .doYesNoDialog(</span>
<span class="nc" id="L4835">                                    Messages.getString(&quot;MovementDisplay.ReturnFly.title&quot;),</span>
<span class="nc" id="L4836">                                    Messages.getString(&quot;MovementDisplay.ReturnFly.message&quot;))) {</span>
<span class="nc" id="L4837">                cmd.addStep(MoveStepType.RETURN);</span>
            } else {
<span class="nc" id="L4839">                cmd.addStep(MoveStepType.OFF);</span>
            }
<span class="nc" id="L4841">            ready();</span>
<span class="nc bnc" id="L4842" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_EJECT.getCmd())) {</span>
<span class="nc bnc" id="L4843" title="All 2 branches missed.">            if (ce instanceof Tank) {</span>
<span class="nc" id="L4844">                if (clientgui</span>
<span class="nc bnc" id="L4845" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L4846">                                Messages.getString(&quot;MovementDisplay.AbandonDialog.title&quot;),</span>
<span class="nc" id="L4847">                                Messages.getString(&quot;MovementDisplay.AbandonDialog.message&quot;))) { //$NON-NLS-1$</span>
                    // $NON-NLS-2$
<span class="nc" id="L4849">                    clear();</span>
<span class="nc" id="L4850">                    cmd.addStep(MoveStepType.EJECT);</span>
<span class="nc" id="L4851">                    ready();</span>
                }
<span class="nc bnc" id="L4853" title="All 2 branches missed.">            } else if (ce.isLargeCraft()) {</span>
<span class="nc" id="L4854">                if (clientgui</span>
<span class="nc bnc" id="L4855" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L4856">                                Messages.getString(&quot;MovementDisplay.AbandonDialog.title&quot;),</span>
<span class="nc" id="L4857">                                Messages.getString(&quot;MovementDisplay.AbandonDialog.message&quot;))) { //$NON-NLS-1$</span>
                    // $NON-NLS-2$
<span class="nc" id="L4859">                    clear();</span>
                    // If we're abandoning while grounded, find a legal position to put an EjectedCrew unit
<span class="nc bnc" id="L4861" title="All 4 branches missed.">                    if (!ce.isSpaceborne() &amp;&amp; ce.getAltitude() == 0) {</span>
<span class="nc" id="L4862">                        Coords pos = getEjectPosition(ce);</span>
<span class="nc" id="L4863">                        cmd.addStep(MoveStepType.EJECT, ce, pos);</span>
<span class="nc" id="L4864">                    } else {</span>
<span class="nc" id="L4865">                        cmd.addStep(MoveStepType.EJECT);</span>
                    }
<span class="nc" id="L4867">                    ready();</span>
                }
<span class="nc" id="L4869">            } else if (clientgui</span>
<span class="nc bnc" id="L4870" title="All 2 branches missed.">                    .doYesNoDialog(</span>
<span class="nc" id="L4871">                            Messages.getString(&quot;MovementDisplay.AbandonDialog1.title&quot;),</span>
<span class="nc" id="L4872">                            Messages.getString(&quot;MovementDisplay.AbandonDialog1.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L4873">                clear();</span>
<span class="nc" id="L4874">                cmd.addStep(MoveStepType.EJECT);</span>
<span class="nc" id="L4875">                ready();</span>
            }
<span class="nc bnc" id="L4877" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LOAD.getCmd())) {</span>
            // Find the other friendly unit in our hex, add it
            // to our local list of loaded units, and then stop.
<span class="nc" id="L4880">            Entity other = getLoadedUnit();</span>
<span class="nc bnc" id="L4881" title="All 2 branches missed.">            if (other != null) {</span>
<span class="nc" id="L4882">                cmd.addStep(MoveStepType.LOAD);</span>
<span class="nc" id="L4883">                clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L4884">                gear = MovementDisplay.GEAR_LAND;</span>
            } // else - didn't find a unit to load
<span class="nc bnc" id="L4886" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TOW.getCmd())) {</span>
            // Find the other friendly unit in our hex, add it
            // to our local list of loaded units, and then stop.
<span class="nc" id="L4889">            Entity other = getTowedUnit();</span>
<span class="nc bnc" id="L4890" title="All 2 branches missed.">            if (other != null) {</span>
<span class="nc" id="L4891">                cmd.addStep(MoveStepType.TOW);</span>
<span class="nc" id="L4892">                clientgui.bv.drawMovementData(ce(), cmd);</span>
            } // else - didn't find a unit to tow
<span class="nc bnc" id="L4894" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DISCONNECT.getCmd())) {</span>
            // Ask the user if we're carrying multiple units.
<span class="nc" id="L4896">            Entity other = getDisconnectedUnit();</span>
<span class="nc bnc" id="L4897" title="All 2 branches missed.">            if (other != null) {</span>
<span class="nc" id="L4898">                cmd.addStep(MoveStepType.DISCONNECT, other);</span>
<span class="nc" id="L4899">                clientgui.bv.drawMovementData(ce(), cmd);</span>
            } // else - didn't find a unit to tow
<span class="nc bnc" id="L4901" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_MOUNT.getCmd())) {</span>
<span class="nc" id="L4902">            Entity other = getMountedUnit();</span>
<span class="nc bnc" id="L4903" title="All 2 branches missed.">            if (other != null) {</span>
<span class="nc" id="L4904">                cmd.addStep(MoveStepType.MOUNT, other);</span>
<span class="nc" id="L4905">                ready();</span>
            }
<span class="nc bnc" id="L4907" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_UNLOAD.getCmd())) {</span>
            // Ask the user if we're carrying multiple units.
<span class="nc" id="L4909">            Entity other = getUnloadedUnit();</span>
<span class="nc bnc" id="L4910" title="All 2 branches missed.">            if (other != null) {</span>
<span class="nc bnc" id="L4911" title="All 2 branches missed.">                if (ce() instanceof SmallCraft </span>
<span class="nc bnc" id="L4912" title="All 2 branches missed.">                        || !ce().getAllTowedUnits().isEmpty()</span>
<span class="nc bnc" id="L4913" title="All 2 branches missed.">                        || ce().getTowedBy() != Entity.NONE) {</span>
<span class="nc" id="L4914">                    Coords pos = getUnloadPosition(other);</span>
<span class="nc bnc" id="L4915" title="All 2 branches missed.">                    if (null != pos) {</span>
                        // set other's position and end this turn - the
                        // unloading unit will get
                        // another turn for further unloading later
<span class="nc" id="L4919">                        cmd.addStep(MoveStepType.UNLOAD, other, pos);</span>
<span class="nc" id="L4920">                        clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L4921">                        ready();</span>
                    }
<span class="nc" id="L4923">                } else {</span>
                    // some different handling for small craft/dropship
                    // unloading
<span class="nc" id="L4926">                    cmd.addStep(MoveStepType.UNLOAD, other);</span>
<span class="nc" id="L4927">                    clientgui.bv.drawMovementData(ce(), cmd);</span>
                }
            } // else - Player canceled the unload.
<span class="nc bnc" id="L4930" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_RAISE_ELEVATION.getCmd())) {</span>
<span class="nc" id="L4931">            cmd.addStep(MoveStepType.UP);</span>
<span class="nc" id="L4932">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4933" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LOWER_ELEVATION.getCmd())) {</span>
<span class="nc bnc" id="L4934" title="All 2 branches missed.">            if (ce.isAero()</span>
<span class="nc bnc" id="L4935" title="All 2 branches missed.">                    &amp;&amp; (null != cmd.getLastStep())</span>
<span class="nc bnc" id="L4936" title="All 2 branches missed.">                    &amp;&amp; (cmd.getLastStep().getNDown() == 1)</span>
<span class="nc bnc" id="L4937" title="All 2 branches missed.">                    &amp;&amp; (cmd.getLastStep().getVelocity() &lt; 12)</span>
<span class="nc bnc" id="L4938" title="All 2 branches missed.">                    &amp;&amp; !(((IAero) ce).isSpheroid() || clientgui.getClient()</span>
<span class="nc bnc" id="L4939" title="All 2 branches missed.">                            .getGame().getPlanetaryConditions().isVacuum())) {</span>
<span class="nc" id="L4940">                cmd.addStep(MoveStepType.ACC, true);</span>
            }
<span class="nc" id="L4942">            cmd.addStep(MoveStepType.DOWN);</span>
<span class="nc" id="L4943">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4944" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_CLIMB_MODE.getCmd())) {</span>
<span class="nc" id="L4945">            MoveStep ms = cmd.getLastStep();</span>
<span class="nc bnc" id="L4946" title="All 2 branches missed.">            if ((ms != null)</span>
<span class="nc bnc" id="L4947" title="All 2 branches missed.">                    &amp;&amp; ((ms.getType() == MoveStepType.CLIMB_MODE_ON) || (ms</span>
<span class="nc bnc" id="L4948" title="All 2 branches missed.">                            .getType() == MoveStepType.CLIMB_MODE_OFF))) {</span>
<span class="nc" id="L4949">                MoveStep lastStep = cmd.getLastStep();</span>
<span class="nc" id="L4950">                cmd.removeLastStep();</span>
                // Add another climb mode step
                // Without this, we end up with 3 effect modes: no climb step, climb step on, climb step off
                // This affects how the StepSprite gets rendered, so it's more clear to keep a climb step
                // once one has been added
<span class="nc bnc" id="L4955" title="All 2 branches missed.">                if (lastStep.getType() == MoveStepType.CLIMB_MODE_ON) {</span>
<span class="nc" id="L4956">                    cmd.addStep(MoveStepType.CLIMB_MODE_OFF);</span>
                } else {
<span class="nc" id="L4958">                    cmd.addStep(MoveStepType.CLIMB_MODE_ON);</span>
                }
<span class="nc bnc" id="L4960" title="All 2 branches missed.">            } else if (cmd.getFinalClimbMode()) {</span>
<span class="nc" id="L4961">                cmd.addStep(MoveStepType.CLIMB_MODE_OFF);</span>
            } else {
<span class="nc" id="L4963">                cmd.addStep(MoveStepType.CLIMB_MODE_ON);</span>
            }
<span class="nc" id="L4965">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc" id="L4966">            computeMovementEnvelope(ce);</span>
<span class="nc bnc" id="L4967" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LAY_MINE.getCmd())) {</span>
<span class="nc" id="L4968">            int i = chooseMineToLay();</span>
<span class="nc bnc" id="L4969" title="All 2 branches missed.">            if (i != -1) {</span>
<span class="nc" id="L4970">                Mounted m = ce.getEquipment(i);</span>
<span class="nc bnc" id="L4971" title="All 2 branches missed.">                if (m.getMineType() == Mounted.MINE_VIBRABOMB) {</span>
<span class="nc" id="L4972">                    VibrabombSettingDialog vsd = new VibrabombSettingDialog(</span>
                            clientgui.frame);
<span class="nc" id="L4974">                    vsd.setVisible(true);</span>
<span class="nc" id="L4975">                    m.setVibraSetting(vsd.getSetting());</span>
                }
<span class="nc bnc" id="L4977" title="All 4 branches missed.">                if (cmd.getLastStep() == null</span>
                        &amp;&amp; ce instanceof BattleArmor
<span class="nc bnc" id="L4979" title="All 2 branches missed.">                        &amp;&amp; ce.getMovementMode().equals(EntityMovementMode.INF_JUMP)) {</span>
<span class="nc" id="L4980">                    cmd.addStep(MoveStepType.START_JUMP);</span>
<span class="nc" id="L4981">                    gear = GEAR_JUMP;</span>
<span class="nc" id="L4982">                    Color jumpColor = GUIPreferences.getInstance().getColor(</span>
                            GUIPreferences.ADVANCED_MOVE_JUMP_COLOR);
<span class="nc" id="L4984">                    clientgui.getBoardView().setHighlightColor(jumpColor);</span>
<span class="nc" id="L4985">                    computeMovementEnvelope(ce);</span>
                }
<span class="nc" id="L4987">                cmd.addStep(MoveStepType.LAY_MINE, i);</span>
<span class="nc" id="L4988">                clientgui.bv.drawMovementData(ce, cmd);</span>
            }
<span class="nc bnc" id="L4990" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_CALL_SUPPORT.getCmd())) {</span>
<span class="nc" id="L4991">            ((Infantry) ce).createLocalSupport();</span>
<span class="nc" id="L4992">            clientgui.getClient().sendUpdateEntity(ce());</span>
<span class="nc bnc" id="L4993" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DIG_IN.getCmd())) {</span>
<span class="nc" id="L4994">            cmd.addStep(MoveStepType.DIG_IN);</span>
<span class="nc" id="L4995">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4996" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_FORTIFY.getCmd())) {</span>
<span class="nc" id="L4997">            cmd.addStep(MoveStepType.FORTIFY);</span>
<span class="nc" id="L4998">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L4999" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TAKE_COVER.getCmd())) {</span>
<span class="nc" id="L5000">            cmd.addStep(MoveStepType.TAKE_COVER);</span>
<span class="nc" id="L5001">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L5002" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_SHAKE_OFF.getCmd())) {</span>
<span class="nc" id="L5003">            cmd.addStep(MoveStepType.SHAKE_OFF_SWARMERS);</span>
<span class="nc" id="L5004">            clientgui.bv.drawMovementData(ce(), cmd);</span>
<span class="nc bnc" id="L5005" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_RECKLESS.getCmd())) {</span>
<span class="nc" id="L5006">            cmd.setCareful(false);</span>
<span class="nc bnc" id="L5007" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_STRAFE.getCmd())) {</span>
<span class="nc" id="L5008">            gear = GEAR_STRAFE;</span>
<span class="nc bnc" id="L5009" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_BOMB.getCmd())) {</span>
<span class="nc bnc" id="L5010" title="All 2 branches missed.">            if (cmd.getLastStep() == null) {</span>
<span class="nc" id="L5011">                cmd.addStep(MoveStepType.NONE);</span>
            }
<span class="nc" id="L5013">            cmd.setVTOLBombStep(cmd.getFinalCoords());</span>
<span class="nc" id="L5014">            cmd.compile(clientgui.getClient().getGame(), ce, false);</span>
<span class="nc" id="L5015">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5016" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_ACCN.getCmd())) {</span>
<span class="nc" id="L5017">            cmd.addStep(MoveStepType.ACCN);</span>
<span class="nc" id="L5018">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5019" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DECN.getCmd())) {</span>
<span class="nc" id="L5020">            cmd.addStep(MoveStepType.DECN);</span>
<span class="nc" id="L5021">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5022" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_ACC.getCmd())) {</span>
<span class="nc" id="L5023">            cmd.addStep(MoveStepType.ACC);</span>
<span class="nc" id="L5024">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5025" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DEC.getCmd())) {</span>
<span class="nc" id="L5026">            cmd.addStep(MoveStepType.DEC);</span>
<span class="nc" id="L5027">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5028" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_EVADE.getCmd())) {</span>
<span class="nc" id="L5029">            cmd.addStep(MoveStepType.EVADE);</span>
<span class="nc" id="L5030">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5031" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_BOOTLEGGER.getCmd())) {</span>
<span class="nc" id="L5032">            cmd.addStep(MoveStepType.BOOTLEGGER);</span>
<span class="nc" id="L5033">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5034" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_SHUTDOWN.getCmd())) {</span>
<span class="nc" id="L5035">            if (clientgui</span>
<span class="nc bnc" id="L5036" title="All 2 branches missed.">                    .doYesNoDialog(</span>
<span class="nc" id="L5037">                            Messages.getString(&quot;MovementDisplay.ShutdownDialog.title&quot;),</span>
<span class="nc" id="L5038">                            Messages.getString(&quot;MovementDisplay.ShutdownDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L5039">                cmd.addStep(MoveStepType.SHUTDOWN);</span>
<span class="nc" id="L5040">                ready();</span>
            }
<span class="nc bnc" id="L5042" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_STARTUP.getCmd())) {</span>
<span class="nc" id="L5043">            if (clientgui</span>
<span class="nc bnc" id="L5044" title="All 2 branches missed.">                    .doYesNoDialog(</span>
<span class="nc" id="L5045">                            Messages.getString(&quot;MovementDisplay.StartupDialog.title&quot;),</span>
<span class="nc" id="L5046">                            Messages.getString(&quot;MovementDisplay.StartupDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L5047">                clear();</span>
<span class="nc" id="L5048">                cmd.addStep(MoveStepType.STARTUP);</span>
<span class="nc" id="L5049">                ready();</span>
            }
<span class="nc bnc" id="L5051" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_SELF_DESTRUCT.getCmd())) {</span>
<span class="nc" id="L5052">            if (clientgui</span>
<span class="nc bnc" id="L5053" title="All 2 branches missed.">                    .doYesNoDialog(</span>
<span class="nc" id="L5054">                            Messages.getString(&quot;MovementDisplay.SelfDestructDialog.title&quot;),</span>
<span class="nc" id="L5055">                            Messages.getString(&quot;MovementDisplay.SelfDestructDialog.message&quot;))) { //$NON-NLS-1$</span>
                // $NON-NLS-2$
<span class="nc" id="L5057">                cmd.addStep(MoveStepType.SELF_DESTRUCT);</span>
<span class="nc" id="L5058">                ready();</span>
            }
<span class="nc bnc" id="L5060" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_EVADE_AERO.getCmd())) {</span>
<span class="nc" id="L5061">            cmd.addStep(MoveStepType.EVADE);</span>
<span class="nc" id="L5062">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc" id="L5063">            setEvadeAeroEnabled(false);</span>
<span class="nc bnc" id="L5064" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_ROLL.getCmd())) {</span>
<span class="nc" id="L5065">            cmd.addStep(MoveStepType.ROLL);</span>
<span class="nc" id="L5066">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5067" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_HOVER.getCmd())) {</span>
<span class="nc" id="L5068">            cmd.addStep(MoveStepType.HOVER);</span>
<span class="nc bnc" id="L5069" title="All 2 branches missed.">            if (ce instanceof LandAirMech</span>
<span class="nc bnc" id="L5070" title="All 2 branches missed.">                    &amp;&amp; ce.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L5071" title="All 2 branches missed.">                    &amp;&amp; ce.isAirborne()) {</span>
<span class="nc" id="L5072">                gear = GEAR_LAND;</span>
            }
<span class="nc" id="L5074">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5075" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_MANEUVER.getCmd())) {</span>
<span class="nc" id="L5076">            ManeuverChoiceDialog choiceDialog = new ManeuverChoiceDialog(</span>
                    clientgui.frame,
<span class="nc" id="L5078">                    Messages.getString(&quot;MovementDisplay.ManeuverDialog.title&quot;), //$NON-NLS-1$</span>
                    &quot;huh?&quot;);
<span class="nc" id="L5080">            IAero a = (IAero) ce;</span>
<span class="nc" id="L5081">            MoveStep last = cmd.getLastStep();</span>
<span class="nc" id="L5082">            int vel = a.getCurrentVelocity();</span>
<span class="nc" id="L5083">            int altitude = ce.getAltitude();</span>
<span class="nc" id="L5084">            Coords pos = ce.getPosition();</span>
<span class="nc" id="L5085">            int distance = 0;</span>
<span class="nc bnc" id="L5086" title="All 2 branches missed.">            if (null != last) {</span>
<span class="nc" id="L5087">                vel = last.getVelocityLeft();</span>
<span class="nc" id="L5088">                altitude = last.getAltitude();</span>
<span class="nc" id="L5089">                pos = last.getPosition();</span>
<span class="nc" id="L5090">                distance = last.getDistance();</span>
            }
<span class="nc" id="L5092">            IBoard board = clientgui.getClient().getGame().getBoard();</span>
            // On Atmospheric maps, elevations are treated as altitudes, so
            // hex ceiling is the ground
<span class="nc" id="L5095">            int ceil = board.getHex(pos).ceiling(board.inAtmosphere());</span>
            // On the ground map, Aeros ignore hex elevations
<span class="nc bnc" id="L5097" title="All 2 branches missed.">            if (board.onGround()) {</span>
<span class="nc" id="L5098">                ceil = 0;</span>
            }
<span class="nc" id="L5100">            choiceDialog.checkPerformability(vel, altitude, ceil, a.isVSTOL(),</span>
<span class="nc" id="L5101">                    distance, clientgui.getClient().getGame(), cmd);</span>
<span class="nc" id="L5102">            choiceDialog.setVisible(true);</span>
<span class="nc" id="L5103">            int manType = choiceDialog.getChoice();</span>
<span class="nc bnc" id="L5104" title="All 4 branches missed.">            if ((manType &gt; ManeuverType.MAN_NONE) &amp;&amp; addManeuver(manType)) {</span>
<span class="nc" id="L5105">                clientgui.bv.drawMovementData(ce, cmd);</span>
            }
<span class="nc bnc" id="L5107" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LAUNCH.getCmd())) {</span>
<span class="nc" id="L5108">            TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; undocked = getUndockedUnits();</span>
<span class="nc bnc" id="L5109" title="All 2 branches missed.">            if (!undocked.isEmpty()) {</span>
<span class="nc" id="L5110">                cmd.addStep(MoveStepType.UNDOCK, undocked);</span>
            }
<span class="nc" id="L5112">            TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = getLaunchedUnits();</span>
<span class="nc bnc" id="L5113" title="All 2 branches missed.">            if (!launched.isEmpty()) {</span>
<span class="nc" id="L5114">                cmd.addStep(MoveStepType.LAUNCH, launched);</span>
            }
<span class="nc bnc" id="L5116" title="All 4 branches missed.">            if (!launched.isEmpty() || !undocked.isEmpty()) {</span>
<span class="nc" id="L5117">                clientgui.bv.drawMovementData(ce, cmd);</span>
            }
<span class="nc bnc" id="L5119" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_RECOVER.getCmd())</span>
<span class="nc bnc" id="L5120" title="All 2 branches missed.">                || actionCmd.equals(MoveCommand.MOVE_DOCK.getCmd())) {</span>
            // if more than one unit is available as a carrier
            // then bring up an option dialog
<span class="nc" id="L5123">            int recoverer = getRecoveryUnit();</span>
<span class="nc bnc" id="L5124" title="All 2 branches missed.">            if (recoverer != -1) {</span>
<span class="nc" id="L5125">                cmd.addStep(MoveStepType.RECOVER, recoverer, -1);</span>
<span class="nc" id="L5126">                clientgui.bv.drawMovementData(ce, cmd);</span>
            }
<span class="nc bnc" id="L5128" title="All 2 branches missed.">            if (actionCmd.equals(MoveCommand.MOVE_DOCK.getCmd())) {</span>
<span class="nc" id="L5129">                cmd.getLastStep().setDocking(true);</span>
            }
<span class="nc bnc" id="L5131" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DROP.getCmd())) {</span>
<span class="nc" id="L5132">            TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; dropped = getDroppedUnits();</span>
<span class="nc bnc" id="L5133" title="All 2 branches missed.">            if (!dropped.isEmpty()) {</span>
<span class="nc" id="L5134">                cmd.addStep(MoveStepType.DROP, dropped);</span>
<span class="nc" id="L5135">                clientgui.bv.drawMovementData(ce, cmd);</span>
            }
<span class="nc bnc" id="L5137" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_JOIN.getCmd())) {</span>
            // if more than one unit is available as a carrier
            // then bring up an option dialog
<span class="nc" id="L5140">            int joined = getUnitJoined();</span>
<span class="nc bnc" id="L5141" title="All 2 branches missed.">            if (joined != -1) {</span>
<span class="nc" id="L5142">                cmd.addStep(MoveStepType.JOIN, joined, -1);</span>
<span class="nc" id="L5143">                clientgui.bv.drawMovementData(ce, cmd);</span>
            }
<span class="nc bnc" id="L5145" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TURN_LEFT.getCmd())) {</span>
<span class="nc" id="L5146">            cmd.addStep(MoveStepType.TURN_LEFT);</span>
<span class="nc" id="L5147">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5148" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TURN_RIGHT.getCmd())) {</span>
<span class="nc" id="L5149">            cmd.addStep(MoveStepType.TURN_RIGHT);</span>
<span class="nc" id="L5150">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5151" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_THRUST.getCmd())) {</span>
<span class="nc" id="L5152">            cmd.addStep(MoveStepType.THRUST);</span>
<span class="nc" id="L5153">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5154" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_YAW.getCmd())) {</span>
<span class="nc" id="L5155">            cmd.addStep(MoveStepType.YAW);</span>
<span class="nc" id="L5156">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5157" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_END_OVER.getCmd())) {</span>
<span class="nc" id="L5158">            cmd.addStep(MoveStepType.YAW);</span>
<span class="nc" id="L5159">            cmd.addStep(MoveStepType.ROLL);</span>
<span class="nc" id="L5160">            clientgui.bv.drawMovementData(ce, cmd);</span>
<span class="nc bnc" id="L5161" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_DUMP.getCmd())) {</span>
<span class="nc" id="L5162">            dumpBombs();</span>
<span class="nc bnc" id="L5163" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TAKE_OFF.getCmd())) {</span>
<span class="nc bnc" id="L5164" title="All 2 branches missed.">            if (ce().isAero()</span>
<span class="nc bnc" id="L5165" title="All 2 branches missed.">                    &amp;&amp; (null != ((IAero) ce()).hasRoomForHorizontalTakeOff())) {</span>
<span class="nc" id="L5166">                String title = Messages</span>
<span class="nc" id="L5167">                        .getString(&quot;MovementDisplay.NoTakeOffDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L5168">                String body = Messages.getString(</span>
                        &quot;MovementDisplay.NoTakeOffDialog.message&quot;,
<span class="nc" id="L5170">                        new Object[] { ((IAero) ce())</span>
<span class="nc" id="L5171">                                .hasRoomForHorizontalTakeOff() }); //$NON-NLS-1$</span>
<span class="nc" id="L5172">                clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L5173">            } else {</span>
<span class="nc" id="L5174">                if (clientgui</span>
<span class="nc bnc" id="L5175" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L5176">                                Messages.getString(&quot;MovementDisplay.TakeOffDialog.title&quot;),</span>
<span class="nc" id="L5177">                                Messages.getString(&quot;MovementDisplay.TakeOffDialog.message&quot;))) { //$NON-NLS-1$</span>
                    // $NON-NLS-2$
<span class="nc" id="L5179">                    clear();</span>
<span class="nc" id="L5180">                    cmd.addStep(MoveStepType.TAKEOFF);</span>
<span class="nc" id="L5181">                    ready();</span>
                }
            }
<span class="nc bnc" id="L5184" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_VERT_TAKE_OFF.getCmd())) {</span>
<span class="nc" id="L5185">            if (clientgui</span>
<span class="nc bnc" id="L5186" title="All 2 branches missed.">                    .doYesNoDialog(</span>
<span class="nc" id="L5187">                            Messages.getString(&quot;MovementDisplay.TakeOffDialog.title&quot;),</span>
<span class="nc" id="L5188">                            Messages.getString(&quot;MovementDisplay.TakeOffDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L5189">                clear();</span>
<span class="nc" id="L5190">                cmd.addStep(MoveStepType.VTAKEOFF);</span>
<span class="nc" id="L5191">                ready();</span>
            }
<span class="nc bnc" id="L5193" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_LAND.getCmd())) {</span>
<span class="nc bnc" id="L5194" title="All 2 branches missed.">            if (ce().isAero()</span>
<span class="nc bnc" id="L5195" title="All 2 branches missed.">                    &amp;&amp; (null != ((IAero) ce()).hasRoomForHorizontalLanding())) {</span>
<span class="nc" id="L5196">                String title = Messages</span>
<span class="nc" id="L5197">                        .getString(&quot;MovementDisplay.NoLandingDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L5198">                String body = Messages.getString(</span>
                        &quot;MovementDisplay.NoLandingDialog.message&quot;,
<span class="nc" id="L5200">                        new Object[] { ((IAero) ce())</span>
<span class="nc" id="L5201">                                .hasRoomForHorizontalLanding() }); //$NON-NLS-1$</span>
<span class="nc" id="L5202">                clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L5203">            } else {</span>
<span class="nc" id="L5204">                if (clientgui</span>
<span class="nc bnc" id="L5205" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L5206">                                Messages.getString(&quot;MovementDisplay.LandDialog.title&quot;),</span>
<span class="nc" id="L5207">                                Messages.getString(&quot;MovementDisplay.LandDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L5208">                    clear();</span>
<span class="nc" id="L5209">                    cmd.addStep(MoveStepType.LAND);</span>
<span class="nc" id="L5210">                    ready();</span>
                }
            }
<span class="nc bnc" id="L5213" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_VERT_LAND.getCmd())) {</span>
<span class="nc bnc" id="L5214" title="All 2 branches missed.">            if (ce().isAero()</span>
<span class="nc bnc" id="L5215" title="All 2 branches missed.">                    &amp;&amp; (null != ((IAero) ce()).hasRoomForVerticalLanding())) {</span>
<span class="nc" id="L5216">                String title = Messages</span>
<span class="nc" id="L5217">                        .getString(&quot;MovementDisplay.NoLandingDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L5218">                String body = Messages.getString(</span>
                        &quot;MovementDisplay.NoLandingDialog.message&quot;,
<span class="nc" id="L5220">                        new Object[] { ((IAero) ce())</span>
<span class="nc" id="L5221">                                .hasRoomForVerticalLanding() }); //$NON-NLS-1$</span>
<span class="nc" id="L5222">                clientgui.doAlertDialog(title, body);</span>
<span class="nc" id="L5223">            } else {</span>
<span class="nc" id="L5224">                if (clientgui</span>
<span class="nc bnc" id="L5225" title="All 2 branches missed.">                        .doYesNoDialog(</span>
<span class="nc" id="L5226">                                Messages.getString(&quot;MovementDisplay.LandDialog.title&quot;),</span>
<span class="nc" id="L5227">                                Messages.getString(&quot;MovementDisplay.LandDialog.message&quot;))) { //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L5228">                    clear();</span>
<span class="nc" id="L5229">                    cmd.addStep(MoveStepType.VLAND);</span>
<span class="nc" id="L5230">                    ready();</span>
                }
            }
<span class="nc bnc" id="L5233" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_ENVELOPE.getCmd())) {</span>
<span class="nc" id="L5234">            computeMovementEnvelope(clientgui.mechD.getCurrentEntity());</span>
<span class="nc bnc" id="L5235" title="All 2 branches missed.">        } else if (actionCmd.equals(MoveCommand.MOVE_TRAITOR.getCmd())) {</span>
            // Set up variables we need
            // We use a vector instead of enumeration here so we can grab the
            // size
<span class="nc" id="L5239">            Vector&lt;IPlayer&gt; players = clientgui.getClient().getGame()</span>
<span class="nc" id="L5240">                    .getPlayersVector();</span>
<span class="nc" id="L5241">            Integer[] playerIds = new Integer[players.size() - 1];</span>
<span class="nc" id="L5242">            String[] playerNames = new String[players.size() - 1];</span>
<span class="nc" id="L5243">            String[] options = new String[players.size() - 1];</span>
<span class="nc" id="L5244">            Entity e = ce();</span>

            // Loop through the players vector and fill in the arrays
<span class="nc" id="L5247">            int idx = 0;</span>
<span class="nc bnc" id="L5248" title="All 2 branches missed.">            for (int i = 0; i &lt; players.size(); i++) {</span>
<span class="nc" id="L5249">                IPlayer p = players.get(i);</span>
                // If this is us, we skip it since we can't transfer to
                // ourselves
<span class="nc bnc" id="L5252" title="All 2 branches missed.">                if (p.getName().equals(</span>
<span class="nc" id="L5253">                        clientgui.getClient().getLocalPlayer().getName())) {</span>
<span class="nc" id="L5254">                    continue;</span>
                }
<span class="nc" id="L5256">                playerIds[idx] = p.getId();</span>
<span class="nc" id="L5257">                playerNames[idx] = p.getName();</span>
<span class="nc" id="L5258">                options[idx] = p.getName() + &quot; (ID: &quot; + p.getId() + &quot;)&quot;;</span>
<span class="nc" id="L5259">                idx++;</span>
            }

            // Dialog for choosing which player to transfer to
<span class="nc" id="L5263">            String option = (String) JOptionPane</span>
<span class="nc" id="L5264">                    .showInputDialog(</span>
<span class="nc" id="L5265">                            clientgui.getFrame(),</span>
                            &quot;Choose the player to gain ownership of this unit when it turns traitor&quot;,
                            &quot;Traitor&quot;, JOptionPane.QUESTION_MESSAGE, null,
                            options, options[0]);

            // Verify that we have a valid option...
<span class="nc bnc" id="L5271" title="All 2 branches missed.">            if (option != null) {</span>
                // Now that we've selected a player, correctly associate the ID
                // and name
<span class="nc" id="L5274">                int id = playerIds[Arrays.asList(options).indexOf(option)];</span>
<span class="nc" id="L5275">                String name = playerNames[Arrays.asList(options)</span>
<span class="nc" id="L5276">                        .indexOf(option)];</span>

                // And now we perform the actual transfer
<span class="nc" id="L5279">                int confirm = JOptionPane</span>
<span class="nc" id="L5280">                        .showConfirmDialog(</span>
<span class="nc" id="L5281">                                clientgui.getFrame(),</span>
<span class="nc" id="L5282">                                e.getDisplayName()</span>
                                        + &quot; will switch to &quot;
                                        + name
                                        + &quot;'s side at the end of this turn. Are you &quot;
                                        + &quot;sure?&quot;, &quot;Confirm&quot;,
                                JOptionPane.YES_NO_OPTION);
                /*
                 * JOptionPane.showMessageDialog( clientgui.getFrame(),
                 * e.getDisplayName() + &quot; will switch to &quot; + name +
                 * &quot;'s side at the end of this turn.&quot;, &quot;ERROR: Can't Switch&quot;,
                 * JOptionPane.INFORMATION_MESSAGE);
                 */
<span class="nc bnc" id="L5294" title="All 2 branches missed.">                if (confirm == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L5295">                    e.setTraitorId(id);</span>
<span class="nc" id="L5296">                    clientgui.getClient().sendUpdateEntity(e);</span>
                }
            }
        }
<span class="nc" id="L5300">        updateProneButtons();</span>
<span class="nc" id="L5301">        updateRACButton();</span>
<span class="nc" id="L5302">        updateSearchlightButton();</span>
<span class="nc" id="L5303">        updateElevationButtons();</span>
<span class="nc" id="L5304">        updateTakeOffButtons();</span>
<span class="nc" id="L5305">        updateLandButtons();</span>
<span class="nc" id="L5306">        updateFlyOffButton();</span>
<span class="nc" id="L5307">        updateLaunchButton();</span>
<span class="nc" id="L5308">        updateLoadButtons();</span>
<span class="nc" id="L5309">        updateDropButton();</span>
<span class="nc" id="L5310">        updateConvertModeButton();</span>
<span class="nc" id="L5311">        updateRecklessButton();</span>
<span class="nc" id="L5312">        updateHoverButton();</span>
<span class="nc" id="L5313">        updateManeuverButton();</span>
<span class="nc" id="L5314">        updateDumpButton();</span>
<span class="nc" id="L5315">        updateEvadeButton();</span>
<span class="nc" id="L5316">        updateBootleggerButton();</span>
<span class="nc" id="L5317">        updateShutdownButton();</span>
<span class="nc" id="L5318">        updateStartupButton();</span>
<span class="nc" id="L5319">        updateSelfDestructButton();</span>
<span class="nc" id="L5320">        updateTraitorButton();</span>
<span class="nc" id="L5321">        updateSpeedButtons();</span>
<span class="nc" id="L5322">        updateThrustButton();</span>
<span class="nc" id="L5323">        updateRollButton();</span>
<span class="nc" id="L5324">        updateTakeCoverButton();</span>
<span class="nc" id="L5325">        updateLayMineButton();</span>
<span class="nc" id="L5326">        checkFuel();</span>
<span class="nc" id="L5327">        checkOOC();</span>
<span class="nc" id="L5328">        checkAtmosphere();</span>

        // if small craft/dropship that has unloaded units, then only allowed
        // to unload more
<span class="nc bnc" id="L5332" title="All 2 branches missed.">        if (ce.hasUnloadedUnitsFromBays()) {</span>
<span class="nc" id="L5333">            disableButtons();</span>
<span class="nc" id="L5334">            updateLoadButtons();</span>
<span class="nc" id="L5335">            butDone.setEnabled(true);</span>
        }

<span class="nc" id="L5338">    }</span>
    
    /**
     * Add enough &lt;code&gt;MoveStepType.CONVERT_MODE&lt;/code&gt; steps to get to the requested mode, or
     * clear the path if the unit is in the requested mode at the beginning of the turn.
     * 
     * @param endMode The mode to convert to
     */
    private void adjustConvertSteps(EntityMovementMode endMode) {
        //Since conversion is not allowed in water, we shouldn't have to deal with the possibility of swim modes.
<span class="nc bnc" id="L5348" title="All 2 branches missed.">        if (ce().getMovementMode() == endMode</span>
                // Account for grounded LAMs in fighter mode with movement type wheeled 
<span class="nc bnc" id="L5350" title="All 4 branches missed.">                || (ce().isAero() &amp;&amp; endMode == EntityMovementMode.AERODYNE)) {</span>
<span class="nc" id="L5351">            cmd.clear();</span>
<span class="nc" id="L5352">            return;</span>
        }
<span class="nc bnc" id="L5354" title="All 2 branches missed.">        if (cmd.getFinalConversionMode() == endMode) {</span>
<span class="nc" id="L5355">            return;</span>
        }
<span class="nc" id="L5357">        clear();</span>
<span class="nc" id="L5358">        ce().setConvertingNow(true);</span>
<span class="nc" id="L5359">        cmd.addStep(MoveStepType.CONVERT_MODE);</span>
<span class="nc bnc" id="L5360" title="All 2 branches missed.">        if (cmd.getFinalConversionMode() != endMode) {</span>
<span class="nc" id="L5361">            cmd.addStep(MoveStepType.CONVERT_MODE);</span>
        }
<span class="nc bnc" id="L5363" title="All 4 branches missed.">        if (ce() instanceof Mech &amp;&amp; ((Mech)ce()).hasTracks()) {</span>
<span class="nc" id="L5364">            ce().setMovementMode(endMode);</span>
        }
<span class="nc" id="L5366">    }</span>

    /**
     * Give the player the opportunity to unload all entities that are stranded
     * on immobile transports.
     * &lt;p/&gt;
     * According to &lt;a href= &quot;http://www.classicbattletech.com/w3t/showflat
     * .php?Cat=&amp;Board=ask&amp;Number=555466&amp;page=2&amp;view=collapsed&amp;sb=5&amp;o=0&amp;fpart=&quot;
     * &gt; Randall Bills&lt;/a&gt;, the &quot;minimum move&quot; rule allow stranded units to
     * dismount at the start of the turn.
     */
    private void unloadStranded() {
<span class="nc" id="L5378">        Vector&lt;Entity&gt; stranded = new Vector&lt;Entity&gt;();</span>
<span class="nc" id="L5379">        String[] names = null;</span>
<span class="nc" id="L5380">        Entity entity = null;</span>
<span class="nc" id="L5381">        Entity transport = null;</span>

        // Let the player know what's going on.
<span class="nc" id="L5384">        setStatusBarText(Messages.getString(&quot;MovementDisplay.AllPlayersUnload&quot;)); //$NON-NLS-1$</span>

        // Collect the stranded entities into the vector.
<span class="nc" id="L5387">        Iterator&lt;Entity&gt; entities = clientgui.getClient().getSelectedEntities(</span>
<span class="nc" id="L5388">                new EntitySelector() {</span>
<span class="nc" id="L5389">                    private final IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L5390">                    private final GameTurn turn = clientgui.getClient()</span>
<span class="nc" id="L5391">                            .getGame().getTurn();</span>
<span class="nc" id="L5392">                    private final int ownerId = clientgui.getClient()</span>
<span class="nc" id="L5393">                            .getLocalPlayer().getId();</span>

                    public boolean accept(Entity acc) {
<span class="nc bnc" id="L5396" title="All 2 branches missed.">                        if (turn.isValid(ownerId, acc, game)) {</span>
<span class="nc" id="L5397">                            return true;</span>
                        }
<span class="nc" id="L5399">                        return false;</span>
                    }
                });
<span class="nc bnc" id="L5402" title="All 2 branches missed.">        while (entities.hasNext()) {</span>
<span class="nc" id="L5403">            stranded.addElement(entities.next());</span>
        }

        // Construct an array of stranded entity names
<span class="nc" id="L5407">        names = new String[stranded.size()];</span>
<span class="nc bnc" id="L5408" title="All 2 branches missed.">        for (int index = 0; index &lt; names.length; index++) {</span>
<span class="nc" id="L5409">            entity = stranded.elementAt(index);</span>
<span class="nc" id="L5410">            transport = clientgui.getClient()</span>
<span class="nc" id="L5411">                                 .getEntity(entity.getTransportId());</span>
            String buffer;
<span class="nc bnc" id="L5413" title="All 2 branches missed.">            if (null == transport) {</span>
<span class="nc" id="L5414">                buffer = entity.getDisplayName();</span>
            } else {
<span class="nc" id="L5416">                buffer = Messages.getString(&quot;MovementDisplay.EntityAt&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L5417">                        new Object[] { entity.getDisplayName(),</span>
<span class="nc" id="L5418">                                transport.getPosition().getBoardNum() });</span>
            }
<span class="nc" id="L5420">            names[index] = buffer.toString();</span>
        }

        // Show the choices to the player
<span class="nc" id="L5424">        int[] indexes = clientgui</span>
<span class="nc" id="L5425">                .doChoiceDialog(</span>
<span class="nc" id="L5426">                        Messages.getString(&quot;MovementDisplay.UnloadStrandedUnitsDialog.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L5427">                        Messages.getString(&quot;MovementDisplay.UnloadStrandedUnitsDialog.message&quot;), //$NON-NLS-1$</span>
                        names);

        // Convert the indexes into selected entity IDs and tell the server.
<span class="nc" id="L5431">        int[] ids = null;</span>
<span class="nc bnc" id="L5432" title="All 2 branches missed.">        if (null != indexes) {</span>
<span class="nc" id="L5433">            ids = new int[indexes.length];</span>
<span class="nc bnc" id="L5434" title="All 2 branches missed.">            for (int index = 0; index &lt; indexes.length; index++) {</span>
<span class="nc" id="L5435">                entity = stranded.elementAt(index);</span>
<span class="nc" id="L5436">                ids[index] = entity.getId();</span>
            }
        }
<span class="nc" id="L5439">        clientgui.getClient().sendUnloadStranded(ids);</span>
<span class="nc" id="L5440">    }</span>

    // board view listener
    @Override
    public void finishedMovingUnits(BoardViewEvent b) {
<span class="nc" id="L5445">        final Entity ce = ce();</span>

        // Are we ignoring events?
<span class="nc bnc" id="L5448" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L5449">            return;</span>
        }
<span class="nc bnc" id="L5451" title="All 4 branches missed.">        if (clientgui.getClient().isMyTurn() &amp;&amp; (ce != null)) {</span>
<span class="nc" id="L5452">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L5453">            clientgui.bv.centerOnHex(ce.getPosition());</span>
        }
<span class="nc" id="L5455">    }</span>

    @Override
    public void unitSelected(BoardViewEvent b) {
        // Are we ignoring events?
<span class="nc bnc" id="L5460" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L5461">            return;</span>
        }
<span class="nc" id="L5463">        Entity e = clientgui.getClient().getGame().getEntity(b.getEntityId());</span>
<span class="nc bnc" id="L5464" title="All 2 branches missed.">        if (null == e) {</span>
<span class="nc" id="L5465">            return;</span>
        }
<span class="nc bnc" id="L5467" title="All 2 branches missed.">        if (clientgui.getClient().isMyTurn()) {</span>
<span class="nc" id="L5468">            if (clientgui.getClient().getGame().getTurn()</span>
<span class="nc bnc" id="L5469" title="All 2 branches missed.">                         .isValidEntity(e, clientgui.getClient().getGame())) {</span>
<span class="nc" id="L5470">                selectEntity(e.getId());</span>
            }
        } else {
<span class="nc" id="L5473">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L5474">            clientgui.mechD.displayEntity(e);</span>
<span class="nc bnc" id="L5475" title="All 2 branches missed.">            if (e.isDeployed()) {</span>
<span class="nc" id="L5476">                clientgui.bv.centerOnHex(e.getPosition());</span>
            }
        }
<span class="nc" id="L5479">    }</span>

    private void setWalkEnabled(boolean enabled) {
<span class="nc" id="L5482">        buttons.get(MoveCommand.MOVE_WALK).setEnabled(enabled);</span>
<span class="nc" id="L5483">        clientgui.getMenuBar().setMoveWalkEnabled(enabled);</span>
<span class="nc" id="L5484">    }</span>

    private void setTurnEnabled(boolean enabled) {
<span class="nc" id="L5487">        buttons.get(MoveCommand.MOVE_TURN).setEnabled(enabled);</span>
<span class="nc" id="L5488">        clientgui.getMenuBar().setMoveTurnEnabled(enabled);</span>
<span class="nc" id="L5489">    }</span>

    private void setNextEnabled(boolean enabled) {
<span class="nc" id="L5492">        getBtn(MoveCommand.MOVE_NEXT).setEnabled(enabled);</span>
<span class="nc" id="L5493">        clientgui.getMenuBar().setMoveNextEnabled(enabled);</span>
<span class="nc" id="L5494">    }</span>

    private void setForwardIniEnabled(boolean enabled) {
        // forward initiative can only be done if Teams have an initiative!
<span class="nc" id="L5498">        if (clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L5499" title="All 2 branches missed.">                     .booleanOption(OptionsConstants.BASE_TEAM_INITIATIVE)) {</span>
<span class="nc" id="L5500">            getBtn(MoveCommand.MOVE_FORWARD_INI).setEnabled(enabled);</span>
<span class="nc" id="L5501">            clientgui.getMenuBar().setMoveForwardIniEnabled(enabled);</span>
        } else { // turn them off regardless what is said!
<span class="nc" id="L5503">            getBtn(MoveCommand.MOVE_FORWARD_INI).setEnabled(false);</span>
<span class="nc" id="L5504">            clientgui.getMenuBar().setMoveForwardIniEnabled(false);</span>
        }
<span class="nc" id="L5506">    }</span>

    private void setLayMineEnabled(boolean enabled) {
<span class="nc" id="L5509">        getBtn(MoveCommand.MOVE_LAY_MINE).setEnabled(enabled);</span>
<span class="nc" id="L5510">        clientgui.getMenuBar().setMoveLayMineEnabled(enabled);</span>
<span class="nc" id="L5511">    }</span>

    private void setLoadEnabled(boolean enabled) {
<span class="nc" id="L5514">        getBtn(MoveCommand.MOVE_LOAD).setEnabled(enabled);</span>
<span class="nc" id="L5515">        clientgui.getMenuBar().setMoveLoadEnabled(enabled);</span>
<span class="nc" id="L5516">    }</span>

    private void setMountEnabled(boolean enabled) {
<span class="nc" id="L5519">        getBtn(MoveCommand.MOVE_MOUNT).setEnabled(enabled);</span>
        // clientgui.getMenuBar().setMoveMountEnabled(enabled);
<span class="nc" id="L5521">    }</span>
    
    private void setTowEnabled(boolean enabled) {
<span class="nc" id="L5524">        getBtn(MoveCommand.MOVE_TOW).setEnabled(enabled);</span>
<span class="nc" id="L5525">        clientgui.getMenuBar().setMoveTowEnabled(enabled);</span>
<span class="nc" id="L5526">    }</span>

    private void setUnloadEnabled(boolean enabled) {
<span class="nc" id="L5529">        getBtn(MoveCommand.MOVE_UNLOAD).setEnabled(enabled);</span>
<span class="nc" id="L5530">        clientgui.getMenuBar().setMoveUnloadEnabled(enabled);</span>
<span class="nc" id="L5531">    }</span>
    
    private void setDisconnectEnabled(boolean enabled) {
<span class="nc" id="L5534">        getBtn(MoveCommand.MOVE_DISCONNECT).setEnabled(enabled);</span>
<span class="nc" id="L5535">        clientgui.getMenuBar().setMoveDisconnectEnabled(enabled);</span>
<span class="nc" id="L5536">    }</span>

    private void setJumpEnabled(boolean enabled) {
<span class="nc" id="L5539">        buttons.get(MoveCommand.MOVE_JUMP).setEnabled(enabled);</span>
<span class="nc" id="L5540">        clientgui.getMenuBar().setMoveJumpEnabled(enabled);</span>
<span class="nc" id="L5541">    }</span>
    
    private void setModeConvertEnabled(boolean enabled) {
<span class="nc" id="L5544">        buttons.get(MoveCommand.MOVE_MODE_CONVERT).setEnabled(enabled);</span>
<span class="nc" id="L5545">        clientgui.getMenuBar().setMoveModeConvertEnabled(enabled);</span>
<span class="nc" id="L5546">    }</span>

    private void setSwimEnabled(boolean enabled) {
<span class="nc" id="L5549">        buttons.get(MoveCommand.MOVE_SWIM).setEnabled(enabled);</span>
<span class="nc" id="L5550">        clientgui.getMenuBar().setMoveSwimEnabled(enabled);</span>
<span class="nc" id="L5551">    }</span>

    private void setBackUpEnabled(boolean enabled) {
<span class="nc" id="L5554">        buttons.get(MoveCommand.MOVE_BACK_UP).setEnabled(enabled);</span>
<span class="nc" id="L5555">        clientgui.getMenuBar().setMoveBackUpEnabled(enabled);</span>
<span class="nc" id="L5556">    }</span>

    private void setChargeEnabled(boolean enabled) {
<span class="nc" id="L5559">        getBtn(MoveCommand.MOVE_CHARGE).setEnabled(enabled);</span>
<span class="nc" id="L5560">        clientgui.getMenuBar().setMoveChargeEnabled(enabled);</span>
<span class="nc" id="L5561">    }</span>

    private void setDFAEnabled(boolean enabled) {
<span class="nc" id="L5564">        getBtn(MoveCommand.MOVE_DFA).setEnabled(enabled);</span>
<span class="nc" id="L5565">        clientgui.getMenuBar().setMoveDFAEnabled(enabled);</span>
<span class="nc" id="L5566">    }</span>

    private void setGoProneEnabled(boolean enabled) {
<span class="nc" id="L5569">        getBtn(MoveCommand.MOVE_GO_PRONE).setEnabled(enabled);</span>
<span class="nc" id="L5570">        clientgui.getMenuBar().setMoveGoProneEnabled(enabled);</span>
<span class="nc" id="L5571">    }</span>

    private void setFleeEnabled(boolean enabled) {
<span class="nc" id="L5574">        getBtn(MoveCommand.MOVE_FLEE).setEnabled(enabled);</span>
<span class="nc" id="L5575">        clientgui.getMenuBar().setMoveFleeEnabled(enabled);</span>
<span class="nc" id="L5576">    }</span>

    private void setFlyOffEnabled(boolean enabled) {
<span class="nc" id="L5579">        getBtn(MoveCommand.MOVE_FLY_OFF).setEnabled(enabled);</span>
<span class="nc" id="L5580">        clientgui.getMenuBar().setMoveFlyOffEnabled(enabled);</span>
<span class="nc" id="L5581">    }</span>

    private void setEjectEnabled(boolean enabled) {
<span class="nc" id="L5584">        getBtn(MoveCommand.MOVE_EJECT).setEnabled(enabled);</span>
<span class="nc" id="L5585">        clientgui.getMenuBar().setMoveEjectEnabled(enabled);</span>
<span class="nc" id="L5586">    }</span>

    private void setUnjamEnabled(boolean enabled) {
<span class="nc" id="L5589">        getBtn(MoveCommand.MOVE_UNJAM).setEnabled(enabled);</span>
<span class="nc" id="L5590">        clientgui.getMenuBar().setMoveUnjamEnabled(enabled);</span>
<span class="nc" id="L5591">    }</span>

    private void setSearchlightEnabled(boolean enabled, boolean state) {
<span class="nc bnc" id="L5594" title="All 2 branches missed.">        if (state) {</span>
<span class="nc" id="L5595">            getBtn(MoveCommand.MOVE_SEARCHLIGHT).setText(</span>
<span class="nc" id="L5596">                    Messages.getString(&quot;MovementDisplay.butSearchlightOff&quot;));</span>
            //$NON-NLS-1$
        } else {
<span class="nc" id="L5599">            getBtn(MoveCommand.MOVE_SEARCHLIGHT).setText(</span>
<span class="nc" id="L5600">                    Messages.getString(&quot;MovementDisplay.butSearchlightOn&quot;));</span>
            //$NON-NLS-1$
        }
<span class="nc" id="L5603">        getBtn(MoveCommand.MOVE_SEARCHLIGHT).setEnabled(enabled);</span>
<span class="nc" id="L5604">        clientgui.getMenuBar().setMoveSearchlightEnabled(enabled);</span>
<span class="nc" id="L5605">    }</span>

    private void setHullDownEnabled(boolean enabled) {
<span class="nc" id="L5608">        getBtn(MoveCommand.MOVE_HULL_DOWN).setEnabled(enabled);</span>
<span class="nc" id="L5609">        clientgui.getMenuBar().setMoveHullDownEnabled(enabled);</span>
<span class="nc" id="L5610">    }</span>

    private void setClearEnabled(boolean enabled) {
<span class="nc" id="L5613">        getBtn(MoveCommand.MOVE_CLEAR).setEnabled(enabled);</span>
<span class="nc" id="L5614">        clientgui.getMenuBar().setMoveClearEnabled(enabled);</span>
<span class="nc" id="L5615">    }</span>

    private void setGetUpEnabled(boolean enabled) {
<span class="nc" id="L5618">        getBtn(MoveCommand.MOVE_GET_UP).setEnabled(enabled);</span>
<span class="nc" id="L5619">        clientgui.getMenuBar().setMoveGetUpEnabled(enabled);</span>
<span class="nc" id="L5620">    }</span>

    private void setRaiseEnabled(boolean enabled) {
<span class="nc" id="L5623">        getBtn(MoveCommand.MOVE_RAISE_ELEVATION).setEnabled(enabled);</span>
<span class="nc" id="L5624">        clientgui.getMenuBar().setMoveRaiseEnabled(enabled);</span>
<span class="nc" id="L5625">    }</span>

    private void setLowerEnabled(boolean enabled) {
<span class="nc" id="L5628">        getBtn(MoveCommand.MOVE_LOWER_ELEVATION).setEnabled(enabled);</span>
<span class="nc" id="L5629">        clientgui.getMenuBar().setMoveLowerEnabled(enabled);</span>
<span class="nc" id="L5630">    }</span>

    private void setRecklessEnabled(boolean enabled) {
<span class="nc" id="L5633">        getBtn(MoveCommand.MOVE_RECKLESS).setEnabled(enabled);</span>
<span class="nc" id="L5634">        clientgui.getMenuBar().setMoveRecklessEnabled(enabled);</span>
<span class="nc" id="L5635">    }</span>

    private void setAccEnabled(boolean enabled) {
<span class="nc" id="L5638">        getBtn(MoveCommand.MOVE_ACC).setEnabled(enabled);</span>
<span class="nc" id="L5639">        clientgui.getMenuBar().setMoveAccEnabled(enabled);</span>
<span class="nc" id="L5640">    }</span>

    private void setDecEnabled(boolean enabled) {
<span class="nc" id="L5643">        getBtn(MoveCommand.MOVE_DEC).setEnabled(enabled);</span>
<span class="nc" id="L5644">        clientgui.getMenuBar().setMoveDecEnabled(enabled);</span>
<span class="nc" id="L5645">    }</span>

    private void setAccNEnabled(boolean enabled) {
<span class="nc" id="L5648">        getBtn(MoveCommand.MOVE_ACCN).setEnabled(enabled);</span>
<span class="nc" id="L5649">        clientgui.getMenuBar().setMoveAccNEnabled(enabled);</span>
<span class="nc" id="L5650">    }</span>

    private void setDecNEnabled(boolean enabled) {
<span class="nc" id="L5653">        getBtn(MoveCommand.MOVE_DECN).setEnabled(enabled);</span>
<span class="nc" id="L5654">        clientgui.getMenuBar().setMoveDecNEnabled(enabled);</span>
<span class="nc" id="L5655">    }</span>

    private void setEvadeEnabled(boolean enabled) {
<span class="nc" id="L5658">        getBtn(MoveCommand.MOVE_EVADE).setEnabled(enabled);</span>
<span class="nc" id="L5659">        clientgui.getMenuBar().setMoveEvadeEnabled(enabled);</span>
<span class="nc" id="L5660">    }</span>
    
    private void setBootleggerEnabled(boolean enabled) {
<span class="nc" id="L5663">        getBtn(MoveCommand.MOVE_BOOTLEGGER).setEnabled(enabled);</span>
<span class="nc" id="L5664">        clientgui.getMenuBar().setMoveBootleggerEnabled(enabled);</span>
<span class="nc" id="L5665">    }</span>

    private void setShutdownEnabled(boolean enabled) {
<span class="nc" id="L5668">        getBtn(MoveCommand.MOVE_SHUTDOWN).setEnabled(enabled);</span>
<span class="nc" id="L5669">        clientgui.getMenuBar().setMoveShutdownEnabled(enabled);</span>
<span class="nc" id="L5670">    }</span>

    private void setStartupEnabled(boolean enabled) {
<span class="nc" id="L5673">        getBtn(MoveCommand.MOVE_STARTUP).setEnabled(enabled);</span>
<span class="nc" id="L5674">        clientgui.getMenuBar().setMoveStartupEnabled(enabled);</span>
<span class="nc" id="L5675">    }</span>

    private void setSelfDestructEnabled(boolean enabled) {
<span class="nc" id="L5678">        getBtn(MoveCommand.MOVE_SELF_DESTRUCT).setEnabled(enabled);</span>
<span class="nc" id="L5679">        clientgui.getMenuBar().setMoveSelfDestructEnabled(enabled);</span>
<span class="nc" id="L5680">    }</span>

    private void setTraitorEnabled(boolean enabled) {
<span class="nc" id="L5683">        clientgui.getMenuBar().setMoveTraitorEnabled(enabled);</span>
<span class="nc" id="L5684">    }</span>

    private void setEvadeAeroEnabled(boolean enabled) {
<span class="nc" id="L5687">        getBtn(MoveCommand.MOVE_EVADE_AERO).setEnabled(enabled);</span>
<span class="nc" id="L5688">        clientgui.getMenuBar().setMoveEvadeAeroEnabled(enabled);</span>
<span class="nc" id="L5689">    }</span>

    private void setRollEnabled(boolean enabled) {
<span class="nc" id="L5692">        getBtn(MoveCommand.MOVE_ROLL).setEnabled(enabled);</span>
<span class="nc" id="L5693">        clientgui.getMenuBar().setMoveRollEnabled(enabled);</span>
<span class="nc" id="L5694">    }</span>

    private void setLaunchEnabled(boolean enabled) {
<span class="nc" id="L5697">        getBtn(MoveCommand.MOVE_LAUNCH).setEnabled(enabled);</span>
<span class="nc" id="L5698">        clientgui.getMenuBar().setMoveLaunchEnabled(enabled);</span>
<span class="nc" id="L5699">    }</span>

    private void setDockEnabled(boolean enabled) {
<span class="nc" id="L5702">        getBtn(MoveCommand.MOVE_DOCK).setEnabled(enabled);</span>
<span class="nc" id="L5703">        clientgui.getMenuBar().setMoveLaunchEnabled(enabled);</span>
<span class="nc" id="L5704">    }</span>

    private void setRecoverEnabled(boolean enabled) {
<span class="nc" id="L5707">        getBtn(MoveCommand.MOVE_RECOVER).setEnabled(enabled);</span>
<span class="nc" id="L5708">        clientgui.getMenuBar().setMoveRecoverEnabled(enabled);</span>
<span class="nc" id="L5709">    }</span>

    private void setDropEnabled(boolean enabled) {
<span class="nc" id="L5712">        getBtn(MoveCommand.MOVE_DROP).setEnabled(enabled);</span>
        // clientgui.getMenuBar().setMoveDropEnabled(enabled);
<span class="nc" id="L5714">    }</span>

    private void setJoinEnabled(boolean enabled) {
<span class="nc" id="L5717">        getBtn(MoveCommand.MOVE_JOIN).setEnabled(enabled);</span>
<span class="nc" id="L5718">        clientgui.getMenuBar().setMoveJoinEnabled(enabled);</span>
<span class="nc" id="L5719">    }</span>

    private void setDumpEnabled(boolean enabled) {
<span class="nc" id="L5722">        getBtn(MoveCommand.MOVE_DUMP).setEnabled(enabled);</span>
<span class="nc" id="L5723">        clientgui.getMenuBar().setMoveDumpEnabled(enabled);</span>
<span class="nc" id="L5724">    }</span>

    private void setRamEnabled(boolean enabled) {
<span class="nc" id="L5727">        getBtn(MoveCommand.MOVE_RAM).setEnabled(enabled);</span>
<span class="nc" id="L5728">        clientgui.getMenuBar().setMoveRamEnabled(enabled);</span>
<span class="nc" id="L5729">    }</span>

    private void setHoverEnabled(boolean enabled) {
<span class="nc" id="L5732">        getBtn(MoveCommand.MOVE_HOVER).setEnabled(enabled);</span>
<span class="nc" id="L5733">        clientgui.getMenuBar().setMoveHoverEnabled(enabled);</span>
<span class="nc" id="L5734">    }</span>

    private void setTakeOffEnabled(boolean enabled) {
<span class="nc" id="L5737">        getBtn(MoveCommand.MOVE_TAKE_OFF).setEnabled(enabled);</span>
        // clientgui.getMenuBar().setMoveTakeOffEnabled(enabled);
<span class="nc" id="L5739">    }</span>

    private void setVTakeOffEnabled(boolean enabled) {
<span class="nc" id="L5742">        getBtn(MoveCommand.MOVE_VERT_TAKE_OFF).setEnabled(enabled);</span>
        // clientgui.getMenuBar().setMoveVTakeOffEnabled(enabled);
<span class="nc" id="L5744">    }</span>

    private void setLandEnabled(boolean enabled) {
<span class="nc" id="L5747">        getBtn(MoveCommand.MOVE_LAND).setEnabled(enabled);</span>
        // clientgui.getMenuBar().setMoveLandEnabled(enabled);
<span class="nc" id="L5749">    }</span>

    private void setVLandEnabled(boolean enabled) {
<span class="nc" id="L5752">        getBtn(MoveCommand.MOVE_VERT_LAND).setEnabled(enabled);</span>
        // clientgui.getMenuBar().setMoveVLandEnabled(enabled);
<span class="nc" id="L5754">    }</span>

    private void setManeuverEnabled(boolean enabled) {
<span class="nc" id="L5757">        getBtn(MoveCommand.MOVE_MANEUVER).setEnabled(enabled);</span>
<span class="nc" id="L5758">        clientgui.getMenuBar().setMoveManeuverEnabled(enabled);</span>
<span class="nc" id="L5759">    }</span>

    private void setTurnLeftEnabled(boolean enabled) {
<span class="nc" id="L5762">        getBtn(MoveCommand.MOVE_TURN_LEFT).setEnabled(enabled);</span>
<span class="nc" id="L5763">        clientgui.getMenuBar().setMoveTurnLeftEnabled(enabled);</span>
<span class="nc" id="L5764">    }</span>

    private void setTurnRightEnabled(boolean enabled) {
<span class="nc" id="L5767">        getBtn(MoveCommand.MOVE_TURN_RIGHT).setEnabled(enabled);</span>
<span class="nc" id="L5768">        clientgui.getMenuBar().setMoveTurnRightEnabled(enabled);</span>
<span class="nc" id="L5769">    }</span>

    private void setThrustEnabled(boolean enabled) {
<span class="nc" id="L5772">        getBtn(MoveCommand.MOVE_THRUST).setEnabled(enabled);</span>
<span class="nc" id="L5773">        clientgui.getMenuBar().setMoveThrustEnabled(enabled);</span>
<span class="nc" id="L5774">    }</span>

    private void setYawEnabled(boolean enabled) {
<span class="nc" id="L5777">        getBtn(MoveCommand.MOVE_YAW).setEnabled(enabled);</span>
<span class="nc" id="L5778">        clientgui.getMenuBar().setMoveYawEnabled(enabled);</span>
<span class="nc" id="L5779">    }</span>

    private void setEndOverEnabled(boolean enabled) {
<span class="nc" id="L5782">        getBtn(MoveCommand.MOVE_END_OVER).setEnabled(enabled);</span>
<span class="nc" id="L5783">        clientgui.getMenuBar().setMoveEndOverEnabled(enabled);</span>
<span class="nc" id="L5784">    }</span>

    private void setStrafeEnabled(boolean enabled) {
<span class="nc" id="L5787">        getBtn(MoveCommand.MOVE_STRAFE).setEnabled(enabled);</span>
<span class="nc" id="L5788">        clientgui.getMenuBar().setMoveStrafeEnabled(enabled);</span>
<span class="nc" id="L5789">    }</span>

    private void setBombEnabled(boolean enabled) {
<span class="nc" id="L5792">        getBtn(MoveCommand.MOVE_BOMB).setEnabled(enabled);</span>
<span class="nc" id="L5793">        clientgui.getMenuBar().setMoveBombEnabled(enabled);</span>
<span class="nc" id="L5794">    }</span>

    /**
     * Stop just ignoring events and actually stop listening to them.
     */
    public void removeAllListeners() {
<span class="nc bnc" id="L5800" title="All 2 branches missed.">        if (clientgui != null) {</span>
<span class="nc" id="L5801">            clientgui.getClient().getGame().removeGameListener(this);</span>
<span class="nc" id="L5802">            clientgui.getBoardView().removeBoardViewListener(this);</span>
        }
<span class="nc" id="L5804">    }</span>

    private void updateTurnButton() {
<span class="nc" id="L5807">        final Entity ce = ce();</span>
<span class="nc bnc" id="L5808" title="All 2 branches missed.">        if (null == ce) {</span>
<span class="nc" id="L5809">            return;</span>
        }

<span class="nc bnc" id="L5812" title="All 2 branches missed.">        setTurnEnabled(!ce.isImmobile()</span>
<span class="nc bnc" id="L5813" title="All 2 branches missed.">                       &amp;&amp; !ce.isStuck()</span>
<span class="nc bnc" id="L5814" title="All 4 branches missed.">                       &amp;&amp; ((ce.getWalkMP() &gt; 0) || (ce.getJumpMP() &gt; 0))</span>
<span class="nc bnc" id="L5815" title="All 4 branches missed.">                       &amp;&amp; !(cmd.isJumping() &amp;&amp; (ce instanceof Mech) &amp;&amp; (ce</span>
<span class="nc bnc" id="L5816" title="All 2 branches missed.">                                                                                .getJumpType() == Mech.JUMP_BOOSTER)));</span>
<span class="nc" id="L5817">    }</span>
    
    public void FieldofFire(Entity unit, int[][] ranges, int arc, int loc) {
        // do nothing here outside the movement phase
<span class="nc bnc" id="L5821" title="All 2 branches missed.">        if (!(clientgui.getClient().getGame().getPhase() == Phase.PHASE_MOVEMENT)) return;</span>
        
<span class="nc" id="L5823">        clientgui.bv.fieldofFireUnit = unit;</span>
<span class="nc" id="L5824">        clientgui.bv.fieldofFireRanges = ranges;</span>
<span class="nc" id="L5825">        clientgui.bv.fieldofFireWpArc = arc;</span>
<span class="nc" id="L5826">        clientgui.bv.fieldofFireWpLoc = loc;</span>
        
        // If the unit is the current unit, then work with
        // the current considered movement
<span class="nc bnc" id="L5830" title="All 2 branches missed.">        if (unit.equals(ce())) </span>
<span class="nc" id="L5831">            clientgui.bv.setWeaponFieldofFire(ce(), cmd);</span>
        else
<span class="nc" id="L5833">            clientgui.bv.setWeaponFieldofFire(unit.getFacing(), unit.getPosition());</span>
<span class="nc" id="L5834">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>