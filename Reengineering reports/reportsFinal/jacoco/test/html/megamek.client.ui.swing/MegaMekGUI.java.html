<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MegaMekGUI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">MegaMekGUI.java</span></div><h1>MegaMekGUI.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 * Copyright Â© 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 * Copyright (c) 2020 - The MegaMek Team. All Rights Reserved.
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 * for more details.
 */
package megamek.client.ui.swing;

import static megamek.common.Compute.d6;

import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.DisplayMode;
import java.awt.Font;
import java.awt.FontFormatException;
import java.awt.FontMetrics;
import java.awt.Frame;
import java.awt.Graphics;
import java.awt.GraphicsEnvironment;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Image;
import java.awt.Insets;
import java.awt.KeyboardFocusManager;
import java.awt.MediaTracker;
import java.awt.SystemColor;
import java.awt.event.ActionListener;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.awt.image.BufferedImage;
import java.awt.Window;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.Vector;
import java.util.zip.GZIPInputStream;

import javax.swing.ImageIcon;
import javax.swing.JComponent;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.SwingUtilities;
import javax.swing.ToolTipManager;
import javax.swing.UIManager;
import javax.swing.filechooser.FileFilter;

import com.thoughtworks.xstream.XStream;

import megamek.MegaMek;
import megamek.client.Client;
import megamek.client.bot.BotClient;
import megamek.client.bot.TestBot;
import megamek.client.bot.princess.Princess;
import megamek.client.bot.ui.swing.BotGUI;
import megamek.client.ui.IMegaMekGUI;
import megamek.client.ui.Messages;
import megamek.client.ui.dialogs.helpDialogs.MMReadMeHelpDialog;
import megamek.client.ui.swing.gameConnectionDialogs.ConnectDialog;
import megamek.client.ui.swing.gameConnectionDialogs.HostDialog;
import megamek.client.ui.swing.skinEditor.SkinEditorMainGUI;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.client.ui.swing.widget.MegamekButton;
import megamek.client.ui.swing.widget.SkinSpecification;
import megamek.client.ui.swing.widget.SkinXMLHandler;
import megamek.common.Compute;
import megamek.common.Configuration;
import megamek.common.IGame;
import megamek.common.IPlayer;
import megamek.common.KeyBindParser;
import megamek.common.MechFileParser;
import megamek.common.MechSummaryCache;
import megamek.common.Player;
import megamek.common.QuirksHandler;
import megamek.common.WeaponOrderHandler;
import megamek.common.logging.LogLevel;
import megamek.common.options.GameOptions;
import megamek.common.options.IBasicOption;
import megamek.common.options.IOption;
import megamek.common.preference.IPreferenceChangeListener;
import megamek.common.preference.PreferenceChangeEvent;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.ImageUtil;
import megamek.common.util.SerializationHelper;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.server.ScenarioLoader;
import megamek.server.Server;

<span class="nc" id="L107">public class MegaMekGUI  implements IPreferenceChangeListener, IMegaMekGUI {</span>
    private static final String FILENAME_MEGAMEK_SPLASH = &quot;../misc/megamek-splash.jpg&quot;;
    private static final String FILENAME_ICON_16X16 = &quot;megamek-icon-16x16.png&quot;;
    private static final String FILENAME_ICON_32X32 = &quot;megamek-icon-32x32.png&quot;;
    private static final String FILENAME_ICON_48X48 = &quot;megamek-icon-48x48.png&quot;;
    private static final String FILENAME_ICON_256X256 = &quot;megamek-icon-256x256.png&quot;;

    private static final String FILENAME_BT_CLASSIC_FONT = &quot;btclassic/BTLogo_old.ttf&quot;;

    private JFrame frame;
    private Client client;
    private Server server;
    private CommonAboutDialog about;
    private GameOptionsDialog optionsDialog;
    private CommonSettingsDialog settingsDialog;

    private MegaMekController controller;

<span class="nc" id="L125">    BufferedImage backgroundIcon = null;</span>

    @Override
    public void start(String[] args) {
<span class="nc" id="L129">        createGUI();</span>
<span class="nc" id="L130">    }</span>

    /**
     * Construct a MegaMek, and display the main menu in the specified frame.
     */
    private void createGUI() {
        try {
<span class="nc" id="L137">            GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();</span>
<span class="nc" id="L138">            File btFontFile = new MegaMekFile(Configuration.fontsDir(), FILENAME_BT_CLASSIC_FONT).getFile();</span>
<span class="nc" id="L139">            Font btFont = Font.createFont(Font.TRUETYPE_FONT, btFontFile);</span>
<span class="nc" id="L140">            System.out.println(&quot;Loaded Font: &quot; + btFont.getName());</span>
<span class="nc" id="L141">            ge.registerFont(btFont);</span>
<span class="nc" id="L142">        } catch (IOException | FontFormatException e) {</span>
<span class="nc" id="L143">            System.out.println(&quot;Error Registering BT Classic Font! Error: &quot; + e.getMessage());</span>
<span class="nc" id="L144">        }</span>

<span class="nc" id="L146">        createController();</span>

<span class="nc" id="L148">        GUIPreferences.getInstance().addPreferenceChangeListener(this);</span>

        // Set a couple of things to make the Swing GUI look more &quot;Mac-like&quot; on
        // Macs
        // Taken from:
        // http://www.devdaily.com/apple/mac/java-mac-native-look/Introduction.shtml
<span class="nc" id="L154">        System.setProperty(&quot;apple.laf.useScreenMenuBar&quot;, &quot;true&quot;);</span>
<span class="nc" id="L155">        System.setProperty(&quot;com.apple.mrj.application.apple.menu.about.name&quot;, &quot;MegaMek&quot;);</span>

        // Add additional themes
<span class="nc" id="L158">        UIManager.installLookAndFeel(&quot;Flat Light&quot;, &quot;com.formdev.flatlaf.FlatLightLaf&quot;);</span>
<span class="nc" id="L159">        UIManager.installLookAndFeel(&quot;Flat IntelliJ&quot;, &quot;com.formdev.flatlaf.FlatIntelliJLaf&quot;);</span>
<span class="nc" id="L160">        UIManager.installLookAndFeel(&quot;Flat Dark&quot;, &quot;com.formdev.flatlaf.FlatDarkLaf&quot;);</span>
<span class="nc" id="L161">        UIManager.installLookAndFeel(&quot;Flat Darcula&quot;, &quot;com.formdev.flatlaf.FlatDarculaLaf&quot;);</span>

        // this should also help to make MegaMek look more system-specific
        try {
<span class="nc" id="L165">            UIManager.setLookAndFeel(GUIPreferences.getInstance().getUITheme());</span>
<span class="nc" id="L166">        } catch (Exception e) {</span>
<span class="nc" id="L167">            System.err.println(&quot;Error setting look and feel!&quot;);</span>
<span class="nc" id="L168">            e.printStackTrace();</span>
<span class="nc" id="L169">        }</span>

<span class="nc" id="L171">        ToolTipManager.sharedInstance().setInitialDelay(</span>
<span class="nc" id="L172">                GUIPreferences.getInstance().getTooltipDelay());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getTooltipDismissDelay() &gt;= 0) {</span>
<span class="nc" id="L174">            ToolTipManager.sharedInstance().setDismissDelay(</span>
<span class="nc" id="L175">                    GUIPreferences.getInstance().getTooltipDismissDelay());</span>
        }
<span class="nc" id="L177">        frame = new JFrame(&quot;MegaMek&quot;);</span>
<span class="nc" id="L178">        frame.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L181">                quit();</span>
<span class="nc" id="L182">            }</span>
        });

<span class="nc" id="L185">        frame.setContentPane(new JPanel() {</span>
            private static final long serialVersionUID = 5174313603291016012L;

            @Override
            protected void paintComponent(Graphics g) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (backgroundIcon == null) {</span>
<span class="nc" id="L191">                    super.paintComponent(g);</span>
<span class="nc" id="L192">                    return;</span>
                }
<span class="nc" id="L194">                int w = getWidth();</span>
<span class="nc" id="L195">                int h = getHeight();</span>
<span class="nc" id="L196">                int iW = backgroundIcon.getWidth();</span>
<span class="nc" id="L197">                int iH = backgroundIcon.getHeight();</span>
                // If the image isn't loaded, prevent an infinite loop
<span class="nc bnc" id="L199" title="All 4 branches missed.">                if ((iW &lt; 1) || (iH &lt; 1)) {</span>
<span class="nc" id="L200">                    return;</span>
                }
<span class="nc bnc" id="L202" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x += iW) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                    for (int y = 0; y &lt; h; y += iH) {</span>
<span class="nc" id="L204">                        g.drawImage(backgroundIcon, x, y,null);</span>
                    }
                }
<span class="nc" id="L207">            }</span>
        });

<span class="nc" id="L210">        List&lt;Image&gt; iconList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L211">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L212">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_16X16).toString()));</span>
<span class="nc" id="L213">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L214">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_32X32).toString()));</span>
<span class="nc" id="L215">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L216">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_48X48).toString()));</span>
<span class="nc" id="L217">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L218">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_256X256).toString()));</span>
<span class="nc" id="L219">        frame.setIconImages(iconList);</span>
<span class="nc" id="L220">        CommonMenuBar menuBar = new CommonMenuBar();</span>
<span class="nc" id="L221">        menuBar.addActionListener(actionListener);</span>
<span class="nc" id="L222">        frame.setJMenuBar(menuBar);</span>
<span class="nc" id="L223">        showMainMenu();</span>

        // set visible on middle of screen
<span class="nc" id="L226">        frame.setLocationRelativeTo(null);</span>
        // init the cache
<span class="nc" id="L228">        MechSummaryCache.getInstance();</span>

        // Show the window.
<span class="nc" id="L231">        frame.setVisible(true);</span>

        // tell the user about the readme...
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getNagForReadme()) {</span>
<span class="nc" id="L235">            ConfirmDialog confirm = new ConfirmDialog(frame,</span>
<span class="nc" id="L236">                    Messages.getString(&quot;MegaMek.welcome.title&quot;) + MegaMek.VERSION,</span>
<span class="nc" id="L237">                    Messages.getString(&quot;MegaMek.welcome.message&quot;), true);</span>
<span class="nc" id="L238">            confirm.setVisible(true);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (!confirm.getShowAgain()) {</span>
<span class="nc" id="L240">                GUIPreferences.getInstance().setNagForReadme(false);</span>
            }
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (confirm.getAnswer()) {</span>
<span class="nc" id="L243">                new MMReadMeHelpDialog(frame).setVisible(true);</span>
            }
        }
<span class="nc" id="L246">    }</span>

    public void createController() {
<span class="nc" id="L249">        controller = new MegaMekController();</span>
<span class="nc" id="L250">        KeyboardFocusManager kbfm = KeyboardFocusManager.getCurrentKeyboardFocusManager();</span>
<span class="nc" id="L251">        kbfm.addKeyEventDispatcher(controller);</span>

<span class="nc" id="L253">        KeyBindParser.parseKeyBindings(controller);</span>
<span class="nc" id="L254">    }</span>

    /**
     * Display the main menu.
     */
    private void showMainMenu() {
<span class="nc" id="L260">        SkinSpecification skinSpec = SkinXMLHandler.getSkin(SkinSpecification.UIComponents.MainMenuBorder.getComp(),</span>
                true);
<span class="nc" id="L262">        frame.getContentPane().removeAll();</span>
<span class="nc" id="L263">        frame.setBackground(SystemColor.menu);</span>
<span class="nc" id="L264">        frame.setForeground(SystemColor.menuText);</span>
<span class="nc" id="L265">        frame.setResizable(false);</span>

        MegamekButton hostB;
        MegamekButton connectB;
        MegamekButton botB;
        MegamekButton editB;
        MegamekButton skinEditB;
        MegamekButton scenB;
        MegamekButton loadB;
        MegamekButton quitB;
<span class="nc" id="L275">        JLabel labVersion = new JLabel(Messages.getString(&quot;MegaMek.Version&quot;) + MegaMek.VERSION,</span>
                JLabel.CENTER);
<span class="nc" id="L277">        labVersion.setPreferredSize(new Dimension(250,15));</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (skinSpec.fontColors.size() &gt; 0) {</span>
<span class="nc" id="L279">            labVersion.setForeground(skinSpec.fontColors.get(0));</span>
        }
<span class="nc" id="L281">        hostB = new MegamekButton(Messages.getString(&quot;MegaMek.hostNewGame.label&quot;),</span>
<span class="nc" id="L282">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L283">        hostB.setActionCommand(ClientGUI.FILE_GAME_NEW);</span>
<span class="nc" id="L284">        hostB.addActionListener(actionListener);</span>
<span class="nc" id="L285">        scenB = new MegamekButton(Messages.getString(&quot;MegaMek.hostScenario.label&quot;),</span>
<span class="nc" id="L286">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L287">        scenB.setActionCommand(ClientGUI.FILE_GAME_SCENARIO);</span>
<span class="nc" id="L288">        scenB.addActionListener(actionListener);</span>
<span class="nc" id="L289">        loadB = new MegamekButton(Messages.getString(&quot;MegaMek.hostSavedGame.label&quot;),</span>
<span class="nc" id="L290">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L291">        loadB.setActionCommand(ClientGUI.FILE_GAME_OPEN);</span>
<span class="nc" id="L292">        loadB.addActionListener(actionListener);</span>
<span class="nc" id="L293">        connectB = new MegamekButton(Messages.getString(&quot;MegaMek.Connect.label&quot;),</span>
<span class="nc" id="L294">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L295">        connectB.setActionCommand(ClientGUI.FILE_GAME_CONNECT);</span>
<span class="nc" id="L296">        connectB.addActionListener(actionListener);</span>
<span class="nc" id="L297">        botB = new MegamekButton(Messages.getString(&quot;MegaMek.ConnectAsBot.label&quot;),</span>
<span class="nc" id="L298">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L299">        botB.setActionCommand(ClientGUI.FILE_GAME_CONNECT_BOT);</span>
<span class="nc" id="L300">        botB.addActionListener(actionListener);</span>
<span class="nc" id="L301">        editB = new MegamekButton(Messages.getString(&quot;MegaMek.MapEditor.label&quot;),</span>
<span class="nc" id="L302">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L303">        editB.setActionCommand(ClientGUI.FILE_BOARD_NEW);</span>
<span class="nc" id="L304">        editB.addActionListener(actionListener);</span>
<span class="nc" id="L305">        skinEditB = new MegamekButton(Messages.getString(&quot;MegaMek.SkinEditor.label&quot;),</span>
<span class="nc" id="L306">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L307">        skinEditB.setActionCommand(ClientGUI.MAIN_SKIN_NEW);</span>
<span class="nc" id="L308">        skinEditB.addActionListener(actionListener);</span>
<span class="nc" id="L309">        quitB = new MegamekButton(Messages.getString(&quot;MegaMek.Quit.label&quot;),</span>
<span class="nc" id="L310">                SkinSpecification.UIComponents.MainMenuButton.getComp(), true);</span>
<span class="nc" id="L311">        quitB.setActionCommand(ClientGUI.MAIN_QUIT);</span>
<span class="nc" id="L312">        quitB.addActionListener(actionListener);</span>

        // Use the current monitor so we don't &quot;overflow&quot; computers whose primary
        // displays aren't as large as their secondary displays.
<span class="nc" id="L316">        DisplayMode currentMonitor = frame.getGraphicsConfiguration().getDevice().getDisplayMode();</span>

        String splashFilename;
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (skinSpec.hasBackgrounds()) {</span>
<span class="nc" id="L320">            splashFilename = determineSplashScreen(skinSpec.backgrounds, </span>
<span class="nc" id="L321">                    currentMonitor.getWidth(), currentMonitor.getHeight());</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (skinSpec.backgrounds.size() &gt; 1) {</span>
<span class="nc" id="L323">                File file = new MegaMekFile(Configuration.widgetsDir(),</span>
<span class="nc" id="L324">                        skinSpec.backgrounds.get(1)).getFile();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (!file.exists()) {</span>
<span class="nc" id="L326">                    MegaMek.getLogger().error(&quot;MainMenu Error: background icon doesn't exist: &quot;</span>
<span class="nc" id="L327">                            + file.getAbsolutePath());</span>
                } else {
<span class="nc" id="L329">                    backgroundIcon = (BufferedImage) ImageUtil.loadImageFromFile(file.toString());</span>
                }
<span class="nc" id="L331">            }</span>
        } else {
<span class="nc" id="L333">            splashFilename = FILENAME_MEGAMEK_SPLASH;</span>
<span class="nc" id="L334">            backgroundIcon = null;</span>
        }
<span class="nc" id="L336">        File splashFile = new File(Configuration.widgetsDir(), splashFilename);</span>
        // Ensure we have a splash image, even if we have to fall back to default.
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!splashFile.exists()) {</span>
<span class="nc" id="L339">            splashFilename = FILENAME_MEGAMEK_SPLASH;</span>
        }
        // initialize splash image
<span class="nc" id="L342">        Image imgSplash = frame.getToolkit()</span>
<span class="nc" id="L343">                .getImage(new MegaMekFile(Configuration.widgetsDir(), splashFilename).toString());</span>

        // wait for splash image to load completely
<span class="nc" id="L346">        MediaTracker tracker = new MediaTracker(frame);</span>
<span class="nc" id="L347">        tracker.addImage(imgSplash, 0);</span>
        try {
<span class="nc" id="L349">            tracker.waitForID(0);</span>
<span class="nc" id="L350">        } catch (InterruptedException e) {</span>
            // really should never come here
<span class="nc" id="L352">        }</span>
        // make splash image panel
<span class="nc" id="L354">        ImageIcon icon = new ImageIcon(imgSplash);</span>
<span class="nc" id="L355">        JLabel panTitle = new JLabel(icon);</span>

<span class="nc" id="L357">        FontMetrics metrics = hostB.getFontMetrics(loadB.getFont());</span>
<span class="nc" id="L358">        int width = metrics.stringWidth(hostB.getText());</span>
<span class="nc" id="L359">        int height = metrics.getHeight();</span>
<span class="nc" id="L360">        Dimension textDim =  new Dimension(width+50, height+10);</span>

        // Strive for no more than ~90% of the screen and use golden ratio to make
        // the button width &quot;look&quot; reasonable.
<span class="nc" id="L364">        int imageWidth = imgSplash.getWidth(frame);</span>
<span class="nc" id="L365">        int maximumWidth = (int) (0.9 * currentMonitor.getWidth()) - imageWidth;</span>
<span class="nc" id="L366">        Dimension minButtonDim = new Dimension((int) (maximumWidth / 1.618), 25);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (textDim.getWidth() &gt; minButtonDim.getWidth()) {</span>
<span class="nc" id="L368">            minButtonDim = textDim;</span>
        }

<span class="nc" id="L371">        hostB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L372">        connectB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L373">        botB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L374">        editB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L375">        skinEditB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L376">        scenB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L377">        loadB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L378">        quitB.setPreferredSize(minButtonDim);</span>
<span class="nc" id="L379">        hostB.setPreferredSize(minButtonDim);</span>

<span class="nc" id="L381">        connectB.setMinimumSize(minButtonDim);</span>
<span class="nc" id="L382">        botB.setMinimumSize(minButtonDim);</span>
<span class="nc" id="L383">        editB.setMinimumSize(minButtonDim);</span>
<span class="nc" id="L384">        skinEditB.setMinimumSize(minButtonDim);</span>
<span class="nc" id="L385">        scenB.setMinimumSize(minButtonDim);</span>
<span class="nc" id="L386">        loadB.setMinimumSize(minButtonDim);</span>
<span class="nc" id="L387">        quitB.setMinimumSize(minButtonDim);</span>

        // layout
<span class="nc" id="L390">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L391">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L392">        frame.getContentPane().setLayout(gridbag);</span>
        // Left Column
<span class="nc" id="L394">        c.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L395">        c.insets = new Insets(10, 5, 10, 10);</span>
<span class="nc" id="L396">        c.ipadx = 10; c.ipady = 5;</span>
<span class="nc" id="L397">        c.gridx = 0;  c.gridy = 0;</span>
<span class="nc" id="L398">        c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L399">        c.weightx = 0.0; c.weighty = 0.0;</span>
<span class="nc" id="L400">        c.gridwidth = 1;</span>
<span class="nc" id="L401">        c.gridheight = 9;</span>
<span class="nc" id="L402">        addBag(panTitle, gridbag, c);</span>
        // Right Column
<span class="nc" id="L404">        c.insets = new Insets(4, 4, 1, 12);</span>
<span class="nc" id="L405">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L406">        c.weightx = 1.0; c.weighty = 1.0;</span>
<span class="nc" id="L407">        c.ipadx = 0; c.ipady = 0;</span>
<span class="nc" id="L408">        c.gridheight = 1;</span>
<span class="nc" id="L409">        c.gridx = 1; c.gridy = 0;</span>
<span class="nc" id="L410">        addBag(labVersion, gridbag, c);</span>
<span class="nc" id="L411">        c.gridy++;</span>
<span class="nc" id="L412">        addBag(hostB, gridbag, c);</span>
<span class="nc" id="L413">        c.gridy++;</span>
<span class="nc" id="L414">        addBag(loadB, gridbag, c);</span>
<span class="nc" id="L415">        c.gridy++;</span>
<span class="nc" id="L416">        addBag(scenB, gridbag, c);</span>
<span class="nc" id="L417">        c.gridy++;</span>
<span class="nc" id="L418">        addBag(connectB, gridbag, c);</span>
<span class="nc" id="L419">        c.gridy++;</span>
<span class="nc" id="L420">        addBag(botB, gridbag, c);</span>
<span class="nc" id="L421">        c.gridy++;</span>
<span class="nc" id="L422">        addBag(editB, gridbag, c);</span>
<span class="nc" id="L423">        c.gridy++;</span>
<span class="nc" id="L424">        addBag(skinEditB, gridbag, c);</span>
<span class="nc" id="L425">        c.gridy++;</span>
<span class="nc" id="L426">        c.insets = new Insets(4, 4, 15, 12);</span>
<span class="nc" id="L427">        addBag(quitB, gridbag, c);</span>
<span class="nc" id="L428">        frame.validate();</span>
<span class="nc" id="L429">        frame.pack();</span>
<span class="nc" id="L430">    }</span>

    /**
     * Display the game options dialog.
     */
    void showGameOptions() {
<span class="nc" id="L436">        GameOptions options = new GameOptions();</span>
<span class="nc" id="L437">        options.initialize();</span>
<span class="nc" id="L438">        options.loadOptions();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (optionsDialog == null) {</span>
<span class="nc" id="L440">            optionsDialog = new GameOptionsDialog(frame, options, true);</span>
        }
<span class="nc" id="L442">        optionsDialog.update(options);</span>
<span class="nc" id="L443">        optionsDialog.setVisible(true);</span>
<span class="nc" id="L444">    }</span>

    /**
     * Display the board editor.
     */
    void showEditor() {
<span class="nc" id="L450">        BoardEditor editor = new BoardEditor(controller);</span>
<span class="nc" id="L451">        controller.boardEditor = editor;</span>
<span class="nc" id="L452">        launch(editor.getFrame());</span>
<span class="nc" id="L453">        editor.boardNew(GUIPreferences.getInstance().getBoardEdRndStart());</span>
<span class="nc" id="L454">    }</span>
    
    void showSkinEditor() {
<span class="nc" id="L457">        int response = JOptionPane.showConfirmDialog(frame, </span>
                &quot;The skin editor is currently &quot;
                + &quot;in beta and is a work in progress.  There are likely to &quot;
                + &quot;be issues. \nContinue?&quot;, &quot;Continue?&quot;,
                JOptionPane.OK_CANCEL_OPTION);
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (response == JOptionPane.CANCEL_OPTION) {</span>
<span class="nc" id="L463">            return;</span>
        }
<span class="nc" id="L465">        SkinEditorMainGUI skinEditor = new SkinEditorMainGUI();</span>
<span class="nc" id="L466">        skinEditor.initialize();</span>
<span class="nc" id="L467">        skinEditor.switchPanel(IGame.Phase.PHASE_MOVEMENT);</span>
<span class="nc" id="L468">        launch(skinEditor.getFrame());        </span>
<span class="nc" id="L469">    }</span>

    /**
     * Display the board editor and open an &quot;open&quot; dialog.
     */
    void showEditorOpen() {
<span class="nc" id="L475">        BoardEditor editor = new BoardEditor(controller);</span>
<span class="nc" id="L476">        controller.boardEditor = editor;</span>
<span class="nc" id="L477">        launch(editor.getFrame());</span>
<span class="nc" id="L478">        editor.boardLoad();</span>
<span class="nc" id="L479">    }</span>

    /**
     * Start instances of both the client and the server.
     */
    void host() {
<span class="nc" id="L485">        HostDialog hd = new HostDialog(frame);</span>
<span class="nc" id="L486">        hd.setVisible(true);</span>

<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (!hd.dataValidation(&quot;MegaMek.HostGameAlert.title&quot;)) {</span>
<span class="nc" id="L489">            return;</span>
        }

        // kick off a RNG check
<span class="nc" id="L493">        d6();</span>

        // start server
        try {
<span class="nc" id="L497">            server = new Server(hd.getServerPass(), hd.getPort(), hd.isRegister(),</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                    hd.isRegister() ? hd.getMetaserver() : &quot;&quot;);</span>
<span class="nc" id="L499">        } catch (Exception e) {</span>
<span class="nc" id="L500">            MegaMek.getLogger().error(&quot;Could not create server socket on port &quot; + hd.getPort(), e);</span>
<span class="nc" id="L501">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L502">                    Messages.getFormattedString(&quot;MegaMek.StartServerError&quot;, hd.getPort(), e.getMessage()),</span>
<span class="nc" id="L503">                    Messages.getString(&quot;MegaMek.HostGameAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L504">            return;</span>
<span class="nc" id="L505">        }</span>
        // initialize client
<span class="nc" id="L507">        client = new Client(hd.getPlayerName(), &quot;localhost&quot;, hd.getPort());</span>
<span class="nc" id="L508">        ClientGUI gui = new ClientGUI(client, controller);</span>
<span class="nc" id="L509">        controller.clientgui = gui;</span>
<span class="nc" id="L510">        frame.setCursor(new Cursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L511">        gui.initialize();</span>
<span class="nc" id="L512">        frame.setCursor(new Cursor(Cursor.DEFAULT_CURSOR));</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (!client.connect()) {</span>
<span class="nc" id="L514">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L515">                    Messages.getFormattedString(&quot;MegaMek.ServerConnectionError&quot;, &quot;localhost&quot;, hd.getPort()),</span>
<span class="nc" id="L516">                    Messages.getString(&quot;MegaMek.HostGameAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L517">            frame.setVisible(false);</span>
<span class="nc" id="L518">            client.die();</span>
        }
<span class="nc" id="L520">        launch(gui.getFrame());</span>

<span class="nc" id="L522">        optionsDialog = null;</span>
<span class="nc" id="L523">    }</span>

    void loadGame() {
<span class="nc" id="L526">        JFileChooser fc = new JFileChooser(&quot;savegames&quot;);</span>
<span class="nc" id="L527">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L528">        fc.setDialogTitle(Messages.getString(&quot;MegaMek.SaveGameDialog.title&quot;));</span>
<span class="nc" id="L529">        fc.setFileFilter(new FileFilter() {</span>
            @Override
            public boolean accept(File dir) {
<span class="nc bnc" id="L532" title="All 6 branches missed.">                return ((dir.getName().endsWith(&quot;.sav&quot;) || dir.getName().endsWith(&quot;.sav.gz&quot;) || dir.isDirectory()));</span>
            }

            @Override
            public String getDescription() {
<span class="nc" id="L537">                return &quot;Savegames&quot;;</span>
            }
        });
<span class="nc" id="L540">        int returnVal = fc.showOpenDialog(frame);</span>
<span class="nc bnc" id="L541" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L543">            return;</span>
        }

<span class="nc" id="L546">        IGame newGame = null;</span>
<span class="nc" id="L547">        try (InputStream is = new FileInputStream(fc.getSelectedFile()); InputStream gzi = new GZIPInputStream(is)) {</span>
<span class="nc" id="L548">            XStream xstream = SerializationHelper.getXStream();</span>
<span class="nc" id="L549">            newGame = (IGame) xstream.fromXML(gzi);</span>
<span class="nc" id="L550">        } catch (Exception e) {</span>
<span class="nc" id="L551">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + fc.getSelectedFile(), e);</span>
<span class="nc" id="L552">            JOptionPane.showMessageDialog(frame, Messages.getString(&quot;MegaMek.LoadGameAlert.message&quot;),</span>
<span class="nc" id="L553">            Messages.getString(&quot;MegaMek.LoadGameAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L554">            return;</span>
<span class="nc" id="L555">        }</span>

<span class="nc" id="L557">        Vector&lt;String&gt; playerNames = null;</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (newGame != null) {</span>
<span class="nc" id="L559">            playerNames = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">            for (IPlayer player : newGame.getPlayersVector()) {</span>
<span class="nc" id="L561">                playerNames.add(player.getName());</span>
<span class="nc" id="L562">            }</span>
        }

<span class="nc" id="L565">        HostDialog hd = new HostDialog(frame, playerNames);</span>
<span class="nc" id="L566">        hd.setVisible(true);</span>

<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (!hd.dataValidation(&quot;MegaMek.LoadGameAlert.title&quot;)) {</span>
<span class="nc" id="L569">            return;</span>
        }

        // kick off a RNG check
<span class="nc" id="L573">        d6();</span>
        // start server
        try {
<span class="nc bnc" id="L576" title="All 2 branches missed.">            server = new Server(hd.getServerPass(), hd.getPort(), hd.isRegister(), hd.isRegister() ? hd.getMetaserver() : &quot;&quot;);</span>
<span class="nc" id="L577">        } catch (IOException ex) {</span>
<span class="nc" id="L578">            MegaMek.getLogger().error(&quot;Could not create server socket on port &quot; + hd.getPort(), ex);</span>
<span class="nc" id="L579">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L580">                    Messages.getFormattedString(&quot;MegaMek.StartServerError&quot;, hd.getPort(), ex.getMessage()),</span>
<span class="nc" id="L581">                    Messages.getString(&quot;MegaMek.LoadGameAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L582">            return;</span>
<span class="nc" id="L583">        }</span>

<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (!server.loadGame(fc.getSelectedFile())) {</span>
<span class="nc" id="L586">            JOptionPane.showMessageDialog(frame, Messages.getString(&quot;MegaMek.LoadGameAlert.message&quot;),</span>
<span class="nc" id="L587">                    Messages.getString(&quot;MegaMek.LoadGameAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L588">            server.die();</span>
<span class="nc" id="L589">            server = null;</span>
<span class="nc" id="L590">            return;</span>
        }

<span class="nc" id="L593">        client = new Client(hd.getPlayerName(), &quot;localhost&quot;, hd.getPort());</span>
<span class="nc" id="L594">        ClientGUI gui = new ClientGUI(client, controller);</span>
<span class="nc" id="L595">        controller.clientgui = gui;</span>
<span class="nc" id="L596">        frame.setCursor(new Cursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L597">        gui.initialize();</span>
<span class="nc" id="L598">        frame.setCursor(new Cursor(Cursor.DEFAULT_CURSOR));</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if (!client.connect()) {</span>
<span class="nc" id="L600">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L601">                    Messages.getFormattedString(&quot;MegaMek.ServerConnectionError&quot;, &quot;localhost&quot;, hd.getPort()),</span>
<span class="nc" id="L602">                    Messages.getString(&quot;MegaMek.LoadGameAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L603">            frame.setVisible(false);</span>
<span class="nc" id="L604">            client.die();</span>
        }
<span class="nc" id="L606">        optionsDialog = null;</span>

        // free some memory that's only needed in lounge
        // This normally happens in the deployment phase in Client, but
        // if we are loading a game, this phase may not be reached
<span class="nc" id="L611">        MechFileParser.dispose();</span>
        // We must do this last, as the name and unit generators can create
        // a new instance if they are running
<span class="nc" id="L614">        MechSummaryCache.dispose();</span>

<span class="nc" id="L616">        launch(gui.getFrame());</span>
<span class="nc" id="L617">    }</span>

    /**
     * Host a game constructed from a scenario file
     */
    void scenario() {
<span class="nc" id="L623">        JFileChooser fc = new JFileChooser(&quot;data&quot; + File.separatorChar + &quot;scenarios&quot;);</span>
<span class="nc" id="L624">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L625">        fc.setDialogTitle(Messages.getString(&quot;MegaMek.SelectScenarioDialog.title&quot;));</span>

<span class="nc" id="L627">        FileFilter filter = new FileFilter() {</span>

            @Override
            public boolean accept(File f) {
<span class="nc bnc" id="L631" title="All 2 branches missed.">                if (f.isDirectory()) {</span>
<span class="nc" id="L632">                    return true;</span>
                }

<span class="nc" id="L635">                String ext = null;</span>
<span class="nc" id="L636">                String s = f.getName();</span>
<span class="nc" id="L637">                int i = s.lastIndexOf('.');</span>

<span class="nc bnc" id="L639" title="All 4 branches missed.">                if ((i &gt; 0) &amp;&amp; (i &lt; (s.length() - 1))) {</span>
<span class="nc" id="L640">                    ext = s.substring(i + 1).toLowerCase();</span>
                }

<span class="nc bnc" id="L643" title="All 2 branches missed.">                if (ext != null) {</span>
<span class="nc" id="L644">                    return ext.equalsIgnoreCase(&quot;mms&quot;);</span>
                }

<span class="nc" id="L647">                return false;</span>
            }

            @Override
            public String getDescription() {
<span class="nc" id="L652">                return &quot;MegaMek Scenario Files&quot;;</span>
            }

        };
<span class="nc" id="L656">        fc.setFileFilter(filter);</span>

<span class="nc" id="L658">        int returnVal = fc.showOpenDialog(frame);</span>
<span class="nc bnc" id="L659" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L661">            return;</span>
        }

<span class="nc" id="L664">        ScenarioLoader sl = new ScenarioLoader(fc.getSelectedFile());</span>
        IGame g;
        try {
<span class="nc" id="L667">            g = sl.createGame();</span>
<span class="nc" id="L668">        } catch (Exception e) {</span>
<span class="nc" id="L669">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L670">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L671">                    Messages.getString(&quot;MegaMek.HostScenarioAlert.message&quot;, e.getMessage()),</span>
<span class="nc" id="L672">                    Messages.getString(&quot;MegaMek.HostScenarioAlert.title&quot;),</span>
                    JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L674">            return;</span>
<span class="nc" id="L675">        }</span>

        // popup options dialog
<span class="nc" id="L678">        GameOptionsDialog god = new GameOptionsDialog(frame, g.getOptions(), false);</span>
<span class="nc" id="L679">        god.update(g.getOptions());</span>
<span class="nc" id="L680">        god.setEditable(true);</span>
<span class="nc" id="L681">        god.setVisible(true);</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">        for (IBasicOption opt : god.getOptions()) {</span>
<span class="nc" id="L683">            IOption orig = g.getOptions().getOption(opt.getName());</span>
<span class="nc" id="L684">            orig.setValue(opt.getValue());</span>
<span class="nc" id="L685">        }</span>

        // popup planetary conditions dialog
<span class="nc" id="L688">        PlanetaryConditionsDialog pcd = new PlanetaryConditionsDialog(frame, g.getPlanetaryConditions());</span>
<span class="nc" id="L689">        pcd.update(g.getPlanetaryConditions());</span>
<span class="nc" id="L690">        pcd.setVisible(true);</span>
<span class="nc" id="L691">        g.setPlanetaryConditions(pcd.getConditions());</span>

        // get player types and colors set
<span class="nc" id="L694">        Player[] pa = new Player[g.getPlayersVector().size()];</span>
<span class="nc" id="L695">        g.getPlayersVector().copyInto(pa);</span>
<span class="nc" id="L696">        ScenarioDialog sd = new ScenarioDialog(frame, pa);</span>
<span class="nc" id="L697">        sd.setVisible(true);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">        if (!sd.bSet) {</span>
<span class="nc" id="L699">            return;</span>
        }

<span class="nc" id="L702">        HostDialog hd = new HostDialog(frame);</span>
<span class="nc" id="L703">        boolean hasSlot = false;</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">        if (!(&quot;&quot;.equals(sd.localName))) {</span>
<span class="nc" id="L705">            hasSlot = true;</span>
        }
<span class="nc" id="L707">        hd.setPlayerName(sd.localName);</span>
<span class="nc" id="L708">        hd.setVisible(true);</span>

<span class="nc bnc" id="L710" title="All 2 branches missed.">        if (!hd.dataValidation(&quot;MegaMek.HostScenarioAlert.title&quot;)) {</span>
<span class="nc" id="L711">            return;</span>
        }

<span class="nc" id="L714">        sd.localName = hd.getPlayerName();</span>

        // kick off a RNG check
<span class="nc" id="L717">        Compute.d6();</span>

        // start server
        try {
<span class="nc" id="L721">            server = new Server(hd.getServerPass(), hd.getPort());</span>
<span class="nc" id="L722">        } catch (Exception ex) {</span>
<span class="nc" id="L723">            MegaMek.getLogger().error(&quot;Could not create server socket on port &quot; + hd.getPort(), ex);</span>
<span class="nc" id="L724">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L725">                    Messages.getFormattedString(&quot;MegaMek.StartServerError&quot;, hd.getPort(), ex.getMessage()),</span>
<span class="nc" id="L726">                    Messages.getString(&quot;MegaMek.HostScenarioAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L727">            return;</span>
<span class="nc" id="L728">        }</span>
<span class="nc" id="L729">        server.setGame(g);</span>

        // apply any scenario damage
<span class="nc" id="L732">        sl.applyDamage(server);</span>
<span class="nc" id="L733">        ClientGUI gui = null;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">        if (!&quot;&quot;.equals(sd.localName)) {</span>
            // initialize game
<span class="nc" id="L736">            client = new Client(hd.getPlayerName(), &quot;localhost&quot;, hd.getPort());</span>
<span class="nc" id="L737">            gui = new ClientGUI(client, controller);</span>
<span class="nc" id="L738">            controller.clientgui = gui;</span>
<span class="nc" id="L739">            gui.initialize();</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">            if (!client.connect()) {</span>
<span class="nc" id="L741">                JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L742">                        Messages.getFormattedString(&quot;MegaMek.ServerConnectionError&quot;, &quot;localhost&quot;, hd.getPort()),</span>
<span class="nc" id="L743">                        Messages.getString(&quot;MegaMek.HostScenarioAlert.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L744">                frame.setVisible(false);</span>
<span class="nc" id="L745">                client.die();</span>
            }
        }
<span class="nc" id="L748">        optionsDialog = null;</span>

        // calculate initial BV
<span class="nc" id="L751">        server.calculatePlayerInitialCounts();</span>
        
        // setup any bots
<span class="nc bnc" id="L754" title="All 2 branches missed.">        for (int x = 0; x &lt; pa.length; x++) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (sd.playerTypes[x] == ScenarioDialog.T_BOT) {</span>
<span class="nc" id="L756">                MegaMek.getLogger().info(&quot;Adding bot &quot;  + pa[x].getName() + &quot; as Princess&quot;);</span>
<span class="nc" id="L757">                BotClient c = new Princess(pa[x].getName(), &quot;localhost&quot;, hd.getPort(), LogLevel.ERROR);</span>
<span class="nc" id="L758">                c.getGame().addGameListener(new BotGUI(c));</span>
<span class="nc" id="L759">                c.connect();                </span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">            } else if (sd.playerTypes[x] == ScenarioDialog.T_OBOT) {</span>
<span class="nc" id="L761">                MegaMek.getLogger().info(&quot;Adding bot &quot;  + pa[x].getName() + &quot; as TestBot&quot;);</span>
<span class="nc" id="L762">                BotClient c = new TestBot(pa[x].getName(), &quot;localhost&quot;, hd.getPort());</span>
<span class="nc" id="L763">                c.getGame().addGameListener(new BotGUI(c));</span>
<span class="nc" id="L764">                c.connect();</span>
            }
        }

        // If he didn't have a name when hasSlot was set, then the host should
        // be an observer.
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (!hasSlot) {</span>
<span class="nc" id="L771">            Enumeration&lt;IPlayer&gt; pE = server.getGame().getPlayers();</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">            while (pE.hasMoreElements()) {</span>
<span class="nc" id="L773">                IPlayer tmpP = pE.nextElement();</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">                if (tmpP.getName().equals(sd.localName)) {</span>
<span class="nc" id="L775">                    tmpP.setObserver(true);</span>
                }
<span class="nc" id="L777">            }</span>
        }
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (gui != null) {</span>
<span class="nc" id="L780">            launch(gui.getFrame());</span>
        }
<span class="nc" id="L782">    }</span>

    /**
     * Connect to to a game and then launch the chat lounge.
     */
    void connect() {
<span class="nc" id="L788">        ConnectDialog cd = new ConnectDialog(frame);</span>
<span class="nc" id="L789">        cd.setVisible(true);</span>

<span class="nc bnc" id="L791" title="All 2 branches missed.">        if (!cd.dataValidation(&quot;MegaMek.ConnectDialog.title&quot;)) {</span>
<span class="nc" id="L792">            return;</span>
        }

        // initialize game
<span class="nc" id="L796">        client = new Client(cd.getPlayerName(), cd.getServerAddress(), cd.getPort());</span>
<span class="nc" id="L797">        ClientGUI gui = new ClientGUI(client, controller);</span>
<span class="nc" id="L798">        controller.clientgui = gui;</span>
<span class="nc" id="L799">        frame.setCursor(new Cursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L800">        gui.initialize();</span>
<span class="nc" id="L801">        frame.setCursor(new Cursor(Cursor.DEFAULT_CURSOR));</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">        if (!client.connect()) {</span>
<span class="nc" id="L803">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L804">                    Messages.getFormattedString(&quot;MegaMek.ServerConnectionError&quot;, cd.getServerAddress(), cd.getPort()),</span>
<span class="nc" id="L805">                    Messages.getString(&quot;MegaMek.ConnectDialog.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L806">            frame.setVisible(false);</span>
<span class="nc" id="L807">            client.die();</span>
        }
<span class="nc" id="L809">        launch(gui.getFrame());</span>
<span class="nc" id="L810">    }</span>

    void connectBot() {
<span class="nc" id="L813">        ConnectDialog cd = new ConnectDialog(frame);</span>
<span class="nc" id="L814">        cd.setVisible(true);</span>

<span class="nc bnc" id="L816" title="All 2 branches missed.">        if (!cd.dataValidation(&quot;MegaMek.ConnectDialog.title&quot;)) {</span>
<span class="nc" id="L817">            return;</span>
        }

        // initialize game
<span class="nc" id="L821">        BotConfigDialog bcd = new BotConfigDialog(frame);</span>
<span class="nc" id="L822">        bcd.setVisible(true);</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">        if (bcd.dialogAborted) {</span>
<span class="nc" id="L824">            return; // user didn't click 'ok', add no bot</span>
        }
<span class="nc" id="L826">        client = bcd.getSelectedBot(cd.getServerAddress(), cd.getPort());</span>
<span class="nc" id="L827">        client.getGame().addGameListener(new BotGUI((BotClient) client));</span>
<span class="nc" id="L828">        ClientGUI gui = new ClientGUI(client, controller);</span>
<span class="nc" id="L829">        controller.clientgui = gui;</span>
<span class="nc" id="L830">        gui.initialize();</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (!client.connect()) {</span>
<span class="nc" id="L832">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L833">                    Messages.getFormattedString(&quot;MegaMek.ServerConnectionError&quot;, cd.getServerAddress(), cd.getPort()),</span>
<span class="nc" id="L834">                    Messages.getString(&quot;MegaMek.ConnectDialog.title&quot;), JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L835">            frame.setVisible(false);</span>
<span class="nc" id="L836">            client.die();</span>
        }
<span class="nc" id="L838">        launch(gui.getFrame());</span>
<span class="nc" id="L839">    }</span>

    private void addBag(JComponent comp, GridBagLayout gridbag, GridBagConstraints c) {
<span class="nc" id="L842">        gridbag.setConstraints(comp, c);</span>
<span class="nc" id="L843">        frame.getContentPane().add(comp);</span>
<span class="nc" id="L844">    }</span>

    /**
     * Called when the user selects the &quot;Help-&gt;About&quot; menu item.
     */
    void showAbout() {
        // Do we need to create the &quot;about&quot; dialog?
<span class="nc bnc" id="L851" title="All 2 branches missed.">        if (about == null) {</span>
<span class="nc" id="L852">            about = new CommonAboutDialog(frame);</span>
        }

        // Show the about dialog.
<span class="nc" id="L856">        about.setVisible(true);</span>
<span class="nc" id="L857">    }</span>

    private void showSkinningHowTo() {
        try {
            // Get the correct help file.
<span class="nc" id="L862">            StringBuilder helpPath = new StringBuilder(&quot;file:///&quot;);</span>
<span class="nc" id="L863">            helpPath.append(System.getProperty(&quot;user.dir&quot;));</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">            if (!helpPath.toString().endsWith(File.separator)) {</span>
<span class="nc" id="L865">                helpPath.append(File.separator);</span>
            }
<span class="nc" id="L867">            helpPath.append(Messages.getString(&quot;ClientGUI.skinningHelpPath&quot;));</span>
<span class="nc" id="L868">            URL helpUrl = new URL(helpPath.toString());</span>

            // Launch the help dialog.
<span class="nc" id="L871">            HelpDialog helpDialog = new HelpDialog(</span>
<span class="nc" id="L872">                    Messages.getString(&quot;ClientGUI.skinningHelpPath.title&quot;),</span>
                    helpUrl);
<span class="nc" id="L874">            helpDialog.setVisible(true);</span>
<span class="nc" id="L875">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L876">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L877">        }</span>
<span class="nc" id="L878">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Client Settings&quot; menu item.
     */
    void showSettings() {
        // Do we need to create the &quot;settings&quot; dialog?
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if (settingsDialog == null) {</span>
<span class="nc" id="L886">            settingsDialog = new CommonSettingsDialog(frame);</span>
        }

        // Show the settings dialog.
<span class="nc" id="L890">        settingsDialog.setVisible(true);</span>
<span class="nc" id="L891">    }</span>

    /**
     * Called when the quit buttons is pressed or the main menu is closed.
     */
    static void quit() {
<span class="nc" id="L897">        MegaMek.getPreferences().saveToFile(MegaMek.PREFERENCES_FILE);</span>
<span class="nc" id="L898">        PreferenceManager.getInstance().save();</span>

        try {
<span class="nc" id="L901">            WeaponOrderHandler.saveWeaponOrderFile();</span>
<span class="nc" id="L902">        } catch (IOException e) {</span>
<span class="nc" id="L903">            MegaMek.getLogger().error(&quot;Error saving custom weapon orders!&quot;, e);</span>
<span class="nc" id="L904">        }</span>

        try {
<span class="nc" id="L907">            QuirksHandler.saveCustomQuirksList();</span>
<span class="nc" id="L908">        } catch (IOException e) {</span>
<span class="nc" id="L909">            MegaMek.getLogger().error(&quot;Error saving quirks override!&quot;, e);</span>
<span class="nc" id="L910">        }</span>

<span class="nc" id="L912">        System.exit(0);</span>
<span class="nc" id="L913">    }</span>

    /**
     * Hides this window for later. Listens to the frame until it closes, then
     * calls unlaunch().
     */
    private void launch(JFrame launched) {
        // listen to new frame
<span class="nc" id="L921">        launched.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosed(WindowEvent e) {
<span class="nc" id="L924">                unlaunch();</span>
<span class="nc" id="L925">            }</span>
        });
        // hide menu frame
<span class="nc" id="L928">        frame.setVisible(false);</span>
<span class="nc" id="L929">    }</span>

    /**
     * Un-hides the main menu and tries to clean up the client or server.
     */
    void unlaunch() {
        // clean up server, if we have one
<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (server != null) {</span>
<span class="nc" id="L937">            server.die();</span>
<span class="nc" id="L938">            server = null;</span>
        }
        // show menu frame
<span class="nc" id="L941">        frame.setVisible(true);</span>

        // just to free some memory
<span class="nc" id="L944">        client = null;</span>
<span class="nc" id="L945">        System.gc();</span>
<span class="nc" id="L946">        System.runFinalization();</span>
<span class="nc" id="L947">    }</span>
    
<span class="nc" id="L949">    private ActionListener actionListener = ev -&gt; {</span>
<span class="nc bnc" id="L950" title="All 15 branches missed.">        switch (ev.getActionCommand()) {</span>
            case ClientGUI.FILE_BOARD_NEW:
<span class="nc" id="L952">                showEditor();</span>
<span class="nc" id="L953">                break;</span>
            case ClientGUI.MAIN_SKIN_NEW:
<span class="nc" id="L955">                showSkinEditor();</span>
<span class="nc" id="L956">                break;</span>
            case ClientGUI.FILE_BOARD_OPEN:
<span class="nc" id="L958">                showEditorOpen();</span>
<span class="nc" id="L959">                break;</span>
            case ClientGUI.FILE_GAME_NEW:
<span class="nc" id="L961">                host();</span>
<span class="nc" id="L962">                break;</span>
            case ClientGUI.FILE_GAME_SCENARIO:
<span class="nc" id="L964">                scenario();</span>
<span class="nc" id="L965">                break;</span>
            case ClientGUI.FILE_GAME_CONNECT:
<span class="nc" id="L967">                connect();</span>
<span class="nc" id="L968">                break;</span>
            case ClientGUI.FILE_GAME_CONNECT_BOT:
<span class="nc" id="L970">                connectBot();</span>
<span class="nc" id="L971">                break;</span>
            case ClientGUI.FILE_GAME_OPEN:
<span class="nc" id="L973">                loadGame();</span>
<span class="nc" id="L974">                break;</span>
            case ClientGUI.VIEW_GAME_OPTIONS:
<span class="nc" id="L976">                showGameOptions();</span>
<span class="nc" id="L977">                break;</span>
            case ClientGUI.HELP_ABOUT:
<span class="nc" id="L979">                showAbout();</span>
<span class="nc" id="L980">                break;</span>
            case ClientGUI.HELP_CONTENTS:
<span class="nc" id="L982">                new MMReadMeHelpDialog(frame).setVisible(true);</span>
<span class="nc" id="L983">                break;</span>
            case ClientGUI.HELP_SKINNING:
<span class="nc" id="L985">                showSkinningHowTo();</span>
<span class="nc" id="L986">                break;</span>
            case ClientGUI.VIEW_CLIENT_SETTINGS:
<span class="nc" id="L988">                showSettings();</span>
<span class="nc" id="L989">                break;</span>
            case ClientGUI.MAIN_QUIT:
<span class="nc" id="L991">                quit();</span>
                break;
        }
<span class="nc" id="L994">    };</span>

    @Override
    public void preferenceChange(PreferenceChangeEvent e) {
        // Update to reflect new skin
<span class="nc bnc" id="L999" title="All 2 branches missed.">        if (e.getName().equals(GUIPreferences.SKIN_FILE)) {</span>
<span class="nc" id="L1000">            showMainMenu();</span>
<span class="nc" id="L1001">            frame.repaint();</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">        } else if (e.getName().equals(GUIPreferences.UI_THEME)) {</span>
            try {
<span class="nc" id="L1004">                UIManager.setLookAndFeel((String)e.getNewValue());</span>
                // We went all Oprah and gave everybody frames...
                // so now we have to let everybody who got a frame
                // under their chair know that we updated our look
                // and feel.
<span class="nc bnc" id="L1009" title="All 2 branches missed.">                for (Frame f : Frame.getFrames()) {</span>
<span class="nc" id="L1010">                    SwingUtilities.updateComponentTreeUI(f);</span>
                }
                // ...and also all of our windows and dialogs, etc.
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                for (Window w : Window.getWindows()) {</span>
<span class="nc" id="L1014">                    SwingUtilities.updateComponentTreeUI(w);</span>
                }
<span class="nc" id="L1016">            } catch (Exception ex) {</span>
<span class="nc" id="L1017">                MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L1018">            }</span>
        }
<span class="nc" id="L1020">    }</span>
    
    /**
     * Method used to determine the appropriate splash screen to use. This method looks 
     * at both the height and the width of the main monitor.
     * 
     * @param splashScreens
     * 		List of available splash screens.
     * @param screenWidth
     * 		Width of the current monitor.
     * @param screenHeight
     * 		Height of the current monitor.
     * @return
     * 		String that represents the splash screen that should be displayed.
     */
    private String determineSplashScreen(final List&lt;String&gt; splashScreens, 
            final int screenWidth, final int screenHeight) {
        // Ensure that the list is of appropriate size to contain HD, FHD, and UHD splash
        // screens.
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        if (splashScreens.size() &gt; 3) {</span>
            // Default to the HD splash screen.
<span class="nc" id="L1041">            String splashFileName = splashScreens.get(3);</span>
            // If both height and width is greater than 1080p use the UHD splash screen.
<span class="nc bnc" id="L1043" title="All 4 branches missed.">            if (screenWidth &gt; 1920 &amp;&amp; screenHeight &gt; 1080) {</span>
<span class="nc" id="L1044">                splashFileName = splashScreens.get(2);</span>
            }
            // If both height and width is greater than 720p then use the FHD splash screen.
<span class="nc bnc" id="L1047" title="All 4 branches missed.">            else if (screenWidth &gt; 1280 &amp;&amp; screenHeight &gt; 720)</span>
            {
<span class="nc" id="L1049">                splashFileName = splashScreens.get(0);</span>
            }
<span class="nc" id="L1051">            return splashFileName;</span>
        }
        // List of splash screens is not complete so default to the first splash screen.
<span class="nc" id="L1054">        return splashScreens.get(0);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>