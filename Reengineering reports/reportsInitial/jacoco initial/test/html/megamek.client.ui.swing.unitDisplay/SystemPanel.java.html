<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SystemPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing.unitDisplay</a> &gt; <span class="el_source">SystemPanel.java</span></div><h1>SystemPanel.java</h1><pre class="source lang-java linenums">package megamek.client.ui.swing.unitDisplay;

import java.awt.Color;
import java.awt.Dimension;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Image;
import java.awt.Insets;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.util.Enumeration;
import java.util.Vector;

import javax.swing.DefaultComboBoxModel;
import javax.swing.DefaultListModel;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JScrollPane;
import javax.swing.ListSelectionModel;
import javax.swing.SwingConstants;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

import megamek.client.Client;
import megamek.client.ui.Messages;
import megamek.client.ui.swing.ChoiceDialog;
import megamek.client.ui.swing.ClientGUI;
import megamek.client.ui.swing.widget.BackGroundDrawer;
import megamek.client.ui.swing.widget.PMUtil;
import megamek.client.ui.swing.widget.PicMap;
import megamek.client.ui.swing.widget.SkinXMLHandler;
import megamek.client.ui.swing.widget.UnitDisplaySkinSpecification;
import megamek.common.Aero;
import megamek.common.AmmoType;
import megamek.common.BattleArmor;
import megamek.common.Configuration;
import megamek.common.CriticalSlot;
import megamek.common.Entity;
import megamek.common.EquipmentMode;
import megamek.common.IGame;
import megamek.common.ILocationExposureStatus;
import megamek.common.Mech;
import megamek.common.MiscType;
import megamek.common.Mounted;
import megamek.common.Protomech;
import megamek.common.Tank;
import megamek.common.WeaponType;
import megamek.common.options.OptionsConstants;
import megamek.common.util.fileUtils.MegaMekFile;

/**
 * This class shows the critical hits and systems for a mech
 */
class SystemPanel extends PicMap implements ItemListener, ActionListener,
        ListSelectionListener {
    
<span class="nc" id="L62">    private static int LOC_ALL_EQUIP = 0;</span>
<span class="nc" id="L63">    private static int LOC_ALL_WEAPS = 1;</span>
<span class="nc" id="L64">    private static int LOC_SPACER = 2;</span>
<span class="nc" id="L65">    private static int LOC_OFFSET = 3;</span>
    
    /**
     * 
     */
    private final UnitDisplay unitDisplay;

    /**
     *
     */
    private static final long serialVersionUID = 6660316427898323590L;

    private JLabel locLabel;
    private JLabel slotLabel;
    private JLabel modeLabel;
    private JLabel unitLabel;
    private JList&lt;String&gt; slotList;
    private JList&lt;String&gt; locList;
    private JList&lt;String&gt; unitList;

    private JComboBox&lt;String&gt; m_chMode;
    private JButton m_bDumpAmmo;

    private Entity en;
<span class="nc" id="L89">    private Vector&lt;Entity&gt; entities = new Vector&lt;Entity&gt;();</span>

<span class="nc" id="L91">    private int minTopMargin = 8;</span>
<span class="nc" id="L92">    private int minLeftMargin = 8;</span>

<span class="nc" id="L94">    SystemPanel(UnitDisplay unitDisplay) {</span>
<span class="nc" id="L95">        this.unitDisplay = unitDisplay;</span>
<span class="nc" id="L96">        locLabel = new JLabel(</span>
<span class="nc" id="L97">                Messages.getString(&quot;MechDisplay.Location&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L98">        locLabel.setOpaque(false);</span>
<span class="nc" id="L99">        locLabel.setForeground(Color.WHITE);</span>
<span class="nc" id="L100">        slotLabel = new JLabel(</span>
<span class="nc" id="L101">                Messages.getString(&quot;MechDisplay.Slot&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L102">        slotLabel.setOpaque(false);</span>
<span class="nc" id="L103">        slotLabel.setForeground(Color.WHITE);</span>

<span class="nc" id="L105">        unitLabel = new JLabel(</span>
<span class="nc" id="L106">                Messages.getString(&quot;MechDisplay.Unit&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L107">        unitLabel.setOpaque(false);</span>
<span class="nc" id="L108">        unitLabel.setForeground(Color.WHITE);</span>

<span class="nc" id="L110">        locList = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</span>
<span class="nc" id="L111">        locList.setOpaque(false);</span>
<span class="nc" id="L112">        locList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>

<span class="nc" id="L114">        slotList = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</span>
<span class="nc" id="L115">        slotList.setOpaque(false);</span>
<span class="nc" id="L116">        slotList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>

<span class="nc" id="L118">        unitList = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</span>
<span class="nc" id="L119">        unitList.setOpaque(false);</span>

<span class="nc" id="L121">        m_chMode = new JComboBox&lt;String&gt;();</span>
<span class="nc" id="L122">        m_chMode.addItem(&quot;   &quot;); //$NON-NLS-1$</span>
<span class="nc" id="L123">        m_chMode.setEnabled(false);</span>

<span class="nc" id="L125">        m_bDumpAmmo = new JButton(</span>
<span class="nc" id="L126">                Messages.getString(&quot;MechDisplay.m_bDumpAmmo&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L127">        m_bDumpAmmo.setEnabled(false);</span>
<span class="nc" id="L128">        m_bDumpAmmo.setActionCommand(&quot;dump&quot;); //$NON-NLS-1$</span>

<span class="nc" id="L130">        modeLabel = new JLabel(</span>
<span class="nc" id="L131">                Messages.getString(&quot;MechDisplay.modeLabel&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>
<span class="nc" id="L132">        modeLabel.setOpaque(false);</span>
<span class="nc" id="L133">        modeLabel.setForeground(Color.WHITE);</span>
        // modeLabel.setEnabled(false);

        // layout main panel
<span class="nc" id="L137">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L138">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L139">        setLayout(gridbag);</span>

<span class="nc" id="L141">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L142">        c.insets = new Insets(15, 9, 1, 1);</span>
<span class="nc" id="L143">        c.gridy = 0;</span>
<span class="nc" id="L144">        c.gridx = 0;</span>
<span class="nc" id="L145">        c.weightx = 0.5;</span>
<span class="nc" id="L146">        c.weighty = 0.0;</span>
<span class="nc" id="L147">        c.gridwidth = 1;</span>
<span class="nc" id="L148">        c.gridheight = 1;</span>
<span class="nc" id="L149">        gridbag.setConstraints(locLabel, c);</span>
<span class="nc" id="L150">        add(locLabel);</span>

<span class="nc" id="L152">        c.weightx = 0.0;</span>
<span class="nc" id="L153">        c.gridy = 0;</span>
<span class="nc" id="L154">        c.gridx = 1;</span>
<span class="nc" id="L155">        c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L156">        c.insets = new Insets(15, 1, 1, 9);</span>
<span class="nc" id="L157">        gridbag.setConstraints(slotLabel, c);</span>
<span class="nc" id="L158">        add(slotLabel);</span>

<span class="nc" id="L160">        c.weightx = 0.5;</span>
        // c.weighty = 1.0;
<span class="nc" id="L162">        c.gridy = 1;</span>
<span class="nc" id="L163">        c.gridx = 0;</span>
<span class="nc" id="L164">        c.gridwidth = 1;</span>
<span class="nc" id="L165">        c.insets = new Insets(1, 9, 15, 1);</span>
<span class="nc" id="L166">        c.gridheight = 1;</span>
<span class="nc" id="L167">        gridbag.setConstraints(locList, c);</span>
<span class="nc" id="L168">        add(locList);</span>

<span class="nc" id="L170">        c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L171">        c.insets = new Insets(15, 9, 1, 1);</span>
<span class="nc" id="L172">        c.gridy = 2;</span>
<span class="nc" id="L173">        c.gridx = 0;</span>
<span class="nc" id="L174">        c.weightx = 0.5;</span>
<span class="nc" id="L175">        c.weighty = 0.0;</span>
<span class="nc" id="L176">        c.gridwidth = 1;</span>
<span class="nc" id="L177">        c.gridheight = 1;</span>
<span class="nc" id="L178">        gridbag.setConstraints(unitLabel, c);</span>
<span class="nc" id="L179">        add(unitLabel);</span>

<span class="nc" id="L181">        c.weightx = 0.5;</span>
        // c.weighty = 1.0;
<span class="nc" id="L183">        c.gridy = 3;</span>
<span class="nc" id="L184">        c.gridx = 0;</span>
<span class="nc" id="L185">        c.gridwidth = 1;</span>
<span class="nc" id="L186">        c.insets = new Insets(1, 9, 15, 1);</span>
<span class="nc" id="L187">        c.gridheight = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L188">        gridbag.setConstraints(unitList, c);</span>
<span class="nc" id="L189">        add(unitList);</span>

<span class="nc" id="L191">        c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L192">        c.gridheight = 1;</span>
<span class="nc" id="L193">        c.gridy = 1;</span>
<span class="nc" id="L194">        c.gridx = 1;</span>
<span class="nc" id="L195">        c.weightx = 0.0;</span>
<span class="nc" id="L196">        c.weighty = 1.0;</span>
<span class="nc" id="L197">        c.insets = new Insets(1, 1, 1, 9);</span>
<span class="nc" id="L198">        JScrollPane tSlotScroll = new JScrollPane(slotList);</span>
<span class="nc" id="L199">        tSlotScroll.setMinimumSize(new Dimension(200, 100));</span>
<span class="nc" id="L200">        gridbag.setConstraints(tSlotScroll, c);</span>
<span class="nc" id="L201">        add(tSlotScroll);</span>

<span class="nc" id="L203">        c.gridwidth = 1;</span>
<span class="nc" id="L204">        c.gridy = 2;</span>
<span class="nc" id="L205">        c.gridx = 1;</span>
<span class="nc" id="L206">        c.weightx = 0.0;</span>
<span class="nc" id="L207">        c.weighty = 0.0;</span>
<span class="nc" id="L208">        gridbag.setConstraints(modeLabel, c);</span>
<span class="nc" id="L209">        c.insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L210">        add(modeLabel);</span>

<span class="nc" id="L212">        c.weightx = 1.0;</span>
<span class="nc" id="L213">        c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L214">        c.gridy = 2;</span>
<span class="nc" id="L215">        c.gridx = 2;</span>
<span class="nc" id="L216">        c.insets = new Insets(1, 1, 1, 9);</span>
<span class="nc" id="L217">        gridbag.setConstraints(m_chMode, c);</span>
<span class="nc" id="L218">        add(m_chMode);</span>

<span class="nc" id="L220">        c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L221">        c.gridheight = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L222">        c.gridy = 3;</span>
<span class="nc" id="L223">        c.gridx = 1;</span>
<span class="nc" id="L224">        c.insets = new Insets(4, 4, 15, 9);</span>
<span class="nc" id="L225">        gridbag.setConstraints(m_bDumpAmmo, c);</span>
<span class="nc" id="L226">        add(m_bDumpAmmo);</span>

<span class="nc" id="L228">        setBackGround();</span>
<span class="nc" id="L229">        onResize();</span>
        
<span class="nc" id="L231">        addListeners();</span>
<span class="nc" id="L232">    }</span>

    @Override
    public void onResize() {
<span class="nc" id="L236">        int w = getSize().width;</span>
<span class="nc" id="L237">        Rectangle r = getContentBounds();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (r == null) {</span>
<span class="nc" id="L239">            return;</span>
        }
<span class="nc" id="L241">        int dx = Math.round(((w - r.width) / 2));</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (dx &lt; minLeftMargin) {</span>
<span class="nc" id="L243">            dx = minLeftMargin;</span>
        }
<span class="nc" id="L245">        int dy = minTopMargin;</span>
<span class="nc" id="L246">        setContentMargins(dx, dy, dx, dy);</span>
<span class="nc" id="L247">    }</span>

    private CriticalSlot getSelectedCritical() {
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if ((locList.getSelectedIndex() == LOC_ALL_EQUIP)</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                || (locList.getSelectedIndex() == LOC_ALL_WEAPS)</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                || (locList.getSelectedIndex() == LOC_SPACER)) {</span>
<span class="nc" id="L253">            return null;</span>
        }
<span class="nc" id="L255">        int loc = locList.getSelectedIndex();</span>
<span class="nc" id="L256">        int slot = slotList.getSelectedIndex();</span>
<span class="nc" id="L257">        loc -= LOC_OFFSET;</span>
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if ((loc == -1) || (slot == -1)) {</span>
<span class="nc" id="L259">            return null;</span>
        }
<span class="nc" id="L261">        return en.getCritical(loc, slot);</span>
    }

    private Mounted getSelectedEquipment() {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if ((locList.getSelectedIndex() == LOC_ALL_EQUIP)) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (slotList.getSelectedIndex() != -1) { </span>
<span class="nc" id="L267">                return en.getMisc().get(slotList.getSelectedIndex());</span>
            } else {
<span class="nc" id="L269">                return null;</span>
            }
        }
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (locList.getSelectedIndex() == LOC_ALL_WEAPS) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (slotList.getSelectedIndex() != -1) { </span>
<span class="nc" id="L274">                return en.getWeaponList().get(slotList.getSelectedIndex());</span>
            } else {
<span class="nc" id="L276">                return null;</span>
            }
        }
        
<span class="nc" id="L280">        final CriticalSlot cs = getSelectedCritical();</span>
<span class="nc bnc" id="L281" title="All 4 branches missed.">        if ((cs == null) || (unitDisplay.getClientGUI() == null)) {</span>
<span class="nc" id="L282">            return null;</span>
        }
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (cs.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
<span class="nc" id="L285">            return null;</span>
        }
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if ((cs.getMount().getType() instanceof MiscType)</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">                &amp;&amp; cs.getMount().getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc" id="L289">            Mounted m = cs.getMount();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            while (m.getLinked() != null) {</span>
<span class="nc" id="L291">                m = m.getLinked();</span>
            }
<span class="nc" id="L293">            return m;</span>
        }
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (cs.getMount2() != null) {</span>
<span class="nc" id="L296">            ChoiceDialog choiceDialog = new ChoiceDialog(unitDisplay.getClientGUI().frame,</span>
<span class="nc" id="L297">                    Messages.getString(&quot;MechDisplay.SelectMulti.title&quot;),</span>
<span class="nc" id="L298">                    Messages.getString(&quot;MechDisplay.SelectMulti.question&quot;),</span>
<span class="nc" id="L299">                    new String[] { cs.getMount().getName(),</span>
<span class="nc" id="L300">                            cs.getMount2().getName() }, true);</span>
<span class="nc" id="L301">            choiceDialog.setVisible(true);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            if (choiceDialog.getAnswer() == true) {</span>
                // load up the choices
<span class="nc" id="L304">                int[] toDump = choiceDialog.getChoices();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                if (toDump[0] == 0) {</span>
<span class="nc" id="L306">                    return cs.getMount();</span>
                } else {
<span class="nc" id="L308">                    return cs.getMount2();</span>
                }
            }
        }
<span class="nc" id="L312">        return cs.getMount();</span>
    }

    private Entity getSelectedEntity() {
<span class="nc" id="L316">        int unit = unitList.getSelectedIndex();</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">        if ((unit == -1) || (unit &gt; entities.size())) {</span>
<span class="nc" id="L318">            return null;</span>
        }
<span class="nc" id="L320">        return entities.elementAt(unit);</span>
    }

    /**
     * updates fields for the specified mech
     */
    public void displayMech(Entity newEntity) {
<span class="nc" id="L327">        en = newEntity;</span>
<span class="nc" id="L328">        entities.clear();</span>
<span class="nc" id="L329">        entities.add(newEntity);</span>
<span class="nc" id="L330">        removeListeners();</span>
<span class="nc" id="L331">        ((DefaultListModel&lt;String&gt;) unitList.getModel())</span>
<span class="nc" id="L332">                .removeAllElements();</span>
<span class="nc" id="L333">        ((DefaultListModel&lt;String&gt;) unitList.getModel())</span>
<span class="nc" id="L334">                .addElement(Messages.getString(&quot;MechDisplay.Ego&quot;));</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        for (Entity loadee : newEntity.getLoadedUnits()) {</span>
<span class="nc" id="L336">            ((DefaultListModel&lt;String&gt;) unitList.getModel())</span>
<span class="nc" id="L337">                    .addElement(loadee.getModel());</span>
<span class="nc" id="L338">            entities.add(loadee);</span>
<span class="nc" id="L339">        }</span>
<span class="nc" id="L340">        unitList.setSelectedIndex(0);</span>
<span class="nc" id="L341">        displayLocations();</span>
<span class="nc" id="L342">        addListeners();</span>
<span class="nc" id="L343">    }</span>
    
    public void selectLocation(int loc) {
<span class="nc" id="L346">        locList.setSelectedIndex(loc + LOC_OFFSET);</span>
<span class="nc" id="L347">    }</span>

    private void displayLocations() {
<span class="nc" id="L350">        DefaultListModel&lt;String&gt; locModel = ((DefaultListModel&lt;String&gt;) locList</span>
<span class="nc" id="L351">                .getModel());</span>
<span class="nc" id="L352">        locModel.removeAllElements();</span>
<span class="nc" id="L353">        locModel.insertElementAt(</span>
<span class="nc" id="L354">                Messages.getString(&quot;MechDisplay.AllEquipment&quot;), LOC_ALL_EQUIP);</span>
<span class="nc" id="L355">        locModel.insertElementAt(</span>
<span class="nc" id="L356">                Messages.getString(&quot;MechDisplay.AllWeapons&quot;), LOC_ALL_WEAPS);</span>
<span class="nc" id="L357">        locModel.insertElementAt(&quot;-----&quot;, LOC_SPACER);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        for (int loc = 0; loc &lt; en.locations(); loc++) {</span>
<span class="nc" id="L359">            int idx = loc + LOC_OFFSET;</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (en.getNumberOfCriticals(loc) &gt; 0) {</span>
<span class="nc" id="L361">                locModel.insertElementAt(en.getLocationName(loc), idx);</span>
            }
        }
<span class="nc" id="L364">        locList.setSelectedIndex(0);</span>
<span class="nc" id="L365">        displaySlots();</span>
<span class="nc" id="L366">    }</span>

    private void displaySlots() {
<span class="nc" id="L369">        int loc = locList.getSelectedIndex();</span>
<span class="nc" id="L370">        DefaultListModel&lt;String&gt; slotModel = </span>
<span class="nc" id="L371">                ((DefaultListModel&lt;String&gt;) slotList.getModel()); </span>
<span class="nc" id="L372">        slotModel.removeAllElements();        </span>
        
        // Display all Equipment
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (loc == LOC_ALL_EQUIP) {</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">            for (Mounted m : en.getMisc()) {</span>
<span class="nc" id="L377">                slotModel.addElement(getMountedDisplay(m, loc));</span>
<span class="nc" id="L378">            }</span>
<span class="nc" id="L379">            return;</span>
        }
        
        // Display all Weapons
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (loc == LOC_ALL_WEAPS) {</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            for (Mounted m : en.getWeaponList()) {</span>
<span class="nc" id="L385">                slotModel.addElement(getMountedDisplay(m, loc));</span>
<span class="nc" id="L386">            }</span>
<span class="nc" id="L387">            return;</span>
        }
        
        // Display nothing for a spacer
<span class="nc bnc" id="L391" title="All 2 branches missed.">        if (loc == LOC_SPACER) {</span>
<span class="nc" id="L392">            return;</span>
        }        

        // Standard location handling
<span class="nc" id="L396">        loc -= LOC_OFFSET;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L398">            final CriticalSlot cs = en.getCritical(loc, i);</span>
<span class="nc" id="L399">            StringBuffer sb = new StringBuffer(32);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L401">                sb.append(&quot;---&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc bnc" id="L403" title="All 3 branches missed.">                switch (cs.getType()) {</span>
                    case CriticalSlot.TYPE_SYSTEM:
<span class="nc bnc" id="L405" title="All 4 branches missed.">                        if (cs.isDestroyed() || cs.isMissing()) {</span>
<span class="nc" id="L406">                            sb.append(&quot;*&quot;); //$NON-NLS-1$</span>
                        }
<span class="nc bnc" id="L408" title="All 2 branches missed.">                        if (cs.isBreached()) {</span>
<span class="nc" id="L409">                            sb.append(&quot;x&quot;); //$NON-NLS-1$</span>
                        }
                        // Protomechs have different system names.
<span class="nc bnc" id="L412" title="All 2 branches missed.">                        if (en instanceof Protomech) {</span>
<span class="nc" id="L413">                            sb.append(Protomech.systemNames[cs.getIndex()]);</span>
                        } else {
<span class="nc" id="L415">                            sb.append(((Mech) en).getSystemName(cs</span>
<span class="nc" id="L416">                                    .getIndex()));</span>
                        }
<span class="nc" id="L418">                        break;</span>
                    case CriticalSlot.TYPE_EQUIPMENT:
<span class="nc" id="L420">                        sb.append(getMountedDisplay(cs.getMount(), loc, cs));</span>
<span class="nc" id="L421">                        break;</span>
                    default:
                }
<span class="nc bnc" id="L424" title="All 2 branches missed.">                if (cs.isArmored()) {</span>
<span class="nc" id="L425">                    sb.append(&quot; (armored)&quot;);  //$NON-NLS-1$</span>
                }
            }
<span class="nc" id="L428">            slotModel.addElement(sb.toString());</span>
        }
<span class="nc" id="L430">        onResize();</span>
<span class="nc" id="L431">    }</span>
    
    private String getMountedDisplay(Mounted m, int loc) {
<span class="nc" id="L434">        return getMountedDisplay(m, loc, null);</span>
    }
    
    private String getMountedDisplay(Mounted m, int loc, CriticalSlot cs) {
<span class="nc" id="L438">        String hotLoaded = Messages.getString(&quot;MechDisplay.isHotLoaded&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L439">        StringBuffer sb = new StringBuffer();</span>
        
<span class="nc" id="L441">        sb.append(m.getDesc());</span>

<span class="nc bnc" id="L443" title="All 4 branches missed.">        if ((cs != null) &amp;&amp; cs.getMount2() != null) {</span>
<span class="nc" id="L444">            sb.append(&quot; &quot;); //$NON-NLS-1$</span>
<span class="nc" id="L445">            sb.append(cs.getMount2().getDesc()); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (m.isHotLoaded()) {</span>
<span class="nc" id="L448">            sb.append(hotLoaded);</span>
        }
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (m.getType().hasModes()) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            if (m.curMode().getDisplayableName().length() &gt; 0) {</span>
<span class="nc" id="L452">                sb.append(&quot; (&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L453">                sb.append(m.curMode().getDisplayableName());</span>
<span class="nc" id="L454">                sb.append(')'); //$NON-NLS-1$</span>
            }
<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (!m.pendingMode().equals(&quot;None&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L457">                sb.append(&quot; (next turn, &quot;); //$NON-NLS-1$</span>
<span class="nc" id="L458">                sb.append(m.pendingMode().getDisplayableName());</span>
<span class="nc" id="L459">                sb.append(')'); //$NON-NLS-1$</span>
            }
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                    &amp;&amp; ((MiscType) m.getType()).isShield()) {</span>
<span class="nc" id="L463">                sb.append(&quot; &quot; //$NON-NLS-1$</span>
<span class="nc" id="L464">                        + m.getDamageAbsorption(en, m.getLocation())</span>
                        + '/' //$NON-NLS-1$
<span class="nc" id="L466">                        + m.getCurrentDamageCapacity(en,</span>
<span class="nc" id="L467">                                m.getLocation()) + ')'); //$NON-NLS-1$</span>
            }
        }
<span class="nc" id="L470">        return sb.toString();</span>
    }

    //
    // ItemListener
    //
    public void itemStateChanged(ItemEvent ev) {
<span class="nc" id="L477">        removeListeners();</span>
        try {
<span class="nc" id="L479">            ClientGUI clientgui = unitDisplay.getClientGUI();</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">            if (clientgui == null) {</span>
<span class="nc" id="L481">                return;</span>
            }
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (ev.getSource().equals(m_chMode)</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                    &amp;&amp; (ev.getStateChange() == ItemEvent.SELECTED)) {</span>
<span class="nc" id="L485">                Mounted m = getSelectedEquipment();</span>
<span class="nc" id="L486">                CriticalSlot cs = getSelectedCritical();</span>
<span class="nc bnc" id="L487" title="All 4 branches missed.">                if ((m != null) &amp;&amp; m.getType().hasModes()) {</span>
<span class="nc" id="L488">                    int nMode = m_chMode.getSelectedIndex();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                    if (nMode &gt;= 0) {</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">                        if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">                                &amp;&amp; ((MiscType) m.getType()).isShield()</span>
<span class="nc" id="L493">                                &amp;&amp; (clientgui.getClient().getGame()</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                                        .getPhase() != IGame.Phase.PHASE_FIRING)) {</span>
<span class="nc" id="L495">                            clientgui.systemMessage(Messages.getString(</span>
                                    &quot;MechDisplay.ShieldModePhase&quot;));//$NON-NLS-1$
<span class="nc" id="L497">                            return;</span>
                        }

<span class="nc bnc" id="L500" title="All 2 branches missed.">                        if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">                                &amp;&amp; ((MiscType) m.getType()).isVibroblade()</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">                                &amp;&amp; (clientgui.getClient().getGame().getPhase()</span>
                                != IGame.Phase.PHASE_PHYSICAL)) {
<span class="nc" id="L504">                            clientgui.systemMessage(Messages.getString(</span>
                                    &quot;MechDisplay.VibrobladeModePhase&quot;));//$NON-NLS-1$
<span class="nc" id="L506">                            return;</span>
                        }

<span class="nc bnc" id="L509" title="All 2 branches missed.">                        if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                                &amp;&amp; m.getType().hasSubType(MiscType.S_RETRACTABLE_BLADE)</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">                                &amp;&amp; (clientgui.getClient().getGame().getPhase() != IGame.Phase.PHASE_MOVEMENT)) {</span>
<span class="nc" id="L512">                            clientgui.systemMessage(Messages.getString(</span>
                                                    &quot;MechDisplay.RetractableBladeModePhase&quot;));//$NON-NLS-1$
<span class="nc" id="L514">                            return;</span>
                        }

                        // Can only charge a capacitor if the weapon has not
                        // been fired.
<span class="nc bnc" id="L519" title="All 2 branches missed.">                        if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                                &amp;&amp; (m.getLinked() != null)</span>
<span class="nc" id="L521">                                &amp;&amp; ((MiscType) m.getType())</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                                        .hasFlag(MiscType.F_PPC_CAPACITOR)</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">                                &amp;&amp; m.getLinked().isUsedThisRound()</span>
                                &amp;&amp; (nMode == 1)) {
<span class="nc" id="L525">                            clientgui.systemMessage(Messages.getString(</span>
                                    &quot;MechDisplay.CapacitorCharging&quot;));//$NON-NLS-1$
<span class="nc" id="L527">                            return;</span>
                        }
<span class="nc" id="L529">                        m.setMode(nMode);</span>
                        // send the event to the server
<span class="nc" id="L531">                        clientgui.getClient().sendModeChange(en.getId(), en.getEquipmentNum(m), nMode);</span>

                        // notify the player
<span class="nc bnc" id="L534" title="All 2 branches missed.">                        if (m.canInstantSwitch(nMode)) {</span>
<span class="nc" id="L535">                            clientgui.systemMessage(Messages.getString(&quot;MechDisplay.switched&quot;,</span>
<span class="nc" id="L536">                                    m.getName(), m.curMode().getDisplayableName()));</span>
<span class="nc" id="L537">                            int weap = this.unitDisplay.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L538">                            this.unitDisplay.wPan.displayMech(en);</span>
<span class="nc" id="L539">                            this.unitDisplay.wPan.selectWeapon(weap);</span>
                            // displaySlots();
<span class="nc" id="L541">                        } else {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                            if (IGame.Phase.PHASE_DEPLOYMENT == clientgui.getClient().getGame().getPhase()) {</span>
<span class="nc" id="L543">                                clientgui.systemMessage(Messages.getString(&quot;MechDisplay.willSwitchAtStart&quot;,</span>
<span class="nc" id="L544">                                        m.getName(), m.pendingMode().getDisplayableName()));</span>
                            } else {
<span class="nc" id="L546">                                clientgui.systemMessage(Messages.getString(&quot;MechDisplay.willSwitchAtEnd&quot;,</span>
<span class="nc" id="L547">                                        m.getName(), m.pendingMode().getDisplayableName()));</span>
                            }
                        }
<span class="nc" id="L550">                        int loc = slotList.getSelectedIndex();</span>
<span class="nc" id="L551">                        displaySlots();</span>
<span class="nc" id="L552">                        slotList.setSelectedIndex(loc);</span>
                    }
<span class="nc bnc" id="L554" title="All 2 branches missed.">                } else if ((cs != null)</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">                        &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L556">                    int nMode = m_chMode.getSelectedIndex();</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">                    if (nMode &gt;= 0) {</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">                        if ((cs.getIndex() == Mech.SYSTEM_COCKPIT)</span>
<span class="nc bnc" id="L559" title="All 4 branches missed.">                                &amp;&amp; en.hasEiCockpit()</span>
                                &amp;&amp; (en instanceof Mech)) {
<span class="nc" id="L561">                            Mech mech = (Mech) en;</span>
<span class="nc" id="L562">                            mech.setCockpitStatus(nMode);</span>
<span class="nc" id="L563">                            clientgui.getClient().sendSystemModeChange(</span>
<span class="nc" id="L564">                                    en.getId(), Mech.SYSTEM_COCKPIT, nMode);</span>
<span class="nc" id="L565">                            if (mech.getCockpitStatus() == mech</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">                                    .getCockpitStatusNextRound()) {</span>
<span class="nc" id="L567">                                clientgui</span>
<span class="nc" id="L568">                                        .systemMessage(Messages</span>
<span class="nc" id="L569">                                                .getString(</span>
                                                        &quot;MechDisplay.switched&quot;,
                                                        new Object[] {
                                                                &quot;Cockpit&quot;,
<span class="nc" id="L573">                                                                m_chMode.getSelectedItem() }));</span>
                                //$NON-NLS-1$
                            } else {
<span class="nc" id="L576">                                clientgui</span>
<span class="nc" id="L577">                                        .systemMessage(Messages</span>
<span class="nc" id="L578">                                                .getString(</span>
                                                        &quot;MechDisplay.willSwitchAtEnd&quot;,
                                                        new Object[] {
                                                                &quot;Cockpit&quot;,
<span class="nc" id="L582">                                                                m_chMode.getSelectedItem() }));</span>
                                //$NON-NLS-1$
                            }
                        }
                    }
                }
            }
<span class="nc" id="L589">            onResize();</span>
        } finally {
<span class="nc" id="L591">            addListeners();</span>
        }
<span class="nc" id="L593">    }</span>

    // ActionListener
    public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L597">        removeListeners();</span>
        try {
<span class="nc" id="L599">            ClientGUI clientgui = unitDisplay.getClientGUI();</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            if (clientgui == null) {</span>
<span class="nc" id="L601">                return;</span>
            }
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (&quot;dump&quot;.equals(ae.getActionCommand())) { //$NON-NLS-1$</span>
<span class="nc" id="L604">                Mounted m = getSelectedEquipment();</span>
<span class="nc" id="L605">                boolean bOwner = clientgui.getClient().getLocalPlayer()</span>
<span class="nc" id="L606">                        .equals(en.getOwner());</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">                if ((m == null) || !bOwner) {</span>
<span class="nc" id="L608">                    return;</span>
                }

                // Check for BA dumping SRM launchers
<span class="nc bnc" id="L612" title="All 4 branches missed.">                if ((en instanceof BattleArmor) &amp;&amp; (!m.isMissing())</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                        &amp;&amp; m.isBodyMounted()</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                        &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                        &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                        &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                    boolean isDumping = !m.isPendingDump();</span>
<span class="nc" id="L618">                    m.setPendingDump(isDumping);</span>
<span class="nc" id="L619">                    clientgui.getClient().sendModeChange(en.getId(),</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">                            en.getEquipmentNum(m), isDumping ? -1 : 0);</span>
<span class="nc" id="L621">                    int selIdx = slotList.getSelectedIndex();</span>
<span class="nc" id="L622">                    displaySlots();</span>
<span class="nc" id="L623">                    slotList.setSelectedIndex(selIdx);</span>
                }

<span class="nc bnc" id="L626" title="All 2 branches missed.">                if (((!(m.getType() instanceof AmmoType) || (m</span>
<span class="nc bnc" id="L627" title="All 4 branches missed.">                        .getUsableShotsLeft() &lt;= 0)) &amp;&amp; !m.isDWPMounted())</span>
<span class="nc bnc" id="L628" title="All 4 branches missed.">                        || (m.isDWPMounted() &amp;&amp; (m.isMissing() == true))) {</span>
<span class="nc" id="L629">                    return;</span>
                }

                boolean bDumping;
                boolean bConfirmed;

<span class="nc bnc" id="L635" title="All 2 branches missed.">                if (m.isPendingDump()) {</span>
<span class="nc" id="L636">                    bDumping = false;</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                    if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L638">                        String title = Messages</span>
<span class="nc" id="L639">                                .getString(&quot;MechDisplay.CancelDumping.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L640">                        String body = Messages</span>
<span class="nc" id="L641">                                .getString(</span>
<span class="nc" id="L642">                                        &quot;MechDisplay.CancelDumping.message&quot;, new Object[] { m.getName() }); //$NON-NLS-1$</span>
<span class="nc" id="L643">                        bConfirmed = clientgui.doYesNoDialog(title, body);</span>
<span class="nc" id="L644">                    } else {</span>
<span class="nc" id="L645">                        String title = Messages</span>
<span class="nc" id="L646">                                .getString(&quot;MechDisplay.CancelJettison.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L647">                        String body = Messages</span>
<span class="nc" id="L648">                                .getString(</span>
<span class="nc" id="L649">                                        &quot;MechDisplay.CancelJettison.message&quot;, new Object[] { m.getName() }); //$NON-NLS-1$</span>
<span class="nc" id="L650">                        bConfirmed = clientgui.doYesNoDialog(title, body);</span>
<span class="nc" id="L651">                    }</span>
                } else {
<span class="nc" id="L653">                    bDumping = true;</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                    if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L655">                        String title = Messages</span>
<span class="nc" id="L656">                                .getString(&quot;MechDisplay.Dump.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L657">                        String body = Messages</span>
<span class="nc" id="L658">                                .getString(</span>
<span class="nc" id="L659">                                        &quot;MechDisplay.Dump.message&quot;, new Object[] { m.getName() }); //$NON-NLS-1$</span>
<span class="nc" id="L660">                        bConfirmed = clientgui.doYesNoDialog(title, body);</span>
<span class="nc" id="L661">                    } else {</span>
<span class="nc" id="L662">                        String title = Messages</span>
<span class="nc" id="L663">                                .getString(&quot;MechDisplay.Jettison.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L664">                        String body = Messages</span>
<span class="nc" id="L665">                                .getString(</span>
<span class="nc" id="L666">                                        &quot;MechDisplay.Jettison.message&quot;, new Object[] { m.getName() }); //$NON-NLS-1$</span>
<span class="nc" id="L667">                        bConfirmed = clientgui.doYesNoDialog(title, body);</span>
                    }

                }

<span class="nc bnc" id="L672" title="All 2 branches missed.">                if (bConfirmed) {</span>
<span class="nc" id="L673">                    m.setPendingDump(bDumping);</span>
<span class="nc" id="L674">                    clientgui.getClient().sendModeChange(en.getId(),</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">                            en.getEquipmentNum(m), bDumping ? -1 : 0);</span>
<span class="nc" id="L676">                    int selIdx = slotList.getSelectedIndex();</span>
<span class="nc" id="L677">                    displaySlots();</span>
<span class="nc" id="L678">                    slotList.setSelectedIndex(selIdx);</span>
                }
            }
<span class="nc" id="L681">            onResize();</span>
        } finally {
<span class="nc" id="L683">            addListeners();</span>
        }
<span class="nc" id="L685">    }</span>

    private void setBackGround() {
        UnitDisplaySkinSpecification udSpec = SkinXMLHandler
<span class="nc" id="L689">                .getUnitDisplaySkin();</span>

<span class="nc" id="L691">        Image tile = getToolkit()</span>
<span class="nc" id="L692">                .getImage(</span>
<span class="nc" id="L693">                        new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L694">                                .getBackgroundTile()).toString());</span>
<span class="nc" id="L695">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L696">        int b = BackGroundDrawer.TILING_BOTH;</span>
<span class="nc" id="L697">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L699">        b = BackGroundDrawer.TILING_HORIZONTAL | BackGroundDrawer.VALIGN_TOP;</span>
<span class="nc" id="L700">        tile = getToolkit().getImage(</span>
<span class="nc" id="L701">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getTopLine())</span>
<span class="nc" id="L702">                        .toString());</span>
<span class="nc" id="L703">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L704">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L706">        b = BackGroundDrawer.TILING_HORIZONTAL | BackGroundDrawer.VALIGN_BOTTOM;</span>
<span class="nc" id="L707">        tile = getToolkit().getImage(</span>
<span class="nc" id="L708">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getBottomLine())</span>
<span class="nc" id="L709">                        .toString()); //$NON-NLS-1$</span>
<span class="nc" id="L710">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L711">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L713">        b = BackGroundDrawer.TILING_VERTICAL | BackGroundDrawer.HALIGN_LEFT;</span>
<span class="nc" id="L714">        tile = getToolkit().getImage(</span>
<span class="nc" id="L715">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getLeftLine())</span>
<span class="nc" id="L716">                        .toString()); //$NON-NLS-1$</span>
<span class="nc" id="L717">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L718">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L720">        b = BackGroundDrawer.TILING_VERTICAL | BackGroundDrawer.HALIGN_RIGHT;</span>
<span class="nc" id="L721">        tile = getToolkit().getImage(</span>
<span class="nc" id="L722">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getRightLine())</span>
<span class="nc" id="L723">                        .toString());</span>
<span class="nc" id="L724">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L725">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L727">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_TOP</span>
                | BackGroundDrawer.HALIGN_LEFT;
<span class="nc" id="L729">        tile = getToolkit().getImage(</span>
<span class="nc" id="L730">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getTopLeftCorner())</span>
<span class="nc" id="L731">                        .toString());</span>
<span class="nc" id="L732">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L733">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L735">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_BOTTOM</span>
                | BackGroundDrawer.HALIGN_LEFT;
<span class="nc" id="L737">        tile = getToolkit().getImage(</span>
<span class="nc" id="L738">                new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L739">                        .getBottomLeftCorner()).toString());</span>
<span class="nc" id="L740">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L741">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L743">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_TOP</span>
                | BackGroundDrawer.HALIGN_RIGHT;
<span class="nc" id="L745">        tile = getToolkit()</span>
<span class="nc" id="L746">                .getImage(</span>
<span class="nc" id="L747">                        new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L748">                                .getTopRightCorner()).toString());</span>
<span class="nc" id="L749">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L750">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L752">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_BOTTOM</span>
                | BackGroundDrawer.HALIGN_RIGHT;
<span class="nc" id="L754">        tile = getToolkit().getImage(</span>
<span class="nc" id="L755">                new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L756">                        .getBottomRightCorner()).toString());</span>
<span class="nc" id="L757">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L758">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L760">    }</span>

    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L763" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L764">            return;</span>
        }
<span class="nc" id="L766">        removeListeners();</span>
        try {
<span class="nc bnc" id="L768" title="All 2 branches missed.">            if (event.getSource().equals(unitList)) {</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">                if (null != getSelectedEntity()) {</span>
<span class="nc" id="L770">                    en = getSelectedEntity();</span>
<span class="nc" id="L771">                    ((DefaultComboBoxModel&lt;String&gt;) m_chMode.getModel())</span>
<span class="nc" id="L772">                            .removeAllElements();</span>
<span class="nc" id="L773">                    m_chMode.setEnabled(false);</span>
<span class="nc" id="L774">                    displayLocations();</span>
                }
<span class="nc bnc" id="L776" title="All 2 branches missed.">            } else if (event.getSource().equals(locList)) {</span>
<span class="nc" id="L777">                ((DefaultComboBoxModel&lt;String&gt;) m_chMode.getModel())</span>
<span class="nc" id="L778">                        .removeAllElements();</span>
<span class="nc" id="L779">                m_chMode.setEnabled(false);</span>
<span class="nc" id="L780">                displaySlots();</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">            } else if (event.getSource().equals(slotList)</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">                    &amp;&amp; (unitDisplay.getClientGUI() != null)) {</span>

<span class="nc" id="L784">                Client client = unitDisplay.getClientGUI().getClient();</span>
<span class="nc" id="L785">                m_bDumpAmmo.setEnabled(false);</span>
<span class="nc" id="L786">                m_chMode.setEnabled(false);</span>
<span class="nc" id="L787">                Mounted m = getSelectedEquipment();</span>
<span class="nc" id="L788">                boolean carryingBAsOnBack = false;</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">                        &amp;&amp; ((en.getExteriorUnitAt(Mech.LOC_CT, true) != null)</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">                                || (en.getExteriorUnitAt(Mech.LOC_LT, true) != null) || (en</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">                                .getExteriorUnitAt(Mech.LOC_RT, true) != null))) {</span>
<span class="nc" id="L793">                    carryingBAsOnBack = true;</span>
                }

<span class="nc" id="L796">                boolean invalidEnvironment = false;</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">                        &amp;&amp; (en.getLocationStatus(Mech.LOC_CT) &gt; ILocationExposureStatus.NORMAL)) {</span>
<span class="nc" id="L799">                    invalidEnvironment = true;</span>
                }

<span class="nc bnc" id="L802" title="All 2 branches missed.">                if ((en instanceof Tank)</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                        &amp;&amp; (en.getLocationStatus(Tank.LOC_REAR) &gt; ILocationExposureStatus.NORMAL)) {</span>
<span class="nc" id="L804">                    invalidEnvironment = true;</span>
                }

<span class="nc" id="L807">                ((DefaultComboBoxModel&lt;String&gt;) m_chMode.getModel())</span>
<span class="nc" id="L808">                        .removeAllElements();</span>
<span class="nc" id="L809">                boolean bOwner = client.getLocalPlayer().equals(en.getOwner());</span>
<span class="nc bnc" id="L810" title="All 4 branches missed.">                if ((m != null)</span>
                        &amp;&amp; bOwner
<span class="nc bnc" id="L812" title="All 2 branches missed.">                        &amp;&amp; (m.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">                        &amp;&amp; (client.getGame().getPhase() != IGame.Phase.PHASE_DEPLOYMENT)</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">                        &amp;&amp; (client.getGame().getPhase() != IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">                        &amp;&amp; (m.getUsableShotsLeft() &gt; 0)</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">                        &amp;&amp; !m.isDumping()</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">                        &amp;&amp; en.isActive()</span>
<span class="nc" id="L818">                        &amp;&amp; (client.getGame().getOptions().intOption(OptionsConstants.BASE_DUMPING_FROM_ROUND) </span>
<span class="nc bnc" id="L819" title="All 6 branches missed.">                                &lt;= client.getGame().getRoundCount())</span>
                        &amp;&amp; !carryingBAsOnBack &amp;&amp; !invalidEnvironment) {
<span class="nc" id="L821">                    m_bDumpAmmo.setEnabled(true);</span>
<span class="nc bnc" id="L822" title="All 4 branches missed.">                } else if ((m != null) &amp;&amp; bOwner</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">                        &amp;&amp; (m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L824" title="All 4 branches missed.">                        &amp;&amp; !m.isMissing() &amp;&amp; m.isDWPMounted()) {</span>
<span class="nc" id="L825">                    m_bDumpAmmo.setEnabled(true);</span>
                    // Allow dumping of body-mounted missile launchers on BA
<span class="nc bnc" id="L827" title="All 6 branches missed.">                } else if ((m != null) &amp;&amp; bOwner</span>
                        &amp;&amp; (en instanceof BattleArmor)
<span class="nc bnc" id="L829" title="All 2 branches missed.">                        &amp;&amp; (m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L830" title="All 4 branches missed.">                        &amp;&amp; !m.isMissing() &amp;&amp; m.isBodyMounted()</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                        &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                        &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">                        &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L834">                    m_bDumpAmmo.setEnabled(true);</span>
                }
<span class="nc" id="L836">                int round = client.getGame().getRoundCount();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">                boolean inSquadron = ((en instanceof Aero) &amp;&amp; ((Aero) en)</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                        .isInASquadron());</span>
<span class="nc bnc" id="L839" title="All 6 branches missed.">                if ((m != null) &amp;&amp; bOwner &amp;&amp; m.getType().hasModes()) {</span>
<span class="nc bnc" id="L840" title="All 4 branches missed.">                    if (!m.isInoperable() &amp;&amp; !m.isDumping()</span>
<span class="nc bnc" id="L841" title="All 6 branches missed.">                            &amp;&amp; (en.isActive() || en.isActive(round) || inSquadron)</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                            &amp;&amp; m.isModeSwitchable()) {</span>
<span class="nc" id="L843">                        m_chMode.setEnabled(true);</span>
                    }
<span class="nc bnc" id="L845" title="All 2 branches missed.">                    if (!m.isInoperable()</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">                            &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">                            &amp;&amp; m.getType().hasFlag(MiscType.F_STEALTH)</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">                            &amp;&amp; m.isModeSwitchable()) {</span>
<span class="nc" id="L849">                        m_chMode.setEnabled(true);</span>
                    }// if the maxtech eccm option is not set then the ECM
                     // should not show anything.
<span class="nc bnc" id="L852" title="All 2 branches missed.">                    if (m.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                            &amp;&amp; !(client.getGame().getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_ECCM)</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">                                    || client.getGame().getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_GHOST_TARGET))) {</span>
<span class="nc" id="L855">                        return;</span>
                    }
<span class="nc" id="L857">                    for (Enumeration&lt;EquipmentMode&gt; e = m.getType()</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                            .getModes(); e.hasMoreElements();) {</span>
<span class="nc" id="L859">                        EquipmentMode em = e.nextElement();</span>
                        //Hack to prevent showing an option that is disabled by the server, but would
                        //be overwritten by every entity update if made also in the client
<span class="nc bnc" id="L862" title="All 4 branches missed.">                        if (em.equals(&quot;HotLoad&quot;) &amp;&amp; en instanceof Mech</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">                                &amp;&amp; !client.getGame().getOptions().booleanOption(OptionsConstants.ADVCOMBAT_HOTLOAD_IN_GAME)) {</span>
<span class="nc" id="L864">                            continue;</span>
                        }
<span class="nc" id="L866">                        m_chMode.addItem(em.getDisplayableName());</span>
<span class="nc" id="L867">                    }</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">                    if (m_chMode.getModel().getSize() &lt;= 1) {</span>
<span class="nc" id="L869">                        m_chMode.removeAllItems();</span>
<span class="nc" id="L870">                        m_chMode.setEnabled(false);</span>
                    } else {
<span class="nc bnc" id="L872" title="All 2 branches missed.">                        if (m.pendingMode().equals(&quot;None&quot;)) {</span>
<span class="nc" id="L873">                            m_chMode.setSelectedItem(m.curMode()</span>
<span class="nc" id="L874">                                    .getDisplayableName());</span>
                        } else {
<span class="nc" id="L876">                            m_chMode.setSelectedItem(m.pendingMode()</span>
<span class="nc" id="L877">                                    .getDisplayableName());</span>
                        }
                    }
                } else {
<span class="nc" id="L881">                    CriticalSlot cs = getSelectedCritical();</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                    if ((cs != null)</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">                            &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">                        if ((cs.getIndex() == Mech.SYSTEM_COCKPIT)</span>
<span class="nc bnc" id="L885" title="All 4 branches missed.">                                &amp;&amp; en.hasEiCockpit()</span>
                                &amp;&amp; (en instanceof Mech)) {
<span class="nc" id="L887">                            m_chMode.setEnabled(true);</span>
<span class="nc" id="L888">                            m_chMode.addItem(&quot;EI Off&quot;);</span>
<span class="nc" id="L889">                            m_chMode.addItem(&quot;EI On&quot;);</span>
<span class="nc" id="L890">                            m_chMode.addItem(&quot;Aimed shot&quot;);</span>
<span class="nc" id="L891">                            m_chMode.setSelectedItem(Integer.valueOf(</span>
<span class="nc" id="L892">                                    ((Mech) en).getCockpitStatusNextRound()));</span>
                        }
                    }
                }
            }
<span class="nc" id="L897">            onResize();</span>
        } finally {
<span class="nc" id="L899">            addListeners();</span>
        }
<span class="nc" id="L901">    }</span>
    
    private void addListeners() {
<span class="nc" id="L904">        locList.addListSelectionListener(this);</span>
<span class="nc" id="L905">        slotList.addListSelectionListener(this);</span>
<span class="nc" id="L906">        unitList.addListSelectionListener(this);</span>
        
<span class="nc" id="L908">        m_chMode.addItemListener(this);</span>
<span class="nc" id="L909">        m_bDumpAmmo.addActionListener(this);</span>
<span class="nc" id="L910">    }</span>
    
    private void removeListeners() {
<span class="nc" id="L913">        locList.removeListSelectionListener(this);</span>
<span class="nc" id="L914">        slotList.removeListSelectionListener(this);</span>
<span class="nc" id="L915">        unitList.removeListSelectionListener(this);</span>
        
<span class="nc" id="L917">        m_chMode.removeItemListener(this);</span>
<span class="nc" id="L918">        m_bDumpAmmo.removeActionListener(this);</span>
<span class="nc" id="L919">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>