<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TROView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.templates</a> &gt; <span class="el_source">TROView.java</span></div><h1>TROView.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2018 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/

package megamek.common.templates;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.text.NumberFormat;
import java.util.*;
import java.util.function.BiFunction;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import freemarker.template.Template;
import freemarker.template.TemplateException;
import freemarker.template.TemplateMethodModelEx;
import megamek.MegaMek;
import megamek.common.Aero;
import megamek.common.AmmoType;
import megamek.common.BattleArmor;
import megamek.common.Bay;
import megamek.common.Configuration;
import megamek.common.CriticalSlot;
import megamek.common.Entity;
import megamek.common.EntityFluff;
import megamek.common.EquipmentType;
import megamek.common.Infantry;
import megamek.common.Jumpship;
import megamek.common.Mech;
import megamek.common.Messages;
import megamek.common.Mounted;
import megamek.common.Protomech;
import megamek.common.SmallCraft;
import megamek.common.Tank;
import megamek.common.Transporter;
import megamek.common.TroopSpace;
import megamek.common.WeaponType;
import megamek.common.annotations.Nullable;
import megamek.common.options.IOption;
import megamek.common.options.IOptionGroup;
import megamek.common.options.Quirks;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.verifier.BayData;
import megamek.common.verifier.EntityVerifier;

/**
 * Fills in a template to produce a unit summary in TRO format.
 *
 * @author Neoancient
 */
public class TROView {

    private Template template;
<span class="nc" id="L68">    private final Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</span>
<span class="nc" id="L69">    private final EntityVerifier verifier = EntityVerifier</span>
<span class="nc" id="L70">            .getInstance(new MegaMekFile(Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</span>

<span class="nc" id="L72">    private boolean includeFluff = true;</span>

<span class="nc" id="L74">    protected TROView() {</span>
<span class="nc" id="L75">    }</span>

    public static TROView createView(Entity entity, boolean html) {
        TROView view;
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (entity.hasETypeFlag(Entity.ETYPE_MECH)) {</span>
<span class="nc" id="L80">            view = new MechTROView((Mech) entity);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L82">            view = new ProtomechTROView((Protomech) entity);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_SUPPORT_TANK)</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                || (entity.hasETypeFlag(Entity.ETYPE_SUPPORT_VTOL))) {</span>
<span class="nc" id="L85">            view = new SupportVeeTROView((Tank) entity);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_TANK)) {</span>
<span class="nc" id="L87">            view = new VehicleTROView((Tank) entity);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L89">            view = new SmallCraftDropshipTROView((SmallCraft) entity);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L91">            view = new CapitalShipTROView((Jumpship) entity);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_AERO)) {</span>
<span class="nc" id="L93">            view = new AeroTROView((Aero) entity);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)) {</span>
<span class="nc" id="L95">            view = new BattleArmorTROView((BattleArmor) entity);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        } else if (entity.hasETypeFlag(Entity.ETYPE_INFANTRY)) {</span>
<span class="nc" id="L97">            view = new InfantryTROView((Infantry) entity);</span>
        } else {
<span class="nc" id="L99">            view = new TROView();</span>
        }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (null != view.getTemplateFileName(html)) {</span>
            try {
<span class="nc" id="L103">                view.template = TemplateConfiguration.getInstance()</span>
<span class="nc" id="L104">                        .getTemplate(&quot;tro/&quot; + view.getTemplateFileName(html));</span>
<span class="nc" id="L105">            } catch (final IOException e) {</span>
<span class="nc" id="L106">                MegaMek.getLogger().error(e);</span>
<span class="nc" id="L107">            }</span>
<span class="nc" id="L108">            view.initModel(view.verifier);</span>
        }
<span class="nc" id="L110">        return view;</span>
    }

    protected String getTemplateFileName(boolean html) {
<span class="nc" id="L114">        return null;</span>
    }

    protected void setModelData(String key, Object data) {
<span class="nc" id="L118">        model.put(key, data);</span>
<span class="nc" id="L119">    }</span>

    protected Object getModelData(String key) {
<span class="nc" id="L122">        return model.get(key);</span>
    }

    protected void initModel(EntityVerifier verifier) {
<span class="nc" id="L126">    }</span>

    /**
     * Uses the template and supplied {@link Entity} to generate a TRO document
     *
     * @return The generated document. Returns {@code null} if there was an error
     *         that prevented the document from being generated. Check logs for
     *         reason.
     */
    @Nullable
    public String processTemplate() {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (null != template) {</span>
<span class="nc" id="L138">            model.put(&quot;includeFluff&quot;, includeFluff);</span>
<span class="nc" id="L139">            try (final ByteArrayOutputStream os = new ByteArrayOutputStream();</span>
<span class="nc" id="L140">                 final Writer out = new OutputStreamWriter(os)) {</span>
<span class="nc" id="L141">                template.process(model, out);</span>
<span class="nc" id="L142">                return os.toString();</span>
<span class="nc" id="L143">            } catch (TemplateException | IOException e) {</span>
<span class="nc" id="L144">                MegaMek.getLogger().error(e);</span>
<span class="nc" id="L145">                e.printStackTrace();</span>
            }
        }
<span class="nc" id="L148">        return null;</span>
    }

    protected void addBasicData(Entity entity) {
<span class="nc" id="L152">        model.put(&quot;formatBasicDataRow&quot;, new FormatTableRowMethod(new int[] { 30, 20, 5 },</span>
                new Justification[] { Justification.LEFT, Justification.LEFT, Justification.RIGHT }));
<span class="nc" id="L154">        model.put(&quot;fullName&quot;, entity.getShortNameRaw());</span>
<span class="nc" id="L155">        model.put(&quot;chassis&quot;, entity.getChassis());</span>
<span class="nc" id="L156">        model.put(&quot;techBase&quot;, formatTechBase(entity));</span>
<span class="nc" id="L157">        model.put(&quot;tonnage&quot;, NumberFormat.getInstance().format(entity.getWeight()));</span>
<span class="nc" id="L158">        model.put(&quot;battleValue&quot;, NumberFormat.getInstance().format(entity.calculateBattleValue()));</span>
<span class="nc" id="L159">        model.put(&quot;cost&quot;, NumberFormat.getInstance().format(entity.getCost(false)));</span>

<span class="nc" id="L161">        final StringJoiner quirksList = new StringJoiner(&quot;, &quot;);</span>
<span class="nc" id="L162">        final Quirks quirks = entity.getQuirks();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        for (final Enumeration&lt;IOptionGroup&gt; optionGroups = quirks.getGroups(); optionGroups.hasMoreElements();) {</span>
<span class="nc" id="L164">            final IOptionGroup group = optionGroups.nextElement();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (quirks.count(group.getKey()) &gt; 0) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                for (final Enumeration&lt;IOption&gt; options = group.getOptions(); options.hasMoreElements();) {</span>
<span class="nc" id="L167">                    final IOption option = options.nextElement();</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">                    if ((option != null) &amp;&amp; option.booleanValue()) {</span>
<span class="nc" id="L169">                        quirksList.add(option.getDisplayableNameWithValue());</span>
                    }
<span class="nc" id="L171">                }</span>
            }
<span class="nc" id="L173">        }</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (quirksList.length() &gt; 0) {</span>
<span class="nc" id="L175">            model.put(&quot;quirks&quot;, quirksList.toString());</span>
        }

<span class="nc" id="L178">    }</span>

    protected void addEntityFluff(Entity entity) {
<span class="nc" id="L181">        model.put(&quot;year&quot;, String.valueOf(entity.getYear()));</span>
<span class="nc" id="L182">        model.put(&quot;techRating&quot;, entity.getFullRatingName());</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (entity.getFluff().getOverview().length() &gt; 0) {</span>
<span class="nc" id="L184">            model.put(&quot;fluffOverview&quot;, entity.getFluff().getOverview());</span>
        }
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (entity.getFluff().getCapabilities().length() &gt; 0) {</span>
<span class="nc" id="L187">            model.put(&quot;fluffCapabilities&quot;, entity.getFluff().getCapabilities());</span>
        }
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (entity.getFluff().getDeployment().length() &gt; 0) {</span>
<span class="nc" id="L190">            model.put(&quot;fluffDeployment&quot;, entity.getFluff().getDeployment());</span>
        }
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (entity.getFluff().getHistory().length() &gt; 0) {</span>
<span class="nc" id="L193">            model.put(&quot;fluffHistory&quot;, entity.getFluff().getHistory());</span>
        }
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (entity.getFluff().getManufacturer().length() &gt; 0) {</span>
<span class="nc" id="L196">            model.put(&quot;manufacturerDesc&quot;, entity.getFluff().getManufacturer());</span>
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (entity.getFluff().getPrimaryFactory().length() &gt; 0) {</span>
<span class="nc" id="L199">            model.put(&quot;factoryDesc&quot;, entity.getFluff().getPrimaryFactory());</span>
        }
<span class="nc" id="L201">    }</span>

    /**
     * Builds the fluff name for a system component.
     *
     * @param system
     *            The system component
     * @param fluff
     *            The {@link Entity}'s fluff object
     * @param altText
     *            Alternate text that will be used if neither fluff field is set.
     * @return The fluff display name, which consists of the manufacturer and the
     *         model separated by a space. If either is missing it is left out.
     */
    protected String formatSystemFluff(EntityFluff.System system, EntityFluff fluff, Supplier&lt;String&gt; altText) {
<span class="nc" id="L216">        final StringJoiner sj = new StringJoiner(&quot; &quot;);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (fluff.getSystemManufacturer(system).length() &gt; 0) {</span>
<span class="nc" id="L218">            sj.add(fluff.getSystemManufacturer(system));</span>
        }
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (fluff.getSystemModel(system).length() &gt; 0) {</span>
<span class="nc" id="L221">            sj.add(fluff.getSystemModel(system));</span>
        }
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (sj.toString().length() &gt; 0) {</span>
<span class="nc" id="L224">            return sj.toString();</span>
        } else {
<span class="nc" id="L226">            return altText.get();</span>
        }
    }

    protected void addMechVeeAeroFluff(Entity entity) {
<span class="nc" id="L231">        addEntityFluff(entity);</span>
<span class="nc" id="L232">        model.put(&quot;massDesc&quot;, NumberFormat.getInstance().format(entity.getWeight())</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                + Messages.getString(entity.getWeight() == 1.0 ? &quot;TROView.ton&quot; : &quot;TROView.tons&quot;));</span>
<span class="nc" id="L234">        model.put(&quot;engineDesc&quot;, formatSystemFluff(EntityFluff.System.ENGINE, entity.getFluff(),</span>
<span class="nc" id="L235">                () -&gt; stripNotes(entity.getEngine().getEngineName())));</span>
<span class="nc" id="L236">        model.put(&quot;cruisingSpeed&quot;, entity.getWalkMP() * 10.8);</span>
<span class="nc" id="L237">        model.put(&quot;maxSpeed&quot;, entity.getRunMP() * 10.8);</span>
<span class="nc" id="L238">        model.put(&quot;armorDesc&quot;,</span>
<span class="nc" id="L239">                formatSystemFluff(EntityFluff.System.ARMOR, entity.getFluff(), () -&gt; formatArmorType(entity, false)));</span>
<span class="nc" id="L240">        final Map&lt;String, Integer&gt; weaponCount = new HashMap&lt;&gt;();</span>
<span class="nc" id="L241">        double podSpace = 0.0;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        for (final Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (m.isOmniPodMounted()) {</span>
<span class="nc" id="L244">                podSpace += m.getTonnage();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            } else if (m.getType() instanceof WeaponType) {</span>
<span class="nc" id="L246">                weaponCount.merge(m.getName(), 1, Integer::sum);</span>
            }
<span class="nc" id="L248">        }</span>
<span class="nc" id="L249">        final List&lt;String&gt; armaments = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        for (final Map.Entry&lt;String, Integer&gt; entry : weaponCount.entrySet()) {</span>
<span class="nc" id="L251">            armaments.add(String.format(&quot;%d %s&quot;, entry.getValue(), entry.getKey()));</span>
<span class="nc" id="L252">        }</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (podSpace &gt; 0) {</span>
<span class="nc" id="L254">            armaments.add(String.format(Messages.getString(&quot;TROView.podspace.format&quot;), podSpace));</span>
        }
<span class="nc" id="L256">        model.put(&quot;armamentList&quot;, armaments);</span>
<span class="nc" id="L257">        model.put(&quot;communicationDesc&quot;, formatSystemFluff(EntityFluff.System.COMMUNICATIONS, entity.getFluff(),</span>
<span class="nc" id="L258">                () -&gt; Messages.getString(&quot;TROView.Unknown&quot;)));</span>
<span class="nc" id="L259">        model.put(&quot;targetingDesc&quot;, formatSystemFluff(EntityFluff.System.TARGETING, entity.getFluff(),</span>
<span class="nc" id="L260">                () -&gt; Messages.getString(&quot;TROView.Unknown&quot;)));</span>
<span class="nc" id="L261">    }</span>

    private String formatTechBase(Entity entity) {
<span class="nc" id="L264">        final StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (entity.isMixedTech()) {</span>
<span class="nc" id="L266">            sb.append(Messages.getString(&quot;TROView.Mixed&quot;));</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        } else if (entity.isClan()) {</span>
<span class="nc" id="L268">            sb.append(Messages.getString(&quot;TROView.Clan&quot;));</span>
        } else {
<span class="nc" id="L270">            sb.append(Messages.getString(&quot;TROView.InnerSphere&quot;));</span>
        }
<span class="nc" id="L272">        sb.append(&quot; (&quot;).append(entity.getStaticTechLevel().toString()).append(&quot;)&quot;);</span>
<span class="nc" id="L273">        return sb.toString();</span>
    }

    protected String formatArmorType(Entity entity, boolean trim) {
<span class="nc bnc" id="L277" title="All 4 branches missed.">        if (entity.hasETypeFlag(Entity.ETYPE_SUPPORT_TANK) || entity.hasETypeFlag(Entity.ETYPE_SUPPORT_VTOL)</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                || entity.hasETypeFlag(Entity.ETYPE_FIXED_WING_SUPPORT)) {</span>
<span class="nc" id="L279">            return &quot;BAR &quot; + entity.getBARRating(Tank.LOC_FRONT);</span>
        }
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (entity.hasPatchworkArmor()) {</span>
<span class="nc" id="L282">            return EquipmentType.getArmorTypeName(EquipmentType.T_ARMOR_PATCHWORK);</span>
        }
        // Some types do not have armor on the first location, and others have only a
        // single location
<span class="nc" id="L286">        final int at = entity.getArmorType(Math.min(1, entity.locations() - 1));</span>
<span class="nc bnc" id="L287" title="All 4 branches missed.">        if (trim &amp;&amp; (at == EquipmentType.T_ARMOR_STANDARD)) {</span>
<span class="nc" id="L288">            return &quot;&quot;;</span>
        }
<span class="nc" id="L290">        String name = EquipmentType.getArmorTypeName(at);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (trim) {</span>
<span class="nc" id="L292">            name = name.replace(&quot;-Fibrous&quot;, &quot;&quot;).replace(&quot;-Aluminum&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (at == EquipmentType.T_ARMOR_EDP) {</span>
<span class="nc" id="L294">                name = &quot;EDP&quot;;</span>
            }
        }
<span class="nc" id="L297">        return name;</span>
    }

    protected String formatArmorType(int at, boolean trim) {
        // Some types do not have armor on the first location, and others have only a
        // single location
<span class="nc bnc" id="L303" title="All 4 branches missed.">        if (trim &amp;&amp; (at == EquipmentType.T_ARMOR_STANDARD)) {</span>
<span class="nc" id="L304">            return &quot;&quot;;</span>
        }
<span class="nc" id="L306">        String name = EquipmentType.getArmorTypeName(at);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (trim) {</span>
<span class="nc" id="L308">            name = name.replace(&quot;-Fibrous&quot;, &quot;&quot;).replace(&quot;-Aluminum&quot;, &quot;&quot;);</span>
        }
<span class="nc" id="L310">        return name;</span>
    }

    /**
     * Convenience method to format armor and structure values, consolidating
     * right/left values into a single entry. In most cases the right and left armor
     * values are the same, in which case only a single value is used. If the values
     * do not match they are both (or all, in the case of tripod mech legs) given
     * separated by slashes.
     *
     * @param entity
     *            The entity to collect structure or armor values for
     * @param provider
     *            The function that retrieves the armor or structure value for the
     *            entity and location
     * @param locSets
     *            A two-dimensional array that groups locations that should appear
     *            on the same line. Any location that is not legal for the unit
     *            (e.g. center leg on non-tripods) is ignored. If the first location
     *            in a group is illegal, the entire group is skipped.
     * @return A {@link Map} with the armor/structure value mapped to the
     *         abbreviation of each of the location keys.
     */
    protected Map&lt;String, String&gt; addArmorStructureEntries(Entity entity, BiFunction&lt;Entity, Integer, Integer&gt; provider,
            int[][] locSets) {
<span class="nc" id="L335">        final Map&lt;String, String&gt; retVal = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        for (final int[] locs : locSets) {</span>
<span class="nc bnc" id="L337" title="All 4 branches missed.">            if ((locs.length == 0) || (locs[0] &gt;= entity.locations())) {</span>
<span class="nc" id="L338">                continue;</span>
            }
<span class="nc" id="L340">            String val = null;</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (locs.length &gt; 1) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                for (int i = 1; i &lt; locs.length; i++) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                    if ((locs[i] &lt; entity.locations())</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                            &amp;&amp; ((!provider.apply(entity, locs[i]).equals(provider.apply(entity, locs[0])))</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                                    || !entity.hasETypeFlag(Entity.ETYPE_MECH))) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                        val = Arrays.stream(locs).filter(l -&gt; l &lt; entity.locations())</span>
<span class="nc" id="L347">                                .mapToObj(l -&gt; String.valueOf(provider.apply(entity, l)))</span>
<span class="nc" id="L348">                                .collect(Collectors.joining(&quot;/&quot;));</span>
<span class="nc" id="L349">                        break;</span>
                    }
                }
            }
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (null == val) {</span>
<span class="nc" id="L354">                val = String.valueOf(provider.apply(entity, locs[0]));</span>
            }
<span class="nc bnc" id="L356" title="All 2 branches missed.">            for (final int loc : locs) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                if (loc &lt; entity.locations()) {</span>
<span class="nc" id="L358">                    retVal.put(entity.getLocationAbbr(loc), val);</span>
                }
            }
        }
<span class="nc" id="L362">        return retVal;</span>
    }

    protected Map&lt;String, String&gt; addPatchworkATs(Entity entity, int[][] locSets) {
<span class="nc" id="L366">        final Map&lt;String, String&gt; retVal = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        for (final int[] locs : locSets) {</span>
<span class="nc bnc" id="L368" title="All 4 branches missed.">            if ((locs.length == 0) || (locs[0] &gt;= entity.locations())) {</span>
<span class="nc" id="L369">                continue;</span>
            }
<span class="nc" id="L371">            String val = null;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (locs.length &gt; 1) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                for (int i = 1; i &lt; locs.length; i++) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                    if ((locs[i] &lt; entity.locations())</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                            &amp;&amp; (entity.getArmorType(locs[i]) != entity.getArmorType(locs[0]))) {</span>
<span class="nc" id="L376">                        val = Arrays.stream(locs).mapToObj(l -&gt; formatArmorType(entity.getArmorType(l), true))</span>
<span class="nc" id="L377">                                .collect(Collectors.joining(&quot;/&quot;));</span>
<span class="nc" id="L378">                        break;</span>
                    }
                }
            }
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (null == val) {</span>
<span class="nc" id="L383">                val = formatArmorType(entity.getArmorType(locs[0]), true);</span>
            }
<span class="nc bnc" id="L385" title="All 2 branches missed.">            for (final int loc : locs) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                if (loc &lt; entity.locations()) {</span>
<span class="nc" id="L387">                    retVal.put(entity.getLocationAbbr(loc), val);</span>
                }
            }
        }
<span class="nc" id="L391">        return retVal;</span>
    }

    protected int addEquipment(Entity entity) {
<span class="nc" id="L395">        return addEquipment(entity, true);</span>
    }

    /**
     * Test for whether the mount should be included in the equipment inventory section.
     *
     * @param mount        The equipment mount
     * @param includeAmmo  Whether to include ammo in the list
     * @return             Whether to list the equipment in the inventory section
     */
    protected boolean skipMount(Mounted mount, boolean includeAmmo) {
<span class="nc bnc" id="L406" title="All 2 branches missed.">        return mount.getLocation() &lt; 0</span>
<span class="nc bnc" id="L407" title="All 4 branches missed.">                || mount.isWeaponGroup()</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                || (!includeAmmo &amp;&amp; (mount.getType() instanceof AmmoType));</span>
    }

    protected int addEquipment(Entity entity, boolean includeAmmo) {
<span class="nc" id="L412">        final int structure = entity.getStructureType();</span>
<span class="nc" id="L413">        final Map&lt;String, Map&lt;EquipmentKey, Integer&gt;&gt; equipment = new HashMap&lt;&gt;();</span>
<span class="nc" id="L414">        int nameWidth = 20;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        for (final Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">            if (skipMount(m, includeAmmo)) {</span>
<span class="nc" id="L417">                continue;</span>
            }
            // Skip armor and structure
<span class="nc bnc" id="L420" title="All 4 branches missed.">            if (!m.getType().isHittable() &amp;&amp; (m.getLocation() &gt;= 0)) {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                if ((structure != EquipmentType.T_STRUCTURE_UNKNOWN)</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                        &amp;&amp; (EquipmentType.getStructureType(m.getType()) == structure)) {</span>
<span class="nc" id="L423">                    continue;</span>
                }
<span class="nc bnc" id="L425" title="All 2 branches missed.">                if ((m.getLocation() &gt;= 0)</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">                        &amp;&amp; (entity.getArmorType(m.getLocation()) == EquipmentType.getArmorType(m.getType()))) {</span>
<span class="nc" id="L427">                    continue;</span>
                }
            }
<span class="nc bnc" id="L430" title="All 4 branches missed.">            if (m.isOmniPodMounted() || !entity.isOmni()) {</span>
<span class="nc" id="L431">                final String loc = formatLocationTableEntry(entity, m);</span>
<span class="nc" id="L432">                equipment.putIfAbsent(loc, new HashMap&lt;&gt;());</span>
<span class="nc" id="L433">                equipment.get(loc).merge(new EquipmentKey(m.getType(), m.getSize(), m.isArmored()),</span>
<span class="nc" id="L434">                        1, Integer::sum);</span>
            }
<span class="nc" id="L436">        }</span>
<span class="nc" id="L437">        final List&lt;Map&lt;String, Object&gt;&gt; eqList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">        for (final String loc : equipment.keySet()) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">            for (final Map.Entry&lt;EquipmentKey, Integer&gt; entry : equipment.get(loc).entrySet()) {</span>
<span class="nc" id="L440">                final EquipmentType eq = entry.getKey().getType();</span>
<span class="nc" id="L441">                final int count = equipment.get(loc).get(entry.getKey());</span>
<span class="nc" id="L442">                String name = stripNotes(entry.getKey().name());</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                if (entry.getKey().isArmored()) {</span>
<span class="nc" id="L444">                    name += &quot; (Armored)&quot;;</span>
                }
<span class="nc bnc" id="L446" title="All 2 branches missed.">                if (eq instanceof AmmoType) {</span>
<span class="nc" id="L447">                    name = String.format(&quot;%s (%d)&quot;, name, ((AmmoType) eq).getShots() * count);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                } else if (count &gt; 1) {</span>
<span class="nc" id="L449">                    name = String.format(&quot;%d %s&quot;, count, name);</span>
                }
<span class="nc" id="L451">                final Map&lt;String, Object&gt; fields = new HashMap&lt;&gt;();</span>
<span class="nc" id="L452">                fields.put(&quot;name&quot;, name);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                if (name.length() &gt;= nameWidth) {</span>
<span class="nc" id="L454">                    nameWidth = name.length() + 1;</span>
                }
<span class="nc" id="L456">                fields.put(&quot;tonnage&quot;, eq.getTonnage(entity, entry.getKey().getSize()) * count);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                if (eq instanceof WeaponType) {</span>
<span class="nc" id="L458">                    fields.put(&quot;heat&quot;, eq.getHeat());</span>
<span class="nc" id="L459">                    fields.put(&quot;srv&quot;, (int) ((WeaponType) eq).getShortAV());</span>
<span class="nc" id="L460">                    fields.put(&quot;mrv&quot;, (int) ((WeaponType) eq).getMedAV());</span>
<span class="nc" id="L461">                    fields.put(&quot;lrv&quot;, (int) ((WeaponType) eq).getLongAV());</span>
<span class="nc" id="L462">                    fields.put(&quot;erv&quot;, (int) ((WeaponType) eq).getExtAV());</span>
                } else {
<span class="nc" id="L464">                    fields.put(&quot;heat&quot;, &quot;-&quot;);</span>
<span class="nc" id="L465">                    fields.put(&quot;srv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L466">                    fields.put(&quot;mrv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L467">                    fields.put(&quot;lrv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L468">                    fields.put(&quot;erv&quot;, &quot;-&quot;);</span>
                }
<span class="nc bnc" id="L470" title="All 2 branches missed.">                if (eq.isSpreadable()) {</span>
<span class="nc" id="L471">                    final Map&lt;Integer, Integer&gt; byLoc = getSpreadableLocations(entity, eq);</span>
<span class="nc" id="L472">                    final StringJoiner locs = new StringJoiner(&quot;/&quot;);</span>
<span class="nc" id="L473">                    final StringJoiner crits = new StringJoiner(&quot;/&quot;);</span>
<span class="nc" id="L474">                    byLoc.forEach((l, c) -&gt; {</span>
<span class="nc" id="L475">                        locs.add(entity.getLocationAbbr(l));</span>
<span class="nc" id="L476">                        crits.add(String.valueOf(c));</span>
<span class="nc" id="L477">                    });</span>
<span class="nc" id="L478">                    fields.put(&quot;location&quot;, locs.toString());</span>
<span class="nc" id="L479">                    fields.put(&quot;slots&quot;, crits.toString());</span>
<span class="nc" id="L480">                } else {</span>
<span class="nc" id="L481">                    fields.put(&quot;location&quot;, loc);</span>
<span class="nc" id="L482">                    fields.put(&quot;slots&quot;, eq.getCriticals(entity, entry.getValue()) * count);</span>
                }
<span class="nc" id="L484">                eqList.add(fields);</span>
<span class="nc" id="L485">            }</span>
<span class="nc" id="L486">        }</span>
<span class="nc" id="L487">        model.put(&quot;equipment&quot;, eqList);</span>
<span class="nc" id="L488">        return nameWidth;</span>
    }

    private Map&lt;Integer, Integer&gt; getSpreadableLocations(final Entity entity, final EquipmentType eq) {
<span class="nc" id="L492">        final Map&lt;Integer, Integer&gt; retVal = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">            for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</span>
<span class="nc" id="L495">                final CriticalSlot crit = entity.getCritical(loc, slot);</span>
<span class="nc bnc" id="L496" title="All 6 branches missed.">                if ((crit != null) &amp;&amp; (crit.getMount() != null) &amp;&amp; (crit.getMount().getType() == eq)) {</span>
<span class="nc" id="L497">                    retVal.merge(loc, 1, Integer::sum);</span>
                }
            }
        }
<span class="nc" id="L501">        return retVal;</span>
    }

    protected void addFixedOmni(final Entity entity) {
<span class="nc" id="L505">        double fixedTonnage = 0.0;</span>
<span class="nc" id="L506">        final List&lt;Map&lt;String, Object&gt;&gt; fixedList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc bnc" id="L508" title="All 4 branches missed.">            if (entity.isAero() &amp;&amp; (loc == Aero.LOC_WINGS)) {</span>
<span class="nc" id="L509">                break;</span>
            }
<span class="nc" id="L511">            int remaining = 0;</span>
<span class="nc" id="L512">            final Map&lt;String, Integer&gt; fixedCount = new HashMap&lt;&gt;();</span>
<span class="nc" id="L513">            final Map&lt;String, Double&gt; fixedWeight = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">            for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</span>
<span class="nc" id="L515">                final CriticalSlot crit = entity.getCritical(loc, slot);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                if (null == crit) {</span>
<span class="nc" id="L517">                    remaining++;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                } else if ((crit.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                        &amp;&amp; showFixedSystem(entity, crit.getIndex(), loc)) {</span>
<span class="nc" id="L520">                    fixedCount.merge(getSystemName(entity, crit.getIndex()), 1, Integer::sum);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                } else if (crit.getMount() != null) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                    if (crit.getMount().isOmniPodMounted()) {</span>
<span class="nc" id="L523">                        remaining++;</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                    } else if (!crit.getMount().isWeaponGroup()) {</span>
<span class="nc" id="L525">                        final String key = stripNotes(crit.getMount().getName());</span>
<span class="nc" id="L526">                        fixedCount.merge(key, 1, Integer::sum);</span>
<span class="nc" id="L527">                        fixedWeight.merge(key, crit.getMount().getTonnage(), Double::sum);</span>
                    }
                }
            }
            Map&lt;String, Object&gt; row;
<span class="nc bnc" id="L532" title="All 2 branches missed.">            if (fixedCount.isEmpty()) {</span>
<span class="nc" id="L533">                row = new HashMap&lt;&gt;();</span>
<span class="nc" id="L534">                row.put(&quot;location&quot;, entity.getLocationName(loc));</span>
<span class="nc" id="L535">                row.put(&quot;equipment&quot;, &quot;None&quot;);</span>
<span class="nc" id="L536">                row.put(&quot;remaining&quot;, remaining);</span>
<span class="nc" id="L537">                row.put(&quot;tonnage&quot;, 0.0);</span>
<span class="nc" id="L538">                row.put(&quot;heat&quot;, &quot;-&quot;);</span>
<span class="nc" id="L539">                row.put(&quot;srv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L540">                row.put(&quot;mrv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L541">                row.put(&quot;lrv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L542">                row.put(&quot;erv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L543">                fixedList.add(row);</span>
            } else {
<span class="nc" id="L545">                boolean firstLine = true;</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                for (final Map.Entry&lt;String, Integer&gt; entry : fixedCount.entrySet()) {</span>
<span class="nc" id="L547">                    row = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">                    if (firstLine) {</span>
<span class="nc" id="L549">                        row.put(&quot;location&quot;, entity.getLocationName(loc));</span>
<span class="nc" id="L550">                        row.put(&quot;remaining&quot;, remaining);</span>
<span class="nc" id="L551">                        firstLine = false;</span>
                    } else {
<span class="nc" id="L553">                        row.put(&quot;location&quot;, &quot;&quot;);</span>
<span class="nc" id="L554">                        row.put(&quot;remaining&quot;, &quot;&quot;);</span>
                    }

<span class="nc bnc" id="L557" title="All 2 branches missed.">                    if (entry.getValue() &gt; 1) {</span>
<span class="nc" id="L558">                        row.put(&quot;equipment&quot;, entry.getValue() + &quot; &quot; + entry.getKey());</span>
                    } else {
<span class="nc" id="L560">                        row.put(&quot;equipment&quot;, entry.getKey());</span>
                    }

<span class="nc bnc" id="L563" title="All 2 branches missed.">                    if (fixedWeight.containsKey(entry.getKey())) {</span>
                        // Not valid for mech systems
<span class="nc" id="L565">                        row.put(&quot;tonnage&quot;, fixedWeight.get(entry.getKey()));</span>
<span class="nc" id="L566">                        fixedTonnage += fixedWeight.get(entry.getKey());</span>
                    } else {
<span class="nc" id="L568">                        row.put(&quot;tonnage&quot;, &quot;&quot;);</span>
                    }

                    // FIXME : I am not properly implemented, this is a temporary fix for testing
                    // FIXME : and needs to be fixed.
<span class="nc" id="L573">                    row.put(&quot;heat&quot;, &quot;-&quot;);</span>
<span class="nc" id="L574">                    row.put(&quot;srv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L575">                    row.put(&quot;mrv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L576">                    row.put(&quot;lrv&quot;, &quot;-&quot;);</span>
<span class="nc" id="L577">                    row.put(&quot;erv&quot;, &quot;-&quot;);</span>

<span class="nc" id="L579">                    fixedList.add(row);</span>
<span class="nc" id="L580">                }</span>
            }
        }
<span class="nc" id="L583">        model.put(&quot;fixedEquipment&quot;, fixedList);</span>
<span class="nc" id="L584">        model.put(&quot;fixedTonnage&quot;, fixedTonnage);</span>
<span class="nc" id="L585">    }</span>

    protected void addTransportBays(Entity entity) {
<span class="nc" id="L588">        final List&lt;Map&lt;String, Object&gt;&gt; bays = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">        for (final Bay bay : entity.getTransportBays()) {</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">            if (bay.isQuarters()) {</span>
<span class="nc" id="L591">                continue;</span>
            }
<span class="nc" id="L593">            final BayData bayData = BayData.getBayType(bay);</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">            if (null != bayData) {</span>
<span class="nc" id="L595">                final Map&lt;String, Object&gt; bayRow = new HashMap&lt;&gt;();</span>
<span class="nc" id="L596">                bayRow.put(&quot;name&quot;, bayData.getDisplayName());</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                if (bayData.isCargoBay()) {</span>
<span class="nc" id="L598">                    bayRow.put(&quot;size&quot;, bay.getCapacity() + Messages.getString(&quot;TROView.tons&quot;));</span>
                } else {
<span class="nc" id="L600">                    bayRow.put(&quot;size&quot;, (int) bay.getCapacity());</span>
                }
<span class="nc" id="L602">                bayRow.put(&quot;doors&quot;, bay.getDoors());</span>
<span class="nc" id="L603">                bays.add(bayRow);</span>
<span class="nc" id="L604">            } else {</span>
<span class="nc" id="L605">                MegaMek.getLogger().warning(&quot;Could not determine bay type for &quot; + bay.toString());</span>
            }
<span class="nc" id="L607">        }</span>
<span class="nc" id="L608">        setModelData(&quot;bays&quot;, bays);</span>
<span class="nc" id="L609">    }</span>

    /**
     * Used to determine whether system crits should be shown when detailing fixed
     * equipment in an omni unit. By default this is false, but mechs override it to
     * show some systems.
     *
     * @param entity
     *            The unit the TRO is for
     * @param index
     *            The system index of the critical slot
     * @param loc
     *            The slot location
     * @return Whether to show this as a fixed system in an omni configuration
     */
    protected boolean showFixedSystem(Entity entity, int index, int loc) {
<span class="nc" id="L625">        return false;</span>
    }

    /**
     * Used to show the name of fixed system critical slots in an omni unit. This is
     * only used for Mechs, and returns a default value of &quot;Unknown System&quot; for
     * other units.
     *
     * @param entity
     *            The unit the TRO is for
     * @param index
     *            The system index of the critical slot
     * @return The name of the system to display in the fixed equipment table
     */
    protected String getSystemName(Entity entity, int index) {
<span class="nc" id="L640">        return &quot;Unknown System&quot;;</span>
    }

    /**
     * Formats displayable location name for use in equipment table. The format of
     * the name can vary by unit type due to available space based on number of
     * columns, and in some cases the official TROs have different location names
     * than the ones used by MM.
     *
     * @param entity
     *            The entity the TRO is created for
     * @param mounted
     *            The mounted equipment
     * @return The location name to use in the table.
     */
    protected String formatLocationTableEntry(Entity entity, Mounted mounted) {
        // Default: location abbreviation
<span class="nc" id="L657">        return entity.getLocationAbbr(mounted.getLocation());</span>
    }

    /**
     * Formats {@link Transporter} to display as a row in an equipment table. Any
     * other than bays and troop space are skipped to avoid showing BA handles and
     * such.
     *
     * @param transporter
     *            The transporter to show.
     * @param loc
     *            The location name to display on the table.
     * @return A map of values used by the equipment tables (omni fixed and
     *         pod/non-omni). Returns {@code null} for a type of {@link Transporter}
     *         that should not be shown.
     */
    protected @Nullable Map&lt;String, Object&gt; formatTransporter(Transporter transporter, String loc) {
<span class="nc" id="L674">        final Map&lt;String, Object&gt; retVal = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (transporter instanceof TroopSpace) {</span>
<span class="nc" id="L676">            retVal.put(&quot;name&quot;, Messages.getString(&quot;TROView.TroopSpace&quot;));</span>
<span class="nc" id="L677">            retVal.put(&quot;tonnage&quot;, transporter.getUnused());</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">        } else if (transporter instanceof Bay) {</span>
<span class="nc" id="L679">            final BayData bayType = BayData.getBayType((Bay) transporter);</span>
<span class="nc" id="L680">            retVal.put(&quot;name&quot;, bayType.getDisplayName());</span>
<span class="nc" id="L681">            retVal.put(&quot;tonnage&quot;, bayType.getWeight() * transporter.getUnused());</span>
<span class="nc" id="L682">        } else {</span>
<span class="nc" id="L683">            return null;</span>
        }
<span class="nc" id="L685">        retVal.put(&quot;equipment&quot;, retVal.get(&quot;name&quot;));</span>
<span class="nc" id="L686">        retVal.put(&quot;location&quot;, loc);</span>
<span class="nc" id="L687">        retVal.put(&quot;slots&quot;, 1);</span>
<span class="nc" id="L688">        retVal.put(&quot;heat&quot;, &quot;-&quot;);</span>
<span class="nc" id="L689">        return retVal;</span>
    }

<span class="nc" id="L692">    protected enum Justification {</span>
<span class="nc" id="L693">        LEFT((str, w) -&gt; String.format(&quot;%-&quot; + w + &quot;s&quot;, str)), CENTER((str, w) -&gt; {</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">            if (w &gt; str.length()) {</span>
<span class="nc" id="L695">                final int rightPadding = Math.max(0, (w - str.length()) / 2);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                if (rightPadding &gt; 0) {</span>
<span class="nc" id="L697">                    str = String.format(&quot;%-&quot; + (w - rightPadding) + &quot;s&quot;, str);</span>
                }
<span class="nc" id="L699">                return String.format(&quot;%&quot; + w + &quot;s&quot;, str);</span>
            }
<span class="nc" id="L701">            return str;</span>
<span class="nc" id="L702">        }), RIGHT((str, w) -&gt; String.format(&quot;%&quot; + w + &quot;s&quot;, str));</span>

        final private BiFunction&lt;String, Integer, String&gt; pad;

<span class="nc" id="L706">        Justification(BiFunction&lt;String, Integer, String&gt; pad) {</span>
<span class="nc" id="L707">            this.pad = pad;</span>
<span class="nc" id="L708">        }</span>

        public String padString(String str, int fieldWidth) {
<span class="nc bnc" id="L711" title="All 2 branches missed.">            if (fieldWidth &gt; 0) {</span>
<span class="nc" id="L712">                return pad.apply(str, fieldWidth);</span>
            } else {
<span class="nc" id="L714">                return str;</span>
            }
        }
    }

    /**
     * Removes parenthetical and bracketed notes from a String, with the exception
     * of parenthetical notes that begin with a digit. These are assumed to be
     * a marker of equipment size and left intact.
     *
     * @param str The String to process
     * @return     The same String with notes removed
     */
    protected String stripNotes(String str) {
<span class="nc" id="L728">        return str.replaceAll(&quot;\\s+\\[.*?]&quot;, &quot;&quot;)</span>
<span class="nc" id="L729">                .replaceAll(&quot;\\s+\\([^\\d].*?\\)&quot;, &quot;&quot;);</span>
    }

    protected static class FormatTableRowMethod implements TemplateMethodModelEx {
        final private int[] colWidths;
        final private Justification[] justification;

<span class="nc" id="L736">        public FormatTableRowMethod(int[] widths, Justification[] justify) {</span>
<span class="nc" id="L737">            colWidths = new int[widths.length];</span>
<span class="nc" id="L738">            justification = new Justification[widths.length];</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">            for (int i = 0; i &lt; widths.length; i++) {</span>
<span class="nc" id="L740">                colWidths[i] = widths[i];</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">                if (i &lt; justify.length) {</span>
<span class="nc" id="L742">                    justification[i] = justify[i];</span>
                } else {
<span class="nc" id="L744">                    justification[i] = Justification.LEFT;</span>
                }
            }
<span class="nc" id="L747">            System.arraycopy(widths, 0, colWidths, 0, widths.length);</span>
<span class="nc" id="L748">        }</span>

        @Override
        public Object exec(List arguments) {
<span class="nc" id="L752">            final StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L753">            int col = 0;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">            for (final Object o : arguments) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">                if (col &lt; colWidths.length) {</span>
<span class="nc" id="L756">                    sb.append(justification[col].padString(o.toString(), colWidths[col]));</span>
                } else {
<span class="nc" id="L758">                    sb.append(o);</span>
                }
<span class="nc" id="L760">                col++;</span>
<span class="nc" id="L761">            }</span>
<span class="nc" id="L762">            return sb.toString();</span>
        }

    }

    /**
     * Sets whether to include the fluff section when processing the template
     *
     * @param includeFluff
     *            Whether to include the fluff section
     */
    public void setIncludeFluff(boolean includeFluff) {
<span class="nc" id="L774">        this.includeFluff = includeFluff;</span>
<span class="nc" id="L775">    }</span>

    /**
     *
     * @return Whether the fluff section will be included when processing the
     *         template
     */
    public boolean getIncludeFluff() {
<span class="nc" id="L783">        return includeFluff;</span>
    }

    /**
     * Tuple composed of EquipmentType and size, used for map keys
     */
    static final class EquipmentKey {
        private final EquipmentType etype;
        private final double size;
        private final boolean armored;

        EquipmentKey(EquipmentType etype, double size) {
<span class="nc" id="L795">            this(etype, size, false);</span>
<span class="nc" id="L796">        }</span>

<span class="nc" id="L798">        EquipmentKey(EquipmentType etype, double size, boolean armored) {</span>
<span class="nc" id="L799">            this.etype = etype;</span>
<span class="nc" id="L800">            this.size = size;</span>
<span class="nc" id="L801">            this.armored = armored;</span>
<span class="nc" id="L802">        }</span>

        String name() {
<span class="nc" id="L805">            return etype.getName(size);</span>
        }

        EquipmentType getType() {
<span class="nc" id="L809">            return etype;</span>
        }

        double getSize() {
<span class="nc" id="L813">            return size;</span>
        }

        boolean isArmored() {
<span class="nc" id="L817">            return armored;</span>
        }

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L822" title="All 2 branches missed.">            return (o instanceof EquipmentKey)</span>
<span class="nc bnc" id="L823" title="All 6 branches missed.">                    &amp;&amp; (etype.equals(((EquipmentKey) o).etype))</span>
                    &amp;&amp; (size == ((EquipmentKey) o).size)
                    &amp;&amp; (armored == ((EquipmentKey) o).armored);
        }

        @Override
        public int hashCode() {
<span class="nc" id="L830">            return Objects.hash(etype, size, armored);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>