<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestAero.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common.verifier</a> &gt; <span class="el_source">TestAero.java</span></div><h1>TestAero.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

/*
 * Author: Reinhard Vicinus
 */

package megamek.common.verifier;

import java.util.*;
import java.util.function.Function;

import megamek.common.*;
import megamek.common.annotations.Nullable;
import megamek.common.util.StringUtil;
import megamek.common.weapons.bayweapons.BayWeapon;
import megamek.common.weapons.capitalweapons.ScreenLauncherWeapon;
import megamek.common.weapons.flamers.VehicleFlamerWeapon;
import megamek.common.weapons.infantry.InfantryWeapon;
import megamek.common.weapons.lasers.CLChemicalLaserWeapon;
import megamek.common.weapons.lrms.LRMWeapon;
import megamek.common.weapons.lrms.LRTWeapon;
import megamek.common.weapons.missiles.MRMWeapon;
import megamek.common.weapons.missiles.RLWeapon;
import megamek.common.weapons.srms.SRMWeapon;
import megamek.common.weapons.srms.SRTWeapon;

/**
 * Class for testing and validating instantiations for Conventional Fighters and
 * Aerospace Fighters.
 * 
 * @author arlith
 *
 */
public class TestAero extends TestEntity {
<span class="fc" id="L48">    private Aero aero = null;</span>
    
    /**
     * An enumeration that keeps track of the legal armors for Aerospace and 
     * Conventional fighters.  Each entry consists of the type, which 
     * corresponds to the types defined in &lt;code&gt;EquipmentType&lt;/code&gt; as well
     * as the number of slots the armor takes up.
     * 
     * @author arlith
     *
     */
<span class="nc" id="L59">    public static enum AeroArmor{</span>
<span class="nc" id="L60">        STANDARD(EquipmentType.T_ARMOR_STANDARD, 0, 0, false),   </span>
<span class="nc" id="L61">        CLAN_FERRO_ALUM(EquipmentType.T_ARMOR_ALUM, 1, 1, true),</span>
<span class="nc" id="L62">        FERRO_LAMELLOR(EquipmentType.T_ARMOR_FERRO_LAMELLOR, 2, 1, true),</span>
<span class="nc" id="L63">        CLAN_REACTIVE(EquipmentType.T_ARMOR_REACTIVE, 1, 1, true),</span>
<span class="nc" id="L64">        CLAN_REFLECTIVE(EquipmentType.T_ARMOR_REFLECTIVE, 1, 1, true),</span>
<span class="nc" id="L65">        ANTI_PENETRATIVE_ABLATION(</span>
                EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION, 1, 1, false),
<span class="nc" id="L67">        BALLISTIC_REINFORCED(</span>
                EquipmentType.T_ARMOR_BALLISTIC_REINFORCED, 2, 1, false),
<span class="nc" id="L69">        FERRO_ALUM(EquipmentType.T_ARMOR_ALUM, 2, 1, false),</span>
<span class="nc" id="L70">        FERRO_PROTO(EquipmentType.T_ARMOR_FERRO_ALUM_PROTO, 3, 1, false),        </span>
<span class="nc" id="L71">        HEAVY_FERRO_ALUM(EquipmentType.T_ARMOR_HEAVY_ALUM, 4, 2, false),</span>
<span class="nc" id="L72">        LIGHT_FERRO_ALUM(EquipmentType.T_ARMOR_LIGHT_ALUM, 1, 1, false),</span>
<span class="nc" id="L73">        PRIMITIVE(EquipmentType.T_ARMOR_PRIMITIVE_FIGHTER, 0, 0, false),        </span>
<span class="nc" id="L74">        REACTIVE(EquipmentType.T_ARMOR_REACTIVE, 3, 1, false),        </span>
<span class="nc" id="L75">        REFLECTIVE(EquipmentType.T_ARMOR_REFLECTIVE, 2, 1, false),</span>
<span class="nc" id="L76">        STEALTH_VEHICLE(EquipmentType.T_ARMOR_STEALTH_VEHICLE, 2, 1, false);</span>

        /**
         * The type, corresponding to types defined in 
         * &lt;code&gt;EquipmentType&lt;/code&gt;.
         */
        public final int type;
        
        /**
         * The number of spaces occupied by the armor type.  Armors that take 
         * up 1 space take up space in the aft, those with 2 take up space in
         * each wing, 3 takes up space in both wings and the aft, 4 takes up
         * space in each possible arc (nose, aft, left wing, right wing).
         */
        public final int space;
        
        /**
         * The number of weapon spaces occupied by patchwork armor. Unlike standard armor, patchwork
         * armor takes up slots in the location where it's used.
         */
        public final int patchworkSpace;
        
        /**
         * Denotes whether this armor is Clan or not.
         */
        public boolean isClan;
        
<span class="nc" id="L103">        private AeroArmor(int t, int s, int p, boolean c){</span>
<span class="nc" id="L104">            type = t;</span>
<span class="nc" id="L105">            space = s;</span>
<span class="nc" id="L106">            patchworkSpace = p;</span>
<span class="nc" id="L107">            isClan = c;</span>
<span class="nc" id="L108">        }</span>
        
        /**
         * Given an armor type, return the &lt;code&gt;AeroArmor&lt;/code&gt; instance that
         * represents that type.
         * 
         * @param t  The armor type.
         * @param c  Whether this armor type is Clan or not.
         * @return   The &lt;code&gt;AeroArmor&lt;/code&gt; that correspondes to the given 
         *              type or null if no match was found.
         */
        public static AeroArmor getArmor(int t, boolean c){
<span class="nc bnc" id="L120" title="All 2 branches missed.">            for (AeroArmor a : values()){</span>
<span class="nc bnc" id="L121" title="All 6 branches missed.">                if ((a.type == t) &amp;&amp; ((a.isClan == c)</span>
                        || (t == EquipmentType.T_ARMOR_STANDARD))) {
<span class="nc" id="L123">                    return a;</span>
                }
            }
<span class="nc" id="L126">            return null;</span>
        }
        
        /**
         * @return The &lt;code&gt;MiscType&lt;/code&gt; for this armor.
         */
        public EquipmentType getArmor() {
<span class="nc" id="L133">            String name = EquipmentType.getArmorTypeName(type, isClan);</span>
<span class="nc" id="L134">            return EquipmentType.get(name);</span>
        }
        
    }
    
    /**
     * Filters all fighter armor according to given tech constraints
     * 
     * @param techManager
     * @return A list of all armors that meet the tech constraints
     */
    public static List&lt;EquipmentType&gt; legalArmorsFor(ITechManager techManager) {
<span class="nc" id="L146">        List&lt;EquipmentType&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        for (AeroArmor armor : AeroArmor.values()) {</span>
<span class="nc" id="L148">            final EquipmentType eq = armor.getArmor();</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">            if ((null != eq) &amp;&amp; techManager.isLegal(eq)) {</span>
<span class="nc" id="L150">                retVal.add(eq);</span>
            }
        }
<span class="nc" id="L153">        return retVal;</span>
    }
    
    /**
     * Defines how many spaces each arc has for weapons. Large units can add more by increasing weight
     * of master fire control systems.
     */
    public static int slotsPerArc(Aero aero) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_WARSHIP)</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                || aero.hasETypeFlag(Entity.ETYPE_SPACE_STATION)) {</span>
<span class="nc" id="L163">            return 20;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                || aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L166">            return 12;</span>
        } else {
<span class="nc" id="L168">            return 5;</span>
        }
    }
    
    /**
     * @param aero A large craft
     * @return     The maximum number of bay doors. Aerospace units that are not large craft have
     *             a maximum of zero.
     */
    public static int maxBayDoors(Aero aero) {
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_WARSHIP)) {</span>
<span class="nc" id="L179">            return 8 + (int)Math.ceil(aero.getWeight() / 100000);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L181">            return 8 + (int)Math.ceil(aero.getWeight() / 75000);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                || (aero.hasETypeFlag(Entity.ETYPE_DROPSHIP))) {</span>
<span class="nc" id="L184">            return 7 + (int)Math.ceil(aero.getWeight() / 50000);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            return aero.isSpheroid()? 4 : 2;</span>
        } else {
<span class="nc" id="L188">            return 0;</span>
        }
    }
    
<span class="nc" id="L192">    public enum Quarters {</span>
<span class="nc" id="L193">        FIRST_CLASS (10, FirstClassQuartersCargoBay.class, size -&gt; new FirstClassQuartersCargoBay(size, 0)),</span>
<span class="nc" id="L194">        STANDARD (7, CrewQuartersCargoBay.class, size -&gt; new CrewQuartersCargoBay(size, 0)),</span>
<span class="nc" id="L195">        SECOND_CLASS (7, SecondClassQuartersCargoBay.class, size -&gt; new SecondClassQuartersCargoBay(size, 0)),</span>
<span class="nc" id="L196">        STEERAGE (5, SteerageQuartersCargoBay.class, size -&gt; new SteerageQuartersCargoBay(size, 0));</span>
        
        private int tonnage;
        private Class&lt;? extends Bay&gt; bayClass;
        private Function&lt;Integer, Bay&gt; init;
        
<span class="nc" id="L202">        Quarters(int tonnage, Class&lt;? extends Bay&gt; bayClass, Function&lt;Integer, Bay&gt; init) {</span>
<span class="nc" id="L203">            this.tonnage = tonnage;</span>
<span class="nc" id="L204">            this.bayClass = bayClass;</span>
<span class="nc" id="L205">            this.init = init;</span>
<span class="nc" id="L206">        }</span>
        
        public int getTonnage() {
<span class="nc" id="L209">            return tonnage;</span>
        }
        
        public static @Nullable Quarters getQuartersForBay(Bay bay) {
<span class="nc bnc" id="L213" title="All 2 branches missed.">            for (Quarters q : values()) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (bay.getClass() == q.bayClass) {</span>
<span class="nc" id="L215">                    return q;</span>
                }
            }
<span class="nc" id="L218">            return null;</span>
        }
        
        public Bay newQuarters(int size) {
<span class="nc" id="L222">            return init.apply(size * tonnage);</span>
        }
        
        public static Map&lt;Quarters, Integer&gt; getQuartersByType(Aero aero) {
<span class="nc" id="L226">            EnumMap&lt;TestAero.Quarters, Integer&gt; sizes = new EnumMap&lt;&gt;(TestAero.Quarters.class);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            for (Quarters q : values()) {</span>
<span class="nc" id="L228">                sizes.put(q, 0);</span>
            }
<span class="nc bnc" id="L230" title="All 2 branches missed.">            for (Bay bay : aero.getTransportBays()) {</span>
<span class="nc" id="L231">                Quarters q = getQuartersForBay(bay);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                if (null != q) {</span>
<span class="nc" id="L233">                    sizes.merge(q, (int) bay.getCapacity(), Integer::sum);</span>
                }
<span class="nc" id="L235">            }</span>
<span class="nc" id="L236">            return sizes;</span>
        }
    }
    
    /**
     * Defines the maximum engine rating that an Aero can have.
     */
<span class="fc" id="L243">    public static int MAX_ENGINE_RATING = 400;</span>
    
    /**
     *  Computes the maximum number of armor points for a given Aero
     *  at the given tonnage.
     *   
     * @param aero
     * @param tonnage
     * @return
     */
    public static int maxArmorPoints(Entity aero, double tonnage){
<span class="nc" id="L254">        long eType = aero.getEntityType();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L256">            return TestSmallCraft.maxArmorPoints((SmallCraft)aero);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L258">                return (int)(tonnage * 1);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        } else if (eType == Entity.ETYPE_AERO){</span>
<span class="nc" id="L260">            return (int)(tonnage * 8);</span>
        } else {
<span class="nc" id="L262">            return 0;</span>
        }
    }
    
    /**
     * Computes the available space for each location in the supplied Aero.
     * Aeros can only have so many weapons in each location, and this available
     * space is reduced by the armor type.
     * 
     * @param a  The aero in question
     * @return   Returns an int array, where each element corresponds to a 
     *           location and the value is the number of weapons the Aero can
     *           have in that location. Returns null if the space cannot be determined
     *           due to illegal armor type value.
     */
    public static @Nullable int[] availableSpace(Aero a){
        // Keep track of the max space we have in each arc
<span class="nc" id="L279">        int slots = slotsPerArc(a);</span>
<span class="nc" id="L280">        int availSpace[] = </span>
            { slots, slots, slots, slots };
        
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (!a.hasPatchworkArmor()) {</span>
            // Get the armor type, to determine how much space it uses
<span class="nc" id="L285">            AeroArmor armor = </span>
<span class="nc" id="L286">                    AeroArmor.getArmor(a.getArmorType(Aero.LOC_NOSE),</span>
<span class="nc" id="L287">                                       a.isClanArmor(Aero.LOC_NOSE));</span>
            
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (armor == null){            </span>
<span class="nc" id="L290">                return null;</span>
            }
            // Remove space for each location until we've allocated the armor
<span class="nc" id="L293">            int spaceUsedByArmor = armor.space;</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            int loc = (spaceUsedByArmor != 2) ? Aero.LOC_AFT : Aero.LOC_RWING;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            while (spaceUsedByArmor &gt; 0){</span>
<span class="nc" id="L296">                availSpace[loc]--;</span>
<span class="nc" id="L297">                spaceUsedByArmor--;</span>
<span class="nc" id="L298">                loc--;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                if (loc &lt; 0){</span>
<span class="nc" id="L300">                    loc = Aero.LOC_AFT;</span>
                }
            }
<span class="nc" id="L303">        } else {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            for (int loc = 0; loc &lt; Aero.LOC_WINGS; loc++) {</span>
<span class="nc" id="L305">                AeroArmor armor = AeroArmor.getArmor(a.getArmorType(loc),</span>
<span class="nc" id="L306">                        a.isClanArmor(loc));</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                if (null == armor) {</span>
<span class="nc" id="L308">                    return null;</span>
                } else {
<span class="nc" id="L310">                    availSpace[loc] -= armor.patchworkSpace;</span>
                }
            }
        }
        // Blue shield particle field dampener takes one slot in each arc.
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (a.hasMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            for (int i = 0; i &lt; availSpace.length; i++) {</span>
<span class="nc" id="L317">                availSpace[i]--;</span>
            }
        }
        
        // XXL engines take up extra space in the aft in conventional fighters
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (((a.getEntityType() &amp; Entity.ETYPE_CONV_FIGHTER) != 0)</span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">                &amp;&amp; a.hasEngine() &amp;&amp; (a.getEngine().getEngineType() == Engine.XXL_ENGINE)) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (a.getEngine().hasFlag(Engine.CLAN_ENGINE)) {</span>
<span class="nc" id="L325">                availSpace[Aero.LOC_AFT] -= 2;</span>
            } else {
<span class="nc" id="L327">                availSpace[Aero.LOC_AFT] -= 4;</span>
            }
        }
<span class="nc" id="L330">        return availSpace;</span>
    }
    
    public static boolean usesWeaponSlot(Entity en, EquipmentType eq) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (eq instanceof WeaponType) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            return !(eq instanceof BayWeapon);</span>
        }
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (eq instanceof MiscType) {</span>
            // Equipment that takes up a slot on fighters and small craft, but not large craft.
<span class="nc bnc" id="L339" title="All 4 branches missed.">            if (!en.hasETypeFlag(Entity.ETYPE_DROPSHIP) &amp;&amp; !en.hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                    &amp;&amp; (eq.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                            || eq.hasFlag(MiscType.F_WATCHDOG)</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                            || eq.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                            || eq.hasFlag(MiscType.F_ANGEL_ECM)</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                            || eq.hasFlag(MiscType.F_EW_EQUIPMENT)</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                            || eq.hasFlag(MiscType.F_BOOBY_TRAP)</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                            || eq.hasFlag(MiscType.F_SENSOR_DISPENSER))) {</span>
<span class="nc" id="L347">                return true;</span>
                
            }
            // Equipment that takes a slot on all aerospace units
<span class="nc bnc" id="L351" title="All 2 branches missed.">            return  eq.hasFlag(MiscType.F_CHAFF_POD)</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_SPACE_MINE_DISPENSER)</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_MOBILE_HPG)</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_RECON_CAMERA)</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_HIRES_IMAGER)</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_HYPERSPECTRAL_IMAGER)</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_INFRARED_IMAGER)</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_LOOKDOWN_RADAR);</span>
        }
<span class="nc" id="L360">        return false;</span>
    }
    
    /**
     * Computes the engine rating for the given entity type.
     * 
     * @param unit
     * @param tonnage
     * @param desiredSafeThrust
     * @return
     */
    public static int calculateEngineRating(Aero unit, int tonnage, int desiredSafeThrust){
        int rating;
<span class="nc" id="L373">        long eType = unit.getEntityType();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (unit.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L375">            rating = (tonnage * desiredSafeThrust);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        } else if (eType == Entity.ETYPE_AERO){</span>
<span class="nc" id="L377">            rating = (tonnage * (desiredSafeThrust - 2));</span>
        } else {
<span class="nc" id="L379">            rating = 0;</span>
        }
        
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (unit.isPrimitive()){</span>
<span class="nc" id="L383">            double dRating = rating;</span>
<span class="nc" id="L384">            dRating *= 1.2;</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            if ((dRating % 5) != 0) {</span>
<span class="nc" id="L386">                dRating = (dRating - (dRating % 5)) + 5;</span>
            }
<span class="nc" id="L388">            rating = (int) dRating;</span>
        }
<span class="nc" id="L390">        return rating;</span>
    }
    
    /**
     * Computes and returns the maximum number of turns the given unit could
     * fly at safe thrust given its fuel payload.  Aerospace fighters consume
     * 1 fuel point per thrust point spent up the the maximum safe thrust, 
     * whereas conventional fighters with turbine engines consume 0.5 fuel
     * points per thrust point spent up to the maximum safe thrust.
     * See Strategic Operations pg 34. 
     * 
     * @param aero
     * @return
     */
    public static float calculateMaxTurnsAtSafe(Aero aero){
<span class="nc" id="L405">        int fuelPoints = aero.getFuel();</span>
        float fuelPerTurn;
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                &amp;&amp; aero.hasEngine()</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                &amp;&amp; (aero.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc" id="L410">            fuelPerTurn = aero.getWalkMP() * 0.5f;</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        } else if (aero.getWalkMP() == 0) {</span>
<span class="nc" id="L412">            fuelPerTurn = 0.2f;</span>
        } else {
<span class="nc" id="L414">            fuelPerTurn = aero.getWalkMP();</span>
        }
<span class="nc" id="L416">        return fuelPoints/fuelPerTurn;        </span>
    }
    
    /**
     * Computes and returns the maximum number of turns the given unit could
     * fly at max thrust given its fuel payload.  Aerospace fighters consume
     * 1 fuel point per thrust point spent up the the maximum safe thrust and
     * 2 fuel points per thrust point afterwards, whereas conventional fighters 
     * with ICE engines consume 0.5 fuel points per thrust point spent up to 
     * the maximum safe thrust and 1 fuel point per thrust up to the maximum 
     * thrust.  Conventional fighters with Fusion engines spend 0.5 fuel points
     * per thrust up to the safe thrust and then 2 fuel points per thrust 
     * afterwards.  See Strategic Operations pg 34.
     * 
     * @param aero
     * @return
     */
    public static float calculateMaxTurnsAtMax(Aero aero){
<span class="nc" id="L434">        int fuelPoints = aero.getFuel();</span>
        float fuelPerTurn;
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L437">            fuelPerTurn = aero.getWalkMP() * 0.5f;</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if(aero.hasEngine()) {</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                if(aero.getEngine().isFusion()) {</span>
<span class="nc" id="L440">                    fuelPerTurn += (aero.getRunMP()-aero.getWalkMP()) * 2;</span>
                } else {
<span class="nc" id="L442">                    fuelPerTurn += (aero.getRunMP()-aero.getWalkMP());</span>
                }
            }
<span class="nc bnc" id="L445" title="All 2 branches missed.">        } else if (aero.getWalkMP() == 0) {</span>
<span class="nc" id="L446">            fuelPerTurn = 0.2f;</span>
        } else {
<span class="nc" id="L448">            fuelPerTurn = aero.getWalkMP() + </span>
<span class="nc" id="L449">                    (aero.getRunMP()-aero.getWalkMP()) * 2;</span>
        }
<span class="nc" id="L451">        return fuelPoints/fuelPerTurn;       </span>
    }    

    public static int weightFreeHeatSinks(Aero aero) {
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L456">            return TestSmallCraft.weightFreeHeatSinks((SmallCraft) aero);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L458">            return TestAdvancedAerospace.weightFreeHeatSinks((Jumpship) aero);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        } else if (aero.hasEngine()) {</span>
<span class="nc" id="L460">            return aero.getEngine().getWeightFreeEngineHeatSinks();</span>
        } else {
<span class="nc" id="L462">            return 0;</span>
        }
    }
    
    /**
     * Computes and returns the number of days the unit can spend accelerating at 1G 
     * 
     * @param aero
     * @return
     */
    public static double calculateDaysAt1G(Aero aero) {
<span class="nc" id="L473">        double stratUse = aero.getStrategicFuelUse();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if (stratUse &gt; 0) {</span>
<span class="nc" id="L475">            return aero.getFuelTonnage() / aero.getStrategicFuelUse();</span>
        } else {
<span class="nc" id="L477">            return 0.0;</span>
        }
    }
    
    /**
     * Computes and returns the number of days the unit can spend accelerating at maximum thrust. 
     * 
     * @param aero
     * @return
     */
    public static double calculateDaysAtMax(Aero aero) {
<span class="nc" id="L488">        double stratUse = aero.getStrategicFuelUse();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        if (stratUse &gt; 0) {</span>
<span class="nc" id="L490">            double maxMP = aero.getRunMP();</span>
            // check for station-keeping drive
<span class="nc bnc" id="L492" title="All 2 branches missed.">            if (maxMP == 0) {</span>
<span class="nc" id="L493">                maxMP = 0.2;</span>
            }
<span class="nc" id="L495">            return aero.getFuelTonnage() / (aero.getStrategicFuelUse() * maxMP / 2.0);</span>
        } else {
<span class="nc" id="L497">            return 0.0;</span>
        }
    }
    
    public TestAero(Aero a, TestEntityOption option, String fs) {
<span class="fc" id="L502">        super(option, a.getEngine(), getArmor(a), getStructure(a));</span>
<span class="fc" id="L503">        aero = a;</span>
<span class="fc" id="L504">        fileString = fs;</span>
<span class="fc" id="L505">    }</span>

    private static Structure getStructure(Aero aero) {
<span class="fc" id="L508">        int type = aero.getStructureType();</span>
<span class="fc" id="L509">        return new Structure(type, false, aero.getMovementMode());</span>
    }

    private static Armor[] getArmor(Aero aero) {
        Armor[] armor;
<span class="fc" id="L514">        armor = new Armor[1];</span>
<span class="fc" id="L515">        int type = aero.getArmorType(1);</span>
<span class="fc" id="L516">        int flag = 0;</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">        if (aero.isClanArmor(1)) {</span>
<span class="nc" id="L518">            flag |= Armor.CLAN_ARMOR;</span>
        }
<span class="fc" id="L520">        armor[0] = new Armor(type, flag);</span>
<span class="fc" id="L521">        return armor;</span>

    }

    @Override
    public Entity getEntity() {
<span class="nc" id="L527">        return aero;</span>
    }

    @Override
    public boolean isTank() {
<span class="nc" id="L532">        return false;</span>
    }

    @Override
    public boolean isMech() {
<span class="nc" id="L537">        return false;</span>
    }
    
    @Override
    public boolean isAero() {
<span class="nc" id="L542">        return true;</span>
    }
    
    @Override
    public boolean isSmallCraft() {
<span class="nc" id="L547">        return false;</span>
    }
    
    @Override
    public boolean isAdvancedAerospace() {
<span class="nc" id="L552">        return false;</span>
    }
    
    @Override
    public boolean isProtomech() {
<span class="nc" id="L557">        return false;</span>
    }

    @Override
    public double getWeightMisc() {
        // VSTOL equipment weighs extra for conventional fighters
<span class="nc bnc" id="L563" title="All 4 branches missed.">        if ((aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) &amp;&amp; aero.isVSTOL()) {</span>
            // Weight = tonnage * 0.05 rounded up to nearest half ton
<span class="nc" id="L565">            return Math.ceil(0.05 * aero.getWeight() * 2) / 2.0;</span>
        }
<span class="nc" id="L567">        return 0.0f;</span>
    }

    @Override
    public double getWeightPowerAmp() {
        // Conventional Fighters with ICE engines may need a power amp
<span class="nc bnc" id="L573" title="All 4 branches missed.">        if ((aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) &amp;&amp; aero.hasEngine()</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                &amp;&amp; (aero.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc" id="L575">            double weight = 0;</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">            for (Mounted m : aero.getWeaponList()) {</span>
<span class="nc" id="L577">                WeaponType wt = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L578" title="All 6 branches missed.">                if (wt.hasFlag(WeaponType.F_ENERGY) &amp;&amp; </span>
                        !(wt instanceof CLChemicalLaserWeapon) &amp;&amp; 
                        !(wt instanceof VehicleFlamerWeapon)) {
<span class="nc" id="L581">                    weight += m.getTonnage();</span>
                }
<span class="nc" id="L583">                Mounted linkedBy = m.getLinkedBy();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                if ((linkedBy != null) &amp;&amp; </span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">                        (linkedBy.getType() instanceof MiscType) &amp;&amp; </span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                        linkedBy.getType().hasFlag(MiscType.F_PPC_CAPACITOR)){</span>
<span class="nc" id="L587">                    weight += linkedBy.getTonnage();</span>
                }
<span class="nc" id="L589">            }</span>
            // Power amp weighs:
            //   energy weapon tonnage * 0.1 rounded to nearest half ton
<span class="nc" id="L592">            return Math.ceil(0.1 * weight * 2) / 2.0;</span>
        }
<span class="nc" id="L594">        return 0;</span>
    }
    
    @Override
    public double getWeightEngine() {
<span class="nc" id="L599">        double wt = super.getWeightEngine();</span>
        // Conventional fighters with fusion engines require extra shielding.
        // Per TacOps fission engines require extra shielding as well.
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (getEntity().hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">                &amp;&amp; (null != getEntity().getEngine())</span>
<span class="nc bnc" id="L604" title="All 4 branches missed.">                &amp;&amp; (getEntity().getEngine().isFusion() || getEntity().getEngine().hasFlag(Engine.FISSION))) {</span>
<span class="nc" id="L605">            wt = ceil(wt * 1.5, Ceil.HALFTON);</span>
        }
<span class="nc" id="L607">        return wt;</span>
    }

    @Override
    public double getWeightControls() {
        // Controls for Aerospace Fighters and Conventional Fighters consists
        //  of the cockpit and the fuel
        double weight;
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
            // Weight = tonnage * 0.1 rounded to nearest half ton
<span class="nc" id="L617">            weight = Math.round(0.1 * aero.getWeight()*2) / 2.0;</span>
        } else {
<span class="nc" id="L619">            weight = 3.0;</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">            if (aero.getCockpitType() == Aero.COCKPIT_SMALL) {</span>
<span class="nc" id="L621">                weight = 2.0;</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        } else if (aero.getCockpitType() == Aero.COCKPIT_COMMAND_CONSOLE){                       </span>
<span class="nc" id="L623">                weight = 6.0;</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">            } else if (aero.getCockpitType() == Aero.COCKPIT_PRIMITIVE) {</span>
<span class="nc" id="L625">                weight = 5.0;</span>
            } 
        }   
<span class="nc" id="L628">        return weight;</span>
    }
    
    public double getWeightFuel() {
<span class="nc" id="L632">        return aero.getFuelTonnage();</span>
    }

    @Override
    public int getCountHeatSinks() {
<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L638">            return heatNeutralHSRequirement();</span>
        }
<span class="nc" id="L640">        return aero.getHeatSinks();</span>
    }

    @Override
    public double getWeightHeatSinks() {
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L646">            int required = heatNeutralHSRequirement();</span>
<span class="nc" id="L647">            return Math.max(0, required - engine.getWeightFreeEngineHeatSinks());</span>
        } else {
<span class="nc" id="L649">            return Math.max(getCountHeatSinks() - engine.getWeightFreeEngineHeatSinks(), 0);</span>
        }
    }

    @Override
    public boolean hasDoubleHeatSinks() {
<span class="nc bnc" id="L655" title="All 2 branches missed.">        return aero.getHeatType() == Aero.HEAT_DOUBLE;</span>
    }

    @Override
    public String printWeightMisc() {
<span class="nc" id="L660">        double weight = getWeightMisc();</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">        if (weight &gt; 0){</span>
<span class="nc" id="L662">            StringBuffer retVal = new StringBuffer(StringUtil.makeLength(</span>
<span class="nc" id="L663">                    &quot;VSTOL equipment:&quot;, getPrintSize() - 5));</span>
<span class="nc" id="L664">            retVal.append(makeWeightString(weight));</span>
<span class="nc" id="L665">            retVal.append(&quot;\n&quot;);</span>
<span class="nc" id="L666">            return retVal.toString();</span>
        }
<span class="nc" id="L668">        return &quot;&quot;;</span>
    }

    @Override
    public String printWeightControls() {
<span class="nc" id="L673">        StringBuffer retVal = new StringBuffer(StringUtil.makeLength(</span>
<span class="nc" id="L674">                aero.getCockpitTypeString() + &quot;:&quot;, getPrintSize() - 5));</span>
<span class="nc" id="L675">        retVal.append(makeWeightString(getWeightControls()));</span>
<span class="nc" id="L676">        retVal.append(&quot;\n&quot;);</span>
<span class="nc" id="L677">        return retVal.toString();</span>
    }
        
    public String printWeightFuel() {
<span class="nc" id="L681">        StringBuffer retVal = new StringBuffer(StringUtil.makeLength(</span>
<span class="nc" id="L682">                &quot;Fuel: &quot;, getPrintSize() - 5));</span>
<span class="nc" id="L683">        retVal.append(makeWeightString(getWeightFuel()));</span>
<span class="nc" id="L684">        retVal.append(&quot;\n&quot;);</span>
<span class="nc" id="L685">        return retVal.toString();</span>
    }

    public Aero getAero() {
<span class="nc" id="L689">        return aero;</span>
    }

    public String printArmorLocProp(int loc, int wert) {
<span class="nc" id="L693">        return &quot; is greater than &quot; + Integer.toString(wert) + &quot;!&quot;;</span>
    }

    /**
     * Checks to see if this unit has valid armor assignment.
     * 
     * @param buff
     * @return
     */
    public boolean correctArmor(StringBuffer buff) {
<span class="nc" id="L703">        boolean correct = true;</span>
<span class="nc" id="L704">        int maxArmorPoints = maxArmorPoints(aero,aero.getWeight());</span>
<span class="nc" id="L705">        int armorTotal = 0;</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">        for (int loc = 0; loc &lt; aero.locations(); loc++) {</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">            if (aero.getOArmor(loc) &gt; maxArmorPoints) {</span>
<span class="nc" id="L708">                buff.append(printArmorLocation(loc))</span>
<span class="nc" id="L709">                        .append(printArmorLocProp(loc,</span>
<span class="nc" id="L710">                                maxArmorPoints)).append(&quot;\n&quot;);</span>
<span class="nc" id="L711">                correct = false;</span>
            }
<span class="nc" id="L713">            armorTotal += aero.getOArmor(loc);</span>
        }
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (armorTotal &gt; maxArmorPoints){</span>
<span class="nc" id="L716">            buff.append(&quot;Total armor,&quot; + armorTotal + </span>
                    &quot;, is greater than the maximum: &quot; + maxArmorPoints + &quot;\n&quot;);
<span class="nc" id="L718">            correct = false;</span>
        }

<span class="nc" id="L721">        return correct ;</span>
    }
    
    /**
     * Checks that Conventional fighters only have a standard cockpit and that
     * Aerospace fighters have a valid cockpit (standard, small, primitive, 
     * command console).
     * 
     * @param buff
     * @return
     */
    public boolean correctControlSystems(StringBuffer buff){
<span class="nc bnc" id="L733" title="All 2 branches missed.">        if ((aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) &amp;&amp;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">                aero.getCockpitType() != Aero.COCKPIT_STANDARD){</span>
<span class="nc" id="L735">            buff.append(</span>
                    &quot;Conventional fighters may only have standard cockpits!&quot;);
<span class="nc" id="L737">            return false;</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">        } else if (aero.getCockpitType() &lt; Aero.COCKPIT_STANDARD || </span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">                aero.getCockpitType() &gt; Aero.COCKPIT_PRIMITIVE){</span>
<span class="nc" id="L740">            buff.append(</span>
                    &quot;Invalid cockpit type!&quot;);
<span class="nc" id="L742">            return false;</span>
        }
<span class="nc" id="L744">        return true;</span>
    }
    
    public List&lt;Mounted&gt; checkCriticalSlotsForEquipment(Entity entity) {
<span class="nc" id="L748">        List&lt;Mounted&gt; unallocated = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">        for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L750" title="All 6 branches missed.">            if ((m.getLocation() == Entity.LOC_NONE) &amp;&amp; !m.isOneShotAmmo() &amp;&amp; (m.getCriticals() &gt; 0)) {</span>
<span class="nc" id="L751">                unallocated.add(m);</span>
            }
<span class="nc" id="L753">        }</span>
<span class="nc" id="L754">        return unallocated;</span>
    }

    /**
     * For Aerospace and Conventional fighters the only thing we need to ensure
     * is that they do not mount more weapons in each arc then allowed.  They
     * have boundless space for equipment.  Certain armor types reduce the 
     * number of spaces available in each arc.
     * 
     * @param buff  A buffer for error messages
     * @return  True if the mounted weapons are valid, else false
     */
    public boolean correctCriticals(StringBuffer buff) {
<span class="nc" id="L767">        boolean correct = true;</span>

<span class="nc" id="L769">        List&lt;Mounted&gt; unallocated = checkCriticalSlotsForEquipment(aero);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (!unallocated.isEmpty()) {</span>
<span class="nc" id="L771">            buff.append(&quot;Unallocated Equipment:\n&quot;);</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">            for (Mounted mount : unallocated) {</span>
<span class="nc" id="L773">                buff.append(mount.getType().getInternalName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L774">            }</span>
<span class="nc" id="L775">            correct = false;</span>
        }
<span class="nc" id="L777">        int[] numWeapons = new int[aero.locations()];</span>
<span class="nc" id="L778">        int numBombs = 0;</span>
        
<span class="nc bnc" id="L780" title="All 2 branches missed.">        for (Mounted m : aero.getWeaponList()){</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">            if (m.getLocation() == Entity.LOC_NONE)</span>
<span class="nc" id="L782">                continue;</span>
            
            // Aeros can't use special munitions except for artemis, exceptions
            //  LBX's must use clusters
<span class="nc" id="L786">            WeaponType wt = (WeaponType)m.getType();</span>
<span class="nc" id="L787">            boolean canHaveSpecialMunitions = </span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                    ((wt.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">                    || (wt.getAmmoType() == AmmoType.T_ATM)</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">                    || (wt.getAmmoType() == AmmoType.T_NARC));</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">            if (wt.getAmmoType() != AmmoType.T_NA</span>
<span class="nc bnc" id="L792" title="All 4 branches missed.">                    &amp;&amp; m.getLinked() != null </span>
                    &amp;&amp; !canHaveSpecialMunitions) {
<span class="nc" id="L794">                EquipmentType linkedType = m.getLinked().getType();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">                boolean hasArtemisFCS = m.getLinkedBy() != null</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">                        &amp;&amp; (m.getLinkedBy().getType().hasFlag(MiscType.F_ARTEMIS)</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                        || m.getLinkedBy().getType().hasFlag(MiscType.F_ARTEMIS_PROTO)</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">                        || m.getLinkedBy().getType().hasFlag(MiscType.F_ARTEMIS_V));</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">                if (linkedType instanceof AmmoType) {</span>
<span class="nc" id="L800">                    AmmoType linkedAT = (AmmoType)linkedType;</span>
                    // Check LBX's
<span class="nc bnc" id="L802" title="All 2 branches missed.">                    if (wt.getAmmoType() == AmmoType.T_AC_LBX &amp;&amp; </span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                            linkedAT.getMunitionType() != AmmoType.M_CLUSTER) {</span>
<span class="nc" id="L804">                        correct = false;</span>
<span class="nc" id="L805">                        buff.append(&quot;Aeros must use cluster munitions!&quot;).append(m.getType().getInternalName())</span>
<span class="nc" id="L806">                                .append(&quot; is using &quot;).append(linkedAT.getInternalName()).append(&quot;\n&quot;);</span>
                    }
                    // Allow Artemis munitions for artemis-linked launchers
<span class="nc bnc" id="L809" title="All 2 branches missed.">                    if (hasArtemisFCS</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">                            &amp;&amp; linkedAT.getMunitionType() != AmmoType.M_STANDARD</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">                            &amp;&amp; linkedAT.getMunitionType() != AmmoType.M_ARTEMIS_CAPABLE</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                            &amp;&amp; linkedAT.getMunitionType() != AmmoType.M_ARTEMIS_V_CAPABLE) {</span>
<span class="nc" id="L813">                        correct = false;</span>
<span class="nc" id="L814">                        buff.append(&quot;Aero using illegal special missile type!&quot;).append(m.getType().getInternalName())</span>
<span class="nc" id="L815">                                .append(&quot; is using &quot;).append(linkedAT.getInternalName()).append(&quot;\n&quot;);</span>
                    }
<span class="nc bnc" id="L817" title="All 4 branches missed.">                    if (linkedAT.getMunitionType() != AmmoType.M_STANDARD </span>
                            &amp;&amp; !hasArtemisFCS 
<span class="nc bnc" id="L819" title="All 2 branches missed.">                            &amp;&amp; wt.getAmmoType() != AmmoType.T_AC_LBX</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                    		&amp;&amp; wt.getAmmoType() != AmmoType.T_SBGAUSS){</span>
<span class="nc" id="L821">                        correct = false;</span>
<span class="nc" id="L822">                        buff.append(&quot;Aeros may not use special munitions! &quot;).append(m.getType().getInternalName())</span>
<span class="nc" id="L823">                                .append(&quot; is using &quot;).append(linkedAT.getInternalName()).append(&quot;\n&quot;);</span>
                    }
                    
                }
            }
            
<span class="nc bnc" id="L829" title="All 2 branches missed.">            if (m.getType().hasFlag(AmmoType.F_SPACE_BOMB) </span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">                    || m.getType().hasFlag(AmmoType.F_GROUND_BOMB)</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                    || m.getType().hasFlag(WeaponType.F_DIVE_BOMB)</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                    || m.getType().hasFlag(WeaponType.F_ALT_BOMB)</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">                    || m.getType().hasFlag(WeaponType.F_SPACE_BOMB)){</span>
<span class="nc" id="L834">                numBombs++;</span>
            } else {
<span class="nc" id="L836">                numWeapons[m.getLocation()]++;</span>
            }
<span class="nc" id="L838">        }</span>

<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (aero.isFighter()) {</span>
<span class="nc" id="L841">            int[] availSpace = availableSpace(aero);</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (availSpace == null) {</span>
<span class="nc" id="L843">                buff.append(&quot;Invalid armor type! Armor: &quot;)</span>
<span class="nc" id="L844">                        .append(EquipmentType.armorNames[aero.getArmorType(Aero.LOC_NOSE)]);</span>
<span class="nc" id="L845">                buff.append(&quot;\n&quot;);</span>
<span class="nc" id="L846">                return false;</span>
            }
<span class="nc bnc" id="L848" title="All 2 branches missed.">            if (numBombs &gt; aero.getMaxBombPoints()) {</span>
<span class="nc" id="L849">                buff.append(&quot;Invalid number of bombs! Unit can mount &quot;).append(aero.getMaxBombPoints())</span>
<span class="nc" id="L850">                        .append(&quot; but &quot;).append(numBombs).append(&quot;are present!&quot;);</span>
<span class="nc" id="L851">                buff.append(&quot;\n&quot;);</span>
<span class="nc" id="L852">                return false;</span>
            }

<span class="nc" id="L855">            String[] locNames = aero.getLocationNames();</span>
<span class="nc" id="L856">            int loc = Aero.LOC_AFT;</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">            while (loc &gt;= 0) {</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                correct &amp;= !(numWeapons[loc] &gt; availSpace[loc]);</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">                if (numWeapons[loc] &gt; availSpace[loc]) {</span>
<span class="nc" id="L860">                    buff.append(locNames[loc]).append(&quot; has &quot;).append(numWeapons[loc])</span>
<span class="nc" id="L861">                            .append(&quot; weapons but it can only fit &quot;).append(availSpace[loc]).append(&quot; weapons!&quot;);</span>
<span class="nc" id="L862">                    buff.append(&quot;\n&quot;);</span>
                }
<span class="nc" id="L864">                loc--;</span>
            }
        }
        
<span class="nc" id="L868">        return correct;</span>
    }
    
    
    /**
     * Checks that the heatsink assignment is legal.  Conventional fighters must
     * have enough heatsinks to dissipate heat from all of their energy weapons
     * and they may only mount standard heatsinks.
     * Aerospace fighters must have at least 10 heatsinks.
     * 
     * @param buff
     * @return
     */
    public boolean correctHeatSinks(StringBuffer buff) {
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if ((aero.getHeatType() != Aero.HEAT_SINGLE) </span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">                &amp;&amp; (aero.getHeatType() != Aero.HEAT_DOUBLE)) {</span>
<span class="nc" id="L884">            buff.append(&quot;Invalid heatsink type!  Valid types are &quot;</span>
                    + Aero.HEAT_SINGLE + &quot; and &quot; + Aero.HEAT_DOUBLE
<span class="nc" id="L886">                    + &quot;.  Found &quot; + aero.getHeatType() + &quot;.&quot;);</span>
<span class="nc" id="L887">            return false;</span>
        }
<span class="nc" id="L889">        return true;</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff) {
<span class="nc" id="L894">        return correctEntity(buff, aero.getTechLevel());</span>
    }

    @Override
    public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {
<span class="nc" id="L899">        boolean correct = true;</span>
        
        // We only support Conventional Fighters and ASF
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (aero.getEntityType() == Entity.ETYPE_DROPSHIP || </span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                aero.getEntityType() == Entity.ETYPE_SMALL_CRAFT ||</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                aero.getEntityType() == Entity.ETYPE_FIGHTER_SQUADRON ||</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">                aero.getEntityType() == Entity.ETYPE_JUMPSHIP ||</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">                aero.getEntityType() == Entity.ETYPE_SPACE_STATION){</span>
<span class="nc" id="L907">            System.out.println(&quot;TestAero only supports Aerospace Fighters &quot; +</span>
                    &quot;and Conventional fighters.  Supplied unit was a &quot; + 
<span class="nc" id="L909">                    Entity.getEntityTypeName(aero.getEntityType()));</span>
<span class="nc" id="L910">            return true;            </span>
        }
        
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (skip()) {</span>
<span class="nc" id="L914">            return true;</span>
        }
<span class="nc bnc" id="L916" title="All 2 branches missed.">        if (!correctWeight(buff)) {</span>
<span class="nc" id="L917">            buff.insert(0, printTechLevel() + printShortMovement());</span>
<span class="nc" id="L918">            buff.append(printWeightCalculation());</span>
<span class="nc" id="L919">            correct = false;</span>
        }
<span class="nc bnc" id="L921" title="All 2 branches missed.">        if (!engine.engineValid) {</span>
<span class="nc" id="L922">            buff.append(engine.problem.toString()).append(&quot;\n\n&quot;);</span>
<span class="nc" id="L923">            correct = false;</span>
        }
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if ((getCountHeatSinks() &lt; engine.getWeightFreeEngineHeatSinks())</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">                &amp;&amp; !aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L927">            buff.append(&quot;Heat Sinks:\n&quot;);</span>
<span class="nc" id="L928">            buff.append(&quot; Engine    &quot;</span>
<span class="nc" id="L929">                    + engine.integralHeatSinkCapacity(false) + &quot;\n&quot;);</span>
<span class="nc" id="L930">            buff.append(&quot; Total     &quot; + getCountHeatSinks() + &quot;\n&quot;);</span>
<span class="nc" id="L931">            buff.append(&quot; Required  &quot; + engine.getWeightFreeEngineHeatSinks()</span>
                    + &quot;\n&quot;);
<span class="nc" id="L933">            correct = false;</span>
        }                
        
<span class="nc bnc" id="L936" title="All 4 branches missed.">        if (showCorrectArmor() &amp;&amp; !correctArmor(buff)) {</span>
<span class="nc" id="L937">            correct = false;</span>
        }
<span class="nc bnc" id="L939" title="All 4 branches missed.">        if (showCorrectCritical() &amp;&amp; !correctCriticals(buff)) {</span>
<span class="nc" id="L940">            correct = false;</span>
        }
<span class="nc bnc" id="L942" title="All 4 branches missed.">        if (showFailedEquip() &amp;&amp; hasFailedEquipment(buff)) {</span>
<span class="nc" id="L943">            correct = false;</span>
        }
<span class="nc bnc" id="L945" title="All 4 branches missed.">        if (showIncorrectIntroYear() &amp;&amp; hasIncorrectIntroYear(buff)) {</span>
<span class="nc" id="L946">            correct = false;</span>
        }
        
<span class="nc" id="L949">        correct &amp;= correctControlSystems(buff);</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">        correct &amp;= !hasIllegalTechLevels(buff, ammoTechLvl);</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">        correct &amp;= !hasIllegalEquipmentCombinations(buff);</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">        correct &amp;= !hasMismatchedLateralWeapons(buff);</span>
<span class="nc" id="L953">        correct &amp;= correctHeatSinks(buff);</span>
        
<span class="nc" id="L955">        return correct;</span>
    }

    /**
     * Checks that the weapon loads in the wings match each other.
     * @param buff The buffer that contains the collected error messages.
     * @return     Whether the lateral weapons are mismatched.
     */
    public boolean hasMismatchedLateralWeapons(StringBuffer buff) {
<span class="nc" id="L964">        boolean illegal = false;</span>
<span class="nc" id="L965">        Map&lt;EquipmentType,Integer&gt; leftWing = new HashMap&lt;&gt;();</span>
<span class="nc" id="L966">        Map&lt;EquipmentType,Integer&gt; rightWing = new HashMap&lt;&gt;();</span>
<span class="nc" id="L967">        Map&lt;EquipmentType,Integer&gt; leftWingRear = new HashMap&lt;&gt;();</span>
<span class="nc" id="L968">        Map&lt;EquipmentType,Integer&gt; rightWingRear = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">        for (Mounted m : aero.getEquipment()) {</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">            if (m.getType() instanceof WeaponType) {</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                if (m.getLocation() == Aero.LOC_LWING) {</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">                    if (m.isRearMounted()) {</span>
<span class="nc" id="L973">                        leftWingRear.merge(m.getType(), 1, Integer::sum);</span>
                    } else {
<span class="nc" id="L975">                        leftWing.merge(m.getType(), 1, Integer::sum);</span>
                    }
<span class="nc bnc" id="L977" title="All 2 branches missed.">                } else if (m.getLocation() == SmallCraft.LOC_RWING) {</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">                    if (m.isRearMounted()) {</span>
<span class="nc" id="L979">                        rightWingRear.merge(m.getType(), 1, Integer::sum);</span>
                    } else {
<span class="nc" id="L981">                        rightWing.merge(m.getType(), 1, Integer::sum);</span>
                    }
                }
            }
<span class="nc" id="L985">        }</span>
<span class="nc" id="L986">        boolean lateralMatch = true;</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">        for (EquipmentType eq : leftWing.keySet()) {</span>
<span class="nc bnc" id="L988" title="All 4 branches missed.">            if (!rightWing.containsKey(eq) || !leftWing.get(eq).equals(rightWing.get(eq))) {</span>
<span class="nc" id="L989">                lateralMatch = false;</span>
<span class="nc" id="L990">                break;</span>
            }
<span class="nc" id="L992">        }</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">        if (lateralMatch) {</span>
            //We've already checked counts, so in the reverse direction we only need to see if there's
            //anything not found on the other side.
<span class="nc bnc" id="L996" title="All 2 branches missed.">            for (EquipmentType eq : rightWing.keySet()) {</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">                if (!leftWing.containsKey(eq)) {</span>
<span class="nc" id="L998">                    lateralMatch = false;</span>
<span class="nc" id="L999">                    break;</span>
                }
<span class="nc" id="L1001">            }</span>
        }
<span class="nc bnc" id="L1003" title="All 2 branches missed.">        if (lateralMatch) {</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            for (EquipmentType eq : leftWingRear.keySet()) {</span>
<span class="nc bnc" id="L1005" title="All 4 branches missed.">                if (!rightWingRear.containsKey(eq) || !leftWingRear.get(eq).equals(rightWingRear.get(eq))) {</span>
<span class="nc" id="L1006">                    lateralMatch = false;</span>
<span class="nc" id="L1007">                    break;</span>
                }
<span class="nc" id="L1009">            }</span>
        }
<span class="nc bnc" id="L1011" title="All 2 branches missed.">        if (lateralMatch) {</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">            for (EquipmentType eq : rightWingRear.keySet()) {</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                if (!leftWingRear.containsKey(eq)) {</span>
<span class="nc" id="L1014">                    lateralMatch = false;</span>
<span class="nc" id="L1015">                    break;</span>
                }
<span class="nc" id="L1017">            }</span>
        }
<span class="nc bnc" id="L1019" title="All 2 branches missed.">        if (!lateralMatch) {</span>
<span class="nc" id="L1020">            buff.append(&quot;Left and right side weapon loads do not match.\n&quot;);</span>
<span class="nc" id="L1021">            illegal = true;</span>
        }
<span class="nc" id="L1023">        return illegal;</span>
    }

    /**
     * @param eq        The equipment
     * @param location  A location index on the Entity
     * @param buffer    If non-null and the location is invalid, will be appended with an explanation
     * @return          Whether the equipment can be mounted in the location on the aerospace fighter,
     *                  conventional fighter, or fixed wing support vehicle
     */
    public static boolean isValidAeroLocation(EquipmentType eq, int location, @Nullable StringBuffer buffer) {
<span class="nc bnc" id="L1034" title="All 2 branches missed.">        if (eq instanceof AmmoType) {</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">            if (location != Aero.LOC_FUSELAGE) {</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1037">                    buffer.append(eq.getName()).append(&quot; must be mounted in the fuselage.\n&quot;);</span>
                }
<span class="nc" id="L1039">                return false;</span>
            }
<span class="nc bnc" id="L1041" title="All 2 branches missed.">        } else if (eq instanceof MiscType) {</span>
            // Weapon enhancements go in the same location as the weapon
<span class="nc bnc" id="L1043" title="All 2 branches missed.">            if ((eq.hasFlag(MiscType.F_ARTEMIS)</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_ARTEMIS_V)</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_ARTEMIS_PROTO)</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_APOLLO)</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">                    || eq.hasFlag(MiscType.F_PPC_CAPACITOR)</span>
<span class="nc bnc" id="L1048" title="All 4 branches missed.">                    || eq.hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) &amp;&amp; (location &gt;= Aero.LOC_WINGS)) {</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                if (location != Aero.LOC_FUSELAGE) {</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                    if (buffer != null) {</span>
<span class="nc" id="L1051">                        buffer.append(eq.getName()).append(&quot; must be mounted in a location with a firing arc.\n&quot;);</span>
                    }
<span class="nc" id="L1053">                    return false;</span>
                }
<span class="nc bnc" id="L1055" title="All 4 branches missed.">            } else if ((eq.hasFlag(MiscType.F_BLUE_SHIELD) || eq.hasFlag(MiscType.F_LIFTHOIST)</span>
<span class="nc bnc" id="L1056" title="All 6 branches missed.">                    || (eq.hasFlag(MiscType.F_CASE) &amp;&amp; !eq.isClan())) &amp;&amp; (location != Aero.LOC_FUSELAGE)) {</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1058">                    buffer.append(eq.getName()).append(&quot; must be mounted in the fuselage.\n&quot;);</span>
                }
<span class="nc" id="L1060">                return false;</span>
            }
<span class="nc bnc" id="L1062" title="All 2 branches missed.">        } else if (eq instanceof WeaponType) {</span>
<span class="nc bnc" id="L1063" title="All 6 branches missed.">            if ((((WeaponType) eq).getAmmoType() == AmmoType.T_GAUSS_HEAVY)</span>
                    &amp;&amp; (location != Aero.LOC_NOSE) &amp;&amp; (location != Aero.LOC_AFT)) {
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1066">                    buffer.append(eq.getName()).append(&quot; must be mounted in the nose or aft.\n&quot;);</span>
                }
<span class="nc" id="L1068">                return false;</span>
            }
<span class="nc bnc" id="L1070" title="All 4 branches missed.">            if (!eq.hasFlag(WeaponType.F_C3M) &amp;&amp; !eq.hasFlag(WeaponType.F_C3MBS)</span>
<span class="nc bnc" id="L1071" title="All 4 branches missed.">                    &amp;&amp; !eq.hasFlag(WeaponType.F_TAG) &amp;&amp; (location == Aero.LOC_FUSELAGE)) {</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L1073">                    buffer.append(eq.getName()).append(&quot; must be mounted in a location with a firing arc.\n&quot;);</span>
                }
<span class="nc" id="L1075">                return false;</span>
            }
        }
<span class="nc" id="L1078">        return true;</span>
    }

    public boolean isAeroWeapon(EquipmentType eq, Entity en) {
<span class="nc bnc" id="L1082" title="All 2 branches missed.">        if (eq instanceof InfantryWeapon) {</span>
<span class="nc" id="L1083">            return false;</span>
        }

<span class="nc" id="L1086">        WeaponType weapon = (WeaponType) eq;</span>
        
        // small craft only; lacks aero weapon flag
<span class="nc bnc" id="L1089" title="All 2 branches missed.">        if (weapon.getAmmoType() == AmmoType.T_C3_REMOTE_SENSOR) {</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">            return en.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">                    &amp;&amp; !en.hasETypeFlag(Entity.ETYPE_DROPSHIP);</span>
        }

<span class="nc bnc" id="L1094" title="All 4 branches missed.">        if (weapon.hasFlag(WeaponType.F_ARTILLERY) &amp;&amp; !weapon.hasFlag(WeaponType.F_BA_WEAPON)) {</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">            return (weapon.getAmmoType() == AmmoType.T_ARROW_IV)</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">                    || en.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">                    || en.hasETypeFlag(Entity.ETYPE_JUMPSHIP);</span>
        }
        
<span class="nc bnc" id="L1100" title="All 6 branches missed.">        if (weapon.isSubCapital() || (weapon.isCapital() &amp;&amp; (weapon.hasFlag(WeaponType.F_MISSILE)))</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                || (weapon.getAtClass() == WeaponType.CLASS_SCREEN)) {</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            return en.hasETypeFlag(Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">                    || en.hasETypeFlag(Entity.ETYPE_JUMPSHIP);</span>
        }

<span class="nc bnc" id="L1106" title="All 2 branches missed.">        if (weapon.hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">            return !en.hasETypeFlag(Entity.ETYPE_JUMPSHIP);</span>
        }

<span class="nc bnc" id="L1110" title="All 2 branches missed.">        if (weapon.isCapital()) {</span>
<span class="nc" id="L1111">            return en.hasETypeFlag(Entity.ETYPE_JUMPSHIP);</span>
        }
        
<span class="nc bnc" id="L1114" title="All 2 branches missed.">        if (weapon instanceof BayWeapon) {</span>
<span class="nc" id="L1115">            return en.usesWeaponBays();</span>
        }

<span class="nc bnc" id="L1118" title="All 2 branches missed.">        if (!weapon.hasFlag(WeaponType.F_AERO_WEAPON)) {</span>
<span class="nc" id="L1119">            return false;</span>
        }

<span class="nc bnc" id="L1122" title="All 4 branches missed.">        if (((weapon instanceof LRMWeapon) || (weapon instanceof LRTWeapon))</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 5)</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 10)</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 15)</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 20)) {</span>
<span class="nc" id="L1127">            return false;</span>
        }
<span class="nc bnc" id="L1129" title="All 4 branches missed.">        if (((weapon instanceof SRMWeapon) || (weapon instanceof SRTWeapon))</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 2)</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 4)</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">                &amp;&amp; (weapon.getRackSize() != 6)) {</span>
<span class="nc" id="L1133">            return false;</span>
        }
<span class="nc bnc" id="L1135" title="All 4 branches missed.">        if ((weapon instanceof MRMWeapon) &amp;&amp; (weapon.getRackSize() &lt; 10)) {</span>
<span class="nc" id="L1136">            return false;</span>
        }

<span class="nc bnc" id="L1139" title="All 4 branches missed.">        if ((weapon instanceof RLWeapon) &amp;&amp; (weapon.getRackSize() &lt; 10)) {</span>
<span class="nc" id="L1140">            return false;</span>
        }
        
<span class="nc bnc" id="L1143" title="All 2 branches missed.">        if (weapon.hasFlag(WeaponType.F_ENERGY)</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">                || (weapon.hasFlag(WeaponType.F_PLASMA) &amp;&amp; (weapon</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">                        .getAmmoType() == AmmoType.T_PLASMA))) {</span>

<span class="nc bnc" id="L1147" title="All 2 branches missed.">            if (weapon.hasFlag(WeaponType.F_ENERGY)</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">                    &amp;&amp; weapon.hasFlag(WeaponType.F_PLASMA)</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">                    &amp;&amp; (weapon.getAmmoType() == AmmoType.T_NA)) {</span>
<span class="nc" id="L1150">                return false;</span>
            }
        }
<span class="nc" id="L1153">        return true;</span>
    }

    @Override
    public StringBuffer printEntity() {
<span class="nc" id="L1158">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L1159">        buff.append(&quot;Aero: &quot;).append(aero.getDisplayName()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1160">        buff.append(&quot;Found in: &quot;).append(fileString).append(&quot;\n&quot;);        </span>
<span class="nc" id="L1161">        buff.append(printTechLevel());</span>
<span class="nc" id="L1162">        buff.append(&quot;Intro year: &quot;).append(aero.getYear()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1163">        buff.append(printSource());</span>
<span class="nc" id="L1164">        buff.append(printShortMovement());</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">        if (correctWeight(buff, true, true)) {</span>
<span class="nc" id="L1166">            buff.append(&quot;Weight: &quot;).append(getWeight()).append(&quot; (&quot;)</span>
<span class="nc" id="L1167">                    .append(calculateWeight()).append(&quot;)\n&quot;);</span>
        }
<span class="nc" id="L1169">        buff.append(printWeightCalculation()).append(&quot;\n&quot;);</span>
<span class="nc" id="L1170">        buff.append(printArmorPlacement());</span>
<span class="nc" id="L1171">        correctArmor(buff);</span>
<span class="nc" id="L1172">        buff.append(printLocations());</span>
<span class="nc" id="L1173">        correctCriticals(buff);</span>

        // printArmor(buff);
<span class="nc" id="L1176">        printFailedEquipment(buff);</span>
<span class="nc" id="L1177">        return buff;</span>
    }
    
    @Override
    public double calculateWeight() {
<span class="nc" id="L1182">        double weight = 0;</span>
<span class="nc" id="L1183">        weight += getWeightEngine();</span>
<span class="nc" id="L1184">        weight += getWeightControls();</span>
<span class="nc" id="L1185">        weight += getWeightFuel();</span>
<span class="nc" id="L1186">        weight += getWeightHeatSinks();</span>
<span class="nc" id="L1187">        weight += getWeightArmor();</span>
<span class="nc" id="L1188">        weight += getWeightMisc();</span>

<span class="nc" id="L1190">        weight += getWeightMiscEquip();</span>
<span class="nc" id="L1191">        weight += getWeightWeapon();</span>
<span class="nc" id="L1192">        weight += getWeightAmmo();</span>
<span class="nc" id="L1193">        weight += getWeightPowerAmp();</span>

<span class="nc" id="L1195">        weight += getWeightCarryingSpace();</span>

<span class="nc" id="L1197">        weight += getArmoredComponentWeight();</span>
<span class="nc" id="L1198">        return weight;</span>
    }

    @Override
    public String printWeightCalculation() {
<span class="nc" id="L1203">        return printWeightEngine()</span>
<span class="nc" id="L1204">                + printWeightControls() + printWeightFuel() </span>
<span class="nc" id="L1205">                + printWeightHeatSinks()</span>
<span class="nc" id="L1206">                + printWeightArmor() + printWeightMisc()</span>
<span class="nc" id="L1207">                + printWeightCarryingSpace() + &quot;Equipment:\n&quot;</span>
<span class="nc" id="L1208">                + printMiscEquip() + printWeapon() + printAmmo();</span>
    }
    
    @Override
    public String printLocations() {
<span class="nc" id="L1213">        StringBuffer buff = new StringBuffer();</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">        for (int i = 0; i &lt; getEntity().locations(); i++) {</span>
<span class="nc" id="L1215">            String locationName = getEntity().getLocationName(i);</span>
<span class="nc" id="L1216">            buff.append(locationName + &quot;:&quot;);</span>
<span class="nc" id="L1217">            buff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">            for (int j = 0; j &lt; getEntity().getNumberOfCriticals(i); j++) {</span>
<span class="nc" id="L1219">                CriticalSlot slot = getEntity().getCritical(i, j);</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">                if (slot == null) {</span>
<span class="nc" id="L1221">                    j = getEntity().getNumberOfCriticals(i);                    </span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">                } else if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
<span class="nc" id="L1223">                        buff.append(Integer.toString(j)</span>
                                + &quot;. UNKNOWN SYSTEM NAME&quot;);
<span class="nc" id="L1225">                        buff.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                } else if (slot.getType() == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L1227">                    EquipmentType e = getEntity().getEquipmentType(slot);</span>
<span class="nc" id="L1228">                    buff.append(Integer.toString(j) + &quot;. &quot;</span>
<span class="nc" id="L1229">                            + e.getInternalName());</span>
<span class="nc" id="L1230">                    buff.append(&quot;\n&quot;);</span>
                }
            }
        }
<span class="nc" id="L1234">        return buff.toString();</span>
    }
    
    public double getWeightQuarters() {
<span class="nc" id="L1238">        double quartersWeight = 0;</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">        for (Bay bay : getEntity().getTransportBays()) {</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">            if (bay.isQuarters()) {</span>
<span class="nc" id="L1241">                quartersWeight += bay.getWeight();</span>
            }
<span class="nc" id="L1243">        }</span>
<span class="nc" id="L1244">        return quartersWeight;</span>
    }

    public String printWeightQuarters() {
<span class="nc" id="L1248">        double weight = 0.0;</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">        for (Bay bay : aero.getTransportBays()) {</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">            if (bay.isQuarters()) {</span>
<span class="nc" id="L1251">                weight += bay.getWeight();</span>
            }
<span class="nc" id="L1253">        }</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">        if (weight &gt; 0) {</span>
<span class="nc" id="L1255">            return StringUtil.makeLength(&quot;Crew quarters: &quot;, getPrintSize() - 5) + weight + &quot;\n&quot;;</span>
        }
<span class="nc" id="L1257">        return &quot;&quot;;</span>
    }

    @Override
    public String getName() {
<span class="nc bnc" id="L1262" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L1263">            return &quot;Conventional Fighter: &quot; + aero.getDisplayName();</span>
        } else {
<span class="nc" id="L1265">            return &quot;Aerospace Fighter: &quot; + aero.getDisplayName();</span>
        }
    }

    /**
     * Calculate the structural integrity weight
     */
    public double getWeightStructure() {
<span class="nc" id="L1273">        double tonnage = 0;</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L1275">            tonnage = aero.getSI() * aero.getWeight();</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">            if (aero.isSpheroid()) {</span>
<span class="nc" id="L1277">                tonnage /= 500;</span>
            } else {
<span class="nc" id="L1279">                tonnage /= 200;</span>
            }
<span class="nc bnc" id="L1281" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_SPACE_STATION)) {</span>
<span class="nc" id="L1282">            tonnage = aero.getWeight() / 100;</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_WARSHIP)) {</span>
            // SI * weight / 1000, rounded up to half ton
<span class="nc" id="L1285">            tonnage = aero.getSI() * aero.getWeight() / 1000;</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L1287">            tonnage = aero.getWeight() / 150;</span>
        } else {
            // Fighters do not allocate weight to structure
<span class="nc" id="L1290">            return 0;</span>
        }
<span class="nc" id="L1292">        return Math.ceil(tonnage * 2) / 2.0;</span>
    }

    /**
     * Get the maximum tonnage for the type of unit. Primitive jumpships will use the maximum
     * allowable value for the construction year (Terran Alliance/Hegemony)
     * 
     * @param aero      The unit
     * @return          The maximum tonnage for the type of unit.
     */
    public static int getMaxTonnage(Aero aero) {
<span class="nc" id="L1303">        return getMaxTonnage(aero, ITechnology.F_NONE);</span>
    }
    
    /**
     * Get the maximum tonnage for the type of unit
     * 
     * @param aero      The unit
     * @param faction   An ITechnology faction constant used for primitive jumpships. A value
     *                  of F_NONE will use the least restrictive values (TA/TH).
     * @return          The maximum tonnage for the type of unit.
     */
    public static int getMaxTonnage(Aero aero, int faction) {
<span class="nc bnc" id="L1315" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_SPACE_STATION)) {</span>
<span class="nc" id="L1316">            return 2500000;</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_WARSHIP)) {</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">            if (((Jumpship) aero).getDriveCoreType() == Jumpship.DRIVE_CORE_SUBCOMPACT) {</span>
<span class="nc" id="L1319">                return 25000;</span>
            }
<span class="nc" id="L1321">            return 2500000;</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc bnc" id="L1323" title="All 2 branches missed.">            if (aero.isPrimitive()) {</span>
<span class="nc" id="L1324">                return getPrimitiveJumpshipMaxTonnage(aero, faction);</span>
            }
<span class="nc" id="L1326">            return 500000;</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_DROPSHIP)) {</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">            if (aero.isPrimitive()) {</span>
<span class="nc" id="L1329">                return getPrimitiveDropshipMaxTonnage(aero);</span>
            }
<span class="nc bnc" id="L1331" title="All 2 branches missed.">            return aero.isSpheroid()? 100000 : 35000;</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">                || aero.hasETypeFlag(Entity.ETYPE_FIXED_WING_SUPPORT)) {</span>
<span class="nc" id="L1334">            return 200;</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_CONV_FIGHTER)) {</span>
<span class="nc" id="L1336">            return 50;</span>
        } else {
<span class="nc" id="L1338">            return 100;</span>
        }
    }
    
    /**
     * @param jumpship
     * @return Max tonnage allowed by construction rules.
     */
    public static int getPrimitiveJumpshipMaxTonnage(Aero jumpship, int faction) {
<span class="nc bnc" id="L1347" title="All 3 branches missed.">        switch (faction) {</span>
            case ITechnology.F_TA:
            case ITechnology.F_TH:
            case ITechnology.F_NONE:
<span class="nc bnc" id="L1351" title="All 2 branches missed.">                if (jumpship.getYear() &lt; 2130) {</span>
<span class="nc" id="L1352">                    return 100000;</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2150) {</span>
<span class="nc" id="L1354">                    return 150000;</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2165) {</span>
<span class="nc" id="L1356">                    return 200000;</span>
<span class="nc bnc" id="L1357" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2175) {</span>
<span class="nc" id="L1358">                    return 250000;</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2200) {</span>
<span class="nc" id="L1360">                    return 350000;</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2300){</span>
<span class="nc" id="L1362">                    return 500000;</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2350) {</span>
<span class="nc" id="L1364">                    return 1000000;</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2400) {</span>
<span class="nc" id="L1366">                    return 1600000;</span>
                } else {
<span class="nc" id="L1368">                    return 1800000;</span>
                }
            case ITechnology.F_CC:
            case ITechnology.F_DC:
            case ITechnology.F_FS:
            case ITechnology.F_FW:
            case ITechnology.F_LC:
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                if (jumpship.getYear() &lt; 2300){</span>
<span class="nc" id="L1376">                    return 350000;</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2350) {</span>
<span class="nc" id="L1378">                    return 600000;</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2400) {</span>
<span class="nc" id="L1380">                    return 800000;</span>
                } else {
<span class="nc" id="L1382">                    return 1000000;</span>
                }
            default:
<span class="nc bnc" id="L1385" title="All 2 branches missed.">                if (jumpship.getYear() &lt; 2300){</span>
<span class="nc" id="L1386">                    return 300000;</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2350) {</span>
<span class="nc" id="L1388">                    return 450000;</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">                } else if (jumpship.getYear() &lt; 2400) {</span>
<span class="nc" id="L1390">                    return 600000;</span>
                } else {
<span class="nc" id="L1392">                    return 1000000;</span>
                }
        }
    }
    
    public static int getPrimitiveDropshipMaxTonnage(Aero dropship) {
<span class="nc bnc" id="L1398" title="All 2 branches missed.">        if (dropship.getYear() &lt; 2130) {</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">            return dropship.isSpheroid()? 3000 : 1000; </span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2150) {</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">            return dropship.isSpheroid()? 4000 : 1500; </span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2165) {</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">            return dropship.isSpheroid()? 7000 : 2500; </span>
<span class="nc bnc" id="L1404" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2175) {</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">            return dropship.isSpheroid()? 10000 : 3000; </span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2200) {</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">            return dropship.isSpheroid()? 14000 : 5000; </span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2250) {</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">            return dropship.isSpheroid()? 15000 : 6000; </span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2300) {</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">            return dropship.isSpheroid()? 19000 : 7000; </span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2350) {</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">            return dropship.isSpheroid()? 23000 : 8000; </span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">        } else if (dropship.getYear() &lt; 2425) {</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">            return dropship.isSpheroid()? 30000 : 10000; </span>
        } else {
<span class="nc bnc" id="L1417" title="All 2 branches missed.">            return dropship.isSpheroid()? 50000 : 20000; </span>
        }
    }

    /**
     * @return Minimum crew requirements based on unit type and equipment crew requirements.
     */
    public static int minimumBaseCrew(Aero aero) {
<span class="nc bnc" id="L1425" title="All 2 branches missed.">        if (aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L1426">            return TestSmallCraft.minimumBaseCrew((SmallCraft) aero);</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">        } else if (aero.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L1428">            return TestAdvancedAerospace.minimumBaseCrew((Jumpship) aero);</span>
        } else {
<span class="nc" id="L1430">            return 1;</span>
        }
    }
    
    /**
     * One gunner is required for each capital weapon and each six standard scale weapons, rounding up
     * @return The vessel's minimum gunner requirements.
     */
    public static int requiredGunners(Aero aero) {
<span class="nc bnc" id="L1439" title="All 4 branches missed.">        if (!aero.isLargeCraft() &amp;&amp; !aero.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)) {</span>
<span class="nc" id="L1440">            return 0;</span>
        }
<span class="nc" id="L1442">        int capitalWeapons = 0;</span>
<span class="nc" id="L1443">        int stdWeapons = 0;</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">        for (Mounted m : aero.getTotalWeaponList()) {</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">            if (m.getType() instanceof BayWeapon) {</span>
<span class="nc" id="L1446">                continue;</span>
            }
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            if ((((WeaponType)m.getType()).getLongRange() &lt;= 1)</span>
                    // MML range depends on ammo, and getLongRange() returns 0
<span class="nc bnc" id="L1450" title="All 2 branches missed.">                    &amp;&amp; (((WeaponType) m.getType()).getAmmoType() != AmmoType.T_MML)) {</span>
<span class="nc" id="L1451">                continue;</span>
            }
<span class="nc bnc" id="L1453" title="All 2 branches missed.">            if (((WeaponType)m.getType()).isCapital()</span>
<span class="nc bnc" id="L1454" title="All 2 branches missed.">                    || (m.getType() instanceof ScreenLauncherWeapon)) {</span>
<span class="nc" id="L1455">                capitalWeapons++;</span>
            } else {
<span class="nc" id="L1457">                stdWeapons++;</span>
            }
<span class="nc" id="L1459">        }</span>
<span class="nc" id="L1460">        return capitalWeapons + (int)Math.ceil(stdWeapons / 6.0);</span>
    }

    /**
     * Determines whether a piece of equipment should be mounted in a specific location, as opposed
     * to the fuselage.
     * 
     * @param eq       The equipment
     * @param fighter  If the aero is a fighter (including fixed wing support), the ammo is mounted in the
     *                 fuselage. Otherwise it's in the location with the weapon.
     * @return         Whether the equipment needs to be assigned to a location with a firing arc.
     */
    public static boolean eqRequiresLocation(EquipmentType eq, boolean fighter) {
<span class="nc bnc" id="L1473" title="All 2 branches missed.">        if (!fighter) {</span>
<span class="nc bnc" id="L1474" title="All 6 branches missed.">            return (eq instanceof WeaponType)</span>
                    || (eq instanceof AmmoType)
                    || ((eq instanceof MiscType)
<span class="nc bnc" id="L1477" title="All 2 branches missed.">                            &amp;&amp; (eq.hasFlag(MiscType.F_ARTEMIS)</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">                                    || eq.hasFlag(MiscType.F_ARTEMIS_PROTO)</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">                                    || eq.hasFlag(MiscType.F_ARTEMIS_V)</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">                                    || eq.hasFlag(MiscType.F_APOLLO)</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">                                    || eq.hasFlag(MiscType.F_PPC_CAPACITOR)</span>
<span class="nc bnc" id="L1482" title="All 2 branches missed.">                                    || eq.hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)</span>
<span class="nc bnc" id="L1483" title="All 2 branches missed.">                                    || eq.hasFlag(MiscType.F_LASER_INSULATOR)));</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">        } else if (eq instanceof MiscType) {</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">            if (eq.hasFlag(MiscType.F_CASE)) {</span>
<span class="nc" id="L1486">                return eq.isClan();</span>
<span class="nc bnc" id="L1487" title="All 4 branches missed.">            } else return !eq.hasFlag(MiscType.F_BLUE_SHIELD) &amp;&amp; !eq.hasFlag(MiscType.F_LIFTHOIST);</span>
        } else {
<span class="nc bnc" id="L1489" title="All 2 branches missed.">            return !(eq instanceof AmmoType);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>