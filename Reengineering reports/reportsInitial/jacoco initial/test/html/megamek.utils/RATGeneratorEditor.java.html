<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RATGeneratorEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.utils</a> &gt; <span class="el_source">RATGeneratorEditor.java</span></div><h1>RATGeneratorEditor.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2018 - The MegaMek Team
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

package megamek.utils;

import java.awt.Dimension;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.io.File;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.StringJoiner;
import java.util.stream.Collectors;

import javax.swing.ButtonGroup;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.JScrollPane;
import javax.swing.JTabbedPane;
import javax.swing.JTable;
import javax.swing.JTextField;
import javax.swing.ListSelectionModel;
import javax.swing.RowFilter;
import javax.swing.RowSorter;
import javax.swing.SortOrder;
import javax.swing.SwingUtilities;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableRowSorter;

import megamek.MegaMek;
import megamek.client.ratgenerator.AbstractUnitRecord;
import megamek.client.ratgenerator.AvailabilityRating;
import megamek.client.ratgenerator.FactionRecord;
import megamek.client.ratgenerator.FactionRecord.TechCategory;
import megamek.client.ratgenerator.ModelRecord;
import megamek.client.ratgenerator.RATGenerator;
import megamek.common.Configuration;
import megamek.common.EntityMovementMode;
import megamek.common.UnitType;

/**
 * @author neoancient
 *
 */
public class RATGeneratorEditor extends JFrame {

    private static final long serialVersionUID = 6544418066071039219L;

<span class="nc" id="L74">    private static final String[] MOVEMENT_TYPE_NAMES = {</span>
            &quot;Leg&quot;, &quot;Tracked&quot;, &quot;Wheeled&quot;, &quot;Hover&quot;, &quot;WiGE&quot;, &quot;VTOL&quot;,
            &quot;Naval&quot;, &quot;Underwater&quot;, &quot;Jump&quot;, &quot;Motorized&quot;, &quot;Atmospheric&quot;,
            &quot;Aerospace&quot;, &quot;Space&quot;, &quot;None&quot;
    };

    private static RATGenerator rg;
    
    private static Integer[] ERAS;

<span class="nc" id="L84">    private final JComboBox&lt;String&gt; cbUnitType = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L85">    private final JComboBox&lt;String&gt; cbMovementType = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L86">    private final JRadioButton radioModel = new JRadioButton(&quot;Model&quot;);</span>
<span class="nc" id="L87">    private final JRadioButton radioChassis = new JRadioButton(&quot;Chassis&quot;);</span>

<span class="nc" id="L89">    private final JTabbedPane panMain = new JTabbedPane();</span>

<span class="nc" id="L91">    private final JTextField txtSearch = new JTextField();</span>
<span class="nc" id="L92">    private final JTable tblMasterUnitList = new JTable();</span>
    private MasterUnitListTableModel masterUnitListModel;
    private TableRowSorter&lt;MasterUnitListTableModel&gt; masterUnitListSorter;

<span class="nc" id="L96">    private final JTextField txtFaction = new JTextField();</span>
<span class="nc" id="L97">    private final JTable tblUnitEditor = new JTable();</span>
<span class="nc" id="L98">    private final UnitEditorTableModel unitEditorModel = new UnitEditorTableModel();</span>

<span class="nc" id="L100">    private final JTextField txtNewFaction = new JTextField();</span>
<span class="nc" id="L101">    private final JCheckBox chkShowSubfactions = new JCheckBox();</span>
<span class="nc" id="L102">    private final JCheckBox chkShowMinorFactions = new JCheckBox();</span>
<span class="nc" id="L103">    private final JTable tblMasterFactionList = new JTable();</span>
    private FactionListTableModel masterFactionListModel;
    private TableRowSorter&lt;FactionListTableModel&gt; masterFactionListSorter;
<span class="nc" id="L106">    private final JTable tblFactionEditor = new JTable();</span>
    private FactionEditorTableModel factionEditorModel;
<span class="nc" id="L108">    private final JTextField txtSalvageFaction = new JTextField();</span>
<span class="nc" id="L109">    private final JTable tblSalvageEditor = new JTable();</span>
    private SalvageEditorTableModel salvageEditorModel;

<span class="nc" id="L112">    private File lastDir = Configuration.forceGeneratorDir();</span>

<span class="nc" id="L114">    public RATGeneratorEditor() {</span>
<span class="nc" id="L115">        rg = RATGenerator.getInstance();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        while (!rg.isInitialized()) {</span>
            try {
<span class="nc" id="L118">                Thread.sleep(50);</span>
<span class="nc" id="L119">            } catch (InterruptedException ex) {</span>
                // Do nothing
<span class="nc" id="L121">            }</span>
        }
<span class="nc" id="L123">        rg.getEraSet().forEach(e -&gt; rg.loadYear(e));</span>
<span class="nc" id="L124">        ERAS = rg.getEraSet().toArray(new Integer[0]);</span>
<span class="nc" id="L125">        rg.initRemainingUnits();</span>

<span class="nc" id="L127">        initUI();</span>
<span class="nc" id="L128">    }</span>

    public RATGeneratorEditor(File dir) {
<span class="nc" id="L131">        this();</span>
<span class="nc bnc" id="L132" title="All 4 branches missed.">        if (dir.exists() &amp;&amp; dir.isDirectory()) {</span>
<span class="nc" id="L133">            lastDir = dir;</span>
<span class="nc" id="L134">            rg.reloadFromDir(lastDir);</span>
<span class="nc" id="L135">            ERAS = rg.getEraSet().toArray(new Integer[0]);</span>
<span class="nc" id="L136">            rg.initRemainingUnits();</span>
        }
<span class="nc" id="L138">    }</span>

    private void initUI() {
<span class="nc" id="L141">        setTitle(&quot;Unit Selector Editor&quot;);</span>
<span class="nc" id="L142">        setDefaultCloseOperation(EXIT_ON_CLOSE);</span>

<span class="nc" id="L144">        masterUnitListModel = new MasterUnitListTableModel(rg.getModelList());</span>

<span class="nc" id="L146">        setLayout(new GridBagLayout());</span>

<span class="nc" id="L148">        buildOptionPanel();</span>

<span class="nc" id="L150">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L151">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L152">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L153">        gbc.gridwidth = 1;</span>
<span class="nc" id="L154">        gbc.insets = new Insets(5, 5, 5, 5);</span>

<span class="nc" id="L156">        gbc.gridx = 0;</span>
<span class="nc" id="L157">        gbc.gridy = 2;</span>
<span class="nc" id="L158">        gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L159">        gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L160">        add(panMain, gbc);</span>

<span class="nc" id="L162">        JPanel panButtons = new JPanel();</span>
<span class="nc" id="L163">        gbc.gridx = 0;</span>
<span class="nc" id="L164">        gbc.gridy = 3;</span>
<span class="nc" id="L165">        gbc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L166">        add(panButtons, gbc);</span>

<span class="nc" id="L168">        JPanel panEditTab = createUnitPanel();</span>
<span class="nc" id="L169">        gbc = new GridBagConstraints();</span>
<span class="nc" id="L170">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L171">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L172">        gbc.gridwidth = 1;</span>
<span class="nc" id="L173">        gbc.insets = new Insets(5, 5, 5, 5);</span>
<span class="nc" id="L174">        panMain.addTab(&quot;Edit&quot;, panEditTab);</span>

<span class="nc" id="L176">        JPanel panFactionEditorTab = createFactionTab();</span>
<span class="nc" id="L177">        gbc = new GridBagConstraints();</span>
<span class="nc" id="L178">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L179">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L180">        gbc.gridwidth = 1;</span>
<span class="nc" id="L181">        gbc.insets = new Insets(5, 5, 5, 5);</span>
<span class="nc" id="L182">        panMain.addTab(&quot;Edit Factions&quot;, panFactionEditorTab);</span>

<span class="nc" id="L184">        JButton button = new JButton(&quot;Load&quot;);</span>
<span class="nc" id="L185">        button.setToolTipText(&quot;Load data from alternate location&quot;);</span>
<span class="nc" id="L186">        panButtons.add(button);</span>
<span class="nc" id="L187">        button.addActionListener(ev -&gt; loadAltDir());</span>

<span class="nc" id="L189">        button = new JButton(&quot;Save&quot;);</span>
<span class="nc" id="L190">        button.setToolTipText(&quot;Export data to a selected directory&quot;);</span>
<span class="nc" id="L191">        panButtons.add(button);</span>
<span class="nc" id="L192">        button.addActionListener(ev -&gt; saveValues());</span>

<span class="nc" id="L194">        pack();</span>

<span class="nc" id="L196">    }</span>

    private void loadAltDir() {
<span class="nc" id="L199">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L200">        chooser.setCurrentDirectory(lastDir);</span>
<span class="nc" id="L201">        chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);</span>
<span class="nc" id="L202">        chooser.setDialogTitle(&quot;Select load directory&quot;);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L204">            lastDir = chooser.getSelectedFile();</span>
<span class="nc" id="L205">            rg.reloadFromDir(lastDir);</span>
<span class="nc" id="L206">            ERAS = rg.getEraSet().toArray(new Integer[0]);</span>
<span class="nc" id="L207">            rg.initRemainingUnits();</span>
<span class="nc" id="L208">            tblMasterUnitList.clearSelection();</span>
<span class="nc" id="L209">            tblMasterFactionList.clearSelection();</span>
        }
<span class="nc" id="L211">    }</span>

    private void saveValues() {
<span class="nc" id="L214">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L215">        chooser.setCurrentDirectory(lastDir);</span>
<span class="nc" id="L216">        chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);</span>
<span class="nc" id="L217">        chooser.setDialogTitle(&quot;Select save directory&quot;);</span>
<span class="nc" id="L218">        chooser.setAcceptAllFileFilterUsed(false);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (chooser.showSaveDialog(this) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L220">            lastDir = chooser.getSelectedFile();</span>
<span class="nc" id="L221">            rg.exportRATGen(lastDir);</span>
        }
<span class="nc" id="L223">    }</span>

    private void buildOptionPanel() {
<span class="nc" id="L226">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L227">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L228">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L229">        gbc.gridwidth = 1;</span>
<span class="nc" id="L230">        gbc.insets = new Insets(5, 5, 5, 5);</span>

<span class="nc" id="L232">        cbUnitType.addItem(&quot;All&quot;);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        for (int i = 0; i &lt; UnitType.SIZE; i++) {</span>
<span class="nc" id="L234">            cbUnitType.addItem(UnitType.getTypeName(i));</span>
        }
<span class="nc" id="L236">        gbc.gridx = 0;</span>
<span class="nc" id="L237">        gbc.gridy = 0;</span>
<span class="nc" id="L238">        add(new JLabel(&quot;Unit Type:&quot;), gbc);</span>
<span class="nc" id="L239">        gbc.gridx = 1;</span>
<span class="nc" id="L240">        gbc.gridy = 0;</span>
<span class="nc" id="L241">        add(cbUnitType, gbc);</span>
<span class="nc" id="L242">        cbUnitType.addActionListener(ev -&gt; filterMasterUnitList());</span>

<span class="nc" id="L244">        cbMovementType.addItem(&quot;All&quot;);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        for (String movementTypeName : MOVEMENT_TYPE_NAMES) {</span>
<span class="nc" id="L246">            cbMovementType.addItem(movementTypeName);</span>
        }
<span class="nc" id="L248">        gbc.gridx = 2;</span>
<span class="nc" id="L249">        gbc.gridy = 0;</span>
<span class="nc" id="L250">        add(new JLabel(&quot;Movement Type:&quot;), gbc);</span>
<span class="nc" id="L251">        gbc.gridx = 3;</span>
<span class="nc" id="L252">        gbc.gridy = 0;</span>
<span class="nc" id="L253">        add(cbMovementType, gbc);</span>
<span class="nc" id="L254">        cbMovementType.addActionListener(arg0 -&gt; filterMasterUnitList());</span>

<span class="nc" id="L256">        radioModel.setSelected(true);</span>
<span class="nc" id="L257">        gbc.gridx = 4;</span>
<span class="nc" id="L258">        gbc.gridy = 0;</span>
<span class="nc" id="L259">        add(radioModel, gbc);</span>
<span class="nc" id="L260">        radioModel.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (unitEditorModel.getMode() != UnitEditorTableModel.MODE_MODEL &amp;&amp;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                    tblMasterUnitList.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L263">                ModelRecord model = masterUnitListModel.getUnitRecord(tblMasterUnitList.convertRowIndexToModel(tblMasterUnitList.getSelectedRow()));</span>
<span class="nc" id="L264">                unitEditorModel.setData(model, UnitEditorTableModel.MODE_MODEL);</span>
<span class="nc" id="L265">            } else {</span>
<span class="nc" id="L266">                unitEditorModel.clearData();</span>
            }
<span class="nc" id="L268">        });</span>

<span class="nc" id="L270">        gbc.gridx = 5;</span>
<span class="nc" id="L271">        gbc.gridy = 0;</span>
<span class="nc" id="L272">        add(radioChassis, gbc);</span>
<span class="nc" id="L273">        radioChassis.addActionListener(ev -&gt;  {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (unitEditorModel.getMode() != UnitEditorTableModel.MODE_CHASSIS &amp;&amp;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                    tblMasterUnitList.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L276">                ModelRecord model = masterUnitListModel.getUnitRecord(tblMasterUnitList.convertRowIndexToModel(tblMasterUnitList.getSelectedRow()));</span>
<span class="nc" id="L277">                unitEditorModel.setData(model, UnitEditorTableModel.MODE_CHASSIS);</span>
<span class="nc" id="L278">            } else {</span>
<span class="nc" id="L279">                unitEditorModel.clearData();</span>
            }
<span class="nc" id="L281">        });</span>

<span class="nc" id="L283">        ButtonGroup group = new ButtonGroup();</span>
<span class="nc" id="L284">        group.add(radioModel);</span>
<span class="nc" id="L285">        group.add(radioChassis);</span>
<span class="nc" id="L286">    }</span>

    private JPanel createUnitPanel() {
<span class="nc" id="L289">        JPanel panEditTab = new JPanel(new GridBagLayout());</span>

<span class="nc" id="L291">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L292">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L293">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L294">        gbc.gridwidth = 1;</span>
<span class="nc" id="L295">        gbc.insets = new Insets(5, 5, 5, 5);</span>

<span class="nc" id="L297">        txtSearch.setMinimumSize(new Dimension(200, 25));</span>
<span class="nc" id="L298">        txtSearch.setPreferredSize(new Dimension(200, 25));</span>
<span class="nc" id="L299">        gbc.gridx = 0;</span>
<span class="nc" id="L300">        gbc.gridy = 0;</span>
<span class="nc" id="L301">        panEditTab.add(new JLabel(&quot;Search:&quot;), gbc);</span>
<span class="nc" id="L302">        gbc.gridx = 1;</span>
<span class="nc" id="L303">        gbc.gridy = 0;</span>
<span class="nc" id="L304">        panEditTab.add(txtSearch, gbc);</span>
<span class="nc" id="L305">        txtSearch.getDocument().addDocumentListener(new DocumentListener() {</span>

            @Override
            public void changedUpdate(DocumentEvent arg0) {
<span class="nc" id="L309">                filterMasterUnitList();</span>
<span class="nc" id="L310">            }</span>

            @Override
            public void insertUpdate(DocumentEvent arg0) {
<span class="nc" id="L314">                filterMasterUnitList();</span>
<span class="nc" id="L315">            }</span>

            @Override
            public void removeUpdate(DocumentEvent arg0) {
<span class="nc" id="L319">                filterMasterUnitList();</span>
<span class="nc" id="L320">            }</span>

        });

<span class="nc" id="L324">        tblMasterUnitList.setModel(masterUnitListModel);</span>
<span class="nc" id="L325">        masterUnitListSorter =</span>
                new TableRowSorter&lt;&gt;(masterUnitListModel);
<span class="nc" id="L327">        masterUnitListSorter.setComparator(MasterUnitListTableModel.COL_UNIT_TYPE, new UnitTypeComparator());</span>
<span class="nc" id="L328">        List&lt;RowSorter.SortKey&gt; sortKeys = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L329">        sortKeys.add(new RowSorter.SortKey(MasterUnitListTableModel.COL_UNIT_TYPE, SortOrder.ASCENDING));</span>
<span class="nc" id="L330">        sortKeys.add(new RowSorter.SortKey(MasterUnitListTableModel.COL_CHASSIS, SortOrder.ASCENDING));</span>
<span class="nc" id="L331">        sortKeys.add(new RowSorter.SortKey(MasterUnitListTableModel.COL_MODEL, SortOrder.ASCENDING));</span>
<span class="nc" id="L332">        sortKeys.add(new RowSorter.SortKey(MasterUnitListTableModel.COL_YEAR, SortOrder.ASCENDING));</span>
<span class="nc" id="L333">        masterUnitListSorter.setSortKeys(sortKeys);</span>
<span class="nc" id="L334">        tblMasterUnitList.setRowSorter(masterUnitListSorter);</span>
<span class="nc" id="L335">        tblMasterUnitList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L336">        tblMasterUnitList.getSelectionModel().addListSelectionListener(arg0 -&gt; {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (tblMasterUnitList.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L338">                ModelRecord rec = masterUnitListModel.</span>
<span class="nc" id="L339">                        getUnitRecord(tblMasterUnitList.</span>
<span class="nc" id="L340">                                convertRowIndexToModel(tblMasterUnitList.</span>
<span class="nc" id="L341">                                        getSelectedRow()));</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                unitEditorModel.setData(rec, radioModel.isSelected() ? UnitEditorTableModel.MODE_MODEL : UnitEditorTableModel.MODE_CHASSIS);</span>
<span class="nc" id="L343">            } else {</span>
<span class="nc" id="L344">                unitEditorModel.clearData();</span>
            }
<span class="nc" id="L346">        });</span>

<span class="nc" id="L348">        JScrollPane scroll = new JScrollPane();</span>
<span class="nc" id="L349">        scroll.setMinimumSize(new Dimension(600, 400));</span>
<span class="nc" id="L350">        scroll.setPreferredSize(new Dimension(600, 400));</span>
<span class="nc" id="L351">        scroll.setViewportView(tblMasterUnitList);</span>
<span class="nc" id="L352">        gbc.gridx = 0;</span>
<span class="nc" id="L353">        gbc.gridy = 1;</span>
<span class="nc" id="L354">        gbc.gridwidth = 2;</span>
<span class="nc" id="L355">        panEditTab.add(scroll, gbc);</span>

<span class="nc" id="L357">        txtFaction.setMinimumSize(new Dimension(60,25));</span>
<span class="nc" id="L358">        txtFaction.setPreferredSize(new Dimension(60,25));</span>
<span class="nc" id="L359">        gbc.gridx = 2;</span>
<span class="nc" id="L360">        gbc.gridy = 0;</span>
<span class="nc" id="L361">        gbc.gridwidth = 1;</span>
<span class="nc" id="L362">        panEditTab.add(txtFaction, gbc);</span>

<span class="nc" id="L364">        JButton button = new JButton(&quot;Add Row&quot;);</span>
<span class="nc" id="L365">        gbc.gridx = 3;</span>
<span class="nc" id="L366">        gbc.gridy = 0;</span>
<span class="nc" id="L367">        panEditTab.add(button, gbc);</span>
<span class="nc" id="L368">        button.addActionListener(ev -&gt; {</span>
            
<span class="nc bnc" id="L370" title="All 2 branches missed.">            if(!unitEditorModel.addEntry(txtFaction.getText())) {</span>
<span class="nc" id="L371">                JOptionPane.showMessageDialog(this, </span>
                        &quot;Unable to add model or chassis entry. Please select a unit model. &quot; +
                        &quot;If adding a model entry, make sure you already have a chassis entry defined.&quot;);
            }
<span class="nc" id="L375">        });</span>

<span class="nc" id="L377">        button = new JButton(&quot;Delete Row&quot;);</span>
<span class="nc" id="L378">        gbc.gridx = 4;</span>
<span class="nc" id="L379">        gbc.gridy = 0;</span>
<span class="nc" id="L380">        panEditTab.add(button, gbc);</span>
<span class="nc" id="L381">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (tblUnitEditor.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L383">                unitEditorModel.removeEntry(tblUnitEditor.convertRowIndexToModel(tblUnitEditor.getSelectedRow()));</span>
            }
<span class="nc" id="L385">        });</span>

<span class="nc" id="L387">        button = new JButton(&quot;Copy Row&quot;);</span>
<span class="nc" id="L388">        gbc.gridx = 5;</span>
<span class="nc" id="L389">        gbc.gridy = 0;</span>
<span class="nc" id="L390">        panEditTab.add(button, gbc);</span>
<span class="nc" id="L391">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">            if (tblUnitEditor.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L393">                unitEditorModel.copyRow(tblUnitEditor.convertRowIndexToModel(tblUnitEditor.getSelectedRow()),</span>
<span class="nc" id="L394">                        txtFaction.getText());</span>
            }
<span class="nc" id="L396">        });</span>

<span class="nc" id="L398">        tblUnitEditor.setModel(unitEditorModel);</span>
<span class="nc" id="L399">        tblUnitEditor.createDefaultColumnsFromModel();</span>
<span class="nc" id="L400">        tblUnitEditor.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);</span>
<span class="nc" id="L401">        scroll = new JScrollPane(tblUnitEditor, JScrollPane.VERTICAL_SCROLLBAR_ALWAYS,</span>
                JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L403">        scroll.setMinimumSize(new Dimension(600, 400));</span>
<span class="nc" id="L404">        scroll.setPreferredSize(new Dimension(600, 400));</span>
<span class="nc" id="L405">        scroll.setViewportView(tblUnitEditor);</span>
<span class="nc" id="L406">        gbc.gridx = 2;</span>
<span class="nc" id="L407">        gbc.gridy = 1;</span>
<span class="nc" id="L408">        gbc.gridwidth = 8;</span>
<span class="nc" id="L409">        gbc.weightx = 1.0;</span>
<span class="nc" id="L410">        panEditTab.add(scroll, gbc);</span>

<span class="nc" id="L412">        return panEditTab;</span>
    }

    private JPanel createFactionTab() {
<span class="nc" id="L416">        JPanel panFactionEditorTab = new JPanel(new GridBagLayout());</span>

<span class="nc" id="L418">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L419">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L420">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L421">        gbc.gridwidth = 1;</span>
<span class="nc" id="L422">        gbc.insets = new Insets(5, 5, 5, 5);</span>

<span class="nc" id="L424">        txtNewFaction.setMinimumSize(new Dimension(100, 25));</span>
<span class="nc" id="L425">        txtNewFaction.setPreferredSize(new Dimension(100, 25));</span>
<span class="nc" id="L426">        gbc.gridx = 0;</span>
<span class="nc" id="L427">        gbc.gridy = 0;</span>
<span class="nc" id="L428">        panFactionEditorTab.add(txtNewFaction, gbc);</span>

<span class="nc" id="L430">        JButton button = new JButton(&quot;New&quot;);</span>
<span class="nc" id="L431">        gbc.gridx = 1;</span>
<span class="nc" id="L432">        gbc.gridy = 0;</span>
<span class="nc" id="L433">        panFactionEditorTab.add(button, gbc);</span>
<span class="nc" id="L434">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (txtNewFaction.getText().length() &gt; 0) {</span>
<span class="nc" id="L436">                FactionRecord rec = new FactionRecord(txtNewFaction.getText());</span>
<span class="nc" id="L437">                rg.addFaction(rec);</span>
<span class="nc" id="L438">                masterFactionListModel.addRecord(rec);</span>
            }
<span class="nc" id="L440">        });</span>

<span class="nc" id="L442">        button = new JButton(&quot;Delete&quot;);</span>
<span class="nc" id="L443">        gbc.gridx = 2;</span>
<span class="nc" id="L444">        gbc.gridy = 0;</span>
<span class="nc" id="L445">        panFactionEditorTab.add(button, gbc);</span>
<span class="nc" id="L446">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (tblMasterFactionList.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L448">                FactionRecord rec = masterFactionListModel.getFactionRecord(</span>
<span class="nc" id="L449">                        tblMasterFactionList.convertRowIndexToModel(</span>
<span class="nc" id="L450">                                tblMasterFactionList.getSelectedRow()));</span>
<span class="nc" id="L451">                masterFactionListModel.delRecord(rec);</span>
<span class="nc" id="L452">                rg.removeFaction(rec);</span>
            }
<span class="nc" id="L454">        });</span>

<span class="nc" id="L456">        button = new JButton(&quot;Copy&quot;);</span>
<span class="nc" id="L457">        gbc.gridx = 3;</span>
<span class="nc" id="L458">        gbc.gridy = 0;</span>
<span class="nc" id="L459">        panFactionEditorTab.add(button, gbc);</span>
<span class="nc" id="L460">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (txtNewFaction.getText().length() &gt; 0</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                    &amp;&amp; tblMasterFactionList.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L463">                FactionRecord from = masterFactionListModel.getFactionRecord(</span>
<span class="nc" id="L464">                        tblMasterFactionList.convertRowIndexToModel(</span>
<span class="nc" id="L465">                                tblMasterFactionList.getSelectedRow()));</span>
<span class="nc" id="L466">                FactionRecord rec = new FactionRecord(txtNewFaction.getText());</span>
<span class="nc" id="L467">                rec.setClan(from.isClan());</span>
<span class="nc" id="L468">                rec.setRatings(String.join(&quot;,&quot;, from.getRatingLevels()));</span>
<span class="nc" id="L469">                rg.addFaction(rec);</span>
<span class="nc" id="L470">                masterFactionListModel.addRecord(rec);</span>
            }
<span class="nc" id="L472">        });</span>

<span class="nc" id="L474">        chkShowSubfactions.setText(&quot;Show Subfactions&quot;);</span>
<span class="nc" id="L475">        chkShowSubfactions.setSelected(true);</span>
<span class="nc" id="L476">        gbc.gridx = 4;</span>
<span class="nc" id="L477">        gbc.gridy = 0;</span>
<span class="nc" id="L478">        panFactionEditorTab.add(chkShowSubfactions, gbc);</span>
<span class="nc" id="L479">        chkShowSubfactions.addActionListener(ev -&gt; filterFactionList());</span>

<span class="nc" id="L481">        chkShowMinorFactions.setText(&quot;Show Minor Factions&quot;);</span>
<span class="nc" id="L482">        chkShowMinorFactions.setSelected(true);</span>
<span class="nc" id="L483">        gbc.gridx = 5;</span>
<span class="nc" id="L484">        gbc.gridy = 0;</span>
<span class="nc" id="L485">        panFactionEditorTab.add(chkShowMinorFactions, gbc);</span>
<span class="nc" id="L486">        chkShowMinorFactions.addActionListener(ev -&gt; filterFactionList());</span>

<span class="nc" id="L488">        masterFactionListModel = new FactionListTableModel(rg.getFactionList());</span>
<span class="nc" id="L489">        tblMasterFactionList.setModel(masterFactionListModel);</span>
<span class="nc" id="L490">        masterFactionListSorter =</span>
                new TableRowSorter&lt;&gt;(masterFactionListModel);
<span class="nc" id="L492">        List&lt;RowSorter.SortKey&gt; sortKeys = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L493">        sortKeys.add(new RowSorter.SortKey(FactionListTableModel.COL_CODE, SortOrder.ASCENDING));</span>
<span class="nc" id="L494">        sortKeys.add(new RowSorter.SortKey(FactionListTableModel.COL_NAME, SortOrder.ASCENDING));</span>
<span class="nc" id="L495">        sortKeys.add(new RowSorter.SortKey(FactionListTableModel.COL_CLAN, SortOrder.ASCENDING));</span>
<span class="nc" id="L496">        masterFactionListSorter.setSortKeys(sortKeys);</span>
<span class="nc" id="L497">        tblMasterFactionList.setRowSorter(masterFactionListSorter);</span>
<span class="nc" id="L498">        tblMasterFactionList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L499">        tblMasterFactionList.getSelectionModel().addListSelectionListener(arg0 -&gt; {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">            if (tblMasterFactionList.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L501">                FactionRecord rec = masterFactionListModel.</span>
<span class="nc" id="L502">                        getFactionRecord(tblMasterFactionList.</span>
<span class="nc" id="L503">                                convertRowIndexToModel(tblMasterFactionList.</span>
<span class="nc" id="L504">                                        getSelectedRow()));</span>
<span class="nc" id="L505">                factionEditorModel.setData(rec);</span>
<span class="nc" id="L506">                salvageEditorModel.setData(rec);</span>
<span class="nc" id="L507">            } else {</span>
<span class="nc" id="L508">                factionEditorModel.clearData();</span>
<span class="nc" id="L509">                salvageEditorModel.clearData();</span>
            }
<span class="nc" id="L511">        });</span>

<span class="nc" id="L513">        JScrollPane scroll = new JScrollPane();</span>
<span class="nc" id="L514">        scroll.setMinimumSize(new Dimension(600, 400));</span>
<span class="nc" id="L515">        scroll.setPreferredSize(new Dimension(600, 400));</span>
<span class="nc" id="L516">        scroll.setViewportView(tblMasterFactionList);</span>
<span class="nc" id="L517">        gbc.gridx = 0;</span>
<span class="nc" id="L518">        gbc.gridy = 1;</span>
<span class="nc" id="L519">        gbc.gridwidth = 6;</span>
<span class="nc" id="L520">        gbc.gridheight = 4;</span>
<span class="nc" id="L521">        panFactionEditorTab.add(scroll, gbc);</span>

<span class="nc" id="L523">        factionEditorModel = new FactionEditorTableModel(null);</span>
<span class="nc" id="L524">        tblFactionEditor.setModel(factionEditorModel);</span>
<span class="nc" id="L525">        tblFactionEditor.createDefaultColumnsFromModel();</span>
<span class="nc" id="L526">        tblFactionEditor.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);</span>
<span class="nc" id="L527">        scroll = new JScrollPane(tblFactionEditor, JScrollPane.VERTICAL_SCROLLBAR_ALWAYS,</span>
                JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L529">        scroll.setMinimumSize(new Dimension(600, 200));</span>
<span class="nc" id="L530">        scroll.setPreferredSize(new Dimension(600, 200));</span>
<span class="nc" id="L531">        scroll.setViewportView(tblFactionEditor);</span>
<span class="nc" id="L532">        gbc.gridx = 6;</span>
<span class="nc" id="L533">        gbc.gridy = 1;</span>
<span class="nc" id="L534">        gbc.gridwidth = 8;</span>
<span class="nc" id="L535">        gbc.gridheight = 1;</span>
<span class="nc" id="L536">        panFactionEditorTab.add(scroll, gbc);</span>

<span class="nc" id="L538">        txtSalvageFaction.setMinimumSize(new Dimension(60,25));</span>
<span class="nc" id="L539">        txtSalvageFaction.setPreferredSize(new Dimension(60,25));</span>
<span class="nc" id="L540">        gbc.gridx = 6;</span>
<span class="nc" id="L541">        gbc.gridy = 2;</span>
<span class="nc" id="L542">        gbc.gridwidth = 1;</span>
<span class="nc" id="L543">        panFactionEditorTab.add(txtSalvageFaction, gbc);</span>

<span class="nc" id="L545">        button = new JButton(&quot;Add Row&quot;);</span>
<span class="nc" id="L546">        gbc.gridx = 7;</span>
<span class="nc" id="L547">        gbc.gridy = 2;</span>
<span class="nc" id="L548">        panFactionEditorTab.add(button, gbc);</span>
<span class="nc" id="L549">        button.addActionListener(ev -&gt; salvageEditorModel.addEntry(txtSalvageFaction.getText()));</span>

<span class="nc" id="L551">        button = new JButton(&quot;Delete Row&quot;);</span>
<span class="nc" id="L552">        gbc.gridx = 8;</span>
<span class="nc" id="L553">        gbc.gridy = 2;</span>
<span class="nc" id="L554">        panFactionEditorTab.add(button, gbc);</span>
<span class="nc" id="L555">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">                if (tblSalvageEditor.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L557">                    salvageEditorModel.removeEntry(tblSalvageEditor.convertRowIndexToModel(tblSalvageEditor.getSelectedRow()));</span>
                }
<span class="nc" id="L559">        });</span>

<span class="nc" id="L561">        button = new JButton(&quot;Copy Row&quot;);</span>
<span class="nc" id="L562">        gbc.gridx = 9;</span>
<span class="nc" id="L563">        gbc.gridy = 2;</span>
<span class="nc" id="L564">        panFactionEditorTab.add(button, gbc);</span>
<span class="nc" id="L565">        button.addActionListener(ev -&gt; {</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">                if (tblSalvageEditor.getSelectedRow() &gt;= 0) {</span>
<span class="nc" id="L567">                    salvageEditorModel.copyRow(tblSalvageEditor.convertRowIndexToModel(tblSalvageEditor.getSelectedRow()),</span>
<span class="nc" id="L568">                            txtSalvageFaction.getText());</span>
                }
<span class="nc" id="L570">        });</span>

<span class="nc" id="L572">        salvageEditorModel = new SalvageEditorTableModel();</span>
<span class="nc" id="L573">        tblSalvageEditor.setModel(salvageEditorModel);</span>
<span class="nc" id="L574">        tblSalvageEditor.createDefaultColumnsFromModel();</span>
<span class="nc" id="L575">        tblSalvageEditor.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);</span>
<span class="nc" id="L576">        scroll = new JScrollPane(tblSalvageEditor, JScrollPane.VERTICAL_SCROLLBAR_ALWAYS,</span>
                JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L578">        scroll.setMinimumSize(new Dimension(600, 200));</span>
<span class="nc" id="L579">        scroll.setPreferredSize(new Dimension(600, 200));</span>
<span class="nc" id="L580">        scroll.setViewportView(tblSalvageEditor);</span>
<span class="nc" id="L581">        gbc.gridx = 6;</span>
<span class="nc" id="L582">        gbc.gridy = 3;</span>
<span class="nc" id="L583">        gbc.gridwidth = 8;</span>
<span class="nc" id="L584">        gbc.weightx = 1.0;</span>
<span class="nc" id="L585">        panFactionEditorTab.add(scroll, gbc);</span>

<span class="nc" id="L587">        return panFactionEditorTab;</span>
    }

    private void filterFactionList() {
        RowFilter&lt;FactionListTableModel, Integer&gt; rf;
<span class="nc" id="L592">        rf = new RowFilter&lt;FactionListTableModel, Integer&gt;() {</span>
            @Override
            public boolean include(Entry&lt;? extends FactionListTableModel,
                    ? extends Integer&gt; entry) {
<span class="nc" id="L596">                FactionListTableModel model = entry.getModel();</span>
<span class="nc" id="L597">                FactionRecord rec = model.getFactionRecord(entry.getIdentifier());</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                if (!chkShowSubfactions.isSelected() &amp;&amp;</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                        rec.getKey().contains(&quot;.&quot;)) {</span>
<span class="nc" id="L600">                    return false;</span>
                }

<span class="nc bnc" id="L603" title="All 2 branches missed.">                return chkShowMinorFactions.isSelected() ||</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">                        rec.getParentFactions() == null;</span>
            }
        };
<span class="nc" id="L607">        masterFactionListSorter.setRowFilter(rf);</span>
<span class="nc" id="L608">    }</span>

    private void filterMasterUnitList() {
        RowFilter&lt;MasterUnitListTableModel, Integer&gt; rf;
<span class="nc" id="L612">        rf = new RowFilter&lt;MasterUnitListTableModel, Integer&gt;() {</span>
            @Override
            public boolean include(Entry&lt;? extends MasterUnitListTableModel,
                    ? extends Integer&gt; entry) {
<span class="nc" id="L616">                MasterUnitListTableModel model = entry.getModel();</span>
<span class="nc" id="L617">                ModelRecord rec = model.getUnitRecord(entry.getIdentifier());</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                if (cbUnitType.getSelectedIndex() &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                        !UnitType.getTypeName(rec.getUnitType()).equals(cbUnitType.getSelectedItem())) {</span>
<span class="nc" id="L620">                    return false;</span>
                }
<span class="nc bnc" id="L622" title="All 2 branches missed.">                if (cbMovementType.getSelectedIndex() &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                        (rec.getMovementMode() != EntityMovementMode.getMode((String) cbMovementType.getSelectedItem()))) {</span>
<span class="nc" id="L624">                    return false;</span>
                }
<span class="nc bnc" id="L626" title="All 2 branches missed.">                if (txtSearch.getText().length() &gt; 0) {</span>
<span class="nc" id="L627">                    return rec.getKey().toLowerCase().contains(txtSearch.getText().toLowerCase());</span>
                }
<span class="nc" id="L629">                return true;</span>
            }
        };
<span class="nc" id="L632">        masterUnitListSorter.setRowFilter(rf);</span>
<span class="nc" id="L633">    }</span>

    private static class MasterUnitListTableModel extends DefaultTableModel {

        /**
         * 
         */
        private static final long serialVersionUID = 2792332961159226169L;

        public static final int COL_CHASSIS = 0;
        public static final int COL_MODEL = 1;
        public static final int COL_UNIT_TYPE = 2;
        public static final int COL_YEAR = 3;
        public static final int COL_ROLE = 4;
        public static final int COL_DEPLOYED_WITH = 5;
        public static final int COL_EXCLUDE_FACTIONS = 6;
        public static final int NUM_COLS = 7;
<span class="nc" id="L650">        public static final String[] colNames = {</span>
                &quot;Chassis&quot;, &quot;Model&quot;, &quot;Unit Type&quot;, &quot;Year&quot;, &quot;Role&quot;, &quot;Deployed With&quot;, &quot;Exclude Factions&quot;
        };

        private ArrayList&lt;ModelRecord&gt; data;

<span class="nc" id="L656">        public MasterUnitListTableModel(Collection&lt;ModelRecord&gt; modelList) {</span>
<span class="nc" id="L657">            data = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L658">            data.addAll(modelList);</span>
<span class="nc" id="L659">        }</span>

        @Override
        public String getColumnName(int column) {
<span class="nc" id="L663">            return colNames[column];</span>
        }

        @Override
        public int getColumnCount() {
<span class="nc" id="L668">            return NUM_COLS;</span>
        }

        @Override
        public int getRowCount() {
<span class="nc bnc" id="L673" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L674">                return 0;</span>
            }
<span class="nc" id="L676">            return data.size();</span>
        }

        @Override
        public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L681" title="All 2 branches missed.">            return col &gt;= COL_ROLE;</span>
        }

        @Override
        public Class&lt;?&gt; getColumnClass(int col) {
<span class="nc bnc" id="L686" title="All 2 branches missed.">            if (col == COL_YEAR) {</span>
<span class="nc" id="L687">                return Integer.class;</span>
            }
<span class="nc" id="L689">            return String.class;</span>
        }

        @Override
        public Object getValueAt(int row, int col) {
<span class="nc bnc" id="L694" title="All 8 branches missed.">            switch (col) {</span>
                case COL_CHASSIS:
<span class="nc" id="L696">                    return data.get(row).getChassis();</span>
                case COL_MODEL:
<span class="nc bnc" id="L698" title="All 2 branches missed.">                    if (data.get(row).isClan()) {</span>
<span class="nc" id="L699">                        return data.get(row).getModel() + &quot;[C]&quot;;</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">                    } else if (data.get(row).isSL()) {</span>
<span class="nc" id="L701">                        return data.get(row).getModel() + &quot;[*]&quot;;</span>
                    } 
<span class="nc" id="L703">                    return data.get(row).getModel();</span>
                case COL_UNIT_TYPE:
<span class="nc bnc" id="L705" title="All 2 branches missed.">                    if (data.get(row).getMechSummary() == null) {</span>
<span class="nc" id="L706">                        System.err.println(&quot;Could not find mechsummary for &quot; + data.get(row).getKey());</span>
                    }
<span class="nc" id="L708">                    return data.get(row).getMechSummary().getUnitType();</span>
                case COL_YEAR:
<span class="nc bnc" id="L710" title="All 2 branches missed.">                    if (data.get(row).getMechSummary() == null) {</span>
<span class="nc" id="L711">                        System.err.println(&quot;Could not find mechsummary for &quot; + data.get(row).getKey());</span>
                    }
<span class="nc" id="L713">                    return data.get(row).getMechSummary().getYear();</span>
                case COL_ROLE:
<span class="nc" id="L715">                    return data.get(row).getRoles().stream().map(Object::toString).collect(Collectors.joining(&quot;,&quot;));</span>
                case COL_DEPLOYED_WITH:
<span class="nc" id="L717">                    StringJoiner sj = new StringJoiner(&quot;,&quot;);</span>
<span class="nc" id="L718">                    data.get(row).getDeployedWith().forEach(sj::add);</span>
<span class="nc" id="L719">                    data.get(row).getRequiredUnits().forEach(s -&gt; sj.add(&quot;req:&quot; + s));</span>
<span class="nc" id="L720">                    return sj.toString();</span>
                case COL_EXCLUDE_FACTIONS:
<span class="nc" id="L722">                    return String.join(&quot;,&quot;, data.get(row).getExcludedFactions());</span>
                default:
<span class="nc" id="L724">                    return &quot;?&quot;;</span>
            }
        }

        @Override
        public void setValueAt(Object val, int row, int col) {
<span class="nc bnc" id="L730" title="All 2 branches missed.">            if (col == COL_ROLE) {</span>
<span class="nc" id="L731">                data.get(row).addRoles((String)val);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">            } else if (col == COL_DEPLOYED_WITH) {</span>
<span class="nc" id="L733">                data.get(row).getRequiredUnits().clear();</span>
<span class="nc" id="L734">                data.get(row).getDeployedWith().clear();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                if (((String)val).length() &gt; 0) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">                    for (String unit : ((String)val).split(&quot;,&quot;)) {</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">                        if (unit.startsWith(&quot;req:&quot;)) {</span>
<span class="nc" id="L738">                            data.get(row).getRequiredUnits().add(unit);             </span>
                        } else {
<span class="nc" id="L740">                            data.get(row).getDeployedWith().add(unit);</span>
                        }
                    }
                }
<span class="nc bnc" id="L744" title="All 2 branches missed.">            } else if (col == COL_EXCLUDE_FACTIONS) {</span>
<span class="nc" id="L745">                data.get(row).setExcludedFactions((String)val);</span>
            }
<span class="nc" id="L747">        }</span>

        public ModelRecord getUnitRecord(int row) {
<span class="nc" id="L750">            return data.get(row);</span>
        }
    }

    private static class UnitEditorTableModel extends DefaultTableModel {

        private static final long serialVersionUID = 1323721840252090355L;

        public static final int MODE_MODEL = 0;
        public static final int MODE_CHASSIS = 1;
        public static final int MODE_SUMMARY = 2;

        ArrayList&lt;String&gt; factions;
        HashMap&lt;String, ArrayList&lt;String&gt;&gt; data;
        private int mode;
        private AbstractUnitRecord unitRecord;
        
        private String getUnitKey() {
<span class="nc bnc" id="L768" title="All 2 branches missed.">            return (mode == MODE_CHASSIS) ? unitRecord.getChassisKey() : unitRecord.getKey();</span>
        }

<span class="nc" id="L771">        public UnitEditorTableModel() {</span>
<span class="nc" id="L772">            factions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L773">            data = new HashMap&lt;&gt;();</span>
<span class="nc" id="L774">            unitRecord = null;</span>
<span class="nc" id="L775">        }</span>

        public void clearData() {
<span class="nc" id="L778">            factions.clear();</span>
<span class="nc" id="L779">            data.clear();</span>
<span class="nc" id="L780">            unitRecord = null;</span>
<span class="nc" id="L781">            fireTableDataChanged();</span>
<span class="nc" id="L782">        }</span>

        public void setData(AbstractUnitRecord unitRec, int mode) {
<span class="nc" id="L785">            factions.clear();</span>
<span class="nc" id="L786">            data.clear();</span>
<span class="nc" id="L787">            this.mode = mode;</span>
<span class="nc" id="L788">            unitRecord = unitRec;</span>
<span class="nc" id="L789">            final ArrayList&lt;String&gt; empty = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">            while (empty.size() &lt; rg.getEraSet().size()) {</span>
<span class="nc" id="L791">                empty.add(&quot;&quot;);</span>
            }
<span class="nc bnc" id="L793" title="All 2 branches missed.">            for (int i = 0; i &lt; rg.getEraSet().size(); i++) {</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                Collection&lt;AvailabilityRating&gt; recs = (mode == MODE_MODEL)?</span>
<span class="nc" id="L795">                        rg.getModelFactionRatings(ERAS[i], getUnitKey()):</span>
<span class="nc" id="L796">                            rg.getChassisFactionRatings(ERAS[i], unitRec.getChassisKey());</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                        if (recs != null) {</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">                            for (AvailabilityRating rec : recs) {</span>
<span class="nc" id="L799">                                String key = rec.getFactionCode();</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">                                if (!factions.contains(key)) {</span>
<span class="nc" id="L801">                                    factions.add(key);</span>
<span class="nc" id="L802">                                    data.put(key, new ArrayList&lt;&gt;(empty));</span>
                                }
<span class="nc bnc" id="L804" title="All 2 branches missed.">                                if (mode == MODE_SUMMARY) {</span>
<span class="nc" id="L805">                                    AvailabilityRating mar = rg.findModelAvailabilityRecord(ERAS[i],</span>
<span class="nc" id="L806">                                            unitRec.getKey(), rec.getFaction());</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">                                    if (mar != null) {</span>
<span class="nc" id="L808">                                        int weight = (int)((rec.getWeight() * 10.0 * mar.getWeight()) /</span>
<span class="nc" id="L809">                                                rg.getChassisRecord(unitRec.getChassisKey()).</span>
<span class="nc" id="L810">                                                totalModelWeight(ERAS[i], rec.getFaction()) + 0.5);</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">                                        if (weight &gt; 0) {</span>
<span class="nc" id="L812">                                            data.get(key).set(i, Integer.toString(weight));</span>
                                        }
                                    } 
<span class="nc bnc" id="L815" title="All 2 branches missed.">                                } else if (rec.getEra() == rec.getStartYear()){</span>
<span class="nc" id="L816">                                    data.get(key).set(i, rec.getAvailabilityCode());</span>
                                } else {
<span class="nc" id="L818">                                    data.get(key).set(i, rec.getAvailabilityCode() + &quot;:&quot; + rec.getStartYear());                     </span>
                                }
<span class="nc" id="L820">                            }</span>
                        }
            }
<span class="nc" id="L823">            fireTableDataChanged();</span>
<span class="nc" id="L824">        }</span>

        @Override
        public String getColumnName(int col) {
<span class="nc bnc" id="L828" title="All 2 branches missed.">            if (col == 0) {</span>
<span class="nc" id="L829">                return &quot;Faction&quot;;</span>
            }
<span class="nc" id="L831">            return Integer.toString(ERAS[col - 1]); </span>
        }

        @Override
        public int getColumnCount() {
<span class="nc bnc" id="L836" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L837">                return 0;</span>
            }
<span class="nc" id="L839">            return ERAS.length + 1;</span>
        }

        public int getRowCount() {
<span class="nc bnc" id="L843" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L844">                return 0;</span>
            }
<span class="nc" id="L846">            return data.size();</span>
        }

        @Override
        public Class&lt;?&gt; getColumnClass(int col) {
<span class="nc" id="L851">            return String.class;</span>
        }

        @Override
        public Object getValueAt(int row, int col) {
<span class="nc bnc" id="L856" title="All 2 branches missed.">            if (col == 0) {</span>
<span class="nc" id="L857">                return factions.get(row);</span>
            } else {
<span class="nc" id="L859">                return data.get(factions.get(row)).get(col - 1);</span>
            } 
        }

        @Override
        public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L865" title="All 4 branches missed.">            return mode &lt; MODE_SUMMARY &amp;&amp; col &gt; 0;</span>
        }

        @Override
        public void setValueAt(Object value, int row, int col) {
            AvailabilityRating ar;
<span class="nc" id="L871">            int era = ERAS[col - 1];</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">            if ((value).equals(&quot;&quot;)) {</span>
<span class="nc" id="L873">                ar = null;</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">            } else if (!((String)value).matches(&quot;\\d+[+\\-]?(:\\d+)?&quot;)) {</span>
<span class="nc" id="L875">                return;</span>
            } else {
<span class="nc" id="L877">                ar = new AvailabilityRating(getUnitKey(), era,</span>
<span class="nc" id="L878">                        factions.get(row) + &quot;:&quot; + value);</span>
            }
<span class="nc" id="L880">            data.get(factions.get(row)).set(col - 1, (String)value);</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">            if (rg.getChassisRecord(getUnitKey()) != null) {</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                if (ar == null) {</span>
<span class="nc" id="L883">                    rg.removeChassisFactionRating(era, getUnitKey(), factions.get(row));                </span>
                } else {
<span class="nc" id="L885">                    rg.setChassisFactionRating(era, getUnitKey(), ar);</span>
                }
            } else {
<span class="nc bnc" id="L888" title="All 2 branches missed.">                if (ar == null) {</span>
<span class="nc" id="L889">                    rg.removeModelFactionRating(era, getUnitKey(), factions.get(row));               </span>
                } else {
<span class="nc" id="L891">                    rg.setModelFactionRating(era, getUnitKey(), ar);</span>
                }
            }
<span class="nc" id="L894">        }</span>

        public boolean addEntry(String faction) {
<span class="nc bnc" id="L897" title="All 2 branches missed.">            if(unitRecord == null) {                 </span>
<span class="nc" id="L898">                return false;</span>
            }
            
<span class="nc bnc" id="L901" title="All 2 branches missed.">            if(mode == MODE_MODEL) {</span>
<span class="nc" id="L902">                boolean chassisRecordFound = false;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                for(int era : ERAS) {</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                    if(rg.getChassisFactionRatings(era, unitRecord.getChassisKey()) != null) {</span>
<span class="nc" id="L905">                        chassisRecordFound = true;</span>
<span class="nc" id="L906">                        break;</span>
                    }
                }
                
<span class="nc bnc" id="L910" title="All 2 branches missed.">                if(!chassisRecordFound) {</span>
<span class="nc" id="L911">                    return false;</span>
                }
            }                    
            
<span class="nc" id="L915">            factions.add(faction);</span>
<span class="nc" id="L916">            ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">            while (list.size() &lt; ERAS.length) {</span>
<span class="nc" id="L918">                list.add(&quot;&quot;);</span>
            }
<span class="nc" id="L920">            data.put(faction, list);</span>
<span class="nc" id="L921">            fireTableDataChanged();</span>
<span class="nc" id="L922">            return true;</span>
        }

        public void removeEntry(int row) {
<span class="nc bnc" id="L926" title="All 2 branches missed.">            for (int era : ERAS) {</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">                if (mode == MODE_CHASSIS) {</span>
<span class="nc" id="L928">                    rg.removeChassisFactionRating(era, getUnitKey(), factions.get(row));                </span>
                } else {
<span class="nc" id="L930">                    rg.removeModelFactionRating(era, getUnitKey(), factions.get(row));                               </span>
                }
            }
<span class="nc" id="L933">            data.remove(factions.get(row));</span>
<span class="nc" id="L934">            factions.remove(row);</span>
<span class="nc" id="L935">            fireTableDataChanged();</span>
<span class="nc" id="L936">        }</span>

        public void copyRow(int row, String newFaction) {
<span class="nc" id="L939">            ArrayList&lt;String&gt; copyFrom = data.get(factions.get(row));</span>
<span class="nc" id="L940">            factions.add(newFaction);</span>
<span class="nc" id="L941">            ArrayList&lt;String&gt; copyTo = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">            for (int i = 0; i &lt; ERAS.length; i++) {</span>
<span class="nc" id="L943">                copyTo.add(copyFrom.get(i));</span>
            }       
<span class="nc" id="L945">            data.put(newFaction, copyTo);</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            for (int i = 0; i &lt; ERAS.length; i++) {</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                if (!copyFrom.get(i).equals(&quot;&quot;)) {</span>
<span class="nc" id="L948">                    AvailabilityRating ar = new AvailabilityRating(getUnitKey(), ERAS[i],</span>
<span class="nc" id="L949">                            newFaction + &quot;:&quot; + copyFrom.get(i));</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                    if (mode == MODE_MODEL) {</span>
<span class="nc" id="L951">                        rg.setModelFactionRating(ERAS[i], getUnitKey(), ar);</span>
                    } else {
<span class="nc" id="L953">                        rg.setChassisFactionRating(ERAS[i], getUnitKey(), ar);</span>
                    }
                }
            }
<span class="nc" id="L957">            fireTableDataChanged();</span>
<span class="nc" id="L958">        }</span>

        public int getMode() {
<span class="nc" id="L961">            return mode;</span>
        }
    }

    private static class UnitTypeComparator implements Comparator&lt;String&gt; {
        private Map&lt;String, Integer&gt; keys;

<span class="nc" id="L968">        public UnitTypeComparator() {</span>
<span class="nc" id="L969">            keys = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">            for (int i = 0; i &lt; UnitType.SIZE; i++) {</span>
<span class="nc" id="L971">                keys.put(UnitType.getTypeName(i), i);</span>
            }
<span class="nc" id="L973">        }</span>
        @Override
        public int compare(String arg0, String arg1) {
<span class="nc" id="L976">            return keys.get(arg0) - keys.get(arg1);</span>
        }

    }

    private static class FactionListTableModel extends DefaultTableModel {

        /**
         * 
         */
        private static final long serialVersionUID = -2719685611810784836L;

        public static final int COL_CODE = 0;
        public static final int COL_NAME = 1;
        public static final int COL_YEARS = 2;
        public static final int COL_MINOR = 3;
        public static final int COL_CLAN = 4;
        public static final int COL_PERIPHERY = 5;
        public static final int COL_RATINGS = 6;
        public static final int COL_USE_ALT_FACTION = 7;
        public static final int NUM_COLS = 8;
        
<span class="nc" id="L998">        public static final String[] colNames = {&quot;Code&quot;, &quot;Name&quot;, &quot;Years&quot;, &quot;Minor&quot;, &quot;Clan&quot;,</span>
            &quot;Periphery&quot;, &quot;Ratings&quot;, &quot;Use Alt&quot;};
        
        private ArrayList&lt;FactionRecord&gt; data;
        
<span class="nc" id="L1003">        public FactionListTableModel(Collection&lt;FactionRecord&gt; factionList) {</span>
<span class="nc" id="L1004">            data = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1005">            data.addAll(factionList);</span>
<span class="nc" id="L1006">        }</span>
        
        public void addRecord(FactionRecord rec) {
<span class="nc" id="L1009">            data.add(rec);</span>
<span class="nc" id="L1010">            fireTableDataChanged();</span>
<span class="nc" id="L1011">        }</span>
        
        public void delRecord(FactionRecord rec) {
<span class="nc" id="L1014">            data.remove(rec);</span>
<span class="nc" id="L1015">            fireTableDataChanged();</span>
<span class="nc" id="L1016">        }</span>
        
        @Override
        public String getColumnName(int column) {
<span class="nc" id="L1020">            return colNames[column];</span>
        }

        @Override
        public int getColumnCount() {
<span class="nc" id="L1025">            return NUM_COLS;</span>
        }
        
        @Override
        public int getRowCount() {
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L1031">                return 0;</span>
            }
<span class="nc" id="L1033">            return data.size();</span>
        }
        
        @Override
        public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L1038" title="All 2 branches missed.">            return col &gt; COL_CODE;</span>
        }
        
        @Override
        public Class&lt;?&gt; getColumnClass(int col) {
<span class="nc bnc" id="L1043" title="All 6 branches missed.">            if (col == COL_MINOR || col == COL_CLAN || col == COL_PERIPHERY) {</span>
<span class="nc" id="L1044">                return Boolean.class;</span>
            }
<span class="nc" id="L1046">            return String.class;</span>
        }
        
        @Override
        public Object getValueAt(int row, int col) {
<span class="nc bnc" id="L1051" title="All 9 branches missed.">            switch (col) {</span>
            case COL_CODE:
<span class="nc" id="L1053">                return data.get(row).getKey();</span>
            case COL_NAME:
<span class="nc" id="L1055">                return data.get(row).getNamesAsString();</span>
            case COL_YEARS:
<span class="nc" id="L1057">                return data.get(row).getYearsAsString();</span>
            case COL_MINOR:
<span class="nc" id="L1059">                return data.get(row).isMinor();</span>
            case COL_CLAN:
<span class="nc" id="L1061">                return data.get(row).isClan();</span>
            case COL_PERIPHERY:
<span class="nc" id="L1063">                return data.get(row).isPeriphery();</span>
            case COL_RATINGS:
<span class="nc" id="L1065">                return String.join(&quot;,&quot;, data.get(row).getRatingLevels());</span>
            case COL_USE_ALT_FACTION:
<span class="nc" id="L1067">                return String.join(&quot;,&quot;, data.get(row).getParentFactions());</span>
            default:
<span class="nc" id="L1069">                return &quot;?&quot;;</span>
            }
        }
        
        @Override
        public void setValueAt(Object val, int row, int col) {
<span class="nc bnc" id="L1075" title="All 8 branches missed.">            switch (col) {</span>
            case COL_CLAN:
<span class="nc" id="L1077">                data.get(row).setClan((Boolean)val);</span>
<span class="nc" id="L1078">                break;</span>
            case COL_PERIPHERY:
<span class="nc" id="L1080">                data.get(row).setPeriphery((Boolean)val);</span>
<span class="nc" id="L1081">                break;</span>
            case COL_NAME:
<span class="nc" id="L1083">                data.get(row).setNames((String)val);</span>
<span class="nc" id="L1084">                break;</span>
            case COL_YEARS:
                try {
<span class="nc" id="L1087">                    data.get(row).setYears((String)val);</span>
<span class="nc" id="L1088">                } catch (Exception ex) {</span>
                    //Illegal format; ignore new value
<span class="nc" id="L1090">                }</span>
<span class="nc" id="L1091">                break;</span>
            case COL_MINOR:
<span class="nc" id="L1093">                data.get(row).setMinor((Boolean)val);</span>
<span class="nc" id="L1094">                break;</span>
            case COL_RATINGS:
<span class="nc" id="L1096">                data.get(row).setRatings((String)val);</span>
<span class="nc" id="L1097">                break;</span>
            case COL_USE_ALT_FACTION:
<span class="nc" id="L1099">                data.get(row).setParentFactions((String)val);</span>
            }
<span class="nc" id="L1101">        }</span>
        
        public FactionRecord getFactionRecord(int row) {
<span class="nc" id="L1104">            return data.get(row);</span>
        }
        
    }
    
    private static class FactionEditorTableModel extends DefaultTableModel {
        
        private static final long serialVersionUID = 5324520609209690560L;
        
        private static final int CAT_OMNI_PCT = 0;
        private static final int CAT_CLAN_PCT = 1;
        private static final int CAT_SL_PCT = 2;
        private static final int CAT_OMNI_AERO_PCT = 3;
        private static final int CAT_CLAN_AERO_PCT = 4;
        private static final int CAT_SL_AERO_PCT = 5;
        private static final int CAT_CLAN_VEE_PCT = 6;
        private static final int CAT_SL_VEE_PCT = 7;
<span class="nc" id="L1121">        private static final String [] CATEGORIES = {</span>
            &quot;Omni %&quot;, &quot;Clan %&quot;, &quot;SL %&quot;,
            &quot;Omni % (Aero)&quot;, &quot;Clan % (Aero)&quot;, &quot;SL % (Aero)&quot;,
            &quot;Clan % (Vee)&quot;, &quot;SL % (Vee)&quot;
        };
        
<span class="nc" id="L1127">        private static final int[] WEIGHT_DIST_UNIT_TYPES = {</span>
                UnitType.MEK, UnitType.TANK, UnitType.AERO
        };
        
        private FactionRecord factionRec;
        
<span class="nc" id="L1133">        public FactionEditorTableModel(FactionRecord rec) {</span>
<span class="nc" id="L1134">            factionRec = rec;</span>
<span class="nc" id="L1135">        }</span>

        public void clearData() {
<span class="nc" id="L1138">            setData(null);</span>
<span class="nc" id="L1139">        }</span>
        
        public void setData(FactionRecord rec) {
<span class="nc" id="L1142">            factionRec = rec;</span>
<span class="nc" id="L1143">            fireTableDataChanged();</span>
<span class="nc" id="L1144">        }</span>
        
        @Override
        public String getColumnName(int column) {
<span class="nc bnc" id="L1148" title="All 2 branches missed.">            if (column == 0) {</span>
<span class="nc" id="L1149">                return &quot;&quot;;</span>
            } else {
<span class="nc" id="L1151">                return Integer.toString(ERAS[column - 1]);</span>
            }
        }

        @Override
        public int getColumnCount() {
<span class="nc" id="L1157">            return ERAS.length + 1;</span>
        }
        
        @Override
        public int getRowCount() {
<span class="nc bnc" id="L1162" title="All 2 branches missed.">            if (factionRec == null) {</span>
<span class="nc" id="L1163">                return 0;</span>
            }
<span class="nc" id="L1165">            return 1 + CATEGORIES.length * factionRec.getRatingLevels().size()</span>
                    + WEIGHT_DIST_UNIT_TYPES.length;
        }
        
        @Override
        public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L1171" title="All 4 branches missed.">            return factionRec != null &amp;&amp; col &gt; 0;</span>
        }
        
        @Override
        public Class&lt;?&gt; getColumnClass(int col) {
<span class="nc" id="L1176">            return String.class;</span>
        }
        
        @Override
        public Object getValueAt(int row, int col) {
<span class="nc bnc" id="L1181" title="All 2 branches missed.">            if (factionRec == null) {</span>
<span class="nc" id="L1182">                return &quot;&quot;;</span>
            }
<span class="nc bnc" id="L1184" title="All 2 branches missed.">            if (col == 0) {</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">                if (row == 0) {</span>
<span class="nc" id="L1186">                    return &quot;Salvage %&quot;;</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">                } else if (row &gt; factionRec.getRatingLevels().size() * CATEGORIES.length) {</span>
<span class="nc" id="L1188">                    return WEIGHT_DIST_UNIT_TYPES[row - 1 - factionRec.getRatingLevels().size() * CATEGORIES.length];</span>
                } else {
<span class="nc" id="L1190">                    return CATEGORIES[(row - 1) / factionRec.getRatingLevels().size()]</span>
<span class="nc" id="L1191">                            + &quot; &quot; + factionRec.getRatingLevels().get((row - 1) % factionRec.getRatingLevels().size());</span>
                }
            }
<span class="nc" id="L1194">            int era = ERAS[col - 1];</span>
            
<span class="nc bnc" id="L1196" title="All 2 branches missed.">            if (row == 0) {</span>
<span class="nc" id="L1197">                Integer pct = factionRec.getPctSalvage(era);</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">                return (pct == null)?&quot;&quot;:pct.toString();</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">            } else if (row &gt; factionRec.getRatingLevels().size() * CATEGORIES.length) {</span>
<span class="nc" id="L1200">                int unitType = WEIGHT_DIST_UNIT_TYPES[row - 1 - factionRec.getRatingLevels().size() * CATEGORIES.length];</span>
<span class="nc" id="L1201">                return factionRec.getWeightDistributionAsString(era, unitType);</span>
            }
<span class="nc" id="L1203">            int rating = (row - 1) % factionRec.getRatingLevels().size();</span>
<span class="nc bnc" id="L1204" title="All 9 branches missed.">            switch ((row - 1) / factionRec.getRatingLevels().size()) {</span>
            case CAT_OMNI_PCT:
<span class="nc" id="L1206">                return factionRec.getPctTech(TechCategory.OMNI, era, rating);</span>
            case CAT_CLAN_PCT:
<span class="nc" id="L1208">                return factionRec.getPctTech(TechCategory.CLAN, era, rating);</span>
            case CAT_SL_PCT:
<span class="nc" id="L1210">                return factionRec.getPctTech(TechCategory.IS_ADVANCED, era, rating);</span>
            case CAT_OMNI_AERO_PCT:
<span class="nc" id="L1212">                return factionRec.getPctTech(TechCategory.OMNI_AERO, era, rating);</span>
            case CAT_CLAN_AERO_PCT:
<span class="nc" id="L1214">                return factionRec.getPctTech(TechCategory.CLAN_AERO, era, rating);</span>
            case CAT_SL_AERO_PCT:
<span class="nc" id="L1216">                return factionRec.getPctTech(TechCategory.IS_ADVANCED_AERO, era, rating);</span>
            case CAT_CLAN_VEE_PCT:
<span class="nc" id="L1218">                return factionRec.getPctTech(TechCategory.CLAN_VEE, era, rating);</span>
            case CAT_SL_VEE_PCT:
<span class="nc" id="L1220">                return factionRec.getPctTech(TechCategory.IS_ADVANCED_VEE, era, rating);</span>
            default:
<span class="nc" id="L1222">                return &quot;?&quot;;</span>
            }
        }
        
        @Override
        public void setValueAt(Object val, int row, int col) {
<span class="nc" id="L1228">            int era = ERAS[col - 1];</span>
<span class="nc" id="L1229">            Integer value = null;</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">            if (((String)val).length() &gt; 0) {</span>
                try {
<span class="nc" id="L1232">                    value = Integer.parseInt((String)val);</span>
<span class="nc" id="L1233">                } catch (NumberFormatException ex) {</span>
                    //leave null
<span class="nc" id="L1235">                }</span>
            }
<span class="nc bnc" id="L1237" title="All 2 branches missed.">            if (row == 0) {</span>
<span class="nc" id="L1238">                factionRec.setPctSalvage(era, value);</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">            } else if (row &gt; factionRec.getRatingLevels().size() * CATEGORIES.length) {</span>
<span class="nc" id="L1240">                int unitType = WEIGHT_DIST_UNIT_TYPES[row - 1 - factionRec.getRatingLevels().size() * CATEGORIES.length];</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">                if (((String)val).length() &gt; 0) {</span>
                    try {
<span class="nc" id="L1243">                        factionRec.setWeightDistribution(era, unitType, (String)val);</span>
<span class="nc" id="L1244">                    } catch (Exception ex) {</span>
                        //ignore
<span class="nc" id="L1246">                    }</span>
                } else {
<span class="nc" id="L1248">                    factionRec.setWeightDistribution(era, unitType, null);</span>
                }
<span class="nc bnc" id="L1250" title="All 2 branches missed.">            } else if (null != value) {</span>
<span class="nc" id="L1251">                int rating = (row - 1) % factionRec.getRatingLevels().size();</span>
<span class="nc bnc" id="L1252" title="All 9 branches missed.">                switch ((row - 1) / factionRec.getRatingLevels().size()) {</span>
                case CAT_OMNI_PCT:
<span class="nc" id="L1254">                    factionRec.setPctTech(TechCategory.OMNI, era, rating, value);</span>
<span class="nc" id="L1255">                    break;</span>
                case CAT_CLAN_PCT:
<span class="nc" id="L1257">                    factionRec.setPctTech(TechCategory.CLAN, era, rating, value);</span>
<span class="nc" id="L1258">                    break;</span>
                case CAT_SL_PCT:
<span class="nc" id="L1260">                    factionRec.setPctTech(TechCategory.IS_ADVANCED, era, rating, value);</span>
<span class="nc" id="L1261">                    break;</span>
                case CAT_OMNI_AERO_PCT:
<span class="nc" id="L1263">                    factionRec.setPctTech(TechCategory.OMNI_AERO, era, rating, value);</span>
<span class="nc" id="L1264">                    break;</span>
                case CAT_CLAN_AERO_PCT:
<span class="nc" id="L1266">                    factionRec.setPctTech(TechCategory.CLAN_AERO, era, rating, value);</span>
<span class="nc" id="L1267">                    break;</span>
                case CAT_SL_AERO_PCT:
<span class="nc" id="L1269">                    factionRec.setPctTech(TechCategory.IS_ADVANCED_AERO, era, rating, value);</span>
<span class="nc" id="L1270">                    break;</span>
                case CAT_CLAN_VEE_PCT:
<span class="nc" id="L1272">                    factionRec.setPctTech(TechCategory.CLAN_VEE, era, rating, value);</span>
<span class="nc" id="L1273">                    break;</span>
                case CAT_SL_VEE_PCT:
<span class="nc" id="L1275">                    factionRec.setPctTech(TechCategory.IS_ADVANCED_VEE, era, rating, value);</span>
                    break;
                }
            }
<span class="nc" id="L1279">        }</span>
        
    }
    
    private static class SalvageEditorTableModel extends DefaultTableModel {
        
        /**
         * 
         */
        private static final long serialVersionUID = -3155497417382584025L;
        
        ArrayList&lt;String&gt; factions;
        HashMap&lt;String, ArrayList&lt;String&gt;&gt; data;
        private FactionRecord factionRec;
        
<span class="nc" id="L1294">        public SalvageEditorTableModel() {</span>
<span class="nc" id="L1295">            factions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1296">            data = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1297">            factionRec = null;</span>
<span class="nc" id="L1298">        }</span>

        public void clearData() {
<span class="nc" id="L1301">            factionRec = null;</span>
<span class="nc" id="L1302">            factions.clear();</span>
<span class="nc" id="L1303">            data.clear();</span>
<span class="nc" id="L1304">            fireTableDataChanged();</span>
<span class="nc" id="L1305">        }</span>

        public void setData(FactionRecord rec) {
<span class="nc" id="L1308">            factionRec = rec;</span>
<span class="nc" id="L1309">            factions.clear();</span>
<span class="nc" id="L1310">            data.clear();</span>
<span class="nc" id="L1311">            final ArrayList&lt;String&gt; empty = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">            while (empty.size() &lt; ERAS.length) {</span>
<span class="nc" id="L1313">                empty.add(&quot;&quot;);</span>
            }
<span class="nc bnc" id="L1315" title="All 2 branches missed.">            for (int i = 0; i &lt; ERAS.length; i++) {</span>
<span class="nc" id="L1316">                HashMap&lt;String,Integer&gt; recs = factionRec.getSalvage(ERAS[i]);</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">                if (recs != null) {</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                    for (String faction : recs.keySet()) {</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">                        if (!factions.contains(faction)) {</span>
<span class="nc" id="L1320">                            factions.add(faction);</span>
<span class="nc" id="L1321">                            data.put(faction, new ArrayList&lt;&gt;(empty));</span>
                        }
<span class="nc" id="L1323">                        data.get(faction).set(i, recs.get(faction).toString());</span>
<span class="nc" id="L1324">                    }</span>
                }
            }
<span class="nc" id="L1327">            fireTableDataChanged();</span>
<span class="nc" id="L1328">        }</span>

        @Override
        public String getColumnName(int col) {
<span class="nc bnc" id="L1332" title="All 2 branches missed.">            if (col == 0) {</span>
<span class="nc" id="L1333">                return &quot;Faction&quot;;</span>
            }
<span class="nc" id="L1335">            return Integer.toString(ERAS[col - 1]); </span>
        }
        
        @Override
        public int getColumnCount() {
<span class="nc bnc" id="L1340" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L1341">                return 0;</span>
            }
<span class="nc" id="L1343">            return ERAS.length + 1;</span>
        }
        
        public int getRowCount() {
<span class="nc bnc" id="L1347" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L1348">                return 0;</span>
            }
<span class="nc" id="L1350">            return data.size();</span>
        }
        
        @Override
        public Class&lt;?&gt; getColumnClass(int col) {
<span class="nc" id="L1355">            return String.class;</span>
        }
        
        @Override
        public Object getValueAt(int row, int col) {
<span class="nc bnc" id="L1360" title="All 2 branches missed.">            if (col == 0) {</span>
<span class="nc" id="L1361">                return factions.get(row);</span>
            } else {
<span class="nc" id="L1363">                return data.get(factions.get(row)).get(col - 1);</span>
            } 
        }
        
        @Override
        public boolean isCellEditable(int row, int col) {
<span class="nc bnc" id="L1369" title="All 2 branches missed.">            return col &gt; 0;</span>
        }
        
        @Override
        public void setValueAt(Object value, int row, int col) {
            Integer wt;
<span class="nc" id="L1375">            int era = ERAS[col - 1];</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">            if (&quot;&quot;.equals(value)) {</span>
<span class="nc" id="L1377">                wt = null;</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">            } else if (!((String)value).matches(&quot;\\d+&quot;)) {</span>
<span class="nc" id="L1379">                return;</span>
            } else {
<span class="nc" id="L1381">                wt = Integer.parseInt((String)value);</span>
            }
<span class="nc" id="L1383">            data.get(factions.get(row)).set(col - 1, (String)value);</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">            if (wt == null) {</span>
<span class="nc" id="L1385">                factionRec.removeSalvage(era, factions.get(row));</span>
            } else {
<span class="nc" id="L1387">                factionRec.setSalvage(era, factions.get(row), wt);</span>
            }
<span class="nc" id="L1389">        }</span>
        
        public void addEntry(String faction) {
<span class="nc" id="L1392">            factions.add(faction);</span>
<span class="nc" id="L1393">            ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1394" title="All 2 branches missed.">            while (list.size() &lt; ERAS.length) {</span>
<span class="nc" id="L1395">                list.add(&quot;&quot;);</span>
            }
<span class="nc" id="L1397">            data.put(faction, list);</span>
<span class="nc" id="L1398">            fireTableDataChanged();</span>
<span class="nc" id="L1399">        }</span>
        
        public void removeEntry(int row) {
<span class="nc bnc" id="L1402" title="All 2 branches missed.">            for (int era : ERAS) {</span>
<span class="nc" id="L1403">                factionRec.removeSalvage(era, factions.get(row));</span>
            }
<span class="nc" id="L1405">            data.remove(factions.get(row));</span>
<span class="nc" id="L1406">            factions.remove(row);</span>
<span class="nc" id="L1407">            fireTableDataChanged();</span>
<span class="nc" id="L1408">        }</span>
        
        public void copyRow(int row, String newFaction) {
<span class="nc" id="L1411">            ArrayList&lt;String&gt; copyFrom = data.get(factions.get(row));</span>
<span class="nc" id="L1412">            factions.add(newFaction);</span>
<span class="nc" id="L1413">            ArrayList&lt;String&gt; copyTo = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">            for (int i = 0; i &lt; ERAS.length; i++) {</span>
<span class="nc" id="L1415">                copyTo.add(copyFrom.get(i));</span>
            }       
<span class="nc" id="L1417">            data.put(newFaction, copyTo);</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">            for (int i = 0; i &lt; ERAS.length; i++) {</span>
<span class="nc bnc" id="L1419" title="All 2 branches missed.">                if (!copyFrom.get(i).equals(&quot;&quot;)) {</span>
<span class="nc" id="L1420">                    factionRec.setSalvage(ERAS[i], newFaction, Integer.parseInt(copyFrom.get(i)));</span>
                }
            }
<span class="nc" id="L1423">            fireTableDataChanged();</span>
<span class="nc" id="L1424">        }</span>
        
    }

    /**
     * Runs the RATGeneratorEditor UI
     *
     * @param args The RATGenerator data will be loaded from the directory named as the first element
     *             of the arguments. If the {@code args} element is empty, or the first element
     *             is not a valid directory, loads from the default location.
     */
    public static void main(String[] args) {
<span class="nc" id="L1436">        SwingUtilities.invokeLater (() -&gt; {</span>
            RATGeneratorEditor ui;
<span class="nc bnc" id="L1438" title="All 2 branches missed.">            if (args.length &gt; 0) {</span>
<span class="nc" id="L1439">                File dir = new File(args[0]);</span>
<span class="nc bnc" id="L1440" title="All 4 branches missed.">                if (dir.exists() &amp;&amp; dir.isDirectory()) {</span>
<span class="nc" id="L1441">                    ui = new RATGeneratorEditor(dir);</span>
                } else {
<span class="nc" id="L1443">                    MegaMek.getLogger().info(args[0] + &quot; is not a valid directory name&quot;);</span>
<span class="nc" id="L1444">                    ui = new RATGeneratorEditor();</span>
                }
<span class="nc" id="L1446">            } else {</span>
<span class="nc" id="L1447">                ui = new RATGeneratorEditor();</span>
            }
<span class="nc" id="L1449">            ui.setVisible(true);</span>
<span class="nc" id="L1450">        });</span>
<span class="nc" id="L1451">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>