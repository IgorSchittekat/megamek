<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.server</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
* Copyright (C) 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
* Copyright (C) 2018, 2020 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/
package megamek.server;

import java.io.*;
import java.net.HttpURLConnection;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.URL;
import java.net.URLEncoder;
import java.net.UnknownHostException;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.Timer;
import java.util.TimerTask;
import java.util.TreeMap;
import java.util.TreeSet;
import java.util.Vector;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.stream.Collectors;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

import com.thoughtworks.xstream.XStream;

import megamek.MegaMek;
import megamek.client.ui.swing.util.PlayerColour;
import megamek.common.*;
import megamek.common.Building.BasementType;
import megamek.common.Building.DemolitionCharge;
import megamek.common.IGame.Phase;
import megamek.common.MovePath.MoveStepType;
import megamek.common.actions.*;
import megamek.common.containers.PlayerIDandList;
import megamek.common.event.GameListener;
import megamek.common.event.GameVictoryEvent;
import megamek.common.icons.Camouflage;
import megamek.common.net.ConnectionFactory;
import megamek.common.net.ConnectionListenerAdapter;
import megamek.common.net.DisconnectedEvent;
import megamek.common.net.IConnection;
import megamek.common.net.Packet;
import megamek.common.net.PacketReceivedEvent;
import megamek.common.options.GameOptions;
import megamek.common.options.IBasicOption;
import megamek.common.options.IOption;
import megamek.common.options.OptionsConstants;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.BoardUtilities;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.util.SerializationHelper;
import megamek.common.util.StringUtil;
import megamek.common.verifier.EntityVerifier;
import megamek.common.verifier.TestAero;
import megamek.common.verifier.TestBattleArmor;
import megamek.common.verifier.TestEntity;
import megamek.common.verifier.TestMech;
import megamek.common.verifier.TestSupportVehicle;
import megamek.common.verifier.TestTank;
import megamek.common.weapons.AreaEffectHelper;
import megamek.common.weapons.AreaEffectHelper.DamageFalloff;
import megamek.common.weapons.AreaEffectHelper.NukeStats;
import megamek.common.weapons.ArtilleryBayWeaponIndirectHomingHandler;
import megamek.common.weapons.ArtilleryWeaponIndirectHomingHandler;
import megamek.common.weapons.AttackHandler;
import megamek.common.weapons.CapitalMissileBearingsOnlyHandler;
import megamek.common.weapons.TAGHandler;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.WeaponHandler;
import megamek.common.weapons.infantry.InfantryWeapon;
import megamek.common.weapons.other.TSEMPWeapon;
import megamek.server.commands.AddBotCommand;
import megamek.server.commands.AllowTeamChangeCommand;
import megamek.server.commands.AssignNovaNetServerCommand;
import megamek.server.commands.CheckBVCommand;
import megamek.server.commands.CheckBVTeamCommand;
import megamek.server.commands.DefeatCommand;
import megamek.server.commands.ExportListCommand;
import megamek.server.commands.FixElevationCommand;
import megamek.server.commands.HelpCommand;
import megamek.server.commands.JoinTeamCommand;
import megamek.server.commands.KickCommand;
import megamek.server.commands.ListEntitiesCommand;
import megamek.server.commands.ListSavesCommand;
import megamek.server.commands.LoadGameCommand;
import megamek.server.commands.LocalLoadGameCommand;
import megamek.server.commands.LocalSaveGameCommand;
import megamek.server.commands.NukeCommand;
import megamek.server.commands.ResetCommand;
import megamek.server.commands.RollCommand;
import megamek.server.commands.RulerCommand;
import megamek.server.commands.SaveGameCommand;
import megamek.server.commands.SeeAllCommand;
import megamek.server.commands.ServerCommand;
import megamek.server.commands.ShowEntityCommand;
import megamek.server.commands.ShowTileCommand;
import megamek.server.commands.ShowValidTargetsCommand;
import megamek.server.commands.SkipCommand;
import megamek.server.commands.TeamCommand;
import megamek.server.commands.TraitorCommand;
import megamek.server.commands.VictoryCommand;
import megamek.server.commands.WhoCommand;
import megamek.server.victory.VictoryResult;

/**
 * @author Ben Mazur
 */
public class Server implements Runnable {
    private static class EntityTargetPair {
        Entity ent;

        Targetable target;

<span class="nc" id="L146">        EntityTargetPair (Entity e, Targetable t) {</span>
<span class="nc" id="L147">            ent = e;</span>
<span class="nc" id="L148">            target = t;</span>
<span class="nc" id="L149">        }</span>

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (this == o) {</span>
<span class="nc" id="L154">                return true;</span>
            }
<span class="nc bnc" id="L156" title="All 4 branches missed.">            if ((null == o) || (getClass() != o.getClass())) {</span>
<span class="nc" id="L157">                return false;</span>
            }
<span class="nc" id="L159">            final EntityTargetPair other = (EntityTargetPair) o;</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">            return Objects.equals(ent, other.ent) &amp;&amp; Objects.equals(target, other.target);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L165">            return Objects.hash(ent, target);</span>
        }

    }
    /**
     * The DamageType enumeration is used for the damageEntity function.
     */
<span class="nc" id="L172">    public enum DamageType {</span>
<span class="nc" id="L173">        NONE, FRAGMENTATION, FLECHETTE, ACID, INCENDIARY, IGNORE_PASSENGER, ANTI_TSM, ANTI_INFANTRY, NAIL_RIVET,</span>
<span class="nc" id="L174">        NONPENETRATING</span>
    }

    // public static final String LEGAL_CHARS =
    // &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-&quot;;
    private static final String DEFAULT_BOARD = MapSettings.BOARD_SURPRISE;

    // server setup
    private String password;

    private final String metaServerUrl;

    private ServerSocket serverSocket;

    private String motd;

    private static class ReceivedPacket {
        public int connId;
        public Packet packet;

<span class="nc" id="L194">        ReceivedPacket(int cid, Packet p) {</span>
<span class="nc" id="L195">            packet = p;</span>
<span class="nc" id="L196">            connId = cid;</span>
<span class="nc" id="L197">        }</span>

    }

    private class PacketPump implements Runnable {

        boolean shouldStop;

<span class="nc" id="L205">        PacketPump() {</span>
<span class="nc" id="L206">            shouldStop = false;</span>
<span class="nc" id="L207">        }</span>

        void signalEnd() {
<span class="nc" id="L210">            shouldStop = true;</span>
<span class="nc" id="L211">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L215" title="All 2 branches missed.">            while (!shouldStop) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                while (!packetQueue.isEmpty()) {</span>
<span class="nc" id="L217">                    ReceivedPacket rp = packetQueue.poll();</span>
<span class="nc" id="L218">                    synchronized (serverLock) {</span>
<span class="nc" id="L219">                        handle(rp.connId, rp.packet);</span>
<span class="nc" id="L220">                    }</span>
<span class="nc" id="L221">                }</span>
                try {
<span class="nc" id="L223">                    synchronized (packetQueue) {</span>
<span class="nc" id="L224">                        packetQueue.wait();</span>
<span class="nc" id="L225">                    }</span>
<span class="nc" id="L226">                } catch (InterruptedException e) {</span>
                    // If we are interrupted, just keep going, generally
                    // this happens after we are signalled to stop.
<span class="nc" id="L229">                }</span>
            }
<span class="nc" id="L231">        }</span>

    }

    // game info
<span class="nc" id="L236">    private Vector&lt;IConnection&gt; connections = new Vector&lt;&gt;(4);</span>

<span class="nc" id="L238">    private Hashtable&lt;Integer, ConnectionHandler&gt; connectionHandlers = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L240">    private final ConcurrentLinkedQueue&lt;ReceivedPacket&gt; packetQueue = new ConcurrentLinkedQueue&lt;&gt;();</span>

    /**
     * Special packet queue for client feedback requests.
     */
<span class="nc" id="L245">    private final ConcurrentLinkedQueue&lt;ReceivedPacket&gt; cfrPacketQueue = new ConcurrentLinkedQueue&lt;&gt;();</span>

<span class="nc" id="L247">    private Vector&lt;IConnection&gt; connectionsPending = new Vector&lt;&gt;(4);</span>

<span class="nc" id="L249">    private Hashtable&lt;Integer, IConnection&gt; connectionIds = new Hashtable&lt;&gt;();</span>

    private int connectionCounter;

<span class="nc" id="L253">    private IGame game = new Game();</span>

<span class="nc" id="L255">    private Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>

    public Vector&lt;Report&gt; getvPhaseReport() {
<span class="nc" id="L258">        return vPhaseReport;</span>
    }

<span class="nc" id="L261">    private MapSettings mapSettings = MapSettings.getInstance();</span>

    // commands
<span class="nc" id="L264">    private Hashtable&lt;String, ServerCommand&gt; commandsHash = new Hashtable&lt;&gt;();</span>

    // listens for and connects players
    private Thread connector;

    private PacketPump packetPump;
    private Thread packetPumpThread;

    // Track buildings that are affected by an entity's movement.
<span class="nc" id="L273">    private Hashtable&lt;Building, Boolean&gt; affectedBldgs = new Hashtable&lt;&gt;();</span>

    // Track Physical Action results, HACK to deal with opposing pushes
    // canceling each other
<span class="nc" id="L277">    private Vector&lt;PhysicalResult&gt; physicalResults = new Vector&lt;&gt;();</span>

<span class="nc" id="L279">    private Vector&lt;DynamicTerrainProcessor&gt; terrainProcessors = new Vector&lt;&gt;();</span>

<span class="nc" id="L281">    private Timer watchdogTimer = new Timer(&quot;Watchdog Timer&quot;);</span>

    private static EntityVerifier entityVerifier;

<span class="nc" id="L285">    private ArrayList&lt;int[]&gt; scheduledNukes = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L287">    private static Server serverInstance = null;</span>

<span class="nc" id="L289">    private String serverAccessKey = null;</span>

<span class="nc" id="L291">    private Timer serverBrowserUpdateTimer = null;</span>

    /**
     * Keeps track of what team a player requested to join.
     */
<span class="nc" id="L296">    private int requestedTeam = IPlayer.TEAM_NONE;</span>

    /**
     * Keeps track of what player made a request to change teams.
     */
<span class="nc" id="L301">    private IPlayer playerChangingTeam = null;</span>

    /**
     * Flag that is set to true when all players have voted to allow another
     * player to change teams.
     */
<span class="nc" id="L307">    private boolean changePlayersTeam = false;</span>

    /**
     * Stores a set of &lt;code&gt;Coords&lt;/code&gt; that have changed during this phase.
     */
<span class="nc" id="L312">    private Set&lt;Coords&gt; hexUpdateSet = new LinkedHashSet&lt;&gt;();</span>

<span class="nc" id="L314">    private List&lt;DemolitionCharge&gt; explodingCharges = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L316">    private ConnectionListenerAdapter connectionListener = new ConnectionListenerAdapter() {</span>

        /**
         * Called when it is sensed that a connection has terminated.
         */
        @Override
        public void disconnected(DisconnectedEvent e) {
<span class="nc" id="L323">            synchronized (serverLock) {</span>
<span class="nc" id="L324">                IConnection conn = e.getConnection();</span>

                // write something in the log
<span class="nc" id="L327">                MegaMek.getLogger().info(&quot;s: connection &quot; + conn.getId() + &quot; disconnected&quot;);</span>

<span class="nc" id="L329">                connections.removeElement(conn);</span>
<span class="nc" id="L330">                connectionsPending.removeElement(conn);</span>
<span class="nc" id="L331">                connectionIds.remove(conn.getId());</span>
<span class="nc" id="L332">                ConnectionHandler ch = connectionHandlers.get(conn.getId());</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if (ch != null) {</span>
<span class="nc" id="L334">                    ch.signalStop();</span>
<span class="nc" id="L335">                    connectionHandlers.remove(conn.getId());</span>
                }

                // if there's a player for this connection, remove it too
<span class="nc" id="L339">                IPlayer player = getPlayer(conn.getId());</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                if (null != player) {</span>
<span class="nc" id="L341">                    Server.this.disconnected(player);</span>
                }
<span class="nc" id="L343">            }</span>
<span class="nc" id="L344">        }</span>

        @Override
        public void packetReceived(PacketReceivedEvent e) {
<span class="nc" id="L348">            ReceivedPacket rp = new ReceivedPacket(e.getConnection().getId(),</span>
<span class="nc" id="L349">                    e.getPacket());</span>
<span class="nc" id="L350">            int cmd = e.getPacket().getCommand();</span>
            // Handled CFR packets specially
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (cmd == Packet.COMMAND_CLIENT_FEEDBACK_REQUEST) {</span>
<span class="nc" id="L353">                synchronized (cfrPacketQueue) {</span>
<span class="nc" id="L354">                    cfrPacketQueue.add(rp);</span>
<span class="nc" id="L355">                    cfrPacketQueue.notifyAll();</span>
<span class="nc" id="L356">                }</span>
            // Some packets should be handled immediately
<span class="nc bnc" id="L358" title="All 8 branches missed.">            } else if ((cmd == Packet.COMMAND_CLOSE_CONNECTION)</span>
                    || (cmd == Packet.COMMAND_CLIENT_NAME)
                    || (cmd == Packet.COMMAND_CLIENT_VERSIONS)
                    || (cmd == Packet.COMMAND_CHAT)) {
<span class="nc" id="L362">                handle(rp.connId, rp.packet);</span>
            } else {
<span class="nc" id="L364">                synchronized (packetQueue) {</span>
<span class="nc" id="L365">                    packetQueue.add(rp);</span>
<span class="nc" id="L366">                    packetQueue.notifyAll();</span>
<span class="nc" id="L367">                }</span>
            }
<span class="nc" id="L369">        }</span>

    };

    /**
     * Used to ensure only one thread at a time is accessing this particular
     * instance of the server.
     */
<span class="nc" id="L377">    private final Object serverLock = new Object();</span>

    public Server(String password, int port) throws IOException {
<span class="nc" id="L380">        this(password, port, false, &quot;&quot;);</span>
<span class="nc" id="L381">    }</span>

    /**
     * Construct a new GameHost and begin listening for incoming clients.
     *
     * @param password                  the &lt;code&gt;String&lt;/code&gt; that is set as a password
     * @param port                      the &lt;code&gt;int&lt;/code&gt; value that specifies the port that is
     *                                  used
     * @param registerWithServerBrowser a &lt;code&gt;boolean&lt;/code&gt; indicating whether we should register
     *                                  with the master server browser on megamek.info
     */
    public Server(String password, int port, boolean registerWithServerBrowser,
<span class="nc" id="L393">                  String metaServerUrl) throws IOException {</span>
<span class="nc" id="L394">        this.metaServerUrl = metaServerUrl;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        this.password = password.length() &gt; 0 ? password : null;</span>
        // initialize server socket
<span class="nc" id="L397">        serverSocket = new ServerSocket(port);</span>

<span class="nc" id="L399">        motd = createMotd();</span>

<span class="nc" id="L401">        game.getOptions().initialize();</span>
<span class="nc" id="L402">        game.getOptions().loadOptions();</span>

<span class="nc" id="L404">        changePhase(IGame.Phase.PHASE_LOUNGE);</span>

        // display server start text
<span class="nc" id="L407">        MegaMek.getLogger().info(&quot;s: starting a new server...&quot;);</span>

        try {
<span class="nc" id="L410">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L411">            String host = InetAddress.getLocalHost().getHostName();</span>
<span class="nc" id="L412">            sb.append(&quot;s: hostname = '&quot;);</span>
<span class="nc" id="L413">            sb.append(host);</span>
<span class="nc" id="L414">            sb.append(&quot;' port = &quot;);</span>
<span class="nc" id="L415">            sb.append(serverSocket.getLocalPort());</span>
<span class="nc" id="L416">            sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L417">            InetAddress[] addresses = InetAddress.getAllByName(host);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">            for (InetAddress address : addresses) {</span>
<span class="nc" id="L419">                sb.append(&quot;s: hosting on address = &quot;);</span>
<span class="nc" id="L420">                sb.append(address.getHostAddress());</span>
<span class="nc" id="L421">                sb.append(&quot;\n&quot;);</span>
            }

<span class="nc" id="L424">            MegaMek.getLogger().info(sb.toString());</span>
<span class="nc" id="L425">        } catch (UnknownHostException ignored) {</span>
            // oh well.
<span class="nc" id="L427">        }</span>

<span class="nc" id="L429">        MegaMek.getLogger().info(&quot;s: password = &quot; + this.password);</span>

        // register commands
<span class="nc" id="L432">        registerCommand(new DefeatCommand(this));</span>
<span class="nc" id="L433">        registerCommand(new ExportListCommand(this));</span>
<span class="nc" id="L434">        registerCommand(new FixElevationCommand(this));</span>
<span class="nc" id="L435">        registerCommand(new HelpCommand(this));</span>
<span class="nc" id="L436">        registerCommand(new KickCommand(this));</span>
<span class="nc" id="L437">        registerCommand(new ListSavesCommand(this));</span>
<span class="nc" id="L438">        registerCommand(new LocalSaveGameCommand(this));</span>
<span class="nc" id="L439">        registerCommand(new LocalLoadGameCommand(this));</span>
<span class="nc" id="L440">        registerCommand(new ResetCommand(this));</span>
<span class="nc" id="L441">        registerCommand(new RollCommand(this));</span>
<span class="nc" id="L442">        registerCommand(new SaveGameCommand(this));</span>
<span class="nc" id="L443">        registerCommand(new LoadGameCommand(this));</span>
<span class="nc" id="L444">        registerCommand(new SeeAllCommand(this));</span>
<span class="nc" id="L445">        registerCommand(new SkipCommand(this));</span>
<span class="nc" id="L446">        registerCommand(new VictoryCommand(this));</span>
<span class="nc" id="L447">        registerCommand(new WhoCommand(this));</span>
<span class="nc" id="L448">        registerCommand(new TeamCommand(this));</span>
<span class="nc" id="L449">        registerCommand(new ShowTileCommand(this));</span>
<span class="nc" id="L450">        registerCommand(new ShowEntityCommand(this));</span>
<span class="nc" id="L451">        registerCommand(new RulerCommand(this));</span>
<span class="nc" id="L452">        registerCommand(new ShowValidTargetsCommand(this));</span>
<span class="nc" id="L453">        registerCommand(new AddBotCommand(this));</span>
<span class="nc" id="L454">        registerCommand(new CheckBVCommand(this));</span>
<span class="nc" id="L455">        registerCommand(new CheckBVTeamCommand(this));</span>
<span class="nc" id="L456">        registerCommand(new NukeCommand(this));</span>
<span class="nc" id="L457">        registerCommand(new TraitorCommand(this));</span>
<span class="nc" id="L458">        registerCommand(new ListEntitiesCommand(this));</span>
<span class="nc" id="L459">        registerCommand(new AssignNovaNetServerCommand(this));</span>
<span class="nc" id="L460">        registerCommand(new AllowTeamChangeCommand(this));</span>
<span class="nc" id="L461">        registerCommand(new JoinTeamCommand(this));</span>

        // register terrain processors
<span class="nc" id="L464">        terrainProcessors.add(new FireProcessor(this));</span>
<span class="nc" id="L465">        terrainProcessors.add(new SmokeProcessor(this));</span>
<span class="nc" id="L466">        terrainProcessors.add(new GeyserProcessor(this));</span>
<span class="nc" id="L467">        terrainProcessors.add(new ElevatorProcessor(this));</span>
<span class="nc" id="L468">        terrainProcessors.add(new ScreenProcessor(this));</span>
<span class="nc" id="L469">        terrainProcessors.add(new WeatherProcessor(this));</span>
<span class="nc" id="L470">        terrainProcessors.add(new QuicksandProcessor(this));</span>

<span class="nc" id="L472">        packetPump = new PacketPump();</span>
<span class="nc" id="L473">        packetPumpThread = new Thread(packetPump, &quot;Packet Pump&quot;);</span>
<span class="nc" id="L474">        packetPumpThread.start();</span>

<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (registerWithServerBrowser) {</span>

<span class="nc" id="L478">            final TimerTask register = new TimerTask() {</span>
                @Override
                public void run() {
<span class="nc" id="L481">                    registerWithServerBrowser(true,</span>
<span class="nc" id="L482">                                              Server.getServerInstance().metaServerUrl);</span>
<span class="nc" id="L483">                }</span>
            };
<span class="nc" id="L485">            serverBrowserUpdateTimer = new Timer(</span>
                    &quot;Server Browser Register Timer&quot;, true);
<span class="nc" id="L487">            serverBrowserUpdateTimer.schedule(register, 1, 40000);</span>
        }

        // Fully initialised, now accept connections
<span class="nc" id="L491">        connector = new Thread(this, &quot;Connection Listener&quot;);</span>
<span class="nc" id="L492">        connector.start();</span>

<span class="nc" id="L494">        serverInstance = this;</span>
<span class="nc" id="L495">    }</span>

    /**
     * Sets the game for this server. Restores any transient fields, and sets
     * all players as ghosts. This should only be called during server
     * initialization before any players have connected.
     */
    public void setGame(IGame g) {
        // game listeners are transient so we need to save and restore them
<span class="nc" id="L504">        Vector&lt;GameListener&gt; gameListenersClone = new Vector&lt;&gt;(getGame().getGameListeners());</span>

<span class="nc" id="L506">        game = g;</span>

<span class="nc bnc" id="L508" title="All 2 branches missed.">        for (GameListener listener : gameListenersClone) {</span>
<span class="nc" id="L509">            getGame().addGameListener(listener);</span>
<span class="nc" id="L510">        }</span>

<span class="nc" id="L512">        List&lt;Integer&gt; orphanEntities = new ArrayList&lt;&gt;();</span>
                
        // reattach the transient fields and ghost the players
<span class="nc bnc" id="L515" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L516">            Entity ent = e.next();</span>
<span class="nc" id="L517">            ent.setGame(game);</span>
            
<span class="nc bnc" id="L519" title="All 2 branches missed.">            if(ent.getOwner() == null) {</span>
<span class="nc" id="L520">                orphanEntities.add(ent.getId());</span>
<span class="nc" id="L521">                continue;</span>
            }
            
<span class="nc bnc" id="L524" title="All 2 branches missed.">            if (ent instanceof Mech) {</span>
<span class="nc" id="L525">                ((Mech) ent).setBAGrabBars();</span>
<span class="nc" id="L526">                ((Mech) ent).setProtomechClampMounts();</span>
            }
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (ent instanceof Tank) {</span>
<span class="nc" id="L529">                ((Tank) ent).setBAGrabBars();</span>
            }
<span class="nc" id="L531">        }</span>
        
<span class="nc" id="L533">        game.removeEntities(orphanEntities, IEntityRemovalConditions.REMOVE_UNKNOWN);</span>
        
<span class="nc" id="L535">        game.setOutOfGameEntitiesVector(game.getOutOfGameEntitiesVector());</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; e = game.getPlayers(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L537">            IPlayer p = e.nextElement();</span>
<span class="nc" id="L538">            p.setGame(game);</span>
<span class="nc" id="L539">            p.setGhost(true);</span>
<span class="nc" id="L540">        }</span>
        // might need to restore weapon type for some attacks that take multiple
        // turns (like artillery)
<span class="nc" id="L543">        for (Enumeration&lt;AttackHandler&gt; a = game.getAttacks(); a</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L545">            AttackHandler handler = a.nextElement();</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">            if (handler instanceof WeaponHandler) {</span>
<span class="nc" id="L547">                ((WeaponHandler) handler).restore();</span>
            }
<span class="nc" id="L549">        }</span>

<span class="nc" id="L551">    }</span>

    /**
     * Returns the current game object
     */
    public IGame getGame() {
<span class="nc" id="L557">        return game;</span>
    }

    /**
     * Make a default message o' the day containing the version string, and if
     * it was found, the build timestamp
     */
    private String createMotd() {
<span class="nc" id="L565">        StringBuilder motd = new StringBuilder();</span>
<span class="nc" id="L566">        motd.append(&quot;Welcome to MegaMek.  Server is running version &quot;).append(MegaMek.VERSION)</span>
<span class="nc" id="L567">                .append(&quot;, build date &quot;);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (MegaMek.TIMESTAMP &gt; 0L) {</span>
<span class="nc" id="L569">            motd.append(new Date(MegaMek.TIMESTAMP).toString());</span>
        } else {
<span class="nc" id="L571">            motd.append(&quot;unknown&quot;);</span>
        }
<span class="nc" id="L573">        motd.append('.');</span>

<span class="nc" id="L575">        return motd.toString();</span>
    }

    /**
     * @return true if the server has a password
     */
    public boolean isPassworded() {
<span class="nc bnc" id="L582" title="All 2 branches missed.">        return password != null;</span>
    }

    /**
     * @return true if the password matches
     */
    public boolean isPassword(Object guess) {
<span class="nc" id="L589">        return password.equals(guess);</span>
    }

    /**
     * Registers a new command in the server command table
     */
    private void registerCommand(ServerCommand command) {
<span class="nc" id="L596">        commandsHash.put(command.getName(), command);</span>
<span class="nc" id="L597">    }</span>

    /**
     * Returns the command associated with the specified name
     */
    public ServerCommand getCommand(String name) {
<span class="nc" id="L603">        return commandsHash.get(name);</span>
    }

    /**
     * Shuts down the server.
     */
    public void die() {
<span class="nc" id="L610">        watchdogTimer.cancel();</span>

        // kill thread accepting new connections
<span class="nc" id="L613">        connector = null;</span>
<span class="nc" id="L614">        packetPump.signalEnd();</span>
<span class="nc" id="L615">        packetPumpThread.interrupt();</span>
<span class="nc" id="L616">        packetPumpThread = null;</span>

        // close socket
        try {
<span class="nc" id="L620">            serverSocket.close();</span>
<span class="nc" id="L621">        } catch (IOException ignored) {</span>
<span class="nc" id="L622">        }</span>

        // kill pending connections
<span class="nc" id="L625">        for (Enumeration&lt;IConnection&gt; connEnum = connectionsPending.elements(); connEnum</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L627">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L628">            conn.close();</span>
<span class="nc" id="L629">        }</span>
<span class="nc" id="L630">        connectionsPending.removeAllElements();</span>

        // Send &quot;kill&quot; commands to all connections
        // N.B. I may be starting a race here.
<span class="nc bnc" id="L634" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L635">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L636">            send(conn.getId(), new Packet(Packet.COMMAND_CLOSE_CONNECTION));</span>
<span class="nc" id="L637">        }</span>

        // kill active connections
<span class="nc bnc" id="L640" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L641">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L642">            conn.close();</span>
<span class="nc" id="L643">        }</span>

<span class="nc" id="L645">        connections.removeAllElements();</span>
<span class="nc" id="L646">        connectionIds.clear();</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (serverBrowserUpdateTimer != null) {</span>
<span class="nc" id="L648">            serverBrowserUpdateTimer.cancel();</span>
        }
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (!metaServerUrl.equals(&quot;&quot;)) {</span>
<span class="nc" id="L651">            registerWithServerBrowser(false, metaServerUrl);</span>
        }

        // TODO : Not sure that this still needs to be here after updating to the new logging methods.
<span class="nc" id="L655">        System.out.flush();</span>
<span class="nc" id="L656">    }</span>

    /**
     * Returns an enumeration of all the command names
     */
    public Enumeration&lt;String&gt; getAllCommandNames() {
<span class="nc" id="L662">        return commandsHash.keys();</span>
    }

    /**
     * Sent when a client attempts to connect.
     */
    void greeting(int cn) {
        // send server greeting -- client should reply with client info.
<span class="nc" id="L670">        sendToPending(cn, new Packet(Packet.COMMAND_SERVER_GREETING));</span>
<span class="nc" id="L671">    }</span>

    /**
     * Returns a free connection id.
     */
    public int getFreeConnectionId() {
<span class="nc bnc" id="L677" title="All 2 branches missed.">        while ((getPendingConnection(connectionCounter) != null)</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">               || (getConnection(connectionCounter) != null)</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">               || (getPlayer(connectionCounter) != null)) {</span>
<span class="nc" id="L680">            connectionCounter++;</span>
        }
<span class="nc" id="L682">        return connectionCounter;</span>
    }

    /**
     * Returns a free entity id. Perhaps this should be in Game instead.
     */
    public int getFreeEntityId() {
<span class="nc" id="L689">        return game.getNextEntityId();</span>
    }

    /**
     * Allow the player to set whatever parameters he is able to
     */
    private void receivePlayerInfo(Packet packet, int connId) {
<span class="nc" id="L696">        IPlayer player = (IPlayer) packet.getObject(0);</span>
<span class="nc" id="L697">        IPlayer gamePlayer = game.getPlayer(connId);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">        if (null != gamePlayer) {</span>
<span class="nc" id="L699">            gamePlayer.setColour(player.getColour());</span>
<span class="nc" id="L700">            gamePlayer.setStartingPos(player.getStartingPos());</span>
<span class="nc" id="L701">            gamePlayer.setTeam(player.getTeam());</span>
<span class="nc" id="L702">            gamePlayer.setCamouflage(player.getCamouflage().clone());</span>
<span class="nc" id="L703">            gamePlayer.setNbrMFConventional(player.getNbrMFConventional());</span>
<span class="nc" id="L704">            gamePlayer.setNbrMFCommand(player.getNbrMFCommand());</span>
<span class="nc" id="L705">            gamePlayer.setNbrMFVibra(player.getNbrMFVibra());</span>
<span class="nc" id="L706">            gamePlayer.setNbrMFActive(player.getNbrMFActive());</span>
<span class="nc" id="L707">            gamePlayer.setNbrMFInferno(player.getNbrMFInferno());</span>
<span class="nc" id="L708">            if (gamePlayer.getConstantInitBonus()</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                != player.getConstantInitBonus()) {</span>
<span class="nc" id="L710">                sendServerChat(&quot;Player &quot; + gamePlayer.getName()</span>
                               + &quot; changed their initiative bonus from &quot;
<span class="nc" id="L712">                               + gamePlayer.getConstantInitBonus()</span>
<span class="nc" id="L713">                               + &quot; to &quot; + player.getConstantInitBonus() + &quot;.&quot;);</span>
            }
<span class="nc" id="L715">            gamePlayer.setConstantInitBonus(player.getConstantInitBonus());</span>
        }
<span class="nc" id="L717">    }</span>

    /**
     * Correct a duplicate player name
     *
     * @param oldName the &lt;code&gt;String&lt;/code&gt; old player name, that is a duplicate
     * @return the &lt;code&gt;String&lt;/code&gt; new player name
     */
    private String correctDupeName(String oldName) {
<span class="nc bnc" id="L726" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L727">            IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            if (player.getName().equals(oldName)) {</span>
                // We need to correct it.
<span class="nc" id="L730">                String newName = oldName;</span>
                int dupNum;
                try {
<span class="nc" id="L733">                    dupNum = Integer.parseInt(oldName.substring(oldName.lastIndexOf(&quot;.&quot;) + 1));</span>
<span class="nc" id="L734">                    dupNum++;</span>
<span class="nc" id="L735">                    newName = oldName.substring(0, oldName.lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L736">                } catch (Exception e) {</span>
                    // If this fails, we don't care much.
                    // Just assume it's the first time for this name.
<span class="nc" id="L739">                    dupNum = 2;</span>
<span class="nc" id="L740">                }</span>
<span class="nc" id="L741">                newName = newName.concat(&quot;.&quot;).concat(Integer.toString(dupNum));</span>
<span class="nc" id="L742">                return correctDupeName(newName);</span>
            }
<span class="nc" id="L744">        }</span>
<span class="nc" id="L745">        return oldName;</span>
    }

    private void receivePlayerVersion(Packet packet, int connId) {
<span class="nc" id="L749">        String version = (String) packet.getObject(0);</span>
<span class="nc" id="L750">        String clientChecksum = (String) packet.getObject(1);</span>
<span class="nc" id="L751">        String serverChecksum = MegaMek.getMegaMekSHA256();</span>
<span class="nc" id="L752">        StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L753">        boolean needs = false;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">        if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L755">            buf.append(&quot;Client/Server version mismatch. Server reports: &quot;).append(MegaMek.VERSION)</span>
<span class="nc" id="L756">                    .append(&quot;, Client reports: &quot;).append(version);</span>
<span class="nc" id="L757">            MegaMek.getLogger().error(&quot;Client/Server Version Mismatch -- Client: &quot; </span>
                    + version + &quot; Server: &quot; + MegaMek.VERSION);
<span class="nc" id="L759">            needs = true;</span>
        }
        // print a message indicating client doesn't have jar file
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (clientChecksum == null) {</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L764">                buf.append(System.lineSeparator()).append(System.lineSeparator());</span>
            }
<span class="nc" id="L766">            buf.append(&quot;Client Checksum is null. Client may not have a jar file&quot;);</span>
<span class="nc" id="L767">            MegaMek.getLogger().info(&quot;Client does not have a jar file&quot;);</span>
<span class="nc" id="L768">            needs = true;</span>
        // print message indicating server doesn't have jar file
<span class="nc bnc" id="L770" title="All 2 branches missed.">        } else if (serverChecksum == null) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L772">                buf.append(System.lineSeparator()).append(System.lineSeparator());</span>
            }
<span class="nc" id="L774">            buf.append(&quot;Server Checksum is null. Server may not have a jar file&quot;);</span>
<span class="nc" id="L775">            MegaMek.getLogger().info(&quot;Server does not have a jar file&quot;);</span>
<span class="nc" id="L776">            needs = true;</span>
        // print message indicating a client/server checksum mismatch
<span class="nc bnc" id="L778" title="All 2 branches missed.">        } else if (!clientChecksum.equals(serverChecksum)) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L780">                buf.append(System.lineSeparator());</span>
<span class="nc" id="L781">                buf.append(System.lineSeparator());</span>
            }
<span class="nc" id="L783">            buf.append(&quot;Client/Server checksum mismatch. Server reports: &quot;).append(serverChecksum)</span>
<span class="nc" id="L784">                    .append(&quot;, Client reports: &quot;).append(clientChecksum);</span>
<span class="nc" id="L785">            MegaMek.getLogger().error(&quot;Client/Server Checksum Mismatch -- Client: &quot; + clientChecksum </span>
                    + &quot; Server: &quot; + serverChecksum);

<span class="nc" id="L788">            needs = true;</span>
        }

        // Now, if we need to, send message!
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if (needs) {</span>
<span class="nc" id="L793">            IPlayer player = getPlayer(connId);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (null != player) {</span>
<span class="nc" id="L795">                sendServerChat(&quot;For &quot; + player.getName() + &quot; Server reports:&quot;</span>
<span class="nc" id="L796">                        + System.lineSeparator()</span>
<span class="nc" id="L797">                        + buf.toString());</span>
            }
<span class="nc" id="L799">        } else {</span>
<span class="nc" id="L800">            MegaMek.getLogger().info(&quot;SUCCESS: Client/Server Version (&quot; + version + &quot;) and Checksum (&quot; </span>
                    + clientChecksum + &quot;) matched&quot;);
        }
<span class="nc" id="L803">    }</span>

    /**
     * Receives a player name, sent from a pending connection, and connects that
     * connection.
     */
    private void receivePlayerName(Packet packet, int connId) {
<span class="nc" id="L810">        final IConnection conn = getPendingConnection(connId);</span>
<span class="nc" id="L811">        String name = (String) packet.getObject(0);</span>
<span class="nc" id="L812">        boolean returning = false;</span>

        // this had better be from a pending connection
<span class="nc bnc" id="L815" title="All 2 branches missed.">        if (conn == null) {</span>
<span class="nc" id="L816">            MegaMek.getLogger().warning(&quot;Got a client name from a non-pending connection&quot;);</span>
<span class="nc" id="L817">            return;</span>
        }

        // check if they're connecting with the same name as a ghost player
<span class="nc bnc" id="L821" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L822">            IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">            if (player.getName().equals(name)) {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                if (player.isGhost()) {</span>
<span class="nc" id="L825">                    returning = true;</span>
<span class="nc" id="L826">                    player.setGhost(false);</span>
                    // switch id
<span class="nc" id="L828">                    connId = player.getId();</span>
<span class="nc" id="L829">                    conn.setId(connId);</span>
                }
            }
<span class="nc" id="L832">        }</span>

<span class="nc bnc" id="L834" title="All 2 branches missed.">        if (!returning) {</span>
            // Check to avoid duplicate names...
<span class="nc" id="L836">            name = correctDupeName(name);</span>
<span class="nc" id="L837">            sendToPending(connId, new Packet(Packet.COMMAND_SERVER_CORRECT_NAME, name));</span>
        }

        // right, switch the connection into the &quot;active&quot; bin
<span class="nc" id="L841">        connectionsPending.removeElement(conn);</span>
<span class="nc" id="L842">        connections.addElement(conn);</span>
<span class="nc" id="L843">        connectionIds.put(conn.getId(), conn);</span>

        // add and validate the player info
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (!returning) {</span>
<span class="nc" id="L847">            addNewPlayer(connId, name);</span>
        }

        // if it is not the lounge phase, this player becomes an observer
<span class="nc" id="L851">        IPlayer player = getPlayer(connId);</span>
<span class="nc bnc" id="L852" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; (null != player)</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">            &amp;&amp; (game.getEntitiesOwnedBy(player) &lt; 1)) {</span>
<span class="nc" id="L854">            player.setObserver(true);</span>
        }

        // send the player the motd
<span class="nc" id="L858">        sendServerChat(connId, motd);</span>

        // send info that the player has connected
<span class="nc" id="L861">        send(createPlayerConnectPacket(connId));</span>

        // tell them their local playerId
<span class="nc" id="L864">        send(connId, new Packet(Packet.COMMAND_LOCAL_PN, connId));</span>

        // send current game info
<span class="nc" id="L867">        sendCurrentInfo(connId);</span>

<span class="nc" id="L869">        final boolean showIPAddressesInChat = PreferenceManager.getClientPreferences().getShowIPAddressesInChat();</span>

        try {
<span class="nc" id="L872">            InetAddress[] addresses = InetAddress.getAllByName(InetAddress</span>
<span class="nc" id="L873">                    .getLocalHost().getHostName());</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">            for (InetAddress address : addresses) {</span>
<span class="nc" id="L875">                MegaMek.getLogger().info(&quot;s: machine IP &quot; + address.getHostAddress());</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                if (showIPAddressesInChat) {</span>
<span class="nc" id="L877">                    sendServerChat(connId,</span>
<span class="nc" id="L878">                            &quot;Machine IP is &quot; + address.getHostAddress());</span>
                }
            }
<span class="nc" id="L881">        } catch (UnknownHostException e) {</span>
            // oh well.
<span class="nc" id="L883">        }</span>

<span class="nc" id="L885">        MegaMek.getLogger().info(&quot;s: listening on port &quot; + serverSocket.getLocalPort());</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">        if (showIPAddressesInChat) {</span>
            // Send the port we're listening on. Only useful for the player
            // on the server machine to check.
<span class="nc" id="L889">            sendServerChat(connId,</span>
<span class="nc" id="L890">                        &quot;Listening on port &quot; + serverSocket.getLocalPort());</span>
        }

        // Get the player *again*, because they may have disconnected.
<span class="nc" id="L894">        player = getPlayer(connId);</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L896">            String who = player.getName() + &quot; connected from &quot; + getClient(connId).getInetAddress();</span>
<span class="nc" id="L897">            MegaMek.getLogger().info(&quot;s: player #&quot; + connId + &quot;, &quot; + who);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">            if (showIPAddressesInChat) {</span>
<span class="nc" id="L899">                sendServerChat(who);</span>
            }

        } // Found the player

<span class="nc" id="L904">    }</span>

    /**
     * Sends a player the info they need to look at the current phase. This is
     * triggered when a player first connects to the server.
     */
    public void sendCurrentInfo(int connId) {
        // why are these two outside the player != null check below?
<span class="nc" id="L912">        transmitAllPlayerConnects(connId);</span>
<span class="nc" id="L913">        send(connId, createGameSettingsPacket());</span>
<span class="nc" id="L914">        send(connId, createPlanetaryConditionsPacket());</span>

<span class="nc" id="L916">        IPlayer player = game.getPlayer(connId);</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L918">            send(connId,</span>
                 new Packet(Packet.COMMAND_SENDING_MINEFIELDS, player
<span class="nc" id="L920">                         .getMinefields()));</span>

<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L923">                send(connId, createMapSettingsPacket());</span>
<span class="nc" id="L924">                send(createMapSizesPacket());</span>
                // Send Entities *after* the Lounge Phase Change
<span class="nc" id="L926">                send(connId,</span>
<span class="nc" id="L927">                        new Packet(Packet.COMMAND_PHASE_CHANGE, game.getPhase()));</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L929">                    send(connId, createFilteredFullEntitiesPacket(player));</span>
                } else {
<span class="nc" id="L931">                    send(connId, createFullEntitiesPacket());</span>
                }
            } else {
<span class="nc" id="L934">                send(connId, new Packet(Packet.COMMAND_ROUND_UPDATE, game.getRoundCount()));</span>
<span class="nc" id="L935">                send(connId, createBoardPacket());</span>
<span class="nc" id="L936">                send(connId, createAllReportsPacket(player));</span>

                // Send entities *before* other phase changes.
<span class="nc bnc" id="L939" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L940">                    send(connId, createFilteredFullEntitiesPacket(player));</span>
                } else {
<span class="nc" id="L942">                    send(connId, createFullEntitiesPacket());</span>
                }
<span class="nc bnc" id="L944" title="All 2 branches missed.">                player.setDone(game.getEntitiesOwnedBy(player) &lt;= 0);</span>
<span class="nc" id="L945">                send(connId, new Packet(Packet.COMMAND_PHASE_CHANGE, game.getPhase()));</span>
            }
<span class="nc bnc" id="L947" title="All 2 branches missed.">            if ((game.getPhase() == IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD)</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_PHYSICAL)) {</span>
                // can't go above, need board to have been sent
<span class="nc" id="L952">                send(connId, createAttackPacket(game.getActionsVector(), 0));</span>
<span class="nc" id="L953">                send(connId, createAttackPacket(game.getChargesVector(), 1));</span>
<span class="nc" id="L954">                send(connId, createAttackPacket(game.getRamsVector(), 1));</span>
<span class="nc" id="L955">                send(connId, createAttackPacket(game.getTeleMissileAttacksVector(), 1));</span>
            }
            
<span class="nc bnc" id="L958" title="All 4 branches missed.">            if (game.phaseHasTurns(game.getPhase()) &amp;&amp; game.hasMoreTurns()) {</span>
<span class="nc" id="L959">                send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L960">                send(connId, createTurnIndexPacket(connId));</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">            } else if (game.getPhase() != IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L962">                endCurrentPhase();</span>
            }

<span class="nc" id="L965">            send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L966">            send(connId, createFlarePacket());</span>
<span class="nc" id="L967">            send(connId, createSpecialHexDisplayPacket(connId));</span>

        } // Found the player.

<span class="nc" id="L971">    }</span>

    /**
     * Resend entities to the player called by SeeAll command
     */
    public void sendEntities(int connId) {
<span class="nc bnc" id="L977" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L978">            send(connId, createFilteredEntitiesPacket(getPlayer(connId), null));</span>
        } else {
<span class="nc" id="L980">            send(connId, createEntitiesPacket());</span>
        }
<span class="nc" id="L982">    }</span>

    /**
     * Adds a new player to the game
     */
    private IPlayer addNewPlayer(int connId, String name) {
<span class="nc" id="L988">        int team = IPlayer.TEAM_UNASSIGNED;</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">        if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L990">            team = IPlayer.TEAM_NONE;</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">            for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">                if (p.getTeam() &gt; team) {</span>
<span class="nc" id="L993">                    team = p.getTeam();</span>
                }
<span class="nc" id="L995">            }</span>
<span class="nc" id="L996">            team++;</span>
        }
<span class="nc" id="L998">        IPlayer newPlayer = new Player(connId, name);</span>
<span class="nc" id="L999">        PlayerColour colour = newPlayer.getColour();</span>
<span class="nc" id="L1000">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc" id="L1001">        final PlayerColour[] colours = PlayerColour.values();</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L1003">            final IPlayer p = players.nextElement();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            if (p.getId() == newPlayer.getId()) {</span>
<span class="nc" id="L1005">                continue;</span>
            }

<span class="nc bnc" id="L1008" title="All 4 branches missed.">            if ((p.getColour() == colour) &amp;&amp; (colours.length &gt; (colour.ordinal() + 1))) {</span>
<span class="nc" id="L1009">                colour = colours[colour.ordinal() + 1];</span>
            }
<span class="nc" id="L1011">        }</span>
<span class="nc" id="L1012">        newPlayer.setColour(colour);</span>
<span class="nc" id="L1013">        newPlayer.setCamouflage(new Camouflage(Camouflage.COLOUR_CAMOUFLAGE, colour.name()));</span>
<span class="nc" id="L1014">        newPlayer.setTeam(Math.min(team, 5));</span>
<span class="nc" id="L1015">        game.addPlayer(connId, newPlayer);</span>
<span class="nc" id="L1016">        validatePlayerInfo(connId);</span>
<span class="nc" id="L1017">        return newPlayer;</span>
    }

    /**
     * Validates the player info.
     */
    public void validatePlayerInfo(int playerId) {
<span class="nc" id="L1024">        final IPlayer player = getPlayer(playerId);</span>

<span class="nc bnc" id="L1026" title="All 2 branches missed.">        if (player != null) {</span>
            // TODO : check for duplicate or reserved names

            // Colour Assignment
<span class="nc" id="L1030">            final PlayerColour[] playerColours = PlayerColour.values();</span>
<span class="nc" id="L1031">            boolean allUsed = true;</span>
<span class="nc" id="L1032">            Set&lt;PlayerColour&gt; colourUtilization = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">            for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1034">                final IPlayer otherPlayer = i.nextElement();</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (otherPlayer.getId() != playerId) {</span>
<span class="nc" id="L1036">                    colourUtilization.add(otherPlayer.getColour());</span>
                } else {
<span class="nc" id="L1038">                    allUsed = false;</span>
                }
<span class="nc" id="L1040">            }</span>

<span class="nc bnc" id="L1042" title="All 4 branches missed.">            if (!allUsed &amp;&amp; colourUtilization.contains(player.getColour())) {</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                for (PlayerColour colour : playerColours) {</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">                    if (!colourUtilization.contains(colour)) {</span>
<span class="nc" id="L1045">                        player.setColour(colour);</span>
<span class="nc" id="L1046">                        break;</span>
                    }
                }
            }
        }
<span class="nc" id="L1051">    }</span>

    /**
     * Called when it's been determined that an actual player disconnected.
     * Notifies the other players and does the appropriate housekeeping.
     */
    void disconnected(IPlayer player) {
<span class="nc" id="L1058">        IGame.Phase phase = game.getPhase();</span>

        // in the lounge, just remove all entities for that player
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        if (phase == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1062">            removeAllEntitiesOwnedBy(player);</span>
        }

        // if a player has active entities, he becomes a ghost
        // except the VICTORY_PHASE when the disconnected
        // player is most likely the Bot disconnected after receiving
        // the COMMAND_END_OF_GAME command
        // see the Bug 1225949.
        // Ghost players (Bots mostly) are now removed during the
        // resetGame(), so we don't need to do it here.
        // This fixes Bug 3399000 without reintroducing 1225949
<span class="nc bnc" id="L1073" title="All 4 branches missed.">        if ((phase == IGame.Phase.PHASE_VICTORY)</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            || (phase == IGame.Phase.PHASE_LOUNGE) || player.isObserver()) {</span>
<span class="nc" id="L1075">            game.removePlayer(player.getId());</span>
<span class="nc" id="L1076">            send(new Packet(Packet.COMMAND_PLAYER_REMOVE, player.getId()));</span>
            // Prevent situation where all players but the disconnected one
            // are done, and the disconnecting player causes the game to start
<span class="nc bnc" id="L1079" title="All 2 branches missed.">            if (phase == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1080">                resetActivePlayersDone();</span>
            }
        } else {
<span class="nc" id="L1083">            player.setGhost(true);</span>
<span class="nc" id="L1084">            player.setDone(true);</span>
<span class="nc" id="L1085">            send(createPlayerUpdatePacket(player.getId()));</span>
        }

        // make sure the game advances
<span class="nc bnc" id="L1089" title="All 4 branches missed.">        if (game.phaseHasTurns(game.getPhase()) &amp;&amp; (null != game.getTurn())) {</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">            if (game.getTurn().isValid(player.getId(), game)) {</span>
<span class="nc" id="L1091">                sendGhostSkipMessage(player);</span>
            }
        } else {
<span class="nc" id="L1094">            checkReady();</span>
        }

        // notify other players
<span class="nc" id="L1098">        sendServerChat(player.getName() + &quot; disconnected.&quot;);</span>

        // log it
<span class="nc" id="L1101">        MegaMek.getLogger().info(&quot;s: removed player &quot; + player.getName());</span>

        // Reset the game after Elvis has left the building.
<span class="nc bnc" id="L1104" title="All 2 branches missed.">        if (0 == game.getNoOfPlayers()) {</span>
<span class="nc" id="L1105">            resetGame();</span>
        }
<span class="nc" id="L1107">    }</span>

    /**
     * Checks each player to see if he has no entities, and if true, sets the
     * observer flag for that player. An exception is that there are no
     * observers during the lounge phase.
     */
    public void checkForObservers() {
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; e = game.getPlayers(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1116">            IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            p.setObserver((game.getEntitiesOwnedBy(p) &lt; 1)</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">                          &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_LOUNGE));</span>
<span class="nc" id="L1119">        }</span>
<span class="nc" id="L1120">    }</span>

    /**
     * Reset the game back to the lounge.
     * TODO : couldn't this be a hazard if there are other things executing at the same time?
     */
    public void resetGame() {
        // remove all entities
<span class="nc" id="L1128">        game.reset();</span>
<span class="nc" id="L1129">        send(createEntitiesPacket());</span>
<span class="nc" id="L1130">        send(new Packet(Packet.COMMAND_SENDING_MINEFIELDS, new Vector&lt;&gt;()));</span>

        // remove ghosts
<span class="nc" id="L1133">        List&lt;IPlayer&gt; ghosts = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; players = game.getPlayers(); players.hasMoreElements(); ) {</span>
<span class="nc" id="L1135">            IPlayer p = players.nextElement();</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            if (p.isGhost()) {</span>
<span class="nc" id="L1137">                ghosts.add(p);</span>
            } else {
                // non-ghosts set their starting positions to any
<span class="nc" id="L1140">                p.setStartingPos(Board.START_ANY);</span>
<span class="nc" id="L1141">                send(createPlayerUpdatePacket(p.getId()));</span>
            }
<span class="nc" id="L1143">        }</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">        for (IPlayer p : ghosts) {</span>
<span class="nc" id="L1145">            game.removePlayer(p.getId());</span>
<span class="nc" id="L1146">            send(new Packet(Packet.COMMAND_PLAYER_REMOVE, p.getId()));</span>
<span class="nc" id="L1147">        }</span>

        // reset all players
<span class="nc" id="L1150">        resetPlayersDone();</span>
<span class="nc" id="L1151">        transmitAllPlayerDones();</span>

        // Write end of game to stdout so controlling scripts can rotate logs.
<span class="nc" id="L1154">        SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss z&quot;);</span>
<span class="nc" id="L1155">        MegaMek.getLogger().info(format.format(new Date()) + &quot; END OF GAME&quot;);</span>

<span class="nc" id="L1157">        changePhase(IGame.Phase.PHASE_LOUNGE);</span>
<span class="nc" id="L1158">    }</span>

    /**
     * automatically save the game
     */
    public void autoSave() {
<span class="nc" id="L1164">        String fileName = &quot;autosave&quot;;</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">        if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L1166">            fileName = StringUtil.addDateTimeStamp(fileName);</span>
        }
<span class="nc" id="L1168">        saveGame(fileName, game.getOptions().booleanOption(OptionsConstants.BASE_AUTOSAVE_MSG));</span>
<span class="nc" id="L1169">    }</span>

    /**
     * save the game and send it to the specified connection
     *
     * @param connId     The &lt;code&gt;int&lt;/code&gt; connection id to send to
     * @param sFile      The &lt;code&gt;String&lt;/code&gt; filename to use
     * @param sLocalPath The &lt;code&gt;String&lt;/code&gt; path to the file to be used on the
     *                   client
     */
    public void sendSaveGame(int connId, String sFile, String sLocalPath) {
<span class="nc" id="L1180">        saveGame(sFile, false);</span>
<span class="nc" id="L1181">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav.gz&quot;)) {</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">            if (sFinalFile.endsWith(&quot;.sav&quot;)) {</span>
<span class="nc" id="L1184">                sFinalFile = sFile + &quot;.gz&quot;;</span>
            } else {
<span class="nc" id="L1186">                sFinalFile = sFile + &quot;.sav.gz&quot;;</span>
            }
        }
<span class="nc" id="L1189">        sLocalPath = sLocalPath.replaceAll(&quot;\\|&quot;, &quot; &quot;);</span>
<span class="nc" id="L1190">        String localFile = &quot;savegames&quot; + File.separator + sFinalFile;</span>
<span class="nc" id="L1191">        try (InputStream in = new FileInputStream(localFile); InputStream bin = new BufferedInputStream(in)) {</span>
<span class="nc" id="L1192">            List&lt;Integer&gt; data = new ArrayList&lt;&gt;();</span>
            int input;
<span class="nc bnc" id="L1194" title="All 2 branches missed.">            while ((input = bin.read()) != -1) {</span>
<span class="nc" id="L1195">                data.add(input);</span>
            }
<span class="nc" id="L1197">            send(connId, new Packet(Packet.COMMAND_SEND_SAVEGAME, new Object[]{</span>
                    sFinalFile, data, sLocalPath}));
<span class="nc" id="L1199">            sendChat(connId, &quot;***Server&quot;, &quot;Save game has been sent to you.&quot;);</span>
<span class="nc" id="L1200">        } catch (Exception e) {</span>
<span class="nc" id="L1201">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + localFile, e);</span>
<span class="nc" id="L1202">        }</span>
<span class="nc" id="L1203">    }</span>

    /**
     * save the game
     *
     * @param sFile    The &lt;code&gt;String&lt;/code&gt; filename to use
     * @param sendChat A &lt;code&gt;boolean&lt;/code&gt; value whether or not to announce the
     *                 saving to the server chat.
     */
    public void saveGame(String sFile, boolean sendChat) {
        // We need to strip the .gz if it exists,
        // otherwise we'll double up on it.
<span class="nc bnc" id="L1215" title="All 2 branches missed.">        if (sFile.endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1216">            sFile = sFile.replace(&quot;.gz&quot;, &quot;&quot;);</span>
        }
<span class="nc" id="L1218">        XStream xstream = new XStream();</span>

        // This will make save games much smaller
        // by using a more efficient means of referencing
        // objects in the XML graph
<span class="nc" id="L1223">        xstream.setMode(XStream.ID_REFERENCES);</span>

<span class="nc" id="L1225">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav&quot;)) {</span>
<span class="nc" id="L1227">            sFinalFile = sFile + &quot;.sav&quot;;</span>
        }
<span class="nc" id="L1229">        File sDir = new File(&quot;savegames&quot;);</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">        if (!sDir.exists()) {</span>
<span class="nc" id="L1231">            sDir.mkdir();</span>
        }

<span class="nc" id="L1234">        sFinalFile = sDir + File.separator + sFinalFile;</span>

<span class="nc" id="L1236">        try (OutputStream os = new FileOutputStream(sFinalFile + &quot;.gz&quot;);</span>
<span class="nc" id="L1237">             OutputStream gzo = new GZIPOutputStream(os);</span>
<span class="nc" id="L1238">             Writer writer = new OutputStreamWriter(gzo, StandardCharsets.UTF_8)) {</span>

<span class="nc" id="L1240">            xstream.toXML(game, writer);</span>
<span class="nc" id="L1241">        } catch (Exception e) {</span>
<span class="nc" id="L1242">            MegaMek.getLogger().error(&quot;Unable to save file: &quot; + sFinalFile, e);</span>
<span class="nc" id="L1243">        }</span>

<span class="nc bnc" id="L1245" title="All 2 branches missed.">        if (sendChat) {</span>
<span class="nc" id="L1246">            sendChat(&quot;MegaMek&quot;, &quot;Game saved to &quot; + sFinalFile);</span>
        }
<span class="nc" id="L1248">    }</span>

    /**
     * save the game
     *
     * @param sFile The &lt;code&gt;String&lt;/code&gt; filename to use
     */
    public void saveGame(String sFile) {
<span class="nc" id="L1256">        saveGame(sFile, true);</span>
<span class="nc" id="L1257">    }</span>

    /**
     * send a packet to the connection tells it load a locally saved game
     *
     * @param connId The &lt;code&gt;int&lt;/code&gt; connection id to send to
     * @param sFile  The &lt;code&gt;String&lt;/code&gt; filename to use
     */
    public void sendLoadGame(int connId, String sFile) {
<span class="nc" id="L1266">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1267" title="All 4 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav&quot;) &amp;&amp; !sFinalFile.endsWith(&quot;.sav.gz&quot;)) {</span>
<span class="nc" id="L1268">            sFinalFile = sFile + &quot;.sav&quot;;</span>
        }
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1271">            sFinalFile = sFinalFile + &quot;.gz&quot;;</span>
        }
<span class="nc" id="L1273">        send(connId, new Packet(Packet.COMMAND_LOAD_SAVEGAME, new Object[]{sFinalFile}));</span>
<span class="nc" id="L1274">    }</span>

    /**
     * load the game
     *
     * @param f The &lt;code&gt;File&lt;/code&gt; to load
     * @return A &lt;code&gt;boolean&lt;/code&gt; value whether or not the loading was successful
     */
    public boolean loadGame(File f) {
<span class="nc" id="L1283">        return loadGame(f, true);</span>
    }

    /**
     * load the game
     *
     * @param f
     *            The &lt;code&gt;File&lt;/code&gt; to load
     * @param sendInfo
     *            Determines whether the connections should be updated with
     *            current info. This may be false if some reconnection remapping
     *            needs to be done first.
     * @return A &lt;code&gt;boolean&lt;/code&gt; value whether or not the loading was successful
     */
    public boolean loadGame(File f, boolean sendInfo) {
<span class="nc" id="L1298">        MegaMek.getLogger().info(&quot;s: loading saved game file '&quot; + f + &quot;'&quot;);</span>

        IGame newGame;
<span class="nc" id="L1301">        try (InputStream is = new FileInputStream(f); InputStream gzi = new GZIPInputStream(is)) {</span>
<span class="nc" id="L1302">            XStream xstream = SerializationHelper.getXStream();</span>
<span class="nc" id="L1303">            newGame = (IGame) xstream.fromXML(gzi);</span>
<span class="nc" id="L1304">        } catch (Exception e) {</span>
<span class="nc" id="L1305">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + f, e);</span>
<span class="nc" id="L1306">            return false;</span>
<span class="nc" id="L1307">        }</span>

<span class="nc" id="L1309">        setGame(newGame);</span>

<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (!sendInfo) {</span>
<span class="nc" id="L1312">            return true;</span>
        }

        // update all the clients with the new game info
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        for (IConnection conn : connections) {</span>
<span class="nc" id="L1317">            sendCurrentInfo(conn.getId());</span>
<span class="nc" id="L1318">        }</span>
<span class="nc" id="L1319">        return true;</span>
    }

    /**
     * When the load command is used, there is a list of already connected
     * players which have assigned names and player id numbers with the id
     * numbers matching the connection numbers. When a new game is loaded, this
     * mapping may need to be updated. This method takes a map of player names
     * to their current ids, and uses the list of players to figure out what the
     * current ids should change to.
     *
     * @param nameToIdMap
     *            This maps a player name to the current connection ID
     * @param idToNameMap
     *            This maps a current conn ID to a player name, and is just the
     *            inverse mapping from nameToIdMap
     */
    public void remapConnIds(Map&lt;String, Integer&gt; nameToIdMap, Map&lt;Integer, String&gt; idToNameMap) {
        // Keeps track of connections without Ids
<span class="nc" id="L1338">        List&lt;IConnection&gt; unassignedConns = new ArrayList&lt;&gt;();</span>
       // Keep track of which ids are used
<span class="nc" id="L1340">        Set&lt;Integer&gt; usedPlayerIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1341">        Set&lt;String&gt; currentPlayerNames = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc" id="L1343">            currentPlayerNames.add(p.getName());</span>
<span class="nc" id="L1344">        }</span>
        // Map the old connection Id to new value
<span class="nc" id="L1346">        Map&lt;Integer,Integer&gt; connIdRemapping = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">        for (IPlayer p : game.getPlayersVector()) {</span>
            // Check to see if this player was already connected
<span class="nc" id="L1349">            Integer oldId = nameToIdMap.get(p.getName());</span>
<span class="nc bnc" id="L1350" title="All 4 branches missed.">            if ((oldId != null) &amp;&amp; (oldId != p.getId())) {</span>
<span class="nc" id="L1351">                connIdRemapping.put(oldId, p.getId());</span>
            }
            // If the old and new Ids match, make sure we remove ghost status
<span class="nc bnc" id="L1354" title="All 4 branches missed.">            if ((oldId != null) &amp;&amp; (oldId == p.getId())) {</span>
<span class="nc" id="L1355">                p.setGhost(false);</span>
            }
            // Check to see if this player's Id is taken
<span class="nc" id="L1358">            String oldName = idToNameMap.get(p.getId());</span>
<span class="nc bnc" id="L1359" title="All 4 branches missed.">            if ((oldName != null) &amp;&amp; !oldName.equals(p.getName())) {</span>
                // If this name doesn't belong to a current player, unassign it
<span class="nc bnc" id="L1361" title="All 2 branches missed.">                if (!currentPlayerNames.contains(oldName)) {</span>
<span class="nc" id="L1362">                    unassignedConns.add(connectionIds.get(p.getId()));</span>
                    // Make sure we don't add this to unassigned connections twice
<span class="nc" id="L1364">                    connectionIds.remove(p.getId());</span>
                }
                // If it does belong to a current player, it'll get handled
                // when that player comes up
            }
            // Keep track of what Ids are used
<span class="nc" id="L1370">            usedPlayerIds.add(p.getId());</span>
<span class="nc" id="L1371">        }</span>

        // Remap old connection Ids to new ones
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        for (Integer currConnId : connIdRemapping.keySet()) {</span>
<span class="nc" id="L1375">            Integer newId = connIdRemapping.get(currConnId);</span>
<span class="nc" id="L1376">            IConnection conn = connectionIds.get(currConnId);</span>
<span class="nc" id="L1377">            conn.setId(newId);</span>
            // If this Id is used, make sure we reassign that connection
<span class="nc bnc" id="L1379" title="All 2 branches missed.">            if (connectionIds.containsKey(newId)) {</span>
<span class="nc" id="L1380">                unassignedConns.add(connectionIds.get(newId));</span>
            }
            // Map the new Id
<span class="nc" id="L1383">            connectionIds.put(newId, conn);</span>

<span class="nc" id="L1385">            game.getPlayer(newId).setGhost(false);</span>
<span class="nc" id="L1386">            send(newId, new Packet(Packet.COMMAND_LOCAL_PN, newId));</span>
<span class="nc" id="L1387">        }</span>

        // It's possible we have players not in the saved game, add 'em
<span class="nc bnc" id="L1390" title="All 2 branches missed.">        for (IConnection conn : unassignedConns) {</span>
<span class="nc" id="L1391">            int newId = 0;</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">            while (usedPlayerIds.contains(newId)) {</span>
<span class="nc" id="L1393">                newId++;</span>
            }
<span class="nc" id="L1395">            String name = idToNameMap.get(conn.getId());</span>
<span class="nc" id="L1396">            conn.setId(newId);</span>
<span class="nc" id="L1397">            IPlayer newPlayer = addNewPlayer(newId, name);</span>
<span class="nc" id="L1398">            newPlayer.setObserver(true);</span>
<span class="nc" id="L1399">            connectionIds.put(newId,  conn);</span>
<span class="nc" id="L1400">            send(newId, new Packet(Packet.COMMAND_LOCAL_PN, newId));</span>
<span class="nc" id="L1401">        }</span>

        // Ensure all clients are up-to-date on player info
<span class="nc" id="L1404">        transmitAllPlayerUpdates();</span>
<span class="nc" id="L1405">    }</span>

    /**
     * Shortcut to game.getPlayer(id)
     */
    public IPlayer getPlayer(int id) {
<span class="nc" id="L1411">        return game.getPlayer(id);</span>
    }

    /**
     * Removes all entities owned by a player. Should only be called when it
     * won't cause trouble (the lounge, for instance, or between phases.)
     *
     * @param player whose entities are to be removed
     */
    private void removeAllEntitiesOwnedBy(IPlayer player) {
<span class="nc" id="L1421">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L1423" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1424">            final Entity entity = e.next();</span>

<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (entity.getOwner().equals(player)) {</span>
<span class="nc" id="L1427">                toRemove.addElement(entity);</span>
            }
<span class="nc" id="L1429">        }</span>

<span class="nc bnc" id="L1431" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1432">            int id = entity.getId();</span>
<span class="nc" id="L1433">            game.removeEntity(id, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
<span class="nc" id="L1434">            send(createRemoveEntityPacket(id, IEntityRemovalConditions.REMOVE_NEVER_JOINED));</span>
<span class="nc" id="L1435">        }</span>
<span class="nc" id="L1436">    }</span>

    /**
     * a shorter name for getConnection()
     */
    private IConnection getClient(int connId) {
<span class="nc" id="L1442">        return getConnection(connId);</span>
    }

    /**
     * Returns a connection, indexed by id
     */
    public Enumeration&lt;IConnection&gt; getConnections() {
<span class="nc" id="L1449">        return connections.elements();</span>
    }

    /**
     * Returns a connection, indexed by id
     */
    public IConnection getConnection(int connId) {
<span class="nc" id="L1456">        return connectionIds.get(connId);</span>
    }

    /**
     * Returns a pending connection
     */
    IConnection getPendingConnection(int connId) {
<span class="nc bnc" id="L1463" title="All 2 branches missed.">        for (IConnection conn : connectionsPending) {</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">            if (conn.getId() == connId) {</span>
<span class="nc" id="L1465">                return conn;</span>
            }
<span class="nc" id="L1467">        }</span>
<span class="nc" id="L1468">        return null;</span>
    }

    /**
     * Called at the beginning of each game round to reset values on this entity
     * that are reset every round
     */
    private void resetEntityRound() {
<span class="nc bnc" id="L1476" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1477">            Entity entity = e.next();</span>

<span class="nc" id="L1479">            entity.newRound(game.getRoundCount());</span>
<span class="nc" id="L1480">        }</span>
<span class="nc" id="L1481">    }</span>

    /**
     * Check a list of entity Ids for doomed entities and destroy those.
     */
    private void destroyDoomedEntities(Vector&lt;Integer&gt; entityIds) {
<span class="nc" id="L1487">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;(0, 10);</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">        for (Integer entityId : entityIds) {</span>
<span class="nc" id="L1489">            Entity entity = game.getEntity(entityId);</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L1491">                entity.setDestroyed(true);</span>

                // Is this unit swarming somebody? Better let go before
                // it's too late.
<span class="nc" id="L1495">                final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">                if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L1497">                    final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L1498">                    swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L1499">                    entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L1500">                    Report r = new Report(5165);</span>
<span class="nc" id="L1501">                    r.subject = swarmedId;</span>
<span class="nc" id="L1502">                    r.addDesc(swarmed);</span>
<span class="nc" id="L1503">                    addReport(r);</span>
<span class="nc" id="L1504">                    entityUpdate(swarmedId);</span>
                }
            }

<span class="nc bnc" id="L1508" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc" id="L1509">                toRemove.addElement(entity);</span>
            }
<span class="nc" id="L1511">        }</span>

        // actually remove all flagged entities
<span class="nc bnc" id="L1514" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1515">            int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L1516" title="All 2 branches missed.">            if (!entity.isSalvage()) {</span>
<span class="nc" id="L1517">                condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
            }
            // If we removed a unit during the movement phase that hasn't moved,
            // remove its turn.
<span class="nc bnc" id="L1521" title="All 4 branches missed.">            if ((game.getPhase() == Phase.PHASE_MOVEMENT) &amp;&amp; entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L1522">                game.removeTurnFor(entity);</span>
<span class="nc" id="L1523">                send(createTurnVectorPacket());</span>
            }
<span class="nc" id="L1525">            entityUpdate(entity.getId());</span>
<span class="nc" id="L1526">            game.removeEntity(entity.getId(), condition);</span>
<span class="nc" id="L1527">            send(createRemoveEntityPacket(entity.getId(), condition));</span>
<span class="nc" id="L1528">        }</span>
<span class="nc" id="L1529">    }</span>

    /**
     * Deploys elligible offboard entities.
     */
    private void deployOffBoardEntities() {
        // place off board entities actually off-board
<span class="nc" id="L1536">        Iterator&lt;Entity&gt; entities = game.getEntities();</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">        while (entities.hasNext()) {</span>
<span class="nc" id="L1538">            Entity en = entities.next();</span>
<span class="nc bnc" id="L1539" title="All 4 branches missed.">            if (en.isOffBoard() &amp;&amp; !en.isDeployed()) {</span>
<span class="nc" id="L1540">                en.deployOffBoard(game.getRoundCount());</span>
            }
<span class="nc" id="L1542">        }</span>
<span class="nc" id="L1543">    }</span>

    /**
     * Called at the beginning of each phase. Sets and resets any entity
     * parameters that need to be reset.
     */
    private void resetEntityPhase(IGame.Phase phase) {
        // first, mark doomed entities as destroyed and flag them
<span class="nc" id="L1551">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;(0, 10);</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1553">            final Entity entity = e.next();</span>
<span class="nc" id="L1554">            entity.newPhase(phase);</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L1556">                entity.setDestroyed(true);</span>

                // Is this unit swarming somebody? Better let go before
                // it's too late.
<span class="nc" id="L1560">                final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">                if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L1562">                    final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L1563">                    swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L1564">                    entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L1565">                    Report r = new Report(5165);</span>
<span class="nc" id="L1566">                    r.subject = swarmedId;</span>
<span class="nc" id="L1567">                    r.addDesc(swarmed);</span>
<span class="nc" id="L1568">                    addReport(r);</span>
<span class="nc" id="L1569">                    entityUpdate(swarmedId);</span>
                }
            }

<span class="nc bnc" id="L1573" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                if (game.getEntity(entity.getTransportId()) != null</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">                        &amp;&amp; game.getEntity(entity.getTransportId()).isLargeCraft()) {</span>
                    //Leaving destroyed entities in dropship bays alone here
                } else {
<span class="nc" id="L1578">                    toRemove.addElement(entity);</span>
                }
            }
<span class="nc" id="L1581">        }</span>

        // actually remove all flagged entities
<span class="nc bnc" id="L1584" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1585">            int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">            if (!entity.isSalvage()) {</span>
<span class="nc" id="L1587">                condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
            }

<span class="nc" id="L1590">            entityUpdate(entity.getId());</span>
<span class="nc" id="L1591">            game.removeEntity(entity.getId(), condition);</span>
<span class="nc" id="L1592">            send(createRemoveEntityPacket(entity.getId(), condition));</span>
<span class="nc" id="L1593">        }</span>

        // do some housekeeping on all the remaining
<span class="nc bnc" id="L1596" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1597">            final Entity entity = e.next();</span>

<span class="nc" id="L1599">            entity.applyDamage();</span>

<span class="nc" id="L1601">            entity.reloadEmptyWeapons();</span>

            // reset damage this phase
            // telemissiles need a record of damage last phase
<span class="nc" id="L1605">            entity.damageThisRound += entity.damageThisPhase;</span>
<span class="nc" id="L1606">            entity.damageThisPhase = 0;</span>
<span class="nc" id="L1607">            entity.engineHitsThisPhase = 0;</span>
<span class="nc" id="L1608">            entity.rolledForEngineExplosion = false;</span>
<span class="nc" id="L1609">            entity.dodging = false;</span>
<span class="nc" id="L1610">            entity.setShutDownThisPhase(false);</span>
<span class="nc" id="L1611">            entity.setStartupThisPhase(false);</span>

            // reset done to false

<span class="nc bnc" id="L1615" title="All 2 branches missed.">            if (phase == IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">                entity.setDone(!entity.shouldDeploy(game.getRoundCount()));</span>
            } else {
<span class="nc" id="L1618">                entity.setDone(false);</span>
            }

            // reset spotlights
<span class="nc" id="L1622">            entity.setIlluminated(false);</span>
<span class="nc" id="L1623">            entity.setUsedSearchlight(false);</span>
<span class="nc" id="L1624">            entity.setCarefulStand(false);</span>
<span class="nc" id="L1625">            entity.setNetworkBAP(false);</span>

<span class="nc bnc" id="L1627" title="All 2 branches missed.">            if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L1628">                ((MechWarrior) entity).setLanded(true);</span>
            }
<span class="nc" id="L1630">        }</span>
<span class="nc" id="L1631">        game.clearIlluminatedPositions();</span>
<span class="nc" id="L1632">        send(new Packet(Packet.COMMAND_CLEAR_ILLUM_HEXES));</span>
<span class="nc" id="L1633">    }</span>

    /*
     *  Called during the end phase. Checks each entity for ASEW effects counters and decrements them by 1 if &gt; 0
     */

    public void decrementASEWTurns() {
<span class="nc bnc" id="L1640" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1641">            final Entity entity = e.next();</span>
            // Decrement ASEW effects
<span class="nc bnc" id="L1643" title="All 2 branches missed.">            if ((entity.getEntityType() &amp; Entity.ETYPE_DROPSHIP) == Entity.ETYPE_DROPSHIP) {</span>
<span class="nc" id="L1644">                Dropship d = (Dropship) entity;</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">                for (int loc = 0; loc &lt; d.locations(); loc++) {</span>
<span class="nc bnc" id="L1646" title="All 2 branches missed.">                    if (d.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L1647">                        d.setASEWAffected(loc, d.getASEWAffected(loc) - 1);</span>
                    }
                }
<span class="nc bnc" id="L1650" title="All 2 branches missed.">            } else if ((entity.getEntityType() &amp; Entity.ETYPE_JUMPSHIP) != 0) {</span>
<span class="nc" id="L1651">                Jumpship j = (Jumpship) entity;</span>
<span class="nc bnc" id="L1652" title="All 2 branches missed.">                for (int loc = 0; loc &lt; j.locations(); loc++) {</span>
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                    if (j.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L1654">                        j.setASEWAffected(loc, j.getASEWAffected(loc) - 1);</span>
                    }
                }
<span class="nc" id="L1657">            } else {</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">                if (entity.getASEWAffected() &gt; 0) {</span>
<span class="nc" id="L1659">                    entity.setASEWAffected(entity.getASEWAffected() - 1);</span>
                }
            }
<span class="nc" id="L1662">        }</span>
<span class="nc" id="L1663">    }</span>


    /**
     * are we currently in a reporting phase
     *
     * @return &lt;code&gt;true&lt;/code&gt; if we are or &lt;code&gt;false&lt;/code&gt; if not.
     */
    private boolean isReportingPhase() {
<span class="nc bnc" id="L1672" title="All 2 branches missed.">        return (game.getPhase() == IGame.Phase.PHASE_FIRING_REPORT)</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_INITIATIVE_REPORT)</span>
<span class="nc bnc" id="L1674" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_MOVEMENT_REPORT)</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD_REPORT)</span>
<span class="nc bnc" id="L1676" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_PHYSICAL_REPORT);</span>
    }

    /**
     * Called at the beginning of certain phases to make every player not ready.
     */
    private void resetPlayersDone() {
<span class="nc bnc" id="L1683" title="All 2 branches missed.">        if (isReportingPhase()) {</span>
<span class="nc" id="L1684">            return;</span>
        }
<span class="nc bnc" id="L1686" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1687">            final IPlayer player = i.nextElement();</span>
<span class="nc" id="L1688">            player.setDone(false);</span>
<span class="nc" id="L1689">        }</span>
<span class="nc" id="L1690">        transmitAllPlayerDones();</span>
<span class="nc" id="L1691">    }</span>

    /**
     * Called at the beginning of certain phases to make every active player not
     * ready.
     */
    private void resetActivePlayersDone() {
        /*
         * if (isReportingPhase()) { return; }
         */
<span class="nc bnc" id="L1701" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1702">            final IPlayer player = i.nextElement();</span>

<span class="nc bnc" id="L1704" title="All 2 branches missed.">            player.setDone(game.getEntitiesOwnedBy(player) &lt;= 0);</span>

<span class="nc" id="L1706">        }</span>
<span class="nc" id="L1707">        transmitAllPlayerDones();</span>
<span class="nc" id="L1708">    }</span>

    /**
     * Writes the victory report
     */
    private void prepareVictoryReport() {
        Report r;

        // remove carcasses to the graveyard
<span class="nc" id="L1717">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L1718" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L1719" title="All 4 branches missed.">            if (e.isCarcass() &amp;&amp; !e.isDestroyed()) {</span>
<span class="nc" id="L1720">                toRemove.add(e);</span>
            }
<span class="nc" id="L1722">        }</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">        for (Entity e : toRemove) {</span>
<span class="nc" id="L1724">            destroyEntity(e, &quot;crew death&quot;, false, true);</span>
<span class="nc" id="L1725">            game.removeEntity(e.getId(), IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
<span class="nc" id="L1726">            e.setDestroyed(true);</span>
<span class="nc" id="L1727">        }</span>

<span class="nc" id="L1729">        addReport(new Report(7000, Report.PUBLIC));</span>

        // Declare the victor
<span class="nc" id="L1732">        r = new Report(1210);</span>
<span class="nc" id="L1733">        r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L1734" title="All 2 branches missed.">        if (game.getVictoryTeam() == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1735">            IPlayer player = getPlayer(game.getVictoryPlayerId());</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L1737">                r.messageId = 7005;</span>
            } else {
<span class="nc" id="L1739">                r.messageId = 7010;</span>
<span class="nc" id="L1740">                r.add(Server.getColorForPlayer(player));</span>
            }
<span class="nc" id="L1742">        } else {</span>
            // Team victory
<span class="nc" id="L1744">            r.messageId = 7015;</span>
<span class="nc" id="L1745">            r.add(game.getVictoryTeam());</span>
        }
<span class="nc" id="L1747">        addReport(r);</span>

        // Show player BVs
<span class="nc" id="L1750">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L1752">            IPlayer player = players.nextElement();</span>
            // Observers without initial entities get ignored
<span class="nc bnc" id="L1754" title="All 4 branches missed.">            if (player.isObserver() &amp;&amp; (player.getInitialEntityCount() == 0)) {</span>
<span class="nc" id="L1755">                continue;</span>
            }
<span class="nc" id="L1757">            r = new Report(7016, Report.PUBLIC);</span>
<span class="nc" id="L1758">            r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L1759">            r.add(player.getBV());</span>
<span class="nc" id="L1760">            r.add(player.getInitialBV());</span>
<span class="nc" id="L1761">            r.add(Double.toString(Math.round(((double) player.getBV() / player.getInitialBV()) * 10000.0) / 100.0));</span>
<span class="nc" id="L1762">            r.add(player.getFledBV());</span>
<span class="nc" id="L1763">            r.add(player.getEntityCount());</span>
<span class="nc" id="L1764">            r.add(player.getInitialEntityCount());</span>
<span class="nc" id="L1765">            r.add(Double.toString(Math.round(((double) player.getEntityCount() / player.getInitialEntityCount()) * 10000.0) / 100.0));</span>
<span class="nc" id="L1766">            addReport(r);</span>
<span class="nc" id="L1767">        }</span>

        // List the survivors
<span class="nc" id="L1770">        Iterator&lt;Entity&gt; survivors = game.getEntities();</span>
<span class="nc bnc" id="L1771" title="All 2 branches missed.">        if (survivors.hasNext()) {</span>
<span class="nc" id="L1772">            addReport(new Report(7020, Report.PUBLIC));</span>
<span class="nc bnc" id="L1773" title="All 2 branches missed.">            while (survivors.hasNext()) {</span>
<span class="nc" id="L1774">                Entity entity = survivors.next();</span>

<span class="nc bnc" id="L1776" title="All 2 branches missed.">                if (!entity.isDeployed()) {</span>
<span class="nc" id="L1777">                    continue;</span>
                }

<span class="nc" id="L1780">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1781">            }</span>
        }
        // List units that never deployed
<span class="nc" id="L1784">        Iterator&lt;Entity&gt; undeployed = game.getEntities();</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">        if (undeployed.hasNext()) {</span>
<span class="nc" id="L1786">            boolean wroteHeader = false;</span>

<span class="nc bnc" id="L1788" title="All 2 branches missed.">            while (undeployed.hasNext()) {</span>
<span class="nc" id="L1789">                Entity entity = undeployed.next();</span>

<span class="nc bnc" id="L1791" title="All 2 branches missed.">                if (entity.isDeployed()) {</span>
<span class="nc" id="L1792">                    continue;</span>
                }

<span class="nc bnc" id="L1795" title="All 2 branches missed.">                if (!wroteHeader) {</span>
<span class="nc" id="L1796">                    addReport(new Report(7075, Report.PUBLIC));</span>
<span class="nc" id="L1797">                    wroteHeader = true;</span>
                }

<span class="nc" id="L1800">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1801">            }</span>
        }
        // List units that retreated
<span class="nc" id="L1804">        Enumeration&lt;Entity&gt; retreat = game.getRetreatedEntities();</span>
<span class="nc bnc" id="L1805" title="All 2 branches missed.">        if (retreat.hasMoreElements()) {</span>
<span class="nc" id="L1806">            addReport(new Report(7080, Report.PUBLIC));</span>
<span class="nc bnc" id="L1807" title="All 2 branches missed.">            while (retreat.hasMoreElements()) {</span>
<span class="nc" id="L1808">                Entity entity = retreat.nextElement();</span>
<span class="nc" id="L1809">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1810">            }</span>
        }
        // List destroyed units
<span class="nc" id="L1813">        Enumeration&lt;Entity&gt; graveyard = game.getGraveyardEntities();</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">        if (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1815">            addReport(new Report(7085, Report.PUBLIC));</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1817">                Entity entity = graveyard.nextElement();</span>
<span class="nc" id="L1818">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1819">            }</span>
        }
        // List devastated units (not salvageable)
<span class="nc" id="L1822">        Enumeration&lt;Entity&gt; devastated = game.getDevastatedEntities();</span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">        if (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1824">            addReport(new Report(7090, Report.PUBLIC));</span>

<span class="nc bnc" id="L1826" title="All 2 branches missed.">            while (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1827">                Entity entity = devastated.nextElement();</span>
<span class="nc" id="L1828">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1829">            }</span>
        }
        // Let player know about entitystatus.txt file
<span class="nc" id="L1832">        addReport(new Report(7095, Report.PUBLIC));</span>
<span class="nc" id="L1833">    }</span>

    /**
     * Generates a detailed report for campaign use
     */
    private String getDetailedVictoryReport() {
<span class="nc" id="L1839">        StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L1841">        Vector&lt;Entity&gt; vAllUnits = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L1842" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L1843">            vAllUnits.addElement(i.next());</span>
        }

<span class="nc bnc" id="L1846" title="All 2 branches missed.">        for (Enumeration&lt;Entity&gt; i = game.getRetreatedEntities(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1847">            vAllUnits.addElement(i.nextElement());</span>
        }

<span class="nc bnc" id="L1850" title="All 2 branches missed.">        for (Enumeration&lt;Entity&gt; i = game.getGraveyardEntities(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1851">            vAllUnits.addElement(i.nextElement());</span>
        }

<span class="nc bnc" id="L1854" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
            // Record the player.
<span class="nc" id="L1856">            IPlayer p = i.nextElement();</span>
<span class="nc" id="L1857">            sb.append(&quot;++++++++++ &quot;).append(p.getName()).append(&quot; ++++++++++&quot;);</span>
<span class="nc" id="L1858">            sb.append(CommonConstants.NL);</span>

            // Record the player's alive, retreated, or salvageable units.
<span class="nc bnc" id="L1861" title="All 2 branches missed.">            for (int x = 0; x &lt; vAllUnits.size(); x++) {</span>
<span class="nc" id="L1862">                Entity e = vAllUnits.elementAt(x);</span>
<span class="nc bnc" id="L1863" title="All 2 branches missed.">                if (e.getOwner() == p) {</span>
<span class="nc" id="L1864">                    sb.append(UnitStatusFormatter.format(e));</span>
                }
            }

            // Record the player's devastated units.
<span class="nc" id="L1869">            Enumeration&lt;Entity&gt; devastated = game.getDevastatedEntities();</span>
<span class="nc bnc" id="L1870" title="All 2 branches missed.">            if (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1871">                sb.append(&quot;=============================================================&quot;);</span>
<span class="nc" id="L1872">                sb.append(CommonConstants.NL);</span>
<span class="nc" id="L1873">                sb.append(&quot;The following utterly destroyed units are not available for salvage:&quot;);</span>
<span class="nc" id="L1874">                sb.append(CommonConstants.NL);</span>
<span class="nc bnc" id="L1875" title="All 2 branches missed.">                while (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1876">                    Entity e = devastated.nextElement();</span>
<span class="nc bnc" id="L1877" title="All 2 branches missed.">                    if (e.getOwner() == p) {</span>
<span class="nc" id="L1878">                        sb.append(e.getShortName());</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">                        for (int pos = 0; pos &lt; e.getCrew().getSlotCount(); pos++) {</span>
<span class="nc" id="L1880">                            sb.append(&quot;, &quot;).append(e.getCrew().getNameAndRole(pos)).append(&quot; (&quot;)</span>
<span class="nc" id="L1881">                                .append(e.getCrew().getGunnery()).append('/')</span>
<span class="nc" id="L1882">                                .append(e.getCrew().getPiloting()).append(')');</span>
<span class="nc" id="L1883">                            sb.append(CommonConstants.NL);</span>
                        }
                    }
<span class="nc" id="L1886">                } // Handle the next non-salvageable unit for the player</span>
<span class="nc" id="L1887">                sb.append(&quot;=============================================================&quot;);</span>
<span class="nc" id="L1888">                sb.append(CommonConstants.NL);</span>
            }

<span class="nc" id="L1891">        } // Handle the next player</span>

<span class="nc" id="L1893">        return sb.toString();</span>
    }

    /**
     * Forces victory for the specified player, or his/her team at the end of
     * the round.
     */
    public void forceVictory(IPlayer victor) {
<span class="nc" id="L1901">        game.setForceVictory(true);</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">        if (victor.getTeam() == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1903">            game.setVictoryPlayerId(victor.getId());</span>
<span class="nc" id="L1904">            game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
        } else {
<span class="nc" id="L1906">            game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L1907">            game.setVictoryTeam(victor.getTeam());</span>
        }

<span class="nc" id="L1910">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        for (int i = 0; i &lt; playersVector.size(); i++) {</span>
<span class="nc" id="L1912">            IPlayer player = playersVector.elementAt(i);</span>
<span class="nc" id="L1913">            player.setAdmitsDefeat(false);</span>
        }
<span class="nc" id="L1915">    }</span>

    /**
     * Cancels the force victory
     */
    public void cancelVictory() {
<span class="nc" id="L1921">        game.setForceVictory(false);</span>
<span class="nc" id="L1922">        game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L1923">        game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
<span class="nc" id="L1924">    }</span>

    public void requestTeamChange(int team, IPlayer player) {
<span class="nc" id="L1927">        requestedTeam = team;</span>
<span class="nc" id="L1928">        playerChangingTeam = player;</span>
<span class="nc" id="L1929">        changePlayersTeam = false;</span>
<span class="nc" id="L1930">    }</span>

    public void allowTeamChange() {
<span class="nc" id="L1933">        changePlayersTeam = true;</span>
<span class="nc" id="L1934">    }</span>

    public boolean isTeamChangeRequestInProgress() {
<span class="nc bnc" id="L1937" title="All 2 branches missed.">        return playerChangingTeam != null;</span>
    }

    public IPlayer getPlayerRequestingTeamChange() {
<span class="nc" id="L1941">        return playerChangingTeam;</span>
    }

    public int getRequestedTeam() {
<span class="nc" id="L1945">        return requestedTeam;</span>
    }

    private void processTeamChange() {
<span class="nc bnc" id="L1949" title="All 2 branches missed.">        if (playerChangingTeam != null) {</span>
<span class="nc" id="L1950">            playerChangingTeam.setTeam(requestedTeam);</span>
<span class="nc" id="L1951">            game.setupTeams();</span>
<span class="nc" id="L1952">            send(createPlayerUpdatePacket(playerChangingTeam.getId()));</span>
<span class="nc" id="L1953">            String teamString = &quot;Team &quot; + requestedTeam + &quot;!&quot;;</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">            if (requestedTeam == IPlayer.TEAM_UNASSIGNED) {</span>
<span class="nc" id="L1955">                teamString = &quot; unassigned!&quot;;</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">            } else if (requestedTeam == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1957">                teamString = &quot; lone wolf!&quot;;</span>
            }
<span class="nc" id="L1959">            sendServerChat(playerChangingTeam.getName() + &quot; has changed teams to &quot; + teamString);</span>
<span class="nc" id="L1960">            playerChangingTeam = null;</span>
        }
<span class="nc" id="L1962">        changePlayersTeam = false;</span>
<span class="nc" id="L1963">    }</span>

    /**
     * Called when a player declares that he is &quot;done.&quot; Checks to see if all
     * players are done, and if so, moves on to the next phase.
     */
    private void checkReady() {
        // check if all active players are done
<span class="nc bnc" id="L1971" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1972">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L1973" title="All 6 branches missed.">            if (!player.isGhost() &amp;&amp; !player.isObserver() &amp;&amp; !player.isDone()) {</span>
<span class="nc" id="L1974">                return;</span>
            }
<span class="nc" id="L1976">        }</span>

        // Tactical Genius pilot special ability (lvl 3)
<span class="nc bnc" id="L1979" title="All 2 branches missed.">        if (game.getNoOfInitiativeRerollRequests() &gt; 0) {</span>
<span class="nc" id="L1980">            resetActivePlayersDone();</span>
<span class="nc" id="L1981">            game.rollInitAndResolveTies();</span>

<span class="nc" id="L1983">            determineTurnOrder(IGame.Phase.PHASE_INITIATIVE);</span>
<span class="nc" id="L1984">            clearReports();</span>
<span class="nc" id="L1985">            writeInitiativeReport(true);</span>
<span class="nc" id="L1986">            sendReport(true);</span>
<span class="nc" id="L1987">            return; // don't end the phase yet, players need to see new report</span>
        }

        // need at least one entity in the game for the lounge phase to end
<span class="nc bnc" id="L1991" title="All 4 branches missed.">        if (!game.phaseHasTurns(game.getPhase()) &amp;&amp; ((game.getPhase() != IGame.Phase.PHASE_LOUNGE)</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">                || (game.getNoOfEntities() &gt; 0))) {</span>
<span class="nc" id="L1993">            endCurrentPhase();</span>
        }
<span class="nc" id="L1995">    }</span>

    /**
     * Called when the current player has done his current turn and the turn
     * counter needs to be advanced. Also enforces the &quot;protos_move_multi&quot; and
     * the &quot;protos_move_multi&quot; option. If the player has just moved
     * infantry/protos with a &quot;normal&quot; turn, adds up to
     * Game.INF_AND_PROTOS_MOVE_MULTI - 1 more infantry/proto-specific turns
     * after the current turn.
     */
    private void endCurrentTurn(Entity entityUsed) {
        // Enforce &quot;inf_move_multi&quot; and &quot;protos_move_multi&quot; options.
        // The &quot;isNormalTurn&quot; flag is checking to see if any non-Infantry
        // or non-ProtoMech units can move during the current turn.
<span class="nc" id="L2009">        boolean turnsChanged = false;</span>
<span class="nc" id="L2010">        boolean outOfOrder = false;</span>
<span class="nc" id="L2011">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L2012" title="All 4 branches missed.">        if (game.isPhaseSimultaneous()</span>
            &amp;&amp; (entityUsed != null)
<span class="nc bnc" id="L2014" title="All 2 branches missed.">            &amp;&amp; !turn.isValid(entityUsed.getOwnerId(), game)) {</span>
            // turn played out of order
<span class="nc" id="L2016">            outOfOrder = true;</span>
<span class="nc" id="L2017">            entityUsed.setDone(false);</span>
<span class="nc" id="L2018">            GameTurn removed = game.removeFirstTurnFor(entityUsed);</span>
<span class="nc" id="L2019">            entityUsed.setDone(true);</span>
<span class="nc" id="L2020">            turnsChanged = true;</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">            if (removed != null) {</span>
<span class="nc" id="L2022">                turn = removed;</span>
            }
        }
<span class="nc" id="L2025">        final Phase currPhase = game.getPhase();</span>
<span class="nc" id="L2026">        final GameOptions gameOpts = game.getOptions();</span>
<span class="nc bnc" id="L2027" title="All 2 branches missed.">        final int playerId = null == entityUsed ? IPlayer.PLAYER_NONE : entityUsed.getOwnerId();</span>
<span class="nc" id="L2028">        boolean infMoved = entityUsed instanceof Infantry;</span>
<span class="nc bnc" id="L2029" title="All 8 branches missed.">        boolean infMoveMulti = gameOpts.booleanOption(OptionsConstants.INIT_INF_MOVE_MULTI)</span>
               &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                   || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                   || (currPhase == IGame.Phase.PHASE_INITIATIVE));
<span class="nc" id="L2033">        boolean protosMoved = entityUsed instanceof Protomech;</span>
<span class="nc" id="L2034">        boolean protosMoveMulti = gameOpts.booleanOption(OptionsConstants.INIT_PROTOS_MOVE_MULTI);</span>
<span class="nc" id="L2035">        boolean tanksMoved = entityUsed instanceof Tank;</span>
<span class="nc bnc" id="L2036" title="All 8 branches missed.">        boolean tanksMoveMulti = gameOpts.booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT)
                &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                    || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                    || (currPhase == IGame.Phase.PHASE_INITIATIVE));
<span class="nc" id="L2041">        boolean meksMoved = entityUsed instanceof Mech;</span>
<span class="nc bnc" id="L2042" title="All 8 branches missed.">        boolean meksMoveMulti = gameOpts.booleanOption(OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT)</span>
                &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                    || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                    || (currPhase == IGame.Phase.PHASE_INITIATIVE));

        // If infantry or protos move multi see if any
        // other unit types can move in the current turn.
<span class="nc" id="L2049">        int multiMask = 0;</span>
<span class="nc bnc" id="L2050" title="All 4 branches missed.">        if (infMoveMulti &amp;&amp; infMoved) {</span>
<span class="nc" id="L2051">            multiMask = GameTurn.CLASS_INFANTRY;</span>
<span class="nc bnc" id="L2052" title="All 4 branches missed.">        } else if (protosMoveMulti &amp;&amp; protosMoved) {</span>
<span class="nc" id="L2053">            multiMask = GameTurn.CLASS_PROTOMECH;</span>
<span class="nc bnc" id="L2054" title="All 4 branches missed.">        } else if (tanksMoveMulti &amp;&amp; tanksMoved) {</span>
<span class="nc" id="L2055">            multiMask = GameTurn.CLASS_TANK;</span>
<span class="nc bnc" id="L2056" title="All 4 branches missed.">        } else if (meksMoveMulti &amp;&amp; meksMoved) {</span>
<span class="nc" id="L2057">            multiMask = GameTurn.CLASS_MECH;</span>
        }

        // In certain cases, a new SpecificEntityTurn could have been added for
        // the Entity whose turn we are ending as the next turn. If this has
        // happened, the remaining entity count will be off and we must ensure
        // that the SpecificEntityTurn for this unit remains the next turn
<span class="nc" id="L2064">        List&lt;GameTurn&gt; turnVector = game.getTurnVector();</span>
<span class="nc" id="L2065">        int turnIndex = game.getTurnIndex();</span>
<span class="nc" id="L2066">        boolean usedEntityNotDone = false;</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">        if ((turnIndex + 1) &lt; turnVector.size()) {</span>
<span class="nc" id="L2068">            GameTurn nextTurn = turnVector.get(turnIndex + 1);</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">            if (nextTurn instanceof GameTurn.SpecificEntityTurn) {</span>
<span class="nc" id="L2070">                GameTurn.SpecificEntityTurn seTurn = (GameTurn.SpecificEntityTurn) nextTurn;</span>
<span class="nc bnc" id="L2071" title="All 4 branches missed.">                if ((entityUsed != null) &amp;&amp; (seTurn.getEntityNum() == entityUsed.getId())) {</span>
<span class="nc" id="L2072">                    turnIndex++;</span>
<span class="nc" id="L2073">                    usedEntityNotDone = true;</span>
                }
            }
        }

        // Was the turn we just took added as part of a multi-turn?
        //  This determines if we should add more multi-turns
<span class="nc" id="L2080">        boolean isMultiTurn = turn.isMultiTurn();</span>

        // Unless overridden by the &quot;protos_move_multi&quot; option, all ProtoMechs
        // in a unit declare fire, and they don't mix with infantry.
<span class="nc bnc" id="L2084" title="All 8 branches missed.">        if (protosMoved &amp;&amp; !protosMoveMulti &amp;&amp; !isMultiTurn &amp;&amp; (entityUsed != null)) {</span>

            // What's the unit number and ID of the entity used?
<span class="nc" id="L2087">            final short movingUnit = entityUsed.getUnitNumber();</span>
<span class="nc" id="L2088">            final int movingId = entityUsed.getId();</span>

            // How many other ProtoMechs are in the unit that can fire?
<span class="nc" id="L2091">            int protoTurns = game.getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L2092">                private final int ownerId = playerId;</span>

<span class="nc" id="L2094">                private final int entityId = movingId;</span>

<span class="nc" id="L2096">                private final short unitNum = movingUnit;</span>

                public boolean accept(Entity entity) {
<span class="nc bnc" id="L2099" title="All 2 branches missed.">                    return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L2100" title="All 2 branches missed.">                            &amp;&amp; entity.isSelectableThisTurn()</span>
<span class="nc bnc" id="L2101" title="All 2 branches missed.">                            &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L2102" title="All 2 branches missed.">                            &amp;&amp; (entityId != entity.getId())</span>
<span class="nc bnc" id="L2103" title="All 2 branches missed.">                            &amp;&amp; (unitNum == entity.getUnitNumber());</span>
                }
            });

            // Add the correct number of turns for the ProtoMech unit number.
<span class="nc bnc" id="L2108" title="All 2 branches missed.">            for (int i = 0; i &lt; protoTurns; i++) {</span>
<span class="nc" id="L2109">                GameTurn newTurn = new GameTurn.UnitNumberTurn(playerId, movingUnit);</span>
<span class="nc" id="L2110">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2111">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2112">                turnsChanged = true;</span>
            }
<span class="nc" id="L2114">        }</span>
        // Otherwise, we may need to add turns for the &quot;*_move_multi&quot; options.
<span class="nc bnc" id="L2116" title="All 10 branches missed.">        else if (((infMoved &amp;&amp; infMoveMulti) || (protosMoved &amp;&amp; protosMoveMulti)) &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2117">            int remaining = 0;</span>

            // Calculate the number of EntityClassTurns need to be added.
<span class="nc bnc" id="L2120" title="All 4 branches missed.">            if (infMoveMulti &amp;&amp; infMoved) {</span>
<span class="nc" id="L2121">                remaining += game.getInfantryLeft(playerId);</span>
            }
<span class="nc bnc" id="L2123" title="All 4 branches missed.">            if (protosMoveMulti &amp;&amp; protosMoved) {</span>
<span class="nc" id="L2124">                remaining += game.getProtomechsLeft(playerId);</span>
            }
<span class="nc bnc" id="L2126" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2127">                remaining--;</span>
            }
<span class="nc" id="L2129">            int moreInfAndProtoTurns = Math.min(</span>
<span class="nc" id="L2130">                    gameOpts.intOption(OptionsConstants.INIT_INF_PROTO_MOVE_MULTI) - 1, remaining);</span>

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2133" title="All 2 branches missed.">            for (int i = 0; i &lt; moreInfAndProtoTurns; i++) {</span>
<span class="nc" id="L2134">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2135">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2136">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2137">                turnsChanged = true;</span>
            }
        }

<span class="nc bnc" id="L2141" title="All 6 branches missed.">        if (tanksMoved &amp;&amp; tanksMoveMulti &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2142">            int remaining = game.getVehiclesLeft(playerId);</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2144">                remaining--;</span>
            }
<span class="nc" id="L2146">            int moreVeeTurns = Math.min(</span>
<span class="nc" id="L2147">                    gameOpts.intOption(OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT_NUMBER) - 1,</span>
                    remaining);

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2151" title="All 2 branches missed.">            for (int i = 0; i &lt; moreVeeTurns; i++) {</span>
<span class="nc" id="L2152">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2153">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2154">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2155">                turnsChanged = true;</span>
            }
        }

<span class="nc bnc" id="L2159" title="All 6 branches missed.">        if (meksMoved &amp;&amp; meksMoveMulti &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2160">            int remaining = game.getMechsLeft(playerId);</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2162">                remaining--;</span>
            }
<span class="nc" id="L2164">            int moreMekTurns = Math.min(</span>
<span class="nc" id="L2165">                    gameOpts.intOption(OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT_NUMBER) - 1,</span>
                    remaining);

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2169" title="All 2 branches missed.">            for (int i = 0; i &lt; moreMekTurns; i++) {</span>
<span class="nc" id="L2170">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2171">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2172">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2173">                turnsChanged = true;</span>
            }
        }

        // brief everybody on the turn update, if they changed
<span class="nc bnc" id="L2178" title="All 2 branches missed.">        if (turnsChanged) {</span>
<span class="nc" id="L2179">            send(createTurnVectorPacket());</span>
        }

        // move along
<span class="nc bnc" id="L2183" title="All 2 branches missed.">        if (outOfOrder) {</span>
<span class="nc" id="L2184">            send(createTurnIndexPacket(playerId));</span>
        } else {
<span class="nc" id="L2186">            changeToNextTurn(playerId);</span>
        }
<span class="nc" id="L2188">    }</span>

    /**
     * Changes the current phase, does some bookkeeping and then tells the
     * players.
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase to change to
     */
    private void changePhase(IGame.Phase phase) {
<span class="nc" id="L2197">        game.setLastPhase(game.getPhase());</span>
<span class="nc" id="L2198">        game.setPhase(phase);</span>

        // prepare for the phase
<span class="nc" id="L2201">        prepareForPhase(phase);</span>

<span class="nc bnc" id="L2203" title="All 2 branches missed.">        if (isPhasePlayable(phase)) {</span>
            // tell the players about the new phase
<span class="nc" id="L2205">            send(new Packet(Packet.COMMAND_PHASE_CHANGE, phase));</span>

            // post phase change stuff
<span class="nc" id="L2208">            executePhase(phase);</span>
        } else {
<span class="nc" id="L2210">            endCurrentPhase();</span>
        }
<span class="nc" id="L2212">    }</span>

    /**
     * Prepares for, presumably, the next phase. This typically involves
     * resetting the states of entities in the game and making sure the client
     * has the information it needs for the new phase.
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase to prepare for
     */
    private void prepareForPhase(IGame.Phase phase) {
<span class="nc bnc" id="L2222" title="All 10 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L2224">                clearReports();</span>
<span class="nc" id="L2225">                mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L2226">                        mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L2227">                mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L2228">                send(createMapSettingsPacket());</span>
<span class="nc" id="L2229">                send(createMapSizesPacket());</span>
<span class="nc" id="L2230">                checkForObservers();</span>
<span class="nc" id="L2231">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2232">                break;</span>
            case PHASE_INITIATIVE:
                // remove the last traces of last round
<span class="nc" id="L2235">                game.handleInitiativeCompensation();</span>
<span class="nc" id="L2236">                game.resetActions();</span>
<span class="nc" id="L2237">                game.resetTagInfo();</span>
<span class="nc" id="L2238">                sendTagInfoReset();</span>
<span class="nc" id="L2239">                clearReports();</span>
<span class="nc" id="L2240">                resetEntityRound();</span>
<span class="nc" id="L2241">                resetEntityPhase(phase);</span>
<span class="nc" id="L2242">                checkForObservers();</span>
<span class="nc" id="L2243">                transmitAllPlayerUpdates();</span>

                // roll 'em
<span class="nc" id="L2246">                resetActivePlayersDone();</span>
<span class="nc" id="L2247">                rollInitiative();</span>
                //Cockpit command consoles that switched crew on the previous round are ineligible for force
                //commander initiative bonus. Now that initiative is rolled, clear the flag.
<span class="nc" id="L2250">                game.getEntities().forEachRemaining(e -&gt; e.getCrew().resetActedFlag());</span>

<span class="nc bnc" id="L2252" title="All 2 branches missed.">                if (!game.shouldDeployThisRound()) {</span>
<span class="nc" id="L2253">                    incrementAndSendGameRound();</span>
                }

                // setIneligible(phase);
<span class="nc" id="L2257">                determineTurnOrder(phase);</span>
<span class="nc" id="L2258">                writeInitiativeReport(false);</span>

                // checks for environmental survival
<span class="nc" id="L2261">                checkForConditionDeath();</span>

<span class="nc" id="L2263">                checkForBlueShieldDamage();</span>
<span class="nc bnc" id="L2264" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L2265">                    checkForAtmosphereDeath();</span>
                }
<span class="nc bnc" id="L2267" title="All 2 branches missed.">                if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L2268">                    checkForSpaceDeath();</span>
                }

<span class="nc" id="L2271">                MegaMek.getLogger().info(&quot;Round &quot; + game.getRoundCount() + &quot; memory usage: &quot; + MegaMek.getMemoryUsed());</span>
<span class="nc" id="L2272">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L2274">                checkForObservers();</span>
<span class="nc" id="L2275">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2276">                resetActivePlayersDone();</span>
<span class="nc" id="L2277">                setIneligible(phase);</span>

<span class="nc" id="L2279">                Enumeration&lt;IPlayer&gt; e = game.getPlayers();</span>
<span class="nc" id="L2280">                Vector&lt;GameTurn&gt; turns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L2281" title="All 2 branches missed.">                while (e.hasMoreElements()) {</span>
<span class="nc" id="L2282">                    IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L2283" title="All 4 branches missed.">                    if (p.hasMinefields() &amp;&amp; game.getBoard().onGround()) {</span>
<span class="nc" id="L2284">                        GameTurn gt = new GameTurn(p.getId());</span>
<span class="nc" id="L2285">                        turns.addElement(gt);</span>
                    }
<span class="nc" id="L2287">                }</span>
<span class="nc" id="L2288">                game.setTurnVector(turns);</span>
<span class="nc" id="L2289">                game.resetTurnIndex();</span>

                // send turns to all players
<span class="nc" id="L2292">                send(createTurnVectorPacket());</span>
<span class="nc" id="L2293">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L2295">                deployOffBoardEntities();</span>
<span class="nc" id="L2296">                checkForObservers();</span>
<span class="nc" id="L2297">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2298">                resetActivePlayersDone();</span>
<span class="nc" id="L2299">                setIneligible(phase);</span>

<span class="nc" id="L2301">                Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc" id="L2302">                Vector&lt;GameTurn&gt; turn = new Vector&lt;&gt;();</span>

                // Walk through the players of the game, and add
                // a turn for all players with artillery weapons.
<span class="nc bnc" id="L2306" title="All 2 branches missed.">                while (players.hasMoreElements()) {</span>

                    // Get the next player.
<span class="nc" id="L2309">                    final IPlayer p = players.nextElement();</span>

                    // Does the player have any artillery-equipped units?
<span class="nc" id="L2312">                    EntitySelector playerArtySelector = new EntitySelector() {</span>
<span class="nc" id="L2313">                        private IPlayer owner = p;</span>

                        public boolean accept(Entity entity) {
<span class="nc bnc" id="L2316" title="All 4 branches missed.">                            return owner.equals(entity.getOwner()) &amp;&amp; entity.isEligibleForArtyAutoHitHexes();</span>
                        }
                    };
<span class="nc bnc" id="L2319" title="All 2 branches missed.">                    if (game.getSelectedEntities(playerArtySelector).hasNext()) {</span>
                        // Yes, the player has arty-equipped units.
<span class="nc" id="L2321">                        GameTurn gt = new GameTurn(p.getId());</span>
<span class="nc" id="L2322">                        turn.addElement(gt);</span>
                    }
<span class="nc" id="L2324">                }</span>
<span class="nc" id="L2325">                game.setTurnVector(turn);</span>
<span class="nc" id="L2326">                game.resetTurnIndex();</span>

                // send turns to all players
<span class="nc" id="L2329">                send(createTurnVectorPacket());</span>
<span class="nc" id="L2330">                break;</span>
            case PHASE_MOVEMENT:
            case PHASE_DEPLOYMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc" id="L2337">                deployOffBoardEntities();</span>

                // Check for activating hidden units
<span class="nc bnc" id="L2340" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L2341" title="All 2 branches missed.">                    for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L2342" title="All 2 branches missed.">                        if (ent.getHiddenActivationPhase() == phase) {</span>
<span class="nc" id="L2343">                            ent.setHidden(false);</span>
                        }
<span class="nc" id="L2345">                    }</span>
                }
                // Update visibility indications if using double blind.
<span class="nc bnc" id="L2348" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L2349">                    updateVisibilityIndicator(null);</span>
                }
<span class="nc" id="L2351">                resetEntityPhase(phase);</span>
<span class="nc" id="L2352">                checkForObservers();</span>
<span class="nc" id="L2353">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2354">                resetActivePlayersDone();</span>
<span class="nc" id="L2355">                setIneligible(phase);</span>
<span class="nc" id="L2356">                determineTurnOrder(phase);</span>
                // send(createEntitiesPacket());
<span class="nc" id="L2358">                entityAllUpdate();</span>
<span class="nc" id="L2359">                clearReports();</span>
<span class="nc" id="L2360">                doTryUnstuck();</span>
<span class="nc" id="L2361">                break;</span>
            case PHASE_END:
<span class="nc" id="L2363">                resetEntityPhase(phase);</span>
<span class="nc" id="L2364">                clearReports();</span>
<span class="nc" id="L2365">                resolveHeat();</span>
<span class="nc bnc" id="L2366" title="All 2 branches missed.">                if (game.getPlanetaryConditions().isSandBlowing()</span>
<span class="nc bnc" id="L2367" title="All 2 branches missed.">                    &amp;&amp; (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_LIGHT_GALE)) {</span>
<span class="nc" id="L2368">                    addReport(resolveBlowingSandDamage());</span>
                }
<span class="nc" id="L2370">                addReport(resolveControlRolls());</span>
<span class="nc" id="L2371">                addReport(checkForTraitors());</span>
                // write End Phase header
<span class="nc" id="L2373">                addReport(new Report(5005, Report.PUBLIC));</span>
<span class="nc" id="L2374">                checkLayExplosives();</span>
<span class="nc" id="L2375">                resolveHarJelRepairs();</span>
<span class="nc" id="L2376">                resolveEmergencyCoolantSystem();</span>
<span class="nc" id="L2377">                checkForSuffocation();</span>
<span class="nc" id="L2378">                game.getPlanetaryConditions().determineWind();</span>
<span class="nc" id="L2379">                send(createPlanetaryConditionsPacket());</span>

<span class="nc" id="L2381">                applyBuildingDamage();</span>
<span class="nc" id="L2382">                addReport(game.ageFlares());</span>
<span class="nc" id="L2383">                send(createFlarePacket());</span>
<span class="nc" id="L2384">                resolveAmmoDumps();</span>
<span class="nc" id="L2385">                resolveCrewWakeUp();</span>
<span class="nc" id="L2386">                resolveConsoleCrewSwaps();</span>
<span class="nc" id="L2387">                resolveSelfDestruct();</span>
<span class="nc" id="L2388">                resolveShutdownCrashes();</span>
<span class="nc" id="L2389">                checkForIndustrialEndOfTurn();</span>
<span class="nc" id="L2390">                resolveMechWarriorPickUp();</span>
<span class="nc" id="L2391">                resolveVeeINarcPodRemoval();</span>
<span class="nc" id="L2392">                resolveFortify();</span>

                // Moved this to the very end because it makes it difficult to see
                // more important updates when you have 300+ messages of smoke filling
                // whatever hex. Please don't move it above the other things again.
                // Thanks! Ralgith - 2018/03/15
<span class="nc" id="L2398">                hexUpdateSet.clear();</span>
<span class="nc bnc" id="L2399" title="All 2 branches missed.">                for (DynamicTerrainProcessor tp : terrainProcessors) {</span>
<span class="nc" id="L2400">                    tp.doEndPhaseChanges(vPhaseReport);</span>
<span class="nc" id="L2401">                }</span>
<span class="nc" id="L2402">                sendChangedHexes(hexUpdateSet);</span>

<span class="nc" id="L2404">                checkForObservers();</span>
<span class="nc" id="L2405">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2406">                entityAllUpdate();</span>
<span class="nc" id="L2407">                break;</span>
            case PHASE_INITIATIVE_REPORT: {
<span class="nc" id="L2409">                autoSave();</span>
                // Show player BVs
<span class="nc" id="L2411">                Enumeration&lt;IPlayer&gt; players2 = game.getPlayers();</span>
<span class="nc bnc" id="L2412" title="All 2 branches missed.">                while (players2.hasMoreElements()) {</span>
<span class="nc" id="L2413">                    IPlayer player = players2.nextElement();</span>
                    // Observers without initial entities get ignored
<span class="nc bnc" id="L2415" title="All 4 branches missed.">                    if (player.isObserver() &amp;&amp; (player.getInitialEntityCount() == 0)) {</span>
<span class="nc" id="L2416">                        continue;</span>
                    }
<span class="nc" id="L2418">                    Report r = new Report(7016, Report.PUBLIC);</span>
<span class="nc bnc" id="L2419" title="All 4 branches missed.">                    if (doBlind() &amp;&amp; suppressBlindBV()) {</span>
<span class="nc" id="L2420">                        r.type = Report.PLAYER;</span>
<span class="nc" id="L2421">                        r.player = player.getId();</span>
                    }
<span class="nc" id="L2423">                    r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L2424">                    r.add(player.getBV());</span>
<span class="nc" id="L2425">                    r.add(player.getInitialBV());</span>
<span class="nc" id="L2426">                    r.add(Double.toString(Math.round(((double) player.getBV() / player.getInitialBV()) * 10000.0) / 100.0));</span>
<span class="nc" id="L2427">                    r.add(player.getFledBV());</span>
<span class="nc" id="L2428">                    r.add(player.getEntityCount());</span>
<span class="nc" id="L2429">                    r.add(player.getInitialEntityCount());</span>
<span class="nc" id="L2430">                    r.add(Double.toString(Math.round(((double) player.getEntityCount() / player.getInitialEntityCount()) * 10000.0) / 100.0));</span>
<span class="nc" id="L2431">                    addReport(r);</span>
<span class="nc" id="L2432">                }</span>
            }
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
<span class="nc" id="L2440">                resetActivePlayersDone();</span>
<span class="nc" id="L2441">                sendReport();</span>
<span class="nc bnc" id="L2442" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PARANOID_AUTOSAVE)) {</span>
<span class="nc" id="L2443">                    autoSave();</span>
                }
                break;
            case PHASE_VICTORY:
<span class="nc" id="L2447">                resetPlayersDone();</span>
<span class="nc" id="L2448">                clearReports();</span>
<span class="nc" id="L2449">                prepareVictoryReport();</span>
<span class="nc" id="L2450">                game.addReports(vPhaseReport);</span>
                // Before we send the full entities packet we need to loop
                // through the fighters in squadrons and damage them.
<span class="nc bnc" id="L2453" title="All 2 branches missed.">                for (Iterator&lt;Entity&gt; ents = game.getEntities(); ents.hasNext(); ) {</span>
<span class="nc" id="L2454">                    Entity entity = ents.next();</span>
<span class="nc bnc" id="L2455" title="All 4 branches missed.">                    if ((entity.isFighter()) &amp;&amp; !(entity instanceof FighterSquadron)) {</span>
<span class="nc bnc" id="L2456" title="All 4 branches missed.">                        if (entity.isPartOfFighterSquadron() || entity.isCapitalFighter()) {</span>
<span class="nc" id="L2457">                            ((IAero) entity).doDisbandDamage();</span>
                        }
                    }
                // fix the armor and SI of aeros if using aero sanity rules for
                // the MUL
<span class="nc bnc" id="L2462" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)</span>
                        &amp;&amp; (entity instanceof Aero)) {
                    // need to rescale SI and armor
<span class="nc" id="L2465">                    int scale = 1;</span>
<span class="nc bnc" id="L2466" title="All 2 branches missed.">                    if (entity.isCapitalScale()) {</span>
<span class="nc" id="L2467">                        scale = 10;</span>
                    }
<span class="nc" id="L2469">                    Aero a = (Aero) entity;</span>
<span class="nc" id="L2470">                    int currentSI = a.getSI() / (2 * scale);</span>
<span class="nc" id="L2471">                    a.set0SI(a.get0SI() / (2 * scale));</span>
<span class="nc bnc" id="L2472" title="All 2 branches missed.">                    if (currentSI &gt; 0) {</span>
<span class="nc" id="L2473">                        a.setSI(currentSI);</span>
                    }
                    //Fix for #587. MHQ tracks fighters at standard scale and doesn't (currently)
                    //track squadrons. Squadrons don't save to MUL either, so... only convert armor for JS/WS/SS?
                    //Do we ever need to save capital fighter armor to the final MUL or entityStatus?
<span class="nc bnc" id="L2478" title="All 2 branches missed.">                    if (!entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L2479">                        scale = 1;</span>
                    }
<span class="nc bnc" id="L2481" title="All 2 branches missed.">                    if (scale &gt; 1) {</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc" id="L2483">                            int currentArmor = entity.getArmor(loc) / scale;</span>
<span class="nc bnc" id="L2484" title="All 2 branches missed.">                            if (entity.getOArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2485">                                entity.initializeArmor(entity.getOArmor(loc) / scale, loc);</span>
                            }
<span class="nc bnc" id="L2487" title="All 2 branches missed.">                            if (entity.getArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2488">                                entity.setArmor(currentArmor, loc);</span>
                            }
                        }
                    }
                }
<span class="nc" id="L2493">            }</span>
<span class="nc" id="L2494">                send(createFullEntitiesPacket());</span>
<span class="nc" id="L2495">                send(createReportPacket(null));</span>
<span class="nc" id="L2496">                send(createEndOfGamePacket());</span>
<span class="nc" id="L2497">                break;</span>
            default:
        }
<span class="nc" id="L2500">    }</span>

    /**
     * Should we play this phase or skip it?
     */
    private boolean isPhasePlayable(IGame.Phase phase) {
<span class="nc bnc" id="L2506" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_INITIATIVE:
            case PHASE_END:
<span class="nc" id="L2509">                return false;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_MOVEMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
<span class="nc" id="L2517">                return game.hasMoreTurns();</span>
            case PHASE_OFFBOARD:
<span class="nc" id="L2519">                return isOffboardPlayable();</span>
            default:
<span class="nc" id="L2521">                return true;</span>
        }
    }

    /**
     * Skip offboard phase, if there is no homing / semiguided ammo in play
     */
    private boolean isOffboardPlayable() {
<span class="nc bnc" id="L2529" title="All 2 branches missed.">        if (!game.hasMoreTurns()) {</span>
<span class="nc" id="L2530">            return false;</span>
        }
        
<span class="nc bnc" id="L2533" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext();) {</span>
<span class="nc" id="L2534">            Entity entity = e.next();</span>
<span class="nc bnc" id="L2535" title="All 2 branches missed.">            for (Mounted mounted : entity.getAmmo()) {</span>
<span class="nc" id="L2536">                AmmoType ammoType = (AmmoType) mounted.getType();</span>
                
                // per errata, TAG will spot for LRMs and such
<span class="nc bnc" id="L2539" title="All 2 branches missed.">                if ((ammoType.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L2540" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L2541" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_NLRM)</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MEK_MORTAR)) {</span>
<span class="nc" id="L2544">                    return true;</span>
                }
                
<span class="nc bnc" id="L2547" title="All 2 branches missed.">                if (((ammoType.getAmmoType() == AmmoType.T_ARROW_IV)</span>
<span class="nc bnc" id="L2548" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LONG_TOM)</span>
<span class="nc bnc" id="L2549" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_SNIPER)</span>
<span class="nc bnc" id="L2550" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_THUMPER))</span>
<span class="nc bnc" id="L2551" title="All 2 branches missed.">                        &amp;&amp; (ammoType.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L2552">                    return true;</span>
                }
<span class="nc" id="L2554">            }</span>
            
<span class="nc bnc" id="L2556" title="All 2 branches missed.">            for (Mounted b : entity.getBombs()) {</span>
<span class="nc bnc" id="L2557" title="All 4 branches missed.">                if (!b.isDestroyed() &amp;&amp; (b.getUsableShotsLeft() &gt; 0)</span>
<span class="nc bnc" id="L2558" title="All 2 branches missed.">                    &amp;&amp; (((BombType) b.getType()).getBombType() == BombType.B_LG)) {</span>
<span class="nc" id="L2559">                    return true;</span>
                }
<span class="nc" id="L2561">            }</span>
<span class="nc" id="L2562">        }</span>
        
        // loop through all current attacks
        // if there are any that use homing ammo, we are playable
        // we need to do this because we might have a homing arty shot in flight
        // when the unit that mounted that ammo is no longer on the field
<span class="nc bnc" id="L2568" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; attacks = game.getAttacks(); attacks.hasMoreElements(); ) {</span>
<span class="nc" id="L2569">            AttackHandler attackHandler = attacks.nextElement();</span>
<span class="nc" id="L2570">            Mounted ammo = attackHandler.getWaa().getEntity(game)</span>
<span class="nc" id="L2571">                    .getEquipment(attackHandler.getWaa().getAmmoId());</span>
<span class="nc bnc" id="L2572" title="All 2 branches missed.">            if (ammo != null) {</span>
<span class="nc" id="L2573">                AmmoType ammoType = (AmmoType) ammo.getType();</span>
<span class="nc bnc" id="L2574" title="All 2 branches missed.">                if (ammoType.getMunitionType() == AmmoType.M_HOMING) {</span>
<span class="nc" id="L2575">                    return true;</span>
                }
            }
<span class="nc" id="L2578">        }</span>
<span class="nc" id="L2579">        return false;</span>
    }

    /**
     * Do anything we seed to start the new phase, such as give a turn to the
     * first player to play.
     */
    private void executePhase(IGame.Phase phase) {
<span class="nc bnc" id="L2587" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_EXCHANGE:
<span class="nc" id="L2589">                resetPlayersDone();</span>
                // Update initial BVs, as things may have been modified in lounge
<span class="nc bnc" id="L2591" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc" id="L2592">                    e.setInitialBV(e.calculateBattleValue(false, false));</span>
<span class="nc" id="L2593">                }</span>
<span class="nc" id="L2594">                calculatePlayerInitialCounts();</span>
                // Build teams vector
<span class="nc" id="L2596">                game.setupTeams();</span>
<span class="nc" id="L2597">                applyBoardSettings();</span>
<span class="nc" id="L2598">                game.getPlanetaryConditions().determineWind();</span>
<span class="nc" id="L2599">                send(createPlanetaryConditionsPacket());</span>
                // transmit the board to everybody
<span class="nc" id="L2601">                send(createBoardPacket());</span>
<span class="nc" id="L2602">                game.setupRoundDeployment();</span>
<span class="nc" id="L2603">                game.setVictoryContext(new HashMap&lt;&gt;());</span>
<span class="nc" id="L2604">                game.createVictoryConditions();</span>
                // some entities may need to be checked and updated
<span class="nc" id="L2606">                checkEntityExchange();</span>
<span class="nc" id="L2607">                break;</span>
            case PHASE_MOVEMENT:
                // write Movement Phase header to report
<span class="nc" id="L2610">                addReport(new Report(2000, Report.PUBLIC));</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc" id="L2618">                changeToNextTurn(-1);</span>
<span class="nc bnc" id="L2619" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PARANOID_AUTOSAVE)) {</span>
<span class="nc" id="L2620">                    autoSave();</span>
                }
                break;
            default:
        }
<span class="nc" id="L2625">    }</span>

    /**
     * Calculates the initial count and BV for all players, and thus should only be called at the
     * start of a game
     */
    public void calculatePlayerInitialCounts() {
<span class="nc bnc" id="L2632" title="All 2 branches missed.">        for (final Enumeration&lt;IPlayer&gt; players = game.getPlayers(); players.hasMoreElements(); ) {</span>
<span class="nc" id="L2633">            final IPlayer player = players.nextElement();</span>
<span class="nc" id="L2634">            player.setInitialEntityCount(player.getEntityCount());</span>
<span class="nc" id="L2635">            player.setInitialBV(player.getBV());</span>
<span class="nc" id="L2636">        }</span>
<span class="nc" id="L2637">    }</span>

    /**
     * loop through entities in the exchange phase (i.e. after leaving
     * chat lounge) and do any actions that need to be done
     */
    public void checkEntityExchange() {
<span class="nc bnc" id="L2644" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; entities = game.getEntities(); entities.hasNext(); ) {</span>
<span class="nc" id="L2645">            Entity entity = entities.next();</span>
            // apply bombs
<span class="nc bnc" id="L2647" title="All 2 branches missed.">            if (entity.isBomber()) {</span>
<span class="nc" id="L2648">                ((IBomber)entity).applyBombs();</span>
            }

<span class="nc bnc" id="L2651" title="All 2 branches missed.">            if (entity.isAero()) {</span>
<span class="nc" id="L2652">                IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L2653" title="All 2 branches missed.">                if (a.isSpaceborne()) {</span>
                    // altitude and elevation don't matter in space
<span class="nc" id="L2655">                    a.liftOff(0);</span>
                } else {
                    // check for grounding
<span class="nc bnc" id="L2658" title="All 4 branches missed.">                    if (game.getBoard().inAtmosphere() &amp;&amp; !entity.isAirborne()) {</span>
                        // you have to be airborne on the atmospheric map
<span class="nc" id="L2660">                        a.liftOff(entity.getAltitude());</span>
                    }
                }

<span class="nc bnc" id="L2664" title="All 2 branches missed.">                if (entity.isFighter()) {</span>
<span class="nc" id="L2665">                    a.updateWeaponGroups();</span>
<span class="nc" id="L2666">                    entity.loadAllWeapons();</span>
                }
            }

            // if units were loaded in the chat lounge, I need to keep track of
            // it here because they can get dumped in the deployment phase
<span class="nc bnc" id="L2672" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L2673">                Vector&lt;Integer&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L2674" title="All 2 branches missed.">                for (Entity en : entity.getLoadedUnits()) {</span>
<span class="nc" id="L2675">                    v.add(en.getId());</span>
<span class="nc" id="L2676">                }</span>
<span class="nc" id="L2677">                entity.setLoadedKeepers(v);</span>
            }

<span class="nc bnc" id="L2680" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)</span>
<span class="nc bnc" id="L2681" title="All 2 branches missed.">                    &amp;&amp; (entity.isAero())) {</span>
<span class="nc" id="L2682">                Aero a = null;</span>
<span class="nc bnc" id="L2683" title="All 2 branches missed.">                if (entity instanceof Aero) {</span>
<span class="nc" id="L2684">                    a = (Aero) entity;</span>
                }
<span class="nc bnc" id="L2686" title="All 2 branches missed.">                if (entity.isCapitalScale()) {</span>
<span class="nc bnc" id="L2687" title="All 2 branches missed.">                    if (a != null) {</span>
<span class="nc" id="L2688">                        int currentSI = a.getSI() * 20;</span>
<span class="nc" id="L2689">                        a.initializeSI(a.get0SI() * 20);</span>
<span class="nc" id="L2690">                        a.setSI(currentSI);</span>
                    }
<span class="nc bnc" id="L2692" title="All 2 branches missed.">                    if (entity.isCapitalFighter()) {</span>
<span class="nc" id="L2693">                        ((IAero)entity).autoSetCapArmor();</span>
<span class="nc" id="L2694">                        ((IAero)entity).autoSetFatalThresh();</span>
                    } else {
                        // all armor and SI is going to be at standard scale, so
                        // we need to adjust
<span class="nc bnc" id="L2698" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc bnc" id="L2699" title="All 2 branches missed.">                            if (entity.getArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2700">                                int currentArmor = entity.getArmor(loc) * 10;</span>
<span class="nc" id="L2701">                                entity.initializeArmor(entity.getOArmor(loc) * 10, loc);</span>
<span class="nc" id="L2702">                                entity.setArmor(currentArmor, loc);</span>

                            }
                        }
                    }
<span class="nc bnc" id="L2707" title="All 2 branches missed.">                } else if (a != null) {</span>
<span class="nc" id="L2708">                    int currentSI = a.getSI() * 2;</span>
<span class="nc" id="L2709">                    a.initializeSI(a.get0SI() * 2);</span>
<span class="nc" id="L2710">                    a.setSI(currentSI);</span>
                }
            }
            // Give the unit a spotlight, if it has the spotlight quirk
<span class="nc bnc" id="L2714" title="All 2 branches missed.">            entity.setExternalSpotlight(entity.hasExternaSpotlight()</span>
<span class="nc bnc" id="L2715" title="All 2 branches missed.">                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</span>
<span class="nc" id="L2716">            entityUpdate(entity.getId());</span>

            // Remove hot-loading some from LRMs for meks
<span class="nc bnc" id="L2719" title="All 2 branches missed.">            if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_HOTLOAD_IN_GAME)) {</span>
<span class="nc bnc" id="L2720" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
                    // Vehicles are allowed to hot load, just meks cannot
<span class="nc bnc" id="L2722" title="All 2 branches missed.">                    if (!(e instanceof Mech)) {</span>
<span class="nc" id="L2723">                        continue;</span>
                    }
<span class="nc bnc" id="L2725" title="All 2 branches missed.">                    for (Mounted weapon : e.getWeaponList()) {</span>
<span class="nc" id="L2726">                        weapon.getType().removeMode(&quot;HotLoad&quot;);</span>
<span class="nc" id="L2727">                    }</span>
<span class="nc bnc" id="L2728" title="All 2 branches missed.">                    for (Mounted ammo : e.getAmmo()) {</span>
<span class="nc" id="L2729">                        ammo.getType().removeMode(&quot;HotLoad&quot;);</span>
<span class="nc" id="L2730">                    }</span>
<span class="nc" id="L2731">                }</span>
            }
<span class="nc" id="L2733">        }</span>
<span class="nc" id="L2734">    }</span>

    /**
     * Ends this phase and moves on to the next.
     */
    private void endCurrentPhase() {
<span class="nc bnc" id="L2740" title="All 21 branches missed.">        switch (game.getPhase()) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L2742">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2743">                changePhase(IGame.Phase.PHASE_EXCHANGE);</span>
<span class="nc" id="L2744">                break;</span>
            case PHASE_EXCHANGE:
            case PHASE_STARTING_SCENARIO:
<span class="nc" id="L2747">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2748">                changePhase(IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES);</span>
<span class="nc" id="L2749">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L2751">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2752">                Enumeration&lt;IPlayer&gt; e = game.getPlayers();</span>
<span class="nc" id="L2753">                boolean mines = false;</span>
<span class="nc bnc" id="L2754" title="All 4 branches missed.">                while (e.hasMoreElements() &amp;&amp; !mines) {</span>
<span class="nc" id="L2755">                    IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L2756" title="All 2 branches missed.">                    if (p.hasMinefields()) {</span>
<span class="nc" id="L2757">                        mines = true;</span>
                    }
<span class="nc" id="L2759">                }</span>
<span class="nc" id="L2760">                game.addReports(vPhaseReport);</span>
<span class="nc bnc" id="L2761" title="All 2 branches missed.">                if (mines) {</span>
<span class="nc" id="L2762">                    changePhase(IGame.Phase.PHASE_DEPLOY_MINEFIELDS);</span>
                } else {
<span class="nc" id="L2764">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                }
<span class="nc" id="L2766">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L2768">                changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
<span class="nc" id="L2769">                break;</span>
            case PHASE_DEPLOYMENT:
<span class="nc" id="L2771">                game.clearDeploymentThisRound();</span>
<span class="nc" id="L2772">                game.checkForCompleteDeployment();</span>
<span class="nc" id="L2773">                Enumeration&lt;IPlayer&gt; pls = game.getPlayers();</span>
<span class="nc bnc" id="L2774" title="All 2 branches missed.">                while (pls.hasMoreElements()) {</span>
<span class="nc" id="L2775">                    IPlayer p = pls.nextElement();</span>
<span class="nc" id="L2776">                    p.adjustStartingPosForReinforcements();</span>
<span class="nc" id="L2777">                }</span>

<span class="nc bnc" id="L2779" title="All 2 branches missed.">                if (game.getRoundCount() &lt; 1) {</span>
<span class="nc" id="L2780">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                } else {
<span class="nc" id="L2782">                    changePhase(IGame.Phase.PHASE_TARGETING);</span>
                }
<span class="nc" id="L2784">                break;</span>
            case PHASE_INITIATIVE:
<span class="nc" id="L2786">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2787">                detectSpacecraft();</span>
<span class="nc" id="L2788">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2789">                changePhase(IGame.Phase.PHASE_INITIATIVE_REPORT);</span>
<span class="nc" id="L2790">                break;</span>
            case PHASE_INITIATIVE_REPORT:
                // NOTE: now that aeros can come and go from the battlefield, I
                // need
                // to update the
                // deployment table every round. I think this it is OK to go
                // here.
                // (Taharqa)
<span class="nc" id="L2798">                game.setupRoundDeployment();</span>
                // boolean doDeploy = game.shouldDeployThisRound() &amp;&amp;
                // (game.getLastPhase() != IGame.Phase.PHASE_DEPLOYMENT);
<span class="nc bnc" id="L2801" title="All 2 branches missed.">                if (game.shouldDeployThisRound()) {</span>
<span class="nc" id="L2802">                    changePhase(IGame.Phase.PHASE_DEPLOYMENT);</span>
                } else {
<span class="nc" id="L2804">                    changePhase(IGame.Phase.PHASE_TARGETING);</span>
                }
<span class="nc" id="L2806">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc" id="L2808">                detectHiddenUnits();</span>
<span class="nc" id="L2809">                updateSpacecraftDetection();</span>
<span class="nc" id="L2810">                detectSpacecraft();</span>
<span class="nc" id="L2811">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2812">                doAllAssaultDrops();</span>
<span class="nc" id="L2813">                addMovementHeat();</span>
<span class="nc" id="L2814">                applyBuildingDamage();</span>
<span class="nc" id="L2815">                checkForPSRFromDamage();</span>
<span class="nc" id="L2816">                addReport(resolvePilotingRolls()); // Skids cause damage in</span>
                // movement phase
<span class="nc" id="L2818">                checkForFlamingDamage();</span>
<span class="nc" id="L2819">                checkForTeleMissileAttacks();</span>
<span class="nc" id="L2820">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2821">                checkForFlawedCooling();</span>
<span class="nc" id="L2822">                resolveCallSupport();</span>
                // check phase report
<span class="nc bnc" id="L2824" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2825">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2826">                    changePhase(IGame.Phase.PHASE_MOVEMENT_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2829">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2830">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2831">                    sendReport();</span>
<span class="nc" id="L2832">                    changePhase(IGame.Phase.PHASE_OFFBOARD);</span>
                }
<span class="nc" id="L2834">                break;</span>
            case PHASE_MOVEMENT_REPORT:
<span class="nc" id="L2836">                changePhase(IGame.Phase.PHASE_OFFBOARD);</span>
<span class="nc" id="L2837">                break;</span>
            case PHASE_FIRING:
                // write Weapon Attack Phase header
<span class="nc" id="L2840">                addReport(new Report(3000, Report.PUBLIC));</span>
<span class="nc" id="L2841">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2842">                resolveAllButWeaponAttacks();</span>
<span class="nc" id="L2843">                resolveSelfDestructions();</span>
<span class="nc" id="L2844">                reportGhostTargetRolls();</span>
<span class="nc" id="L2845">                reportLargeCraftECCMRolls();</span>
<span class="nc" id="L2846">                resolveOnlyWeaponAttacks();</span>
<span class="nc" id="L2847">                assignAMS();</span>
<span class="nc" id="L2848">                handleAttacks();</span>
<span class="nc" id="L2849">                resolveScheduledNukes();</span>
<span class="nc" id="L2850">                applyBuildingDamage();</span>
<span class="nc" id="L2851">                checkForPSRFromDamage();</span>
<span class="nc" id="L2852">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2853">                addReport(resolvePilotingRolls());</span>
<span class="nc" id="L2854">                checkForFlawedCooling();</span>
                // check phase report
<span class="nc bnc" id="L2856" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2857">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2858">                    changePhase(IGame.Phase.PHASE_FIRING_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2861">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2862">                    sendReport();</span>
<span class="nc" id="L2863">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2864">                    changePhase(IGame.Phase.PHASE_PHYSICAL);</span>
                }
<span class="nc" id="L2866">                break;</span>
            case PHASE_FIRING_REPORT:
<span class="nc" id="L2868">                changePhase(IGame.Phase.PHASE_PHYSICAL);</span>
<span class="nc" id="L2869">                break;</span>
            case PHASE_PHYSICAL:
<span class="nc" id="L2871">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2872">                resolvePhysicalAttacks();</span>
<span class="nc" id="L2873">                applyBuildingDamage();</span>
<span class="nc" id="L2874">                checkForPSRFromDamage();</span>
<span class="nc" id="L2875">                addReport(resolvePilotingRolls());</span>
<span class="nc" id="L2876">                resolveSinkVees();</span>
<span class="nc" id="L2877">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2878">                checkForFlawedCooling();</span>
<span class="nc" id="L2879">                checkForChainWhipGrappleChecks();</span>
                // check phase report
<span class="nc bnc" id="L2881" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2882">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2883">                    changePhase(IGame.Phase.PHASE_PHYSICAL_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2886">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2887">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2888">                    sendReport();</span>
<span class="nc" id="L2889">                    changePhase(IGame.Phase.PHASE_END);</span>
                }
<span class="nc" id="L2891">                break;</span>
            case PHASE_PHYSICAL_REPORT:
<span class="nc" id="L2893">                changePhase(IGame.Phase.PHASE_END);</span>
<span class="nc" id="L2894">                break;</span>
            case PHASE_TARGETING:
<span class="nc" id="L2896">                vPhaseReport.addElement(new Report(1035, Report.PUBLIC));</span>
<span class="nc" id="L2897">                resolveAllButWeaponAttacks();</span>
<span class="nc" id="L2898">                resolveOnlyWeaponAttacks();</span>
<span class="nc" id="L2899">                handleAttacks();</span>
                // check reports
<span class="nc bnc" id="L2901" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2902">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2903">                    changePhase(IGame.Phase.PHASE_TARGETING_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2906">                    vPhaseReport.addElement(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2907">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2908">                    sendReport();</span>
<span class="nc" id="L2909">                    changePhase(IGame.Phase.PHASE_MOVEMENT);</span>
                }

<span class="nc" id="L2912">                sendSpecialHexDisplayPackets();</span>
<span class="nc bnc" id="L2913" title="All 2 branches missed.">                for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L2914">                    IPlayer player = i.nextElement();</span>
<span class="nc" id="L2915">                    int connId = player.getId();</span>
<span class="nc" id="L2916">                    send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L2917">                }</span>

<span class="nc" id="L2919">                break;</span>
            case PHASE_OFFBOARD:
                // write Offboard Attack Phase header
<span class="nc" id="L2922">                addReport(new Report(1100, Report.PUBLIC));</span>
<span class="nc" id="L2923">                resolveAllButWeaponAttacks(); // torso twist or flip arms</span>
                // possible
<span class="nc" id="L2925">                resolveOnlyWeaponAttacks(); // should only be TAG at this point</span>
<span class="nc" id="L2926">                handleAttacks();</span>
<span class="nc bnc" id="L2927" title="All 2 branches missed.">                for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L2928">                    IPlayer player = i.nextElement();</span>
<span class="nc" id="L2929">                    int connId = player.getId();</span>
<span class="nc" id="L2930">                    send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L2931">                }</span>
<span class="nc" id="L2932">                applyBuildingDamage();</span>
<span class="nc" id="L2933">                checkForPSRFromDamage();</span>
<span class="nc" id="L2934">                addReport(resolvePilotingRolls());</span>

<span class="nc" id="L2936">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2937">                checkForFlawedCooling();</span>

<span class="nc" id="L2939">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2940">                sendTagInfoUpdates();</span>

                // check reports
<span class="nc bnc" id="L2943" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2944">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2945">                    changePhase(IGame.Phase.PHASE_OFFBOARD_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2948">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2949">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2950">                    sendReport();</span>
<span class="nc" id="L2951">                    changePhase(IGame.Phase.PHASE_FIRING);</span>
                }
<span class="nc" id="L2953">                break;</span>
            case PHASE_OFFBOARD_REPORT:
<span class="nc" id="L2955">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2956">                changePhase(IGame.Phase.PHASE_FIRING);</span>
<span class="nc" id="L2957">                break;</span>
            case PHASE_TARGETING_REPORT:
<span class="nc" id="L2959">                changePhase(IGame.Phase.PHASE_MOVEMENT);</span>
<span class="nc" id="L2960">                break;</span>
            case PHASE_END:
                // remove any entities that died in the heat/end phase before
                // checking for victory
<span class="nc" id="L2964">                resetEntityPhase(IGame.Phase.PHASE_END);</span>
<span class="nc" id="L2965">                boolean victory = victory(); // note this may add reports</span>
                // check phase report
                // HACK: hardcoded message ID check
<span class="nc bnc" id="L2968" title="All 4 branches missed.">                if ((vPhaseReport.size() &gt; 3) || ((vPhaseReport.size() &gt; 1)</span>
<span class="nc bnc" id="L2969" title="All 2 branches missed.">                        &amp;&amp; (vPhaseReport.elementAt(1).messageId != 1205))) {</span>
<span class="nc" id="L2970">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2971">                    changePhase(IGame.Phase.PHASE_END_REPORT);</span>
                } else {
                    // just the heat and end headers, so we'll add
                    // the &lt;nothing&gt; label
<span class="nc" id="L2975">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2976">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2977">                    sendReport();</span>
<span class="nc bnc" id="L2978" title="All 2 branches missed.">                    if (victory) {</span>
<span class="nc" id="L2979">                        changePhase(IGame.Phase.PHASE_VICTORY);</span>
                    } else {
<span class="nc" id="L2981">                        changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                    }
                }
                // Decrement the ASEWAffected counter
<span class="nc" id="L2985">                decrementASEWTurns();</span>

<span class="nc" id="L2987">                break;</span>
            case PHASE_END_REPORT:
<span class="nc bnc" id="L2989" title="All 2 branches missed.">                if (changePlayersTeam) {</span>
<span class="nc" id="L2990">                    processTeamChange();</span>
                }
<span class="nc bnc" id="L2992" title="All 2 branches missed.">                if (victory()) {</span>
<span class="nc" id="L2993">                    changePhase(IGame.Phase.PHASE_VICTORY);</span>
                } else {
<span class="nc" id="L2995">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                }
<span class="nc" id="L2997">                break;</span>
            case PHASE_VICTORY:
<span class="nc" id="L2999">                GameVictoryEvent gve = new GameVictoryEvent(this, game);</span>
<span class="nc" id="L3000">                game.processGameEvent(gve);</span>
<span class="nc" id="L3001">                transmitGameVictoryEventToAll();</span>
<span class="nc" id="L3002">                resetGame();</span>
<span class="nc" id="L3003">                break;</span>
            default:
        }

        // Any hidden units that activated this phase, should clear their
        // activating phase
<span class="nc bnc" id="L3009" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L3010" title="All 2 branches missed.">            if (ent.getHiddenActivationPhase() == game.getPhase()) {</span>
<span class="nc" id="L3011">                ent.setHiddeActivationPhase(null);</span>
            }
<span class="nc" id="L3013">        }</span>
<span class="nc" id="L3014">    }</span>

    private void sendSpecialHexDisplayPackets() {
<span class="nc bnc" id="L3017" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3018">            return;</span>
        }
<span class="nc bnc" id="L3020" title="All 2 branches missed.">        for (int i = 0; i &lt; connections.size(); i++) {</span>
<span class="nc bnc" id="L3021" title="All 2 branches missed.">            if (connections.get(i) != null) {</span>
<span class="nc" id="L3022">                connections.get(i).send(createSpecialHexDisplayPacket(i));</span>
            }
        }
<span class="nc" id="L3025">    }</span>

    private void sendTagInfoUpdates() {
<span class="nc bnc" id="L3028" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3029">            return;</span>
        }
<span class="nc bnc" id="L3031" title="All 2 branches missed.">        for (IConnection connection : connections) {</span>
<span class="nc bnc" id="L3032" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L3033">                connection.send(createTagInfoUpdatesPacket());</span>
            }
<span class="nc" id="L3035">        }</span>
<span class="nc" id="L3036">    }</span>

    public void sendTagInfoReset() {
<span class="nc bnc" id="L3039" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3040">            return;</span>
        }
<span class="nc bnc" id="L3042" title="All 2 branches missed.">        for (IConnection connection : connections) {</span>
<span class="nc bnc" id="L3043" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L3044">                connection.send(new Packet(Packet.COMMAND_RESET_TAGINFO));</span>
            }
<span class="nc" id="L3046">        }</span>
<span class="nc" id="L3047">    }</span>

    /**
     * Increment's the server's game round and send it to all the clients
     */
    private void incrementAndSendGameRound() {
<span class="nc" id="L3053">        game.incrementRoundCount();</span>
<span class="nc" id="L3054">        send(new Packet(Packet.COMMAND_ROUND_UPDATE, game.getRoundCount()));</span>
<span class="nc" id="L3055">    }</span>

    /**
     * Hand over a turn to the next player. This is only possible if you haven't
     * yet started your turn (i.e. not yet moved anything like infantry where
     * you have to move multiple units)
     *
     * @param connectionId - connection id of the player sending the packet
     */
    private void receiveForwardIni(int connectionId) {
        // this is the player sending the packet
<span class="nc" id="L3066">        IPlayer current = getPlayer(connectionId);</span>

<span class="nc bnc" id="L3068" title="All 2 branches missed.">        if (game.getTurn().getPlayerNum() != current.getId()) {</span>
            // this player is not the current player, so just ignore this
            // command!
<span class="nc" id="L3071">            return;</span>
        }
        // if individual initiative is active we cannot forward our initiative
        // ever!
<span class="nc bnc" id="L3075" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3076">            return;</span>
        }
        
        // if the player isn't on a team, there is no next team by definition. Skip the rest.
<span class="nc" id="L3080">        Team currentPlayerTeam = game.getTeamForPlayer(current);</span>
<span class="nc bnc" id="L3081" title="All 2 branches missed.">        if (currentPlayerTeam == null) {</span>
<span class="nc" id="L3082">            return;</span>
        }
        
        // get the next player from the team this player is on.
<span class="nc" id="L3086">        IPlayer next = currentPlayerTeam.getNextValidPlayer(current, game);</span>
        
<span class="nc bnc" id="L3088" title="All 2 branches missed.">        while (!next.equals(current)) {</span>
            // if the chosen player is a valid player, we change the turn order and
            // inform the clients.
<span class="nc bnc" id="L3091" title="All 4 branches missed.">            if ((next != null) &amp;&amp; (game.getEntitiesOwnedBy(next) != 0)</span>
<span class="nc bnc" id="L3092" title="All 2 branches missed.">                    &amp;&amp; (game.getTurnForPlayer(next.getId()) != null)) {</span>
    
<span class="nc" id="L3094">                int currentTurnIndex = game.getTurnIndex();</span>
                // now look for the next occurrence of player next in the turn order
<span class="nc" id="L3096">                List&lt;GameTurn&gt; turns = game.getTurnVector();</span>
<span class="nc" id="L3097">                GameTurn turn = game.getTurn();</span>
                // not entirely necessary. As we will also check this for the
                // activity of the button but to be sure do it on the server too.
<span class="nc bnc" id="L3100" title="All 6 branches missed.">                boolean isGeneralMoveTurn = !(turn instanceof GameTurn.SpecificEntityTurn)</span>
                        &amp;&amp; !(turn instanceof GameTurn.UnitNumberTurn)
                        &amp;&amp; !(turn instanceof GameTurn.UnloadStrandedTurn);
<span class="nc bnc" id="L3103" title="All 2 branches missed.">                if (!isGeneralMoveTurn) {</span>
                    // if this is not a general turn the player cannot forward his turn.
<span class="nc" id="L3105">                    return;</span>
                }
    
                // if it is an EntityClassTurn we have to check make sure, that the
                // turn it is exchanged with is the same kind of turn!
                // in fact this requires an access function to the mask of an
                // EntityClassTurn.
<span class="nc" id="L3112">                boolean isEntityClassTurn = (turn instanceof GameTurn.EntityClassTurn);</span>
<span class="nc" id="L3113">                int classMask = 0;</span>
<span class="nc bnc" id="L3114" title="All 2 branches missed.">                if (isEntityClassTurn) {</span>
<span class="nc" id="L3115">                    classMask = ((GameTurn.EntityClassTurn) turn).getTurnCode();</span>
                }
    
<span class="nc" id="L3118">                boolean switched = false;</span>
<span class="nc" id="L3119">                int nextTurnId = 0;</span>
<span class="nc bnc" id="L3120" title="All 2 branches missed.">                for (int i = currentTurnIndex; i &lt; turns.size(); i++) {</span>
                    // if we find a turn for the specific player, swap the current
                    // player with the player noted there
                    // and stop
<span class="nc bnc" id="L3124" title="All 2 branches missed.">                    if (turns.get(i).isValid(next.getId(), game)) {</span>
<span class="nc" id="L3125">                        nextTurnId = i;</span>
<span class="nc bnc" id="L3126" title="All 2 branches missed.">                        if (isEntityClassTurn) {</span>
                            // if we had an EntityClassTurn
<span class="nc bnc" id="L3128" title="All 2 branches missed.">                            if ((turns.get(i) instanceof GameTurn.EntityClassTurn)) {</span>
                                // and found another EntityClassTurn
<span class="nc bnc" id="L3130" title="All 2 branches missed.">                                if (!(((GameTurn.EntityClassTurn) turns.get(i)).getTurnCode() == classMask)) {</span>
                                    // both have to refer to the SAME class(es) or
                                    // they need to be rejected.
<span class="nc" id="L3133">                                    continue;</span>
                                }
                            } else {
                                continue;
                            }
                        }
<span class="nc" id="L3139">                        switched = true;</span>
<span class="nc" id="L3140">                        break;</span>
                    }
                }
    
                // update turn order
<span class="nc bnc" id="L3145" title="All 2 branches missed.">                if (switched) {</span>
<span class="nc" id="L3146">                    game.swapTurnOrder(currentTurnIndex, nextTurnId);</span>
                    // update the turn packages for all players.
<span class="nc" id="L3148">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L3149">                    send(createTurnIndexPacket(connectionId));</span>
<span class="nc" id="L3150">                    return;</span>
                }
                // if nothing changed return without doing anything
            }
            
<span class="nc" id="L3155">            next = currentPlayerTeam.getNextValidPlayer(next, game);</span>
        }
<span class="nc" id="L3157">    }</span>

    /**
     * Tries to change to the next turn. If there are no more turns, ends the
     * current phase. If the player whose turn it is next is not connected, we
     * allow the other players to skip that player.
     */
    private void changeToNextTurn(int prevPlayerId) {
<span class="nc bnc" id="L3165" title="All 2 branches missed.">        boolean minefieldPhase = game.getPhase() == IGame.Phase.PHASE_DEPLOY_MINEFIELDS;</span>
<span class="nc bnc" id="L3166" title="All 2 branches missed.">        boolean artyPhase = game.getPhase() == IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES;</span>
        
<span class="nc" id="L3168">        GameTurn nextTurn = null;</span>
<span class="nc" id="L3169">        Entity nextEntity = null;</span>
<span class="nc bnc" id="L3170" title="All 4 branches missed.">        while (game.hasMoreTurns() &amp;&amp; (null == nextEntity)) {</span>
<span class="nc" id="L3171">            nextTurn = game.changeToNextTurn();</span>
<span class="nc" id="L3172">            nextEntity = game.getEntity(game.getFirstEntityNum(nextTurn));</span>
<span class="nc bnc" id="L3173" title="All 4 branches missed.">            if (minefieldPhase || artyPhase) {</span>
<span class="nc" id="L3174">                break;</span>
            }
        }
   
        // if there aren't any more valid turns, end the phase
        // note that some phases don't use entities
<span class="nc bnc" id="L3180" title="All 8 branches missed.">        if (((null == nextEntity) &amp;&amp; !minefieldPhase) || ((null == nextTurn) &amp;&amp; minefieldPhase)) {</span>
<span class="nc" id="L3181">            endCurrentPhase();</span>
<span class="nc" id="L3182">            return;</span>
        }

<span class="nc" id="L3185">        IPlayer player = getPlayer(nextTurn.getPlayerNum());</span>

<span class="nc bnc" id="L3187" title="All 4 branches missed.">        if ((player != null) &amp;&amp; (game.getEntitiesOwnedBy(player) == 0)) {</span>
<span class="nc" id="L3188">            endCurrentTurn(null);</span>
<span class="nc" id="L3189">            return;</span>
        }

<span class="nc bnc" id="L3192" title="All 2 branches missed.">        if (prevPlayerId != -1) {</span>
<span class="nc" id="L3193">            send(createTurnIndexPacket(prevPlayerId));</span>
        } else {
<span class="nc bnc" id="L3195" title="All 2 branches missed.">            send(createTurnIndexPacket(player != null ? player.getId() : IPlayer.PLAYER_NONE));</span>
        }

<span class="nc bnc" id="L3198" title="All 4 branches missed.">        if ((null != player) &amp;&amp; player.isGhost()) {</span>
<span class="nc" id="L3199">            sendGhostSkipMessage(player);</span>
<span class="nc bnc" id="L3200" title="All 8 branches missed.">        } else if ((null == game.getFirstEntity()) &amp;&amp; (null != player) &amp;&amp; !minefieldPhase &amp;&amp; !artyPhase) {</span>
<span class="nc" id="L3201">            sendTurnErrorSkipMessage(player);</span>
        }
<span class="nc" id="L3203">    }</span>

    /**
     * Sends out a notification message indicating that a ghost player may be
     * skipped.
     *
     * @param ghost - the &lt;code&gt;Player&lt;/code&gt; who is ghosted. This value must not
     *              be &lt;code&gt;null&lt;/code&gt;.
     */
    private void sendGhostSkipMessage(IPlayer ghost) {
<span class="nc" id="L3213">        String message = &quot;Player '&quot; + ghost.getName() +</span>
                &quot;' is disconnected.  You may skip his/her current turn with the /skip command.&quot;;
<span class="nc" id="L3215">        sendServerChat(message);</span>
<span class="nc" id="L3216">    }</span>

    /**
     * Sends out a notification message indicating that the current turn is an
     * error and should be skipped.
     *
     * @param skip - the &lt;code&gt;Player&lt;/code&gt; who is to be skipped. This value
     *             must not be &lt;code&gt;null&lt;/code&gt;.
     */
    private void sendTurnErrorSkipMessage(IPlayer skip) {
<span class="nc" id="L3226">        String message = &quot;Player '&quot; + skip.getName() +</span>
                &quot;' has no units to move.  You should skip his/her/your current turn with the /skip command. &quot; +
                &quot;You may want to report this error at https://github.com/MegaMek/megamek/issues&quot;;
<span class="nc" id="L3229">        sendServerChat(message);</span>
<span class="nc" id="L3230">    }</span>

    /**
     * Skips the current turn. This only makes sense in phases that have turns.
     * Operates by finding an entity to move and then doing nothing with it.
     */
    public void skipCurrentTurn() {
        // find an entity to skip...
<span class="nc" id="L3238">        Entity toSkip = game.getFirstEntity();</span>

<span class="nc bnc" id="L3240" title="All 4 branches missed.">        switch (game.getPhase()) {</span>
            case PHASE_DEPLOYMENT:
                // allow skipping during deployment,
                // we need that when someone removes a unit.
<span class="nc" id="L3244">                endCurrentTurn(null);</span>
<span class="nc" id="L3245">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc bnc" id="L3247" title="All 2 branches missed.">                if (toSkip != null) {</span>
<span class="nc" id="L3248">                    processMovement(toSkip, new MovePath(game, toSkip), null);</span>
                }
<span class="nc" id="L3250">                endCurrentTurn(toSkip);</span>
<span class="nc" id="L3251">                break;</span>
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc bnc" id="L3256" title="All 2 branches missed.">                if (toSkip != null) {</span>
<span class="nc" id="L3257">                    processAttack(toSkip, new Vector&lt;&gt;(0));</span>
                }
<span class="nc" id="L3259">                endCurrentTurn(toSkip);</span>
<span class="nc" id="L3260">                break;</span>
            default:
        }
<span class="nc" id="L3263">    }</span>

    /**
     * Returns true if the current turn may be skipped. Ghost players' turns are
     * skippable, and a turn should be skipped if there's nothing to move.
     */
    public boolean isTurnSkippable() {
<span class="nc" id="L3270">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L3271" title="All 2 branches missed.">        if (null == turn) {</span>
<span class="nc" id="L3272">            return false;</span>
        }
<span class="nc" id="L3274">        IPlayer player = getPlayer(turn.getPlayerNum());</span>
<span class="nc bnc" id="L3275" title="All 6 branches missed.">        return (null == player) || player.isGhost() || (game.getFirstEntity() == null);</span>
    }

    /**
     * Returns true if victory conditions have been met. Victory conditions are
     * when there is only one player left with mechs or only one team. will also
     * add some reports to reporting
     */
    public boolean victory() {
<span class="nc" id="L3284">        VictoryResult vr = game.getVictory().checkForVictory(game, game.getVictoryContext());</span>
<span class="nc bnc" id="L3285" title="All 2 branches missed.">        for (Report r : vr.getReports()) {</span>
<span class="nc" id="L3286">            addReport(r);</span>
<span class="nc" id="L3287">        }</span>

<span class="nc bnc" id="L3289" title="All 2 branches missed.">        if (vr.victory()) {</span>
<span class="nc" id="L3290">            boolean draw = vr.isDraw();</span>
<span class="nc" id="L3291">            int wonPlayer = vr.getWinningPlayer();</span>
<span class="nc" id="L3292">            int wonTeam = vr.getWinningTeam();</span>

<span class="nc bnc" id="L3294" title="All 2 branches missed.">            if (wonPlayer != IPlayer.PLAYER_NONE) {</span>
<span class="nc" id="L3295">                Report r = new Report(7200, Report.PUBLIC);</span>
<span class="nc" id="L3296">                r.add(Server.getColorForPlayer(game.getPlayer(wonPlayer)));</span>
<span class="nc" id="L3297">                addReport(r);</span>
            }
<span class="nc bnc" id="L3299" title="All 2 branches missed.">            if (wonTeam != IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L3300">                Report r = new Report(7200, Report.PUBLIC);</span>
<span class="nc" id="L3301">                r.add(&quot;Team &quot; + wonTeam);</span>
<span class="nc" id="L3302">                addReport(r);</span>
            }
<span class="nc bnc" id="L3304" title="All 2 branches missed.">            if (draw) {</span>
                // multiple-won draw
<span class="nc" id="L3306">                game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L3307">                game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
            } else {
                // nobody-won draw or
                // single player won or
                // single team won
<span class="nc" id="L3312">                game.setVictoryPlayerId(wonPlayer);</span>
<span class="nc" id="L3313">                game.setVictoryTeam(wonTeam);</span>
            }
<span class="nc" id="L3315">        } else {</span>
<span class="nc" id="L3316">            game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L3317">            game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
<span class="nc bnc" id="L3318" title="All 2 branches missed.">            if (game.isForceVictory()) {</span>
<span class="nc" id="L3319">                cancelVictory();</span>
            }
        }
<span class="nc" id="L3322">        return vr.victory();</span>
    }// end victory

    private boolean isPlayerForcedVictory() {
        // check game options
<span class="nc bnc" id="L3327" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.VICTORY_SKIP_FORCED_VICTORY)) {</span>
<span class="nc" id="L3328">            return false;</span>
        }

<span class="nc bnc" id="L3331" title="All 2 branches missed.">        if (!game.isForceVictory()) {</span>
<span class="nc" id="L3332">            return false;</span>
        }

<span class="nc bnc" id="L3335" title="All 2 branches missed.">        for (IPlayer player : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L3336" title="All 4 branches missed.">            if ((player.getId() == game.getVictoryPlayerId()) || ((player.getTeam() == game.getVictoryTeam())</span>
<span class="nc bnc" id="L3337" title="All 2 branches missed.">                    &amp;&amp; (game.getVictoryTeam() != IPlayer.TEAM_NONE))) {</span>
<span class="nc" id="L3338">                continue;</span>
            }

<span class="nc bnc" id="L3341" title="All 2 branches missed.">            if (!player.admitsDefeat()) {</span>
<span class="nc" id="L3342">                return false;</span>
            }
<span class="nc" id="L3344">        }</span>

<span class="nc" id="L3346">        return true;</span>
    }

    /**
     * Applies board settings. This loads and combines all the boards that were
     * specified into one mega-board and sets that board as current.
     */
    public void applyBoardSettings() {
<span class="nc" id="L3354">        mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L3355">        mapSettings.replaceBoardWithRandom(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L3356">        IBoard[] sheetBoards = new IBoard[mapSettings.getMapWidth()</span>
<span class="nc" id="L3357">                * mapSettings.getMapHeight()];</span>
<span class="nc" id="L3358">        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3359">        for (int i = 0; i &lt; (mapSettings.getMapWidth() * mapSettings</span>
<span class="nc bnc" id="L3360" title="All 2 branches missed.">                .getMapHeight()); i++) {</span>
<span class="nc" id="L3361">            sheetBoards[i] = new Board();</span>
<span class="nc" id="L3362">            String name = mapSettings.getBoardsSelectedVector().get(i);</span>
<span class="nc" id="L3363">            boolean isRotated = false;</span>
<span class="nc bnc" id="L3364" title="All 2 branches missed.">            if (name.startsWith(Board.BOARD_REQUEST_ROTATION)) {</span>
                // only rotate boards with an even width
<span class="nc bnc" id="L3366" title="All 2 branches missed.">                if ((mapSettings.getBoardWidth() % 2) == 0) {</span>
<span class="nc" id="L3367">                    isRotated = true;</span>
                }
<span class="nc" id="L3369">                name = name.substring(Board.BOARD_REQUEST_ROTATION.length());</span>
            }
<span class="nc bnc" id="L3371" title="All 2 branches missed.">            if (name.startsWith(MapSettings.BOARD_GENERATED)</span>
<span class="nc bnc" id="L3372" title="All 2 branches missed.">                    || (mapSettings.getMedium() == MapSettings.MEDIUM_SPACE)) {</span>
<span class="nc" id="L3373">                sheetBoards[i] = BoardUtilities.generateRandom(mapSettings);</span>
            } else {
<span class="nc" id="L3375">                sheetBoards[i].load(new MegaMekFile(Configuration.boardsDir(), name</span>
<span class="nc" id="L3376">                        + &quot;.board&quot;).getFile());</span>
<span class="nc" id="L3377">                BoardUtilities.flip(sheetBoards[i], isRotated, isRotated);</span>
            }
<span class="nc" id="L3379">            rotateBoard.add(isRotated);</span>
        }
<span class="nc" id="L3381">        IBoard newBoard = BoardUtilities.combine(mapSettings.getBoardWidth(),</span>
<span class="nc" id="L3382">                mapSettings.getBoardHeight(), mapSettings.getMapWidth(),</span>
<span class="nc" id="L3383">                mapSettings.getMapHeight(), sheetBoards, rotateBoard,</span>
<span class="nc" id="L3384">                mapSettings.getMedium());</span>
<span class="nc bnc" id="L3385" title="All 2 branches missed.">        if (game.getOptions().getOption(OptionsConstants.BASE_BRIDGECF).intValue() &gt; 0) {</span>
<span class="nc" id="L3386">            newBoard.setBridgeCF(game.getOptions().getOption(OptionsConstants.BASE_BRIDGECF).intValue());</span>
        }
<span class="nc bnc" id="L3388" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_RANDOM_BASEMENTS)) {</span>
<span class="nc" id="L3389">            newBoard.setRandomBasementsOff();</span>
        }
<span class="nc bnc" id="L3391" title="All 2 branches missed.">        if (game.getPlanetaryConditions().isTerrainAffected()) {</span>
<span class="nc" id="L3392">            BoardUtilities.addWeatherConditions(newBoard, game.getPlanetaryConditions().getWeather(),</span>
<span class="nc" id="L3393">                    game.getPlanetaryConditions().getWindStrength());</span>
        }
<span class="nc" id="L3395">        game.setBoard(newBoard);</span>
<span class="nc" id="L3396">    }</span>

    /**
     * Rolls initiative for all the players.
     */
    private void rollInitiative() {
<span class="nc bnc" id="L3402" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3403">            TurnOrdered.rollInitiative(game.getEntitiesVector(), false);</span>
        } else {
            // Roll for initiative on the teams.
<span class="nc" id="L3406">            TurnOrdered.rollInitiative(game.getTeamsVector(),</span>
<span class="nc bnc" id="L3407" title="All 2 branches missed.">                    game.getOptions().booleanOption(OptionsConstants.INIT_INITIATIVE_STREAK_COMPENSATION)</span>
<span class="nc bnc" id="L3408" title="All 2 branches missed.">                    &amp;&amp; !game.shouldDeployThisRound());</span>
        }

<span class="nc" id="L3411">        transmitAllPlayerUpdates();</span>
<span class="nc" id="L3412">    }</span>

    private Vector&lt;GameTurn&gt; checkTurnOrderStranded(TurnVectors team_order) {
<span class="nc" id="L3415">        Vector&lt;GameTurn&gt; turns = new Vector&lt;&gt;(team_order.getTotalTurns()</span>
<span class="nc" id="L3416">                + team_order.getEvenTurns());</span>
        // Stranded units only during movement phases, rebuild the turns vector
<span class="nc bnc" id="L3418" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_MOVEMENT) {</span>
            // See if there are any loaded units stranded on immobile transports.
<span class="nc" id="L3420">            Iterator&lt;Entity&gt; strandedUnits = game.getSelectedEntities(</span>
<span class="nc" id="L3421">                    entity -&gt; game.isEntityStranded(entity));</span>
<span class="nc bnc" id="L3422" title="All 2 branches missed.">            if (strandedUnits.hasNext()) {</span>
                // Add a game turn to unload stranded units, if this
                // is the movement phase.
<span class="nc" id="L3425">                turns = new Vector&lt;&gt;(team_order.getTotalTurns()</span>
<span class="nc" id="L3426">                        + team_order.getEvenTurns() + 1);</span>
<span class="nc" id="L3427">                turns.addElement(new GameTurn.UnloadStrandedTurn(strandedUnits));</span>
            }
        }
<span class="nc" id="L3430">        return turns;</span>
    }

    /**
     * Determines the turn oder for a given phase (with individual init)
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase
     */
    private void determineTurnOrderIUI(IGame.Phase phase) {
<span class="nc bnc" id="L3439" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; loop = game.getEntities(); loop.hasNext();) {</span>
<span class="nc" id="L3440">            final Entity entity = loop.next();</span>
<span class="nc" id="L3441">            entity.resetOtherTurns();</span>
<span class="nc bnc" id="L3442" title="All 2 branches missed.">            if (entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L3443">                entity.incrementOtherTurns();</span>
            }
<span class="nc" id="L3445">        }</span>

        List&lt;Entity&gt; entities;
        // If the protos move multi option isn't on, protos move as a unit
        // Need to adjust entities vector otherwise we'll have too many turns
        // when first proto in a unit moves, new turns get added so rest of the
        // unit will move
<span class="nc" id="L3452">        boolean protosMoveMulti = game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_MULTI);
<span class="nc bnc" id="L3454" title="All 2 branches missed.">        if (!protosMoveMulti) {</span>
<span class="nc" id="L3455">            entities = new ArrayList&lt;&gt;(game.getEntitiesVector().size());</span>
<span class="nc" id="L3456">            Set&lt;Short&gt; movedUnits = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3457" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
                // This only effects Protos for the time being
<span class="nc bnc" id="L3459" title="All 2 branches missed.">                if (!(e instanceof Protomech)) {</span>
<span class="nc" id="L3460">                    entities.add(e);</span>
<span class="nc" id="L3461">                    continue;</span>
                }
<span class="nc" id="L3463">                short unitNumber = e.getUnitNumber();</span>
<span class="nc bnc" id="L3464" title="All 2 branches missed.">                if ((unitNumber == Entity.NONE)</span>
<span class="nc bnc" id="L3465" title="All 2 branches missed.">                        || !movedUnits.contains(unitNumber)) {</span>
<span class="nc" id="L3466">                    entities.add(e);</span>
<span class="nc bnc" id="L3467" title="All 2 branches missed.">                    if (unitNumber != Entity.NONE) {</span>
<span class="nc" id="L3468">                        movedUnits.add(unitNumber);</span>
                    }
                }
<span class="nc" id="L3471">            }</span>
<span class="nc" id="L3472">        } else {</span>
<span class="nc" id="L3473">            entities = game.getEntitiesVector();</span>
        }
        // Now, generate the global order of all teams' turns.
<span class="nc" id="L3476">        TurnVectors team_order = TurnOrdered.generateTurnOrder(entities, game);</span>

        // Now, we collect everything into a single vector.
<span class="nc" id="L3479">        Vector&lt;GameTurn&gt; turns = checkTurnOrderStranded(team_order);</span>

        // add the turns (this is easy)
<span class="nc bnc" id="L3482" title="All 2 branches missed.">        while (team_order.hasMoreElements()) {</span>
<span class="nc" id="L3483">            Entity e = (Entity) team_order.nextElement();</span>
<span class="nc bnc" id="L3484" title="All 2 branches missed.">            if (e.isSelectableThisTurn()) {</span>
<span class="nc bnc" id="L3485" title="All 6 branches missed.">                if (!protosMoveMulti &amp;&amp; (e instanceof Protomech) &amp;&amp; (e.getUnitNumber() != Entity.NONE)) {</span>
<span class="nc" id="L3486">                    turns.addElement(new GameTurn.UnitNumberTurn(e.getOwnerId(), e.getUnitNumber()));</span>
                } else {
<span class="nc" id="L3488">                    turns.addElement(new GameTurn.SpecificEntityTurn(e.getOwnerId(), e.getId()));</span>
                }
            }
<span class="nc" id="L3491">        }</span>

        // set fields in game
<span class="nc" id="L3494">        game.setTurnVector(turns);</span>
<span class="nc" id="L3495">        game.resetTurnIndex();</span>

        // send turns to all players
<span class="nc" id="L3498">        send(createTurnVectorPacket());</span>
<span class="nc" id="L3499">    }</span>

    /**
     * Determines the turn order for a given phase
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase
     */
    private void determineTurnOrder(IGame.Phase phase) {
<span class="nc bnc" id="L3507" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3508">            determineTurnOrderIUI(phase);</span>
<span class="nc" id="L3509">            return;</span>
        }
        // and/or deploy even according to game options.
<span class="nc bnc" id="L3512" title="All 2 branches missed.">        boolean infMoveEven = (game.getOptions().booleanOption(OptionsConstants.INIT_INF_MOVE_EVEN)</span>
<span class="nc bnc" id="L3513" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3514" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_MOVEMENT)))</span>
<span class="nc bnc" id="L3515" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.INIT_INF_DEPLOY_EVEN)</span>
<span class="nc bnc" id="L3516" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT));</span>
<span class="nc" id="L3517">        boolean infMoveMulti = game.getOptions()</span>
<span class="nc bnc" id="L3518" title="All 2 branches missed.">                .booleanOption(OptionsConstants.INIT_INF_MOVE_MULTI)</span>
<span class="nc bnc" id="L3519" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3520" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3521" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>
<span class="nc bnc" id="L3522" title="All 2 branches missed.">        boolean protosMoveEven = (game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_EVEN)
<span class="nc bnc" id="L3524" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3525" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3526" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))))</span>
<span class="nc bnc" id="L3527" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.INIT_PROTOS_MOVE_EVEN)</span>
<span class="nc bnc" id="L3528" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT));</span>
<span class="nc" id="L3529">        boolean protosMoveMulti = game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_MULTI);
<span class="nc bnc" id="L3531" title="All 2 branches missed.">        boolean protosMoveByPoint = !protosMoveMulti;</span>
<span class="nc bnc" id="L3532" title="All 2 branches missed.">        boolean tankMoveByLance = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT)
<span class="nc bnc" id="L3534" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3535" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3536" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>
<span class="nc bnc" id="L3537" title="All 2 branches missed.">        boolean mekMoveByLance = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT)
<span class="nc bnc" id="L3539" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3540" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3541" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>

<span class="nc" id="L3543">        int evenMask = 0;</span>
<span class="nc bnc" id="L3544" title="All 2 branches missed.">        if (infMoveEven) {</span>
<span class="nc" id="L3545">            evenMask += GameTurn.CLASS_INFANTRY;</span>
        }
<span class="nc bnc" id="L3547" title="All 2 branches missed.">        if (protosMoveEven) {</span>
<span class="nc" id="L3548">            evenMask += GameTurn.CLASS_PROTOMECH;</span>
        }
        // Reset all of the Players' turn category counts
<span class="nc bnc" id="L3551" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; loop = game.getPlayers(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L3552">            final IPlayer player = loop.nextElement();</span>
<span class="nc" id="L3553">            player.resetEvenTurns();</span>
<span class="nc" id="L3554">            player.resetMultiTurns();</span>
<span class="nc" id="L3555">            player.resetOtherTurns();</span>
<span class="nc" id="L3556">            player.resetSpaceStationTurns();</span>
<span class="nc" id="L3557">            player.resetJumpshipTurns();</span>
<span class="nc" id="L3558">            player.resetWarshipTurns();</span>
<span class="nc" id="L3559">            player.resetDropshipTurns();</span>
<span class="nc" id="L3560">            player.resetSmallCraftTurns();</span>
<span class="nc" id="L3561">            player.resetAeroTurns();</span>

            // Add turns for ProtoMechs weapons declaration.
<span class="nc bnc" id="L3564" title="All 2 branches missed.">            if (protosMoveByPoint) {</span>

                // How many ProtoMechs does the player have?
<span class="nc" id="L3567">                Iterator&lt;Entity&gt; playerProtos = game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L3568">                            private final int ownerId = player.getId();</span>

                            public boolean accept(Entity entity) {
<span class="nc bnc" id="L3571" title="All 2 branches missed.">                                return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L3572" title="All 2 branches missed.">                                        &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L3573" title="All 2 branches missed.">                                        &amp;&amp; entity.isSelectableThisTurn();</span>
                            }
                        });
<span class="nc" id="L3576">                HashSet&lt;Integer&gt; points = new HashSet&lt;&gt;();</span>
<span class="nc" id="L3577">                int numPlayerProtos = 0;</span>
<span class="nc bnc" id="L3578" title="All 2 branches missed.">                for (; playerProtos.hasNext(); ) {</span>
<span class="nc" id="L3579">                    Entity proto = playerProtos.next();</span>
<span class="nc" id="L3580">                    numPlayerProtos++;</span>
<span class="nc" id="L3581">                    points.add((int) proto.getUnitNumber());</span>
<span class="nc" id="L3582">                }</span>
<span class="nc" id="L3583">                int numProtoUnits = (int) Math.ceil(numPlayerProtos / 5.0);</span>
<span class="nc bnc" id="L3584" title="All 2 branches missed.">                if (!protosMoveEven) {</span>
<span class="nc" id="L3585">                    numProtoUnits = points.size();</span>
                }
<span class="nc bnc" id="L3587" title="All 2 branches missed.">                for (int unit = 0; unit &lt; numProtoUnits; unit++) {</span>
<span class="nc bnc" id="L3588" title="All 2 branches missed.">                    if (protosMoveEven) {</span>
<span class="nc" id="L3589">                        player.incrementEvenTurns();</span>
                    } else {
<span class="nc" id="L3591">                        player.incrementOtherTurns();</span>
                    }
                }

            } // End handle-proto-firing-turns

<span class="nc" id="L3597">        } // Handle the next player</span>

        // Go through all entities, and update the turn categories of the
        // entity's player. The teams get their totals from their players.
        // N.B. ProtoMechs declare weapons fire based on their point.
<span class="nc bnc" id="L3602" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; loop = game.getEntities(); loop.hasNext();) {</span>
<span class="nc" id="L3603">            final Entity entity = loop.next();</span>
<span class="nc bnc" id="L3604" title="All 2 branches missed.">            if (entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L3605">                final IPlayer player = entity.getOwner();</span>
<span class="nc bnc" id="L3606" title="All 2 branches missed.">                if ((entity instanceof SpaceStation)</span>
<span class="nc bnc" id="L3607" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3608" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3609">                    player.incrementSpaceStationTurns();</span>
<span class="nc bnc" id="L3610" title="All 2 branches missed.">                } else if ((entity instanceof Warship)</span>
<span class="nc bnc" id="L3611" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3612" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3613">                    player.incrementWarshipTurns();</span>
<span class="nc bnc" id="L3614" title="All 2 branches missed.">                } else if ((entity instanceof Jumpship)</span>
<span class="nc bnc" id="L3615" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3616" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3617">                    player.incrementJumpshipTurns();</span>
<span class="nc bnc" id="L3618" title="All 4 branches missed.">                } else if ((entity instanceof Dropship) &amp;&amp; entity.isAirborne()</span>
<span class="nc bnc" id="L3619" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3620" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3621">                    player.incrementDropshipTurns();</span>
<span class="nc bnc" id="L3622" title="All 4 branches missed.">                } else if ((entity instanceof SmallCraft) &amp;&amp; entity.isAirborne()</span>
<span class="nc bnc" id="L3623" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3624" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3625">                    player.incrementSmallCraftTurns();</span>
<span class="nc bnc" id="L3626" title="All 2 branches missed.">                } else if (entity.isAirborne()</span>
<span class="nc bnc" id="L3627" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3628" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3629">                    player.incrementAeroTurns();</span>
<span class="nc bnc" id="L3630" title="All 2 branches missed.">                } else if ((entity instanceof Infantry)) {</span>
<span class="nc bnc" id="L3631" title="All 2 branches missed.">                    if (infMoveEven) {</span>
<span class="nc" id="L3632">                        player.incrementEvenTurns();</span>
<span class="nc bnc" id="L3633" title="All 2 branches missed.">                    } else if (infMoveMulti) {</span>
<span class="nc" id="L3634">                        player.incrementMultiTurns(GameTurn.CLASS_INFANTRY);</span>
                    } else {
<span class="nc" id="L3636">                        player.incrementOtherTurns();</span>
                    }
<span class="nc bnc" id="L3638" title="All 2 branches missed.">                } else if (entity instanceof Protomech) {</span>
<span class="nc bnc" id="L3639" title="All 2 branches missed.">                    if (!protosMoveByPoint) {</span>
<span class="nc bnc" id="L3640" title="All 2 branches missed.">                        if (protosMoveEven) {</span>
<span class="nc" id="L3641">                            player.incrementEvenTurns();</span>
<span class="nc bnc" id="L3642" title="All 2 branches missed.">                        } else if (protosMoveMulti) {</span>
<span class="nc" id="L3643">                            player.incrementMultiTurns(GameTurn.CLASS_PROTOMECH);</span>
                        } else {
<span class="nc" id="L3645">                            player.incrementOtherTurns();</span>
                        }
                    }
<span class="nc bnc" id="L3648" title="All 4 branches missed.">                } else if ((entity instanceof Tank) &amp;&amp; tankMoveByLance) {</span>
<span class="nc" id="L3649">                    player.incrementMultiTurns(GameTurn.CLASS_TANK);</span>
<span class="nc bnc" id="L3650" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; mekMoveByLance) {</span>
<span class="nc" id="L3651">                    player.incrementMultiTurns(GameTurn.CLASS_MECH);</span>
                } else {
<span class="nc" id="L3653">                    player.incrementOtherTurns();</span>
                }
            }
<span class="nc" id="L3656">        }</span>

        // Generate the turn order for the Players *within*
        // each Team. Map the teams to their turn orders.
        // Count the number of teams moving this turn.
<span class="nc" id="L3661">        int nTeams = game.getNoOfTeams();</span>
<span class="nc" id="L3662">        Hashtable&lt;Team, TurnVectors&gt; allTeamTurns = new Hashtable&lt;&gt;(nTeams);</span>
<span class="nc" id="L3663">        Hashtable&lt;Team, int[]&gt; evenTrackers = new Hashtable&lt;&gt;(nTeams);</span>
<span class="nc" id="L3664">        int numTeamsMoving = 0;</span>
<span class="nc bnc" id="L3665" title="All 2 branches missed.">        for (Enumeration&lt;Team&gt; loop = game.getTeams(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L3666">            final Team team = loop.nextElement();</span>
<span class="nc" id="L3667">            allTeamTurns.put(team, team.determineTeamOrder(game));</span>

            // Track both the number of times we've checked the team for
            // &quot;leftover&quot; turns, and the number of &quot;leftover&quot; turns placed.
<span class="nc" id="L3671">            int[] evenTracker = new int[2];</span>
<span class="nc" id="L3672">            evenTrackers.put(team, evenTracker);</span>

            // Count this team if it has any &quot;normal&quot; moves.
<span class="nc bnc" id="L3675" title="All 2 branches missed.">            if (team.getNormalTurns(game) &gt; 0) {</span>
<span class="nc" id="L3676">                numTeamsMoving++;</span>
            }
<span class="nc" id="L3678">        }</span>

        // Now, generate the global order of all teams' turns.
<span class="nc" id="L3681">        TurnVectors team_order = TurnOrdered.generateTurnOrder(game.getTeamsVector(), game);</span>

        // Now, we collect everything into a single vector.
<span class="nc" id="L3684">        Vector&lt;GameTurn&gt; turns = checkTurnOrderStranded(team_order);</span>

        // Walk through the global order, assigning turns
        // for individual players to the single vector.
        // Keep track of how many turns we've added to the vector.
<span class="nc" id="L3689">        Team prevTeam = null;</span>
<span class="nc" id="L3690">        int min = team_order.getMin();</span>
<span class="nc bnc" id="L3691" title="All 2 branches missed.">        for (int numTurn = 0; team_order.hasMoreElements(); numTurn++) {</span>
<span class="nc" id="L3692">            Team team = (Team) team_order.nextElement();</span>
<span class="nc" id="L3693">            TurnVectors withinTeamTurns = allTeamTurns.get(team);</span>

<span class="nc" id="L3695">            int[] evenTracker = evenTrackers.get(team);</span>
<span class="nc" id="L3696">            float teamEvenTurns = team.getEvenTurns();</span>

            // Calculate the number of &quot;even&quot; turns to add for this team.
<span class="nc" id="L3699">            int numEven = 0;</span>
<span class="nc bnc" id="L3700" title="All 2 branches missed.">            if (1 == numTeamsMoving) {</span>
                // If there's only one team moving, we don't need to bother
                // with the evenTracker, just make sure the even turns are
                // evenly distributed
<span class="nc" id="L3704">                numEven += (int) Math.round(teamEvenTurns / min);</span>
<span class="nc bnc" id="L3705" title="All 2 branches missed.">            } else if (prevTeam == null) {</span>
                // Increment the number of times we've checked for &quot;leftovers&quot;.
<span class="nc" id="L3707">                evenTracker[0]++;</span>

                // The first team to move just adds the &quot;baseline&quot; turns.
<span class="nc" id="L3710">                numEven += Math.round(teamEvenTurns / min);</span>
<span class="nc bnc" id="L3711" title="All 2 branches missed.">            } else if (!team.equals(prevTeam)) {</span>
                // Increment the number of times we've checked for &quot;leftovers&quot;.
<span class="nc" id="L3713">                evenTracker[0]++;</span>

                // This weird equation attempts to spread the &quot;leftover&quot;
                // turns across the turn's moves in a &quot;fair&quot; manner.
                // It's based on the number of times we've checked for
                // &quot;leftovers&quot; the number of &quot;leftovers&quot; we started with,
                // the number of times we've added a turn for a &quot;leftover&quot;,
                // and the total number of times we're going to check.
<span class="nc" id="L3721">                numEven += (int) Math.ceil(((evenTracker[0] * (teamEvenTurns % min)) / min) - 0.5)</span>
                           - evenTracker[1];

                // Update the number of turns actually added for &quot;leftovers&quot;.
<span class="nc" id="L3725">                evenTracker[1] += numEven;</span>

                // Add the &quot;baseline&quot; number of turns.
<span class="nc" id="L3728">                numEven += Math.round(teamEvenTurns / min);</span>
            }

            // Record this team for the next move.
<span class="nc" id="L3732">            prevTeam = team;</span>

<span class="nc" id="L3734">            int aeroMask = GameTurn.CLASS_AERO + GameTurn.CLASS_SMALL_CRAFT</span>
                           + GameTurn.CLASS_DROPSHIP + GameTurn.CLASS_JUMPSHIP
                           + GameTurn.CLASS_WARSHIP + GameTurn.CLASS_SPACE_STATION;
            GameTurn turn;
            IPlayer player;
<span class="nc bnc" id="L3739" title="All 2 branches missed.">            if (withinTeamTurns.hasMoreNormalElements()) {</span>
                // Not a placeholder... get the player who moves next.
<span class="nc" id="L3741">                player = (IPlayer) withinTeamTurns.nextNormalElement();</span>

                // If we've added all &quot;normal&quot; turns, allocate turns
                // for the infantry and/or ProtoMechs moving even.
<span class="nc bnc" id="L3745" title="All 2 branches missed.">                if (numTurn &gt;= team_order.getTotalTurns()) {</span>
<span class="nc" id="L3746">                    turn = new GameTurn.EntityClassTurn(player.getId(), evenMask);</span>
                }
                // If either Infantry or ProtoMechs move even, only allow
                // the other classes to move during the &quot;normal&quot; turn.
<span class="nc bnc" id="L3750" title="All 4 branches missed.">                else if (infMoveEven || protosMoveEven) {</span>
<span class="nc" id="L3751">                    int newMask = evenMask;</span>
                    // if this is the movement phase, then don't allow Aeros on
                    // normal turns
<span class="nc bnc" id="L3754" title="All 2 branches missed.">                    if ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3755" title="All 2 branches missed.">                            || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3756">                        newMask += aeroMask;</span>
                    }
<span class="nc" id="L3758">                    turn = new GameTurn.EntityClassTurn(player.getId(), ~newMask);</span>
<span class="nc" id="L3759">                }</span>
                // Otherwise, let *anybody* move.
                else {
                    // well, almost anybody; Aero don't get normal turns during
                    // the movement phase
<span class="nc bnc" id="L3764" title="All 2 branches missed.">                    if ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3765" title="All 2 branches missed.">                            || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3766">                        turn = new GameTurn.EntityClassTurn(player.getId(), ~aeroMask);</span>
                    } else {
<span class="nc" id="L3768">                        turn = new GameTurn(player.getId());</span>
                    }
                }
<span class="nc" id="L3771">                turns.addElement(turn);</span>
            } // End team-has-&quot;normal&quot;-turns
<span class="nc bnc" id="L3773" title="All 2 branches missed.">            else if (withinTeamTurns.hasMoreSpaceStationElements()) {</span>
<span class="nc" id="L3774">                player = (IPlayer) withinTeamTurns.nextSpaceStationElement();</span>
<span class="nc" id="L3775">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_SPACE_STATION);</span>
<span class="nc" id="L3776">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3777" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreJumpshipElements()) {</span>
<span class="nc" id="L3778">                player = (IPlayer) withinTeamTurns.nextJumpshipElement();</span>
<span class="nc" id="L3779">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_JUMPSHIP);</span>
<span class="nc" id="L3780">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3781" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreWarshipElements()) {</span>
<span class="nc" id="L3782">                player = (IPlayer) withinTeamTurns.nextWarshipElement();</span>
<span class="nc" id="L3783">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_WARSHIP);</span>
<span class="nc" id="L3784">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3785" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreDropshipElements()) {</span>
<span class="nc" id="L3786">                player = (IPlayer) withinTeamTurns.nextDropshipElement();</span>
<span class="nc" id="L3787">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_DROPSHIP);</span>
<span class="nc" id="L3788">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3789" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreSmallCraftElements()) {</span>
<span class="nc" id="L3790">                player = (IPlayer) withinTeamTurns.nextSmallCraftElement();</span>
<span class="nc" id="L3791">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_SMALL_CRAFT);</span>
<span class="nc" id="L3792">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3793" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreAeroElements()) {</span>
<span class="nc" id="L3794">                player = (IPlayer) withinTeamTurns.nextAeroElement();</span>
<span class="nc" id="L3795">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_AERO);</span>
<span class="nc" id="L3796">                turns.addElement(turn);</span>
            }

            // Add the calculated number of &quot;even&quot; turns.
            // Allow the player at least one &quot;normal&quot; turn before the
            // &quot;even&quot; turns to help with loading infantry in deployment.
<span class="nc bnc" id="L3802" title="All 4 branches missed.">            while ((numEven &gt; 0) &amp;&amp; withinTeamTurns.hasMoreEvenElements()) {</span>
<span class="nc" id="L3803">                IPlayer evenPlayer = (IPlayer) withinTeamTurns.nextEvenElement();</span>
<span class="nc" id="L3804">                turns.addElement(new GameTurn.EntityClassTurn(evenPlayer.getId(), evenMask));</span>
<span class="nc" id="L3805">                numEven--;</span>
<span class="nc" id="L3806">            }</span>
        }

        // set fields in game
<span class="nc" id="L3810">        game.setTurnVector(turns);</span>
<span class="nc" id="L3811">        game.resetTurnIndex();</span>

        // send turns to all players
<span class="nc" id="L3814">        send(createTurnVectorPacket());</span>
<span class="nc" id="L3815">    }</span>

    private static String getColorForPlayer(IPlayer p) {
<span class="nc" id="L3818">        return &quot;&lt;B&gt;&lt;font color='&quot; + p.getColour().getHexString(0x00F0F0F0) + &quot;'&gt;&quot; + p.getName() + &quot;&lt;/font&gt;&lt;/B&gt;&quot;;</span>
    }

    /**
     * Write the initiative results to the report
     */
    private void writeInitiativeReport(boolean abbreviatedReport) {
        // write to report
        Report r;
<span class="nc" id="L3827">        boolean deployment = false;</span>
<span class="nc bnc" id="L3828" title="All 2 branches missed.">        if (!abbreviatedReport) {</span>
<span class="nc" id="L3829">            r = new Report(1210);</span>
<span class="nc" id="L3830">            r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L3831" title="All 4 branches missed.">            if ((game.getLastPhase() == IGame.Phase.PHASE_DEPLOYMENT) || game.isDeploymentComplete()</span>
<span class="nc bnc" id="L3832" title="All 2 branches missed.">                    || !game.shouldDeployThisRound()) {</span>
<span class="nc" id="L3833">                r.messageId = 1000;</span>
<span class="nc" id="L3834">                r.add(game.getRoundCount());</span>
            } else {
<span class="nc" id="L3836">                deployment = true;</span>
<span class="nc bnc" id="L3837" title="All 2 branches missed.">                if (game.getRoundCount() == 0) {</span>
<span class="nc" id="L3838">                    r.messageId = 1005;</span>
                } else {
<span class="nc" id="L3840">                    r.messageId = 1010;</span>
<span class="nc" id="L3841">                    r.add(game.getRoundCount());</span>
                }
            }
<span class="nc" id="L3844">            addReport(r);</span>
            // write separator
<span class="nc" id="L3846">            addReport(new Report(1200, Report.PUBLIC));</span>
        } else {
<span class="nc" id="L3848">            addReport(new Report(1210, Report.PUBLIC));</span>
        }

<span class="nc bnc" id="L3851" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3852">            r = new Report(1040, Report.PUBLIC);</span>
<span class="nc" id="L3853">            addReport(r);</span>
<span class="nc bnc" id="L3854" title="All 2 branches missed.">            for (Enumeration&lt;GameTurn&gt; e = game.getTurns(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L3855">                GameTurn t = e.nextElement();</span>
<span class="nc bnc" id="L3856" title="All 2 branches missed.">                if (t instanceof GameTurn.SpecificEntityTurn) {</span>
<span class="nc" id="L3857">                    Entity entity = game.getEntity(((GameTurn.SpecificEntityTurn) t).getEntityNum());</span>
<span class="nc" id="L3858">                    r = new Report(1045);</span>
<span class="nc" id="L3859">                    r.subject = entity.getId();</span>
<span class="nc" id="L3860">                    r.addDesc(entity);</span>
<span class="nc" id="L3861">                    r.add(entity.getInitiative().toString());</span>
<span class="nc" id="L3862">                    addReport(r);</span>
<span class="nc" id="L3863">                } else {</span>
<span class="nc" id="L3864">                    IPlayer player = getPlayer(t.getPlayerNum());</span>
<span class="nc bnc" id="L3865" title="All 2 branches missed.">                    if (null != player) {</span>
<span class="nc" id="L3866">                        r = new Report(1050, Report.PUBLIC);</span>
<span class="nc" id="L3867">                        r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L3868">                        addReport(r);</span>
                    }
                }
<span class="nc" id="L3871">            }</span>
        } else {
<span class="nc bnc" id="L3873" title="All 2 branches missed.">            for (Enumeration&lt;Team&gt; i = game.getTeams(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L3874">                final Team team = i.nextElement();</span>

                // Teams with no active players can be ignored
<span class="nc bnc" id="L3877" title="All 2 branches missed.">                if (team.isObserverTeam()) {</span>
<span class="nc" id="L3878">                    continue;</span>
                }

                // If there is only one non-observer player, list
                // them as the 'team', and use the team initiative
<span class="nc bnc" id="L3883" title="All 2 branches missed.">                if (team.getNonObserverSize() == 1) {</span>
<span class="nc" id="L3884">                    final IPlayer player = team.getNonObserverPlayers().nextElement();</span>
<span class="nc" id="L3885">                    r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3886">                    r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L3887">                    r.add(team.getInitiative().toString());</span>
<span class="nc" id="L3888">                    addReport(r);</span>
<span class="nc" id="L3889">                } else {</span>
                    // Multiple players. List the team, then break it down.
<span class="nc" id="L3891">                    r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3892">                    r.add(IPlayer.teamNames[team.getId()]);</span>
<span class="nc" id="L3893">                    r.add(team.getInitiative().toString());</span>
<span class="nc" id="L3894">                    addReport(r);</span>
<span class="nc bnc" id="L3895" title="All 2 branches missed.">                    for (Enumeration&lt;IPlayer&gt; j = team.getNonObserverPlayers(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L3896">                        final IPlayer player = j.nextElement();</span>
<span class="nc" id="L3897">                        r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3898">                        r.indent();</span>
<span class="nc" id="L3899">                        r.add(player.getName());</span>
<span class="nc" id="L3900">                        r.add(player.getInitiative().toString());</span>
<span class="nc" id="L3901">                        addReport(r);</span>
<span class="nc" id="L3902">                    }</span>
                }
<span class="nc" id="L3904">            }</span>

<span class="nc bnc" id="L3906" title="All 2 branches missed.">            if (!doBlind()) {</span>

                // The turn order is different in movement phase
                // if a player has any &quot;even&quot; moving units.
<span class="nc" id="L3910">                r = new Report(1020, Report.PUBLIC);</span>

<span class="nc" id="L3912">                boolean hasEven = false;</span>
<span class="nc bnc" id="L3913" title="All 2 branches missed.">                for (Enumeration&lt;GameTurn&gt; i = game.getTurns(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L3914">                    GameTurn turn = i.nextElement();</span>
<span class="nc" id="L3915">                    IPlayer player = getPlayer(turn.getPlayerNum());</span>
<span class="nc bnc" id="L3916" title="All 2 branches missed.">                    if (null != player) {</span>
<span class="nc" id="L3917">                        r.add(player.getName());</span>
<span class="nc bnc" id="L3918" title="All 2 branches missed.">                        if (player.getEvenTurns() &gt; 0) {</span>
<span class="nc" id="L3919">                            hasEven = true;</span>
                        }
                    }
<span class="nc" id="L3922">                }</span>
<span class="nc" id="L3923">                r.newlines = 2;</span>
<span class="nc" id="L3924">                addReport(r);</span>
<span class="nc bnc" id="L3925" title="All 2 branches missed.">                if (hasEven) {</span>
<span class="nc" id="L3926">                    r = new Report(1021, Report.PUBLIC);</span>
<span class="nc bnc" id="L3927" title="All 2 branches missed.">                    if ((game.getOptions().booleanOption(OptionsConstants.INIT_INF_DEPLOY_EVEN)</span>
<span class="nc bnc" id="L3928" title="All 2 branches missed.">                            || game.getOptions().booleanOption(OptionsConstants.INIT_PROTOS_MOVE_EVEN))</span>
<span class="nc bnc" id="L3929" title="All 2 branches missed.">                            &amp;&amp; !(game.getLastPhase() == IGame.Phase.PHASE_END_REPORT)) {</span>
<span class="nc" id="L3930">                        r.choose(true);</span>
                    } else {
<span class="nc" id="L3932">                        r.choose(false);</span>
                    }
<span class="nc" id="L3934">                    r.indent();</span>
<span class="nc" id="L3935">                    r.newlines = 2;</span>
<span class="nc" id="L3936">                    addReport(r);</span>
                }
            }

        }
<span class="nc bnc" id="L3941" title="All 2 branches missed.">        if (!abbreviatedReport) {</span>
            // we don't much care about wind direction and such in a hard vacuum
<span class="nc bnc" id="L3943" title="All 2 branches missed.">            if(!game.getBoard().inSpace()) {</span>
                // Wind direction and strength
<span class="nc" id="L3945">                Report rWindDir = new Report(1025, Report.PUBLIC);</span>
<span class="nc" id="L3946">                rWindDir.add(game.getPlanetaryConditions().getWindDirDisplayableName());</span>
<span class="nc" id="L3947">                rWindDir.newlines = 0;</span>
<span class="nc" id="L3948">                Report rWindStr = new Report(1030, Report.PUBLIC);</span>
<span class="nc" id="L3949">                rWindStr.add(game.getPlanetaryConditions().getWindDisplayableName());</span>
<span class="nc" id="L3950">                rWindStr.newlines = 0;</span>
<span class="nc" id="L3951">                Report rWeather = new Report(1031, Report.PUBLIC);</span>
<span class="nc" id="L3952">                rWeather.add(game.getPlanetaryConditions().getWeatherDisplayableName());</span>
<span class="nc" id="L3953">                rWeather.newlines = 0;</span>
<span class="nc" id="L3954">                Report rLight = new Report(1032, Report.PUBLIC);</span>
<span class="nc" id="L3955">                rLight.add(game.getPlanetaryConditions().getLightDisplayableName());</span>
<span class="nc" id="L3956">                Report rVis = new Report(1033, Report.PUBLIC);</span>
<span class="nc" id="L3957">                rVis.add(game.getPlanetaryConditions().getFogDisplayableName());</span>
<span class="nc" id="L3958">                addReport(rWindDir);</span>
<span class="nc" id="L3959">                addReport(rWindStr);</span>
<span class="nc" id="L3960">                addReport(rWeather);</span>
<span class="nc" id="L3961">                addReport(rLight);</span>
<span class="nc" id="L3962">                addReport(rVis);</span>
            }

<span class="nc bnc" id="L3965" title="All 2 branches missed.">            if (deployment) {</span>
<span class="nc" id="L3966">                addNewLines();</span>
            }
        }
<span class="nc" id="L3969">    }</span>

    private void applyDropShipLandingDamage(Coords centralPos, Entity killer) {
        // first cycle through hexes to figure out final elevation
<span class="nc" id="L3973">        IHex centralHex = game.getBoard().getHex(centralPos);</span>
<span class="nc bnc" id="L3974" title="All 2 branches missed.">        if (null == centralHex) {</span>
            // shouldn't happen
<span class="nc" id="L3976">            return;</span>
        }
<span class="nc" id="L3978">        int finalElev = centralHex.getLevel();</span>
<span class="nc bnc" id="L3979" title="All 2 branches missed.">        if (!centralHex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L3980" title="All 2 branches missed.">            &amp;&amp; !centralHex.containsTerrain(Terrains.ROAD)) {</span>
<span class="nc" id="L3981">            finalElev--;</span>
        }
<span class="nc" id="L3983">        Vector&lt;Coords&gt; positions = new Vector&lt;&gt;();</span>
<span class="nc" id="L3984">        positions.add(centralPos);</span>
<span class="nc bnc" id="L3985" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L3986">            Coords pos = centralPos.translated(i);</span>
<span class="nc" id="L3987">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L3988" title="All 2 branches missed.">            if (null == hex) {</span>
<span class="nc" id="L3989">                continue;</span>
            }
<span class="nc bnc" id="L3991" title="All 2 branches missed.">            if (hex.getLevel() &lt; finalElev) {</span>
<span class="nc" id="L3992">                finalElev = hex.getLevel();</span>
            }
<span class="nc" id="L3994">            positions.add(pos);</span>
        }
        // ok now cycle through hexes and make all changes
<span class="nc bnc" id="L3997" title="All 2 branches missed.">        for (Coords pos : positions) {</span>
<span class="nc" id="L3998">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc" id="L3999">            hex.setLevel(finalElev);</span>
            // get rid of woods and replace with rough
<span class="nc bnc" id="L4001" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L4002">                hex.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L4003">                hex.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L4004">                hex.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L4005">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.ROUGH, 1));</span>
            }
<span class="nc" id="L4007">            sendChangedHex(pos);</span>
<span class="nc" id="L4008">        }</span>

<span class="nc" id="L4010">        applyDropShipProximityDamage(centralPos, killer);</span>
<span class="nc" id="L4011">    }</span>

    private void applyDropShipProximityDamage(Coords centralPos, Entity killer) {
<span class="nc" id="L4014">        applyDropShipProximityDamage(centralPos, false, 0, killer);</span>
<span class="nc" id="L4015">    }</span>

    /**
     * apply damage to units and buildings within a certain radius of a landing
     * or lifting off DropShip
     *
     * @param centralPos - the Coords for the central position of the DropShip
     */
    private void applyDropShipProximityDamage(Coords centralPos, boolean rearArc, int facing,
                                              Entity killer) {

<span class="nc" id="L4026">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>

        // anything in the central hex or adjacent hexes is destroyed
<span class="nc" id="L4029">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>
<span class="nc bnc" id="L4030" title="All 2 branches missed.">        for (Entity en : game.getEntitiesVector(centralPos)) {</span>
<span class="nc bnc" id="L4031" title="All 2 branches missed.">            if (!en.isAirborne()) {</span>
<span class="nc" id="L4032">                addReport(destroyEntity(en, &quot;DropShip proximity damage&quot;, false,</span>
                                        false));
<span class="nc" id="L4034">                alreadyHit.add(en.getId());</span>
            }
<span class="nc" id="L4036">        }</span>
<span class="nc" id="L4037">        Building bldg = game.getBoard().getBuildingAt(centralPos);</span>
<span class="nc bnc" id="L4038" title="All 2 branches missed.">        if (null != bldg) {</span>
<span class="nc" id="L4039">            collapseBuilding(bldg, positionMap, centralPos, vPhaseReport);</span>
        }
<span class="nc bnc" id="L4041" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4042">            Coords pos = centralPos.translated(i);</span>
<span class="nc bnc" id="L4043" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector(pos)) {</span>
<span class="nc bnc" id="L4044" title="All 2 branches missed.">                if (!en.isAirborne()) {</span>
<span class="nc" id="L4045">                    addReport(destroyEntity(en, &quot;DropShip proximity damage&quot;,</span>
                                            false, false));
                }
<span class="nc" id="L4048">                alreadyHit.add(en.getId());</span>
<span class="nc" id="L4049">            }</span>
<span class="nc" id="L4050">            bldg = game.getBoard().getBuildingAt(pos);</span>
<span class="nc bnc" id="L4051" title="All 2 branches missed.">            if (null != bldg) {</span>
<span class="nc" id="L4052">                collapseBuilding(bldg, positionMap, pos, vPhaseReport);</span>
            }
        }

        // Report r;
        // ok now I need to look at the damage rings - start at 2 and go to 7
<span class="nc bnc" id="L4058" title="All 2 branches missed.">        for (int i = 2; i &lt; 8; i++) {</span>
<span class="nc" id="L4059">            int damageDice = (8 - i) * 2;</span>
<span class="nc" id="L4060">            List&lt;Coords&gt; ring = centralPos.allAtDistance(i);</span>
<span class="nc bnc" id="L4061" title="All 2 branches missed.">            for (Coords pos : ring) {</span>
<span class="nc bnc" id="L4062" title="All 4 branches missed.">                if (rearArc &amp;&amp; !Compute.isInArc(centralPos, facing, pos, Compute.ARC_AFT)) {</span>
<span class="nc" id="L4063">                    continue;</span>
                }

<span class="nc" id="L4066">                alreadyHit = artilleryDamageHex(pos, centralPos, damageDice, null, killer.getId(),</span>
                        killer, null, false, 0, vPhaseReport, false,
                        alreadyHit, true);
<span class="nc" id="L4069">            }</span>
        }
<span class="nc" id="L4071">        destroyDoomedEntities(alreadyHit);</span>
<span class="nc" id="L4072">    }</span>

    /**
     * Marks ineligible entities as not ready for this phase
     */
    private void setIneligible(IGame.Phase phase) {
<span class="nc" id="L4078">        Vector&lt;Entity&gt; assistants = new Vector&lt;&gt;();</span>
<span class="nc" id="L4079">        boolean assistable = false;</span>

<span class="nc bnc" id="L4081" title="All 2 branches missed.">        if (isPlayerForcedVictory()) {</span>
<span class="nc" id="L4082">            assistants.addAll(game.getEntitiesVector());</span>
        } else {
<span class="nc bnc" id="L4084" title="All 2 branches missed.">            for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L4085" title="All 2 branches missed.">                if (entity.isEligibleFor(phase)) {</span>
<span class="nc" id="L4086">                    assistable = true;</span>
                } else {
<span class="nc" id="L4088">                    assistants.addElement(entity);</span>
                }
<span class="nc" id="L4090">            }</span>
        }
<span class="nc bnc" id="L4092" title="All 2 branches missed.">        for (Entity assistant : assistants) {</span>
<span class="nc bnc" id="L4093" title="All 4 branches missed.">            if (!assistable || !assistant.canAssist(phase)) {</span>
<span class="nc" id="L4094">                assistant.setDone(true);</span>
            }
<span class="nc" id="L4096">        }</span>
<span class="nc" id="L4097">    }</span>

    /**
     * Have the loader load the indicated unit. The unit being loaded loses its
     * turn.
     *
     * @param loader - the &lt;code&gt;Entity&lt;/code&gt; that is loading the unit.
     * @param unit   - the &lt;code&gt;Entity&lt;/code&gt; being loaded.
     */
    private void loadUnit(Entity loader, Entity unit, int bayNumber) {
        // ProtoMechs share a single turn for a Point. When loading one we don't remove its turn
        // unless it's the last unit in the Point to act.
<span class="nc" id="L4109">        int remainingProtos = 0;</span>
<span class="nc bnc" id="L4110" title="All 2 branches missed.">        if (unit.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc bnc" id="L4111" title="All 2 branches missed.">            remainingProtos = game.getSelectedEntityCount(en -&gt; en.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="nc bnc" id="L4112" title="All 2 branches missed.">                    &amp;&amp; en.getId() != unit.getId()</span>
<span class="nc bnc" id="L4113" title="All 2 branches missed.">                    &amp;&amp; en.isSelectableThisTurn()</span>
<span class="nc bnc" id="L4114" title="All 2 branches missed.">                    &amp;&amp; en.getOwnerId() == unit.getOwnerId()</span>
<span class="nc bnc" id="L4115" title="All 2 branches missed.">                    &amp;&amp; en.getUnitNumber() == unit.getUnitNumber());</span>
        }

<span class="nc bnc" id="L4118" title="All 6 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; !unit.isDone()</span>
                &amp;&amp; (remainingProtos == 0)) {
            // Remove the *last* friendly turn (removing the *first* penalizes
            // the opponent too much, and re-calculating moves is too hard).
<span class="nc" id="L4122">            game.removeTurnFor(unit);</span>
<span class="nc" id="L4123">            send(createTurnVectorPacket());</span>
        }

        // When loading an Aero into a squadron in the lounge, make sure the
        // loaded aero has the same bomb loadout as the squadron
        // We want to do this before the fighter is loaded: when the fighter
        // is loaded into the squadron, the squadrons bombing attacks are
        // adjusted based on the bomb-loadout on the fighter.
<span class="nc bnc" id="L4131" title="All 4 branches missed.">        if ((game.getPhase() == Phase.PHASE_LOUNGE)</span>
            &amp;&amp; (loader instanceof FighterSquadron)) {
<span class="nc" id="L4133">            ((IBomber) unit).setBombChoices(((FighterSquadron) loader)</span>
<span class="nc" id="L4134">                                                 .getBombChoices());</span>
        }

        // Load the unit. Do not check for elevation during deployment
<span class="nc bnc" id="L4138" title="All 2 branches missed.">        boolean checkElevation = (game.getPhase() != Phase.PHASE_DEPLOYMENT)</span>
<span class="nc bnc" id="L4139" title="All 2 branches missed.">                                 &amp;&amp; (game.getPhase() != Phase.PHASE_LOUNGE);</span>
<span class="nc bnc" id="L4140" title="All 2 branches missed.">        if (bayNumber == -1) {</span>
<span class="nc" id="L4141">            loader.load(unit, checkElevation);</span>
        } else {
<span class="nc" id="L4143">            loader.load(unit, checkElevation, bayNumber);</span>
        }

        // The loaded unit is being carried by the loader.
<span class="nc" id="L4147">        unit.setTransportId(loader.getId());</span>

        // Remove the loaded unit from the screen.
<span class="nc" id="L4150">        unit.setPosition(null);</span>

        // set deployment round of the loadee to equal that of the loader
<span class="nc" id="L4153">        unit.setDeployRound(loader.getDeployRound());</span>
        
        //Update the loading unit's passenger count, if it's a large craft
<span class="nc bnc" id="L4156" title="All 4 branches missed.">        if (loader instanceof SmallCraft || loader instanceof Jumpship) {</span>
            //Don't add dropship crew to a jumpship or station's passenger list
<span class="nc bnc" id="L4158" title="All 2 branches missed.">            if (!unit.isLargeCraft()) {</span>
<span class="nc" id="L4159">                loader.setNPassenger(loader.getNPassenger() + unit.getCrew().getSize());</span>
            }
        }

        // Update the loaded unit.
<span class="nc" id="L4164">        entityUpdate(unit.getId());</span>

        // Taharqa (2/28/13): I am not sure why the loader is not getting
        // updated too - not updating it
        // is causing problem in the chat lounge loading, so I am going to do it
        // here, but if we get
        // weird results for other loading, then the reason is probably this
<span class="nc" id="L4171">        entityUpdate(loader.getId());</span>
<span class="nc" id="L4172">    }</span>

    /**
     * Have the loader tow the indicated unit. The unit being towed loses its
     * turn.
     *
     * @param loader - the &lt;code&gt;Entity&lt;/code&gt; that is towing the unit.
     * @param unit   - the &lt;code&gt;Entity&lt;/code&gt; being towed.
     */
    private void towUnit(Entity loader, Entity unit) {
<span class="nc bnc" id="L4182" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; !unit.isDone()) {</span>
            // Remove the *last* friendly turn (removing the *first* penalizes
            // the opponent too much, and re-calculating moves is too hard).
<span class="nc" id="L4185">            game.removeTurnFor(unit);</span>
<span class="nc" id="L4186">            send(createTurnVectorPacket());</span>
        }

<span class="nc" id="L4189">        loader.towUnit(unit.getId());</span>

        // set deployment round of the loadee to equal that of the loader
<span class="nc" id="L4192">        unit.setDeployRound(loader.getDeployRound());</span>

        // Update the loader and towed units.
<span class="nc" id="L4195">        entityUpdate(unit.getId());</span>
<span class="nc" id="L4196">        entityUpdate(loader.getId());</span>
<span class="nc" id="L4197">    }</span>

    /**
     * Have the tractor drop the indicated trailer. This will also disconnect all
     * trailers that follow the one dropped.
     *
     * @param tractor
     *            - the &lt;code&gt;Entity&lt;/code&gt; that is disconnecting the trailer.
     * @param unloaded
     *            - the &lt;code&gt;Targetable&lt;/code&gt; unit being unloaded.
     * @param pos
     *            - the &lt;code&gt;Coords&lt;/code&gt; for the unloaded unit.
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was successfully unloaded,
     *         &lt;code&gt;false&lt;/code&gt; if the trailer isn't carried by tractor.
     */
    private boolean disconnectUnit(Entity tractor, Targetable unloaded, Coords pos) {

        // We can only unload Entities.
        Entity trailer;
<span class="nc bnc" id="L4216" title="All 2 branches missed.">        if (unloaded instanceof Entity) {</span>
<span class="nc" id="L4217">            trailer = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4219">            return false;</span>
        }
        // disconnectUnit() updates anything behind 'trailer' too, so copy
        // the list of trailers before we alter it so entityUpdate() can be
        // run on all of them. Also, add the entity towing Trailer to the list
<span class="nc" id="L4224">        List&lt;Integer&gt; trailerList = new ArrayList&lt;&gt;(trailer.getConnectedUnits());</span>
<span class="nc" id="L4225">        trailerList.add(trailer.getTowedBy());</span>

        // Unload the unit.
<span class="nc" id="L4228">        tractor.disconnectUnit(trailer.getId());</span>

        // Update the tractor and all affected trailers.
<span class="nc bnc" id="L4231" title="All 2 branches missed.">        for (int id : trailerList) {</span>
<span class="nc" id="L4232">            entityUpdate(id);</span>
<span class="nc" id="L4233">        }</span>
<span class="nc" id="L4234">        entityUpdate(trailer.getId());</span>
<span class="nc" id="L4235">        entityUpdate(tractor.getId());</span>

        // Unloaded successfully.
<span class="nc" id="L4238">        return true;</span>
    }

    private boolean unloadUnit(Entity unloader, Targetable unloaded,
                               Coords pos, int facing, int elevation) {
<span class="nc" id="L4243">        return unloadUnit(unloader, unloaded, pos, facing, elevation, false,</span>
                false);
    }

    /**
     * Have the unloader unload the indicated unit. The unit being unloaded may
     * or may not gain a turn
     *
     * @param unloader
     *            - the &lt;code&gt;Entity&lt;/code&gt; that is unloading the unit.
     * @param unloaded
     *            - the &lt;code&gt;Targetable&lt;/code&gt; unit being unloaded.
     * @param pos
     *            - the &lt;code&gt;Coords&lt;/code&gt; for the unloaded unit.
     * @param facing
     *            - the &lt;code&gt;int&lt;/code&gt; facing for the unloaded unit.
     * @param elevation
     *            - the &lt;code&gt;int&lt;/code&gt; elevation at which to unload, if both
     *            loader and loaded units use VTOL movement.
     * @param evacuation
     *            - a &lt;code&gt;boolean&lt;/code&gt; indicating whether this unit is being
     *            unloaded as a result of its carrying units destruction
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was successfully unloaded,
     *         &lt;code&gt;false&lt;/code&gt; if the unit isn't carried in unloader.
     */
    private boolean unloadUnit(Entity unloader, Targetable unloaded,
            Coords pos, int facing, int elevation, boolean evacuation,
            boolean duringDeployment) {

        // We can only unload Entities.
        Entity unit;
<span class="nc bnc" id="L4274" title="All 2 branches missed.">        if (unloaded instanceof Entity) {</span>
<span class="nc" id="L4275">            unit = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4277">            return false;</span>
        }

        // Unload the unit.
<span class="nc bnc" id="L4281" title="All 2 branches missed.">        if (!unloader.unload(unit)) {</span>
<span class="nc" id="L4282">            return false;</span>
        }

        // The unloaded unit is no longer being carried.
<span class="nc" id="L4286">        unit.setTransportId(Entity.NONE);</span>

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4289">        unit.setPosition(pos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4292" title="All 2 branches missed.">        if (pos != null) {</span>
<span class="nc" id="L4293">            unit.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4297">        unit.setFacing(facing);</span>
<span class="nc" id="L4298">        unit.setSecondaryFacing(facing);</span>

<span class="nc" id="L4300">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L4301" title="All 2 branches missed.">        boolean isBridge = (hex != null)</span>
<span class="nc bnc" id="L4302" title="All 2 branches missed.">                &amp;&amp; hex.containsTerrain(Terrains.PAVEMENT);</span>

<span class="nc bnc" id="L4304" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L4305">            unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4306" title="All 2 branches missed.">        } else if (unloader.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L4307" title="All 2 branches missed.">            if (unit.getMovementMode() == EntityMovementMode.VTOL) {</span>
                // Flying units unload to the same elevation as the flying
                // transport
<span class="nc" id="L4310">                unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4311" title="All 2 branches missed.">            } else if (game.getBoard().getBuildingAt(pos) != null) {</span>
                // non-flying unit unloaded from a flying onto a building
                // -&gt; sit on the roof
<span class="nc" id="L4314">                unit.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
            } else {
<span class="nc bnc" id="L4316" title="All 2 branches missed.">                while (elevation &gt;= -hex.depth()) {</span>
<span class="nc bnc" id="L4317" title="All 2 branches missed.">                    if (unit.isElevationValid(elevation, hex)) {</span>
<span class="nc" id="L4318">                        unit.setElevation(elevation);</span>
<span class="nc" id="L4319">                        break;</span>
                    }
<span class="nc" id="L4321">                    elevation--;</span>
                    // If unit is landed, the while loop breaks before here
                    // And unit.moved will be MOVE_NONE
                    // If we can jump, use jump
<span class="nc bnc" id="L4325" title="All 2 branches missed.">                    if (unit.getJumpMP() &gt; 0) {</span>
<span class="nc" id="L4326">                        unit.moved = EntityMovementType.MOVE_JUMP;</span>
                    } else { // Otherwise, use walk trigger check for ziplines
<span class="nc" id="L4328">                        unit.moved = EntityMovementType.MOVE_WALK;</span>
                    }
                }
<span class="nc bnc" id="L4331" title="All 2 branches missed.">                if (!unit.isElevationValid(elevation, hex)) {</span>
<span class="nc" id="L4332">                    return false;</span>
                }
            }
<span class="nc bnc" id="L4335" title="All 2 branches missed.">        } else if (game.getBoard().getBuildingAt(pos) != null) {</span>
            // non flying unit unloading units into a building
            // -&gt; sit in the building at the same elevation
<span class="nc" id="L4338">            unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4339" title="All 2 branches missed.">        } else if (hex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
<span class="nc bnc" id="L4340" title="All 2 branches missed.">            if ((unit.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L4341" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L4342" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L4343" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L4344" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L4345" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L4346" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.ICE) || isBridge) {</span>
                // units that can float stay on the surface, or we go on the
                // bridge
                // this means elevation 0, because elevation is relative to the
                // surface
<span class="nc" id="L4351">                unit.setElevation(0);</span>
            }
        } else {
            // default to the floor of the hex.
            // unit elevation is relative to the surface
<span class="nc" id="L4356">            unit.setElevation(hex.floor() - hex.surface());</span>
        }

        // Check for zip lines PSR -- MOVE_WALK implies ziplines
<span class="nc bnc" id="L4360" title="All 2 branches missed.">        if (unit.moved == EntityMovementType.MOVE_WALK) {</span>
<span class="nc bnc" id="L4361" title="All 4 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_ZIPLINES)</span>
                    &amp;&amp; (unit instanceof Infantry)
<span class="nc bnc" id="L4363" title="All 2 branches missed.">                    &amp;&amp; !((Infantry) unit).isMechanized()) {</span>

               // Handle zip lines
<span class="nc" id="L4366">                PilotingRollData psr = getEjectModifiers(game, unit, 0, false,</span>
<span class="nc" id="L4367">                        unit.getPosition(), &quot;Anti-mek skill&quot;);</span>
                // Factor in Elevation
<span class="nc bnc" id="L4369" title="All 2 branches missed.">                if (unloader.getElevation() &gt; 0) {</span>
<span class="nc" id="L4370">                    psr.addModifier(unloader.getElevation(), &quot;elevation&quot;);</span>
                }
<span class="nc" id="L4372">                int roll = Compute.d6(2);</span>

                // Report ziplining
<span class="nc" id="L4375">                Report r = new Report(9920);</span>
<span class="nc" id="L4376">                r.subject = unit.getId();</span>
<span class="nc" id="L4377">                r.addDesc(unit);</span>
<span class="nc" id="L4378">                r.newlines = 0;</span>
<span class="nc" id="L4379">                addReport(r);</span>

                // Report TN
<span class="nc" id="L4382">                r = new Report(9921);</span>
<span class="nc" id="L4383">                r.subject = unit.getId();</span>
<span class="nc" id="L4384">                r.add(psr.getValue());</span>
<span class="nc" id="L4385">                r.add(psr.getDesc());</span>
<span class="nc" id="L4386">                r.add(roll);</span>
<span class="nc" id="L4387">                r.newlines = 0;</span>
<span class="nc" id="L4388">                addReport(r);</span>

<span class="nc bnc" id="L4390" title="All 2 branches missed.">                if (roll &lt; psr.getValue()) { // Failure!</span>
<span class="nc" id="L4391">                    r = new Report(9923);</span>
<span class="nc" id="L4392">                    r.subject = unit.getId();</span>
<span class="nc" id="L4393">                    r.add(psr.getValue());</span>
<span class="nc" id="L4394">                    r.add(roll);</span>
<span class="nc" id="L4395">                    addReport(r);</span>

<span class="nc" id="L4397">                    HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4398">                    hit.setIgnoreInfantryDoubleDamage(true);</span>
<span class="nc" id="L4399">                    addReport(damageEntity(unit, hit, 5));</span>
<span class="nc" id="L4400">                } else { //  Report success</span>
<span class="nc" id="L4401">                    r = new Report(9922);</span>
<span class="nc" id="L4402">                    r.subject = unit.getId();</span>
<span class="nc" id="L4403">                    r.add(psr.getValue());</span>
<span class="nc" id="L4404">                    r.add(roll);</span>
<span class="nc" id="L4405">                    addReport(r);</span>
                }
<span class="nc" id="L4407">                addNewLines();</span>
<span class="nc" id="L4408">            } else {</span>
<span class="nc" id="L4409">                return false;</span>
            }
        }

<span class="nc" id="L4413">        addReport(doSetLocationsExposure(unit, hex, false, unit.getElevation()));</span>

        // unlike other unloaders, entities unloaded from droppers can still
        // move (unless infantry)
<span class="nc bnc" id="L4417" title="All 6 branches missed.">        if (!evacuation &amp;&amp; (unloader instanceof SmallCraft)</span>
            &amp;&amp; !(unit instanceof Infantry)) {
<span class="nc" id="L4419">            unit.setUnloaded(false);</span>
<span class="nc" id="L4420">            unit.setDone(false);</span>

            // unit uses half of walk mp and is treated as moving one hex
<span class="nc" id="L4423">            unit.mpUsed = unit.getOriginalWalkMP() / 2;</span>
<span class="nc" id="L4424">            unit.delta_distance = 1;</span>
        }

        // If we unloaded during deployment, allow a turn
<span class="nc bnc" id="L4428" title="All 2 branches missed.">        if (duringDeployment) {</span>
<span class="nc" id="L4429">            unit.setUnloaded(false);</span>
<span class="nc" id="L4430">            unit.setDone(false);</span>
        }
        
        //Update the transport unit's passenger count, if it's a large craft
<span class="nc bnc" id="L4434" title="All 4 branches missed.">        if (unloader instanceof SmallCraft || unloader instanceof Jumpship) {</span>
            //Don't add dropship crew to a jumpship or station's passenger list
<span class="nc bnc" id="L4436" title="All 2 branches missed.">            if (!unit.isLargeCraft()) {</span>
<span class="nc" id="L4437">                unloader.setNPassenger(Math.max(0, unloader.getNPassenger() - unit.getCrew().getSize()));</span>
            }
        }

        // Update the unloaded unit.
<span class="nc" id="L4442">        entityUpdate(unit.getId());</span>

        // Unloaded successfully.
<span class="nc" id="L4445">        return true;</span>
    }

    /**
     * Do a piloting skill check to attempt landing
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is landing
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this landing.
     */
    private void attemptLanding(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L4455" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L4456">            return;</span>
        }

        // okay, print the info
<span class="nc" id="L4460">        Report r = new Report(9605);</span>
<span class="nc" id="L4461">        r.subject = entity.getId();</span>
<span class="nc" id="L4462">        r.addDesc(entity);</span>
<span class="nc" id="L4463">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L4464">        addReport(r);</span>

        // roll
<span class="nc" id="L4467">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L4468">        r = new Report(9606);</span>
<span class="nc" id="L4469">        r.subject = entity.getId();</span>
<span class="nc" id="L4470">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L4471">        r.add(roll.getDesc());</span>
<span class="nc" id="L4472">        r.add(diceRoll);</span>
        // boolean suc;
<span class="nc bnc" id="L4474" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L4475">            r.choose(false);</span>
<span class="nc" id="L4476">            addReport(r);</span>
<span class="nc" id="L4477">            int mof = roll.getValue() - diceRoll;</span>
<span class="nc" id="L4478">            int damage = 10 * (mof);</span>
            // Report damage taken
<span class="nc" id="L4480">            r = new Report(9609);</span>
<span class="nc" id="L4481">            r.indent();</span>
<span class="nc" id="L4482">            r.addDesc(entity);</span>
<span class="nc" id="L4483">            r.add(damage);</span>
<span class="nc" id="L4484">            r.add(mof);</span>
<span class="nc" id="L4485">            addReport(r);</span>

<span class="nc" id="L4487">            int side = ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L4488" title="All 4 branches missed.">            if ((entity instanceof Aero) &amp;&amp; ((Aero) entity).isSpheroid()) {</span>
<span class="nc" id="L4489">                side = ToHitData.SIDE_REAR;</span>
            }
<span class="nc bnc" id="L4491" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L4492">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc" id="L4493">                addReport(damageEntity(entity, hit, 10));</span>
<span class="nc" id="L4494">                damage -= 10;</span>
<span class="nc" id="L4495">            }</span>
            // suc = false;
<span class="nc" id="L4497">        } else {</span>
<span class="nc" id="L4498">            r.choose(true);</span>
<span class="nc" id="L4499">            addReport(r);</span>
            // suc = true;
        }
<span class="nc" id="L4502">    }</span>

    private boolean launchUnit(Entity unloader, Targetable unloaded,
                               Coords pos, int facing, int velocity, int altitude, int[] moveVec,
                               int bonus) {

        Entity unit;
<span class="nc bnc" id="L4509" title="All 4 branches missed.">        if (unloaded instanceof Entity &amp;&amp; unloader instanceof Aero) {</span>
<span class="nc" id="L4510">            unit = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4512">            return false;</span>
        }

        // must be an ASF, Small Craft, or DropShip
<span class="nc bnc" id="L4516" title="All 4 branches missed.">        if (!unit.isAero() || unit instanceof Jumpship) {</span>
<span class="nc" id="L4517">            return false;</span>
        }
<span class="nc" id="L4519">        IAero a = (IAero) unit;</span>

        Report r;

        // Unload the unit.
<span class="nc bnc" id="L4524" title="All 2 branches missed.">        if (!unloader.unload(unit)) {</span>
<span class="nc" id="L4525">            return false;</span>
        }

        // The unloaded unit is no longer being carried.
<span class="nc" id="L4529">        unit.setTransportId(Entity.NONE);</span>

        // pg. 86 of TW: launched fighters can move in fire in the turn they are
        // unloaded
<span class="nc" id="L4533">        unit.setUnloaded(false);</span>

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4536">        unit.setPosition(pos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4539" title="All 2 branches missed.">        if (pos != null) {</span>
<span class="nc" id="L4540">            unit.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4544">        unit.setFacing(facing);</span>
<span class="nc" id="L4545">        unit.setSecondaryFacing(facing);</span>

        // the velocity of the unloaded unit is the same as the loader
<span class="nc" id="L4548">        a.setCurrentVelocity(velocity);</span>
<span class="nc" id="L4549">        a.setNextVelocity(velocity);</span>

        // if using advanced movement then set vectors
<span class="nc" id="L4552">        unit.setVectors(moveVec);</span>

<span class="nc" id="L4554">        unit.setAltitude(altitude);</span>

        // it seems that the done button is still being set and I can't figure
        // out where
<span class="nc" id="L4558">        unit.setDone(false);</span>

        // if the bonus was greater than zero then too many fighters were
        // launched and they
        // must all make control rolls
<span class="nc bnc" id="L4563" title="All 2 branches missed.">        if (bonus &gt; 0) {</span>
<span class="nc" id="L4564">            PilotingRollData psr = unit.getBasePilotingRoll();</span>
<span class="nc" id="L4565">            psr.addModifier(bonus, &quot;safe launch rate exceeded&quot;);</span>
<span class="nc" id="L4566">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L4567">            r = new Report(9375);</span>
<span class="nc" id="L4568">            r.subject = unit.getId();</span>
<span class="nc" id="L4569">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4570">            r.add(psr);</span>
<span class="nc" id="L4571">            r.add(ctrlroll);</span>
<span class="nc" id="L4572">            r.indent(1);</span>
<span class="nc bnc" id="L4573" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L4574">                r.choose(false);</span>
<span class="nc" id="L4575">                addReport(r);</span>
                // damage the unit
<span class="nc" id="L4577">                int damage = 10 * (psr.getValue() - ctrlroll);</span>
<span class="nc" id="L4578">                HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4579">                Vector&lt;Report&gt; rep = damageEntity(unit, hit, damage);</span>
<span class="nc" id="L4580">                Report.indentAll(rep, 1);</span>
<span class="nc" id="L4581">                rep.lastElement().newlines++;</span>
<span class="nc" id="L4582">                addReport(rep);</span>
                // did we destroy the unit?
<span class="nc bnc" id="L4584" title="All 2 branches missed.">                if (unit.isDoomed()) {</span>
                    // Clean out the entity.
<span class="nc" id="L4586">                    unit.setDestroyed(true);</span>
<span class="nc" id="L4587">                    game.moveToGraveyard(unit.getId());</span>
<span class="nc" id="L4588">                    send(createRemoveEntityPacket(unit.getId()));</span>
                }
<span class="nc" id="L4590">            } else {</span>
                // avoided damage
<span class="nc" id="L4592">                r.choose(true);</span>
<span class="nc" id="L4593">                r.newlines++;</span>
<span class="nc" id="L4594">                addReport(r);</span>
            }
<span class="nc" id="L4596">        } else {</span>
<span class="nc" id="L4597">            r = new Report(9374);</span>
<span class="nc" id="L4598">            r.subject = unit.getId();</span>
<span class="nc" id="L4599">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4600">            r.indent(1);</span>
<span class="nc" id="L4601">            r.newlines++;</span>
<span class="nc" id="L4602">            addReport(r);</span>
        }

        // launching from an OOC vessel causes damage
        // same thing if faster than 2 velocity in atmosphere
<span class="nc bnc" id="L4607" title="All 4 branches missed.">        if ((((Aero) unloader).isOutControlTotal() &amp;&amp; !unit.isDoomed())</span>
<span class="nc bnc" id="L4608" title="All 2 branches missed.">            || ((((Aero)unloader).getCurrentVelocity() &gt; 2) &amp;&amp; !game</span>
<span class="nc bnc" id="L4609" title="All 2 branches missed.">                .getBoard().inSpace())) {</span>
<span class="nc" id="L4610">            int damageRoll = Compute.d6(2);</span>
<span class="nc" id="L4611">            int damage = damageRoll * 10;</span>
<span class="nc" id="L4612">            r = new Report(9385);</span>
<span class="nc" id="L4613">            r.subject = unit.getId();</span>
<span class="nc" id="L4614">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4615">            r.add(damage);</span>
<span class="nc" id="L4616">            addReport(r);</span>
<span class="nc" id="L4617">            HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4618">            addReport(damageEntity(unit, hit, damage));</span>
            // did we destroy the unit?
<span class="nc bnc" id="L4620" title="All 2 branches missed.">            if (unit.isDoomed()) {</span>
                // Clean out the entity.
<span class="nc" id="L4622">                unit.setDestroyed(true);</span>
<span class="nc" id="L4623">                game.moveToGraveyard(unit.getId());</span>
<span class="nc" id="L4624">                send(createRemoveEntityPacket(unit.getId()));</span>
            }
        }

        // Update the unloaded unit.
<span class="nc" id="L4629">        entityUpdate(unit.getId());</span>

        // Set the turn mask. We need to be specific otherwise we run the risk
        // of having a unit of another class consume the turn and leave the
        // unloaded unit without a turn
        int turnMask;
<span class="nc" id="L4635">        List&lt;GameTurn&gt; turnVector = game.getTurnVector();</span>
<span class="nc bnc" id="L4636" title="All 2 branches missed.">        if (unit instanceof Dropship) {</span>
<span class="nc" id="L4637">            turnMask = GameTurn.CLASS_DROPSHIP;</span>
<span class="nc bnc" id="L4638" title="All 2 branches missed.">        } else if (unit instanceof SmallCraft) {</span>
<span class="nc" id="L4639">            turnMask = GameTurn.CLASS_SMALL_CRAFT;</span>
        } else {
<span class="nc" id="L4641">            turnMask = GameTurn.CLASS_AERO;</span>
        }
        // Add one, otherwise we consider the turn we're currently processing
<span class="nc" id="L4644">        int turnInsertIdx = game.getTurnIndex() + 1;</span>
        // We have to figure out where to insert this turn, to maintain proper
        // space turn order (JumpShips, Small Craft, DropShips, Aeros)
<span class="nc bnc" id="L4647" title="All 2 branches missed.">        for (; turnInsertIdx &lt; turnVector.size(); turnInsertIdx++) {</span>
<span class="nc" id="L4648">            GameTurn turn = turnVector.get(turnInsertIdx);</span>
<span class="nc bnc" id="L4649" title="All 2 branches missed.">            if (turn.isValidEntity(unit, game)) {</span>
<span class="nc" id="L4650">                break;</span>
            }
        }

        // ok add another turn for the unloaded entity so that it can move
<span class="nc" id="L4655">        GameTurn newTurn = new GameTurn.EntityClassTurn(unit.getOwner().getId(), turnMask);</span>
<span class="nc" id="L4656">        game.insertTurnAfter(newTurn, turnInsertIdx);</span>
        // brief everybody on the turn update
<span class="nc" id="L4658">        send(createTurnVectorPacket());</span>

<span class="nc" id="L4660">        return true;</span>
    }

    public void dropUnit(Entity drop, Entity entity, Coords curPos, int altitude) {
        // Unload the unit.
<span class="nc" id="L4665">        entity.unload(drop);</span>
        // The unloaded unit is no longer being carried.
<span class="nc" id="L4667">        drop.setTransportId(Entity.NONE);</span>

        // OK according to Welshman's pending ruling, when on the ground map
        // units should be deployed in the ring two hexes away from the DropShip
        // optimally, we should let people choose here, but that would be
        // complicated
        // so for now I am just going to distribute them. I will give each unit
        // the first
        // emptiest hex that has no water or magma in it.
        // I will start the circle based on the facing of the dropper
        // Spheroid - facing
        // Aerodyne - opposite of facing
        // http://www.classicbattletech.com/forums/index.php?topic=65600.msg1568089#new
<span class="nc bnc" id="L4680" title="All 4 branches missed.">        if (game.getBoard().onGround() &amp;&amp; (null != curPos)) {</span>
<span class="nc" id="L4681">            boolean selected = false;</span>
            int count;
<span class="nc" id="L4683">            int max = 0;</span>
<span class="nc" id="L4684">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L4685" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
                // no real rule for this but it seems to make sense that units
                // would drop behind an
                // aerodyne rather than in front of it
<span class="nc" id="L4689">                facing = (facing + 3) % 6;</span>
            }
<span class="nc" id="L4691">            boolean checkDanger = true;</span>
<span class="nc bnc" id="L4692" title="All 2 branches missed.">            while (!selected) {</span>
                // we can get caught in an infinite loop if all available hexes
                // are dangerous, so check for this
<span class="nc" id="L4695">                boolean allDanger = true;</span>
<span class="nc bnc" id="L4696" title="All 2 branches missed.">                for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4697">                    int dir = (facing + i) % 6;</span>
<span class="nc" id="L4698">                    Coords newPos = curPos.translated(dir, 2);</span>
<span class="nc" id="L4699">                    count = 0;</span>
<span class="nc bnc" id="L4700" title="All 2 branches missed.">                    if (game.getBoard().contains(newPos)) {</span>
<span class="nc" id="L4701">                        IHex newHex = game.getBoard().getHex(newPos);</span>
<span class="nc" id="L4702">                        Building bldg = game.getBoard().getBuildingAt(newPos);</span>
<span class="nc bnc" id="L4703" title="All 2 branches missed.">                        boolean danger = newHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4704" title="All 4 branches missed.">                                         || newHex.containsTerrain(Terrains.MAGMA)</span>
                                         || (null != bldg);
<span class="nc bnc" id="L4706" title="All 2 branches missed.">                        for (Entity unit : game.getEntitiesVector(newPos)) {</span>
<span class="nc bnc" id="L4707" title="All 2 branches missed.">                            if ((unit.getAltitude() == altitude)</span>
<span class="nc bnc" id="L4708" title="All 2 branches missed.">                                &amp;&amp; !unit.isAero()) {</span>
<span class="nc" id="L4709">                                count++;</span>
                            }
<span class="nc" id="L4711">                        }</span>
<span class="nc bnc" id="L4712" title="All 6 branches missed.">                        if ((count &lt;= max) &amp;&amp; (!danger || !checkDanger)) {</span>
<span class="nc" id="L4713">                            selected = true;</span>
<span class="nc" id="L4714">                            curPos = newPos;</span>
<span class="nc" id="L4715">                            break;</span>
                        }
<span class="nc bnc" id="L4717" title="All 2 branches missed.">                        if (!danger) {</span>
<span class="nc" id="L4718">                            allDanger = false;</span>
                        }
                    }
<span class="nc" id="L4721">                    newPos = newPos.translated((dir + 2) % 6);</span>
<span class="nc" id="L4722">                    count = 0;</span>
<span class="nc bnc" id="L4723" title="All 2 branches missed.">                    if (game.getBoard().contains(newPos)) {</span>
<span class="nc" id="L4724">                        IHex newHex = game.getBoard().getHex(newPos);</span>
<span class="nc" id="L4725">                        Building bldg = game.getBoard().getBuildingAt(newPos);</span>
<span class="nc bnc" id="L4726" title="All 2 branches missed.">                        boolean danger = newHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4727" title="All 4 branches missed.">                                         || newHex.containsTerrain(Terrains.MAGMA)</span>
                                         || (null != bldg);
<span class="nc bnc" id="L4729" title="All 2 branches missed.">                        for (Entity unit : game.getEntitiesVector(newPos)) {</span>
<span class="nc bnc" id="L4730" title="All 4 branches missed.">                            if ((unit.getAltitude() == altitude) &amp;&amp; !unit.isAero()) {</span>
<span class="nc" id="L4731">                                count++;</span>
                            }
<span class="nc" id="L4733">                        }</span>
<span class="nc bnc" id="L4734" title="All 6 branches missed.">                        if ((count &lt;= max) &amp;&amp; (!danger || !checkDanger)) {</span>
<span class="nc" id="L4735">                            selected = true;</span>
<span class="nc" id="L4736">                            curPos = newPos;</span>
<span class="nc" id="L4737">                            break;</span>
                        }
<span class="nc bnc" id="L4739" title="All 2 branches missed.">                        if (!danger) {</span>
<span class="nc" id="L4740">                            allDanger = false;</span>
                        }
                    }
                }
<span class="nc bnc" id="L4744" title="All 4 branches missed.">                if (allDanger &amp;&amp; checkDanger) {</span>
<span class="nc" id="L4745">                    checkDanger = false;</span>
                } else {
<span class="nc" id="L4747">                    max++;</span>
                }
<span class="nc" id="L4749">            }</span>
        }

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4753">        drop.setPosition(curPos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4756" title="All 2 branches missed.">        if (curPos != null) {</span>
<span class="nc" id="L4757">            drop.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4761">        drop.setFacing(entity.getFacing());</span>
<span class="nc" id="L4762">        drop.setSecondaryFacing(entity.getFacing());</span>

<span class="nc" id="L4764">        drop.setAltitude(altitude);</span>
<span class="nc" id="L4765">        entityUpdate(drop.getId());</span>
<span class="nc" id="L4766">    }</span>

    /**
     * Record that the given building has been affected by the current entity's
     * movement. At the end of the entity's movement, notify the clients about
     * the updates.
     *
     * @param bldg     - the &lt;code&gt;Building&lt;/code&gt; that has been affected.
     * @param collapse - a &lt;code&gt;boolean&lt;/code&gt; value that specifies that the
     *                 building collapsed (when &lt;code&gt;true&lt;/code&gt;).
     */
    private void addAffectedBldg(Building bldg, boolean collapse) {
        // If the building collapsed, then the clients have already
        // been notified, so remove it from the notification list.
<span class="nc bnc" id="L4780" title="All 2 branches missed.">        if (collapse) {</span>
<span class="nc" id="L4781">            affectedBldgs.remove(bldg);</span>
        } else { // Otherwise, make sure that this building is tracked.
<span class="nc" id="L4783">            affectedBldgs.put(bldg, Boolean.FALSE);</span>
        }
<span class="nc" id="L4785">    }</span>

    /**
     * Walk through the building hexes that were affected by the recent entity's
     * movement. Notify the clients about the updates to all affected entities
     * and non-collapsed buildings. The affected hexes is then cleared for the
     * next entity's movement.
     */
    private void applyAffectedBldgs() {
        // Build a list of Building updates.
<span class="nc" id="L4795">        Vector&lt;Building&gt; bldgUpdates = new Vector&lt;&gt;();</span>

        // Only send a single turn update.
<span class="nc" id="L4798">        boolean bTurnsChanged = false;</span>

        // Walk the set of buildings.
<span class="nc" id="L4801">        Enumeration&lt;Building&gt; bldgs = affectedBldgs.keys();</span>
<span class="nc bnc" id="L4802" title="All 2 branches missed.">        while (bldgs.hasMoreElements()) {</span>
<span class="nc" id="L4803">            final Building bldg = bldgs.nextElement();</span>

            // Walk through the building's coordinates.
<span class="nc" id="L4806">            Enumeration&lt;Coords&gt; bldgCoords = bldg.getCoords();</span>
<span class="nc bnc" id="L4807" title="All 2 branches missed.">            while (bldgCoords.hasMoreElements()) {</span>
<span class="nc" id="L4808">                final Coords coords = bldgCoords.nextElement();</span>
                // Walk through the entities at these coordinates.
<span class="nc bnc" id="L4810" title="All 2 branches missed.">                for (Entity entity : game.getEntitiesVector(coords)) {</span>
                    // Is the entity infantry?
<span class="nc bnc" id="L4812" title="All 2 branches missed.">                    if (entity instanceof Infantry) {</span>
                        // Is the infantry dead?
<span class="nc bnc" id="L4814" title="All 4 branches missed.">                        if (entity.isDoomed() || entity.isDestroyed()) {</span>
                            // Has the entity taken a turn?
<span class="nc bnc" id="L4816" title="All 2 branches missed.">                            if (!entity.isDone()) {</span>
                                // Dead entities don't take turns.
<span class="nc" id="L4818">                                game.removeTurnFor(entity);</span>
<span class="nc" id="L4819">                                bTurnsChanged = true;</span>
                            } // End entity-still-to-move

                            // Clean out the dead entity.
<span class="nc" id="L4823">                            entity.setDestroyed(true);</span>
<span class="nc" id="L4824">                            game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L4825">                            send(createRemoveEntityPacket(entity.getId()));</span>
                        } else { // Infantry that aren't dead are damaged.
<span class="nc" id="L4827">                            entityUpdate(entity.getId());</span>
                        }
                    } // End entity-is-infantry
<span class="nc" id="L4830">                } // Check the next entity.</span>
<span class="nc" id="L4831">            } // Handle the next hex in this building.</span>
            // Add this building to the report.
<span class="nc" id="L4833">            bldgUpdates.addElement(bldg);</span>
<span class="nc" id="L4834">        } // Handle the next affected building.</span>

        // Did we update the turns?
<span class="nc bnc" id="L4837" title="All 2 branches missed.">        if (bTurnsChanged) {</span>
<span class="nc" id="L4838">            send(createTurnVectorPacket());</span>
        }

        // Are there any building updates?
<span class="nc bnc" id="L4842" title="All 2 branches missed.">        if (!bldgUpdates.isEmpty()) {</span>
            // Send the building updates to the clients.
<span class="nc" id="L4844">            sendChangedBuildings(bldgUpdates);</span>

            // Clear the list of affected buildings.
<span class="nc" id="L4847">            affectedBldgs.clear();</span>
        }

        // And we're done.
<span class="nc" id="L4851">    } // End private void applyAffectedBldgs()</span>

    /**
     * Receives an entity movement packet, and if valid, executes it and ends
     * the current turn.
     */
    private void receiveMovement(Packet packet, int connId) {
<span class="nc" id="L4858">        Map&lt;EntityTargetPair, LosEffects&gt; losCache = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4859">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L4860">        MovePath md = (MovePath) packet.getObject(1);</span>
<span class="nc" id="L4861">        md.setGame(getGame());</span>
<span class="nc" id="L4862">        md.setEntity(entity);</span>

        // is this the right phase?
<span class="nc bnc" id="L4865" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L4866">            MegaMek.getLogger().error(&quot;Server got movement packet in wrong phase&quot;);</span>
<span class="nc" id="L4867">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L4871">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L4872" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L4873">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L4875" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)) {</span>
<span class="nc" id="L4876">            String msg = &quot;error: server got invalid movement packet from &quot; + &quot;connection &quot; + connId;</span>
<span class="nc bnc" id="L4877" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L4878">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L4880">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L4882">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L4883">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L4887">        processMovement(entity, md, losCache);</span>

        // The attacker may choose to break a chain whip grapple by expending MP
<span class="nc bnc" id="L4890" title="All 2 branches missed.">        if ((entity.getGrappled() != Entity.NONE)</span>
<span class="nc bnc" id="L4891" title="All 4 branches missed.">                &amp;&amp; entity.isChainWhipGrappled() &amp;&amp; entity.isGrappleAttacker()</span>
<span class="nc bnc" id="L4892" title="All 2 branches missed.">                &amp;&amp; (md.getMpUsed() &gt; 0)) {</span>

<span class="nc" id="L4894">            Entity te = game.getEntity(entity.getGrappled());</span>
<span class="nc" id="L4895">            Report r = new Report(4316);</span>
<span class="nc" id="L4896">            r.subject = entity.getId();</span>
<span class="nc" id="L4897">            r.addDesc(entity);</span>
<span class="nc" id="L4898">            r.addDesc(te);</span>
<span class="nc" id="L4899">            addReport(r);</span>

<span class="nc" id="L4901">            entity.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L4902">            te.setGrappled(Entity.NONE, false);</span>

<span class="nc" id="L4904">            entityUpdate(entity.getId());</span>
<span class="nc" id="L4905">            entityUpdate(te.getId());</span>
        }

        // check the LOS of any telemissiles owned by this entity
<span class="nc bnc" id="L4909" title="All 2 branches missed.">        for (int missileId : entity.getTMTracker().getMissiles()) {</span>
<span class="nc" id="L4910">            Entity tm = game.getEntity(missileId);</span>
<span class="nc bnc" id="L4911" title="All 6 branches missed.">            if ((null != tm) &amp;&amp; !tm.isDestroyed()</span>
                &amp;&amp; (tm instanceof TeleMissile)) {
<span class="nc bnc" id="L4913" title="All 2 branches missed.">                if (LosEffects.calculateLos(game, entity.getId(), tm).canSee()) {</span>
<span class="nc" id="L4914">                    ((TeleMissile) tm).setOutContact(false);</span>
                } else {
<span class="nc" id="L4916">                    ((TeleMissile) tm).setOutContact(true);</span>
                }
<span class="nc" id="L4918">                entityUpdate(tm.getId());</span>
            }
<span class="nc" id="L4920">        }</span>

        // Notify the clients about any building updates.
<span class="nc" id="L4923">        applyAffectedBldgs();</span>

        // Unit movement may detect hidden units
<span class="nc" id="L4926">        detectHiddenUnits();</span>

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L4929" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L4930">            updateVisibilityIndicator(losCache);</span>
        }

        // This entity's turn is over.
        // N.B. if the entity fell, a *new* turn has already been added.
<span class="nc" id="L4935">        endCurrentTurn(entity);</span>
<span class="nc" id="L4936">    }</span>

    /**
     * makes a unit skid or sideslip on the board
     *
     * @param entity    the unit which should skid
     * @param start     the coordinates of the hex the unit was in prior to skidding
     * @param elevation the elevation of the unit
     * @param direction the direction of the skid
     * @param distance  the number of hexes skidded
     * @param step      the MoveStep which caused the skid
     * @return true if the entity was removed from play
     */
    private boolean processSkid(Entity entity, Coords start, int elevation,
            int direction, int distance, MoveStep step,
            EntityMovementType moveType) {
<span class="nc" id="L4952">        return processSkid(entity, start, elevation, direction, distance, step, moveType, false);</span>
    }

    /**
     * makes a unit skid or sideslip on the board
     *
     * @param entity    the unit which should skid
     * @param start     the coordinates of the hex the unit was in prior to skidding
     * @param elevation the elevation of the unit
     * @param direction the direction of the skid
     * @param distance  the number of hexes skidded
     * @param step      the MoveStep which caused the skid
     * @param flip      whether the skid resulted from a failure maneuver result of major skid
     * @return true if the entity was removed from play
     */
    private boolean processSkid(Entity entity, Coords start, int elevation,
            int direction, int distance, MoveStep step,
            EntityMovementType moveType, boolean flip) {
<span class="nc" id="L4970">        Coords nextPos = start;</span>
<span class="nc" id="L4971">        Coords curPos = nextPos;</span>
<span class="nc" id="L4972">        IHex curHex = game.getBoard().getHex(start);</span>
        Report r;
<span class="nc" id="L4974">        int skidDistance = 0; // actual distance moved</span>
        // Flipping vehicles take tonnage/10 points of damage for every hex they enter.
<span class="nc" id="L4976">        int flipDamage = (int) Math.ceil(entity.getWeight() / 10.0);</span>
<span class="nc bnc" id="L4977" title="All 4 branches missed.">        while (!entity.isDoomed() &amp;&amp; (distance &gt; 0)) {</span>
<span class="nc" id="L4978">            nextPos = curPos.translated(direction);</span>
            // Is the next hex off the board?
<span class="nc bnc" id="L4980" title="All 2 branches missed.">            if (!game.getBoard().contains(nextPos)) {</span>

                // Can the entity skid off the map?
<span class="nc bnc" id="L4983" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PUSH_OFF_BOARD)) {</span>
                    // Yup. One dead entity.
<span class="nc" id="L4985">                    game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L4986">                    send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
<span class="nc" id="L4987">                    r = new Report(2030, Report.PUBLIC);</span>
<span class="nc" id="L4988">                    r.addDesc(entity);</span>
<span class="nc" id="L4989">                    addReport(r);</span>

<span class="nc bnc" id="L4991" title="All 2 branches missed.">                    for (Entity e : entity.getLoadedUnits()) {</span>
<span class="nc" id="L4992">                        game.removeEntity(e.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L4993">                        send(createRemoveEntityPacket(e.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
<span class="nc" id="L4994">                    }</span>
<span class="nc" id="L4995">                    Entity swarmer = game.getEntity(entity.getSwarmAttackerId());</span>
<span class="nc bnc" id="L4996" title="All 2 branches missed.">                    if (swarmer != null) {</span>
<span class="nc bnc" id="L4997" title="All 2 branches missed.">                        if (!swarmer.isDone()) {</span>
<span class="nc" id="L4998">                            game.removeTurnFor(swarmer);</span>
<span class="nc" id="L4999">                            swarmer.setDone(true);</span>
<span class="nc" id="L5000">                            send(createTurnVectorPacket());</span>
                        }
<span class="nc" id="L5002">                        game.removeEntity(swarmer.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L5003">                        send(createRemoveEntityPacket(swarmer.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
                    }
                    // The entity's movement is completed.
<span class="nc" id="L5006">                    return true;</span>

                }
                // Nope. Update the report.
<span class="nc" id="L5010">                r = new Report(2035);</span>
<span class="nc" id="L5011">                r.subject = entity.getId();</span>
<span class="nc" id="L5012">                r.indent();</span>
<span class="nc" id="L5013">                addReport(r);</span>
                // Stay in the current hex and stop skidding.
<span class="nc" id="L5015">                break;</span>
            }

<span class="nc" id="L5018">            IHex nextHex = game.getBoard().getHex(nextPos);</span>
<span class="nc" id="L5019">            distance -= nextHex.movementCost(entity) + 1;</span>
            // By default, the unit is going to fall to the floor of the next
            // hex
<span class="nc" id="L5022">            int curAltitude = elevation + curHex.getLevel();</span>
<span class="nc" id="L5023">            int nextAltitude = nextHex.floor();</span>

            // but VTOL keep altitude
<span class="nc bnc" id="L5026" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L5027">                nextAltitude = Math.max(nextAltitude, curAltitude);</span>
            } else {
                // Is there a building to &quot;catch&quot; the unit?
<span class="nc bnc" id="L5030" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
                    // unit will land on the roof, if at a higher level,
                    // otherwise it will skid through the wall onto the same
                    // floor.
                    // don't change this if the building starts at an elevation
                    // higher than the unit
                    // (e.g. the building is on a hill). Otherwise, we skid into
                    // solid earth.
<span class="nc bnc" id="L5038" title="All 2 branches missed.">                    if (curAltitude &gt;= nextHex.floor()) {</span>
<span class="nc" id="L5039">                        nextAltitude = Math.min(curAltitude,</span>
<span class="nc" id="L5040">                                nextHex.getLevel() + nextHex.terrainLevel(Terrains.BLDG_ELEV));</span>
                    }
                }
                // Is there a bridge to &quot;catch&quot; the unit?
<span class="nc bnc" id="L5044" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BRIDGE)) {</span>
                    // unit will land on the bridge, if at a higher level,
                    // and the bridge exits towards the current hex,
                    // otherwise the bridge has no effect
<span class="nc" id="L5048">                    int exitDir = (direction + 3) % 6;</span>
<span class="nc" id="L5049">                    exitDir = 1 &lt;&lt; exitDir;</span>
<span class="nc bnc" id="L5050" title="All 2 branches missed.">                    if ((nextHex.getTerrain(Terrains.BRIDGE).getExits() &amp; exitDir) == exitDir) {</span>
<span class="nc" id="L5051">                        nextAltitude = Math.min(curAltitude,</span>
<span class="nc" id="L5052">                                     Math.max(nextAltitude,</span>
<span class="nc" id="L5053">                                             nextHex.getLevel() + nextHex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
                    }
                }
<span class="nc bnc" id="L5056" title="All 2 branches missed.">                if ((nextAltitude &lt;= nextHex.surface())</span>
<span class="nc bnc" id="L5057" title="All 2 branches missed.">                    &amp;&amp; (curAltitude &gt;= curHex.surface())) {</span>
                    // Hovercraft and WiGEs can &quot;skid&quot; over water.
                    // all units can skid over ice.
<span class="nc bnc" id="L5060" title="All 2 branches missed.">                    if ((entity.getMovementMode().equals(EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5061" title="All 2 branches missed.">                                || entity.getMovementMode().equals(EntityMovementMode.WIGE))</span>
<span class="nc bnc" id="L5062" title="All 2 branches missed.">                            &amp;&amp; nextHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L5063">                        nextAltitude = nextHex.surface();</span>
                    } else {
<span class="nc bnc" id="L5065" title="All 2 branches missed.">                        if (nextHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L5066">                            nextAltitude = nextHex.surface();</span>
                        }
                    }
                }
<span class="nc bnc" id="L5070" title="All 6 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WIGE</span>
                        &amp;&amp; elevation &gt; 0 &amp;&amp; nextAltitude &lt; curAltitude) {
                    // Airborne WiGEs drop to one level above the surface
<span class="nc bnc" id="L5073" title="All 2 branches missed.">                    if (entity.climbMode()) {</span>
<span class="nc" id="L5074">                        nextAltitude = curAltitude;</span>
                    } else {
<span class="nc" id="L5076">                        nextAltitude++;</span>
                    }
                }
            }

            // The elevation the skidding unit will occupy in next hex
<span class="nc" id="L5082">            int nextElevation = nextAltitude - nextHex.surface();</span>

<span class="nc bnc" id="L5084" title="All 2 branches missed.">            boolean crashedIntoTerrain = curAltitude &lt; nextAltitude;</span>
<span class="nc bnc" id="L5085" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L5086" title="All 2 branches missed.">                &amp;&amp; (nextHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L5087" title="All 2 branches missed.">                        || nextHex.containsTerrain(Terrains.JUNGLE)) </span>
<span class="nc bnc" id="L5088" title="All 2 branches missed.">                &amp;&amp; nextElevation &lt;= nextHex.terrainLevel(Terrains.FOLIAGE_ELEV)) {</span>
<span class="nc" id="L5089">                    crashedIntoTerrain = true;</span>
                
            }

<span class="nc bnc" id="L5093" title="All 2 branches missed.">            if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5094">                Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

<span class="nc bnc" id="L5096" title="All 2 branches missed.">                if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5097">                    crashedIntoTerrain = true;</span>
                }

<span class="nc bnc" id="L5100" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5101">                    crashedIntoTerrain = true;</span>
                }
            }

            // however WiGE can gain 1 level to avoid crashing into the terrain.
<span class="nc bnc" id="L5106" title="All 4 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; (elevation &gt; 0)) {</span>
<span class="nc bnc" id="L5107" title="All 2 branches missed.">                if (curAltitude == nextHex.floor()) {</span>
<span class="nc" id="L5108">                    nextElevation = 1;</span>
<span class="nc" id="L5109">                    crashedIntoTerrain = false;</span>
<span class="nc bnc" id="L5110" title="All 4 branches missed.">                } else if ((entity instanceof LandAirMech) &amp;&amp; (curAltitude + 1 == nextHex.floor())) {</span>
                    // LAMs in AirMech mode skid across terrain that is two levels higher rather than crashing,
                    // Reset the skid distance for skid damage calculations.
<span class="nc" id="L5113">                    nextElevation = 0;</span>
<span class="nc" id="L5114">                    skidDistance = 0;</span>
<span class="nc" id="L5115">                    crashedIntoTerrain = false;</span>
<span class="nc" id="L5116">                    r = new Report(2102);</span>
<span class="nc" id="L5117">                    r.subject = entity.getId();</span>
<span class="nc" id="L5118">                    r.indent();</span>
<span class="nc" id="L5119">                    addReport(r);</span>
                }
            }

<span class="nc" id="L5123">            Entity crashDropShip = null;</span>
<span class="nc bnc" id="L5124" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector(nextPos)) {</span>
<span class="nc bnc" id="L5125" title="All 4 branches missed.">                if ((en instanceof Dropship) &amp;&amp; !en.isAirborne()</span>
<span class="nc bnc" id="L5126" title="All 2 branches missed.">                    &amp;&amp; (nextAltitude &lt;= (en.relHeight()))) {</span>
<span class="nc" id="L5127">                    crashDropShip = en;</span>
                }
<span class="nc" id="L5129">            }</span>

<span class="nc bnc" id="L5131" title="All 2 branches missed.">            if (crashedIntoTerrain) {</span>
<span class="nc bnc" id="L5132" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5133">                    Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

                    // If you crash into a wall you want to stop in the hex
                    // before the wall not in the wall
                    // Like a building.
<span class="nc bnc" id="L5138" title="All 2 branches missed.">                    if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5139">                        r = new Report(2047);</span>
<span class="nc bnc" id="L5140" title="All 2 branches missed.">                    } else if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5141">                        r = new Report(2049);</span>
                    } else {
<span class="nc" id="L5143">                        r = new Report(2045);</span>
                    }

<span class="nc" id="L5146">                } else {</span>
<span class="nc" id="L5147">                    r = new Report(2045);</span>
                }

<span class="nc" id="L5150">                r.subject = entity.getId();</span>
<span class="nc" id="L5151">                r.indent();</span>
<span class="nc" id="L5152">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5153">                addReport(r);</span>

<span class="nc bnc" id="L5155" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L5156" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L5157">                    int hitSide = (step.getFacing() - direction) + 6;</span>
<span class="nc" id="L5158">                    hitSide %= 6;</span>
<span class="nc" id="L5159">                    int table = 0;</span>
<span class="nc bnc" id="L5160" title="All 5 branches missed.">                    switch (hitSide) {// quite hackish...I think it ought to</span>
                        // work, though.
                        case 0:// can this happen?
<span class="nc" id="L5163">                            table = ToHitData.SIDE_FRONT;</span>
<span class="nc" id="L5164">                            break;</span>
                        case 1:
                        case 2:
<span class="nc" id="L5167">                            table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L5168">                            break;</span>
                        case 3:
<span class="nc" id="L5170">                            table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L5171">                            break;</span>
                        case 4:
                        case 5:
<span class="nc" id="L5174">                            table = ToHitData.SIDE_RIGHT;</span>
                            break;
                    }
<span class="nc" id="L5177">                    elevation = nextElevation;</span>
<span class="nc bnc" id="L5178" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc" id="L5179">                        addReport(crashVTOLorWiGE((Tank) entity, false, true,</span>
                                distance, curPos, elevation, table));
                    }

<span class="nc bnc" id="L5183" title="All 2 branches missed.">                    if ((nextHex.containsTerrain(Terrains.WATER) &amp;&amp; !nextHex</span>
<span class="nc bnc" id="L5184" title="All 2 branches missed.">                            .containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L5185" title="All 2 branches missed.">                            || nextHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L5186" title="All 2 branches missed.">                            || nextHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L5187">                        addReport(destroyEntity(entity, &quot;could not land in crash site&quot;));</span>
<span class="nc bnc" id="L5188" title="All 2 branches missed.">                    } else if (elevation &lt; nextHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5189">                        Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

                        // If you crash into a wall you want to stop in the hex
                        // before the wall not in the wall
                        // Like a building.
<span class="nc bnc" id="L5194" title="All 2 branches missed.">                        if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5195">                            addReport(destroyEntity(entity, &quot;crashed into a wall&quot;));</span>
<span class="nc" id="L5196">                            break;</span>
                        }
<span class="nc bnc" id="L5198" title="All 2 branches missed.">                        if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5199">                            addReport(destroyEntity(entity, &quot;crashed into a gun emplacement&quot;));</span>
<span class="nc" id="L5200">                            break;</span>
                        }

<span class="nc" id="L5203">                        addReport(destroyEntity(entity, &quot;crashed into building&quot;));</span>
<span class="nc" id="L5204">                    } else {</span>
<span class="nc" id="L5205">                        entity.setPosition(nextPos);</span>
<span class="nc" id="L5206">                        entity.setElevation(0);</span>
<span class="nc" id="L5207">                        addReport(doEntityDisplacementMinefieldCheck(entity,</span>
                                curPos, nextPos, nextElevation));
                    }
<span class="nc" id="L5210">                    break;</span>

                }
                // skidding into higher terrain does weight/20
                // damage in 5pt clusters to front.
<span class="nc" id="L5215">                int damage = ((int) entity.getWeight() + 19) / 20;</span>
<span class="nc bnc" id="L5216" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L5217">                    int table = ToHitData.HIT_NORMAL;</span>
<span class="nc" id="L5218">                    int side = entity.sideTable(nextPos);</span>
<span class="nc bnc" id="L5219" title="All 2 branches missed.">                    if (entity instanceof Protomech) {</span>
<span class="nc" id="L5220">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
                    }
<span class="nc" id="L5222">                    HitData hitData = entity.rollHitLocation(table, side);</span>
<span class="nc" id="L5223">                    hitData.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5224">                    addReport(damageEntity(entity, hitData, Math.min(5, damage)));</span>
<span class="nc" id="L5225">                    damage -= 5;</span>
<span class="nc" id="L5226">                }</span>
                // Stay in the current hex and stop skidding.
                break;
            }

            // did we hit a DropShip. Oww!
            // Taharqa: The rules on how to handle this are completely missing, so I am assuming
            // we assign damage as per an accidental charge, but do not displace
            // the DropShip and end the skid
<span class="nc bnc" id="L5235" title="All 2 branches missed.">            else if (null != crashDropShip) {</span>
<span class="nc" id="L5236">                r = new Report(2050);</span>
<span class="nc" id="L5237">                r.subject = entity.getId();</span>
<span class="nc" id="L5238">                r.indent();</span>
<span class="nc" id="L5239">                r.add(crashDropShip.getShortName(), true);</span>
<span class="nc" id="L5240">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5241">                addReport(r);</span>
<span class="nc" id="L5242">                ChargeAttackAction caa = new ChargeAttackAction(entity.getId(),</span>
<span class="nc" id="L5243">                        crashDropShip.getTargetType(),</span>
<span class="nc" id="L5244">                        crashDropShip.getTargetId(),</span>
<span class="nc" id="L5245">                        crashDropShip.getPosition());</span>
<span class="nc" id="L5246">                ToHitData toHit = caa.toHit(game, true);</span>
<span class="nc" id="L5247">                resolveChargeDamage(entity, crashDropShip, toHit, direction);</span>
<span class="nc bnc" id="L5248" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L5249" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L5250">                    int hitSide = (step.getFacing() - direction) + 6;</span>
<span class="nc" id="L5251">                    hitSide %= 6;</span>
<span class="nc" id="L5252">                    int table = 0;</span>
<span class="nc bnc" id="L5253" title="All 5 branches missed.">                    switch (hitSide) {// quite hackish...I think it ought to work, though.</span>
                        case 0:// can this happen?
<span class="nc" id="L5255">                            table = ToHitData.SIDE_FRONT;</span>
<span class="nc" id="L5256">                            break;</span>
                        case 1:
                        case 2:
<span class="nc" id="L5259">                            table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L5260">                            break;</span>
                        case 3:
<span class="nc" id="L5262">                            table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L5263">                            break;</span>
                        case 4:
                        case 5:
<span class="nc" id="L5266">                            table = ToHitData.SIDE_RIGHT;</span>
                            break;
                    }
<span class="nc" id="L5269">                    elevation = nextElevation;</span>
<span class="nc" id="L5270">                    addReport(crashVTOLorWiGE((VTOL) entity, false, true,</span>
                            distance, curPos, elevation, table));
<span class="nc" id="L5272">                    break;</span>
                }
<span class="nc bnc" id="L5274" title="All 4 branches missed.">                if (!crashDropShip.isDoomed() &amp;&amp; !crashDropShip.isDestroyed()</span>
<span class="nc bnc" id="L5275" title="All 2 branches missed.">                        &amp;&amp; !game.isOutOfGame(crashDropShip)) {</span>
<span class="nc" id="L5276">                    break;</span>
                }
<span class="nc" id="L5278">            }</span>

            // Have skidding units suffer falls (off a cliff).
<span class="nc bnc" id="L5281" title="All 2 branches missed.">            else if ( (curAltitude &gt; (nextAltitude + entity.getMaxElevationChange())</span>
<span class="nc bnc" id="L5282" title="All 4 branches missed.">                    || (curHex.hasCliffTopTowards(nextHex) &amp;&amp; curAltitude &gt; nextAltitude) )</span>
<span class="nc bnc" id="L5283" title="All 4 branches missed.">                    &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; elevation &gt; curHex.ceiling())) {</span>
<span class="nc" id="L5284">                addReport(doEntityFallsInto(entity, entity.getElevation(), curPos, nextPos,</span>
<span class="nc" id="L5285">                        entity.getBasePilotingRoll(moveType), true));</span>
<span class="nc" id="L5286">                addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
                // Stay in the current hex and stop skidding.
<span class="nc" id="L5288">                break;</span>
            }

            // Get any building in the hex.
<span class="nc" id="L5292">            Building bldg = null;</span>
<span class="nc bnc" id="L5293" title="All 2 branches missed.">            if (nextElevation &lt; nextHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
                // We will only run into the building if its at a higher level,
                // otherwise we skid over the roof
<span class="nc" id="L5296">                bldg = game.getBoard().getBuildingAt(nextPos);</span>
            }
<span class="nc" id="L5298">            boolean bldgSuffered = false;</span>
<span class="nc" id="L5299">            boolean stopTheSkid = false;</span>
            // Does the next hex contain an entities?
            // ASSUMPTION: hurt EVERYONE in the hex.
<span class="nc" id="L5302">            Iterator&lt;Entity&gt; targets = game.getEntities(nextPos);</span>
<span class="nc bnc" id="L5303" title="All 2 branches missed.">            if (targets.hasNext()) {</span>
<span class="nc" id="L5304">                List&lt;Entity&gt; avoidedChargeUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L5305">                boolean skidChargeHit = false;</span>
<span class="nc bnc" id="L5306" title="All 2 branches missed.">                while (targets.hasNext()) {</span>
<span class="nc" id="L5307">                    Entity target = targets.next();</span>

<span class="nc bnc" id="L5309" title="All 2 branches missed.">                    if ((target.getElevation() &gt; (nextElevation + entity.getHeight()))</span>
<span class="nc bnc" id="L5310" title="All 2 branches missed.">                            || (target.relHeight() &lt; nextElevation)) {</span>
                        // target is not in the way
<span class="nc" id="L5312">                        continue;</span>
                    }

                    // Can the target avoid the skid?
<span class="nc bnc" id="L5316" title="All 2 branches missed.">                    if (!target.isDone()) {</span>
<span class="nc bnc" id="L5317" title="All 2 branches missed.">                        if (target instanceof Infantry) {</span>
<span class="nc" id="L5318">                            r = new Report(2420);</span>
<span class="nc" id="L5319">                            r.subject = target.getId();</span>
<span class="nc" id="L5320">                            r.addDesc(target);</span>
<span class="nc" id="L5321">                            addReport(r);</span>
<span class="nc" id="L5322">                            continue;</span>
<span class="nc bnc" id="L5323" title="All 2 branches missed.">                        } else if (target instanceof Protomech) {</span>
<span class="nc bnc" id="L5324" title="All 2 branches missed.">                            if (target != Compute.stackingViolation(game, entity, nextPos, null)) {</span>
<span class="nc" id="L5325">                                r = new Report(2420);</span>
<span class="nc" id="L5326">                                r.subject = target.getId();</span>
<span class="nc" id="L5327">                                r.addDesc(target);</span>
<span class="nc" id="L5328">                                addReport(r);</span>
<span class="nc" id="L5329">                                continue;</span>
                            }
                        } else {
<span class="nc" id="L5332">                            PilotingRollData psr = target.getBasePilotingRoll();</span>
<span class="nc" id="L5333">                            psr.addModifier(0, &quot;avoiding collision&quot;);</span>
<span class="nc bnc" id="L5334" title="All 2 branches missed.">                            if (psr.getValue() == TargetRoll.AUTOMATIC_FAIL</span>
<span class="nc bnc" id="L5335" title="All 2 branches missed.">                                    || psr.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L5336">                                r = new Report(2426);</span>
<span class="nc" id="L5337">                                r.subject = target.getId();</span>
<span class="nc" id="L5338">                                r.addDesc(target);</span>
<span class="nc" id="L5339">                                r.add(psr.getDesc());</span>
<span class="nc" id="L5340">                                addReport(r);</span>
                            } else {
<span class="nc" id="L5342">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L5343">                                r = new Report(2425);</span>
<span class="nc" id="L5344">                                r.subject = target.getId();</span>
<span class="nc" id="L5345">                                r.addDesc(target);</span>
<span class="nc" id="L5346">                                r.add(psr);</span>
<span class="nc" id="L5347">                                r.add(psr.getDesc());</span>
<span class="nc" id="L5348">                                r.add(roll);</span>
<span class="nc" id="L5349">                                addReport(r);</span>
<span class="nc bnc" id="L5350" title="All 2 branches missed.">                                if (roll &gt;= psr.getValue()) {</span>
<span class="nc" id="L5351">                                    game.removeTurnFor(target);</span>
<span class="nc" id="L5352">                                    avoidedChargeUnits.add(target);</span>
<span class="nc" id="L5353">                                    continue;</span>
                                    // TODO : the charge should really be suspended
                                    // and resumed after the target moved.
                                }
                            }
                        }
                    }

                    // Mechs and vehicles get charged,
                    // but need to make a to-hit roll
<span class="nc bnc" id="L5363" title="All 6 branches missed.">                    if ((target instanceof Mech) || (target instanceof Tank)</span>
                            || (target instanceof Aero)) {
<span class="nc" id="L5365">                        ChargeAttackAction caa = new ChargeAttackAction(</span>
<span class="nc" id="L5366">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L5367">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L5368">                        ToHitData toHit = caa.toHit(game, true);</span>

                        // roll
<span class="nc" id="L5371">                        int roll = Compute.d6(2);</span>
                        // Update report.
<span class="nc" id="L5373">                        r = new Report(2050);</span>
<span class="nc" id="L5374">                        r.subject = entity.getId();</span>
<span class="nc" id="L5375">                        r.indent();</span>
<span class="nc" id="L5376">                        r.add(target.getShortName(), true);</span>
<span class="nc" id="L5377">                        r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5378">                        r.newlines = 0;</span>
<span class="nc" id="L5379">                        addReport(r);</span>
<span class="nc bnc" id="L5380" title="All 2 branches missed.">                        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L5381">                            roll = -12;</span>
<span class="nc" id="L5382">                            r = new Report(2055);</span>
<span class="nc" id="L5383">                            r.subject = entity.getId();</span>
<span class="nc" id="L5384">                            r.add(toHit.getDesc());</span>
<span class="nc" id="L5385">                            r.newlines = 0;</span>
<span class="nc" id="L5386">                            addReport(r);</span>
<span class="nc bnc" id="L5387" title="All 2 branches missed.">                        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L5388">                            r = new Report(2060);</span>
<span class="nc" id="L5389">                            r.subject = entity.getId();</span>
<span class="nc" id="L5390">                            r.add(toHit.getDesc());</span>
<span class="nc" id="L5391">                            r.newlines = 0;</span>
<span class="nc" id="L5392">                            addReport(r);</span>
<span class="nc" id="L5393">                            roll = Integer.MAX_VALUE;</span>
                        } else {
                            // report the roll
<span class="nc" id="L5396">                            r = new Report(2065);</span>
<span class="nc" id="L5397">                            r.subject = entity.getId();</span>
<span class="nc" id="L5398">                            r.add(toHit);</span>
<span class="nc" id="L5399">                            r.add(roll);</span>
<span class="nc" id="L5400">                            r.newlines = 0;</span>
<span class="nc" id="L5401">                            addReport(r);</span>
                        }

                        // Resolve a charge against the target.
                        // ASSUMPTION: buildings block damage for
                        // *EACH* entity charged.
<span class="nc bnc" id="L5407" title="All 2 branches missed.">                        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L5408">                            r = new Report(2070);</span>
<span class="nc" id="L5409">                            r.subject = entity.getId();</span>
<span class="nc" id="L5410">                            addReport(r);</span>
                        } else {
                            // Resolve the charge.
<span class="nc" id="L5413">                            resolveChargeDamage(entity, target, toHit, direction);</span>
                            // HACK: set the entity's location
                            // to the original hex again, for the other targets
<span class="nc bnc" id="L5416" title="All 2 branches missed.">                            if (targets.hasNext()) {</span>
<span class="nc" id="L5417">                                entity.setPosition(curPos);</span>
                            }
<span class="nc" id="L5419">                            bldgSuffered = true;</span>
<span class="nc" id="L5420">                            skidChargeHit = true;</span>
                            // The skid ends here if the target lives.
<span class="nc bnc" id="L5422" title="All 4 branches missed.">                            if (!target.isDoomed() &amp;&amp; !target.isDestroyed()</span>
<span class="nc bnc" id="L5423" title="All 2 branches missed.">                                    &amp;&amp; !game.isOutOfGame(target)) {</span>
<span class="nc" id="L5424">                                stopTheSkid = true;</span>
                            }
                        }

                        // if we don't do this here,
                        // we can have a mech without a leg
                        // standing on the field and moving
                        // as if it still had his leg after
                        // getting skid-charged.
<span class="nc bnc" id="L5433" title="All 2 branches missed.">                        if (!target.isDone()) {</span>
<span class="nc" id="L5434">                            addReport(resolvePilotingRolls(target));</span>
<span class="nc" id="L5435">                            game.resetPSRs(target);</span>
<span class="nc" id="L5436">                            target.applyDamage();</span>
<span class="nc" id="L5437">                            addNewLines();</span>
                        }

<span class="nc" id="L5440">                    }</span>

                    // Resolve &quot;move-through&quot; damage on infantry.
                    // Infantry inside of a building don't get a
                    // move-through, but suffer &quot;bleed through&quot;
                    // from the building.
<span class="nc bnc" id="L5446" title="All 4 branches missed.">                    else if ((target instanceof Infantry) &amp;&amp; (bldg != null)) {</span>
                        // Update report.
<span class="nc" id="L5448">                        r = new Report(2075);</span>
<span class="nc" id="L5449">                        r.subject = entity.getId();</span>
<span class="nc" id="L5450">                        r.indent();</span>
<span class="nc" id="L5451">                        r.add(target.getShortName(), true);</span>
<span class="nc" id="L5452">                        r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5453">                        r.newlines = 0;</span>
<span class="nc" id="L5454">                        addReport(r);</span>

                        // Infantry don't have different
                        // tables for punches and kicks
<span class="nc" id="L5458">                        HitData hit = target.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L5459">                                Compute.targetSideTable(entity, target));</span>
<span class="nc" id="L5460">                        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
                        // Damage equals tonnage, divided by 5.
                        // ASSUMPTION: damage is applied in one hit.
<span class="nc" id="L5463">                        addReport(damageEntity(target, hit, (int) Math.round(entity.getWeight() / 5)));</span>
<span class="nc" id="L5464">                        addNewLines();</span>
                    }

                    // Has the target been destroyed?
<span class="nc bnc" id="L5468" title="All 2 branches missed.">                    if (target.isDoomed()) {</span>
                        // Has the target taken a turn?
<span class="nc bnc" id="L5470" title="All 2 branches missed.">                        if (!target.isDone()) {</span>
                            // Dead entities don't take turns.
<span class="nc" id="L5472">                            game.removeTurnFor(target);</span>
<span class="nc" id="L5473">                            send(createTurnVectorPacket());</span>
                        } // End target-still-to-move

                        // Clean out the entity.
<span class="nc" id="L5477">                        target.setDestroyed(true);</span>
<span class="nc" id="L5478">                        game.moveToGraveyard(target.getId());</span>
<span class="nc" id="L5479">                        send(createRemoveEntityPacket(target.getId()));</span>
                    }
                    // Update the target's position,
                    // unless it is off the game map.
<span class="nc bnc" id="L5483" title="All 2 branches missed.">                    if (!game.isOutOfGame(target)) {</span>
<span class="nc" id="L5484">                        entityUpdate(target.getId());</span>
                    }
<span class="nc" id="L5486">                } // Check the next entity in the hex.</span>

<span class="nc bnc" id="L5488" title="All 2 branches missed.">                if (skidChargeHit) {</span>
                    // HACK: set the entities position to that
                    // hex's coords, because we had to move the entity
                    // back earlier for the other targets
<span class="nc" id="L5492">                    entity.setPosition(nextPos);</span>
                }
<span class="nc bnc" id="L5494" title="All 2 branches missed.">                for (Entity e : avoidedChargeUnits) {</span>
<span class="nc" id="L5495">                    GameTurn newTurn = new GameTurn.SpecificEntityTurn(e.getOwner().getId(), e.getId());</span>
                    // Prevents adding extra turns for multi-turns
<span class="nc" id="L5497">                    newTurn.setMultiTurn(true);</span>
<span class="nc" id="L5498">                    game.insertNextTurn(newTurn);</span>
<span class="nc" id="L5499">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L5500">                }</span>
            }

            // Handle the building in the hex.
<span class="nc bnc" id="L5504" title="All 2 branches missed.">            if (bldg != null) {</span>
                // Report that the entity has entered the bldg.
<span class="nc" id="L5506">                r = new Report(2080);</span>
<span class="nc" id="L5507">                r.subject = entity.getId();</span>
<span class="nc" id="L5508">                r.indent();</span>
<span class="nc" id="L5509">                r.add(bldg.getName());</span>
<span class="nc" id="L5510">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5511">                addReport(r);</span>

                // If the building hasn't already suffered
                // damage, then apply charge damage to the
                // building and displace the entity inside.
                // ASSUMPTION: you don't charge the building
                // if Tanks or Mechs were charged.
<span class="nc" id="L5518">                int chargeDamage = ChargeAttackAction.getDamageFor(entity, game</span>
<span class="nc" id="L5519">                        .getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
                        entity.delta_distance);
<span class="nc bnc" id="L5521" title="All 2 branches missed.">                if (!bldgSuffered) {</span>
<span class="nc" id="L5522">                    Vector&lt;Report&gt; reports = damageBuilding(bldg, chargeDamage, nextPos);</span>
<span class="nc bnc" id="L5523" title="All 2 branches missed.">                    for (Report report : reports) {</span>
<span class="nc" id="L5524">                        report.subject = entity.getId();</span>
<span class="nc" id="L5525">                    }</span>
<span class="nc" id="L5526">                    addReport(reports);</span>

                    // Apply damage to the attacker.
<span class="nc" id="L5529">                    int toAttacker = ChargeAttackAction.getDamageTakenBy(entity, bldg, nextPos);</span>
<span class="nc" id="L5530">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(nextPos));</span>
<span class="nc" id="L5531">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5532">                    addReport(damageEntity(entity, hit, toAttacker));</span>
<span class="nc" id="L5533">                    addNewLines();</span>

<span class="nc" id="L5535">                    entity.setPosition(nextPos);</span>
<span class="nc" id="L5536">                    entity.setElevation(nextElevation);</span>
<span class="nc" id="L5537">                    addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
<span class="nc" id="L5538">                    curPos = nextPos;</span>
                } // End buildings-suffer-too

                // Any infantry in the building take damage
                // equal to the building being charged.
                // ASSUMPTION: infantry take no damage from the
                // building absorbing damage from
                // Tanks and Mechs being charged.
<span class="nc" id="L5546">                addReport(damageInfantryIn(bldg, chargeDamage, nextPos));</span>

                // If a building still stands, then end the skid,
                // and add it to the list of affected buildings.
<span class="nc bnc" id="L5550" title="All 2 branches missed.">                if (bldg.getCurrentCF(nextPos) &gt; 0) {</span>
<span class="nc" id="L5551">                    stopTheSkid = true;</span>
<span class="nc bnc" id="L5552" title="All 2 branches missed.">                    if (bldg.rollBasement(nextPos, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L5553">                        sendChangedHex(nextPos);</span>
<span class="nc" id="L5554">                        Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L5555">                        buildings.add(bldg);</span>
<span class="nc" id="L5556">                        sendChangedBuildings(buildings);</span>
                    }
<span class="nc" id="L5558">                    addAffectedBldg(bldg, checkBuildingCollapseWhileMoving(bldg, entity, nextPos));</span>
                } else {
                    // otherwise it collapses immediately on our head
<span class="nc" id="L5561">                    checkForCollapse(bldg, game.getPositionMap(), nextPos, true, vPhaseReport);</span>
                }
            } // End handle-building.

            // Do we stay in the current hex and stop skidding?
<span class="nc bnc" id="L5566" title="All 2 branches missed.">            if (stopTheSkid) {</span>
<span class="nc" id="L5567">                break;</span>
            }

            // Update entity position and elevation
<span class="nc" id="L5571">            entity.setPosition(nextPos);</span>
<span class="nc" id="L5572">            entity.setElevation(nextElevation);</span>
<span class="nc" id="L5573">            addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
<span class="nc" id="L5574">            skidDistance++;</span>

            // Check for collapse of any building the entity might be on
<span class="nc" id="L5577">            Building roof = game.getBoard().getBuildingAt(nextPos);</span>
<span class="nc bnc" id="L5578" title="All 2 branches missed.">            if (roof != null) {</span>
<span class="nc bnc" id="L5579" title="All 2 branches missed.">                if (checkForCollapse(roof, game.getPositionMap(), nextPos, true, vPhaseReport)) {</span>
<span class="nc" id="L5580">                    break; // stop skidding if the building collapsed</span>
                }
            }

            // Can the skidding entity enter the next hex from this?
            // N.B. can skid along roads.
<span class="nc bnc" id="L5586" title="All 4 branches missed.">            if ((entity.isLocationProhibited(start) || entity.isLocationProhibited(nextPos))</span>
<span class="nc bnc" id="L5587" title="All 2 branches missed.">                    &amp;&amp; !Compute.canMoveOnPavement(game, curPos, nextPos, step)) {</span>
                // Update report.
<span class="nc" id="L5589">                r = new Report(2040);</span>
<span class="nc" id="L5590">                r.subject = entity.getId();</span>
<span class="nc" id="L5591">                r.indent();</span>
<span class="nc" id="L5592">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5593">                addReport(r);</span>

                // If the prohibited terrain is water, entity is destroyed
<span class="nc bnc" id="L5596" title="All 4 branches missed.">                if ((nextHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
                        &amp;&amp; (entity instanceof Tank)
<span class="nc bnc" id="L5598" title="All 2 branches missed.">                        &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5599" title="All 2 branches missed.">                        &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L5600">                    addReport(destroyEntity(entity,</span>
                            &quot;skidded into a watery grave&quot;, false, true));
                }

                // otherwise, damage is weight/5 in 5pt clusters
<span class="nc" id="L5605">                int damage = ((int) entity.getWeight() + 4) / 5;</span>
<span class="nc bnc" id="L5606" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L5607">                    addReport(damageEntity(entity, entity.rollHitLocation(</span>
                            ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),
<span class="nc" id="L5609">                            Math.min(5, damage)));</span>
<span class="nc" id="L5610">                    damage -= 5;</span>
                }
                // and unit is immobile
<span class="nc bnc" id="L5613" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L5614">                    ((Tank) entity).immobilize();</span>
                }

                // Stay in the current hex and stop skidding.
                break;
            }

<span class="nc bnc" id="L5621" title="All 2 branches missed.">            if ((nextHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L5622" title="All 2 branches missed.">                    &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5623" title="All 2 branches missed.">                    &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)) {</span>
                // water ends the skid
<span class="nc" id="L5625">                break;</span>
            }

            // check for breaking magma crust
            // note that this must sequentially occur before the next 'entering liquid magma' check
            // otherwise, magma crust won't have a chance to break
<span class="nc" id="L5631">            ServerHelper.checkAndApplyMagmaCrust(nextHex, nextElevation, entity, curPos, false, vPhaseReport, this);</span>

            // is the next hex a swamp?
<span class="nc" id="L5634">            PilotingRollData rollTarget = entity.checkBogDown(step, moveType, nextHex, curPos, nextPos,</span>
<span class="nc" id="L5635">                    step.getElevation(), Compute.canMoveOnPavement(game, curPos, nextPos, step));</span>

<span class="nc bnc" id="L5637" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Taharqa: According to TacOps, you automatically stick if you
                // are skidding, (pg. 63)
                // if (0 &lt; doSkillCheckWhileMoving(entity, curPos, nextPos,
                // rollTarget, false)) {
<span class="nc" id="L5642">                entity.setStuck(true);</span>
<span class="nc" id="L5643">                r = new Report(2081);</span>
<span class="nc" id="L5644">                r.subject = entity.getId();</span>
<span class="nc" id="L5645">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L5646">                addReport(r);</span>
                // check for quicksand
<span class="nc" id="L5648">                addReport(checkQuickSand(nextPos));</span>
                // check for accidental stacking violation
<span class="nc" id="L5650">                Entity violation = Compute.stackingViolation(game, entity.getId(), curPos);</span>
<span class="nc bnc" id="L5651" title="All 2 branches missed.">                if (violation != null) {</span>
                    // target gets displaced, because of low elevation
<span class="nc" id="L5653">                    Coords targetDest = Compute.getValidDisplacement(game, entity.getId(), curPos,</span>
                            direction);
<span class="nc" id="L5655">                    addReport(doEntityDisplacement(violation, curPos, targetDest,</span>
<span class="nc" id="L5656">                            new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;)));</span>
                    // Update the violating entity's position on the client.
<span class="nc" id="L5658">                    entityUpdate(violation.getId());</span>
<span class="nc" id="L5659">                }</span>
                // stay here and stop skidding, see bug 1115608
                break;
            }

            // Update the position and keep skidding.
<span class="nc" id="L5665">            curPos = nextPos;</span>
<span class="nc" id="L5666">            curHex = nextHex;</span>
<span class="nc" id="L5667">            elevation = nextElevation;</span>
<span class="nc" id="L5668">            r = new Report(2085);</span>
<span class="nc" id="L5669">            r.subject = entity.getId();</span>
<span class="nc" id="L5670">            r.indent();</span>
<span class="nc" id="L5671">            r.add(curPos.getBoardNum(), true);</span>
<span class="nc" id="L5672">            addReport(r);</span>

<span class="nc bnc" id="L5674" title="All 4 branches missed.">            if (flip &amp;&amp; entity instanceof Tank) {</span>
<span class="nc bnc" id="L5675" title="All 2 branches missed.">                doVehicleFlipDamage((Tank)entity, flipDamage, direction &lt; 3, skidDistance - 1);</span>
            }

<span class="nc" id="L5678">        } // Handle the next skid hex.</span>

        // If the skidding entity violates stacking,
        // displace targets until it doesn't.
<span class="nc" id="L5682">        curPos = entity.getPosition();</span>
<span class="nc" id="L5683">        Entity target = Compute.stackingViolation(game, entity.getId(), curPos);</span>
<span class="nc bnc" id="L5684" title="All 2 branches missed.">        while (target != null) {</span>
<span class="nc" id="L5685">            nextPos = Compute.getValidDisplacement(game, target.getId(), target.getPosition(), direction);</span>
            // ASSUMPTION
            // There should always be *somewhere* that
            // the target can go... last skid hex if
            // nothing else is available.
<span class="nc bnc" id="L5690" title="All 2 branches missed.">            if (null == nextPos) {</span>
                // But I don't trust the assumption fully.
                // Report the error and try to continue.
<span class="nc" id="L5693">                MegaMek.getLogger().error(&quot;The skid of &quot; + entity.getShortName()</span>
<span class="nc" id="L5694">                                + &quot; should displace &quot; + target.getShortName()</span>
<span class="nc" id="L5695">                                + &quot; in hex &quot; + curPos.getBoardNum()</span>
                                + &quot; but there is nowhere to go.&quot;);
<span class="nc" id="L5697">                break;</span>
            }
            // indent displacement
<span class="nc" id="L5700">            r = new Report(1210, Report.PUBLIC);</span>
<span class="nc" id="L5701">            r.indent();</span>
<span class="nc" id="L5702">            r.newlines = 0;</span>
<span class="nc" id="L5703">            addReport(r);</span>
<span class="nc" id="L5704">            addReport(doEntityDisplacement(target, curPos, nextPos, null));</span>
<span class="nc" id="L5705">            addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, entity.getElevation()));</span>
<span class="nc" id="L5706">            target = Compute.stackingViolation(game, entity.getId(), curPos);</span>
        }

        // Mechs suffer damage for every hex skidded.
        // For QuadVees in vehicle mode, apply
        // damage only if flipping.
<span class="nc bnc" id="L5712" title="All 2 branches missed.">        boolean mechDamage = ((entity instanceof Mech)</span>
<span class="nc bnc" id="L5713" title="All 4 branches missed.">                &amp;&amp; !((entity.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (entity.getElevation() &gt; 0)));</span>
<span class="nc bnc" id="L5714" title="All 4 branches missed.">        if (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
<span class="nc" id="L5715">            mechDamage = flip;</span>
        }
<span class="nc bnc" id="L5717" title="All 2 branches missed.">        if (mechDamage) {</span>
            // Calculate one half falling damage times skid length.
<span class="nc" id="L5719">            int damage = skidDistance * (int) Math.ceil(Math.round(entity.getWeight() / 10.0) / 2.0);</span>

            // report skid damage
<span class="nc" id="L5722">            r = new Report(2090);</span>
<span class="nc" id="L5723">            r.subject = entity.getId();</span>
<span class="nc" id="L5724">            r.indent();</span>
<span class="nc" id="L5725">            r.addDesc(entity);</span>
<span class="nc" id="L5726">            r.add(damage);</span>
<span class="nc" id="L5727">            addReport(r);</span>

            // standard damage loop
            // All skid damage is to the front.
<span class="nc bnc" id="L5731" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L5732">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L5733">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L5734">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5735">                addReport(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L5736">                damage -= cluster;</span>
<span class="nc" id="L5737">            }</span>
<span class="nc" id="L5738">            addNewLines();</span>
        }

<span class="nc bnc" id="L5741" title="All 4 branches missed.">        if (flip &amp;&amp; entity instanceof Tank) {</span>
<span class="nc" id="L5742">            addReport(applyCriticalHit(entity, Entity.NONE, new CriticalSlot(0, Tank.CRIT_CREW_STUNNED),</span>
                    true, 0, false));
<span class="nc bnc" id="L5744" title="All 6 branches missed.">        } else if (flip &amp;&amp; entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
            // QuadVees don't suffer stunned crew criticals; require PSR to avoid damage instead.
<span class="nc" id="L5746">            PilotingRollData prd = entity.getBasePilotingRoll();</span>
<span class="nc" id="L5747">            addReport(checkPilotAvoidFallDamage(entity, 1, prd));</span>
        }

        // Clean up the entity if it has been destroyed.
<span class="nc bnc" id="L5751" title="All 2 branches missed.">        if (entity.isDoomed()) {</span>
<span class="nc" id="L5752">            entity.setDestroyed(true);</span>
<span class="nc" id="L5753">            game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L5754">            send(createRemoveEntityPacket(entity.getId()));</span>

            // The entity's movement is completed.
<span class="nc" id="L5757">            return true;</span>
        }

        // Let the player know the ordeal is over.
<span class="nc" id="L5761">        r = new Report(2095);</span>
<span class="nc" id="L5762">        r.subject = entity.getId();</span>
<span class="nc" id="L5763">        r.indent();</span>
<span class="nc" id="L5764">        addReport(r);</span>

<span class="nc" id="L5766">        return false;</span>
    }

    /**
     * Roll on the failed vehicle maneuver table.
     *
     * @param entity    The vehicle that failed the maneuver.
     * @param curPos    The coordinates of the hex in which the maneuver was attempted.
     * @param turnDirection The difference between the intended final facing and the starting facing
     *                      (-1 for left turn, 1 for right turn, 0 for not turning).
     * @param prevStep  The &lt;code&gt;MoveStep&lt;/code&gt; immediately preceding the one being processed.
     *                  Cannot be null; if the check is made for the first step of the path,
     *                  use the current step.
     * @param lastStepMoveType  The &lt;code&gt;EntityMovementType&lt;/code&gt; of the last step in the path.
     * @param distance  The distance moved so far during the phase; used to calculate any potential skid.
     * @param modifier  The modifier to the maneuver failure roll.
     * @return          true if the maneuver failure result ends the unit's turn.
     */
    private boolean processFailedVehicleManeuver(Entity entity, Coords curPos, int turnDirection,
            MoveStep prevStep, boolean isBackwards, EntityMovementType lastStepMoveType, int distance,
            int modifier, int marginOfFailure) {
<span class="nc" id="L5787">        IHex curHex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L5788" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WHEELED</span>
<span class="nc bnc" id="L5789" title="All 2 branches missed.">                &amp;&amp; !curHex.containsTerrain(Terrains.PAVEMENT)) {</span>
<span class="nc" id="L5790">            modifier += 2;</span>
        }
<span class="nc bnc" id="L5792" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L5793">            modifier += 2;</span>
<span class="nc bnc" id="L5794" title="All 2 branches missed.">        } else if (entity.getMovementMode() == EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L5795" title="All 4 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; entity instanceof Tank)</span>
<span class="nc bnc" id="L5796" title="All 2 branches missed.">                || entity.getMovementMode() == EntityMovementMode.HYDROFOIL) {</span>
<span class="nc" id="L5797">            modifier += 4;</span>
        }
<span class="nc bnc" id="L5799" title="All 2 branches missed.">        if (entity.getWeightClass() &lt; EntityWeightClass.WEIGHT_MEDIUM</span>
<span class="nc bnc" id="L5800" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</span>
<span class="nc" id="L5801">            modifier++;</span>
<span class="nc bnc" id="L5802" title="All 2 branches missed.">        } else if (entity.getWeightClass() == EntityWeightClass.WEIGHT_HEAVY</span>
<span class="nc bnc" id="L5803" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_LARGE_SUPPORT) {</span>
<span class="nc" id="L5804">            modifier--;</span>
<span class="nc bnc" id="L5805" title="All 2 branches missed.">        } else if (entity.getWeightClass() == EntityWeightClass.WEIGHT_ASSAULT</span>
<span class="nc bnc" id="L5806" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY) {</span>
<span class="nc" id="L5807">            modifier -= 2;</span>
        }
<span class="nc" id="L5809">        boolean turnEnds = false;</span>
<span class="nc" id="L5810">        boolean motiveDamage = false;</span>
<span class="nc" id="L5811">        int motiveDamageMod = 0;</span>
<span class="nc" id="L5812">        boolean skid = false;</span>
<span class="nc" id="L5813">        boolean flip = false;</span>
<span class="nc bnc" id="L5814" title="All 2 branches missed.">        boolean isGroundVehicle = ((entity instanceof Tank)</span>
<span class="nc bnc" id="L5815" title="All 2 branches missed.">                &amp;&amp; ((entity.getMovementMode() == EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L5816" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WHEELED)));</span>

<span class="nc" id="L5818">        int roll = Compute.d6(2);</span>

<span class="nc" id="L5820">        Report r = new Report(2505);</span>
<span class="nc" id="L5821">        r.subject = entity.getId();</span>
<span class="nc" id="L5822">        r.newlines = 0;</span>
<span class="nc" id="L5823">        r.indent(2);</span>
<span class="nc" id="L5824">        addReport(r);</span>
<span class="nc" id="L5825">        r = new Report(6310);</span>
<span class="nc" id="L5826">        r.subject = entity.getId();</span>
<span class="nc" id="L5827">        r.add(roll);</span>
<span class="nc" id="L5828">        r.newlines = 0;</span>
<span class="nc" id="L5829">        addReport(r);</span>
<span class="nc" id="L5830">        r = new Report(3340);</span>
<span class="nc" id="L5831">        r.add(modifier);</span>
<span class="nc" id="L5832">        r.subject = entity.getId();</span>
<span class="nc" id="L5833">        r.newlines = 0;</span>
<span class="nc" id="L5834">        addReport(r);</span>

<span class="nc" id="L5836">        r = new Report(1210);</span>
<span class="nc" id="L5837">        r.subject = entity.getId();</span>
<span class="nc" id="L5838">        roll += modifier;</span>
<span class="nc bnc" id="L5839" title="All 2 branches missed.">        if (roll &lt; 8) {</span>
<span class="nc" id="L5840">            r.messageId = 2506;</span>
            // minor fishtail, fail to turn
<span class="nc" id="L5842">            turnDirection = 0;</span>
<span class="nc bnc" id="L5843" title="All 2 branches missed.">        } else if (roll &lt; 10) {</span>
<span class="nc" id="L5844">            r.messageId = 2507;</span>
            // moderate fishtail, turn an extra hexside and roll for motive damage at -1.
<span class="nc bnc" id="L5846" title="All 2 branches missed.">            if (turnDirection == 0) {</span>
<span class="nc bnc" id="L5847" title="All 2 branches missed.">                turnDirection = Compute.d6() &lt; 4? -1 : 1;</span>
            } else {
<span class="nc" id="L5849">                turnDirection *= 2;</span>
            }
<span class="nc" id="L5851">            motiveDamage = true;</span>
<span class="nc" id="L5852">            motiveDamageMod = -1;</span>
<span class="nc bnc" id="L5853" title="All 2 branches missed.">        } else if (roll &lt; 12) {</span>
<span class="nc" id="L5854">            r.messageId = 2508;</span>
            // serious fishtail, turn an extra hexside and roll for motive damage. Turn ends.
<span class="nc bnc" id="L5856" title="All 2 branches missed.">            if (turnDirection == 0) {</span>
<span class="nc bnc" id="L5857" title="All 2 branches missed.">                turnDirection = Compute.d6() &lt; 4? -1 : 1;</span>
            } else {
<span class="nc" id="L5859">                turnDirection *= 2;</span>
            }
<span class="nc" id="L5861">            motiveDamage = true;</span>
<span class="nc" id="L5862">            turnEnds = true;</span>
        } else {
<span class="nc" id="L5864">            r.messageId = 2509;</span>
            // Turn fails and vehicle skids
            // Wheeled and naval vehicles start to flip if the roll is high enough.
<span class="nc bnc" id="L5867" title="All 2 branches missed.">            if (roll &gt; 13) {</span>
<span class="nc bnc" id="L5868" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L5869">                    r.messageId = 2510;</span>
<span class="nc" id="L5870">                    flip = true;</span>
<span class="nc bnc" id="L5871" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.NAVAL</span>
<span class="nc bnc" id="L5872" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.HYDROFOIL) {</span>
<span class="nc" id="L5873">                    entity.setDoomed(true);</span>
<span class="nc" id="L5874">                    r.messageId = 2511;</span>
                }
            }
<span class="nc" id="L5877">            skid = true;</span>
<span class="nc" id="L5878">            turnEnds = true;</span>
        }
<span class="nc" id="L5880">        addReport(r);</span>
<span class="nc" id="L5881">        entity.setFacing((entity.getFacing() + turnDirection + 6) % 6);</span>
<span class="nc" id="L5882">        entity.setSecondaryFacing(entity.getFacing());</span>
<span class="nc bnc" id="L5883" title="All 4 branches missed.">        if (motiveDamage &amp;&amp; isGroundVehicle) {</span>
<span class="nc" id="L5884">            addReport(vehicleMotiveDamage((Tank)entity, motiveDamageMod));</span>
        }
<span class="nc bnc" id="L5886" title="All 4 branches missed.">        if (skid &amp;&amp; !entity.isDoomed()) {</span>
<span class="nc bnc" id="L5887" title="All 4 branches missed.">            if (!flip &amp;&amp; isGroundVehicle) {</span>
<span class="nc" id="L5888">                addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
            }

<span class="nc" id="L5891">            int skidDistance = (int)Math.round((double) (distance - 1) / 2);</span>
<span class="nc bnc" id="L5892" title="All 4 branches missed.">            if (flip &amp;&amp; entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
                // Wheeled vehicles that start to flip reduce the skid distance by one hex.
<span class="nc" id="L5894">                skidDistance--;</span>
<span class="nc bnc" id="L5895" title="All 2 branches missed.">            } else if (entity.getMovementMode() == EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L5896" title="All 2 branches missed.">                    || entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L5897" title="All 2 branches missed.">                    || entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L5898">                skidDistance = Math.min(marginOfFailure, distance);</span>
            }
<span class="nc bnc" id="L5900" title="All 2 branches missed.">            if (skidDistance &gt; 0) {</span>
<span class="nc" id="L5901">                int skidDirection = prevStep.getFacing();</span>
<span class="nc bnc" id="L5902" title="All 2 branches missed.">                if (isBackwards) {</span>
<span class="nc" id="L5903">                    skidDirection = (skidDirection + 3) % 6;</span>
                }
<span class="nc" id="L5905">                processSkid(entity, curPos, prevStep.getElevation(), skidDirection, skidDistance,</span>
                        prevStep, lastStepMoveType, flip);
            }
        }
<span class="nc" id="L5909">        return turnEnds;</span>
    }

    private void doVehicleFlipDamage(Tank entity, int damage, boolean startRight, int flipCount) {
        HitData hit;

<span class="nc" id="L5915">        int index = flipCount % 4;</span>
        // If there is no turret, we do side-side-bottom
<span class="nc bnc" id="L5917" title="All 2 branches missed.">        if (entity.hasNoTurret()) {</span>
<span class="nc" id="L5918">            index = flipCount % 3;</span>
<span class="nc bnc" id="L5919" title="All 2 branches missed.">            if (index &gt; 0) {</span>
<span class="nc" id="L5920">                index++;</span>
            }
        }
<span class="nc bnc" id="L5923" title="All 4 branches missed.">        switch (index) {</span>
            case 0:
<span class="nc bnc" id="L5925" title="All 2 branches missed.">                hit = new HitData(startRight ? Tank.LOC_RIGHT : Tank.LOC_LEFT);</span>
<span class="nc" id="L5926">                break;</span>
            case 1:
<span class="nc" id="L5928">                hit = new HitData(Tank.LOC_TURRET);</span>
<span class="nc" id="L5929">                break;</span>
            case 2:
<span class="nc bnc" id="L5931" title="All 2 branches missed.">                hit = new HitData(startRight ? Tank.LOC_LEFT : Tank.LOC_RIGHT);</span>
<span class="nc" id="L5932">                break;</span>
            default:
<span class="nc" id="L5934">                hit = null; //Motive damage instead</span>
        }
<span class="nc bnc" id="L5936" title="All 2 branches missed.">        if (hit != null) {</span>
<span class="nc" id="L5937">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5938">            addReport(damageEntity(entity, hit, damage));</span>
            // If the vehicle has two turrets, they both take full damage.
<span class="nc bnc" id="L5940" title="All 4 branches missed.">            if ((hit.getLocation() == Tank.LOC_TURRET) &amp;&amp; !(entity.hasNoDualTurret())) {</span>
<span class="nc" id="L5941">                hit = new HitData(Tank.LOC_TURRET_2);</span>
<span class="nc" id="L5942">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5943">                addReport(damageEntity(entity, hit, damage));</span>
            }
        } else {
<span class="nc" id="L5946">            addReport(vehicleMotiveDamage(entity, 1));</span>
        }
<span class="nc" id="L5948">    }</span>

    /**
     * processes a potential collision
     *
     * @param entity
     * @param target
     * @param src
     * @return
     */
    private boolean processCollision(Entity entity, Entity target, Coords src) {
        Report r;

<span class="nc" id="L5961">        r = new Report(9035);</span>
<span class="nc" id="L5962">        r.subject = entity.getId();</span>
<span class="nc" id="L5963">        r.add(entity.getDisplayName());</span>
<span class="nc" id="L5964">        r.add(target.getDisplayName());</span>
<span class="nc" id="L5965">        addReport(r);</span>
<span class="nc bnc" id="L5966" title="All 2 branches missed.">        boolean partial = (Compute.d6() == 6);</span>
        // if aero chance to avoid
<span class="nc bnc" id="L5968" title="All 2 branches missed.">        if ((target.isAero())</span>
<span class="nc bnc" id="L5969" title="All 2 branches missed.">            &amp;&amp; (target.mpUsed &lt; target.getRunMPwithoutMASC())</span>
<span class="nc bnc" id="L5970" title="All 4 branches missed.">            &amp;&amp; !((IAero) target).isOutControlTotal() &amp;&amp; !target.isImmobile()) {</span>
            // give them a control roll to avoid the collision
            // TODO : I should make this voluntary really
<span class="nc" id="L5973">            IAero ta = (IAero) target;</span>
<span class="nc" id="L5974">            PilotingRollData psr = target.getBasePilotingRoll();</span>
<span class="nc" id="L5975">            psr.addModifier(0, &quot;avoiding collision&quot;);</span>
<span class="nc" id="L5976">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L5977">            r = new Report(9045);</span>
<span class="nc" id="L5978">            r.subject = target.getId();</span>
<span class="nc" id="L5979">            r.add(target.getDisplayName());</span>
<span class="nc" id="L5980">            r.add(psr);</span>
<span class="nc" id="L5981">            r.add(ctrlroll);</span>
<span class="nc" id="L5982">            r.newlines = 0;</span>
<span class="nc" id="L5983">            r.indent(2);</span>
<span class="nc bnc" id="L5984" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L5985">                r.choose(false);</span>
<span class="nc" id="L5986">                addReport(r);</span>
            } else {
                // avoided collision
<span class="nc" id="L5989">                r.choose(true);</span>
<span class="nc" id="L5990">                addReport(r);</span>
                // two possibilities:
                // 1) the target already moved, but had MP left - check for
                // control roll conditions
                // 2) the target had not yet moved, move them in straight line
<span class="nc bnc" id="L5995" title="All 2 branches missed.">                if (!target.isDone()) {</span>
<span class="nc" id="L5996">                    int vel = ta.getCurrentVelocity();</span>
<span class="nc" id="L5997">                    MovePath md = new MovePath(game, target);</span>
<span class="nc bnc" id="L5998" title="All 2 branches missed.">                    while (vel &gt; 0) {</span>
<span class="nc" id="L5999">                        md.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L6000">                        vel--;</span>
                    }
<span class="nc" id="L6002">                    game.removeTurnFor(target);</span>
<span class="nc" id="L6003">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L6004">                    processMovement(target, md, null);</span>
                    // for some reason it is not clearing out turn
<span class="nc" id="L6006">                } else {</span>
                    // what needs to get checked?
                    // this move puts them at over-thrust
<span class="nc" id="L6009">                    target.moved = EntityMovementType.MOVE_OVER_THRUST;</span>
                    // they may have exceeded SI, only add if they hadn't
                    // exceeded it before
<span class="nc bnc" id="L6012" title="All 2 branches missed.">                    if (target.mpUsed &lt;= ta.getSI()) {</span>
<span class="nc" id="L6013">                        PilotingRollData rollTarget = ta.checkThrustSITotal(</span>
<span class="nc" id="L6014">                                target.getRunMPwithoutMASC(), target.moved);</span>
<span class="nc bnc" id="L6015" title="All 2 branches missed.">                        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6016">                            game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L6017">                                    target.getId(), 0,</span>
                                    &quot;Thrust spent during turn exceeds SI&quot;));
                        }
                    }
<span class="nc" id="L6021">                    target.mpUsed = target.getRunMPwithoutMASC();</span>
                }
<span class="nc" id="L6023">                return false;</span>
            }
<span class="nc" id="L6025">        } else {</span>
            // can't avoid collision - write report
<span class="nc" id="L6027">            r = new Report(9040);</span>
<span class="nc" id="L6028">            r.subject = entity.getId();</span>
<span class="nc" id="L6029">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L6030">            r.indent(2);</span>
<span class="nc" id="L6031">            addReport(r);</span>
        }

        // if we are still here, then collide
<span class="nc" id="L6035">        ToHitData toHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, &quot;Its a collision&quot;);</span>
<span class="nc" id="L6036">        toHit.setSideTable(target.sideTable(src));</span>
<span class="nc" id="L6037">        resolveRamDamage((IAero)entity, target, toHit, partial, false);</span>

        // Has the target been destroyed?
<span class="nc bnc" id="L6040" title="All 2 branches missed.">        if (target.isDoomed()) {</span>
            // Has the target taken a turn?
<span class="nc bnc" id="L6042" title="All 2 branches missed.">            if (!target.isDone()) {</span>
                // Dead entities don't take turns.
<span class="nc" id="L6044">                game.removeTurnFor(target);</span>
<span class="nc" id="L6045">                send(createTurnVectorPacket());</span>
            } // End target-still-to-move
            // Clean out the entity.
<span class="nc" id="L6048">            target.setDestroyed(true);</span>
<span class="nc" id="L6049">            game.moveToGraveyard(target.getId());</span>
<span class="nc" id="L6050">            send(createRemoveEntityPacket(target.getId()));</span>
        }
        // Update the target's position,
        // unless it is off the game map.
<span class="nc bnc" id="L6054" title="All 2 branches missed.">        if (!game.isOutOfGame(target)) {</span>
<span class="nc" id="L6055">            entityUpdate(target.getId());</span>
        }

<span class="nc" id="L6058">        return true;</span>
    }

    private boolean checkCrash(Entity entity, Coords pos, int altitude) {
        // only Aeros can crash
<span class="nc bnc" id="L6063" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L6064">            return false;</span>
        }
        // no crashing in space
<span class="nc bnc" id="L6067" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L6068">            return false;</span>
        }
        // if aero on the ground map, then only crash if elevation is zero
<span class="nc bnc" id="L6071" title="All 2 branches missed.">        else if (game.getBoard().onGround()) {</span>
<span class="nc bnc" id="L6072" title="All 2 branches missed.">            return altitude &lt;= 0;</span>
        }
        // we must be in atmosphere
        // if we're off the map, assume hex ceiling 0
        // Hexes with elevations &lt; 0 are treated as 0 altitude
<span class="nc" id="L6077">        int ceiling = 0;</span>
<span class="nc bnc" id="L6078" title="All 2 branches missed.">        if (game.getBoard().getHex(pos) != null) {</span>
<span class="nc" id="L6079">            ceiling = Math.max(0, game.getBoard().getHex(pos).ceiling(true));</span>
        }
<span class="nc bnc" id="L6081" title="All 2 branches missed.">        return ceiling &gt;= altitude;</span>
    }

    private Vector&lt;Report&gt; processCrash(Entity entity, int vel, Coords c) {
<span class="nc" id="L6085">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L6087" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L6088">            r = new Report(9701);</span>
<span class="nc" id="L6089">            r.subject = entity.getId();</span>
<span class="nc" id="L6090">            vReport.add(r);</span>
<span class="nc" id="L6091">            vReport.addAll(destroyEntity(entity, &quot;crashed off the map&quot;, true, true));</span>
<span class="nc" id="L6092">            return vReport;</span>
        }

<span class="nc bnc" id="L6095" title="All 2 branches missed.">        if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L6096">            r = new Report(9393, Report.PUBLIC);</span>
<span class="nc" id="L6097">            r.indent();</span>
<span class="nc" id="L6098">            r.addDesc(entity);</span>
<span class="nc" id="L6099">            vReport.add(r);</span>
<span class="nc" id="L6100">            entity.setDoomed(true);</span>
        } else {
<span class="nc" id="L6102">            ((IAero) entity).land();</span>
        }

        // we might hit multiple hexes, if we're a DropShip, so we do some
        // checks for all of them
<span class="nc" id="L6107">        List&lt;Coords&gt; coords = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L6108">        coords.add(c);</span>
<span class="nc" id="L6109">        IHex h = game.getBoard().getHex(c);</span>
        int crateredElevation;
<span class="nc" id="L6111">        boolean containsWater = false;</span>
<span class="nc bnc" id="L6112" title="All 2 branches missed.">        if (h.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L6113">            crateredElevation = Math.min(2, h.depth() + 1);</span>
<span class="nc" id="L6114">            containsWater = true;</span>
        } else {
<span class="nc" id="L6116">            crateredElevation = h.getLevel() - 2;</span>
        }
<span class="nc bnc" id="L6118" title="All 2 branches missed.">        if (entity instanceof Dropship) {</span>
<span class="nc bnc" id="L6119" title="All 2 branches missed.">            for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L6120">                Coords adjCoords = c.translated(i);</span>
<span class="nc bnc" id="L6121" title="All 2 branches missed.">                if (!game.getBoard().contains(adjCoords)) {</span>
<span class="nc" id="L6122">                    continue;</span>
                }
<span class="nc" id="L6124">                IHex adjHex = game.getBoard().getHex(adjCoords);</span>
<span class="nc" id="L6125">                coords.add(adjCoords);</span>
<span class="nc bnc" id="L6126" title="All 2 branches missed.">                if (adjHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L6127" title="All 2 branches missed.">                    if (containsWater) {</span>
<span class="nc" id="L6128">                        int newDepth = Math.min(2, adjHex.depth() + 1);</span>
<span class="nc bnc" id="L6129" title="All 2 branches missed.">                        if (newDepth &gt; crateredElevation) {</span>
<span class="nc" id="L6130">                            crateredElevation = newDepth;</span>
                        }
<span class="nc" id="L6132">                    } else {</span>
<span class="nc" id="L6133">                        crateredElevation = Math.min(2, adjHex.depth() + 1);</span>
<span class="nc" id="L6134">                        containsWater = true;</span>
                    }
<span class="nc bnc" id="L6136" title="All 4 branches missed.">                } else if (!containsWater &amp;&amp; (adjHex.getLevel() &lt; crateredElevation)) {</span>
<span class="nc" id="L6137">                    crateredElevation = adjHex.getLevel();</span>
                }
            }
        }
        // Units with velocity zero are treated like that had velocity two
<span class="nc bnc" id="L6142" title="All 2 branches missed.">        if (vel &lt; 1) {</span>
<span class="nc" id="L6143">            vel = 2;</span>
        }

        // deal crash damage only once
<span class="nc" id="L6147">        boolean damageDealt = false;</span>
<span class="nc bnc" id="L6148" title="All 2 branches missed.">        for (Coords hitCoords : coords) {</span>
<span class="nc" id="L6149">            int orig_crash_damage = Compute.d6(2) * 10 * vel;</span>
<span class="nc" id="L6150">            int crash_damage = orig_crash_damage;</span>
<span class="nc" id="L6151">            int direction = entity.getFacing();</span>
            // first check for buildings
<span class="nc" id="L6153">            Building bldg = game.getBoard().getBuildingAt(hitCoords);</span>
<span class="nc bnc" id="L6154" title="All 4 branches missed.">            if ((null != bldg) &amp;&amp; (bldg.getType() == Building.HARDENED)) {</span>
<span class="nc" id="L6155">                crash_damage *= 2;</span>
            }
<span class="nc bnc" id="L6157" title="All 2 branches missed.">            if (null != bldg) {</span>
<span class="nc" id="L6158">                collapseBuilding(bldg, game.getPositionMap(), hitCoords, true, vReport);</span>
            }
<span class="nc bnc" id="L6160" title="All 2 branches missed.">            if (!damageDealt) {</span>
<span class="nc" id="L6161">                r = new Report(9700, Report.PUBLIC);</span>
<span class="nc" id="L6162">                r.indent();</span>
<span class="nc" id="L6163">                r.addDesc(entity);</span>
<span class="nc" id="L6164">                r.add(crash_damage);</span>
<span class="nc" id="L6165">                vReport.add(r);</span>
<span class="nc bnc" id="L6166" title="All 2 branches missed.">                while (crash_damage &gt; 0) {</span>
                    HitData hit;
<span class="nc bnc" id="L6168" title="All 4 branches missed.">                    if ((entity instanceof SmallCraft) &amp;&amp; ((SmallCraft) entity).isSpheroid()) {</span>
<span class="nc" id="L6169">                        hit = entity.rollHitLocation(ToHitData.HIT_SPHEROID_CRASH, ToHitData.SIDE_REAR);</span>
                    } else {
<span class="nc" id="L6171">                        hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
                    }

<span class="nc bnc" id="L6174" title="All 2 branches missed.">                    if (crash_damage &gt; 10) {</span>
<span class="nc" id="L6175">                        vReport.addAll(damageEntity(entity, hit, 10));</span>
                    } else {
<span class="nc" id="L6177">                        vReport.addAll(damageEntity(entity, hit, crash_damage));</span>
                    }
<span class="nc" id="L6179">                    crash_damage -= 10;</span>
<span class="nc" id="L6180">                }</span>
<span class="nc" id="L6181">                damageDealt = true;</span>
            }

            // ok, now lets cycle through the entities in this spot and
            // potentially
            // damage them
<span class="nc bnc" id="L6187" title="All 2 branches missed.">            for (Entity victim : game.getEntitiesVector(hitCoords)) {</span>
<span class="nc bnc" id="L6188" title="All 2 branches missed.">                if (victim.getId() == entity.getId()) {</span>
<span class="nc" id="L6189">                    continue;</span>
                }
<span class="nc bnc" id="L6191" title="All 2 branches missed.">                if (((victim.getElevation() &gt; 0) &amp;&amp; victim</span>
<span class="nc bnc" id="L6192" title="All 4 branches missed.">                        .isAirborneVTOLorWIGE()) || (victim.getAltitude() &gt; 0)) {</span>
<span class="nc" id="L6193">                    continue;</span>
                }
                // if the crasher is a DropShip and the victim is not a mech,
                // then it is automatically destroyed
<span class="nc bnc" id="L6197" title="All 4 branches missed.">                if ((entity instanceof Dropship) &amp;&amp; !(victim instanceof Mech)) {</span>
<span class="nc" id="L6198">                    vReport.addAll(destroyEntity(victim, &quot;hit by crashing DropShip&quot;));</span>
                } else {
<span class="nc" id="L6200">                    crash_damage = orig_crash_damage / 2;</span>
                    // roll dice to see if they got hit
<span class="nc" id="L6202">                    int target = 2;</span>
<span class="nc bnc" id="L6203" title="All 2 branches missed.">                    if (victim instanceof Infantry) {</span>
<span class="nc" id="L6204">                        target = 3;</span>
                    }
<span class="nc" id="L6206">                    int roll = Compute.d6();</span>
<span class="nc" id="L6207">                    r = new Report(9705, Report.PUBLIC);</span>
<span class="nc" id="L6208">                    r.indent();</span>
<span class="nc" id="L6209">                    r.addDesc(victim);</span>
<span class="nc" id="L6210">                    r.add(target);</span>
<span class="nc" id="L6211">                    r.add(crash_damage);</span>
<span class="nc" id="L6212">                    r.add(roll);</span>
<span class="nc bnc" id="L6213" title="All 2 branches missed.">                    if (roll &gt; target) {</span>
<span class="nc" id="L6214">                        r.choose(true);</span>
<span class="nc" id="L6215">                        vReport.add(r);</span>
                        // apply half the crash damage in 5 point clusters
                        // (check
                        // hit tables)
<span class="nc bnc" id="L6219" title="All 2 branches missed.">                        while (crash_damage &gt; 0) {</span>
<span class="nc" id="L6220">                            HitData hit = victim.rollHitLocation(</span>
                                    ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);
<span class="nc bnc" id="L6222" title="All 2 branches missed.">                            if (victim instanceof Mech) {</span>
<span class="nc" id="L6223">                                hit = victim.rollHitLocation(</span>
                                        ToHitData.HIT_PUNCH, ToHitData.SIDE_FRONT);
                            }
<span class="nc bnc" id="L6226" title="All 2 branches missed.">                            if (victim instanceof Protomech) {</span>
<span class="nc" id="L6227">                                hit = victim.rollHitLocation(</span>
                                        ToHitData.HIT_SPECIAL_PROTO, ToHitData.SIDE_FRONT);
                            }
<span class="nc bnc" id="L6230" title="All 2 branches missed.">                            if (crash_damage &gt; 5) {</span>
<span class="nc" id="L6231">                                vReport.addAll(damageEntity(victim, hit, 5));</span>
                            } else {
<span class="nc" id="L6233">                                vReport.addAll(damageEntity(victim, hit, crash_damage));</span>
                            }
<span class="nc" id="L6235">                            crash_damage -= 5;</span>
<span class="nc" id="L6236">                        }</span>

                    } else {
<span class="nc" id="L6239">                        r.choose(false);</span>
<span class="nc" id="L6240">                        vReport.add(r);</span>
                    }
                }

<span class="nc bnc" id="L6244" title="All 4 branches missed.">                if (!victim.isDoomed() &amp;&amp; !victim.isDestroyed()) {</span>
                    // entity displacement
<span class="nc" id="L6246">                    Coords dest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L6247">                                                               victim.getId(), hitCoords, direction);</span>
<span class="nc bnc" id="L6248" title="All 2 branches missed.">                    if (null != dest) {</span>
<span class="nc" id="L6249">                        doEntityDisplacement(</span>
                                victim,
                                hitCoords,
                                dest,
<span class="nc" id="L6253">                                new PilotingRollData(victim.getId(), 0, &quot;crash&quot;));</span>
<span class="nc bnc" id="L6254" title="All 2 branches missed.">                    } else if (!(victim instanceof Dropship)) {</span>
                        // destroy entity - but not dropships which are
                        // immovable
<span class="nc" id="L6257">                        addReport(destroyEntity(victim,</span>
                                                &quot;impossible displacement&quot;,
                                                victim instanceof Mech, victim instanceof Mech));
                    }
                }

<span class="nc" id="L6263">            }</span>

            // reduce woods
<span class="nc" id="L6266">            h = game.getBoard().getHex(hitCoords);</span>
<span class="nc bnc" id="L6267" title="All 2 branches missed.">            if (h.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc bnc" id="L6268" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6269">                    h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L6270">                    h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6271">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.ROUGH, 1));
                } else {
<span class="nc" id="L6274">                    int level = h.terrainLevel(Terrains.WOODS) - 1;</span>
<span class="nc" id="L6275">                    int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6276">                    h.removeTerrain(Terrains.WOODS);</span>
<span class="nc bnc" id="L6277" title="All 2 branches missed.">                    if (level &gt; 0) {</span>
<span class="nc" id="L6278">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6279">                                .createTerrain(Terrains.WOODS, level));</span>
<span class="nc" id="L6280">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc bnc" id="L6281" title="All 2 branches missed.">                                .createTerrain(Terrains.FOLIAGE_ELEV, folEl == 1 ? 1 : 2));</span>
                    } else {
<span class="nc" id="L6283">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6284">                                             .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L6285">                        h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                    }
                }
            }
            // do the same for jungles
<span class="nc bnc" id="L6290" title="All 2 branches missed.">            if (h.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc bnc" id="L6291" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6292">                    h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L6293">                    h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6294">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.ROUGH, 1));
                } else {
<span class="nc" id="L6297">                    int level = h.terrainLevel(Terrains.JUNGLE) - 1;</span>
<span class="nc" id="L6298">                    int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6299">                    h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc bnc" id="L6300" title="All 2 branches missed.">                    if (level &gt; 0) {</span>
<span class="nc" id="L6301">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6302">                                .createTerrain(Terrains.JUNGLE, level));</span>
<span class="nc" id="L6303">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc bnc" id="L6304" title="All 2 branches missed.">                                .createTerrain(Terrains.FOLIAGE_ELEV, folEl == 1 ? 1 : 2));</span>
                    } else {
<span class="nc" id="L6306">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6307">                                             .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L6308">                        h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                    }
                }
            }
<span class="nc bnc" id="L6312" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc bnc" id="L6313" title="All 2 branches missed.">                if (!containsWater) {</span>
<span class="nc" id="L6314">                    h.setLevel(crateredElevation);</span>
                } else {
<span class="nc bnc" id="L6316" title="All 2 branches missed.">                    if (!h.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L6317">                        h.removeAllTerrains();</span>
                    }
<span class="nc" id="L6319">                    h.addTerrain(new Terrain(Terrains.WATER, crateredElevation,</span>
                                             false, 0));
                }
            }
<span class="nc" id="L6323">            sendChangedHex(hitCoords);</span>
<span class="nc" id="L6324">        }</span>

        // check for a stacking violation - which should only happen in the
        // case of grounded dropships, because they are not movable
<span class="nc bnc" id="L6328" title="All 2 branches missed.">        if (null != Compute.stackingViolation(game, entity.getId(), c)) {</span>
<span class="nc" id="L6329">            Coords dest = Compute.getValidDisplacement(game, entity.getId(), c,</span>
<span class="nc" id="L6330">                                                       Compute.d6() - 1);</span>
<span class="nc bnc" id="L6331" title="All 2 branches missed.">            if (null != dest) {</span>
<span class="nc" id="L6332">                doEntityDisplacement(entity, c, dest, null);</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L6337">                vPhaseReport.addAll(destroyEntity(entity,</span>
                                                  &quot;impossible displacement&quot;, entity instanceof Mech,
                                                  entity instanceof Mech));
            }
        }

        // Check for watery death
<span class="nc" id="L6344">        h = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L6345" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.WATER) &amp;&amp; !entity.isDestroyed()</span>
<span class="nc bnc" id="L6346" title="All 2 branches missed.">            &amp;&amp; !entity.isDoomed()) {</span>
            int lethalDepth;
<span class="nc bnc" id="L6348" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6349">                lethalDepth = 2;</span>
            } else {
<span class="nc" id="L6351">                lethalDepth = 1;</span>
            }

<span class="nc bnc" id="L6354" title="All 2 branches missed.">            if (h.depth() &gt;= lethalDepth) {</span>
                // Oh snap... we is dead
<span class="nc" id="L6356">                vReport.addAll(destroyEntity(entity,</span>
                                             &quot;crashing into deep water&quot;, true, true));
            }
        }

<span class="nc" id="L6361">        return vReport;</span>
    }

    /**
     * Process any flee movement actions, including flying off the map
     *
     * @param movePath   The move path which resulted in an entity leaving the map.
     * @param flewOff    whether this fleeing is a result of accidentally flying off the
     *                   map
     * @param returnable the number of rounds until the unit can return to the map (-1
     *                   if it can't return)
     * @return Vector of turn reports.
     */
    private Vector&lt;Report&gt; processLeaveMap(MovePath movePath, boolean flewOff, int returnable) {
<span class="nc" id="L6375">        Entity entity = movePath.getEntity();</span>
<span class="nc" id="L6376">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
        // Unit has fled the battlefield.
<span class="nc" id="L6379">        r = new Report(2005, Report.PUBLIC);</span>
<span class="nc bnc" id="L6380" title="All 2 branches missed.">        if (flewOff) {</span>
<span class="nc" id="L6381">            r = new Report(9370, Report.PUBLIC);</span>
        }
<span class="nc" id="L6383">        r.addDesc(entity);</span>
<span class="nc" id="L6384">        addReport(r);</span>
        OffBoardDirection fleeDirection;
<span class="nc bnc" id="L6386" title="All 2 branches missed.">        if (movePath.getFinalCoords().getY() &lt;= 0) {</span>
<span class="nc" id="L6387">            fleeDirection = OffBoardDirection.NORTH;</span>
<span class="nc bnc" id="L6388" title="All 2 branches missed.">        } else if (movePath.getFinalCoords().getY() &gt;= (getGame().getBoard().getHeight() - 1)) {</span>
<span class="nc" id="L6389">            fleeDirection = OffBoardDirection.SOUTH;</span>
<span class="nc bnc" id="L6390" title="All 2 branches missed.">        } else if (movePath.getFinalCoords().getX() &lt;= 0) {</span>
<span class="nc" id="L6391">            fleeDirection = OffBoardDirection.WEST;</span>
        } else {
<span class="nc" id="L6393">            fleeDirection = OffBoardDirection.EAST;</span>
        }

<span class="nc bnc" id="L6396" title="All 2 branches missed.">        if (returnable &gt; -1) {</span>

<span class="nc" id="L6398">            entity.setDeployed(false);</span>
<span class="nc" id="L6399">            entity.setDeployRound(1 + game.getRoundCount() + returnable);</span>
<span class="nc" id="L6400">            entity.setPosition(null);</span>
<span class="nc" id="L6401">            entity.setDone(true);</span>
<span class="nc bnc" id="L6402" title="All 2 branches missed.">            if (entity.isAero()) {</span>
                // If we're flying off because we're OOC, when we come back we
                // should no longer be OOC
                // If we don't, this causes a major problem as aeros tend to
                // return, re-deploy then
                // fly off again instantly.
<span class="nc" id="L6408">                ((IAero) entity).setOutControl(false);</span>
            }
<span class="nc bnc" id="L6410" title="All 5 branches missed.">            switch (fleeDirection) {</span>
                case WEST:
<span class="nc" id="L6412">                    entity.setStartingPos(Board.START_W);</span>
<span class="nc" id="L6413">                    break;</span>
                case NORTH:
<span class="nc" id="L6415">                    entity.setStartingPos(Board.START_N);</span>
<span class="nc" id="L6416">                    break;</span>
                case EAST:
<span class="nc" id="L6418">                    entity.setStartingPos(Board.START_E);</span>
<span class="nc" id="L6419">                    break;</span>
                case SOUTH:
<span class="nc" id="L6421">                    entity.setStartingPos(Board.START_S);</span>
<span class="nc" id="L6422">                    break;</span>
                default:
<span class="nc" id="L6424">                    entity.setStartingPos(Board.START_EDGE);</span>
            }
<span class="nc" id="L6426">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6427">            return vReport;</span>
        }

        // Is the unit carrying passengers or trailers?
<span class="nc" id="L6431">        final List&lt;Entity&gt; passengers = new ArrayList&lt;&gt;(entity.getLoadedUnits());</span>
<span class="nc bnc" id="L6432" title="All 2 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()) {</span>
<span class="nc bnc" id="L6433" title="All 2 branches missed.">            for (int id : entity.getAllTowedUnits()) {</span>
<span class="nc" id="L6434">                Entity towed = game.getEntity(id);</span>
<span class="nc" id="L6435">                passengers.add(towed);</span>
<span class="nc" id="L6436">            }</span>
        }
<span class="nc bnc" id="L6438" title="All 2 branches missed.">        if (!passengers.isEmpty()) {</span>
<span class="nc bnc" id="L6439" title="All 2 branches missed.">            for (Entity passenger : passengers) {</span>
                // Unit has fled the battlefield.
<span class="nc" id="L6441">                r = new Report(2010, Report.PUBLIC);</span>
<span class="nc" id="L6442">                r.indent();</span>
<span class="nc" id="L6443">                r.addDesc(passenger);</span>
<span class="nc" id="L6444">                addReport(r);</span>
<span class="nc" id="L6445">                passenger.setRetreatedDirection(fleeDirection);</span>
<span class="nc" id="L6446">                game.removeEntity(passenger.getId(),</span>
                                  IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L6448">                send(createRemoveEntityPacket(passenger.getId(),</span>
                                              IEntityRemovalConditions.REMOVE_IN_RETREAT));
<span class="nc" id="L6450">            }</span>
        }

        // Handle any picked up MechWarriors
<span class="nc bnc" id="L6454" title="All 2 branches missed.">        for (Integer mechWarriorId : entity.getPickedUpMechWarriors()) {</span>
<span class="nc" id="L6455">            Entity mw = game.getEntity(mechWarriorId);</span>
            
<span class="nc bnc" id="L6457" title="All 2 branches missed.">            if(mw == null) {</span>
<span class="nc" id="L6458">                continue;</span>
            }

            // Is the MechWarrior an enemy?
<span class="nc" id="L6462">            int condition = IEntityRemovalConditions.REMOVE_IN_RETREAT;</span>
<span class="nc" id="L6463">            r = new Report(2010);</span>
<span class="nc bnc" id="L6464" title="All 2 branches missed.">            if (mw.isCaptured()) {</span>
<span class="nc" id="L6465">                r = new Report(2015);</span>
<span class="nc" id="L6466">                condition = IEntityRemovalConditions.REMOVE_CAPTURED;</span>
            } else {
<span class="nc" id="L6468">                mw.setRetreatedDirection(fleeDirection);</span>
            }
<span class="nc" id="L6470">            game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L6471">            send(createRemoveEntityPacket(mw.getId(), condition));</span>
<span class="nc" id="L6472">            r.addDesc(mw);</span>
<span class="nc" id="L6473">            r.indent();</span>
<span class="nc" id="L6474">            addReport(r);</span>
<span class="nc" id="L6475">        }</span>
        // Is the unit being swarmed?
<span class="nc" id="L6477">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L6478" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L6479">            final Entity swarmer = game.getEntity(swarmerId);</span>

            // Has the swarmer taken a turn?
<span class="nc bnc" id="L6482" title="All 2 branches missed.">            if (!swarmer.isDone()) {</span>
                // Dead entities don't take turns.
<span class="nc" id="L6484">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L6485">                send(createTurnVectorPacket());</span>

            } // End swarmer-still-to-move

            // Unit has fled the battlefield.
<span class="nc" id="L6490">            swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L6491">            entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L6492">            r = new Report(2015, Report.PUBLIC);</span>
<span class="nc" id="L6493">            r.indent();</span>
<span class="nc" id="L6494">            r.addDesc(swarmer);</span>
<span class="nc" id="L6495">            addReport(r);</span>
<span class="nc" id="L6496">            game.removeEntity(swarmerId, IEntityRemovalConditions.REMOVE_CAPTURED);</span>
<span class="nc" id="L6497">            send(createRemoveEntityPacket(swarmerId, IEntityRemovalConditions.REMOVE_CAPTURED));</span>
        }
<span class="nc" id="L6499">        entity.setRetreatedDirection(fleeDirection);</span>
<span class="nc" id="L6500">        game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L6501">        send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
<span class="nc" id="L6502">        return vReport;</span>
    }

    /**
     * Steps through an entity movement packet, executing it.
     *
     * @param entity   The Entity that is moving
     * @param md       The MovePath that defines how the Entity moves
     * @param losCache A cache that stores Los between various Entities and
     *                 targets.  In double blind games, we may need to compute a
     *                 lot of LosEffects, so caching them can really speed
     *                 things up.
     */
    private void processMovement(Entity entity, MovePath md, Map&lt;EntityTargetPair,
            LosEffects&gt; losCache) {
        // Make sure the cache isn't null
<span class="nc bnc" id="L6518" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L6519">            losCache = new HashMap&lt;&gt;();</span>
        }
        Report r;
<span class="nc" id="L6522">        boolean sideslipped = false; // for VTOL side slipping</span>
        PilotingRollData rollTarget;

        // check for fleeing
<span class="nc bnc" id="L6526" title="All 2 branches missed.">        if (md.contains(MoveStepType.FLEE)) {</span>
<span class="nc" id="L6527">            addReport(processLeaveMap(md, false, -1));</span>
<span class="nc" id="L6528">            return;</span>
        }

<span class="nc bnc" id="L6531" title="All 2 branches missed.">        if (md.contains(MoveStepType.EJECT)) {</span>
<span class="nc bnc" id="L6532" title="All 4 branches missed.">            if (entity.isLargeCraft() &amp;&amp; !entity.isCarcass()) {</span>
<span class="nc" id="L6533">                r = new Report(2026);</span>
<span class="nc" id="L6534">                r.subject = entity.getId();</span>
<span class="nc" id="L6535">                r.addDesc(entity);</span>
<span class="nc" id="L6536">                addReport(r);</span>
<span class="nc" id="L6537">                Aero ship = (Aero) entity;</span>
<span class="nc" id="L6538">                ship.setEjecting(true);</span>
<span class="nc" id="L6539">                entityUpdate(ship.getId());</span>
<span class="nc" id="L6540">                Coords legalPos = entity.getPosition();</span>
                //Get the step so we can pass it in and get the abandon coords from it
<span class="nc" id="L6542">                for (final Enumeration&lt;MoveStep&gt; i = md.getSteps(); i</span>
<span class="nc bnc" id="L6543" title="All 2 branches missed.">                        .hasMoreElements();) {</span>
<span class="nc" id="L6544">                    final MoveStep step = i.nextElement();</span>
<span class="nc bnc" id="L6545" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.EJECT) {</span>
<span class="nc" id="L6546">                        legalPos = step.getTargetPosition();</span>
                    }
<span class="nc" id="L6548">                }</span>
<span class="nc bnc" id="L6549" title="All 4 branches missed.">                addReport(ejectSpacecraft(ship, ship.isSpaceborne(), (ship.isAirborne() &amp;&amp; !ship.isSpaceborne()),legalPos));</span>
                //If we're grounded or destroyed by crew loss, end movement
<span class="nc bnc" id="L6551" title="All 6 branches missed.">                if (entity.isDoomed() || (!entity.isSpaceborne() &amp;&amp; !entity.isAirborne())) {</span>
<span class="nc" id="L6552">                    return;</span>
                }
<span class="nc bnc" id="L6554" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Aero)) {</span>
<span class="nc" id="L6555">                r = new Report(2020);</span>
<span class="nc" id="L6556">                r.subject = entity.getId();</span>
<span class="nc" id="L6557">                r.add(entity.getCrew().getName());</span>
<span class="nc" id="L6558">                r.addDesc(entity);</span>
<span class="nc" id="L6559">                addReport(r);</span>
<span class="nc" id="L6560">                addReport(ejectEntity(entity, false));</span>
<span class="nc" id="L6561">                return;</span>
<span class="nc bnc" id="L6562" title="All 4 branches missed.">            } else if ((entity instanceof Tank) &amp;&amp; !entity.isCarcass()) {</span>
<span class="nc" id="L6563">                r = new Report(2025);</span>
<span class="nc" id="L6564">                r.subject = entity.getId();</span>
<span class="nc" id="L6565">                r.addDesc(entity);</span>
<span class="nc" id="L6566">                addReport(r);</span>
<span class="nc" id="L6567">                addReport(ejectEntity(entity, false));</span>
<span class="nc" id="L6568">                return;</span>
            }
        }

<span class="nc bnc" id="L6572" title="All 2 branches missed.">        if (md.contains(MoveStepType.CAREFUL_STAND)) {</span>
<span class="nc" id="L6573">            entity.setCarefulStand(true);</span>
        }
<span class="nc bnc" id="L6575" title="All 2 branches missed.">        if (md.contains(MoveStepType.BACKWARDS)) {</span>
<span class="nc" id="L6576">            entity.setMovedBackwards(true);</span>
<span class="nc bnc" id="L6577" title="All 2 branches missed.">            if (md.getMpUsed() &gt; entity.getWalkMP()) {</span>
<span class="nc" id="L6578">                entity.setPowerReverse(true);</span>
            }
        }

<span class="nc bnc" id="L6582" title="All 4 branches missed.">        if (md.contains(MoveStepType.TAKEOFF) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6583">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6584">            a.setCurrentVelocity(1);</span>
<span class="nc" id="L6585">            a.liftOff(1);</span>
<span class="nc bnc" id="L6586" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6587">                applyDropShipProximityDamage(md.getFinalCoords(), true, md.getFinalFacing(), entity);</span>
            }
<span class="nc" id="L6589">            checkForTakeoffDamage(a);</span>
<span class="nc" id="L6590">            entity.setPosition(entity.getPosition().translated(entity.getFacing(), a.getTakeOffLength()));</span>
<span class="nc" id="L6591">            entity.setDone(true);</span>
<span class="nc" id="L6592">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6593">            return;</span>
        }

<span class="nc bnc" id="L6596" title="All 4 branches missed.">        if (md.contains(MoveStepType.VTAKEOFF) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6597">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6598">            rollTarget = a.checkVerticalTakeOff();</span>
<span class="nc bnc" id="L6599" title="All 2 branches missed.">            if (doVerticalTakeOffCheck(entity, rollTarget)) {</span>
<span class="nc" id="L6600">                a.setCurrentVelocity(0);</span>
<span class="nc" id="L6601">                a.liftOff(1);</span>
<span class="nc bnc" id="L6602" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6603">                    applyDropShipProximityDamage(md.getFinalCoords(), (Dropship)a);</span>
                }
<span class="nc" id="L6605">                checkForTakeoffDamage(a);</span>
            }
<span class="nc" id="L6607">            entity.setDone(true);</span>
<span class="nc" id="L6608">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6609">            return;</span>
        }

<span class="nc bnc" id="L6612" title="All 4 branches missed.">        if (md.contains(MoveStepType.LAND) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6613">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6614">            rollTarget = a.checkLanding(md.getLastStepMovementType(), md.getFinalVelocity(),</span>
<span class="nc" id="L6615">                    md.getFinalCoords(), md.getFinalFacing(), false);</span>
<span class="nc" id="L6616">            attemptLanding(entity, rollTarget);</span>
<span class="nc" id="L6617">            a.land();</span>
<span class="nc" id="L6618">            entity.setPosition(md.getFinalCoords().translated(md.getFinalFacing(),</span>
<span class="nc" id="L6619">                    a.getLandingLength()));</span>
<span class="nc" id="L6620">            entity.setDone(true);</span>
<span class="nc" id="L6621">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6622">            return;</span>
        }

<span class="nc bnc" id="L6625" title="All 4 branches missed.">        if (md.contains(MoveStepType.VLAND) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6626">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6627">            rollTarget = a.checkLanding(md.getLastStepMovementType(),</span>
<span class="nc" id="L6628">                    md.getFinalVelocity(), md.getFinalCoords(),</span>
<span class="nc" id="L6629">                    md.getFinalFacing(), true);</span>
<span class="nc" id="L6630">            attemptLanding(entity, rollTarget);</span>
<span class="nc bnc" id="L6631" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6632">                applyDropShipLandingDamage(md.getFinalCoords(), (Dropship)a);</span>
            }
<span class="nc" id="L6634">            a.land();</span>
<span class="nc" id="L6635">            entity.setPosition(md.getFinalCoords());</span>
<span class="nc" id="L6636">            entity.setDone(true);</span>
<span class="nc" id="L6637">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6638">            return;</span>
        }

        // okay, proceed with movement calculations
<span class="nc" id="L6642">        Coords lastPos = entity.getPosition();</span>
<span class="nc" id="L6643">        Coords curPos = entity.getPosition();</span>
<span class="nc" id="L6644">        int curFacing = entity.getFacing();</span>
<span class="nc" id="L6645">        int curVTOLElevation = entity.getElevation();</span>
        int curElevation;
<span class="nc" id="L6647">        int lastElevation = entity.getElevation();</span>
<span class="nc" id="L6648">        int curAltitude = entity.getAltitude();</span>
<span class="nc" id="L6649">        boolean curClimbMode = entity.climbMode();</span>
        // if the entity already used some MPs,
        // it previously tried to get up and fell,
        // and then got another turn. set moveType
        // and overallMoveType accordingly
        // (these are all cleared by Entity.newRound)
<span class="nc" id="L6655">        int distance = entity.delta_distance;</span>
<span class="nc" id="L6656">        int mpUsed = entity.mpUsed;</span>
<span class="nc" id="L6657">        EntityMovementType moveType = entity.moved;</span>
        EntityMovementType overallMoveType;
        boolean firstStep;
<span class="nc" id="L6660">        boolean wasProne = entity.isProne();</span>
<span class="nc" id="L6661">        boolean fellDuringMovement = false;</span>
<span class="nc" id="L6662">        boolean crashedDuringMovement = false;</span>
<span class="nc" id="L6663">        boolean dropshipStillUnloading = false;</span>
        boolean turnOver;
<span class="nc" id="L6665">        int prevFacing = curFacing;</span>
<span class="nc" id="L6666">        IHex prevHex = game.getBoard().getHex(curPos);</span>
<span class="nc" id="L6667">        final boolean isInfantry = entity instanceof Infantry;</span>
<span class="nc" id="L6668">        AttackAction charge = null;</span>
<span class="nc" id="L6669">        RamAttackAction ram = null;</span>
        // cache this here, otherwise changing MP in the turn causes
        // erroneous gravity PSRs
<span class="nc" id="L6672">        int cachedGravityLimit = -1;</span>
<span class="nc" id="L6673">        int thrustUsed = 0;</span>
<span class="nc" id="L6674">        int j = 0;</span>
        boolean didMove;
<span class="nc" id="L6676">        boolean recovered = false;</span>
<span class="nc" id="L6677">        Entity loader = null;</span>
<span class="nc" id="L6678">        boolean continueTurnFromPBS = false;</span>
<span class="nc" id="L6679">        boolean continueTurnFromFishtail = false;</span>
<span class="nc" id="L6680">        boolean continueTurnFromLevelDrop = false;</span>
<span class="nc" id="L6681">        boolean continueTurnFromCliffAscent = false;</span>

        // get a list of coordinates that the unit passed through this turn
        // so that I can later recover potential bombing targets
        // it may already have some values
<span class="nc" id="L6686">        Vector&lt;Coords&gt; passedThrough = entity.getPassedThrough();</span>
<span class="nc" id="L6687">        passedThrough.add(curPos);</span>
<span class="nc" id="L6688">        List&lt;Integer&gt; passedThroughFacing = entity.getPassedThroughFacing();</span>
<span class="nc" id="L6689">        passedThroughFacing.add(curFacing);</span>

        // Compile the move - don't clip
        // Clipping could affect hidden units; illegal steps aren't processed
<span class="nc" id="L6693">        md.compile(game, entity, false);</span>

        // if advanced movement is being used then set the new vectors based on
        // move path
<span class="nc" id="L6697">        entity.setVectors(md.getFinalVectors());</span>

<span class="nc" id="L6699">        overallMoveType = md.getLastStepMovementType();</span>

        // check for starting in liquid magma
<span class="nc" id="L6702">        if ((game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L6703" title="All 2 branches missed.">                .terrainLevel(Terrains.MAGMA) == 2)</span>
<span class="nc bnc" id="L6704" title="All 2 branches missed.">                &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L6705">            doMagmaDamage(entity, false);</span>
        }

        // set acceleration used to default
<span class="nc bnc" id="L6709" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L6710">            ((IAero)entity).setAccLast(false);</span>
        }

        // check for dropping troops and drop them
<span class="nc bnc" id="L6714" title="All 4 branches missed.">        if (entity.isDropping() &amp;&amp; !md.contains(MoveStepType.HOVER)) {</span>
<span class="nc" id="L6715">            entity.setAltitude(entity.getAltitude() - game.getPlanetaryConditions().getDropRate());</span>
            // they may have changed their facing
<span class="nc bnc" id="L6717" title="All 2 branches missed.">            if (md.length() &gt; 0) {</span>
<span class="nc" id="L6718">                entity.setFacing(md.getFinalFacing());</span>
            }
<span class="nc" id="L6720">            passedThrough.add(entity.getPosition());</span>
<span class="nc" id="L6721">            entity.setPassedThrough(passedThrough);</span>
<span class="nc" id="L6722">            passedThroughFacing.add(entity.getFacing());</span>
<span class="nc" id="L6723">            entity.setPassedThroughFacing(passedThroughFacing);</span>
            // We may still need to process any conversions for dropping LAMs
<span class="nc bnc" id="L6725" title="All 4 branches missed.">            if (entity instanceof LandAirMech &amp;&amp; md.contains(MoveStepType.CONVERT_MODE)) {</span>
<span class="nc" id="L6726">                entity.setMovementMode(md.getFinalConversionMode());</span>
<span class="nc" id="L6727">                entity.setConvertingNow(true);</span>
<span class="nc" id="L6728">                r = new Report(1210);</span>
<span class="nc" id="L6729">                r.subject = entity.getId();</span>
<span class="nc" id="L6730">                r.addDesc(entity);</span>
<span class="nc bnc" id="L6731" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L6732">                    r.messageId = 2452;</span>
<span class="nc bnc" id="L6733" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L6734">                    r.messageId = 2453;</span>
                } else {
<span class="nc" id="L6736">                    r.messageId = 2450;</span>
                }
<span class="nc" id="L6738">                addReport(r);</span>
            }
<span class="nc" id="L6740">            entity.setDone(true);</span>
<span class="nc" id="L6741">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6742">            return;</span>
        }
        
        // iterate through steps
<span class="nc" id="L6746">        firstStep = true;</span>
<span class="nc" id="L6747">        turnOver = false;</span>
        /* Bug 754610: Revert fix for bug 702735. */
<span class="nc" id="L6749">        MoveStep prevStep = null;</span>

<span class="nc" id="L6751">        List&lt;Entity&gt; hiddenEnemies = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L6752" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L6753" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L6754" title="All 6 branches missed.">                if (e.isHidden() &amp;&amp; e.isEnemyOf(entity) &amp;&amp; (e.getPosition() != null)) {</span>
<span class="nc" id="L6755">                    hiddenEnemies.add(e);</span>
                }
<span class="nc" id="L6757">            }</span>
        }

<span class="nc" id="L6760">        Vector&lt;UnitLocation&gt; movePath = new Vector&lt;&gt;();</span>
<span class="nc" id="L6761">        EntityMovementType lastStepMoveType = md.getLastStepMovementType();</span>
<span class="nc bnc" id="L6762" title="All 2 branches missed.">        for (final Enumeration&lt;MoveStep&gt; i = md.getSteps(); i.hasMoreElements();) {</span>
<span class="nc" id="L6763">            final MoveStep step = i.nextElement();</span>
<span class="nc" id="L6764">            EntityMovementType stepMoveType = step.getMovementType(md.isEndStep(step));</span>
<span class="nc" id="L6765">            wasProne = entity.isProne();</span>
<span class="nc" id="L6766">            boolean isPavementStep = step.isPavementStep();</span>
<span class="nc" id="L6767">            entity.inReverse = step.isThisStepBackwards();</span>
<span class="nc" id="L6768">            boolean entityFellWhileAttemptingToStand = false;</span>
<span class="nc bnc" id="L6769" title="All 2 branches missed.">            boolean isOnGround = !i.hasMoreElements();</span>
<span class="nc bnc" id="L6770" title="All 2 branches missed.">            isOnGround |= stepMoveType != EntityMovementType.MOVE_JUMP;</span>
<span class="nc bnc" id="L6771" title="All 2 branches missed.">            isOnGround &amp;= step.getElevation() &lt; 1;</span>

            // Check for hidden units point blank shots
<span class="nc bnc" id="L6774" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L6775" title="All 2 branches missed.">                for (Entity e : hiddenEnemies) {</span>
<span class="nc" id="L6776">                    int dist = e.getPosition().distance(step.getPosition());</span>
                    // Checking for same hex and stacking violation
<span class="nc bnc" id="L6778" title="All 4 branches missed.">                    if ((dist == 0) &amp;&amp; !continueTurnFromPBS</span>
<span class="nc bnc" id="L6779" title="All 2 branches missed.">                            &amp;&amp; (Compute.stackingViolation(game, entity.getId(),</span>
<span class="nc" id="L6780">                                    step.getPosition()) != null)) {</span>
                        // Moving into hex of a hidden unit detects the unit
<span class="nc" id="L6782">                        e.setHidden(false);</span>
<span class="nc" id="L6783">                        entityUpdate(e.getId());</span>
<span class="nc" id="L6784">                        r = new Report(9960);</span>
<span class="nc" id="L6785">                        r.addDesc(entity);</span>
<span class="nc" id="L6786">                        r.subject = entity.getId();</span>
<span class="nc" id="L6787">                        r.add(e.getPosition().getBoardNum());</span>
<span class="nc" id="L6788">                        vPhaseReport.addElement(r);</span>
                        // Report the block
<span class="nc bnc" id="L6790" title="All 2 branches missed.">                        if (doBlind()) {</span>
<span class="nc" id="L6791">                            r = new Report(9961);</span>
<span class="nc" id="L6792">                            r.subject = e.getId();</span>
<span class="nc" id="L6793">                            r.addDesc(e);</span>
<span class="nc" id="L6794">                            r.addDesc(entity);</span>
<span class="nc" id="L6795">                            r.add(step.getPosition().getBoardNum());</span>
<span class="nc" id="L6796">                            addReport(r);</span>
                        }
                        // Report halted movement
<span class="nc" id="L6799">                        r = new Report(9962);</span>
<span class="nc" id="L6800">                        r.subject = entity.getId();</span>
<span class="nc" id="L6801">                        r.addDesc(entity);</span>
<span class="nc" id="L6802">                        r.add(step.getPosition().getBoardNum());</span>
<span class="nc" id="L6803">                        addReport(r);</span>
<span class="nc" id="L6804">                        addNewLines();</span>
<span class="nc" id="L6805">                        Report.addNewline(vPhaseReport);</span>
                        // If we aren't at the end, send a special report
<span class="nc bnc" id="L6807" title="All 2 branches missed.">                        if ((game.getTurnIndex() + 1) &lt; game.getTurnVector().size()) {</span>
<span class="nc" id="L6808">                            send(e.getOwner().getId(), createSpecialReportPacket());</span>
<span class="nc" id="L6809">                            send(entity.getOwner().getId(), createSpecialReportPacket());</span>
                        }
<span class="nc" id="L6811">                        entity.setDone(true);</span>
<span class="nc" id="L6812">                        entityUpdate(entity.getId(), movePath, true, losCache);</span>
<span class="nc" id="L6813">                        return;</span>
                        // Potential point-blank shot
<span class="nc bnc" id="L6815" title="All 4 branches missed.">                    } else if ((dist == 1) &amp;&amp; !e.madePointblankShot()) {</span>
<span class="nc" id="L6816">                        entity.setPosition(step.getPosition());</span>
<span class="nc" id="L6817">                        entity.setFacing(step.getFacing());</span>
                        // If not set, BV icons could have wrong facing
<span class="nc" id="L6819">                        entity.setSecondaryFacing(step.getFacing());</span>
                        // Update entity position on client
<span class="nc" id="L6821">                        send(e.getOwnerId(), createEntityPacket(entity.getId(), null));</span>
<span class="nc" id="L6822">                        boolean tookPBS = processPointblankShotCFR(e, entity);</span>
                        // Movement should be interrupted
<span class="nc bnc" id="L6824" title="All 2 branches missed.">                        if (tookPBS) {</span>
                            // Attacking reveals hidden unit
<span class="nc" id="L6826">                            e.setHidden(false);</span>
<span class="nc" id="L6827">                            entityUpdate(e.getId());</span>
<span class="nc" id="L6828">                            r = new Report(9960);</span>
<span class="nc" id="L6829">                            r.addDesc(entity);</span>
<span class="nc" id="L6830">                            r.subject = entity.getId();</span>
<span class="nc" id="L6831">                            r.add(e.getPosition().getBoardNum());</span>
<span class="nc" id="L6832">                            vPhaseReport.addElement(r);</span>
<span class="nc" id="L6833">                            continueTurnFromPBS = true;</span>

<span class="nc" id="L6835">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6836">                            curPos = entity.getPosition();</span>
<span class="nc" id="L6837">                            mpUsed = step.getMpUsed();</span>
<span class="nc" id="L6838">                            break;</span>
                        }
                    }
<span class="nc" id="L6841">                }</span>
            }

            // stop for illegal movement
<span class="nc bnc" id="L6845" title="All 2 branches missed.">            if (stepMoveType == EntityMovementType.MOVE_ILLEGAL) {</span>
<span class="nc" id="L6846">                break;</span>
            }

            // stop if the entity already killed itself
<span class="nc bnc" id="L6850" title="All 4 branches missed.">            if (entity.isDestroyed() || entity.isDoomed()) {</span>
<span class="nc" id="L6851">                break;</span>
            }

<span class="nc bnc" id="L6854" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L6855" title="All 4 branches missed.">                if (step.getType() == MoveStepType.UP &amp;&amp; !entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L6856">                    entity.setWigeLiftoffHover(true);</span>
<span class="nc bnc" id="L6857" title="All 2 branches missed.">                } else if (step.getType() == MoveStepType.HOVER) {</span>
<span class="nc" id="L6858">                    entity.setWigeLiftoffHover(true);</span>
<span class="nc" id="L6859">                    entity.setAssaultDropInProgress(false);</span>
<span class="nc bnc" id="L6860" title="All 4 branches missed.">                } else if (step.getType() == MoveStepType.DOWN &amp;&amp; step.getClearance() == 0) {</span>
                    // If this is the first step, use the Entity's starting elevation
<span class="nc bnc" id="L6862" title="All 2 branches missed.">                    int elevation = (prevStep == null) ? entity.getElevation() : prevStep.getElevation();</span>
<span class="nc bnc" id="L6863" title="All 2 branches missed.">                    if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L6864">                        addReport(landAirMech((LandAirMech) entity, step.getPosition(), elevation,</span>
                                distance));
<span class="nc bnc" id="L6866" title="All 2 branches missed.">                    } else if (entity instanceof Protomech) {</span>
<span class="nc" id="L6867">                        addReport(landGliderPM((Protomech) entity, step.getPosition(), elevation,</span>
                                distance));
                    }
                    // landing always ends movement whether successful or not
                }
            }

            // check for MASC failure on first step
            // also check Tanks because they can have superchargers that act
            // like MASc
<span class="nc bnc" id="L6877" title="All 6 branches missed.">            if (firstStep &amp;&amp; ((entity instanceof Mech) || (entity instanceof Tank))) {</span>
                // Not necessarily a fall, but we need to give them a new turn to plot movement with
                // likely reduced MP.
<span class="nc" id="L6880">                fellDuringMovement = checkMASCFailure(entity, md);</span>
            }

<span class="nc bnc" id="L6883" title="All 2 branches missed.">            if (firstStep) {</span>
<span class="nc" id="L6884">                rollTarget = entity.checkGunningIt(overallMoveType);</span>
<span class="nc bnc" id="L6885" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6886">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L6888" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
                        // Since this is the first step, we don't have a previous step so we'll pass
                        // this one in case it's needed to process a skid.
<span class="nc bnc" id="L6891" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos, 0, step,</span>
<span class="nc" id="L6892">                                step.isThisStepBackwards(), lastStepMoveType, distance, 2, mof)) {</span>
<span class="nc bnc" id="L6893" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L6894">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L6896">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L6899">                            turnOver = true;</span>
<span class="nc" id="L6900">                            distance = entity.delta_distance;</span>
<span class="nc" id="L6901">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6902">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6903">                            break;</span>
<span class="nc bnc" id="L6904" title="All 2 branches missed.">                        } else if (entity.getFacing() != curFacing) {</span>
                            // If the facing doesn't change we had a minor fishtail that doesn't require
                            // stopping movement.
<span class="nc" id="L6907">                            continueTurnFromFishtail = true;</span>
<span class="nc" id="L6908">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6909">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6910">                            break;</span>
                        }
                    }
                }
            }

            // Check for failed maneuver for overdrive on first step. The rules for overdrive do not
            // state this explicitly, but since combining overdrive with gunning it requires two rolls
            // and gunning does state explicitly that the roll is made before movement, this
            // implies the same for overdrive.
<span class="nc bnc" id="L6920" title="All 6 branches missed.">            if (firstStep &amp;&amp; (overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                    || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L6922">                rollTarget = entity.checkUsingOverdrive(EntityMovementType.MOVE_SPRINT);</span>
<span class="nc bnc" id="L6923" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6924">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L6926" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
<span class="nc bnc" id="L6927" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos, 0, step, step.isThisStepBackwards(),</span>
                                lastStepMoveType, distance, 2, mof)) {
<span class="nc bnc" id="L6929" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L6930">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L6932">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L6935">                            turnOver = true;</span>
<span class="nc" id="L6936">                            distance = entity.delta_distance;</span>
<span class="nc" id="L6937">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6938">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6939">                            break;</span>
<span class="nc bnc" id="L6940" title="All 2 branches missed.">                        } else if (entity.getFacing() != curFacing) {</span>
                            // If the facing doesn't change we had a minor fishtail that doesn't require
                            // stopping movement.
<span class="nc" id="L6943">                            continueTurnFromFishtail = true;</span>
<span class="nc" id="L6944">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6945">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6946">                            break;</span>
                        }
                    }
                }
            }

<span class="nc bnc" id="L6952" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L6953">                entity.setConvertingNow(true);</span>

                // Non-omni QuadVees converting to vehicle mode dump any riding BA in the
                // starting hex if they fail to make an anti-mech check.
                // http://bg.battletech.com/forums/index.php?topic=55263.msg1271423#msg1271423
<span class="nc bnc" id="L6958" title="All 4 branches missed.">                if (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_MECH</span>
<span class="nc bnc" id="L6959" title="All 2 branches missed.">                        &amp;&amp; !entity.isOmni()) {</span>
<span class="nc bnc" id="L6960" title="All 2 branches missed.">                    for (Entity rider : entity.getExternalUnits()) {</span>
<span class="nc" id="L6961">                        addReport(checkDropBAFromConverting(entity, rider, curPos, curFacing,</span>
                                false, false, false));
<span class="nc" id="L6963">                    }</span>
<span class="nc bnc" id="L6964" title="All 2 branches missed.">                } else if ((entity.getEntityType() &amp; Entity.ETYPE_LAND_AIR_MECH) != 0) {</span>
                    //External units on LAMs, including swarmers, fall automatically and take damage,
                    //and the LAM itself may take one or more criticals.
<span class="nc bnc" id="L6967" title="All 2 branches missed.">                    for (Entity rider : entity.getExternalUnits()) {</span>
<span class="nc" id="L6968">                        addReport(checkDropBAFromConverting(entity, rider, curPos, curFacing, true, true, true));</span>
<span class="nc" id="L6969">                    }</span>
<span class="nc" id="L6970">                    final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L6971" title="All 2 branches missed.">                    if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L6972">                        addReport(checkDropBAFromConverting(entity, game.getEntity(swarmerId),</span>
                                curPos, curFacing, true, true, true));
                    }
<span class="nc" id="L6975">                }</span>

                continue;
            }

            // did the entity move?
<span class="nc bnc" id="L6981" title="All 2 branches missed.">            didMove = step.getDistance() &gt; distance;</span>

            // check for aero stuff
<span class="nc bnc" id="L6984" title="All 4 branches missed.">            if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6985">                IAero a = (IAero) entity;</span>
<span class="nc" id="L6986">                j++;</span>

                // increment straight moves (can't do it at end, because not all
                // steps may be processed)
<span class="nc" id="L6990">                a.setStraightMoves(step.getNStraight());</span>

                // TODO : change the way this check is made
<span class="nc bnc" id="L6993" title="All 4 branches missed.">                if (!didMove &amp;&amp; (md.length() != j)) {</span>
<span class="nc" id="L6994">                    thrustUsed += step.getMp();</span>
                } else {
                    // if this was the last move and distance was zero, then add
                    // thrust
<span class="nc bnc" id="L6998" title="All 4 branches missed.">                    if (!didMove &amp;&amp; (md.length() == j)) {</span>
<span class="nc" id="L6999">                        thrustUsed += step.getMp();</span>
                    }
                    // then we moved to a new hex or the last step so check
                    // conditions
                    // structural damage
<span class="nc" id="L7004">                    rollTarget = a.checkThrustSI(thrustUsed, overallMoveType);</span>
<span class="nc bnc" id="L7005" title="All 4 branches missed.">                    if ((rollTarget.getValue() != TargetRoll.CHECK_FALSE)</span>
<span class="nc bnc" id="L7006" title="All 2 branches missed.">                            &amp;&amp; !(entity instanceof FighterSquadron) &amp;&amp; !game.useVectorMove()) {</span>
<span class="nc bnc" id="L7007" title="All 2 branches missed.">                        if (!doSkillCheckInSpace(entity, rollTarget)) {</span>
<span class="nc" id="L7008">                            a.setSI(a.getSI() - 1);</span>
<span class="nc bnc" id="L7009" title="All 2 branches missed.">                            if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L7010">                                addReport(criticalEntity(entity, Mech.LOC_CT, false, 0, 1));</span>
                            }
                            // check for destruction
<span class="nc bnc" id="L7013" title="All 2 branches missed.">                            if (a.getSI() == 0) {</span>
                                // Lets auto-eject if we can!
<span class="nc bnc" id="L7015" title="All 2 branches missed.">                                if (a instanceof LandAirMech) {</span>
                                    // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L7017">                                    LandAirMech lam = (LandAirMech) a;</span>
<span class="nc bnc" id="L7018" title="All 2 branches missed.">                                    if (lam.isAutoEject()</span>
<span class="nc bnc" id="L7019" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7020" title="All 2 branches missed.">                                                || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7021" title="All 2 branches missed.">                                                        &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L7022">                                        addReport(ejectEntity(entity, true, false));</span>
                                    }
<span class="nc" id="L7024">                                } else {</span>
                                    // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L7026">                                    Aero aero = (Aero) a;</span>
<span class="nc bnc" id="L7027" title="All 2 branches missed.">                                    if (aero.isAutoEject()</span>
<span class="nc bnc" id="L7028" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7029" title="All 2 branches missed.">                                                || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7030" title="All 2 branches missed.">                                                        &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L7031">                                        addReport(ejectEntity(entity, true, false));</span>
                                    }
                                }
<span class="nc" id="L7034">                                addReport(destroyEntity(entity, &quot;Structural Integrity Collapse&quot;,</span>
                                        false));
                            }
                        }
                    }

                    // check for pilot damage
<span class="nc" id="L7041">                    int hits = entity.getCrew().getHits();</span>
<span class="nc" id="L7042">                    int health = 6 - hits;</span>

<span class="nc bnc" id="L7044" title="All 6 branches missed.">                    if ((thrustUsed &gt; (2 * health)) &amp;&amp; !game.useVectorMove()</span>
                            &amp;&amp; !(entity instanceof TeleMissile)) {
<span class="nc" id="L7046">                        int targetRoll = 2 + (thrustUsed - (2 * health))</span>
                                + (2 * hits);
<span class="nc" id="L7048">                        resistGForce(entity, targetRoll);</span>
                    }

<span class="nc" id="L7051">                    thrustUsed = 0;</span>
                }

<span class="nc bnc" id="L7054" title="All 2 branches missed.">                if (step.getType() == MoveStepType.RETURN) {</span>
<span class="nc" id="L7055">                    a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7056">                    entity.setAltitude(curAltitude);</span>
<span class="nc" id="L7057">                    processLeaveMap(md, true, Compute.roundsUntilReturn(game, entity));</span>
<span class="nc" id="L7058">                    return;</span>
                }

<span class="nc bnc" id="L7061" title="All 2 branches missed.">                if (step.getType() == MoveStepType.OFF) {</span>
<span class="nc" id="L7062">                    a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7063">                    entity.setAltitude(curAltitude);</span>
<span class="nc" id="L7064">                    processLeaveMap(md, true, -1);</span>
<span class="nc" id="L7065">                    return;</span>
                }

<span class="nc" id="L7068">                rollTarget = a.checkRolls(step, overallMoveType);</span>
<span class="nc bnc" id="L7069" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7070">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0, &quot;excess roll&quot;));</span>
                }

<span class="nc" id="L7073">                rollTarget = a.checkManeuver(step, overallMoveType);</span>
<span class="nc bnc" id="L7074" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L7075" title="All 2 branches missed.">                    if (!doSkillCheckManeuver(entity, rollTarget)) {</span>
<span class="nc" id="L7076">                        a.setFailedManeuver(true);</span>
<span class="nc" id="L7077">                        int forward = Math.max(step.getVelocityLeft() / 2, 1);</span>
<span class="nc bnc" id="L7078" title="All 2 branches missed.">                        if (forward &lt; step.getVelocityLeft()) {</span>
<span class="nc" id="L7079">                            fellDuringMovement = true;</span>
                        }
                        // multiply forward by 16 when on ground hexes
<span class="nc bnc" id="L7082" title="All 2 branches missed.">                        if (game.getBoard().onGround()) {</span>
<span class="nc" id="L7083">                            forward *= 16;</span>
                        }
<span class="nc bnc" id="L7085" title="All 2 branches missed.">                        while (forward &gt; 0) {</span>
<span class="nc" id="L7086">                            curPos = curPos.translated(step.getFacing());</span>
<span class="nc" id="L7087">                            forward--;</span>
<span class="nc" id="L7088">                            distance++;</span>
<span class="nc" id="L7089">                            a.setStraightMoves(a.getStraightMoves() + 1);</span>
                            // make sure it didn't fly off the map
<span class="nc bnc" id="L7091" title="All 2 branches missed.">                            if (!game.getBoard().contains(curPos)) {</span>
<span class="nc" id="L7092">                                a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7093">                                processLeaveMap(md, true, Compute.roundsUntilReturn(game, entity));</span>
<span class="nc" id="L7094">                                return;</span>
                                // make sure it didn't crash
<span class="nc bnc" id="L7096" title="All 2 branches missed.">                            } else if (checkCrash(entity, curPos, step.getAltitude())) {</span>
<span class="nc" id="L7097">                                addReport(processCrash(entity, step.getVelocity(), curPos));</span>
<span class="nc" id="L7098">                                forward = 0;</span>
<span class="nc" id="L7099">                                fellDuringMovement = false;</span>
<span class="nc" id="L7100">                                crashedDuringMovement = true;</span>
                            }
                        }
                        break;
                    }
                }

                // if out of control, check for possible collision
<span class="nc bnc" id="L7108" title="All 4 branches missed.">                if (didMove &amp;&amp; a.isOutControlTotal()) {</span>
<span class="nc" id="L7109">                    Iterator&lt;Entity&gt; targets = game.getEntities(step.getPosition());</span>
<span class="nc bnc" id="L7110" title="All 2 branches missed.">                    if (targets.hasNext()) {</span>
                        // Somebody here so check to see if there is a collision
<span class="nc" id="L7112">                        int checkRoll = Compute.d6(2);</span>
                        // TODO : change this to 11 for Large Craft
<span class="nc" id="L7114">                        int targetRoll = 11;</span>
<span class="nc bnc" id="L7115" title="All 4 branches missed.">                        if ((a instanceof Dropship) || (entity instanceof Jumpship)) {</span>
<span class="nc" id="L7116">                            targetRoll = 10;</span>
                        }
<span class="nc bnc" id="L7118" title="All 2 branches missed.">                        if (checkRoll &gt;= targetRoll) {</span>
                            // this gets complicated, I need to check for each
                            // unit type
                            // by order of movement sub-phase
<span class="nc" id="L7122">                            Vector&lt;Integer&gt; potentialSpaceStation = new Vector&lt;&gt;();</span>
<span class="nc" id="L7123">                            Vector&lt;Integer&gt; potentialWarShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7124">                            Vector&lt;Integer&gt; potentialJumpShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7125">                            Vector&lt;Integer&gt; potentialDropShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7126">                            Vector&lt;Integer&gt; potentialSmallCraft = new Vector&lt;&gt;();</span>
<span class="nc" id="L7127">                            Vector&lt;Integer&gt; potentialASF = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L7129" title="All 2 branches missed.">                            while (targets.hasNext()) {</span>
<span class="nc" id="L7130">                                int id = targets.next().getId();</span>
<span class="nc" id="L7131">                                Entity ce = game.getEntity(id);</span>
                                // if we are in atmosphere and not the same altitude
                                // then skip
<span class="nc bnc" id="L7134" title="All 4 branches missed.">                                if (!game.getBoard().inSpace() &amp;&amp; (ce.getAltitude() != curAltitude)) {</span>
<span class="nc" id="L7135">                                    continue;</span>
                                }
                                // you can't collide with yourself
<span class="nc bnc" id="L7138" title="All 2 branches missed.">                                if (ce.equals(a)) {</span>
<span class="nc" id="L7139">                                    continue;</span>
                                }
<span class="nc bnc" id="L7141" title="All 2 branches missed.">                                if (ce instanceof SpaceStation) {</span>
<span class="nc" id="L7142">                                    potentialSpaceStation.addElement(id);</span>
<span class="nc bnc" id="L7143" title="All 2 branches missed.">                                } else if (ce instanceof Warship) {</span>
<span class="nc" id="L7144">                                    potentialWarShip.addElement(id);</span>
<span class="nc bnc" id="L7145" title="All 2 branches missed.">                                } else if (ce instanceof Jumpship) {</span>
<span class="nc" id="L7146">                                    potentialJumpShip.addElement(id);</span>
<span class="nc bnc" id="L7147" title="All 2 branches missed.">                                } else if (ce instanceof Dropship) {</span>
<span class="nc" id="L7148">                                    potentialDropShip.addElement(id);</span>
<span class="nc bnc" id="L7149" title="All 2 branches missed.">                                } else if (ce instanceof SmallCraft) {</span>
<span class="nc" id="L7150">                                    potentialSmallCraft.addElement(id);</span>
                                } else {
                                    // ASF can actually include anything,
                                    // because we might
                                    // have combat dropping troops
<span class="nc" id="L7155">                                    potentialASF.addElement(id);</span>
                                }
<span class="nc" id="L7157">                            }</span>

                            // ok now go through and see if these have anybody in them
                            int chosen;
                            Entity target;
                            Coords destination;

<span class="nc bnc" id="L7164" title="All 2 branches missed.">                            if (potentialSpaceStation.size() &gt; 0) {</span>
<span class="nc" id="L7165">                                chosen = Compute.randomInt(potentialSpaceStation.size());</span>
<span class="nc" id="L7166">                                target = game.getEntity(potentialSpaceStation.elementAt(chosen));</span>
<span class="nc" id="L7167">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7168" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7169">                                    curPos = destination;</span>
<span class="nc" id="L7170">                                    break;</span>
                                }
<span class="nc bnc" id="L7172" title="All 2 branches missed.">                            } else if (potentialWarShip.size() &gt; 0) {</span>
<span class="nc" id="L7173">                                chosen = Compute.randomInt(potentialWarShip.size());</span>
<span class="nc" id="L7174">                                target = game.getEntity(potentialWarShip.elementAt(chosen));</span>
<span class="nc" id="L7175">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7176" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7177">                                    curPos = destination;</span>
<span class="nc" id="L7178">                                    break;</span>
                                }
<span class="nc bnc" id="L7180" title="All 2 branches missed.">                            } else if (potentialJumpShip.size() &gt; 0) {</span>
<span class="nc" id="L7181">                                chosen = Compute.randomInt(potentialJumpShip.size());</span>
<span class="nc" id="L7182">                                target = game.getEntity(potentialJumpShip.elementAt(chosen));</span>
<span class="nc" id="L7183">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7184" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7185">                                    curPos = destination;</span>
<span class="nc" id="L7186">                                    break;</span>
                                }
<span class="nc bnc" id="L7188" title="All 2 branches missed.">                            } else if (potentialDropShip.size() &gt; 0) {</span>
<span class="nc" id="L7189">                                chosen = Compute.randomInt(potentialDropShip.size());</span>
<span class="nc" id="L7190">                                target = game.getEntity(potentialDropShip.elementAt(chosen));</span>
<span class="nc" id="L7191">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7192" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7193">                                    curPos = destination;</span>
<span class="nc" id="L7194">                                    break;</span>
                                }
<span class="nc bnc" id="L7196" title="All 2 branches missed.">                            } else if (potentialSmallCraft.size() &gt; 0) {</span>
<span class="nc" id="L7197">                                chosen = Compute.randomInt(potentialSmallCraft.size());</span>
<span class="nc" id="L7198">                                target = game.getEntity(potentialSmallCraft.elementAt(chosen));</span>
<span class="nc" id="L7199">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7200" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7201">                                    curPos = destination;</span>
<span class="nc" id="L7202">                                    break;</span>
                                }
<span class="nc bnc" id="L7204" title="All 2 branches missed.">                            } else if (potentialASF.size() &gt; 0) {</span>
<span class="nc" id="L7205">                                chosen = Compute.randomInt(potentialASF.size());</span>
<span class="nc" id="L7206">                                target = game.getEntity(potentialASF.elementAt(chosen));</span>
<span class="nc" id="L7207">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7208" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7209">                                    curPos = destination;</span>
<span class="nc" id="L7210">                                    break;</span>
                                }
                            }

                        }
                    }
                }

                // if in the atmosphere, check for a potential crash

<span class="nc bnc" id="L7220" title="All 2 branches missed.">                if (checkCrash(entity, step.getPosition(), step.getAltitude())) {</span>
<span class="nc" id="L7221">                    addReport(processCrash(entity, md.getFinalVelocity(), curPos));</span>
<span class="nc" id="L7222">                    crashedDuringMovement = true;</span>
                    // don't do the rest
<span class="nc" id="L7224">                    break;</span>
                }

                // handle fighter launching
<span class="nc bnc" id="L7228" title="All 2 branches missed.">                if (step.getType() == MoveStepType.LAUNCH) {</span>
<span class="nc" id="L7229">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = step.getLaunched();</span>
<span class="nc" id="L7230">                    Set&lt;Integer&gt; bays = launched.keySet();</span>
<span class="nc" id="L7231">                    Iterator&lt;Integer&gt; bayIter = bays.iterator();</span>
                    Bay currentBay;
<span class="nc bnc" id="L7233" title="All 2 branches missed.">                    while (bayIter.hasNext()) {</span>
<span class="nc" id="L7234">                        int bayId = bayIter.next();</span>
<span class="nc" id="L7235">                        currentBay = entity.getFighterBays().elementAt(bayId);</span>
<span class="nc" id="L7236">                        Vector&lt;Integer&gt; launches = launched.get(bayId);</span>
<span class="nc" id="L7237">                        int nLaunched = launches.size();</span>
                        // need to make some decisions about how to handle the
                        // distribution
                        // of fighters to doors beyond the launch rate. The most
                        // sensible thing
                        // is probably to distribute them evenly.
<span class="nc" id="L7243">                        int doors = currentBay.getCurrentDoors();</span>
<span class="nc" id="L7244">                        int[] distribution = new int[doors];</span>
<span class="nc bnc" id="L7245" title="All 2 branches missed.">                        for (int l = 0; l &lt; nLaunched; l++) {</span>
<span class="nc" id="L7246">                            distribution[l % doors] = distribution[l % doors] + 1;</span>
                        }
                        // ok, now lets launch them
<span class="nc" id="L7249">                        r = new Report(9380);</span>
<span class="nc" id="L7250">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7251">                        r.subject = entity.getId();</span>
<span class="nc" id="L7252">                        r.add(nLaunched);</span>
<span class="nc" id="L7253">                        r.add(&quot;bay &quot; + currentBay.getBayNumber() + &quot; (&quot; + doors + &quot; doors)&quot;);</span>
<span class="nc" id="L7254">                        addReport(r);</span>
<span class="nc" id="L7255">                        int currentDoor = 0;</span>
<span class="nc" id="L7256">                        int fighterCount = 0;</span>
<span class="nc" id="L7257">                        boolean doorDamage = false;</span>
<span class="nc bnc" id="L7258" title="All 2 branches missed.">                        for (int fighterId : launches) {</span>
                            // check to see if we are in the same door
<span class="nc" id="L7260">                            fighterCount++;</span>

                            // check for door damage
<span class="nc" id="L7263">                            Report doorReport = null;</span>
<span class="nc bnc" id="L7264" title="All 6 branches missed.">                            if (!doorDamage &amp;&amp; (distribution[currentDoor] &gt; 2) &amp;&amp; (fighterCount &gt; 2)) {</span>
<span class="nc" id="L7265">                                doorReport = new Report(9378);</span>
<span class="nc" id="L7266">                                doorReport.subject = entity.getId();</span>
<span class="nc" id="L7267">                                doorReport.indent(2);</span>
<span class="nc" id="L7268">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L7269">                                doorReport.add(roll);</span>
<span class="nc bnc" id="L7270" title="All 2 branches missed.">                                if (roll == 2) {</span>
<span class="nc" id="L7271">                                    doorDamage = true;</span>
<span class="nc" id="L7272">                                    doorReport.choose(true);</span>
<span class="nc" id="L7273">                                    currentBay.destroyDoorNext();</span>
                                } else {
<span class="nc" id="L7275">                                    doorReport.choose(false);</span>
                                }
<span class="nc" id="L7277">                                doorReport.newlines++;</span>
                            }

<span class="nc bnc" id="L7280" title="All 2 branches missed.">                            if (fighterCount &gt; distribution[currentDoor]) {</span>
                                // move to a new door
<span class="nc" id="L7282">                                currentDoor++;</span>
<span class="nc" id="L7283">                                fighterCount = 0;</span>
<span class="nc" id="L7284">                                doorDamage = false;</span>
                            }
<span class="nc" id="L7286">                            int bonus = Math.max(0,</span>
                                    distribution[currentDoor] - 2);

<span class="nc" id="L7289">                            Entity fighter = game.getEntity(fighterId);</span>
<span class="nc bnc" id="L7290" title="All 2 branches missed.">                            if (!launchUnit(entity, fighter, curPos, curFacing, step.getVelocity(),</span>
<span class="nc" id="L7291">                                    step.getAltitude(), step.getVectors(), bonus)) {</span>
<span class="nc" id="L7292">                                MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L7293">                                        + fighter.getDisplayName() + &quot; from &quot; + entity.getDisplayName()</span>
<span class="nc" id="L7294">                                        + &quot; into &quot; + curPos.getBoardNum());</span>
                            }
<span class="nc bnc" id="L7296" title="All 2 branches missed.">                            if (doorReport != null) {</span>
<span class="nc" id="L7297">                                addReport(doorReport);</span>
                            }
<span class="nc" id="L7299">                        }</span>
<span class="nc" id="L7300">                    }</span>
                    // now apply any damage to bay doors
<span class="nc" id="L7302">                    entity.resetBayDoors();</span>
                }

                // handle DropShip undocking
<span class="nc bnc" id="L7306" title="All 2 branches missed.">                if (step.getType() == MoveStepType.UNDOCK) {</span>
<span class="nc" id="L7307">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = step.getLaunched();</span>
<span class="nc" id="L7308">                    Set&lt;Integer&gt; collars = launched.keySet();</span>
<span class="nc" id="L7309">                    Iterator&lt;Integer&gt; collarIter = collars.iterator();</span>
<span class="nc bnc" id="L7310" title="All 2 branches missed.">                    while (collarIter.hasNext()) {</span>
<span class="nc" id="L7311">                        int collarId = collarIter.next();</span>
<span class="nc" id="L7312">                        Vector&lt;Integer&gt; launches = launched.get(collarId);</span>
<span class="nc" id="L7313">                        int nLaunched = launches.size();</span>
                        // ok, now lets launch them
<span class="nc" id="L7315">                        r = new Report(9380);</span>
<span class="nc" id="L7316">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7317">                        r.subject = entity.getId();</span>
<span class="nc" id="L7318">                        r.add(nLaunched);</span>
<span class="nc" id="L7319">                        r.add(&quot;collar &quot; + collarId);</span>
<span class="nc" id="L7320">                        addReport(r);</span>
<span class="nc bnc" id="L7321" title="All 2 branches missed.">                        for (int dropShipId : launches) {</span>
                            // check to see if we are in the same door
<span class="nc" id="L7323">                            Entity ds = game.getEntity(dropShipId);</span>
<span class="nc bnc" id="L7324" title="All 2 branches missed.">                            if (!launchUnit(entity, ds, curPos, curFacing,</span>
<span class="nc" id="L7325">                                    step.getVelocity(), step.getAltitude(),</span>
<span class="nc" id="L7326">                                    step.getVectors(), 0)) {</span>
<span class="nc" id="L7327">                                MegaMek.getLogger().error(&quot;Error! Server was told to unload &quot;</span>
<span class="nc" id="L7328">                                                + ds.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L7329">                                                + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L7330">                                                + curPos.getBoardNum());</span>
                            }
<span class="nc" id="L7332">                        }</span>
<span class="nc" id="L7333">                    }</span>
                }

                // handle combat drops
<span class="nc bnc" id="L7337" title="All 2 branches missed.">                if (step.getType() == MoveStepType.DROP) {</span>
<span class="nc" id="L7338">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; dropped = step.getLaunched();</span>
<span class="nc" id="L7339">                    Set&lt;Integer&gt; bays = dropped.keySet();</span>
<span class="nc" id="L7340">                    Iterator&lt;Integer&gt; bayIter = bays.iterator();</span>
                    Bay currentBay;
<span class="nc bnc" id="L7342" title="All 2 branches missed.">                    while (bayIter.hasNext()) {</span>
<span class="nc" id="L7343">                        int bayId = bayIter.next();</span>
<span class="nc" id="L7344">                        currentBay = entity.getTransportBays().elementAt(bayId);</span>
<span class="nc" id="L7345">                        Vector&lt;Integer&gt; drops = dropped.get(bayId);</span>
<span class="nc" id="L7346">                        int nDropped = drops.size();</span>
                        // ok, now lets drop them
<span class="nc" id="L7348">                        r = new Report(9386);</span>
<span class="nc" id="L7349">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7350">                        r.subject = entity.getId();</span>
<span class="nc" id="L7351">                        r.add(nDropped);</span>
<span class="nc" id="L7352">                        addReport(r);</span>
<span class="nc bnc" id="L7353" title="All 2 branches missed.">                        for (int unitId : drops) {</span>
<span class="nc bnc" id="L7354" title="All 2 branches missed.">                            if (Compute.d6(2) == 2) {</span>
<span class="nc" id="L7355">                                r = new Report(9390);</span>
<span class="nc" id="L7356">                                r.subject = entity.getId();</span>
<span class="nc" id="L7357">                                r.indent(1);</span>
<span class="nc" id="L7358">                                r.add(currentBay.getType());</span>
<span class="nc" id="L7359">                                addReport(r);</span>
<span class="nc" id="L7360">                                currentBay.destroyDoorNext();</span>
                            }
<span class="nc" id="L7362">                            Entity drop = game.getEntity(unitId);</span>
<span class="nc" id="L7363">                            dropUnit(drop, entity, curPos, step.getAltitude());</span>
<span class="nc" id="L7364">                        }</span>
<span class="nc" id="L7365">                    }</span>
                    // now apply any damage to bay doors
<span class="nc" id="L7367">                    entity.resetBayDoors();</span>
                }
            }

            // check piloting skill for getting up
<span class="nc" id="L7372">            rollTarget = entity.checkGetUp(step, overallMoveType);</span>

<span class="nc bnc" id="L7374" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Unless we're an ICE- or fuel cell-powered IndustrialMech,
                // standing up builds heat.
<span class="nc bnc" id="L7377" title="All 6 branches missed.">                if ((entity instanceof Mech) &amp;&amp; entity.hasEngine() &amp;&amp; !(((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L7378" title="All 2 branches missed.">                        &amp;&amp; ((entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)</span>
<span class="nc bnc" id="L7379" title="All 2 branches missed.">                                || (entity.getEngine().getEngineType() == Engine.FUEL_CELL)))) {</span>
<span class="nc" id="L7380">                    entity.heatBuildup += 1;</span>
                }
<span class="nc" id="L7382">                entity.setProne(false);</span>
                // entity.setHullDown(false);
<span class="nc" id="L7384">                wasProne = false;</span>
<span class="nc" id="L7385">                game.resetPSRs(entity);</span>
<span class="nc bnc" id="L7386" title="All 2 branches missed.">                entityFellWhileAttemptingToStand = !doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // did the entity just fall?
<span class="nc bnc" id="L7389" title="All 2 branches missed.">            if (entityFellWhileAttemptingToStand) {</span>
<span class="nc" id="L7390">                moveType = stepMoveType;</span>
<span class="nc" id="L7391">                curFacing = entity.getFacing();</span>
<span class="nc" id="L7392">                curPos = entity.getPosition();</span>
<span class="nc" id="L7393">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L7394">                fellDuringMovement = true;</span>
<span class="nc bnc" id="L7395" title="All 2 branches missed.">                if (!entity.isCarefulStand()) {</span>
<span class="nc" id="L7396">                    break;</span>
                }
<span class="nc bnc" id="L7398" title="All 2 branches missed.">            } else if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7399">                entity.setHullDown(false);</span>
            }

<span class="nc bnc" id="L7402" title="All 2 branches missed.">            if (step.getType() == MoveStepType.UNJAM_RAC) {</span>
<span class="nc" id="L7403">                entity.setUnjammingRAC(true);</span>
<span class="nc" id="L7404">                game.addAction(new UnjamAction(entity.getId()));</span>

                // for Aeros this will end movement prematurely
                // if we break
<span class="nc bnc" id="L7408" title="All 2 branches missed.">                if (!(entity.isAirborne())) {</span>
<span class="nc" id="L7409">                    break;</span>
                }
            }

<span class="nc bnc" id="L7413" title="All 2 branches missed.">            if (step.getType() == MoveStepType.LAY_MINE) {</span>
<span class="nc" id="L7414">                layMine(entity, step.getMineToLay(), step.getPosition());</span>
<span class="nc" id="L7415">                continue;</span>
            }

<span class="nc bnc" id="L7418" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CLEAR_MINEFIELD) {</span>
<span class="nc" id="L7419">                ClearMinefieldAction cma = new ClearMinefieldAction(entity.getId(), step.getMinefield());</span>
<span class="nc" id="L7420">                entity.setClearingMinefield(true);</span>
<span class="nc" id="L7421">                game.addAction(cma);</span>
<span class="nc" id="L7422">                break;</span>
            }

<span class="nc bnc" id="L7425" title="All 2 branches missed.">            if ((step.getType() == MoveStepType.SEARCHLIGHT)</span>
<span class="nc bnc" id="L7426" title="All 2 branches missed.">                    &amp;&amp; entity.hasSpotlight()) {</span>
<span class="nc bnc" id="L7427" title="All 2 branches missed.">                final boolean SearchOn = !entity.isUsingSpotlight();</span>
<span class="nc" id="L7428">                entity.setSpotlightState(SearchOn);</span>
<span class="nc bnc" id="L7429" title="All 2 branches missed.">                if (doBlind()) { // if double blind, we may need to filter the</span>
                    // players that receive this message
<span class="nc" id="L7431">                    Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc" id="L7432">                    Vector&lt;IPlayer&gt; vCanSee = whoCanSee(entity);</span>
<span class="nc bnc" id="L7433" title="All 2 branches missed.">                    for (IPlayer p : playersVector) {</span>
<span class="nc bnc" id="L7434" title="All 2 branches missed.">                        if (vCanSee.contains(p)) { // Player sees the unit</span>
<span class="nc" id="L7435">                            sendServerChat(p.getId(),</span>
<span class="nc" id="L7436">                                    entity.getDisplayName()</span>
                                            + &quot; switched searchlight &quot;
<span class="nc bnc" id="L7438" title="All 2 branches missed.">                                            + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                        } else {
<span class="nc" id="L7440">                            sendServerChat(p.getId(),</span>
                                    &quot;An unseen unit&quot; + &quot; switched searchlight &quot;
<span class="nc bnc" id="L7442" title="All 2 branches missed.">                                            + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                        }
<span class="nc" id="L7444">                    }</span>
<span class="nc" id="L7445">                } else { // No double blind, everyone can see this</span>
<span class="nc" id="L7446">                    sendServerChat(</span>
<span class="nc" id="L7447">                            entity.getDisplayName() + &quot; switched searchlight &quot;</span>
<span class="nc bnc" id="L7448" title="All 2 branches missed.">                                    + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                }
            }

            // set most step parameters
<span class="nc" id="L7453">            moveType = stepMoveType;</span>
<span class="nc" id="L7454">            distance = step.getDistance();</span>
<span class="nc" id="L7455">            mpUsed = step.getMpUsed();</span>

<span class="nc bnc" id="L7457" title="All 2 branches missed.">            if (cachedGravityLimit &lt; 0) {</span>
<span class="nc bnc" id="L7458" title="All 2 branches missed.">                cachedGravityLimit = EntityMovementType.MOVE_JUMP == moveType</span>
<span class="nc" id="L7459">                        ? entity.getJumpMP(false)</span>
<span class="nc" id="L7460">                        : entity.getRunningGravityLimit();</span>
            }
            // check for charge
<span class="nc bnc" id="L7463" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CHARGE) {</span>
<span class="nc bnc" id="L7464" title="All 2 branches missed.">                if (entity.canCharge()) {</span>
<span class="nc" id="L7465">                    checkExtremeGravityMovement(entity, step, lastStepMoveType,</span>
                            curPos, cachedGravityLimit);
<span class="nc" id="L7467">                    Targetable target = step.getTarget(game);</span>
<span class="nc bnc" id="L7468" title="All 2 branches missed.">                    if (target != null) {</span>
<span class="nc" id="L7469">                        ChargeAttackAction caa = new ChargeAttackAction(</span>
<span class="nc" id="L7470">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L7471">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L7472">                        entity.setDisplacementAttack(caa);</span>
<span class="nc" id="L7473">                        game.addCharge(caa);</span>
<span class="nc" id="L7474">                        charge = caa;</span>
<span class="nc" id="L7475">                    } else {</span>
<span class="nc" id="L7476">                        String message = &quot;Illegal charge!! &quot; + entity.getDisplayName() +</span>
                                &quot; is attempting to charge a null target!&quot;;
<span class="nc" id="L7478">                        MegaMek.getLogger().info(message);</span>
<span class="nc" id="L7479">                        sendServerChat(message);</span>
<span class="nc" id="L7480">                        return;</span>
                    }
<span class="nc bnc" id="L7482" title="All 4 branches missed.">                } else if (entity.isAirborneVTOLorWIGE() &amp;&amp; entity.canRam()) {</span>
<span class="nc" id="L7483">                    checkExtremeGravityMovement(entity, step, lastStepMoveType,</span>
                            curPos, cachedGravityLimit);
<span class="nc" id="L7485">                    Targetable target = step.getTarget(game);</span>
<span class="nc bnc" id="L7486" title="All 2 branches missed.">                    if (target != null) {</span>
<span class="nc" id="L7487">                        AirmechRamAttackAction raa = new AirmechRamAttackAction(</span>
<span class="nc" id="L7488">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L7489">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L7490">                        entity.setDisplacementAttack(raa);</span>
<span class="nc" id="L7491">                        entity.setRamming(true);</span>
<span class="nc" id="L7492">                        game.addCharge(raa);</span>
<span class="nc" id="L7493">                        charge = raa;</span>
<span class="nc" id="L7494">                    } else {</span>
<span class="nc" id="L7495">                        String message = &quot;Illegal charge!! &quot; + entity.getDisplayName() + &quot; is attempting to charge a null target!&quot;;</span>
<span class="nc" id="L7496">                        MegaMek.getLogger().info(message);</span>
<span class="nc" id="L7497">                        sendServerChat(message);</span>
<span class="nc" id="L7498">                        return;</span>
                    }
<span class="nc" id="L7500">                } else {</span>
<span class="nc" id="L7501">                    sendServerChat(&quot;Illegal charge!! I don't think &quot;</span>
<span class="nc" id="L7502">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to charge,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7505">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7506">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7507">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7510">                    return;</span>
                }
                break;
            }

            // check for dfa
<span class="nc bnc" id="L7516" title="All 2 branches missed.">            if (step.getType() == MoveStepType.DFA) {</span>
<span class="nc bnc" id="L7517" title="All 2 branches missed.">                if (entity.canDFA()) {</span>
<span class="nc" id="L7518">                    checkExtremeGravityMovement(entity, step, lastStepMoveType, curPos, cachedGravityLimit);</span>
<span class="nc" id="L7519">                    Targetable target = step.getTarget(game);</span>
                    
                    int targetType;
                    int targetID;
                    
                    // if it's a valid target, then simply pass along the type and ID
<span class="nc bnc" id="L7525" title="All 2 branches missed.">                    if (target != null) {    </span>
<span class="nc" id="L7526">                        targetID = target.getTargetId();</span>
<span class="nc" id="L7527">                        targetType = target.getTargetType();</span>
                    // if the target has become invalid somehow, or was incorrectly declared in the first place
                    // log the error, then put some defaults in for the DFA and proceed as if the target had been moved/destroyed
                    } else {
<span class="nc" id="L7531">                        String errorMessage = &quot;Illegal DFA by &quot; + entity.getDisplayName() + &quot; against non-existent entity at &quot; + step.getTargetPosition(); </span>
<span class="nc" id="L7532">                        sendServerChat(errorMessage);</span>
<span class="nc" id="L7533">                        MegaMek.getLogger().error(errorMessage);</span>
<span class="nc" id="L7534">                        targetID = Entity.NONE; </span>
                        // doesn't really matter, DFA processing will cut out early if target resolves as null
<span class="nc" id="L7536">                        targetType = Targetable.TYPE_ENTITY; </span>
                    }
                    
<span class="nc" id="L7539">                    DfaAttackAction daa = new DfaAttackAction(entity.getId(),</span>
                            targetType, targetID,
<span class="nc" id="L7541">                            step.getPosition());</span>
<span class="nc" id="L7542">                    entity.setDisplacementAttack(daa);</span>
<span class="nc" id="L7543">                    entity.setElevation(step.getElevation());</span>
<span class="nc" id="L7544">                    game.addCharge(daa);</span>
<span class="nc" id="L7545">                    charge = daa;</span>
                    
<span class="nc" id="L7547">                } else {</span>
<span class="nc" id="L7548">                    sendServerChat(&quot;Illegal DFA!! I don't think &quot;</span>
<span class="nc" id="L7549">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to DFA,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7552">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7553">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7554">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7557">                    return;</span>
                }
                
                break;
            }

            // check for ram
<span class="nc bnc" id="L7564" title="All 2 branches missed.">            if (step.getType() == MoveStepType.RAM) {</span>
<span class="nc bnc" id="L7565" title="All 2 branches missed.">                if (entity.canRam()) {</span>
<span class="nc" id="L7566">                    Targetable target = step.getTarget(game);</span>
<span class="nc" id="L7567">                    RamAttackAction raa = new RamAttackAction(entity.getId(),</span>
<span class="nc" id="L7568">                            target.getTargetType(), target.getTargetId(),</span>
<span class="nc" id="L7569">                            target.getPosition());</span>
<span class="nc" id="L7570">                    entity.setRamming(true);</span>
<span class="nc" id="L7571">                    game.addRam(raa);</span>
<span class="nc" id="L7572">                    ram = raa;</span>
<span class="nc" id="L7573">                } else {</span>
<span class="nc" id="L7574">                    sendServerChat(&quot;Illegal ram!! I don't think &quot;</span>
<span class="nc" id="L7575">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to charge,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7578">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7579">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7580">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7583">                    return;</span>
                }
                break;
            }

<span class="nc bnc" id="L7588" title="All 2 branches missed.">            if (step.isVTOLBombingStep()) {</span>
<span class="nc" id="L7589">                ((IBomber) entity).setVTOLBombTarget(step.getTarget(game));</span>
<span class="nc bnc" id="L7590" title="All 4 branches missed.">            } else if (step.isStrafingStep() &amp;&amp; (entity instanceof VTOL)) {</span>
<span class="nc" id="L7591">                ((VTOL) entity).getStrafingCoords().add(step.getPosition());</span>
            }

<span class="nc bnc" id="L7594" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.ACC) || (step.getType() == MoveStepType.ACCN)) {</span>
<span class="nc bnc" id="L7595" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7596">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7597" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.ACCN) {</span>
<span class="nc" id="L7598">                        a.setAccLast(true);</span>
                    } else {
<span class="nc" id="L7600">                        a.setAccDecNow(true);</span>
<span class="nc" id="L7601">                        a.setCurrentVelocity(a.getCurrentVelocity() + 1);</span>
                    }
<span class="nc" id="L7603">                    a.setNextVelocity(a.getNextVelocity() + 1);</span>
                }
            }

<span class="nc bnc" id="L7607" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.DEC) || (step.getType() == MoveStepType.DECN)) {</span>
<span class="nc bnc" id="L7608" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7609">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7610" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.DECN) {</span>
<span class="nc" id="L7611">                        a.setAccLast(true);</span>
                    } else {
<span class="nc" id="L7613">                        a.setAccDecNow(true);</span>
<span class="nc" id="L7614">                        a.setCurrentVelocity(a.getCurrentVelocity() - 1);</span>
                    }
<span class="nc" id="L7616">                    a.setNextVelocity(a.getNextVelocity() - 1);</span>
                }
            }

<span class="nc bnc" id="L7620" title="All 2 branches missed.">            if (step.getType() == MoveStepType.EVADE) {</span>
<span class="nc" id="L7621">                entity.setEvading(true);</span>
            }

<span class="nc bnc" id="L7624" title="All 2 branches missed.">            if (step.getType() == MoveStepType.SHUTDOWN) {</span>
<span class="nc" id="L7625">                entity.performManualShutdown();</span>
<span class="nc" id="L7626">                sendServerChat(entity.getDisplayName() + &quot; has shutdown.&quot;);</span>
            }

<span class="nc bnc" id="L7629" title="All 2 branches missed.">            if (step.getType() == MoveStepType.STARTUP) {</span>
<span class="nc" id="L7630">                entity.performManualStartup();</span>
<span class="nc" id="L7631">                sendServerChat(entity.getDisplayName() + &quot; has started up.&quot;);</span>
            }

<span class="nc bnc" id="L7634" title="All 2 branches missed.">            if (step.getType() == MoveStepType.SELF_DESTRUCT) {</span>
<span class="nc" id="L7635">                entity.setSelfDestructing(true);</span>
            }

<span class="nc bnc" id="L7638" title="All 2 branches missed.">            if (step.getType() == MoveStepType.ROLL) {</span>
<span class="nc bnc" id="L7639" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7640">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7641" title="All 2 branches missed.">                    a.setRolled(!a.isRolled());</span>
                }
            }

            // check for dig in or fortify
<span class="nc bnc" id="L7646" title="All 2 branches missed.">            if (entity instanceof Infantry) {</span>
<span class="nc" id="L7647">                Infantry inf = (Infantry) entity;</span>
<span class="nc bnc" id="L7648" title="All 2 branches missed.">                if (step.getType() == MoveStepType.DIG_IN) {</span>
<span class="nc" id="L7649">                    inf.setDugIn(Infantry.DUG_IN_WORKING);</span>
<span class="nc" id="L7650">                    continue;</span>
<span class="nc bnc" id="L7651" title="All 2 branches missed.">                } else if (step.getType() == MoveStepType.FORTIFY) {</span>
<span class="nc bnc" id="L7652" title="All 2 branches missed.">                    if (!entity.hasWorkingMisc(MiscType.F_TOOLS,</span>
                            MiscType.S_VIBROSHOVEL)) {
<span class="nc" id="L7654">                        sendServerChat(entity.getDisplayName()</span>
                                + &quot; failed to fortify because it is missing suitable equipment&quot;);
                    }
<span class="nc" id="L7657">                    inf.setDugIn(Infantry.DUG_IN_FORTIFYING1);</span>
<span class="nc" id="L7658">                    continue;</span>
<span class="nc bnc" id="L7659" title="All 2 branches missed.">                } else if ((step.getType() != MoveStepType.TURN_LEFT)</span>
<span class="nc bnc" id="L7660" title="All 2 branches missed.">                        &amp;&amp; (step.getType() != MoveStepType.TURN_RIGHT)) {</span>
                    // other movement clears dug in status
<span class="nc" id="L7662">                    inf.setDugIn(Infantry.DUG_IN_NONE);</span>
                }

<span class="nc bnc" id="L7665" title="All 2 branches missed.">                if (step.getType() == MoveStepType.TAKE_COVER) {</span>
<span class="nc bnc" id="L7666" title="All 2 branches missed.">                    if (Infantry.hasValidCover(game, step.getPosition(),</span>
<span class="nc" id="L7667">                            step.getElevation())) {</span>
<span class="nc" id="L7668">                        inf.setTakingCover(true);</span>
                    } else {
<span class="nc" id="L7670">                        sendServerChat(entity.getDisplayName()</span>
                                + &quot; failed to take cover: &quot;
                                + &quot;no valid unit found in &quot;
<span class="nc" id="L7673">                                + step.getPosition());</span>
                    }
                }
            }

            // If we have turned, check whether we have fulfilled any turn mode requirements.
<span class="nc bnc" id="L7679" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.TURN_LEFT || step.getType() == MoveStepType.TURN_RIGHT)</span>
<span class="nc bnc" id="L7680" title="All 2 branches missed.">                    &amp;&amp; entity.usesTurnMode()) {</span>
<span class="nc" id="L7681">                int straight = 0;</span>
<span class="nc bnc" id="L7682" title="All 2 branches missed.">                if (prevStep != null) {</span>
<span class="nc" id="L7683">                    straight = prevStep.getNStraight();</span>
                }
<span class="nc" id="L7685">                rollTarget = entity.checkTurnModeFailure(overallMoveType, straight,</span>
<span class="nc" id="L7686">                        md.getMpUsed(), step.getPosition());</span>
<span class="nc bnc" id="L7687" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7688">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L7690" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
<span class="nc bnc" id="L7691" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos,</span>
<span class="nc" id="L7692">                                step.getFacing() - curFacing,</span>
<span class="nc bnc" id="L7693" title="All 2 branches missed.">                                (null == prevStep)?step : prevStep,</span>
<span class="nc" id="L7694">                                        step.isThisStepBackwards(),</span>
                                        lastStepMoveType, distance, mof, mof)) {
<span class="nc bnc" id="L7696" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L7697">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L7699">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L7702">                            turnOver = true;</span>
<span class="nc" id="L7703">                            distance = entity.delta_distance;</span>
                        } else {
<span class="nc" id="L7705">                            continueTurnFromFishtail = true;</span>
                        }
<span class="nc" id="L7707">                        curFacing = entity.getFacing();</span>
<span class="nc" id="L7708">                        curPos = entity.getPosition();</span>
<span class="nc" id="L7709">                        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L7710">                        break;</span>
                    }
                }
            }

<span class="nc bnc" id="L7715" title="All 2 branches missed.">            if (step.getType() == MoveStepType.BOOTLEGGER) {</span>
<span class="nc" id="L7716">                rollTarget = entity.getBasePilotingRoll();</span>
<span class="nc" id="L7717">                entity.addPilotingModifierForTerrain(rollTarget);</span>
<span class="nc" id="L7718">                rollTarget.addModifier(0, &quot;bootlegger maneuver&quot;);</span>
<span class="nc" id="L7719">                int mof = doSkillCheckWhileMoving(entity, lastElevation,</span>
                        curPos, curPos, rollTarget, false);
<span class="nc bnc" id="L7721" title="All 2 branches missed.">                if (mof &gt; 0) {</span>
                    // If the bootlegger maneuver fails, we treat it as a turn in a random direction.
<span class="nc bnc" id="L7723" title="All 2 branches missed.">                    processFailedVehicleManeuver(entity, curPos, Compute.d6() &lt; 4 ? -1 : 1,</span>
<span class="nc bnc" id="L7724" title="All 2 branches missed.">                            (null == prevStep)? step : prevStep,</span>
<span class="nc" id="L7725">                            step.isThisStepBackwards(), lastStepMoveType, distance, 2, mof);</span>
<span class="nc" id="L7726">                    curFacing = entity.getFacing();</span>
<span class="nc" id="L7727">                    curPos = entity.getPosition();</span>
<span class="nc" id="L7728">                    break;</span>
                }
            }

            // set last step parameters
<span class="nc" id="L7733">            curPos = step.getPosition();</span>
<span class="nc bnc" id="L7734" title="All 4 branches missed.">            if (!((entity.getJumpType() == Mech.JUMP_BOOSTER) &amp;&amp; step.isJumping())) {</span>
<span class="nc" id="L7735">                curFacing = step.getFacing();</span>
            }
            // check if a building PSR will be needed later, before setting the
            // new elevation
<span class="nc" id="L7739">            int buildingMove = entity.checkMovementInBuilding(step, prevStep, curPos, lastPos);</span>
<span class="nc" id="L7740">            curVTOLElevation = step.getElevation();</span>
<span class="nc" id="L7741">            curAltitude = step.getAltitude();</span>
<span class="nc" id="L7742">            curElevation = step.getElevation();</span>
<span class="nc" id="L7743">            curClimbMode = step.climbMode();</span>
            // set elevation in case of collapses
<span class="nc" id="L7745">            entity.setElevation(step.getElevation());</span>
            // set climb mode in case of skid
<span class="nc" id="L7747">            entity.setClimbMode(curClimbMode);</span>

<span class="nc" id="L7749">            IHex curHex = game.getBoard().getHex(curPos);</span>

            // when first entering a building, we need to roll what type
            // of basement it has
<span class="nc bnc" id="L7753" title="All 4 branches missed.">            if (isOnGround &amp;&amp; curHex.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L7754">                Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L7755" title="All 2 branches missed.">                if (bldg.rollBasement(curPos, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L7756">                    sendChangedHex(curPos);</span>
<span class="nc" id="L7757">                    Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L7758">                    buildings.add(bldg);</span>
<span class="nc" id="L7759">                    sendChangedBuildings(buildings);</span>
                }
            }

            // check for automatic unstick
<span class="nc bnc" id="L7764" title="All 6 branches missed.">            if (entity.canUnstickByJumping() &amp;&amp; entity.isStuck()</span>
                    &amp;&amp; (moveType == EntityMovementType.MOVE_JUMP)) {
<span class="nc" id="L7766">                entity.setStuck(false);</span>
<span class="nc" id="L7767">                entity.setCanUnstickByJumping(false);</span>
            }

            // check for leap
<span class="nc bnc" id="L7771" title="All 6 branches missed.">            if (!lastPos.equals(curPos)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP) &amp;&amp; (entity instanceof Mech)
<span class="nc bnc" id="L7773" title="All 4 branches missed.">                    &amp;&amp; !entity.isAirborne() &amp;&amp; (step.getClearance() &lt;= 0)  // Don't check airborne LAMs</span>
<span class="nc bnc" id="L7774" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_LEAPING)) {</span>
<span class="nc" id="L7775">                int leapDistance = (lastElevation</span>
<span class="nc" id="L7776">                        + game.getBoard().getHex(lastPos).getLevel())</span>
<span class="nc" id="L7777">                        - (curElevation + curHex.getLevel());</span>
<span class="nc bnc" id="L7778" title="All 2 branches missed.">                if (leapDistance &gt; 2) {</span>
                    // skill check for leg damage
<span class="nc" id="L7780">                    rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L7781">                    entity.addPilotingModifierForTerrain(rollTarget, curPos);</span>
<span class="nc" id="L7782">                    rollTarget.append(new PilotingRollData(entity.getId(),</span>
                            2 * leapDistance, &quot;leaping (leg damage)&quot;));
<span class="nc bnc" id="L7784" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
                        // do leg damage
<span class="nc" id="L7787">                        addReport(damageEntity(entity, new HitData(Mech.LOC_LLEG), leapDistance));</span>
<span class="nc" id="L7788">                        addReport(damageEntity(entity, new HitData(Mech.LOC_RLEG), leapDistance));</span>
<span class="nc" id="L7789">                        addNewLines();</span>
<span class="nc" id="L7790">                        addReport(criticalEntity(entity, Mech.LOC_LLEG, false, 0, 0));</span>
<span class="nc" id="L7791">                        addNewLines();</span>
<span class="nc" id="L7792">                        addReport(criticalEntity(entity, Mech.LOC_RLEG, false, 0, 0));</span>
<span class="nc bnc" id="L7793" title="All 2 branches missed.">                        if (entity instanceof QuadMech) {</span>
<span class="nc" id="L7794">                            addReport(damageEntity(entity, new HitData(Mech.LOC_LARM), leapDistance));</span>
<span class="nc" id="L7795">                            addReport(damageEntity(entity, new HitData(Mech.LOC_RARM), leapDistance));</span>
<span class="nc" id="L7796">                            addNewLines();</span>
<span class="nc" id="L7797">                            addReport(criticalEntity(entity, Mech.LOC_LARM, false, 0, 0));</span>
<span class="nc" id="L7798">                            addNewLines();</span>
<span class="nc" id="L7799">                            addReport(criticalEntity(entity, Mech.LOC_RARM, false, 0, 0));</span>
                        }
                    }
                    // skill check for fall
<span class="nc" id="L7803">                    rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L7804">                    entity.addPilotingModifierForTerrain(rollTarget, curPos);</span>
<span class="nc" id="L7805">                    rollTarget.append(new PilotingRollData(entity.getId(),</span>
                            leapDistance, &quot;leaping (fall)&quot;));
<span class="nc bnc" id="L7807" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
<span class="nc" id="L7809">                        entity.setElevation(lastElevation);</span>
<span class="nc" id="L7810">                        addReport(doEntityFallsInto(entity, lastElevation,</span>
                                lastPos, curPos,
<span class="nc" id="L7812">                                entity.getBasePilotingRoll(overallMoveType), false));</span>
                    }
                }
            }
            
            // Check for skid.
<span class="nc" id="L7818">            rollTarget = entity.checkSkid(moveType, prevHex, overallMoveType,</span>
                    prevStep, step, prevFacing, curFacing, lastPos, curPos,
                    isInfantry, distance - 1);
<span class="nc bnc" id="L7821" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Have an entity-meaningful PSR message.
                boolean psrFailed;
<span class="nc" id="L7824">                int startingFacing = entity.getFacing();</span>
<span class="nc bnc" id="L7825" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
                    // We need to ensure that falls will happen from the proper
                    // facing
<span class="nc" id="L7828">                    entity.setFacing(curFacing);</span>
<span class="nc bnc" id="L7829" title="All 2 branches missed.">                    psrFailed = (0 &lt; doSkillCheckWhileMoving(entity,</span>
                            lastElevation, lastPos, lastPos, rollTarget, true));
                } else {
<span class="nc bnc" id="L7832" title="All 2 branches missed.">                    psrFailed = (0 &lt; doSkillCheckWhileMoving(entity,</span>
                            lastElevation, lastPos, lastPos, rollTarget, false));
                }

                // Does the entity skid?
<span class="nc bnc" id="L7837" title="All 2 branches missed.">                if (psrFailed) {</span>

<span class="nc bnc" id="L7839" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc" id="L7840">                        addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
                    }

<span class="nc" id="L7843">                    curPos = lastPos;</span>
<span class="nc" id="L7844">                    int skidDistance = (int) Math.round((double) (distance - 1) / 2);</span>
<span class="nc" id="L7845">                    int skidDirection = prevFacing;</span>

                    // All charge damage is based upon
                    // the pre-skid move distance.
<span class="nc" id="L7849">                    entity.delta_distance = distance - 1;</span>

                    // Attacks against a skidding target have additional +2.
<span class="nc" id="L7852">                    moveType = EntityMovementType.MOVE_SKID;</span>

                    // What is the first hex in the skid?
<span class="nc bnc" id="L7855" title="All 2 branches missed.">                    if (step.isThisStepBackwards()) {</span>
<span class="nc" id="L7856">                        skidDirection = (skidDirection + 3) % 6;</span>
                    }

<span class="nc bnc" id="L7859" title="All 2 branches missed.">                    if (processSkid(entity, curPos, prevStep.getElevation(),</span>
                            skidDirection, skidDistance, prevStep,
                            lastStepMoveType)) {
<span class="nc" id="L7862">                        return;</span>
                    }

                    // set entity parameters
<span class="nc" id="L7866">                    curFacing = entity.getFacing();</span>
<span class="nc" id="L7867">                    curPos = entity.getPosition();</span>
<span class="nc" id="L7868">                    entity.setSecondaryFacing(curFacing);</span>

                    // skid consumes all movement
<span class="nc bnc" id="L7871" title="All 2 branches missed.">                    if (md.hasActiveMASC()) {</span>
<span class="nc" id="L7872">                        mpUsed = entity.getRunMP();</span>
                    } else {
<span class="nc" id="L7874">                        mpUsed = entity.getRunMPwithoutMASC();</span>
                    }

<span class="nc" id="L7877">                    entity.moved = moveType;</span>
<span class="nc" id="L7878">                    fellDuringMovement = true;</span>
<span class="nc" id="L7879">                    turnOver = true;</span>
<span class="nc" id="L7880">                    distance = entity.delta_distance;</span>
<span class="nc" id="L7881">                    break;</span>

                } else { // End failed-skid-psr
                    // If the check succeeded, restore the facing we had before
                    // if it failed, the fall will have changed facing
<span class="nc" id="L7886">                    entity.setFacing(startingFacing);</span>
                }

            } // End need-skid-psr

            // check sideslip
<span class="nc bnc" id="L7892" title="All 2 branches missed.">            if ((entity instanceof VTOL)</span>
<span class="nc bnc" id="L7893" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L7894" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L7895" title="All 2 branches missed.">                            &amp;&amp; step.getClearance() &gt; 0)) {</span>
<span class="nc" id="L7896">                rollTarget = entity.checkSideSlip(moveType, prevHex,</span>
                        overallMoveType, prevStep, prevFacing, curFacing,
                        lastPos, curPos, distance);
<span class="nc bnc" id="L7899" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7900">                    int moF = doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false);
<span class="nc bnc" id="L7902" title="All 2 branches missed.">                    if (moF &gt; 0) {</span>
                        int elev;
                        int sideslipDistance;
                        int skidDirection;
                        Coords start;
<span class="nc bnc" id="L7907" title="All 2 branches missed.">                        if (step.getType() == MoveStepType.LATERAL_LEFT</span>
<span class="nc bnc" id="L7908" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_RIGHT</span>
<span class="nc bnc" id="L7909" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_LEFT_BACKWARDS</span>
<span class="nc bnc" id="L7910" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_RIGHT_BACKWARDS) {</span>
                            // A failed controlled sideslip always results in moving one additional hex
                            // in the direction of the intentional sideslip.
<span class="nc" id="L7913">                            elev = step.getElevation();</span>
<span class="nc" id="L7914">                            sideslipDistance = 1;</span>
<span class="nc" id="L7915">                            skidDirection = lastPos.direction(curPos);</span>
<span class="nc" id="L7916">                            start = curPos;</span>
                        } else {
<span class="nc bnc" id="L7918" title="All 2 branches missed.">                            elev = (null == prevStep)? curElevation : prevStep.getElevation();</span>
                            // maximum distance is hexes moved / 2
<span class="nc" id="L7920">                            sideslipDistance = Math.min(moF, distance / 2);</span>
<span class="nc" id="L7921">                            skidDirection = prevFacing;</span>
<span class="nc" id="L7922">                            start = lastPos;</span>
                        }
<span class="nc bnc" id="L7924" title="All 2 branches missed.">                        if (sideslipDistance &gt; 0) {</span>
<span class="nc" id="L7925">                            sideslipped = true;</span>
<span class="nc" id="L7926">                            r = new Report(2100);</span>
<span class="nc" id="L7927">                            r.subject = entity.getId();</span>
<span class="nc" id="L7928">                            r.addDesc(entity);</span>
<span class="nc" id="L7929">                            r.add(sideslipDistance);</span>
<span class="nc" id="L7930">                            addReport(r);</span>

<span class="nc bnc" id="L7932" title="All 2 branches missed.">                            if (processSkid(entity, start, elev, skidDirection,</span>
<span class="nc bnc" id="L7933" title="All 2 branches missed.">                                    sideslipDistance, (null == prevStep)? step : prevStep,</span>
                                    lastStepMoveType)) {
<span class="nc" id="L7935">                                return;</span>
                            }

<span class="nc bnc" id="L7938" title="All 4 branches missed.">                            if (!entity.isDestroyed() &amp;&amp; !entity.isDoomed()</span>
<span class="nc bnc" id="L7939" title="All 2 branches missed.">                                    &amp;&amp; (mpUsed &lt; entity.getRunMP())) {</span>
<span class="nc" id="L7940">                                fellDuringMovement = true; // No, but it should</span>
                                // work...
                            }

<span class="nc bnc" id="L7944" title="All 2 branches missed.">                            if ((entity.getElevation() == 0)</span>
<span class="nc bnc" id="L7945" title="All 2 branches missed.">                                    &amp;&amp; ((entity.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L7946" title="All 2 branches missed.">                                        || (entity.getMovementMode() == EntityMovementMode.WIGE))) {</span>
<span class="nc" id="L7947">                                turnOver = true;</span>
                            }
                            // set entity parameters
<span class="nc" id="L7950">                            curFacing = step.getFacing();</span>
<span class="nc" id="L7951">                            curPos = entity.getPosition();</span>
<span class="nc" id="L7952">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L7953">                            break;</span>
                        }
                    }
                }
            }

            // check if we've moved into rubble
<span class="nc" id="L7960">            boolean isLastStep = step.equals(md.getLastStep());</span>
<span class="nc" id="L7961">            rollTarget = entity.checkRubbleMove(step, overallMoveType, curHex,</span>
                    lastPos, curPos, isLastStep, isPavementStep);
<span class="nc bnc" id="L7963" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7964">                doSkillCheckWhileMoving(entity, lastElevation, lastPos, curPos,</span>
                        rollTarget, true);
            }

            // check if we are using reckless movement
<span class="nc" id="L7969">            rollTarget = entity.checkRecklessMove(step, overallMoveType, curHex,</span>
                    lastPos, curPos, prevHex);
<span class="nc bnc" id="L7971" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L7972" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L7973">                    doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, true);
<span class="nc bnc" id="L7975" title="All 2 branches missed.">                } else if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L7976" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
                        // assume VTOLs in flight are always in clear terrain
<span class="nc bnc" id="L7979" title="All 2 branches missed.">                        if ((0 == curHex.terrainsPresent())</span>
<span class="nc bnc" id="L7980" title="All 2 branches missed.">                                || (step.getClearance() &gt; 0)) {</span>
<span class="nc bnc" id="L7981" title="All 2 branches missed.">                            if (entity instanceof VTOL) {</span>
<span class="nc" id="L7982">                                r = new Report(2208);</span>
                            } else {
<span class="nc" id="L7984">                                r = new Report(2206);</span>
                            }
<span class="nc" id="L7986">                            r.addDesc(entity);</span>
<span class="nc" id="L7987">                            r.subject = entity.getId();</span>
<span class="nc" id="L7988">                            addReport(r);</span>
<span class="nc" id="L7989">                            mpUsed = step.getMpUsed() + 1;</span>
<span class="nc" id="L7990">                            fellDuringMovement = true;</span>
<span class="nc" id="L7991">                            break;</span>
                        }
<span class="nc" id="L7993">                        r = new Report(2207);</span>
<span class="nc" id="L7994">                        r.addDesc(entity);</span>
<span class="nc" id="L7995">                        r.subject = entity.getId();</span>
<span class="nc" id="L7996">                        addReport(r);</span>
                        // until we get a rules clarification assume that the
                        // entity is both giver and taker
                        // for charge damage
<span class="nc" id="L8000">                        HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8001">                        addReport(damageEntity(entity, hit, ChargeAttackAction</span>
<span class="nc" id="L8002">                                .getDamageTakenBy(entity, entity)));</span>
<span class="nc" id="L8003">                        turnOver = true;</span>
<span class="nc" id="L8004">                        break;</span>
                    }
                }
            }

            // check for breaking magma crust unless we are jumping over the hex
<span class="nc bnc" id="L8010" title="All 2 branches missed.">            if (stepMoveType != EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L8011">                ServerHelper.checkAndApplyMagmaCrust(curHex, step.getElevation(), entity, curPos, false, vPhaseReport, this);</span>
            }

            // check if we've moved into a swamp
<span class="nc" id="L8015">            rollTarget = entity.checkBogDown(step, lastStepMoveType, curHex,</span>
                    lastPos, curPos, lastElevation, isPavementStep);
<span class="nc bnc" id="L8017" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L8018" title="All 2 branches missed.">                if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                        curPos, rollTarget, false)) {
<span class="nc" id="L8020">                    entity.setStuck(true);</span>
<span class="nc" id="L8021">                    entity.setCanUnstickByJumping(true);</span>
<span class="nc" id="L8022">                    r = new Report(2081);</span>
<span class="nc" id="L8023">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L8024">                    r.subject = entity.getId();</span>
<span class="nc" id="L8025">                    addReport(r);</span>
                    // check for quicksand
<span class="nc" id="L8027">                    addReport(checkQuickSand(curPos));</span>
                    // check for accidental stacking violation
<span class="nc" id="L8029">                    Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L8030">                            entity.getId(), curPos);</span>
<span class="nc bnc" id="L8031" title="All 2 branches missed.">                    if (violation != null) {</span>
                        // target gets displaced, because of low elevation
<span class="nc" id="L8033">                        int direction = lastPos.direction(curPos);</span>
<span class="nc" id="L8034">                        Coords targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L8035">                                entity.getId(), curPos, direction);</span>
<span class="nc" id="L8036">                        addReport(doEntityDisplacement(violation, curPos,</span>
                                targetDest,
<span class="nc" id="L8038">                                new PilotingRollData(violation.getId(), 0,</span>
                                        &quot;domino effect&quot;)));
                        // Update the violating entity's position on the client.
<span class="nc" id="L8041">                        entityUpdate(violation.getId());</span>
<span class="nc" id="L8042">                    }</span>
                    break;
                }
            }

            // check to see if we are a mech and we've moved OUT of fire
<span class="nc" id="L8048">            IHex lastHex = game.getBoard().getHex(lastPos);</span>
<span class="nc bnc" id="L8049" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc bnc" id="L8050" title="All 4 branches missed.">                if (!lastPos.equals(curPos) &amp;&amp; (prevStep != null)</span>
<span class="nc bnc" id="L8051" title="All 2 branches missed.">                        &amp;&amp; ((lastHex.containsTerrain(Terrains.FIRE)</span>
<span class="nc bnc" id="L8052" title="All 2 branches missed.">                                &amp;&amp; (prevStep.getElevation() &lt;= 1))</span>
<span class="nc bnc" id="L8053" title="All 2 branches missed.">                                || (lastHex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L8054" title="All 4 branches missed.">                                        &amp;&amp; (prevStep.getElevation() == 0)))</span>
                        &amp;&amp; ((stepMoveType != EntityMovementType.MOVE_JUMP)
                                // Bug #828741 -- jumping bypasses fire, but not
                                // on the
                                // first step
                                // getMpUsed -- total MP used to this step
                                // getMp -- MP used in this step
                                // the difference will always be 0 on the &quot;first
                                // step&quot;
                                // of a jump,
                                // and &gt;0 on a step in the midst of a jump
<span class="nc bnc" id="L8065" title="All 2 branches missed.">                                || (0 == (step.getMpUsed() - step.getMp())))) {</span>
<span class="nc" id="L8066">                    int heat = 0;</span>
<span class="nc bnc" id="L8067" title="All 2 branches missed.">                    if (lastHex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L8068">                        heat += 2;</span>
                    }
<span class="nc bnc" id="L8070" title="All 2 branches missed.">                    if (lastHex.terrainLevel(Terrains.MAGMA) == 1) {</span>
<span class="nc" id="L8071">                        heat += 2;</span>
<span class="nc bnc" id="L8072" title="All 2 branches missed.">                    } else if (lastHex.terrainLevel(Terrains.MAGMA) == 2) {</span>
<span class="nc" id="L8073">                        heat += 5;</span>
                    }
<span class="nc bnc" id="L8075" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L8076">                        heat /= 2;</span>
                    }
<span class="nc" id="L8078">                    entity.heatFromExternal += heat;</span>
<span class="nc" id="L8079">                    r = new Report(2115);</span>
<span class="nc" id="L8080">                    r.subject = entity.getId();</span>
<span class="nc" id="L8081">                    r.addDesc(entity);</span>
<span class="nc" id="L8082">                    r.add(heat);</span>
<span class="nc" id="L8083">                    addReport(r);</span>
<span class="nc bnc" id="L8084" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L8085">                        r = new Report(5550);</span>
<span class="nc" id="L8086">                        addReport(r);</span>
                    }
                }
            }

            // check to see if we are not a mech and we've moved INTO fire
<span class="nc bnc" id="L8092" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L8093">                boolean underwater = game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L8094" title="All 2 branches missed.">                        .containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L8095" title="All 2 branches missed.">                        &amp;&amp; (game.getBoard().getHex(curPos).depth() &gt; 0)</span>
<span class="nc bnc" id="L8096" title="All 2 branches missed.">                        &amp;&amp; (step.getElevation() &lt; game.getBoard().getHex(curPos).surface());</span>
<span class="nc bnc" id="L8097" title="All 2 branches missed.">                if (game.getBoard().getHex(curPos).containsTerrain(</span>
<span class="nc bnc" id="L8098" title="All 4 branches missed.">                        Terrains.FIRE) &amp;&amp; !lastPos.equals(curPos)</span>
                        &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8100" title="All 4 branches missed.">                        &amp;&amp; (step.getElevation() &lt;= 1) &amp;&amp; !underwater) {</span>
<span class="nc" id="L8101">                    doFlamingDamage(entity);</span>
                }
            }
            // check for extreme gravity movement
<span class="nc bnc" id="L8105" title="All 4 branches missed.">            if (!i.hasMoreElements() &amp;&amp; !firstStep) {</span>
<span class="nc" id="L8106">                checkExtremeGravityMovement(entity, step, lastStepMoveType, curPos, cachedGravityLimit);</span>
            }
            // check for minefields. have to check both new hex and new
            // elevation
            // VTOLs may land and submarines may rise or lower into a minefield
<span class="nc bnc" id="L8111" title="All 4 branches missed.">            if (!lastPos.equals(curPos) || (lastElevation != curElevation)) {</span>
<span class="nc" id="L8112">                boolean boom = false;</span>
<span class="nc bnc" id="L8113" title="All 2 branches missed.">                if (isOnGround) {</span>
<span class="nc" id="L8114">                    boom = checkVibrabombs(entity, curPos, false, lastPos, curPos, vPhaseReport);</span>
                }
<span class="nc bnc" id="L8116" title="All 2 branches missed.">                if (game.containsMinefield(curPos)) {</span>
                    // set the new position temporarily, because
                    // infantry otherwise would get double damage
                    // when moving from clear into mined woods
<span class="nc" id="L8120">                    entity.setPosition(curPos);</span>
<span class="nc bnc" id="L8121" title="All 2 branches missed.">                    if (enterMinefield(entity, curPos, step.getElevation(),</span>
                            isOnGround, vPhaseReport)) {
                        // resolve any piloting rolls from damage unless unit
                        // was jumping
<span class="nc bnc" id="L8125" title="All 2 branches missed.">                        if (stepMoveType != EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L8126">                            addReport(resolvePilotingRolls(entity));</span>
<span class="nc" id="L8127">                            game.resetPSRs(entity);</span>
                        }
<span class="nc" id="L8129">                        boom = true;</span>
                    }
<span class="nc bnc" id="L8131" title="All 4 branches missed.">                    if (wasProne || !entity.isProne()) {</span>
<span class="nc" id="L8132">                        entity.setPosition(lastPos);</span>
                    }
                }
                // did anything go boom?
<span class="nc bnc" id="L8136" title="All 2 branches missed.">                if (boom) {</span>
                    // set fell during movement so that entity will get another
                    // chance to move with any motive damage
                    // taken account of (functions the same as MASC failure)
                    // only do this if they had more steps (and they were not
                    // jumping
<span class="nc bnc" id="L8142" title="All 4 branches missed.">                    if (i.hasMoreElements() &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)) {</span>
<span class="nc" id="L8143">                        md.clear();</span>
<span class="nc" id="L8144">                        fellDuringMovement = true;</span>
                    }
                    // reset mines if anything detonated
<span class="nc" id="L8147">                    resetMines();</span>
                }
            }

            // infantry discovers minefields if they end their move
            // in a minefield.
<span class="nc bnc" id="L8153" title="All 6 branches missed.">            if (!lastPos.equals(curPos) &amp;&amp; !i.hasMoreElements() &amp;&amp; isInfantry) {</span>
<span class="nc bnc" id="L8154" title="All 2 branches missed.">                if (game.containsMinefield(curPos)) {</span>
<span class="nc" id="L8155">                    IPlayer owner = entity.getOwner();</span>
<span class="nc bnc" id="L8156" title="All 2 branches missed.">                    for (Minefield mf : game.getMinefields(curPos)) {</span>
<span class="nc bnc" id="L8157" title="All 2 branches missed.">                        if (!owner.containsMinefield(mf)) {</span>
<span class="nc" id="L8158">                            r = new Report(2120);</span>
<span class="nc" id="L8159">                            r.subject = entity.getId();</span>
<span class="nc" id="L8160">                            r.add(entity.getShortName(), true);</span>
<span class="nc" id="L8161">                            addReport(r);</span>
<span class="nc" id="L8162">                            revealMinefield(game.getTeamForPlayer(owner), mf);</span>
                        }
<span class="nc" id="L8164">                    }</span>
                }
            }

            // check if we've moved into water
<span class="nc" id="L8169">            rollTarget = entity.checkWaterMove(step, lastStepMoveType, curHex,</span>
                    lastPos, curPos, isPavementStep);
<span class="nc bnc" id="L8171" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Swarmers need special handling.
<span class="nc" id="L8173">                final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc" id="L8174">                boolean swarmerDone = true;</span>
<span class="nc" id="L8175">                Entity swarmer = null;</span>
<span class="nc bnc" id="L8176" title="All 2 branches missed.">                if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L8177">                    swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L8178">                    swarmerDone = swarmer.isDone();</span>
                }

                // Now do the skill check.
<span class="nc" id="L8182">                entity.setFacing(curFacing);</span>
<span class="nc" id="L8183">                doSkillCheckWhileMoving(entity, lastElevation, lastPos, curPos, rollTarget, true);</span>

                // Swarming infantry platoons may drown.
<span class="nc bnc" id="L8186" title="All 2 branches missed.">                if (curHex.terrainLevel(Terrains.WATER) &gt; 1) {</span>
<span class="nc" id="L8187">                    drownSwarmer(entity, curPos);</span>
                }

                // Do we need to remove a game turn for the swarmer
<span class="nc bnc" id="L8191" title="All 4 branches missed.">                if (!swarmerDone &amp;&amp; (swarmer != null)</span>
<span class="nc bnc" id="L8192" title="All 4 branches missed.">                        &amp;&amp; (swarmer.isDoomed() || swarmer.isDestroyed())) {</span>
                    // We have to diddle with the swarmer's
                    // status to get its turn removed.
<span class="nc" id="L8195">                    swarmer.setDone(false);</span>
<span class="nc" id="L8196">                    swarmer.setUnloaded(false);</span>

                    // Dead entities don't take turns.
<span class="nc" id="L8199">                    game.removeTurnFor(swarmer);</span>
<span class="nc" id="L8200">                    send(createTurnVectorPacket());</span>

                    // Return the original status.
<span class="nc" id="L8203">                    swarmer.setDone(true);</span>
<span class="nc" id="L8204">                    swarmer.setUnloaded(true);</span>
                }

                // check for inferno wash-off
<span class="nc" id="L8208">                checkForWashedInfernos(entity, curPos);</span>
            }

            // In water, may or may not be a new hex, necessary to
            // check during movement, for breach damage, and always
            // set dry if appropriate
            // TODO : possibly make the locations local and set later
<span class="nc bnc" id="L8215" title="All 2 branches missed.">            addReport(doSetLocationsExposure(entity, curHex,</span>
                    stepMoveType == EntityMovementType.MOVE_JUMP,
<span class="nc" id="L8217">                    step.getElevation()));</span>

            // check for breaking ice by breaking through from below
<span class="nc bnc" id="L8220" title="All 4 branches missed.">            if ((lastElevation &lt; 0) &amp;&amp; (step.getElevation() == 0)</span>
<span class="nc bnc" id="L8221" title="All 2 branches missed.">                    &amp;&amp; lastHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L8222" title="All 4 branches missed.">                    &amp;&amp; lastHex.containsTerrain(Terrains.WATER)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8224" title="All 2 branches missed.">                    &amp;&amp; !lastPos.equals(curPos)) {</span>
                // need to temporarily reset entity's position so it doesn't
                // fall in the ice
<span class="nc" id="L8227">                entity.setPosition(curPos);</span>
<span class="nc" id="L8228">                r = new Report(2410);</span>
<span class="nc" id="L8229">                r.addDesc(entity);</span>
<span class="nc" id="L8230">                addReport(r);</span>
<span class="nc" id="L8231">                addReport(resolveIceBroken(lastPos));</span>
                // ok now set back
<span class="nc" id="L8233">                entity.setPosition(lastPos);</span>
            }
            // check for breaking ice by stepping on it
<span class="nc bnc" id="L8236" title="All 2 branches missed.">            if (curHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L8237" title="All 4 branches missed.">                    &amp;&amp; curHex.containsTerrain(Terrains.WATER)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8239" title="All 6 branches missed.">                    &amp;&amp; !lastPos.equals(curPos) &amp;&amp; !(entity instanceof Infantry)</span>
<span class="nc bnc" id="L8240" title="All 2 branches missed.">                    &amp;&amp; !(isPavementStep &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE))) {</span>
<span class="nc bnc" id="L8241" title="All 2 branches missed.">                if (step.getElevation() == 0) {</span>
<span class="nc" id="L8242">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L8243">                    r = new Report(2118);</span>
<span class="nc" id="L8244">                    r.addDesc(entity);</span>
<span class="nc" id="L8245">                    r.add(roll);</span>
<span class="nc" id="L8246">                    r.subject = entity.getId();</span>
<span class="nc" id="L8247">                    addReport(r);</span>
<span class="nc bnc" id="L8248" title="All 2 branches missed.">                    if (roll == 6) {</span>
<span class="nc" id="L8249">                        entity.setPosition(curPos);</span>
<span class="nc" id="L8250">                        addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L8251">                        curPos = entity.getPosition();</span>
                    }
<span class="nc" id="L8253">                }</span>
                // or intersecting it
<span class="nc bnc" id="L8255" title="All 2 branches missed.">                else if ((step.getElevation() + entity.height()) == 0) {</span>
<span class="nc" id="L8256">                    r = new Report(2410);</span>
<span class="nc" id="L8257">                    r.addDesc(entity);</span>
<span class="nc" id="L8258">                    addReport(r);</span>
<span class="nc" id="L8259">                    addReport(resolveIceBroken(curPos));</span>
                }
            }

            // Handle loading units.
<span class="nc bnc" id="L8264" title="All 2 branches missed.">            if (step.getType() == MoveStepType.LOAD) {</span>

                // Find the unit being loaded.
<span class="nc" id="L8267">                Entity loaded = null;</span>
<span class="nc" id="L8268">                Iterator&lt;Entity&gt; entities = game.getEntities(curPos);</span>
<span class="nc bnc" id="L8269" title="All 2 branches missed.">                while (entities.hasNext()) {</span>

                    // Is the other unit friendly and not the current entity?
<span class="nc" id="L8272">                    loaded = entities.next();</span>

                    // This should never ever happen, but just in case...
<span class="nc bnc" id="L8275" title="All 2 branches missed.">                    if (loaded.equals(null)) {</span>
<span class="nc" id="L8276">                        continue;</span>
                    }

<span class="nc bnc" id="L8279" title="All 4 branches missed.">                    if (!entity.isEnemyOf(loaded) &amp;&amp; !entity.equals(loaded)) {</span>
                        // The moving unit should be able to load the other
                        // unit and the other should be able to have a turn.
<span class="nc bnc" id="L8282" title="All 4 branches missed.">                        if (!entity.canLoad(loaded) || !loaded.isLoadableThisTurn()) {</span>
                            // Something is fishy in Denmark.
<span class="nc" id="L8284">                            MegaMek.getLogger().error(entity.getShortName() + &quot; can not load &quot; + loaded.getShortName());</span>
<span class="nc" id="L8285">                            loaded = null;</span>
                        } else {
                            // Have the deployed unit load the indicated unit.
<span class="nc" id="L8288">                            loadUnit(entity, loaded, loaded.getTargetBay());</span>

                            // Stop looking.
<span class="nc" id="L8291">                            break;</span>
                        }

                    } else {
                        // Nope. Discard it.
<span class="nc" id="L8296">                        loaded = null;</span>
                    }

                } // Handle the next entity in this hex.

                // We were supposed to find someone to load.
<span class="nc bnc" id="L8302" title="All 2 branches missed.">                if (loaded == null) {</span>
<span class="nc" id="L8303">                    MegaMek.getLogger().error(&quot;Could not find unit for &quot; + entity.getShortName() + &quot; to load in &quot; + curPos);</span>
                }

            } // End STEP_LOAD

         // Handle towing units.
<span class="nc bnc" id="L8309" title="All 2 branches missed.">            if (step.getType() == MoveStepType.TOW) {</span>

                // Find the unit being loaded.
                Entity loaded;
<span class="nc" id="L8313">                loaded = game.getEntity(entity.getTowing());</span>

                // This should never ever happen, but just in case...
<span class="nc bnc" id="L8316" title="All 2 branches missed.">                if (loaded == null) {</span>
<span class="nc" id="L8317">                    MegaMek.getLogger().error(&quot;Could not find unit for &quot; + entity.getShortName() + &quot; to tow.&quot;);</span>
<span class="nc" id="L8318">                    continue;</span>
                }

                // The moving unit should be able to tow the other
                // unit and the other should be able to have a turn.
                //FIXME: I know this check duplicates functions already performed when enabling the Tow button.
                //This code made more sense as borrowed from &quot;Load&quot; where we actually rechecked the hex for the target unit.
                //Do we need it here for safety, client/server sync or can this be further streamlined?
<span class="nc bnc" id="L8326" title="All 2 branches missed.">                if (!entity.canTow(loaded.getId())) {</span>
                    // Something is fishy in Denmark.
<span class="nc" id="L8328">                    MegaMek.getLogger().error(entity.getShortName() + &quot; can not tow &quot; + loaded.getShortName());</span>
                } else {
                    // Have the deployed unit load the indicated unit.
<span class="nc" id="L8331">                    towUnit(entity, loaded);</span>
                }
            } // End STEP_TOW

            // Handle mounting units to small craft/DropShip
<span class="nc bnc" id="L8336" title="All 2 branches missed.">            if (step.getType() == MoveStepType.MOUNT) {</span>
<span class="nc" id="L8337">                Targetable mountee = step.getTarget(game);</span>
<span class="nc bnc" id="L8338" title="All 2 branches missed.">                if (mountee instanceof Entity) {</span>
<span class="nc" id="L8339">                    Entity dropShip = (Entity) mountee;</span>
<span class="nc bnc" id="L8340" title="All 2 branches missed.">                    if (!dropShip.canLoad(entity)) {</span>
                        // Something is fishy in Denmark.
<span class="nc" id="L8342">                        MegaMek.getLogger().error(dropShip.getShortName() + &quot; can not load &quot; + entity.getShortName());</span>
                    } else {
                        // Have the indicated unit load this unit.
<span class="nc" id="L8345">                        entity.setDone(true);</span>
<span class="nc" id="L8346">                        loadUnit(dropShip, entity, entity.getTargetBay());</span>
<span class="nc" id="L8347">                        Bay currentBay = dropShip.getBay(entity);</span>
<span class="nc bnc" id="L8348" title="All 4 branches missed.">                        if ((null != currentBay) &amp;&amp; (Compute.d6(2) == 2)) {</span>
<span class="nc" id="L8349">                            r = new Report(9390);</span>
<span class="nc" id="L8350">                            r.subject = entity.getId();</span>
<span class="nc" id="L8351">                            r.indent(1);</span>
<span class="nc" id="L8352">                            r.add(currentBay.getType());</span>
<span class="nc" id="L8353">                            addReport(r);</span>
<span class="nc" id="L8354">                            currentBay.destroyDoorNext();</span>
                        }
                        // Stop looking.
<span class="nc" id="L8357">                        entityUpdate(dropShip.getId());</span>
<span class="nc" id="L8358">                        return;</span>
                    }
                }
            } // End STEP_MOUNT

            // handle fighter recovery, and also DropShip docking with another large craft
<span class="nc bnc" id="L8364" title="All 2 branches missed.">            if (step.getType() == MoveStepType.RECOVER) {</span>

<span class="nc" id="L8366">                loader = game.getEntity(step.getRecoveryUnit());</span>
<span class="nc" id="L8367">                boolean isDS = (entity instanceof Dropship);</span>

<span class="nc" id="L8369">                rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc bnc" id="L8370" title="All 2 branches missed.">                if (loader.mpUsed &gt; 0) {</span>
<span class="nc" id="L8371">                    rollTarget.addModifier(5, &quot;carrier used thrust&quot;);</span>
                }
<span class="nc bnc" id="L8373" title="All 2 branches missed.">                if (entity.getPartialRepairs().booleanOption(&quot;aero_collar_crit&quot;)) {</span>
<span class="nc" id="L8374">                    rollTarget.addModifier(2, &quot;misrepaired docking collar&quot;);</span>
                }
<span class="nc bnc" id="L8376" title="All 4 branches missed.">                if (isDS &amp;&amp; (((Dropship)entity).getCollarType() == Dropship.COLLAR_PROTOTYPE)) {</span>
<span class="nc" id="L8377">                    rollTarget.addModifier(2, &quot;prototype kf-boom&quot;);</span>
                }
<span class="nc" id="L8379">                int ctrlroll = Compute.d6(2);</span>
<span class="nc bnc" id="L8380" title="All 2 branches missed.">                if (isDS) {</span>
<span class="nc" id="L8381">                    r = new Report(9388);</span>
                } else {
<span class="nc" id="L8383">                    r = new Report(9381);</span>
                }
<span class="nc" id="L8385">                r.subject = entity.getId();</span>
<span class="nc" id="L8386">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L8387">                r.add(loader.getDisplayName());</span>
<span class="nc" id="L8388">                r.add(rollTarget);</span>
<span class="nc" id="L8389">                r.add(ctrlroll);</span>
<span class="nc" id="L8390">                r.newlines = 0;</span>
<span class="nc" id="L8391">                r.indent(1);</span>
<span class="nc bnc" id="L8392" title="All 2 branches missed.">                if (ctrlroll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L8393">                    r.choose(false);</span>
<span class="nc" id="L8394">                    addReport(r);</span>
                    // damage unit
<span class="nc" id="L8396">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8397">                    addReport(damageEntity(entity, hit, 2 * (rollTarget.getValue() - ctrlroll)));</span>
<span class="nc" id="L8398">                } else {</span>
<span class="nc" id="L8399">                    r.choose(true);</span>
<span class="nc" id="L8400">                    addReport(r);</span>
<span class="nc" id="L8401">                    recovered = true;</span>
                }
                // check for door damage
<span class="nc bnc" id="L8404" title="All 2 branches missed.">                if (ctrlroll == 2) {</span>
<span class="nc" id="L8405">                    loader.damageDoorRecovery(entity);</span>
<span class="nc" id="L8406">                    r = new Report(9384);</span>
<span class="nc" id="L8407">                    r.subject = entity.getId();</span>
<span class="nc" id="L8408">                    r.indent(0);</span>
<span class="nc" id="L8409">                    r.add(loader.getDisplayName());</span>
<span class="nc" id="L8410">                    addReport(r);</span>
                }
            }

            // handle fighter squadron joining
<span class="nc bnc" id="L8415" title="All 2 branches missed.">            if (step.getType() == MoveStepType.JOIN) {</span>
<span class="nc" id="L8416">                loader = game.getEntity(step.getRecoveryUnit());</span>
<span class="nc" id="L8417">                recovered = true;</span>
            }

            // Handle unloading units.
<span class="nc bnc" id="L8421" title="All 2 branches missed.">            if (step.getType() == MoveStepType.UNLOAD) {</span>
<span class="nc" id="L8422">                Targetable unloaded = step.getTarget(game);</span>
<span class="nc" id="L8423">                Coords unloadPos = curPos;</span>
<span class="nc" id="L8424">                int unloadFacing = curFacing;</span>
<span class="nc bnc" id="L8425" title="All 2 branches missed.">                if (null != step.getTargetPosition()) {</span>
<span class="nc" id="L8426">                    unloadPos = step.getTargetPosition();</span>
<span class="nc" id="L8427">                    unloadFacing = curPos.direction(unloadPos);</span>
                }
<span class="nc bnc" id="L8429" title="All 2 branches missed.">                if (!unloadUnit(entity, unloaded, unloadPos, unloadFacing,</span>
<span class="nc" id="L8430">                        step.getElevation())) {</span>
<span class="nc" id="L8431">                    MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L8432">                                    + unloaded.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L8433">                                    + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L8434">                                    + curPos.getBoardNum());</span>
                }
                // some additional stuff to take care of for small
                // craft/DropShip unloading
<span class="nc bnc" id="L8438" title="All 4 branches missed.">                if ((entity instanceof SmallCraft) &amp;&amp; (unloaded instanceof Entity)) {</span>
<span class="nc" id="L8439">                    Bay currentBay = entity.getBay((Entity) unloaded);</span>
<span class="nc bnc" id="L8440" title="All 4 branches missed.">                    if ((null != currentBay) &amp;&amp; (Compute.d6(2) == 2)) {</span>
<span class="nc" id="L8441">                        r = new Report(9390);</span>
<span class="nc" id="L8442">                        r.subject = entity.getId();</span>
<span class="nc" id="L8443">                        r.indent(1);</span>
<span class="nc" id="L8444">                        r.add(currentBay.getType());</span>
<span class="nc" id="L8445">                        addReport(r);</span>
<span class="nc" id="L8446">                        currentBay.destroyDoorNext();</span>
                    }
                    // now apply any damage to bay doors
<span class="nc" id="L8449">                    entity.resetBayDoors();</span>
<span class="nc" id="L8450">                    entityUpdate(entity.getId());</span>
                    // ok now add another turn for the transport so it can
                    // continue to unload units
<span class="nc bnc" id="L8453" title="All 2 branches missed.">                    if (entity.getUnitsUnloadableFromBays().size() &gt; 0) {</span>
<span class="nc" id="L8454">                        dropshipStillUnloading = true;</span>
<span class="nc" id="L8455">                        GameTurn newTurn = new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L8456">                                entity.getOwner().getId(), entity.getId());</span>
                        // Need to set the new turn's multiTurn state
<span class="nc" id="L8458">                        newTurn.setMultiTurn(true);</span>
<span class="nc" id="L8459">                        game.insertNextTurn(newTurn);</span>
                    }
                    // ok add another turn for the unloaded entity so that it
                    // can move
<span class="nc bnc" id="L8463" title="All 2 branches missed.">                    if (!(unloaded instanceof Infantry)) {</span>
<span class="nc" id="L8464">                        GameTurn newTurn = new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L8465">                                ((Entity) unloaded).getOwner().getId(),</span>
<span class="nc" id="L8466">                                ((Entity) unloaded).getId());</span>
                        // Need to set the new turn's multiTurn state
<span class="nc" id="L8468">                        newTurn.setMultiTurn(true);</span>
<span class="nc" id="L8469">                        game.insertNextTurn(newTurn);</span>
                    }
                    // brief everybody on the turn update
<span class="nc" id="L8472">                    send(createTurnVectorPacket());</span>
                }
            }

            // Handle disconnecting trailers.
<span class="nc bnc" id="L8477" title="All 2 branches missed.">            if (step.getType() == MoveStepType.DISCONNECT) {</span>
<span class="nc" id="L8478">                Targetable unloaded = step.getTarget(game);</span>
<span class="nc" id="L8479">                Coords unloadPos = curPos;</span>
<span class="nc bnc" id="L8480" title="All 2 branches missed.">                if (null != step.getTargetPosition()) {</span>
<span class="nc" id="L8481">                    unloadPos = step.getTargetPosition();</span>
                }
<span class="nc bnc" id="L8483" title="All 2 branches missed.">                if (!disconnectUnit(entity, unloaded, unloadPos)) {</span>
<span class="nc" id="L8484">                    MegaMek.getLogger().error(&quot;Server was told to disconnect &quot;</span>
<span class="nc" id="L8485">                                    + unloaded.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L8486">                                    + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L8487">                                    + curPos.getBoardNum());</span>
                }
            }

            // moving backwards over elevation change
<span class="nc bnc" id="L8492" title="All 2 branches missed.">            if (((step.getType() == MoveStepType.BACKWARDS)</span>
<span class="nc bnc" id="L8493" title="All 2 branches missed.">                    || (step.getType() == MoveStepType.LATERAL_LEFT_BACKWARDS)</span>
<span class="nc bnc" id="L8494" title="All 2 branches missed.">                    || (step.getType() == MoveStepType.LATERAL_RIGHT_BACKWARDS))</span>
<span class="nc bnc" id="L8495" title="All 2 branches missed.">                    &amp;&amp; !(md.isJumping()</span>
<span class="nc bnc" id="L8496" title="All 2 branches missed.">                            &amp;&amp; (entity.getJumpType() == Mech.JUMP_BOOSTER))</span>
<span class="nc bnc" id="L8497" title="All 6 branches missed.">                    &amp;&amp; (lastHex.getLevel() + lastElevation != curHex.getLevel() + step.getElevation())</span>
                    &amp;&amp; !(entity instanceof VTOL)
                    &amp;&amp; !(curClimbMode
<span class="nc bnc" id="L8500" title="All 2 branches missed.">                            &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc" id="L8501">                            &amp;&amp; ((curHex.terrainLevel(Terrains.BRIDGE_ELEV)</span>
<span class="nc" id="L8502">                                    + curHex.getLevel()) == (prevHex.getLevel()</span>
<span class="nc bnc" id="L8503" title="All 2 branches missed.">                                            + (prevHex.containsTerrain(</span>
                                                    Terrains.BRIDGE)
                                                            ? prevHex
<span class="nc" id="L8506">                                                                    .terrainLevel(</span>
                                                                            Terrains.BRIDGE_ELEV)
<span class="nc bnc" id="L8508" title="All 2 branches missed.">                                                            : 0))))) {</span>

                // per TacOps, if the mech is walking backwards over an elevation change and falls
                // it falls into the lower hex. The caveat is if it already fell from some other PSR in this 
                // invocation of processMovement, then it can't fall again. 
<span class="nc bnc" id="L8513" title="All 2 branches missed.">                if ((entity instanceof Mech) &amp;&amp; (curHex.getLevel() &lt; game</span>
<span class="nc bnc" id="L8514" title="All 4 branches missed.">                        .getBoard().getHex(lastPos).getLevel()) &amp;&amp; !entity.hasFallen()) {</span>
<span class="nc" id="L8515">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8516">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc" id="L8518">                    doSkillCheckWhileMoving(entity, entity.getElevation(),</span>
                            curPos, curPos, rollTarget, true);
<span class="nc bnc" id="L8520" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; !entity.hasFallen()) {</span>
<span class="nc" id="L8521">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8522">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc" id="L8524">                    doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            lastPos, rollTarget, true);
<span class="nc bnc" id="L8526" title="All 2 branches missed.">                } else if (entity instanceof Tank) {</span>
<span class="nc" id="L8527">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8528">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc bnc" id="L8530" title="All 2 branches missed.">                    if (doSkillCheckWhileMoving(entity, entity.getElevation(),</span>
                            curPos, lastPos, rollTarget, false) &lt; 0) {
<span class="nc" id="L8532">                        curPos = lastPos;</span>
                    }
                }

            }

            // Handle non-infantry moving into a building.
<span class="nc bnc" id="L8539" title="All 2 branches missed.">            if (buildingMove &gt; 0) {</span>

                // Get the building being exited.
<span class="nc" id="L8542">                Building bldgExited = null;</span>
<span class="nc bnc" id="L8543" title="All 2 branches missed.">                if ((buildingMove &amp; 1) == 1) {</span>
<span class="nc" id="L8544">                    bldgExited = game.getBoard().getBuildingAt(lastPos);</span>
                }

                // Get the building being entered.
<span class="nc" id="L8548">                Building bldgEntered = null;</span>
<span class="nc bnc" id="L8549" title="All 2 branches missed.">                if ((buildingMove &amp; 2) == 2) {</span>
<span class="nc" id="L8550">                    bldgEntered = game.getBoard().getBuildingAt(curPos);</span>
                }

                // ProtoMechs changing levels within a building cause damage
<span class="nc bnc" id="L8554" title="All 4 branches missed.">                if (((buildingMove &amp; 8) == 8) &amp;&amp; (entity instanceof Protomech)) {</span>
<span class="nc" id="L8555">                    Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc" id="L8556">                    Vector&lt;Report&gt; vBuildingReport = damageBuilding(bldg, 1, curPos);</span>
<span class="nc bnc" id="L8557" title="All 2 branches missed.">                    for (Report report : vBuildingReport) {</span>
<span class="nc" id="L8558">                        report.subject = entity.getId();</span>
<span class="nc" id="L8559">                    }</span>
<span class="nc" id="L8560">                    addReport(vBuildingReport);</span>
                }

<span class="nc" id="L8563">                boolean collapsed = false;</span>
<span class="nc bnc" id="L8564" title="All 2 branches missed.">                if ((bldgEntered != null)) {</span>
                    // If we're not leaving a building, just handle the
                    // &quot;entered&quot;.
                    String reason;
<span class="nc bnc" id="L8568" title="All 2 branches missed.">                    if (bldgExited == null) {</span>
<span class="nc" id="L8569">                        reason = &quot;entering&quot;;</span>
                    }
                    // If we're moving within the same building, just handle
                    // the &quot;within&quot;.
<span class="nc bnc" id="L8573" title="All 6 branches missed.">                    else if (bldgExited.equals(bldgEntered)</span>
                            &amp;&amp; !(entity instanceof Protomech)
                            &amp;&amp; !(entity instanceof Infantry)) {
<span class="nc" id="L8576">                        reason = &quot;moving in&quot;;</span>
                    }
                    // If we have different buildings, roll for each.
                    else {
<span class="nc" id="L8580">                        reason = &quot;entering&quot;;</span>
                    }
<span class="nc" id="L8582">                    passBuildingWall(entity, bldgEntered, lastPos, curPos,</span>
<span class="nc" id="L8583">                            distance, reason, step.isThisStepBackwards(),</span>
                            lastStepMoveType, true);
<span class="nc" id="L8585">                    addAffectedBldg(bldgEntered, collapsed);</span>
                }

                // Clean up the entity if it has been destroyed.
<span class="nc bnc" id="L8589" title="All 2 branches missed.">                if (entity.isDoomed()) {</span>
<span class="nc" id="L8590">                    entity.setDestroyed(true);</span>
<span class="nc" id="L8591">                    game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L8592">                    send(createRemoveEntityPacket(entity.getId()));</span>

                    // The entity's movement is completed.
<span class="nc" id="L8595">                    return;</span>
                }

                // TODO : what if a building collapses into rubble?
            }

<span class="nc bnc" id="L8601" title="All 2 branches missed.">            if (stepMoveType != EntityMovementType.MOVE_JUMP</span>
<span class="nc bnc" id="L8602" title="All 2 branches missed.">                    &amp;&amp; (step.getClearance() == 0</span>
<span class="nc bnc" id="L8603" title="All 4 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; step.getClearance() == 1)</span>
<span class="nc bnc" id="L8604" title="All 2 branches missed.">                        || curElevation == curHex.terrainLevel(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L8605" title="All 2 branches missed.">                        || curElevation == curHex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L8606">                Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L8607" title="All 4 branches missed.">                if ((bldg != null) &amp;&amp; (entity.getElevation() &gt;= 0)) {</span>
<span class="nc bnc" id="L8608" title="All 2 branches missed.">                    boolean wigeFlyingOver = entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L8609" title="All 2 branches missed.">                            &amp;&amp; ((curHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L8610" title="All 2 branches missed.">                                    &amp;&amp; curElevation &gt; curHex.terrainLevel(Terrains.BLDG_ELEV)) ||</span>
<span class="nc bnc" id="L8611" title="All 2 branches missed.">                            (curHex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc bnc" id="L8612" title="All 2 branches missed.">                                    &amp;&amp; curElevation &gt; curHex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
<span class="nc" id="L8613">                    boolean collapse = checkBuildingCollapseWhileMoving(bldg, entity, curPos);</span>
<span class="nc" id="L8614">                    addAffectedBldg(bldg, collapse);</span>
                    // If the building is collapsed by a WiGE flying over it, the WiGE drops one level of elevation.
                    // This could invalidate the remainder of the movement path, so we will send it back to the client.
<span class="nc bnc" id="L8617" title="All 4 branches missed.">                    if (collapse &amp;&amp; wigeFlyingOver) {</span>
<span class="nc" id="L8618">                        curElevation--;</span>
<span class="nc" id="L8619">                        r = new Report(2378);</span>
<span class="nc" id="L8620">                        r.subject = entity.getId();</span>
<span class="nc" id="L8621">                        r.addDesc(entity);</span>
<span class="nc" id="L8622">                        addReport(r);</span>
<span class="nc" id="L8623">                        continueTurnFromLevelDrop = true;</span>
<span class="nc" id="L8624">                        entity.setPosition(curPos);</span>
<span class="nc" id="L8625">                        entity.setFacing(curFacing);</span>
<span class="nc" id="L8626">                        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L8627">                        entity.setElevation(curElevation);</span>
<span class="nc" id="L8628">                        break;</span>
                    }
                }
            }
            
            // Sheer Cliffs, TO p.39
<span class="nc bnc" id="L8634" title="All 2 branches missed.">            boolean vehicleAffectedByCliff = entity instanceof Tank </span>
<span class="nc bnc" id="L8635" title="All 2 branches missed.">                    &amp;&amp; !entity.isAirborneVTOLorWIGE();</span>
<span class="nc bnc" id="L8636" title="All 2 branches missed.">            boolean quadveeVehMode = entity instanceof QuadVee</span>
<span class="nc bnc" id="L8637" title="All 2 branches missed.">                    &amp;&amp; ((QuadVee)entity).getConversionMode() == QuadVee.CONV_MODE_VEHICLE;</span>
<span class="nc bnc" id="L8638" title="All 6 branches missed.">            boolean mechAffectedByCliff = (entity instanceof Mech || entity instanceof Protomech)</span>
                    &amp;&amp; moveType != EntityMovementType.MOVE_JUMP
<span class="nc bnc" id="L8640" title="All 2 branches missed.">                    &amp;&amp; !entity.isAero();</span>
            // Cliffs should only exist towards 1 or 2 level drops, check just to make sure
            // Everything that does not have a 1 or 2 level drop shouldn't be handled as a cliff
<span class="nc" id="L8643">            int stepHeight = curElevation + curHex.getLevel() </span>
<span class="nc" id="L8644">                    - (lastElevation + prevHex.getLevel());</span>
<span class="nc bnc" id="L8645" title="All 2 branches missed.">            boolean isUpCliff = !lastPos.equals(curPos) </span>
<span class="nc bnc" id="L8646" title="All 6 branches missed.">                    &amp;&amp; curHex.hasCliffTopTowards(prevHex)</span>
                    &amp;&amp; (stepHeight == 1 || stepHeight == 2);
<span class="nc bnc" id="L8648" title="All 2 branches missed.">            boolean isDownCliff = !lastPos.equals(curPos) </span>
<span class="nc bnc" id="L8649" title="All 6 branches missed.">                    &amp;&amp; prevHex.hasCliffTopTowards(curHex)</span>
                    &amp;&amp; (stepHeight == -1 || stepHeight == -2);

            // Vehicles (exc. WIGE/VTOL) moving down a cliff
<span class="nc bnc" id="L8653" title="All 6 branches missed.">            if (vehicleAffectedByCliff &amp;&amp; isDownCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8654">                rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L8655">                rollTarget.append(new PilotingRollData(entity.getId(), 0, &quot;moving down a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8656" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, curPos, rollTarget, false) &gt; 0) {
<span class="nc" id="L8658">                    addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
<span class="nc" id="L8659">                    addNewLines();</span>
<span class="nc" id="L8660">                    turnOver = true;</span>
<span class="nc" id="L8661">                    break;</span>
                }
            }

            // Mechs and Protomechs moving down a cliff
            // Quadvees in vee mode ignore PSRs to avoid falls, IO p.133
<span class="nc bnc" id="L8667" title="All 8 branches missed.">            if (mechAffectedByCliff &amp;&amp; !quadveeVehMode &amp;&amp; isDownCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8668">                rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L8669">                rollTarget.append(new PilotingRollData(entity.getId(), -stepHeight - 1, &quot;moving down a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8670" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, curPos, rollTarget, true) &gt; 0) {
<span class="nc" id="L8672">                    addNewLines();</span>
<span class="nc" id="L8673">                    turnOver = true;</span>
<span class="nc" id="L8674">                    break;</span>
                }
            }

            // Mechs moving up a cliff
<span class="nc bnc" id="L8679" title="All 8 branches missed.">            if (mechAffectedByCliff &amp;&amp; !quadveeVehMode &amp;&amp; isUpCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8680">                rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L8681">                rollTarget.append(new PilotingRollData(entity.getId(), stepHeight, &quot;moving up a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8682" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, lastPos, rollTarget, false) &gt; 0) {
<span class="nc" id="L8684">                    r = new Report(2209);</span>
<span class="nc" id="L8685">                    r.addDesc(entity);</span>
<span class="nc" id="L8686">                    r.subject = entity.getId();</span>
<span class="nc" id="L8687">                    addReport(r);</span>
<span class="nc" id="L8688">                    addNewLines();</span>
<span class="nc" id="L8689">                    curPos = entity.getPosition();</span>
<span class="nc" id="L8690">                    mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8691">                    continueTurnFromCliffAscent = true;</span>
<span class="nc" id="L8692">                    break;</span>
                }
            }

            // did the entity just fall?
<span class="nc bnc" id="L8697" title="All 4 branches missed.">            if (!wasProne &amp;&amp; entity.isProne()) {</span>
<span class="nc" id="L8698">                curFacing = entity.getFacing();</span>
<span class="nc" id="L8699">                curPos = entity.getPosition();</span>
<span class="nc" id="L8700">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8701">                fellDuringMovement = true;</span>
<span class="nc" id="L8702">                break;</span>
            }

            // dropping prone intentionally?
<span class="nc bnc" id="L8706" title="All 2 branches missed.">            if (step.getType() == MoveStepType.GO_PRONE) {</span>
<span class="nc" id="L8707">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8708">                rollTarget = entity.checkDislodgeSwarmers(step, overallMoveType);</span>
<span class="nc bnc" id="L8709" title="All 2 branches missed.">                if (rollTarget.getValue() == TargetRoll.CHECK_FALSE) {</span>
                    // Not being swarmed
<span class="nc" id="L8711">                    entity.setProne(true);</span>
                    // check to see if we washed off infernos
<span class="nc" id="L8713">                    checkForWashedInfernos(entity, curPos);</span>
                } else {
                    // Being swarmed
<span class="nc" id="L8716">                    entity.setPosition(curPos);</span>
<span class="nc bnc" id="L8717" title="All 2 branches missed.">                    if (doDislodgeSwarmerSkillCheck(entity, rollTarget, curPos)) {</span>
                        // Entity falls
<span class="nc" id="L8719">                        curFacing = entity.getFacing();</span>
<span class="nc" id="L8720">                        curPos = entity.getPosition();</span>
<span class="nc" id="L8721">                        fellDuringMovement = true;</span>
<span class="nc" id="L8722">                        break;</span>
                    }
                    // roll failed, go prone but don't dislodge swarmers
<span class="nc" id="L8725">                    entity.setProne(true);</span>
                    // check to see if we washed off infernos
<span class="nc" id="L8727">                    checkForWashedInfernos(entity, curPos);</span>
<span class="nc" id="L8728">                    break;</span>
                }
            }

            // going hull down
<span class="nc bnc" id="L8733" title="All 2 branches missed.">            if (step.getType() == MoveStepType.HULL_DOWN) {</span>
<span class="nc" id="L8734">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8735">                entity.setHullDown(true);</span>
            }

            // Check for crushing buildings by Dropships/Mobile Structures
<span class="nc bnc" id="L8739" title="All 2 branches missed.">            for (Coords pos : step.getCrushedBuildingLocs()) {</span>
<span class="nc" id="L8740">                Building bldg = game.getBoard().getBuildingAt(pos);</span>
<span class="nc" id="L8741">                IHex hex = game.getBoard().getHex(pos);</span>

<span class="nc" id="L8743">                r = new Report(3443);</span>
<span class="nc" id="L8744">                r.subject = entity.getId();</span>
<span class="nc" id="L8745">                r.addDesc(entity);</span>
<span class="nc" id="L8746">                r.add(bldg.getName());</span>
<span class="nc" id="L8747">                vPhaseReport.add(r);</span>

<span class="nc" id="L8749">                final int cf = bldg.getCurrentCF(pos);</span>
<span class="nc" id="L8750">                final int numFloors = Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L8751">                vPhaseReport.addAll(damageBuilding(bldg, 150, &quot; is crushed for &quot;, pos));</span>
<span class="nc" id="L8752">                int damage = (int) Math.round((cf / 10.0) * numFloors);</span>
<span class="nc" id="L8753">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8754">                vPhaseReport.addAll(damageEntity(entity, hit, damage));</span>
<span class="nc" id="L8755">            }</span>

            // Track this step's location.
<span class="nc" id="L8758">            movePath.addElement(new UnitLocation(entity.getId(), curPos,</span>
<span class="nc" id="L8759">                    curFacing, step.getElevation()));</span>

            // if the lastpos is not the same as the current position
            // then add the current position to the list of places passed
            // through
<span class="nc bnc" id="L8764" title="All 2 branches missed.">            if (!curPos.equals(lastPos)) {</span>
<span class="nc" id="L8765">                passedThrough.add(curPos);</span>
<span class="nc" id="L8766">                passedThroughFacing.add(curFacing);</span>
            }

            // update lastPos, prevStep, prevFacing &amp; prevHex
<span class="nc bnc" id="L8770" title="All 2 branches missed.">            if (!curPos.equals(lastPos)) {</span>
<span class="nc" id="L8771">                prevFacing = curFacing;</span>
            }
<span class="nc" id="L8773">            lastPos = curPos;</span>
<span class="nc" id="L8774">            lastElevation = curElevation;</span>
<span class="nc" id="L8775">            prevStep = step;</span>
<span class="nc" id="L8776">            prevHex = curHex;</span>

<span class="nc" id="L8778">            firstStep = false;</span>
<span class="nc" id="L8779">        }</span>

        // set entity parameters
<span class="nc" id="L8782">        entity.setPosition(curPos);</span>
<span class="nc" id="L8783">        entity.setFacing(curFacing);</span>
<span class="nc" id="L8784">        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L8785">        entity.delta_distance = distance;</span>
<span class="nc" id="L8786">        entity.moved = moveType;</span>
<span class="nc" id="L8787">        entity.mpUsed = mpUsed;</span>
<span class="nc" id="L8788">        entity.setClimbMode(curClimbMode);</span>
<span class="nc bnc" id="L8789" title="All 6 branches missed.">        if (!sideslipped &amp;&amp; !fellDuringMovement &amp;&amp; !crashedDuringMovement</span>
<span class="nc bnc" id="L8790" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L8791">            entity.setElevation(curVTOLElevation);</span>
        }
<span class="nc" id="L8793">        entity.setAltitude(curAltitude);</span>
<span class="nc" id="L8794">        entity.setClimbMode(curClimbMode);</span>

        // add a list of places passed through
<span class="nc" id="L8797">        entity.setPassedThrough(passedThrough);</span>
<span class="nc" id="L8798">        entity.setPassedThroughFacing(passedThroughFacing);</span>

        // if we ran with destroyed hip or gyro, we need a psr
<span class="nc" id="L8801">        rollTarget = entity.checkRunningWithDamage(overallMoveType);</span>
<span class="nc bnc" id="L8802" title="All 4 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8803">            doSkillCheckInPlace(entity, rollTarget);</span>
        }

        // if we sprinted with MASC or a supercharger, then we need a PSR
<span class="nc" id="L8807">        rollTarget = entity.checkSprintingWithMASC(overallMoveType,</span>
                entity.mpUsed);
<span class="nc bnc" id="L8809" title="All 4 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8810">            doSkillCheckInPlace(entity, rollTarget);</span>
        }

        // if we used ProtoMech myomer booster, roll 2d6
        // pilot damage on a 2
<span class="nc bnc" id="L8815" title="All 4 branches missed.">        if ((entity instanceof Protomech) &amp;&amp; ((Protomech) entity).hasMyomerBooster()</span>
<span class="nc" id="L8816">                &amp;&amp; (md.getMpUsed() &gt; ((Protomech) entity)</span>
<span class="nc bnc" id="L8817" title="All 2 branches missed.">                        .getRunMPwithoutMyomerBooster(true, false, false))) {</span>
<span class="nc" id="L8818">            r = new Report(2373);</span>
<span class="nc" id="L8819">            r.addDesc(entity);</span>
<span class="nc" id="L8820">            r.subject = entity.getId();</span>
<span class="nc" id="L8821">            int roll = Compute.d6(2);</span>
<span class="nc" id="L8822">            r.add(roll);</span>
<span class="nc bnc" id="L8823" title="All 2 branches missed.">            if (roll &gt; 2) {</span>
<span class="nc" id="L8824">                r.choose(true);</span>
<span class="nc" id="L8825">                addReport(r);</span>
            } else {
<span class="nc" id="L8827">                r.choose(false);</span>
<span class="nc" id="L8828">                addReport(r);</span>
<span class="nc" id="L8829">                addReport(damageCrew(entity, 1));</span>
            }
        }

<span class="nc" id="L8833">        rollTarget = entity.checkSprintingWithSupercharger(overallMoveType, entity.mpUsed);</span>
<span class="nc bnc" id="L8834" title="All 2 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8835">            doSkillCheckInPlace(entity, rollTarget);</span>
        }
<span class="nc bnc" id="L8837" title="All 2 branches missed.">        if ((md.getLastStepMovementType() == EntityMovementType.MOVE_SPRINT)</span>
<span class="nc bnc" id="L8838" title="All 4 branches missed.">                &amp;&amp; md.hasActiveMASC() &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8839">            doSkillCheckInPlace(entity, entity.getBasePilotingRoll(EntityMovementType.MOVE_SPRINT));</span>
        }

<span class="nc bnc" id="L8842" title="All 4 branches missed.">        if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>

<span class="nc" id="L8844">            IAero a = (IAero) entity;</span>
<span class="nc" id="L8845">            int thrust = md.getMpUsed();</span>

            // consume fuel
<span class="nc bnc" id="L8848" title="All 2 branches missed.">            if (((entity.isAero())</span>
<span class="nc bnc" id="L8849" title="All 4 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_FUEL_CONSUMPTION))</span>
                    || (entity instanceof TeleMissile)) {
<span class="nc" id="L8851">                int fuelUsed = ((IAero) entity).getFuelUsed(thrust);</span>
<span class="nc" id="L8852">                a.useFuel(fuelUsed);</span>
            }

            // JumpShips and space stations need to reduce accumulated thrust if
            // they spend some
<span class="nc bnc" id="L8857" title="All 2 branches missed.">            if (entity instanceof Jumpship) {</span>
<span class="nc" id="L8858">                Jumpship js = (Jumpship) entity;</span>
<span class="nc" id="L8859">                double penalty = 0.0;</span>
                // JumpShips do not accumulate thrust when they make a turn or
                // change velocity
<span class="nc bnc" id="L8862" title="All 4 branches missed.">                if (md.contains(MoveStepType.TURN_LEFT) || md.contains(MoveStepType.TURN_RIGHT)) {</span>
                    // I need to subtract the station keeping thrust from their
                    // accumulated thrust
                    // because they did not actually use it
<span class="nc" id="L8866">                    penalty = js.getStationKeepingThrust();</span>
                }
<span class="nc bnc" id="L8868" title="All 2 branches missed.">                if (thrust &gt; 0) {</span>
<span class="nc" id="L8869">                    penalty = thrust;</span>
                }
<span class="nc bnc" id="L8871" title="All 2 branches missed.">                if (penalty &gt; 0.0) {</span>
<span class="nc" id="L8872">                    js.setAccumulatedThrust(Math.max(0, js.getAccumulatedThrust() - penalty));</span>
                }
            }

            // check to see if thrust exceeded SI

<span class="nc" id="L8878">            rollTarget = a.checkThrustSITotal(thrust, overallMoveType);</span>
<span class="nc bnc" id="L8879" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8880">                game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                        &quot;Thrust spent during turn exceeds SI&quot;));
            }

<span class="nc bnc" id="L8884" title="All 2 branches missed.">            if (!game.getBoard().inSpace()) {</span>
<span class="nc" id="L8885">                rollTarget = a.checkVelocityDouble(md.getFinalVelocity(),</span>
                        overallMoveType);
<span class="nc bnc" id="L8887" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8888">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                            &quot;Velocity greater than 2x safe thrust&quot;));
                }

<span class="nc" id="L8892">                rollTarget = a.checkDown(md.getFinalNDown(), overallMoveType);</span>
<span class="nc bnc" id="L8893" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8894">                    game.addControlRoll(</span>
<span class="nc" id="L8895">                            new PilotingRollData(entity.getId(), md.getFinalNDown(),</span>
                                    &quot;descended more than two altitudes&quot;));
                }

                // check for hovering
<span class="nc" id="L8900">                rollTarget = a.checkHover(md);</span>
<span class="nc bnc" id="L8901" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8902">                    game.addControlRoll(</span>
<span class="nc" id="L8903">                            new PilotingRollData(entity.getId(), 0, &quot;hovering&quot;));</span>
                }

                // check for aero stall
<span class="nc" id="L8907">                rollTarget = a.checkStall(md);</span>
<span class="nc bnc" id="L8908" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8909">                    r = new Report(9391);</span>
<span class="nc" id="L8910">                    r.subject = entity.getId();</span>
<span class="nc" id="L8911">                    r.addDesc(entity);</span>
<span class="nc" id="L8912">                    addReport(r);</span>
<span class="nc" id="L8913">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                            &quot;stalled out&quot;));
<span class="nc" id="L8915">                    entity.setAltitude(entity.getAltitude() - 1);</span>
                    // check for crash
<span class="nc bnc" id="L8917" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L8918">                        addReport(processCrash(entity, 0, entity.getPosition()));</span>
                    }
                }

                // check to see if spheroids should lose one altitude
<span class="nc bnc" id="L8923" title="All 4 branches missed.">                if (a.isSpheroid() &amp;&amp; !a.isSpaceborne()</span>
<span class="nc bnc" id="L8924" title="All 6 branches missed.">                        &amp;&amp; a.isAirborne() &amp;&amp; (md.getFinalNDown() == 0) &amp;&amp; (md.getMpUsed() == 0)) {</span>
<span class="nc" id="L8925">                    r = new Report(9392);</span>
<span class="nc" id="L8926">                    r.subject = entity.getId();</span>
<span class="nc" id="L8927">                    r.addDesc(entity);</span>
<span class="nc" id="L8928">                    addReport(r);</span>
<span class="nc" id="L8929">                    entity.setAltitude(entity.getAltitude() - 1);</span>
                    // check for crash
<span class="nc bnc" id="L8931" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L8932">                        addReport(processCrash(entity, 0, entity.getPosition()));</span>
                    }
<span class="nc bnc" id="L8934" title="All 6 branches missed.">                } else if (entity instanceof EscapePods &amp;&amp; entity.isAirborne() &amp;&amp; md.getFinalVelocity() &lt; 2) {</span>
                    //Atmospheric Escape Pods that drop below velocity 2 lose altitude as dropping units
<span class="nc" id="L8936">                    entity.setAltitude(entity.getAltitude()</span>
<span class="nc" id="L8937">                            - game.getPlanetaryConditions().getDropRate());</span>
<span class="nc" id="L8938">                    r = new Report(6676);</span>
<span class="nc" id="L8939">                    r.subject = entity.getId();</span>
<span class="nc" id="L8940">                    r.addDesc(entity);</span>
<span class="nc" id="L8941">                    r.add(game.getPlanetaryConditions().getDropRate());</span>
<span class="nc" id="L8942">                    addReport(r);</span>
                }
            }
        }

        // We need to check for the removal of hull-down for tanks.
        // Tanks can just drive out of hull-down: if the tank was hull-down
        // and doesn't end hull-down we can remove the hull-down status
<span class="nc bnc" id="L8950" title="All 8 branches missed.">        if (entity.isHullDown() &amp;&amp; !md.getFinalHullDown()</span>
                &amp;&amp; (entity instanceof Tank
<span class="nc bnc" id="L8952" title="All 2 branches missed.">                || (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE))) {</span>
<span class="nc" id="L8953">            entity.setHullDown(false);</span>
        }

        // If the entity is being swarmed, erratic movement may dislodge the
        // fleas.
<span class="nc" id="L8958">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L8959" title="All 4 branches missed.">        if ((Entity.NONE != swarmerId) &amp;&amp; md.contains(MoveStepType.SHAKE_OFF_SWARMERS)) {</span>
<span class="nc" id="L8960">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L8961">            rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L8963">            entity.addPilotingModifierForTerrain(rollTarget);</span>

            // Add a +4 modifier.
<span class="nc bnc" id="L8966" title="All 2 branches missed.">            if (md.getLastStepMovementType() == EntityMovementType.MOVE_VTOL_RUN) {</span>
<span class="nc" id="L8967">                rollTarget.addModifier(2,</span>
                        &quot;dislodge swarming infantry with VTOL movement&quot;);
            } else {
<span class="nc" id="L8970">                rollTarget.addModifier(4, &quot;dislodge swarming infantry&quot;);</span>
            }

            // If the swarmer has Assault claws, give a 1 modifier.
            // We can stop looking when we find our first match.
<span class="nc bnc" id="L8975" title="All 2 branches missed.">            for (Mounted mount : swarmer.getMisc()) {</span>
<span class="nc" id="L8976">                EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L8977" title="All 2 branches missed.">                if (equip.hasFlag(MiscType.F_MAGNET_CLAW)) {</span>
<span class="nc" id="L8978">                    rollTarget.addModifier(1, &quot;swarmer has magnetic claws&quot;);</span>
<span class="nc" id="L8979">                    break;</span>
                }
<span class="nc" id="L8981">            }</span>

            // okay, print the info
<span class="nc" id="L8984">            r = new Report(2125);</span>
<span class="nc" id="L8985">            r.subject = entity.getId();</span>
<span class="nc" id="L8986">            r.addDesc(entity);</span>
<span class="nc" id="L8987">            addReport(r);</span>

            // roll
<span class="nc" id="L8990">            final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L8991">            r = new Report(2130);</span>
<span class="nc" id="L8992">            r.subject = entity.getId();</span>
<span class="nc" id="L8993">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L8994">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L8995">            r.add(diceRoll);</span>
<span class="nc bnc" id="L8996" title="All 2 branches missed.">            if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L8997">                r.choose(false);</span>
<span class="nc" id="L8998">                addReport(r);</span>
            } else {
                // Dislodged swarmers don't get turns.
<span class="nc" id="L9001">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L9002">                send(createTurnVectorPacket());</span>

                // Update the report and the swarmer's status.
<span class="nc" id="L9005">                r.choose(true);</span>
<span class="nc" id="L9006">                addReport(r);</span>
<span class="nc" id="L9007">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9008">                swarmer.setSwarmTargetId(Entity.NONE);</span>

<span class="nc" id="L9010">                IHex curHex = game.getBoard().getHex(curPos);</span>

                // Did the infantry fall into water?
<span class="nc bnc" id="L9013" title="All 2 branches missed.">                if (curHex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
                    // Swarming infantry die.
<span class="nc" id="L9015">                    swarmer.setPosition(curPos);</span>
<span class="nc" id="L9016">                    r = new Report(2135);</span>
<span class="nc" id="L9017">                    r.subject = entity.getId();</span>
<span class="nc" id="L9018">                    r.indent();</span>
<span class="nc" id="L9019">                    r.addDesc(swarmer);</span>
<span class="nc" id="L9020">                    addReport(r);</span>
<span class="nc" id="L9021">                    addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
                } else {
                    // Swarming infantry take a 3d6 point hit.
                    // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L9025">                    r = new Report(2140);</span>
<span class="nc" id="L9026">                    r.subject = entity.getId();</span>
<span class="nc" id="L9027">                    r.indent();</span>
<span class="nc" id="L9028">                    r.addDesc(swarmer);</span>
<span class="nc" id="L9029">                    r.add(&quot;3d6&quot;);</span>
<span class="nc" id="L9030">                    addReport(r);</span>
<span class="nc" id="L9031">                    addReport(damageEntity(swarmer,</span>
<span class="nc" id="L9032">                            swarmer.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),</span>
<span class="nc" id="L9033">                            Compute.d6(3)));</span>
<span class="nc" id="L9034">                    addNewLines();</span>
<span class="nc" id="L9035">                    swarmer.setPosition(curPos);</span>
                }
<span class="nc" id="L9037">                entityUpdate(swarmerId);</span>
            } // End successful-PSR

        } // End try-to-dislodge-swarmers

        // but the danger isn't over yet! landing from a jump can be risky!
<span class="nc bnc" id="L9043" title="All 4 branches missed.">        if ((overallMoveType == EntityMovementType.MOVE_JUMP) &amp;&amp; !entity.isMakingDfa()) {</span>
<span class="nc" id="L9044">            final IHex curHex = game.getBoard().getHex(curPos);</span>
            // check for damaged criticals
<span class="nc" id="L9046">            rollTarget = entity.checkLandingWithDamage(overallMoveType);</span>
<span class="nc bnc" id="L9047" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9048">                doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // check for prototype JJs
<span class="nc" id="L9051">            rollTarget = entity.checkLandingWithPrototypeJJ(overallMoveType);</span>
<span class="nc bnc" id="L9052" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9053">                doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // check for jumping into heavy woods
<span class="nc bnc" id="L9056" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_PSR_JUMP_HEAVY_WOODS)) {</span>
<span class="nc" id="L9057">                rollTarget = entity.checkLandingInHeavyWoods(overallMoveType, curHex);</span>
<span class="nc bnc" id="L9058" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9059">                    doSkillCheckInPlace(entity, rollTarget);</span>
                }
            }
            // Mechanical jump boosters fall damage
<span class="nc bnc" id="L9063" title="All 2 branches missed.">            if (md.shouldMechanicalJumpCauseFallDamage()) {</span>
<span class="nc" id="L9064">                vPhaseReport.addAll(doEntityFallsInto(entity,</span>
<span class="nc" id="L9065">                        entity.getElevation(), md.getJumpPathHighestPoint(),</span>
<span class="nc" id="L9066">                        curPos, entity.getBasePilotingRoll(overallMoveType),</span>
<span class="nc" id="L9067">                        false, entity.getJumpMP()));</span>
            }
            // jumped into water?
<span class="nc" id="L9070">            int waterLevel = curHex.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L9071" title="All 4 branches missed.">            if (curHex.containsTerrain(Terrains.ICE) &amp;&amp; (waterLevel &gt; 0)) {</span>
<span class="nc bnc" id="L9072" title="All 2 branches missed.">                if (!(entity instanceof Infantry)) {</span>
                    // check for breaking ice
<span class="nc" id="L9074">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L9075">                    r = new Report(2122);</span>
<span class="nc" id="L9076">                    r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L9077">                    r.add(roll);</span>
<span class="nc" id="L9078">                    r.subject = entity.getId();</span>
<span class="nc" id="L9079">                    addReport(r);</span>
<span class="nc bnc" id="L9080" title="All 2 branches missed.">                    if (roll &gt;= 4) {</span>
                        // oops!
<span class="nc" id="L9082">                        entity.setPosition(curPos);</span>
<span class="nc" id="L9083">                        addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L9084">                        curPos = entity.getPosition();</span>
                    } else {
                        // TacOps: immediate PSR with +4 for terrain. If you
                        // fall then may break the ice after all
<span class="nc" id="L9088">                        rollTarget = entity.checkLandingOnIce(overallMoveType, curHex);</span>
<span class="nc bnc" id="L9089" title="All 2 branches missed.">                        if (!doSkillCheckInPlace(entity, rollTarget)) {</span>
                            // apply damage now, or it will show up as a
                            // possible breach, if ice is broken
<span class="nc" id="L9092">                            entity.applyDamage();</span>
<span class="nc" id="L9093">                            roll = Compute.d6(1);</span>
<span class="nc" id="L9094">                            r = new Report(2118);</span>
<span class="nc" id="L9095">                            r.addDesc(entity);</span>
<span class="nc" id="L9096">                            r.add(roll);</span>
<span class="nc" id="L9097">                            r.subject = entity.getId();</span>
<span class="nc" id="L9098">                            addReport(r);</span>
<span class="nc bnc" id="L9099" title="All 2 branches missed.">                            if (roll == 6) {</span>
<span class="nc" id="L9100">                                entity.setPosition(curPos);</span>
<span class="nc" id="L9101">                                addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L9102">                                curPos = entity.getPosition();</span>
                            }
                        }
                    }
<span class="nc" id="L9106">                }</span>
<span class="nc bnc" id="L9107" title="All 4 branches missed.">            } else if (!(prevStep.climbMode() &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE))</span>
<span class="nc bnc" id="L9108" title="All 2 branches missed.">                    &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L9109">                rollTarget = entity.checkWaterMove(waterLevel, overallMoveType);</span>
<span class="nc bnc" id="L9110" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                    // For falling elevation, Entity must not on hex surface
<span class="nc" id="L9112">                    int currElevation = entity.getElevation();</span>
<span class="nc" id="L9113">                    entity.setElevation(0);</span>
<span class="nc" id="L9114">                    boolean success = doSkillCheckInPlace(entity, rollTarget);</span>
<span class="nc bnc" id="L9115" title="All 2 branches missed.">                    if (success) {</span>
<span class="nc" id="L9116">                        entity.setElevation(currElevation);</span>
                    }
                }
<span class="nc bnc" id="L9119" title="All 2 branches missed.">                if (waterLevel &gt; 1) {</span>
                    // Any swarming infantry will be destroyed.
<span class="nc" id="L9121">                    drownSwarmer(entity, curPos);</span>
                }
            }

            // check for building collapse
<span class="nc" id="L9126">            Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L9127" title="All 2 branches missed.">            if (bldg != null) {</span>
<span class="nc" id="L9128">                checkForCollapse(bldg, game.getPositionMap(), curPos, true,</span>
                        vPhaseReport);
            }

            // Don't interact with terrain when jumping onto a building or a bridge
<span class="nc bnc" id="L9133" title="All 2 branches missed.">            if (entity.getElevation() == 0) {</span>
<span class="nc" id="L9134">                ServerHelper.checkAndApplyMagmaCrust(curHex, entity.getElevation(), entity, curPos, true, vPhaseReport, this);</span>

                // jumped into swamp? maybe stuck!
<span class="nc bnc" id="L9137" title="All 2 branches missed.">                if (curHex.getBogDownModifier(entity.getMovementMode(),</span>
                        entity instanceof LargeSupportTank) != TargetRoll.AUTOMATIC_SUCCESS) {
<span class="nc bnc" id="L9139" title="All 2 branches missed.">                    if (entity instanceof Mech) {</span>
<span class="nc" id="L9140">                        entity.setStuck(true);</span>
<span class="nc" id="L9141">                        r = new Report(2121);</span>
<span class="nc" id="L9142">                        r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L9143">                        r.subject = entity.getId();</span>
<span class="nc" id="L9144">                        addReport(r);</span>
                        // check for quicksand
<span class="nc" id="L9146">                        addReport(checkQuickSand(curPos));</span>
<span class="nc bnc" id="L9147" title="All 2 branches missed.">                    } else if (!entity.hasETypeFlag(Entity.ETYPE_INFANTRY)) {</span>
<span class="nc" id="L9148">                        rollTarget = new PilotingRollData(entity.getId(),</span>
                                5, &quot;entering boggy terrain&quot;);
<span class="nc" id="L9150">                        rollTarget.append(new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L9151">                                curHex.getBogDownModifier(entity.getMovementMode(),</span>
                                        entity instanceof LargeSupportTank),
                                &quot;avoid bogging down&quot;));
<span class="nc bnc" id="L9154" title="All 2 branches missed.">                        if (0 &lt; doSkillCheckWhileMoving(entity, entity.getElevation(), curPos, curPos,</span>
                                rollTarget, false)) {
<span class="nc" id="L9156">                            entity.setStuck(true);</span>
<span class="nc" id="L9157">                            r = new Report(2081);</span>
<span class="nc" id="L9158">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L9159">                            r.subject = entity.getId();</span>
<span class="nc" id="L9160">                            addReport(r);</span>
                            // check for quicksand
<span class="nc" id="L9162">                            addReport(checkQuickSand(curPos));</span>
                        }
                    }
                }
            }
            // If the entity is being swarmed, jumping may dislodge the fleas.
<span class="nc bnc" id="L9168" title="All 2 branches missed.">            if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L9169">                final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L9170">                rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L9172">                entity.addPilotingModifierForTerrain(rollTarget);</span>

                // Add a +4 modifier.
<span class="nc" id="L9175">                rollTarget.addModifier(4, &quot;dislodge swarming infantry&quot;);</span>

                // If the swarmer has Assault claws, give a 1 modifier.
                // We can stop looking when we find our first match.
<span class="nc bnc" id="L9179" title="All 2 branches missed.">                if (swarmer.hasWorkingMisc(MiscType.F_MAGNET_CLAW, -1)) {</span>
<span class="nc" id="L9180">                    rollTarget.addModifier(1, &quot;swarmer has magnetic claws&quot;);</span>
                }

                // okay, print the info
<span class="nc" id="L9184">                r = new Report(2125);</span>
<span class="nc" id="L9185">                r.subject = entity.getId();</span>
<span class="nc" id="L9186">                r.addDesc(entity);</span>
<span class="nc" id="L9187">                addReport(r);</span>

                // roll
<span class="nc" id="L9190">                final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L9191">                r = new Report(2130);</span>
<span class="nc" id="L9192">                r.subject = entity.getId();</span>
<span class="nc" id="L9193">                r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L9194">                r.add(rollTarget.getDesc());</span>
<span class="nc" id="L9195">                r.add(diceRoll);</span>
<span class="nc bnc" id="L9196" title="All 2 branches missed.">                if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L9197">                    r.choose(false);</span>
<span class="nc" id="L9198">                    addReport(r);</span>
                } else {
                    // Dislodged swarmers don't get turns.
<span class="nc" id="L9201">                    game.removeTurnFor(swarmer);</span>
<span class="nc" id="L9202">                    send(createTurnVectorPacket());</span>

                    // Update the report and the swarmer's status.
<span class="nc" id="L9205">                    r.choose(true);</span>
<span class="nc" id="L9206">                    addReport(r);</span>
<span class="nc" id="L9207">                    entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9208">                    swarmer.setSwarmTargetId(Entity.NONE);</span>

                    // Did the infantry fall into water?
<span class="nc bnc" id="L9211" title="All 2 branches missed.">                    if (curHex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
                        // Swarming infantry die.
<span class="nc" id="L9213">                        swarmer.setPosition(curPos);</span>
<span class="nc" id="L9214">                        r = new Report(2135);</span>
<span class="nc" id="L9215">                        r.subject = entity.getId();</span>
<span class="nc" id="L9216">                        r.indent();</span>
<span class="nc" id="L9217">                        r.addDesc(swarmer);</span>
<span class="nc" id="L9218">                        addReport(r);</span>
<span class="nc" id="L9219">                        addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
                    } else {
                        // Swarming infantry take a 3d6 point hit.
                        // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L9223">                        r = new Report(2140);</span>
<span class="nc" id="L9224">                        r.subject = entity.getId();</span>
<span class="nc" id="L9225">                        r.indent();</span>
<span class="nc" id="L9226">                        r.addDesc(swarmer);</span>
<span class="nc" id="L9227">                        r.add(&quot;3d6&quot;);</span>
<span class="nc" id="L9228">                        addReport(r);</span>
<span class="nc" id="L9229">                        addReport(damageEntity(swarmer,</span>
<span class="nc" id="L9230">                                swarmer.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),</span>
<span class="nc" id="L9231">                                Compute.d6(3)));</span>
<span class="nc" id="L9232">                        addNewLines();</span>
<span class="nc" id="L9233">                        swarmer.setPosition(curPos);</span>
                    }
<span class="nc" id="L9235">                    entityUpdate(swarmerId);</span>
                } // End successful-PSR

            } // End try-to-dislodge-swarmers

            // one more check for inferno wash-off
<span class="nc" id="L9241">            checkForWashedInfernos(entity, curPos);</span>

            // a jumping tank needs to roll for movement damage
<span class="nc bnc" id="L9244" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L9245">                int modifier = 0;</span>
<span class="nc bnc" id="L9246" title="All 2 branches missed.">                if (curHex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L9247" title="All 2 branches missed.">                        || curHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L9248" title="All 2 branches missed.">                        || curHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L9249">                    modifier = 1;</span>
                }
<span class="nc" id="L9251">                r = new Report(2126);</span>
<span class="nc" id="L9252">                r.subject = entity.getId();</span>
<span class="nc" id="L9253">                r.addDesc(entity);</span>
<span class="nc" id="L9254">                vPhaseReport.add(r);</span>
<span class="nc" id="L9255">                vPhaseReport.addAll(vehicleMotiveDamage((Tank)entity, modifier,</span>
                        false, -1, true));
<span class="nc" id="L9257">                Report.addNewline(vPhaseReport);</span>
            }

        } // End entity-is-jumping

        //If converting to another mode, set the final movement mode and report it
<span class="nc bnc" id="L9263" title="All 2 branches missed.">        if (entity.isConvertingNow()) {</span>
<span class="nc" id="L9264">            r = new Report(1210);</span>
<span class="nc" id="L9265">            r.subject = entity.getId();</span>
<span class="nc" id="L9266">            r.addDesc(entity);</span>
<span class="nc bnc" id="L9267" title="All 4 branches missed.">            if (entity instanceof QuadVee &amp;&amp; entity.isProne()</span>
<span class="nc bnc" id="L9268" title="All 2 branches missed.">                    &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_MECH) {</span>
                //Fall while converting to vehicle mode cancels conversion.
<span class="nc" id="L9270">                entity.setConvertingNow(false);</span>
<span class="nc" id="L9271">                r.messageId = 2454;</span>
            } else {
                // LAMs converting from fighter mode need to have the elevation set properly.
<span class="nc bnc" id="L9274" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc bnc" id="L9275" title="All 2 branches missed.">                    if (md.getFinalConversionMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L9276" title="All 4 branches missed.">                            &amp;&amp; entity.getAltitude() &gt; 0 &amp;&amp; entity.getAltitude() &lt;= 3) {</span>
<span class="nc" id="L9277">                        entity.setElevation(entity.getAltitude() * 10);</span>
<span class="nc" id="L9278">                        entity.setAltitude(0);</span>
                    } else {
<span class="nc" id="L9280">                        IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L9281" title="All 2 branches missed.">                        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L9282">                            entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
                        } else {
<span class="nc" id="L9284">                            entity.setElevation(0);</span>
                        }
                    }
                }
<span class="nc" id="L9288">                entity.setMovementMode(md.getFinalConversionMode());</span>
<span class="nc bnc" id="L9289" title="All 4 branches missed.">                if (entity instanceof Mech &amp;&amp; ((Mech)entity).hasTracks()) {</span>
<span class="nc" id="L9290">                    r.messageId = 2455;</span>
<span class="nc bnc" id="L9291" title="All 2 branches missed.">                    r.choose(entity.getMovementMode() == EntityMovementMode.TRACKED);</span>
<span class="nc bnc" id="L9292" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.TRACKED</span>
<span class="nc bnc" id="L9293" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L9294">                    r.messageId = 2451;</span>
<span class="nc bnc" id="L9295" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L9296">                    r.messageId = 2452;</span>
<span class="nc bnc" id="L9297" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L9298">                    r.messageId = 2453;</span>
                } else {
<span class="nc" id="L9300">                    r.messageId = 2450;</span>
                }
<span class="nc bnc" id="L9302" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L9303">                    int altitude = entity.getAltitude();</span>
<span class="nc bnc" id="L9304" title="All 4 branches missed.">                    if (altitude == 0 &amp;&amp; md.getFinalElevation() &gt;= 8) {</span>
<span class="nc" id="L9305">                        altitude = 1;</span>
                    }
<span class="nc bnc" id="L9307" title="All 2 branches missed.">                    if (altitude == 0) {</span>
<span class="nc" id="L9308">                        ((IAero)entity).land();</span>
                    } else {
<span class="nc" id="L9310">                        ((IAero)entity).liftOff(altitude);</span>
                    }
                }
            }
<span class="nc" id="L9314">            addReport(r);</span>
        }

          // update entity's locations' exposure
<span class="nc" id="L9318">        vPhaseReport.addAll(doSetLocationsExposure(entity,</span>
<span class="nc" id="L9319">                game.getBoard().getHex(curPos), false, entity.getElevation()));</span>

        // Check the falls_end_movement option to see if it should be able to
        // move on.
        // Need to check here if the 'Mech actually went from non-prone to prone
        // here because 'fellDuringMovement' is sometimes abused just to force
        // another turn and so doesn't reliably tell us.
<span class="nc bnc" id="L9326" title="All 6 branches missed.">        boolean continueTurnFromFall = !(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_FALLS_END_MOVEMENT)</span>
<span class="nc bnc" id="L9327" title="All 4 branches missed.">                    &amp;&amp; (entity instanceof Mech) &amp;&amp; !wasProne &amp;&amp; entity.isProne())</span>
<span class="nc bnc" id="L9328" title="All 4 branches missed.">                &amp;&amp; (fellDuringMovement &amp;&amp; !entity.isCarefulStand()) // Careful standing takes up the whole turn</span>
<span class="nc bnc" id="L9329" title="All 4 branches missed.">                &amp;&amp; !turnOver &amp;&amp; (entity.mpUsed &lt; entity.getRunMP())</span>
                &amp;&amp; (overallMoveType != EntityMovementType.MOVE_JUMP);
<span class="nc bnc" id="L9331" title="All 10 branches missed.">        if ((continueTurnFromFall || continueTurnFromPBS || continueTurnFromFishtail || continueTurnFromLevelDrop || continueTurnFromCliffAscent)</span>
<span class="nc bnc" id="L9332" title="All 4 branches missed.">                &amp;&amp; entity.isSelectableThisTurn() &amp;&amp; !entity.isDoomed()) {</span>
<span class="nc" id="L9333">            entity.applyDamage();</span>
<span class="nc" id="L9334">            entity.setDone(false);</span>
<span class="nc" id="L9335">            GameTurn newTurn = new GameTurn.SpecificEntityTurn(entity.getOwner().getId(), entity.getId());</span>
            // Need to set the new turn's multiTurn state
<span class="nc" id="L9337">            newTurn.setMultiTurn(true);</span>
<span class="nc" id="L9338">            game.insertNextTurn(newTurn);</span>
            // brief everybody on the turn update
<span class="nc" id="L9340">            send(createTurnVectorPacket());</span>
            // let everyone know about what just happened
<span class="nc bnc" id="L9342" title="All 2 branches missed.">            if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L9343">                send(entity.getOwner().getId(), createSpecialReportPacket());</span>
            }
<span class="nc" id="L9345">        } else {</span>
<span class="nc bnc" id="L9346" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L9347">                IHex hex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L9348" title="All 2 branches missed.">                if (md.automaticWiGELanding(false)) {</span>
                    // try to land safely; LAMs require a psr when landing with gyro or leg actuator
                    // damage and ProtoMechs always require a roll
<span class="nc bnc" id="L9351" title="All 2 branches missed.">                    int elevation = (null == prevStep)? entity.getElevation() : prevStep.getElevation();</span>
<span class="nc bnc" id="L9352" title="All 2 branches missed.">                    if (entity.hasETypeFlag(Entity.ETYPE_LAND_AIR_MECH)) {</span>
<span class="nc" id="L9353">                        addReport(landAirMech((LandAirMech) entity, entity.getPosition(), elevation,</span>
                                entity.delta_distance));
<span class="nc bnc" id="L9355" title="All 2 branches missed.">                    } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L9356">                        vPhaseReport.addAll(landGliderPM((Protomech) entity, entity.getPosition(),</span>
                                elevation, entity.delta_distance));
                    } else {
<span class="nc" id="L9359">                        r = new Report(2123);</span>
<span class="nc" id="L9360">                        r.addDesc(entity);</span>
<span class="nc" id="L9361">                        r.subject = entity.getId();</span>
<span class="nc" id="L9362">                        vPhaseReport.add(r);</span>
                    }

<span class="nc bnc" id="L9365" title="All 2 branches missed.">                    if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L9366">                        Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc" id="L9367">                        entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L9368">                        addAffectedBldg(bldg, checkBuildingCollapseWhileMoving(bldg,</span>
<span class="nc" id="L9369">                                entity, entity.getPosition()));</span>
<span class="nc bnc" id="L9370" title="All 2 branches missed.">                    } else if (entity.isLocationProhibited(entity.getPosition(), 0)</span>
<span class="nc bnc" id="L9371" title="All 2 branches missed.">                            &amp;&amp; !hex.hasPavement()){</span>
                        // crash
<span class="nc" id="L9373">                        r = new Report(2124);</span>
<span class="nc" id="L9374">                        r.addDesc(entity);</span>
<span class="nc" id="L9375">                        r.subject = entity.getId();</span>
<span class="nc" id="L9376">                        vPhaseReport.add(r);</span>
<span class="nc" id="L9377">                        vPhaseReport.addAll(crashVTOLorWiGE((Tank) entity));</span>
                    } else {
<span class="nc" id="L9379">                        entity.setElevation(0);</span>
                    }

                    // Check for stacking violations in the target hex
<span class="nc" id="L9383">                    Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L9384">                            entity.getId(), entity.getPosition());</span>
<span class="nc bnc" id="L9385" title="All 2 branches missed.">                    if (violation != null) {</span>
<span class="nc" id="L9386">                        PilotingRollData prd = new PilotingRollData(</span>
<span class="nc" id="L9387">                                violation.getId(), 2, &quot;fallen on&quot;);</span>
<span class="nc bnc" id="L9388" title="All 2 branches missed.">                        if (violation instanceof Dropship) {</span>
<span class="nc" id="L9389">                            violation = entity;</span>
<span class="nc" id="L9390">                            prd = null;</span>
                        }
<span class="nc" id="L9392">                        Coords targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L9393">                                violation.getId(), entity.getPosition(), 0);</span>
<span class="nc bnc" id="L9394" title="All 2 branches missed.">                        if (targetDest != null) {</span>
<span class="nc" id="L9395">                            vPhaseReport.addAll(doEntityDisplacement(violation,</span>
<span class="nc" id="L9396">                                    entity.getPosition(), targetDest, prd));</span>
                            // Update the violating entity's position on the
                            // client.
<span class="nc" id="L9399">                            entityUpdate(violation.getId());</span>
                        } else {
                            // ack! automatic death! Tanks
                            // suffer an ammo/power plant hit.
                            // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L9404">                            vPhaseReport.addAll(destroyEntity(violation,</span>
                                    &quot;impossible displacement&quot;,
                                    violation instanceof Mech,
                                    violation instanceof Mech));
                        }
                    }
<span class="nc bnc" id="L9410" title="All 2 branches missed.">                } else if (!entity.hasETypeFlag(Entity.ETYPE_LAND_AIR_MECH)</span>
<span class="nc bnc" id="L9411" title="All 2 branches missed.">                        &amp;&amp; !entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>

                    // we didn't land, so we go to elevation 1 above the terrain
                    // features
                    // it might have been higher than one due to the extra MPs
                    // it can spend to stay higher during movement, but should
                    // end up at one

<span class="nc" id="L9419">                    entity.setElevation(Math.min(entity.getElevation(),</span>
<span class="nc" id="L9420">                            1 + hex.maxTerrainFeatureElevation(</span>
<span class="nc" id="L9421">                            game.getBoard().inAtmosphere())));</span>
                }
            }

            // If we've somehow gotten here as an airborne LAM with a destroyed side torso
            // (such as conversion while dropping), crash now.
<span class="nc bnc" id="L9427" title="All 2 branches missed.">            if (entity instanceof LandAirMech</span>
<span class="nc bnc" id="L9428" title="All 4 branches missed.">                    &amp;&amp; (entity.isLocationBad(Mech.LOC_RT) || entity.isLocationBad(Mech.LOC_LT))) {</span>
<span class="nc" id="L9429">                r = new Report(9710);</span>
<span class="nc" id="L9430">                r.subject = entity.getId();</span>
<span class="nc" id="L9431">                r.addDesc(entity);</span>
<span class="nc bnc" id="L9432" title="All 2 branches missed.">                if (entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L9433">                    addReport(r);</span>
<span class="nc" id="L9434">                    crashAirMech(entity, new PilotingRollData(entity.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                            &quot;side torso destroyed&quot;), vPhaseReport);
<span class="nc bnc" id="L9436" title="All 4 branches missed.">                } else if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L9437">                    addReport(r);</span>
<span class="nc" id="L9438">                    addReport(processCrash(entity, ((IAero)entity).getCurrentVelocity(), entity.getPosition()));</span>
                }
            }

<span class="nc" id="L9442">            entity.setDone(true);</span>
        }

<span class="nc bnc" id="L9445" title="All 2 branches missed.">        if (dropshipStillUnloading) {</span>
            // turns should have already been inserted but we need to set the
            // entity as not done
<span class="nc" id="L9448">            entity.setDone(false);</span>
        }

        // If the entity is being swarmed, update the attacker's position.
<span class="nc bnc" id="L9452" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L9453">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L9454">            swarmer.setPosition(curPos);</span>
            // If the hex is on fire, and the swarming infantry is
            // *not* Battle Armor, it drops off.
<span class="nc bnc" id="L9457" title="All 2 branches missed.">            if (!(swarmer instanceof BattleArmor) &amp;&amp; game.getBoard()</span>
<span class="nc bnc" id="L9458" title="All 2 branches missed.">                    .getHex(curPos).containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L9459">                swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L9460">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9461">                r = new Report(2145);</span>
<span class="nc" id="L9462">                r.subject = entity.getId();</span>
<span class="nc" id="L9463">                r.indent();</span>
<span class="nc" id="L9464">                r.add(swarmer.getShortName(), true);</span>
<span class="nc" id="L9465">                addReport(r);</span>
            }
<span class="nc" id="L9467">            entityUpdate(swarmerId);</span>
        }

        // Update the entity's position,
        // unless it is off the game map.
<span class="nc bnc" id="L9472" title="All 2 branches missed.">        if (!game.isOutOfGame(entity)) {</span>
<span class="nc" id="L9473">            entityUpdate(entity.getId(), movePath, true, losCache);</span>
<span class="nc bnc" id="L9474" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L9475">                send(createRemoveEntityPacket(entity.getId(),</span>
<span class="nc" id="L9476">                        entity.getRemovalCondition()));</span>
            }
        }

        //If the entity is towing trailers, update the position of those trailers
<span class="nc bnc" id="L9481" title="All 2 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L9482">            List&lt;Integer&gt; reversedTrailers = new ArrayList&lt;&gt;(entity.getAllTowedUnits()); // initialize with a copy (no need to initialize to an empty list first)</span>
<span class="nc" id="L9483">            Collections.reverse(reversedTrailers); // reverse in-place</span>
<span class="nc" id="L9484">            List&lt;Coords&gt; trailerPath = initializeTrailerCoordinates(entity, reversedTrailers); // no need to initialize to an empty list first</span>
<span class="nc" id="L9485">            processTrailerMovement(entity, trailerPath);</span>
         }

        // recovered units should now be recovered and dealt with
<span class="nc bnc" id="L9489" title="All 6 branches missed.">        if (entity.isAero() &amp;&amp; recovered &amp;&amp; (loader != null)) {</span>

<span class="nc bnc" id="L9491" title="All 2 branches missed.">            if (loader.isCapitalFighter()) {</span>
<span class="nc bnc" id="L9492" title="All 2 branches missed.">                if (!(loader instanceof FighterSquadron)) {</span>
                    // this is a solo capital fighter so we need to add a new
                    // squadron and load both the loader and loadee
<span class="nc" id="L9495">                    FighterSquadron fs = new FighterSquadron();</span>
<span class="nc" id="L9496">                    fs.setDeployed(true);</span>
<span class="nc" id="L9497">                    fs.setId(getFreeEntityId());</span>
<span class="nc" id="L9498">                    fs.setCurrentVelocity(((Aero) loader).getCurrentVelocity());</span>
<span class="nc" id="L9499">                    fs.setNextVelocity(((Aero) loader).getNextVelocity());</span>
<span class="nc" id="L9500">                    fs.setVectors(loader.getVectors());</span>
<span class="nc" id="L9501">                    fs.setFacing(loader.getFacing());</span>
<span class="nc" id="L9502">                    fs.setOwner(entity.getOwner());</span>
                    // set velocity and heading the same as parent entity
<span class="nc" id="L9504">                    game.addEntity(fs);</span>
<span class="nc" id="L9505">                    send(createAddEntityPacket(fs.getId()));</span>
                    // make him not get a move this turn
<span class="nc" id="L9507">                    fs.setDone(true);</span>
                    // place on board
<span class="nc" id="L9509">                    fs.setPosition(loader.getPosition());</span>
<span class="nc" id="L9510">                    loadUnit(fs, loader, -1);</span>
<span class="nc" id="L9511">                    loader = fs;</span>
<span class="nc" id="L9512">                    entityUpdate(fs.getId());</span>
                }
<span class="nc" id="L9514">                loader.load(entity);</span>
            } else {
<span class="nc" id="L9516">                loader.recover(entity);</span>
<span class="nc" id="L9517">                entity.setRecoveryTurn(5);</span>
            }

            // The loaded unit is being carried by the loader.
<span class="nc" id="L9521">            entity.setTransportId(loader.getId());</span>

            // Remove the loaded unit from the screen.
<span class="nc" id="L9524">            entity.setPosition(null);</span>

            // Update the loaded unit.
<span class="nc" id="L9527">            entityUpdate(entity.getId());</span>
        }

        // even if load was unsuccessful, I may need to update the loader
<span class="nc bnc" id="L9531" title="All 2 branches missed.">        if (null != loader) {</span>
<span class="nc" id="L9532">            entityUpdate(loader.getId());</span>
        }

        // if using double blind, update the player on new units he might see
<span class="nc bnc" id="L9536" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L9537">            send(entity.getOwner().getId(),</span>
<span class="nc" id="L9538">                    createFilteredEntitiesPacket(entity.getOwner(), losCache));</span>
        }

        // if we generated a charge attack, report it now
<span class="nc bnc" id="L9542" title="All 2 branches missed.">        if (charge != null) {</span>
<span class="nc" id="L9543">            send(createAttackPacket(charge, 1));</span>
        }

        // if we generated a ram attack, report it now
<span class="nc bnc" id="L9547" title="All 2 branches missed.">        if (ram != null) {</span>
<span class="nc" id="L9548">            send(createAttackPacket(ram, 1));</span>
        }
<span class="nc bnc" id="L9550" title="All 6 branches missed.">        if ((entity instanceof Mech) &amp;&amp; entity.hasEngine() &amp;&amp; ((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L9551" title="All 2 branches missed.">                &amp;&amp; !entity.hasEnvironmentalSealing()</span>
<span class="nc bnc" id="L9552" title="All 2 branches missed.">                &amp;&amp; (entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc bnc" id="L9553" title="All 2 branches missed.">            if ((!entity.isProne()</span>
<span class="nc" id="L9554">                    &amp;&amp; (game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L9555" title="All 2 branches missed.">                            .terrainLevel(Terrains.WATER) &gt;= 2))</span>
<span class="nc bnc" id="L9556" title="All 2 branches missed.">                    || (entity.isProne()</span>
<span class="nc" id="L9557">                            &amp;&amp; (game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L9558" title="All 2 branches missed.">                                    .terrainLevel(Terrains.WATER) == 1))) {</span>
<span class="nc" id="L9559">                ((Mech) entity).setJustMovedIntoIndustrialKillingWater(true);</span>

            } else {
<span class="nc" id="L9562">                ((Mech) entity).setJustMovedIntoIndustrialKillingWater(false);</span>
            }
        }
<span class="nc" id="L9565">    }</span>

    /**
     * Updates the position of any towed trailers.
     *
     * @param tractor    The Entity that is moving
     * @param trainPath  The path all trailers are following?
     */
    private void processTrailerMovement(Entity tractor, List&lt;Coords&gt; trainPath) {
<span class="nc bnc" id="L9574" title="All 2 branches missed.">        for (int eId : tractor.getAllTowedUnits()) {</span>
<span class="nc" id="L9575">            Entity trailer = game.getEntity(eId);</span>
            // if the Tractor didn't move anywhere, stay where we are
<span class="nc bnc" id="L9577" title="All 2 branches missed.">            if (tractor.delta_distance == 0) {</span>
<span class="nc" id="L9578">                trailer.delta_distance = tractor.delta_distance;</span>
<span class="nc" id="L9579">                trailer.moved = tractor.moved;</span>
<span class="nc" id="L9580">                trailer.setSecondaryFacing(trailer.getFacing());</span>
<span class="nc" id="L9581">                trailer.setDone(true);</span>
<span class="nc" id="L9582">                entityUpdate(eId);</span>
<span class="nc" id="L9583">                continue;</span>
            }
            int stepNumber; // The Coords in trainPath that this trailer should move to
            Coords trailerPos;
<span class="nc" id="L9587">            int trailerNumber = tractor.getAllTowedUnits().indexOf(eId);</span>
<span class="nc" id="L9588">            double trailerPositionOffset = (trailerNumber + 1); //Offset so we get the right position index</span>
            // Unless the tractor is superheavy, put the first trailer in its hex.
            // Technically this would be true for a superheavy trailer too, but only a superheavy tractor can tow one.
<span class="nc bnc" id="L9591" title="All 4 branches missed.">            if (trailerNumber == 0 &amp;&amp; !tractor.isSuperHeavy()) {</span>
<span class="nc" id="L9592">                trailer.setPosition(tractor.getPosition());</span>
<span class="nc" id="L9593">                trailer.setFacing(tractor.getFacing());</span>
            } else {
                // If the trailer is superheavy, place it in a hex by itself
<span class="nc bnc" id="L9596" title="All 2 branches missed.">                if (trailer.isSuperHeavy()) {</span>
<span class="nc" id="L9597">                    trailerPositionOffset ++;</span>
<span class="nc" id="L9598">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9599">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9600">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9601" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9602">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
<span class="nc bnc" id="L9604" title="All 2 branches missed.">                } else if (tractor.isSuperHeavy()) {</span>
                    // If the tractor is superheavy, we can put two trailers in each hex
                    // starting trailer 0 in the hex behind the tractor
<span class="nc" id="L9607">                    trailerPositionOffset = (Math.ceil((trailerPositionOffset / 2.0)) + 1);</span>
<span class="nc" id="L9608">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9609">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9610">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9611" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9612">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
                } else {
                    // Otherwise, we can put two trailers in each hex
                    // starting trailer 1 in the hex behind the tractor
<span class="nc" id="L9617">                    trailerPositionOffset ++;</span>
<span class="nc" id="L9618">                    trailerPositionOffset = Math.ceil((trailerPositionOffset / 2.0));</span>
<span class="nc" id="L9619">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9620">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9621">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9622" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9623">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
                }
            }
            // trailers are immobile by default. Match the tractor's movement here
<span class="nc" id="L9628">            trailer.delta_distance = tractor.delta_distance;</span>
<span class="nc" id="L9629">            trailer.moved = tractor.moved;</span>
<span class="nc" id="L9630">            trailer.setSecondaryFacing(trailer.getFacing());</span>
<span class="nc" id="L9631">            trailer.setDone(true);</span>
<span class="nc" id="L9632">            entityUpdate(eId);</span>
<span class="nc" id="L9633">        }</span>
<span class="nc" id="L9634">    }</span>

    /**
     * Flips the order of a tractor's towed trailers list by index and
     * adds their starting coordinates to a list of hexes the tractor passed through
     *
     * @return  Returns the properly sorted list of all train coordinates
     */
    public List&lt;Coords&gt; initializeTrailerCoordinates(Entity tractor, List&lt;Integer&gt; allTowedTrailers) {
<span class="nc" id="L9643">        List&lt;Coords&gt; trainCoords = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L9644" title="All 2 branches missed.">        for (int trId : allTowedTrailers) {</span>
<span class="nc" id="L9645">            Entity trailer = game.getEntity(trId);</span>
<span class="nc" id="L9646">            Coords position = trailer.getPosition();</span>
            //Duplicates foul up the works...
<span class="nc bnc" id="L9648" title="All 2 branches missed.">            if (!trainCoords.contains(position)) {</span>
<span class="nc" id="L9649">                trainCoords.add(position);</span>
            }
<span class="nc" id="L9651">        }</span>
<span class="nc bnc" id="L9652" title="All 2 branches missed.">        for (Coords c : tractor.getPassedThrough() ) {</span>
<span class="nc bnc" id="L9653" title="All 2 branches missed.">            if (!trainCoords.contains(c)) {</span>
<span class="nc" id="L9654">                trainCoords.add(c);</span>
            }
<span class="nc" id="L9656">        }</span>
<span class="nc" id="L9657">        return trainCoords;</span>
    }

    /**
     * Checks whether the entity used MASC or a supercharger during movement, and if so checks for
     * and resolves any failures.
     *
     * @param entity  The unit using MASC/supercharger
     * @param md      The current &lt;code&gt;MovePath&lt;/code&gt;
     * @return        Whether the unit failed the check
     */
    private boolean checkMASCFailure(Entity entity, MovePath md) {
<span class="nc" id="L9669">        HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; crits = new HashMap&lt;&gt;();</span>
<span class="nc" id="L9670">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L9671" title="All 2 branches missed.">        if (entity.checkForMASCFailure(md, vReport, crits)) {</span>
<span class="nc" id="L9672">            boolean mascFailure = true;</span>
            // Check to see if the pilot can reroll due to Edge
<span class="nc bnc" id="L9674" title="All 2 branches missed.">            if (entity.getCrew().hasEdgeRemaining()</span>
<span class="nc" id="L9675">                    &amp;&amp; entity.getCrew().getOptions()</span>
<span class="nc bnc" id="L9676" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.EDGE_WHEN_MASC_FAILS)) {</span>
<span class="nc" id="L9677">                entity.getCrew().decreaseEdge();</span>
                // Need to reset the MASCUsed flag
<span class="nc" id="L9679">                entity.setMASCUsed(false);</span>
                // Report to notify user that masc check was rerolled
<span class="nc" id="L9681">                Report masc_report = new Report(6501);</span>
<span class="nc" id="L9682">                masc_report.subject = entity.getId();</span>
<span class="nc" id="L9683">                masc_report.indent(2);</span>
<span class="nc" id="L9684">                masc_report.addDesc(entity);</span>
<span class="nc" id="L9685">                vReport.add(masc_report);</span>
                // Report to notify user how much edge pilot has left
<span class="nc" id="L9687">                masc_report = new Report(6510);</span>
<span class="nc" id="L9688">                masc_report.subject = entity.getId();</span>
<span class="nc" id="L9689">                masc_report.indent(2);</span>
<span class="nc" id="L9690">                masc_report.addDesc(entity);</span>
<span class="nc" id="L9691">                masc_report.add(entity.getCrew().getOptions()</span>
<span class="nc" id="L9692">                        .intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L9693">                vReport.addElement(masc_report);</span>
                // Recheck MASC failure
<span class="nc bnc" id="L9695" title="All 2 branches missed.">                if (!entity.checkForMASCFailure(md, vReport, crits)) {</span>
                    // The reroll passed, don't process the failure
<span class="nc" id="L9697">                    mascFailure = false;</span>
<span class="nc" id="L9698">                    addReport(vReport);</span>
                }
            }
            // Check for failure and process it
<span class="nc bnc" id="L9702" title="All 2 branches missed.">            if (mascFailure) {</span>
<span class="nc" id="L9703">                addReport(vReport);</span>
                // If this is supercharger failure we need to damage the supercharger as well as
                // the additional criticals. For mechs this requires the additional step of finding
                // the slot and marking it as hit so it can't absorb future damage.
<span class="nc" id="L9707">                Mounted supercharger = entity.getSuperCharger();</span>
<span class="nc bnc" id="L9708" title="All 4 branches missed.">                if ((null != supercharger) &amp;&amp; supercharger.curMode().equals(&quot;Armed&quot;)) {</span>
<span class="nc bnc" id="L9709" title="All 2 branches missed.">                    if (entity.hasETypeFlag(Entity.ETYPE_MECH)) {</span>
<span class="nc" id="L9710">                        final int loc = supercharger.getLocation();</span>
<span class="nc bnc" id="L9711" title="All 2 branches missed.">                        for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</span>
<span class="nc" id="L9712">                            final CriticalSlot crit = entity.getCritical(loc, slot);</span>
<span class="nc bnc" id="L9713" title="All 4 branches missed.">                            if ((null != crit) &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L9714" title="All 2 branches missed.">                                    &amp;&amp; (crit.getMount().getType().equals(supercharger.getType()))) {</span>
<span class="nc" id="L9715">                                addReport(applyCriticalHit(entity, loc, crit,</span>
                                        true, 0, false));
<span class="nc" id="L9717">                                break;</span>
                            }
                        }
<span class="nc" id="L9720">                    } else {</span>
<span class="nc" id="L9721">                        supercharger.setHit(true);</span>
                    }
<span class="nc" id="L9723">                    supercharger.setMode(&quot;Off&quot;);</span>
                }
<span class="nc bnc" id="L9725" title="All 2 branches missed.">                for (Integer loc : crits.keySet()) {</span>
<span class="nc" id="L9726">                    List&lt;CriticalSlot&gt; lcs = crits.get(loc);</span>
<span class="nc bnc" id="L9727" title="All 2 branches missed.">                    for (CriticalSlot cs : lcs) {</span>
                        // HACK: if loc is -1, we need to deal motive damage to
                        // the tank, the severity of which is stored in the critslot index
<span class="nc bnc" id="L9730" title="All 2 branches missed.">                        if (loc == -1) {</span>
<span class="nc" id="L9731">                            addReport(vehicleMotiveDamage((Tank) entity,</span>
<span class="nc" id="L9732">                                    0, true, cs.getIndex()));</span>
                        } else {
<span class="nc" id="L9734">                            addReport(applyCriticalHit(entity, loc, cs,</span>
                                    true, 0, false));
                        }
<span class="nc" id="L9737">                    }</span>
<span class="nc" id="L9738">                }</span>
                // do any PSR immediately
<span class="nc" id="L9740">                addReport(resolvePilotingRolls(entity));</span>
<span class="nc" id="L9741">                game.resetPSRs(entity);</span>
                // let the player replot their move as MP might be changed
<span class="nc" id="L9743">                md.clear();</span>
<span class="nc" id="L9744">                return true;</span>
            }
<span class="nc" id="L9746">        } else {</span>
<span class="nc" id="L9747">            addReport(vReport);</span>
        }
<span class="nc" id="L9749">        return false;</span>
    }

    /**
     * LAMs or QuadVees converting from leg mode may force any carried infantry (including swarming)
     * to fall into the current hex. A LAM may suffer damage.
     *
     * @param carrier       The &lt;code&gt;Entity&lt;/code&gt; making the conversion.
     * @param rider         The &lt;code&gt;Entity&lt;/code&gt; possibly being forced off.
     * @param curPos        The coordinates of the hex where the conversion starts.
     * @param curFacing     The carrier's facing when conversion starts.
     * @param automatic     Whether the infantry falls automatically. If false, an anti-mech roll is made
     *                      to see whether it stays mounted.
     * @param infDamage     If true, the infantry takes falling damage, +1D6 for conventional.
     * @param carrierDamage If true, the carrier takes damage from converting while carrying infantry.
     */
    private Vector&lt;Report&gt; checkDropBAFromConverting(Entity carrier, Entity rider, Coords curPos, int curFacing,
            boolean automatic, boolean infDamage, boolean carrierDamage) {
<span class="nc" id="L9767">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L9769">        PilotingRollData prd = rider.getBasePilotingRoll(EntityMovementType.MOVE_NONE);</span>
<span class="nc" id="L9770">        boolean falls = automatic;</span>
<span class="nc bnc" id="L9771" title="All 2 branches missed.">        if (automatic) {</span>
<span class="nc" id="L9772">            r = new Report(2465);</span>
<span class="nc" id="L9773">            r.subject = rider.getId();</span>
<span class="nc" id="L9774">            r.addDesc(rider);</span>
<span class="nc" id="L9775">            r.addDesc(carrier);</span>
        } else {
<span class="nc" id="L9777">            r = new Report(2460);</span>
<span class="nc" id="L9778">            r.subject = rider.getId();</span>
<span class="nc" id="L9779">            r.addDesc(rider);</span>
<span class="nc" id="L9780">            r.add(prd);</span>
<span class="nc" id="L9781">            r.addDesc(carrier);</span>
<span class="nc" id="L9782">            final int diceRoll = carrier.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L9783">            r.add(diceRoll);</span>
<span class="nc bnc" id="L9784" title="All 2 branches missed.">            if (diceRoll &lt; prd.getValue()) {</span>
<span class="nc" id="L9785">                r.choose(false);</span>
<span class="nc" id="L9786">                falls = true;</span>
            } else {
<span class="nc" id="L9788">                r.choose(true);</span>
            }
        }
<span class="nc" id="L9791">        reports.add(r);</span>
<span class="nc bnc" id="L9792" title="All 2 branches missed.">        if (falls) {</span>
<span class="nc bnc" id="L9793" title="All 2 branches missed.">            if (carrier.getSwarmAttackerId() == rider.getId()) {</span>
<span class="nc" id="L9794">                rider.setDone(true);</span>
<span class="nc" id="L9795">                carrier.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9796">                rider.setSwarmTargetId(Entity.NONE);</span>
<span class="nc bnc" id="L9797" title="All 2 branches missed.">            } else if (!unloadUnit(carrier, rider, curPos, curFacing, 0)) {</span>
<span class="nc" id="L9798">                MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L9799">                                + rider.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L9800">                                + carrier.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L9801">                                + curPos.getBoardNum());</span>
<span class="nc" id="L9802">                return reports;</span>
            }
<span class="nc bnc" id="L9804" title="All 2 branches missed.">            if (infDamage) {</span>
<span class="nc" id="L9805">                reports.addAll(doEntityFall(rider, curPos, 2, prd));</span>
<span class="nc bnc" id="L9806" title="All 2 branches missed.">                if (rider.getEntityType() == Entity.ETYPE_INFANTRY) {</span>
<span class="nc" id="L9807">                    int extra = Compute.d6();</span>
<span class="nc" id="L9808">                    reports.addAll(damageEntity(rider, new HitData(Infantry.LOC_INFANTRY), extra));</span>
                }
            }
<span class="nc bnc" id="L9811" title="All 2 branches missed.">            if (carrierDamage) {</span>
                //Report the possibility of a critical hit.
<span class="nc" id="L9813">                r = new Report(2470);</span>
<span class="nc" id="L9814">                r.subject = carrier.getId();</span>
<span class="nc" id="L9815">                r.addDesc(carrier);</span>
<span class="nc" id="L9816">                reports.addElement(r);</span>
<span class="nc" id="L9817">                int mod = 0;</span>
<span class="nc bnc" id="L9818" title="All 2 branches missed.">                if (rider.getEntityType() == Entity.ETYPE_INFANTRY) {</span>
<span class="nc" id="L9819">                    mod = -2;</span>
                }
<span class="nc" id="L9821">                HitData hit = carrier.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L9822">                reports.addAll(criticalEntity(carrier, hit.getLocation(), false, mod, 0));</span>
            }
        }
<span class="nc" id="L9825">        return reports;</span>
    }

    /**
     * Handles a pointblank shot for hidden units, which must request feedback
     * from the client of the player who owns the hidden unit.
     * @return Returns true if a point-blank shot was taken, otherwise false
     */
    private boolean processPointblankShotCFR(Entity hidden, Entity target) {
<span class="nc" id="L9834">        sendPointBlankShotCFR(hidden, target);</span>
<span class="nc" id="L9835">        boolean firstPacket = true;</span>
        // Keep processing until we get a response
        while (true) {
<span class="nc" id="L9838">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9840" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9841">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9843">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9844">                    return false;</span>
<span class="nc" id="L9845">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9848" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9849">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9850">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9852" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_HIDDEN_PBS) {</span>
<span class="nc" id="L9853">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_HIDDEN_PBS CFR packet, &quot; </span>
                                + &quot;received: &quot; + cfrType);
<span class="nc" id="L9855">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L9858" title="All 2 branches missed.">                    if (rp.connId != hidden.getOwnerId()) {</span>
<span class="nc" id="L9859">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_HIDDEN_PBS CFR packet &quot; </span>
<span class="nc" id="L9860">                                + &quot;from player  &quot; + hidden.getOwnerId()</span>
                                + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L9862">                        continue;</span>
                    }
<span class="nc" id="L9864">                } else { // If no packets, wait again</span>
<span class="nc" id="L9865">                    continue;</span>
                }
                // First packet indicates whether the PBS is taken or declined
<span class="nc bnc" id="L9868" title="All 2 branches missed.">                if (firstPacket) {</span>
                    // Check to see if the client declined the PBS
<span class="nc bnc" id="L9870" title="All 2 branches missed.">                    if (rp.packet.getObject(1) == null) {</span>
<span class="nc" id="L9871">                        return false;</span>
                    } else {
<span class="nc" id="L9873">                        firstPacket = false;</span>
                        // Notify other clients, so they can display a message
<span class="nc bnc" id="L9875" title="All 2 branches missed.">                        for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L9876" title="All 2 branches missed.">                            if (p.getId() == hidden.getOwnerId()) {</span>
<span class="nc" id="L9877">                                continue;</span>
                            }
<span class="nc" id="L9879">                            send(p.getId(), new Packet(</span>
                                    Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
                                    new Object[] {
<span class="nc" id="L9882">                                            Packet.COMMAND_CFR_HIDDEN_PBS,</span>
<span class="nc" id="L9883">                                            Entity.NONE, Entity.NONE }));</span>
<span class="nc" id="L9884">                        }</span>
                        // Update all clients with the position of the PBS
<span class="nc" id="L9886">                        entityUpdate(target.getId());</span>
<span class="nc" id="L9887">                        continue;</span>
                    }
                }
                // The second packet contains the attacks to process
                @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L9892">                Vector&lt;EntityAction&gt; attacks = (Vector&lt;EntityAction&gt;) rp.packet.getObject(1);</span>
                // Mark the hidden unit as having taken a PBS
<span class="nc" id="L9894">                hidden.setMadePointblankShot(true);</span>
                // Process the Actions
<span class="nc bnc" id="L9896" title="All 2 branches missed.">                for (EntityAction ea : attacks) {</span>
<span class="nc" id="L9897">                    Entity entity = game.getEntity(ea.getEntityId());</span>
<span class="nc bnc" id="L9898" title="All 2 branches missed.">                    if (ea instanceof TorsoTwistAction) {</span>
<span class="nc" id="L9899">                        TorsoTwistAction tta = (TorsoTwistAction) ea;</span>
<span class="nc bnc" id="L9900" title="All 2 branches missed.">                        if (entity.canChangeSecondaryFacing()) {</span>
<span class="nc" id="L9901">                            entity.setSecondaryFacing(tta.getFacing());</span>
                        }
<span class="nc bnc" id="L9903" title="All 2 branches missed.">                    } else if (ea instanceof FlipArmsAction) {</span>
<span class="nc" id="L9904">                        FlipArmsAction faa = (FlipArmsAction) ea;</span>
<span class="nc" id="L9905">                        entity.setArmsFlipped(faa.getIsFlipped());</span>
<span class="nc bnc" id="L9906" title="All 2 branches missed.">                    } else if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L9907">                        boolean hexesAdded = ((SearchlightAttackAction) ea).setHexesIlluminated(game);</span>
                        // If we added new hexes, send them to all players.
                        // These are spotlights at night, you know they're
                        // there.
<span class="nc bnc" id="L9911" title="All 2 branches missed.">                        if (hexesAdded) {</span>
<span class="nc" id="L9912">                            send(createIlluminatedHexesPacket());</span>
                        }
<span class="nc" id="L9914">                        SearchlightAttackAction saa = (SearchlightAttackAction) ea;</span>
<span class="nc" id="L9915">                        addReport(saa.resolveAction(game));</span>
<span class="nc bnc" id="L9916" title="All 2 branches missed.">                    } else if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L9917">                        WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L9918">                        Entity ae = game.getEntity(waa.getEntityId());</span>
<span class="nc" id="L9919">                        Mounted m = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L9920">                        Weapon w = (Weapon) m.getType();</span>
                        // Track attacks original target, for things like swarm LRMs
<span class="nc" id="L9922">                        waa.setOriginalTargetId(waa.getTargetId());</span>
<span class="nc" id="L9923">                        waa.setOriginalTargetType(waa.getTargetType());</span>
<span class="nc" id="L9924">                        AttackHandler ah = w.fire(waa, game, this);</span>
<span class="nc bnc" id="L9925" title="All 2 branches missed.">                        if (ah != null) {</span>
<span class="nc" id="L9926">                            ah.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L9927">                            ah.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L9928">                            game.addAttack(ah);</span>
                        }
                    }
<span class="nc" id="L9931">                }</span>
                // Now handle the attacks
                // Set to the firing phase, so the attacks handle
<span class="nc" id="L9934">                IGame.Phase currentPhase = game.getPhase();</span>
<span class="nc" id="L9935">                game.setPhase(IGame.Phase.PHASE_FIRING);</span>
                // Handle attacks
<span class="nc" id="L9937">                handleAttacks(true);</span>
                // Restore Phase
<span class="nc" id="L9939">                game.setPhase(currentPhase);</span>
<span class="nc" id="L9940">                return true;</span>
            }
        }
    }

    public int processTeleguidedMissileCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; toHitValues) {
<span class="nc" id="L9946">        sendTeleguidedMissileCFR(playerId, targetIds, toHitValues);</span>
        while (true) {
<span class="nc" id="L9948">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9950" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9951">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9953">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9954">                    return 0;</span>
<span class="nc" id="L9955">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9958" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9959">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9960">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9962" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_TELEGUIDED_TARGET) {</span>
<span class="nc" id="L9963">                        MegaMek.getLogger().error(&quot;Expected a &quot; </span>
                                + &quot;COMMAND_CFR_TELEGUIDED_TARGET CFR packet, &quot; + &quot;received: &quot; + cfrType);
<span class="nc" id="L9965">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L9968" title="All 2 branches missed.">                    if (rp.connId != playerId) {</span>
<span class="nc" id="L9969">                        MegaMek.getLogger().error(&quot;Expected a &quot; </span>
                                + &quot;COMMAND_CFR_TELEGUIDED_TARGET CFR packet &quot; + &quot;from player  &quot; + playerId
                                + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L9972">                        continue;</span>
                    }
<span class="nc" id="L9974">                    return (int)rp.packet.getData()[1];</span>
                } // If no packets, wait again
<span class="nc" id="L9976">            }</span>
        }
    }
    
    public int processTAGTargetCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; targetTypes) {
<span class="nc" id="L9981">        sendTAGTargetCFR(playerId, targetIds, targetTypes);</span>
        while (true) {
<span class="nc" id="L9983">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9985" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9986">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9988">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9989">                    return 0;</span>
<span class="nc" id="L9990">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9993" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9994">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9995">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9997" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_TAG_TARGET) {</span>
<span class="nc" id="L9998">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_TAG_TARGET CFR packet, &quot;</span>
                                        + &quot;received: &quot; + cfrType);
<span class="nc" id="L10000">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L10003" title="All 2 branches missed.">                    if (rp.connId != playerId) {</span>
<span class="nc" id="L10004">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_TAG_TARGET CFR packet &quot;</span>
                                        + &quot;from player  &quot; + playerId
                                        + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L10007">                        continue;</span>
                    }
<span class="nc" id="L10009">                    return (int) rp.packet.getData()[1];</span>
                }
<span class="nc" id="L10011">            }</span>
        }
    }

    /**
     * If an aero unit takes off in the same turn that other units loaded, then
     * it risks damage to itself and those units
     *
     * @param a - The &lt;code&gt;Aero&lt;/code&gt; taking off
     */
    private void checkForTakeoffDamage(IAero a) {
<span class="nc" id="L10022">        boolean unsecured = false;</span>
<span class="nc bnc" id="L10023" title="All 2 branches missed.">        for (Entity loaded : ((Entity)a).getLoadedUnits()) {</span>
<span class="nc bnc" id="L10024" title="All 4 branches missed.">            if (loaded.wasLoadedThisTurn() &amp;&amp; !(loaded instanceof Infantry)) {</span>
<span class="nc" id="L10025">                unsecured = true;</span>
                // uh-oh, you forgot your seat belt
<span class="nc" id="L10027">                Report r = new Report(6800);</span>
<span class="nc" id="L10028">                r.subject = loaded.getId();</span>
<span class="nc" id="L10029">                r.addDesc(loaded);</span>
<span class="nc" id="L10030">                addReport(r);</span>
<span class="nc" id="L10031">                int damage = 25;</span>
<span class="nc" id="L10032">                ToHitData toHit = new ToHitData();</span>
<span class="nc bnc" id="L10033" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L10034">                    HitData hit = loaded.rollHitLocation(toHit.getHitTable(), ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10035">                    addReport(damageEntity(loaded, hit, 5, false,</span>
                            DamageType.NONE, false, true, false));
<span class="nc" id="L10037">                    damage -= 5;</span>
<span class="nc" id="L10038">                }</span>
            }
<span class="nc" id="L10040">        }</span>
<span class="nc bnc" id="L10041" title="All 2 branches missed.">        if (unsecured) {</span>
            // roll hit location to get a new critical
<span class="nc" id="L10043">            HitData hit = ((Entity)a).rollHitLocation(ToHitData.HIT_ABOVE, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10044">            addReport(applyCriticalHit((Entity)a, hit.getLocation(), new CriticalSlot(</span>
<span class="nc" id="L10045">                    0, ((Aero)a).getPotCrit()), true, 1, false));</span>
        }

<span class="nc" id="L10048">    }</span>

    /**
     * Delivers a thunder-aug shot to the targeted hex area. Thunder-Augs are 7
     * hexes, though, so...
     *
     * @param damage
     *            The per-hex density of the incoming minefield; that is, the
     *            final value with any modifiers (such as halving and rounding
     *            just for &lt;em&gt;being&lt;/em&gt; T-Aug) already applied.
     */
    public void deliverThunderAugMinefield(Coords coords, int playerId, int damage, int entityId) {
        Coords mfCoord;
<span class="nc bnc" id="L10061" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 7; dir++) {</span>
            // May need to reset here for each new hex.
<span class="nc" id="L10063">            int hexDamage = damage;</span>
<span class="nc bnc" id="L10064" title="All 2 branches missed.">            if (dir == 6) {// The targeted hex.</span>
<span class="nc" id="L10065">                mfCoord = coords;</span>
            } else {// The hex in the dir direction from the targeted hex.
<span class="nc" id="L10067">                mfCoord = coords.translated(dir);</span>
            }

            // Only if this is on the board...
<span class="nc bnc" id="L10071" title="All 2 branches missed.">            if (game.getBoard().contains(mfCoord)) {</span>
<span class="nc" id="L10072">                Minefield minefield = null;</span>
<span class="nc" id="L10073">                Enumeration&lt;Minefield&gt; minefields = game.getMinefields(mfCoord).elements();</span>
                // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10075" title="All 2 branches missed.">                while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10076">                    Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10077" title="All 2 branches missed.">                    if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10078">                        minefield = mf;</span>
<span class="nc" id="L10079">                        break;</span>
                    }
<span class="nc" id="L10081">                }</span>

                // Did we find a Thunder minefield in the hex?
                // N.B. damage Thunder minefields equals the number of
                // missiles, divided by two, rounded up.
<span class="nc bnc" id="L10086" title="All 2 branches missed.">                if (minefield == null) {</span>
                    // Nope. Create a new Thunder minefield
<span class="nc" id="L10088">                    minefield = Minefield.createMinefield(mfCoord, playerId,</span>
                            Minefield.TYPE_CONVENTIONAL, hexDamage);
<span class="nc" id="L10090">                    game.addMinefield(minefield);</span>
<span class="nc" id="L10091">                    checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10092" title="All 2 branches missed.">                } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
                    // Yup. Replace the old one.
<span class="nc" id="L10094">                    removeMinefield(minefield);</span>
<span class="nc" id="L10095">                    hexDamage += minefield.getDensity();</span>

                    // Damage from Thunder minefields are capped.
<span class="nc bnc" id="L10098" title="All 2 branches missed.">                    if (hexDamage &gt; Minefield.MAX_DAMAGE) {</span>
<span class="nc" id="L10099">                        hexDamage = Minefield.MAX_DAMAGE;</span>
                    }
<span class="nc" id="L10101">                    minefield.setDensity(hexDamage);</span>
<span class="nc" id="L10102">                    game.addMinefield(minefield);</span>
<span class="nc" id="L10103">                    checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
                }
            } // End coords-on-board
        } // Handle the next coords
<span class="nc" id="L10107">    }</span>

    /**
     * Adds a Thunder minefield to the hex.
     *
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10118">        Minefield minefield = null;</span>
<span class="nc" id="L10119">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10121" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10122">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10123" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10124">                minefield = mf;</span>
<span class="nc" id="L10125">                break;</span>
            }
<span class="nc" id="L10127">        }</span>

        // Create a new Thunder minefield
<span class="nc bnc" id="L10130" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10131">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_CONVENTIONAL, damage);</span>
<span class="nc" id="L10132">            game.addMinefield(minefield);</span>
<span class="nc" id="L10133">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10134" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10136">            removeMinefield(minefield);</span>
<span class="nc" id="L10137">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10138">            damage += oldDamage;</span>
<span class="nc" id="L10139">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10140">            minefield.setDensity(damage);</span>
<span class="nc" id="L10141">            game.addMinefield(minefield);</span>
<span class="nc" id="L10142">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10144">    }</span>

    /**
     * Adds a Thunder Inferno minefield to the hex.
     *
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderInfernoMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10155">        Minefield minefield = null;</span>
<span class="nc" id="L10156">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10158" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10159">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10160" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_INFERNO) {</span>
<span class="nc" id="L10161">                minefield = mf;</span>
<span class="nc" id="L10162">                break;</span>
            }
<span class="nc" id="L10164">        }</span>

        // Create a new Thunder Inferno minefield
<span class="nc bnc" id="L10167" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10168">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_INFERNO, damage);</span>
<span class="nc" id="L10169">            game.addMinefield(minefield);</span>
<span class="nc" id="L10170">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10171" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10173">            removeMinefield(minefield);</span>
<span class="nc" id="L10174">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10175">            damage += oldDamage;</span>
<span class="nc" id="L10176">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10177">            minefield.setDensity(damage);</span>
<span class="nc" id="L10178">            game.addMinefield(minefield);</span>
<span class="nc" id="L10179">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10181">    }</span>

    /**
     * Delivers an artillery FASCAM shot to the targeted hex area.
     */
    public void deliverFASCAMMinefield(Coords coords, int playerId, int damage, int entityId) {
        // Only if this is on the board...
<span class="nc bnc" id="L10188" title="All 2 branches missed.">        if (game.getBoard().contains(coords)) {</span>
<span class="nc" id="L10189">            Minefield minefield = null;</span>
<span class="nc" id="L10190">            Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
            // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10192" title="All 2 branches missed.">            while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10193">                Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10194" title="All 2 branches missed.">                if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10195">                    minefield = mf;</span>
<span class="nc" id="L10196">                    break;</span>
                }
<span class="nc" id="L10198">            }</span>
            // Did we find a Thunder minefield in the hex?
<span class="nc bnc" id="L10200" title="All 2 branches missed.">            if (minefield == null) {</span>
<span class="nc" id="L10201">                minefield = Minefield.createMinefield(coords, playerId,</span>
                        Minefield.TYPE_CONVENTIONAL, damage);
<span class="nc" id="L10203">                game.addMinefield(minefield);</span>
<span class="nc" id="L10204">                checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10205" title="All 2 branches missed.">            } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
                // Add to the old one.
<span class="nc" id="L10207">                removeMinefield(minefield);</span>
<span class="nc" id="L10208">                int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10209">                damage += oldDamage;</span>
<span class="nc" id="L10210">                damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10211">                minefield.setDensity(damage);</span>
<span class="nc" id="L10212">                game.addMinefield(minefield);</span>
<span class="nc" id="L10213">                checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
            }
        } // End coords-on-board
<span class="nc" id="L10216">    }</span>

    /**
     * Adds a Thunder-Active minefield to the hex.
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderActiveMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10226">        Minefield minefield = null;</span>
<span class="nc" id="L10227">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10229" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10230">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10231" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_ACTIVE) {</span>
<span class="nc" id="L10232">                minefield = mf;</span>
<span class="nc" id="L10233">                break;</span>
            }
<span class="nc" id="L10235">        }</span>

        // Create a new Thunder-Active minefield
<span class="nc bnc" id="L10238" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10239">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_ACTIVE, damage);</span>
<span class="nc" id="L10240">            game.addMinefield(minefield);</span>
<span class="nc" id="L10241">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10242" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10244">            removeMinefield(minefield);</span>
<span class="nc" id="L10245">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10246">            damage += oldDamage;</span>
<span class="nc" id="L10247">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10248">            minefield.setDensity(damage);</span>
<span class="nc" id="L10249">            game.addMinefield(minefield);</span>
<span class="nc" id="L10250">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10252">    }</span>

    /**
     * Adds a Thunder-Vibrabomb minefield to the hex.
     */
    public void deliverThunderVibraMinefield(Coords coords, int playerId,
            int damage, int sensitivity, int entityId) {
<span class="nc" id="L10259">        Minefield minefield = null;</span>
<span class="nc" id="L10260">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10262" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10263">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10264" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L10265">                minefield = mf;</span>
<span class="nc" id="L10266">                break;</span>
            }
<span class="nc" id="L10268">        }</span>

        // Create a new Thunder-Vibra minefield
<span class="nc bnc" id="L10271" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10272">            minefield = Minefield.createMinefield(coords, playerId,</span>
                    Minefield.TYPE_VIBRABOMB, damage, sensitivity);
<span class="nc" id="L10274">            game.addMinefield(minefield);</span>
<span class="nc" id="L10275">            game.addVibrabomb(minefield);</span>
<span class="nc" id="L10276">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10277" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10279">            removeMinefield(minefield);</span>
<span class="nc" id="L10280">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10281">            damage += oldDamage;</span>
<span class="nc" id="L10282">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10283">            minefield.setDensity(damage);</span>
<span class="nc" id="L10284">            game.addMinefield(minefield);</span>
<span class="nc" id="L10285">            game.addVibrabomb(minefield);</span>
<span class="nc" id="L10286">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10288">    }</span>

    /**
     * Creates an artillery flare of the given radius above the target
     */
    public void deliverArtilleryFlare(Coords coords, int radius) {
<span class="nc" id="L10294">        Flare flare = new Flare(coords, 5, radius, Flare.F_DRIFTING);</span>
<span class="nc" id="L10295">        game.addFlare(flare);</span>
<span class="nc" id="L10296">    }</span>

    public void deliverMortarFlare(Coords coords, int duration) {
<span class="nc" id="L10299">        Flare flare = new Flare(coords, duration, 1, Flare.F_IGNITED);</span>
<span class="nc" id="L10300">        game.addFlare(flare);</span>
<span class="nc" id="L10301">    }</span>

    /**
     * deliver missile smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */

    public void deliverMissileSmoke(Coords coords, int smokeType, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10310">        Report r = new Report(5183, Report.PUBLIC);</span>
<span class="nc" id="L10311">        r.indent(2);</span>
        //Report either light or heavy smoke, as appropriate
<span class="nc bnc" id="L10313" title="All 2 branches missed.">        r.choose(smokeType == SmokeCloud.SMOKE_LIGHT);</span>
<span class="nc" id="L10314">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10315">        vPhaseReport.add(r);</span>
<span class="nc" id="L10316">        createSmoke(coords, smokeType, 3);</span>
<span class="nc" id="L10317">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10318">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.SMOKE, smokeType));</span>
<span class="nc" id="L10319">        sendChangedHex(coords);</span>
<span class="nc" id="L10320">    }</span>

    public void deliverSmokeGrenade(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10323">        Report r = new Report(5200, Report.PUBLIC);</span>
<span class="nc" id="L10324">        r.indent(2);</span>
<span class="nc" id="L10325">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10326">        vPhaseReport.add(r);</span>
<span class="nc" id="L10327">        createSmoke(coords, SmokeCloud.SMOKE_LIGHT, 3);</span>
<span class="nc" id="L10328">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10329">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_LIGHT));
<span class="nc" id="L10331">        sendChangedHex(coords);</span>
<span class="nc" id="L10332">    }</span>

    public void deliverSmokeMortar(Coords coords, Vector&lt;Report&gt; vPhaseReport, int duration) {
<span class="nc" id="L10335">        Report r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10336">        r.indent(2);</span>
<span class="nc" id="L10337">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10338">        vPhaseReport.add(r);</span>
<span class="nc" id="L10339">        createSmoke(coords, SmokeCloud.SMOKE_HEAVY, duration);</span>
<span class="nc" id="L10340">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10341">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10343">        sendChangedHex(coords);</span>
<span class="nc" id="L10344">    }</span>

    public void deliverChaffGrenade(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10347">        Report r = new Report(5187, Report.PUBLIC);</span>
<span class="nc" id="L10348">        r.indent(2);</span>
<span class="nc" id="L10349">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10350">        vPhaseReport.add(r);</span>
<span class="nc" id="L10351">        createSmoke(coords, SmokeCloud.SMOKE_CHAFF_LIGHT, 1);</span>
<span class="nc" id="L10352">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10353">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_CHAFF_LIGHT));
<span class="nc" id="L10355">        sendChangedHex(coords);</span>
<span class="nc" id="L10356">    }</span>

    /**
     * deliver artillery smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */
    public void deliverArtillerySmoke(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10364">        Report r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10365">        r.indent(2);</span>
<span class="nc" id="L10366">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10367">        vPhaseReport.add(r);</span>
<span class="nc" id="L10368">        createSmoke(coords, SmokeCloud.SMOKE_HEAVY, 3);</span>
<span class="nc" id="L10369">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10370">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10372">        sendChangedHex(coords);</span>
<span class="nc bnc" id="L10373" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10374">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10375" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10376">                continue;</span>
            }
<span class="nc bnc" id="L10378" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10379">                continue;</span>
            }
<span class="nc" id="L10381">            r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10382">            r.indent(2);</span>
<span class="nc" id="L10383">            r.add(tempcoords.getBoardNum());</span>
<span class="nc" id="L10384">            vPhaseReport.add(r);</span>
<span class="nc" id="L10385">            createSmoke(tempcoords, SmokeCloud.SMOKE_HEAVY, 3);</span>
<span class="nc" id="L10386">            hex = game.getBoard().getHex(tempcoords);</span>
<span class="nc" id="L10387">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10389">            sendChangedHex(tempcoords);</span>
        }
<span class="nc" id="L10391">    }</span>

    /**
     * deliver LASER inhibiting smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */
    public void deliverLIsmoke(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10399">        Report r = new Report(5186, Report.PUBLIC);</span>
<span class="nc" id="L10400">        r.indent(2);</span>
<span class="nc" id="L10401">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10402">        vPhaseReport.add(r);</span>
<span class="nc" id="L10403">        createSmoke(coords, SmokeCloud.SMOKE_LI_HEAVY, 2);</span>
<span class="nc" id="L10404">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10405">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_LI_HEAVY));
<span class="nc" id="L10407">        sendChangedHex(coords);</span>
<span class="nc bnc" id="L10408" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10409">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10410" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10411">                continue;</span>
            }
<span class="nc bnc" id="L10413" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10414">                continue;</span>
            }
<span class="nc" id="L10416">            r = new Report(5186, Report.PUBLIC);</span>
<span class="nc" id="L10417">            r.indent(2);</span>
<span class="nc" id="L10418">            r.add(tempcoords.getBoardNum());</span>
<span class="nc" id="L10419">            vPhaseReport.add(r);</span>
<span class="nc" id="L10420">            createSmoke(tempcoords, SmokeCloud.SMOKE_LI_HEAVY, 2);</span>
<span class="nc" id="L10421">            hex = game.getBoard().getHex(tempcoords);</span>
<span class="nc" id="L10422">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SMOKE, SmokeCloud.SMOKE_LI_HEAVY));
<span class="nc" id="L10424">            sendChangedHex(tempcoords);</span>
        }
<span class="nc" id="L10426">    }</span>

    /**
     * deliver artillery inferno
     *
     * @param coords    the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     * @param ae        the attacking &lt;code&gt;entity&lt;code&gt;
     * @param subjectId the &lt;code&gt;int&lt;/code&gt; id of the target
     */
    public void deliverArtilleryInferno(Coords coords, Entity ae,
            int subjectId, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10437">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
        // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L10440" title="All 2 branches missed.">        if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_IV) {</span>
<span class="nc" id="L10441">            ignite(coords, Terrains.FIRE_LVL_INFERNO_IV, vPhaseReport);</span>
        }
        // possibly melt ice and snow
<span class="nc bnc" id="L10444" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L10445">            vPhaseReport.addAll(meltIceAndSnow(coords, subjectId));</span>
        }
<span class="nc bnc" id="L10447" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {</span>
            // TacOps, p. 356 - treat as if hit by 5 inferno missiles
<span class="nc" id="L10449">            r = new Report(6695);</span>
<span class="nc" id="L10450">            r.indent(3);</span>
<span class="nc" id="L10451">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L10452">            r.subject = entity.getId();</span>
<span class="nc" id="L10453">            r.newlines = 0;</span>
<span class="nc" id="L10454">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10455" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L10456">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L10458">            Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae, entity, 5, true);</span>
<span class="nc" id="L10459">            Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L10460">            vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L10461">        }</span>
<span class="nc bnc" id="L10462" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10463">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10464" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10465">                continue;</span>
            }
<span class="nc bnc" id="L10467" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10468">                continue;</span>
            }
<span class="nc" id="L10470">            h = game.getBoard().getHex(tempcoords);</span>
            // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L10472" title="All 2 branches missed.">            if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_IV) {</span>
<span class="nc" id="L10473">                ignite(tempcoords, Terrains.FIRE_LVL_INFERNO_IV, vPhaseReport);</span>
            }
            // possibly melt ice and snow
<span class="nc bnc" id="L10476" title="All 4 branches missed.">            if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L10477">                vPhaseReport.addAll(meltIceAndSnow(tempcoords, subjectId));</span>
            }
<span class="nc bnc" id="L10479" title="All 2 branches missed.">            for (Entity entity : game.getEntitiesVector(tempcoords)) {</span>
<span class="nc" id="L10480">                r = new Report(6695);</span>
<span class="nc" id="L10481">                r.indent(3);</span>
<span class="nc" id="L10482">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L10483">                r.newlines = 0;</span>
<span class="nc" id="L10484">                r.subject = entity.getId();</span>
<span class="nc" id="L10485">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10486" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L10487">                    Report.addNewline(vPhaseReport);</span>
                }
<span class="nc" id="L10489">                Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae,</span>
                        entity, 5, true);
<span class="nc" id="L10491">                Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L10492">                vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L10493">            }</span>
        }
<span class="nc" id="L10495">    }</span>

    public void deliverScreen(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10498">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
<span class="nc" id="L10500">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10501">        r = new Report(9070, Report.PUBLIC);</span>
<span class="nc" id="L10502">        r.indent(2);</span>
<span class="nc" id="L10503">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10504">        vPhaseReport.add(r);</span>
        // use level to count the number of screens (since level does not matter
        // in space)
<span class="nc" id="L10507">        int nscreens = h.terrainLevel(Terrains.SCREEN);</span>
<span class="nc bnc" id="L10508" title="All 2 branches missed.">        if (nscreens &gt; 0) {</span>
<span class="nc" id="L10509">            h.removeTerrain(Terrains.SCREEN);</span>
<span class="nc" id="L10510">            h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SCREEN, nscreens + 1));
        } else {
<span class="nc" id="L10513">            h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SCREEN, 1));
        }
<span class="nc" id="L10516">        sendChangedHex(coords);</span>
<span class="nc" id="L10517">    }</span>

    /**
     * deploys a new telemissile entity onto the map
     */
    public void deployTeleMissile(Entity ae, WeaponType wtype, AmmoType atype, int wId,
            int capMisMod, int damage, int armor, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10524">        Report r = new Report(9080);</span>
<span class="nc" id="L10525">        r.subject = ae.getId();</span>
<span class="nc" id="L10526">        r.addDesc(ae);</span>
<span class="nc" id="L10527">        r.indent(2);</span>
<span class="nc" id="L10528">        r.newlines = 0;</span>
<span class="nc" id="L10529">        r.add(wtype.getName());</span>
<span class="nc" id="L10530">        vPhaseReport.add(r);</span>
<span class="nc" id="L10531">        TeleMissile tele = new TeleMissile(ae, damage, armor,</span>
<span class="nc" id="L10532">                atype.getTonnage(ae), atype.getAmmoType(), capMisMod);</span>
<span class="nc" id="L10533">        tele.setDeployed(true);</span>
<span class="nc" id="L10534">        tele.setId(getFreeEntityId());</span>
<span class="nc bnc" id="L10535" title="All 2 branches missed.">        if (ae instanceof Aero) {</span>
<span class="nc" id="L10536">            Aero a = (Aero) ae;</span>
<span class="nc" id="L10537">            tele.setCurrentVelocity(a.getCurrentVelocity());</span>
<span class="nc" id="L10538">            tele.setNextVelocity(a.getNextVelocity());</span>
<span class="nc" id="L10539">            tele.setVectors(a.getVectors());</span>
<span class="nc" id="L10540">            tele.setFacing(a.getFacing());</span>
        }
        // set velocity and heading the same as parent entity
<span class="nc" id="L10543">        game.addEntity(tele);</span>
<span class="nc" id="L10544">        send(createAddEntityPacket(tele.getId()));</span>
        // make him not get a move this turn
<span class="nc" id="L10546">        tele.setDone(true);</span>
        // place on board
<span class="nc" id="L10548">        tele.setPosition(ae.getPosition());</span>
        // Update the entity
<span class="nc" id="L10550">        entityUpdate(tele.getId());</span>
        // check to see if the launching of this missile removes control of any
        // prior missiles
<span class="nc bnc" id="L10553" title="All 2 branches missed.">        if (ae.getTMTracker().containsLauncher(wId)) {</span>
<span class="nc" id="L10554">            Entity priorMissile = game.getEntity(ae.getTMTracker().getMissile(</span>
                    wId));
<span class="nc bnc" id="L10556" title="All 2 branches missed.">            if (priorMissile instanceof TeleMissile) {</span>
<span class="nc" id="L10557">                ((TeleMissile) priorMissile).setOutContact(true);</span>
                // remove this from the tracker for good measure
<span class="nc" id="L10559">                ae.getTMTracker().removeMissile(wId);</span>
            }
        }
        // track this missile on the entity
<span class="nc" id="L10563">        ae.getTMTracker().addMissile(wId, tele.getId());</span>
<span class="nc" id="L10564">    }</span>

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t, int missiles) {
<span class="nc" id="L10574">        return deliverInfernoMissiles(ae, t, missiles, CalledShot.CALLED_NONE);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param areaEffect a &lt;code&gt;boolean&lt;/code&gt; indicating whether the attack is from an
     *                   area effect weapon such as Arrow IV inferno, and partial cover should
     *                   be ignored.
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t, int missiles,
                                                 boolean areaEffect) {
<span class="nc" id="L10589">        return deliverInfernoMissiles(ae, t, missiles, CalledShot.CALLED_NONE, areaEffect);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param called   an &lt;code&gt;int&lt;/code&gt; indicated the aiming mode used to fire the
     *                 inferno missiles (for called shots)
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t,
            int missiles, int called) {
<span class="nc" id="L10603">        return deliverInfernoMissiles(ae, t, missiles, called, false);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae         the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t          the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles   the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param called     an &lt;code&gt;int&lt;/code&gt; indicated the aiming mode used to fire the
     *                   inferno missiles (for called shots)
     * @param areaEffect a &lt;code&gt;boolean&lt;/code&gt; indicating whether the attack is from an
     *                   area effect weapon such as Arrow IV inferno, and partial cover should
     *                   be ignored.
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t,
                int missiles, int called, boolean areaEffect) {
<span class="nc" id="L10620">        IHex hex = game.getBoard().getHex(t.getPosition());</span>
        Report r;
<span class="nc" id="L10622">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L10623">        int attId = Entity.NONE;</span>
<span class="nc bnc" id="L10624" title="All 2 branches missed.">        if (null != ae) {</span>
<span class="nc" id="L10625">            attId = ae.getId();</span>
        }
<span class="nc bnc" id="L10627" title="All 5 branches missed.">        switch (t.getTargetType()) {</span>
            case Targetable.TYPE_HEX_ARTILLERY:
                // used for BA inferno explosion
<span class="nc bnc" id="L10630" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector(t.getPosition())) {</span>
<span class="nc bnc" id="L10631" title="All 2 branches missed.">                    if (e.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L10632">                        r = new Report(6685);</span>
<span class="nc" id="L10633">                        r.subject = e.getId();</span>
<span class="nc" id="L10634">                        r.addDesc(e);</span>
<span class="nc" id="L10635">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10636">                        vPhaseReport.addAll(deliverInfernoMissiles(ae, e, missiles, called));</span>
                    } else {
<span class="nc" id="L10638">                        int roll = Compute.d6();</span>
<span class="nc" id="L10639">                        r = new Report(3570);</span>
<span class="nc" id="L10640">                        r.subject = e.getId();</span>
<span class="nc" id="L10641">                        r.addDesc(e);</span>
<span class="nc" id="L10642">                        r.add(roll);</span>
<span class="nc" id="L10643">                        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10644" title="All 2 branches missed.">                        if (roll &gt;= 5) {</span>
<span class="nc" id="L10645">                            vPhaseReport.addAll(deliverInfernoMissiles(ae, e, missiles, called));</span>
                        }
                    }
<span class="nc" id="L10648">                }</span>
<span class="nc bnc" id="L10649" title="All 2 branches missed.">                if (game.getBoard().getBuildingAt(t.getPosition()) != null) {</span>
<span class="nc" id="L10650">                    Vector&lt;Report&gt; vBuildingReport = damageBuilding(game.getBoard().getBuildingAt(t.getPosition()),</span>
<span class="nc" id="L10651">                            2 * missiles, t.getPosition());</span>
<span class="nc bnc" id="L10652" title="All 2 branches missed.">                    for (Report report : vBuildingReport) {</span>
<span class="nc" id="L10653">                        report.subject = attId;</span>
<span class="nc" id="L10654">                    }</span>
<span class="nc" id="L10655">                    vPhaseReport.addAll(vBuildingReport);</span>
                }
                // fall through
            case Targetable.TYPE_HEX_CLEAR:
            case Targetable.TYPE_HEX_IGNITE:
                // Report that damage applied to terrain, if there's TF to damage
<span class="nc" id="L10661">                IHex h = game.getBoard().getHex(t.getPosition());</span>
<span class="nc bnc" id="L10662" title="All 4 branches missed.">                if ((h != null) &amp;&amp; h.hasTerrainfactor()) {</span>
<span class="nc" id="L10663">                    r = new Report(3384);</span>
<span class="nc" id="L10664">                    r.indent(2);</span>
<span class="nc" id="L10665">                    r.subject = attId;</span>
<span class="nc" id="L10666">                    r.add(t.getPosition().getBoardNum());</span>
<span class="nc" id="L10667">                    r.add(missiles * 4);</span>
<span class="nc" id="L10668">                    vPhaseReport.addElement(r);</span>
                }
<span class="nc" id="L10670">                vPhaseReport.addAll(tryClearHex(t.getPosition(), missiles * 4, attId));</span>
<span class="nc" id="L10671">                tryIgniteHex(t.getPosition(), attId, false, true,</span>
                             new TargetRoll(0, &quot;inferno&quot;), -1, vPhaseReport);
<span class="nc" id="L10673">                break;</span>
            case Targetable.TYPE_BLDG_IGNITE:
            case Targetable.TYPE_BUILDING:
<span class="nc" id="L10676">                Vector&lt;Report&gt; vBuildingReport = damageBuilding(game.getBoard().getBuildingAt(t.getPosition()),</span>
<span class="nc" id="L10677">                        2 * missiles, t.getPosition());</span>
<span class="nc bnc" id="L10678" title="All 2 branches missed.">                for (Report report : vBuildingReport) {</span>
<span class="nc" id="L10679">                    report.subject = attId;</span>
<span class="nc" id="L10680">                }</span>
<span class="nc" id="L10681">                vPhaseReport.addAll(vBuildingReport);</span>

                // For each missile, check to see if it hits a unit in this hex
<span class="nc bnc" id="L10684" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector(t.getPosition())) {</span>
<span class="nc bnc" id="L10685" title="All 2 branches missed.">                    if (e.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L10686">                        continue;</span>
                    }
<span class="nc bnc" id="L10688" title="All 2 branches missed.">                    for (int m = 0; m &lt; missiles; m++) {</span>
<span class="nc" id="L10689">                        int roll = Compute.d6();</span>
<span class="nc" id="L10690">                        r = new Report(3570);</span>
<span class="nc" id="L10691">                        r.subject = e.getId();</span>
<span class="nc" id="L10692">                        r.indent(3);</span>
<span class="nc" id="L10693">                        r.addDesc(e);</span>
<span class="nc" id="L10694">                        r.add(roll);</span>
<span class="nc" id="L10695">                        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10696" title="All 2 branches missed.">                        if (roll &gt;= 5) {</span>
<span class="nc" id="L10697">                            Vector&lt;Report&gt; dmgReports = deliverInfernoMissiles(ae, e, 1, called);</span>
<span class="nc bnc" id="L10698" title="All 2 branches missed.">                            for (Report rep : dmgReports) {</span>
<span class="nc" id="L10699">                                rep.indent(4);</span>
<span class="nc" id="L10700">                            }</span>
<span class="nc" id="L10701">                            vPhaseReport.addAll(dmgReports);</span>
                        }
                    }
<span class="nc" id="L10704">                }</span>

<span class="nc" id="L10706">                break;</span>
            case Targetable.TYPE_ENTITY:
<span class="nc" id="L10708">                Entity te = (Entity) t;</span>
<span class="nc bnc" id="L10709" title="All 4 branches missed.">                if ((te instanceof Mech) &amp;&amp; (!areaEffect)) {</span>
                    // Bug #1585497: Check for partial cover
<span class="nc" id="L10711">                    int m = missiles;</span>
<span class="nc" id="L10712">                    LosEffects le = LosEffects.calculateLos(game, attId, t);</span>
<span class="nc" id="L10713">                    int cover = le.getTargetCover();</span>
<span class="nc" id="L10714">                    Vector&lt;Report&gt; coverDamageReports = new Vector&lt;&gt;();</span>
<span class="nc" id="L10715">                    int heatDamage = 0;</span>
<span class="nc" id="L10716">                    boolean heatReduced = false;</span>
<span class="nc" id="L10717">                    String reductionCause = &quot;&quot;;</span>
<span class="nc bnc" id="L10718" title="All 2 branches missed.">                    for (int i = 0; i &lt; m; i++) {</span>
<span class="nc" id="L10719">                        int side = Compute.targetSideTable(ae, t, called);</span>
<span class="nc" id="L10720">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc bnc" id="L10721" title="All 2 branches missed.">                        if (te.removePartialCoverHits(hit.getLocation(), cover, side)) {</span>
<span class="nc" id="L10722">                            missiles--;</span>
                            // Determine if damageable cover is hit
                            int damageableCoverType;
                            Entity coverDropship;
                            Coords coverLoc;

                            // Determine if there is primary and secondary
                            // cover,
                            // and then determine which one gets hit
<span class="nc bnc" id="L10731" title="All 6 branches missed.">                            if (((cover == LosEffects.COVER_75RIGHT) || (cover == LosEffects.COVER_75LEFT))</span>
                                    // 75% cover has a primary and secondary
                                    || ((cover == LosEffects.COVER_HORIZONTAL)
<span class="nc bnc" id="L10734" title="All 2 branches missed.">                                    &amp;&amp; (le.getDamagableCoverTypeSecondary() != LosEffects.DAMAGABLE_COVER_NONE))) {</span>
                                // Horizontal cover provided by two 25%'s,
                                // so primary and secondary
<span class="nc" id="L10737">                                int hitLoc = hit.getLocation();</span>
                                // Primary stores the left side, from the
                                // perspective of the attacker
<span class="nc bnc" id="L10740" title="All 6 branches missed.">                                if ((hitLoc == Mech.LOC_RLEG) || (hitLoc == Mech.LOC_RT)</span>
                                        || (hitLoc == Mech.LOC_RARM)) {
                                    // Left side is primary
<span class="nc" id="L10743">                                    damageableCoverType = le.getDamagableCoverTypePrimary();</span>
<span class="nc" id="L10744">                                    coverDropship = le.getCoverDropshipPrimary();</span>
<span class="nc" id="L10745">                                    coverLoc = le.getCoverLocPrimary();</span>
                                } else {
                                    // If not left side, then right side,
                                    // which is secondary
<span class="nc" id="L10749">                                    damageableCoverType = le.getDamagableCoverTypeSecondary();</span>
<span class="nc" id="L10750">                                    coverDropship = le.getCoverDropshipSecondary();</span>
<span class="nc" id="L10751">                                    coverLoc = le.getCoverLocSecondary();</span>
                                }
<span class="nc" id="L10753">                            } else { // Only primary cover exists</span>
<span class="nc" id="L10754">                                damageableCoverType = le.getDamagableCoverTypePrimary();</span>
<span class="nc" id="L10755">                                coverDropship = le.getCoverDropshipPrimary();</span>
<span class="nc" id="L10756">                                coverLoc = le.getCoverLocPrimary();</span>
                            }

                            // Check if we need to damage the cover that
                            // absorbed
                            // the hit.
<span class="nc" id="L10762">                            Vector&lt;Report&gt; coverDamageReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L10763" title="All 2 branches missed.">                            if (damageableCoverType == LosEffects.DAMAGABLE_COVER_DROPSHIP) {</span>
<span class="nc" id="L10764">                                r = new Report(3465);</span>
<span class="nc" id="L10765">                                r.addDesc(coverDropship);</span>
<span class="nc" id="L10766">                                r.indent(1);</span>
<span class="nc" id="L10767">                                coverDamageReport = deliverInfernoMissiles(ae,</span>
                                        coverDropship, 1, CalledShot.CALLED_NONE);
<span class="nc" id="L10769">                                coverDamageReport.insertElementAt(r, 0);</span>
<span class="nc bnc" id="L10770" title="All 2 branches missed.">                                for (Report report : coverDamageReport) {</span>
<span class="nc" id="L10771">                                    report.indent(1);</span>
<span class="nc" id="L10772">                                }</span>
<span class="nc bnc" id="L10773" title="All 2 branches missed.">                            } else if (damageableCoverType == LosEffects.DAMAGABLE_COVER_BUILDING) {</span>
<span class="nc" id="L10774">                                BuildingTarget bldgTrgt = new BuildingTarget(coverLoc,</span>
<span class="nc" id="L10775">                                        game.getBoard(), false);</span>
<span class="nc" id="L10776">                                coverDamageReport = deliverInfernoMissiles(ae, bldgTrgt, 1,</span>
                                        CalledShot.CALLED_NONE);
                            }
<span class="nc bnc" id="L10779" title="All 2 branches missed.">                            for (Report report : coverDamageReport) {</span>
<span class="nc" id="L10780">                                report.indent(1);</span>
<span class="nc" id="L10781">                            }</span>
<span class="nc" id="L10782">                            coverDamageReports.addAll(coverDamageReport);</span>
<span class="nc" id="L10783">                        } else { // No partial cover, missile hits</span>
<span class="nc bnc" id="L10784" title="All 2 branches missed.">                            if ((te.getArmor(hit) &gt; 0)</span>
<span class="nc bnc" id="L10785" title="All 2 branches missed.">                                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HEAT_DISSIPATING)) {</span>
<span class="nc" id="L10786">                                heatDamage += 1;</span>
<span class="nc" id="L10787">                                heatReduced = true;</span>
<span class="nc" id="L10788">                                reductionCause = EquipmentType.armorNames[te</span>
<span class="nc" id="L10789">                                        .getArmorType(hit.getLocation())];</span>
                            } else {
<span class="nc" id="L10791">                                heatDamage += 2;</span>
                            }
                        }
                    }
<span class="nc bnc" id="L10795" title="All 2 branches missed.">                    if (heatReduced) {</span>
<span class="nc" id="L10796">                        r = new Report(3406);</span>
<span class="nc" id="L10797">                        r.add(heatDamage);</span>
<span class="nc" id="L10798">                        r.subject = te.getId();</span>
<span class="nc" id="L10799">                        r.indent(2);</span>
<span class="nc" id="L10800">                        r.choose(true);</span>
<span class="nc" id="L10801">                        r.add(missiles * 2);</span>
<span class="nc" id="L10802">                        r.add(reductionCause);</span>
                    } else {
<span class="nc" id="L10804">                        r = new Report(3400);</span>
<span class="nc" id="L10805">                        r.add(heatDamage);</span>
<span class="nc" id="L10806">                        r.subject = te.getId();</span>
<span class="nc" id="L10807">                        r.indent(2);</span>
<span class="nc" id="L10808">                        r.choose(true);</span>
                    }
<span class="nc" id="L10810">                    vPhaseReport.add(r);</span>
<span class="nc" id="L10811">                    Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10812">                    te.heatFromExternal += heatDamage;</span>

<span class="nc bnc" id="L10814" title="All 2 branches missed.">                    if (missiles != m) {</span>
<span class="nc" id="L10815">                        r = new Report(3403);</span>
<span class="nc" id="L10816">                        r.add(m - missiles);</span>
<span class="nc" id="L10817">                        r.indent(2);</span>
<span class="nc" id="L10818">                        r.subject = te.getId();</span>
<span class="nc" id="L10819">                        vPhaseReport.add(r);</span>
                    }
<span class="nc" id="L10821">                    vPhaseReport.addAll(coverDamageReports);</span>
<span class="nc" id="L10822">                    Report.addNewline(vPhaseReport);</span>
<span class="nc bnc" id="L10823" title="All 2 branches missed.">                } else if (te.tracksHeat()) {</span>
                    // ASFs and small craft
<span class="nc" id="L10825">                    r = new Report(3400);</span>
<span class="nc" id="L10826">                    r.add(2 * missiles);</span>
<span class="nc" id="L10827">                    r.subject = te.getId();</span>
<span class="nc" id="L10828">                    r.indent(2);</span>
<span class="nc" id="L10829">                    r.choose(true);</span>
<span class="nc" id="L10830">                    vPhaseReport.add(r);</span>
<span class="nc" id="L10831">                    te.heatFromExternal += 2 * missiles;</span>
<span class="nc" id="L10832">                    Report.addNewline(vPhaseReport);</span>
<span class="nc bnc" id="L10833" title="All 2 branches missed.">                } else if (te instanceof GunEmplacement){</span>
<span class="nc" id="L10834">                    int direction = Compute.targetSideTable(ae, te, called);</span>
<span class="nc bnc" id="L10835" title="All 2 branches missed.">                    while (missiles-- &gt; 0) {</span>
<span class="nc" id="L10836">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, direction);</span>
<span class="nc" id="L10837">                        vPhaseReport.addAll(damageEntity(te, hit, 2));</span>
<span class="nc" id="L10838">                    }</span>
<span class="nc bnc" id="L10839" title="All 4 branches missed.">                } else if ((te instanceof Tank) || te.isSupportVehicle()) {</span>
<span class="nc" id="L10840">                    int direction = Compute.targetSideTable(ae, te, called);</span>
<span class="nc bnc" id="L10841" title="All 2 branches missed.">                    while (missiles-- &gt; 0) {</span>
<span class="nc" id="L10842">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, direction);</span>
<span class="nc" id="L10843">                        int critRollMod = 0;</span>
<span class="nc bnc" id="L10844" title="All 4 branches missed.">                        if (!te.isSupportVehicle() || (te.hasArmoredChassis()</span>
<span class="nc bnc" id="L10845" title="All 2 branches missed.">                                &amp;&amp; (te.getBARRating(hit.getLocation()) &gt; 9))) {</span>
<span class="nc" id="L10846">                            critRollMod -= 2;</span>
                        }
<span class="nc bnc" id="L10848" title="All 2 branches missed.">                        if ((te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED)</span>
<span class="nc bnc" id="L10849" title="All 2 branches missed.">                                &amp;&amp; (te.getArmor(hit.getLocation()) &gt; 0)) {</span>
<span class="nc" id="L10850">                            critRollMod -= 2;</span>
                        }
<span class="nc" id="L10852">                        vPhaseReport.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
                                critRollMod, 0, true));
<span class="nc" id="L10854">                    }</span>
<span class="nc bnc" id="L10855" title="All 2 branches missed.">                } else if (te instanceof ConvFighter) {</span>
                    // CFs take a point SI damage for every three missiles that hit.
                    // Use the heatFromExternal field to carry the remainder in case of multiple inferno hits.
<span class="nc" id="L10858">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10859" title="All 2 branches missed.">                    if (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10860">                        int siDamage = te.heatFromExternal / 3;</span>
<span class="nc" id="L10861">                        te.heatFromExternal %= 3;</span>
<span class="nc" id="L10862">                        final ConvFighter ftr = (ConvFighter) te;</span>
<span class="nc" id="L10863">                        int remaining = Math.max(0,  ftr.getSI() - siDamage);</span>
<span class="nc" id="L10864">                        r = new Report(9146);</span>
<span class="nc" id="L10865">                        r.subject = te.getId();</span>
<span class="nc" id="L10866">                        r.indent(2);</span>
<span class="nc" id="L10867">                        r.add(siDamage);</span>
<span class="nc" id="L10868">                        r.add(remaining);</span>
<span class="nc" id="L10869">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10870">                        ftr.setSI(remaining);</span>
<span class="nc" id="L10871">                        te.damageThisPhase += siDamage;</span>
<span class="nc bnc" id="L10872" title="All 2 branches missed.">                        if (remaining &lt;= 0) {</span>
                            // Lets auto-eject if we can!
<span class="nc bnc" id="L10874" title="All 2 branches missed.">                            if (ftr.isAutoEject()</span>
<span class="nc bnc" id="L10875" title="All 2 branches missed.">                                    &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L10876" title="All 2 branches missed.">                                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L10877" title="All 2 branches missed.">                                                &amp;&amp; ftr.isCondEjectSIDest()))) {</span>
<span class="nc" id="L10878">                                vPhaseReport.addAll(ejectEntity(te, true, false));</span>
                            }
<span class="nc" id="L10880">                            vPhaseReport.addAll(destroyEntity(te,&quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L10881">                            ftr.setSI(0);</span>
<span class="nc bnc" id="L10882" title="All 2 branches missed.">                            if (null != ae) {</span>
<span class="nc" id="L10883">                                creditKill(te, ae);</span>
                            }
                        }
<span class="nc" id="L10886">                    }</span>
<span class="nc bnc" id="L10887" title="All 2 branches missed.">                } else if (te.isLargeCraft()) {</span>
                    // Large craft ignore infernos
<span class="nc" id="L10889">                    r = new Report(1242);</span>
<span class="nc" id="L10890">                    r.subject = te.getId();</span>
<span class="nc" id="L10891">                    r.indent(2);</span>
<span class="nc" id="L10892">                    vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10893" title="All 2 branches missed.">                } else if (te instanceof Protomech) {</span>
<span class="nc" id="L10894">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10895" title="All 2 branches missed.">                    while (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10896">                        te.heatFromExternal -= 3;</span>
<span class="nc" id="L10897">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L10898" title="All 2 branches missed.">                        if (hit.getLocation() == Protomech.LOC_NMISS) {</span>
<span class="nc" id="L10899">                            Protomech proto = (Protomech) te;</span>
<span class="nc" id="L10900">                            r = new Report(6035);</span>
<span class="nc" id="L10901">                            r.subject = te.getId();</span>
<span class="nc" id="L10902">                            r.indent(2);</span>
<span class="nc bnc" id="L10903" title="All 2 branches missed.">                            if (proto.isGlider()) {</span>
<span class="nc" id="L10904">                                r.messageId = 6036;</span>
<span class="nc" id="L10905">                                proto.setWingHits(proto.getWingHits() + 1);</span>
                            }
<span class="nc" id="L10907">                            vPhaseReport.add(r);</span>
<span class="nc" id="L10908">                        } else {</span>
<span class="nc" id="L10909">                            r = new Report(6690);</span>
<span class="nc" id="L10910">                            r.subject = te.getId();</span>
<span class="nc" id="L10911">                            r.indent(2);</span>
<span class="nc" id="L10912">                            r.add(te.getLocationName(hit));</span>
<span class="nc" id="L10913">                            vPhaseReport.add(r);</span>
<span class="nc" id="L10914">                            te.destroyLocation(hit.getLocation());</span>
                            // Handle ProtoMech pilot damage
                            // due to location destruction
<span class="nc" id="L10917">                            int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L10918">                                       - ((Protomech) te).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L10919" title="All 2 branches missed.">                            if (hits &gt; 0) {</span>
<span class="nc" id="L10920">                                vPhaseReport.addAll(damageCrew(te, hits));</span>
<span class="nc" id="L10921">                                ((Protomech) te).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L10922">                                        Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                            }
<span class="nc bnc" id="L10924" title="All 2 branches missed.">                            if (te.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L10925">                                vPhaseReport.addAll(destroyEntity(te,</span>
                                        &quot;flaming inferno death&quot;, false, true));
<span class="nc" id="L10927">                                Report.addNewline(vPhaseReport);</span>
                            }
                        }
<span class="nc" id="L10930">                    }</span>
<span class="nc bnc" id="L10931" title="All 2 branches missed.">                } else if (te instanceof BattleArmor) {</span>
<span class="nc bnc" id="L10932" title="All 2 branches missed.">                    if (((BattleArmor) te).isFireResistant()) {</span>
<span class="nc" id="L10933">                        r = new Report(3395);</span>
<span class="nc" id="L10934">                        r.indent(2);</span>
<span class="nc" id="L10935">                        r.subject = te.getId();</span>
<span class="nc" id="L10936">                        r.addDesc(te);</span>
<span class="nc" id="L10937">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10938">                        return vPhaseReport;</span>
                    }
<span class="nc" id="L10940">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10941" title="All 2 branches missed.">                    while (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10942">                        te.heatFromExternal -= 3;</span>
<span class="nc" id="L10943">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10944">                        hit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L10945">                        vPhaseReport.addAll(damageEntity(te, hit, 1));</span>
<span class="nc" id="L10946">                        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10947">                    }</span>
<span class="nc bnc" id="L10948" title="All 2 branches missed.">                } else if (te instanceof Infantry) {</span>
<span class="nc" id="L10949">                    HitData hit = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc bnc" id="L10950" title="All 2 branches missed.">                    if (te.getInternal(hit) &gt; (3 * missiles)) {</span>
                        // internal structure absorbs all damage
<span class="nc" id="L10952">                        te.setInternal(te.getInternal(hit) - (3 * missiles), hit);</span>
<span class="nc" id="L10953">                        r = new Report(6065);</span>
<span class="nc" id="L10954">                        r.addDesc(te);</span>
<span class="nc" id="L10955">                        r.add(3 * missiles);</span>
<span class="nc" id="L10956">                        r.indent(2);</span>
<span class="nc" id="L10957">                        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L10958">                        r.newlines = 0;</span>
<span class="nc" id="L10959">                        r.subject = te.getId();</span>
<span class="nc" id="L10960">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10961">                        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10962">                        r = new Report(6095);</span>
<span class="nc" id="L10963">                        r.add(te.getInternal(hit));</span>
<span class="nc" id="L10964">                        r.subject = te.getId();</span>
<span class="nc" id="L10965">                        r.indent(3);</span>
<span class="nc" id="L10966">                        vPhaseReport.add(r);</span>
                    } else {
<span class="nc" id="L10968">                        vPhaseReport.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
<span class="nc" id="L10969">                        creditKill(te, ae);</span>
<span class="nc" id="L10970">                        Report.addNewline(vPhaseReport);</span>
                    }
                }
        }
<span class="nc" id="L10974">        return vPhaseReport;</span>
    }

    /**
     * Check for any detonations when an entity enters a minefield, except a
     * vibrabomb.
     *
     * @param entity
     *            - the &lt;code&gt;entity&lt;/code&gt; who entered the minefield
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the minefield
     * @param curElev
     *            - an &lt;code&gt;int&lt;/code&gt; for the elevation of the entity entering
     *            the minefield (used for underwater sea mines)
     * @param isOnGround
     *            - &lt;code&gt;true&lt;/code&gt; if the entity is not in the middle of a
     *            jump
     * @param vMineReport
     *            - the report vector that reports will be added to
     * @return - &lt;code&gt;true&lt;/code&gt; if the entity set off any mines
     */
    private boolean enterMinefield(Entity entity, Coords c, int curElev, boolean isOnGround,
                                   Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L10997">        return enterMinefield(entity, c, curElev, isOnGround, vMineReport, -1);</span>
    }

    /**
     * Check for any detonations when an entity enters a minefield, except a
     * vibrabomb.
     *
     * @param entity
     *            - the &lt;code&gt;entity&lt;/code&gt; who entered the minefield
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the minefield
     * @param curElev
     *            - an &lt;code&gt;int&lt;/code&gt; for the elevation of the entity entering
     *            the minefield (used for underwater sea mines)
     * @param isOnGround
     *            - &lt;code&gt;true&lt;/code&gt; if the entity is not in the middle of a
     *            jump
     * @param vMineReport
     *            - the report vector that reports will be added to
     * @param target
     *            - the &lt;code&gt;int&lt;/code&gt; target number for detonation. If this
     *            will be determined by density, it should be -1
     * @return - &lt;code&gt;true&lt;/code&gt; if the entity set off any mines
     */
    private boolean enterMinefield(Entity entity, Coords c, int curElev, boolean isOnGround,
                                   Vector&lt;Report&gt; vMineReport, int target) {
        Report r;
<span class="nc" id="L11024">        boolean trippedMine = false;</span>
        // flying units cannot trip a mine
<span class="nc bnc" id="L11026" title="All 2 branches missed.">        if (curElev &gt; 0) {</span>
<span class="nc" id="L11027">            return false;</span>
        }

        // Check for Mine sweepers
<span class="nc" id="L11031">        Mounted minesweeper = null;</span>
<span class="nc bnc" id="L11032" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L11033" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; m.isReady()</span>
<span class="nc bnc" id="L11034" title="All 2 branches missed.">                    &amp;&amp; (m.getArmorValue() &gt; 0)) {</span>
<span class="nc" id="L11035">                minesweeper = m;</span>
<span class="nc" id="L11036">                break; // Can only have one minesweeper</span>
            }
<span class="nc" id="L11038">        }</span>

<span class="nc" id="L11040">        Vector&lt;Minefield&gt; fieldsToRemove = new Vector&lt;&gt;();</span>
        // loop through mines in this hex
<span class="nc bnc" id="L11042" title="All 2 branches missed.">        for (Minefield mf : game.getMinefields(c)) {</span>

            // vibrabombs are handled differently
<span class="nc bnc" id="L11045" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L11046">                continue;</span>
            }

            // if we are in the water, then the sea mine will only blow up if at
            // the right depth
<span class="nc" id="L11051">            if (game.getBoard().getHex(mf.getCoords())</span>
<span class="nc bnc" id="L11052" title="All 2 branches missed.">                    .containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L11053" title="All 2 branches missed.">                if ((Math.abs(curElev) != mf.getDepth())</span>
<span class="nc" id="L11054">                    &amp;&amp; (Math.abs(curElev + entity.getHeight()) != mf</span>
<span class="nc bnc" id="L11055" title="All 2 branches missed.">                        .getDepth())) {</span>
<span class="nc" id="L11056">                    continue;</span>
                }
            }

            // Check for mine-sweeping.  Vibramines handled elsewhere
<span class="nc bnc" id="L11061" title="All 2 branches missed.">            if ((minesweeper != null)</span>
<span class="nc bnc" id="L11062" title="All 2 branches missed.">                    &amp;&amp; ((mf.getType() == Minefield.TYPE_CONVENTIONAL)</span>
<span class="nc bnc" id="L11063" title="All 2 branches missed.">                            || (mf.getType() == Minefield.TYPE_ACTIVE)</span>
<span class="nc bnc" id="L11064" title="All 2 branches missed.">                            || (mf.getType() == Minefield.TYPE_INFERNO))) {</span>
                // Check to see if the minesweeper clears
<span class="nc" id="L11066">                int roll = Compute.d6(2);</span>

                // Report minefield roll
<span class="nc bnc" id="L11069" title="All 2 branches missed.">                if (doBlind()) { // only report if DB, otherwise all players see</span>
<span class="nc" id="L11070">                r = new Report(2152);</span>
<span class="nc" id="L11071">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11072">                r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11073">                r.add(mf.getCoords().getBoardNum());</span>
<span class="nc" id="L11074">                r.add(roll);</span>
<span class="nc" id="L11075">                r.newlines = 0;</span>
<span class="nc" id="L11076">                vMineReport.add(r);</span>
                }

<span class="nc bnc" id="L11079" title="All 2 branches missed.">                if (roll &gt;= 6) {</span>
                    // Report hit
<span class="nc bnc" id="L11081" title="All 2 branches missed.">                    if (doBlind()) {</span>
<span class="nc" id="L11082">                        r = new Report(5543);</span>
<span class="nc" id="L11083">                        r.player = mf.getPlayerId();</span>
<span class="nc" id="L11084">                        vMineReport.add(r);</span>
                    }

                    // Clear the minefield
<span class="nc" id="L11088">                    r = new Report(2158);</span>
<span class="nc" id="L11089">                    r.subject = entity.getId();</span>
<span class="nc" id="L11090">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11091">                    r.add(Minefield.getDisplayableName(mf.getType()), true);</span>
<span class="nc" id="L11092">                    r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11093">                    r.indent();</span>
<span class="nc" id="L11094">                    vMineReport.add(r);</span>
<span class="nc" id="L11095">                    fieldsToRemove.add(mf);</span>

                    // Handle armor value damage
<span class="nc" id="L11098">                    int remainingAV = minesweeper.getArmorValue() - 6;</span>
<span class="nc" id="L11099">                    minesweeper.setArmorValue(Math.max(remainingAV, 0));</span>

<span class="nc" id="L11101">                    r = new Report(2161);</span>
<span class="nc" id="L11102">                    r.indent(2);</span>
<span class="nc" id="L11103">                    r.subject = entity.getId();</span>
<span class="nc" id="L11104">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11105">                    r.add(6);</span>
<span class="nc" id="L11106">                    r.add(Math.max(remainingAV, 0));</span>
<span class="nc" id="L11107">                    vMineReport.add(r);</span>

<span class="nc bnc" id="L11109" title="All 2 branches missed.">                    if (remainingAV &lt;= 0) {</span>
<span class="nc" id="L11110">                        minesweeper.setDestroyed(true);</span>
                    }
                    // Check for damage transfer
<span class="nc bnc" id="L11113" title="All 2 branches missed.">                    if (remainingAV &lt; 0) {</span>
<span class="nc" id="L11114">                        int damage = Math.abs(remainingAV);</span>
<span class="nc" id="L11115">                        r = new Report(2162);</span>
<span class="nc" id="L11116">                        r.indent(2);</span>
<span class="nc" id="L11117">                        r.subject = entity.getId();</span>
<span class="nc" id="L11118">                        r.add(damage, true);</span>
<span class="nc" id="L11119">                        vMineReport.add(r);</span>

                        // Damage is dealt to the location of minesweeper
<span class="nc" id="L11122">                        HitData hit = new HitData(minesweeper.getLocation());</span>
<span class="nc" id="L11123">                        Vector&lt;Report&gt; damageReports = damageEntity(entity, hit, damage);</span>
<span class="nc bnc" id="L11124" title="All 2 branches missed.">                        for (Report r1 : damageReports) {</span>
<span class="nc" id="L11125">                            r1.indent(1);</span>
<span class="nc" id="L11126">                        }</span>
<span class="nc" id="L11127">                        vMineReport.addAll(damageReports);</span>
                    }
<span class="nc" id="L11129">                    Report.addNewline(vMineReport);</span>
                    // If the minefield is cleared, we're done processing it
<span class="nc" id="L11131">                    continue;</span>
                } else {
                    // Report miss
<span class="nc bnc" id="L11134" title="All 2 branches missed.">                    if (doBlind()) {</span>
<span class="nc" id="L11135">                        r = new Report(5542);</span>
<span class="nc" id="L11136">                        r.player = mf.getPlayerId();</span>
<span class="nc" id="L11137">                        vMineReport.add(r);</span>
                    }
                }
            }

            // check whether we have an active mine
<span class="nc bnc" id="L11143" title="All 4 branches missed.">            if ((mf.getType() == Minefield.TYPE_ACTIVE) &amp;&amp; isOnGround) {</span>
<span class="nc" id="L11144">                continue;</span>
            }
<span class="nc bnc" id="L11146" title="All 4 branches missed.">            if ((mf.getType() != Minefield.TYPE_ACTIVE) &amp;&amp; !isOnGround) {</span>
<span class="nc" id="L11147">                continue;</span>
            }

            // set the target number
<span class="nc bnc" id="L11151" title="All 2 branches missed.">            if (target == -1) {</span>
<span class="nc" id="L11152">                target = mf.getTrigger();</span>
<span class="nc bnc" id="L11153" title="All 2 branches missed.">                if (mf.getType() == Minefield.TYPE_ACTIVE) {</span>
<span class="nc" id="L11154">                    target = 9;</span>
                }
<span class="nc bnc" id="L11156" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc" id="L11157">                    target += 1;</span>
                }
<span class="nc bnc" id="L11159" title="All 2 branches missed.">                if (entity.hasAbility(OptionsConstants.MISC_EAGLE_EYES)) {</span>
<span class="nc" id="L11160">                    target += 2;</span>
                }
<span class="nc bnc" id="L11162" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L11163" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L11164">                    target = 12;</span>
                }
            }

<span class="nc" id="L11168">            int roll = Compute.d6(2);</span>

            // Report minefield roll
<span class="nc bnc" id="L11171" title="All 2 branches missed.">            if (doBlind()) { // Only do if DB, otherwise all players will see</span>
<span class="nc" id="L11172">                r = new Report(2151);</span>
<span class="nc" id="L11173">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11174">                r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11175">                r.add(mf.getCoords().getBoardNum());</span>
<span class="nc" id="L11176">                r.add(target);</span>
<span class="nc" id="L11177">                r.add(roll);</span>
<span class="nc" id="L11178">                r.newlines = 0;</span>
<span class="nc" id="L11179">                vMineReport.add(r);</span>
            }

<span class="nc bnc" id="L11182" title="All 2 branches missed.">            if (roll &lt; target) {</span>
                // Report miss
<span class="nc bnc" id="L11184" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L11185">                    r = new Report(2217);</span>
<span class="nc" id="L11186">                    r.player = mf.getPlayerId();</span>
<span class="nc" id="L11187">                    vMineReport.add(r);</span>
                }
                continue;
            }

            // Report hit
<span class="nc bnc" id="L11193" title="All 2 branches missed.">            if (doBlind()) {</span>
<span class="nc" id="L11194">                r = new Report(2270);</span>
<span class="nc" id="L11195">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11196">                vMineReport.add(r);</span>
            }

            // apply damage
<span class="nc" id="L11200">            trippedMine = true;</span>
            // explodedMines.add(mf);
<span class="nc" id="L11202">            mf.setDetonated(true);</span>
<span class="nc bnc" id="L11203" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_INFERNO) {</span>
                // report hitting an inferno mine
<span class="nc" id="L11205">                r = new Report(2155);</span>
<span class="nc" id="L11206">                r.subject = entity.getId();</span>
<span class="nc" id="L11207">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11208">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11209">                r.indent();</span>
<span class="nc" id="L11210">                vMineReport.add(r);</span>
<span class="nc" id="L11211">                vMineReport.addAll(deliverInfernoMissiles(entity, entity, mf.getDensity() / 2));</span>
            } else {
<span class="nc" id="L11213">                r = new Report(2150);</span>
<span class="nc" id="L11214">                r.subject = entity.getId();</span>
<span class="nc" id="L11215">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11216">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11217">                r.indent();</span>
<span class="nc" id="L11218">                vMineReport.add(r);</span>
<span class="nc" id="L11219">                int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11220" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L11221">                    int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11222">                    damage = damage - cur_damage;</span>
                    HitData hit;
<span class="nc bnc" id="L11224" title="All 2 branches missed.">                    if (minesweeper == null) {</span>
<span class="nc" id="L11225">                        hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE,</span>
                                Minefield.TO_HIT_SIDE);
                    } else { // Minesweepers cause mines to hit minesweeper loc
<span class="nc" id="L11228">                        hit = new HitData(minesweeper.getLocation());</span>
                    }
<span class="nc" id="L11230">                    vMineReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11231">                }</span>
<span class="nc bnc" id="L11232" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
                    // Tanks check for motive system damage from minefields as
                    // from a side hit even though the damage proper hits the
                    // front above; exact side doesn't matter, though.
<span class="nc" id="L11236">                    vMineReport.addAll(vehicleMotiveDamage((Tank)entity,</span>
<span class="nc" id="L11237">                            entity.getMotiveSideMod(ToHitData.SIDE_LEFT)));</span>
                }
<span class="nc" id="L11239">                Report.addNewline(vMineReport);</span>
            }

            // check the direct reduction
<span class="nc" id="L11243">            mf.checkReduction(0, true);</span>
<span class="nc" id="L11244">            revealMinefield(mf);</span>
<span class="nc" id="L11245">        }</span>

<span class="nc bnc" id="L11247" title="All 2 branches missed.">        for (Minefield mf : fieldsToRemove) {</span>
<span class="nc" id="L11248">            removeMinefield(mf);</span>
<span class="nc" id="L11249">        }</span>

<span class="nc" id="L11251">        return trippedMine;</span>
    }

    /**
     * cycle through all mines on the board, check to see whether they should do
     * collateral damage to other mines due to detonation, resets detonation to
     * false, and removes any mines whose density has been reduced to zero.
     */
    private void resetMines() {
<span class="nc" id="L11260">        Enumeration&lt;Coords&gt; mineLoc = game.getMinedCoords();</span>
<span class="nc bnc" id="L11261" title="All 2 branches missed.">        while (mineLoc.hasMoreElements()) {</span>
<span class="nc" id="L11262">            Coords c = mineLoc.nextElement();</span>
<span class="nc" id="L11263">            Enumeration&lt;Minefield&gt; minefields = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11264" title="All 2 branches missed.">            while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L11265">                Minefield minefield = minefields.nextElement();</span>
<span class="nc bnc" id="L11266" title="All 2 branches missed.">                if (minefield.hasDetonated()) {</span>
<span class="nc" id="L11267">                    minefield.setDetonated(false);</span>
<span class="nc" id="L11268">                    Enumeration&lt;Minefield&gt; otherMines = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11269" title="All 2 branches missed.">                    while (otherMines.hasMoreElements()) {</span>
<span class="nc" id="L11270">                        Minefield otherMine = otherMines.nextElement();</span>
<span class="nc bnc" id="L11271" title="All 2 branches missed.">                        if (otherMine.equals(minefield)) {</span>
<span class="nc" id="L11272">                            continue;</span>
                        }
<span class="nc" id="L11274">                        int bonus = 0;</span>
<span class="nc bnc" id="L11275" title="All 2 branches missed.">                        if (otherMine.getDensity() &gt; minefield.getDensity()) {</span>
<span class="nc" id="L11276">                            bonus = 1;</span>
                        }
<span class="nc bnc" id="L11278" title="All 2 branches missed.">                        if (otherMine.getDensity() &lt; minefield.getDensity()) {</span>
<span class="nc" id="L11279">                            bonus = -1;</span>
                        }
<span class="nc" id="L11281">                        otherMine.checkReduction(bonus, false);</span>
<span class="nc" id="L11282">                    }</span>
                }
<span class="nc" id="L11284">            }</span>
            // cycle through a second time to see if any mines at these coords
            // need to be removed
<span class="nc" id="L11287">            List&lt;Minefield&gt; mfRemoved = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L11288">            Enumeration&lt;Minefield&gt; mines = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11289" title="All 2 branches missed.">            while (mines.hasMoreElements()) {</span>
<span class="nc" id="L11290">                Minefield mine = mines.nextElement();</span>
<span class="nc bnc" id="L11291" title="All 2 branches missed.">                if (mine.getDensity() &lt; 5) {</span>
<span class="nc" id="L11292">                    mfRemoved.add(mine);</span>
                }
<span class="nc" id="L11294">            }</span>
            // we have to do it this way to avoid a concurrent error problem
<span class="nc bnc" id="L11296" title="All 2 branches missed.">            for (Minefield mf : mfRemoved) {</span>
<span class="nc" id="L11297">                removeMinefield(mf);</span>
<span class="nc" id="L11298">            }</span>
            // update the mines at these coords
<span class="nc" id="L11300">            sendChangedMines(c);</span>
<span class="nc" id="L11301">        }</span>
<span class="nc" id="L11302">    }</span>

    /**
     * attempt to clear a minefield
     *
     * @param mf     - a &lt;code&gt;Minefield&lt;/code&gt; to clear
     * @param en     - &lt;code&gt;entity&lt;/code&gt; doing the clearing
     * @param target - &lt;code&gt;int&lt;/code&gt; needed to roll for a successful clearance
     * @return &lt;code&gt;true&lt;/code&gt; if clearance successful
     */
    public boolean clearMinefield(Minefield mf, Entity en, int target,
                                  Vector&lt;Report&gt; vClearReport) {
<span class="nc" id="L11314">        return clearMinefield(mf, en, target, -1, vClearReport, 2);</span>
    }

    public boolean clearMinefield(Minefield mf, Entity en, int target,
                                  int botch, Vector&lt;Report&gt; vClearReport) {
<span class="nc" id="L11319">        return clearMinefield(mf, en, target, botch, vClearReport, 1);</span>
    }

    /**
     * attempt to clear a minefield We don't actually remove the minefield here,
     * because if this is called up from within a loop, that will cause problems
     *
     * @param mf
     *            - a &lt;code&gt;Minefield&lt;/code&gt; to clear
     * @param en
     *            - &lt;code&gt;entity&lt;/code&gt; doing the clearing
     * @param target
     *            - &lt;code&gt;int&lt;/code&gt; needed to roll for a successful clearance
     * @param botch
     *            - &lt;code&gt;int&lt;/code&gt; that indicates an accidental detonation
     * @param vClearReport
     *            - The report collection to report to
     * @param indent
     *            - The number of indents for the report
     * @return &lt;code&gt;true&lt;/code&gt; if clearance successful
     */
    public boolean clearMinefield(Minefield mf, Entity en, int target,
            int botch, Vector&lt;Report&gt; vClearReport, int indent) {
        Report r;
<span class="nc" id="L11343">        int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L11344" title="All 2 branches missed.">        if (roll &gt;= target) {</span>
<span class="nc" id="L11345">            r = new Report(2250);</span>
<span class="nc" id="L11346">            r.subject = en.getId();</span>
<span class="nc" id="L11347">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11348">            r.add(target);</span>
<span class="nc" id="L11349">            r.add(roll);</span>
<span class="nc" id="L11350">            r.indent(indent);</span>
<span class="nc" id="L11351">            vClearReport.add(r);</span>
<span class="nc" id="L11352">            return true;</span>
<span class="nc bnc" id="L11353" title="All 2 branches missed.">        } else if (roll &lt;= botch) {</span>
            // TODO : detonate the minefield
<span class="nc" id="L11355">            r = new Report(2255);</span>
<span class="nc" id="L11356">            r.subject = en.getId();</span>
<span class="nc" id="L11357">            r.indent(indent);</span>
<span class="nc" id="L11358">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11359">            r.add(target);</span>
<span class="nc" id="L11360">            r.add(roll);</span>
<span class="nc" id="L11361">            vClearReport.add(r);</span>
            // The detonation damages any units that were also attempting to
            // clear mines in the same hex
<span class="nc bnc" id="L11364" title="All 2 branches missed.">            for (Entity victim : game.getEntitiesVector(mf.getCoords())) {</span>
                Report rVictim;
<span class="nc bnc" id="L11366" title="All 2 branches missed.">                if (victim.isClearingMinefield()) {</span>
<span class="nc" id="L11367">                    rVictim = new Report(2265);</span>
<span class="nc" id="L11368">                    rVictim.subject = victim.getId();</span>
<span class="nc" id="L11369">                    rVictim.add(victim.getShortName(), true);</span>
<span class="nc" id="L11370">                    rVictim.indent(indent + 1);</span>
<span class="nc" id="L11371">                    vClearReport.add(rVictim);</span>
<span class="nc" id="L11372">                    int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11373" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L11374">                        int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11375">                        damage = damage - cur_damage;</span>
<span class="nc" id="L11376">                        HitData hit = victim.rollHitLocation(</span>
                                Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);
<span class="nc" id="L11378">                        vClearReport.addAll(damageEntity(victim, hit, cur_damage));</span>
<span class="nc" id="L11379">                    }</span>
                }
<span class="nc" id="L11381">            }</span>
            // reduction works differently here
<span class="nc bnc" id="L11383" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L11384">                mf.setDensity(Math.max(5, mf.getDensity() - 5));</span>
            } else {
                // congratulations, you cleared the mine by blowing yourself up
<span class="nc" id="L11387">                return true;</span>
            }
        } else {
            // failure
<span class="nc" id="L11391">            r = new Report(2260);</span>
<span class="nc" id="L11392">            r.subject = en.getId();</span>
<span class="nc" id="L11393">            r.indent(indent);</span>
<span class="nc" id="L11394">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11395">            r.add(target);</span>
<span class="nc" id="L11396">            r.add(roll);</span>
<span class="nc" id="L11397">            vClearReport.add(r);</span>
        }
<span class="nc" id="L11399">        return false;</span>
    }

    /**
     * Clear any detonated mines at these coords
     */
    private void clearDetonatedMines(Coords c, int target) {
<span class="nc" id="L11406">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(c).elements();</span>
<span class="nc" id="L11407">        List&lt;Minefield&gt; mfRemoved = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L11408" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L11409">            Minefield minefield = minefields.nextElement();</span>
<span class="nc bnc" id="L11410" title="All 4 branches missed.">            if (minefield.hasDetonated() &amp;&amp; (Compute.d6(2) &gt;= target)) {</span>
<span class="nc" id="L11411">                mfRemoved.add(minefield);</span>
            }
<span class="nc" id="L11413">        }</span>
        // we have to do it this way to avoid a concurrent error problem
<span class="nc bnc" id="L11415" title="All 2 branches missed.">        for (Minefield mf : mfRemoved) {</span>
<span class="nc" id="L11416">            removeMinefield(mf);</span>
<span class="nc" id="L11417">        }</span>
<span class="nc" id="L11418">    }</span>

    /**
     * Checks to see if an entity sets off any vibrabombs.
     */
    private boolean checkVibrabombs(Entity entity, Coords coords, boolean displaced,
                                    Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11425">        return checkVibrabombs(entity, coords, displaced, null, null, vMineReport);</span>
    }

    /**
     * Checks to see if an entity sets off any vibrabombs.
     */
    private boolean checkVibrabombs(Entity entity, Coords coords, boolean displaced, Coords lastPos,
                                    Coords curPos, Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11433">        int mass = (int) entity.getWeight();</span>

        // Check for Mine sweepers
<span class="nc" id="L11436">        Mounted minesweeper = null;</span>
<span class="nc bnc" id="L11437" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L11438" title="All 6 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; m.isReady() &amp;&amp; (m.getArmorValue() &gt; 0)) {</span>
<span class="nc" id="L11439">                minesweeper = m;</span>
<span class="nc" id="L11440">                break; // Can only have one minesweeper</span>
            }
<span class="nc" id="L11442">        }</span>

        // Check for minesweepers sweeping VB minefields
<span class="nc bnc" id="L11445" title="All 2 branches missed.">        if (minesweeper != null) {</span>
<span class="nc" id="L11446">            Vector&lt;Minefield&gt; fieldsToRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L11447" title="All 2 branches missed.">            for (Minefield mf : game.getVibrabombs()) {</span>
                // Ignore mines if they aren't in this position
<span class="nc bnc" id="L11449" title="All 2 branches missed.">                if (!mf.getCoords().equals(coords)) {</span>
<span class="nc" id="L11450">                    continue;</span>
                }

                // Minesweepers on units within 9 tons of the vibrafield setting
                // automatically clear the minefield
<span class="nc bnc" id="L11455" title="All 2 branches missed.">                if (Math.abs(mass - mf.getSetting()) &lt; 10) {</span>
                    // Clear the minefield
                    Report r;
<span class="nc" id="L11458">                    r = new Report(2158);</span>
<span class="nc" id="L11459">                    r.subject = entity.getId();</span>
<span class="nc" id="L11460">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11461">                    r.add(Minefield.getDisplayableName(mf.getType()), true);</span>
<span class="nc" id="L11462">                    r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11463">                    r.indent();</span>
<span class="nc" id="L11464">                    vMineReport.add(r);</span>
<span class="nc" id="L11465">                    fieldsToRemove.add(mf);</span>

                    // Handle armor value damage
<span class="nc" id="L11468">                    int remainingAV = minesweeper.getArmorValue() - 10;</span>
<span class="nc" id="L11469">                    minesweeper.setArmorValue(Math.max(remainingAV, 0));</span>

<span class="nc" id="L11471">                    r = new Report(2161);</span>
<span class="nc" id="L11472">                    r.indent(2);</span>
<span class="nc" id="L11473">                    r.subject = entity.getId();</span>
<span class="nc" id="L11474">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11475">                    r.add(10);</span>
<span class="nc" id="L11476">                    r.add(Math.max(remainingAV, 0));</span>
<span class="nc" id="L11477">                    vMineReport.add(r);</span>

<span class="nc bnc" id="L11479" title="All 2 branches missed.">                    if (remainingAV &lt;= 0) {</span>
<span class="nc" id="L11480">                        minesweeper.setDestroyed(true);</span>
                    }
                    // Check for damage transfer
<span class="nc bnc" id="L11483" title="All 2 branches missed.">                    if (remainingAV &lt; 0) {</span>
<span class="nc" id="L11484">                        int damage = Math.abs(remainingAV);</span>
<span class="nc" id="L11485">                        r = new Report(2162);</span>
<span class="nc" id="L11486">                        r.indent(2);</span>
<span class="nc" id="L11487">                        r.subject = entity.getId();</span>
<span class="nc" id="L11488">                        r.add(damage, true);</span>
<span class="nc" id="L11489">                        vMineReport.add(r);</span>

                        // Damage is dealt to the location of minesweeper
<span class="nc" id="L11492">                        HitData hit = new HitData(minesweeper.getLocation());</span>
<span class="nc" id="L11493">                        Vector&lt;Report&gt; damageReports = damageEntity(entity, hit, damage);</span>
<span class="nc bnc" id="L11494" title="All 2 branches missed.">                        for (Report r1 : damageReports) {</span>
<span class="nc" id="L11495">                            r1.indent(1);</span>
<span class="nc" id="L11496">                        }</span>
<span class="nc" id="L11497">                        vMineReport.addAll(damageReports);</span>
<span class="nc" id="L11498">                        entity.applyDamage();</span>
                    }
<span class="nc" id="L11500">                    Report.addNewline(vMineReport);</span>
                }
<span class="nc" id="L11502">            }</span>
<span class="nc bnc" id="L11503" title="All 2 branches missed.">            for (Minefield mf : fieldsToRemove) {</span>
<span class="nc" id="L11504">                removeMinefield(mf);</span>
<span class="nc" id="L11505">            }</span>
        }


<span class="nc" id="L11509">        boolean boom = false;</span>
        // Only mechs can set off vibrabombs. QuadVees should only be able to set off a
        // vibrabomb in Mech mode. Those that are converting to or from Mech mode should
        // are using leg movement and should be able to set them off.
<span class="nc bnc" id="L11513" title="All 4 branches missed.">        if (!(entity instanceof Mech) || (entity instanceof QuadVee</span>
<span class="nc bnc" id="L11514" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</span>
<span class="nc bnc" id="L11515" title="All 2 branches missed.">                &amp;&amp; !entity.isConvertingNow())) {</span>
<span class="nc" id="L11516">            return false;</span>
        }

<span class="nc" id="L11519">        Enumeration&lt;Minefield&gt; e = game.getVibrabombs().elements();</span>

<span class="nc bnc" id="L11521" title="All 2 branches missed.">        while (e.hasMoreElements()) {</span>
<span class="nc" id="L11522">            Minefield mf = e.nextElement();</span>

            // Bug 954272: Mines shouldn't work underwater, and BMRr says
            // Vibrabombs are mines
<span class="nc bnc" id="L11526" title="All 2 branches missed.">            if (game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L11527" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L11528" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L11529">                continue;</span>
            }

            // Mech weighing 10 tons or less can't set off the bomb
<span class="nc bnc" id="L11533" title="All 2 branches missed.">            if (mass &lt;= (mf.getSetting() - 10)) {</span>
<span class="nc" id="L11534">                continue;</span>
            }

<span class="nc" id="L11537">            int effectiveDistance = (mass - mf.getSetting()) / 10;</span>
<span class="nc" id="L11538">            int actualDistance = coords.distance(mf.getCoords());</span>

<span class="nc bnc" id="L11540" title="All 2 branches missed.">            if (actualDistance &lt;= effectiveDistance) {</span>
<span class="nc" id="L11541">                Report r = new Report(2156);</span>
<span class="nc" id="L11542">                r.subject = entity.getId();</span>
<span class="nc" id="L11543">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11544">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11545">                vMineReport.add(r);</span>
                
                // if the moving entity is not actually moving into the vibrabomb
                // hex, it won't get damaged
<span class="nc" id="L11549">                Integer excludeEntityID = null;</span>
<span class="nc bnc" id="L11550" title="All 2 branches missed.">                if (!coords.equals(mf.getCoords())) {</span>
<span class="nc" id="L11551">                    excludeEntityID = entity.getId();</span>
                }
                    
<span class="nc" id="L11554">                explodeVibrabomb(mf, vMineReport, false, excludeEntityID);</span>
            }

            // Hack; when moving, the Mech isn't in the hex during
            // the movement.
<span class="nc bnc" id="L11559" title="All 4 branches missed.">            if (!displaced &amp;&amp; (actualDistance == 0)) {</span>
                // report getting hit by vibrabomb
<span class="nc" id="L11561">                Report r = new Report(2160);</span>
<span class="nc" id="L11562">                r.subject = entity.getId();</span>
<span class="nc" id="L11563">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11564">                vMineReport.add(r);</span>
<span class="nc" id="L11565">                int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11566" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L11567">                    int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11568">                    damage = damage - cur_damage;</span>
<span class="nc" id="L11569">                    HitData hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);</span>
<span class="nc" id="L11570">                    vMineReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11571">                }</span>
<span class="nc" id="L11572">                vMineReport.addAll(resolvePilotingRolls(entity, true, lastPos, curPos));</span>
                // we need to apply Damage now, in case the entity lost a leg,
                // otherwise it won't get a leg missing mod if it hasn't yet
                // moved and lost a leg, see bug 1071434 for an example
<span class="nc" id="L11576">                entity.applyDamage();</span>
            }

            // don't check for reduction until the end or units in the same hex
            // through
            // movement will get the reduced damage
<span class="nc bnc" id="L11582" title="All 2 branches missed.">            if (mf.hasDetonated()) {</span>
<span class="nc" id="L11583">                boom = true;</span>
<span class="nc" id="L11584">                mf.checkReduction(0, true);</span>
            }

<span class="nc" id="L11587">        }</span>
<span class="nc" id="L11588">        return boom;</span>
    }

    /**
     * Removes the minefield from the game.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to remove
     */
    public void removeMinefield(Minefield mf) {
<span class="nc bnc" id="L11597" title="All 2 branches missed.">        if (game.containsVibrabomb(mf)) {</span>
<span class="nc" id="L11598">            game.removeVibrabomb(mf);</span>
        }
<span class="nc" id="L11600">        game.removeMinefield(mf);</span>

<span class="nc" id="L11602">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc bnc" id="L11603" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L11604">            IPlayer player = players.nextElement();</span>
<span class="nc" id="L11605">            removeMinefield(player, mf);</span>
<span class="nc" id="L11606">        }</span>
<span class="nc" id="L11607">    }</span>

    /**
     * Removes the minefield from a player.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; whose minefield should be removed
     * @param mf     The &lt;code&gt;Minefield&lt;/code&gt; to be removed
     */
    private void removeMinefield(IPlayer player, Minefield mf) {
<span class="nc bnc" id="L11616" title="All 2 branches missed.">        if (player.containsMinefield(mf)) {</span>
<span class="nc" id="L11617">            player.removeMinefield(mf);</span>
<span class="nc" id="L11618">            send(player.getId(), new Packet(Packet.COMMAND_REMOVE_MINEFIELD, mf));</span>
        }
<span class="nc" id="L11620">    }</span>

    /**
     * Reveals a minefield for all players.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to be revealed
     */
    private void revealMinefield(Minefield mf) {
<span class="nc" id="L11628">        Enumeration&lt;Team&gt; teams = game.getTeams();</span>
<span class="nc bnc" id="L11629" title="All 2 branches missed.">        while (teams.hasMoreElements()) {</span>
<span class="nc" id="L11630">            Team team = teams.nextElement();</span>
<span class="nc" id="L11631">            revealMinefield(team, mf);</span>
<span class="nc" id="L11632">        }</span>
<span class="nc" id="L11633">    }</span>

    /**
     * Reveals a minefield for all players on a team.
     *
     * @param team The &lt;code&gt;team&lt;/code&gt; whose minefield should be revealed
     * @param mf   The &lt;code&gt;Minefield&lt;/code&gt; to be revealed
     */
    private void revealMinefield(Team team, Minefield mf) {
<span class="nc" id="L11642">        Enumeration&lt;IPlayer&gt; players = team.getPlayers();</span>
<span class="nc bnc" id="L11643" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L11644">            IPlayer player = players.nextElement();</span>
<span class="nc bnc" id="L11645" title="All 2 branches missed.">            if (!player.containsMinefield(mf)) {</span>
<span class="nc" id="L11646">                player.addMinefield(mf);</span>
<span class="nc" id="L11647">                send(player.getId(), new Packet(Packet.COMMAND_REVEAL_MINEFIELD, mf));</span>
            }
<span class="nc" id="L11649">        }</span>
<span class="nc" id="L11650">    }</span>

    /**
     * checks whether a newly set mine should be revealed to players based on
     * LOS. If so, then it reveals the mine
     */
    private void checkForRevealMinefield(Minefield mf, Entity layer) {
<span class="nc" id="L11657">        Enumeration&lt;Team&gt; teams = game.getTeams();</span>
        // loop through each team and determine if they can see the mine, then
        // loop through players on team
        // and reveal the mine
<span class="nc bnc" id="L11661" title="All 2 branches missed.">        while (teams.hasMoreElements()) {</span>
<span class="nc" id="L11662">            Team team = teams.nextElement();</span>
<span class="nc" id="L11663">            boolean canSee = false;</span>

            // the players own team can always see the mine
<span class="nc bnc" id="L11666" title="All 2 branches missed.">            if (team.equals(game.getTeamForPlayer(game.getPlayer(mf.getPlayerId())))) {</span>
<span class="nc" id="L11667">                canSee = true;</span>
            } else {
                // need to loop through all entities on this team and find the
                // one with the best shot of seeing
                // the mine placement
<span class="nc" id="L11672">                int target = Integer.MAX_VALUE;</span>
<span class="nc" id="L11673">                Iterator&lt;Entity&gt; entities = game.getEntities();</span>
<span class="nc bnc" id="L11674" title="All 2 branches missed.">                while (entities.hasNext()) {</span>
<span class="nc" id="L11675">                    Entity en = entities.next();</span>
                    // are we on the right team?
<span class="nc bnc" id="L11677" title="All 2 branches missed.">                    if (!team.equals(game.getTeamForPlayer(en.getOwner()))) {</span>
<span class="nc" id="L11678">                        continue;</span>
                    }
<span class="nc" id="L11680">                    if (LosEffects.calculateLos(game, en.getId(),</span>
<span class="nc" id="L11681">                            new HexTarget(mf.getCoords(), game.getBoard(),</span>
<span class="nc bnc" id="L11682" title="All 2 branches missed.">                                    Targetable.TYPE_HEX_CLEAR)).canSee()) {</span>
<span class="nc" id="L11683">                        target = 0;</span>
<span class="nc" id="L11684">                        break;</span>
                    }
<span class="nc" id="L11686">                    LosEffects los = LosEffects.calculateLos(game, en.getId(), layer);</span>
<span class="nc bnc" id="L11687" title="All 2 branches missed.">                    if (los.canSee()) {</span>
                        // TODO : need to add mods
<span class="nc" id="L11689">                        ToHitData current = new ToHitData(4, &quot;base&quot;);</span>
<span class="nc" id="L11690">                        current.append(Compute.getAttackerMovementModifier(game, en.getId()));</span>
<span class="nc" id="L11691">                        current.append(Compute.getTargetMovementModifier(game, layer.getId()));</span>
<span class="nc" id="L11692">                        current.append(los.losModifiers(game));</span>
<span class="nc bnc" id="L11693" title="All 2 branches missed.">                        if (current.getValue() &lt; target) {</span>
<span class="nc" id="L11694">                            target = current.getValue();</span>
                        }
                    }
<span class="nc" id="L11697">                }</span>

<span class="nc bnc" id="L11699" title="All 2 branches missed.">                if (Compute.d6(2) &gt;= target) {</span>
<span class="nc" id="L11700">                    canSee = true;</span>
                }
            }
<span class="nc bnc" id="L11703" title="All 2 branches missed.">            if (canSee) {</span>
<span class="nc" id="L11704">                revealMinefield(team, mf);</span>
            }
<span class="nc" id="L11706">        }</span>
<span class="nc" id="L11707">    }</span>

    /**
     * Explodes a vibrabomb.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to explode
     */
    private void explodeVibrabomb(Minefield mf, Vector&lt;Report&gt; vBoomReport, boolean reduce, Integer entityToExclude) {
<span class="nc" id="L11715">        Iterator&lt;Entity&gt; targets = game.getEntities(mf.getCoords());</span>
        Report r;

<span class="nc bnc" id="L11718" title="All 2 branches missed.">        while (targets.hasNext()) {</span>
<span class="nc" id="L11719">            Entity entity = targets.next();</span>

            // Airborne entities wont get hit by the mines...
<span class="nc bnc" id="L11722" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L11723">                continue;</span>
            }

            // check for the OptionsConstants.ADVGRNDMOV_NO_PREMOVE_VIBRA option
            // If it's set, and the target has not yet moved,
            // it doesn't get damaged.
<span class="nc bnc" id="L11729" title="All 2 branches missed.">            if (!entity.isDone()</span>
<span class="nc bnc" id="L11730" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_PREMOVE_VIBRA)) {</span>
<span class="nc" id="L11731">                r = new Report(2157);</span>
<span class="nc" id="L11732">                r.subject = entity.getId();</span>
<span class="nc" id="L11733">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11734">                vBoomReport.add(r);</span>
<span class="nc" id="L11735">                continue;</span>
            }
            
            // the &quot;currently moving entity&quot; may not be in the same hex, so it needs to be excluded
<span class="nc bnc" id="L11739" title="All 4 branches missed.">            if ((entityToExclude != null) &amp;&amp; (entity.getId() == entityToExclude)) {</span>
                // report not hitting vibrabomb
<span class="nc" id="L11741">                r = new Report(2157);</span>
<span class="nc" id="L11742">                r.subject = entity.getId();</span>
<span class="nc" id="L11743">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11744">                vBoomReport.add(r);</span>
<span class="nc" id="L11745">                continue;</span>
            } else {
                // report hitting vibrabomb
<span class="nc" id="L11748">                r = new Report(2160);</span>
<span class="nc" id="L11749">                r.subject = entity.getId();</span>
<span class="nc" id="L11750">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11751">                vBoomReport.add(r);</span>
            }
            
<span class="nc" id="L11754">            int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11755" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L11756">                int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11757">                damage = damage - cur_damage;</span>
<span class="nc" id="L11758">                HitData hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);</span>
<span class="nc" id="L11759">                vBoomReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11760">            }</span>
<span class="nc" id="L11761">            Report.addNewline(vBoomReport);</span>

<span class="nc bnc" id="L11763" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L11764">                vBoomReport.addAll(vehicleMotiveDamage((Tank)entity,</span>
<span class="nc" id="L11765">                        entity.getMotiveSideMod(ToHitData.SIDE_LEFT)));</span>
            }
<span class="nc" id="L11767">            vBoomReport.addAll(resolvePilotingRolls(entity, true, entity.getPosition(),</span>
<span class="nc" id="L11768">                    entity.getPosition()));</span>
            // we need to apply Damage now, in case the entity lost a leg,
            // otherwise it won't get a leg missing mod if it hasn't yet
            // moved and lost a leg, see bug 1071434 for an example
<span class="nc" id="L11772">            game.resetPSRs(entity);</span>
<span class="nc" id="L11773">            entity.applyDamage();</span>
<span class="nc" id="L11774">            Report.addNewline(vBoomReport);</span>
<span class="nc" id="L11775">            entityUpdate(entity.getId());</span>
<span class="nc" id="L11776">        }</span>

        // check the direct reduction of mine
<span class="nc bnc" id="L11779" title="All 2 branches missed.">        if (reduce) {</span>
<span class="nc" id="L11780">            mf.checkReduction(0, true);</span>
        }
<span class="nc" id="L11782">        mf.setDetonated(true);</span>
<span class="nc" id="L11783">    }</span>

    /**
     * drowns any units swarming the entity
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is being swarmed
     * @param pos    The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    private void drownSwarmer(Entity entity, Coords pos) {
        // Any swarming infantry will be destroyed.
<span class="nc" id="L11793">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L11794" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L11795">            final Entity swarmer = game.getEntity(swarmerId);</span>
            // Only *platoons* drown while swarming.
<span class="nc bnc" id="L11797" title="All 2 branches missed.">            if (!(swarmer instanceof BattleArmor)) {</span>
<span class="nc" id="L11798">                swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L11799">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L11800">                swarmer.setPosition(pos);</span>
<span class="nc" id="L11801">                Report r = new Report(2165);</span>
<span class="nc" id="L11802">                r.subject = entity.getId();</span>
<span class="nc" id="L11803">                r.indent();</span>
<span class="nc" id="L11804">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11805">                addReport(r);</span>
<span class="nc" id="L11806">                addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L11807">                entityUpdate(swarmerId);</span>
            }
        }
<span class="nc" id="L11810">    }</span>

    /**
     * Checks to see if we may have just washed off infernos. Call after a step
     * which may have done this.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is being checked
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    void checkForWashedInfernos(Entity entity, Coords coords) {
<span class="nc" id="L11820">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L11821">        int waterLevel = hex.terrainLevel(Terrains.WATER);</span>
        // Mech on fire with infernos can wash them off.
<span class="nc bnc" id="L11823" title="All 4 branches missed.">        if (!(entity instanceof Mech) || !entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L11824">            return;</span>
        }
        // Check if entering depth 2 water or prone in depth 1.
<span class="nc bnc" id="L11827" title="All 4 branches missed.">        if ((waterLevel &gt; 0) &amp;&amp; (entity.relHeight() &lt; 0)) {</span>
<span class="nc" id="L11828">            washInferno(entity, coords);</span>
        }
<span class="nc" id="L11830">    }</span>

    /**
     * Washes off an inferno from a mech and adds it to the (water) hex.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is taking a bath
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    void washInferno(Entity entity, Coords coords) {
<span class="nc" id="L11839">        game.getBoard().addInfernoTo(coords, InfernoTracker.STANDARD_ROUND, 1);</span>
<span class="nc" id="L11840">        entity.infernos.clear();</span>

        // Start a fire in the hex?
<span class="nc" id="L11843">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L11844">        Report r = new Report(2170);</span>
<span class="nc" id="L11845">        r.subject = entity.getId();</span>
<span class="nc" id="L11846">        r.addDesc(entity);</span>
<span class="nc bnc" id="L11847" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L11848">            r.messageId = 2175;</span>
<span class="nc" id="L11849">            ignite(coords, Terrains.FIRE_LVL_INFERNO, null);</span>
        }
<span class="nc" id="L11851">        addReport(r);</span>
<span class="nc" id="L11852">    }</span>

    /**
     * Add heat from the movement phase
     */
    public void addMovementHeat() {
<span class="nc bnc" id="L11858" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L11859">            Entity entity = i.next();</span>

<span class="nc bnc" id="L11861" title="All 2 branches missed.">            if (entity.hasDamagedRHS()) {</span>
<span class="nc" id="L11862">                entity.heatBuildup += 1;</span>
            }

<span class="nc bnc" id="L11865" title="All 2 branches missed.">            if ((entity.getMovementMode() == EntityMovementMode.BIPED_SWIM)</span>
<span class="nc bnc" id="L11866" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.QUAD_SWIM)) {</span>
                // UMU heat
<span class="nc" id="L11868">                entity.heatBuildup += 1;</span>
<span class="nc" id="L11869">                continue;</span>
            }

            // build up heat from movement
<span class="nc bnc" id="L11873" title="All 4 branches missed.">            if (entity.isEvading() &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L11874">                entity.heatBuildup += entity.getRunHeat() + 2;</span>
<span class="nc bnc" id="L11875" title="All 2 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_NONE) {</span>
<span class="nc" id="L11876">                entity.heatBuildup += entity.getStandingHeat();</span>
<span class="nc bnc" id="L11877" title="All 6 branches missed.">            } else if ((entity.moved == EntityMovementType.MOVE_WALK)</span>
                       || (entity.moved == EntityMovementType.MOVE_VTOL_WALK)
                       || (entity.moved == EntityMovementType.MOVE_CAREFUL_STAND)) {
<span class="nc" id="L11880">                entity.heatBuildup += entity.getWalkHeat();</span>
<span class="nc bnc" id="L11881" title="All 6 branches missed.">            } else if ((entity.moved == EntityMovementType.MOVE_RUN)</span>
                       || (entity.moved == EntityMovementType.MOVE_VTOL_RUN)
                       || (entity.moved == EntityMovementType.MOVE_SKID)) {
<span class="nc" id="L11884">                entity.heatBuildup += entity.getRunHeat();</span>
<span class="nc bnc" id="L11885" title="All 2 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L11886">                entity.heatBuildup += entity.getJumpHeat(entity.delta_distance);</span>
<span class="nc bnc" id="L11887" title="All 4 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_SPRINT</span>
                    || entity.moved == EntityMovementType.MOVE_VTOL_SPRINT) {
<span class="nc" id="L11889">                entity.heatBuildup += entity.getSprintHeat();</span>
            }
<span class="nc" id="L11891">        }</span>
<span class="nc" id="L11892">    }</span>

    /**
     * Set the LocationsExposure of an entity
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; who's exposure is being set
     * @param hex
     *            The &lt;code&gt;IHex&lt;/code&gt; the entity is in
     * @param isJump
     *            a &lt;code&gt;boolean&lt;/code&gt; value whether the entity is jumping
     * @param elevation
     *            the elevation the entity should be at.
     */
    public Vector&lt;Report&gt; doSetLocationsExposure(Entity entity, IHex hex,
            boolean isJump, int elevation) {
<span class="nc" id="L11908">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L11909" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L11910">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L11912" title="All 6 branches missed.">        if ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !isJump</span>
            &amp;&amp; (elevation &lt; 0)) {
<span class="nc" id="L11914">            int partialWaterLevel = 1;</span>
<span class="nc bnc" id="L11915" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; entity.isSuperHeavy()) {</span>
<span class="nc" id="L11916">                partialWaterLevel = 2;</span>
            }
<span class="nc bnc" id="L11918" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; !entity.isProne()</span>
<span class="nc bnc" id="L11919" title="All 2 branches missed.">                &amp;&amp; (hex.terrainLevel(Terrains.WATER) &lt;= partialWaterLevel)) {</span>
<span class="nc bnc" id="L11920" title="All 2 branches missed.">                for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc bnc" id="L11921" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().isVacuum()</span>
<span class="nc bnc" id="L11922" title="All 4 branches missed.">                            || ((entity.getEntityType() &amp; Entity.ETYPE_AERO) == 0 &amp;&amp; entity.isSpaceborne())) {</span>
<span class="nc" id="L11923">                        entity.setLocationStatus(loop, ILocationExposureStatus.VACUUM);</span>
                    } else {
<span class="nc" id="L11925">                        entity.setLocationStatus(loop, ILocationExposureStatus.NORMAL);</span>
                    }
                }
<span class="nc" id="L11928">                entity.setLocationStatus(Mech.LOC_RLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11929">                entity.setLocationStatus(Mech.LOC_LLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11930">                vPhaseReport.addAll(breachCheck(entity, Mech.LOC_RLEG, hex));</span>
<span class="nc" id="L11931">                vPhaseReport.addAll(breachCheck(entity, Mech.LOC_LLEG, hex));</span>
<span class="nc bnc" id="L11932" title="All 2 branches missed.">                if (entity instanceof QuadMech) {</span>
<span class="nc" id="L11933">                    entity.setLocationStatus(Mech.LOC_RARM, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11934">                    entity.setLocationStatus(Mech.LOC_LARM, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11935">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_RARM, hex));</span>
<span class="nc" id="L11936">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_LARM, hex));</span>
                }
<span class="nc bnc" id="L11938" title="All 2 branches missed.">                if (entity instanceof TripodMech) {</span>
<span class="nc" id="L11939">                    entity.setLocationStatus(Mech.LOC_CLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11940">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_CLEG, hex));</span>
                }
            } else {
<span class="nc bnc" id="L11943" title="All 2 branches missed.">                for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc" id="L11944">                    entity.setLocationStatus(loop, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11945">                    vPhaseReport.addAll(breachCheck(entity, loop, hex));</span>
                }
            }
<span class="nc" id="L11948">        } else {</span>
<span class="nc bnc" id="L11949" title="All 2 branches missed.">            for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc bnc" id="L11950" title="All 2 branches missed.">                if (game.getPlanetaryConditions().isVacuum()</span>
<span class="nc bnc" id="L11951" title="All 4 branches missed.">                        || ((entity.getEntityType() &amp; Entity.ETYPE_AERO) == 0 &amp;&amp; entity.isSpaceborne())) {</span>
<span class="nc" id="L11952">                    entity.setLocationStatus(loop, ILocationExposureStatus.VACUUM);</span>
                } else {
<span class="nc" id="L11954">                    entity.setLocationStatus(loop, ILocationExposureStatus.NORMAL);</span>
                }
            }
        }
<span class="nc" id="L11958">        return vPhaseReport;</span>
    }

    /**
     * Do a roll to avoid pilot damage from g-forces
     *
     * @param entity       The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param targetNumber The &lt;code&gt;int&lt;/code&gt; to be used for this PSR.
     */
    private void resistGForce(Entity entity, int targetNumber) {
        // okay, print the info
<span class="nc" id="L11969">        Report r = new Report(9330);</span>
<span class="nc" id="L11970">        r.subject = entity.getId();</span>
<span class="nc" id="L11971">        r.addDesc(entity);</span>
<span class="nc" id="L11972">        addReport(r);</span>

        // roll
<span class="nc" id="L11975">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L11976">        r = new Report(9335);</span>
<span class="nc" id="L11977">        r.subject = entity.getId();</span>
<span class="nc" id="L11978">        r.add(Integer.toString(targetNumber));</span>
<span class="nc" id="L11979">        r.add(diceRoll);</span>
<span class="nc bnc" id="L11980" title="All 2 branches missed.">        if (diceRoll &lt; targetNumber) {</span>
<span class="nc" id="L11981">            r.choose(false);</span>
<span class="nc" id="L11982">            addReport(r);</span>
<span class="nc" id="L11983">            addReport(damageCrew(entity, 1));</span>
        } else {
<span class="nc" id="L11985">            r.choose(true);</span>
<span class="nc" id="L11986">            addReport(r);</span>
        }
<span class="nc" id="L11988">    }</span>

    /**
     * Do a piloting skill check in space to avoid structural damage
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckInSpace(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L11998" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L11999">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12003">        Report r = new Report(9320);</span>
<span class="nc" id="L12004">        r.subject = entity.getId();</span>
<span class="nc" id="L12005">        r.addDesc(entity);</span>
<span class="nc" id="L12006">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12007">        addReport(r);</span>

        // roll
<span class="nc" id="L12010">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12011">        r = new Report(9325);</span>
<span class="nc" id="L12012">        r.subject = entity.getId();</span>
<span class="nc" id="L12013">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12014">        r.add(roll.getDesc());</span>
<span class="nc" id="L12015">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12017" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12018">            r.choose(false);</span>
<span class="nc" id="L12019">            addReport(r);</span>
<span class="nc" id="L12020">            suc = false;</span>
        } else {
<span class="nc" id="L12022">            r.choose(true);</span>
<span class="nc" id="L12023">            addReport(r);</span>
<span class="nc" id="L12024">            suc = true;</span>
        }

<span class="nc" id="L12027">        return suc;</span>
    }

    /**
     * Do a piloting skill check to take off vertically
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doVerticalTakeOffCheck(Entity entity, PilotingRollData roll) {

<span class="nc bnc" id="L12039" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L12040">            return false;</span>
        }

<span class="nc" id="L12043">        IAero a = (IAero) entity;</span>

<span class="nc bnc" id="L12045" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12046">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12050">        Report r = new Report(9320);</span>
<span class="nc" id="L12051">        r.subject = entity.getId();</span>
<span class="nc" id="L12052">        r.addDesc(entity);</span>
<span class="nc" id="L12053">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12054">        addReport(r);</span>

        // roll
<span class="nc" id="L12057">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12058">        r = new Report(9321);</span>
<span class="nc" id="L12059">        r.subject = entity.getId();</span>
<span class="nc" id="L12060">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12061">        r.add(roll.getDesc());</span>
<span class="nc" id="L12062">        r.add(diceRoll);</span>
<span class="nc" id="L12063">        r.newlines = 0;</span>
<span class="nc" id="L12064">        addReport(r);</span>
<span class="nc" id="L12065">        boolean suc = false;</span>
<span class="nc bnc" id="L12066" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12067">            int mof = roll.getValue() - diceRoll;</span>
<span class="nc bnc" id="L12068" title="All 2 branches missed.">            if (mof &lt; 3) {</span>
<span class="nc" id="L12069">                r = new Report(9322);</span>
<span class="nc" id="L12070">                r.subject = entity.getId();</span>
<span class="nc" id="L12071">                addReport(r);</span>
<span class="nc" id="L12072">                suc = true;</span>
<span class="nc bnc" id="L12073" title="All 2 branches missed.">            } else if (mof &lt; 5) {</span>
<span class="nc" id="L12074">                PilotingRollData newRoll = entity.getBasePilotingRoll();</span>
<span class="nc bnc" id="L12075" title="All 2 branches missed.">                if (Compute.d6(2) &gt;= newRoll.getValue()) {</span>
<span class="nc" id="L12076">                    r = new Report(9322);</span>
<span class="nc" id="L12077">                    r.subject = entity.getId();</span>
<span class="nc" id="L12078">                    addReport(r);</span>
<span class="nc" id="L12079">                    suc = true;</span>
                } else {
<span class="nc" id="L12081">                    r = new Report(9323);</span>
<span class="nc" id="L12082">                    r.subject = entity.getId();</span>
<span class="nc" id="L12083">                    addReport(r);</span>
<span class="nc" id="L12084">                    int damage = 20;</span>
<span class="nc bnc" id="L12085" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L12086">                        addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12087">                                ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12088">                        damage -= 5;</span>
                    }
                }
<span class="nc bnc" id="L12091" title="All 2 branches missed.">            } else if (mof &lt; 6) {</span>
<span class="nc" id="L12092">                r = new Report(9323);</span>
<span class="nc" id="L12093">                r.subject = entity.getId();</span>
<span class="nc" id="L12094">                addReport(r);</span>
<span class="nc" id="L12095">                int damage = 50;</span>
<span class="nc bnc" id="L12096" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L12097">                    addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12098">                            ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12099">                    damage -= 5;</span>
                }
<span class="nc" id="L12101">            } else {</span>
<span class="nc" id="L12102">                r = new Report(9323);</span>
<span class="nc" id="L12103">                r.subject = entity.getId();</span>
<span class="nc" id="L12104">                addReport(r);</span>
<span class="nc" id="L12105">                int damage = 100;</span>
<span class="nc bnc" id="L12106" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L12107">                    addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12108">                            ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12109">                    damage -= 5;</span>
                }
            }
<span class="nc" id="L12112">            a.setGearHit(true);</span>
<span class="nc" id="L12113">            r = new Report(9125);</span>
<span class="nc" id="L12114">            r.subject = entity.getId();</span>
<span class="nc" id="L12115">            addReport(r);</span>
<span class="nc" id="L12116">        } else {</span>
<span class="nc" id="L12117">            r = new Report(9322);</span>
<span class="nc" id="L12118">            r.subject = entity.getId();</span>
<span class="nc" id="L12119">            addReport(r);</span>
<span class="nc" id="L12120">            suc = true;</span>
        }

<span class="nc" id="L12123">        return suc;</span>
    }

    /**
     * Do a piloting skill check in space to do a successful maneuver Failure
     * means moving forward half velocity
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckManeuver(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12135" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12136">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12140">        Report r = new Report(9600);</span>
<span class="nc" id="L12141">        r.subject = entity.getId();</span>
<span class="nc" id="L12142">        r.addDesc(entity);</span>
<span class="nc" id="L12143">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12144">        addReport(r);</span>

        // roll
<span class="nc" id="L12147">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12148">        r = new Report(9601);</span>
<span class="nc" id="L12149">        r.subject = entity.getId();</span>
<span class="nc" id="L12150">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12151">        r.add(roll.getDesc());</span>
<span class="nc" id="L12152">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12154" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12155">            r.choose(false);</span>
<span class="nc" id="L12156">            addReport(r);</span>
<span class="nc" id="L12157">            suc = false;</span>
        } else {
<span class="nc" id="L12159">            r.choose(true);</span>
<span class="nc" id="L12160">            addReport(r);</span>
<span class="nc" id="L12161">            suc = true;</span>
        }

<span class="nc" id="L12164">        return suc;</span>
    }

    /**
     * Do a piloting skill check while standing still (during the movement
     * phase).
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckInPlace(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12176" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12177">            return true;</span>
        }

<span class="nc bnc" id="L12180" title="All 2 branches missed.">        if (entity.isProne()) {</span>
<span class="nc" id="L12181">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12185">        Report r = new Report(2180);</span>
<span class="nc" id="L12186">        r.subject = entity.getId();</span>
<span class="nc" id="L12187">        r.addDesc(entity);</span>
<span class="nc" id="L12188">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12189">        addReport(r);</span>

        // roll
<span class="nc" id="L12192">        final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L12193">        r = new Report(2185);</span>
<span class="nc" id="L12194">        r.subject = entity.getId();</span>
<span class="nc" id="L12195">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12196">        r.add(roll.getDesc());</span>
<span class="nc" id="L12197">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12199" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12200">            r.choose(false);</span>
<span class="nc" id="L12201">            addReport(r);</span>
<span class="nc bnc" id="L12202" title="All 2 branches missed.">            if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L12203" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L12205" title="All 2 branches missed.">                &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L12206" title="All 4 branches missed.">                &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L12207" title="All 4 branches missed.">                if ((entity.getCrew().getPiloting() &gt; 1) &amp;&amp; ((roll.getValue() - diceRoll) &lt; 2)) {</span>
<span class="nc" id="L12208">                    entity.setHullDown(true);</span>
<span class="nc bnc" id="L12209" title="All 2 branches missed.">                } else if ((entity.getCrew().getPiloting() &lt;= 1)</span>
<span class="nc bnc" id="L12210" title="All 2 branches missed.">                        &amp;&amp; ((roll.getValue() - diceRoll) &lt; 3)) {</span>
<span class="nc" id="L12211">                    entity.setHullDown(true);</span>
                }
            }
<span class="nc bnc" id="L12214" title="All 2 branches missed.">            if (!entity.isHullDown()</span>
<span class="nc bnc" id="L12215" title="All 4 branches missed.">                || (entity.isHullDown() &amp;&amp; !entity.canGoHullDown())) {</span>
<span class="nc" id="L12216">                addReport(doEntityFall(entity, roll));</span>
            } else {
<span class="nc" id="L12218">                ServerHelper.sinkToBottom(entity);</span>
                
<span class="nc" id="L12220">                r = new Report(2317);</span>
<span class="nc" id="L12221">                r.subject = entity.getId();</span>
<span class="nc" id="L12222">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L12223">                addReport(r);</span>
            }

<span class="nc" id="L12226">            suc = false;</span>
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12228">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
        } else {
<span class="nc" id="L12230">            r.choose(true);</span>
<span class="nc" id="L12231">            addReport(r);</span>
<span class="nc" id="L12232">            suc = true;</span>
        }

<span class="nc" id="L12235">        return suc;</span>
    }

    /**
     * Do a Piloting Skill check to dislodge swarming infantry.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is doing the dislodging.
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; for this PSR.
     * @param curPos The &lt;code&gt;Coords&lt;/code&gt; the entity is at.
     * @return &lt;code&gt;true&lt;/code&gt; if the dislodging is successful.
     */
    private boolean doDislodgeSwarmerSkillCheck(Entity entity, PilotingRollData roll, Coords curPos) {
        // okay, print the info
<span class="nc" id="L12248">        Report r = new Report(2180);</span>
<span class="nc" id="L12249">        r.subject = entity.getId();</span>
<span class="nc" id="L12250">        r.addDesc(entity);</span>
<span class="nc" id="L12251">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12252">        addReport(r);</span>

        // roll
<span class="nc" id="L12255">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12256">        r = new Report(2190);</span>
<span class="nc" id="L12257">        r.subject = entity.getId();</span>
<span class="nc" id="L12258">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12259">        r.add(roll.getDesc());</span>
<span class="nc" id="L12260">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12261" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12262">            r.choose(false);</span>
<span class="nc" id="L12263">            addReport(r);</span>
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12265">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L12266">            return false;</span>
        }
        // Dislodged swarmers don't get turns.
<span class="nc" id="L12269">        int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc" id="L12270">        final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc bnc" id="L12271" title="All 2 branches missed.">        if (!swarmer.isDone()) {</span>
<span class="nc" id="L12272">            game.removeTurnFor(swarmer);</span>
<span class="nc" id="L12273">            swarmer.setDone(true);</span>
<span class="nc" id="L12274">            send(createTurnVectorPacket());</span>
        }

        // Update the report and cause a fall.
<span class="nc" id="L12278">        r.choose(true);</span>
<span class="nc" id="L12279">        addReport(r);</span>
<span class="nc" id="L12280">        entity.setPosition(curPos);</span>
<span class="nc" id="L12281">        addReport(doEntityFallsInto(entity, curPos, roll, false));</span>
<span class="nc" id="L12282">        return true;</span>
    }

    /**
     * Do a piloting skill check while moving.
     *
     * @param entity          - the &lt;code&gt;Entity&lt;/code&gt; that must roll.
     * @param entityElevation The elevation of the supplied Entity above the surface of the
     *                        src hex. This is necessary as the state of the Entity may
     *                        represent the elevation of the entity about the surface of the
     *                        destination hex.
     * @param src             - the &lt;code&gt;Coords&lt;/code&gt; the entity is moving from.
     * @param dest            - the &lt;code&gt;Coords&lt;/code&gt; the entity is moving to. This value
     *                        can be the same as src for in-place checks.
     * @param roll            - the &lt;code&gt;PilotingRollData&lt;/code&gt; that is causing this
     *                        check.
     * @param isFallRoll      - a &lt;code&gt;boolean&lt;/code&gt; flag that indicates that failure will
     *                        result in a fall or not. Falls will be processed.
     * @return Margin of Failure if the pilot fails the skill check, 0 if they
     * pass.
     */
    private int doSkillCheckWhileMoving(Entity entity, int entityElevation,
            Coords src, Coords dest, PilotingRollData roll, boolean isFallRoll) {
        boolean fallsInPlace;

        // Start the info for this roll.
<span class="nc" id="L12308">        Report r = new Report(1210);</span>
<span class="nc" id="L12309">        r.subject = entity.getId();</span>
<span class="nc" id="L12310">        r.addDesc(entity);</span>

        // Will the entity fall in the source or destination hex?
<span class="nc bnc" id="L12313" title="All 2 branches missed.">        if (src.equals(dest)) {</span>
<span class="nc" id="L12314">            fallsInPlace = true;</span>
<span class="nc" id="L12315">            r.messageId = 2195;</span>
<span class="nc" id="L12316">            r.add(src.getBoardNum(), true);</span>
        } else {
<span class="nc" id="L12318">            fallsInPlace = false;</span>
<span class="nc" id="L12319">            r.messageId = 2200;</span>
<span class="nc" id="L12320">            r.add(src.getBoardNum(), true);</span>
<span class="nc" id="L12321">            r.add(dest.getBoardNum(), true);</span>
        }

        // Finish the info.
<span class="nc" id="L12325">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12326">        addReport(r);</span>

        // roll
<span class="nc" id="L12329">        final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L12330">        r = new Report(2185);</span>
<span class="nc" id="L12331">        r.subject = entity.getId();</span>
<span class="nc" id="L12332">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12333">        r.add(roll.getDesc());</span>
<span class="nc" id="L12334">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12335" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
            // Does failing the PSR result in a fall.
<span class="nc bnc" id="L12337" title="All 4 branches missed.">            if (isFallRoll &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L12338">                r.choose(false);</span>
<span class="nc" id="L12339">                addReport(r);</span>
<span class="nc" id="L12340">                addReport(doEntityFallsInto(entity, entityElevation,</span>
<span class="nc bnc" id="L12341" title="All 4 branches missed.">                                            fallsInPlace ? dest : src, fallsInPlace ? src : dest,</span>
                                            roll, true));
            } else {
<span class="nc" id="L12344">                r.messageId = 2190;</span>
<span class="nc" id="L12345">                r.choose(false);</span>
<span class="nc" id="L12346">                addReport(r);</span>
<span class="nc bnc" id="L12347" title="All 2 branches missed.">                entity.setPosition(fallsInPlace ? src : dest);</span>
            }
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12350">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L12351">            return roll.getValue() - diceRoll;</span>
        }
<span class="nc" id="L12353">        r.choose(true);</span>
<span class="nc" id="L12354">        r.newlines = 2;</span>
<span class="nc" id="L12355">        addReport(r);</span>
<span class="nc" id="L12356">        return 0;</span>
    }

    /**
     * Process a fall when the source and destination hexes are the same.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller. Note: the elevation of the entity is used to
     * determine fall distance, so it is important to ensure the Entity's
     * elevation is correct.
     *
     * @param entity    The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param src       The &lt;code&gt;Coords&lt;/code&gt; of the source hex.
     * @param roll      The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                  by the falling.
     * @param causeAffa The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                  to cause an accidental fall from above
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity, Coords src,
                                             PilotingRollData roll, boolean causeAffa) {
<span class="nc" id="L12376">        return doEntityFallsInto(entity, entity.getElevation(), src, src, roll,</span>
                                 causeAffa);
    }

    /**
     * Process a fall when moving from the source hex to the destination hex.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller. Note: the elevation of the entity is used to
     * determine fall distance, so it is important to ensure the Entity's
     * elevation is correct.
     *
     * @param entity             The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param entitySrcElevation The elevation of the supplied Entity above the surface of the
     *                           src hex. This is necessary as the state of the Entity may
     *                           represent the elevation of the entity about the surface of the
     *                           destination hex.
     * @param src                The &lt;code&gt;Coords&lt;/code&gt; of the source hex.
     * @param dest               The &lt;code&gt;Coords&lt;/code&gt; of the destination hex.
     * @param roll               The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                           by the falling.
     * @param causeAffa          The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                           to cause an accidental fall from above
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity,
                                             int entitySrcElevation, Coords src, Coords dest,
                                             PilotingRollData roll, boolean causeAffa) {
<span class="nc" id="L12403">        return doEntityFallsInto(entity, entitySrcElevation, src, dest, roll,</span>
                                 causeAffa, 0);
    }

    /**
     * Process a fall when moving from the source hex to the destination hex.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller.
     *
     * @param entity             The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param entitySrcElevation The elevation of the supplied Entity above the surface of the
     *                           src hex. This is necessary as the state of the Entity may
     *                           represent the elevation of the entity about the surface of the
     *                           destination hex.
     * @param origSrc            The &lt;code&gt;Coords&lt;/code&gt; of the original source hex.
     * @param origDest           The &lt;code&gt;Coords&lt;/code&gt; of the original destination hex.
     * @param roll               The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                           by the falling.
     * @param causeAffa          The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                           to cause an accidental fall from above
     * @param fallReduction      An integer value to reduce the fall distance by
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity,
                                             int entitySrcElevation, Coords origSrc, Coords origDest,
                                             PilotingRollData roll, boolean causeAffa, int fallReduction) {
<span class="nc" id="L12429">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L12430">        IHex srcHex = game.getBoard().getHex(origSrc);</span>
<span class="nc" id="L12431">        IHex destHex = game.getBoard().getHex(origDest);</span>
        Coords src, dest;
        // We need to fall into the lower of the two hexes, TW pg 68
<span class="nc bnc" id="L12434" title="All 2 branches missed.">        if (srcHex.getLevel() &lt; destHex.getLevel()) {</span>
<span class="nc" id="L12435">            IHex swapHex = destHex;</span>
<span class="nc" id="L12436">            destHex = srcHex;</span>
<span class="nc" id="L12437">            srcHex = swapHex;</span>
<span class="nc" id="L12438">            src = origDest;</span>
<span class="nc" id="L12439">            dest = origSrc;</span>
<span class="nc" id="L12440">        } else {</span>
<span class="nc" id="L12441">            src = origSrc;</span>
<span class="nc" id="L12442">            dest = origDest;</span>
        }
<span class="nc" id="L12444">        final int srcHeightAboveFloor = entitySrcElevation + srcHex.depth(false);</span>
<span class="nc" id="L12445">        int fallElevation = Math.abs((srcHex.floor() + srcHeightAboveFloor)</span>
<span class="nc bnc" id="L12446" title="All 2 branches missed.">                - (destHex.containsTerrain(Terrains.ICE) ? destHex.surface() : destHex.floor()))</span>
                - fallReduction;
<span class="nc bnc" id="L12448" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L12449">            fallElevation -= destHex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc bnc" id="L12451" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_BASEMENT_TYPE)) {</span>
<span class="nc bnc" id="L12452" title="All 2 branches missed.">            if (entity.getElevation() == 0) { // floor 0 falling into basement</span>
<span class="nc" id="L12453">                fallElevation = destHex.depth(true);</span>
            }
        }

        int direction;
<span class="nc bnc" id="L12458" title="All 2 branches missed.">        if (src.equals(dest)) {</span>
<span class="nc" id="L12459">            direction = Compute.d6() - 1;</span>
        } else {
<span class="nc" id="L12461">            direction = src.direction(dest);</span>
        }
        Report r;
        // check entity in target hex
<span class="nc" id="L12465">        Entity affaTarget = game.getAffaTarget(dest, entity);</span>
        // falling mech falls
<span class="nc" id="L12467">        r = new Report(2205);</span>
<span class="nc" id="L12468">        r.subject = entity.getId();</span>
<span class="nc" id="L12469">        r.addDesc(entity);</span>
<span class="nc" id="L12470">        r.add(fallElevation);</span>
<span class="nc" id="L12471">        r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L12472">        r.newlines = 0;</span>

        // if hex was empty, deal damage and we're done
<span class="nc bnc" id="L12475" title="All 2 branches missed.">        if (affaTarget == null) {</span>
<span class="nc" id="L12476">            r.newlines = 1;</span>
<span class="nc" id="L12477">            vPhaseReport.add(r);</span>
            // If we rolled for the direction, we want to use that for the fall
<span class="nc bnc" id="L12479" title="All 2 branches missed.">            if (src.equals(dest)) {</span>
<span class="nc" id="L12480">                vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation,</span>
<span class="nc" id="L12481">                                                 direction, roll, false, srcHex.hasCliffTopTowards(destHex)));</span>
            } else {
                // Otherwise, we'll roll for the direction after the fall
<span class="nc" id="L12484">                vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation, roll));</span>
            }

<span class="nc" id="L12487">            return vPhaseReport;</span>
        }
<span class="nc" id="L12489">        vPhaseReport.add(r);</span>

        // hmmm... somebody there... problems.
<span class="nc bnc" id="L12492" title="All 4 branches missed.">        if ((fallElevation &gt;= 2) &amp;&amp; causeAffa) {</span>
            // accidental fall from above: havoc!
<span class="nc" id="L12494">            r = new Report(2210);</span>
<span class="nc" id="L12495">            r.subject = entity.getId();</span>
<span class="nc" id="L12496">            r.addDesc(affaTarget);</span>
<span class="nc" id="L12497">            vPhaseReport.add(r);</span>

            // determine to-hit number
<span class="nc" id="L12500">            ToHitData toHit = new ToHitData(7, &quot;base&quot;);</span>
<span class="nc bnc" id="L12501" title="All 4 branches missed.">            if ((affaTarget instanceof Tank) || (affaTarget instanceof Dropship)) {</span>
<span class="nc" id="L12502">                toHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, &quot;Target is a Tank&quot;);</span>
            } else {
<span class="nc" id="L12504">                toHit.append(Compute.getTargetMovementModifier(game, affaTarget.getId()));</span>
<span class="nc" id="L12505">                toHit.append(Compute.getTargetTerrainModifier(game, affaTarget));</span>
            }

<span class="nc bnc" id="L12508" title="All 2 branches missed.">            if (toHit.getValue() != TargetRoll.AUTOMATIC_FAIL) {</span>
                // collision roll
<span class="nc" id="L12510">                final int diceRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L12511" title="All 2 branches missed.">                if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12512">                    r = new Report(2212);</span>
<span class="nc" id="L12513">                    r.add(toHit.getValue());</span>
                } else {
<span class="nc" id="L12515">                    r = new Report(2215);</span>
<span class="nc" id="L12516">                    r.subject = entity.getId();</span>
<span class="nc" id="L12517">                    r.add(toHit.getValue());</span>
<span class="nc" id="L12518">                    r.add(diceRoll);</span>
<span class="nc" id="L12519">                    r.newlines = 0;</span>
                }
<span class="nc" id="L12521">                r.indent();</span>
<span class="nc" id="L12522">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12523" title="All 2 branches missed.">                if (diceRoll &gt;= toHit.getValue()) {</span>
                    // deal damage to target
<span class="nc" id="L12525">                    int damage = Compute.getAffaDamageFor(entity);</span>
<span class="nc" id="L12526">                    r = new Report(2220);</span>
<span class="nc" id="L12527">                    r.subject = affaTarget.getId();</span>
<span class="nc" id="L12528">                    r.addDesc(affaTarget);</span>
<span class="nc" id="L12529">                    r.add(damage);</span>
<span class="nc" id="L12530">                    vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12531" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L12532">                        int cluster = Math.min(5, damage);</span>
<span class="nc" id="L12533">                        HitData hit = affaTarget.rollHitLocation(ToHitData.HIT_PUNCH, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L12534">                        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L12535">                        vPhaseReport.addAll(damageEntity(affaTarget, hit, cluster));</span>
<span class="nc" id="L12536">                        damage -= cluster;</span>
<span class="nc" id="L12537">                    }</span>

                    // attacker falls as normal, on his back
                    // only given a modifier, so flesh out into a full piloting
                    // roll
<span class="nc" id="L12542">                    PilotingRollData pilotRoll = entity.getBasePilotingRoll();</span>
<span class="nc" id="L12543">                    pilotRoll.append(roll);</span>
<span class="nc" id="L12544">                    vPhaseReport.addAll(doEntityFall(entity, dest,</span>
                            fallElevation, 3, pilotRoll, false, false));
<span class="nc" id="L12546">                    vPhaseReport.addAll(doEntityDisplacementMinefieldCheck(</span>
<span class="nc" id="L12547">                            entity, src, dest, entity.getElevation()));</span>

                    // defender pushed away, or destroyed, if there is a
                    // stacking violation
<span class="nc" id="L12551">                    Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12552" title="All 2 branches missed.">                    if (violation != null) {</span>
<span class="nc" id="L12553">                        PilotingRollData prd = new PilotingRollData(violation.getId(), 2,</span>
                                &quot;fallen on&quot;);
<span class="nc bnc" id="L12555" title="All 2 branches missed.">                        if (violation instanceof Dropship) {</span>
<span class="nc" id="L12556">                            violation = entity;</span>
<span class="nc" id="L12557">                            prd = null;</span>
                        }
<span class="nc" id="L12559">                        Coords targetDest = Compute.getValidDisplacement(game, violation.getId(),</span>
                                dest, direction);
<span class="nc bnc" id="L12561" title="All 2 branches missed.">                        if (targetDest != null) {</span>
<span class="nc" id="L12562">                            vPhaseReport.addAll(doEntityDisplacement(violation, dest, targetDest, prd));</span>
                            // Update the violating entity's position on the
                            // client.
<span class="nc" id="L12565">                            entityUpdate(violation.getId());</span>
                        } else {
                            // ack! automatic death! Tanks
                            // suffer an ammo/power plant hit.
                            // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L12570">                            vPhaseReport.addAll(destroyEntity(violation, &quot;impossible displacement&quot;,</span>
                                    violation instanceof Mech, violation instanceof Mech));
                        }
                    }
<span class="nc" id="L12574">                    return vPhaseReport;</span>
                }
<span class="nc" id="L12576">            } else {</span>
                // automatic miss
<span class="nc" id="L12578">                r = new Report(2213);</span>
<span class="nc" id="L12579">                r.add(toHit.getDesc());</span>
<span class="nc" id="L12580">                vPhaseReport.add(r);</span>
            }
            // ok, we missed, let's fall into a valid other hex and not cause an
            // AFFA while doing so
<span class="nc" id="L12584">            Coords targetDest = Compute.getValidDisplacement(game, entity.getId(), dest, direction);</span>
<span class="nc bnc" id="L12585" title="All 2 branches missed.">            if (targetDest != null) {</span>
<span class="nc" id="L12586">                vPhaseReport.addAll(doEntityFallsInto(entity, entitySrcElevation, src, targetDest,</span>
<span class="nc" id="L12587">                        new PilotingRollData(entity.getId(),</span>
                                TargetRoll.IMPOSSIBLE,
                                &quot;pushed off a cliff&quot;),
                        false));
                // Update the entity's position on the client.
<span class="nc" id="L12592">                entityUpdate(entity.getId());</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L12597">                vPhaseReport.addAll(destroyEntity(entity,</span>
                        &quot;impossible displacement&quot;, entity instanceof Mech, entity instanceof Mech));
            }
<span class="nc" id="L12600">        } else {</span>
            // damage as normal
<span class="nc" id="L12602">            vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation, roll));</span>
<span class="nc" id="L12603">            Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12604" title="All 2 branches missed.">            if (violation != null) {</span>
<span class="nc" id="L12605">                PilotingRollData prd = new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;);</span>
<span class="nc bnc" id="L12606" title="All 2 branches missed.">                if (violation instanceof Dropship) {</span>
<span class="nc" id="L12607">                    violation = entity;</span>
<span class="nc" id="L12608">                    prd = null;</span>
                }
                // target gets displaced, because of low elevation
<span class="nc" id="L12611">                Coords targetDest = Compute.getValidDisplacement(game, violation.getId(), dest, direction);</span>
<span class="nc" id="L12612">                vPhaseReport.addAll(doEntityDisplacement(violation, dest, targetDest, prd));</span>
                // Update the violating entity's position on the client.
<span class="nc bnc" id="L12614" title="All 2 branches missed.">                if (!game.getOutOfGameEntitiesVector().contains(violation)) {</span>
<span class="nc" id="L12615">                    entityUpdate(violation.getId());</span>
                }
            }
        }
<span class="nc" id="L12619">        return vPhaseReport;</span>
    }

    /**
     * Displace a unit in the direction specified. The unit moves in that
     * direction, and the piloting skill roll is used to determine if it falls.
     * The roll may be unnecessary as certain situations indicate an automatic
     * fall. Rolls are added to the piloting roll list.
     */
    private Vector&lt;Report&gt; doEntityDisplacement(Entity entity, Coords src,
            Coords dest, PilotingRollData roll) {
<span class="nc" id="L12630">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L12632" title="All 2 branches missed.">        if (!game.getBoard().contains(dest)) {</span>
            // set position anyway, for pushes moving through, stuff like that
<span class="nc" id="L12634">            entity.setPosition(dest);</span>
<span class="nc bnc" id="L12635" title="All 2 branches missed.">            if (!entity.isDoomed()) {</span>
                // Make sure there aren't any specific entity turns for entity
<span class="nc" id="L12637">                int turnsRemoved = game.removeSpecificEntityTurnsFor(entity);</span>
                // May need to remove a turn for this Entity
<span class="nc bnc" id="L12639" title="All 2 branches missed.">                if ((game.getPhase() == Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L12640" title="All 4 branches missed.">                        &amp;&amp; !entity.isDone() &amp;&amp; (turnsRemoved == 0)) {</span>
<span class="nc" id="L12641">                    game.removeTurnFor(entity);</span>
<span class="nc" id="L12642">                    send(createTurnVectorPacket());</span>
<span class="nc bnc" id="L12643" title="All 2 branches missed.">                } else if (turnsRemoved &gt; 0) {</span>
<span class="nc" id="L12644">                    send(createTurnVectorPacket());</span>
                }
<span class="nc" id="L12646">                game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L12647">                send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
                // entity forced from the field
<span class="nc" id="L12649">                r = new Report(2230);</span>
<span class="nc" id="L12650">                r.subject = entity.getId();</span>
<span class="nc" id="L12651">                r.addDesc(entity);</span>
<span class="nc" id="L12652">                vPhaseReport.add(r);</span>
                // TODO : remove passengers and swarmers.
            }
<span class="nc" id="L12655">            return vPhaseReport;</span>
        }
<span class="nc" id="L12657">        final IHex srcHex = game.getBoard().getHex(src);</span>
<span class="nc" id="L12658">        final IHex destHex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L12659">        final int direction = src.direction(dest);</span>

        // Handle null hexes.
<span class="nc bnc" id="L12662" title="All 4 branches missed.">        if ((srcHex == null) || (destHex == null)) {</span>
<span class="nc" id="L12663">            MegaMek.getLogger().error(&quot;Can not displace &quot; + entity.getShortName()</span>
                    + &quot; from &quot; + src + &quot; to &quot; + dest + &quot;.&quot;);
<span class="nc" id="L12665">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L12667" title="All 2 branches missed.">        int bldgElev = destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L12668">            ? destHex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L12669">        int fallElevation = srcHex.surface() + entity.getElevation()</span>
<span class="nc" id="L12670">                - (destHex.surface() + bldgElev);</span>
<span class="nc bnc" id="L12671" title="All 2 branches missed.">        if (fallElevation &gt; 1) {</span>
<span class="nc bnc" id="L12672" title="All 2 branches missed.">            if (roll == null) {</span>
<span class="nc" id="L12673">                roll = entity.getBasePilotingRoll();</span>
            }
<span class="nc bnc" id="L12675" title="All 2 branches missed.">            if (!(entity.isAirborneVTOLorWIGE())) {</span>
<span class="nc" id="L12676">                vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                        roll, true));
            } else {
<span class="nc" id="L12679">                entity.setPosition(dest);</span>
            }
<span class="nc" id="L12681">            return vPhaseReport;</span>
        }
        // unstick the entity if it was stuck in swamp
<span class="nc" id="L12684">        boolean wasStuck = entity.isStuck();</span>
<span class="nc" id="L12685">        entity.setStuck(false);</span>
<span class="nc" id="L12686">        int oldElev = entity.getElevation();</span>
        // move the entity into the new location gently
<span class="nc" id="L12688">        entity.setPosition(dest);</span>
<span class="nc" id="L12689">        entity.setElevation(entity.calcElevation(srcHex, destHex));</span>
<span class="nc" id="L12690">        Building bldg = game.getBoard().getBuildingAt(dest);</span>
<span class="nc bnc" id="L12691" title="All 2 branches missed.">        if (bldg != null) {</span>
<span class="nc bnc" id="L12692" title="All 2 branches missed.">            if (destHex.terrainLevel(Terrains.BLDG_ELEV) &gt; oldElev) {</span>
                // whoops, into the building we go
<span class="nc" id="L12694">                passBuildingWall(entity, game.getBoard().getBuildingAt(dest), src, dest, 1,</span>
                        &quot;displaced into&quot;,
<span class="nc bnc" id="L12696" title="All 2 branches missed.">                        Math.abs(entity.getFacing() - src.direction(dest)) == 3,</span>
                        entity.moved, true);
            }
<span class="nc" id="L12699">            checkBuildingCollapseWhileMoving(bldg, entity, dest);</span>
        }
        
<span class="nc" id="L12702">        ServerHelper.checkAndApplyMagmaCrust(destHex, entity.getElevation(), entity, dest, false, vPhaseReport, this);</span>
        
<span class="nc" id="L12704">        Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12705" title="All 2 branches missed.">        if (violation == null) {</span>
            // move and roll normally
<span class="nc" id="L12707">            r = new Report(2235);</span>
<span class="nc" id="L12708">            r.indent();</span>
<span class="nc" id="L12709">            r.subject = entity.getId();</span>
<span class="nc" id="L12710">            r.addDesc(entity);</span>
<span class="nc" id="L12711">            r.add(dest.getBoardNum(), true);</span>
        } else {
            // domino effect: move &amp; displace target
<span class="nc" id="L12714">            r = new Report(2240);</span>
<span class="nc" id="L12715">            r.indent();</span>
<span class="nc" id="L12716">            r.subject = entity.getId();</span>
<span class="nc" id="L12717">            r.addDesc(entity);</span>
<span class="nc" id="L12718">            r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L12719">            r.addDesc(violation);</span>
        }
<span class="nc" id="L12721">        vPhaseReport.add(r);</span>
        // trigger any special things for moving to the new hex
<span class="nc" id="L12723">        vPhaseReport.addAll(doEntityDisplacementMinefieldCheck(entity, src, dest, entity.getElevation()));</span>
<span class="nc" id="L12724">        vPhaseReport.addAll(doSetLocationsExposure(entity, destHex, false, entity.getElevation()));</span>
<span class="nc bnc" id="L12725" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L12726" title="All 2 branches missed.">            &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L12727">            bldg = game.getBoard().getBuildingAt(dest);</span>
<span class="nc bnc" id="L12728" title="All 2 branches missed.">            if (bldg.rollBasement(dest, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L12729">                sendChangedHex(dest);</span>
<span class="nc" id="L12730">                Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L12731">                buildings.add(bldg);</span>
<span class="nc" id="L12732">                sendChangedBuildings(buildings);</span>
            }
        }

        // mechs that were stuck will automatically fall in their new hex
<span class="nc bnc" id="L12737" title="All 4 branches missed.">        if (wasStuck &amp;&amp; entity.canFall()) {</span>
<span class="nc bnc" id="L12738" title="All 2 branches missed.">            if (roll == null) {</span>
<span class="nc" id="L12739">                roll = entity.getBasePilotingRoll();</span>
            }
<span class="nc" id="L12741">            vPhaseReport.addAll(doEntityFall(entity, dest, 0, roll));</span>
        }
        // check bog-down conditions
<span class="nc" id="L12744">        vPhaseReport.addAll(doEntityDisplacementBogDownCheck(entity, dest, entity.getElevation()));</span>

<span class="nc bnc" id="L12746" title="All 2 branches missed.">        if (roll != null) {</span>
<span class="nc bnc" id="L12747" title="All 2 branches missed.">            if (entity.canFall()) {</span>
<span class="nc" id="L12748">                game.addPSR(roll);</span>
<span class="nc bnc" id="L12749" title="All 4 branches missed.">            } else if ((entity instanceof LandAirMech) &amp;&amp; entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L12750">                game.addControlRoll(roll);</span>
            }
        }

<span class="nc" id="L12754">        int waterDepth = destHex.terrainLevel(Terrains.WATER);</span>

<span class="nc bnc" id="L12756" title="All 4 branches missed.">        if (destHex.containsTerrain(Terrains.ICE) &amp;&amp; destHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L12757" title="All 2 branches missed.">            if (!(entity instanceof Infantry)) {</span>
<span class="nc" id="L12758">                int d6 = Compute.d6(1);</span>
<span class="nc" id="L12759">                r = new Report(2118);</span>
<span class="nc" id="L12760">                r.addDesc(entity);</span>
<span class="nc" id="L12761">                r.add(d6);</span>
<span class="nc" id="L12762">                r.subject = entity.getId();</span>
<span class="nc" id="L12763">                vPhaseReport.add(r);</span>

<span class="nc bnc" id="L12765" title="All 2 branches missed.">                if (d6 == 6) {</span>
<span class="nc" id="L12766">                    vPhaseReport.addAll(resolveIceBroken(dest));</span>
                }
<span class="nc" id="L12768">            }</span>
        }
        // Falling into water instantly destroys most non-mechs
<span class="nc bnc" id="L12771" title="All 6 branches missed.">        else if ((waterDepth &gt; 0)</span>
                &amp;&amp; !(entity instanceof Mech)
                &amp;&amp; !(entity instanceof Protomech)
<span class="nc bnc" id="L12774" title="All 4 branches missed.">                &amp;&amp; !((entity.getRunMP() &gt; 0) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.HOVER))</span>
<span class="nc bnc" id="L12775" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L12776" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L12777" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L12778" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L12779">            vPhaseReport.addAll(destroyEntity(entity, &quot;a watery grave&quot;, false));</span>
<span class="nc bnc" id="L12780" title="All 2 branches missed.">        } else if ((waterDepth &gt; 0)</span>
<span class="nc bnc" id="L12781" title="All 2 branches missed.">                &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L12782">            PilotingRollData waterRoll = entity.checkWaterMove(waterDepth, entity.moved);</span>
<span class="nc bnc" id="L12783" title="All 2 branches missed.">            if (waterRoll.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L12784">                doSkillCheckInPlace(entity, waterRoll);</span>
            }
        }
        // Update the entity's position on the client.
<span class="nc" id="L12788">        entityUpdate(entity.getId());</span>

<span class="nc bnc" id="L12790" title="All 2 branches missed.">        if (violation != null) {</span>
            // Can the violating unit move out of the way?
            // if the direction comes from a side, Entity didn't jump, and it
            // has MP left to use, it can try to move.
<span class="nc" id="L12794">            MovePath stepForward = new MovePath(game, violation);</span>
<span class="nc" id="L12795">            MovePath stepBackwards = new MovePath(game, violation);</span>
<span class="nc" id="L12796">            stepForward.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L12797">            stepBackwards.addStep(MoveStepType.BACKWARDS);</span>
<span class="nc" id="L12798">            stepForward.compile(getGame(), violation, false);</span>
<span class="nc" id="L12799">            stepBackwards.compile(getGame(), violation, false);</span>
<span class="nc bnc" id="L12800" title="All 2 branches missed.">            if ((direction != violation.getFacing())</span>
<span class="nc bnc" id="L12801" title="All 2 branches missed.">                    &amp;&amp; (direction != ((violation.getFacing() + 3) % 6))</span>
<span class="nc bnc" id="L12802" title="All 2 branches missed.">                    &amp;&amp; !entity.getIsJumpingNow()</span>
<span class="nc bnc" id="L12803" title="All 4 branches missed.">                    &amp;&amp; (stepForward.isMoveLegal() || stepBackwards.isMoveLegal())) {</span>
                // First, we need to make a PSR to see if we can step out
<span class="nc" id="L12805">                int result = Compute.d6(2);</span>
<span class="nc" id="L12806">                roll = entity.getBasePilotingRoll();</span>

<span class="nc" id="L12808">                r = new Report(2351);</span>
<span class="nc" id="L12809">                r.indent(2);</span>
<span class="nc" id="L12810">                r.subject = violation.getId();</span>
<span class="nc" id="L12811">                r.addDesc(violation);</span>
<span class="nc" id="L12812">                r.add(roll);</span>
<span class="nc" id="L12813">                r.add(result);</span>
<span class="nc" id="L12814">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12815" title="All 2 branches missed.">                if (result &lt; roll.getValue()) {</span>
<span class="nc" id="L12816">                    r.choose(false);</span>
<span class="nc" id="L12817">                    Vector&lt;Report&gt; newReports = doEntityDisplacement(violation,</span>
<span class="nc" id="L12818">                            dest, dest.translated(direction),</span>
<span class="nc" id="L12819">                            new PilotingRollData(violation.getId(),</span>
                                    TargetRoll.AUTOMATIC_FAIL,
                                    &quot;failed to step out of a domino effect&quot;));
<span class="nc bnc" id="L12822" title="All 2 branches missed.">                    for (Report newReport : newReports) {</span>
<span class="nc" id="L12823">                        newReport.indent(3);</span>
<span class="nc" id="L12824">                    }</span>
<span class="nc" id="L12825">                    vPhaseReport.addAll(newReports);</span>
<span class="nc" id="L12826">                } else {</span>
<span class="nc" id="L12827">                    r.choose(true);</span>
<span class="nc" id="L12828">                    sendDominoEffectCFR(violation);</span>
<span class="nc" id="L12829">                    synchronized (cfrPacketQueue) {</span>
                        try {
<span class="nc" id="L12831">                            cfrPacketQueue.wait();</span>
<span class="nc" id="L12832">                        } catch (InterruptedException ignored) {</span>
                            // Do nothing
<span class="nc" id="L12834">                        }</span>
<span class="nc bnc" id="L12835" title="All 2 branches missed.">                        if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L12836">                            ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L12837">                            int cfrType = (int) rp.packet.getData()[0];</span>
                            // Make sure we got the right type of response
<span class="nc bnc" id="L12839" title="All 2 branches missed.">                            if (cfrType != Packet.COMMAND_CFR_DOMINO_EFFECT) {</span>
<span class="nc" id="L12840">                                MegaMek.getLogger().error(&quot;Excepted a COMMAND_CFR_DOMINO_EFFECT CFR packet, &quot;</span>
                                                + &quot;received: &quot; + cfrType);
<span class="nc" id="L12842">                                throw new IllegalStateException();</span>
                            }
<span class="nc" id="L12844">                            MovePath mp = (MovePath) rp.packet.getData()[1];</span>
                            // Move based on the feedback
<span class="nc bnc" id="L12846" title="All 2 branches missed.">                            if (mp != null) {</span>
<span class="nc" id="L12847">                                mp.setGame(getGame());</span>
<span class="nc" id="L12848">                                mp.setEntity(violation);</span>
                                // Report
<span class="nc" id="L12850">                                r = new Report(2352);</span>
<span class="nc" id="L12851">                                r.indent(3);</span>
<span class="nc" id="L12852">                                r.subject = violation.getId();</span>
<span class="nc" id="L12853">                                r.addDesc(violation);</span>
<span class="nc bnc" id="L12854" title="All 2 branches missed.">                                if (mp.getLastStep().getType() == MoveStepType.FORWARDS) {</span>
<span class="nc" id="L12855">                                    r.choose(false);</span>
                                } else {
<span class="nc" id="L12857">                                    r.choose(true);</span>
                                }
<span class="nc" id="L12859">                                r.add(mp.getLastStep().getPosition().getBoardNum());</span>
<span class="nc" id="L12860">                                vPhaseReport.add(r);</span>
                                // Move unit
<span class="nc" id="L12862">                                violation.setPosition(mp.getFinalCoords());</span>
<span class="nc" id="L12863">                                violation.mpUsed += mp.getMpUsed();</span>
<span class="nc" id="L12864">                                violation.moved = mp.getLastStepMovementType();</span>
                            } else { // User decided to do nothing
<span class="nc" id="L12866">                                r = new Report(2358);</span>
<span class="nc" id="L12867">                                r.indent(3);</span>
<span class="nc" id="L12868">                                r.subject = violation.getId();</span>
<span class="nc" id="L12869">                                r.addDesc(violation);</span>
<span class="nc" id="L12870">                                vPhaseReport.add(r);</span>
<span class="nc" id="L12871">                                vPhaseReport.addAll(doEntityDisplacement(violation, dest,</span>
<span class="nc" id="L12872">                                        dest.translated(direction), null));</span>
                            }
<span class="nc" id="L12874">                        } else { // If no responses, treat as no action</span>
<span class="nc" id="L12875">                            vPhaseReport.addAll(doEntityDisplacement(violation,</span>
<span class="nc" id="L12876">                                    dest, dest.translated(direction),</span>
<span class="nc" id="L12877">                                    new PilotingRollData(violation.getId(), 0,</span>
                                            &quot;domino effect&quot;)));
                        }
<span class="nc" id="L12880">                    }</span>
                }
<span class="nc" id="L12882">            } else { // Nope</span>
<span class="nc" id="L12883">                r = new Report(2359);</span>
<span class="nc" id="L12884">                r.indent(2);</span>
<span class="nc" id="L12885">                r.subject = violation.getId();</span>
<span class="nc" id="L12886">                r.addDesc(violation);</span>
<span class="nc" id="L12887">                vPhaseReport.add(r);</span>
<span class="nc" id="L12888">                vPhaseReport.addAll(doEntityDisplacement(violation, dest, dest.translated(direction),</span>
<span class="nc" id="L12889">                        new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;)));</span>

            }
            // Update the violating entity's position on the client,
            // if it didn't get displaced off the board.
<span class="nc bnc" id="L12894" title="All 2 branches missed.">            if (!game.isOutOfGame(violation)) {</span>
<span class="nc" id="L12895">                entityUpdate(violation.getId());</span>
            }
        }
<span class="nc" id="L12898">        return vPhaseReport;</span>
    }

    private void sendDominoEffectCFR(Entity e) {
<span class="nc" id="L12902">        send(e.getOwnerId(), new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12903">                new Object[] { Packet.COMMAND_CFR_DOMINO_EFFECT, e.getId() }));</span>
<span class="nc" id="L12904">    }</span>

    private void sendAMSAssignCFR(Entity e, Mounted ams, List&lt;WeaponAttackAction&gt; waas) {
<span class="nc" id="L12907">        send(e.getOwnerId(),</span>
                new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
<span class="nc" id="L12909">                        new Object[] { Packet.COMMAND_CFR_AMS_ASSIGN,</span>
<span class="nc" id="L12910">                                e.getId(), e.getEquipmentNum(ams), waas }));</span>
<span class="nc" id="L12911">    }</span>

    private void sendAPDSAssignCFR(Entity e, List&lt;Integer&gt; apdsDists,
            List&lt;WeaponAttackAction&gt; waas) {
<span class="nc" id="L12915">        send(e.getOwnerId(), new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12916">                new Object[] { Packet.COMMAND_CFR_APDS_ASSIGN, e.getId(),</span>
                apdsDists, waas }));
<span class="nc" id="L12918">    }</span>

    private void sendPointBlankShotCFR(Entity hidden, Entity target) {
        // Send attacker/target IDs to PBS Client
<span class="nc" id="L12922">        send(hidden.getOwnerId(),</span>
                new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
<span class="nc" id="L12924">                        new Object[] { Packet.COMMAND_CFR_HIDDEN_PBS,</span>
<span class="nc" id="L12925">                                hidden.getId(), target.getId() }));</span>
<span class="nc" id="L12926">    }</span>

    private void sendTeleguidedMissileCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; toHitValues) {
        // Send target id numbers and to-hit values to Client
<span class="nc" id="L12930">        send(playerId, new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12931">                new Object[] { Packet.COMMAND_CFR_TELEGUIDED_TARGET, targetIds, toHitValues}));</span>
<span class="nc" id="L12932">    }</span>
    
    private void sendTAGTargetCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; targetTypes) {
        // Send target id numbers and type identifiers to Client
<span class="nc" id="L12936">        send(playerId, new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12937">                new Object[] { Packet.COMMAND_CFR_TAG_TARGET, targetIds, targetTypes}));</span>
<span class="nc" id="L12938">    }</span>

    private Vector&lt;Report&gt; doEntityDisplacementMinefieldCheck(Entity entity, Coords src, Coords dest, int elev) {
<span class="nc" id="L12941">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L12942">        boolean boom = checkVibrabombs(entity, dest, true, vPhaseReport);</span>
<span class="nc bnc" id="L12943" title="All 2 branches missed.">        if (game.containsMinefield(dest)) {</span>
<span class="nc bnc" id="L12944" title="All 4 branches missed.">            boom = enterMinefield(entity, dest, elev, true, vPhaseReport) || boom;</span>
        }
<span class="nc bnc" id="L12946" title="All 2 branches missed.">        if (boom) {</span>
<span class="nc" id="L12947">            resetMines();</span>
        }

<span class="nc" id="L12950">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; doEntityDisplacementBogDownCheck(Entity entity, Coords c, int elev) {
<span class="nc" id="L12954">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L12956">        IHex destHex = game.getBoard().getHex(c);</span>
<span class="nc" id="L12957">        int bgMod = destHex.getBogDownModifier(entity.getMovementMode(),</span>
                entity instanceof LargeSupportTank);
<span class="nc bnc" id="L12959" title="All 2 branches missed.">        if ((bgMod != TargetRoll.AUTOMATIC_SUCCESS)</span>
<span class="nc bnc" id="L12960" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L12961" title="All 4 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)</span>
                &amp;&amp; (elev == 0)) {
<span class="nc" id="L12963">            PilotingRollData roll = entity.getBasePilotingRoll();</span>
<span class="nc" id="L12964">            roll.append(new PilotingRollData(entity.getId(), bgMod, &quot;avoid bogging down&quot;));</span>
<span class="nc" id="L12965">            int stuckroll = Compute.d6(2);</span>
            // A DFA-ing mech is &quot;displaced&quot; into the target hex. Since it
            // must be jumping, it will automatically be bogged down
<span class="nc bnc" id="L12968" title="All 4 branches missed.">            if (stuckroll &lt; roll.getValue() || entity.isMakingDfa()) {</span>
<span class="nc" id="L12969">                entity.setStuck(true);</span>
<span class="nc" id="L12970">                r = new Report(2081);</span>
<span class="nc" id="L12971">                r.subject = entity.getId();</span>
<span class="nc" id="L12972">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L12973">                vReport.add(r);</span>
                // check for quicksand
<span class="nc" id="L12975">                vReport.addAll(checkQuickSand(c));</span>
            }

        }
<span class="nc" id="L12979">        return vReport;</span>
    }

    /**
     * Receive a deployment packet. If valid, execute it and end the current
     * turn.
     */
    private void receiveDeployment(Packet packet, int connId) {
<span class="nc" id="L12987">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L12988">        Coords coords = (Coords) packet.getObject(1);</span>
<span class="nc" id="L12989">        int nFacing = packet.getIntValue(2);</span>
<span class="nc" id="L12990">        int elevation = packet.getIntValue(3);</span>

        // Handle units that deploy loaded with other units.
<span class="nc" id="L12993">        int loadedCount = packet.getIntValue(4);</span>
<span class="nc" id="L12994">        Vector&lt;Entity&gt; loadVector = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L12995" title="All 2 branches missed.">        for (int i = 0; i &lt; loadedCount; i++) {</span>
<span class="nc" id="L12996">            int loadedId = packet.getIntValue(6 + i);</span>
<span class="nc" id="L12997">            loadVector.addElement(game.getEntity(loadedId));</span>
        }

        // is this the right phase?
<span class="nc bnc" id="L13001" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc" id="L13002">            MegaMek.getLogger().error(&quot;Server got deployment packet in wrong phase&quot;);</span>
<span class="nc" id="L13003">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13007">        final boolean assaultDrop = packet.getBooleanValue(5);</span>
        // can this player/entity act right now?
<span class="nc" id="L13009">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13010" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13011">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L13013" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)</span>
<span class="nc bnc" id="L13014" title="All 4 branches missed.">                || !(game.getBoard().isLegalDeployment(coords, entity.getStartingPos())</span>
<span class="nc bnc" id="L13015" title="All 2 branches missed.">                || (assaultDrop &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_ASSAULT_DROP)</span>
<span class="nc bnc" id="L13016" title="All 2 branches missed.">                    &amp;&amp; entity.canAssaultDrop()))) {</span>
<span class="nc" id="L13017">            String msg = &quot;server got invalid deployment packet from &quot;</span>
                         + &quot;connection &quot; + connId;
<span class="nc bnc" id="L13019" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L13020">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L13022">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13024">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13025">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13026">            send(connId, createTurnIndexPacket(turn.getPlayerNum()));</span>
<span class="nc" id="L13027">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13031">        processDeployment(entity, coords, nFacing, elevation, loadVector, assaultDrop);</span>

        //Update Aero sensors for a space or atmospheric game
<span class="nc bnc" id="L13034" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L13035">            IAero a = (IAero) entity;</span>
<span class="nc" id="L13036">            a.updateSensorOptions();</span>
        }

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L13040" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L13041">            updateVisibilityIndicator(null);</span>
        }

<span class="nc" id="L13044">        endCurrentTurn(entity);</span>
<span class="nc" id="L13045">    }</span>

    /**
     * Used when an Entity that was loaded in another Entity in the Lounge is
     * unloaded during deployment.
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveDeploymentUnload(Packet packet, int connId) {
<span class="nc" id="L13054">        Entity loader = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13055">        Entity loaded = game.getEntity(packet.getIntValue(1));</span>

<span class="nc bnc" id="L13057" title="All 2 branches missed.">        if (game.getPhase() != Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc" id="L13058">            String msg = &quot;server received deployment unload packet &quot;</span>
                    + &quot;outside of deployment phase from connection &quot; + connId;
<span class="nc bnc" id="L13060" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L13061">                msg += &quot;, Entity: &quot; + loader.getShortName();</span>
            } else {
<span class="nc" id="L13063">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13065">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13066">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13070">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13071" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13072">            turn = game.getTurnForPlayer(connId);</span>
        }

<span class="nc bnc" id="L13075" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, loader, game)) {</span>
<span class="nc" id="L13076">            String msg = &quot;server got invalid deployment unload packet from connection &quot; + connId;</span>
<span class="nc bnc" id="L13077" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L13078">                msg += &quot;, Entity: &quot; + loader.getShortName();</span>
            } else {
<span class="nc" id="L13080">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13082">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13083">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13084">            send(connId, createTurnIndexPacket(connId));</span>
<span class="nc" id="L13085">            return;</span>
        }

        // Unload and call entityUpdate
<span class="nc" id="L13089">        unloadUnit(loader, loaded, null, 0, 0, false, true);</span>

        // Need to update the loader
<span class="nc" id="L13092">        entityUpdate(loader.getId());</span>

        // Now need to add a turn for the unloaded unit, to be taken immediately
        // Turn forced to be immediate to avoid messy turn ordering issues
        // (aka, how do we add the turn with individual initiative?)
<span class="nc" id="L13097">        game.insertTurnAfter(new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L13098">                loaded.getOwnerId(), loaded.getId()), game.getTurnIndex() - 1);</span>
        //game.insertNextTurn(new GameTurn.SpecificEntityTurn(
        //        loaded.getOwnerId(), loaded.getId()));
<span class="nc" id="L13101">        send(createTurnVectorPacket());</span>
<span class="nc" id="L13102">    }</span>


    /**
     * Process a deployment packet by... deploying the entity! We load any other
     * specified entities inside of it too. Also, check that the deployment is
     * valid.
     */
    private void processDeployment(Entity entity, Coords coords, int nFacing, int elevation, Vector&lt;Entity&gt; loadVector,
            boolean assaultDrop) {
<span class="nc bnc" id="L13112" title="All 2 branches missed.">        for (Entity loaded : loadVector) {</span>
<span class="nc bnc" id="L13113" title="All 2 branches missed.">            if (loaded.getTransportId() != Entity.NONE) {</span>
                // we probably already loaded this unit in the chat lounge
<span class="nc" id="L13115">                continue;</span>
            }
<span class="nc bnc" id="L13117" title="All 2 branches missed.">            if (loaded.getPosition() != null) {</span>
                // Something is fishy in Denmark.
<span class="nc" id="L13119">                MegaMek.getLogger().error(entity + &quot; can not load entity #&quot; + loaded);</span>
<span class="nc" id="L13120">                break;</span>
            }
            // Have the deployed unit load the indicated unit.
<span class="nc" id="L13123">            loadUnit(entity, loaded, loaded.getTargetBay());</span>
<span class="nc" id="L13124">        }</span>

        /*
         * deal with starting velocity for advanced movement. Probably not the
         * best place to do it, but what are you going to do
         */
<span class="nc bnc" id="L13130" title="All 4 branches missed.">        if (entity.isAero() &amp;&amp; game.useVectorMove()) {</span>
<span class="nc" id="L13131">            IAero a = (IAero) entity;</span>
<span class="nc" id="L13132">            int[] v = {0, 0, 0, 0, 0, 0};</span>

            // if this is the entity's first time deploying, we want to respect the &quot;velocity&quot; setting from the lobby
<span class="nc bnc" id="L13135" title="All 2 branches missed.">            if(entity.wasNeverDeployed()) {</span>
<span class="nc bnc" id="L13136" title="All 2 branches missed.">                if (a.getCurrentVelocityActual() &gt; 0) {</span>
<span class="nc" id="L13137">                    v[nFacing] = a.getCurrentVelocityActual();</span>
<span class="nc" id="L13138">                    entity.setVectors(v);</span>
                }
            // this means the entity is coming back from off board, so we'll rotate the velocity vector by 180
            // and set it to 1/2 the magnitude
            } else {
<span class="nc bnc" id="L13143" title="All 2 branches missed.">                for(int x = 0; x &lt; 6; x++) {</span>
<span class="nc" id="L13144">                    v[(x + 3) % 6] = entity.getVector(x) / 2;</span>
                }

<span class="nc" id="L13147">                entity.setVectors(v);</span>
            }
        }

<span class="nc" id="L13151">        entity.setPosition(coords);</span>
<span class="nc" id="L13152">        entity.setFacing(nFacing);</span>
<span class="nc" id="L13153">        entity.setSecondaryFacing(nFacing);</span>
<span class="nc" id="L13154">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L13155" title="All 2 branches missed.">        if (assaultDrop) {</span>
<span class="nc" id="L13156">            entity.setAltitude(1);</span>
            // from the sky!
<span class="nc" id="L13158">            entity.setAssaultDropInProgress(true);</span>
<span class="nc bnc" id="L13159" title="All 4 branches missed.">        } else if ((entity instanceof VTOL) &amp;&amp; (entity.getExternalUnits().size() &lt;= 0)) {</span>
            // We should let players pick, but this simplifies a lot.
            // Only do it for VTOLs, though; assume everything else is on the
            // ground.
<span class="nc" id="L13163">            entity.setElevation((hex.ceiling() - hex.surface()) + 1);</span>
<span class="nc bnc" id="L13164" title="All 2 branches missed.">            while ((Compute.stackingViolation(game, entity, coords, null) != null)</span>
<span class="nc bnc" id="L13165" title="All 2 branches missed.">                   &amp;&amp; (entity.getElevation() &lt;= 50)) {</span>
<span class="nc" id="L13166">                entity.setElevation(entity.getElevation() + 1);</span>
            }
<span class="nc bnc" id="L13168" title="All 2 branches missed.">            if (entity.getElevation() &gt; 50) {</span>
<span class="nc" id="L13169">                throw new IllegalStateException(&quot;Entity #&quot; + entity.getId()</span>
                        + &quot; appears to be in an infinite loop trying to get a legal elevation.&quot;);
            }
<span class="nc bnc" id="L13172" title="All 2 branches missed.">        } else if (entity.isAero()) {</span>
            // if the entity is airborne, then we don't want to set its
            // elevation below, because that will
            // default to 999
<span class="nc bnc" id="L13176" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L13177">                entity.setElevation(0);</span>
<span class="nc" id="L13178">                elevation = 0;</span>
            }
<span class="nc bnc" id="L13180" title="All 2 branches missed.">            if (!game.getBoard().inSpace()) {</span>
                // all spheroid craft should have velocity of zero in atmosphere
                // regardless of what was entered
<span class="nc" id="L13183">                IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L13184" title="All 4 branches missed.">                if (a.isSpheroid() || game.getPlanetaryConditions().isVacuum()) {</span>
<span class="nc" id="L13185">                    a.setCurrentVelocity(0);</span>
<span class="nc" id="L13186">                    a.setNextVelocity(0);</span>
                }
                // make sure that entity is above the level of the hex if in
                // atmosphere
<span class="nc bnc" id="L13190" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()</span>
<span class="nc bnc" id="L13191" title="All 2 branches missed.">                    &amp;&amp; (entity.getAltitude() &lt;= hex.ceiling(true))) {</span>
                    // you can't be grounded on low atmosphere map
<span class="nc" id="L13193">                    entity.setAltitude(hex.ceiling(true) + 1);</span>
                }
<span class="nc" id="L13195">            }</span>
<span class="nc bnc" id="L13196" title="All 2 branches missed.">        } else if (entity.getMovementMode() == EntityMovementMode.SUBMARINE) {</span>
            // TODO : Submarines should have a selectable height.
            // TODO : For now, pretend they're regular naval.
<span class="nc" id="L13199">            entity.setElevation(0);</span>
<span class="nc bnc" id="L13200" title="All 2 branches missed.">        } else if ((entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L13201" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L13202" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L13203" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.HYDROFOIL)) {</span>
            // For now, assume they're on the surface.
            // entity elevation is relative to hex surface
<span class="nc" id="L13206">            entity.setElevation(0);</span>
<span class="nc bnc" id="L13207" title="All 2 branches missed.">        } else if (hex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L13208">            entity.setElevation(0);</span>
        } else {
<span class="nc" id="L13210">            Building bld = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L13211" title="All 4 branches missed.">            if ((bld != null) &amp;&amp; (bld.getType() == Building.WALL)) {</span>
<span class="nc" id="L13212">                entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
            }

        }
        // add the elevation that was passed into this method
        // TODO : currently only used for building placement, we should do this
        // TODO : more systematically with up/down buttons in the deployment display
<span class="nc" id="L13219">        entity.setElevation(entity.getElevation() + elevation);</span>
<span class="nc bnc" id="L13220" title="All 2 branches missed.">        boolean wigeFlyover = entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L13221" title="All 2 branches missed.">                &amp;&amp; hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L13222" title="All 2 branches missed.">                &amp;&amp; entity.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV);</span>


        // when first entering a building, we need to roll what type
        // of basement it has
<span class="nc" id="L13227">        Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L13228" title="All 2 branches missed.">        if ((bldg != null)) {</span>
<span class="nc bnc" id="L13229" title="All 2 branches missed.">            if (bldg.rollBasement(entity.getPosition(), game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L13230">                sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L13231">                Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L13232">                buildings.add(bldg);</span>
<span class="nc" id="L13233">                sendChangedBuildings(buildings);</span>
            }
<span class="nc" id="L13235">            boolean collapse = checkBuildingCollapseWhileMoving(bldg, entity, entity.getPosition());</span>
<span class="nc bnc" id="L13236" title="All 2 branches missed.">            if (collapse) {</span>
<span class="nc" id="L13237">                addAffectedBldg(bldg, true);</span>
<span class="nc bnc" id="L13238" title="All 2 branches missed.">                if (wigeFlyover) {</span>
                // If the building is collapsed by a WiGE flying over it, the WiGE drops one level of elevation.
<span class="nc" id="L13240">                    entity.setElevation(entity.getElevation() - 1);</span>
                }
            }
        }

<span class="nc" id="L13245">        entity.setDone(true);</span>
<span class="nc" id="L13246">        entity.setDeployed(true);</span>
<span class="nc" id="L13247">        entityUpdate(entity.getId());</span>
<span class="nc" id="L13248">        addReport(doSetLocationsExposure(entity, hex, false, entity.getElevation()));</span>
<span class="nc" id="L13249">    }</span>

    /**
     * receive a packet that contains hexes that are automatically hit by
     * artillery
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveArtyAutoHitHexes(Packet packet, int connId) {
<span class="nc" id="L13260">        PlayerIDandList&lt;Coords&gt; artyAutoHitHexes = (PlayerIDandList&lt;Coords&gt;) packet</span>
<span class="nc" id="L13261">                .getObject(0);</span>

<span class="nc" id="L13263">        int playerId = artyAutoHitHexes.getPlayerID();</span>

        // is this the right phase?
<span class="nc bnc" id="L13266" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES) {</span>
<span class="nc" id="L13267">            MegaMek.getLogger().error(&quot;Server got set artyautohithexespacket in wrong phase&quot;);</span>
<span class="nc" id="L13268">            return;</span>
        }
<span class="nc" id="L13270">        game.getPlayer(playerId).setArtyAutoHitHexes(artyAutoHitHexes);</span>

<span class="nc bnc" id="L13272" title="All 2 branches missed.">        for (Coords coord : artyAutoHitHexes) {</span>
<span class="nc" id="L13273">            game.getBoard().addSpecialHexDisplay(coord,</span>
                    new SpecialHexDisplay(
                            SpecialHexDisplay.Type.ARTILLERY_AUTOHIT,
<span class="nc" id="L13276">                            SpecialHexDisplay.NO_ROUND, getPlayer(playerId),</span>
                            &quot;Artillery auto hit hex, for &quot;
<span class="nc" id="L13278">                            + getPlayer(playerId).getName(),</span>
                            SpecialHexDisplay.SHD_OBSCURED_TEAM));
<span class="nc" id="L13280">        }</span>
<span class="nc" id="L13281">        endCurrentTurn(null);</span>
<span class="nc" id="L13282">    }</span>

    /**
     * receive a packet that contains minefields
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveDeployMinefields(Packet packet, int connId) {
<span class="nc" id="L13292">        Vector&lt;Minefield&gt; minefields = (Vector&lt;Minefield&gt;) packet.getObject(0);</span>

        // is this the right phase?
<span class="nc bnc" id="L13295" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_DEPLOY_MINEFIELDS) {</span>
<span class="nc" id="L13296">            MegaMek.getLogger().error(&quot;Server got deploy minefields packet in wrong phase&quot;);</span>
<span class="nc" id="L13297">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13301">        processDeployMinefields(minefields);</span>
<span class="nc" id="L13302">        endCurrentTurn(null);</span>
<span class="nc" id="L13303">    }</span>

    /**
     * process deployment of minefields
     *
     * @param minefields
     */
    private void processDeployMinefields(Vector&lt;Minefield&gt; minefields) {
<span class="nc" id="L13311">        int playerId = IPlayer.PLAYER_NONE;</span>
<span class="nc bnc" id="L13312" title="All 2 branches missed.">        for (int i = 0; i &lt; minefields.size(); i++) {</span>
<span class="nc" id="L13313">            Minefield mf = minefields.elementAt(i);</span>
<span class="nc" id="L13314">            playerId = mf.getPlayerId();</span>

<span class="nc" id="L13316">            game.addMinefield(mf);</span>
<span class="nc bnc" id="L13317" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L13318">                game.addVibrabomb(mf);</span>
            }
        }

<span class="nc" id="L13322">        IPlayer player = game.getPlayer(playerId);</span>
<span class="nc bnc" id="L13323" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L13324">            int teamId = player.getTeam();</span>

<span class="nc bnc" id="L13326" title="All 2 branches missed.">            if (teamId != IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L13327">                Enumeration&lt;Team&gt; teams = game.getTeams();</span>
<span class="nc bnc" id="L13328" title="All 2 branches missed.">                while (teams.hasMoreElements()) {</span>
<span class="nc" id="L13329">                    Team team = teams.nextElement();</span>
<span class="nc bnc" id="L13330" title="All 2 branches missed.">                    if (team.getId() == teamId) {</span>
<span class="nc" id="L13331">                        Enumeration&lt;IPlayer&gt; players = team.getPlayers();</span>
<span class="nc bnc" id="L13332" title="All 2 branches missed.">                        while (players.hasMoreElements()) {</span>
<span class="nc" id="L13333">                            IPlayer teamPlayer = players.nextElement();</span>
<span class="nc bnc" id="L13334" title="All 2 branches missed.">                            if (teamPlayer.getId() != player.getId()) {</span>
<span class="nc" id="L13335">                                send(teamPlayer.getId(), new Packet(Packet.COMMAND_DEPLOY_MINEFIELDS,</span>
                                        minefields));
                            }
<span class="nc" id="L13338">                            teamPlayer.addMinefields(minefields);</span>
<span class="nc" id="L13339">                        }</span>
                        break;
                    }
<span class="nc" id="L13342">                }</span>
<span class="nc" id="L13343">            } else {</span>
<span class="nc" id="L13344">                player.addMinefields(minefields);</span>
            }
        }
<span class="nc" id="L13347">    }</span>

    /**
     * Client has sent an update indicating that a ground unit is firing at
     * an airborne unit and is overriding the default select for the position
     * in the flight path.
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveGroundToAirHexSelectPacket(Packet packet, int connId) {
<span class="nc" id="L13357">        Integer targetId = (Integer)packet.getObject(0);</span>
<span class="nc" id="L13358">        Integer attackerId = (Integer)packet.getObject(1);</span>
<span class="nc" id="L13359">        Coords pos = (Coords)packet.getObject(2);</span>
<span class="nc" id="L13360">        game.getEntity(targetId).setPlayerPickedPassThrough(attackerId, pos);</span>
<span class="nc" id="L13361">    }</span>

    /**
     * Gets a bunch of entity attacks from the packet. If valid, processes them
     * and ends the current turn.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveAttack(Packet packet, int connId) {
<span class="nc" id="L13369">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13370">        Vector&lt;EntityAction&gt; vector = (Vector&lt;EntityAction&gt;) packet.getObject(1);</span>

        // is this the right phase?
<span class="nc bnc" id="L13373" title="All 2 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L13374" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_PHYSICAL)</span>
<span class="nc bnc" id="L13375" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L13376" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_OFFBOARD)) {</span>
<span class="nc" id="L13377">            MegaMek.getLogger().error(&quot;Server got attack packet in wrong phase&quot;);</span>
<span class="nc" id="L13378">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13382">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13383" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13384">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L13386" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)) {</span>
<span class="nc" id="L13387">            String msg = &quot;error: server got invalid attack packet from connection &quot; + connId;</span>
<span class="nc bnc" id="L13388" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L13389">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L13391">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13393">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13394">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13395">            send(connId, createTurnIndexPacket(turn.getPlayerNum()));</span>
<span class="nc" id="L13396">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13400">        processAttack(entity, vector);</span>

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L13403" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L13404">            updateVisibilityIndicator(null);</span>
        }

<span class="nc" id="L13407">        endCurrentTurn(entity);</span>
<span class="nc" id="L13408">    }</span>

    /**
     * Process a batch of entity attack (or twist) actions by adding them to the
     * proper list to be processed later.
     */
    private void processAttack(Entity entity, Vector&lt;EntityAction&gt; vector) {
        // Convert any null vectors to empty vectors to avoid NPEs.
<span class="nc bnc" id="L13416" title="All 2 branches missed.">        if (vector == null) {</span>
<span class="nc" id="L13417">            vector = new Vector&lt;&gt;(0);</span>
        }

        // Not **all** actions take up the entity's turn.
<span class="nc bnc" id="L13421" title="All 2 branches missed.">        boolean setDone = !((game.getTurn() instanceof GameTurn.TriggerAPPodTurn)</span>
<span class="nc bnc" id="L13422" title="All 2 branches missed.">                || (game.getTurn() instanceof GameTurn.TriggerBPodTurn));</span>
<span class="nc bnc" id="L13423" title="All 2 branches missed.">        for (EntityAction ea : vector) {</span>
            // is this the right entity?
<span class="nc bnc" id="L13425" title="All 2 branches missed.">            if (ea.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L13426">                MegaMek.getLogger().error(&quot;Attack packet has wrong attacker&quot;);</span>
<span class="nc" id="L13427">                continue;</span>
            }
<span class="nc bnc" id="L13429" title="All 2 branches missed.">            if (ea instanceof PushAttackAction) {</span>
                // push attacks go the end of the displacement attacks
<span class="nc" id="L13431">                PushAttackAction paa = (PushAttackAction) ea;</span>
<span class="nc" id="L13432">                entity.setDisplacementAttack(paa);</span>
<span class="nc" id="L13433">                game.addCharge(paa);</span>
<span class="nc bnc" id="L13434" title="All 2 branches missed.">            } else if (ea instanceof DodgeAction) {</span>
<span class="nc" id="L13435">                entity.dodging = true;</span>
<span class="nc bnc" id="L13436" title="All 2 branches missed.">            } else if (ea instanceof SpotAction) {</span>
<span class="nc" id="L13437">                entity.setSpotting(true);</span>
<span class="nc" id="L13438">                entity.setSpotTargetId(((SpotAction) ea).getTargetId());</span>
            } else {
                // add to the normal attack list.
<span class="nc" id="L13441">                game.addAction(ea);</span>
            }

            // Anti-mech and pointblank attacks from
            // hiding may allow the target to respond.
<span class="nc bnc" id="L13446" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L13447">                final WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L13448">                final String weaponName = entity.getEquipment(waa.getWeaponId()).getType()</span>
<span class="nc" id="L13449">                        .getInternalName();</span>

<span class="nc bnc" id="L13451" title="All 4 branches missed.">                if (Infantry.SWARM_MEK.equals(weaponName) || Infantry.LEG_ATTACK.equals(weaponName)) {</span>

                    // Does the target have any AP Pods available?
<span class="nc" id="L13454">                    final Entity target = game.getEntity(waa.getTargetId());</span>
<span class="nc bnc" id="L13455" title="All 2 branches missed.">                    for (Mounted equip : target.getMisc()) {</span>
<span class="nc bnc" id="L13456" title="All 4 branches missed.">                        if (equip.getType().hasFlag(MiscType.F_AP_POD) &amp;&amp; equip.canFire()) {</span>

                            // Yup. Insert a game turn to handle AP pods.
                            // ASSUMPTION : AP pod declarations come
                            // immediately after the attack declaration.
<span class="nc" id="L13461">                            game.insertNextTurn(new GameTurn.TriggerAPPodTurn(target.getOwnerId(),</span>
<span class="nc" id="L13462">                                    target.getId()));</span>
<span class="nc" id="L13463">                            send(createTurnVectorPacket());</span>

                            // We can stop looking.
<span class="nc" id="L13466">                            break;</span>

                        } // end found-available-ap-pod

<span class="nc" id="L13470">                    } // Check the next piece of equipment on the target.</span>

<span class="nc bnc" id="L13472" title="All 2 branches missed.">                    for (Mounted weapon : target.getWeaponList()) {</span>
<span class="nc bnc" id="L13473" title="All 4 branches missed.">                        if (weapon.getType().hasFlag(WeaponType.F_B_POD) &amp;&amp; weapon.canFire()) {</span>

                            // Yup. Insert a game turn to handle B pods.
                            // ASSUMPTION : B pod declarations come
                            // immediately after the attack declaration.
<span class="nc" id="L13478">                            game.insertNextTurn(new GameTurn.TriggerBPodTurn(target.getOwnerId(),</span>
<span class="nc" id="L13479">                                    target.getId(), weaponName));</span>
<span class="nc" id="L13480">                            send(createTurnVectorPacket());</span>

                            // We can stop looking.
<span class="nc" id="L13483">                            break;</span>

                        } // end found-available-b-pod
<span class="nc" id="L13486">                    } // Check the next piece of equipment on the target.</span>
                } // End check-for-available-ap-pod

                // Keep track of altitude loss for weapon attacks
<span class="nc bnc" id="L13490" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L13491">                    IAero aero = (IAero) entity;</span>
<span class="nc bnc" id="L13492" title="All 2 branches missed.">                    if (waa.getAltitudeLoss(game) &gt; aero.getAltLoss()) {</span>
<span class="nc" id="L13493">                        aero.setAltLoss(waa.getAltitudeLoss(game));</span>
                    }
                }
            }

            // If attacker breaks grapple, defender may counter
<span class="nc bnc" id="L13499" title="All 2 branches missed.">            if (ea instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L13500">                final BreakGrappleAttackAction bgaa = (BreakGrappleAttackAction) ea;</span>
<span class="nc" id="L13501">                final Entity att = (game.getEntity(bgaa.getEntityId()));</span>
<span class="nc bnc" id="L13502" title="All 2 branches missed.">                if (att.isGrappleAttacker()) {</span>
<span class="nc" id="L13503">                    final Entity def = (game.getEntity(bgaa.getTargetId()));</span>
                    // Remove existing break grapple by defender (if exists)
<span class="nc bnc" id="L13505" title="All 2 branches missed.">                    if (def.isDone()) {</span>
<span class="nc" id="L13506">                        game.removeActionsFor(def.getId());</span>
                    } else {
<span class="nc" id="L13508">                        game.removeTurnFor(def);</span>
<span class="nc" id="L13509">                        def.setDone(true);</span>
                    }
                    // If defender is able, add a turn to declare counterattack
<span class="nc bnc" id="L13512" title="All 2 branches missed.">                    if (!def.isImmobile()) {</span>
<span class="nc" id="L13513">                        game.insertNextTurn(new GameTurn.CounterGrappleTurn(def.getOwnerId(), def.getId()));</span>
<span class="nc" id="L13514">                        send(createTurnVectorPacket());</span>
                    }
                }
            }
<span class="nc bnc" id="L13518" title="All 2 branches missed.">            if (ea instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L13519">                boolean firingAtNewHex = false;</span>
<span class="nc" id="L13520">                final ArtilleryAttackAction aaa = (ArtilleryAttackAction) ea;</span>
<span class="nc" id="L13521">                final Entity firingEntity = game.getEntity(aaa.getEntityId());</span>
<span class="nc" id="L13522">                for (Enumeration&lt;AttackHandler&gt; j = game.getAttacks(); !firingAtNewHex</span>
<span class="nc bnc" id="L13523" title="All 4 branches missed.">                        &amp;&amp; j.hasMoreElements(); ) {</span>
<span class="nc" id="L13524">                    WeaponHandler wh = (WeaponHandler) j.nextElement();</span>
<span class="nc bnc" id="L13525" title="All 2 branches missed.">                    if (wh.waa instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L13526">                        ArtilleryAttackAction oaaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc bnc" id="L13527" title="All 2 branches missed.">                        if ((oaaa.getEntityId() == aaa.getEntityId())</span>
<span class="nc" id="L13528">                            &amp;&amp; !oaaa.getTarget(game).getPosition()</span>
<span class="nc bnc" id="L13529" title="All 2 branches missed.">                                .equals(aaa.getTarget(game).getPosition())) {</span>
<span class="nc" id="L13530">                            firingAtNewHex = true;</span>
                        }
                    }
<span class="nc" id="L13533">                }</span>
<span class="nc bnc" id="L13534" title="All 2 branches missed.">                if (firingAtNewHex) {</span>
<span class="nc" id="L13535">                    clearArtillerySpotters(firingEntity.getId(), aaa.getWeaponId());</span>
                }
<span class="nc" id="L13537">                Iterator&lt;Entity&gt; spotters = game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L13538">                            public int player = firingEntity.getOwnerId();</span>
<span class="nc" id="L13539">                            public Targetable target = aaa.getTarget(game);</span>

                            public boolean accept(Entity entity) {
<span class="nc" id="L13542">                                LosEffects los = LosEffects.calculateLos(game, entity.getId(), target);</span>
<span class="nc bnc" id="L13543" title="All 4 branches missed.">                                return ((player == entity.getOwnerId()) &amp;&amp; !(los.isBlocked())</span>
<span class="nc bnc" id="L13544" title="All 2 branches missed.">                                        &amp;&amp; entity.isActive());</span>
                            }
                        });
<span class="nc" id="L13547">                Vector&lt;Integer&gt; spotterIds = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L13548" title="All 2 branches missed.">                while (spotters.hasNext()) {</span>
<span class="nc" id="L13549">                    Integer id = spotters.next().getId();</span>
<span class="nc" id="L13550">                    spotterIds.addElement(id);</span>
<span class="nc" id="L13551">                }</span>
<span class="nc" id="L13552">                aaa.setSpotterIds(spotterIds);</span>
            }

            // The equipment type of a club needs to be restored.
<span class="nc bnc" id="L13556" title="All 2 branches missed.">            if (ea instanceof ClubAttackAction) {</span>
<span class="nc" id="L13557">                ClubAttackAction caa = (ClubAttackAction) ea;</span>
<span class="nc" id="L13558">                Mounted club = caa.getClub();</span>
<span class="nc" id="L13559">                club.restore();</span>
            }

            // Mark any AP Pod as used in this turn.
<span class="nc bnc" id="L13563" title="All 2 branches missed.">            if (ea instanceof TriggerAPPodAction) {</span>
<span class="nc" id="L13564">                TriggerAPPodAction tapa = (TriggerAPPodAction) ea;</span>
<span class="nc" id="L13565">                Mounted pod = entity.getEquipment(tapa.getPodId());</span>
<span class="nc" id="L13566">                pod.setUsedThisRound(true);</span>
            }
            // Mark any B Pod as used in this turn.
<span class="nc bnc" id="L13569" title="All 2 branches missed.">            if (ea instanceof TriggerBPodAction) {</span>
<span class="nc" id="L13570">                TriggerBPodAction tba = (TriggerBPodAction) ea;</span>
<span class="nc" id="L13571">                Mounted pod = entity.getEquipment(tba.getPodId());</span>
<span class="nc" id="L13572">                pod.setUsedThisRound(true);</span>
            }

            // Mark illuminated hexes, so they can be displayed
<span class="nc bnc" id="L13576" title="All 2 branches missed.">            if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L13577">                boolean hexesAdded =</span>
<span class="nc" id="L13578">                        ((SearchlightAttackAction) ea).setHexesIlluminated(game);</span>
                // If we added new hexes, send them to all players.
                // These are spotlights at night, you know they're there.
<span class="nc bnc" id="L13581" title="All 2 branches missed.">                if (hexesAdded) {</span>
<span class="nc" id="L13582">                    send(createIlluminatedHexesPacket());</span>
                }
            }
<span class="nc" id="L13585">        }</span>

        // Apply altitude loss
<span class="nc bnc" id="L13588" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L13589">            IAero aero = (IAero) entity;</span>
<span class="nc bnc" id="L13590" title="All 2 branches missed.">            if (aero.getAltLoss() &gt; 0) {</span>
<span class="nc" id="L13591">                Report r = new Report(9095);</span>
<span class="nc" id="L13592">                r.subject = entity.getId();</span>
<span class="nc" id="L13593">                r.addDesc(entity);</span>
<span class="nc" id="L13594">                r.add(aero.getAltLoss());</span>
<span class="nc" id="L13595">                addReport(r);</span>
<span class="nc" id="L13596">                entity.setAltitude(entity.getAltitude() - aero.getAltLoss());</span>
<span class="nc" id="L13597">                aero.setAltLossThisRound(aero.getAltLoss());</span>
<span class="nc" id="L13598">                aero.resetAltLoss();</span>
<span class="nc" id="L13599">                entityUpdate(entity.getId());</span>
            }
        }

        // Unless otherwise stated,
        // this entity is done for the round.
<span class="nc bnc" id="L13605" title="All 2 branches missed.">        if (setDone) {</span>
<span class="nc" id="L13606">            entity.setDone(true);</span>
        }
<span class="nc" id="L13608">        entityUpdate(entity.getId());</span>

<span class="nc" id="L13610">        Packet p = createAttackPacket(vector, 0);</span>
<span class="nc bnc" id="L13611" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
            // Update attack only to player who declared it &amp; observers
<span class="nc bnc" id="L13613" title="All 2 branches missed.">            for (IPlayer player : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L13614" title="All 4 branches missed.">                if (player.canSeeAll() || player.isObserver()</span>
<span class="nc bnc" id="L13615" title="All 2 branches missed.">                    || (entity.getOwnerId() == player.getId())) {</span>
<span class="nc" id="L13616">                    send(player.getId(), p);</span>
                }
<span class="nc" id="L13618">            }</span>
        } else {
            // update all players on the attacks. Don't worry about pushes being
            // a &quot;charge&quot; attack. It doesn't matter to the client.
<span class="nc" id="L13622">            send(p);</span>
        }
<span class="nc" id="L13624">    }</span>

    /**
     * Determine which telemissile attack actions could be affected by AMS, and
     * assign AMS to those attacks.
     */
    public void assignTeleMissileAMS(TeleMissileAttackAction taa) {
        // Map target to a list of telemissile attacks directed at entities
<span class="nc" id="L13632">        Hashtable&lt;Entity, Vector&lt;AttackAction&gt;&gt; htTMAttacks = new Hashtable&lt;&gt;();</span>

        //This should be impossible but just in case...
<span class="nc bnc" id="L13635" title="All 2 branches missed.">        if (taa == null) {</span>
<span class="nc" id="L13636">            MegaMek.getLogger().error(&quot;Null TeleMissileAttackAction!&quot;);</span>
        }

<span class="nc bnc" id="L13639" title="All 2 branches missed.">        Entity target = (taa.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc" id="L13640">                ? (Entity) taa.getTarget(game) : null;</span>

        //If a telemissile is still on the board and its original target is not....
<span class="nc bnc" id="L13643" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L13644">            MegaMek.getLogger().info(&quot;Telemissile has no target. AMS not assigned.&quot;);</span>
<span class="nc" id="L13645">            return;</span>
        }

<span class="nc" id="L13648">        Vector&lt;AttackAction&gt; v = htTMAttacks.computeIfAbsent(target, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13649">        v.addElement(taa);</span>
        // Let each target assign its AMS
<span class="nc bnc" id="L13651" title="All 2 branches missed.">        for (Entity e : htTMAttacks.keySet()) {</span>
<span class="nc" id="L13652">            Vector&lt;AttackAction&gt; vTMAttacks = htTMAttacks.get(e);</span>
            // Allow MM to automatically assign AMS targets
            // AMS bays can fire multiple times, so manual target assignment is kind of pointless
<span class="nc" id="L13655">            e.assignTMAMS(vTMAttacks);</span>
<span class="nc" id="L13656">        }</span>
<span class="nc" id="L13657">    }</span>

    /**
     * Determine which missile attack actions could be affected by AMS, and
     * assign AMS (and APDS) to those attacks.
     */
    public void assignAMS() {
        // Get all of the coords that would be protected by APDS
<span class="nc" id="L13665">        Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; apdsCoords = getAPDSProtectedCoords();</span>
        // Map target to a list of missile attacks directed at it
<span class="nc" id="L13667">        Hashtable&lt;Entity, Vector&lt;WeaponHandler&gt;&gt; htAttacks = new Hashtable&lt;&gt;();</span>
        // Keep track of each APDS, and which attacks it could affect
<span class="nc" id="L13669">        Hashtable&lt;Mounted, Vector&lt;WeaponHandler&gt;&gt; apdsTargets = new Hashtable&lt;&gt;();</span>

<span class="nc bnc" id="L13671" title="All 2 branches missed.">        for (AttackHandler ah : game.getAttacksVector()) {</span>
<span class="nc" id="L13672">            WeaponHandler wh = (WeaponHandler) ah;</span>
<span class="nc" id="L13673">            WeaponAttackAction waa = wh.waa;</span>

            // for artillery attacks, the attacking entity
            // might no longer be in the game.
            //TODO : Yeah, I know there's an exploit here, but better able to shoot some ArrowIVs than none, right?
<span class="nc bnc" id="L13678" title="All 2 branches missed.">            if (game.getEntity(waa.getEntityId()) == null) {</span>
<span class="nc" id="L13679">                MegaMek.getLogger().info(&quot;Can't Assign AMS: Artillery firer is null!&quot;);</span>
<span class="nc" id="L13680">                continue;</span>
            }

<span class="nc" id="L13683">            Mounted weapon = game.getEntity(waa.getEntityId()).getEquipment(waa.getWeaponId());</span>

            // Only entities can have AMS. Arrow IV doesn't target an entity until later, so we have to ignore them
<span class="nc bnc" id="L13686" title="All 4 branches missed.">            if (!(waa instanceof ArtilleryAttackAction) &amp;&amp; (Targetable.TYPE_ENTITY != waa.getTargetType())) {</span>
<span class="nc" id="L13687">                continue;</span>
            }

            // AMS is only used against attacks that hit (TW p129)
<span class="nc bnc" id="L13691" title="All 2 branches missed.">            if (wh.roll &lt; wh.toHit.getValue()) {</span>
<span class="nc" id="L13692">                continue;</span>
            }
            
            // Can only use AMS versus missiles. Artillery Bays might be firing Arrow IV homing missiles,
            // but lack the flag
<span class="nc" id="L13697">            boolean isHomingMissile = false;</span>
<span class="nc bnc" id="L13698" title="All 4 branches missed.">            if (wh instanceof ArtilleryWeaponIndirectHomingHandler</span>
                    || wh instanceof ArtilleryBayWeaponIndirectHomingHandler) {
<span class="nc" id="L13700">                Mounted ammoUsed = game.getEntity(waa.getEntityId()).getEquipment(waa.getAmmoId());</span>
<span class="nc bnc" id="L13701" title="All 2 branches missed.">                AmmoType atype = ammoUsed == null ? null : (AmmoType) ammoUsed.getType();</span>
<span class="nc bnc" id="L13702" title="All 2 branches missed.">                if (atype != null </span>
<span class="nc bnc" id="L13703" title="All 4 branches missed.">                        &amp;&amp; (atype.getAmmoType() == AmmoType.T_ARROW_IV || atype.getAmmoType() == BombType.B_HOMING)) {</span>
<span class="nc" id="L13704">                    isHomingMissile = true;</span>
                }
            }
<span class="nc bnc" id="L13707" title="All 4 branches missed.">            if (!weapon.getType().hasFlag(WeaponType.F_MISSILE) &amp;&amp; !isHomingMissile) {</span>
<span class="nc" id="L13708">                continue;</span>
            }

            // For Bearings-only Capital Missiles, don't assign during the offboard phase
<span class="nc bnc" id="L13712" title="All 2 branches missed.">            if (wh instanceof CapitalMissileBearingsOnlyHandler) {</span>
<span class="nc" id="L13713">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) waa;</span>
<span class="nc bnc" id="L13714" title="All 4 branches missed.">                if (aaa.getTurnsTilHit() &gt; 0 || game.getPhase() != IGame.Phase.PHASE_FIRING) {</span>
<span class="nc" id="L13715">                    continue;</span>
                }
            }

            // For Arrow IV homing artillery
            Entity target;
<span class="nc bnc" id="L13721" title="All 2 branches missed.">            if (waa instanceof ArtilleryAttackAction) {</span>
<span class="nc bnc" id="L13722" title="All 2 branches missed.">                target = (waa.getTargetType() == Targetable.TYPE_ENTITY) ? (Entity) waa</span>
<span class="nc" id="L13723">                    .getTarget(game) : null;</span>

                // In case our target really is null.
<span class="nc bnc" id="L13726" title="All 2 branches missed.">                if (target == null) {</span>
<span class="nc" id="L13727">                    continue;</span>
                }
            } else {
<span class="nc" id="L13730">                target = game.getEntity(waa.getTargetId());</span>
            }
<span class="nc" id="L13732">            Vector&lt;WeaponHandler&gt; v = htAttacks.computeIfAbsent(target, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13733">            v.addElement(wh);</span>
            // Keep track of what weapon attacks could be affected by APDS
<span class="nc bnc" id="L13735" title="All 2 branches missed.">            if (apdsCoords.containsKey(target.getPosition())) {</span>
<span class="nc bnc" id="L13736" title="All 2 branches missed.">                for (Mounted apds : apdsCoords.get(target.getPosition())) {</span>
                    // APDS only affects attacks against friendly units
<span class="nc bnc" id="L13738" title="All 2 branches missed.">                    if (target.isEnemyOf(apds.getEntity())) {</span>
<span class="nc" id="L13739">                        continue;</span>
                    }
<span class="nc" id="L13741">                    Vector&lt;WeaponHandler&gt; handlerList = apdsTargets.computeIfAbsent(apds, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13742">                    handlerList.add(wh);</span>
<span class="nc" id="L13743">                }</span>
            }
<span class="nc" id="L13745">        }</span>
        
        // Let each target assign its AMS
<span class="nc bnc" id="L13748" title="All 2 branches missed.">        for (Entity e : htAttacks.keySet()) {</span>
<span class="nc" id="L13749">            Vector&lt;WeaponHandler&gt; vAttacks = htAttacks.get(e);</span>
            // Allow MM to automatically assign AMS targets
<span class="nc bnc" id="L13751" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.BASE_AUTO_AMS)) {</span>
<span class="nc" id="L13752">                e.assignAMS(vAttacks);</span>
            } else { // Allow user to manually assign targets
<span class="nc" id="L13754">                manuallyAssignAMSTarget(e, vAttacks);</span>
            }
<span class="nc" id="L13756">        }</span>

        // Let each APDS assign itself to an attack
<span class="nc" id="L13759">        Set&lt;WeaponAttackAction&gt; targetedAttacks = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L13760" title="All 2 branches missed.">        for (Mounted apds : apdsTargets.keySet()) {</span>
<span class="nc" id="L13761">            List&lt;WeaponHandler&gt; potentialTargets = apdsTargets.get(apds);</span>
            // Ensure we only target each attack once
<span class="nc" id="L13763">            List&lt;WeaponHandler&gt; targetsToRemove = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L13764" title="All 2 branches missed.">            for (WeaponHandler wh : potentialTargets) {</span>
<span class="nc bnc" id="L13765" title="All 2 branches missed.">                if (targetedAttacks.contains(wh.getWaa())) {</span>
<span class="nc" id="L13766">                    targetsToRemove.add(wh);</span>
                }
<span class="nc" id="L13768">            }</span>
<span class="nc" id="L13769">            potentialTargets.removeAll(targetsToRemove);</span>
            WeaponAttackAction targetedWAA;
            // Assign APDS to an attack
<span class="nc bnc" id="L13772" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.BASE_AUTO_AMS)) {</span>
<span class="nc" id="L13773">                targetedWAA = apds.assignAPDS(potentialTargets);</span>
            } else { // Allow user to manually assign targets
<span class="nc" id="L13775">                targetedWAA = manuallyAssignAPDSTarget(apds, potentialTargets);</span>
            }
<span class="nc bnc" id="L13777" title="All 2 branches missed.">            if (targetedWAA != null) {</span>
<span class="nc" id="L13778">                targetedAttacks.add(targetedWAA);</span>
            }
<span class="nc" id="L13780">        }</span>

<span class="nc" id="L13782">    }</span>

    /**
     * Convenience method for determining which missile attack will be targeted
     * with AMS on the supplied Entity
     *
     * @param apds
     *            The Entity with AMS
     * @param vAttacks
     *            List of missile attacks directed at e
     */
    private WeaponAttackAction manuallyAssignAPDSTarget(Mounted apds,
            List&lt;WeaponHandler&gt; vAttacks) {
<span class="nc" id="L13795">        Entity e = apds.getEntity();</span>
<span class="nc bnc" id="L13796" title="All 2 branches missed.">        if (e == null) {</span>
<span class="nc" id="L13797">            return null;</span>
        }

        // Create a list of valid assignments for this APDS
<span class="nc" id="L13801">        List&lt;WeaponAttackAction&gt; vAttacksInArc = new ArrayList&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L13802" title="All 2 branches missed.">        for (WeaponHandler wr : vAttacks) {</span>
<span class="nc" id="L13803">            boolean isInArc = Compute.isInArc(e.getGame(), e.getId(),</span>
<span class="nc" id="L13804">                    e.getEquipmentNum(apds),</span>
<span class="nc" id="L13805">                    game.getEntity(wr.waa.getEntityId()));</span>
<span class="nc bnc" id="L13806" title="All 2 branches missed.">            boolean isInRange = e.getPosition().distance(</span>
<span class="nc" id="L13807">                    wr.getWaa().getTarget(game).getPosition()) &lt;= 3;</span>
<span class="nc bnc" id="L13808" title="All 4 branches missed.">            if (isInArc &amp;&amp; isInRange) {</span>
<span class="nc" id="L13809">                vAttacksInArc.add(wr.waa);</span>
            }
<span class="nc" id="L13811">        }</span>

        // If there are no valid attacks left, don't bother
<span class="nc bnc" id="L13814" title="All 2 branches missed.">        if (vAttacksInArc.size() &lt; 1) {</span>
<span class="nc" id="L13815">            return null;</span>
        }

<span class="nc" id="L13818">        WeaponAttackAction targetedWAA = null;</span>

<span class="nc bnc" id="L13820" title="All 2 branches missed.">        if (apds.curMode().equals(&quot;Automatic&quot;)) {</span>
<span class="nc" id="L13821">            targetedWAA = Compute.getHighestExpectedDamage(game,</span>
                    vAttacksInArc, true);
        } else {
            // Send a client feedback request
<span class="nc" id="L13825">            List&lt;Integer&gt; apdsDists = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L13826" title="All 2 branches missed.">            for (WeaponAttackAction waa : vAttacksInArc) {</span>
<span class="nc" id="L13827">                apdsDists.add(waa.getTarget(game).getPosition()</span>
<span class="nc" id="L13828">                        .distance(e.getPosition()));</span>
<span class="nc" id="L13829">            }</span>
<span class="nc" id="L13830">            sendAPDSAssignCFR(e, apdsDists, vAttacksInArc);</span>
<span class="nc" id="L13831">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc" id="L13833">                    cfrPacketQueue.wait();</span>
<span class="nc" id="L13834">                } catch (InterruptedException ex) {</span>
                    // Do nothing
<span class="nc" id="L13836">                }</span>
<span class="nc bnc" id="L13837" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L13838">                    ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L13839">                    int cfrType = (int) rp.packet.getData()[0];</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L13841" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_APDS_ASSIGN) {</span>
<span class="nc" id="L13842">                        MegaMek.getLogger().error(&quot;Expected a COMMAND_CFR_AMS_ASSIGN CFR packet, received: &quot; + cfrType);</span>
<span class="nc" id="L13843">                        throw new IllegalStateException();</span>
                    }
<span class="nc" id="L13845">                    Integer waaIndex =</span>
<span class="nc" id="L13846">                            (Integer)rp.packet.getData()[1];</span>
<span class="nc bnc" id="L13847" title="All 2 branches missed.">                    if (waaIndex != null) {</span>
<span class="nc" id="L13848">                        targetedWAA = vAttacksInArc.get(waaIndex);</span>
                    }
                }
<span class="nc" id="L13851">            }</span>
        }

<span class="nc bnc" id="L13854" title="All 2 branches missed.">        if (targetedWAA != null) {</span>
<span class="nc" id="L13855">            targetedWAA.addCounterEquipment(apds);</span>
<span class="nc" id="L13856">            return targetedWAA;</span>
        } else {
<span class="nc" id="L13858">            return null;</span>
        }
    }

    /**
     * Convenience method for determining which missile attack will be targeted
     * with AMS on the supplied Entity
     *
     * @param e
     *            The Entity with AMS
     * @param vAttacks
     *            List of missile attacks directed at e
     */
    private void manuallyAssignAMSTarget(Entity e,
            Vector&lt;WeaponHandler&gt; vAttacks) {
        //Fix for bug #1051 - don't send the targeting nag for a shutdown unit
<span class="nc bnc" id="L13874" title="All 2 branches missed.">        if (e.isShutDown()) {</span>
<span class="nc" id="L13875">            return;</span>
        }
        // Current AMS targets: each attack can only be targeted once
<span class="nc" id="L13878">        HashSet&lt;WeaponAttackAction&gt; amsTargets = new HashSet&lt;&gt;();</span>
        // Pick assignment for each active AMS
<span class="nc bnc" id="L13880" title="All 2 branches missed.">        for (Mounted ams : e.getActiveAMS()) {</span>
            // Skip APDS
<span class="nc bnc" id="L13882" title="All 2 branches missed.">            if (ams.isAPDS()) {</span>
<span class="nc" id="L13883">                continue;</span>
            }
            // Create a list of valid assignments for this AMS
<span class="nc" id="L13886">            List&lt;WeaponAttackAction&gt; vAttacksInArc = new ArrayList&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L13887" title="All 2 branches missed.">            for (WeaponHandler wr : vAttacks) {</span>
<span class="nc bnc" id="L13888" title="All 2 branches missed.">                if (!amsTargets.contains(wr.waa)</span>
<span class="nc bnc" id="L13889" title="All 2 branches missed.">                        &amp;&amp; Compute.isInArc(game, e.getId(),</span>
<span class="nc" id="L13890">                                e.getEquipmentNum(ams),</span>
<span class="nc" id="L13891">                                game.getEntity(wr.waa.getEntityId()))) {</span>
<span class="nc" id="L13892">                    vAttacksInArc.add(wr.waa);</span>
                }
<span class="nc" id="L13894">            }</span>

            // If there are no valid attacks left, don't bother
<span class="nc bnc" id="L13897" title="All 2 branches missed.">            if (vAttacksInArc.size() &lt; 1) {</span>
<span class="nc" id="L13898">                continue;</span>
            }

<span class="nc" id="L13901">            WeaponAttackAction targetedWAA = null;</span>

<span class="nc bnc" id="L13903" title="All 2 branches missed.">            if (ams.curMode().equals(&quot;Automatic&quot;)) {</span>
<span class="nc" id="L13904">                targetedWAA = Compute.getHighestExpectedDamage(game,</span>
                        vAttacksInArc, true);
            } else {
                // Send a client feedback request
<span class="nc" id="L13908">                sendAMSAssignCFR(e, ams, vAttacksInArc);</span>
<span class="nc" id="L13909">                synchronized (cfrPacketQueue) {</span>
                    try {
<span class="nc" id="L13911">                        cfrPacketQueue.wait();</span>
<span class="nc" id="L13912">                    } catch (InterruptedException ex) {</span>
                        // Do nothing
<span class="nc" id="L13914">                    }</span>
<span class="nc bnc" id="L13915" title="All 2 branches missed.">                    if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L13916">                        ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L13917">                        int cfrType = (int) rp.packet.getData()[0];</span>
                        // Make sure we got the right type of response
<span class="nc bnc" id="L13919" title="All 2 branches missed.">                        if (cfrType != Packet.COMMAND_CFR_AMS_ASSIGN) {</span>
<span class="nc" id="L13920">                            MegaMek.getLogger().error(&quot;Expected a COMMAND_CFR_AMS_ASSIGN CFR packet, received: &quot; + cfrType);</span>
<span class="nc" id="L13921">                            throw new IllegalStateException();</span>
                        }
<span class="nc" id="L13923">                        Integer waaIndex =</span>
<span class="nc" id="L13924">                                (Integer)rp.packet.getData()[1];</span>
<span class="nc bnc" id="L13925" title="All 2 branches missed.">                        if (waaIndex != null) {</span>
<span class="nc" id="L13926">                            targetedWAA = vAttacksInArc.get(waaIndex);</span>
                        }
                    }
<span class="nc" id="L13929">                }</span>
            }

<span class="nc bnc" id="L13932" title="All 2 branches missed.">            if (targetedWAA != null) {</span>
<span class="nc" id="L13933">                targetedWAA.addCounterEquipment(ams);</span>
<span class="nc" id="L13934">                amsTargets.add(targetedWAA);</span>
            }
<span class="nc" id="L13936">        }</span>
<span class="nc" id="L13937">    }</span>

    /**
     * Convenience method for computing a mapping of which Coords are
     * &quot;protected&quot; by an APDS. Protection implies that the coords is within the
     * range/arc of an active APDS.
     *
     * @return
     */
    private Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; getAPDSProtectedCoords() {
        // Get all of the coords that would be protected by APDS
<span class="nc" id="L13948">        Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; apdsCoords = new Hashtable&lt;&gt;();</span>
<span class="nc bnc" id="L13949" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
            // Ignore Entitys without positions
<span class="nc bnc" id="L13951" title="All 2 branches missed.">            if (e.getPosition() == null) {</span>
<span class="nc" id="L13952">                continue;</span>
            }
<span class="nc" id="L13954">            Coords origPos = e.getPosition();</span>
<span class="nc bnc" id="L13955" title="All 2 branches missed.">            for (Mounted ams : e.getActiveAMS()) {</span>
                // Ignore non-APDS AMS
<span class="nc bnc" id="L13957" title="All 2 branches missed.">                if (!ams.isAPDS()) {</span>
<span class="nc" id="L13958">                    continue;</span>
                }
                // Add the current hex as a defended location
<span class="nc" id="L13961">                List&lt;Mounted&gt; apdsList = apdsCoords.computeIfAbsent(origPos, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="nc" id="L13962">                apdsList.add(ams);</span>
                // Add each coords that is within arc/range as protected
<span class="nc" id="L13964">                int maxDist = 3;</span>
<span class="nc bnc" id="L13965" title="All 2 branches missed.">                if (e instanceof BattleArmor) {</span>
<span class="nc" id="L13966">                    int numTroopers = ((BattleArmor) e)</span>
<span class="nc" id="L13967">                            .getNumberActiverTroopers();</span>
<span class="nc bnc" id="L13968" title="All 3 branches missed.">                    switch (numTroopers) {</span>
                        case 1:
<span class="nc" id="L13970">                            maxDist = 1;</span>
<span class="nc" id="L13971">                            break;</span>
                        case 2:
                        case 3:
<span class="nc" id="L13974">                            maxDist = 2;</span>
                            break;
                    // Anything above is the same as the default
                    }
                }
<span class="nc bnc" id="L13979" title="All 2 branches missed.">                for (int dist = 1; dist &lt;= maxDist; dist++) {</span>
<span class="nc" id="L13980">                    List&lt;Coords&gt; coords = e.getPosition().allAtDistance(dist);</span>
<span class="nc bnc" id="L13981" title="All 2 branches missed.">                    for (Coords pos : coords) {</span>
                        // Check that we're in the right arc
<span class="nc bnc" id="L13983" title="All 2 branches missed.">                        if (Compute.isInArc(game, e.getId(), e.getEquipmentNum(ams),</span>
<span class="nc" id="L13984">                                new HexTarget(pos, game.getBoard(), HexTarget.TYPE_HEX_CLEAR))) {</span>
<span class="nc" id="L13985">                            apdsList = apdsCoords.computeIfAbsent(pos, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="nc" id="L13986">                            apdsList.add(ams);</span>
                        }
<span class="nc" id="L13988">                    }</span>
                }

<span class="nc" id="L13991">            }</span>
<span class="nc" id="L13992">        }</span>
<span class="nc" id="L13993">        return apdsCoords;</span>
    }

    /**
     * Called at the start and end of movement. Determines if an entity
     * has been detected and/or had a firing solution calculated
     */
    private void detectSpacecraft() {
        // Don't bother if we're not in space or if the game option isn't on
<span class="nc bnc" id="L14002" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14003" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)) {</span>
<span class="nc" id="L14004">            return;</span>
        }

        //Now, run the detection rolls
<span class="nc bnc" id="L14008" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
            //Don't process for invalid units
            //in the case of squadrons and transports, we want the 'host'
            //unit, not the component entities
<span class="nc bnc" id="L14012" title="All 2 branches missed.">            if (detector.getPosition() == null</span>
<span class="nc bnc" id="L14013" title="All 2 branches missed.">                    || detector.isDestroyed()</span>
<span class="nc bnc" id="L14014" title="All 2 branches missed.">                    || detector.isDoomed()</span>
<span class="nc bnc" id="L14015" title="All 2 branches missed.">                    || detector.isOffBoard()</span>
<span class="nc bnc" id="L14016" title="All 2 branches missed.">                    || detector.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14017" title="All 2 branches missed.">                    || detector.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14018">                continue;</span>
            }
<span class="nc bnc" id="L14020" title="All 2 branches missed.">            for (Entity target : game.getEntitiesVector()) {</span>
                //Once a target is detected, we don't need to detect it again
<span class="nc bnc" id="L14022" title="All 2 branches missed.">                if (detector.hasSensorContactFor(target.getId())) {</span>
<span class="nc" id="L14023">                    continue;</span>
                }
                //Don't process for invalid units
                //in the case of squadrons and transports, we want the 'host'
                //unit, not the component entities
<span class="nc bnc" id="L14028" title="All 2 branches missed.">                if (target.getPosition() == null</span>
<span class="nc bnc" id="L14029" title="All 2 branches missed.">                        || target.isDestroyed()</span>
<span class="nc bnc" id="L14030" title="All 2 branches missed.">                        || target.isDoomed()</span>
<span class="nc bnc" id="L14031" title="All 2 branches missed.">                        || target.isOffBoard()</span>
<span class="nc bnc" id="L14032" title="All 2 branches missed.">                        || target.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14033" title="All 2 branches missed.">                        || target.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14034">                    continue;</span>
                }
                // Only process for enemy units
<span class="nc bnc" id="L14037" title="All 2 branches missed.">                if (!detector.isEnemyOf(target)) {</span>
<span class="nc" id="L14038">                    continue;</span>
                }
                //If we successfully detect the enemy, add it to the appropriate detector's sensor contacts list
<span class="nc bnc" id="L14041" title="All 2 branches missed.">                if (Compute.calcSensorContact(game, detector, target)) {</span>
<span class="nc" id="L14042">                    game.getEntity(detector.getId()).addSensorContact(target.getId());</span>
                    //If detector is part of a C3 network, share the contact
<span class="nc bnc" id="L14044" title="All 2 branches missed.">                    if (detector.hasNavalC3()) {</span>
<span class="nc bnc" id="L14045" title="All 2 branches missed.">                        for (Entity c3NetMate : game.getC3NetworkMembers(detector)) {</span>
<span class="nc" id="L14046">                            game.getEntity(c3NetMate.getId()).addSensorContact(target.getId());</span>
<span class="nc" id="L14047">                        }</span>
                    }
                }
<span class="nc" id="L14050">            }</span>
<span class="nc" id="L14051">        }</span>
        //Now, run the firing solution calculations
<span class="nc bnc" id="L14053" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
            //Don't process for invalid units
            //in the case of squadrons and transports, we want the 'host'
            //unit, not the component entities
<span class="nc bnc" id="L14057" title="All 2 branches missed.">            if (detector.getPosition() == null</span>
<span class="nc bnc" id="L14058" title="All 2 branches missed.">                    || detector.isDestroyed()</span>
<span class="nc bnc" id="L14059" title="All 2 branches missed.">                    || detector.isDoomed()</span>
<span class="nc bnc" id="L14060" title="All 2 branches missed.">                    || detector.isOffBoard()</span>
<span class="nc bnc" id="L14061" title="All 2 branches missed.">                    || detector.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14062" title="All 2 branches missed.">                    || detector.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14063">                continue;</span>
            }
<span class="nc bnc" id="L14065" title="All 2 branches missed.">            for (int targetId : detector.getSensorContacts()) {</span>
<span class="nc" id="L14066">                Entity target = game.getEntity(targetId);</span>
                //if we already have a firing solution, no need to process a new one
<span class="nc bnc" id="L14068" title="All 2 branches missed.">                if (detector.hasFiringSolutionFor(targetId)) {</span>
<span class="nc" id="L14069">                    continue;</span>
                }
                //Don't process for invalid units
                //in the case of squadrons and transports, we want the 'host'
                //unit, not the component entities
<span class="nc bnc" id="L14074" title="All 2 branches missed.">                if (target == null</span>
<span class="nc bnc" id="L14075" title="All 2 branches missed.">                        || target.getPosition() == null</span>
<span class="nc bnc" id="L14076" title="All 2 branches missed.">                        || target.isDestroyed()</span>
<span class="nc bnc" id="L14077" title="All 2 branches missed.">                        || target.isDoomed()</span>
<span class="nc bnc" id="L14078" title="All 2 branches missed.">                        || target.isOffBoard()</span>
<span class="nc bnc" id="L14079" title="All 2 branches missed.">                        || target.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14080" title="All 2 branches missed.">                        || target.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14081">                    continue;</span>
                }
                // Only process for enemy units
<span class="nc bnc" id="L14084" title="All 2 branches missed.">                if (!detector.isEnemyOf(target)) {</span>
<span class="nc" id="L14085">                    continue;</span>
                }
                //If we successfully lock up the enemy, add it to the appropriate detector's firing solutions list
<span class="nc bnc" id="L14088" title="All 2 branches missed.">                if (Compute.calcFiringSolution(game, detector, target)) {</span>
<span class="nc" id="L14089">                    game.getEntity(detector.getId()).addFiringSolution(targetId);</span>
                }
<span class="nc" id="L14091">            }</span>
<span class="nc" id="L14092">        }</span>
<span class="nc" id="L14093">    }</span>

    /**
     * Called at the end of movement. Determines if an entity
     * has moved beyond sensor range
     */
    private void updateSpacecraftDetection() {
        // Don't bother if we're not in space or if the game option isn't on
<span class="nc bnc" id="L14101" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14102" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)) {</span>
<span class="nc" id="L14103">            return;</span>
        }
        //Run through our list of units and remove any entities from the plotting board that have moved out of range
<span class="nc bnc" id="L14106" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
<span class="nc" id="L14107">            Compute.updateFiringSolutions(game, detector);</span>
<span class="nc" id="L14108">            Compute.updateSensorContacts(game, detector);</span>
<span class="nc" id="L14109">        }</span>
<span class="nc" id="L14110">    }</span>

    /**
     * Checks to see if any units can detected hidden units.
     */
    private void detectHiddenUnits() {
        // If hidden units aren't on, nothing to do
<span class="nc bnc" id="L14117" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc" id="L14118">            return;</span>
        }
        // Get all hidden units
<span class="nc" id="L14121">        List&lt;Entity&gt; hiddenUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L14122" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L14123" title="All 2 branches missed.">            if (ent.isHidden()) {</span>
<span class="nc" id="L14124">                hiddenUnits.add(ent);</span>
            }
<span class="nc" id="L14126">        }</span>

        // If no one is hidden, there's nothing to do
<span class="nc bnc" id="L14129" title="All 2 branches missed.">        if (hiddenUnits.size() &lt; 1) {</span>
<span class="nc" id="L14130">            return;</span>
        }

<span class="nc" id="L14133">        Set&lt;Integer&gt; reportPlayers = new HashSet&lt;&gt;();</span>
        // See if any unit with a probe, detects any hidden units
<span class="nc bnc" id="L14135" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
<span class="nc" id="L14136">            int probeRange = detector.getBAPRange();</span>

            // Units without a position won't be able to detect
<span class="nc bnc" id="L14139" title="All 2 branches missed.">            if (detector.getPosition() == null) {</span>
<span class="nc" id="L14140">                continue;</span>
            }

<span class="nc bnc" id="L14143" title="All 2 branches missed.">            for (Entity detected : hiddenUnits) {</span>
                // Only detected enemy units
<span class="nc bnc" id="L14145" title="All 2 branches missed.">                if (!detector.isEnemyOf(detected)) {</span>
<span class="nc" id="L14146">                    continue;</span>
                }
                // Can't detect units without a position
<span class="nc bnc" id="L14149" title="All 2 branches missed.">                if (detected.getPosition() == null) {</span>
<span class="nc" id="L14150">                    continue;</span>
                }
                // Can only detect units within the probes range
<span class="nc" id="L14153">                int dist = detector.getPosition().distance(</span>
<span class="nc" id="L14154">                        detected.getPosition());</span>

                // An adjacent enemy unit will detect hidden units, TW pg 259
<span class="nc bnc" id="L14157" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; dist &gt; probeRange) {</span>
<span class="nc" id="L14158">                    continue;</span>
                }

                // Check for Void/Null Sig - only detected by Bloodhound probes
<span class="nc bnc" id="L14162" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; (detected instanceof Mech)) {</span>
<span class="nc" id="L14163">                    Mech m = (Mech)detected;</span>
<span class="nc bnc" id="L14164" title="All 4 branches missed.">                    if ((m.isVoidSigActive() || m.isNullSigActive())</span>
<span class="nc bnc" id="L14165" title="All 2 branches missed.">                            &amp;&amp; !detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14166">                        continue;</span>
                    }
                }

                // Check for Infantry stealth armor
<span class="nc bnc" id="L14171" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; (detected instanceof BattleArmor)) {</span>
<span class="nc" id="L14172">                    BattleArmor ba = (BattleArmor) detected;</span>
                    // Need Bloodhound to detect BA stealth armor
<span class="nc bnc" id="L14174" title="All 2 branches missed.">                    if (ba.isStealthy()</span>
<span class="nc bnc" id="L14175" title="All 2 branches missed.">                            &amp;&amp; !detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14176">                        continue;</span>
                    }
<span class="nc bnc" id="L14178" title="All 4 branches missed.">                } else if (dist &gt; 1 &amp;&amp; (detected instanceof Infantry)) {</span>
<span class="nc" id="L14179">                    Infantry inf = (Infantry) detected;</span>
                    // Can't detect sneaky infantry
<span class="nc bnc" id="L14181" title="All 2 branches missed.">                    if (inf.isStealthy()) {</span>
<span class="nc" id="L14182">                        continue;</span>
                    }
                    // Need bloodhound to detect non-sneaky inf
<span class="nc bnc" id="L14185" title="All 2 branches missed.">                    if (!detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14186">                        continue;</span>
                    }
                }

<span class="nc" id="L14190">                LosEffects los = LosEffects.calculateLos(game,</span>
<span class="nc" id="L14191">                        detector.getId(), detected);</span>
<span class="nc bnc" id="L14192" title="All 4 branches missed.">                if (los.canSee() || dist &lt;= 1) {</span>
<span class="nc" id="L14193">                    detected.setHidden(false);</span>
<span class="nc" id="L14194">                    entityUpdate(detected.getId());</span>
<span class="nc" id="L14195">                    Report r = new Report(9960);</span>
<span class="nc" id="L14196">                    r.addDesc(detector);</span>
<span class="nc" id="L14197">                    r.subject = detector.getId();</span>
<span class="nc" id="L14198">                    r.add(detected.getPosition().getBoardNum());</span>
<span class="nc" id="L14199">                    vPhaseReport.addElement(r);</span>
<span class="nc" id="L14200">                    Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L14201">                    reportPlayers.add(detector.getOwnerId());</span>
<span class="nc" id="L14202">                    reportPlayers.add(detected.getOwnerId());</span>
                }
<span class="nc" id="L14204">            }</span>
<span class="nc" id="L14205">        }</span>

<span class="nc bnc" id="L14207" title="All 4 branches missed.">        if (vPhaseReport.size() &gt; 0 &amp;&amp; game.getPhase() == Phase.PHASE_MOVEMENT</span>
<span class="nc bnc" id="L14208" title="All 2 branches missed.">                &amp;&amp; (game.getTurnIndex() + 1) &lt; game.getTurnVector().size()) {</span>
<span class="nc bnc" id="L14209" title="All 2 branches missed.">            for (Integer playerId : reportPlayers) {</span>
<span class="nc" id="L14210">                send(playerId, createSpecialReportPacket());</span>
<span class="nc" id="L14211">            }</span>
        }
<span class="nc" id="L14213">    }</span>

    /**
     * Called to what players can see what units. This is used to determine who
     * can see what in double blind reports.
     */
    private void resolveWhatPlayersCanSeeWhatUnits() {
<span class="nc" id="L14220">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L14221" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L14222">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L14223">                    .getEntitiesVector());</span>
        }
<span class="nc" id="L14225">        Map&lt;EntityTargetPair, LosEffects&gt; losCache = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L14226" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // We are hidden once again!
<span class="nc" id="L14228">            entity.clearSeenBy();</span>
<span class="nc" id="L14229">            entity.clearDetectedBy();</span>
            // Handle visual spotting
<span class="nc bnc" id="L14231" title="All 2 branches missed.">            for (IPlayer p : whoCanSee(entity, false, losCache)) {</span>
<span class="nc" id="L14232">                entity.addBeenSeenBy(p);</span>
<span class="nc" id="L14233">            }</span>
            // Handle detection by sensors
<span class="nc bnc" id="L14235" title="All 2 branches missed.">            for (IPlayer p : whoCanDetect(entity, allECMInfo, losCache)) {</span>
<span class="nc" id="L14236">                    entity.addBeenDetectedBy(p);</span>
<span class="nc" id="L14237">            }</span>
<span class="nc" id="L14238">        }</span>
<span class="nc" id="L14239">    }</span>

    /**
     * Called during the weapons fire phase. Resolves anything other than
     * weapons fire that happens. Torso twists, for example.
     */
    private void resolveAllButWeaponAttacks() {
<span class="nc" id="L14246">        Vector&lt;EntityAction&gt; triggerPodActions = new Vector&lt;&gt;();</span>
        // loop through actions and handle everything we expect except attacks
<span class="nc" id="L14248">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L14249" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L14250">            EntityAction ea = i.nextElement();</span>
<span class="nc" id="L14251">            Entity entity = game.getEntity(ea.getEntityId());</span>
<span class="nc bnc" id="L14252" title="All 2 branches missed.">            if (ea instanceof TorsoTwistAction) {</span>
<span class="nc" id="L14253">                TorsoTwistAction tta = (TorsoTwistAction) ea;</span>
<span class="nc bnc" id="L14254" title="All 2 branches missed.">                if (entity.canChangeSecondaryFacing()) {</span>
<span class="nc" id="L14255">                    entity.setSecondaryFacing(tta.getFacing());</span>
<span class="nc" id="L14256">                    entity.postProcessFacingChange();</span>
                }
<span class="nc bnc" id="L14258" title="All 2 branches missed.">            } else if (ea instanceof FlipArmsAction) {</span>
<span class="nc" id="L14259">                FlipArmsAction faa = (FlipArmsAction) ea;</span>
<span class="nc" id="L14260">                entity.setArmsFlipped(faa.getIsFlipped());</span>
<span class="nc bnc" id="L14261" title="All 2 branches missed.">            } else if (ea instanceof FindClubAction) {</span>
<span class="nc" id="L14262">                resolveFindClub(entity);</span>
<span class="nc bnc" id="L14263" title="All 2 branches missed.">            } else if (ea instanceof UnjamAction) {</span>
<span class="nc" id="L14264">                resolveUnjam(entity);</span>
<span class="nc bnc" id="L14265" title="All 2 branches missed.">            } else if (ea instanceof ClearMinefieldAction) {</span>
<span class="nc" id="L14266">                resolveClearMinefield(entity,</span>
<span class="nc" id="L14267">                                      ((ClearMinefieldAction) ea).getMinefield());</span>
<span class="nc bnc" id="L14268" title="All 2 branches missed.">            } else if (ea instanceof TriggerAPPodAction) {</span>
<span class="nc" id="L14269">                TriggerAPPodAction tapa = (TriggerAPPodAction) ea;</span>

                // Don't trigger the same pod twice.
<span class="nc bnc" id="L14272" title="All 2 branches missed.">                if (!triggerPodActions.contains(tapa)) {</span>
<span class="nc" id="L14273">                    triggerAPPod(entity, tapa.getPodId());</span>
<span class="nc" id="L14274">                    triggerPodActions.addElement(tapa);</span>
                } else {
<span class="nc" id="L14276">                    MegaMek.getLogger().error(&quot;AP Pod #&quot; + tapa.getPodId() + &quot; on &quot; + entity.getDisplayName()</span>
                                    + &quot; was already triggered this round!!&quot;);
                }
<span class="nc bnc" id="L14279" title="All 2 branches missed.">            } else if (ea instanceof TriggerBPodAction) {</span>
<span class="nc" id="L14280">                TriggerBPodAction tba = (TriggerBPodAction) ea;</span>

                // Don't trigger the same pod twice.
<span class="nc bnc" id="L14283" title="All 2 branches missed.">                if (!triggerPodActions.contains(tba)) {</span>
<span class="nc" id="L14284">                    triggerBPod(entity, tba.getPodId(),</span>
<span class="nc" id="L14285">                                game.getEntity(tba.getTargetId()));</span>
<span class="nc" id="L14286">                    triggerPodActions.addElement(tba);</span>
                } else {
<span class="nc" id="L14288">                    MegaMek.getLogger().error(&quot;B Pod #&quot; + tba.getPodId() + &quot; on &quot; + entity.getDisplayName()</span>
                                    + &quot; was already triggered this round!!&quot;);
                }
<span class="nc bnc" id="L14291" title="All 2 branches missed.">            } else if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L14292">                SearchlightAttackAction saa = (SearchlightAttackAction) ea;</span>
<span class="nc" id="L14293">                addReport(saa.resolveAction(game));</span>
<span class="nc bnc" id="L14294" title="All 2 branches missed.">            } else if (ea instanceof UnjamTurretAction) {</span>
<span class="nc bnc" id="L14295" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L14296">                    ((Tank) entity).unjamTurret(((Tank) entity).getLocTurret());</span>
<span class="nc" id="L14297">                    ((Tank) entity)</span>
<span class="nc" id="L14298">                            .unjamTurret(((Tank) entity).getLocTurret2());</span>
<span class="nc" id="L14299">                    Report r = new Report(3033);</span>
<span class="nc" id="L14300">                    r.addDesc(entity);</span>
<span class="nc" id="L14301">                    addReport(r);</span>
<span class="nc" id="L14302">                } else {</span>
<span class="nc" id="L14303">                    MegaMek.getLogger().error(&quot;Non-Tank tried to unjam turret&quot;);</span>
                }
<span class="nc bnc" id="L14305" title="All 2 branches missed.">            } else if (ea instanceof RepairWeaponMalfunctionAction) {</span>
<span class="nc bnc" id="L14306" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L14307">                    Mounted m = entity</span>
<span class="nc" id="L14308">                            .getEquipment(((RepairWeaponMalfunctionAction) ea)</span>
<span class="nc" id="L14309">                                                  .getWeaponId());</span>
<span class="nc" id="L14310">                    m.setJammed(false);</span>
<span class="nc" id="L14311">                    ((Tank) entity).getJammedWeapons().remove(m);</span>
<span class="nc" id="L14312">                    Report r = new Report(3034);</span>
<span class="nc" id="L14313">                    r.subject = entity.getId();</span>
<span class="nc" id="L14314">                    r.addDesc(entity);</span>
<span class="nc" id="L14315">                    r.add(m.getName());</span>
<span class="nc" id="L14316">                    addReport(r);</span>
<span class="nc" id="L14317">                } else {</span>
<span class="nc" id="L14318">                    MegaMek.getLogger().error(&quot;Non-Tank tried to repair weapon malfunction&quot;);</span>
                }
<span class="nc bnc" id="L14320" title="All 2 branches missed.">            } else if (ea instanceof DisengageAction) {</span>
<span class="nc" id="L14321">                MovePath path = new MovePath(game, entity);</span>
<span class="nc" id="L14322">                path.addStep(MoveStepType.FLEE);</span>
<span class="nc" id="L14323">                addReport(processLeaveMap(path, false, -1));</span>
            }
<span class="nc" id="L14325">        }</span>
<span class="nc" id="L14326">    }</span>

    /*
     * Called during the weapons firing phase to initiate self destruction.
     */
    private void resolveSelfDestructions() {
<span class="nc" id="L14332">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L14334" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L14335" title="All 4 branches missed.">            if (e.getSelfDestructInitiated() &amp;&amp; e.hasEngine()) {</span>
<span class="nc" id="L14336">                r = new Report(6166, Report.PUBLIC);</span>
<span class="nc" id="L14337">                int target = e.getCrew().getPiloting();</span>
<span class="nc" id="L14338">                int roll = e.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L14339">                r.subject = e.getId();</span>
<span class="nc" id="L14340">                r.addDesc(e);</span>
<span class="nc" id="L14341">                r.indent();</span>
<span class="nc" id="L14342">                r.add(target);</span>
<span class="nc" id="L14343">                r.add(roll);</span>
<span class="nc bnc" id="L14344" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14345">                    r.choose(true);</span>
                } else {
<span class="nc" id="L14347">                    r.choose(false);</span>
                }
<span class="nc" id="L14349">                vDesc.add(r);</span>

                // Blow it up...
<span class="nc bnc" id="L14352" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14353">                    int engineRating = e.getEngine().getRating();</span>
<span class="nc" id="L14354">                    r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L14355">                    r.subject = e.getId();</span>
<span class="nc" id="L14356">                    r.indent(2);</span>
<span class="nc" id="L14357">                    vDesc.add(r);</span>

<span class="nc bnc" id="L14359" title="All 2 branches missed.">                    if (e instanceof Mech) {</span>
<span class="nc" id="L14360">                        Mech mech = (Mech) e;</span>
<span class="nc bnc" id="L14361" title="All 2 branches missed.">                        if (mech.isAutoEject()</span>
<span class="nc bnc" id="L14362" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION) || (game
<span class="nc bnc" id="L14364" title="All 2 branches missed.">                                        .getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION) &amp;&amp; mech
<span class="nc bnc" id="L14366" title="All 2 branches missed.">                                        .isCondEjectEngine()))) {</span>
<span class="nc" id="L14367">                            vDesc.addAll(ejectEntity(e, true));</span>
                        }
                    }
<span class="nc" id="L14370">                    e.setSelfDestructedThisTurn(true);</span>
<span class="nc" id="L14371">                    doFusionEngineExplosion(engineRating, e.getPosition(),</span>
                            vDesc, null);
<span class="nc" id="L14373">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L14374">                    r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L14375">                    r.subject = e.getId();</span>
<span class="nc" id="L14376">                    r.indent(2);</span>
<span class="nc" id="L14377">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L14378">                    vDesc.add(r);</span>
                }
<span class="nc" id="L14380">                e.setSelfDestructInitiated(false);</span>
            }
<span class="nc" id="L14382">        }</span>
<span class="nc" id="L14383">        addReport(vDesc);</span>
<span class="nc" id="L14384">    }</span>

    private void reportGhostTargetRolls() {
        // run through an enumeration of deployed game entities. If they have
        // ghost targets, then check the roll
        // and report it
        Report r;
<span class="nc bnc" id="L14391" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L14392">            Entity ent = e.next();</span>
<span class="nc bnc" id="L14393" title="All 4 branches missed.">            if (ent.isDeployed() &amp;&amp; ent.hasGhostTargets(false)) {</span>
<span class="nc" id="L14394">                r = new Report(3630);</span>
<span class="nc" id="L14395">                r.subject = ent.getId();</span>
<span class="nc" id="L14396">                r.addDesc(ent);</span>
                // Ghost target mod is +3 per errata
<span class="nc" id="L14398">                int target = ent.getCrew().getPiloting() + 3;</span>
<span class="nc bnc" id="L14399" title="All 2 branches missed.">                if (ent.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L14400">                    target = ent.getCrew().getGunnery() + 3;</span>
                }
<span class="nc" id="L14402">                int roll = ent.getGhostTargetRoll();</span>
<span class="nc" id="L14403">                r.add(target);</span>
<span class="nc" id="L14404">                r.add(roll);</span>
<span class="nc bnc" id="L14405" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14406">                    r.choose(true);</span>
                } else {
<span class="nc" id="L14408">                    r.choose(false);</span>
                }
<span class="nc" id="L14410">                addReport(r);</span>
            }
<span class="nc" id="L14412">        }</span>
<span class="nc" id="L14413">        addNewLines();</span>
<span class="nc" id="L14414">    }</span>

    private void reportLargeCraftECCMRolls() {
        // run through an enumeration of deployed game entities. If they are
        // large craft in space, then check the roll
        // and report it
<span class="nc bnc" id="L14420" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14421" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L14422">            return;</span>
        }
        Report r;
<span class="nc bnc" id="L14425" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L14426">            Entity ent = e.next();</span>
<span class="nc bnc" id="L14427" title="All 4 branches missed.">            if (ent.isDeployed() &amp;&amp; ent.isLargeCraft()) {</span>
<span class="nc" id="L14428">                r = new Report(3635);</span>
<span class="nc" id="L14429">                r.subject = ent.getId();</span>
<span class="nc" id="L14430">                r.addDesc(ent);</span>
<span class="nc" id="L14431">                int target = ((Aero) ent).getECCMTarget();</span>
<span class="nc" id="L14432">                int roll = ((Aero) ent).getECCMRoll();</span>
<span class="nc" id="L14433">                r.add(roll);</span>
<span class="nc" id="L14434">                r.add(target);</span>
<span class="nc" id="L14435">                int mod = ((Aero) ent).getECCMBonus();</span>
<span class="nc" id="L14436">                r.add(mod);</span>
<span class="nc" id="L14437">                addReport(r);</span>
            }
<span class="nc" id="L14439">        }</span>
<span class="nc" id="L14440">    }</span>

    private void resolveClearMinefield(Entity ent, Minefield mf) {

<span class="nc bnc" id="L14444" title="All 6 branches missed.">        if ((null == mf) || (null == ent) || ent.isDoomed()</span>
<span class="nc bnc" id="L14445" title="All 2 branches missed.">            || ent.isDestroyed()) {</span>
<span class="nc" id="L14446">            return;</span>
        }

<span class="nc" id="L14449">        Coords pos = mf.getCoords();</span>
<span class="nc" id="L14450">        int clear = Minefield.CLEAR_NUMBER_INFANTRY;</span>
<span class="nc" id="L14451">        int boom = Minefield.CLEAR_NUMBER_INFANTRY_ACCIDENT;</span>

<span class="nc" id="L14453">        Report r = new Report(2245);</span>
        // Does the entity has a minesweeper?
<span class="nc bnc" id="L14455" title="All 2 branches missed.">        if ((ent instanceof BattleArmor)) {</span>
<span class="nc" id="L14456">            BattleArmor ba = (BattleArmor)ent;</span>
<span class="nc" id="L14457">            String mcmName = BattleArmor.MANIPULATOR_TYPE_STRINGS</span>
                    [BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE];
<span class="nc bnc" id="L14459" title="All 2 branches missed.">            if (ba.getLeftManipulatorName().equals(mcmName)) {</span>
<span class="nc" id="L14460">                clear = Minefield.CLEAR_NUMBER_BA_SWEEPER;</span>
<span class="nc" id="L14461">                boom = Minefield.CLEAR_NUMBER_BA_SWEEPER_ACCIDENT;</span>
<span class="nc" id="L14462">                r = new Report(2246);</span>
            }
<span class="nc bnc" id="L14464" title="All 2 branches missed.">        } else if (ent instanceof Infantry) { // Check Minesweeping Engineers</span>
<span class="nc" id="L14465">            Infantry inf = (Infantry) ent;</span>
<span class="nc bnc" id="L14466" title="All 2 branches missed.">            if (inf.hasSpecialization(Infantry.MINE_ENGINEERS)) {</span>
<span class="nc" id="L14467">                clear = Minefield.CLEAR_NUMBER_INF_ENG;</span>
<span class="nc" id="L14468">                boom = Minefield.CLEAR_NUMBER_INF_ENG_ACCIDENT;</span>
<span class="nc" id="L14469">                r = new Report(2247);</span>
            }
        }
        // mine clearing roll
<span class="nc" id="L14473">        r.subject = ent.getId();</span>
<span class="nc" id="L14474">        r.add(ent.getShortName(), true);</span>
<span class="nc" id="L14475">        r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L14476">        r.add(pos.getBoardNum(), true);</span>
<span class="nc" id="L14477">        addReport(r);</span>

<span class="nc bnc" id="L14479" title="All 2 branches missed.">        if (clearMinefield(mf, ent, clear, boom, vPhaseReport)) {</span>
<span class="nc" id="L14480">            removeMinefield(mf);</span>
        }
        // some mines might have blown up
<span class="nc" id="L14483">        resetMines();</span>

<span class="nc" id="L14485">        addNewLines();</span>
<span class="nc" id="L14486">    }</span>

    /**
     * Called during the fire phase to resolve all (and only) weapon attacks
     */
    private void resolveOnlyWeaponAttacks() {
        // loop through received attack actions, getting attack handlers
<span class="nc" id="L14493">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L14494" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L14495">            EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L14496" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L14497">                WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L14498">                Entity ae = game.getEntity(waa.getEntityId());</span>
<span class="nc" id="L14499">                Mounted m = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L14500">                Weapon w = (Weapon) m.getType();</span>
                // Track attacks original target, for things like swarm LRMs
<span class="nc" id="L14502">                waa.setOriginalTargetId(waa.getTargetId());</span>
<span class="nc" id="L14503">                waa.setOriginalTargetType(waa.getTargetType());</span>
<span class="nc" id="L14504">                AttackHandler ah = w.fire(waa, game, this);</span>
<span class="nc bnc" id="L14505" title="All 2 branches missed.">                if (ah != null) {</span>
<span class="nc" id="L14506">                    ah.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L14507">                    ah.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L14508">                    game.addAttack(ah);</span>
                }
            }
<span class="nc" id="L14511">        }</span>
        // and clear the attacks Vector
<span class="nc" id="L14513">        game.resetActions();</span>
<span class="nc" id="L14514">    }</span>

    /**
     * Trigger the indicated AP Pod of the entity.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; triggering the AP Pod.
     * @param podId  the &lt;code&gt;int&lt;/code&gt; ID of the AP Pod.
     */
    private void triggerAPPod(Entity entity, int podId) {
        // Get the mount for this pod.
<span class="nc" id="L14524">        Mounted mount = entity.getEquipment(podId);</span>

        // Confirm that this is, indeed, an AP Pod.
<span class="nc bnc" id="L14527" title="All 2 branches missed.">        if (null == mount) {</span>
<span class="nc" id="L14528">            MegaMek.getLogger().error(&quot;Expecting to find an AP Pod at &quot; + podId + &quot; on the unit, &quot; + entity.getDisplayName()</span>
                            + &quot; but found NO equipment at all!!!&quot;);
<span class="nc" id="L14530">            return;</span>
        }
<span class="nc" id="L14532">        EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L14533" title="All 4 branches missed.">        if (!(equip instanceof MiscType) || !equip.hasFlag(MiscType.F_AP_POD)) {</span>
<span class="nc" id="L14534">            MegaMek.getLogger().error(&quot;Expecting to find an AP Pod at &quot; + podId + &quot; on the unit, &quot;+ entity.getDisplayName()</span>
<span class="nc" id="L14535">                            + &quot; but found &quot; + equip.getName() + &quot; instead!!!&quot;);</span>
<span class="nc" id="L14536">            return;</span>
        }

        // Now confirm that the entity can trigger the pod.
        // Ignore the &quot;used this round&quot; flag.
<span class="nc" id="L14541">        boolean oldFired = mount.isUsedThisRound();</span>
<span class="nc" id="L14542">        mount.setUsedThisRound(false);</span>
<span class="nc" id="L14543">        boolean canFire = mount.canFire();</span>
<span class="nc" id="L14544">        mount.setUsedThisRound(oldFired);</span>
<span class="nc bnc" id="L14545" title="All 2 branches missed.">        if (!canFire) {</span>
<span class="nc" id="L14546">            MegaMek.getLogger().error(&quot;Can not trigger the AP Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14547">                    + entity.getDisplayName() + &quot;!!!&quot;);</span>
<span class="nc" id="L14548">            return;</span>
        }

        Report r;

        // Mark the pod as fired and log the action.
<span class="nc" id="L14554">        mount.setFired(true);</span>
<span class="nc" id="L14555">        r = new Report(3010);</span>
<span class="nc" id="L14556">        r.newlines = 0;</span>
<span class="nc" id="L14557">        r.subject = entity.getId();</span>
<span class="nc" id="L14558">        r.addDesc(entity);</span>
<span class="nc" id="L14559">        addReport(r);</span>

        // Walk through ALL entities in the triggering entity's hex.
<span class="nc bnc" id="L14562" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector(entity.getPosition())) {</span>
            // Is this an unarmored infantry platoon?
<span class="nc bnc" id="L14564" title="All 2 branches missed.">            if (target.isConventionalInfantry()) {</span>
                // Roll d6-1 for damage.
<span class="nc" id="L14566">                final int damage = Math.max(1, Compute.d6() - 1);</span>

                // Damage the platoon.
<span class="nc" id="L14569">                addReport(damageEntity(target, new HitData(Infantry.LOC_INFANTRY), damage));</span>

                // Damage from AP Pods is applied immediately.
<span class="nc" id="L14572">                target.applyDamage();</span>
<span class="nc" id="L14573">            } // End target-is-unarmored</span>

            // Nope, the target is immune.
            // Don't make a log entry for the triggering entity.
<span class="nc bnc" id="L14577" title="All 2 branches missed.">            else if (!entity.equals(target)) {</span>
<span class="nc" id="L14578">                r = new Report(3020);</span>
<span class="nc" id="L14579">                r.indent(2);</span>
<span class="nc" id="L14580">                r.subject = target.getId();</span>
<span class="nc" id="L14581">                r.addDesc(target);</span>
<span class="nc" id="L14582">                addReport(r);</span>
            }

<span class="nc" id="L14585">        } // Check the next entity in the triggering entity's hex.</span>
<span class="nc" id="L14586">    }</span>

    /**
     * Trigger the indicated B Pod of the entity.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; triggering the B Pod.
     * @param podId  the &lt;code&gt;int&lt;/code&gt; ID of the B Pod.
     */
    private void triggerBPod(Entity entity, int podId, Entity target) {
        // Get the mount for this pod.
<span class="nc" id="L14596">        Mounted mount = entity.getEquipment(podId);</span>

        // Confirm that this is, indeed, an Anti-BA Pod.
<span class="nc bnc" id="L14599" title="All 2 branches missed.">        if (null == mount) {</span>
<span class="nc" id="L14600">            MegaMek.getLogger().error(&quot;Expecting to find an B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14601">                    + entity.getDisplayName() + &quot; but found NO equipment at all!!!&quot;);</span>
<span class="nc" id="L14602">            return;</span>
        }
<span class="nc" id="L14604">        EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L14605" title="All 4 branches missed.">        if (!(equip instanceof WeaponType) || !equip.hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L14606">            MegaMek.getLogger().error(&quot;Expecting to find an B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14607">                    + entity.getDisplayName() + &quot; but found &quot; + equip.getName() + &quot; instead!!!&quot;);</span>
<span class="nc" id="L14608">            return;</span>
        }

        // Now confirm that the entity can trigger the pod.
        // Ignore the &quot;used this round&quot; flag.
<span class="nc" id="L14613">        boolean oldFired = mount.isUsedThisRound();</span>
<span class="nc" id="L14614">        mount.setUsedThisRound(false);</span>
<span class="nc" id="L14615">        boolean canFire = mount.canFire();</span>
<span class="nc" id="L14616">        mount.setUsedThisRound(oldFired);</span>
<span class="nc bnc" id="L14617" title="All 2 branches missed.">        if (!canFire) {</span>
<span class="nc" id="L14618">            MegaMek.getLogger().error(&quot;Can not trigger the B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14619">                    + entity.getDisplayName() + &quot;!!!&quot;);</span>
<span class="nc" id="L14620">            return;</span>
        }

        Report r;

        // Mark the pod as fired and log the action.
<span class="nc" id="L14626">        mount.setFired(true);</span>
<span class="nc" id="L14627">        r = new Report(3011);</span>
<span class="nc" id="L14628">        r.newlines = 0;</span>
<span class="nc" id="L14629">        r.subject = entity.getId();</span>
<span class="nc" id="L14630">        r.addDesc(entity);</span>
<span class="nc" id="L14631">        addReport(r);</span>

        // Is this an unarmored infantry platoon?
<span class="nc bnc" id="L14634" title="All 2 branches missed.">        if (target.isConventionalInfantry()) {</span>
            // Roll d6 for damage.
<span class="nc" id="L14636">            final int damage = Compute.d6();</span>

            // Damage the platoon.
<span class="nc" id="L14639">            addReport(damageEntity(target, new HitData(Infantry.LOC_INFANTRY), damage));</span>

            // Damage from AP Pods is applied immediately.
<span class="nc" id="L14642">            target.applyDamage();</span>
<span class="nc bnc" id="L14643" title="All 2 branches missed.">        } else if (target instanceof BattleArmor) {</span>
            // 20 damage in 5 point clusters
<span class="nc" id="L14645">            final int damage = 5;</span>

            // Damage the squad.
<span class="nc" id="L14648">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14649">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14650">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14651">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>

            // Damage from B Pods is applied immediately.
<span class="nc" id="L14654">            target.applyDamage();</span>
<span class="nc bnc" id="L14655" title="All 2 branches missed.">        } else if (!entity.equals(target)) {</span>
            // Nope, the target is immune.
            // Don't make a log entry for the triggering entity.
<span class="nc" id="L14658">            r = new Report(3020);</span>
<span class="nc" id="L14659">            r.indent(2);</span>
<span class="nc" id="L14660">            r.subject = target.getId();</span>
<span class="nc" id="L14661">            r.addDesc(target);</span>
<span class="nc" id="L14662">            addReport(r);</span>
        }
<span class="nc" id="L14664">    }</span>

    /**
     * Resolve an Unjam Action object
     */
    private void resolveUnjam(Entity entity) {
        Report r;
<span class="nc" id="L14671">        final int TN = entity.getCrew().getGunnery() + 3;</span>
<span class="nc bnc" id="L14672" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L14673">            r = new Report(3026);</span>
        } else {
<span class="nc" id="L14675">            r = new Report(3025);</span>
        }
<span class="nc" id="L14677">        r.subject = entity.getId();</span>
<span class="nc" id="L14678">        r.addDesc(entity);</span>
<span class="nc" id="L14679">        addReport(r);</span>
<span class="nc bnc" id="L14680" title="All 2 branches missed.">        for (Mounted mounted : entity.getTotalWeaponList()) {</span>
<span class="nc bnc" id="L14681" title="All 4 branches missed.">            if (mounted.isJammed() &amp;&amp; !mounted.isDestroyed()) {</span>
<span class="nc" id="L14682">                WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L14683" title="All 2 branches missed.">                if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L14684">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14685">                    r = new Report(3030);</span>
<span class="nc" id="L14686">                    r.indent();</span>
<span class="nc" id="L14687">                    r.subject = entity.getId();</span>
<span class="nc" id="L14688">                    r.add(wtype.getName());</span>
<span class="nc" id="L14689">                    r.add(TN);</span>
<span class="nc" id="L14690">                    r.add(roll);</span>
<span class="nc bnc" id="L14691" title="All 2 branches missed.">                    if (roll &gt;= TN) {</span>
<span class="nc" id="L14692">                        r.choose(true);</span>
<span class="nc" id="L14693">                        mounted.setJammed(false);</span>
                    } else {
<span class="nc" id="L14695">                        r.choose(false);</span>
                    }
<span class="nc" id="L14697">                    addReport(r);</span>
                }
                // Unofficial option to unjam UACs, ACs, and LACs like Rotary
                // Autocannons
<span class="nc bnc" id="L14701" title="All 2 branches missed.">                if (((wtype.getAmmoType() == AmmoType.T_AC_ULTRA)</span>
<span class="nc bnc" id="L14702" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)</span>
<span class="nc bnc" id="L14703" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC)</span>
<span class="nc bnc" id="L14704" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L14705" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_PAC)</span>
<span class="nc bnc" id="L14706" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_LAC))</span>
<span class="nc bnc" id="L14707" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L14708">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14709">                    r = new Report(3030);</span>
<span class="nc" id="L14710">                    r.indent();</span>
<span class="nc" id="L14711">                    r.subject = entity.getId();</span>
<span class="nc" id="L14712">                    r.add(wtype.getName());</span>
<span class="nc" id="L14713">                    r.add(TN);</span>
<span class="nc" id="L14714">                    r.add(roll);</span>
<span class="nc bnc" id="L14715" title="All 2 branches missed.">                    if (roll &gt;= TN) {</span>
<span class="nc" id="L14716">                        r.choose(true);</span>
<span class="nc" id="L14717">                        mounted.setJammed(false);</span>
                    } else {
<span class="nc" id="L14719">                        r.choose(false);</span>
                    }
<span class="nc" id="L14721">                    addReport(r);</span>
                }
            }
<span class="nc" id="L14724">        }</span>
<span class="nc" id="L14725">    }</span>

    private void resolveFindClub(Entity entity) {
<span class="nc" id="L14728">        EquipmentType clubType = null;</span>

<span class="nc" id="L14730">        entity.setFindingClub(true);</span>

        // Get the entity's current hex.
<span class="nc" id="L14733">        Coords coords = entity.getPosition();</span>
<span class="nc" id="L14734">        IHex curHex = game.getBoard().getHex(coords);</span>

        Report r;

        // Is there a blown off arm in the hex?
<span class="nc bnc" id="L14739" title="All 2 branches missed.">        if (curHex.terrainLevel(Terrains.ARMS) &gt; 0) {</span>
<span class="nc" id="L14740">            clubType = EquipmentType.get(EquipmentTypeLookup.LIMB_CLUB);</span>
<span class="nc" id="L14741">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L14742">                    Terrains.ARMS, curHex.terrainLevel(Terrains.ARMS) - 1));</span>
<span class="nc" id="L14743">            sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L14744">            r = new Report(3035);</span>
<span class="nc" id="L14745">            r.subject = entity.getId();</span>
<span class="nc" id="L14746">            r.addDesc(entity);</span>
<span class="nc" id="L14747">            addReport(r);</span>
        }
        // Is there a blown off leg in the hex?
<span class="nc bnc" id="L14750" title="All 2 branches missed.">        else if (curHex.terrainLevel(Terrains.LEGS) &gt; 0) {</span>
<span class="nc" id="L14751">            clubType = EquipmentType.get(EquipmentTypeLookup.LIMB_CLUB);</span>
<span class="nc" id="L14752">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L14753">                    Terrains.LEGS, curHex.terrainLevel(Terrains.LEGS) - 1));</span>
<span class="nc" id="L14754">            sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L14755">            r = new Report(3040);</span>
<span class="nc" id="L14756">            r.subject = entity.getId();</span>
<span class="nc" id="L14757">            r.addDesc(entity);</span>
<span class="nc" id="L14758">            addReport(r);</span>
        }

        // Is there the rubble of a medium, heavy,
        // or hardened building in the hex?
<span class="nc bnc" id="L14763" title="All 2 branches missed.">        else if (Building.LIGHT &lt; curHex.terrainLevel(Terrains.RUBBLE)) {</span>

            // Finding a club is not guaranteed. The chances are
            // based on the type of building that produced the
            // rubble.
<span class="nc" id="L14768">            boolean found = false;</span>
<span class="nc" id="L14769">            int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L14770" title="All 5 branches missed.">            switch (curHex.terrainLevel(Terrains.RUBBLE)) {</span>
                case Building.MEDIUM:
<span class="nc bnc" id="L14772" title="All 2 branches missed.">                    if (roll &gt;= 7) {</span>
<span class="nc" id="L14773">                        found = true;</span>
                    }
                    break;
                case Building.HEAVY:
<span class="nc bnc" id="L14777" title="All 2 branches missed.">                    if (roll &gt;= 6) {</span>
<span class="nc" id="L14778">                        found = true;</span>
                    }
                    break;
                case Building.HARDENED:
<span class="nc bnc" id="L14782" title="All 2 branches missed.">                    if (roll &gt;= 5) {</span>
<span class="nc" id="L14783">                        found = true;</span>
                    }
                    break;
                case Building.WALL:
<span class="nc bnc" id="L14787" title="All 2 branches missed.">                    if (roll &gt;= 13) {</span>
<span class="nc" id="L14788">                        found = true;</span>
                    }
                    break;
                default:
                    // we must be in ultra
<span class="nc bnc" id="L14793" title="All 2 branches missed.">                    if (roll &gt;= 4) {</span>
<span class="nc" id="L14794">                        found = true;</span>
                    }
            }

            // Let the player know if they found a club.
<span class="nc bnc" id="L14799" title="All 2 branches missed.">            if (found) {</span>
<span class="nc" id="L14800">                clubType = EquipmentType.get(EquipmentTypeLookup.GIRDER_CLUB);</span>
<span class="nc" id="L14801">                r = new Report(3045);</span>
<span class="nc" id="L14802">                r.subject = entity.getId();</span>
<span class="nc" id="L14803">                r.addDesc(entity);</span>
<span class="nc" id="L14804">                addReport(r);</span>
            } else {
                // Sorry, no club for you.
<span class="nc" id="L14807">                r = new Report(3050);</span>
<span class="nc" id="L14808">                r.subject = entity.getId();</span>
<span class="nc" id="L14809">                r.addDesc(entity);</span>
<span class="nc" id="L14810">                addReport(r);</span>
            }
<span class="nc" id="L14812">        }</span>

        // Are there woods in the hex?
<span class="nc bnc" id="L14815" title="All 2 branches missed.">        else if (curHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L14816" title="All 2 branches missed.">                 || curHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L14817">            clubType = EquipmentType.get(EquipmentTypeLookup.TREE_CLUB);</span>
<span class="nc" id="L14818">            r = new Report(3055);</span>
<span class="nc" id="L14819">            r.subject = entity.getId();</span>
<span class="nc" id="L14820">            r.addDesc(entity);</span>
<span class="nc" id="L14821">            addReport(r);</span>
        }

        // add the club
        try {
<span class="nc bnc" id="L14826" title="All 2 branches missed.">            if (clubType != null) {</span>
<span class="nc" id="L14827">                entity.addEquipment(clubType, Entity.LOC_NONE);</span>
            }
<span class="nc" id="L14829">        } catch (LocationFullException ex) {</span>
            // unlikely...
<span class="nc" id="L14831">            r = new Report(3060);</span>
<span class="nc" id="L14832">            r.subject = entity.getId();</span>
<span class="nc" id="L14833">            r.addDesc(entity);</span>
<span class="nc" id="L14834">            addReport(r);</span>
<span class="nc" id="L14835">        }</span>
<span class="nc" id="L14836">    }</span>

    /**
     * Try to ignite the hex, taking into account existing fires and the
     * effects of Inferno rounds.
     *
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex being lit.
     * @param entityId
     *            - the &lt;code&gt;int&lt;/code&gt; id of the entity involved.
     * @param bInferno
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon igniting the hex is an
     *            Inferno round. If some other weapon or ammo is causing the
     *            roll, this should be &lt;code&gt;false&lt;/code&gt;.
     * @param bHotGun
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon is plasma/flamer/incendiary
     *            LRM/etc
     * @param nTargetRoll
     *            - the &lt;code&gt;TargetRoll&lt;/code&gt; for the ignition roll.
     * @param bReportAttempt
     *            - &lt;code&gt;true&lt;/code&gt; if the attempt roll should be added to the
     *            report.
     * @param accidentTarget
     *            - &lt;code&gt;int&lt;/code&gt; the target number below which a roll has to
     *            be made in order to try igniting a hex accidentally. -1 for
     *            intentional
     */
    public boolean tryIgniteHex(Coords c, int entityId, boolean bHotGun,
            boolean bInferno, TargetRoll nTargetRoll, boolean bReportAttempt,
            int accidentTarget, Vector&lt;Report&gt; vPhaseReport) {

<span class="nc" id="L14867">        IHex hex = game.getBoard().getHex(c);</span>
        Report r;

        // Ignore bad coordinates.
<span class="nc bnc" id="L14871" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L14872">            return false;</span>
        }

        // Ignore if fire is not enabled as a game option
<span class="nc bnc" id="L14876" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_START_FIRE)) {</span>
<span class="nc" id="L14877">            return false;</span>
        }

        // is the hex ignitable (how are infernos handled?)
<span class="nc bnc" id="L14881" title="All 2 branches missed.">        if (!hex.isIgnitable()) {</span>
<span class="nc" id="L14882">            return false;</span>
        }

        // first for accidental ignitions, make the necessary roll
<span class="nc bnc" id="L14886" title="All 2 branches missed.">        if (accidentTarget &gt; -1) {</span>
            // if this hex is in snow, then accidental ignitions are not
            // possible
<span class="nc bnc" id="L14889" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L14890">                return false;</span>
            }
<span class="nc" id="L14892">            nTargetRoll.addModifier(2, &quot;accidental&quot;);</span>
<span class="nc" id="L14893">            int accidentRoll = Compute.d6(2);</span>
<span class="nc" id="L14894">            r = new Report(3066);</span>
<span class="nc" id="L14895">            r.subject = entityId;</span>
<span class="nc" id="L14896">            r.add(accidentTarget);</span>
<span class="nc" id="L14897">            r.add(accidentRoll);</span>
<span class="nc" id="L14898">            r.indent(2);</span>
<span class="nc bnc" id="L14899" title="All 2 branches missed.">            if (accidentRoll &gt; accidentTarget) {</span>
<span class="nc" id="L14900">                r.choose(false);</span>
<span class="nc" id="L14901">                vPhaseReport.add(r);</span>
<span class="nc" id="L14902">                return false;</span>
            }
<span class="nc" id="L14904">            r.choose(true);</span>
<span class="nc" id="L14905">            vPhaseReport.add(r);</span>
        }

<span class="nc" id="L14908">        int terrainMod = hex.getIgnitionModifier();</span>
<span class="nc bnc" id="L14909" title="All 2 branches missed.">        if (terrainMod != 0) {</span>
<span class="nc" id="L14910">            nTargetRoll.addModifier(terrainMod, &quot;terrain&quot;);</span>
        }

        // building modifiers
<span class="nc" id="L14914">        Building bldg = game.getBoard().getBuildingAt(c);</span>
<span class="nc bnc" id="L14915" title="All 2 branches missed.">        if (null != bldg) {</span>
<span class="nc" id="L14916">            nTargetRoll.addModifier(bldg.getType() - 3, &quot;building&quot;);</span>
        }

        // add in any modifiers for planetary conditions
<span class="nc" id="L14920">        int weatherMod = game.getPlanetaryConditions().getIgniteModifiers();</span>
<span class="nc bnc" id="L14921" title="All 2 branches missed.">        if (weatherMod != 0) {</span>
<span class="nc" id="L14922">            nTargetRoll.addModifier(weatherMod, &quot;conditions&quot;);</span>
        }

        // if there is snow on the ground and this a hotgun or inferno, it may
        // melt the snow instead
<span class="nc bnc" id="L14927" title="All 2 branches missed.">        if ((hex.containsTerrain(Terrains.SNOW) || hex</span>
<span class="nc bnc" id="L14928" title="All 6 branches missed.">                .containsTerrain(Terrains.ICE)) &amp;&amp; (bHotGun || bInferno)) {</span>
<span class="nc" id="L14929">            boolean melted = false;</span>
<span class="nc" id="L14930">            int meltCheck = Compute.d6(2);</span>
<span class="nc bnc" id="L14931" title="All 4 branches missed.">            if ((hex.terrainLevel(Terrains.SNOW) &gt; 1) &amp;&amp; (meltCheck == 12)) {</span>
<span class="nc" id="L14932">                melted = true;</span>
<span class="nc bnc" id="L14933" title="All 4 branches missed.">            } else if (hex.containsTerrain(Terrains.ICE) &amp;&amp; (meltCheck &gt; 9)) {</span>
<span class="nc" id="L14934">                melted = true;</span>
<span class="nc bnc" id="L14935" title="All 4 branches missed.">            } else if (hex.containsTerrain(Terrains.SNOW) &amp;&amp; (meltCheck &gt; 7)) {</span>
<span class="nc" id="L14936">                melted = true;</span>
            }
<span class="nc bnc" id="L14938" title="All 2 branches missed.">            if (bInferno) {</span>
<span class="nc" id="L14939">                melted = true;</span>
            }
<span class="nc bnc" id="L14941" title="All 2 branches missed.">            if (melted) {</span>
<span class="nc" id="L14942">                vPhaseReport.addAll(meltIceAndSnow(c, entityId));</span>
<span class="nc" id="L14943">                return false;</span>
            }

        }

        // inferno always ignites
        // ERRATA not if targeting clear hexes for ignition is disabled.
<span class="nc bnc" id="L14950" title="All 4 branches missed.">        if (bInferno &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_NO_IGNITE_CLEAR)) {</span>
<span class="nc" id="L14951">            nTargetRoll = new TargetRoll(0, &quot;inferno&quot;);</span>
        }

        // no lighting fires in tornadoes
<span class="nc bnc" id="L14955" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L14956">            nTargetRoll = new TargetRoll(TargetRoll.AUTOMATIC_FAIL, &quot;tornado&quot;);</span>
        }

        // The hex may already be on fire.
<span class="nc bnc" id="L14960" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc bnc" id="L14961" title="All 2 branches missed.">            if (bReportAttempt) {</span>
<span class="nc" id="L14962">                r = new Report(3065);</span>
<span class="nc" id="L14963">                r.indent(2);</span>
<span class="nc" id="L14964">                r.subject = entityId;</span>
<span class="nc" id="L14965">                vPhaseReport.add(r);</span>
            }
<span class="nc bnc" id="L14967" title="All 2 branches missed.">        } else if (checkIgnition(c, nTargetRoll, bInferno, entityId,</span>
                vPhaseReport)) {
<span class="nc" id="L14969">            return true;</span>
        }
<span class="nc" id="L14971">        return false;</span>
    }

    /**
     * Try to ignite the hex, taking into account existing fires and the
     * effects of Inferno rounds. This version of the method will not report the
     * attempt roll.
     *
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex being lit.
     * @param entityId
     *            - the &lt;code&gt;int&lt;/code&gt; id of the entity involved.
     * @param bInferno
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon igniting the hex is an
     *            Inferno round. If some other weapon or ammo is causing the
     *            roll, this should be &lt;code&gt;false&lt;/code&gt;.
     * @param nTargetRoll
     *            - the &lt;code&gt;int&lt;/code&gt; roll target for the attempt.
     */
    public boolean tryIgniteHex(Coords c, int entityId, boolean bHotGun, boolean bInferno,
                                TargetRoll nTargetRoll, int accidentTarget,
                                Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L14993">        return tryIgniteHex(c, entityId, bHotGun, bInferno, nTargetRoll, false,</span>
                accidentTarget, vPhaseReport);
    }

    public Vector&lt;Report&gt; tryClearHex(Coords c, int nDamage, int entityId) {
<span class="nc" id="L14998">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L14999">        IHex h = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L15000" title="All 2 branches missed.">        if (h == null) {</span>
<span class="nc" id="L15001">            return vPhaseReport;</span>
        }
<span class="nc" id="L15003">        ITerrain woods = h.getTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15004">        ITerrain jungle = h.getTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15005">        ITerrain ice = h.getTerrain(Terrains.ICE);</span>
<span class="nc" id="L15006">        ITerrain magma = h.getTerrain(Terrains.MAGMA);</span>
        Report r;
<span class="nc" id="L15008">        int reportType = Report.HIDDEN;</span>
<span class="nc bnc" id="L15009" title="All 2 branches missed.">        if (entityId == Entity.NONE) {</span>
<span class="nc" id="L15010">            reportType = Report.PUBLIC;</span>
        }
<span class="nc bnc" id="L15012" title="All 2 branches missed.">        if (woods != null) {</span>
<span class="nc" id="L15013">            int tf = woods.getTerrainFactor() - nDamage;</span>
<span class="nc" id="L15014">            int level = woods.getLevel();</span>
<span class="nc" id="L15015">            int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L15016" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
<span class="nc" id="L15017">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15018">                h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L15019">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.ROUGH, 1));
                // light converted to rough
<span class="nc" id="L15022">                r = new Report(3090, reportType);</span>
<span class="nc" id="L15023">                r.subject = entityId;</span>
<span class="nc" id="L15024">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15025" title="All 4 branches missed.">            } else if ((tf &lt;= 50) &amp;&amp; (level &gt; 1)) {</span>
<span class="nc" id="L15026">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15027">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.WOODS, 1));
<span class="nc bnc" id="L15029" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15030">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15033">                woods = h.getTerrain(Terrains.WOODS);</span>
                // heavy converted to light
<span class="nc" id="L15035">                r = new Report(3085, reportType);</span>
<span class="nc" id="L15036">                r.subject = entityId;</span>
<span class="nc" id="L15037">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15038" title="All 4 branches missed.">            } else if ((tf &lt;= 90) &amp;&amp; (level &gt; 2)) {</span>
<span class="nc" id="L15039">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15040">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.WOODS, 2));
<span class="nc bnc" id="L15042" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15043">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15046">                woods = h.getTerrain(Terrains.WOODS);</span>
                // ultra heavy converted to heavy
<span class="nc" id="L15048">                r = new Report(3082, reportType);</span>
<span class="nc" id="L15049">                r.subject = entityId;</span>
<span class="nc" id="L15050">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L15052">            woods.setTerrainFactor(tf);</span>
        }
<span class="nc bnc" id="L15054" title="All 2 branches missed.">        if (jungle != null) {</span>
<span class="nc" id="L15055">            int tf = jungle.getTerrainFactor() - nDamage;</span>
<span class="nc" id="L15056">            int level = jungle.getLevel();</span>
<span class="nc" id="L15057">            int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L15058" title="All 2 branches missed.">            if (tf &lt; 0) {</span>
<span class="nc" id="L15059">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15060">                h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L15061">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.ROUGH, 1));
                // light converted to rough
<span class="nc" id="L15064">                r = new Report(3091, reportType);</span>
<span class="nc" id="L15065">                r.subject = entityId;</span>
<span class="nc" id="L15066">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15067" title="All 4 branches missed.">            } else if ((tf &lt;= 50) &amp;&amp; (level &gt; 1)) {</span>
<span class="nc" id="L15068">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15069">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.JUNGLE, 1));
<span class="nc bnc" id="L15071" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15072">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15075">                jungle = h.getTerrain(Terrains.JUNGLE);</span>
                // heavy converted to light
<span class="nc" id="L15077">                r = new Report(3086, reportType);</span>
<span class="nc" id="L15078">                r.subject = entityId;</span>
<span class="nc" id="L15079">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15080" title="All 4 branches missed.">            } else if ((tf &lt;= 90) &amp;&amp; (level &gt; 2)) {</span>
<span class="nc" id="L15081">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15082">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.JUNGLE, 2));
<span class="nc bnc" id="L15084" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15085">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15088">                jungle = h.getTerrain(Terrains.JUNGLE);</span>
                // ultra heavy converted to heavy
<span class="nc" id="L15090">                r = new Report(3083, reportType);</span>
<span class="nc" id="L15091">                r.subject = entityId;</span>
<span class="nc" id="L15092">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L15094">            jungle.setTerrainFactor(tf);</span>
        }
<span class="nc bnc" id="L15096" title="All 2 branches missed.">        if (ice != null) {</span>
<span class="nc" id="L15097">            int tf = ice.getTerrainFactor() - nDamage;</span>
<span class="nc bnc" id="L15098" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
                // ice melted
<span class="nc" id="L15100">                r = new Report(3092, reportType);</span>
<span class="nc" id="L15101">                r.subject = entityId;</span>
<span class="nc" id="L15102">                vPhaseReport.add(r);</span>
<span class="nc" id="L15103">                vPhaseReport.addAll(resolveIceBroken(c));</span>
            } else {
<span class="nc" id="L15105">                ice.setTerrainFactor(tf);</span>
            }
        }
<span class="nc bnc" id="L15108" title="All 4 branches missed.">        if ((magma != null) &amp;&amp; (magma.getLevel() == 1)) {</span>
<span class="nc" id="L15109">            int tf = magma.getTerrainFactor() - nDamage;</span>
<span class="nc bnc" id="L15110" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
                // magma crust destroyed
<span class="nc" id="L15112">                r = new Report(3093, reportType);</span>
<span class="nc" id="L15113">                r.subject = entityId;</span>
<span class="nc" id="L15114">                vPhaseReport.add(r);</span>
<span class="nc" id="L15115">                h.removeTerrain(Terrains.MAGMA);</span>
<span class="nc" id="L15116">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.MAGMA, 2));
<span class="nc bnc" id="L15118" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(c)) {</span>
<span class="nc" id="L15119">                    doMagmaDamage(en, false);</span>
<span class="nc" id="L15120">                }</span>
            } else {
<span class="nc" id="L15122">                magma.setTerrainFactor(tf);</span>
            }
        }
<span class="nc" id="L15125">        sendChangedHex(c);</span>

        // any attempt to clear an heavy industrial hex may cause an exposion
<span class="nc" id="L15128">        checkExplodeIndustrialZone(c, vPhaseReport);</span>

<span class="nc" id="L15130">        return vPhaseReport;</span>
    }

    /**
     * Handle all physical attacks for the round
     */
    private void resolvePhysicalAttacks() {
        // Physical phase header
<span class="nc" id="L15138">        addReport(new Report(4000, Report.PUBLIC));</span>

        // add any pending charges
<span class="nc" id="L15141">        for (Enumeration&lt;AttackAction&gt; i = game.getCharges(); i</span>
<span class="nc bnc" id="L15142" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15143">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15145">        game.resetCharges();</span>

        // add any pending rams
<span class="nc bnc" id="L15148" title="All 2 branches missed.">        for (Enumeration&lt;AttackAction&gt; i = game.getRams(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15149">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15151">        game.resetRams();</span>

        // add any pending Tele Missile Attacks
<span class="nc" id="L15154">        for (Enumeration&lt;AttackAction&gt; i = game.getTeleMissileAttacks(); i</span>
<span class="nc bnc" id="L15155" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15156">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15158">        game.resetTeleMissileAttacks();</span>

        // remove any duplicate attack declarations
<span class="nc" id="L15161">        cleanupPhysicalAttacks();</span>

        // loop thru received attack actions
<span class="nc" id="L15164">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L15165" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15166">            Object o = i.nextElement();</span>
            // verify that the attacker is still active
<span class="nc" id="L15168">            AttackAction aa = (AttackAction) o;</span>
<span class="nc bnc" id="L15169" title="All 4 branches missed.">            if (!game.getEntity(aa.getEntityId()).isActive()</span>
                &amp;&amp; !(o instanceof DfaAttackAction)) {
<span class="nc" id="L15171">                continue;</span>
            }
<span class="nc" id="L15173">            AbstractAttackAction aaa = (AbstractAttackAction) o;</span>
            // do searchlights immediately
<span class="nc bnc" id="L15175" title="All 2 branches missed.">            if (aaa instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L15176">                SearchlightAttackAction saa = (SearchlightAttackAction) aaa;</span>
<span class="nc" id="L15177">                addReport(saa.resolveAction(game));</span>
<span class="nc" id="L15178">            } else {</span>
<span class="nc" id="L15179">                physicalResults.addElement(preTreatPhysicalAttack(aaa));</span>
            }
<span class="nc" id="L15181">        }</span>
<span class="nc" id="L15182">        int cen = Entity.NONE;</span>
<span class="nc bnc" id="L15183" title="All 2 branches missed.">        for (PhysicalResult pr : physicalResults) {</span>
<span class="nc" id="L15184">            resolvePhysicalAttack(pr, cen);</span>
<span class="nc" id="L15185">            cen = pr.aaa.getEntityId();</span>
<span class="nc" id="L15186">        }</span>
<span class="nc" id="L15187">        physicalResults.removeAllElements();</span>
<span class="nc" id="L15188">    }</span>

    /**
     * Cleans up the attack declarations for the physical phase by removing all
     * attacks past the first for any one mech. Also clears out attacks by dead
     * or disabled mechs.
     */
    private void cleanupPhysicalAttacks() {
<span class="nc bnc" id="L15196" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L15197">            Entity entity = i.next();</span>
<span class="nc" id="L15198">            removeDuplicateAttacks(entity.getId());</span>
<span class="nc" id="L15199">        }</span>
<span class="nc" id="L15200">        removeDeadAttacks();</span>
<span class="nc" id="L15201">    }</span>

    /**
     * Removes any actions in the attack queue beyond the first by the specified
     * entity, unless that entity has melee master in which case it allows two
     * attacks.
     */
    private void removeDuplicateAttacks(int entityId) {
<span class="nc" id="L15209">        int allowed = 1;</span>
<span class="nc" id="L15210">        Entity en = game.getEntity(entityId);</span>
<span class="nc bnc" id="L15211" title="All 2 branches missed.">        if (null != en) {</span>
<span class="nc" id="L15212">            allowed = en.getAllowedPhysicalAttacks();</span>
        }
<span class="nc" id="L15214">        Vector&lt;EntityAction&gt; toKeep = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L15216" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15217">            EntityAction action = i.nextElement();</span>
<span class="nc bnc" id="L15218" title="All 2 branches missed.">            if (action.getEntityId() != entityId) {</span>
<span class="nc" id="L15219">                toKeep.addElement(action);</span>
<span class="nc bnc" id="L15220" title="All 2 branches missed.">            } else if (allowed &gt; 0) {</span>
<span class="nc" id="L15221">                toKeep.addElement(action);</span>
<span class="nc bnc" id="L15222" title="All 2 branches missed.">                if (!(action instanceof SearchlightAttackAction)) {</span>
<span class="nc" id="L15223">                    allowed--;</span>
                }
            } else {
<span class="nc" id="L15226">                MegaMek.getLogger().error(&quot;Removing duplicate phys attack for id#&quot; + entityId</span>
<span class="nc" id="L15227">                                + &quot;\n\t\taction was &quot; + action.toString());</span>
            }
<span class="nc" id="L15229">        }</span>

        // reset actions and re-add valid elements
<span class="nc" id="L15232">        game.resetActions();</span>
<span class="nc bnc" id="L15233" title="All 2 branches missed.">        for (EntityAction entityAction : toKeep) {</span>
<span class="nc" id="L15234">            game.addAction(entityAction);</span>
<span class="nc" id="L15235">        }</span>
<span class="nc" id="L15236">    }</span>

    /**
     * Removes all attacks by any dead entities. It does this by going through
     * all the attacks and only keeping ones from active entities. DFAs are kept
     * even if the pilot is unconscious, so that he can fail.
     */
    private void removeDeadAttacks() {
<span class="nc" id="L15244">        Vector&lt;EntityAction&gt; toKeep = new Vector&lt;&gt;(game.actionsSize());</span>

<span class="nc bnc" id="L15246" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15247">            EntityAction action = i.nextElement();</span>
<span class="nc" id="L15248">            Entity entity = game.getEntity(action.getEntityId());</span>
<span class="nc bnc" id="L15249" title="All 4 branches missed.">            if ((entity != null) &amp;&amp; !entity.isDestroyed()</span>
<span class="nc bnc" id="L15250" title="All 4 branches missed.">                    &amp;&amp; (entity.isActive() || (action instanceof DfaAttackAction))) {</span>
<span class="nc" id="L15251">                toKeep.addElement(action);</span>
            }
<span class="nc" id="L15253">        }</span>

        // reset actions and re-add valid elements
<span class="nc" id="L15256">        game.resetActions();</span>
<span class="nc bnc" id="L15257" title="All 2 branches missed.">        for (EntityAction entityAction : toKeep) {</span>
<span class="nc" id="L15258">            game.addAction(entityAction);</span>
<span class="nc" id="L15259">        }</span>
<span class="nc" id="L15260">    }</span>

    /**
     * Apply damage to mech for zweihandering (melee attack with both hands) as per
     * pg. 82, CamOps
     * 
     * @param ae           - the attacking entity
     * @param missed       - did the attack missed. If so PSR is necessary.
     * @param criticalLocs - the locations for possible criticals, should be one or
     *                     both arms depending on if it was an unarmed attack (both
     *                     arms) or a weapon attack (the arm with the weapon).
     */
    private void applyZweihanderSelfDamage(Entity ae, boolean missed, List&lt;Integer&gt; criticalLocs) {
<span class="nc" id="L15273">        Report r = new Report(4022);</span>
<span class="nc" id="L15274">        r.subject = ae.getId();</span>
<span class="nc" id="L15275">        r.indent();</span>
<span class="nc" id="L15276">        r.addDesc(ae);</span>
<span class="nc" id="L15277">        addReport(r);</span>
<span class="nc bnc" id="L15278" title="All 2 branches missed.">        for (Integer loc : criticalLocs) {</span>
<span class="nc" id="L15279">            addReport(criticalEntity(ae, loc, false, 0, 1));</span>
<span class="nc" id="L15280">        }</span>
<span class="nc bnc" id="L15281" title="All 2 branches missed.">        if(missed) {</span>
<span class="nc" id="L15282">            game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;Zweihander miss&quot;));</span>
        }
<span class="nc" id="L15284">    }</span>

    /**
     * Handle a punch attack
     */
    private void resolvePunchAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15290">        final PunchAttackAction paa = (PunchAttackAction) pr.aaa;</span>
<span class="nc" id="L15291">        final Entity ae = game.getEntity(paa.getEntityId());</span>
<span class="nc" id="L15292">        final Targetable target = game.getTarget(paa.getTargetType(), paa.getTargetId());</span>
<span class="nc" id="L15293">        Entity te = null;</span>
<span class="nc bnc" id="L15294" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15295">            te = (Entity) target;</span>
        }
<span class="nc" id="L15297">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15298" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15299">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L15301" title="All 2 branches missed.">        final String armName = paa.getArm() == PunchAttackAction.LEFT ? &quot;Left Arm&quot; : &quot;Right Arm&quot;;</span>

<span class="nc bnc" id="L15303" title="All 2 branches missed.">        final int armLoc = paa.getArm() == PunchAttackAction.LEFT ? Mech.LOC_LARM : Mech.LOC_RARM;</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc bnc" id="L15306" title="All 2 branches missed.">        int damage = paa.getArm() == PunchAttackAction.LEFT ? pr.damage : pr.damageRight;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L15308" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15309">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc bnc" id="L15311" title="All 2 branches missed.">        final ToHitData toHit = paa.getArm() == PunchAttackAction.LEFT ? pr.toHit : pr.toHitRight;</span>
<span class="nc bnc" id="L15312" title="All 2 branches missed.">        int roll = paa.getArm() == PunchAttackAction.LEFT ? pr.roll : pr.rollRight;</span>
<span class="nc" id="L15313">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15314" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15315" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        Report r;

        // Set Margin of Success/Failure.
<span class="nc" id="L15320">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15321" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15322" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15325">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15327" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // report who is making the attacks
<span class="nc" id="L15329">            r = new Report(4005);</span>
<span class="nc" id="L15330">            r.subject = ae.getId();</span>
<span class="nc" id="L15331">            r.addDesc(ae);</span>
<span class="nc" id="L15332">            addReport(r);</span>
        }

<span class="nc" id="L15335">        r = new Report(4010);</span>
<span class="nc" id="L15336">        r.subject = ae.getId();</span>
<span class="nc" id="L15337">        r.indent();</span>
<span class="nc" id="L15338">        r.add(armName);</span>
<span class="nc" id="L15339">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15340">        r.newlines = 0;</span>
<span class="nc" id="L15341">        addReport(r);</span>

<span class="nc bnc" id="L15343" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15344">            r = new Report(4015);</span>
<span class="nc" id="L15345">            r.subject = ae.getId();</span>
<span class="nc" id="L15346">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15347">            addReport(r);</span>
<span class="nc bnc" id="L15348" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15349">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed punch attack&quot;));</span>
            }
<span class="nc" id="L15351">            return;</span>
<span class="nc bnc" id="L15352" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15353">            r = new Report(4020);</span>
<span class="nc" id="L15354">            r.subject = ae.getId();</span>
<span class="nc" id="L15355">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15356">            r.newlines = 0;</span>
<span class="nc" id="L15357">            addReport(r);</span>
<span class="nc" id="L15358">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15360">            r = new Report(4025);</span>
<span class="nc" id="L15361">            r.subject = ae.getId();</span>
<span class="nc" id="L15362">            r.add(toHit);</span>
<span class="nc" id="L15363">            r.add(roll);</span>
<span class="nc" id="L15364">            r.newlines = 0;</span>
<span class="nc" id="L15365">            addReport(r);</span>
<span class="nc bnc" id="L15366" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15367">                r = new Report(3186);</span>
<span class="nc" id="L15368">                r.subject = ae.getId();</span>
<span class="nc" id="L15369">                r.newlines = 0;</span>
<span class="nc" id="L15370">                addReport(r);</span>
            }
<span class="nc bnc" id="L15372" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15373">                r = new Report(3189);</span>
<span class="nc" id="L15374">                r.subject = ae.getId();</span>
<span class="nc" id="L15375">                r.newlines = 0;</span>
<span class="nc" id="L15376">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L15381" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // nope
<span class="nc" id="L15383">            r = new Report(4035);</span>
<span class="nc" id="L15384">            r.subject = ae.getId();</span>
<span class="nc" id="L15385">            addReport(r);</span>

<span class="nc bnc" id="L15387" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15388">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed punch attack&quot;));</span>
            }
            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15391" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L15394" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15395">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15396" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15397">                        report.subject = ae.getId();</span>
<span class="nc" id="L15398">                    }</span>
<span class="nc" id="L15399">                    addReport(buildingReport);</span>
                }

            }

<span class="nc bnc" id="L15404" title="All 2 branches missed.">            if(paa.isZweihandering()) {</span>
<span class="nc" id="L15405">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15406">                criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15407">                criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15408">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }

<span class="nc" id="L15411">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15415" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15416" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15418">            r = new Report(4040);</span>
<span class="nc" id="L15419">            r.subject = ae.getId();</span>
<span class="nc" id="L15420">            addReport(r);</span>
<span class="nc" id="L15421">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15422" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15423">                report.subject = ae.getId();</span>
<span class="nc" id="L15424">            }</span>
<span class="nc" id="L15425">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15428">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

<span class="nc bnc" id="L15430" title="All 2 branches missed.">            if(paa.isZweihandering()) {</span>
<span class="nc" id="L15431">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15432">                criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15433">                criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15434">                applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
            }

            // And we're done!
<span class="nc" id="L15438">            return;</span>
        }

<span class="nc" id="L15441">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15442">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L15443">        r = new Report(4045);</span>
<span class="nc" id="L15444">        r.subject = ae.getId();</span>
<span class="nc" id="L15445">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L15446">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L15447">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15451" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15452">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15453">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15454">            damage -= toBldg;</span>
<span class="nc" id="L15455">            addNewLines();</span>
<span class="nc" id="L15456">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, toBldg, target.getPosition());</span>
<span class="nc bnc" id="L15457" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15458">                report.subject = ae.getId();</span>
<span class="nc" id="L15459">            }</span>
<span class="nc" id="L15460">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L15464">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L15468" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L15469">            r = new Report(4050);</span>
<span class="nc" id="L15470">            r.subject = ae.getId();</span>
<span class="nc" id="L15471">            r.add(te.getShortName());</span>
<span class="nc" id="L15472">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L15473">            r.indent();</span>
<span class="nc" id="L15474">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L15476" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15478" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L15480" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15481">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15482">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

<span class="nc" id="L15485">            damage = checkForSpikes(te, hit.getLocation(), damage, ae,</span>
<span class="nc bnc" id="L15486" title="All 2 branches missed.">                    (paa.getArm() == PunchAttackAction.LEFT) ?  Mech.LOC_LARM : Mech.LOC_RARM);</span>
<span class="nc" id="L15487">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L15488">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                    false, throughFront));
<span class="nc bnc" id="L15490" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L15492">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM, VTOL.CRIT_ROTOR_DESTROYED),
                        false, 0, false));
            }
            // check for extending retractable blades
<span class="nc bnc" id="L15497" title="All 2 branches missed.">            if (paa.isBladeExtended(paa.getArm())) {</span>
<span class="nc" id="L15498">                addNewLines();</span>
<span class="nc" id="L15499">                r = new Report(4455);</span>
<span class="nc" id="L15500">                r.indent(2);</span>
<span class="nc" id="L15501">                r.subject = ae.getId();</span>
<span class="nc" id="L15502">                r.newlines = 0;</span>
<span class="nc" id="L15503">                addReport(r);</span>
                // conventional infantry don't take crits and battle armor need
                // to be handled differently
<span class="nc bnc" id="L15506" title="All 2 branches missed.">                if (!(target instanceof Infantry)) {</span>
<span class="nc" id="L15507">                    addNewLines();</span>
<span class="nc" id="L15508">                    addReport(criticalEntity(te, hit.getLocation(), hit.isRear(), 0,</span>
                            true, false, damage));
                }
<span class="nc bnc" id="L15511" title="All 4 branches missed.">                if ((target instanceof BattleArmor) &amp;&amp; (hit.getLocation() &lt; te.locations())</span>
<span class="nc bnc" id="L15512" title="All 2 branches missed.">                        &amp;&amp; (te.getInternal(hit.getLocation()) &gt; 0)) {</span>
                    // TODO : we should really apply BA criticals through the critical
                    // TODO : hits methods. Right now they are applied in damageEntity
<span class="nc" id="L15515">                    HitData baHit = new HitData(hit.getLocation(), false,</span>
                            HitData.EFFECT_CRITICAL);
<span class="nc" id="L15517">                    addReport(damageEntity(te, baHit, 0));</span>
                }
                // extend the blade
                // since retracting/extending is a freebie in the movement
                // phase, lets assume that the
                // blade retracts to its original mode
                // ae.extendBlade(paa.getArm());
                // check for breaking a nail
<span class="nc bnc" id="L15525" title="All 2 branches missed.">                if (Compute.d6(2) &gt; 9) {</span>
<span class="nc" id="L15526">                    addNewLines();</span>
<span class="nc" id="L15527">                    r = new Report(4456);</span>
<span class="nc" id="L15528">                    r.indent(2);</span>
<span class="nc" id="L15529">                    r.subject = ae.getId();</span>
<span class="nc" id="L15530">                    r.newlines = 0;</span>
<span class="nc" id="L15531">                    addReport(r);</span>
<span class="nc" id="L15532">                    ae.destroyRetractableBlade(armLoc);</span>
                }
            }
        }
<span class="nc" id="L15536">        addNewLines();</span>

<span class="nc bnc" id="L15538" title="All 2 branches missed.">        if(paa.isZweihandering()) {</span>
<span class="nc" id="L15539">            ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15540">            criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15541">            criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15542">            applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
        }
<span class="nc" id="L15544">        addNewLines();</span>


        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L15549" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L15550">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L15552">    }</span>

    /**
     * Handle a kick attack
     */
    private void resolveKickAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15558">        KickAttackAction kaa = (KickAttackAction) pr.aaa;</span>
<span class="nc" id="L15559">        final Entity ae = game.getEntity(kaa.getEntityId());</span>
<span class="nc" id="L15560">        final Targetable target = game.getTarget(kaa.getTargetType(), kaa.getTargetId());</span>
<span class="nc" id="L15561">        Entity te = null;</span>
<span class="nc bnc" id="L15562" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15563">            te = (Entity) target;</span>
        }
<span class="nc" id="L15565">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15566" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15567">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L15569" title="All 2 branches missed.">        String legName = (kaa.getLeg() == KickAttackAction.LEFT)</span>
<span class="nc bnc" id="L15570" title="All 2 branches missed.">                || (kaa.getLeg() == KickAttackAction.LEFTMULE) ? &quot;Left &quot; : &quot;Right &quot;;</span>
<span class="nc bnc" id="L15571" title="All 2 branches missed.">        if ((kaa.getLeg() == KickAttackAction.LEFTMULE)</span>
<span class="nc bnc" id="L15572" title="All 2 branches missed.">                || (kaa.getLeg() == KickAttackAction.RIGHTMULE)) {</span>
<span class="nc" id="L15573">            legName = legName.concat(&quot;rear &quot;);</span>
<span class="nc bnc" id="L15574" title="All 2 branches missed.">        } else if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15575">            legName = legName.concat(&quot;front &quot;);</span>
        }
<span class="nc" id="L15577">        legName = legName.concat(&quot;leg&quot;);</span>
        Report r;

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L15581">        int damage = pr.damage;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L15583" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15584">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc" id="L15586">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L15587">        int roll = pr.roll;</span>
<span class="nc" id="L15588">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15589" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15590" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L15593">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15594" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15595" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15598">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15600" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L15602">            r = new Report(4005);</span>
<span class="nc" id="L15603">            r.subject = ae.getId();</span>
<span class="nc" id="L15604">            r.addDesc(ae);</span>
<span class="nc" id="L15605">            addReport(r);</span>
        }

<span class="nc" id="L15608">        r = new Report(4055);</span>
<span class="nc" id="L15609">        r.subject = ae.getId();</span>
<span class="nc" id="L15610">        r.indent();</span>
<span class="nc" id="L15611">        r.add(legName);</span>
<span class="nc" id="L15612">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15613">        r.newlines = 0;</span>
<span class="nc" id="L15614">        addReport(r);</span>

<span class="nc bnc" id="L15616" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15617">            r = new Report(4060);</span>
<span class="nc" id="L15618">            r.subject = ae.getId();</span>
<span class="nc" id="L15619">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15620">            addReport(r);</span>
<span class="nc bnc" id="L15621" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15622">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            } else {
<span class="nc" id="L15624">                game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            }
<span class="nc" id="L15626">            return;</span>
<span class="nc bnc" id="L15627" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15628">            r = new Report(4065);</span>
<span class="nc" id="L15629">            r.subject = ae.getId();</span>
<span class="nc" id="L15630">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15631">            r.newlines = 0;</span>
<span class="nc" id="L15632">            addReport(r);</span>
<span class="nc" id="L15633">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15635">            r = new Report(4025);</span>
<span class="nc" id="L15636">            r.subject = ae.getId();</span>
<span class="nc" id="L15637">            r.add(toHit);</span>
<span class="nc" id="L15638">            r.add(roll);</span>
<span class="nc" id="L15639">            r.newlines = 0;</span>
<span class="nc" id="L15640">            addReport(r);</span>
<span class="nc bnc" id="L15641" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15642">                r = new Report(3186);</span>
<span class="nc" id="L15643">                r.subject = ae.getId();</span>
<span class="nc" id="L15644">                r.newlines = 0;</span>
<span class="nc" id="L15645">                addReport(r);</span>
            }
<span class="nc bnc" id="L15647" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15648">                r = new Report(3189);</span>
<span class="nc" id="L15649">                r.subject = ae.getId();</span>
<span class="nc" id="L15650">                r.newlines = 0;</span>
<span class="nc" id="L15651">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L15657" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L15659">            r = new Report(4035);</span>
<span class="nc" id="L15660">            r.subject = ae.getId();</span>
<span class="nc" id="L15661">            addReport(r);</span>
<span class="nc bnc" id="L15662" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15663">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            } else {
<span class="nc" id="L15665">                game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            }

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15669" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L15672" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15673">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15674" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15675">                        report.subject = ae.getId();</span>
<span class="nc" id="L15676">                    }</span>
<span class="nc" id="L15677">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L15681">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15685" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15686" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15688">            r = new Report(4040);</span>
<span class="nc" id="L15689">            r.subject = ae.getId();</span>
<span class="nc" id="L15690">            addReport(r);</span>
<span class="nc" id="L15691">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15692" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15693">                report.subject = ae.getId();</span>
<span class="nc" id="L15694">            }</span>
<span class="nc" id="L15695">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15698">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L15701">            return;</span>
        }

<span class="nc" id="L15704">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15705">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L15706">        r = new Report(4045);</span>
<span class="nc" id="L15707">        r.subject = ae.getId();</span>
<span class="nc" id="L15708">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L15709">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L15710">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15714" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15715">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15716">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15717">            damage -= toBldg;</span>
<span class="nc" id="L15718">            addNewLines();</span>
<span class="nc" id="L15719">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15720" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15721">                report.subject = ae.getId();</span>
<span class="nc" id="L15722">            }</span>
<span class="nc" id="L15723">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L15727">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L15731" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L15732">            r = new Report(4050);</span>
<span class="nc" id="L15733">            r.subject = ae.getId();</span>
<span class="nc" id="L15734">            r.add(te.getShortName());</span>
<span class="nc" id="L15735">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L15736">            r.newlines = 0;</span>
<span class="nc" id="L15737">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L15739" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15741" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L15743" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15744">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15745">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

            int leg;
<span class="nc bnc" id="L15749" title="All 4 branches missed.">            switch (kaa.getLeg()) {</span>
                case KickAttackAction.LEFT:
<span class="nc bnc" id="L15751" title="All 2 branches missed.">                    if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15752">                        leg = Mech.LOC_LARM;</span>
                    } else {
<span class="nc" id="L15754">                        leg = Mech.LOC_LLEG;</span>
                    }
<span class="nc" id="L15756">                    break;</span>
                case KickAttackAction.RIGHT:
<span class="nc bnc" id="L15758" title="All 2 branches missed.">                    if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15759">                        leg = Mech.LOC_RARM;</span>
                    } else {
<span class="nc" id="L15761">                        leg = Mech.LOC_RLEG;</span>
                    }
<span class="nc" id="L15763">                    break;</span>
                case KickAttackAction.LEFTMULE:
<span class="nc" id="L15765">                    leg = Mech.LOC_LLEG;</span>
<span class="nc" id="L15766">                    break;</span>
                case KickAttackAction.RIGHTMULE:
                default:
<span class="nc" id="L15769">                    leg = Mech.LOC_RLEG;</span>
                    break;
            }
<span class="nc" id="L15772">            damage = checkForSpikes(te, hit.getLocation(), damage, ae, leg);</span>
<span class="nc" id="L15773">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L15774">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                    false, throughFront));
<span class="nc bnc" id="L15776" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L15778">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
<span class="nc bnc" id="L15782" title="All 2 branches missed.">            if (te.hasQuirk(OptionsConstants.QUIRK_NEG_WEAK_LEGS)) {</span>
<span class="nc" id="L15783">                addNewLines();</span>
<span class="nc" id="L15784">                addReport(criticalEntity(te, hit.getLocation(), hit.isRear(), 0, 0));</span>
            }
        }

<span class="nc bnc" id="L15788" title="All 2 branches missed.">        if (te.canFall()) {</span>
<span class="nc" id="L15789">            PilotingRollData kickPRD = getKickPushPSR(te, ae, te, &quot;was kicked&quot;);</span>
<span class="nc" id="L15790">            game.addPSR(kickPRD);</span>
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L15795" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L15796">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L15799">        addNewLines();</span>
<span class="nc" id="L15800">    }</span>

    /**
     * Handle a kick attack
     */
    private void resolveJumpJetAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15806">        JumpJetAttackAction kaa = (JumpJetAttackAction) pr.aaa;</span>
<span class="nc" id="L15807">        final Entity ae = game.getEntity(kaa.getEntityId());</span>
<span class="nc" id="L15808">        final Targetable target = game.getTarget(kaa.getTargetType(), kaa.getTargetId());</span>
<span class="nc" id="L15809">        Entity te = null;</span>
<span class="nc bnc" id="L15810" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15811">            te = (Entity) target;</span>
        }
<span class="nc" id="L15813">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15814" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15815">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
        String legName;
<span class="nc bnc" id="L15818" title="All 3 branches missed.">        switch (kaa.getLeg()) {</span>
            case JumpJetAttackAction.LEFT:
<span class="nc" id="L15820">                legName = &quot;Left leg&quot;;</span>
<span class="nc" id="L15821">                break;</span>
            case JumpJetAttackAction.RIGHT:
<span class="nc" id="L15823">                legName = &quot;Right leg&quot;;</span>
<span class="nc" id="L15824">                break;</span>
            default:
<span class="nc" id="L15826">                legName = &quot;Both legs&quot;;</span>
                break;
        }

        Report r;

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L15833">        int damage = pr.damage;</span>
<span class="nc" id="L15834">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L15835">        int roll = pr.roll;</span>
<span class="nc" id="L15836">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15837" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15838" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L15841">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15842" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15843" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15846">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15848" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L15850">            r = new Report(4005);</span>
<span class="nc" id="L15851">            r.subject = ae.getId();</span>
<span class="nc" id="L15852">            r.addDesc(ae);</span>
<span class="nc" id="L15853">            addReport(r);</span>
        }

<span class="nc" id="L15856">        r = new Report(4290);</span>
<span class="nc" id="L15857">        r.subject = ae.getId();</span>
<span class="nc" id="L15858">        r.indent();</span>
<span class="nc" id="L15859">        r.add(legName);</span>
<span class="nc" id="L15860">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15861">        r.newlines = 0;</span>
<span class="nc" id="L15862">        addReport(r);</span>

<span class="nc bnc" id="L15864" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15865">            r = new Report(4075);</span>
<span class="nc" id="L15866">            r.subject = ae.getId();</span>
<span class="nc" id="L15867">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15868">            addReport(r);</span>
<span class="nc" id="L15869">            return;</span>
<span class="nc bnc" id="L15870" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15871">            r = new Report(4080);</span>
<span class="nc" id="L15872">            r.subject = ae.getId();</span>
<span class="nc" id="L15873">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15874">            r.newlines = 0;</span>
<span class="nc" id="L15875">            addReport(r);</span>
<span class="nc" id="L15876">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15878">            r = new Report(4025);</span>
<span class="nc" id="L15879">            r.subject = ae.getId();</span>
<span class="nc" id="L15880">            r.add(toHit);</span>
<span class="nc" id="L15881">            r.add(roll);</span>
<span class="nc" id="L15882">            r.newlines = 0;</span>
<span class="nc" id="L15883">            addReport(r);</span>
<span class="nc bnc" id="L15884" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15885">                r = new Report(3186);</span>
<span class="nc" id="L15886">                r.subject = ae.getId();</span>
<span class="nc" id="L15887">                r.newlines = 0;</span>
<span class="nc" id="L15888">                addReport(r);</span>
            }
<span class="nc bnc" id="L15890" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15891">                r = new Report(3189);</span>
<span class="nc" id="L15892">                r.subject = ae.getId();</span>
<span class="nc" id="L15893">                r.newlines = 0;</span>
<span class="nc" id="L15894">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L15900" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L15902">            r = new Report(4035);</span>
<span class="nc" id="L15903">            r.subject = ae.getId();</span>
<span class="nc" id="L15904">            addReport(r);</span>

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15907" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

<span class="nc" id="L15909">                damage += pr.damageRight;</span>
                // Only report if damage was done to the building.
<span class="nc bnc" id="L15911" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15912">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg,</span>
<span class="nc" id="L15913">                                                                   damage, target.getPosition());</span>
<span class="nc bnc" id="L15914" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15915">                        report.subject = ae.getId();</span>
<span class="nc" id="L15916">                    }</span>
<span class="nc" id="L15917">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L15921">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15925" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15926" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
<span class="nc" id="L15927">            damage += pr.damageRight;</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15929">            r = new Report(4040);</span>
<span class="nc" id="L15930">            r.subject = ae.getId();</span>
<span class="nc" id="L15931">            addReport(r);</span>
<span class="nc" id="L15932">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L15933">                                                           target.getPosition());</span>
<span class="nc bnc" id="L15934" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15935">                report.subject = ae.getId();</span>
<span class="nc" id="L15936">            }</span>
<span class="nc" id="L15937">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15940">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L15943">            return;</span>
        }

<span class="nc" id="L15946">        r = new Report(4040);</span>
<span class="nc" id="L15947">        r.subject = ae.getId();</span>
<span class="nc" id="L15948">        r.newlines = 0;</span>
<span class="nc" id="L15949">        addReport(r);</span>

<span class="nc bnc" id="L15951" title="All 2 branches missed.">        for (int leg = 0; leg &lt; 2; leg++) {</span>
<span class="nc bnc" id="L15952" title="All 2 branches missed.">            if (leg == 1) {</span>
<span class="nc" id="L15953">                damage = pr.damageRight;</span>
<span class="nc bnc" id="L15954" title="All 2 branches missed.">                if (damage == 0) {</span>
<span class="nc" id="L15955">                    break;</span>
                }
            }
<span class="nc" id="L15958">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15959">            hit.setGeneralDamageType(HitData.DAMAGE_ENERGY);</span>

            // The building shields all units from a certain amount of damage.
            // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15963" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15964">                int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15965">                int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15966">                damage -= toBldg;</span>
<span class="nc" id="L15967">                addNewLines();</span>
<span class="nc" id="L15968">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L15969">                                                               target.getPosition());</span>
<span class="nc bnc" id="L15970" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L15971">                    report.subject = ae.getId();</span>
<span class="nc" id="L15972">                }</span>
<span class="nc" id="L15973">                addReport(buildingReport);</span>

                // some buildings scale remaining damage that is not absorbed
                // TODO : this isn't quite right for castles brian
<span class="nc" id="L15977">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
            }

            // A building may absorb the entire shot.
<span class="nc bnc" id="L15981" title="All 2 branches missed.">            if (damage == 0) {</span>
<span class="nc" id="L15982">                r = new Report(4050);</span>
<span class="nc" id="L15983">                r.subject = ae.getId();</span>
<span class="nc" id="L15984">                r.add(te.getShortName());</span>
<span class="nc" id="L15985">                r.add(te.getOwner().getName());</span>
<span class="nc" id="L15986">                r.newlines = 0;</span>
<span class="nc" id="L15987">                addReport(r);</span>
            } else {
<span class="nc bnc" id="L15989" title="All 2 branches missed.">                if (glancing) {</span>
                    // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15991" title="All 2 branches missed.">                    damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
                }
<span class="nc bnc" id="L15993" title="All 2 branches missed.">                if (directBlow) {</span>
<span class="nc" id="L15994">                    damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15995">                    hit.makeDirectBlow(toHit.getMoS() / 3);</span>
                }
<span class="nc" id="L15997">                addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                                       false, false, throughFront));
            }
        }

<span class="nc" id="L16002">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L16006" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L16007">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L16009">    }</span>

    /**
     * Handle a ProtoMech physical attack
     */

    private void resolveProtoAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16016">        final ProtomechPhysicalAttackAction ppaa = (ProtomechPhysicalAttackAction) pr.aaa;</span>
<span class="nc" id="L16017">        final Entity ae = game.getEntity(ppaa.getEntityId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16019">        int damage = pr.damage;</span>
<span class="nc" id="L16020">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16021">        int roll = pr.roll;</span>
<span class="nc" id="L16022">        final Targetable target = game.getTarget(ppaa.getTargetType(), ppaa.getTargetId());</span>
<span class="nc" id="L16023">        Entity te = null;</span>
<span class="nc bnc" id="L16024" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16025">            te = (Entity) target;</span>
        }
<span class="nc" id="L16027">        boolean throughFront = true;</span>
<span class="nc bnc" id="L16028" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L16029">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc" id="L16031">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L16032" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16033" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>
        // Set Margin of Success/Failure.
<span class="nc" id="L16035">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16036" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16037" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L16042">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L16044" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L16046">            r = new Report(4005);</span>
<span class="nc" id="L16047">            r.subject = ae.getId();</span>
<span class="nc" id="L16048">            r.addDesc(ae);</span>
<span class="nc" id="L16049">            addReport(r);</span>
        }

<span class="nc" id="L16052">        r = new Report(4070);</span>
<span class="nc" id="L16053">        r.subject = ae.getId();</span>
<span class="nc" id="L16054">        r.indent();</span>
<span class="nc" id="L16055">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16056">        r.newlines = 0;</span>
<span class="nc" id="L16057">        addReport(r);</span>

<span class="nc bnc" id="L16059" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16060">            r = new Report(4075);</span>
<span class="nc" id="L16061">            r.subject = ae.getId();</span>
<span class="nc" id="L16062">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16063">            addReport(r);</span>
<span class="nc" id="L16064">            return;</span>
<span class="nc bnc" id="L16065" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16066">            r = new Report(4080);</span>
<span class="nc" id="L16067">            r.subject = ae.getId();</span>
<span class="nc" id="L16068">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16069">            r.newlines = 0;</span>
<span class="nc" id="L16070">            addReport(r);</span>
<span class="nc" id="L16071">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L16074">            r = new Report(4025);</span>
<span class="nc" id="L16075">            r.subject = ae.getId();</span>
<span class="nc" id="L16076">            r.add(toHit);</span>
<span class="nc" id="L16077">            r.add(roll);</span>
<span class="nc" id="L16078">            r.newlines = 0;</span>
<span class="nc" id="L16079">            addReport(r);</span>
<span class="nc bnc" id="L16080" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L16081">                r = new Report(3186);</span>
<span class="nc" id="L16082">                r.subject = ae.getId();</span>
<span class="nc" id="L16083">                r.newlines = 0;</span>
<span class="nc" id="L16084">                addReport(r);</span>
            }
<span class="nc bnc" id="L16086" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16087">                r = new Report(3189);</span>
<span class="nc" id="L16088">                r.subject = ae.getId();</span>
<span class="nc" id="L16089">                r.newlines = 0;</span>
<span class="nc" id="L16090">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L16096" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16098">            r = new Report(4035);</span>
<span class="nc" id="L16099">            r.subject = ae.getId();</span>
<span class="nc" id="L16100">            addReport(r);</span>

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L16103" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L16106" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L16107">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16108" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L16109">                        report.subject = ae.getId();</span>
<span class="nc" id="L16110">                    }</span>
<span class="nc" id="L16111">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L16115">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L16119" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L16120" title="All 2 branches missed.">                || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L16122">            r = new Report(4040);</span>
<span class="nc" id="L16123">            r.subject = ae.getId();</span>
<span class="nc" id="L16124">            addReport(r);</span>
<span class="nc" id="L16125">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16126" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16127">                report.subject = ae.getId();</span>
<span class="nc" id="L16128">            }</span>
<span class="nc" id="L16129">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L16132">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L16135">            return;</span>
        }

<span class="nc" id="L16138">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16139">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>

<span class="nc" id="L16141">        r = new Report(4045);</span>
<span class="nc" id="L16142">        r.subject = ae.getId();</span>
<span class="nc" id="L16143">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16144">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16145">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16149" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16150">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16151">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16152">            damage -= toBldg;</span>
<span class="nc" id="L16153">            addNewLines();</span>
<span class="nc" id="L16154">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L16155">                                                           target.getPosition());</span>
<span class="nc bnc" id="L16156" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16157">                report.subject = ae.getId();</span>
<span class="nc" id="L16158">            }</span>
<span class="nc" id="L16159">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L16163">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L16167" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L16168">            r = new Report(4050);</span>
<span class="nc" id="L16169">            r.subject = ae.getId();</span>
<span class="nc" id="L16170">            r.add(te.getShortName());</span>
<span class="nc" id="L16171">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L16172">            r.newlines = 0;</span>
<span class="nc" id="L16173">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L16175" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L16177" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L16179" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16180">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L16181">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }
<span class="nc" id="L16183">            addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc bnc" id="L16185" title="All 2 branches missed.">            if (((Protomech) ae).isEDPCharged()) {</span>
<span class="nc" id="L16186">                r = new Report(3701);</span>
<span class="nc" id="L16187">                int taserRoll = Compute.d6(2) - 2;</span>
<span class="nc" id="L16188">                r.add(taserRoll);</span>
<span class="nc" id="L16189">                r.newlines = 0;</span>
<span class="nc" id="L16190">                vPhaseReport.add(r);</span>

<span class="nc bnc" id="L16192" title="All 2 branches missed.">                if (te instanceof BattleArmor) {</span>
<span class="nc" id="L16193">                    r = new Report(3706);</span>
<span class="nc" id="L16194">                    r.addDesc(te);</span>
                    // shut down for rest of scenario, so we actually kill it
                    // TODO : fix for salvage purposes
<span class="nc" id="L16197">                    HitData targetTrooper = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16198">                    r.add(te.getLocationAbbr(targetTrooper));</span>
<span class="nc" id="L16199">                    vPhaseReport.add(r);</span>
<span class="nc" id="L16200">                    vPhaseReport.addAll(criticalEntity(ae, targetTrooper.getLocation(),</span>
<span class="nc" id="L16201">                            targetTrooper.isRear(), 0, false, false, 0));</span>
<span class="nc bnc" id="L16202" title="All 2 branches missed.">                } else if (te instanceof Mech) {</span>
<span class="nc bnc" id="L16203" title="All 2 branches missed.">                    if (((Mech) te).isIndustrial()) {</span>
<span class="nc bnc" id="L16204" title="All 2 branches missed.">                        if (taserRoll &gt;= 8) {</span>
<span class="nc" id="L16205">                            r = new Report(3705);</span>
<span class="nc" id="L16206">                            r.addDesc(te);</span>
<span class="nc" id="L16207">                            r.add(4);</span>
<span class="nc" id="L16208">                            te.taserShutdown(4, false);</span>
                        } else {
                            // suffer +2 to piloting and gunnery for 4 rounds
<span class="nc" id="L16211">                            r = new Report(3710);</span>
<span class="nc" id="L16212">                            r.addDesc(te);</span>
<span class="nc" id="L16213">                            r.add(2);</span>
<span class="nc" id="L16214">                            r.add(4);</span>
<span class="nc" id="L16215">                            te.setTaserInterference(2, 4, true);</span>
                        }
                    } else {
<span class="nc bnc" id="L16218" title="All 2 branches missed.">                        if (taserRoll &gt;= 11) {</span>
<span class="nc" id="L16219">                            r = new Report(3705);</span>
<span class="nc" id="L16220">                            r.addDesc(te);</span>
<span class="nc" id="L16221">                            r.add(3);</span>
<span class="nc" id="L16222">                            vPhaseReport.add(r);</span>
<span class="nc" id="L16223">                            te.taserShutdown(3, false);</span>
                        } else {
<span class="nc" id="L16225">                            r = new Report(3710);</span>
<span class="nc" id="L16226">                            r.addDesc(te);</span>
<span class="nc" id="L16227">                            r.add(2);</span>
<span class="nc" id="L16228">                            r.add(3);</span>
<span class="nc" id="L16229">                            vPhaseReport.add(r);</span>
<span class="nc" id="L16230">                            te.setTaserInterference(2, 3, true);</span>
                        }
                    }
<span class="nc bnc" id="L16233" title="All 6 branches missed.">                } else if ((te instanceof Protomech) || (te instanceof Tank)</span>
                           || (te instanceof Aero)) {
<span class="nc bnc" id="L16235" title="All 2 branches missed.">                    if (taserRoll &gt;= 8) {</span>
<span class="nc" id="L16236">                        r = new Report(3705);</span>
<span class="nc" id="L16237">                        r.addDesc(te);</span>
<span class="nc" id="L16238">                        r.add(4);</span>
<span class="nc" id="L16239">                        vPhaseReport.add(r);</span>
<span class="nc" id="L16240">                        te.taserShutdown(4, false);</span>
                    } else {
<span class="nc" id="L16242">                        r = new Report(3710);</span>
<span class="nc" id="L16243">                        r.addDesc(te);</span>
<span class="nc" id="L16244">                        r.add(2);</span>
<span class="nc" id="L16245">                        r.add(4);</span>
<span class="nc" id="L16246">                        vPhaseReport.add(r);</span>
<span class="nc" id="L16247">                        te.setTaserInterference(2, 4, false);</span>
                    }
                }

            }
        }

<span class="nc" id="L16254">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L16258" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L16259">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L16261">    }</span>

    /**
     * Handle a brush off attack
     */
    private void resolveBrushOffAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16267">        final BrushOffAttackAction baa = (BrushOffAttackAction) pr.aaa;</span>
<span class="nc" id="L16268">        final Entity ae = game.getEntity(baa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target
        // of a &quot;brush off&quot;, but iNarc pods **are**.
<span class="nc" id="L16271">        Targetable target = game.getTarget(baa.getTargetType(), baa.getTargetId());</span>
<span class="nc" id="L16272">        Entity te = null;</span>
<span class="nc bnc" id="L16273" title="All 2 branches missed.">        final String armName = baa.getArm() == BrushOffAttackAction.LEFT ? &quot;Left Arm&quot; : &quot;Right Arm&quot;;</span>
        Report r;

<span class="nc bnc" id="L16276" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16277">            te = game.getEntity(baa.getTargetId());</span>
        }

        // get damage, ToHitData and roll from the PhysicalResult
        // ASSUMPTION: buildings can't absorb *this* damage.
<span class="nc bnc" id="L16282" title="All 2 branches missed.">        int damage = baa.getArm() == BrushOffAttackAction.LEFT ? pr.damage : pr.damageRight;</span>
<span class="nc bnc" id="L16283" title="All 2 branches missed.">        final ToHitData toHit = baa.getArm() == BrushOffAttackAction.LEFT ? pr.toHit : pr.toHitRight;</span>
<span class="nc bnc" id="L16284" title="All 2 branches missed.">        int roll = baa.getArm() == BrushOffAttackAction.LEFT ? pr.roll : pr.rollRight;</span>

<span class="nc bnc" id="L16286" title="All 2 branches missed.">        if (lastEntityId != baa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16288">            r = new Report(4005);</span>
<span class="nc" id="L16289">            r.subject = ae.getId();</span>
<span class="nc" id="L16290">            r.addDesc(ae);</span>
<span class="nc" id="L16291">            addReport(r);</span>
        }

<span class="nc" id="L16294">        r = new Report(4085);</span>
<span class="nc" id="L16295">        r.subject = ae.getId();</span>
<span class="nc" id="L16296">        r.indent();</span>
<span class="nc" id="L16297">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16298">        r.add(armName);</span>
<span class="nc" id="L16299">        r.newlines = 0;</span>
<span class="nc" id="L16300">        addReport(r);</span>

<span class="nc bnc" id="L16302" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16303">            r = new Report(4090);</span>
<span class="nc" id="L16304">            r.subject = ae.getId();</span>
<span class="nc" id="L16305">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16306">            addReport(r);</span>
<span class="nc" id="L16307">            return;</span>
        }

        // report the roll
<span class="nc" id="L16311">        r = new Report(4025);</span>
<span class="nc" id="L16312">        r.subject = ae.getId();</span>
<span class="nc" id="L16313">        r.add(toHit);</span>
<span class="nc" id="L16314">        r.add(roll);</span>
<span class="nc" id="L16315">        r.newlines = 0;</span>
<span class="nc" id="L16316">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L16319" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16321">            r = new Report(4035);</span>
<span class="nc" id="L16322">            r.subject = ae.getId();</span>
<span class="nc" id="L16323">            addReport(r);</span>

            // Missed Brush Off attacks cause punch damage to the attacker.
<span class="nc" id="L16326">            toHit.setHitTable(ToHitData.HIT_PUNCH);</span>
<span class="nc" id="L16327">            toHit.setSideTable(ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16328">            HitData hit = ae.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16329">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16330">            r = new Report(4095);</span>
<span class="nc" id="L16331">            r.subject = ae.getId();</span>
<span class="nc" id="L16332">            r.addDesc(ae);</span>
<span class="nc" id="L16333">            r.add(ae.getLocationAbbr(hit));</span>
<span class="nc" id="L16334">            r.newlines = 0;</span>
<span class="nc" id="L16335">            addReport(r);</span>
<span class="nc" id="L16336">            addReport(damageEntity(ae, hit, damage));</span>
<span class="nc" id="L16337">            addNewLines();</span>
            // if this is an industrial mech, it needs to check for crits
            // at the end of turn
<span class="nc bnc" id="L16340" title="All 4 branches missed.">            if ((ae instanceof Mech) &amp;&amp; ((Mech) ae).isIndustrial()) {</span>
<span class="nc" id="L16341">                ((Mech) ae).setCheckForCrit(true);</span>
            }
<span class="nc" id="L16343">            return;</span>
        }

        // Different target types get different handling.
<span class="nc bnc" id="L16347" title="All 3 branches missed.">        switch (target.getTargetType()) {</span>
            case Targetable.TYPE_ENTITY:
                // Handle Entity targets.
<span class="nc" id="L16350">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16351">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16352">                r = new Report(4045);</span>
<span class="nc" id="L16353">                r.subject = ae.getId();</span>
<span class="nc" id="L16354">                r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16355">                r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16356">                addReport(r);</span>
<span class="nc" id="L16357">                addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16358">                addNewLines();</span>

                // Dislodge the swarming infantry.
<span class="nc" id="L16361">                ae.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L16362">                te.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L16363">                r = new Report(4100);</span>
<span class="nc" id="L16364">                r.subject = ae.getId();</span>
<span class="nc" id="L16365">                r.add(te.getDisplayName());</span>
<span class="nc" id="L16366">                addReport(r);</span>
<span class="nc" id="L16367">                break;</span>
            case Targetable.TYPE_INARC_POD:
                // Handle iNarc pod targets.
                // TODO : check the return code and handle false appropriately.
<span class="nc" id="L16371">                ae.removeINarcPod((INarcPod) target);</span>
                // // TODO : confirm that we don't need to update the attacker.
                // //killme
                // entityUpdate( ae.getId() ); // killme
<span class="nc" id="L16375">                r = new Report(4105);</span>
<span class="nc" id="L16376">                r.subject = ae.getId();</span>
<span class="nc" id="L16377">                r.add(target.getDisplayName());</span>
<span class="nc" id="L16378">                addReport(r);</span>
                break;
            // TODO : add a default: case and handle it appropriately.
        }
<span class="nc" id="L16382">    }</span>

    /**
     * Handle a thrash attack
     */
    private void resolveThrashAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16388">        final ThrashAttackAction taa = (ThrashAttackAction) pr.aaa;</span>
<span class="nc" id="L16389">        final Entity ae = game.getEntity(taa.getEntityId());</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16392">        int hits = pr.damage;</span>
<span class="nc" id="L16393">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16394">        int roll = pr.roll;</span>
<span class="nc bnc" id="L16395" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS)
<span class="nc bnc" id="L16397" title="All 2 branches missed.">                                 &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L16400">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16401" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)
<span class="nc bnc" id="L16403" title="All 2 branches missed.">                                   &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // PLEASE NOTE: buildings are *never* the target of a &quot;thrash&quot;.
<span class="nc" id="L16406">        final Entity te = game.getEntity(taa.getTargetId());</span>
        Report r;

<span class="nc bnc" id="L16409" title="All 2 branches missed.">        if (lastEntityId != taa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16411">            r = new Report(4005);</span>
<span class="nc" id="L16412">            r.subject = ae.getId();</span>
<span class="nc" id="L16413">            r.addDesc(ae);</span>
<span class="nc" id="L16414">            addReport(r);</span>
        }

<span class="nc" id="L16417">        r = new Report(4110);</span>
<span class="nc" id="L16418">        r.subject = ae.getId();</span>
<span class="nc" id="L16419">        r.indent();</span>
<span class="nc" id="L16420">        r.addDesc(te);</span>
<span class="nc" id="L16421">        r.newlines = 0;</span>
<span class="nc" id="L16422">        addReport(r);</span>

<span class="nc bnc" id="L16424" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16425">            r = new Report(4115);</span>
<span class="nc" id="L16426">            r.subject = ae.getId();</span>
<span class="nc" id="L16427">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16428">            addReport(r);</span>
<span class="nc" id="L16429">            return;</span>
        }

        // Thrash attack may hit automatically
<span class="nc bnc" id="L16433" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16434">            r = new Report(4120);</span>
        } else {
            // report the roll
<span class="nc" id="L16437">            r = new Report(4025);</span>
<span class="nc" id="L16438">            r.subject = ae.getId();</span>
<span class="nc" id="L16439">            r.add(toHit);</span>
<span class="nc" id="L16440">            r.add(roll);</span>
<span class="nc" id="L16441">            r.newlines = 0;</span>
<span class="nc" id="L16442">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L16445" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L16447">                r = new Report(4035);</span>
<span class="nc" id="L16448">                r.subject = ae.getId();</span>
<span class="nc" id="L16449">                addReport(r);</span>
<span class="nc" id="L16450">                return;</span>
            }
<span class="nc" id="L16452">            r = new Report(4125);</span>
        }
<span class="nc" id="L16454">        r.subject = ae.getId();</span>
<span class="nc" id="L16455">        r.newlines = 0;</span>
<span class="nc" id="L16456">        addReport(r);</span>

        // Standard damage loop in 5 point clusters.
<span class="nc bnc" id="L16459" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16460">            hits = (int) Math.floor(hits / 2.0);</span>
        }
<span class="nc bnc" id="L16462" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16463">            hits += toHit.getMoS() / 3;</span>
        }

<span class="nc" id="L16466">        r = new Report(4130);</span>
<span class="nc" id="L16467">        r.subject = ae.getId();</span>
<span class="nc" id="L16468">        r.add(hits);</span>
<span class="nc" id="L16469">        r.newlines = 0;</span>
<span class="nc" id="L16470">        addReport(r);</span>
<span class="nc bnc" id="L16471" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16472">            r = new Report(3186);</span>
<span class="nc" id="L16473">            r.subject = ae.getId();</span>
<span class="nc" id="L16474">            r.newlines = 0;</span>
<span class="nc" id="L16475">            addReport(r);</span>
        }
<span class="nc bnc" id="L16477" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16478">            r = new Report(3189);</span>
<span class="nc" id="L16479">            r.subject = ae.getId();</span>
<span class="nc" id="L16480">            r.newlines = 0;</span>
<span class="nc" id="L16481">            addReport(r);</span>
        }

<span class="nc bnc" id="L16484" title="All 2 branches missed.">        while (hits &gt; 0) {</span>
<span class="nc" id="L16485">            int damage = Math.min(5, hits);</span>
<span class="nc" id="L16486">            hits -= damage;</span>
<span class="nc" id="L16487">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16488">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16489">            r = new Report(4135);</span>
<span class="nc" id="L16490">            r.subject = ae.getId();</span>
<span class="nc" id="L16491">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16492">            r.newlines = 0;</span>
<span class="nc" id="L16493">            addReport(r);</span>
<span class="nc" id="L16494">            addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16495">        }</span>

<span class="nc" id="L16497">        addNewLines();</span>

        // Thrash attacks cause PSRs. Failed PSRs cause falling damage.
        // This fall damage applies even though the Thrashing Mek is prone.
<span class="nc" id="L16501">        PilotingRollData rollData = ae.getBasePilotingRoll();</span>
<span class="nc" id="L16502">        ae.addPilotingModifierForTerrain(rollData);</span>
<span class="nc" id="L16503">        rollData.addModifier(0, &quot;thrashing at infantry&quot;);</span>
<span class="nc" id="L16504">        r = new Report(4140);</span>
<span class="nc" id="L16505">        r.subject = ae.getId();</span>
<span class="nc" id="L16506">        r.addDesc(ae);</span>
<span class="nc" id="L16507">        addReport(r);</span>
<span class="nc" id="L16508">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L16509">        r = new Report(2190);</span>
<span class="nc" id="L16510">        r.subject = ae.getId();</span>
<span class="nc" id="L16511">        r.add(rollData.getValueAsString());</span>
<span class="nc" id="L16512">        r.add(rollData.getDesc());</span>
<span class="nc" id="L16513">        r.add(diceRoll);</span>
<span class="nc bnc" id="L16514" title="All 2 branches missed.">        if (diceRoll &lt; rollData.getValue()) {</span>
<span class="nc" id="L16515">            r.choose(false);</span>
<span class="nc" id="L16516">            addReport(r);</span>
<span class="nc" id="L16517">            addReport(doEntityFall(ae, rollData));</span>
        } else {
<span class="nc" id="L16519">            r.choose(true);</span>
<span class="nc" id="L16520">            addReport(r);</span>
        }
<span class="nc" id="L16522">    }</span>

    /**
     * Handle a thrash attack
     */
    private void resolveBAVibroClawAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16528">        final BAVibroClawAttackAction bvaa = (BAVibroClawAttackAction) pr.aaa;</span>
<span class="nc" id="L16529">        final Entity ae = game.getEntity(bvaa.getEntityId());</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16532">        int hits = pr.damage;</span>
<span class="nc" id="L16533">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16534">        int roll = pr.roll;</span>
<span class="nc bnc" id="L16535" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS)
<span class="nc bnc" id="L16537" title="All 2 branches missed.">                                 &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L16540">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16541" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)
<span class="nc bnc" id="L16543" title="All 2 branches missed.">                                   &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // PLEASE NOTE: buildings are *never* the target of a BA vibroclaw
        // attack.
<span class="nc" id="L16547">        final Entity te = game.getEntity(bvaa.getTargetId());</span>
        Report r;

<span class="nc bnc" id="L16550" title="All 2 branches missed.">        if (lastEntityId != bvaa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16552">            r = new Report(4005);</span>
<span class="nc" id="L16553">            r.subject = ae.getId();</span>
<span class="nc" id="L16554">            r.addDesc(ae);</span>
<span class="nc" id="L16555">            addReport(r);</span>
        }

<span class="nc" id="L16558">        r = new Report(4146);</span>
<span class="nc" id="L16559">        r.subject = ae.getId();</span>
<span class="nc" id="L16560">        r.indent();</span>
<span class="nc" id="L16561">        r.addDesc(te);</span>
<span class="nc" id="L16562">        r.newlines = 0;</span>
<span class="nc" id="L16563">        addReport(r);</span>

<span class="nc bnc" id="L16565" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16566">            r = new Report(4147);</span>
<span class="nc" id="L16567">            r.subject = ae.getId();</span>
<span class="nc" id="L16568">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16569">            addReport(r);</span>
<span class="nc" id="L16570">            return;</span>
        }

        // we may hit automatically
<span class="nc bnc" id="L16574" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16575">            r = new Report(4120);</span>
<span class="nc" id="L16576">            r.subject = ae.getId();</span>
<span class="nc" id="L16577">            r.newlines = 0;</span>
<span class="nc" id="L16578">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L16581">            r = new Report(4025);</span>
<span class="nc" id="L16582">            r.subject = ae.getId();</span>
<span class="nc" id="L16583">            r.add(toHit);</span>
<span class="nc" id="L16584">            r.add(roll);</span>
<span class="nc" id="L16585">            r.newlines = 0;</span>
<span class="nc" id="L16586">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L16589" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L16591">                r = new Report(4035);</span>
<span class="nc" id="L16592">                r.subject = ae.getId();</span>
<span class="nc" id="L16593">                addReport(r);</span>
<span class="nc" id="L16594">                return;</span>
            }
        }

        // Standard damage loop
<span class="nc bnc" id="L16599" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16600">            hits = (int) Math.floor(hits / 2.0);</span>
        }
<span class="nc bnc" id="L16602" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16603">            hits += toHit.getMoS() / 3;</span>
        }
<span class="nc bnc" id="L16605" title="All 2 branches missed.">        if (te.isConventionalInfantry()) {</span>
<span class="nc" id="L16606">            r = new Report(4149);</span>
<span class="nc" id="L16607">            r.subject = ae.getId();</span>
<span class="nc" id="L16608">            r.add(hits);</span>
        } else {
<span class="nc" id="L16610">            r = new Report(4148);</span>
<span class="nc" id="L16611">            r.subject = ae.getId();</span>
<span class="nc" id="L16612">            r.add(hits);</span>
<span class="nc" id="L16613">            r.add(ae.getVibroClaws());</span>
        }
<span class="nc" id="L16615">        r.newlines = 0;</span>
<span class="nc" id="L16616">        addReport(r);</span>
<span class="nc bnc" id="L16617" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16618">            r = new Report(3186);</span>
<span class="nc" id="L16619">            r.subject = ae.getId();</span>
<span class="nc" id="L16620">            r.newlines = 0;</span>
<span class="nc" id="L16621">            addReport(r);</span>
        }
<span class="nc bnc" id="L16623" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16624">            r = new Report(3189);</span>
<span class="nc" id="L16625">            r.subject = ae.getId();</span>
<span class="nc" id="L16626">            r.newlines = 0;</span>
<span class="nc" id="L16627">            addReport(r);</span>
        }
<span class="nc bnc" id="L16629" title="All 2 branches missed.">        while (hits &gt; 0) {</span>
            // BA get hit separately by each attacking BA trooper
<span class="nc" id="L16631">            int damage = Math.min(ae.getVibroClaws(), hits);</span>
            // conventional infantry get hit in one lump
<span class="nc bnc" id="L16633" title="All 2 branches missed.">            if (te.isConventionalInfantry()) {</span>
<span class="nc" id="L16634">                damage = hits;</span>
            }
<span class="nc" id="L16636">            hits -= damage;</span>
<span class="nc" id="L16637">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16638">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16639">            r = new Report(4135);</span>
<span class="nc" id="L16640">            r.subject = ae.getId();</span>
<span class="nc" id="L16641">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16642">            r.newlines = 0;</span>
<span class="nc" id="L16643">            addReport(r);</span>
<span class="nc" id="L16644">            addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16645">        }</span>
<span class="nc" id="L16646">        addNewLines();</span>
<span class="nc" id="L16647">    }</span>

    /**
     * Handle a club attack
     */
    private void resolveClubAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16653">        final ClubAttackAction caa = (ClubAttackAction) pr.aaa;</span>
<span class="nc" id="L16654">        final Entity ae = game.getEntity(caa.getEntityId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16656">        int damage = pr.damage;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L16658" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16659">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc" id="L16661">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16662">        int roll = pr.roll;</span>
<span class="nc" id="L16663">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
<span class="nc" id="L16664">        Entity te = null;</span>
<span class="nc bnc" id="L16665" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16666">            te = (Entity) target;</span>
        }
<span class="nc" id="L16668">        boolean throughFront = true;</span>
<span class="nc bnc" id="L16669" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L16670">            throughFront = Compute</span>
<span class="nc" id="L16671">                    .isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc" id="L16673">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L16674" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16675" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
        // Make sure the MoS is zero for *automatic* hits in case direct blows
        // are in force.
<span class="nc bnc" id="L16680" title="All 2 branches missed.">        toHit.setMoS((roll == Integer.MAX_VALUE) ? 0 : roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16681" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16682" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;


        // Which building takes the damage?
<span class="nc" id="L16688">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

        // restore club attack
<span class="nc" id="L16691">        caa.getClub().restore();</span>

        // Shield bash causes 1 point of damage to the shield
<span class="nc bnc" id="L16694" title="All 2 branches missed.">        if (((MiscType) caa.getClub().getType()).isShield()) {</span>
<span class="nc" id="L16695">            ((Mech) ae).shieldAbsorptionDamage(1, caa.getClub().getLocation(), false);</span>
        }

<span class="nc bnc" id="L16698" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16700">            r = new Report(4005);</span>
<span class="nc" id="L16701">            r.subject = ae.getId();</span>
<span class="nc" id="L16702">            r.addDesc(ae);</span>
<span class="nc" id="L16703">            addReport(r);</span>
        }

<span class="nc" id="L16706">        r = new Report(4145);</span>
<span class="nc" id="L16707">        r.subject = ae.getId();</span>
<span class="nc" id="L16708">        r.indent();</span>
<span class="nc" id="L16709">        r.add(caa.getClub().getName());</span>
<span class="nc" id="L16710">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16711">        r.newlines = 0;</span>
<span class="nc" id="L16712">        addReport(r);</span>

        // Flail/Wrecking Ball auto misses on a 2 and hits themself.
<span class="nc bnc" id="L16715" title="All 2 branches missed.">        if ((caa.getClub().getType().hasSubType(MiscType.S_FLAIL)</span>
<span class="nc bnc" id="L16716" title="All 4 branches missed.">                || caa.getClub().getType().hasSubType(MiscType.S_WRECKING_BALL))</span>
            &amp;&amp; (roll == 2)) {
            // miss
<span class="nc" id="L16719">            r = new Report(4035);</span>
<span class="nc" id="L16720">            r.subject = ae.getId();</span>
<span class="nc" id="L16721">            addReport(r);</span>
<span class="nc" id="L16722">            ToHitData newToHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS,</span>
                                               &quot;hit with own flail/wrecking ball&quot;);
<span class="nc" id="L16724">            pr.damage = ClubAttackAction.getDamageFor(ae, caa.getClub(), false, caa.isZweihandering());</span>
<span class="nc" id="L16725">            pr.damage = (pr.damage / 2) + (pr.damage % 2);</span>
<span class="nc" id="L16726">            newToHit.setHitTable(ToHitData.HIT_NORMAL);</span>
<span class="nc" id="L16727">            newToHit.setSideTable(ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16728">            pr.toHit = newToHit;</span>
<span class="nc" id="L16729">            pr.aaa.setTargetId(ae.getId());</span>
<span class="nc" id="L16730">            pr.aaa.setTargetType(Targetable.TYPE_ENTITY);</span>
<span class="nc" id="L16731">            pr.roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L16732">            resolveClubAttack(pr, ae.getId());</span>
<span class="nc bnc" id="L16733" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16734">                game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                        &quot;missed a flail/wrecking ball attack&quot;));
            } else {
<span class="nc" id="L16737">                game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                                                 &quot;missed a flail/wrecking ball attack&quot;));
            }
<span class="nc bnc" id="L16740" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16741">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16742">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16743">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16745">            return;</span>
        }

        // Need to compute 2d6 damage. and add +3 heat build up.
<span class="nc bnc" id="L16749" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_BUZZSAW)) {</span>
<span class="nc" id="L16750">            damage = Compute.d6(2);</span>
<span class="nc" id="L16751">            ae.heatBuildup += 3;</span>

            // Buzzsaw's blade will shatter on a roll of 2.
<span class="nc bnc" id="L16754" title="All 2 branches missed.">            if (roll == 2) {</span>

<span class="nc" id="L16756">                Mounted club = caa.getClub();</span>

<span class="nc bnc" id="L16758" title="All 2 branches missed.">                for (Mounted eq : ae.getWeaponList()) {</span>
<span class="nc bnc" id="L16759" title="All 2 branches missed.">                    if ((eq.getLocation() == club.getLocation())</span>
<span class="nc bnc" id="L16760" title="All 2 branches missed.">                        &amp;&amp; (eq.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L16761" title="All 2 branches missed.">                        &amp;&amp; eq.getType().hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L16762" title="All 2 branches missed.">                        &amp;&amp; eq.getType().hasSubType(MiscType.S_BUZZSAW)) {</span>
<span class="nc" id="L16763">                        eq.setHit(true);</span>
<span class="nc" id="L16764">                        break;</span>
                    }
<span class="nc" id="L16766">                }</span>
<span class="nc" id="L16767">                r = new Report(4037);</span>
<span class="nc" id="L16768">                r.subject = ae.getId();</span>
<span class="nc" id="L16769">                addReport(r);</span>
<span class="nc bnc" id="L16770" title="All 2 branches missed.">                if(caa.isZweihandering()) {</span>
<span class="nc" id="L16771">                    ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16772">                    criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16773">                    applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
                }
<span class="nc" id="L16775">                return;</span>
            }
        }

<span class="nc bnc" id="L16779" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16780">            r = new Report(4075);</span>
<span class="nc" id="L16781">            r.subject = ae.getId();</span>
<span class="nc" id="L16782">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16783">            addReport(r);</span>
<span class="nc bnc" id="L16784" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE_THB)) {</span>
<span class="nc bnc" id="L16785" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16786">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16789">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16793" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE)) {</span>
<span class="nc bnc" id="L16794" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16795">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16798">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16802" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16803">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16804">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16805">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16807">            return;</span>
<span class="nc bnc" id="L16808" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16809">            r = new Report(4080);</span>
<span class="nc" id="L16810">            r.subject = ae.getId();</span>
<span class="nc" id="L16811">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16812">            r.newlines = 0;</span>
<span class="nc" id="L16813">            addReport(r);</span>
<span class="nc" id="L16814">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L16817">            r = new Report(4025);</span>
<span class="nc" id="L16818">            r.subject = ae.getId();</span>
<span class="nc" id="L16819">            r.add(toHit);</span>
<span class="nc" id="L16820">            r.add(roll);</span>
<span class="nc" id="L16821">            r.newlines = 0;</span>
<span class="nc" id="L16822">            addReport(r);</span>
<span class="nc bnc" id="L16823" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L16824">                r = new Report(3186);</span>
<span class="nc" id="L16825">                r.subject = ae.getId();</span>
<span class="nc" id="L16826">                r.newlines = 0;</span>
<span class="nc" id="L16827">                addReport(r);</span>
            }
<span class="nc bnc" id="L16829" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16830">                r = new Report(3189);</span>
<span class="nc" id="L16831">                r.subject = ae.getId();</span>
<span class="nc" id="L16832">                r.newlines = 0;</span>
<span class="nc" id="L16833">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L16839" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16841">            r = new Report(4035);</span>
<span class="nc" id="L16842">            r.subject = ae.getId();</span>
<span class="nc" id="L16843">            addReport(r);</span>
<span class="nc bnc" id="L16844" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE_THB)) {</span>
<span class="nc bnc" id="L16845" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16846">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16849">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16853" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE)) {</span>
<span class="nc bnc" id="L16854" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16855">                    game.addControlRoll(new PilotingRollData(ae.getId(), 2,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16858">                    game.addPSR(new PilotingRollData(ae.getId(), 2,</span>
                            &quot;missed a mace attack&quot;));
                }
            }

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L16864" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L16867" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L16868">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg,</span>
<span class="nc" id="L16869">                                                                   damage, target.getPosition());</span>
<span class="nc bnc" id="L16870" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L16871">                        report.subject = ae.getId();</span>
<span class="nc" id="L16872">                    }</span>
<span class="nc" id="L16873">                    addReport(buildingReport);</span>
                }

            }
<span class="nc bnc" id="L16877" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16878">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16879">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16880">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16882">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L16886" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L16887" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L16889">            r = new Report(4040);</span>
<span class="nc" id="L16890">            r.subject = ae.getId();</span>
<span class="nc" id="L16891">            addReport(r);</span>
<span class="nc" id="L16892">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16893" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16894">                report.subject = ae.getId();</span>
<span class="nc" id="L16895">            }</span>
<span class="nc" id="L16896">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L16899">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

<span class="nc bnc" id="L16901" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16902">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16903">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16904">                applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
<span class="nc bnc" id="L16905" title="All 2 branches missed.">                if (caa.getClub().getType().hasSubType(MiscType.S_CLUB)) {</span>
                    // the club breaks
<span class="nc" id="L16907">                    r = new Report(4150);</span>
<span class="nc" id="L16908">                    r.subject = ae.getId();</span>
<span class="nc" id="L16909">                    r.add(caa.getClub().getName());</span>
<span class="nc" id="L16910">                    addReport(r);</span>
<span class="nc" id="L16911">                    ae.removeMisc(caa.getClub().getName());</span>
                }
            }
            // And we're done!
<span class="nc" id="L16915">            return;</span>
        }

<span class="nc" id="L16918">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16919">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16920">        r = new Report(4045);</span>
<span class="nc" id="L16921">        r.subject = ae.getId();</span>
<span class="nc" id="L16922">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16923">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16924">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16928" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16929">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16930">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16931">            damage -= toBldg;</span>
<span class="nc" id="L16932">            addNewLines();</span>
<span class="nc" id="L16933">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16934" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16935">                report.subject = ae.getId();</span>
<span class="nc" id="L16936">            }</span>
<span class="nc" id="L16937">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L16941">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L16945" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L16946">            r = new Report(4050);</span>
<span class="nc" id="L16947">            r.subject = ae.getId();</span>
<span class="nc" id="L16948">            r.add(te.getShortName());</span>
<span class="nc" id="L16949">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L16950">            r.newlines = 0;</span>
<span class="nc" id="L16951">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L16953" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L16955" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L16957" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16958">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L16959">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

<span class="nc" id="L16962">            damage = checkForSpikes(te, hit.getLocation(), damage, ae, Entity.LOC_NONE);</span>

<span class="nc" id="L16964">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L16965">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                                   false, throughFront));
<span class="nc bnc" id="L16967" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L16969">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM, VTOL.CRIT_ROTOR_DESTROYED),
                        false, 0, false));
            }
        }

        // On a roll of 10+ a lance hitting a mech/Vehicle can cause 1 point of
        // internal damage
<span class="nc bnc" id="L16977" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_LANCE)</span>
<span class="nc bnc" id="L16978" title="All 2 branches missed.">            &amp;&amp; (te.getArmor(hit) &gt; 0)</span>
<span class="nc bnc" id="L16979" title="All 2 branches missed.">            &amp;&amp; (te.getArmorType(hit.getLocation()) != EquipmentType.T_ARMOR_HARDENED)</span>
<span class="nc bnc" id="L16980" title="All 2 branches missed.">            &amp;&amp; (te.getArmorType(hit.getLocation()) != EquipmentType.T_ARMOR_FERRO_LAMELLOR)) {</span>
<span class="nc" id="L16981">            roll = Compute.d6(2);</span>
            // Pierce checking report
<span class="nc" id="L16983">            r = new Report(4021);</span>
<span class="nc" id="L16984">            r.indent(2);</span>
<span class="nc" id="L16985">            r.subject = ae.getId();</span>
<span class="nc" id="L16986">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16987">            r.add(roll);</span>
<span class="nc" id="L16988">            addReport(r);</span>
<span class="nc bnc" id="L16989" title="All 2 branches missed.">            if (roll &gt;= 10) {</span>
<span class="nc" id="L16990">                hit.makeGlancingBlow();</span>
<span class="nc" id="L16991">                addReport(damageEntity(te, hit, 1, false, DamageType.NONE,</span>
                                       true, false, throughFront));
            }
        }

        // TODO : Verify this is correct according to latest rules
<span class="nc bnc" id="L16997" title="All 6 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_WRECKING_BALL)</span>
                &amp;&amp; (ae instanceof SupportTank) &amp;&amp; (te instanceof Mech)) {
            // forces a PSR like a charge
<span class="nc bnc" id="L17000" title="All 4 branches missed.">            if (te instanceof LandAirMech &amp;&amp; te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17001">                game.addControlRoll(new PilotingRollData(te.getId(), 2,</span>
                        &quot;was hit by wrecking ball&quot;));
            } else {
<span class="nc" id="L17004">                game.addPSR(new PilotingRollData(te.getId(), 2,</span>
                        &quot;was hit by wrecking ball&quot;));
            }
        }

        // Chain whips can entangle 'Mech and ProtoMech limbs. This
        // implementation assumes that in order to do so the limb must still
        // have some structure left, so if the whip hits and destroys a
        // location in the same attack no special effects take place.
<span class="nc bnc" id="L17013" title="All 6 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_CHAIN_WHIP)</span>
                &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))) {
<span class="nc" id="L17015">            addNewLines();</span>

<span class="nc" id="L17017">            int loc = hit.getLocation();</span>

<span class="nc bnc" id="L17019" title="All 2 branches missed.">            boolean mightTrip = (te instanceof Mech)</span>
<span class="nc bnc" id="L17020" title="All 2 branches missed.">                    &amp;&amp; te.locationIsLeg(loc)</span>
<span class="nc bnc" id="L17021" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17022" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationDoomed(loc)</span>
<span class="nc bnc" id="L17023" title="All 2 branches missed.">                    &amp;&amp; !te.hasActiveShield(loc)</span>
<span class="nc bnc" id="L17024" title="All 2 branches missed.">                    &amp;&amp; !te.hasPassiveShield(loc);</span>

<span class="nc bnc" id="L17026" title="All 6 branches missed.">            boolean mightGrapple = ((te instanceof Mech)</span>
                    &amp;&amp; ((loc == Mech.LOC_LARM) || (loc == Mech.LOC_RARM))
<span class="nc bnc" id="L17028" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17029" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationDoomed(loc)</span>
<span class="nc bnc" id="L17030" title="All 2 branches missed.">                    &amp;&amp; !te.hasActiveShield(loc)</span>
<span class="nc bnc" id="L17031" title="All 2 branches missed.">                    &amp;&amp; !te.hasPassiveShield(loc)</span>
<span class="nc bnc" id="L17032" title="All 10 branches missed.">                    &amp;&amp; !te.hasNoDefenseShield(loc))</span>
                    || ((te instanceof Protomech)
                        &amp;&amp; ((loc == Protomech.LOC_LARM) || (loc == Protomech.LOC_RARM)
                            || (loc == Protomech.LOC_LEG))
                        // Only check location status after confirming we did
                        // hit a limb -- Protos have no actual near-miss
                        // &quot;location&quot; and will throw an exception if it's
                        // referenced here.
<span class="nc bnc" id="L17040" title="All 2 branches missed.">                        &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17041" title="All 2 branches missed.">                        &amp;&amp; !te.isLocationDoomed(loc));</span>

<span class="nc bnc" id="L17043" title="All 2 branches missed.">            if (mightTrip) {</span>
<span class="nc" id="L17044">                roll = Compute.d6(2);</span>
<span class="nc" id="L17045">                int toHitValue = toHit.getValue();</span>
<span class="nc" id="L17046">                String toHitDesc = toHit.getDesc();</span>
<span class="nc bnc" id="L17047" title="All 6 branches missed.">                if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).hasTSM() &amp;&amp; (ae.heat &gt;= 9))</span>
<span class="nc bnc" id="L17048" title="All 6 branches missed.">                        &amp;&amp; (!((Mech) te).hasTSM() || ((((Mech) te).hasTSM()) &amp;&amp; (te.heat &lt; 9)))) {</span>
<span class="nc" id="L17049">                    toHitValue -= 2;</span>
<span class="nc" id="L17050">                    toHitDesc += &quot; -2 (TSM Active Bonus)&quot;;</span>
                }

<span class="nc" id="L17053">                r = new Report(4450);</span>
<span class="nc" id="L17054">                r.subject = ae.getId();</span>
<span class="nc" id="L17055">                r.add(ae.getShortName());</span>
<span class="nc" id="L17056">                r.add(te.getShortName());</span>
<span class="nc" id="L17057">                r.addDataWithTooltip(String.valueOf(toHitValue), toHitDesc);</span>
<span class="nc" id="L17058">                r.add(roll);</span>
<span class="nc" id="L17059">                r.indent(2);</span>
<span class="nc" id="L17060">                r.newlines = 0;</span>
<span class="nc" id="L17061">                addReport(r);</span>

<span class="nc bnc" id="L17063" title="All 2 branches missed.">                if (roll &gt;= toHitValue) {</span>
<span class="nc" id="L17064">                    r = new Report(2270);</span>
<span class="nc" id="L17065">                    r.subject = ae.getId();</span>
<span class="nc" id="L17066">                    r.newlines = 0;</span>
<span class="nc" id="L17067">                    addReport(r);</span>

<span class="nc" id="L17069">                    game.addPSR(new PilotingRollData(te.getId(), 3, &quot;Snared by chain whip&quot;));</span>
                } else {
<span class="nc" id="L17071">                    r = new Report(2357);</span>
<span class="nc" id="L17072">                    r.subject = ae.getId();</span>
<span class="nc" id="L17073">                    r.newlines = 0;</span>
<span class="nc" id="L17074">                    addReport(r);</span>
                }
<span class="nc bnc" id="L17076" title="All 2 branches missed.">            } else if (mightGrapple) {</span>
<span class="nc" id="L17077">                GrappleAttackAction gaa = new GrappleAttackAction(ae.getId(), te.getId());</span>
                int grappleSide;
<span class="nc bnc" id="L17079" title="All 2 branches missed.">                if (caa.getClub().getLocation() == Mech.LOC_RARM) {</span>
<span class="nc" id="L17080">                    grappleSide = Entity.GRAPPLE_RIGHT;</span>
                } else {
<span class="nc" id="L17082">                    grappleSide = Entity.GRAPPLE_LEFT;</span>
                }
<span class="nc" id="L17084">                ToHitData grappleHit = GrappleAttackAction.toHit(game, ae.getId(), target,</span>
                        grappleSide, true);
<span class="nc" id="L17086">                PhysicalResult grappleResult = new PhysicalResult();</span>
<span class="nc" id="L17087">                grappleResult.aaa = gaa;</span>
<span class="nc" id="L17088">                grappleResult.toHit = grappleHit;</span>
<span class="nc" id="L17089">                grappleResult.roll = Compute.d6(2);</span>
<span class="nc" id="L17090">                resolveGrappleAttack(grappleResult, lastEntityId, grappleSide,</span>
<span class="nc bnc" id="L17091" title="All 2 branches missed.">                        hit.getLocation() == Mech.LOC_RARM ? Entity.GRAPPLE_RIGHT : Entity.GRAPPLE_LEFT);</span>
            }
        }

<span class="nc" id="L17095">        addNewLines();</span>

<span class="nc bnc" id="L17097" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_TREE_CLUB)) {</span>
            // the club breaks
<span class="nc" id="L17099">            r = new Report(4150);</span>
<span class="nc" id="L17100">            r.subject = ae.getId();</span>
<span class="nc" id="L17101">            r.add(caa.getClub().getName());</span>
<span class="nc" id="L17102">            addReport(r);</span>
<span class="nc" id="L17103">            ae.removeMisc(caa.getClub().getName());</span>
        }

<span class="nc bnc" id="L17106" title="All 2 branches missed.">        if(caa.isZweihandering()) {</span>
<span class="nc" id="L17107">            ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L17108">            criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L17109">            applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
<span class="nc bnc" id="L17110" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_CLUB)) {</span>
                // the club breaks
<span class="nc" id="L17112">                r = new Report(4150);</span>
<span class="nc" id="L17113">                r.subject = ae.getId();</span>
<span class="nc" id="L17114">                r.add(caa.getClub().getName());</span>
<span class="nc" id="L17115">                addReport(r);</span>
<span class="nc" id="L17116">                ae.removeMisc(caa.getClub().getName());</span>
            }
        }

<span class="nc" id="L17120">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17124" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L17125">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17127">    }</span>

    /**
     * Handle a push attack
     */
    private void resolvePushAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17133">        final PushAttackAction paa = (PushAttackAction) pr.aaa;</span>
<span class="nc" id="L17134">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17136">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17138">        int roll = pr.roll;</span>
<span class="nc" id="L17139">        final ToHitData toHit = pr.toHit;</span>
        Report r;

        // was this push resolved earlier?
<span class="nc bnc" id="L17143" title="All 2 branches missed.">        if (pr.pushBackResolved) {</span>
<span class="nc" id="L17144">            return;</span>
        }
        // don't try this one again
<span class="nc" id="L17147">        pr.pushBackResolved = true;</span>

<span class="nc bnc" id="L17149" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17151">            r = new Report(4005);</span>
<span class="nc" id="L17152">            r.subject = ae.getId();</span>
<span class="nc" id="L17153">            r.addDesc(ae);</span>
<span class="nc" id="L17154">            addReport(r);</span>
        }

<span class="nc" id="L17157">        r = new Report(4155);</span>
<span class="nc" id="L17158">        r.subject = ae.getId();</span>
<span class="nc" id="L17159">        r.indent();</span>
<span class="nc" id="L17160">        r.addDesc(te);</span>
<span class="nc" id="L17161">        r.newlines = 0;</span>
<span class="nc" id="L17162">        addReport(r);</span>

<span class="nc bnc" id="L17164" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17165">            r = new Report(4160);</span>
<span class="nc" id="L17166">            r.subject = ae.getId();</span>
<span class="nc" id="L17167">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17168">            addReport(r);</span>
<span class="nc" id="L17169">            return;</span>
        }

        // report the roll
<span class="nc" id="L17173">        r = new Report(4025);</span>
<span class="nc" id="L17174">        r.subject = ae.getId();</span>
<span class="nc" id="L17175">        r.add(toHit);</span>
<span class="nc" id="L17176">        r.add(roll);</span>
<span class="nc" id="L17177">        r.newlines = 0;</span>
<span class="nc" id="L17178">        addReport(r);</span>

        // check if our target has a push against us, too, and get it
<span class="nc" id="L17181">        PhysicalResult targetPushResult = null;</span>
<span class="nc bnc" id="L17182" title="All 2 branches missed.">        for (PhysicalResult tpr : physicalResults) {</span>
<span class="nc bnc" id="L17183" title="All 4 branches missed.">            if ((tpr.aaa.getEntityId() == te.getId()) &amp;&amp; (tpr.aaa instanceof PushAttackAction)</span>
<span class="nc bnc" id="L17184" title="All 2 branches missed.">                    &amp;&amp; (tpr.aaa.getTargetId() == ae.getId())) {</span>
<span class="nc" id="L17185">                targetPushResult = tpr;</span>
            }
<span class="nc" id="L17187">        }</span>
        // if our target has a push against us,
        // and we are hitting, we need to resolve both now
<span class="nc bnc" id="L17190" title="All 4 branches missed.">        if ((targetPushResult != null) &amp;&amp; !targetPushResult.pushBackResolved</span>
<span class="nc bnc" id="L17191" title="All 2 branches missed.">            &amp;&amp; (roll &gt;= toHit.getValue())) {</span>
<span class="nc" id="L17192">            targetPushResult.pushBackResolved = true;</span>
            // do they hit?
<span class="nc bnc" id="L17194" title="All 2 branches missed.">            if (targetPushResult.roll &gt;= targetPushResult.toHit.getValue()) {</span>
<span class="nc" id="L17195">                r = new Report(4165);</span>
<span class="nc" id="L17196">                r.subject = ae.getId();</span>
<span class="nc" id="L17197">                r.addDesc(te);</span>
<span class="nc" id="L17198">                r.addDesc(te);</span>
<span class="nc" id="L17199">                r.addDesc(ae);</span>
<span class="nc" id="L17200">                r.add(targetPushResult.toHit);</span>
<span class="nc" id="L17201">                r.add(targetPushResult.roll);</span>
<span class="nc" id="L17202">                r.addDesc(ae);</span>
<span class="nc" id="L17203">                addReport(r);</span>
<span class="nc bnc" id="L17204" title="All 2 branches missed.">                if (ae.canFall()) {</span>
<span class="nc" id="L17205">                    PilotingRollData pushPRD = getKickPushPSR(ae, ae, te, &quot;was pushed&quot;);</span>
<span class="nc" id="L17206">                    game.addPSR(pushPRD);</span>
<span class="nc bnc" id="L17207" title="All 4 branches missed.">                } else if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17208">                    game.addControlRoll(getKickPushPSR(ae, ae, te, &quot;was pushed&quot;));</span>
                }
<span class="nc bnc" id="L17210" title="All 2 branches missed.">                if (te.canFall()) {</span>
<span class="nc" id="L17211">                    PilotingRollData targetPushPRD = getKickPushPSR(te, ae, te, &quot;was pushed&quot;);</span>
<span class="nc" id="L17212">                    game.addPSR(targetPushPRD);</span>
<span class="nc bnc" id="L17213" title="All 4 branches missed.">                } else if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17214">                    game.addControlRoll(getKickPushPSR(te, ae, te, &quot;was pushed&quot;));</span>
                }
<span class="nc" id="L17216">                return;</span>
            }
            // report the miss
<span class="nc" id="L17219">            r = new Report(4166);</span>
<span class="nc" id="L17220">            r.subject = ae.getId();</span>
<span class="nc" id="L17221">            r.addDesc(te);</span>
<span class="nc" id="L17222">            r.addDesc(ae);</span>
<span class="nc" id="L17223">            r.add(targetPushResult.toHit);</span>
<span class="nc" id="L17224">            r.add(targetPushResult.roll);</span>
<span class="nc" id="L17225">            addReport(r);</span>
        }

        // do we hit?
<span class="nc bnc" id="L17229" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17231">            r = new Report(4035);</span>
<span class="nc" id="L17232">            r.subject = ae.getId();</span>
<span class="nc" id="L17233">            addReport(r);</span>
<span class="nc" id="L17234">            return;</span>
        }

        // we hit...
<span class="nc" id="L17238">        int direction = ae.getFacing();</span>

<span class="nc" id="L17240">        Coords src = te.getPosition();</span>
<span class="nc" id="L17241">        Coords dest = src.translated(direction);</span>

<span class="nc" id="L17243">        PilotingRollData pushPRD = getKickPushPSR(te, ae, te, &quot;was pushed&quot;);</span>

<span class="nc bnc" id="L17245" title="All 2 branches missed.">        if (Compute.isValidDisplacement(game, te.getId(), te.getPosition(), direction)) {</span>
<span class="nc" id="L17246">            r = new Report(4170);</span>
<span class="nc" id="L17247">            r.subject = ae.getId();</span>
<span class="nc" id="L17248">            r.newlines = 0;</span>
<span class="nc" id="L17249">            addReport(r);</span>
<span class="nc bnc" id="L17250" title="All 2 branches missed.">            if (game.getBoard().contains(dest)) {</span>
<span class="nc" id="L17251">                r = new Report(4175);</span>
<span class="nc" id="L17252">                r.subject = ae.getId();</span>
<span class="nc" id="L17253">                r.add(dest.getBoardNum(), true);</span>
            } else {
                // uh-oh, pushed off board
<span class="nc" id="L17256">                r = new Report(4180);</span>
<span class="nc" id="L17257">                r.subject = ae.getId();</span>
            }
<span class="nc" id="L17259">            addReport(r);</span>

<span class="nc" id="L17261">            addReport(doEntityDisplacement(te, src, dest, pushPRD));</span>

            // if push actually moved the target, attacker follows through
<span class="nc bnc" id="L17264" title="All 2 branches missed.">            if (!te.getPosition().equals(src)) {</span>
<span class="nc" id="L17265">                ae.setPosition(src);</span>
            }
        } else {
            // target immovable
<span class="nc" id="L17269">            r = new Report(4185);</span>
<span class="nc" id="L17270">            r.subject = ae.getId();</span>
<span class="nc" id="L17271">            addReport(r);</span>
<span class="nc bnc" id="L17272" title="All 2 branches missed.">            if (te.canFall()) {</span>
<span class="nc" id="L17273">                game.addPSR(pushPRD);</span>
            }
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17279" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17280">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L17283">        checkForSpikes(te, ae.rollHitLocation(ToHitData.HIT_PUNCH, Compute.targetSideTable(ae, te)).getLocation(),</span>
                0, ae, Mech.LOC_LARM, Mech.LOC_RARM);

<span class="nc" id="L17286">        addNewLines();</span>
<span class="nc" id="L17287">    }</span>

    /**
     * Handle a trip attack
     */
    private void resolveTripAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17293">        final TripAttackAction paa = (TripAttackAction) pr.aaa;</span>
<span class="nc" id="L17294">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;trip&quot;.
<span class="nc" id="L17296">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17298">        int roll = pr.roll;</span>
<span class="nc" id="L17299">        final ToHitData toHit = pr.toHit;</span>
        Report r;

<span class="nc bnc" id="L17302" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17304">            r = new Report(4005);</span>
<span class="nc" id="L17305">            r.subject = ae.getId();</span>
<span class="nc" id="L17306">            r.addDesc(ae);</span>
<span class="nc" id="L17307">            addReport(r);</span>
        }

<span class="nc" id="L17310">        r = new Report(4280);</span>
<span class="nc" id="L17311">        r.subject = ae.getId();</span>
<span class="nc" id="L17312">        r.indent();</span>
<span class="nc" id="L17313">        r.addDesc(te);</span>
<span class="nc" id="L17314">        r.newlines = 0;</span>
<span class="nc" id="L17315">        addReport(r);</span>

<span class="nc bnc" id="L17317" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17318">            r = new Report(4285);</span>
<span class="nc" id="L17319">            r.subject = ae.getId();</span>
<span class="nc" id="L17320">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17321">            addReport(r);</span>
<span class="nc" id="L17322">            return;</span>
        }

        // report the roll
<span class="nc" id="L17326">        r = new Report(4025);</span>
<span class="nc" id="L17327">        r.subject = ae.getId();</span>
<span class="nc" id="L17328">        r.add(toHit);</span>
<span class="nc" id="L17329">        r.add(roll);</span>
<span class="nc" id="L17330">        r.newlines = 0;</span>
<span class="nc" id="L17331">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L17334" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17336">            r = new Report(4035);</span>
<span class="nc" id="L17337">            r.subject = ae.getId();</span>
<span class="nc" id="L17338">            addReport(r);</span>
<span class="nc" id="L17339">            return;</span>
        }

        // we hit...
<span class="nc bnc" id="L17343" title="All 2 branches missed.">        if (te.canFall()) {</span>
<span class="nc" id="L17344">            PilotingRollData pushPRD = getKickPushPSR(te, ae, te, &quot;was tripped&quot;);</span>
<span class="nc" id="L17345">            game.addPSR(pushPRD);</span>
        }

<span class="nc" id="L17348">        r = new Report(4040);</span>
<span class="nc" id="L17349">        r.subject = ae.getId();</span>
<span class="nc" id="L17350">        addReport(r);</span>
<span class="nc" id="L17351">        addNewLines();</span>
        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17354" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17355">            ((Mech) te).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17357">    }</span>

    /**
     * Handle a grapple attack
     */
    private void resolveGrappleAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17363">        resolveGrappleAttack(pr, lastEntityId, Entity.GRAPPLE_BOTH,</span>
                Entity.GRAPPLE_BOTH);
<span class="nc" id="L17365">    }</span>

    /**
     * Resolves a grapple attack.
     *
     * @param pr            the result of a physical attack - this one specifically being a grapple
     * @param lastEntityId  the entity making the attack
     * @param aeGrappleSide
     *            The side that the attacker is grappling with. For normal
     *            grapples this will be both, for chain whip grapples this will
     *            be the arm with the chain whip in it.
     * @param teGrappleSide
     *            The that the the target is grappling with. For normal grapples
     *            this will be both, for chain whip grapples this will be the
     *            arm that is being whipped.
     */
    private void resolveGrappleAttack(PhysicalResult pr, int lastEntityId,
                                      int aeGrappleSide, int teGrappleSide) {
<span class="nc" id="L17383">        final GrappleAttackAction paa = (GrappleAttackAction) pr.aaa;</span>
<span class="nc" id="L17384">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17386">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17388">        int roll = pr.roll;</span>
<span class="nc" id="L17389">        final ToHitData toHit = pr.toHit;</span>
        Report r;

        // same method as push, for counterattacks
<span class="nc bnc" id="L17393" title="All 2 branches missed.">        if (pr.pushBackResolved) {</span>
<span class="nc" id="L17394">            return;</span>
        }

<span class="nc bnc" id="L17397" title="All 2 branches missed.">        if ((te.getGrappled() != Entity.NONE)</span>
<span class="nc bnc" id="L17398" title="All 2 branches missed.">            || (ae.getGrappled() != Entity.NONE)) {</span>
<span class="nc" id="L17399">            toHit.addModifier(TargetRoll.IMPOSSIBLE, &quot;Already Grappled&quot;);</span>
        }

<span class="nc bnc" id="L17402" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17404">            r = new Report(4005);</span>
<span class="nc" id="L17405">            r.subject = ae.getId();</span>
<span class="nc" id="L17406">            r.addDesc(ae);</span>
<span class="nc" id="L17407">            addReport(r);</span>
        }

<span class="nc" id="L17410">        r = new Report(4295);</span>
<span class="nc" id="L17411">        r.subject = ae.getId();</span>
<span class="nc" id="L17412">        r.indent();</span>
<span class="nc" id="L17413">        r.addDesc(te);</span>
<span class="nc" id="L17414">        r.newlines = 0;</span>
<span class="nc" id="L17415">        addReport(r);</span>

<span class="nc bnc" id="L17417" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17418">            r = new Report(4300);</span>
<span class="nc" id="L17419">            r.subject = ae.getId();</span>
<span class="nc" id="L17420">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17421">            addReport(r);</span>
<span class="nc" id="L17422">            return;</span>
        }

        // report the roll
<span class="nc" id="L17426">        r = new Report(4025);</span>
<span class="nc" id="L17427">        r.subject = ae.getId();</span>
<span class="nc" id="L17428">        r.add(toHit);</span>
<span class="nc" id="L17429">        r.add(roll);</span>
<span class="nc" id="L17430">        r.newlines = 0;</span>
<span class="nc" id="L17431">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L17434" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17436">            r = new Report(4035);</span>
<span class="nc" id="L17437">            r.subject = ae.getId();</span>
<span class="nc" id="L17438">            addReport(r);</span>
<span class="nc" id="L17439">            return;</span>
        }

        // we hit...
<span class="nc" id="L17443">        ae.setGrappled(te.getId(), true);</span>
<span class="nc" id="L17444">        te.setGrappled(ae.getId(), false);</span>
<span class="nc" id="L17445">        ae.setGrappledThisRound(true);</span>
<span class="nc" id="L17446">        te.setGrappledThisRound(true);</span>
        // For normal grapples, AE moves into targets hex.
<span class="nc bnc" id="L17448" title="All 2 branches missed.">        if (aeGrappleSide == Entity.GRAPPLE_BOTH) {</span>
<span class="nc" id="L17449">            Coords pos = te.getPosition();</span>
<span class="nc" id="L17450">            ae.setPosition(pos);</span>
<span class="nc" id="L17451">            ae.setElevation(te.getElevation());</span>
<span class="nc" id="L17452">            te.setFacing((ae.getFacing() + 3) % 6);</span>
<span class="nc" id="L17453">            addReport(doSetLocationsExposure(ae, game.getBoard().getHex(pos),</span>
<span class="nc" id="L17454">                    false, ae.getElevation()));</span>
        }

<span class="nc" id="L17457">        ae.setGrappleSide(aeGrappleSide);</span>
<span class="nc" id="L17458">        te.setGrappleSide(teGrappleSide);</span>

<span class="nc" id="L17460">        r = new Report(4040);</span>
<span class="nc" id="L17461">        r.subject = ae.getId();</span>
<span class="nc" id="L17462">        addReport(r);</span>
<span class="nc" id="L17463">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17467" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17468">            ((Mech) te).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17470">    }</span>

    /**
     * Handle a break grapple attack
     */
    private void resolveBreakGrappleAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17476">        final BreakGrappleAttackAction paa = (BreakGrappleAttackAction) pr.aaa;</span>
<span class="nc" id="L17477">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17479">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17481">        int roll = pr.roll;</span>
<span class="nc" id="L17482">        final ToHitData toHit = pr.toHit;</span>
        Report r;

<span class="nc bnc" id="L17485" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17487">            r = new Report(4005);</span>
<span class="nc" id="L17488">            r.subject = ae.getId();</span>
<span class="nc" id="L17489">            r.addDesc(ae);</span>
<span class="nc" id="L17490">            addReport(r);</span>
        }

<span class="nc" id="L17493">        r = new Report(4305);</span>
<span class="nc" id="L17494">        r.subject = ae.getId();</span>
<span class="nc" id="L17495">        r.indent();</span>
<span class="nc" id="L17496">        r.addDesc(te);</span>
<span class="nc" id="L17497">        r.newlines = 0;</span>
<span class="nc" id="L17498">        addReport(r);</span>

<span class="nc bnc" id="L17500" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17501">            r = new Report(4310);</span>
<span class="nc" id="L17502">            r.subject = ae.getId();</span>
<span class="nc" id="L17503">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17504">            addReport(r);</span>
<span class="nc bnc" id="L17505" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17506">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a physical attack&quot;));</span>
            }
<span class="nc" id="L17508">            return;</span>
        }

<span class="nc bnc" id="L17511" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17512">            r = new Report(4320);</span>
<span class="nc" id="L17513">            r.subject = ae.getId();</span>
<span class="nc" id="L17514">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L17517">            r = new Report(4025);</span>
<span class="nc" id="L17518">            r.subject = ae.getId();</span>
<span class="nc" id="L17519">            r.add(toHit);</span>
<span class="nc" id="L17520">            r.add(roll);</span>
<span class="nc" id="L17521">            r.newlines = 0;</span>
<span class="nc" id="L17522">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L17525" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L17527">                r = new Report(4035);</span>
<span class="nc" id="L17528">                r.subject = ae.getId();</span>
<span class="nc" id="L17529">                addReport(r);</span>
<span class="nc bnc" id="L17530" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17531">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a physical attack&quot;));</span>
                }
<span class="nc" id="L17533">                return;</span>
            }

            // hit
<span class="nc" id="L17537">            r = new Report(4040);</span>
<span class="nc" id="L17538">            r.subject = ae.getId();</span>
        }
<span class="nc" id="L17540">        addReport(r);</span>

        // is there a counterattack?
<span class="nc" id="L17543">        PhysicalResult targetGrappleResult = null;</span>
<span class="nc bnc" id="L17544" title="All 2 branches missed.">        for (PhysicalResult tpr : physicalResults) {</span>
<span class="nc bnc" id="L17545" title="All 4 branches missed.">            if ((tpr.aaa.getEntityId() == te.getId())</span>
                &amp;&amp; (tpr.aaa instanceof GrappleAttackAction)
<span class="nc bnc" id="L17547" title="All 2 branches missed.">                &amp;&amp; (tpr.aaa.getTargetId() == ae.getId())) {</span>
<span class="nc" id="L17548">                targetGrappleResult = tpr;</span>
<span class="nc" id="L17549">                break;</span>
            }
<span class="nc" id="L17551">        }</span>

<span class="nc bnc" id="L17553" title="All 2 branches missed.">        if (targetGrappleResult != null) {</span>
<span class="nc" id="L17554">            targetGrappleResult.pushBackResolved = true;</span>
            // counterattack
<span class="nc" id="L17556">            r = new Report(4315);</span>
<span class="nc" id="L17557">            r.subject = te.getId();</span>
<span class="nc" id="L17558">            r.newlines = 0;</span>
<span class="nc" id="L17559">            r.addDesc(te);</span>
<span class="nc" id="L17560">            addReport(r);</span>

            // report the roll
<span class="nc" id="L17563">            r = new Report(4025);</span>
<span class="nc" id="L17564">            r.subject = te.getId();</span>
<span class="nc" id="L17565">            r.add(targetGrappleResult.toHit);</span>
<span class="nc" id="L17566">            r.add(targetGrappleResult.roll);</span>
<span class="nc" id="L17567">            r.newlines = 0;</span>
<span class="nc" id="L17568">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L17571" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L17573">                r = new Report(4035);</span>
<span class="nc" id="L17574">                r.subject = ae.getId();</span>
<span class="nc" id="L17575">                addReport(r);</span>
            } else {
                // hit
<span class="nc" id="L17578">                r = new Report(4040);</span>
<span class="nc" id="L17579">                r.subject = ae.getId();</span>
<span class="nc" id="L17580">                addReport(r);</span>

                // exchange attacker and defender
<span class="nc" id="L17583">                ae.setGrappled(te.getId(), false);</span>
<span class="nc" id="L17584">                te.setGrappled(ae.getId(), true);</span>

<span class="nc" id="L17586">                return;</span>
            }
        }

        // score the adjacent hexes
<span class="nc" id="L17591">        Coords[] hexes = new Coords[6];</span>
<span class="nc" id="L17592">        int[] scores = new int[6];</span>

<span class="nc" id="L17594">        IHex curHex = game.getBoard().getHex(ae.getPosition());</span>
<span class="nc bnc" id="L17595" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L17596">            hexes[i] = ae.getPosition().translated(i);</span>
<span class="nc" id="L17597">            scores[i] = 0;</span>
<span class="nc" id="L17598">            IHex hex = game.getBoard().getHex(hexes[i]);</span>
<span class="nc bnc" id="L17599" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.MAGMA)) {</span>
<span class="nc" id="L17600">                scores[i] += 10;</span>
            }
<span class="nc bnc" id="L17602" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L17603">                scores[i] += hex.terrainLevel(Terrains.WATER);</span>
            }
<span class="nc bnc" id="L17605" title="All 2 branches missed.">            if ((curHex.surface() - hex.surface()) &gt;= 2) {</span>
<span class="nc" id="L17606">                scores[i] += 2 * (curHex.surface() - hex.surface());</span>
            }
        }

<span class="nc" id="L17610">        int bestScore = 99999;</span>
<span class="nc" id="L17611">        int best = 0;</span>
<span class="nc" id="L17612">        int worstScore = -99999;</span>
<span class="nc" id="L17613">        int worst = 0;</span>

<span class="nc bnc" id="L17615" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc bnc" id="L17616" title="All 2 branches missed.">            if (bestScore &gt; scores[i]) {</span>
<span class="nc" id="L17617">                best = i;</span>
<span class="nc" id="L17618">                bestScore = scores[i];</span>
            }
<span class="nc bnc" id="L17620" title="All 2 branches missed.">            if (worstScore &lt; scores[i]) {</span>
<span class="nc" id="L17621">                worst = i;</span>
<span class="nc" id="L17622">                worstScore = scores[i];</span>
            }
        }

        // attacker doesn't fall, unless off a cliff
<span class="nc bnc" id="L17627" title="All 2 branches missed.">        if (ae.isGrappleAttacker()) {</span>
            // move self to least dangerous hex
<span class="nc" id="L17629">            PilotingRollData psr = ae.getBasePilotingRoll();</span>
<span class="nc" id="L17630">            psr.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;break grapple&quot;);</span>
<span class="nc" id="L17631">            addReport(doEntityDisplacement(ae, ae.getPosition(), hexes[best], psr));</span>
<span class="nc" id="L17632">            ae.setFacing(hexes[best].direction(te.getPosition()));</span>
<span class="nc" id="L17633">        } else {</span>
            // move enemy to most dangerous hex
<span class="nc" id="L17635">            PilotingRollData psr = te.getBasePilotingRoll();</span>
<span class="nc" id="L17636">            psr.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;break grapple&quot;);</span>
<span class="nc" id="L17637">            addReport(doEntityDisplacement(te, te.getPosition(), hexes[worst], psr));</span>
<span class="nc" id="L17638">            te.setFacing(hexes[worst].direction(ae.getPosition()));</span>
        }

        // grapple is broken
<span class="nc" id="L17642">        ae.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L17643">        te.setGrappled(Entity.NONE, false);</span>

<span class="nc" id="L17645">        addNewLines();</span>
<span class="nc" id="L17646">    }</span>

    /**
     * Handle a charge attack
     */
    private void resolveChargeAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17652">        final ChargeAttackAction caa = (ChargeAttackAction) pr.aaa;</span>
<span class="nc" id="L17653">        final Entity ae = game.getEntity(caa.getEntityId());</span>
<span class="nc" id="L17654">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L17656">        int damage = pr.damage;</span>
<span class="nc" id="L17657">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L17658">        int roll = pr.roll;</span>

<span class="nc" id="L17660">        Entity te = null;</span>
<span class="nc bnc" id="L17661" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L17662">            te = (Entity) target;</span>
        }
<span class="nc" id="L17664">        boolean throughFront = true;</span>
<span class="nc bnc" id="L17665" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L17666">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L17668" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17669" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L17672">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L17673" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17674" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L17679">        Building bldg = game.getBoard().getBuildingAt(caa.getTargetPos());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L17682" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L17683">            return;</span>
        }

<span class="nc" id="L17686">        final int direction = ae.getFacing();</span>

        // entity isn't charging any more
<span class="nc" id="L17689">        ae.setDisplacementAttack(null);</span>

<span class="nc bnc" id="L17691" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17693">            r = new Report(4005);</span>
<span class="nc" id="L17694">            r.subject = ae.getId();</span>
<span class="nc" id="L17695">            r.addDesc(ae);</span>
<span class="nc" id="L17696">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L17700" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L17701" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L17702">            r = new Report(4190);</span>
<span class="nc" id="L17703">            r.subject = ae.getId();</span>
<span class="nc" id="L17704">            r.indent();</span>
<span class="nc" id="L17705">            addReport(r);</span>
            // doEntityDisplacement(ae, ae.getPosition(), caa.getTargetPos(),
            // null);
            // Randall said that if a charge fails because of target
            // destruction,
            // the attacker stays in the hex he was in at the end of the
            // movement phase
            // See Bug 912094
<span class="nc" id="L17713">            return;</span>
        }

        // attacker fell down?
<span class="nc bnc" id="L17717" title="All 2 branches missed.">        if (ae.isProne()) {</span>
<span class="nc" id="L17718">            r = new Report(4195);</span>
<span class="nc" id="L17719">            r.subject = ae.getId();</span>
<span class="nc" id="L17720">            r.indent();</span>
<span class="nc" id="L17721">            addReport(r);</span>
<span class="nc" id="L17722">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L17726" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L17727">            r = new Report(4200);</span>
<span class="nc" id="L17728">            r.subject = ae.getId();</span>
<span class="nc" id="L17729">            r.indent();</span>
<span class="nc" id="L17730">            addReport(r);</span>
<span class="nc" id="L17731">            return;</span>
        }

        // target fell down, only for attacking Mechs, though
<span class="nc bnc" id="L17735" title="All 6 branches missed.">        if ((te != null) &amp;&amp; (te.isProne()) &amp;&amp; (ae instanceof Mech)) {</span>
<span class="nc" id="L17736">            r = new Report(4205);</span>
<span class="nc" id="L17737">            r.subject = ae.getId();</span>
<span class="nc" id="L17738">            r.indent();</span>
<span class="nc" id="L17739">            addReport(r);</span>
<span class="nc" id="L17740">            return;</span>
        }

<span class="nc" id="L17743">        r = new Report(4210);</span>
<span class="nc" id="L17744">        r.subject = ae.getId();</span>
<span class="nc" id="L17745">        r.indent();</span>
<span class="nc" id="L17746">        r.add(target.getDisplayName());</span>
<span class="nc" id="L17747">        r.newlines = 0;</span>
<span class="nc" id="L17748">        addReport(r);</span>

        // target still in the same position?
<span class="nc bnc" id="L17751" title="All 2 branches missed.">        if (!target.getPosition().equals(caa.getTargetPos())) {</span>
<span class="nc" id="L17752">            r = new Report(4215);</span>
<span class="nc" id="L17753">            r.subject = ae.getId();</span>
<span class="nc" id="L17754">            addReport(r);</span>
<span class="nc" id="L17755">            addReport(doEntityDisplacement(ae, ae.getPosition(), caa.getTargetPos(), null));</span>
<span class="nc" id="L17756">            return;</span>
        }

        // if the attacker's prone, fudge the roll
<span class="nc bnc" id="L17760" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17761">            roll = -12;</span>
<span class="nc" id="L17762">            r = new Report(4220);</span>
<span class="nc" id="L17763">            r.subject = ae.getId();</span>
<span class="nc" id="L17764">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17765">            addReport(r);</span>
<span class="nc bnc" id="L17766" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17767">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L17768">            r = new Report(4225);</span>
<span class="nc" id="L17769">            r.subject = ae.getId();</span>
<span class="nc" id="L17770">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17771">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L17774">            r = new Report(4025);</span>
<span class="nc" id="L17775">            r.subject = ae.getId();</span>
<span class="nc" id="L17776">            r.add(toHit);</span>
<span class="nc" id="L17777">            r.add(roll);</span>
<span class="nc" id="L17778">            addReport(r);</span>
<span class="nc bnc" id="L17779" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L17780">                r = new Report(3186);</span>
<span class="nc" id="L17781">                r.subject = ae.getId();</span>
<span class="nc" id="L17782">                addReport(r);</span>
            }
<span class="nc bnc" id="L17784" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L17785">                r = new Report(3189);</span>
<span class="nc" id="L17786">                r.subject = ae.getId();</span>
<span class="nc" id="L17787">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L17792" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L17793">            Coords src = ae.getPosition();</span>
<span class="nc" id="L17794">            Coords dest = Compute.getMissedChargeDisplacement(game, ae.getId(), src, direction);</span>

            // TODO : handle movement into/out of/through a building. Do it here?

            // miss
<span class="nc" id="L17799">            r = new Report(4035);</span>
<span class="nc" id="L17800">            r.subject = ae.getId();</span>
<span class="nc" id="L17801">            addReport(r);</span>
            // move attacker to side hex
<span class="nc" id="L17803">            addReport(doEntityDisplacement(ae, src, dest, null));</span>
<span class="nc bnc" id="L17804" title="All 2 branches missed.">        } else if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L17805" title="All 2 branches missed.">                   || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) { // Targeting</span>
            // a building.
            // The building takes the full brunt of the attack.
<span class="nc" id="L17808">            r = new Report(4040);</span>
<span class="nc" id="L17809">            r.subject = ae.getId();</span>
<span class="nc" id="L17810">            addReport(r);</span>
<span class="nc" id="L17811">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L17812" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L17813">                report.subject = ae.getId();</span>
<span class="nc" id="L17814">            }</span>
<span class="nc" id="L17815">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L17818">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // Apply damage to the attacker.
<span class="nc" id="L17821">            int toAttacker = ChargeAttackAction.getDamageTakenBy(ae, bldg, target.getPosition());</span>
<span class="nc" id="L17822">            HitData hit = ae.rollHitLocation(ToHitData.HIT_NORMAL, ae.sideTable(target.getPosition()));</span>
<span class="nc" id="L17823">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L17824">            addReport(damageEntity(ae, hit, toAttacker, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc" id="L17826">            addNewLines();</span>
<span class="nc" id="L17827">            entityUpdate(ae.getId());</span>

            // TODO : Does the attacker enter the building?
            // TODO : What if the building collapses?
<span class="nc" id="L17831">        } else {</span>
            // Resolve the damage.
<span class="nc" id="L17833">            resolveChargeDamage(ae, te, toHit, direction, glancing, throughFront, false);</span>
        }
<span class="nc" id="L17835">    }</span>

    /**
     * Handle an Airmech ram attack
     */
    private void resolveAirmechRamAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17841">        final AirmechRamAttackAction caa = (AirmechRamAttackAction) pr.aaa;</span>
<span class="nc" id="L17842">        final Entity ae = game.getEntity(caa.getEntityId());</span>
<span class="nc" id="L17843">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L17845">        int damage = pr.damage;</span>
<span class="nc" id="L17846">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L17847">        int roll = pr.roll;</span>

<span class="nc" id="L17849">        Entity te = null;</span>
<span class="nc bnc" id="L17850" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L17851">            te = (Entity) target;</span>
        }
<span class="nc" id="L17853">        boolean throughFront = true;</span>
<span class="nc bnc" id="L17854" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L17855">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L17857" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17858" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L17861">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L17862" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17863" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L17868">        Building bldg = game.getBoard().getBuildingAt(caa.getTargetPos());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L17871" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L17872">            return;</span>
        }

<span class="nc" id="L17875">        final int direction = ae.getFacing();</span>

        // entity isn't charging any more
<span class="nc" id="L17878">        ae.setDisplacementAttack(null);</span>

<span class="nc bnc" id="L17880" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17882">            r = new Report(4005);</span>
<span class="nc" id="L17883">            r.subject = ae.getId();</span>
<span class="nc" id="L17884">            r.addDesc(ae);</span>
<span class="nc" id="L17885">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L17889" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L17890" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L17891">            r = new Report(4192);</span>
<span class="nc" id="L17892">            r.subject = ae.getId();</span>
<span class="nc" id="L17893">            r.indent();</span>
<span class="nc" id="L17894">            addReport(r);</span>
<span class="nc" id="L17895">            game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L17896">                    ae.getId(), 0, &quot;missed a ramming attack&quot;));</span>
<span class="nc" id="L17897">            return;</span>
        }

        // attacker landed?
<span class="nc bnc" id="L17901" title="All 2 branches missed.">        if (!ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17902">            r = new Report(4197);</span>
<span class="nc" id="L17903">            r.subject = ae.getId();</span>
<span class="nc" id="L17904">            r.indent();</span>
<span class="nc" id="L17905">            addReport(r);</span>
<span class="nc" id="L17906">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L17910" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L17911">            r = new Report(4202);</span>
<span class="nc" id="L17912">            r.subject = ae.getId();</span>
<span class="nc" id="L17913">            r.indent();</span>
<span class="nc" id="L17914">            addReport(r);</span>
<span class="nc" id="L17915">            return;</span>
        }

<span class="nc" id="L17918">        r = new Report(4212);</span>
<span class="nc" id="L17919">        r.subject = ae.getId();</span>
<span class="nc" id="L17920">        r.indent();</span>
<span class="nc" id="L17921">        r.add(target.getDisplayName());</span>
<span class="nc" id="L17922">        r.newlines = 0;</span>
<span class="nc" id="L17923">        addReport(r);</span>

        // if the attacker's prone, fudge the roll
<span class="nc bnc" id="L17926" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17927">            roll = -12;</span>
<span class="nc" id="L17928">            r = new Report(4222);</span>
<span class="nc" id="L17929">            r.subject = ae.getId();</span>
<span class="nc" id="L17930">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17931">            addReport(r);</span>
<span class="nc bnc" id="L17932" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17933">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L17934">            r = new Report(4227);</span>
<span class="nc" id="L17935">            r.subject = ae.getId();</span>
<span class="nc" id="L17936">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17937">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L17940">            r = new Report(4025);</span>
<span class="nc" id="L17941">            r.subject = ae.getId();</span>
<span class="nc" id="L17942">            r.add(toHit);</span>
<span class="nc" id="L17943">            r.add(roll);</span>
<span class="nc" id="L17944">            addReport(r);</span>
<span class="nc bnc" id="L17945" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L17946">                r = new Report(3186);</span>
<span class="nc" id="L17947">                r.subject = ae.getId();</span>
<span class="nc" id="L17948">                addReport(r);</span>
            }
<span class="nc bnc" id="L17950" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L17951">                r = new Report(3189);</span>
<span class="nc" id="L17952">                r.subject = ae.getId();</span>
<span class="nc" id="L17953">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L17958" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17960">            r = new Report(4035);</span>
<span class="nc" id="L17961">            r.subject = ae.getId();</span>
<span class="nc" id="L17962">            addReport(r);</span>
            // attacker must make a control roll
<span class="nc" id="L17964">            game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed ramming attack&quot;));</span>
<span class="nc bnc" id="L17965" title="All 2 branches missed.">        } else if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L17966" title="All 2 branches missed.">                   || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) { // Targeting</span>
            // a building.
            // The building takes the full brunt of the attack.
<span class="nc" id="L17969">            r = new Report(4040);</span>
<span class="nc" id="L17970">            r.subject = ae.getId();</span>
<span class="nc" id="L17971">            addReport(r);</span>
<span class="nc" id="L17972">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L17973" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L17974">                report.subject = ae.getId();</span>
<span class="nc" id="L17975">            }</span>
<span class="nc" id="L17976">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L17979">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // Apply damage to the attacker.
<span class="nc" id="L17982">            int toAttacker = AirmechRamAttackAction.getDamageTakenBy(ae, target,</span>
                    ae.delta_distance);
<span class="nc" id="L17984">            HitData hit = new HitData(Mech.LOC_CT);</span>
<span class="nc" id="L17985">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L17986">            addReport(damageEntity(ae, hit, toAttacker, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc" id="L17988">            addNewLines();</span>
<span class="nc" id="L17989">            entityUpdate(ae.getId());</span>

            // TODO : Does the attacker enter the building?
            // TODO : What if the building collapses?
<span class="nc" id="L17993">        } else {</span>
            // Resolve the damage.
<span class="nc" id="L17995">            resolveChargeDamage(ae, te, toHit, direction, glancing, throughFront, true);</span>
        }
<span class="nc" id="L17997">    }</span>

    /**
     * Handle a telemissile attack
     */
    private void resolveTeleMissileAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18003">        final TeleMissileAttackAction taa = (TeleMissileAttackAction) pr.aaa;</span>
<span class="nc" id="L18004">        final Entity ae = game.getEntity(taa.getEntityId());</span>
<span class="nc bnc" id="L18005" title="All 2 branches missed.">        if (!(ae instanceof TeleMissile)) {</span>
<span class="nc" id="L18006">            return;</span>
        }
<span class="nc" id="L18008">        TeleMissile tm = (TeleMissile) ae;</span>
<span class="nc" id="L18009">        final Targetable target = game.getTarget(taa.getTargetType(), taa.getTargetId());</span>
<span class="nc" id="L18010">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18011">        int roll = pr.roll;</span>
<span class="nc" id="L18012">        int amsDamage = taa.CounterAVInt;</span>
<span class="nc" id="L18013">        Entity te = null;</span>
<span class="nc bnc" id="L18014" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L18015">            te = (Entity) target;</span>
        }

<span class="nc" id="L18018">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18019" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18020">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }

        Report r;

<span class="nc bnc" id="L18025" title="All 2 branches missed.">        if (lastEntityId != taa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18027">            r = new Report(4005);</span>
<span class="nc" id="L18028">            r.subject = ae.getId();</span>
<span class="nc" id="L18029">            r.addDesc(ae);</span>
<span class="nc" id="L18030">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18034" title="All 2 branches missed.">        if ((target == null)</span>
<span class="nc bnc" id="L18035" title="All 4 branches missed.">                || ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; (te.isDestroyed()</span>
<span class="nc bnc" id="L18036" title="All 4 branches missed.">                || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18037">            r = new Report(4191);</span>
<span class="nc" id="L18038">            r.subject = ae.getId();</span>
<span class="nc" id="L18039">            r.indent();</span>
<span class="nc" id="L18040">            addReport(r);</span>
<span class="nc" id="L18041">            return;</span>
        }

<span class="nc" id="L18044">        r = new Report(9031);</span>
<span class="nc" id="L18045">        r.subject = ae.getId();</span>
<span class="nc" id="L18046">        r.indent();</span>
<span class="nc" id="L18047">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18048">        r.newlines = 1;</span>
<span class="nc" id="L18049">        addReport(r);</span>

        //If point defenses engaged the missile, handle that damage
<span class="nc bnc" id="L18052" title="All 2 branches missed.">        if (amsDamage &gt; 0) {</span>
            //Report the attack
<span class="nc" id="L18054">            r = new Report(3362);</span>
<span class="nc" id="L18055">            r.newlines = 1;</span>
<span class="nc" id="L18056">            r.subject = te.getId();</span>
<span class="nc" id="L18057">            vPhaseReport.add(r);</span>

            //If the target's point defenses overheated, report that
<span class="nc bnc" id="L18060" title="All 2 branches missed.">            if (taa.getPDOverheated()) {</span>
<span class="nc" id="L18061">                r = new Report(3361);</span>
<span class="nc" id="L18062">                r.newlines = 1;</span>
<span class="nc" id="L18063">                r.subject = te.getId();</span>
<span class="nc" id="L18064">                vPhaseReport.add(r);</span>
            }

            //Damage the missile
<span class="nc" id="L18068">            HitData hit = tm.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18069">                    tm.sideTable(te.getPosition(), true));</span>
<span class="nc" id="L18070">            addReport(damageEntity(ae, hit, amsDamage, false,</span>
                    DamageType.NONE, false, false, false));

            //If point defense fire destroys the missile, don't process a hit
<span class="nc bnc" id="L18074" title="All 2 branches missed.">            if (ae.isDoomed()) {</span>
<span class="nc" id="L18075">                return;</span>
            }
        }

        // add some stuff to the to hit value
        // need to add damage done modifier
<span class="nc" id="L18081">        int damageTaken = (ae.getOArmor(TeleMissile.LOC_BODY) - ae.getArmor(TeleMissile.LOC_BODY));</span>
<span class="nc bnc" id="L18082" title="All 2 branches missed.">        if (damageTaken &gt; 10) {</span>
<span class="nc" id="L18083">            toHit.addModifier((int) (Math.floor(damageTaken / 10.0)), &quot;damage taken&quot;);</span>
        }

        // add modifiers for the originating unit missing CIC, FCS, or sensors
<span class="nc" id="L18087">        Entity ride = game.getEntity(tm.getOriginalRideId());</span>
<span class="nc bnc" id="L18088" title="All 2 branches missed.">        if (ride instanceof Aero) {</span>
<span class="nc" id="L18089">            Aero aride = (Aero) ride;</span>
<span class="nc" id="L18090">            int cic = aride.getCICHits();</span>
<span class="nc bnc" id="L18091" title="All 2 branches missed.">            if (cic &gt; 0) {</span>
<span class="nc" id="L18092">                toHit.addModifier(cic * 2, &quot;CIC damage&quot;);</span>
            }

            // sensor hits
<span class="nc" id="L18096">            int sensors = aride.getSensorHits();</span>
<span class="nc bnc" id="L18097" title="All 4 branches missed.">            if ((sensors &gt; 0) &amp;&amp; (sensors &lt; 3)) {</span>
<span class="nc" id="L18098">                toHit.addModifier(sensors, &quot;sensor damage&quot;);</span>
            }
<span class="nc bnc" id="L18100" title="All 2 branches missed.">            if (sensors &gt; 2) {</span>
<span class="nc" id="L18101">                toHit.addModifier(+5, &quot;sensors destroyed&quot;);</span>
            }

            // FCS hits
<span class="nc" id="L18105">            int fcs = aride.getFCSHits();</span>
<span class="nc bnc" id="L18106" title="All 2 branches missed.">            if (fcs &gt; 0) {</span>
<span class="nc" id="L18107">                toHit.addModifier(fcs * 2, &quot;fcs damage&quot;);</span>
            }
        }

<span class="nc bnc" id="L18111" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18112">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L18113">            r = new Report(4226);</span>
<span class="nc" id="L18114">            r.subject = ae.getId();</span>
<span class="nc" id="L18115">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L18118">            r = new Report(9033);</span>
<span class="nc" id="L18119">            r.subject = ae.getId();</span>
<span class="nc" id="L18120">            r.add(toHit);</span>
<span class="nc" id="L18121">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18122">            r.add(roll);</span>
<span class="nc" id="L18123">            r.newlines = 0;</span>
        }
<span class="nc" id="L18125">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L18128" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18130">            r = new Report(4035);</span>
<span class="nc" id="L18131">            r.subject = ae.getId();</span>
<span class="nc" id="L18132">            addReport(r);</span>
        } else {
            // Resolve the damage.
<span class="nc" id="L18135">            HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18136">                    te.sideTable(ae.getPosition(), true));</span>
<span class="nc" id="L18137">            hit.setCapital(true);</span>
<span class="nc" id="L18138">            hit.setCapMisCritMod(tm.getCritMod());</span>
<span class="nc" id="L18139">            addReport(damageEntity(te, hit,</span>
<span class="nc" id="L18140">                    TeleMissileAttackAction.getDamageFor(ae), false,</span>
                    DamageType.NONE, false, false, throughFront));
<span class="nc" id="L18142">            destroyEntity(ae, &quot;successful attack&quot;);</span>
        }

<span class="nc" id="L18145">    }</span>

    /**
     * Handle a ramming attack
     */
    private void resolveRamAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18151">        final RamAttackAction raa = (RamAttackAction) pr.aaa;</span>
<span class="nc" id="L18152">        final Entity ae = game.getEntity(raa.getEntityId());</span>
<span class="nc" id="L18153">        final Targetable target = game.getTarget(raa.getTargetType(), raa.getTargetId());</span>
<span class="nc" id="L18154">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18155">        int roll = pr.roll;</span>
<span class="nc" id="L18156">        Entity te = null;</span>
<span class="nc bnc" id="L18157" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L18158">            te = (Entity) target;</span>
        }

<span class="nc" id="L18161">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18162" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18163">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }

        Report r;

<span class="nc bnc" id="L18168" title="All 2 branches missed.">        boolean glancing = Compute.d6(1) == 6;</span>

        // entity isn't ramming any more
<span class="nc" id="L18171">        ae.setRamming(false);</span>

<span class="nc bnc" id="L18173" title="All 2 branches missed.">        if (lastEntityId != raa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18175">            r = new Report(4005);</span>
<span class="nc" id="L18176">            r.subject = ae.getId();</span>
<span class="nc" id="L18177">            r.addDesc(ae);</span>
<span class="nc" id="L18178">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18182" title="All 2 branches missed.">        if ((target == null)</span>
<span class="nc bnc" id="L18183" title="All 4 branches missed.">                || ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; (te.isDestroyed()</span>
<span class="nc bnc" id="L18184" title="All 4 branches missed.">                || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18185">            r = new Report(4190);</span>
<span class="nc" id="L18186">            r.subject = ae.getId();</span>
<span class="nc" id="L18187">            r.indent();</span>
<span class="nc" id="L18188">            addReport(r);</span>
<span class="nc" id="L18189">            return;</span>
        }

        // steel yourself for attack
<span class="nc" id="L18193">        int steelRoll = Compute.d6(2);</span>
<span class="nc" id="L18194">        r = new Report(9020);</span>
<span class="nc" id="L18195">        r.subject = ae.getId();</span>
<span class="nc" id="L18196">        r.add(steelRoll);</span>

<span class="nc bnc" id="L18198" title="All 2 branches missed.">        if (steelRoll &gt;= 11) {</span>
<span class="nc" id="L18199">            r.choose(true);</span>
<span class="nc" id="L18200">            addReport(r);</span>
        } else {
<span class="nc" id="L18202">            r.choose(false);</span>
<span class="nc" id="L18203">            addReport(r);</span>
<span class="nc" id="L18204">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L18208" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L18209">            r = new Report(4200);</span>
<span class="nc" id="L18210">            r.subject = ae.getId();</span>
<span class="nc" id="L18211">            r.indent();</span>
<span class="nc" id="L18212">            addReport(r);</span>
<span class="nc" id="L18213">            return;</span>
        }

<span class="nc" id="L18216">        r = new Report(9030);</span>
<span class="nc" id="L18217">        r.subject = ae.getId();</span>
<span class="nc" id="L18218">        r.indent();</span>
<span class="nc" id="L18219">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18220">        r.newlines = 0;</span>
<span class="nc" id="L18221">        addReport(r);</span>

<span class="nc bnc" id="L18223" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18224">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L18225">            r = new Report(4225);</span>
<span class="nc" id="L18226">            r.subject = ae.getId();</span>
<span class="nc" id="L18227">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L18230">            r = new Report(4025);</span>
<span class="nc" id="L18231">            r.subject = ae.getId();</span>
<span class="nc" id="L18232">            r.add(toHit);</span>
<span class="nc" id="L18233">            r.add(roll);</span>
<span class="nc" id="L18234">            r.newlines = 0;</span>
        }
<span class="nc" id="L18236">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L18239" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18241">            r = new Report(4035);</span>
<span class="nc" id="L18242">            r.subject = ae.getId();</span>
<span class="nc" id="L18243">            addReport(r);</span>
        } else {
            // Resolve the damage.
<span class="nc" id="L18246">            resolveRamDamage((IAero) ae, te, toHit, glancing, throughFront);</span>
        }

<span class="nc" id="L18249">    }</span>

    /**
     * Handle a ramming attack's damage
     */
    private void resolveRamDamage(IAero aero, Entity te, ToHitData toHit,
                                  boolean glancing, boolean throughFront) {

<span class="nc" id="L18257">        Entity ae = (Entity) aero;</span>

<span class="nc" id="L18259">        int damage = RamAttackAction.getDamageFor(aero, te);</span>
<span class="nc" id="L18260">        int damageTaken = RamAttackAction.getDamageTakenBy(aero, te);</span>
<span class="nc bnc" id="L18261" title="All 2 branches missed.">        if (glancing) {</span>
            // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L18263" title="All 2 branches missed.">            damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
<span class="nc" id="L18264">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

        // are they capital scale?
<span class="nc bnc" id="L18268" title="All 2 branches missed.">        if (te.isCapitalScale()</span>
<span class="nc bnc" id="L18269" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L18270">            damage = (int) Math.floor(damage / 10.0);</span>
        }
<span class="nc bnc" id="L18272" title="All 2 branches missed.">        if (ae.isCapitalScale()</span>
<span class="nc bnc" id="L18273" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L18274">            damageTaken = (int) Math.floor(damageTaken / 10.0);</span>
        }

        Report r;

<span class="nc bnc" id="L18279" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L18280">            r = new Report(9015);</span>
<span class="nc" id="L18281">            r.subject = ae.getId();</span>
<span class="nc" id="L18282">            r.indent(1);</span>
<span class="nc" id="L18283">            addReport(r);</span>
        }

        // damage to attacker
<span class="nc" id="L18287">        r = new Report(4240);</span>
<span class="nc" id="L18288">        r.subject = ae.getId();</span>
<span class="nc" id="L18289">        r.add(damageTaken);</span>
<span class="nc" id="L18290">        r.indent();</span>
<span class="nc" id="L18291">        addReport(r);</span>

<span class="nc" id="L18293">        HitData hit = ae.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18294">                ae.sideTable(te.getPosition(), true));</span>
        // if the damage is greater than the initial armor then destroy the
        // entity
<span class="nc bnc" id="L18297" title="All 2 branches missed.">        if ((2 * ae.getOArmor(hit)) &lt; damageTaken) {</span>
<span class="nc" id="L18298">            addReport(destroyEntity(ae, &quot;by massive ramming damage&quot;, false));</span>
        } else {
<span class="nc" id="L18300">            addReport(damageEntity(ae, hit, damageTaken, false,</span>
                    DamageType.NONE, false, false, throughFront));
        }

<span class="nc" id="L18304">        r = new Report(4230);</span>
<span class="nc" id="L18305">        r.subject = ae.getId();</span>
<span class="nc" id="L18306">        r.add(damage);</span>
<span class="nc" id="L18307">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18308">        r.indent();</span>
<span class="nc" id="L18309">        addReport(r);</span>

<span class="nc" id="L18311">        hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc bnc" id="L18312" title="All 2 branches missed.">        if ((2 * te.getOArmor(hit)) &lt; damage) {</span>
<span class="nc" id="L18313">            addReport(destroyEntity(te, &quot;by massive ramming damage&quot;, false));</span>
        } else {
<span class="nc" id="L18315">            addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                    false, false, throughFront));
        }
<span class="nc" id="L18318">    }</span>

    /**
     * Handle a charge's damage
     */
    private void resolveChargeDamage(Entity ae, Entity te, ToHitData toHit, int direction) {
<span class="nc" id="L18324">        resolveChargeDamage(ae, te, toHit, direction, false, true, false);</span>
<span class="nc" id="L18325">    }</span>

    private void resolveChargeDamage(Entity ae, Entity te, ToHitData toHit, int direction,
                                     boolean glancing, boolean throughFront, boolean airmechRam) {

        // we hit...

<span class="nc" id="L18332">        PilotingRollData chargePSR = null;</span>
        // If we're upright, we may fall down.
<span class="nc bnc" id="L18334" title="All 4 branches missed.">        if (!ae.isProne() &amp;&amp; !airmechRam) {</span>
<span class="nc" id="L18335">            chargePSR = new PilotingRollData(ae.getId(), 2, &quot;charging&quot;);</span>
        }

        // Damage To Target
        int damage;

        // Damage to Attacker
        int damageTaken;

<span class="nc bnc" id="L18344" title="All 2 branches missed.">        if (airmechRam) {</span>
<span class="nc" id="L18345">            damage = AirmechRamAttackAction.getDamageFor(ae);</span>
<span class="nc" id="L18346">            damageTaken = AirmechRamAttackAction.getDamageTakenBy(ae, te);</span>
        } else {
<span class="nc" id="L18348">            damage = ChargeAttackAction.getDamageFor(ae, te, game.getOptions()</span>
<span class="nc" id="L18349">                    .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE), toHit.getMoS());</span>
<span class="nc" id="L18350">            damageTaken = ChargeAttackAction.getDamageTakenBy(ae, te, game</span>
<span class="nc" id="L18351">                    .getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE));</span>
        }
<span class="nc bnc" id="L18353" title="All 2 branches missed.">        if (ae.hasWorkingMisc(MiscType.F_RAM_PLATE)) {</span>
<span class="nc" id="L18354">            damage = (int) Math.ceil(damage * 1.5);</span>
<span class="nc" id="L18355">            damageTaken = (int) Math.floor(damageTaken * 0.5);</span>
        }
<span class="nc bnc" id="L18357" title="All 2 branches missed.">        if (glancing) {</span>
            // Glancing Blow rule doesn't state whether damage to attacker on charge
            // or DFA is halved as well, assume yes. TODO : Check with PM
<span class="nc bnc" id="L18360" title="All 2 branches missed.">            damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
<span class="nc" id="L18361">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }
<span class="nc" id="L18363">        boolean bDirect = false;</span>
<span class="nc" id="L18364">        int directBlowCritMod = toHit.getMoS() / 3;</span>
<span class="nc bnc" id="L18365" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)</span>
<span class="nc bnc" id="L18366" title="All 2 branches missed.">                &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1)) {</span>
<span class="nc" id="L18367">            damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L18368">            bDirect = false;</span>
        }

        // Is the target inside a building?
<span class="nc" id="L18372">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>

        // Which building takes the damage?
<span class="nc" id="L18375">        Building bldg = game.getBoard().getBuildingAt(te.getPosition());</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc" id="L18379">        int bldgAbsorbs = 0;</span>
<span class="nc bnc" id="L18380" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L18381">            bldgAbsorbs = bldg.getAbsorbtion(te.getPosition());</span>
        }

        Report r;

        // damage to attacker
<span class="nc" id="L18387">        r = new Report(4240);</span>
<span class="nc" id="L18388">        r.subject = ae.getId();</span>
<span class="nc" id="L18389">        r.add(damageTaken);</span>
<span class="nc" id="L18390">        r.indent();</span>
<span class="nc" id="L18391">        addReport(r);</span>

        // Charging vehicles check for possible motive system hits.
<span class="nc bnc" id="L18394" title="All 2 branches missed.">        if (ae instanceof Tank) {</span>
<span class="nc" id="L18395">            r = new Report(4241);</span>
<span class="nc" id="L18396">            r.indent();</span>
<span class="nc" id="L18397">            addReport(r);</span>
<span class="nc" id="L18398">            int side = Compute.targetSideTable(te, ae);</span>
<span class="nc" id="L18399">            int mod = ae.getMotiveSideMod(side);</span>
<span class="nc" id="L18400">            addReport(vehicleMotiveDamage((Tank)ae, mod));</span>
        }

<span class="nc bnc" id="L18403" title="All 2 branches missed.">        while (damageTaken &gt; 0) {</span>
            int cluster;
            HitData hit;
            // An airmech ramming attack does all damage to attacker's CT
<span class="nc bnc" id="L18407" title="All 2 branches missed.">            if (airmechRam) {</span>
<span class="nc" id="L18408">                cluster = damageTaken;</span>
<span class="nc" id="L18409">                hit = new HitData(Mech.LOC_CT);</span>
            } else {
<span class="nc" id="L18411">                cluster = Math.min(5, damageTaken);</span>
<span class="nc" id="L18412">                hit = ae.rollHitLocation(toHit.getHitTable(), ae.sideTable(te.getPosition()));</span>
            }
<span class="nc" id="L18414">            damageTaken -= cluster;</span>
<span class="nc" id="L18415">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L18416">            cluster = checkForSpikes(ae, hit.getLocation(), cluster, te, Mech.LOC_CT);</span>
<span class="nc" id="L18417">            addReport(damageEntity(ae, hit, cluster, false, DamageType.NONE,</span>
                    false, false, throughFront));
<span class="nc" id="L18419">        }</span>

        // Damage to target
<span class="nc bnc" id="L18422" title="All 2 branches missed.">        if (ae instanceof Mech) {</span>
<span class="nc" id="L18423">            int spikeDamage = 0;</span>
<span class="nc bnc" id="L18424" title="All 2 branches missed.">            for (int loc = 0; loc &lt; ae.locations(); loc++) {</span>
<span class="nc bnc" id="L18425" title="All 4 branches missed.">                if (((Mech) ae).locationIsTorso(loc) &amp;&amp; ae.hasWorkingMisc(MiscType.F_SPIKES, -1, loc)) {</span>
<span class="nc" id="L18426">                    spikeDamage += 2;</span>
                }
            }
<span class="nc bnc" id="L18429" title="All 2 branches missed.">            if (spikeDamage &gt; 0) {</span>
<span class="nc" id="L18430">                r = new Report(4335);</span>
<span class="nc" id="L18431">                r.indent(2);</span>
<span class="nc" id="L18432">                r.subject = ae.getId();</span>
<span class="nc" id="L18433">                r.add(spikeDamage);</span>
<span class="nc" id="L18434">                addReport(r);</span>
            }
<span class="nc" id="L18436">            damage += spikeDamage;</span>
        }
<span class="nc" id="L18438">        r = new Report(4230);</span>
<span class="nc" id="L18439">        r.subject = ae.getId();</span>
<span class="nc" id="L18440">        r.add(damage);</span>
<span class="nc" id="L18441">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18442">        r.indent();</span>
<span class="nc" id="L18443">        addReport(r);</span>

        // Vehicles that have *been* charged check for motive system damage,
        // too...
        // ...though VTOLs don't use that table and should lose their rotor
        // instead,
        // which would be handled as part of the damage already.
<span class="nc bnc" id="L18450" title="All 4 branches missed.">        if ((te instanceof Tank) &amp;&amp; !(te instanceof VTOL)) {</span>
<span class="nc" id="L18451">            r = new Report(4242);</span>
<span class="nc" id="L18452">            r.indent();</span>
<span class="nc" id="L18453">            addReport(r);</span>

<span class="nc" id="L18455">            int side = Compute.targetSideTable(ae, te);</span>
<span class="nc" id="L18456">            int mod = te.getMotiveSideMod(side);</span>
<span class="nc" id="L18457">            addReport(vehicleMotiveDamage((Tank)te, mod));</span>
        }

        // track any additional damage to the attacker due to the target having spikes
<span class="nc" id="L18461">        int spikeDamage = 0;</span>
<span class="nc bnc" id="L18462" title="All 2 branches missed.">        while (damage &gt; 0) {</span>
<span class="nc" id="L18463">            int cluster = Math.min(5, damage);</span>
            // Airmech ramming attacks do all damage to a single location
<span class="nc bnc" id="L18465" title="All 2 branches missed.">            if (airmechRam) {</span>
<span class="nc" id="L18466">                cluster = damage;</span>
            }
<span class="nc" id="L18468">            damage -= cluster;</span>
<span class="nc bnc" id="L18469" title="All 2 branches missed.">            if (bldgAbsorbs &gt; 0) {</span>
<span class="nc" id="L18470">                int toBldg = Math.min(bldgAbsorbs, cluster);</span>
<span class="nc" id="L18471">                cluster -= toBldg;</span>
<span class="nc" id="L18472">                addNewLines();</span>
<span class="nc" id="L18473">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L18474">                                                               te.getPosition());</span>
<span class="nc bnc" id="L18475" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L18476">                    report.subject = ae.getId();</span>
<span class="nc" id="L18477">                }</span>
<span class="nc" id="L18478">                addReport(buildingReport);</span>

                // some buildings scale remaining damage that is not absorbed
                // TODO : this isn't quite right for castles brian
<span class="nc" id="L18482">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
            }

            // A building may absorb the entire shot.
<span class="nc bnc" id="L18486" title="All 2 branches missed.">            if (cluster == 0) {</span>
<span class="nc" id="L18487">                r = new Report(4235);</span>
<span class="nc" id="L18488">                r.subject = ae.getId();</span>
<span class="nc" id="L18489">                r.addDesc(te);</span>
<span class="nc" id="L18490">                r.indent();</span>
<span class="nc" id="L18491">                addReport(r);</span>
            } else {
<span class="nc" id="L18493">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L18494">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc bnc" id="L18495" title="All 2 branches missed.">                if (bDirect) {</span>
<span class="nc" id="L18496">                    hit.makeDirectBlow(directBlowCritMod);</span>
                }
<span class="nc" id="L18498">                cluster = checkForSpikes(te, hit.getLocation(), cluster, ae, Mech.LOC_CT);</span>
<span class="nc" id="L18499">                addReport(damageEntity(te, hit, cluster, false,</span>
                                       DamageType.NONE, false, false, throughFront));
            }
<span class="nc" id="L18502">        }</span>

<span class="nc bnc" id="L18504" title="All 2 branches missed.">        if (airmechRam) {</span>
<span class="nc bnc" id="L18505" title="All 2 branches missed.">            if (!ae.isDoomed()) {</span>
<span class="nc" id="L18506">                PilotingRollData controlRoll = ae.getBasePilotingRoll();</span>
<span class="nc" id="L18507">                Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
<span class="nc" id="L18508">                r = new Report(9320);</span>
<span class="nc" id="L18509">                r.subject = ae.getId();</span>
<span class="nc" id="L18510">                r.addDesc(ae);</span>
<span class="nc" id="L18511">                r.add(&quot;successful ramming attack&quot;);</span>
<span class="nc" id="L18512">                reports.add(r);</span>
<span class="nc" id="L18513">                int diceRoll = Compute.d6(2);</span>
                // different reports depending on out-of-control status
<span class="nc" id="L18515">                r = new Report(9606);</span>
<span class="nc" id="L18516">                r.subject = ae.getId();</span>
<span class="nc" id="L18517">                r.add(controlRoll.getValueAsString());</span>
<span class="nc" id="L18518">                r.add(controlRoll.getDesc());</span>
<span class="nc" id="L18519">                r.add(diceRoll);</span>
<span class="nc" id="L18520">                r.newlines = 1;</span>
<span class="nc bnc" id="L18521" title="All 2 branches missed.">                if (diceRoll &lt; controlRoll.getValue()) {</span>
<span class="nc" id="L18522">                    r.choose(false);</span>
<span class="nc" id="L18523">                    reports.add(r);</span>
<span class="nc" id="L18524">                    crashAirMech(ae, controlRoll, reports);</span>
                } else {
<span class="nc" id="L18526">                    r.choose(true);</span>
<span class="nc" id="L18527">                    reports.addElement(r);</span>
<span class="nc bnc" id="L18528" title="All 2 branches missed.">                    if (ae instanceof LandAirMech) {</span>
<span class="nc" id="L18529">                        reports.addAll(landAirMech((LandAirMech)ae, ae.getPosition(), 1, ae.delta_distance));</span>
                    }
                }
<span class="nc" id="L18532">                addReport(reports);</span>
<span class="nc" id="L18533">            }</span>
        } else {
            // move attacker and target, if possible
<span class="nc" id="L18536">            Coords src = te.getPosition();</span>
<span class="nc" id="L18537">            Coords dest = src.translated(direction);</span>

<span class="nc bnc" id="L18539" title="All 2 branches missed.">            if (Compute.isValidDisplacement(game, te.getId(), te.getPosition(),</span>
                                            direction)) {
<span class="nc" id="L18541">                addNewLines();</span>
<span class="nc" id="L18542">                addReport(doEntityDisplacement(te, src, dest, new PilotingRollData(</span>
<span class="nc" id="L18543">                        te.getId(), 2, &quot;was charged&quot;)));</span>
<span class="nc" id="L18544">                addReport(doEntityDisplacement(ae, ae.getPosition(), src, chargePSR));</span>
            }

<span class="nc" id="L18547">            addNewLines();</span>
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L18552" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L18553">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L18556">    } // End private void resolveChargeDamage( Entity, Entity, ToHitData )</span>

    /**
     * Checks whether the location has spikes, and if so handles the damage to the
     * attack and returns the reduced damage. Locations without spikes return the
     * original damage amount.
     *
     * @param target            The target of a physical attack
     * @param targetLocation    The location that was hit
     * @param damage            The amount of damage dealt to the target
     * @param attacker          The attacker
     * @param attackerLocation  The location on the attacker that is damaged if the
     *                          target has spikes. Entity.LOC_NONE if the attacker
     *                          can't be damaged by spikes in this attack.
     * @return          The damage after applying any reduction due to spikes
     */
    private int checkForSpikes(Entity target, int targetLocation, int damage,
                               Entity attacker, int attackerLocation) {
<span class="nc" id="L18574">        return checkForSpikes(target, targetLocation, damage, attacker, attackerLocation, Entity.LOC_NONE);</span>
    }

    /**
     * Checks whether the location has spikes, and if so handles the damage to the
     * attack and returns the reduced damage. Locations without spikes return the
     * original damage amount.
     *
     * @param target            The target of a physical attack
     * @param targetLocation    The location that was hit
     * @param damage            The amount of damage dealt to the target
     * @param attacker          The attacker
     * @param attackerLocation  The location on the attacker that is damaged if the
     *                          target has spikes. Entity.LOC_NONE if the attacker
     *                          can't be damaged by spikes in this attack.
     * @param attackerLocation2 If not Entity.LOC_NONE, the damage to the attacker
     *                          will be split between two locations.
     * @return          The damage after applying any reduction due to spikes
     */
    private int checkForSpikes(Entity target, int targetLocation, int damage,
                               Entity attacker, int attackerLocation, int attackerLocation2) {
<span class="nc bnc" id="L18595" title="All 2 branches missed.">        if (target.hasWorkingMisc(MiscType.F_SPIKES, -1, targetLocation)) {</span>
            Report r;
<span class="nc bnc" id="L18597" title="All 2 branches missed.">            if (damage == 0) {</span>
                // Only show damage to attacker (push attack)
<span class="nc" id="L18599">                r = new Report(4333);</span>
<span class="nc bnc" id="L18600" title="All 2 branches missed.">            } else if (attackerLocation != Entity.LOC_NONE) {</span>
                // Show damage reduction and damage to attacker
<span class="nc" id="L18602">                r = new Report(4330);</span>
            } else {
                // Only show damage reduction (club/physical weapon attack)
<span class="nc" id="L18605">                r = new Report(4331);</span>
            }
<span class="nc" id="L18607">            r.indent(2);</span>
<span class="nc" id="L18608">            r.subject = target.getId();</span>
<span class="nc" id="L18609">            addReport(r);</span>
            // An attack that deals zero damage can still damage the attacker in the case of a push
<span class="nc bnc" id="L18611" title="All 2 branches missed.">            if (attackerLocation != Entity.LOC_NONE) {</span>
                // Spikes also protect from retaliatory spike damage
<span class="nc bnc" id="L18613" title="All 2 branches missed.">                if (attacker.hasWorkingMisc(MiscType.F_SPIKES, -1, attackerLocation)) {</span>
<span class="nc" id="L18614">                    r = new Report(4332);</span>
<span class="nc" id="L18615">                    r.indent(2);</span>
<span class="nc" id="L18616">                    r.subject = attacker.getId();</span>
<span class="nc" id="L18617">                    addReport(r);</span>
<span class="nc bnc" id="L18618" title="All 2 branches missed.">                } else if (attackerLocation2 == Entity.LOC_NONE) {</span>
<span class="nc" id="L18619">                    addReport(damageEntity(attacker, new HitData(attackerLocation), 2, false,</span>
                            DamageType.NONE,false, false, false));
                } else {
<span class="nc" id="L18622">                    addReport(damageEntity(attacker, new HitData(attackerLocation), 1, false,</span>
                            DamageType.NONE, false, false, false));
<span class="nc" id="L18624">                    addReport(damageEntity(attacker, new HitData(attackerLocation2), 1, false,</span>
                            DamageType.NONE, false, false, false));
                }
            }
<span class="nc" id="L18628">            return Math.max(1, damage - 4);</span>
        }
<span class="nc" id="L18630">        return damage;</span>
    }

    /**
     * End-phase checks for laid explosives; check whether explosives are
     * touched off, or if we should report laying explosives
     */
    private void checkLayExplosives() {
        // Report continuing explosive work
<span class="nc bnc" id="L18639" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L18640" title="All 2 branches missed.">            if (!(e instanceof Infantry)) {</span>
<span class="nc" id="L18641">                continue;</span>
            }
<span class="nc" id="L18643">            Infantry inf = (Infantry) e;</span>
<span class="nc bnc" id="L18644" title="All 2 branches missed.">            if (inf.turnsLayingExplosives &gt; 0) {</span>
<span class="nc" id="L18645">                Report r = new Report(4271);</span>
<span class="nc" id="L18646">                r.subject = inf.getId();</span>
<span class="nc" id="L18647">                r.addDesc(inf);</span>
<span class="nc" id="L18648">                addReport(r);</span>
            }
<span class="nc" id="L18650">        }</span>
        // Check for touched-off explosives
<span class="nc" id="L18652">        Vector&lt;Building&gt; updatedBuildings = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L18653" title="All 2 branches missed.">        for (DemolitionCharge charge : explodingCharges) {</span>
<span class="nc" id="L18654">            Building bldg = game.getBoard().getBuildingAt(charge.pos);</span>
<span class="nc bnc" id="L18655" title="All 2 branches missed.">            if (bldg == null) { // Shouldn't happen...</span>
<span class="nc" id="L18656">                continue;</span>
            }
<span class="nc" id="L18658">            bldg.removeDemolitionCharge(charge);</span>
<span class="nc" id="L18659">            updatedBuildings.add(bldg);</span>
<span class="nc" id="L18660">            Report r = new Report(4272, Report.PUBLIC);</span>
<span class="nc" id="L18661">            r.add(bldg.getName());</span>
<span class="nc" id="L18662">            addReport(r);</span>
<span class="nc" id="L18663">            Vector&lt;Report&gt; dmgReports = damageBuilding(bldg, charge.damage,</span>
                    &quot; explodes for &quot;, charge.pos);
<span class="nc bnc" id="L18665" title="All 2 branches missed.">            for (Report rep : dmgReports) {</span>
<span class="nc" id="L18666">                rep.indent();</span>
<span class="nc" id="L18667">                addReport(rep);</span>
<span class="nc" id="L18668">            }</span>
<span class="nc" id="L18669">        }</span>
<span class="nc" id="L18670">        explodingCharges.clear();</span>
<span class="nc" id="L18671">        sendChangedBuildings(updatedBuildings);</span>
<span class="nc" id="L18672">    }</span>

    private void resolveLayExplosivesAttack(PhysicalResult pr) {
<span class="nc" id="L18675">        final LayExplosivesAttackAction laa = (LayExplosivesAttackAction) pr.aaa;</span>
<span class="nc" id="L18676">        final Entity ae = game.getEntity(laa.getEntityId());</span>
<span class="nc bnc" id="L18677" title="All 2 branches missed.">        if (ae instanceof Infantry) {</span>
<span class="nc" id="L18678">            Infantry inf = (Infantry) ae;</span>
<span class="nc bnc" id="L18679" title="All 2 branches missed.">            if (inf.turnsLayingExplosives &lt; 0) {</span>
<span class="nc" id="L18680">                inf.turnsLayingExplosives = 0;</span>
<span class="nc" id="L18681">                Report r = new Report(4270);</span>
<span class="nc" id="L18682">                r.subject = inf.getId();</span>
<span class="nc" id="L18683">                r.addDesc(inf);</span>
<span class="nc" id="L18684">                addReport(r);</span>
<span class="nc" id="L18685">            } else {</span>
<span class="nc" id="L18686">                Building building = game.getBoard().getBuildingAt(ae.getPosition());</span>
<span class="nc bnc" id="L18687" title="All 2 branches missed.">                if (building != null) {</span>
<span class="nc" id="L18688">                    building.addDemolitionCharge(ae.getOwner().getId(), pr.damage, ae.getPosition());</span>
<span class="nc" id="L18689">                    Report r = new Report(4275);</span>
<span class="nc" id="L18690">                    r.subject = inf.getId();</span>
<span class="nc" id="L18691">                    r.addDesc(inf);</span>
<span class="nc" id="L18692">                    r.add(pr.damage);</span>
<span class="nc" id="L18693">                    addReport(r);</span>
                    // Update clients with this info
<span class="nc" id="L18695">                    Vector&lt;Building&gt; updatedBuildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L18696">                    updatedBuildings.add(building);</span>
<span class="nc" id="L18697">                    sendChangedBuildings(updatedBuildings);</span>
                }
<span class="nc" id="L18699">                inf.turnsLayingExplosives = -1;</span>
            }
        }
<span class="nc" id="L18702">    }</span>

    /**
     * Handle a death from above attack
     */
    private void resolveDfaAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18708">        final DfaAttackAction daa = (DfaAttackAction) pr.aaa;</span>
<span class="nc" id="L18709">        final Entity ae = game.getEntity(daa.getEntityId());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L18712" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L18713">            return;</span>
        }

<span class="nc" id="L18716">        final IHex aeHex = game.getBoard().getHex(ae.getPosition());</span>
<span class="nc" id="L18717">        final IHex teHex = game.getBoard().getHex(daa.getTargetPos());</span>
<span class="nc" id="L18718">        final Targetable target = game.getTarget(daa.getTargetType(), daa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L18720">        int damage = pr.damage;</span>
<span class="nc" id="L18721">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18722">        int roll = pr.roll;</span>
<span class="nc" id="L18723">        Entity te = null;</span>
<span class="nc bnc" id="L18724" title="All 2 branches missed.">        if ((target != null)</span>
<span class="nc bnc" id="L18725" title="All 2 branches missed.">            &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
            // Lets re-write around that horrible hack that was here before.
            // So instead of asking if a specific location is wet and praying
            // that it won't cause an NPE...
            // We'll check 1) if the hex has water, and 2) if it's deep enough
            // to cover the unit in question at its current elevation.
            // It's especially important to make sure it's done this way,
            // because some units (Sylph, submarines) can be at ANY elevation
            // underwater, and VTOLs can be well above the surface.
<span class="nc" id="L18734">            te = (Entity) target;</span>
<span class="nc" id="L18735">            IHex hex = game.getBoard().getHex(te.getPosition());</span>
<span class="nc bnc" id="L18736" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L18737" title="All 2 branches missed.">                if (te.relHeight() &lt; 0) {</span>
<span class="nc" id="L18738">                    damage = (int) Math.ceil(damage * 0.5f);</span>
                }
            }
        }
<span class="nc" id="L18742">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18743" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18744">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L18746" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L18747" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>
        // Set Margin of Success/Failure.
<span class="nc" id="L18749">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L18750" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L18751" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

<span class="nc" id="L18755">        final int direction = ae.getFacing();</span>

<span class="nc bnc" id="L18757" title="All 2 branches missed.">        if (lastEntityId != daa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18759">            r = new Report(4005);</span>
<span class="nc" id="L18760">            r.subject = ae.getId();</span>
<span class="nc" id="L18761">            r.addDesc(ae);</span>
<span class="nc" id="L18762">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18766" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L18767" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18768">            r = new Report(4245);</span>
<span class="nc" id="L18769">            r.subject = ae.getId();</span>
<span class="nc" id="L18770">            r.indent();</span>
<span class="nc" id="L18771">            addReport(r);</span>
            // entity isn't DFAing any more
<span class="nc" id="L18773">            ae.setDisplacementAttack(null);</span>
<span class="nc bnc" id="L18774" title="All 2 branches missed.">            if (ae.isProne()) {</span>
                // attacker prone during weapons phase
<span class="nc" id="L18776">                addReport(doEntityFall(ae, daa.getTargetPos(), 2, 3,</span>
<span class="nc" id="L18777">                        ae.getBasePilotingRoll(), false, false));</span>

            } else {
                // same effect as successful DFA
<span class="nc" id="L18781">                ae.setElevation(ae.calcElevation(aeHex, teHex, 0, false, false));</span>
<span class="nc" id="L18782">                addReport(doEntityDisplacement(ae, ae.getPosition(),</span>
<span class="nc" id="L18783">                        daa.getTargetPos(), new PilotingRollData(ae.getId(), 4,</span>
                                &quot;executed death from above&quot;)));
            }
<span class="nc" id="L18786">            return;</span>
        }

<span class="nc" id="L18789">        r = new Report(4246);</span>
<span class="nc" id="L18790">        r.subject = ae.getId();</span>
<span class="nc" id="L18791">        r.indent();</span>
<span class="nc" id="L18792">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18793">        r.newlines = 0;</span>
<span class="nc" id="L18794">        addReport(r);</span>

        // target still in the same position?
<span class="nc bnc" id="L18797" title="All 2 branches missed.">        if (!target.getPosition().equals(daa.getTargetPos())) {</span>
<span class="nc" id="L18798">            r = new Report(4215);</span>
<span class="nc" id="L18799">            r.subject = ae.getId();</span>
<span class="nc" id="L18800">            addReport(r);</span>
            // entity isn't DFAing any more
<span class="nc" id="L18802">            ae.setDisplacementAttack(null);</span>
<span class="nc" id="L18803">            addReport(doEntityFallsInto(ae, ae.getElevation(), ae.getPosition(), daa.getTargetPos(),</span>
<span class="nc" id="L18804">                    ae.getBasePilotingRoll(), true));</span>
<span class="nc" id="L18805">            return;</span>
        }

        // hack: if the attacker's prone, or incapacitated, fudge the roll
<span class="nc bnc" id="L18809" title="All 4 branches missed.">        if (ae.isProne() || !ae.isActive()) {</span>
<span class="nc" id="L18810">            roll = -12;</span>
<span class="nc" id="L18811">            r = new Report(4250);</span>
<span class="nc" id="L18812">            r.subject = ae.getId();</span>
<span class="nc" id="L18813">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18814">            r.newlines--;</span>
<span class="nc" id="L18815">            addReport(r);</span>
<span class="nc bnc" id="L18816" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L18817">            roll = -12;</span>
<span class="nc" id="L18818">            r = new Report(4255);</span>
<span class="nc" id="L18819">            r.subject = ae.getId();</span>
<span class="nc" id="L18820">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18821">            addReport(r);</span>
<span class="nc bnc" id="L18822" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18823">            r = new Report(4260);</span>
<span class="nc" id="L18824">            r.subject = ae.getId();</span>
<span class="nc" id="L18825">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18826">            addReport(r);</span>
<span class="nc" id="L18827">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L18830">            r = new Report(4025);</span>
<span class="nc" id="L18831">            r.subject = ae.getId();</span>
<span class="nc" id="L18832">            r.add(toHit);</span>
<span class="nc" id="L18833">            r.add(roll);</span>
<span class="nc" id="L18834">            r.newlines = 0;</span>
<span class="nc" id="L18835">            addReport(r);</span>
<span class="nc bnc" id="L18836" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L18837">                r = new Report(3186);</span>
<span class="nc" id="L18838">                r.subject = ae.getId();</span>
<span class="nc" id="L18839">                r.newlines = 0;</span>
<span class="nc" id="L18840">                addReport(r);</span>
            }
<span class="nc bnc" id="L18842" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18843">                r = new Report(3189);</span>
<span class="nc" id="L18844">                r.subject = ae.getId();</span>
<span class="nc" id="L18845">                r.newlines = 0;</span>
<span class="nc" id="L18846">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L18852" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L18853">            Coords dest = te.getPosition();</span>
<span class="nc" id="L18854">            Coords targetDest = Compute.getPreferredDisplacement(game, te.getId(), dest, direction);</span>
            // miss
<span class="nc" id="L18856">            r = new Report(4035);</span>
<span class="nc" id="L18857">            r.subject = ae.getId();</span>
<span class="nc" id="L18858">            addReport(r);</span>
<span class="nc bnc" id="L18859" title="All 2 branches missed.">            if (targetDest != null) {</span>
                // move target to preferred hex
<span class="nc" id="L18861">                addReport(doEntityDisplacement(te, dest, targetDest, null));</span>
                // attacker falls into destination hex
<span class="nc" id="L18863">                r = new Report(4265);</span>
<span class="nc" id="L18864">                r.subject = ae.getId();</span>
<span class="nc" id="L18865">                r.addDesc(ae);</span>
<span class="nc" id="L18866">                r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L18867">                r.indent();</span>
<span class="nc" id="L18868">                addReport(r);</span>
                // entity isn't DFAing any more
<span class="nc" id="L18870">                ae.setDisplacementAttack(null);</span>
<span class="nc" id="L18871">                addReport(doEntityFall(ae, dest, 2, 3, ae.getBasePilotingRoll(),</span>
                        false, false), 1);
<span class="nc" id="L18873">                Entity violation = Compute.stackingViolation(game, ae.getId(), dest);</span>
<span class="nc bnc" id="L18874" title="All 2 branches missed.">                if (violation != null) {</span>
                    // target gets displaced
<span class="nc" id="L18876">                    targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L18877">                            violation.getId(), dest, direction);</span>
<span class="nc" id="L18878">                    vPhaseReport.addAll(doEntityDisplacement(violation, dest,</span>
<span class="nc" id="L18879">                            targetDest, new PilotingRollData(violation.getId(),</span>
                                    0, &quot;domino effect&quot;)));
                    // Update the violating entity's position on the client.
<span class="nc bnc" id="L18882" title="All 2 branches missed.">                    if (!game.getOutOfGameEntitiesVector().contains(violation)) {</span>
<span class="nc" id="L18883">                        entityUpdate(violation.getId());</span>
                    }
                }
<span class="nc" id="L18886">            } else {</span>
                // attacker destroyed
                // Tanks suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L18890">                addReport(destroyEntity(ae, &quot;impossible displacement&quot;,</span>
                        ae instanceof Mech, ae instanceof Mech));
            }
<span class="nc" id="L18893">            return;</span>
        }

        // we hit...

<span class="nc" id="L18898">        r = new Report(4040);</span>
<span class="nc" id="L18899">        r.subject = ae.getId();</span>
<span class="nc" id="L18900">        addReport(r);</span>

<span class="nc" id="L18902">        Coords dest = target.getPosition();</span>

        // Can't DFA a target inside of a building.
<span class="nc" id="L18905">        int damageTaken = DfaAttackAction.getDamageTakenBy(ae);</span>

        // Targeting a building.
<span class="nc bnc" id="L18908" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L18909" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>

            // Which building takes the damage?
<span class="nc" id="L18912">            Building bldg = game.getBoard().getBuildingAt(daa.getTargetPos());</span>
            
            // The building takes the full brunt of the attack.
<span class="nc" id="L18915">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L18916" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L18917">                report.subject = ae.getId();</span>
<span class="nc" id="L18918">            }</span>
<span class="nc" id="L18919">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L18922">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>
<span class="nc" id="L18923">        } else { // Target isn't building.</span>
<span class="nc bnc" id="L18924" title="All 4 branches missed.">            if (glancing &amp;&amp; (te != null)) {</span>
<span class="nc bnc" id="L18925" title="All 2 branches missed.">                damage = (int) (te.isConventionalInfantry() ? Math.ceil(damage / 2.0) : Math.floor(damage / 2.0));</span>
            }
<span class="nc bnc" id="L18927" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18928">                damage += toHit.getMoS() / 3;</span>
            }
            // damage target
<span class="nc" id="L18931">            r = new Report(4230);</span>
<span class="nc" id="L18932">            r.subject = ae.getId();</span>
<span class="nc" id="L18933">            r.add(damage);</span>
<span class="nc" id="L18934">            r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18935">            r.indent(2);</span>
<span class="nc" id="L18936">            addReport(r);</span>

<span class="nc bnc" id="L18938" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L18939">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L18940">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L18941">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc bnc" id="L18942" title="All 2 branches missed.">                if (directBlow) {</span>
<span class="nc" id="L18943">                    hit.makeDirectBlow(toHit.getMoS() / 3);</span>
                }
<span class="nc" id="L18945">                damage -= cluster;</span>
<span class="nc" id="L18946">                cluster = checkForSpikes(te, hit.getLocation(), cluster, ae, Mech.LOC_LLEG, Mech.LOC_RLEG);</span>
<span class="nc" id="L18947">                addReport(damageEntity(te, hit, cluster, false,</span>
                                       DamageType.NONE, false, false, throughFront));
<span class="nc" id="L18949">            }</span>
<span class="nc bnc" id="L18950" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L18952">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
            // Target entities are pushed away or destroyed.
<span class="nc" id="L18957">            Coords targetDest = Compute.getValidDisplacement(game, te.getId(), dest, direction);</span>
<span class="nc bnc" id="L18958" title="All 2 branches missed.">            if (targetDest != null) {</span>
<span class="nc" id="L18959">                addReport(doEntityDisplacement(te, dest, targetDest,</span>
<span class="nc" id="L18960">                        new PilotingRollData(te.getId(), 2, &quot;hit by death from above&quot;)));</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L18965">                addReport(destroyEntity(te, &quot;impossible displacement&quot;,</span>
                        te instanceof Mech, te instanceof Mech));
            }

        }

<span class="nc bnc" id="L18971" title="All 2 branches missed.">        if (glancing) {</span>
            // Glancing Blow rule doesn't state whether damage to attacker on charge
            // or DFA is halved as well, assume yes. TODO : Check with PM
<span class="nc" id="L18974">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

<span class="nc bnc" id="L18977" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_POS_REINFORCED_LEGS)) {</span>
<span class="nc" id="L18978">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

        // damage attacker
<span class="nc" id="L18982">        r = new Report(4240);</span>
<span class="nc" id="L18983">        r.subject = ae.getId();</span>
<span class="nc" id="L18984">        r.add(damageTaken);</span>
<span class="nc" id="L18985">        r.indent(2);</span>
<span class="nc" id="L18986">        addReport(r);</span>
<span class="nc bnc" id="L18987" title="All 2 branches missed.">        while (damageTaken &gt; 0) {</span>
<span class="nc" id="L18988">            int cluster = Math.min(5, damageTaken);</span>
<span class="nc" id="L18989">            HitData hit = ae.rollHitLocation(ToHitData.HIT_KICK, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L18990">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L18991">            addReport(damageEntity(ae, hit, cluster));</span>
<span class="nc" id="L18992">            damageTaken -= cluster;</span>
<span class="nc" id="L18993">        }</span>

<span class="nc bnc" id="L18995" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_NEG_WEAK_LEGS)) {</span>
<span class="nc" id="L18996">            addNewLines();</span>
<span class="nc" id="L18997">            addReport(criticalEntity(ae, Mech.LOC_LLEG, false, 0, 0));</span>
<span class="nc" id="L18998">            addNewLines();</span>
<span class="nc" id="L18999">            addReport(criticalEntity(ae, Mech.LOC_RLEG, false, 0, 0));</span>
<span class="nc bnc" id="L19000" title="All 2 branches missed.">            if (ae instanceof QuadMech) {</span>
<span class="nc" id="L19001">                addNewLines();</span>
<span class="nc" id="L19002">                addReport(criticalEntity(ae, Mech.LOC_LARM, false, 0, 0));</span>
<span class="nc" id="L19003">                addNewLines();</span>
<span class="nc" id="L19004">                addReport(criticalEntity(ae, Mech.LOC_RARM, false, 0, 0));</span>
            }
        }

<span class="nc" id="L19008">        addNewLines();</span>

        // That's it for target buildings.
<span class="nc bnc" id="L19011" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L19012" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
<span class="nc" id="L19013">            return;</span>
        }
<span class="nc" id="L19015">        ae.setElevation(ae.calcElevation(aeHex, teHex, 0, false, false));</span>
        // HACK: to avoid automatic falls, displace from dest to dest
<span class="nc" id="L19017">        addReport(doEntityDisplacement(ae, dest, dest, new PilotingRollData(</span>
<span class="nc" id="L19018">                ae.getId(), 4, &quot;executed death from above&quot;)));</span>

        // entity isn't DFAing any more
<span class="nc" id="L19021">        ae.setDisplacementAttack(null);</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L19025" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L19026">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L19028">    }</span>

    /**
     * Get the Kick or Push PSR, modified by weight class
     *
     * @param psrEntity The &lt;code&gt;Entity&lt;/code&gt; that should make a PSR
     * @param attacker  The attacking &lt;code&gt;Entity&gt;&lt;/code&gt;
     * @param target    The target &lt;code&gt;Entity&lt;/code&gt;
     * @return The &lt;code&gt;PilotingRollData&lt;/code&gt;
     */
    private PilotingRollData getKickPushPSR(Entity psrEntity, Entity attacker,
                                            Entity target, String reason) {
<span class="nc" id="L19040">        int mod = 0;</span>
<span class="nc" id="L19041">        PilotingRollData psr = new PilotingRollData(psrEntity.getId(), mod,</span>
                                                    reason);
<span class="nc bnc" id="L19043" title="All 2 branches missed.">        if (psrEntity.hasQuirk(OptionsConstants.QUIRK_POS_STABLE)) {</span>
<span class="nc" id="L19044">            psr.addModifier(-1, &quot;stable&quot;, false);</span>
        }
<span class="nc bnc" id="L19046" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_PHYSICAL_PSR)) {</span>

<span class="nc bnc" id="L19048" title="All 5 branches missed.">            switch (target.getWeightClass()) {</span>
                case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L19050">                    mod = 1;</span>
<span class="nc" id="L19051">                    break;</span>
                case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L19053">                    mod = 0;</span>
<span class="nc" id="L19054">                    break;</span>
                case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L19056">                    mod = -1;</span>
<span class="nc" id="L19057">                    break;</span>
                case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L19059">                    mod = -2;</span>
                    break;
            }
            String reportStr;
<span class="nc bnc" id="L19063" title="All 2 branches missed.">            if (mod &gt; 0) {</span>
<span class="nc" id="L19064">                reportStr = (&quot;weight class modifier +&quot;) + mod;</span>
            } else {
<span class="nc" id="L19066">                reportStr = (&quot;weight class modifier &quot;) + mod;</span>
            }
<span class="nc" id="L19068">            psr.addModifier(mod, reportStr, false);</span>
        }
<span class="nc" id="L19070">        return psr;</span>
    }

    /**
     * Each mech sinks the amount of heat appropriate to its current heat
     * capacity.
     */
    private void resolveHeat() {
        Report r;
        // Heat phase header
<span class="nc" id="L19080">        addReport(new Report(5000, Report.PUBLIC));</span>
<span class="nc bnc" id="L19081" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L19082">            Entity entity = i.next();</span>
<span class="nc bnc" id="L19083" title="All 4 branches missed.">            if ((null == entity.getPosition()) &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L19084">                continue;</span>
            }
<span class="nc" id="L19086">            IHex entityHex = game.getBoard().getHex(entity.getPosition());</span>

<span class="nc" id="L19088">            int hotDogMod = 0;</span>
<span class="nc bnc" id="L19089" title="All 2 branches missed.">            if (entity.hasAbility(OptionsConstants.PILOT_HOT_DOG)) {</span>
<span class="nc" id="L19090">                hotDogMod = 1;</span>
            }
<span class="nc bnc" id="L19092" title="All 2 branches missed.">            if (entity.getTaserInterferenceHeat()) {</span>
<span class="nc" id="L19093">                entity.heatBuildup += 5;</span>
            }
<span class="nc bnc" id="L19095" title="All 4 branches missed.">            if (entity.hasDamagedRHS() &amp;&amp; entity.weaponFired()) {</span>
<span class="nc" id="L19096">                entity.heatBuildup += 1;</span>
            }
<span class="nc bnc" id="L19098" title="All 6 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech)entity).hasDamagedCoolantSystem() &amp;&amp; entity.weaponFired()) {</span>
<span class="nc" id="L19099">                entity.heatBuildup += 1;</span>
            }

<span class="nc" id="L19102">            int radicalHSBonus = 0;</span>
<span class="nc" id="L19103">            Vector&lt;Report&gt; rhsReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L19104" title="All 2 branches missed.">            if (entity.hasActivatedRadicalHS()) {</span>
<span class="nc bnc" id="L19105" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L19106">                    radicalHSBonus = ((Mech) entity).getActiveSinks();</span>
<span class="nc bnc" id="L19107" title="All 2 branches missed.">                } else if (entity instanceof Aero) {</span>
<span class="nc" id="L19108">                    radicalHSBonus = ((Aero) entity).getHeatSinks();</span>
                } else {
<span class="nc" id="L19110">                    MegaMek.getLogger().error(&quot;Radical heat sinks mounted on non-mech, non-aero Entity!&quot;);</span>
                }
<span class="nc" id="L19112">                int rhsRoll = Compute.d6(2);</span>
                int targetNumber;
<span class="nc bnc" id="L19114" title="All 7 branches missed.">                switch (entity.getConsecutiveRHSUses()) {</span>
                    case 0:
<span class="nc" id="L19116">                        targetNumber = 2;</span>
<span class="nc" id="L19117">                        break;</span>
                    case 1:
<span class="nc" id="L19119">                        targetNumber = 3;</span>
<span class="nc" id="L19120">                        break;</span>
                    case 2:
<span class="nc" id="L19122">                        targetNumber = 5;</span>
<span class="nc" id="L19123">                        break;</span>
                    case 3:
<span class="nc" id="L19125">                        targetNumber = 7;</span>
<span class="nc" id="L19126">                        break;</span>
                    case 4:
<span class="nc" id="L19128">                        targetNumber = 10;</span>
<span class="nc" id="L19129">                        break;</span>
                    case 5:
<span class="nc" id="L19131">                        targetNumber = 11;</span>
<span class="nc" id="L19132">                        break;</span>
                    case 6:
                    default:
<span class="nc" id="L19135">                        targetNumber = TargetRoll.AUTOMATIC_FAIL;</span>
                        break;
                }
<span class="nc" id="L19138">                entity.setConsecutiveRHSUses(entity.getConsecutiveRHSUses() + 1);</span>

                // RHS activation report
<span class="nc" id="L19141">                r = new Report(5540);</span>
<span class="nc" id="L19142">                r.subject = entity.getId();</span>
<span class="nc" id="L19143">                r.indent();</span>
<span class="nc" id="L19144">                r.addDesc(entity);</span>
<span class="nc" id="L19145">                r.add(radicalHSBonus);</span>
<span class="nc" id="L19146">                rhsReports.add(r);</span>

<span class="nc bnc" id="L19148" title="All 2 branches missed.">                boolean rhsFailure = rhsRoll &lt; targetNumber;</span>
<span class="nc" id="L19149">                r = new Report(5541);</span>
<span class="nc" id="L19150">                r.indent(2);</span>
<span class="nc" id="L19151">                r.subject = entity.getId();</span>
<span class="nc" id="L19152">                r.add(targetNumber);</span>
<span class="nc" id="L19153">                r.add(rhsRoll);</span>
<span class="nc" id="L19154">                r.choose(rhsFailure);</span>
<span class="nc" id="L19155">                rhsReports.add(r);</span>

<span class="nc bnc" id="L19157" title="All 2 branches missed.">                if (rhsFailure) {</span>
<span class="nc" id="L19158">                    entity.setHasDamagedRHS(true);</span>
<span class="nc" id="L19159">                    int loc = Entity.LOC_NONE;</span>
<span class="nc bnc" id="L19160" title="All 2 branches missed.">                    for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19161" title="All 2 branches missed.">                        if (m.getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L19162">                            loc = m.getLocation();</span>
<span class="nc" id="L19163">                            m.setDestroyed(true);</span>
<span class="nc" id="L19164">                            break;</span>
                        }
<span class="nc" id="L19166">                    }</span>
<span class="nc bnc" id="L19167" title="All 2 branches missed.">                    if (loc == Entity.LOC_NONE) {</span>
<span class="nc" id="L19168">                        throw new IllegalStateException(&quot;Server.resolveHeat(): &quot; +</span>
                                &quot;Could not find Radical Heat Sink mount on unit that used RHS!&quot;);
                    }
<span class="nc bnc" id="L19171" title="All 2 branches missed.">                    for (int s = 0; s &lt; entity.getNumberOfCriticals(loc); s++) {</span>
<span class="nc" id="L19172">                        CriticalSlot slot = entity.getCritical(loc, s);</span>
<span class="nc bnc" id="L19173" title="All 2 branches missed.">                        if ((slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L19174" title="All 2 branches missed.">                                &amp;&amp; slot.getMount().getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L19175">                            slot.setHit(true);</span>
<span class="nc" id="L19176">                            break;</span>
                        }
                    }
                }
            }

            // put in ASF heat build-up first because there are few differences
<span class="nc bnc" id="L19183" title="All 4 branches missed.">            if (entity instanceof Aero &amp;&amp; !(entity instanceof ConvFighter)) {</span>
<span class="nc" id="L19184">                ServerHelper.resolveAeroHeat(game, entity, vPhaseReport, rhsReports, radicalHSBonus, hotDogMod, this);</span>
<span class="nc" id="L19185">                continue;</span>
            }

            // heat doesn't matter for non-mechs
<span class="nc bnc" id="L19189" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L19190">                entity.heat = 0;</span>
<span class="nc" id="L19191">                entity.heatBuildup = 0;</span>
<span class="nc" id="L19192">                entity.heatFromExternal = 0;</span>
<span class="nc" id="L19193">                entity.coolFromExternal = 0;</span>

<span class="nc bnc" id="L19195" title="All 2 branches missed.">                if (entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L19196">                    doFlamingDamage(entity);</span>
                }
<span class="nc bnc" id="L19198" title="All 2 branches missed.">                if (entity.getTaserShutdownRounds() == 0) {</span>
<span class="nc" id="L19199">                    entity.setBATaserShutdown(false);</span>
<span class="nc bnc" id="L19200" title="All 4 branches missed.">                    if (entity.isShutDown() &amp;&amp; !entity.isManualShutdown()</span>
<span class="nc bnc" id="L19201" title="All 2 branches missed.">                            &amp;&amp; (entity.getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc" id="L19202">                        entity.setShutDown(false);</span>
<span class="nc" id="L19203">                        r = new Report(5045);</span>
<span class="nc" id="L19204">                        r.subject = entity.getId();</span>
<span class="nc" id="L19205">                        r.addDesc(entity);</span>
<span class="nc" id="L19206">                        addReport(r);</span>
                    }
<span class="nc bnc" id="L19208" title="All 2 branches missed.">                } else if (entity.isBATaserShutdown()) {</span>
                    // if we're shutdown by a BA taser, we might activate again
<span class="nc" id="L19210">                    int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L19211" title="All 2 branches missed.">                    if (roll &gt;= 8) {</span>
<span class="nc" id="L19212">                        entity.setTaserShutdownRounds(0);</span>
<span class="nc bnc" id="L19213" title="All 2 branches missed.">                        if (!(entity.isManualShutdown())) {</span>
<span class="nc" id="L19214">                            entity.setShutDown(false);</span>
                        }
<span class="nc" id="L19216">                        entity.setBATaserShutdown(false);</span>
                    }
<span class="nc" id="L19218">                }</span>

                continue;
            }

            // Only Mechs after this point

            // Meks gain heat from inferno hits.
<span class="nc bnc" id="L19226" title="All 2 branches missed.">            if (entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L19227">                int infernoHeat = entity.infernos.getHeat();</span>
<span class="nc" id="L19228">                entity.heatFromExternal += infernoHeat;</span>
<span class="nc" id="L19229">                r = new Report(5010);</span>
<span class="nc" id="L19230">                r.subject = entity.getId();</span>
<span class="nc" id="L19231">                r.add(infernoHeat);</span>
<span class="nc" id="L19232">                addReport(r);</span>
            }

            // should we even bother for this mech?
<span class="nc bnc" id="L19236" title="All 6 branches missed.">            if (entity.isDestroyed() || entity.isDoomed() || entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19237" title="All 2 branches missed.">                    || entity.getCrew().isDead()) {</span>
<span class="nc" id="L19238">                continue;</span>
            }

            // engine hits add a lot of heat, provided the engine is on
<span class="nc" id="L19242">            entity.heatBuildup += entity.getEngineCritHeat();</span>

            // If a Mek had an active Stealth suite, add 10 heat.
<span class="nc bnc" id="L19245" title="All 2 branches missed.">            if (entity.isStealthOn()) {</span>
<span class="nc" id="L19246">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19247">                r = new Report(5015);</span>
<span class="nc" id="L19248">                r.subject = entity.getId();</span>
<span class="nc" id="L19249">                addReport(r);</span>
            }

            // Greg: Nova CEWS If a Mek had an active Nova suite, add 2 heat.
<span class="nc bnc" id="L19253" title="All 2 branches missed.">            if (entity.hasActiveNovaCEWS()) {</span>
<span class="nc" id="L19254">                entity.heatBuildup += 2;</span>
<span class="nc" id="L19255">                r = new Report(5013);</span>
<span class="nc" id="L19256">                r.subject = entity.getId();</span>
<span class="nc" id="L19257">                addReport(r);</span>
            }

            // void sig adds 10 heat
<span class="nc bnc" id="L19261" title="All 2 branches missed.">            if (entity.isVoidSigOn()) {</span>
<span class="nc" id="L19262">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19263">                r = new Report(5016);</span>
<span class="nc" id="L19264">                r.subject = entity.getId();</span>
<span class="nc" id="L19265">                addReport(r);</span>
            }

            // null sig adds 10 heat
<span class="nc bnc" id="L19269" title="All 2 branches missed.">            if (entity.isNullSigOn()) {</span>
<span class="nc" id="L19270">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19271">                r = new Report(5017);</span>
<span class="nc" id="L19272">                r.subject = entity.getId();</span>
<span class="nc" id="L19273">                addReport(r);</span>
            }

            // chameleon polarization field adds 6
<span class="nc bnc" id="L19277" title="All 2 branches missed.">            if (entity.isChameleonShieldOn()) {</span>
<span class="nc" id="L19278">                entity.heatBuildup += 6;</span>
<span class="nc" id="L19279">                r = new Report(5014);</span>
<span class="nc" id="L19280">                r.subject = entity.getId();</span>
<span class="nc" id="L19281">                addReport(r);</span>
            }

            // If a Mek is in extreme Temperatures, add or subtract one
            // heat per 10 degrees (or fraction of 10 degrees) above or
            // below 50 or -30 degrees Celsius
<span class="nc bnc" id="L19287" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getTemperatureDifference(50, -30) != 0</span>
<span class="nc bnc" id="L19288" title="All 2 branches missed.">                    &amp;&amp; !((Mech) entity).hasLaserHeatSinks()) {</span>
<span class="nc bnc" id="L19289" title="All 2 branches missed.">                if (game.getPlanetaryConditions().getTemperature() &gt; 50) {</span>
<span class="nc" id="L19290">                    int heatToAdd = game.getPlanetaryConditions()</span>
<span class="nc" id="L19291">                            .getTemperatureDifference(50, -30);</span>
<span class="nc bnc" id="L19292" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19293">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19295">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19296">                    r = new Report(5020);</span>
<span class="nc" id="L19297">                    r.subject = entity.getId();</span>
<span class="nc" id="L19298">                    r.add(heatToAdd);</span>
<span class="nc" id="L19299">                    addReport(r);</span>
<span class="nc bnc" id="L19300" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19301">                        r = new Report(5550);</span>
<span class="nc" id="L19302">                        addReport(r);</span>
                    }
<span class="nc" id="L19304">                } else {</span>
<span class="nc" id="L19305">                    entity.heatFromExternal -= game.getPlanetaryConditions()</span>
<span class="nc" id="L19306">                            .getTemperatureDifference(50, -30);</span>
<span class="nc" id="L19307">                    r = new Report(5025);</span>
<span class="nc" id="L19308">                    r.subject = entity.getId();</span>
<span class="nc" id="L19309">                    r.add(game.getPlanetaryConditions().getTemperatureDifference(50, -30));</span>
<span class="nc" id="L19310">                    addReport(r);</span>
                }
            }

            // Add +5 Heat if the hex you're in is on fire
            // and was on fire for the full round.
<span class="nc bnc" id="L19316" title="All 2 branches missed.">            if (entityHex != null) {</span>
<span class="nc bnc" id="L19317" title="All 4 branches missed.">                if (entityHex.containsTerrain(Terrains.FIRE) &amp;&amp; (entityHex.getFireTurn() &gt; 0)</span>
<span class="nc bnc" id="L19318" title="All 2 branches missed.">                        &amp;&amp; (entity.getElevation() &lt;= 1)) {</span>
<span class="nc" id="L19319">                    int heatToAdd = 5;</span>
<span class="nc bnc" id="L19320" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19321">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19323">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19324">                    r = new Report(5030);</span>
<span class="nc" id="L19325">                    r.add(heatToAdd);</span>
<span class="nc" id="L19326">                    r.subject = entity.getId();</span>
<span class="nc" id="L19327">                    addReport(r);</span>
<span class="nc bnc" id="L19328" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19329">                        r = new Report(5550);</span>
<span class="nc" id="L19330">                        addReport(r);</span>
                    }
                }
<span class="nc" id="L19333">                int magma = entityHex.terrainLevel(Terrains.MAGMA);</span>
<span class="nc bnc" id="L19334" title="All 4 branches missed.">                if ((magma &gt; 0) &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L19335">                    int heatToAdd = 5 * magma;</span>
<span class="nc bnc" id="L19336" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19337">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19339">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19340">                    r = new Report(5032);</span>
<span class="nc" id="L19341">                    r.subject = entity.getId();</span>
<span class="nc" id="L19342">                    r.add(heatToAdd);</span>
<span class="nc" id="L19343">                    addReport(r);</span>
<span class="nc bnc" id="L19344" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19345">                        r = new Report(5550);</span>
<span class="nc" id="L19346">                        addReport(r);</span>
                    }
                }
            }

            // Check the mech for vibroblades if so then check to see if any
            // are active and what heat they will produce.
<span class="nc bnc" id="L19353" title="All 2 branches missed.">            if (entity.hasVibroblades()) {</span>
                int vibroHeat;

<span class="nc" id="L19356">                vibroHeat = entity.getActiveVibrobladeHeat(Mech.LOC_RARM);</span>
<span class="nc" id="L19357">                vibroHeat += entity.getActiveVibrobladeHeat(Mech.LOC_LARM);</span>

<span class="nc bnc" id="L19359" title="All 2 branches missed.">                if (vibroHeat &gt; 0) {</span>
<span class="nc" id="L19360">                    r = new Report(5018);</span>
<span class="nc" id="L19361">                    r.subject = entity.getId();</span>
<span class="nc" id="L19362">                    r.add(vibroHeat);</span>
<span class="nc" id="L19363">                    addReport(r);</span>
<span class="nc" id="L19364">                    entity.heatBuildup += vibroHeat;</span>
                }
            }

<span class="nc" id="L19368">            int capHeat = 0;</span>
<span class="nc bnc" id="L19369" title="All 2 branches missed.">            for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19370" title="All 4 branches missed.">                if ((m.hasChargedOrChargingCapacitor() == 1) &amp;&amp; !m.isUsedThisRound()) {</span>
<span class="nc" id="L19371">                    capHeat += 5;</span>
                }
<span class="nc bnc" id="L19373" title="All 4 branches missed.">                if ((m.hasChargedOrChargingCapacitor() == 2) &amp;&amp; !m.isUsedThisRound()) {</span>
<span class="nc" id="L19374">                    capHeat += 10;</span>
                }
<span class="nc" id="L19376">            }</span>
<span class="nc bnc" id="L19377" title="All 2 branches missed.">            if (capHeat &gt; 0) {</span>
<span class="nc" id="L19378">                r = new Report(5019);</span>
<span class="nc" id="L19379">                r.subject = entity.getId();</span>
<span class="nc" id="L19380">                r.add(capHeat);</span>
<span class="nc" id="L19381">                addReport(r);</span>
<span class="nc" id="L19382">                entity.heatBuildup += capHeat;</span>
            }

            // Add heat from external sources to the heat buildup
<span class="nc" id="L19386">            int max_ext_heat = game.getOptions().intOption(OptionsConstants.ADVCOMBAT_MAX_EXTERNAL_HEAT);</span>
            // Check Game Options
<span class="nc bnc" id="L19388" title="All 2 branches missed.">            if (max_ext_heat &lt; 0) {</span>
<span class="nc" id="L19389">                max_ext_heat = 15; // standard value specified in TW p.159</span>
            }
<span class="nc" id="L19391">            entity.heatBuildup += Math.min(max_ext_heat, entity.heatFromExternal);</span>
<span class="nc" id="L19392">            entity.heatFromExternal = 0;</span>
            // remove heat we cooled down
<span class="nc" id="L19394">            entity.heatBuildup -= Math.min(9, entity.coolFromExternal);</span>
<span class="nc" id="L19395">            entity.coolFromExternal = 0;</span>

            // Combat computers help manage heat
<span class="nc bnc" id="L19398" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_COMBAT_COMPUTER)) {</span>
<span class="nc" id="L19399">                int reduce = Math.min(entity.heatBuildup, 4);</span>
<span class="nc" id="L19400">                r = new Report(5026);</span>
<span class="nc" id="L19401">                r.subject = entity.getId();</span>
<span class="nc" id="L19402">                r.add(reduce);</span>
<span class="nc" id="L19403">                addReport(r);</span>
<span class="nc" id="L19404">                entity.heatBuildup -= reduce;</span>
            }

<span class="nc bnc" id="L19407" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)</span>
<span class="nc bnc" id="L19408" title="All 2 branches missed.">                    &amp;&amp; ((Mech) entity).isCoolingFlawActive()) {</span>
<span class="nc" id="L19409">                int flaw = 5;</span>
<span class="nc" id="L19410">                r = new Report(5021);</span>
<span class="nc" id="L19411">                r.subject = entity.getId();</span>
<span class="nc" id="L19412">                r.add(flaw);</span>
<span class="nc" id="L19413">                addReport(r);</span>
<span class="nc" id="L19414">                entity.heatBuildup += flaw;</span>
            }
            // if heat build up is negative due to temperature, set it to 0
            // for prettier turn reports
<span class="nc bnc" id="L19418" title="All 2 branches missed.">            if (entity.heatBuildup &lt; 0) {</span>
<span class="nc" id="L19419">                entity.heatBuildup = 0;</span>
            }

            // add the heat we've built up so far.
<span class="nc" id="L19423">            entity.heat += entity.heatBuildup;</span>

            // how much heat can we sink?
<span class="nc" id="L19426">            int toSink = entity.getHeatCapacityWithWater() + radicalHSBonus;</span>

<span class="nc bnc" id="L19428" title="All 2 branches missed.">            if (entity.getCoolantFailureAmount() &gt; 0) {</span>
<span class="nc" id="L19429">                int failureAmount = entity.getCoolantFailureAmount();</span>
<span class="nc" id="L19430">                r = new Report(5520);</span>
<span class="nc" id="L19431">                r.subject = entity.getId();</span>
<span class="nc" id="L19432">                r.add(failureAmount);</span>
<span class="nc" id="L19433">                toSink -= failureAmount;</span>
            }

            // should we use a coolant pod?
<span class="nc bnc" id="L19437" title="All 2 branches missed.">            int safeHeat = entity.hasInfernoAmmo() ? 9 : 13;</span>
<span class="nc" id="L19438">            int possibleSinkage = ((Mech) entity).getNumberOfSinks() - entity.getCoolantFailureAmount();</span>
<span class="nc bnc" id="L19439" title="All 2 branches missed.">            for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19440" title="All 2 branches missed.">                if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L19441">                    AmmoType at = (AmmoType) m.getType();</span>
<span class="nc bnc" id="L19442" title="All 4 branches missed.">                    if ((at.getAmmoType() == AmmoType.T_COOLANT_POD) &amp;&amp; m.isAmmoUsable()) {</span>
<span class="nc" id="L19443">                        EquipmentMode mode = m.curMode();</span>
<span class="nc bnc" id="L19444" title="All 2 branches missed.">                        if (mode.equals(&quot;dump&quot;)) {</span>
<span class="nc" id="L19445">                            r = new Report(5260);</span>
<span class="nc" id="L19446">                            r.subject = entity.getId();</span>
<span class="nc" id="L19447">                            addReport(r);</span>
<span class="nc" id="L19448">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19449">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19450">                            break;</span>
                        }
<span class="nc bnc" id="L19452" title="All 4 branches missed.">                        if (mode.equals(&quot;safe&quot;) &amp;&amp; ((entity.heat - toSink) &gt; safeHeat)) {</span>
<span class="nc" id="L19453">                            r = new Report(5265);</span>
<span class="nc" id="L19454">                            r.subject = entity.getId();</span>
<span class="nc" id="L19455">                            addReport(r);</span>
<span class="nc" id="L19456">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19457">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19458">                            break;</span>
                        }
<span class="nc bnc" id="L19460" title="All 4 branches missed.">                        if (mode.equals(&quot;efficient&quot;) &amp;&amp; ((entity.heat - toSink) &gt;= possibleSinkage)) {</span>
<span class="nc" id="L19461">                            r = new Report(5270);</span>
<span class="nc" id="L19462">                            r.subject = entity.getId();</span>
<span class="nc" id="L19463">                            addReport(r);</span>
<span class="nc" id="L19464">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19465">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19466">                            break;</span>
                        }
                    }
                }
<span class="nc" id="L19470">            }</span>

<span class="nc" id="L19472">            toSink = Math.min(toSink, entity.heat);</span>
<span class="nc" id="L19473">            entity.heat -= toSink;</span>
<span class="nc" id="L19474">            r = new Report(5035);</span>
<span class="nc" id="L19475">            r.subject = entity.getId();</span>
<span class="nc" id="L19476">            r.addDesc(entity);</span>
<span class="nc" id="L19477">            r.add(entity.heatBuildup);</span>
<span class="nc" id="L19478">            r.add(toSink);</span>
<span class="nc" id="L19479">            r.add(entity.heat);</span>
<span class="nc" id="L19480">            addReport(r);</span>
<span class="nc" id="L19481">            entity.heatBuildup = 0;</span>
<span class="nc" id="L19482">            vPhaseReport.addAll(rhsReports);</span>

            // Does the unit have inferno ammo?
<span class="nc bnc" id="L19485" title="All 2 branches missed.">            if (entity.hasInfernoAmmo()) {</span>

                // Roll for possible inferno ammo explosion.
<span class="nc bnc" id="L19488" title="All 2 branches missed.">                if (entity.heat &gt;= 10) {</span>
<span class="nc bnc" id="L19489" title="All 4 branches missed.">                    int boom = (4 + (entity.heat &gt;= 14 ? 2 : 0) + (entity.heat &gt;= 19 ? 2 : 0)</span>
<span class="nc bnc" id="L19490" title="All 4 branches missed.">                                + (entity.heat &gt;= 23 ? 2 : 0) + (entity.heat &gt;= 28 ? 2 : 0))</span>
                               - hotDogMod;
<span class="nc" id="L19492">                    int boomRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L19493" title="All 2 branches missed.">                    if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19494">                        boomRoll += 2;</span>
                    }
<span class="nc" id="L19496">                    r = new Report(5040);</span>
<span class="nc" id="L19497">                    r.subject = entity.getId();</span>
<span class="nc" id="L19498">                    r.addDesc(entity);</span>
<span class="nc" id="L19499">                    r.add(boom);</span>
<span class="nc bnc" id="L19500" title="All 2 branches missed.">                    if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19501">                        r.add(boomRoll + &quot;(&quot; + (boomRoll - 2) + &quot;+2)&quot;);</span>
                    } else {
<span class="nc" id="L19503">                        r.add(boomRoll);</span>
                    }

<span class="nc bnc" id="L19506" title="All 2 branches missed.">                    if (boomRoll &gt;= boom) {</span>
                        // avoided
<span class="nc" id="L19508">                        r.choose(true);</span>
<span class="nc" id="L19509">                        addReport(r);</span>
                    } else {
<span class="nc" id="L19511">                        r.choose(false);</span>
<span class="nc" id="L19512">                        addReport(r);</span>
<span class="nc" id="L19513">                        addReport(explodeInfernoAmmoFromHeat(entity));</span>
                    }
                }
            } // End avoid-inferno-explosion
            int autoShutDownHeat;
            boolean mtHeat;

<span class="nc bnc" id="L19520" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HEAT)) {</span>
<span class="nc" id="L19521">                autoShutDownHeat = 50;</span>
<span class="nc" id="L19522">                mtHeat = true;</span>
            } else {
<span class="nc" id="L19524">                autoShutDownHeat = 30;</span>
<span class="nc" id="L19525">                mtHeat = false;</span>
            }
            // heat effects: start up
<span class="nc bnc" id="L19528" title="All 6 branches missed.">            if ((entity.heat &lt; autoShutDownHeat) &amp;&amp; entity.isShutDown() &amp;&amp; !entity.isStalled()) {</span>
<span class="nc bnc" id="L19529" title="All 2 branches missed.">                if ((entity.getTaserShutdownRounds() == 0)</span>
<span class="nc bnc" id="L19530" title="All 2 branches missed.">                       &amp;&amp; (entity.getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc bnc" id="L19531" title="All 4 branches missed.">                    if ((entity.heat &lt; 14) &amp;&amp; !(entity.isManualShutdown())) {</span>
                        // automatically starts up again
<span class="nc" id="L19533">                        entity.setShutDown(false);</span>
<span class="nc" id="L19534">                        r = new Report(5045);</span>
<span class="nc" id="L19535">                        r.subject = entity.getId();</span>
<span class="nc" id="L19536">                        r.addDesc(entity);</span>
<span class="nc" id="L19537">                        addReport(r);</span>
<span class="nc bnc" id="L19538" title="All 2 branches missed.">                    } else if (!(entity.isManualShutdown())) {</span>
                        // If the pilot is KO and we need to roll, auto-fail.
<span class="nc bnc" id="L19540" title="All 2 branches missed.">                        if (!entity.getCrew().isActive()) {</span>
<span class="nc" id="L19541">                            r = new Report(5049);</span>
<span class="nc" id="L19542">                            r.subject = entity.getId();</span>
<span class="nc" id="L19543">                            r.addDesc(entity);</span>
                        } else {
                            // roll for startup
<span class="nc" id="L19546">                            int startup = (4 + (((entity.heat - 14) / 4) * 2)) - hotDogMod;</span>
<span class="nc bnc" id="L19547" title="All 2 branches missed.">                            if (mtHeat) {</span>
<span class="nc" id="L19548">                                startup -= 5;</span>
<span class="nc bnc" id="L19549" title="All 4 branches missed.">                                switch (entity.getCrew().getPiloting()) {</span>
                                    case 0:
                                    case 1:
<span class="nc" id="L19552">                                        startup -= 2;</span>
<span class="nc" id="L19553">                                        break;</span>
                                    case 2:
                                    case 3:
<span class="nc" id="L19556">                                        startup -= 1;</span>
<span class="nc" id="L19557">                                        break;</span>
                                    case 6:
                                    case 7:
<span class="nc" id="L19560">                                        startup += 1;</span>
                                }
                            }
<span class="nc" id="L19563">                            int suRoll = Compute.d6(2);</span>
<span class="nc" id="L19564">                            r = new Report(5050);</span>
<span class="nc" id="L19565">                            r.subject = entity.getId();</span>
<span class="nc" id="L19566">                            r.addDesc(entity);</span>
<span class="nc" id="L19567">                            r.add(startup);</span>
<span class="nc" id="L19568">                            r.add(suRoll);</span>
<span class="nc bnc" id="L19569" title="All 2 branches missed.">                            if (suRoll &gt;= startup) {</span>
                                // start 'er back up
<span class="nc" id="L19571">                                entity.setShutDown(false);</span>
<span class="nc" id="L19572">                                r.choose(true);</span>
                            } else {
<span class="nc" id="L19574">                                r.choose(false);</span>
                            }
                        }
<span class="nc" id="L19577">                        addReport(r);</span>
                    }
                } else {
                    // if we're shutdown by a BA taser, we might activate
                    // again
<span class="nc bnc" id="L19582" title="All 2 branches missed.">                    if (entity.isBATaserShutdown()) {</span>
<span class="nc" id="L19583">                        int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L19584" title="All 2 branches missed.">                        if (roll &gt;= 7) {</span>
<span class="nc" id="L19585">                            entity.setTaserShutdownRounds(0);</span>
<span class="nc bnc" id="L19586" title="All 2 branches missed.">                            if (!(entity.isManualShutdown())) {</span>
<span class="nc" id="L19587">                                entity.setShutDown(false);</span>
                            }
<span class="nc" id="L19589">                            entity.setBATaserShutdown(false);</span>
                        }
<span class="nc" id="L19591">                    }</span>
                }
            }

            // heat effects: shutdown!
            // Don't shut down if you just restarted.
<span class="nc bnc" id="L19597" title="All 4 branches missed.">            else if ((entity.heat &gt;= 14) &amp;&amp; !entity.isShutDown()) {</span>
<span class="nc bnc" id="L19598" title="All 2 branches missed.">                if (entity.heat &gt;= autoShutDownHeat) {</span>
<span class="nc" id="L19599">                    r = new Report(5055);</span>
<span class="nc" id="L19600">                    r.subject = entity.getId();</span>
<span class="nc" id="L19601">                    r.addDesc(entity);</span>
<span class="nc" id="L19602">                    addReport(r);</span>
                    // add a piloting roll and resolve immediately
<span class="nc bnc" id="L19604" title="All 2 branches missed.">                    if (entity.canFall()) {</span>
<span class="nc" id="L19605">                        game.addPSR(new PilotingRollData(entity.getId(), 3, &quot;reactor shutdown&quot;));</span>
<span class="nc" id="L19606">                        addReport(resolvePilotingRolls());</span>
                    }
                    // okay, now mark shut down
<span class="nc" id="L19609">                    entity.setShutDown(true);</span>
                } else {
                    // Again, pilot KO means shutdown is automatic.
<span class="nc bnc" id="L19612" title="All 2 branches missed.">                    if (!entity.getCrew().isActive()) {</span>
<span class="nc" id="L19613">                        r = new Report(5056);</span>
<span class="nc" id="L19614">                        r.subject = entity.getId();</span>
<span class="nc" id="L19615">                        r.addDesc(entity);</span>
<span class="nc" id="L19616">                        addReport(r);</span>
<span class="nc" id="L19617">                        entity.setShutDown(true);</span>
                    } else {
<span class="nc" id="L19619">                        int shutdown = (4 + (((entity.heat - 14) / 4) * 2)) - hotDogMod;</span>
<span class="nc bnc" id="L19620" title="All 2 branches missed.">                        if (mtHeat) {</span>
<span class="nc" id="L19621">                            shutdown -= 5;</span>
<span class="nc bnc" id="L19622" title="All 4 branches missed.">                            switch (entity.getCrew().getPiloting()) {</span>
                                case 0:
                                case 1:
<span class="nc" id="L19625">                                    shutdown -= 2;</span>
<span class="nc" id="L19626">                                    break;</span>
                                case 2:
                                case 3:
<span class="nc" id="L19629">                                    shutdown -= 1;</span>
<span class="nc" id="L19630">                                    break;</span>
                                case 6:
                                case 7:
<span class="nc" id="L19633">                                    shutdown += 1;</span>
                            }
                        }
<span class="nc" id="L19636">                        int shutdownRoll = Compute.d6(2);</span>
<span class="nc" id="L19637">                        r = new Report(5060);</span>
<span class="nc" id="L19638">                        r.subject = entity.getId();</span>
<span class="nc" id="L19639">                        r.addDesc(entity);</span>
<span class="nc" id="L19640">                        r.add(shutdown);</span>
<span class="nc bnc" id="L19641" title="All 2 branches missed.">                        if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19642">                            r.add((shutdownRoll + 2) + &quot; (&quot; + shutdownRoll + &quot;+2)&quot;);</span>
<span class="nc" id="L19643">                            shutdownRoll += 2;</span>
                        } else {
<span class="nc" id="L19645">                            r.add(shutdownRoll);</span>
                        }
<span class="nc bnc" id="L19647" title="All 2 branches missed.">                        if (shutdownRoll &gt;= shutdown) {</span>
                            // avoided
<span class="nc" id="L19649">                            r.choose(true);</span>
<span class="nc" id="L19650">                            addReport(r);</span>
                        } else {
                            // shutting down...
<span class="nc" id="L19653">                            r.choose(false);</span>
<span class="nc" id="L19654">                            addReport(r);</span>
                            // add a piloting roll and resolve immediately
<span class="nc bnc" id="L19656" title="All 2 branches missed.">                            if (entity.canFall()) {</span>
<span class="nc" id="L19657">                                game.addPSR(new PilotingRollData(entity.getId(), 3, &quot;reactor shutdown&quot;));</span>
<span class="nc" id="L19658">                                addReport(resolvePilotingRolls());</span>
                            }
                            // okay, now mark shut down
<span class="nc" id="L19661">                            entity.setShutDown(true);</span>
                        }
                    }
                }
            }

            // LAMs in fighter mode need to check for random movement due to heat
<span class="nc" id="L19668">            checkRandomAeroMovement(entity, hotDogMod);</span>

            // heat effects: ammo explosion!
<span class="nc bnc" id="L19671" title="All 2 branches missed.">            if (entity.heat &gt;= 19) {</span>
<span class="nc bnc" id="L19672" title="All 4 branches missed.">                int boom = (4 + (entity.heat &gt;= 23 ? 2 : 0) + (entity.heat &gt;= 28 ? 2 : 0))</span>
                           - hotDogMod;
<span class="nc bnc" id="L19674" title="All 2 branches missed.">                if (mtHeat) {</span>
<span class="nc bnc" id="L19675" title="All 2 branches missed.">                    boom += (entity.heat &gt;= 35 ? 2 : 0)</span>
<span class="nc bnc" id="L19676" title="All 2 branches missed.">                            + (entity.heat &gt;= 40 ? 2 : 0)</span>
<span class="nc bnc" id="L19677" title="All 2 branches missed.">                            + (entity.heat &gt;= 45 ? 2 : 0);</span>
                    // Last line is a crutch; 45 heat should be no roll
                    // but automatic explosion.
                }
<span class="nc bnc" id="L19681" title="All 2 branches missed.">                if (((Mech) entity).hasLaserHeatSinks()) {</span>
<span class="nc" id="L19682">                    boom--;</span>
                }
<span class="nc" id="L19684">                int boomRoll = Compute.d6(2);</span>
<span class="nc" id="L19685">                r = new Report(5065);</span>
<span class="nc" id="L19686">                r.subject = entity.getId();</span>
<span class="nc" id="L19687">                r.addDesc(entity);</span>
<span class="nc" id="L19688">                r.add(boom);</span>
<span class="nc bnc" id="L19689" title="All 2 branches missed.">                if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19690">                    r.add((boomRoll + 2) + &quot; (&quot; + boomRoll + &quot;+2)&quot;);</span>
<span class="nc" id="L19691">                    boomRoll += 2;</span>
                } else {
<span class="nc" id="L19693">                    r.add(boomRoll);</span>
                }
<span class="nc bnc" id="L19695" title="All 2 branches missed.">                if (boomRoll &gt;= boom) {</span>
                    // mech is ok
<span class="nc" id="L19697">                    r.choose(true);</span>
<span class="nc" id="L19698">                    addReport(r);</span>
                } else {
                    // boom!
<span class="nc" id="L19701">                    r.choose(false);</span>
<span class="nc" id="L19702">                    addReport(r);</span>
<span class="nc" id="L19703">                    addReport(explodeAmmoFromHeat(entity));</span>
                }
            }

            // heat effects: mechwarrior damage
            // N.B. The pilot may already be dead.
            int lifeSupportCritCount;
<span class="nc bnc" id="L19710" title="All 2 branches missed.">            boolean torsoMountedCockpit = ((Mech) entity).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED;</span>
<span class="nc bnc" id="L19711" title="All 2 branches missed.">            if (torsoMountedCockpit) {</span>
<span class="nc" id="L19712">                lifeSupportCritCount = entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_RT);
<span class="nc" id="L19714">                lifeSupportCritCount += entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_LT);
            } else {
<span class="nc" id="L19717">                lifeSupportCritCount = entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_HEAD);
            }
<span class="nc" id="L19720">            int damageHeat = entity.heat;</span>
<span class="nc bnc" id="L19721" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_IMP_LIFE_SUPPORT)) {</span>
<span class="nc" id="L19722">                damageHeat -= 5;</span>
            }
<span class="nc bnc" id="L19724" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_POOR_LIFE_SUPPORT)) {</span>
<span class="nc" id="L19725">                damageHeat += 5;</span>
            }
<span class="nc bnc" id="L19727" title="All 8 branches missed.">            if ((lifeSupportCritCount &gt; 0)</span>
                    &amp;&amp; ((damageHeat &gt;= 15) || (torsoMountedCockpit &amp;&amp; (damageHeat &gt; 0)))
<span class="nc bnc" id="L19729" title="All 4 branches missed.">                    &amp;&amp; !entity.getCrew().isDead() &amp;&amp; !entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19730" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isEjected()) {</span>
<span class="nc" id="L19731">                int heatLimitDesc = 1;</span>
<span class="nc" id="L19732">                int damageToCrew = 0;</span>
<span class="nc bnc" id="L19733" title="All 4 branches missed.">                if ((damageHeat &gt;= 47) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 5 damage
<span class="nc" id="L19735">                    heatLimitDesc = 47;</span>
<span class="nc" id="L19736">                    damageToCrew = 5;</span>
<span class="nc bnc" id="L19737" title="All 4 branches missed.">                } else if ((damageHeat &gt;= 39) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 4 damage
<span class="nc" id="L19739">                    heatLimitDesc = 39;</span>
<span class="nc" id="L19740">                    damageToCrew = 4;</span>
<span class="nc bnc" id="L19741" title="All 4 branches missed.">                } else if ((damageHeat &gt;= 32) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 3 damage
<span class="nc" id="L19743">                    heatLimitDesc = 32;</span>
<span class="nc" id="L19744">                    damageToCrew = 3;</span>
<span class="nc bnc" id="L19745" title="All 2 branches missed.">                } else if (damageHeat &gt;= 25) {</span>
                    // mechwarrior takes 2 damage
<span class="nc" id="L19747">                    heatLimitDesc = 25;</span>
<span class="nc" id="L19748">                    damageToCrew = 2;</span>
<span class="nc bnc" id="L19749" title="All 2 branches missed.">                } else if (damageHeat &gt;= 15) {</span>
                    // mechwarrior takes 1 damage
<span class="nc" id="L19751">                    heatLimitDesc = 15;</span>
<span class="nc" id="L19752">                    damageToCrew = 1;</span>
                }
<span class="nc bnc" id="L19754" title="All 2 branches missed.">                if ((((Mech) entity).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L19755" title="All 2 branches missed.">                        &amp;&amp; !entity.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L19756">                    damageToCrew += 1;</span>
                }
<span class="nc" id="L19758">                r = new Report(5070);</span>
<span class="nc" id="L19759">                r.subject = entity.getId();</span>
<span class="nc" id="L19760">                r.addDesc(entity);</span>
<span class="nc" id="L19761">                r.add(heatLimitDesc);</span>
<span class="nc" id="L19762">                r.add(damageToCrew);</span>
<span class="nc" id="L19763">                addReport(r);</span>
<span class="nc" id="L19764">                addReport(damageCrew(entity, damageToCrew));</span>
<span class="nc bnc" id="L19765" title="All 6 branches missed.">            } else if (mtHeat &amp;&amp; (entity.heat &gt;= 32) &amp;&amp; !entity.getCrew().isDead()</span>
<span class="nc bnc" id="L19766" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19767" title="All 2 branches missed.">                    &amp;&amp; !entity.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
                // Crew may take damage from heat if MaxTech option is set
<span class="nc" id="L19769">                int heatRoll = Compute.d6(2);</span>
                int avoidNumber;
<span class="nc bnc" id="L19771" title="All 2 branches missed.">                if (entity.heat &gt;= 47) {</span>
<span class="nc" id="L19772">                    avoidNumber = 12;</span>
<span class="nc bnc" id="L19773" title="All 2 branches missed.">                } else if (entity.heat &gt;= 39) {</span>
<span class="nc" id="L19774">                    avoidNumber = 10;</span>
                } else {
<span class="nc" id="L19776">                    avoidNumber = 8;</span>
                }
<span class="nc" id="L19778">                avoidNumber -= hotDogMod;</span>
<span class="nc" id="L19779">                r = new Report(5075);</span>
<span class="nc" id="L19780">                r.subject = entity.getId();</span>
<span class="nc" id="L19781">                r.addDesc(entity);</span>
<span class="nc" id="L19782">                r.add(avoidNumber);</span>
<span class="nc" id="L19783">                r.add(heatRoll);</span>
<span class="nc bnc" id="L19784" title="All 2 branches missed.">                if (heatRoll &gt;= avoidNumber) {</span>
                    // damage avoided
<span class="nc" id="L19786">                    r.choose(true);</span>
<span class="nc" id="L19787">                    addReport(r);</span>
                } else {
<span class="nc" id="L19789">                    r.choose(false);</span>
<span class="nc" id="L19790">                    addReport(r);</span>
<span class="nc" id="L19791">                    addReport(damageCrew(entity, 1));</span>
                }
            }

            // The pilot may have just expired.
<span class="nc bnc" id="L19796" title="All 4 branches missed.">            if ((entity.getCrew().isDead() || entity.getCrew().isDoomed())</span>
<span class="nc bnc" id="L19797" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isEjected()) {</span>
<span class="nc" id="L19798">                r = new Report(5080);</span>
<span class="nc" id="L19799">                r.subject = entity.getId();</span>
<span class="nc" id="L19800">                r.addDesc(entity);</span>
<span class="nc" id="L19801">                addReport(r);</span>
<span class="nc" id="L19802">                addReport(destroyEntity(entity, &quot;crew death&quot;, true));</span>
            }

            // With MaxTech Heat Scale, there may occur critical damage
<span class="nc bnc" id="L19806" title="All 2 branches missed.">            if (mtHeat) {</span>
<span class="nc bnc" id="L19807" title="All 2 branches missed.">                if (entity.heat &gt;= 36) {</span>
<span class="nc" id="L19808">                    int damageRoll = Compute.d6(2);</span>
                    int damageNumber;
<span class="nc bnc" id="L19810" title="All 2 branches missed.">                    if (entity.heat &gt;= 44) {</span>
<span class="nc" id="L19811">                        damageNumber = 10;</span>
                    } else {
<span class="nc" id="L19813">                        damageNumber = 8;</span>
                    }
<span class="nc" id="L19815">                    damageNumber -= hotDogMod;</span>
<span class="nc" id="L19816">                    r = new Report(5085);</span>
<span class="nc" id="L19817">                    r.subject = entity.getId();</span>
<span class="nc" id="L19818">                    r.addDesc(entity);</span>
<span class="nc" id="L19819">                    r.add(damageNumber);</span>
<span class="nc" id="L19820">                    r.add(damageRoll);</span>
<span class="nc" id="L19821">                    r.newlines = 0;</span>
<span class="nc bnc" id="L19822" title="All 2 branches missed.">                    if (damageRoll &gt;= damageNumber) {</span>
<span class="nc" id="L19823">                        r.choose(true);</span>
                    } else {
<span class="nc" id="L19825">                        r.choose(false);</span>
<span class="nc" id="L19826">                        addReport(r);</span>
<span class="nc" id="L19827">                        addReport(oneCriticalEntity(entity, Compute.randomInt(8), false, 0));</span>
                        // add an empty report, for line breaking
<span class="nc" id="L19829">                        r = new Report(1210, Report.PUBLIC);</span>
                    }
<span class="nc" id="L19831">                    addReport(r);</span>
                }
            }

<span class="nc bnc" id="L19835" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_COOLANT_FAILURE)</span>
<span class="nc bnc" id="L19836" title="All 4 branches missed.">                    &amp;&amp; (entity.getHeatCapacity() &gt; entity.getCoolantFailureAmount())</span>
                    &amp;&amp; (entity.heat &gt;= 5)) {
<span class="nc" id="L19838">                int roll = Compute.d6(2);</span>
<span class="nc" id="L19839">                int hitNumber = 10;</span>

<span class="nc" id="L19841">                hitNumber -= Math.max(0, (int) Math.ceil(entity.heat / 5.0) - 2);</span>

<span class="nc" id="L19843">                r = new Report(5525);</span>
<span class="nc" id="L19844">                r.subject = entity.getId();</span>
<span class="nc" id="L19845">                r.add(entity.getShortName());</span>
<span class="nc" id="L19846">                r.add(hitNumber);</span>
<span class="nc" id="L19847">                r.add(roll);</span>
<span class="nc" id="L19848">                r.newlines = 0;</span>
<span class="nc" id="L19849">                addReport(r);</span>
<span class="nc bnc" id="L19850" title="All 2 branches missed.">                if (roll &gt;= hitNumber) {</span>
<span class="nc" id="L19851">                    r = new Report(5052);</span>
<span class="nc" id="L19852">                    r.subject = entity.getId();</span>
<span class="nc" id="L19853">                    addReport(r);</span>
<span class="nc" id="L19854">                    r = new Report(5526);</span>
<span class="nc" id="L19855">                    r.subject = entity.getId();</span>
<span class="nc" id="L19856">                    r.add(entity.getShortNameRaw());</span>
<span class="nc" id="L19857">                    addReport(r);</span>
<span class="nc" id="L19858">                    entity.addCoolantFailureAmount(1);</span>
                } else {
<span class="nc" id="L19860">                    r = new Report(5041);</span>
<span class="nc" id="L19861">                    r.subject = entity.getId();</span>
<span class="nc" id="L19862">                    addReport(r);</span>
                }
            }
<span class="nc" id="L19865">        }</span>

<span class="nc bnc" id="L19867" title="All 2 branches missed.">        if (vPhaseReport.size() == 1) {</span>
            // I guess nothing happened...
<span class="nc" id="L19869">            addReport(new Report(1205, Report.PUBLIC));</span>
        }
<span class="nc" id="L19871">    }</span>

    void checkRandomAeroMovement(Entity entity, int hotDogMod) {
<span class="nc bnc" id="L19874" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L19875">            return;</span>
        }
<span class="nc" id="L19877">        IAero a = (IAero) entity;</span>
        // heat effects: control effects (must make it unless already random moving)
<span class="nc bnc" id="L19879" title="All 4 branches missed.">        if ((entity.heat &gt;= 5) &amp;&amp; !a.isRandomMove()) {</span>
<span class="nc bnc" id="L19880" title="All 4 branches missed.">            int controlAvoid = (5 + (entity.heat &gt;= 10 ? 1 : 0) + (entity.heat &gt;= 15 ? 1 : 0)</span>
<span class="nc bnc" id="L19881" title="All 4 branches missed.">                    + (entity.heat &gt;= 20 ? 1 : 0) + (entity.heat &gt;= 25 ? 2 : 0)) - hotDogMod;</span>
<span class="nc" id="L19882">            int controlRoll = Compute.d6(2);</span>
<span class="nc" id="L19883">            Report r = new Report(9210);</span>
<span class="nc" id="L19884">            r.subject = entity.getId();</span>
<span class="nc" id="L19885">            r.addDesc(entity);</span>
<span class="nc" id="L19886">            r.add(controlAvoid);</span>
<span class="nc" id="L19887">            r.add(controlRoll);</span>
<span class="nc bnc" id="L19888" title="All 2 branches missed.">            if (controlRoll &gt;= controlAvoid) {</span>
                // in control
<span class="nc" id="L19890">                r.choose(true);</span>
<span class="nc" id="L19891">                addReport(r);</span>
            } else {
                // out of control
<span class="nc" id="L19894">                r.choose(false);</span>
<span class="nc" id="L19895">                addReport(r);</span>
                // if not already out of control, this may lead to
                // elevation decline
<span class="nc bnc" id="L19898" title="All 4 branches missed.">                if (!a.isOutControl() &amp;&amp; !a.isSpaceborne()</span>
<span class="nc bnc" id="L19899" title="All 2 branches missed.">                    &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L19900">                    int loss = Compute.d6(1);</span>
<span class="nc" id="L19901">                    r = new Report(9366);</span>
<span class="nc" id="L19902">                    r.newlines = 0;</span>
<span class="nc" id="L19903">                    r.subject = entity.getId();</span>
<span class="nc" id="L19904">                    r.addDesc(entity);</span>
<span class="nc" id="L19905">                    r.add(loss);</span>
<span class="nc" id="L19906">                    addReport(r);</span>
<span class="nc" id="L19907">                    entity.setAltitude(entity.getAltitude() - loss);</span>
                    // check for crash
<span class="nc bnc" id="L19909" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L19910">                        addReport(processCrash(entity, a.getCurrentVelocity(), entity.getPosition()));</span>
                    }
                }
                // force unit out of control through heat
<span class="nc" id="L19914">                a.setOutCtrlHeat(true);</span>
<span class="nc" id="L19915">                a.setRandomMove(true);</span>
            }
        }
<span class="nc" id="L19918">    }</span>

    private void resolveEmergencyCoolantSystem() {
<span class="nc bnc" id="L19921" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L19922" title="All 6 branches missed.">            if ((e instanceof Mech) &amp;&amp; e.hasWorkingMisc(MiscType.F_EMERGENCY_COOLANT_SYSTEM)</span>
                    &amp;&amp; (e.heat &gt; 13)) {
<span class="nc" id="L19924">                Mech mech = (Mech)e;</span>
<span class="nc" id="L19925">                Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L19926">                HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; crits = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L19927" title="All 2 branches missed.">                if (!(mech.doRISCEmergencyCoolantCheckFor(vDesc, crits))) {</span>
<span class="nc" id="L19928">                    mech.heat -= 6 + mech.getCoolantSystemMOS();</span>
<span class="nc" id="L19929">                    Report r = new Report(5027);</span>
<span class="nc" id="L19930">                    r.add(6+mech.getCoolantSystemMOS());</span>
<span class="nc" id="L19931">                    vDesc.add(r);</span>
                }
<span class="nc" id="L19933">                addReport(vDesc);</span>
<span class="nc bnc" id="L19934" title="All 2 branches missed.">                for (Integer loc : crits.keySet()) {</span>
<span class="nc" id="L19935">                    List&lt;CriticalSlot&gt; lcs = crits.get(loc);</span>
<span class="nc bnc" id="L19936" title="All 2 branches missed.">                    for (CriticalSlot cs : lcs) {</span>
<span class="nc" id="L19937">                        addReport(applyCriticalHit(mech, loc, cs, true, 0, false));</span>
<span class="nc" id="L19938">                    }</span>
<span class="nc" id="L19939">                }</span>
            }
<span class="nc" id="L19941">        }</span>
<span class="nc" id="L19942">    }</span>

    /*
     * Resolve HarJel II/III repairs for Mechs so equipped.
     */
    private void resolveHarJelRepairs() {
        Report r;
<span class="nc bnc" id="L19949" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L19950">            Entity entity = i.next();</span>
<span class="nc bnc" id="L19951" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L19952">                continue;</span>
            }

<span class="nc" id="L19955">            Mech me = (Mech) entity;</span>
<span class="nc bnc" id="L19956" title="All 2 branches missed.">            for (int loc = 0; loc &lt; me.locations(); ++loc) {</span>
<span class="nc" id="L19957">                boolean harJelII = me.hasHarJelIIIn(loc); // false implies HarJel III</span>
<span class="nc bnc" id="L19958" title="All 4 branches missed.">                if ((harJelII || me.hasHarJelIIIIn(loc))</span>
<span class="nc bnc" id="L19959" title="All 2 branches missed.">                    &amp;&amp; me.isArmorDamagedThisTurn(loc)) {</span>
<span class="nc bnc" id="L19960" title="All 2 branches missed.">                    if (me.hasRearArmor(loc)) {</span>
                        // must have at least one remaining armor in location
<span class="nc bnc" id="L19962" title="All 4 branches missed.">                        if (!((me.getArmor(loc) &gt; 0) || (me.getArmor(loc, true) &gt; 0))) {</span>
<span class="nc" id="L19963">                            continue;</span>
                        }

<span class="nc bnc" id="L19966" title="All 2 branches missed.">                        int toRepair = harJelII ? 2 : 4;</span>
                        int frontRepair, rearRepair;
                        int desiredFrontRepair, desiredRearRepair;

<span class="nc" id="L19970">                        Mounted harJel = null;</span>
                        // find HarJel item
                        // don't need to check ready or worry about null,
                        // we already know there is one, it's ready,
                        // and there can be at most one in a given location
<span class="nc bnc" id="L19975" title="All 2 branches missed.">                        for (Mounted m: me.getMisc()) {</span>
<span class="nc bnc" id="L19976" title="All 2 branches missed.">                            if ((m.getLocation() == loc)</span>
<span class="nc bnc" id="L19977" title="All 2 branches missed.">                                &amp;&amp; (m.getType().hasFlag(MiscType.F_HARJEL_II)</span>
<span class="nc bnc" id="L19978" title="All 2 branches missed.">                                    || m.getType().hasFlag(MiscType.F_HARJEL_III))) {</span>
<span class="nc" id="L19979">                                harJel = m;</span>
                            }
<span class="nc" id="L19981">                        }</span>

<span class="nc bnc" id="L19983" title="All 2 branches missed.">                        if (harJelII) {</span>
<span class="nc bnc" id="L19984" title="All 2 branches missed.">                            if (harJel.curMode().equals(MiscType.S_HARJEL_II_1F1R)) {</span>
<span class="nc" id="L19985">                                desiredFrontRepair = 1;</span>
<span class="nc bnc" id="L19986" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_II_2F0R)) {</span>
<span class="nc" id="L19987">                                desiredFrontRepair = 2;</span>
                            } else { // 0F2R
<span class="nc" id="L19989">                                desiredFrontRepair = 0;</span>
                            }
                        } else { // HarJel III
<span class="nc bnc" id="L19992" title="All 2 branches missed.">                            if (harJel.curMode().equals(MiscType.S_HARJEL_III_2F2R)) {</span>
<span class="nc" id="L19993">                                desiredFrontRepair = 2;</span>
<span class="nc bnc" id="L19994" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_4F0R)) {</span>
<span class="nc" id="L19995">                                desiredFrontRepair = 4;</span>
<span class="nc bnc" id="L19996" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_3F1R)) {</span>
<span class="nc" id="L19997">                                desiredFrontRepair = 3;</span>
<span class="nc bnc" id="L19998" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_1F3R)) {</span>
<span class="nc" id="L19999">                                desiredFrontRepair = 1;</span>
                            } else { // 0F4R
<span class="nc" id="L20001">                                desiredFrontRepair = 0;</span>
                            }
                        }
<span class="nc" id="L20004">                        desiredRearRepair = toRepair - desiredFrontRepair;</span>

<span class="nc" id="L20006">                        int availableFrontRepair = me.getOArmor(loc) - me.getArmor(loc);</span>
<span class="nc" id="L20007">                        int availableRearRepair = me.getOArmor(loc, true) - me.getArmor(loc, true);</span>
<span class="nc" id="L20008">                        frontRepair = Math.min(availableFrontRepair, desiredFrontRepair);</span>
<span class="nc" id="L20009">                        rearRepair = Math.min(availableRearRepair, desiredRearRepair);</span>
<span class="nc" id="L20010">                        int surplus = desiredFrontRepair - frontRepair;</span>
<span class="nc bnc" id="L20011" title="All 2 branches missed.">                        if (surplus &gt; 0) { // we couldn't use all the points we wanted in front</span>
<span class="nc" id="L20012">                            rearRepair = Math.min(availableRearRepair, rearRepair + surplus);</span>
                        } else {
<span class="nc" id="L20014">                            surplus = desiredRearRepair - rearRepair;</span>
                            // try to move any excess points from rear to front
<span class="nc" id="L20016">                            frontRepair = Math.min(availableFrontRepair, frontRepair + surplus);</span>
                        }

<span class="nc bnc" id="L20019" title="All 2 branches missed.">                        if (frontRepair &gt; 0) {</span>
<span class="nc" id="L20020">                            me.setArmor(me.getArmor(loc) + frontRepair, loc);</span>
<span class="nc bnc" id="L20021" title="All 2 branches missed.">                            r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20022">                            r.subject = me.getId();</span>
<span class="nc" id="L20023">                            r.addDesc(entity);</span>
<span class="nc" id="L20024">                            r.add(frontRepair);</span>
<span class="nc" id="L20025">                            r.add(me.getLocationAbbr(loc));</span>
<span class="nc" id="L20026">                            addReport(r);</span>
                        }
<span class="nc bnc" id="L20028" title="All 2 branches missed.">                        if (rearRepair &gt; 0) {</span>
<span class="nc" id="L20029">                            me.setArmor(me.getArmor(loc, true) + rearRepair, loc, true);</span>
<span class="nc bnc" id="L20030" title="All 2 branches missed.">                            r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20031">                            r.subject = me.getId();</span>
<span class="nc" id="L20032">                            r.addDesc(entity);</span>
<span class="nc" id="L20033">                            r.add(rearRepair);</span>
<span class="nc" id="L20034">                            r.add(me.getLocationAbbr(loc) + &quot; (R)&quot;);</span>
<span class="nc" id="L20035">                            addReport(r);</span>
                        }
<span class="nc" id="L20037">                    } else {</span>
                        // must have at least one remaining armor in location
<span class="nc bnc" id="L20039" title="All 2 branches missed.">                        if (!(me.getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L20040">                            continue;</span>
                        }
<span class="nc bnc" id="L20042" title="All 2 branches missed.">                        int toRepair = harJelII ? 2 : 4;</span>
<span class="nc" id="L20043">                        toRepair = Math.min(toRepair, me.getOArmor(loc) - me.getArmor(loc));</span>
<span class="nc" id="L20044">                        me.setArmor(me.getArmor(loc) + toRepair, loc);</span>
<span class="nc bnc" id="L20045" title="All 2 branches missed.">                        r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20046">                        r.subject = me.getId();</span>
<span class="nc" id="L20047">                        r.addDesc(entity);</span>
<span class="nc" id="L20048">                        r.add(toRepair);</span>
<span class="nc" id="L20049">                        r.add(me.getLocationAbbr(loc));</span>
<span class="nc" id="L20050">                        addReport(r);</span>
                    }
                }
            }
<span class="nc" id="L20054">        }</span>
<span class="nc" id="L20055">    }</span>

    /**
     * Resolve Flaming Damage for the given Entity Taharqa: This is now updated
     * to TacOps rules which is much more lenient So I have change the name to
     * Flaming Damage rather than flaming death
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that may experience flaming damage.
     */
    private void doFlamingDamage(Entity entity) {
        Report r;
<span class="nc" id="L20066">        int boomRoll = Compute.d6(2);</span>

<span class="nc bnc" id="L20068" title="All 2 branches missed.">        if ((entity.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L20069" title="All 2 branches missed.">                &amp;&amp; !entity.infernos.isStillBurning()) {</span>
            // VTOLs don't check as long as they are flying higher than
            // the burning terrain. TODO : Check for rules conformity (ATPM?)
            // according to maxtech, elevation 0 or 1 should be affected,
            // this makes sense for level 2 as well

<span class="nc bnc" id="L20075" title="All 2 branches missed.">            if (entity.getElevation() &gt; 1) {</span>
<span class="nc" id="L20076">                return;</span>
            }
        }
        // Battle Armor squads equipped with fire protection
        // gear automatically avoid flaming damage
        // TODO : can conventional infantry mount fire-resistant armor?
<span class="nc bnc" id="L20082" title="All 2 branches missed.">        if ((entity instanceof BattleArmor)</span>
<span class="nc bnc" id="L20083" title="All 2 branches missed.">            &amp;&amp; ((BattleArmor) entity).isFireResistant()) {</span>
<span class="nc" id="L20084">            r = new Report(5095);</span>
<span class="nc" id="L20085">            r.subject = entity.getId();</span>
<span class="nc" id="L20086">            r.indent(1);</span>
<span class="nc" id="L20087">            r.addDesc(entity);</span>
<span class="nc" id="L20088">            addReport(r);</span>
<span class="nc" id="L20089">            return;</span>
        }

        // mechs shouldn't be here, but just in case
<span class="nc bnc" id="L20093" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L20094">            return;</span>
        }

        // fire has no effect on dropships
<span class="nc bnc" id="L20098" title="All 2 branches missed.">        if (entity instanceof Dropship) {</span>
<span class="nc" id="L20099">            return;</span>
        }

        // Must roll 8+ to survive...
<span class="nc" id="L20103">        r = new Report(5100);</span>
<span class="nc" id="L20104">        r.subject = entity.getId();</span>
<span class="nc" id="L20105">        r.newlines = 0;</span>
<span class="nc" id="L20106">        r.addDesc(entity);</span>
<span class="nc" id="L20107">        r.add(boomRoll);</span>
<span class="nc bnc" id="L20108" title="All 2 branches missed.">        if (boomRoll &gt;= 8) {</span>
            // phew!
<span class="nc" id="L20110">            r.choose(true);</span>
<span class="nc" id="L20111">            addReport(r);</span>
<span class="nc" id="L20112">            Report.addNewline(vPhaseReport);</span>
        } else {
            // eek
<span class="nc" id="L20115">            r.choose(false);</span>
<span class="nc" id="L20116">            r.newlines = 1;</span>
<span class="nc" id="L20117">            addReport(r);</span>
            // gun emplacements have their own critical rules
<span class="nc bnc" id="L20119" title="All 2 branches missed.">            if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L20120">                Vector&lt;GunEmplacement&gt; gun = new Vector&lt;&gt;();</span>
<span class="nc" id="L20121">                gun.add((GunEmplacement) entity);</span>
                
<span class="nc" id="L20123">                Building building = getGame().getBoard().getBuildingAt(entity.getPosition());</span>
                
<span class="nc" id="L20125">                Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L20126">                addReport(criticalGunEmplacement(gun, building, entity.getPosition()));            </span>
            // Taharqa: TacOps rules, protos and vees no longer die instantly
            // (hurray!)
<span class="nc bnc" id="L20129" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
<span class="nc" id="L20130">                int bonus = -2;</span>
<span class="nc bnc" id="L20131" title="All 4 branches missed.">                if ((entity instanceof SupportTank)</span>
                    || (entity instanceof SupportVTOL)) {
<span class="nc" id="L20133">                    bonus = 0;</span>
                }
                // roll a critical hit
<span class="nc" id="L20136">                Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L20137">                addReport(criticalTank((Tank) entity, Tank.LOC_FRONT, bonus, 0, true));</span>
<span class="nc bnc" id="L20138" title="All 2 branches missed.">            } else if (entity instanceof Protomech) {</span>
                // this code is taken from inferno hits
<span class="nc" id="L20140">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L20141" title="All 2 branches missed.">                if (hit.getLocation() == Protomech.LOC_NMISS) {</span>
<span class="nc" id="L20142">                    Protomech proto = (Protomech) entity;</span>
<span class="nc" id="L20143">                    r = new Report(6035);</span>
<span class="nc" id="L20144">                    r.subject = entity.getId();</span>
<span class="nc" id="L20145">                    r.indent(2);</span>
<span class="nc bnc" id="L20146" title="All 2 branches missed.">                    if (proto.isGlider()) {</span>
<span class="nc" id="L20147">                        r.messageId = 6036;</span>
<span class="nc" id="L20148">                        proto.setWingHits(proto.getWingHits() + 1);</span>
                    }
<span class="nc" id="L20150">                    addReport(r);</span>
<span class="nc" id="L20151">                } else {</span>
<span class="nc" id="L20152">                    r = new Report(6690);</span>
<span class="nc" id="L20153">                    r.subject = entity.getId();</span>
<span class="nc" id="L20154">                    r.indent(1);</span>
<span class="nc" id="L20155">                    r.add(entity.getLocationName(hit));</span>
<span class="nc" id="L20156">                    addReport(r);</span>
<span class="nc" id="L20157">                    entity.destroyLocation(hit.getLocation());</span>
                    // Handle ProtoMech pilot damage due to location destruction
<span class="nc" id="L20159">                    int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L20160">                               - ((Protomech) entity).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L20161" title="All 2 branches missed.">                    if (hits &gt; 0) {</span>
<span class="nc" id="L20162">                        addReport(damageCrew(entity, hits));</span>
<span class="nc" id="L20163">                        ((Protomech) entity).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L20164">                                Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                    }
<span class="nc bnc" id="L20166" title="All 2 branches missed.">                    if (entity.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L20167">                        addReport(destroyEntity(entity, &quot;flaming death&quot;, false, true));</span>
<span class="nc" id="L20168">                        Report.addNewline(vPhaseReport);</span>
                    }
                }
<span class="nc" id="L20171">            } else {</span>
                // sucks to be you
<span class="nc" id="L20173">                addReport(destroyEntity(entity, &quot;fire&quot;, false, false));</span>
<span class="nc" id="L20174">                Report.addNewline(vPhaseReport);</span>
            }
        }
<span class="nc" id="L20177">    }</span>

    private void clearFlawedCoolingFlags(Entity entity) {
        // If we're not using quirks, no need to do this check.
<span class="nc bnc" id="L20181" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L20182">            return;</span>
        }
        // Only applies to Mechs.
<span class="nc bnc" id="L20185" title="All 2 branches missed.">        if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20186">            return;</span>
        }

        // Check for existence of flawed cooling quirk.
<span class="nc bnc" id="L20190" title="All 2 branches missed.">        if (!entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)) {</span>
<span class="nc" id="L20191">            return;</span>
        }
<span class="nc" id="L20193">        entity.setFallen(false);</span>
<span class="nc" id="L20194">        entity.setStruck(false);</span>
<span class="nc" id="L20195">    }</span>

    private void checkForFlawedCooling() {

        // If we're not using quirks, no need to do this check.
<span class="nc bnc" id="L20200" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L20201">            return;</span>
        }

<span class="nc bnc" id="L20204" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20205">            final Entity entity = i.next();</span>

            // Only applies to Mechs.
<span class="nc bnc" id="L20208" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20209">                continue;</span>
            }

            // Check for existence of flawed cooling quirk.
<span class="nc bnc" id="L20213" title="All 2 branches missed.">            if (!entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)) {</span>
<span class="nc" id="L20214">                continue;</span>
            }

            // Check for active Cooling Flaw
<span class="nc bnc" id="L20218" title="All 2 branches missed.">            if (((Mech) entity).isCoolingFlawActive()) {</span>
<span class="nc" id="L20219">                continue;</span>
            }

            // Perform the check.
<span class="nc bnc" id="L20223" title="All 2 branches missed.">            if (entity.damageThisPhase &gt;= 20) {</span>
<span class="nc" id="L20224">                addReport(doFlawedCoolingCheck(&quot;20+ damage&quot;, entity));</span>
            }
<span class="nc bnc" id="L20226" title="All 2 branches missed.">            if (entity.hasFallen()) {</span>
<span class="nc" id="L20227">                addReport(doFlawedCoolingCheck(&quot;fall&quot;, entity));</span>
            }
<span class="nc bnc" id="L20229" title="All 2 branches missed.">            if (entity.wasStruck()) {</span>
<span class="nc" id="L20230">                addReport(doFlawedCoolingCheck(&quot;being struck&quot;, entity));</span>
            }
<span class="nc" id="L20232">            clearFlawedCoolingFlags(entity);</span>
<span class="nc" id="L20233">        }</span>
<span class="nc" id="L20234">    }</span>

    /**
     * Checks to see if Flawed Cooling is triggered and generates a report of
     * the result.
     *
     * @param reason
     * @param entity
     * @return
     */
    private Vector&lt;Report&gt; doFlawedCoolingCheck(String reason, Entity entity) {
<span class="nc" id="L20245">        Vector&lt;Report&gt; out = new Vector&lt;&gt;();</span>
<span class="nc" id="L20246">        Report r = new Report(9800);</span>
<span class="nc" id="L20247">        r.addDesc(entity);</span>
<span class="nc" id="L20248">        r.add(reason);</span>
<span class="nc" id="L20249">        int roll = Compute.d6(2);</span>
<span class="nc" id="L20250">        r.add(roll);</span>
<span class="nc" id="L20251">        out.add(r);</span>
<span class="nc bnc" id="L20252" title="All 2 branches missed.">        if (roll &gt;= 10) {</span>
<span class="nc" id="L20253">            Report s = new Report(9805);</span>
<span class="nc" id="L20254">            ((Mech) entity).setCoolingFlawActive(true);</span>
<span class="nc" id="L20255">            out.add(s);</span>
        }

<span class="nc" id="L20258">        return out;</span>
    }

    /**
     * For chain whip grapples, a roll needs to be made at the end of the
     * physical phase to maintain the grapple.
     */
    private void checkForChainWhipGrappleChecks() {
<span class="nc bnc" id="L20266" title="All 2 branches missed.">        for (Entity ae : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L20267" title="All 4 branches missed.">            if ((ae.getGrappled() != Entity.NONE) &amp;&amp; ae.isChainWhipGrappled()</span>
<span class="nc bnc" id="L20268" title="All 4 branches missed.">                    &amp;&amp; ae.isGrappleAttacker() &amp;&amp; !ae.isGrappledThisRound()) {</span>
<span class="nc" id="L20269">                Entity te = game.getEntity(ae.getGrappled());</span>
<span class="nc" id="L20270">                ToHitData grappleHit = GrappleAttackAction.toHit(game,</span>
<span class="nc" id="L20271">                        ae.getId(), te, ae.getGrappleSide(), true);</span>
<span class="nc" id="L20272">                int roll = Compute.d6(2);</span>

<span class="nc" id="L20274">                Report r = new Report(4317);</span>
<span class="nc" id="L20275">                r.subject = ae.getId();</span>
<span class="nc" id="L20276">                r.indent();</span>
<span class="nc" id="L20277">                r.addDesc(ae);</span>
<span class="nc" id="L20278">                r.addDesc(te);</span>
<span class="nc" id="L20279">                r.newlines = 0;</span>
<span class="nc" id="L20280">                addReport(r);</span>

<span class="nc bnc" id="L20282" title="All 2 branches missed.">                if (grappleHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L20283">                    r = new Report(4300);</span>
<span class="nc" id="L20284">                    r.subject = ae.getId();</span>
<span class="nc" id="L20285">                    r.add(grappleHit.getDesc());</span>
<span class="nc" id="L20286">                    addReport(r);</span>
<span class="nc" id="L20287">                    return;</span>
                }

                // report the roll
<span class="nc" id="L20291">                r = new Report(4025);</span>
<span class="nc" id="L20292">                r.subject = ae.getId();</span>
<span class="nc" id="L20293">                r.add(grappleHit);</span>
<span class="nc" id="L20294">                r.add(roll);</span>
<span class="nc" id="L20295">                r.newlines = 0;</span>
<span class="nc" id="L20296">                addReport(r);</span>

                // do we hit?
<span class="nc bnc" id="L20299" title="All 2 branches missed.">                if (roll &gt;= grappleHit.getValue()) {</span>
                    // hit
<span class="nc" id="L20301">                    r = new Report(4040);</span>
<span class="nc" id="L20302">                    r.subject = ae.getId();</span>
<span class="nc" id="L20303">                    addReport(r);</span>
                    // Nothing else to do
<span class="nc" id="L20305">                    return;</span>
                }

                // miss
<span class="nc" id="L20309">                r = new Report(4035);</span>
<span class="nc" id="L20310">                r.subject = ae.getId();</span>
<span class="nc" id="L20311">                addReport(r);</span>

                // Need to break grapple
<span class="nc" id="L20314">                ae.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L20315">                te.setGrappled(Entity.NONE, false);</span>
            }
<span class="nc" id="L20317">        }</span>
<span class="nc" id="L20318">    }</span>

    /**
     * Checks to see if any entity takes enough damage that requires them to
     * make a piloting roll
     */
    private void checkForPSRFromDamage() {
<span class="nc bnc" id="L20325" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20326">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20327" title="All 2 branches missed.">            if (entity.canFall()) {</span>
<span class="nc bnc" id="L20328" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
                    // you can't fall over when you are combat dropping because
                    // you are already falling!
<span class="nc" id="L20331">                    continue;</span>
                }
                // if this mech has 20+ damage, add another roll to the list.
                // Hulldown 'mechs ignore this rule, TO Errata
<span class="nc" id="L20335">                int psrThreshold = 20;</span>
<span class="nc bnc" id="L20336" title="All 2 branches missed.">                if (((Mech) entity).getCockpitType() == Mech.COCKPIT_DUAL</span>
<span class="nc bnc" id="L20337" title="All 2 branches missed.">                        &amp;&amp; entity.getCrew().hasDedicatedPilot()) {</span>
<span class="nc" id="L20338">                    psrThreshold = 30;</span>
                }
<span class="nc bnc" id="L20340" title="All 4 branches missed.">                if ((entity.damageThisPhase &gt;= psrThreshold) &amp;&amp; !entity.isHullDown()) {</span>
<span class="nc bnc" id="L20341" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_TAKING_DAMAGE)) {</span>
<span class="nc" id="L20342">                        PilotingRollData damPRD = new PilotingRollData(entity.getId());</span>
<span class="nc" id="L20343">                        int damMod = entity.damageThisPhase / psrThreshold;</span>
<span class="nc" id="L20344">                        damPRD.addModifier(damMod, (damMod * psrThreshold) + &quot;+ damage&quot;);</span>
<span class="nc" id="L20345">                        int weightMod = 0;</span>
<span class="nc bnc" id="L20346" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVGRNDMOV_TACOPS_PHYSICAL_PSR)) {
<span class="nc bnc" id="L20348" title="All 5 branches missed.">                            switch (entity.getWeightClass()) {</span>
                                case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L20350">                                    weightMod = 1;</span>
<span class="nc" id="L20351">                                    break;</span>
                                case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L20353">                                    weightMod = 0;</span>
<span class="nc" id="L20354">                                    break;</span>
                                case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L20356">                                    weightMod = -1;</span>
<span class="nc" id="L20357">                                    break;</span>
                                case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L20359">                                    weightMod = -2;</span>
                                    break;
                            }
<span class="nc bnc" id="L20362" title="All 4 branches missed.">                            if ((entity instanceof Mech) &amp;&amp; entity.isSuperHeavy()) {</span>
<span class="nc" id="L20363">                                weightMod = -4;</span>
                            }
                            // the weight class PSR modifier is not cumulative
<span class="nc" id="L20366">                            damPRD.addModifier(weightMod,</span>
                                               &quot;weight class modifier&quot;, false);
                        }
<span class="nc bnc" id="L20369" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20370" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20371">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20373">                        game.addPSR(damPRD);</span>
<span class="nc" id="L20374">                    } else {</span>
<span class="nc" id="L20375">                        PilotingRollData damPRD = new PilotingRollData(</span>
<span class="nc" id="L20376">                                entity.getId(), 1, psrThreshold + &quot;+ damage&quot;);</span>
<span class="nc bnc" id="L20377" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20378" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20379">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20381">                        game.addPSR(damPRD);</span>
                    }
                }
            }
<span class="nc bnc" id="L20385" title="All 6 branches missed.">            if (entity.isAero() &amp;&amp; entity.isAirborne() &amp;&amp; !game.getBoard().inSpace()) {</span>
                // if this aero has any damage, add another roll to the list.
<span class="nc bnc" id="L20387" title="All 2 branches missed.">                if (entity.damageThisPhase &gt; 0) {</span>
<span class="nc bnc" id="L20388" title="All 2 branches missed.">                    if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_ATMOSPHERIC_CONTROL)) {</span>
<span class="nc" id="L20389">                        int damMod = entity.damageThisPhase / 20;</span>
<span class="nc" id="L20390">                        PilotingRollData damPRD = new PilotingRollData(entity.getId(), damMod, entity.damageThisPhase + &quot; damage +&quot; + damMod);</span>
<span class="nc bnc" id="L20391" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20392" title="All 2 branches missed.">                                &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20393">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20395">                        game.addControlRoll(damPRD);</span>
<span class="nc" id="L20396">                    } else {</span>
                        // was the damage threshold exceeded this round?
<span class="nc bnc" id="L20398" title="All 2 branches missed.">                        if (((IAero) entity).wasCritThresh()) {</span>
<span class="nc" id="L20399">                            PilotingRollData damThresh = new PilotingRollData(entity.getId(), 0,</span>
                                    &quot;damage threshold exceeded&quot;);
<span class="nc bnc" id="L20401" title="All 2 branches missed.">                            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20402" title="All 2 branches missed.">                                    &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20403">                                damThresh.addModifier(-1, &quot;easy to pilot&quot;);</span>
                            }
<span class="nc" id="L20405">                            game.addControlRoll(damThresh);</span>
                        }
                    }
                }
            }
            // Airborne AirMechs that take 20+ damage make a control roll instead of a PSR.
<span class="nc bnc" id="L20411" title="All 6 branches missed.">            if (entity instanceof LandAirMech &amp;&amp; entity.isAirborneVTOLorWIGE()</span>
                    &amp;&amp; entity.damageThisPhase &gt;= 20) {
<span class="nc" id="L20413">                PilotingRollData damPRD = new PilotingRollData(entity.getId());</span>
<span class="nc" id="L20414">                int damMod = entity.damageThisPhase / 20;</span>
<span class="nc" id="L20415">                damPRD.addModifier(damMod, (damMod * 20) + &quot;+ damage&quot;);</span>
<span class="nc" id="L20416">                game.addControlRoll(damPRD);</span>
            }
<span class="nc" id="L20418">        }</span>
<span class="nc" id="L20419">    }</span>

    /**
     * Checks to see if any non-mech units are standing in fire. Called at the
     * end of the movement phase
     */
    public void checkForFlamingDamage() {
<span class="nc bnc" id="L20426" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20427">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20428" title="All 4 branches missed.">            if ((null == entity.getPosition()) || (entity instanceof Mech)</span>
<span class="nc bnc" id="L20429" title="All 6 branches missed.">                    || entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard()) {</span>
<span class="nc" id="L20430">                continue;</span>
            }
<span class="nc" id="L20432">            final IHex curHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L20433" title="All 2 branches missed.">            final boolean underwater = curHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L20434" title="All 2 branches missed.">                    &amp;&amp; (curHex.depth() &gt; 0)</span>
<span class="nc bnc" id="L20435" title="All 2 branches missed.">                    &amp;&amp; (entity.getElevation() &lt; curHex.surface());</span>
<span class="nc" id="L20436">            final int numFloors = curHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc bnc" id="L20437" title="All 4 branches missed.">            if (curHex.containsTerrain(Terrains.FIRE) &amp;&amp; !underwater</span>
<span class="nc bnc" id="L20438" title="All 2 branches missed.">                    &amp;&amp; ((entity.getElevation() &lt;= 1)</span>
<span class="nc bnc" id="L20439" title="All 2 branches missed.">                            || (entity.getElevation() &lt;= numFloors))) {</span>
<span class="nc" id="L20440">                doFlamingDamage(entity);</span>
            }
<span class="nc" id="L20442">        }</span>
<span class="nc" id="L20443">    }</span>

    /**
     * Checks to see if any telemissiles are in a hex with enemy units. If so,
     * then attack one.
     */
    private void checkForTeleMissileAttacks() {
<span class="nc bnc" id="L20450" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20451">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20452" title="All 2 branches missed.">            if (entity instanceof TeleMissile) {</span>
                // check for enemy units
<span class="nc" id="L20454">                Vector&lt;Integer&gt; potTargets = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L20455" title="All 2 branches missed.">                for (Entity te : game.getEntitiesVector(entity.getPosition())) {</span>
                    //Telemissiles cannot target fighters or other telemissiles
                    //Fighters don't have a distinctive Etype flag, so we have to do
                    //this by exclusion.
<span class="nc bnc" id="L20459" title="All 2 branches missed.">                    if (!(te.hasETypeFlag(Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L20460" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L20461" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L20462" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_WARSHIP)</span>
<span class="nc bnc" id="L20463" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_SPACE_STATION))) {</span>
<span class="nc" id="L20464">                        continue;</span>
                    }
<span class="nc bnc" id="L20466" title="All 2 branches missed.">                    if (te.isEnemyOf(entity)) {</span>
                        // then add it to a vector of potential targets
<span class="nc" id="L20468">                        potTargets.add(te.getId());</span>
                    }
<span class="nc" id="L20470">                }</span>
<span class="nc bnc" id="L20471" title="All 2 branches missed.">                if (potTargets.size() &gt; 0) {</span>
                    // determine randomly
<span class="nc" id="L20473">                    Entity target = game.getEntity(potTargets.get(Compute</span>
<span class="nc" id="L20474">                            .randomInt(potTargets.size())));</span>
                    // report this and add a new TeleMissileAttackAction
<span class="nc" id="L20476">                    Report r = new Report(9085);</span>
<span class="nc" id="L20477">                    r.subject = entity.getId();</span>
<span class="nc" id="L20478">                    r.addDesc(entity);</span>
<span class="nc" id="L20479">                    r.addDesc(target);</span>
<span class="nc" id="L20480">                    addReport(r);</span>
<span class="nc" id="L20481">                    game.addTeleMissileAttack(new TeleMissileAttackAction(entity, target));</span>
                }
            }
<span class="nc" id="L20484">        }</span>
<span class="nc" id="L20485">    }</span>

    private void checkForBlueShieldDamage() {
        Report r;
<span class="nc bnc" id="L20489" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20490">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20491" title="All 4 branches missed.">            if (!(entity instanceof Aero) &amp;&amp; entity.hasActiveBlueShield()</span>
<span class="nc bnc" id="L20492" title="All 2 branches missed.">                &amp;&amp; (entity.getBlueShieldRounds() &gt;= 6)) {</span>
<span class="nc" id="L20493">                int roll = Compute.d6(2);</span>
<span class="nc" id="L20494">                int target = (3 + entity.getBlueShieldRounds()) - 6;</span>
<span class="nc" id="L20495">                r = new Report(1240);</span>
<span class="nc" id="L20496">                r.addDesc(entity);</span>
<span class="nc" id="L20497">                r.add(target);</span>
<span class="nc" id="L20498">                r.add(roll);</span>
<span class="nc bnc" id="L20499" title="All 2 branches missed.">                if (roll &lt; target) {</span>
<span class="nc bnc" id="L20500" title="All 2 branches missed.">                    for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L20501" title="All 2 branches missed.">                        if (m.getType().hasFlag(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L20502">                            m.setBreached(true);</span>
                        }
<span class="nc" id="L20504">                    }</span>
<span class="nc" id="L20505">                    r.choose(true);</span>
                } else {
<span class="nc" id="L20507">                    r.choose(false);</span>
                }
<span class="nc" id="L20509">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L20511">        }</span>
<span class="nc" id="L20512">    }</span>

    /**
     * Check to see if anyone dies due to being in certain planetary conditions.
     */
    private void checkForConditionDeath() {
        Report r;
<span class="nc bnc" id="L20519" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20520">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20521" title="All 6 branches missed.">            if ((null == entity.getPosition()) &amp;&amp; !entity.isOffBoard() || (entity.getTransportId() != Entity.NONE)) {</span>
                // Ignore transported units, and units that don't have a position for some unknown reason
<span class="nc" id="L20523">                continue;</span>
            }
<span class="nc" id="L20525">            String reason = game.getPlanetaryConditions().whyDoomed(entity, game);</span>
<span class="nc bnc" id="L20526" title="All 2 branches missed.">            if (null != reason) {</span>
<span class="nc" id="L20527">                r = new Report(6015);</span>
<span class="nc" id="L20528">                r.subject = entity.getId();</span>
<span class="nc" id="L20529">                r.addDesc(entity);</span>
<span class="nc" id="L20530">                r.add(reason);</span>
<span class="nc" id="L20531">                addReport(r);</span>
<span class="nc" id="L20532">                addReport(destroyEntity(entity, reason, true, true));</span>
            }
<span class="nc" id="L20534">        }</span>
<span class="nc" id="L20535">    }</span>

    /**
     * Check to see if anyone dies due to being in atmosphere.
     */
    private void checkForAtmosphereDeath() {
        Report r;
<span class="nc bnc" id="L20542" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20543">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20544" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20547">                continue;</span>
            }
<span class="nc bnc" id="L20549" title="All 4 branches missed.">            if (entity.doomedInAtmosphere() &amp;&amp; (entity.getAltitude() == 0)) {</span>
<span class="nc" id="L20550">                r = new Report(6016);</span>
<span class="nc" id="L20551">                r.subject = entity.getId();</span>
<span class="nc" id="L20552">                r.addDesc(entity);</span>
<span class="nc" id="L20553">                addReport(r);</span>
<span class="nc" id="L20554">                addReport(destroyEntity(entity,</span>
                        &quot;being in atmosphere where it can't survive&quot;, true,
                        true));
            }
<span class="nc" id="L20558">        }</span>
<span class="nc" id="L20559">    }</span>

    /**
     * checks if IndustrialMechs should die because they moved into to-deep
     * water last round
     */
    private void checkForIndustrialWaterDeath() {
<span class="nc bnc" id="L20566" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20567">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20568" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20571">                continue;</span>
            }
<span class="nc bnc" id="L20573" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L20574" title="All 2 branches missed.">                    &amp;&amp; ((Mech) entity).shouldDieAtEndOfTurnBecauseOfWater()) {</span>
<span class="nc" id="L20575">                addReport(destroyEntity(entity,</span>
                        &quot;being in water without environmental shielding&quot;, true,
                        true));
            }

<span class="nc" id="L20580">        }</span>
<span class="nc" id="L20581">    }</span>

    private void checkForIndustrialEndOfTurn() {
<span class="nc" id="L20584">        checkForIndustrialWaterDeath();</span>
<span class="nc" id="L20585">        checkForIndustrialUnstall();</span>
<span class="nc" id="L20586">        checkForIndustrialCrit(); // This might hit an actuator or gyro, so...</span>
<span class="nc" id="L20587">        addReport(resolvePilotingRolls());</span>
<span class="nc" id="L20588">    }</span>

    private void checkForIndustrialUnstall() {
<span class="nc bnc" id="L20591" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20592">            final Entity entity = i.next();</span>
<span class="nc" id="L20593">            entity.checkUnstall(vPhaseReport);</span>
<span class="nc" id="L20594">        }</span>
<span class="nc" id="L20595">    }</span>

    /**
     * industrial mechs might need to check for critical damage
     */
    private void checkForIndustrialCrit() {
<span class="nc bnc" id="L20601" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20602">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20603" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech) entity).isIndustrial()) {</span>
<span class="nc" id="L20604">                Mech mech = (Mech) entity;</span>
                // should we check for critical damage?
<span class="nc bnc" id="L20606" title="All 2 branches missed.">                if (mech.isCheckForCrit()) {</span>
<span class="nc" id="L20607">                    Report r = new Report(5530);</span>
<span class="nc" id="L20608">                    r.addDesc(mech);</span>
<span class="nc" id="L20609">                    r.subject = mech.getId();</span>
<span class="nc" id="L20610">                    r.newlines = 0;</span>
<span class="nc" id="L20611">                    vPhaseReport.add(r);</span>
                    // for being hit by a physical weapon
<span class="nc bnc" id="L20613" title="All 2 branches missed.">                    if (mech.getLevelsFallen() == 0) {</span>
<span class="nc" id="L20614">                        r = new Report(5531);</span>
<span class="nc" id="L20615">                        r.subject = mech.getId();</span>
                        // or for falling
                    } else {
<span class="nc" id="L20618">                        r = new Report(5532);</span>
<span class="nc" id="L20619">                        r.subject = mech.getId();</span>
<span class="nc" id="L20620">                        r.add(mech.getLevelsFallen());</span>
                    }
<span class="nc" id="L20622">                    vPhaseReport.add(r);</span>
<span class="nc" id="L20623">                    HitData newHit = mech.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L20624">                    vPhaseReport.addAll(criticalEntity(mech,</span>
<span class="nc" id="L20625">                            newHit.getLocation(), newHit.isRear(),</span>
<span class="nc" id="L20626">                            mech.getLevelsFallen(), 0));</span>
                }
            }
<span class="nc" id="L20629">        }</span>
<span class="nc" id="L20630">    }</span>

    /**
     * Check to see if anyone dies due to being in space.
     */
    private void checkForSpaceDeath() {
        Report r;
<span class="nc bnc" id="L20637" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20638">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20639" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20642">                continue;</span>
            }
<span class="nc bnc" id="L20644" title="All 2 branches missed.">            if (entity.doomedInSpace()) {</span>
<span class="nc" id="L20645">                r = new Report(6017);</span>
<span class="nc" id="L20646">                r.subject = entity.getId();</span>
<span class="nc" id="L20647">                r.addDesc(entity);</span>
<span class="nc" id="L20648">                addReport(r);</span>
<span class="nc" id="L20649">                addReport(destroyEntity(entity,</span>
                        &quot;being in space where it can't survive&quot;, true, true));
            }
<span class="nc" id="L20652">        }</span>
<span class="nc" id="L20653">    }</span>

    /**
     * Checks to see if any entities are underwater (or in vacuum) with damaged
     * life support. Called during the end phase.
     */
    private void checkForSuffocation() {
<span class="nc bnc" id="L20660" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20661">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20662" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
<span class="nc" id="L20663">                continue;</span>
            }
<span class="nc" id="L20665">            final IHex curHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L20666" title="All 2 branches missed.">            if ((((entity.getElevation() &lt; 0) &amp;&amp; ((curHex</span>
<span class="nc bnc" id="L20667" title="All 2 branches missed.">                    .terrainLevel(Terrains.WATER) &gt; 1) || ((curHex</span>
<span class="nc bnc" id="L20668" title="All 4 branches missed.">                    .terrainLevel(Terrains.WATER) == 1) &amp;&amp; entity.isProne()))) || game</span>
<span class="nc bnc" id="L20669" title="All 2 branches missed.">                    .getPlanetaryConditions().isVacuum())</span>
<span class="nc bnc" id="L20670" title="All 2 branches missed.">                    &amp;&amp; (entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                            Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_HEAD) &gt; 0)) {
<span class="nc" id="L20672">                Report r = new Report(6020);</span>
<span class="nc" id="L20673">                r.subject = entity.getId();</span>
<span class="nc" id="L20674">                r.addDesc(entity);</span>
<span class="nc" id="L20675">                addReport(r);</span>
<span class="nc" id="L20676">                addReport(damageCrew(entity, 1));</span>

            }
<span class="nc" id="L20679">        }</span>
<span class="nc" id="L20680">    }</span>

    /**
     * Iterates over all entities and gets rid of Narc pods attached to destroyed
     * or lost locations.
     */
    private void cleanupDestroyedNarcPods() {
<span class="nc bnc" id="L20687" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20688">            i.next().clearDestroyedNarcPods();</span>
        }
<span class="nc" id="L20690">    }</span>

    /**
     * Resolves all built up piloting skill rolls. Used at end of weapons,
     * physical phases.
     */
    private Vector&lt;Report&gt; resolvePilotingRolls() {
<span class="nc" id="L20697">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L20698" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20699">            vPhaseReport.addAll(resolvePilotingRolls(i.next()));</span>
        }
<span class="nc" id="L20701">        game.resetPSRs();</span>
<span class="nc" id="L20702">        return vPhaseReport;</span>
    }

    /**
     * Resolves and reports all piloting skill rolls for a single mech.
     */
    private Vector&lt;Report&gt; resolvePilotingRolls(Entity entity) {
<span class="nc" id="L20709">        return resolvePilotingRolls(entity, false, entity.getPosition(),</span>
<span class="nc" id="L20710">                                    entity.getPosition());</span>
    }

    private Vector&lt;Report&gt; resolvePilotingRolls(Entity entity, boolean moving,
                                                Coords src, Coords dest) {
<span class="nc" id="L20715">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        // dead and undeployed and offboard units don't need to.
<span class="nc bnc" id="L20717" title="All 8 branches missed.">        if (entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard() || !entity.isDeployed()</span>
<span class="nc bnc" id="L20718" title="All 2 branches missed.">                || (entity.getTransportId() != Entity.NONE)) {</span>
<span class="nc" id="L20719">            return vPhaseReport;</span>
        }

        // airborne units don't make piloting rolls, they make control rolls
<span class="nc bnc" id="L20723" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>
<span class="nc" id="L20724">            return vPhaseReport;</span>
        }

        Report r;

        // first, do extreme gravity PSR, because non-mechs do these, too
<span class="nc" id="L20730">        PilotingRollData rollTarget = null;</span>
<span class="nc bnc" id="L20731" title="All 2 branches missed.">        for (Enumeration&lt;PilotingRollData&gt; i = game.getExtremeGravityPSRs(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L20732">            final PilotingRollData roll = i.nextElement();</span>
<span class="nc bnc" id="L20733" title="All 2 branches missed.">            if (roll.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L20734">                continue;</span>
            }
            // found a roll, use it (there can be only 1 per entity)
<span class="nc" id="L20737">            rollTarget = roll;</span>
<span class="nc" id="L20738">            game.resetExtremeGravityPSRs(entity);</span>
<span class="nc" id="L20739">        }</span>
<span class="nc bnc" id="L20740" title="All 4 branches missed.">        if ((rollTarget != null) &amp;&amp; (rollTarget.getValue() != TargetRoll.CHECK_FALSE)) {</span>
            // okay, print the info
<span class="nc" id="L20742">            r = new Report(2180);</span>
<span class="nc" id="L20743">            r.subject = entity.getId();</span>
<span class="nc" id="L20744">            r.addDesc(entity);</span>
<span class="nc" id="L20745">            r.add(rollTarget.getLastPlainDesc());</span>
<span class="nc" id="L20746">            vPhaseReport.add(r);</span>
            // roll
<span class="nc" id="L20748">            final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L20749">            r = new Report(2190);</span>
<span class="nc" id="L20750">            r.subject = entity.getId();</span>
<span class="nc" id="L20751">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L20752">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L20753">            r.add(diceRoll);</span>
<span class="nc bnc" id="L20754" title="All 2 branches missed.">            if ((diceRoll &lt; rollTarget.getValue())</span>
<span class="nc bnc" id="L20755" title="All 4 branches missed.">                    || (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2))) {
<span class="nc" id="L20757">                r.choose(false);</span>
                // Report the fumble
<span class="nc bnc" id="L20759" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2)) {
<span class="nc" id="L20761">                    r.messageId = 2306;</span>
                }
<span class="nc" id="L20763">                vPhaseReport.add(r);</span>
                // walking and running, 1 damage per MP used more than we would
                // have normally
<span class="nc bnc" id="L20766" title="All 12 branches missed.">                if ((entity.moved == EntityMovementType.MOVE_WALK)</span>
                        || (entity.moved == EntityMovementType.MOVE_VTOL_WALK)
                        || (entity.moved == EntityMovementType.MOVE_RUN)
                        || (entity.moved == EntityMovementType.MOVE_SPRINT)
                        || (entity.moved == EntityMovementType.MOVE_VTOL_RUN)
                        || (entity.moved == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc bnc" id="L20772" title="All 2 branches missed.">                    if (entity instanceof Mech) {</span>
<span class="nc" id="L20773">                        int j = entity.mpUsed;</span>
<span class="nc" id="L20774">                        int damage = 0;</span>
<span class="nc bnc" id="L20775" title="All 2 branches missed.">                        while (j &gt; entity.getRunningGravityLimit()) {</span>
<span class="nc" id="L20776">                            j--;</span>
<span class="nc" id="L20777">                            damage++;</span>
                        }
                        // Wee, direct internal damage
<span class="nc" id="L20780">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
<span class="nc bnc" id="L20782" title="All 2 branches missed.">                    } else if (entity instanceof Tank) {</span>
                        // if we got a pavement bonus, take care of it
<span class="nc bnc" id="L20784" title="All 2 branches missed.">                        int k = entity.gotPavementBonus ? 1 : 0;</span>
<span class="nc bnc" id="L20785" title="All 2 branches missed.">                        if (!entity.gotPavementBonus) {</span>
<span class="nc" id="L20786">                            int j = entity.mpUsed;</span>
<span class="nc" id="L20787">                            int damage = 0;</span>
<span class="nc bnc" id="L20788" title="All 2 branches missed.">                            while (j &gt; (entity.getRunMP(false, false, false) + k)) {</span>
<span class="nc" id="L20789">                                j--;</span>
<span class="nc" id="L20790">                                damage++;</span>
                            }
<span class="nc" id="L20792">                            vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                       damage));
                        }
                    }
                }
                // jumping
<span class="nc bnc" id="L20798" title="All 4 branches missed.">                if ((entity.moved == EntityMovementType.MOVE_JUMP)</span>
                    &amp;&amp; (entity instanceof Mech)) {
                    // low g, 1 damage for each hex jumped further than
                    // possible normally
<span class="nc bnc" id="L20802" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().getGravity() &lt; 1) {</span>
<span class="nc" id="L20803">                        int j = entity.mpUsed;</span>
<span class="nc" id="L20804">                        int damage = 0;</span>
<span class="nc bnc" id="L20805" title="All 2 branches missed.">                        while (j &gt; entity.getJumpMP(false)) {</span>
<span class="nc" id="L20806">                            j--;</span>
<span class="nc" id="L20807">                            damage++;</span>
                        }
                        // Wee, direct internal damage
<span class="nc" id="L20810">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
<span class="nc" id="L20812">                    }</span>
                    // high g, 1 damage for each MP we have less than normally
<span class="nc bnc" id="L20814" title="All 2 branches missed.">                    else if (game.getPlanetaryConditions().getGravity() &gt; 1) {</span>
<span class="nc" id="L20815">                        int damage = entity.getWalkMP(false, false)</span>
<span class="nc" id="L20816">                                     - entity.getWalkMP();</span>
                        // Wee, direct internal damage
<span class="nc" id="L20818">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20823">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
            } else {
<span class="nc" id="L20825">                r.choose(true);</span>
<span class="nc" id="L20826">                vPhaseReport.add(r);</span>
            }
        }

        // Glider ProtoMechs without sufficient movement to stay airborne make forced landings.
<span class="nc bnc" id="L20831" title="All 4 branches missed.">        if ((entity instanceof Protomech) &amp;&amp; ((Protomech)entity).isGlider()</span>
<span class="nc bnc" id="L20832" title="All 4 branches missed.">                &amp;&amp; entity.isAirborneVTOLorWIGE() &amp;&amp; (entity.getRunMP() &lt; 4)) {</span>
<span class="nc" id="L20833">            vPhaseReport.addAll(landGliderPM((Protomech) entity, entity.getPosition(), entity.getElevation(),</span>
                    entity.delta_distance));
        }

        // non mechs and prone mechs can now return
<span class="nc bnc" id="L20838" title="All 6 branches missed.">        if (!entity.canFall() || (entity.isHullDown() &amp;&amp; entity.canGoHullDown())) {</span>
<span class="nc" id="L20839">            return vPhaseReport;</span>
        }

        // Mechs with UMU float and don't have to roll???
<span class="nc bnc" id="L20843" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L20844">            IHex hex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L20845">            int water = hex.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L20846" title="All 4 branches missed.">            if ((water &gt; 0) &amp;&amp; (entity.getElevation() != -hex.depth(true))</span>
<span class="nc bnc" id="L20847" title="All 4 branches missed.">                    &amp;&amp; ((entity.getElevation() &lt; 0) || ((entity.getElevation() == 0)</span>
<span class="nc bnc" id="L20848" title="All 4 branches missed.">                    &amp;&amp; (hex.terrainLevel(Terrains.BRIDGE_ELEV) != 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE)))</span>
<span class="nc bnc" id="L20849" title="All 4 branches missed.">                    &amp;&amp; !entity.isMakingDfa() &amp;&amp; !entity.isDropping()) {</span>
                // mech is floating in water....
<span class="nc bnc" id="L20851" title="All 2 branches missed.">                if (entity.hasUMU()) {</span>
<span class="nc" id="L20852">                    return vPhaseReport;</span>
                }
                // game.addPSR(new PilotingRollData(entity.getId(),
                // TargetRoll.AUTOMATIC_FAIL, &quot;lost buoyancy&quot;));
            }
        }
        // add all cumulative mods from other rolls to each PSR
        // holds all rolls to make
<span class="nc" id="L20860">        Vector&lt;PilotingRollData&gt; rolls = new Vector&lt;&gt;();</span>
        // holds the initial reason for each roll
<span class="nc" id="L20862">        StringBuilder reasons = new StringBuilder();</span>
<span class="nc" id="L20863">        PilotingRollData base = entity.getBasePilotingRoll();</span>
<span class="nc" id="L20864">        entity.addPilotingModifierForTerrain(base);</span>
<span class="nc bnc" id="L20865" title="All 2 branches missed.">        for (Enumeration&lt;PilotingRollData&gt; i = game.getPSRs(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L20866">            PilotingRollData psr = i.nextElement();</span>
<span class="nc bnc" id="L20867" title="All 2 branches missed.">            if (psr.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L20868">                continue;</span>
            }
            // found a roll
<span class="nc bnc" id="L20871" title="All 2 branches missed.">            if (reasons.length() &gt; 0) {</span>
<span class="nc" id="L20872">                reasons.append(&quot;; &quot;);</span>
            }
<span class="nc" id="L20874">            reasons.append(psr.getPlainDesc());</span>
<span class="nc" id="L20875">            PilotingRollData toUse = entity.getBasePilotingRoll();</span>
<span class="nc" id="L20876">            entity.addPilotingModifierForTerrain(toUse);</span>
<span class="nc" id="L20877">            toUse.append(psr);</span>
            // now, append all other roll's cumulative mods, not the
            // non-cumulative
            // ones
<span class="nc bnc" id="L20881" title="All 2 branches missed.">            for (Enumeration&lt;PilotingRollData&gt; j = game.getPSRs(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L20882">                final PilotingRollData other = j.nextElement();</span>
<span class="nc bnc" id="L20883" title="All 4 branches missed.">                if ((other.getEntityId() != entity.getId()) || other.equals(psr)) {</span>
<span class="nc" id="L20884">                    continue;</span>
                }
<span class="nc" id="L20886">                toUse.append(other, false);</span>
<span class="nc" id="L20887">            }</span>
<span class="nc" id="L20888">            rolls.add(toUse);</span>
<span class="nc" id="L20889">        }</span>
        // any rolls needed?
<span class="nc bnc" id="L20891" title="All 2 branches missed.">        if (rolls.size() == 0) {</span>
<span class="nc" id="L20892">            return vPhaseReport;</span>
        }
        // is our base roll impossible?
<span class="nc bnc" id="L20895" title="All 4 branches missed.">        if ((base.getValue() == TargetRoll.AUTOMATIC_FAIL) || (base.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L20896">            r = new Report(2275);</span>
<span class="nc" id="L20897">            r.subject = entity.getId();</span>
<span class="nc" id="L20898">            r.addDesc(entity);</span>
<span class="nc" id="L20899">            r.add(rolls.size());</span>
<span class="nc" id="L20900">            r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L20901">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20902" title="All 2 branches missed.">            if (moving) {</span>
<span class="nc" id="L20903">                vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                        base, true));
<span class="nc bnc" id="L20905" title="All 4 branches missed.">            } else if ((entity instanceof Mech) &amp;&amp; game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20907" title="All 2 branches missed.">                    &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20908" title="All 4 branches missed.">                    &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20909" title="All 4 branches missed.">                if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L20910">                    r = new Report(2317);</span>
<span class="nc" id="L20911">                    r.subject = entity.getId();</span>
<span class="nc" id="L20912">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L20913">                    vPhaseReport.add(r);</span>
                } else {
<span class="nc" id="L20915">                    vPhaseReport.addAll(doEntityFall(entity, base));</span>
                }
            } else {
<span class="nc" id="L20918">                vPhaseReport.addAll(doEntityFall(entity, base));</span>
            }
            // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20921">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L20922">            return vPhaseReport;</span>
        }
        // loop through rolls we do have to make...
<span class="nc" id="L20925">        r = new Report(2280);</span>
<span class="nc" id="L20926">        r.subject = entity.getId();</span>
<span class="nc" id="L20927">        r.addDesc(entity);</span>
<span class="nc" id="L20928">        r.add(rolls.size());</span>
<span class="nc" id="L20929">        r.add(reasons.toString()); // international issue</span>
<span class="nc" id="L20930">        vPhaseReport.add(r);</span>
<span class="nc" id="L20931">        r = new Report(2285);</span>
<span class="nc" id="L20932">        r.subject = entity.getId();</span>
<span class="nc" id="L20933">        r.add(base.getValueAsString());</span>
<span class="nc" id="L20934">        r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L20935">        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20936" title="All 2 branches missed.">        for (int i = 0; i &lt; rolls.size(); i++) {</span>
<span class="nc" id="L20937">            PilotingRollData roll = rolls.elementAt(i);</span>
<span class="nc" id="L20938">            r = new Report(2290);</span>
<span class="nc" id="L20939">            r.subject = entity.getId();</span>
<span class="nc" id="L20940">            r.indent();</span>
<span class="nc" id="L20941">            r.newlines = 0;</span>
<span class="nc" id="L20942">            r.add(i + 1);</span>
<span class="nc" id="L20943">            r.add(roll.getDesc()); // international issue</span>
<span class="nc" id="L20944">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20945" title="All 2 branches missed.">            if ((roll.getValue() == TargetRoll.AUTOMATIC_FAIL)</span>
<span class="nc bnc" id="L20946" title="All 2 branches missed.">                || (roll.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L20947">                r = new Report(2295);</span>
<span class="nc" id="L20948">                r.subject = entity.getId();</span>
<span class="nc" id="L20949">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20950" title="All 2 branches missed.">                if (moving) {</span>
<span class="nc" id="L20951">                    vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                            roll, true));
                } else {
<span class="nc bnc" id="L20954" title="All 4 branches missed.">                    if ((entity instanceof Mech) &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20956" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20957" title="All 4 branches missed.">                            &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20958" title="All 4 branches missed.">                        if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L20959">                            r = new Report(2317);</span>
<span class="nc" id="L20960">                            r.subject = entity.getId();</span>
<span class="nc" id="L20961">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L20962">                            vPhaseReport.add(r);</span>
                        } else {
<span class="nc" id="L20964">                            vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                        }
                    } else {
<span class="nc" id="L20967">                        vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20971">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L20972">                return vPhaseReport;</span>
            }
<span class="nc" id="L20974">            int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L20975">            r = new Report(2300);</span>
<span class="nc" id="L20976">            r.add(roll);</span>
<span class="nc" id="L20977">            r.add(diceRoll);</span>
<span class="nc" id="L20978">            r.subject = entity.getId();</span>
<span class="nc bnc" id="L20979" title="All 2 branches missed.">            if ((diceRoll &lt; roll.getValue())</span>
<span class="nc bnc" id="L20980" title="All 4 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES) &amp;&amp; (diceRoll == 2))) {</span>
<span class="nc" id="L20981">                r.choose(false);</span>
                // Report the fumble
<span class="nc bnc" id="L20983" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2)) {
<span class="nc" id="L20985">                    r.messageId = 2306;</span>
                }
<span class="nc" id="L20987">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20988" title="All 2 branches missed.">                if (moving) {</span>
<span class="nc" id="L20989">                    vPhaseReport.addAll(doEntityFallsInto(entity,</span>
<span class="nc" id="L20990">                                                          entity.getElevation(), src, dest, roll, true));</span>
                } else {
<span class="nc bnc" id="L20992" title="All 2 branches missed.">                    if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L20993" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20995" title="All 2 branches missed.">                        &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20996" title="All 4 branches missed.">                        &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20997" title="All 2 branches missed.">                        if ((entity.getCrew().getPiloting() &gt; 1)</span>
<span class="nc bnc" id="L20998" title="All 2 branches missed.">                            &amp;&amp; ((roll.getValue() - diceRoll) &lt; 2)) {</span>
<span class="nc" id="L20999">                            entity.setHullDown(true);</span>
<span class="nc bnc" id="L21000" title="All 2 branches missed.">                        } else if ((entity.getCrew().getPiloting() &lt;= 1)</span>
<span class="nc bnc" id="L21001" title="All 2 branches missed.">                                   &amp;&amp; ((roll.getValue() - diceRoll) &lt; 3)) {</span>
<span class="nc" id="L21002">                            entity.setHullDown(true);</span>
                        }
<span class="nc bnc" id="L21004" title="All 4 branches missed.">                        if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L21005">                            ServerHelper.sinkToBottom(entity);</span>
                            
<span class="nc" id="L21007">                            r = new Report(2317);</span>
<span class="nc" id="L21008">                            r.subject = entity.getId();</span>
<span class="nc" id="L21009">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L21010">                            vPhaseReport.add(r);</span>
                        } else {
<span class="nc" id="L21012">                            vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                        }
                    } else {
<span class="nc" id="L21015">                        vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L21019">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L21020">                return vPhaseReport;</span>
            }
<span class="nc" id="L21022">            r.choose(true);</span>
<span class="nc" id="L21023">            vPhaseReport.add(r);</span>
        }
<span class="nc" id="L21025">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; checkForTraitors() {
<span class="nc" id="L21029">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
        // check for traitors
<span class="nc bnc" id="L21031" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21032">            Entity entity = i.next();</span>
<span class="nc bnc" id="L21033" title="All 6 branches missed.">            if (entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard()</span>
<span class="nc bnc" id="L21034" title="All 2 branches missed.">                    || !entity.isDeployed()) {</span>
<span class="nc" id="L21035">                continue;</span>
            }
<span class="nc bnc" id="L21037" title="All 4 branches missed.">            if ((entity.getTraitorId() != -1) &amp;&amp; (entity.getOwnerId() != entity.getTraitorId())) {</span>
<span class="nc" id="L21038">                final IPlayer oldPlayer = game.getPlayer(entity.getOwnerId());</span>
<span class="nc" id="L21039">                final IPlayer newPlayer = game.getPlayer(entity.getTraitorId());</span>
<span class="nc bnc" id="L21040" title="All 2 branches missed.">                if (newPlayer != null) {</span>
<span class="nc" id="L21041">                    Report r = new Report(7305);</span>
<span class="nc" id="L21042">                    r.subject = entity.getId();</span>
<span class="nc" id="L21043">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L21044">                    r.add(newPlayer.getName());</span>
<span class="nc" id="L21045">                    entity.setOwner(newPlayer);</span>
<span class="nc" id="L21046">                    entityUpdate(entity.getId());</span>
<span class="nc" id="L21047">                    vFullReport.add(r);</span>

                    // Move the initial count and BV to their new player
<span class="nc" id="L21050">                    newPlayer.changeInitialEntityCount(1);</span>
<span class="nc" id="L21051">                    newPlayer.changeInitialBV(entity.calculateBattleValue());</span>

                    // And remove it from their old player, if they exist
<span class="nc bnc" id="L21054" title="All 2 branches missed.">                    if (oldPlayer != null) {</span>
<span class="nc" id="L21055">                        oldPlayer.changeInitialEntityCount(-1);</span>
                        // Note: I don't remove the full initial BV if I'm damaged, but that
                        // actually makes sense
<span class="nc" id="L21058">                        oldPlayer.changeInitialBV(-1 * entity.calculateBattleValue());</span>
                    }
                }
<span class="nc" id="L21061">                entity.setTraitorId(-1);</span>
            }
<span class="nc" id="L21063">        }</span>
<span class="nc bnc" id="L21064" title="All 2 branches missed.">        if (!vFullReport.isEmpty()) {</span>
<span class="nc" id="L21065">            vFullReport.add(0, new Report(7300));</span>
        }
<span class="nc" id="L21067">        return vFullReport;</span>
    }

    /**
     * Resolves all built up control rolls. Used only during end phase
     */
    private Vector&lt;Report&gt; resolveControlRolls() {
<span class="nc" id="L21074">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L21075">        vFullReport.add(new Report(5001, Report.PUBLIC));</span>
<span class="nc bnc" id="L21076" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21077">            vFullReport.addAll(resolveControl(i.next()));</span>
        }
<span class="nc" id="L21079">        game.resetControlRolls();</span>
<span class="nc" id="L21080">        return vFullReport;</span>
    }

    /**
     * Resolves and reports all control skill rolls for a single aero or airborne LAM in airmech mode.
     */
    private Vector&lt;Report&gt; resolveControl(Entity e) {
<span class="nc" id="L21087">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L21088" title="All 8 branches missed.">        if (e.isDoomed() || e.isDestroyed() || e.isOffBoard() || !e.isDeployed()) {</span>
<span class="nc" id="L21089">            return vReport;</span>
        }
        Report r;

        /*
         * See forum answers on OOC
         * http://forums.classicbattletech.com/index.php/topic,20424.0.html
         */

<span class="nc" id="L21098">        IAero a = null;</span>
<span class="nc" id="L21099">        boolean canRecover = false;</span>
<span class="nc bnc" id="L21100" title="All 6 branches missed.">        if (e.isAero() &amp;&amp; (e.isAirborne() || e.isSpaceborne())) {</span>
<span class="nc" id="L21101">            a = (IAero) e;</span>
            // they should get a shot at a recovery roll at the end of all this
            // if they are already out of control
<span class="nc" id="L21104">            canRecover = a.isOutControl();</span>
<span class="nc bnc" id="L21105" title="All 4 branches missed.">        } else if (!(e instanceof LandAirMech) || !e.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L21106">            return vReport;</span>
        }

        // if the unit already is moving randomly then it can't get any
        // worse
<span class="nc bnc" id="L21111" title="All 4 branches missed.">        if (a == null || !a.isRandomMove()) {</span>

            // find control rolls and make them
<span class="nc" id="L21114">            Vector&lt;PilotingRollData&gt; rolls = new Vector&lt;&gt;();</span>
<span class="nc" id="L21115">            StringBuilder reasons = new StringBuilder();</span>
<span class="nc" id="L21116">            PilotingRollData target = e.getBasePilotingRoll();</span>
            // maneuvering ace
            // TODO : pending rules query
            // http://www.classicbattletech.com/forums/index.php/topic,63552.new.html#new
            // for now I am assuming Man Ace applies to all out-of-control
            // rolls, but not other
            // uses of control rolls (thus it doesn't go in
            // Entity#addEntityBonuses) and
            // furthermore it doesn't apply to recovery rolls
<span class="nc bnc" id="L21125" title="All 2 branches missed.">            if (e.isUsingManAce()) {</span>
<span class="nc" id="L21126">                target.addModifier(-1, &quot;maneuvering ace&quot;);</span>
            }
<span class="nc bnc" id="L21128" title="All 2 branches missed.">            for (Enumeration&lt;PilotingRollData&gt; j = game.getControlRolls(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L21129">                final PilotingRollData modifier = j.nextElement();</span>
<span class="nc bnc" id="L21130" title="All 2 branches missed.">                if (modifier.getEntityId() != e.getId()) {</span>
<span class="nc" id="L21131">                    continue;</span>
                }
                // found a roll, add it
<span class="nc" id="L21134">                rolls.addElement(modifier);</span>
<span class="nc bnc" id="L21135" title="All 2 branches missed.">                if (reasons.length() &gt; 0) {</span>
<span class="nc" id="L21136">                    reasons.append(&quot;; &quot;);</span>
                }
<span class="nc" id="L21138">                reasons.append(modifier.getCumulativePlainDesc());</span>
<span class="nc" id="L21139">                target.append(modifier);</span>
<span class="nc" id="L21140">            }</span>
            // any rolls needed?
<span class="nc bnc" id="L21142" title="All 2 branches missed.">            if (rolls.size() &gt; 0) {</span>
                // loop through rolls we do have to make...
<span class="nc" id="L21144">                r = new Report(9310);</span>
<span class="nc" id="L21145">                r.subject = e.getId();</span>
<span class="nc" id="L21146">                r.addDesc(e);</span>
<span class="nc" id="L21147">                r.add(rolls.size());</span>
<span class="nc" id="L21148">                r.add(reasons.toString()); // international issue</span>
<span class="nc" id="L21149">                vReport.add(r);</span>
<span class="nc" id="L21150">                r = new Report(2285);</span>
<span class="nc" id="L21151">                r.subject = e.getId();</span>
<span class="nc" id="L21152">                r.add(target.getValueAsString());</span>
<span class="nc" id="L21153">                r.add(target.getDesc()); // international issue</span>
<span class="nc" id="L21154">                vReport.add(r);</span>
<span class="nc bnc" id="L21155" title="All 2 branches missed.">                for (int j = 0; j &lt; rolls.size(); j++) {</span>
<span class="nc" id="L21156">                    PilotingRollData modifier = rolls.elementAt(j);</span>
<span class="nc" id="L21157">                    r = new Report(2290);</span>
<span class="nc" id="L21158">                    r.subject = e.getId();</span>
<span class="nc" id="L21159">                    r.indent();</span>
<span class="nc" id="L21160">                    r.newlines = 0;</span>
<span class="nc" id="L21161">                    r.add(j + 1);</span>
<span class="nc" id="L21162">                    r.add(modifier.getPlainDesc()); // international issue</span>
<span class="nc" id="L21163">                    vReport.add(r);</span>
<span class="nc" id="L21164">                    int diceRoll = Compute.d6(2);</span>
                    // different reports depending on out-of-control status
<span class="nc bnc" id="L21166" title="All 4 branches missed.">                    if (a != null &amp;&amp; a.isOutControl()) {</span>
<span class="nc" id="L21167">                        r = new Report(9360);</span>
<span class="nc" id="L21168">                        r.subject = e.getId();</span>
<span class="nc" id="L21169">                        r.add(target);</span>
<span class="nc" id="L21170">                        r.add(diceRoll);</span>
<span class="nc bnc" id="L21171" title="All 2 branches missed.">                        if (diceRoll &lt; (target.getValue() - 5)) {</span>
<span class="nc" id="L21172">                            r.choose(false);</span>
<span class="nc" id="L21173">                            vReport.add(r);</span>
<span class="nc" id="L21174">                            a.setRandomMove(true);</span>
                        } else {
<span class="nc" id="L21176">                            r.choose(true);</span>
<span class="nc" id="L21177">                            vReport.add(r);</span>
                        }
                    } else {
<span class="nc" id="L21180">                        r = new Report(9315);</span>
<span class="nc" id="L21181">                        r.subject = e.getId();</span>
<span class="nc" id="L21182">                        r.add(target);</span>
<span class="nc" id="L21183">                        r.add(diceRoll);</span>
<span class="nc" id="L21184">                        r.newlines = 1;</span>
<span class="nc bnc" id="L21185" title="All 2 branches missed.">                        if (diceRoll &lt; target.getValue()) {</span>
<span class="nc" id="L21186">                            r.choose(false);</span>
<span class="nc" id="L21187">                            vReport.add(r);</span>
<span class="nc bnc" id="L21188" title="All 2 branches missed.">                            if (a != null) {</span>
<span class="nc" id="L21189">                                a.setOutControl(true);</span>
                                // do we have random movement?
<span class="nc bnc" id="L21191" title="All 2 branches missed.">                                if ((target.getValue() - diceRoll) &gt; 5) {</span>
<span class="nc" id="L21192">                                    r = new Report(9365);</span>
<span class="nc" id="L21193">                                    r.newlines = 0;</span>
<span class="nc" id="L21194">                                    r.subject = e.getId();</span>
<span class="nc" id="L21195">                                    vReport.add(r);</span>
<span class="nc" id="L21196">                                    a.setRandomMove(true);</span>
                                }
                                // if on the atmospheric map, then lose altitude
                                // and check
                                // for crash
<span class="nc bnc" id="L21201" title="All 4 branches missed.">                                if (!a.isSpaceborne() &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L21202">                                    int loss = Compute.d6(1);</span>
<span class="nc" id="L21203">                                    int origAltitude = e.getAltitude();</span>
<span class="nc" id="L21204">                                    e.setAltitude(e.getAltitude() - loss);</span>
                                    //Reroll altitude loss with edge if the new altitude would result in a crash
<span class="nc bnc" id="L21206" title="All 4 branches missed.">                                    if (e.getAltitude() &lt;= 0</span>
                                            //Don't waste the edge if it won't help
                                            &amp;&amp; origAltitude &gt; 1
<span class="nc bnc" id="L21209" title="All 2 branches missed.">                                            &amp;&amp; e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21210" title="All 2 branches missed.">                                            &amp;&amp; e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_ALT_LOSS)) {</span>
<span class="nc" id="L21211">                                        loss = Compute.d6(1);</span>
                                        //Report the edge use
<span class="nc" id="L21213">                                        r = new Report(9367);</span>
<span class="nc" id="L21214">                                        r.newlines = 1;</span>
<span class="nc" id="L21215">                                        r.subject = e.getId();</span>
<span class="nc" id="L21216">                                        vReport.add(r);</span>
<span class="nc" id="L21217">                                        e.setAltitude(origAltitude - loss);</span>
                                        // and spend the edge point
<span class="nc" id="L21219">                                        e.getCrew().decreaseEdge();</span>
                                    }
                                    //Report the altitude loss
<span class="nc" id="L21222">                                    r = new Report(9366);</span>
<span class="nc" id="L21223">                                    r.newlines = 0;</span>
<span class="nc" id="L21224">                                    r.subject = e.getId();</span>
<span class="nc" id="L21225">                                    r.addDesc(e);</span>
<span class="nc" id="L21226">                                    r.add(loss);</span>
<span class="nc" id="L21227">                                    vReport.add(r);</span>
                                    // check for crash
<span class="nc bnc" id="L21229" title="All 2 branches missed.">                                    if (checkCrash(e, e.getPosition(),</span>
<span class="nc" id="L21230">                                            e.getAltitude())) {</span>
<span class="nc" id="L21231">                                        vReport.addAll(processCrash(e,</span>
<span class="nc" id="L21232">                                                a.getCurrentVelocity(),</span>
<span class="nc" id="L21233">                                                e.getPosition()));</span>
<span class="nc" id="L21234">                                        break;</span>
                                    }
<span class="nc" id="L21236">                                }</span>
<span class="nc bnc" id="L21237" title="All 4 branches missed.">                            } else if (e instanceof LandAirMech &amp;&amp; e.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L21238">                                int loss = target.getValue() - diceRoll;</span>
<span class="nc" id="L21239">                                r = new Report(9366);</span>
<span class="nc" id="L21240">                                r.subject = e.getId();</span>
<span class="nc" id="L21241">                                r.addDesc(e);</span>
<span class="nc" id="L21242">                                r.add(loss);</span>
<span class="nc" id="L21243">                                vReport.add(r);</span>
<span class="nc" id="L21244">                                IHex hex = game.getBoard().getHex(e.getPosition());</span>
<span class="nc" id="L21245">                                int elevation = Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc bnc" id="L21246" title="All 2 branches missed.">                                if (e.getElevation() - loss &lt;= elevation) {</span>
<span class="nc" id="L21247">                                    crashAirMech(e, target, vReport);</span>
                                } else {
<span class="nc" id="L21249">                                    e.setElevation(e.getElevation() - loss);</span>
                                }
<span class="nc" id="L21251">                            }</span>
                        } else {
<span class="nc" id="L21253">                            r.choose(true);</span>
<span class="nc" id="L21254">                            vReport.add(r);</span>
                        }
                    }
                }
            }
        }

        // if they were out-of-control to start with, give them a chance to
        // regain control
<span class="nc bnc" id="L21263" title="All 2 branches missed.">        if (canRecover) {</span>
<span class="nc" id="L21264">            PilotingRollData base = e.getBasePilotingRoll();</span>
            // is our base roll impossible?
<span class="nc bnc" id="L21266" title="All 2 branches missed.">            if ((base.getValue() == TargetRoll.AUTOMATIC_FAIL)</span>
<span class="nc bnc" id="L21267" title="All 2 branches missed.">                    || (base.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
                // report something
<span class="nc" id="L21269">                r = new Report(9340);</span>
<span class="nc" id="L21270">                r.subject = e.getId();</span>
<span class="nc" id="L21271">                r.addDesc(e);</span>
<span class="nc" id="L21272">                r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L21273">                vReport.add(r);</span>
<span class="nc" id="L21274">                return vReport;</span>
            }
<span class="nc" id="L21276">            r = new Report(9345);</span>
<span class="nc" id="L21277">            r.subject = e.getId();</span>
<span class="nc" id="L21278">            r.addDesc(e);</span>
<span class="nc" id="L21279">            r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L21280">            vReport.add(r);</span>
<span class="nc" id="L21281">            int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L21282">            r = new Report(9350);</span>
<span class="nc" id="L21283">            r.subject = e.getId();</span>
<span class="nc" id="L21284">            r.add(base);</span>
<span class="nc" id="L21285">            r.add(diceRoll);</span>
<span class="nc bnc" id="L21286" title="All 2 branches missed.">            if (diceRoll &lt; base.getValue()) {</span>
<span class="nc" id="L21287">                r.choose(false);</span>
<span class="nc" id="L21288">                vReport.add(r);</span>
            } else {
<span class="nc" id="L21290">                r.choose(true);</span>
<span class="nc" id="L21291">                vReport.add(r);</span>
<span class="nc" id="L21292">                a.setOutControl(false);</span>
<span class="nc" id="L21293">                a.setOutCtrlHeat(false);</span>
<span class="nc" id="L21294">                a.setRandomMove(false);</span>
            }
        }
<span class="nc" id="L21297">        return vReport;</span>
    }

    /**
     * Inflict damage on a pilot
     *
     * @param en     The &lt;code&gt;Entity&lt;/code&gt; who's pilot gets damaged.
     * @param damage The &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    public Vector&lt;Report&gt; damageCrew(Entity en, int damage) {
<span class="nc" id="L21307">        return damageCrew(en, damage, -1);</span>
    }

    /**
     * Inflict damage on a pilot
     *
     * @param en        The &lt;code&gt;Entity&lt;/code&gt; who's pilot gets damaged.
     * @param damage    The &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param crewPos   The &lt;code&gt;int&lt;/code&gt;position of the crew member in a &lt;code&gt;MultiCrewCockpit&lt;/crew&gt;
     *                  that takes the damage. A value &lt; 0 applies the damage to all crew members.
     *                  The basic &lt;crew&gt;Crew&lt;/crew&gt; ignores this value.
     */
    public Vector&lt;Report&gt; damageCrew(Entity en, int damage, int crewPos) {
<span class="nc" id="L21320">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L21321">        Crew crew = en.getCrew();</span>
        Report r;
<span class="nc bnc" id="L21323" title="All 6 branches missed.">        if (!crew.isDead() &amp;&amp; !crew.isEjected() &amp;&amp; !crew.isDoomed()) {</span>
<span class="nc bnc" id="L21324" title="All 2 branches missed.">            for (int pos = 0; pos &lt; en.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L21325" title="All 4 branches missed.">                if (crewPos &gt;= 0</span>
<span class="nc bnc" id="L21326" title="All 2 branches missed.">                        &amp;&amp; (crewPos != pos || crew.isDead(crewPos))) {</span>
<span class="nc" id="L21327">                    continue;</span>
                }
<span class="nc bnc" id="L21329" title="All 2 branches missed.">                boolean wasPilot = crew.getCurrentPilotIndex() == pos;</span>
<span class="nc bnc" id="L21330" title="All 2 branches missed.">                boolean wasGunner = crew.getCurrentGunnerIndex() == pos;</span>
<span class="nc" id="L21331">                crew.setHits(crew.getHits(pos) + damage, pos);</span>
<span class="nc bnc" id="L21332" title="All 2 branches missed.">                if (en.isLargeCraft()) {</span>
<span class="nc" id="L21333">                    r = new Report (6028);</span>
<span class="nc" id="L21334">                    r.subject = en.getId();</span>
<span class="nc" id="L21335">                    r.indent(2);</span>
<span class="nc" id="L21336">                    r.addDesc(en);</span>
<span class="nc" id="L21337">                    r.add(damage);</span>
<span class="nc bnc" id="L21338" title="All 2 branches missed.">                    if (((Aero)en).isEjecting()) {</span>
<span class="nc" id="L21339">                        r.add(&quot;as crew depart the ship&quot;);</span>
                    } else {
                        //Blank data
<span class="nc" id="L21342">                        r.add(&quot;&quot;);</span>
                    }
<span class="nc" id="L21344">                    r.add(crew.getHits(pos));</span>
<span class="nc" id="L21345">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L21346" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits()) {</span>
<span class="nc" id="L21347">                        vDesc.addAll(resolveCrewDamage(en, damage, pos));</span>
<span class="nc bnc" id="L21348" title="All 2 branches missed.">                    } else if (!crew.isDoomed()) {</span>
<span class="nc" id="L21349">                        crew.setDoomed(true);</span>
                        //Safety. We might use this logic for large naval vessels later on
<span class="nc bnc" id="L21351" title="All 4 branches missed.">                        if (en instanceof Aero &amp;&amp; ((Aero)en).isEjecting()) {</span>
<span class="nc" id="L21352">                            vDesc.addAll(destroyEntity(en, &quot;ejection&quot;, true));</span>
<span class="nc" id="L21353">                            ((Aero)en).setEjecting(false);</span>
                        } else {
<span class="nc" id="L21355">                            vDesc.addAll(destroyEntity(en, &quot;crew casualties&quot;, true));</span>
                        }
                    }
                } else {
<span class="nc bnc" id="L21359" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits(pos)) {</span>
<span class="nc" id="L21360">                        r = new Report(6025);</span>
                    } else {
<span class="nc" id="L21362">                        r = new Report(6026);</span>
                    }
<span class="nc" id="L21364">                    r.subject = en.getId();</span>
<span class="nc" id="L21365">                    r.indent(2);</span>
<span class="nc" id="L21366">                    r.add(crew.getCrewType().getRoleName(pos));</span>
<span class="nc" id="L21367">                    r.addDesc(en);</span>
<span class="nc" id="L21368">                    r.add(crew.getName(pos));</span>
<span class="nc" id="L21369">                    r.add(damage);</span>
<span class="nc" id="L21370">                    r.add(crew.getHits(pos));</span>
<span class="nc" id="L21371">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L21372" title="All 2 branches missed.">                    if (crew.isDead(pos)) {</span>
<span class="nc" id="L21373">                        r = createCrewTakeoverReport(en, pos, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L21374" title="All 2 branches missed.">                        if (null != r) {</span>
<span class="nc" id="L21375">                            vDesc.addElement(r);</span>
                        }
                    }
<span class="nc bnc" id="L21378" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits()) {</span>
<span class="nc" id="L21379">                        vDesc.addAll(resolveCrewDamage(en, damage, pos));</span>
<span class="nc bnc" id="L21380" title="All 2 branches missed.">                    } else if (!crew.isDoomed()) {</span>
<span class="nc" id="L21381">                        crew.setDoomed(true);</span>
<span class="nc" id="L21382">                        vDesc.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                    }
                }
            }
        } else {
<span class="nc bnc" id="L21387" title="All 8 branches missed.">            boolean isPilot = (en instanceof Mech) || ((en instanceof Aero)</span>
                    &amp;&amp; !(en instanceof SmallCraft) &amp;&amp; !(en instanceof Jumpship));
<span class="nc bnc" id="L21389" title="All 4 branches missed.">            if (crew.isDead() || crew.isDoomed()) {</span>
<span class="nc bnc" id="L21390" title="All 2 branches missed.">                if (isPilot) {</span>
<span class="nc" id="L21391">                    r = new Report(6021);</span>
                } else {
<span class="nc" id="L21393">                    r = new Report(6022);</span>
                }
            } else {
<span class="nc bnc" id="L21396" title="All 2 branches missed.">                if (isPilot) {</span>
<span class="nc" id="L21397">                    r = new Report(6023);</span>
                } else {
<span class="nc" id="L21399">                    r = new Report(6024);</span>
                }
            }
<span class="nc" id="L21402">            r.subject = en.getId();</span>
<span class="nc" id="L21403">            r.addDesc(en);</span>
<span class="nc" id="L21404">            r.add(crew.getName());</span>
<span class="nc" id="L21405">            r.indent(2);</span>
<span class="nc" id="L21406">            vDesc.add(r);</span>
        }
<span class="nc bnc" id="L21408" title="All 4 branches missed.">        if (en.isAirborneVTOLorWIGE() &amp;&amp; !en.getCrew().isActive()) {</span>
<span class="nc bnc" id="L21409" title="All 2 branches missed.">            if (en instanceof LandAirMech) {</span>
<span class="nc" id="L21410">                crashAirMech(en, en.getBasePilotingRoll(), vDesc);</span>
<span class="nc bnc" id="L21411" title="All 2 branches missed.">            } else if (en instanceof Protomech) {</span>
<span class="nc" id="L21412">                vDesc.addAll(landGliderPM((Protomech)en));</span>
            }
        }
<span class="nc" id="L21415">        return vDesc;</span>
    }

    /**
     * Convenience method that fills in a report showing that a crew member of a multicrew cockpit
     * has taken over for another incapacitated crew member.
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; for the crew.
     * @param slot      The slot index of the crew member that was incapacitated.
     * @param wasPilot  Whether the crew member was the pilot before becoming incapacitated.
     * @param wasGunner Whether the crew member was the gunner before becoming incapacitated.
     * @return          A completed &lt;code&gt;Report&lt;/code&gt; if the position was assumed by another
     *                  crew members, otherwise null.
     */
    private Report createCrewTakeoverReport(Entity e, int slot, boolean wasPilot, boolean wasGunner) {
<span class="nc bnc" id="L21430" title="All 4 branches missed.">        if (wasPilot &amp;&amp; e.getCrew().getCurrentPilotIndex() != slot) {</span>
<span class="nc" id="L21431">            Report r = new Report(5560);</span>
<span class="nc" id="L21432">            r.subject = e.getId();</span>
<span class="nc" id="L21433">            r.indent(4);</span>
<span class="nc" id="L21434">            r.add(e.getCrew().getNameAndRole(e.getCrew().getCurrentPilotIndex()));</span>
<span class="nc" id="L21435">            r.add(e.getCrew().getCrewType().getRoleName(e.getCrew().getCrewType().getPilotPos()));</span>
<span class="nc" id="L21436">            r.addDesc(e);</span>
<span class="nc" id="L21437">            return r;</span>
        }
<span class="nc bnc" id="L21439" title="All 4 branches missed.">        if (wasGunner &amp;&amp; e.getCrew().getCurrentGunnerIndex() != slot) {</span>
<span class="nc" id="L21440">            Report r = new Report(5560);</span>
<span class="nc" id="L21441">            r.subject = e.getId();</span>
<span class="nc" id="L21442">            r.indent(4);</span>
<span class="nc" id="L21443">            r.add(e.getCrew().getNameAndRole(e.getCrew().getCurrentGunnerIndex()));</span>
<span class="nc" id="L21444">            r.add(e.getCrew().getCrewType().getRoleName(e.getCrew().getCrewType().getGunnerPos()));</span>
<span class="nc" id="L21445">            r.addDesc(e);</span>
<span class="nc" id="L21446">            return r;</span>
        }
<span class="nc" id="L21448">        return null;</span>
    }

    /**
     * resolves consciousness rolls for one entity
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; that took damage
     * @param damage    The &lt;code&gt;int&lt;/code&gt; damage taken by the pilot
     * @param crewPos   The &lt;code&gt;int&lt;/code&gt; index of the crew member for multi crew cockpits, ignored by
     *                  basic &lt;code&gt;crew&lt;/code&gt;
     */
    private Vector&lt;Report&gt; resolveCrewDamage(Entity e, int damage, int crewPos) {
<span class="nc" id="L21460">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L21461">        final int totalHits = e.getCrew().getHits(crewPos);</span>
<span class="nc bnc" id="L21462" title="All 4 branches missed.">        if ((e instanceof MechWarrior) || !e.isTargetable()</span>
<span class="nc bnc" id="L21463" title="All 4 branches missed.">            || !e.getCrew().isActive(crewPos) || (damage == 0)) {</span>
<span class="nc" id="L21464">            return vDesc;</span>
        }

        // no consciousness roll for pain-shunted warriors
<span class="nc bnc" id="L21468" title="All 2 branches missed.">        if (e.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L21469">            return vDesc;</span>
        }

        // no consciousness roll for capital fighter pilots or large craft crews
<span class="nc bnc" id="L21473" title="All 4 branches missed.">        if (e.isCapitalFighter() || e.isLargeCraft()) {</span>
<span class="nc" id="L21474">            return vDesc;</span>
        }

<span class="nc bnc" id="L21477" title="All 2 branches missed.">        for (int hit = (totalHits - damage) + 1; hit &lt;= totalHits; hit++) {</span>
<span class="nc" id="L21478">            int rollTarget = Compute.getConsciousnessNumber(hit);</span>
<span class="nc bnc" id="L21479" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.RPG_TOUGHNESS)) {</span>
<span class="nc" id="L21480">                rollTarget -= e.getCrew().getToughness(crewPos);</span>
            }
<span class="nc" id="L21482">            boolean edgeUsed = false;</span>
            do {
<span class="nc bnc" id="L21484" title="All 2 branches missed.">                if (edgeUsed) {</span>
<span class="nc" id="L21485">                    e.getCrew().decreaseEdge();</span>
                }
<span class="nc" id="L21487">                int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L21488" title="All 2 branches missed.">                if (e.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)) {</span>
<span class="nc" id="L21489">                    roll = Math.min(12, roll + 1);</span>
                }
<span class="nc" id="L21491">                Report r = new Report(6030);</span>
<span class="nc" id="L21492">                r.indent(2);</span>
<span class="nc" id="L21493">                r.subject = e.getId();</span>
<span class="nc" id="L21494">                r.add(e.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L21495">                r.addDesc(e);</span>
<span class="nc" id="L21496">                r.add(e.getCrew().getName(crewPos));</span>
<span class="nc" id="L21497">                r.add(rollTarget);</span>
<span class="nc" id="L21498">                r.add(roll);</span>
<span class="nc bnc" id="L21499" title="All 2 branches missed.">                if (roll &gt;= rollTarget) {</span>
<span class="nc" id="L21500">                    e.getCrew().setKoThisRound(false, crewPos);</span>
<span class="nc" id="L21501">                    r.choose(true);</span>
                } else {
<span class="nc" id="L21503">                    e.getCrew().setKoThisRound(true, crewPos);</span>
<span class="nc" id="L21504">                    r.choose(false);</span>
<span class="nc bnc" id="L21505" title="All 2 branches missed.">                    if (e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21506" title="All 2 branches missed.">                            &amp;&amp; (e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_KO)</span>
<span class="nc bnc" id="L21507" title="All 2 branches missed.">                            || e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_KO))) {</span>
<span class="nc" id="L21508">                        edgeUsed = true;</span>
<span class="nc" id="L21509">                        vDesc.add(r);</span>
<span class="nc" id="L21510">                        r = new Report(6520);</span>
<span class="nc" id="L21511">                        r.subject = e.getId();</span>
<span class="nc" id="L21512">                        r.addDesc(e);</span>
<span class="nc" id="L21513">                        r.add(e.getCrew().getName(crewPos));</span>
<span class="nc" id="L21514">                        r.add(e.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
                    } // if
                    // return true;
                } // else
<span class="nc" id="L21518">                vDesc.add(r);</span>
<span class="nc bnc" id="L21519" title="All 2 branches missed.">            } while (e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21520" title="All 2 branches missed.">                     &amp;&amp; e.getCrew().isKoThisRound(crewPos)</span>
<span class="nc bnc" id="L21521" title="All 2 branches missed.">                     &amp;&amp; (e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_KO)</span>
<span class="nc bnc" id="L21522" title="All 2 branches missed.">                         || e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_KO)));</span>
            // end of do-while
<span class="nc bnc" id="L21524" title="All 2 branches missed.">            if (e.getCrew().isKoThisRound(crewPos)) {</span>
<span class="nc bnc" id="L21525" title="All 2 branches missed.">                boolean wasPilot = e.getCrew().getCurrentPilotIndex() == crewPos;</span>
<span class="nc bnc" id="L21526" title="All 2 branches missed.">                boolean wasGunner = e.getCrew().getCurrentGunnerIndex() == crewPos;</span>
<span class="nc" id="L21527">                e.getCrew().setUnconscious(true, crewPos);</span>
<span class="nc" id="L21528">                Report r = createCrewTakeoverReport(e, crewPos, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L21529" title="All 2 branches missed.">                if (null != r) {</span>
<span class="nc" id="L21530">                    vDesc.add(r);</span>
                }
<span class="nc" id="L21532">                return vDesc;</span>
            }
        }
<span class="nc" id="L21535">        return vDesc;</span>
    }

    /**
     * Make the rolls indicating whether any unconscious crews wake up
     */
    private void resolveCrewWakeUp() {
<span class="nc bnc" id="L21542" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21543">            final Entity e = i.next();</span>

            // only unconscious pilots of mechs and protos, ASF and Small Craft
            // and MechWarriors can roll to wake up
<span class="nc bnc" id="L21547" title="All 12 branches missed.">            if (e.isTargetable()</span>
                    &amp;&amp; ((e instanceof Mech) || (e instanceof Protomech)
                            || (e instanceof MechWarrior) || ((e instanceof Aero) &amp;&amp; !(e instanceof Jumpship)))) {
<span class="nc bnc" id="L21550" title="All 2 branches missed.">                for (int pos = 0; pos &lt; e.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L21551" title="All 2 branches missed.">                    if (e.getCrew().isMissing(pos)) {</span>
<span class="nc" id="L21552">                        continue;</span>
                    }
<span class="nc bnc" id="L21554" title="All 2 branches missed.">                    if (e.getCrew().isUnconscious(pos)</span>
<span class="nc bnc" id="L21555" title="All 2 branches missed.">                            &amp;&amp; !e.getCrew().isKoThisRound(pos)) {</span>
<span class="nc" id="L21556">                        int roll = Compute.d6(2);</span>

<span class="nc bnc" id="L21558" title="All 2 branches missed.">                        if (e.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)) {</span>
<span class="nc" id="L21559">                            roll = Math.min(12, roll + 1);</span>
                        }

<span class="nc" id="L21562">                        int rollTarget = Compute.getConsciousnessNumber(e.getCrew()</span>
<span class="nc" id="L21563">                                                                         .getHits(pos));</span>
<span class="nc" id="L21564">                        Report r = new Report(6029);</span>
<span class="nc" id="L21565">                        r.subject = e.getId();</span>
<span class="nc" id="L21566">                        r.add(e.getCrew().getCrewType().getRoleName(pos));</span>
<span class="nc" id="L21567">                        r.addDesc(e);</span>
<span class="nc" id="L21568">                        r.add(e.getCrew().getName(pos));</span>
<span class="nc" id="L21569">                        r.add(rollTarget);</span>
<span class="nc" id="L21570">                        r.add(roll);</span>
<span class="nc bnc" id="L21571" title="All 2 branches missed.">                        if (roll &gt;= rollTarget) {</span>
<span class="nc" id="L21572">                            r.choose(true);</span>
<span class="nc" id="L21573">                            e.getCrew().setUnconscious(false, pos);</span>
                        } else {
<span class="nc" id="L21575">                            r.choose(false);</span>
                        }
<span class="nc" id="L21577">                        addReport(r);</span>
                    }
                }
            }
<span class="nc" id="L21581">        }</span>
<span class="nc" id="L21582">    }</span>

    /**
     * Check whether any &lt;code&gt;Entity&lt;/code&gt; with a cockpit command console has been scheduled to swap
     * roles between the two crew members.
     */
    private void resolveConsoleCrewSwaps() {
<span class="nc bnc" id="L21589" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21590">            final Entity e = i.next();</span>
<span class="nc bnc" id="L21591" title="All 2 branches missed.">            if (e.getCrew().doConsoleRoleSwap()) {</span>
<span class="nc" id="L21592">                final Crew crew = e.getCrew();</span>
<span class="nc" id="L21593">                final int current = crew.getCurrentPilotIndex();</span>
<span class="nc" id="L21594">                Report r = new Report(5560);</span>
<span class="nc" id="L21595">                r.subject = e.getId();</span>
<span class="nc" id="L21596">                r.add(crew.getNameAndRole(current));</span>
<span class="nc" id="L21597">                r.add(crew.getCrewType().getRoleName(0));</span>
<span class="nc" id="L21598">                r.addDesc(e);</span>
<span class="nc" id="L21599">                addReport(r);</span>
            }
<span class="nc" id="L21601">        }</span>
<span class="nc" id="L21602">    }</span>

    /*
     * Resolve any outstanding self destructions...
     */
    private void resolveSelfDestruct() {
<span class="nc bnc" id="L21608" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L21609" title="All 2 branches missed.">            if (e.getSelfDestructing()) {</span>
<span class="nc" id="L21610">                e.setSelfDestructing(false);</span>
<span class="nc" id="L21611">                e.setSelfDestructInitiated(true);</span>
<span class="nc" id="L21612">                Report r = new Report(5535, Report.PUBLIC);</span>
<span class="nc" id="L21613">                r.subject = e.getId();</span>
<span class="nc" id="L21614">                r.addDesc(e);</span>
<span class="nc" id="L21615">                addReport(r);</span>
            }
<span class="nc" id="L21617">        }</span>
<span class="nc" id="L21618">    }</span>

    /*
     * Resolve any outstanding crashes from shutting down and being airborne
     * VTOL or WiGE...
     */
    private void resolveShutdownCrashes() {
<span class="nc bnc" id="L21625" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L21626" title="All 4 branches missed.">            if (e.isShutDown() &amp;&amp; e.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L21627" title="All 4 branches missed.">                &amp;&amp; !(e.isDestroyed() || e.isDoomed())) {</span>
<span class="nc" id="L21628">                Tank t = (Tank) e;</span>
<span class="nc" id="L21629">                t.immobilize();</span>
<span class="nc" id="L21630">                addReport(forceLandVTOLorWiGE(t));</span>
            }
<span class="nc" id="L21632">        }</span>
<span class="nc" id="L21633">    }</span>

    /**
     * Resolve any potential fatal damage to Capital Fighter after each
     * individual attacker is finished
     */
    private Vector&lt;Report&gt; checkFatalThresholds(int nextAE, int prevAE) {
<span class="nc" id="L21640">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L21641" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext();) {</span>
<span class="nc" id="L21642">            Entity en = e.next();</span>
<span class="nc bnc" id="L21643" title="All 4 branches missed.">            if (!en.isCapitalFighter() || (nextAE == Entity.NONE)) {</span>
<span class="nc" id="L21644">                continue;</span>
            }
<span class="nc" id="L21646">            IAero ship = (IAero) en;</span>
<span class="nc" id="L21647">            int damage = ship.getCurrentDamage();</span>
<span class="nc" id="L21648">            double divisor = 2.0;</span>
<span class="nc bnc" id="L21649" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21650">                divisor = 20.0;</span>
            }
<span class="nc bnc" id="L21652" title="All 2 branches missed.">            if (damage &gt;= ship.getFatalThresh()) {</span>
<span class="nc" id="L21653">                int roll = Compute.d6(2)</span>
<span class="nc" id="L21654">                        + (int) Math.floor((damage - ship.getFatalThresh())</span>
                                / divisor);
<span class="nc bnc" id="L21656" title="All 2 branches missed.">                if (roll &gt; 9) {</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L21658" title="All 2 branches missed.">                    if (ship instanceof LandAirMech) {</span>
                        // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L21660">                        LandAirMech lam = (LandAirMech) ship;</span>
<span class="nc bnc" id="L21661" title="All 2 branches missed.">                        if (lam.isAutoEject()</span>
<span class="nc bnc" id="L21662" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21663" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21664" title="All 2 branches missed.">                                            &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L21665">                            addReport(ejectEntity(en, true, false));</span>
                        }
<span class="nc" id="L21667">                    } else {</span>
                        // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L21669">                        Aero aero = (Aero) ship;</span>
<span class="nc bnc" id="L21670" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L21671" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21672" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21673" title="All 2 branches missed.">                                            &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L21674">                            addReport(ejectEntity(en, true, false));</span>
                        }
                    }
<span class="nc" id="L21677">                    vDesc.addAll(destroyEntity((Entity)ship, &quot;fatal damage threshold&quot;));</span>
<span class="nc" id="L21678">                    ship.doDisbandDamage();</span>
<span class="nc bnc" id="L21679" title="All 2 branches missed.">                    if (prevAE != Entity.NONE) {</span>
<span class="nc" id="L21680">                        creditKill(en, game.getEntity(prevAE));</span>
                    }
                }
            }
<span class="nc" id="L21684">            ship.setCurrentDamage(0);</span>
<span class="nc" id="L21685">        }</span>
<span class="nc" id="L21686">        return vDesc;</span>
    }

    /**
     * damage an Entity
     *
     * @param te            the &lt;code&gt;Entity&lt;/code&gt; to be damaged
     * @param hit           the corresponding &lt;code&gt;HitData&lt;/code&gt;
     * @param damage        the &lt;code&gt;int&lt;/code&gt; amount of damage
     * @param ammoExplosion a &lt;code&gt;boolean&lt;/code&gt; indicating if this is an ammo explosion
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    private Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                        boolean ammoExplosion) {
<span class="nc" id="L21700">        return damageEntity(te, hit, damage, ammoExplosion, DamageType.NONE,</span>
                            false, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te     the target entity
     * @param hit    the hit data for the location hit
     * @param damage the damage to apply
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage) {
<span class="nc" id="L21714">        return damageEntity(te, hit, damage, false, DamageType.NONE, false,</span>
                            false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                       boolean ammoExplosion, DamageType bFrag, boolean damageIS) {
<span class="nc" id="L21735">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                        boolean ammoExplosion, DamageType bFrag, boolean damageIS,
                                        boolean areaSatArty) {
<span class="nc" id="L21758">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, true);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                       boolean ammoExplosion, DamageType bFrag, boolean damageIS,
                                       boolean areaSatArty, boolean throughFront) {
<span class="nc" id="L21782">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, throughFront, false, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @param underWater    Is the damage coming from an underwater attack
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
            boolean ammoExplosion, DamageType bFrag, boolean damageIS,
            boolean areaSatArty, boolean throughFront, boolean underWater) {
<span class="nc" id="L21807">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, throughFront, underWater, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @param underWater    Is the damage coming from an underwater attack?
     * @param nukeS2S       is this a ship-to-ship nuke?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
            boolean ammoExplosion, DamageType bFrag, boolean damageIS,
            boolean areaSatArty, boolean throughFront, boolean underWater,
            boolean nukeS2S) {

<span class="nc" id="L21835">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L21837">        int te_n = te.getId();</span>

        // if this is a fighter squadron then pick an active fighter and pass on
        // the damage
<span class="nc bnc" id="L21841" title="All 2 branches missed.">        if (te instanceof FighterSquadron) {</span>
<span class="nc bnc" id="L21842" title="All 2 branches missed.">            if(te.getActiveSubEntities().orElse(Collections.emptyList()).isEmpty()) {</span>
<span class="nc" id="L21843">                return vDesc;</span>
            }
<span class="nc" id="L21845">            List&lt;Entity&gt; fighters = te.getSubEntities().orElse(Collections.emptyList());</span>
<span class="nc" id="L21846">            Entity fighter = fighters.get(hit.getLocation());</span>
<span class="nc" id="L21847">            HitData new_hit = fighter.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L21848">            new_hit.setBoxCars(hit.rolledBoxCars());</span>
<span class="nc" id="L21849">            new_hit.setGeneralDamageType(hit.getGeneralDamageType());</span>
<span class="nc" id="L21850">            new_hit.setCapital(hit.isCapital());</span>
<span class="nc" id="L21851">            new_hit.setCapMisCritMod(hit.getCapMisCritMod());</span>
<span class="nc" id="L21852">            new_hit.setSingleAV(hit.getSingleAV());</span>
<span class="nc" id="L21853">            new_hit.setAttackerId(hit.getAttackerId());</span>
<span class="nc" id="L21854">            return damageEntity(fighter, new_hit, damage, ammoExplosion, bFrag,</span>
                                damageIS, areaSatArty, throughFront, underWater, nukeS2S);
        }

        // Battle Armor takes full damage to each trooper from area-effect.
<span class="nc bnc" id="L21859" title="All 4 branches missed.">        if (areaSatArty &amp;&amp; (te instanceof BattleArmor)) {</span>
<span class="nc" id="L21860">            r = new Report(6044);</span>
<span class="nc" id="L21861">            r.subject = te.getId();</span>
<span class="nc" id="L21862">            r.indent(2);</span>
<span class="nc" id="L21863">            vDesc.add(r);</span>
<span class="nc bnc" id="L21864" title="All 2 branches missed.">            for (int i = 0; i &lt; ((BattleArmor) te).getTroopers(); i++) {</span>
<span class="nc" id="L21865">                hit.setLocation(BattleArmor.LOC_TROOPER_1 + i);</span>
<span class="nc bnc" id="L21866" title="All 2 branches missed.">                if (te.getInternal(hit) &gt; 0) {</span>
<span class="nc" id="L21867">                    vDesc.addAll(damageEntity(te, hit, damage, ammoExplosion, bFrag,</span>
                            damageIS, false, throughFront, underWater, nukeS2S));
                }
            }
<span class="nc" id="L21871">            return vDesc;</span>
        }

        // This is good for shields if a shield absorps the hit it shouldn't
        // effect the pilot.
        // TC SRM's that hit the head do external and internal damage but its
        // one hit and shouldn't cause
        // 2 hits to the pilot.
<span class="nc bnc" id="L21879" title="All 2 branches missed.">        boolean isHeadHit = (te instanceof Mech)</span>
<span class="nc bnc" id="L21880" title="All 2 branches missed.">                            &amp;&amp; (((Mech) te).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L21881" title="All 2 branches missed.">                            &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L21882" title="All 2 branches missed.">                            &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS);</span>

        // booleans to indicate criticals for AT2
<span class="nc" id="L21885">        boolean critSI = false;</span>
<span class="nc" id="L21886">        boolean critThresh = false;</span>

        // get the relevant damage for damage thresholding
<span class="nc" id="L21889">        int threshDamage = damage;</span>
        // weapon groups only get the damage of one weapon
<span class="nc bnc" id="L21891" title="All 2 branches missed.">        if ((hit.getSingleAV() &gt; -1)</span>
<span class="nc bnc" id="L21892" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21893">            threshDamage = hit.getSingleAV();</span>
        }

        // is this capital-scale damage
<span class="nc" id="L21897">        boolean isCapital = hit.isCapital();</span>

        // check capital/standard damage
<span class="nc bnc" id="L21900" title="All 2 branches missed.">        if (isCapital</span>
<span class="nc bnc" id="L21901" title="All 4 branches missed.">            &amp;&amp; (!te.isCapitalScale() || game.getOptions().booleanOption(</span>
                OptionsConstants.ADVAERORULES_AERO_SANITY))) {
<span class="nc" id="L21903">            damage = 10 * damage;</span>
<span class="nc" id="L21904">            threshDamage = 10 * threshDamage;</span>
        }
<span class="nc bnc" id="L21906" title="All 4 branches missed.">        if (!isCapital &amp;&amp; te.isCapitalScale()</span>
<span class="nc bnc" id="L21907" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21908">            damage = (int) Math.round(damage / 10.0);</span>
<span class="nc" id="L21909">            threshDamage = (int) Math.round(threshDamage / 10.0);</span>
        }

<span class="nc" id="L21912">        int damage_orig = damage;</span>

        // show Locations which have rerolled with Edge
<span class="nc" id="L21915">        HitData undoneLocation = hit.getUndoneLocation();</span>
<span class="nc bnc" id="L21916" title="All 2 branches missed.">        while (undoneLocation != null) {</span>
<span class="nc" id="L21917">            r = new Report(6500);</span>
<span class="nc" id="L21918">            r.subject = te_n;</span>
<span class="nc" id="L21919">            r.indent(2);</span>
<span class="nc" id="L21920">            r.addDesc(te);</span>
<span class="nc" id="L21921">            r.add(te.getLocationAbbr(undoneLocation));</span>
<span class="nc" id="L21922">            vDesc.addElement(r);</span>
<span class="nc" id="L21923">            undoneLocation = undoneLocation.getUndoneLocation();</span>
        } // while
        // if edge was uses, give at end overview of remaining
<span class="nc bnc" id="L21926" title="All 2 branches missed.">        if (hit.getUndoneLocation() != null) {</span>
<span class="nc" id="L21927">            r = new Report(6510);</span>
<span class="nc" id="L21928">            r.subject = te_n;</span>
<span class="nc" id="L21929">            r.indent(2);</span>
<span class="nc" id="L21930">            r.addDesc(te);</span>
<span class="nc" id="L21931">            r.add(te.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L21932">            vDesc.addElement(r);</span>
        } // if

<span class="nc" id="L21935">        boolean autoEject = false;</span>
<span class="nc bnc" id="L21936" title="All 2 branches missed.">        if (ammoExplosion) {</span>
<span class="nc bnc" id="L21937" title="All 2 branches missed.">            if (te instanceof Mech) {</span>
<span class="nc" id="L21938">                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L21939" title="All 4 branches missed.">                if (mech.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21940" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21941" title="All 2 branches missed.">                                &amp;&amp; mech.isCondEjectAmmo()))) {</span>
<span class="nc" id="L21942">                    autoEject = true;</span>
<span class="nc" id="L21943">                    vDesc.addAll(ejectEntity(te, true));</span>
                }
<span class="nc bnc" id="L21945" title="All 2 branches missed.">            } else if (te instanceof Aero) {</span>
<span class="nc" id="L21946">                Aero aero = (Aero) te;</span>
<span class="nc bnc" id="L21947" title="All 4 branches missed.">                if (aero.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21948" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21949" title="All 2 branches missed.">                                &amp;&amp; aero.isCondEjectAmmo()))) {</span>
<span class="nc" id="L21950">                    autoEject = true;</span>
<span class="nc" id="L21951">                    vDesc.addAll(ejectEntity(te, true));</span>
                }
            }
        }
<span class="nc" id="L21955">        boolean isBattleArmor = te instanceof BattleArmor;</span>
<span class="nc bnc" id="L21956" title="All 4 branches missed.">        boolean isPlatoon = !isBattleArmor &amp;&amp; (te instanceof Infantry);</span>
<span class="nc" id="L21957">        boolean isFerroFibrousTarget = false;</span>
<span class="nc" id="L21958">        boolean wasDamageIS = false;</span>
<span class="nc" id="L21959">        boolean tookInternalDamage = damageIS;</span>
<span class="nc" id="L21960">        IHex te_hex = null;</span>

<span class="nc bnc" id="L21962" title="All 4 branches missed.">        boolean hardenedArmor = ((te instanceof Mech) || (te instanceof Tank))</span>
<span class="nc bnc" id="L21963" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED);</span>
<span class="nc bnc" id="L21964" title="All 6 branches missed.">        boolean ferroLamellorArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21965" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_LAMELLOR);</span>
<span class="nc bnc" id="L21966" title="All 6 branches missed.">        boolean reflectiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21967" title="All 4 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REFLECTIVE))</span>
<span class="nc bnc" id="L21968" title="All 2 branches missed.">                || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REFLECTIVE));</span>
<span class="nc bnc" id="L21969" title="All 6 branches missed.">        boolean reactiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21970" title="All 4 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REACTIVE))</span>
<span class="nc bnc" id="L21971" title="All 2 branches missed.">                || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REACTIVE));</span>
<span class="nc bnc" id="L21972" title="All 6 branches missed.">        boolean ballisticArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L21973" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BALLISTIC_REINFORCED);</span>
<span class="nc bnc" id="L21974" title="All 2 branches missed.">        boolean impactArmor = (te instanceof Mech)</span>
<span class="nc bnc" id="L21975" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_IMPACT_RESISTANT);</span>
<span class="nc bnc" id="L21976" title="All 2 branches missed.">        boolean bar5 = te.getBARRating(hit.getLocation()) &lt;= 5;</span>

        // TACs from the hit location table
        int crits;
<span class="nc bnc" id="L21980" title="All 2 branches missed.">        if ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == HitData.EFFECT_CRITICAL) {</span>
<span class="nc" id="L21981">            crits = 1;</span>
        } else {
<span class="nc" id="L21983">            crits = 0;</span>
        }

        // this is for special crits, like AP and tandem-charge
<span class="nc" id="L21987">        int specCrits = 0;</span>

        // the bonus to the crit roll if using the
        // &quot;advanced determining critical hits rule&quot;
<span class="nc" id="L21991">        int critBonus = 0;</span>
<span class="nc bnc" id="L21992" title="All 8 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CRIT_ROLL)</span>
            &amp;&amp; (damage_orig &gt; 0)
            &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))) {
<span class="nc" id="L21995">            critBonus = Math.min((damage_orig - 1) / 5, 4);</span>
        }

        // Find out if Human TRO plays a part it crit bonus
<span class="nc" id="L21999">        Entity ae = game.getEntity(hit.getAttackerId());</span>
<span class="nc bnc" id="L22000" title="All 4 branches missed.">        if ((ae != null) &amp;&amp; !areaSatArty) {</span>
<span class="nc bnc" id="L22001" title="All 4 branches missed.">            if ((te instanceof Mech) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_MECH)) {</span>
<span class="nc" id="L22002">                critBonus += 1;</span>
<span class="nc bnc" id="L22003" title="All 4 branches missed.">            } else if ((te instanceof Aero) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_AERO)) {</span>
<span class="nc" id="L22004">                critBonus += 1;</span>
<span class="nc bnc" id="L22005" title="All 4 branches missed.">            } else if ((te instanceof Tank) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_VEE)) {</span>
<span class="nc" id="L22006">                critBonus += 1;</span>
<span class="nc bnc" id="L22007" title="All 4 branches missed.">            } else if ((te instanceof BattleArmor) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_BA)) {</span>
<span class="nc" id="L22008">                critBonus += 1;</span>
            }
        }

<span class="nc" id="L22012">        HitData nextHit = null;</span>

        // Some &quot;hits&quot; on a ProtoMech are actually misses.
<span class="nc bnc" id="L22015" title="All 4 branches missed.">        if ((te instanceof Protomech) &amp;&amp; (hit.getLocation() == Protomech.LOC_NMISS)) {</span>
<span class="nc" id="L22016">            Protomech proto = (Protomech) te;</span>
<span class="nc" id="L22017">            r = new Report(6035);</span>
<span class="nc" id="L22018">            r.subject = te.getId();</span>
<span class="nc" id="L22019">            r.indent(2);</span>
<span class="nc bnc" id="L22020" title="All 2 branches missed.">            if (proto.isGlider()) {</span>
<span class="nc" id="L22021">                r.messageId = 6036;</span>
<span class="nc" id="L22022">                proto.setWingHits(proto.getWingHits() + 1);</span>
            }
<span class="nc" id="L22024">            vDesc.add(r);</span>
<span class="nc" id="L22025">            return vDesc;</span>
        }

        // check for critical hit/miss vs. a BA
<span class="nc bnc" id="L22029" title="All 4 branches missed.">        if ((crits &gt; 0) &amp;&amp; (te instanceof BattleArmor)) {</span>
            // possible critical miss if the rerolled location isn't alive
<span class="nc bnc" id="L22031" title="All 4 branches missed.">            if ((hit.getLocation() &gt;= te.locations()) || (te.getInternal(hit.getLocation()) &lt;= 0)) {</span>
<span class="nc" id="L22032">                r = new Report(6037);</span>
<span class="nc" id="L22033">                r.add(hit.getLocation());</span>
<span class="nc" id="L22034">                r.subject = te_n;</span>
<span class="nc" id="L22035">                r.indent(2);</span>
<span class="nc" id="L22036">                vDesc.addElement(r);</span>
<span class="nc" id="L22037">                return vDesc;</span>
            }
            // otherwise critical hit
<span class="nc" id="L22040">            r = new Report(6225);</span>
<span class="nc" id="L22041">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L22042">            r.subject = te_n;</span>
<span class="nc" id="L22043">            r.indent(2);</span>
<span class="nc" id="L22044">            vDesc.addElement(r);</span>

<span class="nc" id="L22046">            crits = 0;</span>
<span class="nc" id="L22047">            damage = Math.max(te.getInternal(hit.getLocation()) + te.getArmor(hit.getLocation()), damage);</span>
        }

<span class="nc bnc" id="L22050" title="All 4 branches missed.">        if ((te.getArmor(hit) &gt; 0) &amp;&amp; ((te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_FIBROUS)</span>
<span class="nc bnc" id="L22051" title="All 2 branches missed.">                || (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_LIGHT_FERRO)</span>
<span class="nc bnc" id="L22052" title="All 2 branches missed.">                || (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HEAVY_FERRO))) {</span>
<span class="nc" id="L22053">            isFerroFibrousTarget = true;</span>
        }

        // area effect against infantry is double damage
<span class="nc bnc" id="L22057" title="All 4 branches missed.">        if (isPlatoon &amp;&amp; areaSatArty) {</span>
            // PBI. Double damage.
<span class="nc" id="L22059">            damage *= 2;</span>
<span class="nc" id="L22060">            r = new Report(6039);</span>
<span class="nc" id="L22061">            r.subject = te_n;</span>
<span class="nc" id="L22062">            r.indent(2);</span>
<span class="nc" id="L22063">            vDesc.addElement(r);</span>
        }

        // Is the infantry in the open?
<span class="nc bnc" id="L22067" title="All 2 branches missed.">        if(ServerHelper.infantryInOpen(te, te_hex, game, isPlatoon, ammoExplosion, hit.isIgnoreInfantryDoubleDamage())) {</span>
            // PBI. Damage is doubled.
<span class="nc" id="L22069">            damage *= 2;</span>
<span class="nc" id="L22070">            r = new Report(6040);</span>
<span class="nc" id="L22071">            r.subject = te_n;</span>
<span class="nc" id="L22072">            r.indent(2);</span>
<span class="nc" id="L22073">            vDesc.addElement(r);</span>
        }

        // Is the infantry in vacuum?
<span class="nc bnc" id="L22077" title="All 8 branches missed.">        if ((isPlatoon || isBattleArmor) &amp;&amp; !te.isDestroyed() &amp;&amp; !te.isDoomed()</span>
<span class="nc bnc" id="L22078" title="All 2 branches missed.">            &amp;&amp; game.getPlanetaryConditions().isVacuum()) {</span>
            // PBI. Double damage.
<span class="nc" id="L22080">            damage *= 2;</span>
<span class="nc" id="L22081">            r = new Report(6041);</span>
<span class="nc" id="L22082">            r.subject = te_n;</span>
<span class="nc" id="L22083">            r.indent(2);</span>
<span class="nc" id="L22084">            vDesc.addElement(r);</span>
        }
        // If dealing with fragmentation missiles,
        // it does double damage to infantry...
        // We're actually going to abuse this for AX-head warheads, too, so as
        // to not add another parameter.
<span class="nc bnc" id="L22090" title="All 8 branches missed.">        switch (bFrag) {</span>
            case FRAGMENTATION:
                // Fragmentation missiles deal full damage to conventional
                // infantry
                // (only) and no damage to other target types.
<span class="nc bnc" id="L22095" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22096">                    damage = 0;</span>
<span class="nc" id="L22097">                    r = new Report(6050); // For some reason this report never</span>
                    // actually shows up...
<span class="nc" id="L22099">                    r.subject = te_n;</span>
<span class="nc" id="L22100">                    r.indent(2);</span>
<span class="nc" id="L22101">                    vDesc.addElement(r);</span>
                } else {
<span class="nc" id="L22103">                    r = new Report(6045); // ...but this one displays just fine.</span>
<span class="nc" id="L22104">                    r.subject = te_n;</span>
<span class="nc" id="L22105">                    r.indent(2);</span>
<span class="nc" id="L22106">                    vDesc.addElement(r);</span>
                }
<span class="nc" id="L22108">                break;</span>
            case NONPENETRATING:
<span class="nc bnc" id="L22110" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22111">                    damage = 0;</span>
<span class="nc" id="L22112">                    r = new Report(6051);</span>
<span class="nc" id="L22113">                    r.subject = te_n;</span>
<span class="nc" id="L22114">                    r.indent(2);</span>
<span class="nc" id="L22115">                    vDesc.addElement(r);</span>
                }
                break;
            case FLECHETTE:
                // Flechette ammo deals full damage to conventional infantry and
                // half damage to other targets (including battle armor).
<span class="nc bnc" id="L22121" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22122">                    damage /= 2;</span>
<span class="nc" id="L22123">                    r = new Report(6060);</span>
<span class="nc" id="L22124">                    r.subject = te_n;</span>
<span class="nc" id="L22125">                    r.indent(2);</span>
<span class="nc" id="L22126">                    vDesc.addElement(r);</span>
                } else {
<span class="nc" id="L22128">                    r = new Report(6055);</span>
<span class="nc" id="L22129">                    r.subject = te_n;</span>
<span class="nc" id="L22130">                    r.indent(2);</span>
<span class="nc" id="L22131">                    vDesc.addElement(r);</span>
                }
<span class="nc" id="L22133">                break;</span>
            case ACID:
<span class="nc bnc" id="L22135" title="All 10 branches missed.">                if (isFerroFibrousTarget || reactiveArmor || reflectiveArmor</span>
                    || ferroLamellorArmor || bar5) {
<span class="nc bnc" id="L22137" title="All 2 branches missed.">                    if (te.getArmor(hit) &lt;= 0) {</span>
<span class="nc" id="L22138">                        break; // hitting IS, not acid-affected armor</span>
                    }
<span class="nc" id="L22140">                    damage = Math.min(te.getArmor(hit), 3);</span>
<span class="nc" id="L22141">                    r = new Report(6061);</span>
<span class="nc" id="L22142">                    r.subject = te_n;</span>
<span class="nc" id="L22143">                    r.indent(2);</span>
<span class="nc" id="L22144">                    r.add(damage);</span>
<span class="nc" id="L22145">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22146" title="All 2 branches missed.">                } else if (isPlatoon) {</span>
<span class="nc" id="L22147">                    damage = (int) Math.ceil(damage * 1.5);</span>
<span class="nc" id="L22148">                    r = new Report(6062);</span>
<span class="nc" id="L22149">                    r.subject = te_n;</span>
<span class="nc" id="L22150">                    r.indent(2);</span>
<span class="nc" id="L22151">                    vDesc.addElement(r);</span>
                }
                break;
            case INCENDIARY:
                // Incendiary AC ammo does +2 damage to unarmoured infantry
<span class="nc bnc" id="L22156" title="All 2 branches missed.">                if (isPlatoon) {</span>
<span class="nc" id="L22157">                    damage += 2;</span>
<span class="nc" id="L22158">                    r = new Report(6064);</span>
<span class="nc" id="L22159">                    r.subject = te_n;</span>
<span class="nc" id="L22160">                    r.indent(2);</span>
<span class="nc" id="L22161">                    vDesc.addElement(r);</span>
                }
                break;
            case ANTI_TSM:
<span class="nc" id="L22165">                te.hitThisRoundByAntiTSM = true;</span>
<span class="nc" id="L22166">                break;</span>
            case NAIL_RIVET:
                // no damage against armor of BAR rating &gt;=5
<span class="nc bnc" id="L22169" title="All 2 branches missed.">                if ((te.getBARRating(hit.getLocation()) &gt;= 5)</span>
<span class="nc bnc" id="L22170" title="All 2 branches missed.">                    &amp;&amp; (te.getArmor(hit.getLocation()) &gt; 0)) {</span>
<span class="nc" id="L22171">                    damage = 0;</span>
<span class="nc" id="L22172">                    r = new Report(6063);</span>
<span class="nc" id="L22173">                    r.subject = te_n;</span>
<span class="nc" id="L22174">                    r.indent(2);</span>
<span class="nc" id="L22175">                    vDesc.add(r);</span>
                }
                break;
            default:
                // We can ignore this.
                break;
        }

        // adjust VTOL rotor damage
<span class="nc bnc" id="L22184" title="All 4 branches missed.">        if ((te instanceof VTOL) &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L22185" title="All 2 branches missed.">            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_PHYSICAL)</span>
<span class="nc bnc" id="L22186" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_FULL_ROTOR_HITS)) {</span>
<span class="nc" id="L22187">            damage = (damage + 9) / 10;</span>
        }

        // save EI status, in case sensors crit destroys it
<span class="nc" id="L22191">        final boolean eiStatus = te.hasActiveEiCockpit();</span>
        // BA using EI implants receive +1 damage from attacks
<span class="nc bnc" id="L22193" title="All 6 branches missed.">        if (!(te instanceof Mech) &amp;&amp; !(te instanceof Protomech) &amp;&amp; eiStatus) {</span>
<span class="nc" id="L22194">            damage += 1;</span>
        }

        // check for case on Aeros
<span class="nc bnc" id="L22198" title="All 2 branches missed.">        if (te instanceof Aero) {</span>
<span class="nc" id="L22199">            Aero a = (Aero) te;</span>
<span class="nc bnc" id="L22200" title="All 4 branches missed.">            if (ammoExplosion &amp;&amp; a.hasCase()) {</span>
                // damage should be reduced by a factor of 2 for ammo explosions
                // according to p. 161, TW
<span class="nc" id="L22203">                damage /= 2;</span>
<span class="nc" id="L22204">                r = new Report(9010);</span>
<span class="nc" id="L22205">                r.subject = te_n;</span>
<span class="nc" id="L22206">                r.add(damage);</span>
<span class="nc" id="L22207">                r.indent(3);</span>
<span class="nc" id="L22208">                vDesc.addElement(r);</span>
            }
        }

        // infantry armor can reduce damage
<span class="nc bnc" id="L22213" title="All 4 branches missed.">        if (isPlatoon &amp;&amp; (((Infantry) te).calcDamageDivisor() != 1.0)) {</span>
<span class="nc" id="L22214">            r = new Report(6074);</span>
<span class="nc" id="L22215">            r.subject = te_n;</span>
<span class="nc" id="L22216">            r.indent(2);</span>
<span class="nc" id="L22217">            r.add(damage);</span>
<span class="nc" id="L22218">            damage = (int) Math.ceil((damage) / ((Infantry) te).calcDamageDivisor());</span>
<span class="nc" id="L22219">            r.add(damage);</span>
<span class="nc" id="L22220">            vDesc.addElement(r);</span>
        }

        // Allocate the damage
<span class="nc bnc" id="L22224" title="All 2 branches missed.">        while (damage &gt; 0) {</span>

            // first check for ammo explosions on aeros separately, because it
            // must be done before
            // standard to capital damage conversions
<span class="nc bnc" id="L22229" title="All 6 branches missed.">            if ((te instanceof Aero) &amp;&amp; (hit.getLocation() == Aero.LOC_AFT)</span>
                &amp;&amp; !damageIS) {
<span class="nc bnc" id="L22231" title="All 2 branches missed.">                for (Mounted mAmmo : te.getAmmo()) {</span>
<span class="nc bnc" id="L22232" title="All 6 branches missed.">                    if (mAmmo.isDumping() &amp;&amp; !mAmmo.isDestroyed() &amp;&amp; !mAmmo.isHit()</span>
<span class="nc bnc" id="L22233" title="All 2 branches missed.">                            &amp;&amp; !(mAmmo.getType() instanceof BombType)) {</span>
                        // doh. explode it
<span class="nc" id="L22235">                        vDesc.addAll(explodeEquipment(te, mAmmo.getLocation(), mAmmo));</span>
<span class="nc" id="L22236">                        mAmmo.setHit(true);</span>
                    }
<span class="nc" id="L22238">                }</span>
            }

<span class="nc bnc" id="L22241" title="All 2 branches missed.">            if (te.isAero()) {</span>
                // chance of a critical if damage greater than threshold
<span class="nc" id="L22243">                IAero a = (IAero) te;</span>
<span class="nc bnc" id="L22244" title="All 2 branches missed.">                if ((threshDamage &gt; a.getThresh(hit.getLocation()))) {</span>
<span class="nc" id="L22245">                    critThresh = true;</span>
<span class="nc" id="L22246">                    a.setCritThresh(true);</span>
                }
            }

            // Capital fighters receive damage differently
<span class="nc bnc" id="L22251" title="All 2 branches missed.">            if (te.isCapitalFighter()) {</span>
<span class="nc" id="L22252">                IAero a = (IAero) te;</span>
<span class="nc" id="L22253">                a.setCurrentDamage(a.getCurrentDamage() + damage);</span>
<span class="nc" id="L22254">                a.setCapArmor(a.getCapArmor() - damage);</span>
<span class="nc" id="L22255">                r = new Report(9065);</span>
<span class="nc" id="L22256">                r.subject = te_n;</span>
<span class="nc" id="L22257">                r.indent(2);</span>
<span class="nc" id="L22258">                r.newlines = 0;</span>
<span class="nc" id="L22259">                r.addDesc(te);</span>
<span class="nc" id="L22260">                r.add(damage);</span>
<span class="nc" id="L22261">                vDesc.addElement(r);</span>
<span class="nc" id="L22262">                r = new Report(6085);</span>
<span class="nc" id="L22263">                r.subject = te_n;</span>
<span class="nc" id="L22264">                r.add(Math.max(a.getCapArmor(), 0));</span>
<span class="nc" id="L22265">                vDesc.addElement(r);</span>
                // check to see if this destroyed the entity
<span class="nc bnc" id="L22267" title="All 2 branches missed.">                if (a.getCapArmor() &lt;= 0) {</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L22269" title="All 2 branches missed.">                    if (a instanceof LandAirMech) {</span>
                        // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L22271">                        LandAirMech lam = (LandAirMech) a;</span>
<span class="nc bnc" id="L22272" title="All 2 branches missed.">                        if (lam.isAutoEject()</span>
<span class="nc bnc" id="L22273" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22274" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22275" title="All 2 branches missed.">                                            &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L22276">                            addReport(ejectEntity(te, true, false));</span>
                        }
<span class="nc" id="L22278">                    } else {</span>
                        // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L22280">                        Aero aero = (Aero) a;</span>
<span class="nc bnc" id="L22281" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L22282" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L22283" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22284" title="All 2 branches missed.">                                            &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L22285">                            addReport(ejectEntity(te, true, false));</span>
                        }
                    }
<span class="nc" id="L22288">                    vDesc.addAll(destroyEntity(te, &quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L22289">                    a.doDisbandDamage();</span>
<span class="nc" id="L22290">                    a.setCapArmor(0);</span>
<span class="nc bnc" id="L22291" title="All 2 branches missed.">                    if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L22292">                        creditKill(te, game.getEntity(hit.getAttackerId()));</span>
                    }
                }
                // check for aero crits from natural 12 or threshold; LAMs take damage as mechs
<span class="nc bnc" id="L22296" title="All 2 branches missed.">                if (te instanceof Aero) {</span>
<span class="nc" id="L22297">                    checkAeroCrits(vDesc, (Aero) te, hit, damage_orig, critThresh,</span>
                                   critSI, ammoExplosion, nukeS2S);
                }
<span class="nc" id="L22300">                return vDesc;</span>
            }

<span class="nc bnc" id="L22303" title="All 4 branches missed.">            if (!((te instanceof Aero) &amp;&amp; ammoExplosion)) {</span>
                // report something different for Aero ammo explosions
<span class="nc" id="L22305">                r = new Report(6065);</span>
<span class="nc" id="L22306">                r.subject = te_n;</span>
<span class="nc" id="L22307">                r.indent(2);</span>
<span class="nc" id="L22308">                r.addDesc(te);</span>
<span class="nc" id="L22309">                r.add(damage);</span>
<span class="nc bnc" id="L22310" title="All 2 branches missed.">                if (damageIS) {</span>
<span class="nc" id="L22311">                    r.messageId = 6070;</span>
                }
<span class="nc" id="L22313">                r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L22314">                vDesc.addElement(r);</span>
            }

            // was the section destroyed earlier this phase?
<span class="nc bnc" id="L22318" title="All 2 branches missed.">            if (te.getInternal(hit) == IArmorState.ARMOR_DOOMED) {</span>
                // cannot transfer a through armor crit if so
<span class="nc" id="L22320">                crits = 0;</span>
            }

            // here goes the fun :)
            // Shields take damage first then cowls then armor whee
            // Shield does not protect from ammo explosions or falls.
<span class="nc bnc" id="L22326" title="All 8 branches missed.">            if (!ammoExplosion &amp;&amp; !hit.isFallDamage() &amp;&amp; !damageIS &amp;&amp; te.hasShield()</span>
<span class="nc bnc" id="L22327" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc" id="L22328">                Mech me = (Mech) te;</span>
<span class="nc" id="L22329">                int damageNew = me.shieldAbsorptionDamage(damage, hit.getLocation(), hit.isRear());</span>
                // if a shield absorbed the damage then lets tell the world
                // about it.
<span class="nc bnc" id="L22332" title="All 2 branches missed.">                if (damageNew != damage) {</span>
<span class="nc" id="L22333">                    int absorb = damage - damageNew;</span>
<span class="nc" id="L22334">                    te.damageThisPhase += absorb;</span>
<span class="nc" id="L22335">                    damage = damageNew;</span>

<span class="nc" id="L22337">                    r = new Report(3530);</span>
<span class="nc" id="L22338">                    r.subject = te_n;</span>
<span class="nc" id="L22339">                    r.indent(3);</span>
<span class="nc" id="L22340">                    r.add(absorb);</span>
<span class="nc" id="L22341">                    vDesc.addElement(r);</span>

<span class="nc bnc" id="L22343" title="All 2 branches missed.">                    if (damage &lt;= 0) {</span>
<span class="nc" id="L22344">                        crits = 0;</span>
<span class="nc" id="L22345">                        specCrits = 0;</span>
<span class="nc" id="L22346">                        isHeadHit = false;</span>
                    }
                }
            }

            // Armored Cowl may absorb some damage from hit
<span class="nc bnc" id="L22352" title="All 2 branches missed.">            if (te instanceof Mech) {</span>
<span class="nc" id="L22353">                Mech me = (Mech) te;</span>
<span class="nc bnc" id="L22354" title="All 6 branches missed.">                if (me.hasCowl() &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
                    &amp;&amp; !throughFront) {
<span class="nc" id="L22356">                    int damageNew = me.damageCowl(damage);</span>
<span class="nc" id="L22357">                    int damageDiff = damage - damageNew;</span>
<span class="nc" id="L22358">                    me.damageThisPhase += damageDiff;</span>
<span class="nc" id="L22359">                    damage = damageNew;</span>

<span class="nc" id="L22361">                    r = new Report(3520);</span>
<span class="nc" id="L22362">                    r.subject = te_n;</span>
<span class="nc" id="L22363">                    r.indent(3);</span>
<span class="nc" id="L22364">                    r.add(damageDiff);</span>
<span class="nc" id="L22365">                    vDesc.addElement(r);</span>
                }
            }

            // So might modular armor, if the location mounts any.
<span class="nc bnc" id="L22370" title="All 4 branches missed.">            if (!ammoExplosion &amp;&amp; !damageIS</span>
<span class="nc bnc" id="L22371" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc" id="L22372">                int damageNew = te.getDamageReductionFromModularArmor(hit, damage, vDesc);</span>
<span class="nc" id="L22373">                int damageDiff = damage - damageNew;</span>
<span class="nc" id="L22374">                te.damageThisPhase += damageDiff;</span>
<span class="nc" id="L22375">                damage = damageNew;</span>
            }

            // Destroy searchlights on 7+ (torso hits on mechs)
<span class="nc bnc" id="L22379" title="All 2 branches missed.">            if (te.hasSpotlight()) {</span>
<span class="nc" id="L22380">                boolean spotlightHittable = true;</span>
<span class="nc" id="L22381">                int loc = hit.getLocation();</span>
<span class="nc bnc" id="L22382" title="All 2 branches missed.">                if (te instanceof Mech) {</span>
<span class="nc bnc" id="L22383" title="All 6 branches missed.">                    if ((loc != Mech.LOC_CT) &amp;&amp; (loc != Mech.LOC_LT) &amp;&amp; (loc != Mech.LOC_RT)) {</span>
<span class="nc" id="L22384">                        spotlightHittable = false;</span>
                    }
<span class="nc bnc" id="L22386" title="All 2 branches missed.">                } else if (te instanceof Tank) {</span>
<span class="nc bnc" id="L22387" title="All 2 branches missed.">                    if (te instanceof SuperHeavyTank) {</span>
<span class="nc bnc" id="L22388" title="All 10 branches missed.">                        if ((loc != Tank.LOC_FRONT)</span>
                                &amp;&amp; (loc != SuperHeavyTank.LOC_FRONTRIGHT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_FRONTLEFT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_REARRIGHT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_REARLEFT)) {
<span class="nc" id="L22393">                            spotlightHittable = false;</span>
                        }
<span class="nc bnc" id="L22395" title="All 2 branches missed.">                    } else if (te instanceof LargeSupportTank) {</span>
<span class="nc bnc" id="L22396" title="All 10 branches missed.">                        if ((loc != Tank.LOC_FRONT)</span>
                                &amp;&amp; (loc != LargeSupportTank.LOC_FRONTRIGHT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_FRONTLEFT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_REARRIGHT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_REARLEFT)) {
<span class="nc" id="L22401">                            spotlightHittable = false;</span>
                        }
                    } else {
<span class="nc bnc" id="L22404" title="All 6 branches missed.">                        if ((loc != Tank.LOC_FRONT) &amp;&amp; (loc != Tank.LOC_RIGHT)</span>
                                &amp;&amp; (loc != Tank.LOC_LEFT)) {
<span class="nc" id="L22406">                            spotlightHittable = false;</span>
                        }
                    }

                }
<span class="nc bnc" id="L22411" title="All 2 branches missed.">                if (spotlightHittable) {</span>
<span class="nc" id="L22412">                    int spotroll = Compute.d6(2);</span>
<span class="nc" id="L22413">                    r = new Report(6072);</span>
<span class="nc" id="L22414">                    r.indent(2);</span>
<span class="nc" id="L22415">                    r.subject = te_n;</span>
<span class="nc" id="L22416">                    r.add(&quot;7+&quot;);</span>
<span class="nc" id="L22417">                    r.add(&quot;Searchlight&quot;);</span>
<span class="nc" id="L22418">                    r.add(spotroll);</span>
<span class="nc" id="L22419">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22420" title="All 2 branches missed.">                    if (spotroll &gt;= 7) {</span>
<span class="nc" id="L22421">                        r = new Report(6071);</span>
<span class="nc" id="L22422">                        r.subject = te_n;</span>
<span class="nc" id="L22423">                        r.indent(2);</span>
<span class="nc" id="L22424">                        r.add(&quot;Searchlight&quot;);</span>
<span class="nc" id="L22425">                        vDesc.addElement(r);</span>
<span class="nc" id="L22426">                        te.destroyOneSpotlight();</span>
                    }
                }
            }

            // Does an exterior passenger absorb some of the damage?
<span class="nc bnc" id="L22432" title="All 2 branches missed.">            if (!damageIS) {</span>
<span class="nc" id="L22433">                int nLoc = hit.getLocation();</span>
<span class="nc" id="L22434">                Entity passenger = te.getExteriorUnitAt(nLoc, hit.isRear());</span>
                // Does an exterior passenger absorb some of the damage?
<span class="nc bnc" id="L22436" title="All 8 branches missed.">                if (!ammoExplosion &amp;&amp; (null != passenger) &amp;&amp; !passenger.isDoomed()</span>
                        &amp;&amp; (bFrag != DamageType.IGNORE_PASSENGER)) {
<span class="nc" id="L22438">                    damage = damageExternalPassenger(te, hit, damage, vDesc, passenger);</span>
                }

<span class="nc bnc" id="L22441" title="All 6 branches missed.">                boolean bTorso = (nLoc == Mech.LOC_CT) || (nLoc == Mech.LOC_RT)</span>
                        || (nLoc == Mech.LOC_LT);

                // Does a swarming unit absorb damage?
<span class="nc" id="L22445">                int swarmer = te.getSwarmAttackerId();</span>
<span class="nc bnc" id="L22446" title="All 6 branches missed.">                if ((!(te instanceof Mech) || bTorso) &amp;&amp; (swarmer != Entity.NONE)</span>
<span class="nc bnc" id="L22447" title="All 8 branches missed.">                        &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == 0) &amp;&amp; (Compute.d6() &gt;= 5)</span>
                        &amp;&amp; (bFrag != DamageType.IGNORE_PASSENGER) &amp;&amp; !ammoExplosion) {
<span class="nc" id="L22449">                    Entity swarm = game.getEntity(swarmer);</span>
                    // Yup. Roll up some hit data for that passenger.
<span class="nc" id="L22451">                    r = new Report(6076);</span>
<span class="nc" id="L22452">                    r.subject = swarmer;</span>
<span class="nc" id="L22453">                    r.indent(3);</span>
<span class="nc" id="L22454">                    r.addDesc(swarm);</span>
<span class="nc" id="L22455">                    vDesc.addElement(r);</span>

<span class="nc" id="L22457">                    HitData passHit = swarm.rollHitLocation(</span>
                            ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);

                    // How much damage will the swarm absorb?
<span class="nc" id="L22461">                    int absorb = 0;</span>
<span class="nc" id="L22462">                    HitData nextPassHit = passHit;</span>
                    do {
<span class="nc bnc" id="L22464" title="All 2 branches missed.">                        if (0 &lt; swarm.getArmor(nextPassHit)) {</span>
<span class="nc" id="L22465">                            absorb += swarm.getArmor(nextPassHit);</span>
                        }
<span class="nc bnc" id="L22467" title="All 2 branches missed.">                        if (0 &lt; swarm.getInternal(nextPassHit)) {</span>
<span class="nc" id="L22468">                            absorb += swarm.getInternal(nextPassHit);</span>
                        }
<span class="nc" id="L22470">                        nextPassHit = swarm.getTransferLocation(nextPassHit);</span>
<span class="nc bnc" id="L22471" title="All 2 branches missed.">                    } while ((damage &gt; absorb)</span>
<span class="nc bnc" id="L22472" title="All 2 branches missed.">                             &amp;&amp; (nextPassHit.getLocation() &gt;= 0));</span>

                    // Damage the swarm.
<span class="nc" id="L22475">                    int absorbedDamage = Math.min(damage, absorb);</span>
<span class="nc" id="L22476">                    Vector&lt;Report&gt; newReports = damageEntity(swarm, passHit,</span>
                                                             absorbedDamage);
<span class="nc bnc" id="L22478" title="All 2 branches missed.">                    for (Report newReport : newReports) {</span>
<span class="nc" id="L22479">                        newReport.indent(2);</span>
<span class="nc" id="L22480">                    }</span>
<span class="nc" id="L22481">                    vDesc.addAll(newReports);</span>

                    // Did some damage pass on?
<span class="nc bnc" id="L22484" title="All 2 branches missed.">                    if (damage &gt; absorb) {</span>
                        // Yup. Remove the absorbed damage.
<span class="nc" id="L22486">                        damage -= absorb;</span>
<span class="nc" id="L22487">                        r = new Report(6080);</span>
<span class="nc" id="L22488">                        r.subject = te_n;</span>
<span class="nc" id="L22489">                        r.indent(2);</span>
<span class="nc" id="L22490">                        r.add(damage);</span>
<span class="nc" id="L22491">                        r.addDesc(te);</span>
<span class="nc" id="L22492">                        vDesc.addElement(r);</span>
                    } else {
                        // Nope. Return our description.
<span class="nc" id="L22495">                        return vDesc;</span>
                    }
                }

                // is this a mech/tank dumping ammo being hit in the rear torso?
<span class="nc bnc" id="L22500" title="All 8 branches missed.">                if (((te instanceof Mech) &amp;&amp; hit.isRear() &amp;&amp; bTorso)</span>
<span class="nc bnc" id="L22501" title="All 2 branches missed.">                        || ((te instanceof Tank) &amp;&amp; (hit.getLocation() == (te instanceof SuperHeavyTank ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L22502" title="All 2 branches missed.">                                : Tank.LOC_REAR)))) {</span>
<span class="nc bnc" id="L22503" title="All 2 branches missed.">                    for (Mounted mAmmo : te.getAmmo()) {</span>
<span class="nc bnc" id="L22504" title="All 4 branches missed.">                        if (mAmmo.isDumping() &amp;&amp; !mAmmo.isDestroyed()</span>
<span class="nc bnc" id="L22505" title="All 2 branches missed.">                            &amp;&amp; !mAmmo.isHit()) {</span>
                            // doh. explode it
<span class="nc" id="L22507">                            vDesc.addAll(explodeEquipment(te,</span>
<span class="nc" id="L22508">                                                          mAmmo.getLocation(), mAmmo));</span>
<span class="nc" id="L22509">                            mAmmo.setHit(true);</span>
                        }
<span class="nc" id="L22511">                    }</span>
                }
            }
            // is there armor in the location hit?
<span class="nc bnc" id="L22515" title="All 6 branches missed.">            if (!ammoExplosion &amp;&amp; (te.getArmor(hit) &gt; 0) &amp;&amp; !damageIS) {</span>
<span class="nc" id="L22516">                int tmpDamageHold = -1;</span>
<span class="nc" id="L22517">                int origDamage = damage;</span>

<span class="nc bnc" id="L22519" title="All 2 branches missed.">                if (isPlatoon) {</span>
                    // infantry armour works differently
<span class="nc" id="L22521">                    int armor = te.getArmor(hit);</span>
<span class="nc" id="L22522">                    int men = te.getInternal(hit);</span>
<span class="nc" id="L22523">                    tmpDamageHold = damage % 2;</span>
<span class="nc" id="L22524">                    damage /= 2;</span>
<span class="nc bnc" id="L22525" title="All 4 branches missed.">                    if ((tmpDamageHold == 1) &amp;&amp; (armor &gt;= men)) {</span>
                        // extra 1 point of damage to armor
<span class="nc" id="L22527">                        tmpDamageHold = damage;</span>
<span class="nc" id="L22528">                        damage++;</span>
                    } else {
                        // extra 0 or 1 point of damage to men
<span class="nc" id="L22531">                        tmpDamageHold += damage;</span>
                    }
                    // If the target has Ferro-Lamellor armor, we need to adjust
                    // damage. (4/5ths rounded down),
                    // Also check to eliminate crit chances for damage reduced
                    // to 0
<span class="nc bnc" id="L22537" title="All 2 branches missed.">                } else if (ferroLamellorArmor</span>
<span class="nc bnc" id="L22538" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22539" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22540" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22541">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22542">                    damage = (int) Math.floor((((double) damage) * 4) / 5);</span>
<span class="nc bnc" id="L22543" title="All 2 branches missed.">                    if (damage &lt;= 0) {</span>
<span class="nc" id="L22544">                        isHeadHit = false;</span>
<span class="nc" id="L22545">                        crits = 0;</span>
                    }
<span class="nc" id="L22547">                    r = new Report(6073);</span>
<span class="nc" id="L22548">                    r.subject = te_n;</span>
<span class="nc" id="L22549">                    r.indent(3);</span>
<span class="nc" id="L22550">                    r.add(damage);</span>
<span class="nc" id="L22551">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22552" title="All 2 branches missed.">                } else if (ballisticArmor</span>
<span class="nc bnc" id="L22553" title="All 2 branches missed.">                           &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22554" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22555" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_BALLISTIC)</span>
<span class="nc bnc" id="L22556" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE))) {</span>
<span class="nc" id="L22557">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22558">                    damage = Math.max(1, damage / 2);</span>
<span class="nc" id="L22559">                    r = new Report(6088);</span>
<span class="nc" id="L22560">                    r.subject = te_n;</span>
<span class="nc" id="L22561">                    r.indent(3);</span>
<span class="nc" id="L22562">                    r.add(damage);</span>
<span class="nc" id="L22563">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22564" title="All 2 branches missed.">                } else if (impactArmor</span>
<span class="nc bnc" id="L22565" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)) {</span>
<span class="nc" id="L22566">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22567">                    damage -= (int) Math.ceil((double) damage / 3);</span>
<span class="nc" id="L22568">                    damage = Math.max(1, damage);</span>
<span class="nc" id="L22569">                    r = new Report(6089);</span>
<span class="nc" id="L22570">                    r.subject = te_n;</span>
<span class="nc" id="L22571">                    r.indent(3);</span>
<span class="nc" id="L22572">                    r.add(damage);</span>
<span class="nc" id="L22573">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22574" title="All 2 branches missed.">                } else if (reflectiveArmor</span>
<span class="nc bnc" id="L22575" title="All 4 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)</span>
                           &amp;&amp; !isBattleArmor) { // BA reflec does not receive extra physical damage
<span class="nc" id="L22577">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22578">                    int currArmor = te.getArmor(hit);</span>
<span class="nc" id="L22579">                    int dmgToDouble = Math.min(damage, currArmor / 2);</span>
<span class="nc" id="L22580">                    damage += dmgToDouble;</span>
<span class="nc" id="L22581">                    r = new Report(6066);</span>
<span class="nc" id="L22582">                    r.subject = te_n;</span>
<span class="nc" id="L22583">                    r.indent(3);</span>
<span class="nc" id="L22584">                    r.add(currArmor);</span>
<span class="nc" id="L22585">                    r.add(tmpDamageHold);</span>
<span class="nc" id="L22586">                    r.add(dmgToDouble);</span>
<span class="nc" id="L22587">                    r.add(damage);</span>
<span class="nc" id="L22588">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22589" title="All 6 branches missed.">                } else if (reflectiveArmor &amp;&amp; areaSatArty &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L22590">                    tmpDamageHold = damage; // BA reflec does not receive extra AE damage</span>
<span class="nc" id="L22591">                    int currArmor = te.getArmor(hit);</span>
<span class="nc" id="L22592">                    int dmgToDouble = Math.min(damage, currArmor / 2);</span>
<span class="nc" id="L22593">                    damage += dmgToDouble;</span>
<span class="nc" id="L22594">                    r = new Report(6087);</span>
<span class="nc" id="L22595">                    r.subject = te_n;</span>
<span class="nc" id="L22596">                    r.indent(3);</span>
<span class="nc" id="L22597">                    r.add(currArmor);</span>
<span class="nc" id="L22598">                    r.add(tmpDamageHold);</span>
<span class="nc" id="L22599">                    r.add(dmgToDouble);</span>
<span class="nc" id="L22600">                    r.add(damage);</span>
<span class="nc" id="L22601">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22602" title="All 2 branches missed.">                } else if (reflectiveArmor</span>
<span class="nc bnc" id="L22603" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_ENERGY)) {</span>
<span class="nc" id="L22604">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22605">                    damage = (int) Math.floor(((double) damage) / 2);</span>
<span class="nc bnc" id="L22606" title="All 2 branches missed.">                    if (tmpDamageHold == 1) {</span>
<span class="nc" id="L22607">                        damage = 1;</span>
                    }
<span class="nc" id="L22609">                    r = new Report(6067);</span>
<span class="nc" id="L22610">                    r.subject = te_n;</span>
<span class="nc" id="L22611">                    r.indent(3);</span>
<span class="nc" id="L22612">                    r.add(damage);</span>
<span class="nc" id="L22613">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22614" title="All 2 branches missed.">                } else if (reactiveArmor</span>
<span class="nc bnc" id="L22615" title="All 2 branches missed.">                           &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE)</span>
<span class="nc bnc" id="L22616" title="All 4 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE) ||</span>
                               areaSatArty)) {
<span class="nc" id="L22618">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22619">                    damage = (int) Math.floor(((double) damage) / 2);</span>
<span class="nc bnc" id="L22620" title="All 2 branches missed.">                    if (tmpDamageHold == 1) {</span>
<span class="nc" id="L22621">                        damage = 1;</span>
                    }
<span class="nc" id="L22623">                    r = new Report(6068);</span>
<span class="nc" id="L22624">                    r.subject = te_n;</span>
<span class="nc" id="L22625">                    r.indent(3);</span>
<span class="nc" id="L22626">                    r.add(damage);</span>
<span class="nc" id="L22627">                    vDesc.addElement(r);</span>
                }

                // If we're using optional tank damage thresholds, setup our hit
                // effects now...
<span class="nc bnc" id="L22632" title="All 2 branches missed.">                if ((te instanceof Tank)</span>
<span class="nc" id="L22633">                        &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L22634" title="All 6 branches missed.">                                .booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                        &amp;&amp; !((te instanceof VTOL) || (te instanceof GunEmplacement))) {
<span class="nc" id="L22636">                    int thresh = (int) Math.ceil(</span>
<span class="nc bnc" id="L22637" title="All 2 branches missed.">                            (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD_VARIABLE)</span>
<span class="nc" id="L22638">                                    ? te.getArmor(hit)</span>
<span class="nc" id="L22639">                                    : te.getOArmor(hit)) / (double) game.getOptions().intOption(</span>
                                            OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD_DIVISOR));

                    // adjust for hardened armor
<span class="nc bnc" id="L22643" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22644" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22645" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22646" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22647">                        thresh *= 2;</span>
                    }

<span class="nc bnc" id="L22650" title="All 4 branches missed.">                    if ((damage &gt; thresh) || (te.getArmor(hit) &lt; damage)) {</span>
<span class="nc" id="L22651">                        hit.setEffect(((Tank) te).getPotCrit());</span>
<span class="nc" id="L22652">                        ((Tank) te).setOverThresh(true);</span>
                        // TACs from the hit location table
<span class="nc bnc" id="L22654" title="All 2 branches missed.">                        crits = ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL)</span>
<span class="nc" id="L22655">                                == HitData.EFFECT_CRITICAL) ? 1 : 0;</span>
                    } else {
<span class="nc" id="L22657">                        ((Tank) te).setOverThresh(false);</span>
<span class="nc" id="L22658">                        crits = 0;</span>
                    }
                }

                // if there's a mast mount in the rotor, it and all other
                // equipment
                // on it get destroyed
<span class="nc bnc" id="L22665" title="All 2 branches missed.">                if ((te instanceof VTOL)</span>
<span class="nc bnc" id="L22666" title="All 2 branches missed.">                    &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L22667" title="All 2 branches missed.">                    &amp;&amp; te.hasWorkingMisc(MiscType.F_MAST_MOUNT, -1,</span>
                                         VTOL.LOC_ROTOR)) {
<span class="nc" id="L22669">                    r = new Report(6081);</span>
<span class="nc" id="L22670">                    r.subject = te_n;</span>
<span class="nc" id="L22671">                    r.indent(2);</span>
<span class="nc" id="L22672">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22673" title="All 2 branches missed.">                    for (Mounted mount : te.getMisc()) {</span>
<span class="nc bnc" id="L22674" title="All 2 branches missed.">                        if (mount.getLocation() == VTOL.LOC_ROTOR) {</span>
<span class="nc" id="L22675">                            mount.setHit(true);</span>
                        }
<span class="nc" id="L22677">                    }</span>
                }
                // Need to account for the possibility of hardened armor here
<span class="nc" id="L22680">                int armorThreshold = te.getArmor(hit);</span>
<span class="nc bnc" id="L22681" title="All 2 branches missed.">                if (hardenedArmor</span>
<span class="nc bnc" id="L22682" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22683" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22684" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22685">                    armorThreshold *= 2;</span>
<span class="nc bnc" id="L22686" title="All 2 branches missed.">                    armorThreshold -= (te.isHardenedArmorDamaged(hit)) ? 1 : 0;</span>
<span class="nc" id="L22687">                    vDesc.lastElement().newlines = 0;</span>
<span class="nc" id="L22688">                    r = new Report(6069);</span>
<span class="nc" id="L22689">                    r.subject = te_n;</span>
<span class="nc" id="L22690">                    r.indent(3);</span>
<span class="nc" id="L22691">                    int reportedDamage = damage / 2;</span>
<span class="nc bnc" id="L22692" title="All 2 branches missed.">                    if ((damage % 2) &gt; 0) {</span>
<span class="nc" id="L22693">                        r.add(reportedDamage + &quot;.5&quot;);</span>
                    } else {
<span class="nc" id="L22695">                        r.add(reportedDamage);</span>
                    }

<span class="nc" id="L22698">                    vDesc.addElement(r);</span>
                }
<span class="nc bnc" id="L22700" title="All 2 branches missed.">                if (armorThreshold &gt;= damage) {</span>

                    // armor absorbs all damage
                    // Hardened armor deals with damage in its own fashion...
<span class="nc bnc" id="L22704" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22705" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22706" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22707" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22708">                        armorThreshold -= damage;</span>
<span class="nc bnc" id="L22709" title="All 2 branches missed.">                        te.setHardenedArmorDamaged(hit, (armorThreshold % 2) &gt; 0);</span>
<span class="nc" id="L22710">                        te.setArmor((armorThreshold / 2) + (armorThreshold % 2), hit);</span>
                    } else {
<span class="nc" id="L22712">                        te.setArmor(te.getArmor(hit) - damage, hit);</span>
                    }

                    // set &quot;armor damage&quot; flag for HarJel II/III
                    // we only care about this if there is armor remaining,
                    // so don't worry about the case where damage exceeds
                    // armorThreshold
<span class="nc bnc" id="L22719" title="All 4 branches missed.">                    if ((te instanceof Mech) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L22720">                        ((Mech) te).setArmorDamagedThisTurn(hit.getLocation(), true);</span>
                    }

                    // if the armor is hardened, any penetrating crits are
                    // rolled at -2
<span class="nc bnc" id="L22725" title="All 2 branches missed.">                    if (hardenedArmor) {</span>
<span class="nc" id="L22726">                        critBonus -= 2;</span>
                    }

<span class="nc bnc" id="L22729" title="All 2 branches missed.">                    if (tmpDamageHold &gt;= 0) {</span>
<span class="nc" id="L22730">                        te.damageThisPhase += tmpDamageHold;</span>
                    } else {
<span class="nc" id="L22732">                        te.damageThisPhase += damage;</span>
                    }
<span class="nc" id="L22734">                    damage = 0;</span>
<span class="nc bnc" id="L22735" title="All 2 branches missed.">                    if (!te.isHardenedArmorDamaged(hit)) {</span>
<span class="nc" id="L22736">                        r = new Report(6085);</span>
                    } else {
<span class="nc" id="L22738">                        r = new Report(6086);</span>
                    }

<span class="nc" id="L22741">                    r.subject = te_n;</span>
<span class="nc" id="L22742">                    r.indent(3);</span>
<span class="nc" id="L22743">                    r.add(te.getArmor(hit));</span>
<span class="nc" id="L22744">                    vDesc.addElement(r);</span>

                    // telemissiles are destroyed if they lose all armor
<span class="nc bnc" id="L22747" title="All 2 branches missed.">                    if ((te instanceof TeleMissile)</span>
<span class="nc bnc" id="L22748" title="All 2 branches missed.">                        &amp;&amp; (te.getArmor(hit) == damage)) {</span>
<span class="nc" id="L22749">                        vDesc.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
                    }

                } else {
                    // damage goes on to internal
<span class="nc" id="L22754">                    int absorbed = Math.max(te.getArmor(hit), 0);</span>
<span class="nc bnc" id="L22755" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22756" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22757" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)) {</span>
<span class="nc" id="L22758">                        absorbed = (absorbed * 2)</span>
<span class="nc bnc" id="L22759" title="All 2 branches missed.">                                   - ((te.isHardenedArmorDamaged(hit)) ? 1 : 0);</span>
                    }
<span class="nc bnc" id="L22761" title="All 6 branches missed.">                    if (reflectiveArmor &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)</span>
                            &amp;&amp; !isBattleArmor) {
<span class="nc" id="L22763">                        absorbed = (int) Math.ceil(absorbed / 2.0);</span>
<span class="nc" id="L22764">                        damage = tmpDamageHold;</span>
<span class="nc" id="L22765">                        tmpDamageHold = 0;</span>
                    }
<span class="nc" id="L22767">                    te.setArmor(IArmorState.ARMOR_DESTROYED, hit);</span>
<span class="nc bnc" id="L22768" title="All 2 branches missed.">                    if (tmpDamageHold &gt;= 0) {</span>
<span class="nc" id="L22769">                        te.damageThisPhase += 2 * absorbed;</span>
                    } else {
<span class="nc" id="L22771">                        te.damageThisPhase += absorbed;</span>
                    }
<span class="nc" id="L22773">                    damage -= absorbed;</span>
<span class="nc" id="L22774">                    r = new Report(6090);</span>
<span class="nc" id="L22775">                    r.subject = te_n;</span>
<span class="nc" id="L22776">                    r.indent(3);</span>
<span class="nc" id="L22777">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22778" title="All 2 branches missed.">                    if (te instanceof GunEmplacement) {</span>
                        // gun emplacements have no internal,
                        // destroy the section
<span class="nc" id="L22781">                        te.destroyLocation(hit.getLocation());</span>
<span class="nc" id="L22782">                        r = new Report(6115);</span>
<span class="nc" id="L22783">                        r.subject = te_n;</span>
<span class="nc" id="L22784">                        vDesc.addElement(r);</span>

<span class="nc bnc" id="L22786" title="All 2 branches missed.">                        if (te.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L22787">                            vDesc.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
                        }
                    }
                }

                // targets with BAR armor get crits, depending on damage and BAR
                // rating
<span class="nc bnc" id="L22794" title="All 2 branches missed.">                if (te.hasBARArmor(hit.getLocation())) {</span>
<span class="nc bnc" id="L22795" title="All 2 branches missed.">                    if (origDamage &gt; te.getBARRating(hit.getLocation())) {</span>
<span class="nc bnc" id="L22796" title="All 2 branches missed.">                        if (te.hasArmoredChassis()) {</span>
                            // crit roll with -1 mod
<span class="nc" id="L22798">                            vDesc.addAll(criticalEntity(te, hit.getLocation(),</span>
<span class="nc" id="L22799">                                                        hit.isRear(), -1 + critBonus, damage_orig));</span>
                        } else {
<span class="nc" id="L22801">                            vDesc.addAll(criticalEntity(te, hit.getLocation(),</span>
<span class="nc" id="L22802">                                                        hit.isRear(), critBonus, damage_orig));</span>
                        }
                    }
                }

<span class="nc bnc" id="L22807" title="All 4 branches missed.">                if ((tmpDamageHold &gt; 0) &amp;&amp; isPlatoon) {</span>
<span class="nc" id="L22808">                    damage = tmpDamageHold;</span>
                }
            }

            // For optional tank damage thresholds, the overthresh flag won't
            // be set if IS is damaged, so set it here.
<span class="nc bnc" id="L22814" title="All 2 branches missed.">            if ((te instanceof Tank)</span>
<span class="nc bnc" id="L22815" title="All 4 branches missed.">                    &amp;&amp; ((te.getArmor(hit) &lt; 1) || damageIS)</span>
<span class="nc bnc" id="L22816" title="All 6 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                    &amp;&amp; !((te instanceof VTOL)
                            || (te instanceof GunEmplacement))) {
<span class="nc" id="L22819">                ((Tank) te).setOverThresh(true);</span>
            }

            // is there damage remaining?
<span class="nc bnc" id="L22823" title="All 2 branches missed.">            if (damage &gt; 0) {</span>

                // if this is an Aero then I need to apply internal damage
                // to the SI after halving it. Return from here to prevent
                // further processing
<span class="nc bnc" id="L22828" title="All 2 branches missed.">                if (te instanceof Aero) {</span>
<span class="nc" id="L22829">                    Aero a = (Aero) te;</span>

                    // check for large craft ammo explosions here: damage vented through armor, excess
                    // dissipating, much like Tank CASE.
<span class="nc bnc" id="L22833" title="All 4 branches missed.">                    if (ammoExplosion &amp;&amp; te.isLargeCraft()) {</span>
<span class="nc" id="L22834">                        te.damageThisPhase += damage;</span>
<span class="nc" id="L22835">                        r = new Report(6128);</span>
<span class="nc" id="L22836">                        r.subject = te_n;</span>
<span class="nc" id="L22837">                        r.indent(2);</span>
<span class="nc" id="L22838">                        r.add(damage);</span>
<span class="nc" id="L22839">                        int loc = hit.getLocation();</span>
                        //Roll for broadside weapons so fore/aft side armor facing takes the damage
<span class="nc bnc" id="L22841" title="All 2 branches missed.">                        if (loc == Warship.LOC_LBS) {</span>
<span class="nc" id="L22842">                            int locRoll = Compute.d6();</span>
<span class="nc bnc" id="L22843" title="All 2 branches missed.">                            if (locRoll &lt; 4) {</span>
<span class="nc" id="L22844">                                loc = Jumpship.LOC_FLS;</span>
                            } else {
<span class="nc" id="L22846">                                loc = Jumpship.LOC_ALS;</span>
                            }
                        }
<span class="nc bnc" id="L22849" title="All 2 branches missed.">                        if (loc == Warship.LOC_RBS) {</span>
<span class="nc" id="L22850">                            int locRoll = Compute.d6();</span>
<span class="nc bnc" id="L22851" title="All 2 branches missed.">                            if (locRoll &lt; 4) {</span>
<span class="nc" id="L22852">                                loc = Jumpship.LOC_FRS;</span>
                            } else {
<span class="nc" id="L22854">                                loc = Jumpship.LOC_ARS;</span>
                            }
                        }
<span class="nc" id="L22857">                        r.add(te.getLocationAbbr(loc));</span>
<span class="nc" id="L22858">                        vDesc.add(r);</span>
<span class="nc bnc" id="L22859" title="All 2 branches missed.">                        if (damage &gt; te.getArmor(loc)) {</span>
<span class="nc" id="L22860">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc" id="L22861">                            r = new Report(6090);</span>
                        } else {
<span class="nc" id="L22863">                            te.setArmor(te.getArmor(loc) - damage, loc);</span>
<span class="nc" id="L22864">                            r = new Report(6085);</span>
<span class="nc" id="L22865">                            r.add(te.getArmor(loc));</span>
                        }
<span class="nc" id="L22867">                        r.subject = te_n;</span>
<span class="nc" id="L22868">                        r.indent(3);</span>
<span class="nc" id="L22869">                        vDesc.add(r);</span>
<span class="nc" id="L22870">                        damage = 0;</span>
                    }

                    // check for overpenetration
<span class="nc bnc" id="L22874" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVAERORULES_STRATOPS_OVER_PENETRATE)) {
<span class="nc" id="L22876">                        int opRoll = Compute.d6(1);</span>
<span class="nc bnc" id="L22877" title="All 14 branches missed.">                        if ((((te instanceof Jumpship) || (te instanceof SpaceStation))</span>
                             &amp;&amp; !(te instanceof Warship) &amp;&amp; (opRoll &gt; 3))
                            || ((te instanceof Dropship) &amp;&amp; (opRoll &gt; 4))
                            || ((te instanceof Warship)
<span class="nc bnc" id="L22881" title="All 4 branches missed.">                                &amp;&amp; (a.get0SI() &lt;= 30) &amp;&amp; (opRoll &gt; 5))) {</span>
                            // over-penetration happened
<span class="nc" id="L22883">                            r = new Report(9090);</span>
<span class="nc" id="L22884">                            r.subject = te_n;</span>
<span class="nc" id="L22885">                            r.newlines = 0;</span>
<span class="nc" id="L22886">                            vDesc.addElement(r);</span>
<span class="nc" id="L22887">                            int new_loc = a.getOppositeLocation(hit</span>
<span class="nc" id="L22888">                                                                        .getLocation());</span>
<span class="nc" id="L22889">                            damage = Math.min(damage, te.getArmor(new_loc));</span>
                            // We don't want to deal negative damage
<span class="nc" id="L22891">                            damage = Math.max(damage, 0);</span>
<span class="nc" id="L22892">                            r = new Report(6065);</span>
<span class="nc" id="L22893">                            r.subject = te_n;</span>
<span class="nc" id="L22894">                            r.indent(2);</span>
<span class="nc" id="L22895">                            r.newlines = 0;</span>
<span class="nc" id="L22896">                            r.addDesc(te);</span>
<span class="nc" id="L22897">                            r.add(damage);</span>
<span class="nc" id="L22898">                            r.add(te.getLocationAbbr(new_loc));</span>
<span class="nc" id="L22899">                            vDesc.addElement(r);</span>
<span class="nc" id="L22900">                            te.setArmor(te.getArmor(new_loc) - damage, new_loc);</span>
<span class="nc bnc" id="L22901" title="All 4 branches missed.">                            if ((te instanceof Warship)</span>
                                || (te instanceof Dropship)) {
<span class="nc" id="L22903">                                damage = 2;</span>
                            } else {
<span class="nc" id="L22905">                                damage = 0;</span>
                            }
                        }
                    }

                    // divide damage in half
                    // do not divide by half if it is an ammo exposion
<span class="nc bnc" id="L22912" title="All 4 branches missed.">                    if (!ammoExplosion &amp;&amp; !nukeS2S</span>
<span class="nc bnc" id="L22913" title="All 2 branches missed.">                        &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L22914">                        damage /= 2;</span>
                    }

                    // this should result in a crit
                    // but only if it really did damage after rounding down
<span class="nc bnc" id="L22919" title="All 2 branches missed.">                    if (damage &gt; 0) {</span>
<span class="nc" id="L22920">                        critSI = true;</span>
                    }

                    // Now apply damage to the structural integrity
<span class="nc" id="L22924">                    a.setSI(a.getSI() - damage);</span>
<span class="nc" id="L22925">                    te.damageThisPhase += damage;</span>
                    // send the report
<span class="nc" id="L22927">                    r = new Report(1210);</span>
<span class="nc" id="L22928">                    r.subject = te_n;</span>
<span class="nc" id="L22929">                    r.newlines = 1;</span>
<span class="nc bnc" id="L22930" title="All 2 branches missed.">                    if (!ammoExplosion) {</span>
<span class="nc" id="L22931">                        r.messageId = 9005;</span>
                    }
                    //Only for fighters
<span class="nc bnc" id="L22934" title="All 4 branches missed.">                    if (ammoExplosion &amp;&amp; !a.isLargeCraft()) {</span>
<span class="nc" id="L22935">                        r.messageId = 9006;</span>
                    }
<span class="nc" id="L22937">                    r.add(damage);</span>
<span class="nc" id="L22938">                    r.add(Math.max(a.getSI(), 0));</span>
<span class="nc" id="L22939">                    vDesc.addElement(r);</span>
                    // check to see if this would destroy the ASF
<span class="nc bnc" id="L22941" title="All 2 branches missed.">                    if (a.getSI() &lt;= 0) {</span>
                        // Lets auto-eject if we can!
<span class="nc bnc" id="L22943" title="All 2 branches missed.">                        if (a.isAutoEject()</span>
<span class="nc bnc" id="L22944" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22945" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22946" title="All 2 branches missed.">                                            &amp;&amp; a.isCondEjectSIDest()))) {</span>
<span class="nc" id="L22947">                            vDesc.addAll(ejectEntity(te, true, false));</span>
                        } else {
<span class="nc" id="L22949">                            vDesc.addAll(destroyEntity(te,&quot;Structural Integrity Collapse&quot;));</span>
                        }
<span class="nc" id="L22951">                        a.setSI(0);</span>
<span class="nc bnc" id="L22952" title="All 2 branches missed.">                        if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L22953">                            creditKill(a, game.getEntity(hit.getAttackerId()));</span>
                        }
                    }
<span class="nc" id="L22956">                    checkAeroCrits(vDesc, a, hit, damage_orig, critThresh, critSI, ammoExplosion, nukeS2S);</span>
<span class="nc" id="L22957">                    return vDesc;</span>
                }

                // Check for CASE II right away. if so reduce damage to 1
                // and let it hit the IS.
                // Also remove as much of the rear armor as allowed by the
                // damage. If arm/leg/head
                // Then they lose all their armor if its less then the
                // explosion damage.
<span class="nc bnc" id="L22966" title="All 4 branches missed.">                if (ammoExplosion &amp;&amp; te.hasCASEII(hit.getLocation())) {</span>
                    // 1 point of damage goes to IS
<span class="nc" id="L22968">                    damage--;</span>
                    // Remaining damage prevented by CASE II
<span class="nc" id="L22970">                    r = new Report(6126);</span>
<span class="nc" id="L22971">                    r.subject = te_n;</span>
<span class="nc" id="L22972">                    r.add(damage);</span>
<span class="nc" id="L22973">                    r.indent(3);</span>
<span class="nc" id="L22974">                    vDesc.addElement(r);</span>
<span class="nc" id="L22975">                    int loc = hit.getLocation();</span>
<span class="nc bnc" id="L22976" title="All 6 branches missed.">                    if ((te instanceof Mech) &amp;&amp; ((loc == Mech.LOC_HEAD) || ((Mech) te).isArm(loc)</span>
<span class="nc bnc" id="L22977" title="All 2 branches missed.">                            || te.locationIsLeg(loc))) {</span>
<span class="nc" id="L22978">                        int half = (int) Math.ceil(te.getOArmor(loc, false) / 2.0);</span>
<span class="nc bnc" id="L22979" title="All 2 branches missed.">                        if (damage &gt; half) {</span>
<span class="nc" id="L22980">                            damage = half;</span>
                        }
<span class="nc bnc" id="L22982" title="All 2 branches missed.">                        if (damage &gt;= te.getArmor(loc, false)) {</span>
<span class="nc" id="L22983">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc, false);</span>
                        } else {
<span class="nc" id="L22985">                            te.setArmor(te.getArmor(loc, false) - damage, loc, false);</span>
                        }
<span class="nc" id="L22987">                    } else {</span>
<span class="nc bnc" id="L22988" title="All 2 branches missed.">                        if (damage &gt;= te.getArmor(loc, true)) {</span>
<span class="nc" id="L22989">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc, true);</span>
                        } else {
<span class="nc" id="L22991">                            te.setArmor(te.getArmor(loc, true) - damage, loc, true);</span>
                        }
                    }

<span class="nc bnc" id="L22995" title="All 2 branches missed.">                    if (te.getInternal(hit) &gt; 0) {</span>
                        // Mek takes 1 point of IS damage
<span class="nc" id="L22997">                        damage = 1;</span>
                    } else {
<span class="nc" id="L22999">                        damage = 0;</span>
                    }

<span class="nc" id="L23002">                    te.damageThisPhase += damage;</span>

<span class="nc" id="L23004">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L23005">                    r = new Report(6127);</span>
<span class="nc" id="L23006">                    r.subject = te.getId();</span>
<span class="nc" id="L23007">                    r.add(roll);</span>
<span class="nc" id="L23008">                    vDesc.add(r);</span>
<span class="nc bnc" id="L23009" title="All 2 branches missed.">                    if (roll &gt;= 8) {</span>
<span class="nc" id="L23010">                        hit.setEffect(HitData.EFFECT_NO_CRITICALS);</span>
                    }
                }
                // check for tank CASE here: damage to rear armor, excess
                // dissipating, and a crew stunned crit
<span class="nc bnc" id="L23015" title="All 4 branches missed.">                if (ammoExplosion &amp;&amp; (te instanceof Tank)</span>
<span class="nc bnc" id="L23016" title="All 2 branches missed.">                    &amp;&amp; te.locationHasCase(Tank.LOC_BODY)) {</span>
<span class="nc" id="L23017">                    te.damageThisPhase += damage;</span>
<span class="nc" id="L23018">                    r = new Report(6124);</span>
<span class="nc" id="L23019">                    r.subject = te_n;</span>
<span class="nc" id="L23020">                    r.indent(2);</span>
<span class="nc" id="L23021">                    r.add(damage);</span>
<span class="nc" id="L23022">                    vDesc.add(r);</span>
<span class="nc bnc" id="L23023" title="All 2 branches missed.">                    int loc = (te instanceof SuperHeavyTank) ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L23024" title="All 2 branches missed.">                            : (te instanceof LargeSupportTank) ? LargeSupportTank.LOC_REAR : Tank.LOC_REAR;</span>
<span class="nc bnc" id="L23025" title="All 2 branches missed.">                    if (damage &gt; te.getArmor(loc)) {</span>
<span class="nc" id="L23026">                        te.setArmor(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc" id="L23027">                        r = new Report(6090);</span>
                    } else {
<span class="nc" id="L23029">                        te.setArmor(te.getArmor(loc) - damage, loc);</span>
<span class="nc" id="L23030">                        r = new Report(6085);</span>
<span class="nc" id="L23031">                        r.add(te.getArmor(loc));</span>
                    }
<span class="nc" id="L23033">                    r.subject = te_n;</span>
<span class="nc" id="L23034">                    r.indent(3);</span>
<span class="nc" id="L23035">                    vDesc.add(r);</span>
<span class="nc" id="L23036">                    damage = 0;</span>
                    int critIndex;
<span class="nc bnc" id="L23038" title="All 2 branches missed.">                    if (((Tank) te).isCommanderHit()</span>
<span class="nc bnc" id="L23039" title="All 2 branches missed.">                        &amp;&amp; ((Tank) te).isDriverHit()) {</span>
<span class="nc" id="L23040">                        critIndex = Tank.CRIT_CREW_KILLED;</span>
                    } else {
<span class="nc" id="L23042">                        critIndex = Tank.CRIT_CREW_STUNNED;</span>
                    }
<span class="nc" id="L23044">                    vDesc.addAll(applyCriticalHit(te, Entity.NONE, new CriticalSlot(0, critIndex), true, 0, false));</span>
                }

                // is there internal structure in the location hit?
<span class="nc bnc" id="L23048" title="All 2 branches missed.">                if (te.getInternal(hit) &gt; 0) {</span>

                    // Now we need to consider alternate structure types!
<span class="nc" id="L23051">                    int tmpDamageHold = -1;</span>
<span class="nc bnc" id="L23052" title="All 2 branches missed.">                    if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23053" title="All 2 branches missed.">                        &amp;&amp; ((Mech) te).hasCompositeStructure()) {</span>
<span class="nc" id="L23054">                        tmpDamageHold = damage;</span>
<span class="nc" id="L23055">                        damage *= 2;</span>
<span class="nc" id="L23056">                        r = new Report(6091);</span>
<span class="nc" id="L23057">                        r.subject = te_n;</span>
<span class="nc" id="L23058">                        r.indent(3);</span>
<span class="nc" id="L23059">                        vDesc.add(r);</span>
                    }
<span class="nc bnc" id="L23061" title="All 2 branches missed.">                    if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23062" title="All 2 branches missed.">                        &amp;&amp; ((Mech) te).hasReinforcedStructure()) {</span>
<span class="nc" id="L23063">                        tmpDamageHold = damage;</span>
<span class="nc" id="L23064">                        damage /= 2;</span>
<span class="nc" id="L23065">                        damage += tmpDamageHold % 2;</span>
<span class="nc" id="L23066">                        r = new Report(6092);</span>
<span class="nc" id="L23067">                        r.subject = te_n;</span>
<span class="nc" id="L23068">                        r.indent(3);</span>
<span class="nc" id="L23069">                        vDesc.add(r);</span>
                    }
<span class="nc bnc" id="L23071" title="All 4 branches missed.">                    if ((te.getInternal(hit) &gt; damage) &amp;&amp; (damage &gt; 0)) {</span>
                        // internal structure absorbs all damage
<span class="nc" id="L23073">                        te.setInternal(te.getInternal(hit) - damage, hit);</span>
                        // Triggers a critical hit on Vehicles and Mechs.
<span class="nc bnc" id="L23075" title="All 4 branches missed.">                        if (!isPlatoon &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L23076">                            crits++;</span>
                        }
<span class="nc" id="L23078">                        tookInternalDamage = true;</span>
                        // Alternate structures don't affect our damage total
                        // for later PSR purposes, so use the previously stored
                        // value here as necessary.
<span class="nc bnc" id="L23082" title="All 2 branches missed.">                        te.damageThisPhase += (tmpDamageHold &gt; -1) ?</span>
<span class="nc" id="L23083">                                tmpDamageHold : damage;</span>
<span class="nc" id="L23084">                        damage = 0;</span>
<span class="nc" id="L23085">                        r = new Report(6100);</span>
<span class="nc" id="L23086">                        r.subject = te_n;</span>
<span class="nc" id="L23087">                        r.indent(3);</span>
                        // Infantry platoons have men not &quot;Internals&quot;.
<span class="nc bnc" id="L23089" title="All 2 branches missed.">                        if (isPlatoon) {</span>
<span class="nc" id="L23090">                            r.messageId = 6095;</span>
                        }
<span class="nc" id="L23092">                        r.add(te.getInternal(hit));</span>
<span class="nc" id="L23093">                        vDesc.addElement(r);</span>
<span class="nc bnc" id="L23094" title="All 2 branches missed.">                    } else if (damage &gt; 0) {</span>
                        // Triggers a critical hit on Vehicles and Mechs.
<span class="nc bnc" id="L23096" title="All 4 branches missed.">                        if (!isPlatoon &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L23097">                            crits++;</span>
                        }
                        // damage transfers, maybe
<span class="nc" id="L23100">                        int absorbed = Math.max(te.getInternal(hit), 0);</span>

                        // Handle ProtoMech pilot damage
                        // due to location destruction
<span class="nc bnc" id="L23104" title="All 2 branches missed.">                        if (te instanceof Protomech) {</span>
<span class="nc" id="L23105">                            int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L23106">                                    - ((Protomech) te).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L23107" title="All 2 branches missed.">                            if (hits &gt; 0) {</span>
<span class="nc" id="L23108">                                vDesc.addAll(damageCrew(te, hits));</span>
<span class="nc" id="L23109">                                ((Protomech) te).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L23110">                                        Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                            }
                        }

                        // Platoon, Trooper, or Section destroyed message
<span class="nc" id="L23115">                        r = new Report(1210);</span>
<span class="nc" id="L23116">                        r.subject = te_n;</span>
<span class="nc bnc" id="L23117" title="All 2 branches missed.">                        if (isPlatoon) {</span>
                            // Infantry have only one section, and
                            // are therefore destroyed.
<span class="nc bnc" id="L23120" title="All 2 branches missed.">                            if (((Infantry) te).isSquad()) {</span>
<span class="nc" id="L23121">                                r.messageId = 6106; // Squad Killed</span>
                            } else {
<span class="nc" id="L23123">                                r.messageId = 6105; // Platoon Killed</span>
                            }
<span class="nc bnc" id="L23125" title="All 2 branches missed.">                        } else if (isBattleArmor) {</span>
<span class="nc" id="L23126">                            r.messageId = 6110;</span>
                        } else {
<span class="nc" id="L23128">                            r.messageId = 6115;</span>
                        }
<span class="nc" id="L23130">                        r.indent(3);</span>
<span class="nc" id="L23131">                        vDesc.addElement(r);</span>

                        // If a sidetorso got destroyed, and the
                        // corresponding arm is not yet destroyed, add
                        // it as a club to that hex (p.35 BMRr)
<span class="nc bnc" id="L23136" title="All 2 branches missed.">                        if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23137" title="All 2 branches missed.">                                &amp;&amp; (((hit.getLocation() == Mech.LOC_RT)</span>
<span class="nc bnc" id="L23138" title="All 2 branches missed.">                                        &amp;&amp; (te.getInternal(Mech.LOC_RARM) &gt; 0))</span>
<span class="nc bnc" id="L23139" title="All 2 branches missed.">                                    || ((hit.getLocation() == Mech.LOC_LT)</span>
<span class="nc bnc" id="L23140" title="All 2 branches missed.">                                        &amp;&amp; (te.getInternal(Mech.LOC_LARM) &gt; 0)))) {</span>
                            int blownOffLocation;
<span class="nc bnc" id="L23142" title="All 2 branches missed.">                            if (hit.getLocation() == Mech.LOC_RT) {</span>
<span class="nc" id="L23143">                                blownOffLocation = Mech.LOC_RARM;</span>
                            } else {
<span class="nc" id="L23145">                                blownOffLocation = Mech.LOC_LARM;</span>
                            }
<span class="nc" id="L23147">                            te.destroyLocation(blownOffLocation, true);</span>
<span class="nc" id="L23148">                            r = new Report(6120);</span>
<span class="nc" id="L23149">                            r.subject = te_n;</span>
<span class="nc" id="L23150">                            r.add(te.getLocationName(blownOffLocation));</span>
<span class="nc" id="L23151">                            vDesc.addElement(r);</span>
<span class="nc" id="L23152">                            IHex h = game.getBoard().getHex(te.getPosition());</span>
<span class="nc bnc" id="L23153" title="All 2 branches missed.">                            if(null != h) {</span>
<span class="nc bnc" id="L23154" title="All 2 branches missed.">                                if (te instanceof BipedMech) {</span>
<span class="nc bnc" id="L23155" title="All 2 branches missed.">                                    if (!h.containsTerrain(Terrains.ARMS)) {</span>
<span class="nc" id="L23156">                                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L23157">                                                             .createTerrain(Terrains.ARMS, 1));</span>
                                    } else {
<span class="nc" id="L23159">                                        h.addTerrain(Terrains</span>
<span class="nc" id="L23160">                                                             .getTerrainFactory()</span>
<span class="nc" id="L23161">                                                             .createTerrain(</span>
                                                                     Terrains.ARMS,
<span class="nc" id="L23163">                                                                     h.terrainLevel(Terrains.ARMS) + 1));</span>
                                    }
<span class="nc bnc" id="L23165" title="All 2 branches missed.">                                } else if (!h.containsTerrain(Terrains.LEGS)) {</span>
<span class="nc" id="L23166">                                    h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L23167">                                                         .createTerrain(Terrains.LEGS, 1));</span>
                                } else {
<span class="nc" id="L23169">                                    h.addTerrain(Terrains</span>
<span class="nc" id="L23170">                                                         .getTerrainFactory()</span>
<span class="nc" id="L23171">                                                         .createTerrain(</span>
                                                                 Terrains.LEGS,
<span class="nc" id="L23173">                                                                 h.terrainLevel(Terrains.LEGS) + 1));</span>
                                }
<span class="nc" id="L23175">                                sendChangedHex(te.getPosition());</span>
                            }
                        }

                        // Troopers riding on a location
                        // all die when the location is destroyed.
<span class="nc bnc" id="L23181" title="All 4 branches missed.">                        if ((te instanceof Mech) || (te instanceof Tank)) {</span>
<span class="nc" id="L23182">                            Entity passenger = te.getExteriorUnitAt(</span>
<span class="nc" id="L23183">                                    hit.getLocation(), hit.isRear());</span>
<span class="nc bnc" id="L23184" title="All 4 branches missed.">                            if ((null != passenger) &amp;&amp; !passenger.isDoomed()) {</span>
<span class="nc" id="L23185">                                HitData passHit = passenger</span>
<span class="nc" id="L23186">                                        .getTrooperAtLocation(hit, te);</span>
                                // ensures a kill
<span class="nc" id="L23188">                                passHit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc bnc" id="L23189" title="All 2 branches missed.">                                if (passenger.getInternal(passHit) &gt; 0) {</span>
<span class="nc" id="L23190">                                    vDesc.addAll(damageEntity(passenger,</span>
                                                              passHit, damage));
                                }
<span class="nc" id="L23193">                                passHit = new HitData(hit.getLocation(),</span>
<span class="nc bnc" id="L23194" title="All 2 branches missed.">                                                      !hit.isRear());</span>
<span class="nc" id="L23195">                                passHit = passenger.getTrooperAtLocation(</span>
                                        passHit, te);
                                // ensures a kill
<span class="nc" id="L23198">                                passHit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc bnc" id="L23199" title="All 2 branches missed.">                                if (passenger.getInternal(passHit) &gt; 0) {</span>
<span class="nc" id="L23200">                                    vDesc.addAll(damageEntity(passenger,</span>
                                                              passHit, damage));
                                }
                            }
                        }

                        // BA inferno explosions
<span class="nc bnc" id="L23207" title="All 2 branches missed.">                        if (te instanceof BattleArmor) {</span>
<span class="nc" id="L23208">                            int infernos = 0;</span>
<span class="nc bnc" id="L23209" title="All 2 branches missed.">                            for (Mounted m : te.getEquipment()) {</span>
<span class="nc bnc" id="L23210" title="All 2 branches missed.">                                if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L23211">                                    AmmoType at = (AmmoType) m.getType();</span>
<span class="nc bnc" id="L23212" title="All 4 branches missed.">                                    if (((at.getAmmoType() == AmmoType.T_SRM) || (at.getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L23213" title="All 2 branches missed.">                                            &amp;&amp; (at.getMunitionType() == AmmoType.M_INFERNO)) {</span>
<span class="nc" id="L23214">                                        infernos += at.getRackSize() * m.getHittableShotsLeft();</span>
                                    }
<span class="nc bnc" id="L23216" title="All 2 branches missed.">                                } else if (m.getType().hasFlag(MiscType.F_FIRE_RESISTANT)) {</span>
                                    // immune to inferno explosion
<span class="nc" id="L23218">                                    infernos = 0;</span>
<span class="nc" id="L23219">                                    break;</span>
                                }
<span class="nc" id="L23221">                            }</span>
<span class="nc bnc" id="L23222" title="All 2 branches missed.">                            if (infernos &gt; 0) {</span>
<span class="nc" id="L23223">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L23224">                                r = new Report(6680);</span>
<span class="nc" id="L23225">                                r.add(roll);</span>
<span class="nc" id="L23226">                                vDesc.add(r);</span>
<span class="nc bnc" id="L23227" title="All 2 branches missed.">                                if (roll &gt;= 8) {</span>
<span class="nc" id="L23228">                                    Coords c = te.getPosition();</span>
<span class="nc bnc" id="L23229" title="All 2 branches missed.">                                    if (c == null) {</span>
<span class="nc" id="L23230">                                        Entity transport = game.getEntity(te.getTransportId());</span>
<span class="nc bnc" id="L23231" title="All 2 branches missed.">                                        if (transport != null) {</span>
<span class="nc" id="L23232">                                            c = transport.getPosition();</span>
                                        }
<span class="nc" id="L23234">                                        vPhaseReport.addAll(deliverInfernoMissiles(te, te, infernos));</span>
                                    }
<span class="nc bnc" id="L23236" title="All 2 branches missed.">                                    if (c != null) {</span>
<span class="nc" id="L23237">                                        vPhaseReport.addAll(deliverInfernoMissiles(te,</span>
<span class="nc" id="L23238">                                                new HexTarget(c, game.getBoard(), Targetable.TYPE_HEX_ARTILLERY),</span>
                                                infernos));
                                    }
                                }
                            }
                        }

                        // Mark off the internal structure here, but *don't*
                        // destroy the location just yet -- there are checks
                        // still to run!
<span class="nc" id="L23248">                        te.setInternal(0, hit);</span>
<span class="nc" id="L23249">                        te.damageThisPhase += absorbed;</span>
<span class="nc" id="L23250">                        damage -= absorbed;</span>

                        // Now we need to consider alternate structure types!
<span class="nc bnc" id="L23253" title="All 2 branches missed.">                        if (tmpDamageHold &gt; 0) {</span>
<span class="nc bnc" id="L23254" title="All 2 branches missed.">                            if (((Mech) te).hasCompositeStructure()) {</span>
                                // If there's a remainder, we can actually
                                // ignore it.
<span class="nc" id="L23257">                                damage /= 2;</span>
<span class="nc bnc" id="L23258" title="All 2 branches missed.">                            } else if (((Mech) te).hasReinforcedStructure()) {</span>
<span class="nc" id="L23259">                                damage *= 2;</span>
<span class="nc" id="L23260">                                damage -= tmpDamageHold % 2;</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L23265" title="All 2 branches missed.">                if (te.getInternal(hit) &lt;= 0) {</span>
                    // internal structure is gone, what are the transfer
                    // potentials?
<span class="nc" id="L23268">                    nextHit = te.getTransferLocation(hit);</span>
<span class="nc bnc" id="L23269" title="All 2 branches missed.">                    if (nextHit.getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc bnc" id="L23270" title="All 2 branches missed.">                        if (te instanceof Mech) {</span>
                            // Start with the number of engine crits in this
                            // location, if any...
<span class="nc" id="L23273">                            te.engineHitsThisPhase += te.getNumberOfCriticals(</span>
                                    CriticalSlot.TYPE_SYSTEM,
<span class="nc" id="L23275">                                    Mech.SYSTEM_ENGINE, hit.getLocation());</span>
                            // ...then deduct the ones destroyed previously or
                            // critically
                            // hit this round already. That leaves the ones
                            // actually
                            // destroyed with the location.
<span class="nc" id="L23281">                            te.engineHitsThisPhase -= te.getHitCriticals(</span>
                                    CriticalSlot.TYPE_SYSTEM,
<span class="nc" id="L23283">                                    Mech.SYSTEM_ENGINE, hit.getLocation());</span>
                        }

<span class="nc" id="L23286">                        boolean engineExploded = checkEngineExplosion(te,</span>
                                vDesc, te.engineHitsThisPhase);

<span class="nc bnc" id="L23289" title="All 2 branches missed.">                        if (!engineExploded) {</span>
                            // Entity destroyed. Ammo explosions are
                            // neither survivable nor salvageable.
                            // Only ammo explosions in the CT are devastating.
<span class="nc bnc" id="L23293" title="All 10 branches missed.">                            vDesc.addAll(destroyEntity(te, &quot;damage&quot;, !ammoExplosion,</span>
                                    !((ammoExplosion || areaSatArty) &amp;&amp; ((te instanceof Tank)
<span class="nc bnc" id="L23295" title="All 2 branches missed.">                                            || ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_CT))))));</span>
                            // If the head is destroyed, kill the crew.

<span class="nc bnc" id="L23298" title="All 4 branches missed.">                            if ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L23299" title="All 4 branches missed.">                                    &amp;&amp; !te.getCrew().isDead() &amp;&amp; !te.getCrew().isDoomed()</span>
<span class="nc bnc" id="L23300" title="All 2 branches missed.">                                    &amp;&amp; game.getOptions().booleanOption(</span>
                                            OptionsConstants.ADVANCED_TACOPS_SKIN_OF_THE_TEETH_EJECTION)) {
<span class="nc" id="L23302">                                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L23303" title="All 2 branches missed.">                                if (mech.isAutoEject()</span>
<span class="nc bnc" id="L23304" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23306" title="All 2 branches missed.">                                        || (game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23308" title="All 2 branches missed.">                                                &amp;&amp; mech.isCondEjectHeadshot()))) {</span>
<span class="nc" id="L23309">                                    autoEject = true;</span>
<span class="nc" id="L23310">                                    vDesc.addAll(ejectEntity(te, true, true));</span>
                                }
                            }

<span class="nc bnc" id="L23314" title="All 4 branches missed.">                            if ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_CT)</span>
<span class="nc bnc" id="L23315" title="All 4 branches missed.">                                    &amp;&amp; !te.getCrew().isDead() &amp;&amp; !te.getCrew().isDoomed()) {</span>
<span class="nc" id="L23316">                                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L23317" title="All 2 branches missed.">                                if (mech.isAutoEject()</span>
<span class="nc bnc" id="L23318" title="All 2 branches missed.">                                        &amp;&amp; game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23320" title="All 2 branches missed.">                                        &amp;&amp; mech.isCondEjectCTDest()) {</span>
<span class="nc bnc" id="L23321" title="All 2 branches missed.">                                    if (mech.getCrew().getHits() &lt; 5) {</span>
<span class="nc" id="L23322">                                        Report.addNewline(vDesc);</span>
<span class="nc" id="L23323">                                        mech.setDoomed(false);</span>
<span class="nc" id="L23324">                                        mech.setDoomed(true);</span>
                                    }
<span class="nc" id="L23326">                                    autoEject = true;</span>
<span class="nc" id="L23327">                                    vDesc.addAll(ejectEntity(te, true));</span>
                                }
                            }

<span class="nc bnc" id="L23331" title="All 2 branches missed.">                            if ((hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L23332" title="All 8 branches missed.">                                    || ((hit.getLocation() == Mech.LOC_CT)</span>
                                    &amp;&amp; ((ammoExplosion &amp;&amp; !autoEject) || areaSatArty))) {
<span class="nc" id="L23334">                                te.getCrew().setDoomed(true);</span>
                            }
<span class="nc bnc" id="L23336" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {
<span class="nc" id="L23338">                                vDesc.addAll(abandonEntity(te));</span>
                            }
                        }

                        // nowhere for further damage to go
<span class="nc" id="L23343">                        damage = 0;</span>
<span class="nc bnc" id="L23344" title="All 2 branches missed.">                    } else if (nextHit.getLocation() == Entity.LOC_NONE) {</span>
                        // Rest of the damage is wasted.
<span class="nc" id="L23346">                        damage = 0;</span>
<span class="nc bnc" id="L23347" title="All 2 branches missed.">                    } else if (ammoExplosion</span>
<span class="nc bnc" id="L23348" title="All 2 branches missed.">                               &amp;&amp; te.locationHasCase(hit.getLocation())) {</span>
                        // Remaining damage prevented by CASE
<span class="nc" id="L23350">                        r = new Report(6125);</span>
<span class="nc" id="L23351">                        r.subject = te_n;</span>
<span class="nc" id="L23352">                        r.add(damage);</span>
<span class="nc" id="L23353">                        r.indent(3);</span>
<span class="nc" id="L23354">                        vDesc.addElement(r);</span>

                        // The target takes no more damage from the explosion.
<span class="nc" id="L23357">                        damage = 0;</span>
<span class="nc bnc" id="L23358" title="All 2 branches missed.">                    } else if (damage &gt; 0) {</span>
                        // remaining damage transfers
<span class="nc" id="L23360">                        r = new Report(6130);</span>
<span class="nc" id="L23361">                        r.subject = te_n;</span>
<span class="nc" id="L23362">                        r.indent(2);</span>
<span class="nc" id="L23363">                        r.add(damage);</span>
<span class="nc" id="L23364">                        r.add(te.getLocationAbbr(nextHit));</span>
<span class="nc" id="L23365">                        vDesc.addElement(r);</span>

                        // If there are split weapons in this location, mark it
                        // as hit, even if it took no criticals.
<span class="nc bnc" id="L23369" title="All 2 branches missed.">                        for (Mounted m : te.getWeaponList()) {</span>
<span class="nc bnc" id="L23370" title="All 2 branches missed.">                            if (m.isSplit()) {</span>
<span class="nc bnc" id="L23371" title="All 2 branches missed.">                                if ((m.getLocation() == hit.getLocation())</span>
<span class="nc" id="L23372">                                    || (m.getLocation() == nextHit</span>
<span class="nc bnc" id="L23373" title="All 2 branches missed.">                                        .getLocation())) {</span>
<span class="nc" id="L23374">                                    te.setWeaponHit(m);</span>
                                }
                            }
<span class="nc" id="L23377">                        }</span>
                        // if this is damage from a nail/rivet gun, and we
                        // transfer
                        // to a location that has armor, and BAR &gt;=5, no damage
<span class="nc bnc" id="L23381" title="All 2 branches missed.">                        if ((bFrag == DamageType.NAIL_RIVET)</span>
<span class="nc bnc" id="L23382" title="All 2 branches missed.">                            &amp;&amp; (te.getArmor(nextHit.getLocation()) &gt; 0)</span>
<span class="nc bnc" id="L23383" title="All 2 branches missed.">                            &amp;&amp; (te.getBARRating(nextHit.getLocation()) &gt;= 5)) {</span>
<span class="nc" id="L23384">                            damage = 0;</span>
<span class="nc" id="L23385">                            r = new Report(6065);</span>
<span class="nc" id="L23386">                            r.subject = te_n;</span>
<span class="nc" id="L23387">                            r.indent(2);</span>
<span class="nc" id="L23388">                            vDesc.add(r);</span>
                        }
                    }
                }
<span class="nc bnc" id="L23392" title="All 2 branches missed.">            } else if (hit.getSpecCrit()) {</span>
                // ok, we dealt damage but didn't go on to internal
                // we get a chance of a crit, using Armor Piercing.
                // but only if we don't have hardened, Ferro-Lamellor, or reactive armor
<span class="nc bnc" id="L23396" title="All 6 branches missed.">                if (!hardenedArmor &amp;&amp; !ferroLamellorArmor &amp;&amp; !reactiveArmor) {</span>
<span class="nc" id="L23397">                    specCrits++;</span>
                }
            }
            // check for breaching
<span class="nc" id="L23401">            vDesc.addAll(breachCheck(te, hit.getLocation(), null, underWater));</span>

            // resolve special results
<span class="nc bnc" id="L23404" title="All 2 branches missed.">            if ((hit.getEffect() &amp; HitData.EFFECT_VEHICLE_MOVE_DAMAGED) == HitData.EFFECT_VEHICLE_MOVE_DAMAGED) {</span>
<span class="nc" id="L23405">                vDesc.addAll(vehicleMotiveDamage((Tank) te, hit.getMotiveMod()));</span>
            }
            // Damage from any source can break spikes
<span class="nc bnc" id="L23408" title="All 2 branches missed.">            if (te.hasWorkingMisc(MiscType.F_SPIKES, -1, hit.getLocation())) {</span>
<span class="nc" id="L23409">                vDesc.add(checkBreakSpikes(te, hit.getLocation()));</span>
            }

            // roll all critical hits against this location
            // unless the section destroyed in a previous phase?
            // Cause a crit.
<span class="nc bnc" id="L23415" title="All 2 branches missed.">            if ((te.getInternal(hit) != IArmorState.ARMOR_DESTROYED)</span>
<span class="nc bnc" id="L23416" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc bnc" id="L23417" title="All 2 branches missed.">                for (int i = 0; i &lt; crits; i++) {</span>
<span class="nc" id="L23418">                    vDesc.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
<span class="nc" id="L23419">                            hit.glancingMod() + critBonus, damage_orig));</span>
                }
<span class="nc" id="L23421">                crits = 0;</span>

<span class="nc bnc" id="L23423" title="All 2 branches missed.">                for (int i = 0; i &lt; specCrits; i++) {</span>
                    // against BAR or reflective armor, we get a +2 mod
<span class="nc bnc" id="L23425" title="All 2 branches missed.">                    int critMod = te.hasBARArmor(hit.getLocation()) ? 2 : 0;</span>
<span class="nc bnc" id="L23426" title="All 4 branches missed.">                    critMod += (reflectiveArmor &amp;&amp; !isBattleArmor) ? 2 : 0; // BA</span>
                    // against impact armor, we get a +1 mod
<span class="nc bnc" id="L23428" title="All 2 branches missed.">                    critMod += impactArmor ? 1 : 0;</span>
                    // hardened armour has no crit penalty
<span class="nc bnc" id="L23430" title="All 2 branches missed.">                    if (!hardenedArmor) {</span>
                        // non-hardened armor gets modifiers
                        // the -2 for hardened is handled in the critBonus
                        // variable
<span class="nc" id="L23434">                        critMod += hit.getSpecCritMod();</span>
<span class="nc" id="L23435">                        critMod += hit.glancingMod();</span>
                    }
<span class="nc" id="L23437">                    vDesc.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
                            critMod + critBonus, damage_orig));
                }
<span class="nc" id="L23440">                specCrits = 0;</span>
            }

            // resolve Aero crits
<span class="nc bnc" id="L23444" title="All 2 branches missed.">            if (te instanceof Aero) {</span>
<span class="nc" id="L23445">                checkAeroCrits(vDesc, (Aero) te, hit, damage_orig, critThresh, critSI,</span>
                        ammoExplosion, nukeS2S);
            }

<span class="nc bnc" id="L23449" title="All 2 branches missed.">            if (isHeadHit</span>
<span class="nc bnc" id="L23450" title="All 2 branches missed.">                &amp;&amp; !te.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L23451">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23452">                vDesc.addAll(damageCrew(te, 1));</span>
            }

            // If the location has run out of internal structure, finally
            // actually
            // destroy it here. *EXCEPTION:* Aero units have 0 internal
            // structure
            // in every location by default and are handled elsewhere, so they
            // get a bye.
<span class="nc bnc" id="L23461" title="All 4 branches missed.">            if (!(te instanceof Aero) &amp;&amp; (te.getInternal(hit) &lt;= 0)) {</span>
<span class="nc" id="L23462">                te.destroyLocation(hit.getLocation());</span>

                // Check for possible engine destruction here
<span class="nc bnc" id="L23465" title="All 2 branches missed.">                if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23466" title="All 4 branches missed.">                        &amp;&amp; ((hit.getLocation() == Mech.LOC_RT) || (hit.getLocation() == Mech.LOC_LT))) {</span>

<span class="nc" id="L23468">                    int numEngineHits = te.getEngineHits();</span>
<span class="nc" id="L23469">                    boolean engineExploded = checkEngineExplosion(te, vDesc, numEngineHits);</span>

<span class="nc" id="L23471">                    int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L23472" title="All 6 branches missed.">                    if ((te instanceof Mech) &amp;&amp; te.isSuperHeavy() &amp;&amp; te.hasEngine()</span>
<span class="nc bnc" id="L23473" title="All 2 branches missed.">                            &amp;&amp; (te.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L23474">                        hitsToDestroy = 2;</span>
                    }

<span class="nc bnc" id="L23477" title="All 4 branches missed.">                    if (!engineExploded &amp;&amp; (numEngineHits &gt;= hitsToDestroy)) {</span>
                        // third engine hit
<span class="nc" id="L23479">                        vDesc.addAll(destroyEntity(te, &quot;engine destruction&quot;));</span>
<span class="nc" id="L23480">                        if (game.getOptions()</span>
<span class="nc bnc" id="L23481" title="All 2 branches missed.">                                .booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L23482">                            vDesc.addAll(abandonEntity(te));</span>
                        }
<span class="nc" id="L23484">                        te.setSelfDestructing(false);</span>
<span class="nc" id="L23485">                        te.setSelfDestructInitiated(false);</span>
                    }

                    // Torso destruction in airborne LAM causes immediate crash.
<span class="nc bnc" id="L23489" title="All 6 branches missed.">                    if ((te instanceof LandAirMech) &amp;&amp; !te.isDestroyed() &amp;&amp; !te.isDoomed()) {</span>
<span class="nc" id="L23490">                        r = new Report(9710);</span>
<span class="nc" id="L23491">                        r.subject = te.getId();</span>
<span class="nc" id="L23492">                        r.addDesc(te);</span>
<span class="nc bnc" id="L23493" title="All 2 branches missed.">                        if (te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L23494">                            vDesc.add(r);</span>
<span class="nc" id="L23495">                            crashAirMech(te, new PilotingRollData(te.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                                    &quot;side torso destroyed&quot;), vDesc);
<span class="nc bnc" id="L23497" title="All 4 branches missed.">                        } else if (te.isAirborne() &amp;&amp; te.isAero()) {</span>
<span class="nc" id="L23498">                            vDesc.add(r);</span>
<span class="nc" id="L23499">                            vDesc.addAll(processCrash(te, ((IAero)te).getCurrentVelocity(), te.getPosition()));</span>
                        }
                    }
                }

            }

            // If damage remains, loop to next location; if not, be sure to stop
            // here because we may need to refer back to the last *damaged*
            // location again later. (This is safe because at damage &lt;= 0 the
            // loop terminates anyway.)
<span class="nc bnc" id="L23510" title="All 2 branches missed.">            if (damage &gt; 0) {</span>
<span class="nc" id="L23511">                hit = nextHit;</span>
                // Need to update armor status for the new location
<span class="nc bnc" id="L23513" title="All 4 branches missed.">                hardenedArmor = ((te instanceof Mech) || (te instanceof Tank))</span>
<span class="nc bnc" id="L23514" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED);</span>
<span class="nc bnc" id="L23515" title="All 6 branches missed.">                ferroLamellorArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23516" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_LAMELLOR);</span>
<span class="nc bnc" id="L23517" title="All 6 branches missed.">                reflectiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23518" title="All 4 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REFLECTIVE))</span>
                        || (isBattleArmor
<span class="nc bnc" id="L23520" title="All 2 branches missed.">                                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REFLECTIVE));</span>
<span class="nc bnc" id="L23521" title="All 6 branches missed.">                reactiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23522" title="All 4 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REACTIVE))</span>
<span class="nc bnc" id="L23523" title="All 2 branches missed.">                        || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REACTIVE));</span>
<span class="nc bnc" id="L23524" title="All 6 branches missed.">                ballisticArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23525" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BALLISTIC_REINFORCED);</span>
<span class="nc bnc" id="L23526" title="All 2 branches missed.">                impactArmor = (te instanceof Mech)</span>
<span class="nc bnc" id="L23527" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_IMPACT_RESISTANT);</span>
            }
<span class="nc bnc" id="L23529" title="All 2 branches missed.">            if (damageIS) {</span>
<span class="nc" id="L23530">                wasDamageIS = true;</span>
<span class="nc" id="L23531">                damageIS = false;</span>
            }
        }
        // Mechs using EI implants take pilot damage each time a hit
        // inflicts IS damage
<span class="nc bnc" id="L23536" title="All 6 branches missed.">        if (tookInternalDamage</span>
            &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))
<span class="nc bnc" id="L23538" title="All 2 branches missed.">            &amp;&amp; te.hasActiveEiCockpit()) {</span>
<span class="nc" id="L23539">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23540">            int roll = Compute.d6(2);</span>
<span class="nc" id="L23541">            r = new Report(5075);</span>
<span class="nc" id="L23542">            r.subject = te.getId();</span>
<span class="nc" id="L23543">            r.addDesc(te);</span>
<span class="nc" id="L23544">            r.add(7);</span>
<span class="nc" id="L23545">            r.add(roll);</span>
<span class="nc bnc" id="L23546" title="All 2 branches missed.">            r.choose(roll &gt;= 7);</span>
<span class="nc" id="L23547">            r.indent(2);</span>
<span class="nc" id="L23548">            vDesc.add(r);</span>
<span class="nc bnc" id="L23549" title="All 2 branches missed.">            if (roll &lt; 7) {</span>
<span class="nc" id="L23550">                vDesc.addAll(damageCrew(te, 1));</span>
            }
        }

        // if using VDNI (but not buffered), check for damage on an internal hit
<span class="nc bnc" id="L23555" title="All 2 branches missed.">        if (tookInternalDamage</span>
<span class="nc bnc" id="L23556" title="All 2 branches missed.">            &amp;&amp; te.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L23557" title="All 2 branches missed.">            &amp;&amp; !te.hasAbility(OptionsConstants.MD_BVDNI)</span>
<span class="nc bnc" id="L23558" title="All 2 branches missed.">            &amp;&amp; !te.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L23559">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23560">            int roll = Compute.d6(2);</span>
<span class="nc" id="L23561">            r = new Report(3580);</span>
<span class="nc" id="L23562">            r.subject = te.getId();</span>
<span class="nc" id="L23563">            r.addDesc(te);</span>
<span class="nc" id="L23564">            r.add(7);</span>
<span class="nc" id="L23565">            r.add(roll);</span>
<span class="nc bnc" id="L23566" title="All 2 branches missed.">            r.choose(roll &gt;= 8);</span>
<span class="nc" id="L23567">            r.indent(2);</span>
<span class="nc" id="L23568">            vDesc.add(r);</span>
<span class="nc bnc" id="L23569" title="All 2 branches missed.">            if (roll &gt;= 8) {</span>
<span class="nc" id="L23570">                vDesc.addAll(damageCrew(te, 1));</span>
            }
        }

        // TacOps p.78 Ammo booms can hurt other units in same and adjacent hexes
        // But, this does not apply to CASE'd units and it only applies if the
        // ammo explosion
        // destroyed the unit
<span class="nc bnc" id="L23578" title="All 4 branches missed.">        if (ammoExplosion &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_AMMUNITION)</span>
            // For 'Mechs we care whether there was CASE specifically in the
            // location that went boom...
<span class="nc bnc" id="L23581" title="All 8 branches missed.">            &amp;&amp; !(te.locationHasCase(hit.getLocation()) || te.hasCASEII(hit.getLocation()))</span>
            // ...but vehicles and ASFs just have one CASE item for the
            // whole unit, so we need to look whether there's CASE anywhere
            // at all.
            &amp;&amp; !(((te instanceof Tank) || (te instanceof Aero)) &amp;&amp; te
<span class="nc bnc" id="L23586" title="All 10 branches missed.">                .hasCase()) &amp;&amp; (te.isDestroyed() || te.isDoomed())</span>
            &amp;&amp; (damage_orig &gt; 0) &amp;&amp; ((damage_orig / 10) &gt; 0)) {
<span class="nc" id="L23588">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23589">            r = new Report(5068, Report.PUBLIC);</span>
<span class="nc" id="L23590">            r.subject = te.getId();</span>
<span class="nc" id="L23591">            r.addDesc(te);</span>
<span class="nc" id="L23592">            r.indent(2);</span>
<span class="nc" id="L23593">            vDesc.add(r);</span>
<span class="nc" id="L23594">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23595">            r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L23596">            r.subject = te.getId();</span>
<span class="nc" id="L23597">            r.indent(2);</span>
<span class="nc" id="L23598">            vDesc.add(r);</span>
<span class="nc" id="L23599">            int[] damages = {(int) Math.floor(damage_orig / 10.0),</span>
<span class="nc" id="L23600">                             (int) Math.floor(damage_orig / 20.0)};</span>
<span class="nc" id="L23601">            doExplosion(damages, false, te.getPosition(), true, vDesc, null, 5,</span>
<span class="nc" id="L23602">                        te.getId(), false);</span>
<span class="nc" id="L23603">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23604">            r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L23605">            r.subject = te.getId();</span>
<span class="nc" id="L23606">            r.indent(2);</span>
<span class="nc" id="L23607">            vDesc.add(r);</span>
        }

        // This flag indicates the hit was directly to IS
<span class="nc bnc" id="L23611" title="All 2 branches missed.">        if (wasDamageIS) {</span>
<span class="nc" id="L23612">            Report.addNewline(vDesc);</span>
        }
<span class="nc" id="L23614">        return vDesc;</span>
    }

    /**
     * Apply damage to an Entity carrying external Battle Armor or ProtoMech
     * when a location with a trooper present is hit.
     *
     * @param te             The carrying Entity
     * @param hit            The hit to resolve
     * @param damage         The amount of damage to be allocated
     * @param vDesc          The report vector
     * @param passenger      The BA squad
     * @return               The amount of damage remaining
     */
    private int damageExternalPassenger(Entity te, HitData hit, int damage, Vector&lt;Report&gt; vDesc,
                                        Entity passenger) {
        Report r;
<span class="nc" id="L23631">        int passengerDamage = damage;</span>
<span class="nc" id="L23632">        int avoidRoll = Compute.d6();</span>
<span class="nc" id="L23633">        HitData passHit = passenger.getTrooperAtLocation(hit, te);</span>
<span class="nc bnc" id="L23634" title="All 2 branches missed.">        if (passenger.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L23635">            passengerDamage -= damage / 2;</span>
<span class="nc" id="L23636">            passHit = passenger.rollHitLocation(ToHitData.HIT_SPECIAL_PROTO, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L23637" title="All 2 branches missed.">        } else if (avoidRoll &lt; 5) {</span>
<span class="nc" id="L23638">            passengerDamage = 0;</span>
        }
<span class="nc" id="L23640">        passHit.setGeneralDamageType(hit.getGeneralDamageType());</span>

<span class="nc bnc" id="L23642" title="All 2 branches missed.">        if (passengerDamage &gt; 0) {</span>
            // Yup. Roll up some hit data for that passenger.
<span class="nc" id="L23644">            r = new Report(6075);</span>
<span class="nc" id="L23645">            r.subject = passenger.getId();</span>
<span class="nc" id="L23646">            r.indent(3);</span>
<span class="nc" id="L23647">            r.addDesc(passenger);</span>
<span class="nc" id="L23648">            vDesc.addElement(r);</span>

            // How much damage will the passenger absorb?
<span class="nc" id="L23651">            int absorb = 0;</span>
<span class="nc" id="L23652">            HitData nextPassHit = passHit;</span>
            do {
<span class="nc" id="L23654">                int armorType = passenger.getArmorType(nextPassHit.getLocation());</span>
<span class="nc" id="L23655">                boolean armorDamageReduction = false;</span>
<span class="nc bnc" id="L23656" title="All 2 branches missed.">                if (((armorType == EquipmentType.T_ARMOR_BA_REACTIVE)</span>
<span class="nc bnc" id="L23657" title="All 2 branches missed.">                        &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE)))</span>
<span class="nc bnc" id="L23658" title="All 2 branches missed.">                        || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE)) {</span>
<span class="nc" id="L23659">                    armorDamageReduction = true;</span>
                }
                // Check for reflective armor
<span class="nc bnc" id="L23662" title="All 2 branches missed.">                if ((armorType == EquipmentType.T_ARMOR_BA_REFLECTIVE)</span>
<span class="nc bnc" id="L23663" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_ENERGY)) {</span>
<span class="nc" id="L23664">                    armorDamageReduction = true;</span>
                }
<span class="nc bnc" id="L23666" title="All 2 branches missed.">                if (0 &lt; passenger.getArmor(nextPassHit)) {</span>
<span class="nc" id="L23667">                    absorb += passenger.getArmor(nextPassHit);</span>
<span class="nc bnc" id="L23668" title="All 2 branches missed.">                    if (armorDamageReduction) {</span>
<span class="nc" id="L23669">                        absorb *= 2;</span>
                    }
                }
<span class="nc bnc" id="L23672" title="All 2 branches missed.">                if (0 &lt; passenger.getInternal(nextPassHit)) {</span>
<span class="nc" id="L23673">                    absorb += passenger.getInternal(nextPassHit);</span>
                    // Armor damage reduction, like for reflective or
                    // reactive armor will divide the whole damage
                    // total by 2 and round down. If we have an odd
                    // damage total, need to add 1 to make this
                    // evenly divisible by 2
<span class="nc bnc" id="L23679" title="All 4 branches missed.">                    if (((absorb % 2) != 0) &amp;&amp; armorDamageReduction) {</span>
<span class="nc" id="L23680">                        absorb++;</span>
                    }
                }
<span class="nc" id="L23683">                nextPassHit = passenger.getTransferLocation(nextPassHit);</span>
<span class="nc bnc" id="L23684" title="All 4 branches missed.">            } while ((damage &gt; absorb) &amp;&amp; (nextPassHit.getLocation() &gt;= 0));</span>

            // Damage the passenger.
<span class="nc" id="L23687">            absorb = Math.min(passengerDamage, absorb);</span>
<span class="nc" id="L23688">            Vector&lt;Report&gt; newReports = damageEntity(passenger, passHit, absorb);</span>
<span class="nc bnc" id="L23689" title="All 2 branches missed.">            for (Report newReport : newReports) {</span>
<span class="nc" id="L23690">                newReport.indent(2);</span>
<span class="nc" id="L23691">            }</span>
<span class="nc" id="L23692">            vDesc.addAll(newReports);</span>

            // Did some damage pass on?
<span class="nc bnc" id="L23695" title="All 2 branches missed.">            if (damage &gt; absorb) {</span>
                // Yup. Remove the absorbed damage.
<span class="nc" id="L23697">                damage -= absorb;</span>
<span class="nc" id="L23698">                r = new Report(6080);</span>
<span class="nc" id="L23699">                r.subject = te.getId();</span>
<span class="nc" id="L23700">                r.indent(2);</span>
<span class="nc" id="L23701">                r.add(damage);</span>
<span class="nc" id="L23702">                r.addDesc(te);</span>
<span class="nc" id="L23703">                vDesc.addElement(r);</span>
            } else {
                // Nope. Return our description.
<span class="nc" id="L23706">                return 0;</span>
            }

<span class="nc" id="L23709">        } else {</span>
            // Report that a passenger that could've been missed
            // narrowly avoids damage
<span class="nc" id="L23712">            r = new Report(6084);</span>
<span class="nc" id="L23713">            r.subject = passenger.getId();</span>
<span class="nc" id="L23714">            r.indent(3);</span>
<span class="nc" id="L23715">            r.addDesc(passenger);</span>
<span class="nc" id="L23716">            vDesc.addElement(r);</span>
        } // End nLoc-has-exterior-passenger
<span class="nc bnc" id="L23718" title="All 4 branches missed.">        if (passenger.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="nc bnc" id="L23719" title="All 4 branches missed.">                &amp;&amp; (passengerDamage &gt; 0) &amp;&amp; !passenger.isDoomed() &amp;&amp; !passenger.isDestroyed()) {</span>
<span class="nc" id="L23720">            r = new Report(3850);</span>
<span class="nc" id="L23721">            r.subject = passenger.getId();</span>
<span class="nc" id="L23722">            r.indent(3);</span>
<span class="nc" id="L23723">            r.addDesc(passenger);</span>
<span class="nc" id="L23724">            vDesc.addElement(r);</span>
<span class="nc" id="L23725">            int facing = te.getFacing();</span>
            // We're going to assume that it's mounted facing the mech
<span class="nc" id="L23727">            Coords position = te.getPosition();</span>
<span class="nc bnc" id="L23728" title="All 2 branches missed.">            if (!hit.isRear()) {</span>
<span class="nc" id="L23729">                facing = (facing + 3) % 6;</span>
            }
<span class="nc" id="L23731">            unloadUnit(te, passenger, position, facing, te.getElevation(), false, false);</span>
<span class="nc" id="L23732">            Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L23733">                    passenger.getId(), position);</span>
<span class="nc bnc" id="L23734" title="All 2 branches missed.">            if (violation != null) {</span>
<span class="nc" id="L23735">                Coords targetDest = Compute.getValidDisplacement(game, passenger.getId(), position,</span>
<span class="nc" id="L23736">                        Compute.d6() - 1);</span>
<span class="nc" id="L23737">                addReport(doEntityDisplacement(violation, position, targetDest, null));</span>
                // Update the violating entity's position on the client.
<span class="nc" id="L23739">                entityUpdate(violation.getId());</span>
            }
        }
<span class="nc" id="L23742">        return damage;</span>
    }

    /**
     * Check to see if the entity's engine explodes. Rules for ICE explosions
     * are different to fusion engines.
     *
     * @param en    - the &lt;code&gt;Entity&lt;/code&gt; in question. This value must not be
     *              &lt;code&gt;null&lt;/code&gt;.
     * @param vDesc - the &lt;code&gt;Vector&lt;/code&gt; that this function should add its
     *              &lt;code&gt;Report&lt;code&gt;s to.  It may be empty, but not
     *              &lt;code&gt;null&lt;/code&gt;.
     * @param hits  - the number of criticals on the engine
     * @return &lt;code&gt;true&lt;/code&gt; if the unit's engine exploded,
     * &lt;code&gt;false&lt;/code&gt; if not.
     */
    private boolean checkEngineExplosion(Entity en, Vector&lt;Report&gt; vDesc, int hits) {
<span class="nc bnc" id="L23759" title="All 6 branches missed.">        if (!(en instanceof Mech) &amp;&amp; !(en instanceof Aero) &amp;&amp; !(en instanceof Tank)) {</span>
<span class="nc" id="L23760">            return false;</span>
        }
        // If this method gets called for an entity that's already destroyed or
        // that hasn't taken any actual engine hits this phase yet, do nothing.
<span class="nc bnc" id="L23764" title="All 4 branches missed.">        if (en.isDestroyed() || (en.engineHitsThisPhase &lt;= 0)</span>
<span class="nc bnc" id="L23765" title="All 4 branches missed.">                || en.getSelfDestructedThisTurn() || !en.hasEngine()) {</span>
<span class="nc" id="L23766">            return false;</span>
        }
<span class="nc" id="L23768">        int explosionBTH = 10;</span>
<span class="nc" id="L23769">        int hitsPerRound = 4;</span>
<span class="nc" id="L23770">        Engine engine = en.getEngine();</span>

<span class="nc bnc" id="L23772" title="All 2 branches missed.">        if(en instanceof Tank) {</span>
<span class="nc" id="L23773">            explosionBTH = 12;</span>
<span class="nc" id="L23774">            hitsPerRound = 1;</span>
<span class="nc bnc" id="L23775" title="All 2 branches missed.">        } else if(!(en instanceof Mech)) {</span>
<span class="nc" id="L23776">            explosionBTH = 12;</span>
<span class="nc" id="L23777">            hitsPerRound = 1;</span>
        }

        // Non mechs and mechs that already rolled are safe
<span class="nc bnc" id="L23781" title="All 4 branches missed.">        if (en.rolledForEngineExplosion || !(en instanceof Mech)) {</span>
<span class="nc" id="L23782">            return false;</span>
        }
        // ICE can always explode and roll every time hit
<span class="nc bnc" id="L23785" title="All 2 branches missed.">        if (engine.isFusion()</span>
<span class="nc bnc" id="L23786" title="All 4 branches missed.">                &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_ENGINE_EXPLOSIONS)</span>
                        || (en.engineHitsThisPhase &lt; hitsPerRound))) {
<span class="nc" id="L23788">            return false;</span>
        }
<span class="nc bnc" id="L23790" title="All 2 branches missed.">        if (!engine.isFusion()) {</span>
<span class="nc bnc" id="L23791" title="All 4 branches missed.">            switch (hits) {</span>
                case 0:
<span class="nc" id="L23793">                    return false;</span>
                case 1:
<span class="nc" id="L23795">                    explosionBTH = 10;</span>
<span class="nc" id="L23796">                    break;</span>
                case 2:
<span class="nc" id="L23798">                    explosionBTH = 7;</span>
<span class="nc" id="L23799">                    break;</span>
                case 3:
                default:
<span class="nc" id="L23802">                    explosionBTH = 4;</span>
                    break;
            }
        }
<span class="nc" id="L23806">        int explosionRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L23807" title="All 2 branches missed.">        boolean didExplode = explosionRoll &gt;= explosionBTH;</span>

        Report r;
<span class="nc" id="L23810">        r = new Report(6150);</span>
<span class="nc" id="L23811">        r.subject = en.getId();</span>
<span class="nc" id="L23812">        r.indent(2);</span>
<span class="nc" id="L23813">        r.addDesc(en);</span>
<span class="nc" id="L23814">        r.add(en.engineHitsThisPhase);</span>
<span class="nc" id="L23815">        vDesc.addElement(r);</span>
<span class="nc" id="L23816">        r = new Report(6155);</span>
<span class="nc" id="L23817">        r.subject = en.getId();</span>
<span class="nc" id="L23818">        r.indent(2);</span>
<span class="nc" id="L23819">        r.add(explosionBTH);</span>
<span class="nc" id="L23820">        r.add(explosionRoll);</span>
<span class="nc" id="L23821">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L23823" title="All 2 branches missed.">        if (!didExplode) {</span>
            // whew!
<span class="nc bnc" id="L23825" title="All 2 branches missed.">            if (engine.isFusion()) {</span>
<span class="nc" id="L23826">                en.rolledForEngineExplosion = true;</span>
            }
            // fusion engines only roll 1/phase but ICE roll every time damaged
<span class="nc" id="L23829">            r = new Report(6160);</span>
<span class="nc" id="L23830">            r.subject = en.getId();</span>
<span class="nc" id="L23831">            r.indent(2);</span>
<span class="nc" id="L23832">            vDesc.addElement(r);</span>
        } else {
<span class="nc" id="L23834">            en.rolledForEngineExplosion = true;</span>
<span class="nc" id="L23835">            r = new Report(6165, Report.PUBLIC);</span>
<span class="nc" id="L23836">            r.subject = en.getId();</span>
<span class="nc" id="L23837">            r.indent(2);</span>
<span class="nc" id="L23838">            vDesc.addElement(r);</span>
<span class="nc" id="L23839">            vDesc.addAll(destroyEntity(en, &quot;engine explosion&quot;, false, false));</span>
            // kill the crew
<span class="nc" id="L23841">            en.getCrew().setDoomed(true);</span>

            // This is a hack so MM.NET marks the mech as not salvageable
<span class="nc" id="L23844">            en.destroyLocation(Mech.LOC_CT);</span>

            // ICE explosions don't hurt anyone else, but fusion do
<span class="nc bnc" id="L23847" title="All 2 branches missed.">            if (engine.isFusion()) {</span>
<span class="nc" id="L23848">                int engineRating = en.getEngine().getRating();</span>
<span class="nc" id="L23849">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23850">                r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L23851">                r.subject = en.getId();</span>
<span class="nc" id="L23852">                r.indent(2);</span>
<span class="nc" id="L23853">                vDesc.add(r);</span>

<span class="nc" id="L23855">                Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L23856" title="All 4 branches missed.">                if (mech.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(</span>
                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23858" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(</span>
                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23860" title="All 2 branches missed.">                        &amp;&amp; mech.isCondEjectEngine()))) {</span>
<span class="nc" id="L23861">                    vDesc.addAll(ejectEntity(en, true));</span>
                }

<span class="nc" id="L23864">                doFusionEngineExplosion(engineRating, en.getPosition(), vDesc, null);</span>
<span class="nc" id="L23865">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23866">                r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L23867">                r.subject = en.getId();</span>
<span class="nc" id="L23868">                r.indent(2);</span>
<span class="nc" id="L23869">                vDesc.add(r);</span>

            }
        }

<span class="nc" id="L23874">        return didExplode;</span>
    }

    /**
     * Extract explosion functionality for generalized explosions in areas.
     */
    public void doFusionEngineExplosion(int engineRating, Coords position, Vector&lt;Report&gt; vDesc,
                                        Vector&lt;Integer&gt; vUnits) {
<span class="nc" id="L23882">        int[] myDamages = { engineRating, (engineRating / 10), (engineRating / 20),</span>
                (engineRating / 40) };
<span class="nc" id="L23884">        doExplosion(myDamages, true, position, false, vDesc, vUnits, 5, -1, true);</span>
<span class="nc" id="L23885">    }</span>

    /**
     * General function to cause explosions in areas.
     */
    public void doExplosion(int damage, int degradation, boolean autoDestroyInSameHex,
                            Coords position, boolean allowShelter, Vector&lt;Report&gt; vDesc,
                            Vector&lt;Integer&gt; vUnits, int excludedUnitId) {
<span class="nc bnc" id="L23893" title="All 2 branches missed.">        if (degradation &lt; 1) {</span>
<span class="nc" id="L23894">            return;</span>
        }

<span class="nc" id="L23897">        int[] myDamages = new int[damage / degradation];</span>

<span class="nc bnc" id="L23899" title="All 2 branches missed.">        if (myDamages.length &lt; 1) {</span>
<span class="nc" id="L23900">            return;</span>
        }

<span class="nc" id="L23903">        myDamages[0] = damage;</span>
<span class="nc bnc" id="L23904" title="All 2 branches missed.">        for (int x = 1; x &lt; myDamages.length; x++) {</span>
<span class="nc" id="L23905">            myDamages[x] = myDamages[x - 1] - degradation;</span>
        }
<span class="nc" id="L23907">        doExplosion(myDamages, autoDestroyInSameHex, position, allowShelter, vDesc, vUnits,</span>
                5, excludedUnitId, false);
<span class="nc" id="L23909">    }</span>

    /**
     * General function to cause explosions in areas.
     */
    public void doExplosion(int[] damages, boolean autoDestroyInSameHex, Coords position,
                            boolean allowShelter, Vector&lt;Report&gt; vDesc, Vector&lt;Integer&gt; vUnits,
                            int clusterAmt, int excludedUnitId, boolean engineExplosion) {
<span class="nc bnc" id="L23917" title="All 2 branches missed.">        if (vDesc == null) {</span>
<span class="nc" id="L23918">            vDesc = new Vector&lt;&gt;();</span>
        }

<span class="nc bnc" id="L23921" title="All 2 branches missed.">        if (vUnits == null) {</span>
<span class="nc" id="L23922">            vUnits = new Vector&lt;&gt;();</span>
        }

        Report r;
<span class="nc" id="L23926">        HashSet&lt;Entity&gt; entitiesHit = new HashSet&lt;&gt;();</span>

        // We need to damage buildings.
<span class="nc" id="L23929">        Enumeration&lt;Building&gt; buildings = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L23930" title="All 2 branches missed.">        while (buildings.hasMoreElements()) {</span>
<span class="nc" id="L23931">            final Building bldg = buildings.nextElement();</span>

            // Lets find the closest hex from the building.
<span class="nc" id="L23934">            Enumeration&lt;Coords&gt; hexes = bldg.getCoords();</span>

<span class="nc bnc" id="L23936" title="All 2 branches missed.">            while (hexes.hasMoreElements()) {</span>
<span class="nc" id="L23937">                final Coords coords = hexes.nextElement();</span>
<span class="nc" id="L23938">                int dist = position.distance(coords);</span>
<span class="nc bnc" id="L23939" title="All 2 branches missed.">                if (dist &lt; damages.length) {</span>
<span class="nc" id="L23940">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damages[dist], coords);</span>
<span class="nc bnc" id="L23941" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L23942">                        report.type = Report.PUBLIC;</span>
<span class="nc" id="L23943">                    }</span>
<span class="nc" id="L23944">                    vDesc.addAll(buildingReport);</span>
                }
<span class="nc" id="L23946">            }</span>
<span class="nc" id="L23947">        }</span>

        // We need to damage terrain
<span class="nc" id="L23950">        int maxDist = damages.length;</span>
<span class="nc" id="L23951">        IHex hex = game.getBoard().getHex(position);</span>
        // Center hex starts on fire for engine explosions
<span class="nc bnc" id="L23953" title="All 6 branches missed.">        if (engineExplosion &amp;&amp; (hex != null) &amp;&amp; !hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L23954">            r = new Report(5136);</span>
<span class="nc" id="L23955">            r.indent(2);</span>
<span class="nc" id="L23956">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L23957">            r.add(position.getBoardNum());</span>
<span class="nc" id="L23958">            vDesc.add(r);</span>
<span class="nc" id="L23959">            Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
<span class="nc" id="L23960">            ignite(position, Terrains.FIRE_LVL_NORMAL, reports);</span>
<span class="nc bnc" id="L23961" title="All 2 branches missed.">            for (Report report : reports) {</span>
<span class="nc" id="L23962">                report.indent();</span>
<span class="nc" id="L23963">            }</span>
<span class="nc" id="L23964">            vDesc.addAll(reports);</span>
        }
<span class="nc bnc" id="L23966" title="All 4 branches missed.">        if ((hex != null) &amp;&amp; hex.hasTerrainfactor()) {</span>
<span class="nc" id="L23967">            r = new Report(3384);</span>
<span class="nc" id="L23968">            r.indent(2);</span>
<span class="nc" id="L23969">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L23970">            r.add(position.getBoardNum());</span>
<span class="nc" id="L23971">            r.add(damages[0]);</span>
<span class="nc" id="L23972">            vDesc.add(r);</span>
        }
<span class="nc" id="L23974">        Vector&lt;Report&gt; reports = tryClearHex(position, damages[0], Entity.NONE);</span>
<span class="nc bnc" id="L23975" title="All 2 branches missed.">        for (Report report : reports) {</span>
<span class="nc" id="L23976">            report.indent(3);</span>
<span class="nc" id="L23977">        }</span>
<span class="nc" id="L23978">        vDesc.addAll(reports);</span>

        // Handle surrounding coords
<span class="nc bnc" id="L23981" title="All 2 branches missed.">        for (int dist = 1; dist &lt; maxDist; dist++) {</span>
<span class="nc" id="L23982">            List&lt;Coords&gt; coords = position.allAtDistance(dist);</span>
<span class="nc bnc" id="L23983" title="All 2 branches missed.">            for (Coords c : coords) {</span>
<span class="nc" id="L23984">                hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L23985" title="All 4 branches missed.">                if ((hex != null) &amp;&amp; hex.hasTerrainfactor()) {</span>
<span class="nc" id="L23986">                    r = new Report(3384);</span>
<span class="nc" id="L23987">                    r.indent(2);</span>
<span class="nc" id="L23988">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L23989">                    r.add(c.getBoardNum());</span>
<span class="nc" id="L23990">                    r.add(damages[dist]);</span>
<span class="nc" id="L23991">                    vDesc.add(r);</span>
                }
<span class="nc" id="L23993">                reports = tryClearHex(c, damages[dist], Entity.NONE);</span>
<span class="nc bnc" id="L23994" title="All 2 branches missed.">                for (Report report : reports) {</span>
<span class="nc" id="L23995">                    report.indent(3);</span>
<span class="nc" id="L23996">                }</span>
<span class="nc" id="L23997">                vDesc.addAll(reports);</span>
<span class="nc" id="L23998">            }</span>
        }

        // Now we damage people near the explosion.
<span class="nc" id="L24002">        List&lt;Entity&gt; loaded = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L24003" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; ents = game.getEntities(); ents.hasNext();) {</span>
<span class="nc" id="L24004">            Entity entity = ents.next();</span>

<span class="nc bnc" id="L24006" title="All 2 branches missed.">            if (entitiesHit.contains(entity)) {</span>
<span class="nc" id="L24007">                continue;</span>
            }

<span class="nc bnc" id="L24010" title="All 2 branches missed.">            if (entity.getId() == excludedUnitId) {</span>
<span class="nc" id="L24011">                continue;</span>
            }

<span class="nc bnc" id="L24014" title="All 4 branches missed.">            if (entity.isDestroyed() || !entity.isDeployed()) {</span>
                // FIXME
                // IS this the behavior we want?
                // This means, incidentally, that salvage is never affected by
                // explosions
                // as long as it was destroyed before the explosion.
<span class="nc" id="L24020">                continue;</span>
            }

            // We are going to assume that explosions are on the ground here so
            // flying entities should be unaffected
<span class="nc bnc" id="L24025" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L24026">                continue;</span>
            }

<span class="nc bnc" id="L24029" title="All 4 branches missed.">            if ((entity instanceof MechWarrior) &amp;&amp; !((MechWarrior) entity).hasLanded()) {</span>
                // MechWarrior is still up in the air ejecting hence safe
                // from this explosion.
<span class="nc" id="L24032">                continue;</span>
            }

<span class="nc" id="L24035">            Coords entityPos = entity.getPosition();</span>
<span class="nc bnc" id="L24036" title="All 2 branches missed.">            if (entityPos == null) {</span>
                // maybe its loaded?
<span class="nc" id="L24038">                Entity transport = game.getEntity(entity.getTransportId());</span>
<span class="nc bnc" id="L24039" title="All 4 branches missed.">                if ((transport != null) &amp;&amp; !transport.isAirborne()) {</span>
<span class="nc" id="L24040">                    loaded.add(entity);</span>
                }
                continue;
            }
<span class="nc" id="L24044">            int range = position.distance(entityPos);</span>

<span class="nc bnc" id="L24046" title="All 2 branches missed.">            if (range &gt;= damages.length) {</span>
                // Yeah, this is fine. It's outside the blast radius.
<span class="nc" id="L24048">                continue;</span>
            }

            // We might need to nuke everyone in the explosion hex. If so...
<span class="nc bnc" id="L24052" title="All 4 branches missed.">            if ((range == 0) &amp;&amp; autoDestroyInSameHex) {</span>
                // Add the reports
<span class="nc" id="L24054">                vDesc.addAll(destroyEntity(entity, &quot;explosion proximity&quot;, false, false));</span>
                // Add it to the &quot;blasted units&quot; list
<span class="nc" id="L24056">                vUnits.add(entity.getId());</span>
                // Kill the crew
<span class="nc" id="L24058">                entity.getCrew().setDoomed(true);</span>

<span class="nc" id="L24060">                entitiesHit.add(entity);</span>
<span class="nc" id="L24061">                continue;</span>
            }

<span class="nc" id="L24064">            int damage = damages[range];</span>

<span class="nc bnc" id="L24066" title="All 4 branches missed.">            if (allowShelter &amp;&amp; canShelter(entityPos, position, entity.relHeight())) {</span>
<span class="nc bnc" id="L24067" title="All 2 branches missed.">                if (isSheltered()) {</span>
<span class="nc" id="L24068">                    r = new Report(6545);</span>
<span class="nc" id="L24069">                    r.addDesc(entity);</span>
<span class="nc" id="L24070">                    r.subject = entity.getId();</span>
<span class="nc" id="L24071">                    vDesc.addElement(r);</span>
<span class="nc" id="L24072">                    continue;</span>
                }
                // If shelter is allowed but didn't work, report that.
<span class="nc" id="L24075">                r = new Report(6546);</span>
<span class="nc" id="L24076">                r.subject = entity.getId();</span>
<span class="nc" id="L24077">                r.addDesc(entity);</span>
<span class="nc" id="L24078">                vDesc.addElement(r);</span>
            }

            // Since it's taking damage, add it to the list of units hit.
<span class="nc" id="L24082">            vUnits.add(entity.getId());</span>

<span class="nc" id="L24084">            AreaEffectHelper.applyExplosionClusterDamageToEntity(entity, damage, clusterAmt, position, vDesc, this);</span>
            
<span class="nc" id="L24086">            Report.addNewline(vDesc);</span>
<span class="nc" id="L24087">        }</span>

        // now deal with loaded units...
<span class="nc bnc" id="L24090" title="All 2 branches missed.">        for (Entity e : loaded) {</span>
            // This can be null, if the transport died from damage
<span class="nc" id="L24092">            final Entity transporter = game.getEntity(e.getTransportId());</span>
<span class="nc bnc" id="L24093" title="All 4 branches missed.">            if ((transporter == null) || transporter.getExternalUnits().contains(e)) {</span>
                // Its external or transport was destroyed - hit it.
<span class="nc bnc" id="L24095" title="All 2 branches missed.">                final Coords entityPos = (transporter == null ? e.getPosition()</span>
<span class="nc" id="L24096">                        : transporter.getPosition());</span>
<span class="nc" id="L24097">                final int range = position.distance(entityPos);</span>

<span class="nc bnc" id="L24099" title="All 2 branches missed.">                if (range &gt;= damages.length) {</span>
                    // Yeah, this is fine. It's outside the blast radius.
<span class="nc" id="L24101">                    continue;</span>
                }

<span class="nc" id="L24104">                int damage = damages[range];</span>
<span class="nc bnc" id="L24105" title="All 2 branches missed.">                if (allowShelter) {</span>
<span class="nc bnc" id="L24106" title="All 2 branches missed.">                    final int absHeight = (transporter == null ? e.relHeight()</span>
<span class="nc" id="L24107">                            : transporter.relHeight());</span>
<span class="nc bnc" id="L24108" title="All 2 branches missed.">                    if (canShelter(entityPos, position, absHeight)) {</span>
<span class="nc bnc" id="L24109" title="All 2 branches missed.">                        if (isSheltered()) {</span>
<span class="nc" id="L24110">                            r = new Report(6545);</span>
<span class="nc" id="L24111">                            r.addDesc(e);</span>
<span class="nc" id="L24112">                            r.subject = e.getId();</span>
<span class="nc" id="L24113">                            vDesc.addElement(r);</span>
<span class="nc" id="L24114">                            continue;</span>
                        }
                        // If shelter is allowed but didn't work, report that.
<span class="nc" id="L24117">                        r = new Report(6546);</span>
<span class="nc" id="L24118">                        r.subject = e.getId();</span>
<span class="nc" id="L24119">                        r.addDesc(e);</span>
<span class="nc" id="L24120">                        vDesc.addElement(r);</span>
                    }
                }
                // No shelter
                // Since it's taking damage, add it to the list of units hit.
<span class="nc" id="L24125">                vUnits.add(e.getId());</span>

<span class="nc" id="L24127">                r = new Report(6175);</span>
<span class="nc" id="L24128">                r.subject = e.getId();</span>
<span class="nc" id="L24129">                r.indent(2);</span>
<span class="nc" id="L24130">                r.addDesc(e);</span>
<span class="nc" id="L24131">                r.add(damage);</span>
<span class="nc" id="L24132">                vDesc.addElement(r);</span>

<span class="nc bnc" id="L24134" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L24135">                    int cluster = Math.min(5, damage);</span>
<span class="nc" id="L24136">                    int table = ToHitData.HIT_NORMAL;</span>
<span class="nc bnc" id="L24137" title="All 2 branches missed.">                    if (e instanceof Protomech) {</span>
<span class="nc" id="L24138">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
                    }
<span class="nc" id="L24140">                    HitData hit = e.rollHitLocation(table, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L24141">                    vDesc.addAll(damageEntity(e, hit, cluster, false,</span>
                            DamageType.IGNORE_PASSENGER, false, true));
<span class="nc" id="L24143">                    damage -= cluster;</span>
<span class="nc" id="L24144">                }</span>
<span class="nc" id="L24145">                Report.addNewline(vDesc);</span>
            }
<span class="nc" id="L24147">        }</span>
<span class="nc" id="L24148">    }</span>

    /**
     * Check if an Entity of the passed height can find shelter from a nuke blast
     *
     * @param entityPosition  the &lt;code&gt;Coords&lt;/code&gt; the Entity is at
     * @param position        the &lt;code&gt;Coords&lt;/code&gt; of the explosion
     * @param entityAbsHeight the &lt;code&gt;int&lt;/code&gt; height of the entity
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating if the entity of the
     * given height can find shelter
     */
    public boolean canShelter(Coords entityPosition, Coords position, int entityAbsHeight) {
        // What is the next hex in the direction of the blast?
<span class="nc" id="L24161">        Coords shelteringCoords = Coords.nextHex(entityPosition, position);</span>
<span class="nc" id="L24162">        IHex shelteringHex = game.getBoard().getHex(shelteringCoords);</span>

        // This is an error condition. It really shouldn't ever happen.
<span class="nc bnc" id="L24165" title="All 2 branches missed.">        if (shelteringHex == null) {</span>
<span class="nc" id="L24166">            return false;</span>
        }

        // Now figure out the height to which that hex will provide shelter.
        // It's worth noting, this assumes that any building in the hex has
        // already survived the bomb blast. In the case where a building
        // won't survive the blast but hasn't actually taken the damage
        // yet, this will be wrong.
<span class="nc" id="L24174">        int shelterLevel = shelteringHex.floor();</span>
<span class="nc bnc" id="L24175" title="All 2 branches missed.">        if (shelteringHex.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L24176">            shelterLevel = shelteringHex.ceiling();</span>
        }

        // Get the absolute height of the unit relative to level 0.
<span class="nc" id="L24180">        entityAbsHeight += game.getBoard().getHex(entityPosition).surface();</span>

        // Now find the height that needs to be sheltered, and compare.
<span class="nc bnc" id="L24183" title="All 2 branches missed.">        return entityAbsHeight &lt; shelterLevel;</span>
    }

    /**
     * @return true if the unit succeeds a shelter roll
     */
    private boolean isSheltered() {
<span class="nc bnc" id="L24190" title="All 2 branches missed.">        return Compute.d6(2) &gt;= 9;</span>
    }

    /**
     * add a nuke to be exploded in the next weapons attack phase
     *
     * @param nuke this is an int[] with i=0 and i=1 being X and Y coordinates respectively,
     *             If the input array is length 3, then i=2 is NukeType (from HS:3070)
     *             If the input array is length 6, then i=2 is the base damage dealt,
     *             i=3 is the degradation, i=4 is the secondary radius, and i=5 is the crater depth
     */
    public void addScheduledNuke(int[] nuke) {
<span class="nc" id="L24202">        scheduledNukes.add(nuke);</span>
<span class="nc" id="L24203">    }</span>

    /**
     * explode any scheduled nukes
     */
    private void resolveScheduledNukes() {
<span class="nc bnc" id="L24209" title="All 2 branches missed.">        for (int[] nuke : scheduledNukes) {</span>
<span class="nc bnc" id="L24210" title="All 2 branches missed.">            if (nuke.length == 3) {</span>
<span class="nc" id="L24211">                doNuclearExplosion(new Coords(nuke[0] - 1, nuke[1] - 1), nuke[2],</span>
                        vPhaseReport);
            }
<span class="nc bnc" id="L24214" title="All 2 branches missed.">            if (nuke.length == 6) {</span>
<span class="nc" id="L24215">                doNuclearExplosion(new Coords(nuke[0] - 1, nuke[1] - 1), nuke[2], nuke[3],</span>
                        nuke[4], nuke[5], vPhaseReport);
            }
<span class="nc" id="L24218">        }</span>
<span class="nc" id="L24219">        scheduledNukes.clear();</span>
<span class="nc" id="L24220">    }</span>

    /**
     * do a nuclear explosion
     *
     * @param position the position that will be hit by the nuke
     * @param nukeType the type of nuke
     * @param vDesc    a vector that contains the output report
     */
    public void doNuclearExplosion(Coords position, int nukeType, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L24230">        NukeStats nukeStats = AreaEffectHelper.getNukeStats(nukeType);</span>
        
<span class="nc bnc" id="L24232" title="All 2 branches missed.">        if(nukeStats == null) {</span>
<span class="nc" id="L24233">            MegaMek.getLogger().error(&quot;Illegal nuke not listed in HS:3070&quot;);</span>
        }
        
<span class="nc" id="L24236">        doNuclearExplosion(position, nukeStats.baseDamage, nukeStats.degradation, nukeStats.secondaryRadius,</span>
                nukeStats.craterDepth, vDesc);        
<span class="nc" id="L24238">    }</span>

    /**
     * explode a nuke
     *
     * @param position          the position that will be hit by the nuke
     * @param baseDamage        the base damage from the blast
     * @param degradation       how fast the blast's power degrades
     * @param secondaryRadius   the secondary blast radius
     * @param craterDepth       the depth of the crater created by the blast
     * @param vDesc             a vector that contains the output report
     */
    public void doNuclearExplosion(Coords position, int baseDamage, int degradation,
                                   int secondaryRadius, int craterDepth, Vector&lt;Report&gt; vDesc) {
        // Just in case.
<span class="nc bnc" id="L24253" title="All 2 branches missed.">        if (vDesc == null) {</span>
<span class="nc" id="L24254">            vDesc = new Vector&lt;&gt;();</span>
        }

        // First, crater the terrain.
        // All terrain, units, buildings... EVERYTHING in here is just gone.
        // Gotta love nukes.
<span class="nc" id="L24260">        Report r = new Report(1215, Report.PUBLIC);</span>

<span class="nc" id="L24262">        r.indent();</span>
<span class="nc" id="L24263">        r.add(position.getBoardNum(), true);</span>
<span class="nc" id="L24264">        vDesc.add(r);</span>

<span class="nc" id="L24266">        int curDepth = craterDepth;</span>
<span class="nc" id="L24267">        int range = 0;</span>
<span class="nc bnc" id="L24268" title="All 2 branches missed.">        while (range &lt; (2 * craterDepth)) {</span>
            // Get the set of hexes at this range.
<span class="nc" id="L24270">            List&lt;Coords&gt; hexSet = position.allAtDistance(range);</span>

            // Iterate through the hexes.
<span class="nc bnc" id="L24273" title="All 2 branches missed.">            for (Coords myHexCoords: hexSet) {</span>
                // ignore out of bounds coordinates
<span class="nc bnc" id="L24275" title="All 2 branches missed.">                if (!game.getBoard().contains(myHexCoords)) {</span>
<span class="nc" id="L24276">                    continue;</span>
                }
                
<span class="nc" id="L24279">                IHex myHex = game.getBoard().getHex(myHexCoords);</span>
                // In each hex, first, sink the terrain if necessary.
<span class="nc" id="L24281">                myHex.setLevel((myHex.getLevel() - curDepth));</span>

                // Then, remove ANY terrains here.
                // I mean ALL of them; they're all just gone.
                // No ruins, no water, no rough, no nothing.
<span class="nc bnc" id="L24286" title="All 2 branches missed.">                if (myHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L24287">                    myHex.setLevel(myHex.floor());</span>
                }
<span class="nc" id="L24289">                myHex.removeAllTerrains();</span>
<span class="nc" id="L24290">                myHex.clearExits();</span>

<span class="nc" id="L24292">                sendChangedHex(myHexCoords);</span>
<span class="nc" id="L24293">            }</span>

            // Lastly, if the next distance is a multiple of 2...
            // The crater depth goes down one.
<span class="nc bnc" id="L24297" title="All 4 branches missed.">            if ((range &gt; 0) &amp;&amp; ((range % 2) == 0)) {</span>
<span class="nc" id="L24298">                curDepth--;</span>
            }

            // Now that the hexes are dealt with, increment the distance.
<span class="nc" id="L24302">            range++;</span>
<span class="nc" id="L24303">        }</span>

        // This is technically part of cratering, but...
        // Now we destroy all the units inside the cratering range.
<span class="nc bnc" id="L24307" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // loaded units and off board units don't have a position,
            // so we don't count 'em here
<span class="nc bnc" id="L24310" title="All 4 branches missed.">            if ((entity.getTransportId() != Entity.NONE) || (entity.getPosition() == null)) {</span>
<span class="nc" id="L24311">                continue;</span>
            }

            // If it's too far away for this...
<span class="nc bnc" id="L24315" title="All 2 branches missed.">            if (position.distance(entity.getPosition()) &gt;= range) {</span>
<span class="nc" id="L24316">                continue;</span>
            }

            // If it's already destroyed...
<span class="nc bnc" id="L24320" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc" id="L24321">                continue;</span>
            }

<span class="nc" id="L24324">            vDesc.addAll(destroyEntity(entity, &quot;nuclear explosion proximity&quot;,</span>
                    false, false));
            // Kill the crew
<span class="nc" id="L24327">            entity.getCrew().setDoomed(true);</span>
<span class="nc" id="L24328">        }</span>

        // Then, do actual blast damage.
        // Use the standard blast function for this.
<span class="nc" id="L24332">        Vector&lt;Report&gt; tmpV = new Vector&lt;&gt;();</span>
<span class="nc" id="L24333">        Vector&lt;Integer&gt; blastedUnitsVec = new Vector&lt;&gt;();</span>
<span class="nc" id="L24334">        doExplosion(baseDamage, degradation, true, position, true, tmpV,</span>
                    blastedUnitsVec, -1);
<span class="nc" id="L24336">        Report.indentAll(tmpV, 2);</span>
<span class="nc" id="L24337">        vDesc.addAll(tmpV);</span>

        // Everything that was blasted by the explosion has to make a piloting
        // check at +6.
<span class="nc bnc" id="L24341" title="All 2 branches missed.">        for (int i : blastedUnitsVec) {</span>
<span class="nc" id="L24342">            Entity o = game.getEntity(i);</span>
<span class="nc bnc" id="L24343" title="All 2 branches missed.">            if (o.canFall()) {</span>
                // Needs a piloting check at +6 to avoid falling over.
<span class="nc" id="L24345">                game.addPSR(new PilotingRollData(o.getId(), 6,</span>
                        &quot;hit by nuclear blast&quot;));
<span class="nc bnc" id="L24347" title="All 2 branches missed.">            } else if (o instanceof VTOL) {</span>
                // Needs a piloting check at +6 to avoid crashing.
                // Wheeeeee!
<span class="nc" id="L24350">                VTOL vt = (VTOL) o;</span>

                // Check only applies if it's in the air.
                // FIXME: is this actually correct? What about
                // buildings/bridges?
<span class="nc bnc" id="L24355" title="All 2 branches missed.">                if (vt.getElevation() &gt; 0) {</span>
<span class="nc" id="L24356">                    game.addPSR(new PilotingRollData(vt.getId(), 6,</span>
                                                     &quot;hit by nuclear blast&quot;));
                }
<span class="nc bnc" id="L24359" title="All 2 branches missed.">            } else if (o instanceof Tank) {</span>
                // As per official answer on the rules questions board...
                // Needs a piloting check at +6 to avoid a 1-level fall...
                // But ONLY if a hover-tank.
                // TODO : Fix me
            }
<span class="nc" id="L24365">        }</span>

        // This ISN'T part of the blast, but if there's ANYTHING in the ground
        // zero hex, destroy it.
<span class="nc" id="L24369">        Building tmpB = game.getBoard().getBuildingAt(position);</span>
<span class="nc bnc" id="L24370" title="All 2 branches missed.">        if (tmpB != null) {</span>
<span class="nc" id="L24371">            r = new Report(2415);</span>
<span class="nc" id="L24372">            r.add(tmpB.getName());</span>
<span class="nc" id="L24373">            addReport(r);</span>
<span class="nc" id="L24374">            tmpB.setCurrentCF(0, position);</span>
        }
<span class="nc" id="L24376">        IHex gzHex = game.getBoard().getHex(position);</span>
<span class="nc bnc" id="L24377" title="All 2 branches missed.">        if (gzHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L24378">            gzHex.setLevel(gzHex.floor());</span>
        }
<span class="nc" id="L24380">        gzHex.removeAllTerrains();</span>

        // Next, for whatever's left, do terrain effects
        // such as clearing, roughing, and boiling off water.
<span class="nc" id="L24384">        boolean damageFlag = true;</span>
<span class="nc" id="L24385">        int damageAtRange = baseDamage - (degradation * range);</span>
<span class="nc bnc" id="L24386" title="All 2 branches missed.">        if (damageAtRange &gt; 0) {</span>
<span class="nc bnc" id="L24387" title="All 2 branches missed.">            for (int x = range; damageFlag; x++) {</span>
                // Damage terrain as necessary.
                // Get all the hexes, and then iterate through them.
<span class="nc" id="L24390">                List&lt;Coords&gt; hexSet = position.allAtDistance(x);</span>

                // Iterate through the hexes.
<span class="nc bnc" id="L24393" title="All 2 branches missed.">                for (Coords myHexCoords : hexSet) {</span>
                    // ignore out of bounds coordinates
<span class="nc bnc" id="L24395" title="All 2 branches missed.">                    if (!game.getBoard().contains(myHexCoords)) {</span>
<span class="nc" id="L24396">                        continue;</span>
                    }
                    
<span class="nc" id="L24399">                    IHex myHex = game.getBoard().getHex(myHexCoords);</span>

                    // For each 3000 damage, water level is reduced by 1.
<span class="nc bnc" id="L24402" title="All 4 branches missed.">                    if ((damageAtRange &gt;= 3000) &amp;&amp; (myHex.containsTerrain(Terrains.WATER))) {</span>
<span class="nc" id="L24403">                        int numCleared = damageAtRange / 3000;</span>
<span class="nc" id="L24404">                        int oldLevel = myHex.terrainLevel(Terrains.WATER);</span>
<span class="nc" id="L24405">                        myHex.removeTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L24406" title="All 2 branches missed.">                        if (oldLevel &gt; numCleared) {</span>
<span class="nc" id="L24407">                            myHex.setLevel(myHex.getLevel() - numCleared);</span>
<span class="nc" id="L24408">                            myHex.addTerrain(new Terrain(Terrains.WATER, oldLevel - numCleared));</span>
                        } else {
<span class="nc" id="L24410">                            myHex.setLevel(myHex.getLevel() - oldLevel);</span>
                        }
                    }

                    // ANY non-water hex that takes 200 becomes rough.
<span class="nc bnc" id="L24415" title="All 4 branches missed.">                    if ((damageAtRange &gt;= 200) &amp;&amp; (!myHex.containsTerrain(Terrains.WATER))) {</span>
<span class="nc" id="L24416">                        myHex.removeAllTerrains();</span>
<span class="nc" id="L24417">                        myHex.clearExits();</span>
<span class="nc" id="L24418">                        myHex.addTerrain(new Terrain(Terrains.ROUGH, 1));</span>
<span class="nc bnc" id="L24419" title="All 2 branches missed.">                    } else if ((damageAtRange &gt;= 20)</span>
<span class="nc bnc" id="L24420" title="All 2 branches missed.">                            &amp;&amp; ((myHex.containsTerrain(Terrains.WOODS))</span>
<span class="nc bnc" id="L24421" title="All 2 branches missed.">                            || (myHex.containsTerrain(Terrains.JUNGLE)))) {</span>
                        // Each 20 clears woods by 1 level.
<span class="nc" id="L24423">                        int numCleared = damageAtRange / 20;</span>
<span class="nc bnc" id="L24424" title="All 2 branches missed.">                        int terrainType = (myHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc" id="L24425">                                ? Terrains.WOODS : Terrains.JUNGLE);</span>
<span class="nc" id="L24426">                        int oldLevel = myHex.terrainLevel(terrainType);</span>
<span class="nc" id="L24427">                        int oldEl = myHex.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L24428">                        myHex.removeTerrain(terrainType);</span>
<span class="nc bnc" id="L24429" title="All 2 branches missed.">                        if (oldLevel &gt; numCleared) {</span>
<span class="nc" id="L24430">                            myHex.addTerrain(new Terrain(terrainType, oldLevel - numCleared));</span>
<span class="nc bnc" id="L24431" title="All 2 branches missed.">                            if (oldEl != 1) {</span>
<span class="nc" id="L24432">                                myHex.addTerrain(new Terrain(Terrains.FOLIAGE_ELEV, </span>
<span class="nc bnc" id="L24433" title="All 2 branches missed.">                                        oldLevel - numCleared == 3 ? 3 : 2));</span>
                            }
                        } else {
<span class="nc" id="L24436">                            myHex.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                        }
                    }

<span class="nc" id="L24440">                    sendChangedHex(myHexCoords);</span>
<span class="nc" id="L24441">                }</span>

                // Initialize for the next iteration.
<span class="nc" id="L24444">                damageAtRange = baseDamage - ((degradation * x) + 1);</span>

                // If the damage is less than 20, it has no terrain effect.
<span class="nc bnc" id="L24447" title="All 2 branches missed.">                if (damageAtRange &lt; 20) {</span>
<span class="nc" id="L24448">                    damageFlag = false;</span>
                }
            }
        }

        // Lastly, do secondary effects.
<span class="nc bnc" id="L24454" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // loaded units and off board units don't have a position,
            // so we don't count 'em here
<span class="nc bnc" id="L24457" title="All 4 branches missed.">            if ((entity.getTransportId() != Entity.NONE) || (entity.getPosition() == null)) {</span>
<span class="nc" id="L24458">                continue;</span>
            }

            // If it's already destroyed...
<span class="nc bnc" id="L24462" title="All 4 branches missed.">            if ((entity.isDoomed()) || (entity.isDestroyed())) {</span>
<span class="nc" id="L24463">                continue;</span>
            }

            // If it's too far away for this...
<span class="nc bnc" id="L24467" title="All 2 branches missed.">            if (position.distance(entity.getPosition()) &gt; secondaryRadius) {</span>
<span class="nc" id="L24468">                continue;</span>
            }

            // Actually do secondary effects against it.
            // Since the effects are unit-dependant, we'll just define it in the
            // entity.
<span class="nc" id="L24474">            applySecondaryNuclearEffects(entity, position, vDesc);</span>
<span class="nc" id="L24475">        }</span>

        // All right. We're done.
<span class="nc" id="L24478">        r = new Report(1216, Report.PUBLIC);</span>
<span class="nc" id="L24479">        r.indent();</span>
<span class="nc" id="L24480">        r.newlines = 2;</span>
<span class="nc" id="L24481">        vDesc.add(r);</span>
<span class="nc" id="L24482">    }</span>

    /**
     * Handles secondary effects from nuclear blasts against all units in range.
     *
     * @param entity   The entity to affect.
     * @param position The coordinates of the nuclear blast, for to-hit directions.
     * @param vDesc    a description vector to use for reports.
     */
    public void applySecondaryNuclearEffects(Entity entity, Coords position, Vector&lt;Report&gt; vDesc) {
        // If it's already destroyed, give up. We really don't care.
<span class="nc bnc" id="L24493" title="All 2 branches missed.">        if (entity.isDestroyed()) {</span>
<span class="nc" id="L24494">            return;</span>
        }

        // Check to see if the infantry is in a protective structure.
<span class="nc bnc" id="L24498" title="All 2 branches missed.">        boolean inHardenedBuilding = (Compute.isInBuilding(game, entity)</span>
<span class="nc bnc" id="L24499" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(entity.getPosition()).terrainLevel(Terrains.BUILDING) == 4));</span>

        // Roll 2d6.
<span class="nc" id="L24502">        int roll = Compute.d6(2);</span>

<span class="nc" id="L24504">        Report r = new Report(6555);</span>
<span class="nc" id="L24505">        r.subject = entity.getId();</span>
<span class="nc" id="L24506">        r.add(entity.getDisplayName());</span>
<span class="nc" id="L24507">        r.add(roll);</span>

        // If they are in protective structure, add 2 to the roll.
<span class="nc bnc" id="L24510" title="All 2 branches missed.">        if (inHardenedBuilding) {</span>
<span class="nc" id="L24511">            roll += 2;</span>
<span class="nc" id="L24512">            r.add(&quot; + 2 (unit is in hardened building)&quot;);</span>
        } else {
<span class="nc" id="L24514">            r.add(&quot;&quot;);</span>
        }

        // Also, if the entity is &quot;hardened&quot; against EMI, it gets a +2.
        // For these purposes, I'm going to hand this off to the Entity itself
        // to tell us.
        // Right now, it IS based purely on class, but I won't rule out the idea
        // of
        // &quot;nuclear hardening&quot; as equipment for a support vehicle, for example.
<span class="nc bnc" id="L24523" title="All 2 branches missed.">        if (entity.isNuclearHardened()) {</span>
<span class="nc" id="L24524">            roll += 2;</span>
<span class="nc" id="L24525">            r.add(&quot; + 2 (unit is hardened against EMI)&quot;);</span>
        } else {
<span class="nc" id="L24527">            r.add(&quot;&quot;);</span>
        }

<span class="nc" id="L24530">        r.indent(2);</span>
<span class="nc" id="L24531">        vDesc.add(r);</span>

        // Now, compare it to the table, and apply the effects.
<span class="nc bnc" id="L24534" title="All 2 branches missed.">        if (roll &lt;= 4) {</span>
            // The unit is destroyed.
            // Sucks, doesn't it?
            // This applies to all units.
            // Yup, just sucks.
<span class="nc" id="L24539">            vDesc.addAll(destroyEntity(entity,</span>
                    &quot;nuclear explosion secondary effects&quot;, false, false));
            // Kill the crew
<span class="nc" id="L24542">            entity.getCrew().setDoomed(true);</span>
<span class="nc bnc" id="L24543" title="All 2 branches missed.">        } else if (roll &lt;= 6) {</span>
<span class="nc bnc" id="L24544" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // It takes 50% casualties, rounded up.
<span class="nc" id="L24546">                BattleArmor myBA = (BattleArmor) entity;</span>
<span class="nc" id="L24547">                int numDeaths = (int) (Math.ceil((myBA.getNumberActiverTroopers())) / 2.0);</span>
<span class="nc bnc" id="L24548" title="All 2 branches missed.">                for (int x = 0; x &lt; numDeaths; x++) {</span>
<span class="nc" id="L24549">                    vDesc.addAll(applyCriticalHit(entity, 0, null, false,</span>
                            0, false));
                }
<span class="nc bnc" id="L24552" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
                // Standard infantry are auto-killed in this band, unless
                // they're in a building.
<span class="nc bnc" id="L24555" title="All 2 branches missed.">                if (game.getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.BUILDING)) {</span>
                    // 50% casualties, rounded up.
<span class="nc" id="L24557">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 2.0));</span>
<span class="nc" id="L24558">                    vDesc.addAll(damageEntity(entity, new HitData(</span>
                            Infantry.LOC_INFANTRY), damage, true));
<span class="nc" id="L24560">                } else {</span>
<span class="nc" id="L24561">                    vDesc.addAll(destroyEntity(entity,</span>
                            &quot;nuclear explosion secondary effects&quot;, false, false));
<span class="nc" id="L24563">                    entity.getCrew().setDoomed(true);</span>
                }
<span class="nc bnc" id="L24565" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
                // All vehicles suffer two critical hits...
<span class="nc" id="L24567">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24568">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>
<span class="nc" id="L24569">                hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24570">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // ...and a Crew Killed hit.
<span class="nc" id="L24573">                vDesc.addAll(applyCriticalHit(entity, 0, new CriticalSlot(0,</span>
                        Tank.CRIT_CREW_KILLED), false, 0, false));
<span class="nc bnc" id="L24575" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
                // 'Mechs suffer two critical hits...
<span class="nc" id="L24577">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24578">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>
<span class="nc" id="L24579">                hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24580">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // and four pilot hits.
<span class="nc" id="L24583">                vDesc.addAll(damageCrew(entity, 4));</span>
<span class="nc" id="L24584">            }</span>
            // Buildings and gun emplacements and such are only affected by the EMI.
            // No auto-crits or anything.
<span class="nc bnc" id="L24587" title="All 2 branches missed.">        } else if (roll &lt;= 10) {</span>
<span class="nc bnc" id="L24588" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // It takes 25% casualties, rounded up.
<span class="nc" id="L24590">                BattleArmor myBA = (BattleArmor) entity;</span>
<span class="nc" id="L24591">                int numDeaths = (int) (Math.ceil(((myBA.getNumberActiverTroopers())) / 4.0));</span>
<span class="nc bnc" id="L24592" title="All 2 branches missed.">                for (int x = 0; x &lt; numDeaths; x++) {</span>
<span class="nc" id="L24593">                    vDesc.addAll(applyCriticalHit(entity, 0, null, false, 0, false));</span>
                }
<span class="nc bnc" id="L24595" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
<span class="nc bnc" id="L24596" title="All 2 branches missed.">                if (game.getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.BUILDING)) {</span>
                    // 25% casualties, rounded up.
<span class="nc" id="L24598">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 4.0));</span>
<span class="nc" id="L24599">                    vDesc.addAll(damageEntity(entity, new HitData(Infantry.LOC_INFANTRY), damage, true));</span>
<span class="nc" id="L24600">                } else {</span>
                    // 50% casualties, rounded up.
<span class="nc" id="L24602">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 2.0));</span>
<span class="nc" id="L24603">                    vDesc.addAll(damageEntity(entity, new HitData(Infantry.LOC_INFANTRY), damage, true));</span>
<span class="nc" id="L24604">                }</span>
<span class="nc bnc" id="L24605" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
                // It takes one crit...
<span class="nc" id="L24607">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24608">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // Plus a Crew Stunned critical.
<span class="nc" id="L24611">                vDesc.addAll(applyCriticalHit(entity, 0, new CriticalSlot(0,</span>
                        Tank.CRIT_CREW_STUNNED), false, 0, false));
<span class="nc bnc" id="L24613" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
                // 'Mechs suffer a critical hit...
<span class="nc" id="L24615">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24616">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // and two pilot hits.
<span class="nc" id="L24619">                vDesc.addAll(damageCrew(entity, 2));</span>
            }
            // Buildings and gun emplacements and such are only affected by
            // the EMI.
            // No auto-crits or anything.
        }
        // If it's 11+, there are no secondary effects beyond EMI.
        // Lucky bastards.

        // And lastly, the unit is now affected by electromagnetic interference.
<span class="nc" id="L24629">        entity.setEMI(true);</span>
<span class="nc" id="L24630">    }</span>

    /**
     * Apply a single critical hit. The following private member of Server are
     * accessed from this function, preventing it from being factored out of the
     * Server class: destroyEntity() destroyLocation() checkEngineExplosion()
     * damageCrew() explodeEquipment() game
     *
     * @param en               the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to &lt;code&gt;Tank&lt;/code&gt;s and
     *                         for hits to a &lt;code&gt;Protomech&lt;/code&gt; torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;. For critical hits on a
     *                         &lt;code&gt;Tank&lt;/code&gt;, the index of the slot should be the index
     *                         of the critical hit table.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as triggering
     *                         an ammo explosion, sending hovercraft to watery graves, or
     *                         damaging ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    public Vector&lt;Report&gt; applyCriticalHit(Entity en, int loc, CriticalSlot cs,
                                           boolean secondaryEffects, int damageCaused,
                                           boolean isCapital) {
<span class="nc" id="L24659">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L24662" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L24663">            vDesc.addAll(applyTankCritical((Tank)en, loc, cs, damageCaused));</span>
<span class="nc bnc" id="L24664" title="All 2 branches missed.">        } else if (en instanceof Aero) {</span>
<span class="nc" id="L24665">            vDesc.addAll(applyAeroCritical((Aero)en, loc, cs, damageCaused, isCapital));</span>
<span class="nc bnc" id="L24666" title="All 2 branches missed.">        } else if (en instanceof BattleArmor) {</span>
            // We might as well handle this here.
            // However, we're considering a crit against BA as a &quot;crew kill&quot;.
<span class="nc" id="L24669">            BattleArmor ba = (BattleArmor) en;</span>
<span class="nc" id="L24670">            r = new Report(6111);</span>
<span class="nc" id="L24671">            int randomTrooper = ba.getRandomTrooper();</span>
<span class="nc" id="L24672">            ba.destroyLocation(randomTrooper);</span>
<span class="nc" id="L24673">            r.add(randomTrooper);</span>
<span class="nc" id="L24674">            r.newlines = 1;</span>
<span class="nc" id="L24675">            vDesc.add(r);</span>
<span class="nc bnc" id="L24676" title="All 2 branches missed.">        } else if (CriticalSlot.TYPE_SYSTEM == cs.getType()) {</span>
            // Handle critical hits on system slots.
<span class="nc" id="L24678">            cs.setHit(true);</span>
<span class="nc bnc" id="L24679" title="All 2 branches missed.">            if (en instanceof Protomech) {</span>
<span class="nc" id="L24680">                vDesc.addAll(applyProtomechCritical((Protomech)en, loc, cs, secondaryEffects, damageCaused, isCapital));</span>
            } else {
<span class="nc" id="L24682">                vDesc.addAll(applyMechSystemCritical(en, loc, cs));</span>
            }
<span class="nc bnc" id="L24684" title="All 2 branches missed.">        } else if (CriticalSlot.TYPE_EQUIPMENT == cs.getType()) {</span>
<span class="nc" id="L24685">            vDesc.addAll(applyEquipmentCritical(en, loc, cs, secondaryEffects));</span>
        } // End crit-on-equipment-slot
        // mechs with TSM hit by anti-tsm missiles this round get another
        // crit
<span class="nc bnc" id="L24689" title="All 4 branches missed.">        if ((en instanceof Mech) &amp;&amp; en.hitThisRoundByAntiTSM) {</span>
<span class="nc" id="L24690">            Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L24691" title="All 2 branches missed.">            if (mech.hasTSM()) {</span>
<span class="nc" id="L24692">                r = new Report(6430);</span>
<span class="nc" id="L24693">                r.subject = en.getId();</span>
<span class="nc" id="L24694">                r.indent(2);</span>
<span class="nc" id="L24695">                r.addDesc(en);</span>
<span class="nc" id="L24696">                r.newlines = 0;</span>
<span class="nc" id="L24697">                vDesc.addElement(r);</span>
<span class="nc" id="L24698">                vDesc.addAll(oneCriticalEntity(en, Compute.d6(2), false, damageCaused));</span>
            }
<span class="nc" id="L24700">            en.hitThisRoundByAntiTSM = false;</span>
        }

        // if using buffered VDNI then a possible pilot hit
<span class="nc bnc" id="L24704" title="All 4 branches missed.">        if (en.hasAbility(OptionsConstants.MD_BVDNI) &amp;&amp; !en.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L24705">            Report.addNewline(vDesc);</span>
<span class="nc" id="L24706">            int roll = Compute.d6(2);</span>
<span class="nc" id="L24707">            r = new Report(3580);</span>
<span class="nc" id="L24708">            r.subject = en.getId();</span>
<span class="nc" id="L24709">            r.addDesc(en);</span>
<span class="nc" id="L24710">            r.add(7);</span>
<span class="nc" id="L24711">            r.add(roll);</span>
<span class="nc bnc" id="L24712" title="All 2 branches missed.">            r.choose(roll &gt;= 8);</span>
<span class="nc" id="L24713">            r.indent(2);</span>
<span class="nc" id="L24714">            vDesc.add(r);</span>
<span class="nc bnc" id="L24715" title="All 2 branches missed.">            if (roll &gt;= 8) {</span>
<span class="nc" id="L24716">                vDesc.addAll(damageCrew(en, 1));</span>
            }
        }

        // Return the results of the damage.
<span class="nc" id="L24721">        return vDesc;</span>
    }

    /**
     * Apply a single critical hit to an equipment slot.
     *
     * @param en               the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as triggering
     *                         an ammo explosion, sending hovercraft to watery graves, or
     *                         damaging ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     */
    private Vector&lt;Report&gt; applyEquipmentCritical(Entity en, int loc, CriticalSlot cs,
                                                  boolean secondaryEffects) {
<span class="nc" id="L24740">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L24742">        cs.setHit(true);</span>
<span class="nc" id="L24743">        Mounted mounted = cs.getMount();</span>
<span class="nc" id="L24744">        EquipmentType eqType = mounted.getType();</span>
<span class="nc" id="L24745">        boolean hitBefore = mounted.isHit();</span>

<span class="nc" id="L24747">        r = new Report(6225);</span>
<span class="nc" id="L24748">        r.subject = en.getId();</span>
<span class="nc" id="L24749">        r.indent(3);</span>
<span class="nc" id="L24750">        r.add(mounted.getDesc());</span>
<span class="nc" id="L24751">        reports.addElement(r);</span>

        // Shield objects are not useless when they take one crit.
        // Shields can be critted and still be usable.
<span class="nc bnc" id="L24755" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; ((MiscType) eqType).isShield()) {</span>
<span class="nc" id="L24756">            mounted.setHit(false);</span>
        } else {
<span class="nc" id="L24758">            mounted.setHit(true);</span>
        }

<span class="nc bnc" id="L24761" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; eqType.hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L24762">            ((Mech)en).setHasDamagedCoolantSystem(true);</span>
        }

<span class="nc bnc" id="L24765" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; eqType.hasFlag(MiscType.F_HARJEL)) {</span>
<span class="nc" id="L24766">            reports.addAll(breachLocation(en, loc, null, true));</span>
        }

        // HarJel II/III hits trigger another possible critical hit on
        // the same location
        // it's like an ammunition explosion---a secondary effect
<span class="nc bnc" id="L24772" title="All 4 branches missed.">        if (secondaryEffects &amp;&amp; (eqType instanceof MiscType)</span>
<span class="nc bnc" id="L24773" title="All 6 branches missed.">                &amp;&amp; (eqType.hasFlag(MiscType.F_HARJEL_II) || eqType.hasFlag(MiscType.F_HARJEL_III))</span>
                &amp;&amp; !hitBefore) {
<span class="nc" id="L24775">            r = new Report(9852);</span>
<span class="nc" id="L24776">            r.subject = en.getId();</span>
<span class="nc" id="L24777">            r.indent(2);</span>
<span class="nc" id="L24778">            reports.addElement(r);</span>
<span class="nc" id="L24779">            reports.addAll(criticalEntity(en, loc, false, 0, 0));</span>
        }

        // If the item is the ECM suite of a Mek Stealth system
        // then it's destruction turns off the stealth.
<span class="nc bnc" id="L24784" title="All 4 branches missed.">        if (!hitBefore &amp;&amp; (eqType instanceof MiscType)</span>
<span class="nc bnc" id="L24785" title="All 2 branches missed.">            &amp;&amp; eqType.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L24786" title="All 2 branches missed.">            &amp;&amp; (mounted.getLinkedBy() != null)) {</span>
<span class="nc" id="L24787">            Mounted stealth = mounted.getLinkedBy();</span>
<span class="nc" id="L24788">            r = new Report(6255);</span>
<span class="nc" id="L24789">            r.subject = en.getId();</span>
<span class="nc" id="L24790">            r.indent(2);</span>
<span class="nc" id="L24791">            r.add(stealth.getType().getName());</span>
<span class="nc" id="L24792">            reports.addElement(r);</span>
<span class="nc" id="L24793">            stealth.setMode(&quot;Off&quot;);</span>
        }

        // Handle equipment explosions.
        // Equipment explosions are secondary effects and
        // do not occur when loading from a scenario.
<span class="nc bnc" id="L24799" title="All 4 branches missed.">        if (((secondaryEffects &amp;&amp; eqType.isExplosive(mounted))</span>
<span class="nc bnc" id="L24800" title="All 6 branches missed.">                || mounted.isHotLoaded() || (mounted.hasChargedCapacitor() != 0))</span>
                &amp;&amp; !hitBefore) {
<span class="nc" id="L24802">            reports.addAll(explodeEquipment(en, loc, mounted));</span>
        }

        // Make sure that ammo in this slot is exhausted.
<span class="nc bnc" id="L24806" title="All 2 branches missed.">        if (mounted.getBaseShotsLeft() &gt; 0) {</span>
<span class="nc" id="L24807">            mounted.setShotsLeft(0);</span>
        }

        // LAMs that are part of a fighter squadron will need to have the squadron recalculate
        // the bomb load out on a bomb bay critical.
<span class="nc bnc" id="L24812" title="All 4 branches missed.">        if (en.isPartOfFighterSquadron() &amp;&amp; (mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L24813" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc" id="L24814">            Entity squadron = game.getEntity(en.getTransportId());</span>
<span class="nc bnc" id="L24815" title="All 2 branches missed.">            if (squadron instanceof FighterSquadron) {</span>
<span class="nc" id="L24816">                ((FighterSquadron) squadron).computeSquadronBombLoadout();</span>
            }
        }
<span class="nc" id="L24819">        return reports;</span>
    }

    /**
     * Apply a single critical hit to a Mech system.
     *
     * @param en   the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *             not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc  the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs   the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *             not be &lt;code&gt;null&lt;/code&gt;.
     */
    private Vector&lt;Report&gt; applyMechSystemCritical(Entity en, int loc, CriticalSlot cs) {
<span class="nc" id="L24832">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L24834">        r = new Report(6225);</span>
<span class="nc" id="L24835">        r.subject = en.getId();</span>
<span class="nc" id="L24836">        r.indent(3);</span>
<span class="nc" id="L24837">        r.add(((Mech) en).getSystemName(cs.getIndex()));</span>
<span class="nc" id="L24838">        reports.addElement(r);</span>
<span class="nc bnc" id="L24839" title="All 7 branches missed.">        switch (cs.getIndex()) {</span>
            case Mech.SYSTEM_COCKPIT:
                // Lets auto-eject if we can!
<span class="nc" id="L24842">                Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L24843" title="All 2 branches missed.">                if (game.getOptions().booleanOption(</span>
                        OptionsConstants.ADVANCED_TACOPS_SKIN_OF_THE_TEETH_EJECTION)) {
<span class="nc bnc" id="L24845" title="All 2 branches missed.">                    if (mech.isAutoEject()</span>
<span class="nc bnc" id="L24846" title="All 2 branches missed.">                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L24847" title="All 2 branches missed.">                            || (game.getOptions().booleanOption(</span>
                                    OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L24849" title="All 2 branches missed.">                            &amp;&amp; mech.isCondEjectHeadshot()))) {</span>
<span class="nc" id="L24850">                        reports.addAll(ejectEntity(en, true, true));</span>
                    }
                }

                //First check whether this hit takes out the whole crew; for multi-crew cockpits
                //we need to check the other critical positions (if any).
<span class="nc" id="L24856">                boolean allDead = true;</span>
<span class="nc" id="L24857">                int crewSlot = ((Mech)en).getCrewForCockpitSlot(loc, cs);</span>
<span class="nc bnc" id="L24858" title="All 2 branches missed.">                if (crewSlot &gt;= 0) {</span>
<span class="nc bnc" id="L24859" title="All 2 branches missed.">                    for (int i = 0; i &lt; en.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L24860" title="All 6 branches missed.">                        if (i != crewSlot &amp;&amp; !en.getCrew().isDead(i) &amp;&amp; !en.getCrew().isMissing(i)) {</span>
<span class="nc" id="L24861">                            allDead = false;</span>
                        }
                    }
                }
<span class="nc bnc" id="L24865" title="All 2 branches missed.">                if (allDead) {</span>
                    // Don't kill a pilot multiple times.
<span class="nc bnc" id="L24867" title="All 2 branches missed.">                    if (Crew.DEATH &gt; en.getCrew().getHits()) {</span>
                        // Single pilot or tripod cockpit; all crew are killed.
<span class="nc" id="L24869">                        en.getCrew().setDoomed(true);</span>
<span class="nc" id="L24870">                        Report.addNewline(reports);</span>
<span class="nc" id="L24871">                        reports.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                    }
<span class="nc bnc" id="L24873" title="All 2 branches missed.">                } else if (!en.getCrew().isMissing(crewSlot)){</span>
<span class="nc bnc" id="L24874" title="All 2 branches missed.">                    boolean wasPilot = en.getCrew().getCurrentPilotIndex() == crewSlot;</span>
<span class="nc bnc" id="L24875" title="All 2 branches missed.">                    boolean wasGunner = en.getCrew().getCurrentGunnerIndex() == crewSlot;</span>
<span class="nc" id="L24876">                    en.getCrew().setDead(true, crewSlot);</span>
<span class="nc" id="L24877">                    r = new Report(6027);</span>
<span class="nc" id="L24878">                    r.subject = en.getId();</span>
<span class="nc" id="L24879">                    r.indent(2);</span>
<span class="nc" id="L24880">                    r.add(en.getCrew().getCrewType().getRoleName(crewSlot));</span>
<span class="nc" id="L24881">                    r.addDesc(en);</span>
<span class="nc" id="L24882">                    r.add(en.getCrew().getName(crewSlot));</span>
<span class="nc" id="L24883">                    reports.addElement(r);</span>
<span class="nc" id="L24884">                    r = createCrewTakeoverReport(en, crewSlot, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L24885" title="All 2 branches missed.">                    if (null != r) {</span>
<span class="nc" id="L24886">                        reports.add(r);</span>
                    }
<span class="nc" id="L24888">                }</span>

                break;
            case Mech.SYSTEM_ENGINE:
                // if the slot is missing, the location was previously
                // destroyed and the engine hit was then counted already
<span class="nc bnc" id="L24894" title="All 2 branches missed.">                if (!cs.isMissing()) {</span>
<span class="nc" id="L24895">                    en.engineHitsThisPhase++;</span>
                }
<span class="nc" id="L24897">                int numEngineHits = en.getEngineHits();</span>
<span class="nc" id="L24898">                boolean engineExploded = checkEngineExplosion(en, reports, numEngineHits);</span>
<span class="nc" id="L24899">                int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L24900" title="All 4 branches missed.">                if (en.isSuperHeavy() &amp;&amp; en.hasEngine()</span>
<span class="nc bnc" id="L24901" title="All 2 branches missed.">                        &amp;&amp; (en.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L24902">                    hitsToDestroy = 2;</span>
                }

<span class="nc bnc" id="L24905" title="All 4 branches missed.">                if (!engineExploded &amp;&amp; (numEngineHits &gt;= hitsToDestroy)) {</span>
                    // third engine hit
<span class="nc" id="L24907">                    reports.addAll(destroyEntity(en, &quot;engine destruction&quot;));</span>
<span class="nc" id="L24908">                    if (game.getOptions()</span>
<span class="nc bnc" id="L24909" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L24910">                        reports.addAll(abandonEntity(en));</span>
                    }
<span class="nc" id="L24912">                    en.setSelfDestructing(false);</span>
<span class="nc" id="L24913">                    en.setSelfDestructInitiated(false);</span>
                }
                break;
            case Mech.SYSTEM_GYRO:
<span class="nc" id="L24917">                int gyroHits = en.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, loc);</span>
<span class="nc bnc" id="L24918" title="All 2 branches missed.">                if (en.getGyroType() != Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L24919">                    gyroHits++;</span>
                }
                // Automatically falls in AirMech mode, which it seems would indicate a crash if airborne.
<span class="nc bnc" id="L24922" title="All 6 branches missed.">                if (gyroHits == 3 &amp;&amp; en instanceof LandAirMech &amp;&amp; en.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L24923">                    crashAirMech(en, new PilotingRollData(en.getId(),</span>
                            TargetRoll.AUTOMATIC_FAIL, 1, &quot;gyro destroyed&quot;), reports);
<span class="nc" id="L24925">                    break;</span>
                }
                //No PSR for Mechs in non-leg mode
<span class="nc bnc" id="L24928" title="All 2 branches missed.">                if (!en.canFall(true)) {</span>
<span class="nc" id="L24929">                    break;</span>
                }
<span class="nc bnc" id="L24931" title="All 4 branches missed.">                switch (gyroHits) {</span>
                    case 3:
                        // HD 3 hits, standard 2 hits
<span class="nc" id="L24934">                        game.addPSR(new PilotingRollData(en.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                                1, &quot;gyro destroyed&quot;));
                        // Gyro destroyed entities may not be hull down
<span class="nc" id="L24937">                        en.setHullDown(false);</span>
<span class="nc" id="L24938">                        break;</span>
                    case 2:
                        // HD 2 hits, standard 1 hit
<span class="nc" id="L24941">                        game.addPSR(new PilotingRollData(en.getId(), 3, &quot;gyro hit&quot;));</span>
<span class="nc" id="L24942">                        break;</span>
                    case 1:
                        // HD 1 hit
<span class="nc" id="L24945">                        game.addPSR(new PilotingRollData(en.getId(), 2, &quot;gyro hit&quot;));</span>
<span class="nc" id="L24946">                        break;</span>
                    default:
                        // ignore if &gt;4 hits (don't over do it, the auto fail
                        // already happened.)
                }
<span class="nc" id="L24951">                break;</span>
            case Mech.ACTUATOR_UPPER_LEG:
            case Mech.ACTUATOR_LOWER_LEG:
            case Mech.ACTUATOR_FOOT:
<span class="nc bnc" id="L24955" title="All 2 branches missed.">                if (en.canFall(true)) {</span>
                    // leg/foot actuator piloting roll
<span class="nc" id="L24957">                    game.addPSR(new PilotingRollData(en.getId(), 1, &quot;leg/foot actuator hit&quot;));</span>
                }
                break;
            case Mech.ACTUATOR_HIP:
<span class="nc bnc" id="L24961" title="All 2 branches missed.">                if (en.canFall(true)) {</span>
                    // hip piloting roll
<span class="nc" id="L24963">                    game.addPSR(new PilotingRollData(en.getId(), 2, &quot;hip actuator hit&quot;));</span>
                }
                break;
            case LandAirMech.LAM_AVIONICS:
<span class="nc bnc" id="L24967" title="All 2 branches missed.">                if (en.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L24968" title="All 2 branches missed.">                    if (en.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L24969">                        game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L24970">                                en.getTransportId(), 1, &quot;avionics hit&quot;));</span>
<span class="nc bnc" id="L24971" title="All 2 branches missed.">                    } else if (en.isCapitalFighter()){</span>
<span class="nc" id="L24972">                        game.addControlRoll(new PilotingRollData(en.getId(), 1,</span>
                                &quot;avionics hit&quot;));
                    } else {
<span class="nc" id="L24975">                        game.addControlRoll(new PilotingRollData(en.getId(), 0,</span>
                                &quot;avionics hit&quot;));
                    }
                }
                break;
        }
<span class="nc" id="L24981">        return reports;</span>
    }

    /**
     * Apply a single critical hit to a ProtoMech.
     *
     * @param pm               the &lt;code&gt;Protomech&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to a &lt;code&gt;Protomech&lt;/code&gt;
     *                         torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as damaging
     *                         ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    private Vector&lt;Report&gt; applyProtomechCritical(Protomech pm, int loc, CriticalSlot cs,
                                                  boolean secondaryEffects, int damageCaused,
                                                  boolean isCapital) {
<span class="nc" id="L25005">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L25007">        int numHit = pm.getCritsHit(loc);</span>
<span class="nc bnc" id="L25008" title="All 2 branches missed.">        if ((cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_A)</span>
<span class="nc bnc" id="L25009" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_B)</span>
<span class="nc bnc" id="L25010" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_C)</span>
<span class="nc bnc" id="L25011" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_D)</span>
<span class="nc bnc" id="L25012" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_E)</span>
<span class="nc bnc" id="L25013" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_F)) {</span>
<span class="nc" id="L25014">            r = new Report(6225);</span>
<span class="nc" id="L25015">            r.subject = pm.getId();</span>
<span class="nc" id="L25016">            r.indent(3);</span>
<span class="nc" id="L25017">            r.add(Protomech.systemNames[cs.getIndex()]);</span>
<span class="nc" id="L25018">            reports.addElement(r);</span>
        }
<span class="nc bnc" id="L25020" title="All 11 branches missed.">        switch (cs.getIndex()) {</span>
            case Protomech.SYSTEM_HEADCRIT:
<span class="nc bnc" id="L25022" title="All 2 branches missed.">                if (2 == numHit) {</span>
<span class="nc" id="L25023">                    r = new Report(6230);</span>
<span class="nc" id="L25024">                    r.subject = pm.getId();</span>
<span class="nc" id="L25025">                    reports.addElement(r);</span>
<span class="nc" id="L25026">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_ARMCRIT:
<span class="nc bnc" id="L25030" title="All 2 branches missed.">                if (2 == numHit) {</span>
<span class="nc" id="L25031">                    r = new Report(6235);</span>
<span class="nc" id="L25032">                    r.subject = pm.getId();</span>
<span class="nc" id="L25033">                    reports.addElement(r);</span>
<span class="nc" id="L25034">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_LEGCRIT:
<span class="nc bnc" id="L25038" title="All 2 branches missed.">                if (3 == numHit) {</span>
<span class="nc" id="L25039">                    r = new Report(6240);</span>
<span class="nc" id="L25040">                    r.subject = pm.getId();</span>
<span class="nc" id="L25041">                    r.newlines = 0;</span>
<span class="nc" id="L25042">                    reports.addElement(r);</span>
<span class="nc" id="L25043">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_TORSOCRIT:
<span class="nc bnc" id="L25047" title="All 2 branches missed.">                if (3 == numHit) {</span>
<span class="nc" id="L25048">                    reports.addAll(destroyEntity(pm, &quot;torso destruction&quot;));</span>
                }
                // Torso weapon hits are secondary effects and
                // do not occur when loading from a scenario.
<span class="nc bnc" id="L25052" title="All 2 branches missed.">                else if (secondaryEffects) {</span>
<span class="nc" id="L25053">                    int tweapRoll = Compute.d6(1);</span>
                    CriticalSlot newSlot;

<span class="nc bnc" id="L25056" title="All 7 branches missed.">                    switch (tweapRoll) {</span>
                        case 1:
<span class="nc bnc" id="L25058" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25059">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_A);
<span class="nc" id="L25061">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25063">                                break;</span>
                            }
                        case 2:
<span class="nc bnc" id="L25066" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25067">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_B);
<span class="nc" id="L25069">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25071">                                break;</span>
                            }
<span class="nc" id="L25073">                            newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                    Protomech.SYSTEM_TORSO_WEAPON_A);
<span class="nc" id="L25075">                            reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                    secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25077">                            break;</span>
                        case 3:
<span class="nc bnc" id="L25079" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25080">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25082">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25084">                                break;</span>
                            }
                        case 4:
<span class="nc bnc" id="L25087" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25088">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_D);
<span class="nc" id="L25090">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25092">                                break;</span>
                            }
<span class="nc" id="L25094">                            newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                    Protomech.SYSTEM_TORSO_WEAPON_B);
<span class="nc" id="L25096">                            reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                    secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25098">                            break;</span>
                        case 5:
<span class="nc bnc" id="L25100" title="All 2 branches missed.">                            if (pm.getWeight() &gt; 9) {</span>
<span class="nc bnc" id="L25101" title="All 2 branches missed.">                                if (pm.isQuad()) {</span>
<span class="nc" id="L25102">                                    newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                            Protomech.SYSTEM_TORSO_WEAPON_E);
<span class="nc" id="L25104">                                    reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                            secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25106">                                    break;</span>
                                }
<span class="nc" id="L25108">                                newSlot = new CriticalSlot(</span>
                                        CriticalSlot.TYPE_SYSTEM,
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25111">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25113">                                break;</span>
                            }
                        case 6:
<span class="nc bnc" id="L25116" title="All 2 branches missed.">                            if (pm.getWeight() &gt; 9) {</span>
<span class="nc bnc" id="L25117" title="All 2 branches missed.">                                if (pm.isQuad()) {</span>
<span class="nc" id="L25118">                                    newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                            Protomech.SYSTEM_TORSO_WEAPON_F);
<span class="nc" id="L25120">                                    reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                            secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25122">                                    break;</span>
                                }
<span class="nc" id="L25124">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25126">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
                                break;
                            }
                    }
                    // A magnetic clamp system is destroyed by any torso critical.
<span class="nc" id="L25132">                    Mounted magClamp = pm.getMisc().stream().filter(m -&gt; m.getType()</span>
<span class="nc" id="L25133">                            .hasFlag(MiscType.F_MAGNETIC_CLAMP)).findFirst().orElse(null);</span>
<span class="nc bnc" id="L25134" title="All 4 branches missed.">                    if ((magClamp != null) &amp;&amp; !magClamp.isHit()) {</span>
<span class="nc" id="L25135">                        magClamp.setHit(true);</span>
<span class="nc" id="L25136">                        r = new Report(6252);</span>
<span class="nc" id="L25137">                        r.subject = pm.getId();</span>
<span class="nc" id="L25138">                        reports.addElement(r);</span>
                    }
<span class="nc" id="L25140">                }</span>
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_A:
<span class="nc" id="L25143">                Mounted weaponA = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25144" title="All 2 branches missed.">                if (null != weaponA) {</span>
<span class="nc" id="L25145">                    weaponA.setHit(true);</span>
<span class="nc" id="L25146">                    r = new Report(6245);</span>
<span class="nc" id="L25147">                    r.subject = pm.getId();</span>
<span class="nc" id="L25148">                    r.newlines = 0;</span>
<span class="nc" id="L25149">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_B:
<span class="nc" id="L25153">                Mounted weaponB = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25154" title="All 2 branches missed.">                if (null != weaponB) {</span>
<span class="nc" id="L25155">                    weaponB.setHit(true);</span>
<span class="nc" id="L25156">                    r = new Report(6246);</span>
<span class="nc" id="L25157">                    r.subject = pm.getId();</span>
<span class="nc" id="L25158">                    r.newlines = 0;</span>
<span class="nc" id="L25159">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_C:
<span class="nc" id="L25163">                Mounted weaponC = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25164" title="All 2 branches missed.">                if (null != weaponC) {</span>
<span class="nc" id="L25165">                    weaponC.setHit(true);</span>
<span class="nc" id="L25166">                    r = new Report(6247);</span>
<span class="nc" id="L25167">                    r.subject = pm.getId();</span>
<span class="nc" id="L25168">                    r.newlines = 0;</span>
<span class="nc" id="L25169">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_D:
<span class="nc" id="L25173">                Mounted weaponD = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25174" title="All 2 branches missed.">                if (null != weaponD) {</span>
<span class="nc" id="L25175">                    weaponD.setHit(true);</span>
<span class="nc" id="L25176">                    r = new Report(6248);</span>
<span class="nc" id="L25177">                    r.subject = pm.getId();</span>
<span class="nc" id="L25178">                    r.newlines = 0;</span>
<span class="nc" id="L25179">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_E:
<span class="nc" id="L25183">                Mounted weaponE = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25184" title="All 2 branches missed.">                if (null != weaponE) {</span>
<span class="nc" id="L25185">                    weaponE.setHit(true);</span>
<span class="nc" id="L25186">                    r = new Report(6249);</span>
<span class="nc" id="L25187">                    r.subject = pm.getId();</span>
<span class="nc" id="L25188">                    r.newlines = 0;</span>
<span class="nc" id="L25189">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_F:
<span class="nc" id="L25193">                Mounted weaponF = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25194" title="All 2 branches missed.">                if (null != weaponF) {</span>
<span class="nc" id="L25195">                    weaponF.setHit(true);</span>
<span class="nc" id="L25196">                    r = new Report(6250);</span>
<span class="nc" id="L25197">                    r.subject = pm.getId();</span>
<span class="nc" id="L25198">                    r.newlines = 0;</span>
<span class="nc" id="L25199">                    reports.addElement(r);</span>
                }
                break;
        } // End switch( cs.getType() )

        // Shaded hits cause pilot damage.
<span class="nc bnc" id="L25205" title="All 2 branches missed.">        if (pm.shaded(loc, numHit)) {</span>
            // Destroyed ProtoMech sections have
            // already damaged the pilot.
<span class="nc" id="L25208">            int pHits = Protomech.POSSIBLE_PILOT_DAMAGE[loc]</span>
<span class="nc" id="L25209">                        - pm.getPilotDamageTaken(loc);</span>
<span class="nc bnc" id="L25210" title="All 2 branches missed.">            if (Math.min(1, pHits) &gt; 0) {</span>
<span class="nc" id="L25211">                Report.addNewline(reports);</span>
<span class="nc" id="L25212">                reports.addAll(damageCrew(pm, 1));</span>
<span class="nc" id="L25213">                pHits = 1 + pm.getPilotDamageTaken(loc);</span>
<span class="nc" id="L25214">                pm.setPilotDamageTaken(loc, pHits);</span>
            }
        } // End have-shaded-hit
<span class="nc" id="L25217">        return reports;</span>
    }

    /**
     * Apply a single critical hit to an aerospace unit.
     *
     * @param aero             the &lt;code&gt;Aero&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    private Vector&lt;Report&gt; applyAeroCritical(Aero aero, int loc, CriticalSlot cs, int damageCaused, boolean isCapital) {
<span class="nc" id="L25232">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L25234">        Jumpship js = null;</span>
<span class="nc bnc" id="L25235" title="All 2 branches missed.">        if (aero instanceof Jumpship) {</span>
<span class="nc" id="L25236">            js = (Jumpship)aero;</span>
        }

<span class="nc bnc" id="L25239" title="All 24 branches missed.">        switch (cs.getIndex()) {</span>
            case Aero.CRIT_NONE:
                // no effect
<span class="nc" id="L25242">                r = new Report(6005);</span>
<span class="nc" id="L25243">                r.subject = aero.getId();</span>
<span class="nc" id="L25244">                reports.add(r);</span>
<span class="nc" id="L25245">                break;</span>
            case Aero.CRIT_FCS:
                // Fire control system
<span class="nc" id="L25248">                r = new Report(9105);</span>
<span class="nc" id="L25249">                r.subject = aero.getId();</span>
<span class="nc" id="L25250">                reports.add(r);</span>
<span class="nc" id="L25251">                aero.setFCSHits(aero.getFCSHits() + 1);</span>
<span class="nc" id="L25252">                break;</span>
            case Aero.CRIT_SENSOR:
                // sensors
<span class="nc" id="L25255">                r = new Report(6620);</span>
<span class="nc" id="L25256">                r.subject = aero.getId();</span>
<span class="nc" id="L25257">                reports.add(r);</span>
<span class="nc" id="L25258">                aero.setSensorHits(aero.getSensorHits() + 1);</span>
<span class="nc" id="L25259">                break;</span>
            case Aero.CRIT_AVIONICS:
                // avionics
<span class="nc" id="L25262">                r = new Report(9110);</span>
<span class="nc" id="L25263">                r.subject = aero.getId();</span>
<span class="nc" id="L25264">                reports.add(r);</span>
<span class="nc" id="L25265">                aero.setAvionicsHits(aero.getAvionicsHits() + 1);</span>
<span class="nc bnc" id="L25266" title="All 2 branches missed.">                if (aero.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25267">                    game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25268">                            aero.getTransportId(), 1, &quot;avionics hit&quot;));</span>
<span class="nc bnc" id="L25269" title="All 2 branches missed.">                } else if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25270">                    game.addControlRoll(new PilotingRollData(aero.getId(), 1,</span>
                                                             &quot;avionics hit&quot;));
                } else {
<span class="nc" id="L25273">                    game.addControlRoll(new PilotingRollData(aero.getId(), 0,</span>
                                                             &quot;avionics hit&quot;));
                }
<span class="nc" id="L25276">                break;</span>
            case Aero.CRIT_CONTROL:
                // force control roll
<span class="nc" id="L25279">                r = new Report(9115);</span>
<span class="nc" id="L25280">                r.subject = aero.getId();</span>
<span class="nc" id="L25281">                reports.add(r);</span>
<span class="nc bnc" id="L25282" title="All 2 branches missed.">                if (aero.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25283">                    game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25284">                            aero.getTransportId(), 1, &quot;critical hit&quot;));</span>
<span class="nc bnc" id="L25285" title="All 2 branches missed.">                } else if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25286">                    game.addControlRoll(new PilotingRollData(aero.getId(), 1,</span>
                                                             &quot;critical hit&quot;));
                } else {
<span class="nc" id="L25289">                    game.addControlRoll(new PilotingRollData(aero.getId(), 0,</span>
                                                             &quot;critical hit&quot;));
                }
<span class="nc" id="L25292">                break;</span>
            case Aero.CRIT_FUEL_TANK:
                // fuel tank
<span class="nc" id="L25295">                int boomTarget = 10;</span>
<span class="nc bnc" id="L25296" title="All 2 branches missed.">                if (aero.hasQuirk(OptionsConstants.QUIRK_NEG_FRAGILE_FUEL)) {</span>
<span class="nc" id="L25297">                    boomTarget = 8;</span>
                }
<span class="nc bnc" id="L25299" title="All 4 branches missed.">                if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25300" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)) {
<span class="nc" id="L25302">                    boomTarget = 12;</span>
                }
                // check for possible explosion
<span class="nc" id="L25305">                int fuelroll = Compute.d6(2);</span>
<span class="nc" id="L25306">                r = new Report(9120);</span>
<span class="nc" id="L25307">                r.subject = aero.getId();</span>
<span class="nc bnc" id="L25308" title="All 2 branches missed.">                if (fuelroll &gt;= boomTarget) {</span>
                    // A chance to reroll the explosion with edge
<span class="nc bnc" id="L25310" title="All 2 branches missed.">                    if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25311" title="All 2 branches missed.">                            &amp;&amp; aero.getCrew().getOptions().booleanOption(</span>
                                    OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)) {
                        // Reporting this is funky because 9120 only has room for 2 choices. Replace it.
<span class="nc" id="L25314">                        r = new Report(9123);</span>
<span class="nc" id="L25315">                        r.subject = aero.getId();</span>
<span class="nc" id="L25316">                        r.newlines = 0;</span>
<span class="nc" id="L25317">                        reports.add(r);</span>
<span class="nc" id="L25318">                        aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25319">                        fuelroll = Compute.d6(2);</span>
                        // To explode, or not to explode
<span class="nc bnc" id="L25321" title="All 2 branches missed.">                        if (fuelroll &gt;= boomTarget) {</span>
<span class="nc" id="L25322">                            r = new Report(9124);</span>
<span class="nc" id="L25323">                            r.subject = aero.getId();</span>
                        } else {
<span class="nc" id="L25325">                            r = new Report(9122);</span>
<span class="nc" id="L25326">                            r.subject = aero.getId();</span>
<span class="nc" id="L25327">                            reports.add(r);</span>
<span class="nc" id="L25328">                            break;</span>
                        }
                    }
<span class="nc" id="L25331">                    r.choose(true);</span>
<span class="nc" id="L25332">                    reports.add(r);</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L25334" title="All 2 branches missed.">                    if (aero.isFighter()) {</span>
<span class="nc bnc" id="L25335" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L25336" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L25338" title="All 2 branches missed.">                                || (game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L25340" title="All 2 branches missed.">                                &amp;&amp; aero.isCondEjectFuel()))) {</span>
<span class="nc" id="L25341">                            reports.addAll(ejectEntity(aero, true, false));</span>
                        }
                    }
<span class="nc" id="L25344">                    reports.addAll(destroyEntity(aero, &quot;fuel explosion&quot;, false, false));</span>
                } else {
<span class="nc" id="L25346">                    r.choose(false);</span>
<span class="nc" id="L25347">                    reports.add(r);</span>
                }
                
<span class="nc" id="L25350">                aero.setFuelTankHit(true);</span>
<span class="nc" id="L25351">                break;</span>
            case Aero.CRIT_CREW:
                // pilot hit
<span class="nc" id="L25354">                r = new Report(6650);</span>
<span class="nc bnc" id="L25355" title="All 2 branches missed.">                if (aero.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L25356">                    r = new Report(6651);</span>
<span class="nc" id="L25357">                    r.subject = aero.getId();</span>
<span class="nc" id="L25358">                    reports.add(r);</span>
<span class="nc" id="L25359">                    break;</span>
<span class="nc bnc" id="L25360" title="All 2 branches missed.">                } else if (aero.hasAbility(OptionsConstants.MD_TSM_IMPLANT)) {</span>
<span class="nc" id="L25361">                    r = new Report(6652);</span>
<span class="nc" id="L25362">                    r.subject = aero.getId();</span>
<span class="nc" id="L25363">                    reports.add(r);</span>
<span class="nc" id="L25364">                    break;</span>
                }
<span class="nc bnc" id="L25366" title="All 4 branches missed.">                if ((aero instanceof SmallCraft) || (aero instanceof Jumpship)) {</span>
<span class="nc" id="L25367">                    r = new Report(9197);</span>
                }
<span class="nc bnc" id="L25369" title="All 4 branches missed.">                if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25370" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)
<span class="nc bnc" id="L25372" title="All 2 branches missed.">                        &amp;&amp; (aero.getIgnoredCrewHits() &lt; 2)) {</span>
<span class="nc" id="L25373">                    aero.setIgnoredCrewHits(aero.getIgnoredCrewHits() + 1);</span>
<span class="nc" id="L25374">                    r = new Report(9198);</span>
<span class="nc" id="L25375">                    r.subject = aero.getId();</span>
<span class="nc" id="L25376">                    reports.add(r);</span>
<span class="nc" id="L25377">                    break;</span>
                }
<span class="nc" id="L25379">                r.subject = aero.getId();</span>
<span class="nc" id="L25380">                reports.add(r);</span>
<span class="nc" id="L25381">                reports.addAll(damageCrew(aero, 1));</span>
                // The pilot may have just expired.
<span class="nc bnc" id="L25383" title="All 4 branches missed.">                if ((aero.getCrew().isDead() || aero.getCrew().isDoomed())</span>
<span class="nc bnc" id="L25384" title="All 2 branches missed.">                       &amp;&amp; !aero.getCrew().isEjected()) {</span>
<span class="nc" id="L25385">                    reports.addAll(destroyEntity(aero, &quot;pilot death&quot;, true, true));</span>
                }
                break;
            case Aero.CRIT_GEAR:
                // landing gear
<span class="nc" id="L25390">                r = new Report(9125);</span>
<span class="nc" id="L25391">                r.subject = aero.getId();</span>
<span class="nc" id="L25392">                reports.add(r);</span>
<span class="nc" id="L25393">                aero.setGearHit(true);</span>
<span class="nc" id="L25394">                break;</span>
            case Aero.CRIT_BOMB:
                // bomb destroyed
                // go through bomb list and choose one
<span class="nc" id="L25398">                List&lt;Mounted&gt; bombs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25399" title="All 2 branches missed.">                for (Mounted bomb : aero.getBombs()) {</span>
<span class="nc bnc" id="L25400" title="All 4 branches missed.">                    if (bomb.getType().isHittable() &amp;&amp; (bomb.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L25401">                        bombs.add(bomb);</span>
                    }
<span class="nc" id="L25403">                }</span>
<span class="nc bnc" id="L25404" title="All 2 branches missed.">                if (bombs.size() &gt; 0) {</span>
<span class="nc" id="L25405">                    Mounted hitbomb = bombs.get(Compute.randomInt(bombs.size()));</span>
<span class="nc" id="L25406">                    hitbomb.setShotsLeft(0);</span>
<span class="nc" id="L25407">                    hitbomb.setDestroyed(true);</span>
<span class="nc" id="L25408">                    r = new Report(9130);</span>
<span class="nc" id="L25409">                    r.subject = aero.getId();</span>
<span class="nc" id="L25410">                    r.add(hitbomb.getDesc());</span>
<span class="nc" id="L25411">                    reports.add(r);</span>
                    // If we are part of a squadron, we should recalculate
                    // the bomb salvo for the squadron
<span class="nc bnc" id="L25414" title="All 2 branches missed.">                    if (aero.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L25415">                        Entity e = game.getEntity(aero.getTransportId());</span>
<span class="nc bnc" id="L25416" title="All 2 branches missed.">                        if (e instanceof FighterSquadron) {</span>
<span class="nc" id="L25417">                            ((FighterSquadron) e).computeSquadronBombLoadout();</span>
                        }
                    }
<span class="nc" id="L25420">                } else {</span>
<span class="nc" id="L25421">                    r = new Report(9131);</span>
<span class="nc" id="L25422">                    r.subject = aero.getId();</span>
<span class="nc" id="L25423">                    reports.add(r);</span>
                }
<span class="nc" id="L25425">                break;</span>
            case Aero.CRIT_HEATSINK:
                // heat sink hit
<span class="nc" id="L25428">                int sinksLost = 1;</span>
<span class="nc bnc" id="L25429" title="All 2 branches missed.">                if (isCapital) {</span>
<span class="nc" id="L25430">                    sinksLost = 10;</span>
                }
<span class="nc" id="L25432">                r = new Report(9135);</span>
<span class="nc" id="L25433">                r.subject = aero.getId();</span>
<span class="nc" id="L25434">                r.add(sinksLost);</span>
<span class="nc" id="L25435">                reports.add(r);</span>
<span class="nc" id="L25436">                aero.setHeatSinks(Math.max(0, aero.getHeatSinks() - sinksLost));</span>
<span class="nc" id="L25437">                break;</span>
            case Aero.CRIT_WEAPON_BROAD:
<span class="nc bnc" id="L25439" title="All 2 branches missed.">                if (aero instanceof Warship) {</span>
<span class="nc bnc" id="L25440" title="All 4 branches missed.">                    if ((loc == Jumpship.LOC_ALS) || (loc == Jumpship.LOC_FLS)) {</span>
<span class="nc" id="L25441">                        loc = Warship.LOC_LBS;</span>
<span class="nc bnc" id="L25442" title="All 4 branches missed.">                    } else if ((loc == Jumpship.LOC_ARS)</span>
                               || (loc == Jumpship.LOC_FRS)) {
<span class="nc" id="L25444">                        loc = Warship.LOC_RBS;</span>
                    }
                }
            case Aero.CRIT_WEAPON:
<span class="nc bnc" id="L25448" title="All 2 branches missed.">                if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25449">                    boolean destroyAll = false;</span>
                    // CRIT_WEAPON damages the capital fighter/squadron's weapon groups
                    // Go ahead and map damage for the fighter's weapon criticals for MHQ
                    // resolution.
<span class="nc" id="L25453">                    aero.damageCapFighterWeapons(loc);</span>
<span class="nc bnc" id="L25454" title="All 4 branches missed.">                    if ((loc == Aero.LOC_NOSE) || (loc == Aero.LOC_AFT)) {</span>
<span class="nc" id="L25455">                        destroyAll = true;</span>
                    }
                    
                    // Convert L/R wing location to wings, else wing weapons never get hit
<span class="nc bnc" id="L25459" title="All 4 branches missed.">                    if (loc == Aero.LOC_LWING || loc == Aero.LOC_RWING) {</span>
<span class="nc" id="L25460">                        loc = Aero.LOC_WINGS;</span>
                    }
                    
<span class="nc bnc" id="L25463" title="All 2 branches missed.">                    if (loc == Aero.LOC_WINGS) {</span>
<span class="nc bnc" id="L25464" title="All 2 branches missed.">                        if (aero.areWingsHit()) {</span>
<span class="nc" id="L25465">                            destroyAll = true;</span>
                        } else {
<span class="nc" id="L25467">                            aero.setWingsHit(true);</span>
                        }
                    }
<span class="nc bnc" id="L25470" title="All 2 branches missed.">                    for (Mounted weapon : aero.getWeaponList()) {</span>
<span class="nc bnc" id="L25471" title="All 2 branches missed.">                        if (weapon.getLocation() == loc) {</span>
<span class="nc bnc" id="L25472" title="All 2 branches missed.">                            if (destroyAll) {</span>
<span class="nc" id="L25473">                                weapon.setHit(true);</span>
                            } else {
<span class="nc" id="L25475">                                weapon.setNWeapons(weapon.getNWeapons() / 2);</span>
                            }
                        }
<span class="nc" id="L25478">                    }</span>
                    // also destroy any ECM or BAP in the location hit
<span class="nc bnc" id="L25480" title="All 2 branches missed.">                    for (Mounted misc : aero.getMisc()) {</span>
<span class="nc bnc" id="L25481" title="All 2 branches missed.">                        if ((misc.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L25482" title="All 2 branches missed.">                            || misc.getType().hasFlag(MiscType.F_ANGEL_ECM)</span>
<span class="nc bnc" id="L25483" title="All 2 branches missed.">                            || misc.getType().hasFlag(MiscType.F_BAP))</span>
<span class="nc bnc" id="L25484" title="All 2 branches missed.">                                &amp;&amp; misc.getLocation() == loc) {</span>
<span class="nc" id="L25485">                            misc.setHit(true);</span>
                            //Taharqa: We should also damage the critical slot, or
                            //MM and MHQ won't remember that this weapon is damaged on the MUL
                            //file
<span class="nc bnc" id="L25489" title="All 2 branches missed.">                            for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25490">                                CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25491" title="All 2 branches missed.">                                if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25492" title="All 2 branches missed.">                                        (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25493">                                    continue;</span>
                                }
<span class="nc" id="L25495">                                Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25496" title="All 2 branches missed.">                                if (mounted.equals(misc)) {</span>
<span class="nc" id="L25497">                                    aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25498">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L25502">                    }</span>
<span class="nc" id="L25503">                    r = new Report(9152);</span>
<span class="nc" id="L25504">                    r.subject = aero.getId();</span>
<span class="nc" id="L25505">                    r.add(aero.getLocationName(loc));</span>
<span class="nc" id="L25506">                    reports.add(r);</span>
<span class="nc" id="L25507">                    break;</span>
                }
<span class="nc" id="L25509">                r = new Report(9150);</span>
<span class="nc" id="L25510">                r.subject = aero.getId();</span>
<span class="nc" id="L25511">                List&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25512" title="All 2 branches missed.">                for (Mounted weapon : aero.getWeaponList()) {</span>
<span class="nc bnc" id="L25513" title="All 4 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isDestroyed()</span>
<span class="nc bnc" id="L25514" title="All 2 branches missed.">                            &amp;&amp; weapon.getType().isHittable()) {</span>
<span class="nc" id="L25515">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L25517">                }</span>
                // add in in hittable misc equipment
<span class="nc bnc" id="L25519" title="All 2 branches missed.">                for (Mounted misc : aero.getMisc()) {</span>
<span class="nc bnc" id="L25520" title="All 2 branches missed.">                    if (misc.getType().isHittable()</span>
<span class="nc bnc" id="L25521" title="All 2 branches missed.">                        &amp;&amp; (misc.getLocation() == loc)</span>
<span class="nc bnc" id="L25522" title="All 2 branches missed.">                        &amp;&amp; !misc.isDestroyed()) {</span>
<span class="nc" id="L25523">                        weapons.add(misc);</span>
                    }
<span class="nc" id="L25525">                }</span>
<span class="nc bnc" id="L25526" title="All 2 branches missed.">                if (weapons.size() &gt; 0) {</span>
<span class="nc" id="L25527">                    Mounted weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
                    // possibly check for an ammo explosion
                    // don't allow ammo explosions on fighter squadrons
<span class="nc bnc" id="L25530" title="All 4 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AMMO_EXPLOSIONS)</span>
                        &amp;&amp; !(aero instanceof FighterSquadron)
<span class="nc bnc" id="L25532" title="All 2 branches missed.">                        &amp;&amp; (weapon.getType() instanceof WeaponType)) {</span>
                        //Bay Weapons
<span class="nc bnc" id="L25534" title="All 2 branches missed.">                        if (aero.usesWeaponBays()) {</span>
                            //Finish reporting(9150) a hit on the bay
<span class="nc" id="L25536">                            r.add(weapon.getName());</span>
<span class="nc" id="L25537">                            reports.add(r);</span>
                            //Pick a random weapon in the bay and get the stats
<span class="nc" id="L25539">                            int wId = weapon.getBayWeapons().get(Compute.randomInt(weapon.getBayWeapons().size()));</span>
<span class="nc" id="L25540">                            Mounted bayW = aero.getEquipment(wId);</span>
<span class="nc" id="L25541">                            Mounted bayWAmmo = bayW.getLinked();</span>
<span class="nc bnc" id="L25542" title="All 4 branches missed.">                            if (bayWAmmo != null &amp;&amp; bayWAmmo.getType().isExplosive(bayWAmmo)) {</span>
<span class="nc" id="L25543">                                r = new Report(9156);</span>
<span class="nc" id="L25544">                                r.subject = aero.getId();</span>
<span class="nc" id="L25545">                                r.newlines = 1;</span>
<span class="nc" id="L25546">                                r.indent(2);</span>
                                //On a roll of 10+, the ammo bin explodes
<span class="nc" id="L25548">                                int ammoRoll = Compute.d6(2);</span>
<span class="nc" id="L25549">                                boomTarget = 10;</span>
<span class="nc bnc" id="L25550" title="All 2 branches missed.">                                r.choose(ammoRoll &gt;= boomTarget);</span>
                                // A chance to reroll an explosion with edge
<span class="nc bnc" id="L25552" title="All 2 branches missed.">                                if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25553" title="All 4 branches missed.">                                        &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)</span>
                                        &amp;&amp; ammoRoll &gt;= boomTarget) {
                                    // Report 9156 doesn't offer the right choices. Replace it.
<span class="nc" id="L25556">                                    r = new Report(9158);</span>
<span class="nc" id="L25557">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25558">                                    r.newlines = 0;</span>
<span class="nc" id="L25559">                                    r.indent(2);</span>
<span class="nc" id="L25560">                                    reports.add(r);</span>
<span class="nc" id="L25561">                                    aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25562">                                    ammoRoll = Compute.d6(2);</span>
                                    // To explode, or not to explode
<span class="nc bnc" id="L25564" title="All 2 branches missed.">                                    if (ammoRoll &gt;= boomTarget) {</span>
<span class="nc" id="L25565">                                        reports.addAll(explodeEquipment(aero, loc, bayWAmmo));</span>
                                    } else {
<span class="nc" id="L25567">                                        r = new Report(9157);</span>
<span class="nc" id="L25568">                                        r.subject = aero.getId();</span>
<span class="nc" id="L25569">                                        reports.add(r);</span>
                                    }
                                } else {
                                    //Finish handling report 9156
<span class="nc" id="L25573">                                    reports.add(r);</span>
<span class="nc bnc" id="L25574" title="All 2 branches missed.">                                    if (ammoRoll &gt;= boomTarget) {</span>
<span class="nc" id="L25575">                                        reports.addAll(explodeEquipment(aero, loc, bayWAmmo));</span>
                                    }
                                }
                            }
                            //Hit the weapon then also hit all the other weapons in the bay
<span class="nc" id="L25580">                            weapon.setHit(true);</span>
<span class="nc bnc" id="L25581" title="All 2 branches missed.">                            for(int next : weapon.getBayWeapons()) {</span>
<span class="nc" id="L25582">                                Mounted bayWeap = aero.getEquipment(next);</span>
<span class="nc bnc" id="L25583" title="All 2 branches missed.">                                if(null != bayWeap) {</span>
<span class="nc" id="L25584">                                    bayWeap.setHit(true);</span>
                                    //Taharqa: We should also damage the critical slot, or
                                    //MM and MHQ won't remember that this weapon is damaged on the MUL
                                    //file
<span class="nc bnc" id="L25588" title="All 2 branches missed.">                                    for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25589">                                        CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25590" title="All 2 branches missed.">                                        if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25591" title="All 2 branches missed.">                                                (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25592">                                            continue;</span>
                                        }
<span class="nc" id="L25594">                                        Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25595" title="All 2 branches missed.">                                        if (mounted.equals(bayWeap)) {</span>
<span class="nc" id="L25596">                                            aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25597">                                            break;</span>
                                        }
                                    }
                                }
<span class="nc" id="L25601">                            }</span>
<span class="nc" id="L25602">                            break;</span>
                        }
                        // does it use Ammo?
<span class="nc" id="L25605">                        WeaponType wtype = (WeaponType) weapon.getType();</span>
<span class="nc bnc" id="L25606" title="All 2 branches missed.">                        if (wtype.getAmmoType() != AmmoType.T_NA) {</span>
<span class="nc" id="L25607">                            Mounted m = weapon.getLinked();</span>
<span class="nc" id="L25608">                            int ammoroll = Compute.d6(2);</span>
<span class="nc bnc" id="L25609" title="All 2 branches missed.">                            if (ammoroll &gt;= 10) {</span>
                                // A chance to reroll an explosion with edge
<span class="nc bnc" id="L25611" title="All 2 branches missed.">                                if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25612" title="All 2 branches missed.">                                        &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)) {</span>
<span class="nc" id="L25613">                                    aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25614">                                    r = new Report(6530);</span>
<span class="nc" id="L25615">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25616">                                    r.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25617">                                    reports.add(r);</span>
<span class="nc" id="L25618">                                    ammoroll = Compute.d6(2);</span>
<span class="nc bnc" id="L25619" title="All 2 branches missed.">                                    if (ammoroll &gt;= 10) {</span>
<span class="nc" id="L25620">                                        reports.addAll(explodeEquipment(aero, loc, m));</span>
<span class="nc" id="L25621">                                        break;</span>
                                    } else {
                                        //Crisis averted, set report 9150 back up
<span class="nc" id="L25624">                                        r = new Report(9150);</span>
<span class="nc" id="L25625">                                        r.subject = aero.getId();</span>
                                    }
                                } else {
<span class="nc" id="L25628">                                    r = new Report(9151);</span>
<span class="nc" id="L25629">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25630">                                    r.add(m.getName());</span>
<span class="nc" id="L25631">                                    r.newlines = 0;</span>
<span class="nc" id="L25632">                                    reports.add(r);</span>
<span class="nc" id="L25633">                                    reports.addAll(explodeEquipment(aero, loc, m));</span>
<span class="nc" id="L25634">                                    break;</span>
                                }
                            }
                        }
                    }
                    // If the weapon is explosive, use edge to roll up a new one
<span class="nc bnc" id="L25640" title="All 2 branches missed.">                    if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25641" title="All 2 branches missed.">                            &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)</span>
<span class="nc bnc" id="L25642" title="All 4 branches missed.">                            &amp;&amp; (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L25643" title="All 2 branches missed.">                                    &amp;&amp; !weapon.isDestroyed())) {</span>
<span class="nc" id="L25644">                        aero.getCrew().decreaseEdge();</span>
                        //Try something new for an interrupting report. r is still 9150.
<span class="nc" id="L25646">                        Report r1 = new Report(6530);</span>
<span class="nc" id="L25647">                        r1.subject = aero.getId();</span>
<span class="nc" id="L25648">                        r1.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25649">                        reports.add(r1);</span>
<span class="nc" id="L25650">                        weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
                    }
<span class="nc" id="L25652">                    r.add(weapon.getName());</span>
<span class="nc" id="L25653">                    reports.add(r);</span>
                    // explosive weapons e.g. gauss now explode
<span class="nc bnc" id="L25655" title="All 4 branches missed.">                    if (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L25656" title="All 2 branches missed.">                        &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L25657">                        reports.addAll(explodeEquipment(aero, loc, weapon));</span>
                    }
<span class="nc" id="L25659">                    weapon.setHit(true);</span>
                    //Taharqa: We should also damage the critical slot, or
                    //MM and MHQ won't remember that this weapon is damaged on the MUL
                    //file
<span class="nc bnc" id="L25663" title="All 2 branches missed.">                    for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25664">                        CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25665" title="All 2 branches missed.">                        if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25666" title="All 2 branches missed.">                                (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25667">                            continue;</span>
                        }
<span class="nc" id="L25669">                        Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25670" title="All 2 branches missed.">                        if (mounted.equals(weapon)) {</span>
<span class="nc" id="L25671">                            aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25672">                            break;</span>
                        }
                    }
                    //if this is a weapons bay then also hit all the other weapons
<span class="nc bnc" id="L25676" title="All 2 branches missed.">                    for(int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L25677">                        Mounted bayWeap = aero.getEquipment(wId);</span>
<span class="nc bnc" id="L25678" title="All 2 branches missed.">                        if(null != bayWeap) {</span>
<span class="nc" id="L25679">                            bayWeap.setHit(true);</span>
                            //Taharqa: We should also damage the critical slot, or
                            //MM and MHQ won't remember that this weapon is damaged on the MUL
                            //file
<span class="nc bnc" id="L25683" title="All 2 branches missed.">                            for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25684">                                CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25685" title="All 2 branches missed.">                                if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25686" title="All 2 branches missed.">                                        (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25687">                                    continue;</span>
                                }
<span class="nc" id="L25689">                                Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25690" title="All 2 branches missed.">                                if (mounted.equals(bayWeap)) {</span>
<span class="nc" id="L25691">                                    aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25692">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L25696">                    }</span>
<span class="nc" id="L25697">                } else {</span>
<span class="nc" id="L25698">                    r = new Report(9155);</span>
<span class="nc" id="L25699">                    r.subject = aero.getId();</span>
<span class="nc" id="L25700">                    reports.add(r);</span>
                }
<span class="nc" id="L25702">                break;</span>
            case Aero.CRIT_ENGINE:
                // engine hit
<span class="nc" id="L25705">                r = new Report(9140);</span>
<span class="nc" id="L25706">                r.subject = aero.getId();</span>
<span class="nc" id="L25707">                reports.add(r);</span>
<span class="nc" id="L25708">                aero.engineHitsThisPhase++;</span>
<span class="nc" id="L25709">                boolean engineExploded = checkEngineExplosion(aero, reports, 1);</span>
<span class="nc" id="L25710">                aero.setEngineHits(aero.getEngineHits() + 1);</span>
<span class="nc bnc" id="L25711" title="All 4 branches missed.">                if ((aero.getEngineHits() &gt;= aero.getMaxEngineHits())</span>
                    || engineExploded) {
                    // this engine hit puts the ASF out of commission
<span class="nc" id="L25714">                    reports.addAll(destroyEntity(aero, &quot;engine destruction&quot;, true,</span>
                                               true));
<span class="nc" id="L25716">                    aero.setSelfDestructing(false);</span>
<span class="nc" id="L25717">                    aero.setSelfDestructInitiated(false);</span>
                }
                break;
            case Aero.CRIT_LEFT_THRUSTER:
                // thruster hit
<span class="nc" id="L25722">                r = new Report(9160);</span>
<span class="nc" id="L25723">                r.subject = aero.getId();</span>
<span class="nc" id="L25724">                reports.add(r);</span>
<span class="nc" id="L25725">                aero.setLeftThrustHits(aero.getLeftThrustHits() + 1);</span>
<span class="nc" id="L25726">                break;</span>
            case Aero.CRIT_RIGHT_THRUSTER:
                // thruster hit
<span class="nc" id="L25729">                r = new Report(9160);</span>
<span class="nc" id="L25730">                r.subject = aero.getId();</span>
<span class="nc" id="L25731">                reports.add(r);</span>
<span class="nc" id="L25732">                aero.setRightThrustHits(aero.getRightThrustHits() + 1);</span>
<span class="nc" id="L25733">                break;</span>
            case Aero.CRIT_CARGO:
<span class="nc" id="L25735">                applyCargoCritical(aero, damageCaused, reports);</span>
<span class="nc" id="L25736">                break;</span>
            case Aero.CRIT_DOOR:
                // door hit
                // choose a random bay
<span class="nc" id="L25740">                String bayType = aero.damageBayDoor();</span>
<span class="nc bnc" id="L25741" title="All 2 branches missed.">                if (!bayType.equals(&quot;none&quot;)) {</span>
<span class="nc" id="L25742">                    r = new Report(9170);</span>
<span class="nc" id="L25743">                    r.subject = aero.getId();</span>
<span class="nc" id="L25744">                    r.add(bayType);</span>
<span class="nc" id="L25745">                    reports.add(r);</span>
                } else {
<span class="nc" id="L25747">                    r = new Report(9171);</span>
<span class="nc" id="L25748">                    r.subject = aero.getId();</span>
<span class="nc" id="L25749">                    reports.add(r);</span>
                }
<span class="nc" id="L25751">                break;</span>
            case Aero.CRIT_DOCK_COLLAR:
                // docking collar hit
                // different effect for DropShips and JumpShips
<span class="nc bnc" id="L25755" title="All 2 branches missed.">                if (aero instanceof Dropship) {</span>
<span class="nc" id="L25756">                    ((Dropship)aero).setDamageDockCollar(true);</span>
<span class="nc" id="L25757">                    r = new Report(9175);</span>
<span class="nc" id="L25758">                    r.subject = aero.getId();</span>
<span class="nc" id="L25759">                    reports.add(r);</span>
                }
<span class="nc bnc" id="L25761" title="All 2 branches missed.">                if (aero instanceof Jumpship) {</span>
                    // damage a random docking collar
<span class="nc bnc" id="L25763" title="All 2 branches missed.">                    if (aero.damageDockCollar()) {</span>
<span class="nc" id="L25764">                        r = new Report(9176);</span>
<span class="nc" id="L25765">                        r.subject = aero.getId();</span>
<span class="nc" id="L25766">                        reports.add(r);</span>
                    } else {
<span class="nc" id="L25768">                        r = new Report(9177);</span>
<span class="nc" id="L25769">                        r.subject = aero.getId();</span>
<span class="nc" id="L25770">                        reports.add(r);</span>
                    }
                }
                break;
            case Aero.CRIT_KF_BOOM:
                // KF boom hit
                // no real effect yet
<span class="nc bnc" id="L25777" title="All 2 branches missed.">                if (aero instanceof Dropship) {</span>
<span class="nc" id="L25778">                    ((Dropship)aero).setDamageKFBoom(true);</span>
<span class="nc" id="L25779">                    r = new Report(9180);</span>
<span class="nc" id="L25780">                    r.subject = aero.getId();</span>
<span class="nc" id="L25781">                    reports.add(r);</span>
                }
                break;
            case Aero.CRIT_CIC:
<span class="nc bnc" id="L25785" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L25786">                    break;</span>
                }
                // CIC hit
<span class="nc" id="L25789">                r = new Report(9185);</span>
<span class="nc" id="L25790">                r.subject = aero.getId();</span>
<span class="nc" id="L25791">                reports.add(r);</span>
<span class="nc" id="L25792">                js.setCICHits(js.getCICHits() + 1);</span>
<span class="nc" id="L25793">                break;</span>
            case Aero.CRIT_KF_DRIVE:
                //Per SO construction rules, stations have no KF drive, therefore they can't take a hit to it...
<span class="nc bnc" id="L25796" title="All 4 branches missed.">                if (js == null || js instanceof SpaceStation) {</span>
<span class="nc" id="L25797">                    break;</span>
                }
                // KF Drive hit - damage the drive integrity
<span class="nc" id="L25800">                js.setKFIntegrity(Math.max(0, (js.getKFIntegrity() - 1)));</span>
<span class="nc bnc" id="L25801" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_EXPANDED_KF_DRIVE_DAMAGE)) {</span>
                    //Randomize the component struck - probabilities taken from the old BattleSpace record sheets
<span class="nc bnc" id="L25803" title="All 7 branches missed.">                    switch (Compute.d6(2)) {</span>
                    case 2:
                        //Drive Coil Hit
<span class="nc" id="L25806">                        r = new Report(9186);</span>
<span class="nc" id="L25807">                        r.subject = aero.getId();</span>
<span class="nc" id="L25808">                        reports.add(r);</span>
<span class="nc" id="L25809">                        js.setKFDriveCoilHit(true);</span>
<span class="nc" id="L25810">                        break;</span>
                    case 3:
                    case 11:
                        //Charging System Hit
<span class="nc" id="L25814">                        r = new Report(9187);</span>
<span class="nc" id="L25815">                        r.subject = aero.getId();</span>
<span class="nc" id="L25816">                        reports.add(r);</span>
<span class="nc" id="L25817">                        js.setKFChargingSystemHit(true);</span>
<span class="nc" id="L25818">                        break;</span>
                    case 5:
                        //Field Initiator Hit
<span class="nc" id="L25821">                        r = new Report(9190);</span>
<span class="nc" id="L25822">                        r.subject = aero.getId();</span>
<span class="nc" id="L25823">                        reports.add(r);</span>
<span class="nc" id="L25824">                        js.setKFFieldInitiatorHit(true);</span>
<span class="nc" id="L25825">                        break;</span>
                    case 4:
                    case 6:
                    case 7:
                    case 8:
                        //Helium Tank Hit
<span class="nc" id="L25831">                        r = new Report(9189);</span>
<span class="nc" id="L25832">                        r.subject = aero.getId();</span>
<span class="nc" id="L25833">                        reports.add(r);</span>
<span class="nc" id="L25834">                        js.setKFHeliumTankHit(true);</span>
<span class="nc" id="L25835">                        break;</span>
                    case 9:
                        //Drive Controller Hit
<span class="nc" id="L25838">                        r = new Report(9191);</span>
<span class="nc" id="L25839">                        r.subject = aero.getId();</span>
<span class="nc" id="L25840">                        reports.add(r);</span>
<span class="nc" id="L25841">                        js.setKFDriveControllerHit(true);</span>
<span class="nc" id="L25842">                        break;</span>
                    case 10:
                    case 12:
                        //LF Battery Hit - if you don't have one, treat as helium tank
<span class="nc bnc" id="L25846" title="All 2 branches missed.">                        if (js.hasLF()) {</span>
<span class="nc" id="L25847">                            r = new Report(9188);</span>
<span class="nc" id="L25848">                            r.subject = aero.getId();</span>
<span class="nc" id="L25849">                            reports.add(r);</span>
<span class="nc" id="L25850">                            js.setLFBatteryHit(true);</span>
                        } else {
<span class="nc" id="L25852">                            r = new Report(9189);</span>
<span class="nc" id="L25853">                            r.subject = aero.getId();</span>
<span class="nc" id="L25854">                            reports.add(r);</span>
<span class="nc" id="L25855">                            js.setKFHeliumTankHit(true);</span>
                        }
<span class="nc" id="L25857">                        break;</span>
                    }
                } else {
                    //Just report the standard KF hit, per SO rules
<span class="nc" id="L25861">                    r = new Report(9194);</span>
<span class="nc" id="L25862">                    r.subject = aero.getId();</span>
<span class="nc" id="L25863">                    reports.add(r);</span>
                }
<span class="nc" id="L25865">                break;</span>
            case Aero.CRIT_GRAV_DECK:
<span class="nc bnc" id="L25867" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L25868">                    break;</span>
                }
<span class="nc" id="L25870">                int choice = Compute.randomInt(js.getTotalGravDeck());</span>
                // Grav Deck hit
<span class="nc" id="L25872">                r = new Report(9195);</span>
<span class="nc" id="L25873">                r.subject = aero.getId();</span>
<span class="nc" id="L25874">                reports.add(r);</span>
<span class="nc" id="L25875">                js.setGravDeckDamageFlag(choice, 1);</span>
<span class="nc" id="L25876">                break;</span>
            case Aero.CRIT_LIFE_SUPPORT:
                // Life Support hit
<span class="nc" id="L25879">                aero.setLifeSupport(false);</span>
<span class="nc" id="L25880">                r = new Report(9196);</span>
<span class="nc" id="L25881">                r.subject = aero.getId();</span>
<span class="nc" id="L25882">                reports.add(r);</span>
                break;
        }
<span class="nc" id="L25885">        return reports;</span>
    }

    /**
     * Selects random undestroyed bay and applies damage, destroying loaded units where applicable.
     *
     * @param aero           The unit that received the cargo critical.
     * @param damageCaused   The amount of damage applied by the hit that resulted in the cargo critical.
     * @param reports        Used to return any report generated while applying the critical.
     */
    private void applyCargoCritical(Aero aero, int damageCaused, Vector&lt;Report&gt; reports) {
        Report r;
        // cargo hit
        // First what percentage of the cargo did the hit destroy?
<span class="nc" id="L25899">        double percentDestroyed = 0.0;</span>
<span class="nc" id="L25900">        double mult = 2.0;</span>
<span class="nc bnc" id="L25901" title="All 4 branches missed.">        if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25902" title="All 2 branches missed.">            &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)) {</span>
<span class="nc" id="L25903">            mult = 4.0;</span>
        }
<span class="nc bnc" id="L25905" title="All 2 branches missed.">        if (damageCaused &gt; 0) {</span>
<span class="nc" id="L25906">            percentDestroyed = Math.min(</span>
<span class="nc" id="L25907">                    damageCaused / (mult * aero.getSI()), 1.0);</span>
        }
        List&lt;Bay&gt; bays;
<span class="nc" id="L25910">        double destroyed = 0;</span>
        // did it hit cargo or units
<span class="nc" id="L25912">        int roll = Compute.d6(1);</span>
        // A hit on a bay filled with transported units is devastating
        // allow a reroll with edge
<span class="nc bnc" id="L25915" title="All 2 branches missed.">        if (aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_UNIT_CARGO_LOST)</span>
<span class="nc bnc" id="L25916" title="All 4 branches missed.">                &amp;&amp; aero.getCrew().hasEdgeRemaining() &amp;&amp; roll &gt; 3) {</span>
<span class="nc" id="L25917">            aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25918">            r = new Report(9172);</span>
<span class="nc" id="L25919">            r.subject = aero.getId();</span>
<span class="nc" id="L25920">            r.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25921">            reports.add(r);</span>
            //Reroll. Maybe we'll hit cargo.
<span class="nc" id="L25923">            roll = Compute.d6(1);</span>
        }
<span class="nc bnc" id="L25925" title="All 2 branches missed.">        if (roll &lt; 4) {</span>
<span class="nc" id="L25926">            bays = aero.getTransportBays().stream().filter(Bay::isCargo).collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L25928">            bays = aero.getTransportBays().stream()</span>
<span class="nc bnc" id="L25929" title="All 4 branches missed.">                    .filter(b -&gt; !b.isCargo() &amp;&amp; !b.isQuarters()).collect(Collectors.toList());</span>
        }
<span class="nc" id="L25931">        Bay hitBay = null;</span>
<span class="nc bnc" id="L25932" title="All 4 branches missed.">        while ((null == hitBay) &amp;&amp; !bays.isEmpty()) {</span>
<span class="nc" id="L25933">            hitBay = bays.remove(Compute.randomInt(bays.size()));</span>
<span class="nc bnc" id="L25934" title="All 2 branches missed.">            if (hitBay.getBayDamage() &lt; hitBay.getCapacity()) {</span>
<span class="nc bnc" id="L25935" title="All 2 branches missed.">                if (hitBay.isCargo()) {</span>
<span class="nc" id="L25936">                    destroyed = (hitBay.getCapacity() * percentDestroyed * 2.0) / 2.0;</span>
                } else {
<span class="nc" id="L25938">                    destroyed = Math.ceil(hitBay.getCapacity() * percentDestroyed);</span>
                }
            } else {
<span class="nc" id="L25941">                hitBay = null;</span>
            }
        }
<span class="nc bnc" id="L25944" title="All 2 branches missed.">        if (null != hitBay) {</span>
<span class="nc" id="L25945">            destroyed = Math.min(destroyed, hitBay.getCapacity() - hitBay.getBayDamage());</span>
<span class="nc bnc" id="L25946" title="All 2 branches missed.">            if (hitBay.isCargo()) {</span>
<span class="nc" id="L25947">                r = new Report(9165);</span>
            } else {
<span class="nc" id="L25949">                r = new Report(9166);</span>
            }
<span class="nc" id="L25951">            r.subject = aero.getId();</span>
<span class="nc" id="L25952">            r.add(hitBay.getBayNumber());</span>
<span class="nc bnc" id="L25953" title="All 2 branches missed.">            if (destroyed == (int) destroyed) {</span>
<span class="nc" id="L25954">                r.add((int) destroyed);</span>
            } else {
<span class="nc" id="L25956">                r.add(String.valueOf(Math.ceil(destroyed * 2.0) / 2.0));</span>
            }
<span class="nc" id="L25958">            reports.add(r);</span>
<span class="nc bnc" id="L25959" title="All 2 branches missed.">            if (!hitBay.isCargo()) {</span>
<span class="nc" id="L25960">                List&lt;Entity&gt; units = new ArrayList&lt;&gt;(hitBay.getLoadedUnits());</span>
<span class="nc" id="L25961">                List&lt;Entity&gt; toRemove = new ArrayList&lt;&gt;();</span>
                //We're letting destroyed units stay in the bay now, but take them off the targets list
<span class="nc bnc" id="L25963" title="All 2 branches missed.">                for (Entity en : units) {</span>
<span class="nc bnc" id="L25964" title="All 4 branches missed.">                    if (en.isDestroyed() || en.isDoomed()) {</span>
<span class="nc" id="L25965">                        toRemove.add(en);</span>
                    }
<span class="nc" id="L25967">                }</span>
<span class="nc" id="L25968">                units.removeAll(toRemove);</span>
<span class="nc bnc" id="L25969" title="All 4 branches missed.">                while ((destroyed &gt; 0) &amp;&amp; !units.isEmpty()) {</span>
<span class="nc" id="L25970">                    Entity target = units.remove(Compute.randomInt(units.size()));</span>
<span class="nc" id="L25971">                    reports.addAll(destroyEntity(target, &quot;cargo damage&quot;,</span>
                            false, true));
<span class="nc" id="L25973">                    destroyed--;</span>
<span class="nc" id="L25974">                }</span>
<span class="nc" id="L25975">            }</span>
        } else {
<span class="nc" id="L25977">            r = new Report(9167);</span>
<span class="nc" id="L25978">            r.subject = aero.getId();</span>
<span class="nc bnc" id="L25979" title="All 2 branches missed.">            r.choose(roll &lt; 4); // cargo or transport</span>
<span class="nc" id="L25980">            reports.add(r);</span>
        }
<span class="nc" id="L25982">    }</span>

    /**
     * Apply a single critical hit to a vehicle.
     *
     * @param tank             the &lt;code&gt;Tank&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to &lt;code&gt;Tank&lt;/code&gt;s and
     *                         for hits to a &lt;code&gt;Protomech&lt;/code&gt; torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;. The index of the slot should be the index
     *                         of the critical hit table.
     * @param damageCaused     the amount of damage causing this critical.
     */
    private Vector&lt;Report&gt; applyTankCritical(Tank tank, int loc, CriticalSlot cs, int damageCaused) {
<span class="nc" id="L25998">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
        HitData hit;
<span class="nc bnc" id="L26001" title="All 22 branches missed.">        switch (cs.getIndex()) {</span>
            case Tank.CRIT_NONE:
                // no effect
<span class="nc" id="L26004">                r = new Report(6005);</span>
<span class="nc" id="L26005">                r.subject = tank.getId();</span>
<span class="nc" id="L26006">                reports.add(r);</span>
<span class="nc" id="L26007">                break;</span>
            case Tank.CRIT_AMMO:
                // ammo explosion
<span class="nc" id="L26010">                r = new Report(6610);</span>
<span class="nc" id="L26011">                r.subject = tank.getId();</span>
<span class="nc" id="L26012">                reports.add(r);</span>
<span class="nc" id="L26013">                int damage = 0;</span>
<span class="nc bnc" id="L26014" title="All 2 branches missed.">                for (Mounted m : tank.getAmmo()) {</span>
                    // Don't include ammo of one-shot weapons.
<span class="nc bnc" id="L26016" title="All 2 branches missed.">                    if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L26017">                        continue;</span>
                    }
<span class="nc" id="L26019">                    m.setHit(true);</span>
<span class="nc" id="L26020">                    int tmp = m.getHittableShotsLeft()</span>
<span class="nc" id="L26021">                              * ((AmmoType) m.getType()).getDamagePerShot()</span>
<span class="nc" id="L26022">                              * ((AmmoType) m.getType()).getRackSize();</span>
<span class="nc" id="L26023">                    m.setShotsLeft(0);</span>
                    // non-explosive ammo can't explode
<span class="nc bnc" id="L26025" title="All 2 branches missed.">                    if (!m.getType().isExplosive(m)) {</span>
<span class="nc" id="L26026">                        continue;</span>
                    }
<span class="nc" id="L26028">                    damage += tmp;</span>
<span class="nc" id="L26029">                    r = new Report(6390);</span>
<span class="nc" id="L26030">                    r.subject = tank.getId();</span>
<span class="nc" id="L26031">                    r.add(m.getName());</span>
<span class="nc" id="L26032">                    r.add(tmp);</span>
<span class="nc" id="L26033">                    reports.add(r);</span>
<span class="nc" id="L26034">                }</span>
<span class="nc" id="L26035">                hit = new HitData(loc);</span>
<span class="nc" id="L26036">                reports.addAll(damageEntity(tank, hit, damage, true));</span>
<span class="nc" id="L26037">                break;</span>
            case Tank.CRIT_CARGO:
                // Cargo/infantry damage
<span class="nc" id="L26040">                r = new Report(6615);</span>
<span class="nc" id="L26041">                r.subject = tank.getId();</span>
<span class="nc" id="L26042">                reports.add(r);</span>
<span class="nc" id="L26043">                List&lt;Entity&gt; passengers = tank.getLoadedUnits();</span>
<span class="nc bnc" id="L26044" title="All 2 branches missed.">                if (passengers.size() &gt; 0) {</span>
<span class="nc" id="L26045">                    Entity target = passengers.get(Compute.randomInt(passengers.size()));</span>
<span class="nc" id="L26046">                    hit = target.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L26047">                    reports.addAll(damageEntity(target, hit, damageCaused));</span>
<span class="nc" id="L26048">                }</span>
                break;
            case Tank.CRIT_COMMANDER:
<span class="nc bnc" id="L26051" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26052" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26053">                    r = new Report(6191);</span>
<span class="nc" id="L26054">                    r.subject = tank.getId();</span>
<span class="nc" id="L26055">                    reports.add(r);</span>
<span class="nc" id="L26056">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26058" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26059" title="All 2 branches missed.">                        &amp;&amp; !tank.isCommanderHitPS()) {</span>
<span class="nc" id="L26060">                        r = new Report(6606);</span>
<span class="nc" id="L26061">                        r.subject = tank.getId();</span>
<span class="nc" id="L26062">                        reports.add(r);</span>
<span class="nc" id="L26063">                        tank.setCommanderHitPS(true);</span>
<span class="nc bnc" id="L26064" title="All 2 branches missed.">                    } else if (tank.hasWorkingMisc(MiscType.F_COMMAND_CONSOLE)</span>
<span class="nc bnc" id="L26065" title="All 2 branches missed.">                            &amp;&amp; !tank.isUsingConsoleCommander()) {</span>
<span class="nc" id="L26066">                        r = new Report(6607);</span>
<span class="nc" id="L26067">                        r.subject = tank.getId();</span>
<span class="nc" id="L26068">                        reports.add(r);</span>
<span class="nc" id="L26069">                        tank.setUsingConsoleCommander(true);</span>
                    } else {
<span class="nc" id="L26071">                        r = new Report(6605);</span>
<span class="nc" id="L26072">                        r.subject = tank.getId();</span>
<span class="nc" id="L26073">                        reports.add(r);</span>
<span class="nc" id="L26074">                        tank.setCommanderHit(true);</span>
                    }
                }
                // fall through here, because effects of crew stunned also
                // apply
            case Tank.CRIT_CREW_STUNNED:
<span class="nc bnc" id="L26080" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26081" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26082">                    r = new Report(6191);</span>
<span class="nc" id="L26083">                    r.subject = tank.getId();</span>
<span class="nc" id="L26084">                    reports.add(r);</span>
<span class="nc" id="L26085">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26087" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26088" title="All 2 branches missed.">                            || tank.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L26089">                        r = new Report(6186);</span>
                    } else {
<span class="nc" id="L26091">                        tank.stunCrew();</span>
<span class="nc" id="L26092">                        r = new Report(6185);</span>
<span class="nc" id="L26093">                        r.add(tank.getStunnedTurns() - 1);</span>
                    }
<span class="nc" id="L26095">                    r.subject = tank.getId();</span>
<span class="nc" id="L26096">                    reports.add(r);</span>
                }
<span class="nc" id="L26098">                break;</span>
            case Tank.CRIT_DRIVER:
<span class="nc bnc" id="L26100" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26101" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26102">                    r = new Report(6191);</span>
<span class="nc" id="L26103">                    r.subject = tank.getId();</span>
<span class="nc" id="L26104">                    reports.add(r);</span>
<span class="nc" id="L26105">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26107" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26108" title="All 2 branches missed.">                        &amp;&amp; !tank.isDriverHitPS()) {</span>
<span class="nc" id="L26109">                        r = new Report(6601);</span>
<span class="nc" id="L26110">                        r.subject = tank.getId();</span>
<span class="nc" id="L26111">                        reports.add(r);</span>
<span class="nc" id="L26112">                        tank.setDriverHitPS(true);</span>
                    } else {
<span class="nc" id="L26114">                        r = new Report(6600);</span>
<span class="nc" id="L26115">                        r.subject = tank.getId();</span>
<span class="nc" id="L26116">                        reports.add(r);</span>
<span class="nc" id="L26117">                        tank.setDriverHit(true);</span>
                    }
                }
<span class="nc" id="L26120">                break;</span>
            case Tank.CRIT_CREW_KILLED:
<span class="nc bnc" id="L26122" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26123" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26124">                    r = new Report(6191);</span>
<span class="nc" id="L26125">                    r.subject = tank.getId();</span>
<span class="nc" id="L26126">                    reports.add(r);</span>
<span class="nc" id="L26127">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26129" title="All 4 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT) &amp;&amp; !tank.isCrewHitPS()) {</span>
<span class="nc" id="L26130">                        r = new Report(6191);</span>
<span class="nc" id="L26131">                        r.subject = tank.getId();</span>
<span class="nc" id="L26132">                        reports.add(r);</span>
<span class="nc" id="L26133">                        tank.setCrewHitPS(true);</span>
                    } else {
<span class="nc" id="L26135">                        r = new Report(6190);</span>
<span class="nc" id="L26136">                        r.subject = tank.getId();</span>
<span class="nc" id="L26137">                        reports.add(r);</span>
<span class="nc" id="L26138">                        tank.getCrew().setDoomed(true);</span>
<span class="nc bnc" id="L26139" title="All 2 branches missed.">                        if (tank.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L26140">                            reports.addAll(crashVTOLorWiGE(tank));</span>
                        }
                    }
                }
                break;
            case Tank.CRIT_ENGINE:
<span class="nc" id="L26146">                r = new Report(6210);</span>
<span class="nc" id="L26147">                r.subject = tank.getId();</span>
<span class="nc" id="L26148">                reports.add(r);</span>
<span class="nc" id="L26149">                tank.engineHit();</span>
<span class="nc" id="L26150">                tank.engineHitsThisPhase++;</span>
<span class="nc" id="L26151">                boolean engineExploded = checkEngineExplosion(tank, reports, 1);</span>
<span class="nc bnc" id="L26152" title="All 2 branches missed.">                if (engineExploded) {</span>
<span class="nc" id="L26153">                    reports.addAll(destroyEntity(tank, &quot;engine destruction&quot;, true, true));</span>
<span class="nc" id="L26154">                    tank.setSelfDestructing(false);</span>
<span class="nc" id="L26155">                    tank.setSelfDestructInitiated(false);</span>
                }
<span class="nc bnc" id="L26157" title="All 2 branches missed.">                if (tank.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L26158" title="All 4 branches missed.">                    &amp;&amp; !(tank.isDestroyed() || tank.isDoomed())) {</span>
<span class="nc" id="L26159">                    tank.immobilize();</span>
<span class="nc" id="L26160">                    reports.addAll(forceLandVTOLorWiGE(tank));</span>
                }
                break;
            case Tank.CRIT_FUEL_TANK:
<span class="nc" id="L26164">                r = new Report(6215);</span>
<span class="nc" id="L26165">                r.subject = tank.getId();</span>
<span class="nc" id="L26166">                reports.add(r);</span>
<span class="nc" id="L26167">                reports.addAll(destroyEntity(tank, &quot;fuel explosion&quot;, false, false));</span>
<span class="nc" id="L26168">                break;</span>
            case Tank.CRIT_SENSOR:
<span class="nc" id="L26170">                r = new Report(6620);</span>
<span class="nc" id="L26171">                r.subject = tank.getId();</span>
<span class="nc" id="L26172">                reports.add(r);</span>
<span class="nc" id="L26173">                tank.setSensorHits(tank.getSensorHits() + 1);</span>
<span class="nc" id="L26174">                break;</span>
            case Tank.CRIT_STABILIZER:
<span class="nc" id="L26176">                r = new Report(6625);</span>
<span class="nc" id="L26177">                r.subject = tank.getId();</span>
<span class="nc" id="L26178">                reports.add(r);</span>
<span class="nc" id="L26179">                tank.setStabiliserHit(loc);</span>
<span class="nc" id="L26180">                break;</span>
            case Tank.CRIT_TURRET_DESTROYED:
<span class="nc" id="L26182">                r = new Report(6630);</span>
<span class="nc" id="L26183">                r.subject = tank.getId();</span>
<span class="nc" id="L26184">                reports.add(r);</span>
<span class="nc" id="L26185">                tank.destroyLocation(tank.getLocTurret());</span>
<span class="nc" id="L26186">                reports.addAll(destroyEntity(tank, &quot;turret blown off&quot;, true, true));</span>
<span class="nc" id="L26187">                break;</span>
            case Tank.CRIT_TURRET_JAM:
<span class="nc bnc" id="L26189" title="All 2 branches missed.">                if (tank.isTurretEverJammed(loc)) {</span>
<span class="nc" id="L26190">                    r = new Report(6640);</span>
<span class="nc" id="L26191">                    r.subject = tank.getId();</span>
<span class="nc" id="L26192">                    reports.add(r);</span>
<span class="nc" id="L26193">                    tank.lockTurret(loc);</span>
<span class="nc" id="L26194">                    break;</span>
                }
<span class="nc" id="L26196">                r = new Report(6635);</span>
<span class="nc" id="L26197">                r.subject = tank.getId();</span>
<span class="nc" id="L26198">                reports.add(r);</span>
<span class="nc" id="L26199">                tank.jamTurret(loc);</span>
<span class="nc" id="L26200">                break;</span>
            case Tank.CRIT_TURRET_LOCK:
<span class="nc" id="L26202">                r = new Report(6640);</span>
<span class="nc" id="L26203">                r.subject = tank.getId();</span>
<span class="nc" id="L26204">                reports.add(r);</span>
<span class="nc" id="L26205">                tank.lockTurret(loc);</span>
<span class="nc" id="L26206">                break;</span>
            case Tank.CRIT_WEAPON_DESTROYED: {
<span class="nc" id="L26208">                r = new Report(6305);</span>
<span class="nc" id="L26209">                r.subject = tank.getId();</span>
<span class="nc" id="L26210">                List&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L26211" title="All 2 branches missed.">                for (Mounted weapon : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L26212" title="All 6 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isHit() &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26213">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L26215">                }</span>
                // sort weapons by BV
<span class="nc" id="L26217">                weapons.sort(new WeaponComparatorBV());</span>
<span class="nc" id="L26218">                int roll = Compute.d6();</span>
                Mounted weapon;
<span class="nc bnc" id="L26220" title="All 2 branches missed.">                if (roll &lt; 4) {</span>
                    // defender should choose, we'll just use the lowest BV
                    // weapon
<span class="nc" id="L26223">                    weapon = weapons.get(weapons.size() - 1);</span>
                } else {
                    // attacker chooses, we'll use the highest BV weapon
<span class="nc" id="L26226">                    weapon = weapons.get(0);</span>
                }
<span class="nc" id="L26228">                r.add(weapon.getName());</span>
<span class="nc" id="L26229">                reports.add(r);</span>
                // explosive weapons e.g. gauss now explode
<span class="nc bnc" id="L26231" title="All 4 branches missed.">                if (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L26232" title="All 2 branches missed.">                       &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26233">                    reports.addAll(explodeEquipment(tank, loc, weapon));</span>
                }
<span class="nc" id="L26235">                weapon.setHit(true);</span>
                //Taharqa: We should also damage the critical slot, or
                //MM and MHQ won't remember that this weapon is damaged on the MUL
                //file
<span class="nc bnc" id="L26239" title="All 2 branches missed.">                for (int i = 0; i &lt; tank.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L26240">                    CriticalSlot slot1 = tank.getCritical(loc, i);</span>
<span class="nc bnc" id="L26241" title="All 4 branches missed.">                    if ((slot1 == null) || (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L26242">                        continue;</span>
                    }
<span class="nc" id="L26244">                    Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L26245" title="All 2 branches missed.">                    if (mounted.equals(weapon)) {</span>
<span class="nc" id="L26246">                        tank.hitAllCriticals(loc, i);</span>
<span class="nc" id="L26247">                        break;</span>
                    }
                }
<span class="nc" id="L26250">                break;</span>
            }
            case Tank.CRIT_WEAPON_JAM: {
<span class="nc" id="L26253">                r = new Report(6645);</span>
<span class="nc" id="L26254">                r.subject = tank.getId();</span>
<span class="nc" id="L26255">                ArrayList&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L26256" title="All 2 branches missed.">                for (Mounted weapon : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L26257" title="All 4 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isJammed()</span>
<span class="nc bnc" id="L26258" title="All 4 branches missed.">                        &amp;&amp; !weapon.jammedThisPhase() &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L26259" title="All 2 branches missed.">                        &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26260">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L26262">                }</span>
<span class="nc bnc" id="L26263" title="All 2 branches missed.">                if (weapons.size() &gt; 0) {</span>
<span class="nc" id="L26264">                    Mounted weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
<span class="nc" id="L26265">                    weapon.setJammed(true);</span>
<span class="nc" id="L26266">                    tank.addJammedWeapon(weapon);</span>
<span class="nc" id="L26267">                    r.add(weapon.getName());</span>
<span class="nc" id="L26268">                    reports.add(r);</span>
<span class="nc" id="L26269">                }</span>
                break;
            }
            case VTOL.CRIT_PILOT:
<span class="nc" id="L26273">                r = new Report(6650);</span>
<span class="nc" id="L26274">                r.subject = tank.getId();</span>
<span class="nc" id="L26275">                reports.add(r);</span>
<span class="nc" id="L26276">                tank.setDriverHit(true);</span>
<span class="nc" id="L26277">                PilotingRollData psr = tank.getBasePilotingRoll();</span>
<span class="nc" id="L26278">                psr.addModifier(0, &quot;pilot injury&quot;);</span>
<span class="nc bnc" id="L26279" title="All 2 branches missed.">                if (!doSkillCheckInPlace(tank, psr)) {</span>
<span class="nc" id="L26280">                    r = new Report(6675);</span>
<span class="nc" id="L26281">                    r.subject = tank.getId();</span>
<span class="nc" id="L26282">                    r.addDesc(tank);</span>
<span class="nc" id="L26283">                    reports.add(r);</span>
<span class="nc" id="L26284">                    boolean crash = true;</span>
<span class="nc bnc" id="L26285" title="All 2 branches missed.">                    if (tank.canGoDown()) {</span>
<span class="nc" id="L26286">                        tank.setElevation(tank.getElevation() - 1);</span>
<span class="nc bnc" id="L26287" title="All 2 branches missed.">                        crash = !tank.canGoDown();</span>
                    }
<span class="nc bnc" id="L26289" title="All 2 branches missed.">                    if (crash) {</span>
<span class="nc" id="L26290">                        reports.addAll(crashVTOLorWiGE(tank));</span>
                    }
<span class="nc" id="L26292">                }</span>
                break;
            case VTOL.CRIT_COPILOT:
<span class="nc" id="L26295">                r = new Report(6655);</span>
<span class="nc" id="L26296">                r.subject = tank.getId();</span>
<span class="nc" id="L26297">                reports.add(r);</span>
<span class="nc" id="L26298">                tank.setCommanderHit(true);</span>
<span class="nc" id="L26299">                break;</span>
            case VTOL.CRIT_ROTOR_DAMAGE: {
                // Only resolve rotor crits if the rotor was actually still
                // there.
<span class="nc bnc" id="L26303" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26304">                    r = new Report(6660);</span>
<span class="nc" id="L26305">                    r.subject = tank.getId();</span>
<span class="nc" id="L26306">                    reports.add(r);</span>
<span class="nc" id="L26307">                    tank.setMotiveDamage(tank.getMotiveDamage() + 1);</span>
<span class="nc bnc" id="L26308" title="All 2 branches missed.">                    if (tank.getMotiveDamage() &gt;= tank.getOriginalWalkMP()) {</span>
<span class="nc" id="L26309">                        tank.immobilize();</span>
<span class="nc bnc" id="L26310" title="All 2 branches missed.">                        if (tank.isAirborneVTOLorWIGE()</span>
                            // Don't bother with forcing a landing if
                            // we're already otherwise destroyed.
<span class="nc bnc" id="L26313" title="All 4 branches missed.">                            &amp;&amp; !(tank.isDestroyed() || tank.isDoomed())) {</span>
<span class="nc" id="L26314">                            reports.addAll(forceLandVTOLorWiGE(tank));</span>
                        }
                    }
                }
                break;
            }
            case VTOL.CRIT_ROTOR_DESTROYED:
                // Only resolve rotor crits if the rotor was actually still
                // there. Note that despite the name this critical hit does
                // not in itself physically destroy the rotor *location*
                // (which would simply kill the VTOL).
<span class="nc bnc" id="L26325" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26326">                    r = new Report(6670);</span>
<span class="nc" id="L26327">                    r.subject = tank.getId();</span>
<span class="nc" id="L26328">                    reports.add(r);</span>
<span class="nc" id="L26329">                    tank.immobilize();</span>
<span class="nc" id="L26330">                    reports.addAll(crashVTOLorWiGE(tank, true));</span>
                }
                break;
            case VTOL.CRIT_FLIGHT_STABILIZER:
                // Only resolve rotor crits if the rotor was actually still
                // there.
<span class="nc bnc" id="L26336" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26337">                    r = new Report(6665);</span>
<span class="nc" id="L26338">                    r.subject = tank.getId();</span>
<span class="nc" id="L26339">                    reports.add(r);</span>
<span class="nc" id="L26340">                    tank.setStabiliserHit(VTOL.LOC_ROTOR);</span>
                }
                break;
        }
<span class="nc" id="L26344">        return reports;</span>
    }

    /**
     * Rolls and resolves critical hits with a die roll modifier.
     */

    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear, int critMod, int damage) {
<span class="nc" id="L26352">        return criticalEntity(en, loc, isRear, critMod, true, false, damage);</span>
    }

    /**
     * Rolls and resolves critical hits with a die roll modifier.
     */

    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear, int critMod, int damage,
                                         boolean damagedByFire) {
<span class="nc" id="L26361">        return criticalEntity(en, loc, isRear, critMod, true, false, damage, damagedByFire);</span>
    }

    /**
     * Rolls one critical hit
     */
    public Vector&lt;Report&gt; oneCriticalEntity(Entity en, int loc, boolean isRear, int damage) {
<span class="nc" id="L26368">        return criticalEntity(en, loc, isRear, 0, false, false, damage);</span>
    }

    /**
     * Makes any roll required when an AirMech lands and resolve any damage or
     * skidding resulting from a failed roll. Updates final position and elevation.
     *
     * @param lam       the landing LAM
     * @param pos       the &lt;code&gt;Coords&lt;/code&gt; of the landing hex
     * @param elevation the elevation from which the landing is attempted (usually 1, but may be higher
     *                          if the unit is forced to land due to insufficient movement
     * @param distance  the distance the unit moved in the turn prior to landing
     */
    private Vector&lt;Report&gt; landAirMech(LandAirMech lam, Coords pos, int elevation, int distance) {
<span class="nc" id="L26382">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc" id="L26384">        lam.setPosition(pos);</span>
<span class="nc" id="L26385">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26386" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26387">            lam.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
        } else {
<span class="nc" id="L26389">            lam.setElevation(0);</span>
        }
<span class="nc" id="L26391">        PilotingRollData psr = lam.checkAirMechLanding();</span>
<span class="nc bnc" id="L26392" title="All 2 branches missed.">        if (psr.getValue() != TargetRoll.CHECK_FALSE</span>
<span class="nc bnc" id="L26393" title="All 2 branches missed.">                &amp;&amp; (0 &gt; doSkillCheckWhileMoving(lam, elevation, pos, pos, psr, false))) {</span>
<span class="nc" id="L26394">            crashAirMech(lam, pos, elevation, distance, psr, vDesc);</span>
        }
<span class="nc" id="L26396">        return vDesc;</span>
    }

    private boolean crashAirMech(Entity en, PilotingRollData psr, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26400">        return crashAirMech(en, en.getPosition(), en.getElevation(), en.delta_distance, psr, vDesc);</span>
    }

    private boolean crashAirMech(Entity en, Coords pos, int elevation, int distance,
                                 PilotingRollData psr, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26405">        MoveStep step = new MoveStep(null, MoveStepType.DOWN);</span>
<span class="nc" id="L26406">        step.setFromEntity(en, game);</span>
<span class="nc" id="L26407">        return crashAirMech(en, pos, elevation, distance, psr, step, vDesc);</span>
    }

    private boolean crashAirMech(Entity en, Coords pos, int elevation, int distance,
                                 PilotingRollData psr, MoveStep lastStep, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26412">        vDesc.addAll(doEntityFallsInto(en, elevation, pos, pos, psr, true, 0));</span>
<span class="nc bnc" id="L26413" title="All 2 branches missed.">        return en.isDoomed()</span>
<span class="nc bnc" id="L26414" title="All 2 branches missed.">                || processSkid(en, pos, 0, 0, distance, lastStep, en.moved, false);</span>
    }

    /**
     * Makes the landing roll required for a glider ProtoMech and resolves any damage
     * resulting from a failed roll. Updates final position and elevation.
     *
     * @param en    the landing glider ProtoMech
     */
    private Vector&lt;Report&gt; landGliderPM(Protomech en) {
<span class="nc" id="L26424">        return landGliderPM(en, en.getPosition(), en.getElevation(), en.delta_distance);</span>
    }

    /**
     * Makes the landing roll required for a glider ProtoMech and resolves any damage
     * resulting from a failed roll. Updates final position and elevation.
     *
     * @param en    the landing glider ProtoMech
     * @param pos   the &lt;code&gt;Coords&lt;/code&gt; of the landing hex
     * @param startElevation    the elevation from which the landing is attempted (usually 1, but may be higher
     *                          if the unit is forced to land due to insufficient movement
     * @param distance  the distance the unit moved in the turn prior to landing
     */
    private Vector&lt;Report&gt; landGliderPM(Protomech en, Coords pos, int startElevation,
                                        int distance) {
<span class="nc" id="L26439">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc" id="L26441">        en.setPosition(pos);</span>
<span class="nc" id="L26442">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26443" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26444">            en.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
        } else {
<span class="nc" id="L26446">            en.setElevation(0);</span>
        }
<span class="nc" id="L26448">        PilotingRollData psr = en.checkGliderLanding();</span>
<span class="nc bnc" id="L26449" title="All 2 branches missed.">        if ((psr.getValue() != TargetRoll.CHECK_FALSE)</span>
<span class="nc bnc" id="L26450" title="All 2 branches missed.">                &amp;&amp; (0 &gt; doSkillCheckWhileMoving(en, startElevation, pos, pos, psr, false))) {</span>
<span class="nc bnc" id="L26451" title="All 2 branches missed.">            for (int i = 0; i &lt; en.getNumberOfCriticals(Protomech.LOC_LEG); i++) {</span>
<span class="nc" id="L26452">                en.getCritical(Protomech.LOC_LEG, i).setHit(true);</span>
            }
<span class="nc" id="L26454">            HitData hit = new HitData(Protomech.LOC_LEG);</span>
<span class="nc" id="L26455">            vDesc.addAll(damageEntity(en, hit, 2 * startElevation));</span>
        }
<span class="nc" id="L26457">        return vDesc;</span>
    }

    /**
     * Resolves the forced landing of one airborne {@code VTOL} or {@code WiGE}
     * in its current hex. As this method is only for internal use and not part
     * of the exported public API, it simply relies on its client code to only
     * ever hand it a valid airborne vehicle and does not run any further checks
     * of its own.
     *
     * @param en The {@code VTOL} or {@code WiGE} in question.
     * @return The resulting {@code Vector} of {@code Report}s.
     */
    private Vector&lt;Report&gt; forceLandVTOLorWiGE(Tank en) {
<span class="nc" id="L26471">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L26472">        PilotingRollData psr = en.getBasePilotingRoll();</span>
<span class="nc" id="L26473">        IHex hex = game.getBoard().getHex(en.getPosition());</span>
<span class="nc bnc" id="L26474" title="All 2 branches missed.">        if (en instanceof VTOL) {</span>
<span class="nc" id="L26475">            psr.addModifier(4, &quot;VTOL making forced landing&quot;);</span>
        } else {
<span class="nc" id="L26477">            psr.addModifier(0, &quot;WiGE making forced landing&quot;);</span>
        }
<span class="nc" id="L26479">        int elevation = Math.max(hex.terrainLevel(Terrains.BLDG_ELEV),</span>
<span class="nc" id="L26480">                                 hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
<span class="nc" id="L26481">        elevation = Math.max(elevation, 0);</span>
<span class="nc" id="L26482">        elevation = Math.min(elevation, en.getElevation());</span>
<span class="nc bnc" id="L26483" title="All 2 branches missed.">        if (en.getElevation() &gt; elevation) {</span>
<span class="nc bnc" id="L26484" title="All 2 branches missed.">            if (!hex.containsTerrain(Terrains.FUEL_TANK)</span>
<span class="nc bnc" id="L26485" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L26486" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L26487" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L26488" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.RUBBLE)</span>
<span class="nc bnc" id="L26489" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L26490" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc" id="L26491">                Report r = new Report(2180);</span>
<span class="nc" id="L26492">                r.subject = en.getId();</span>
<span class="nc" id="L26493">                r.addDesc(en);</span>
<span class="nc" id="L26494">                r.add(psr.getLastPlainDesc(), true);</span>
<span class="nc" id="L26495">                vDesc.add(r);</span>

                // roll
<span class="nc" id="L26498">                final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L26499">                r = new Report(2185);</span>
<span class="nc" id="L26500">                r.subject = en.getId();</span>
<span class="nc" id="L26501">                r.add(psr.getValueAsString());</span>
<span class="nc" id="L26502">                r.add(psr.getDesc());</span>
<span class="nc" id="L26503">                r.add(diceRoll);</span>
<span class="nc bnc" id="L26504" title="All 2 branches missed.">                if (diceRoll &lt; psr.getValue()) {</span>
<span class="nc" id="L26505">                    r.choose(false);</span>
<span class="nc" id="L26506">                    vDesc.add(r);</span>
<span class="nc" id="L26507">                    vDesc.addAll(crashVTOLorWiGE(en, true));</span>
                } else {
<span class="nc" id="L26509">                    r.choose(true);</span>
<span class="nc" id="L26510">                    vDesc.add(r);</span>
<span class="nc" id="L26511">                    en.setElevation(elevation);</span>
                }
<span class="nc" id="L26513">            } else {</span>
<span class="nc" id="L26514">                vDesc.addAll(crashVTOLorWiGE(en, true));</span>
            }
        }
<span class="nc" id="L26517">        return vDesc;</span>
    }

    /**
     * Crash a VTOL
     *
     * @param en the &lt;code&gt;VTOL&lt;/code&gt; to be crashed
     * @return the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing phase reports
     */
    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en) {
<span class="nc" id="L26527">        return crashVTOLorWiGE(en, false, false, 0, en.getPosition(),</span>
<span class="nc" id="L26528">                               en.getElevation(), 0);</span>
    }

    /**
     * Crash a VTOL or WiGE.
     *
     * @param en              The {@code VTOL} or {@code WiGE} to crash.
     * @param rerollRotorHits Whether any rotor hits from the crash should be rerolled,
     *                        typically after a &quot;rotor destroyed&quot; critical hit.
     * @return The {@code Vector&lt;Report&gt;} of resulting reports.
     */
    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en, boolean rerollRotorHits) {
<span class="nc" id="L26540">        return crashVTOLorWiGE(en, rerollRotorHits, false, 0, en.getPosition(),</span>
<span class="nc" id="L26541">                               en.getElevation(), 0);</span>
    }

    /**
     * Crash a VTOL or WiGE.
     *
     * @param en              The {@code VTOL} or {@code WiGE} to crash.
     * @param rerollRotorHits Whether any rotor hits from the crash should be rerolled,
     *                        typically after a &quot;rotor destroyed&quot; critical hit.
     * @param sideSlipCrash   A &lt;code&gt;boolean&lt;/code&gt; value indicating whether this is a
     *                        sideslip crash or not.
     * @param hexesMoved      The &lt;code&gt;int&lt;/code&gt; number of hexes moved.
     * @param crashPos        The &lt;code&gt;Coords&lt;/code&gt; of the crash
     * @param crashElevation  The &lt;code&gt;int&lt;/code&gt; elevation of the VTOL
     * @param impactSide      The &lt;code&gt;int&lt;/code&gt; describing the side on which the VTOL
     *                        falls
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; of Reports.
     */

    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en, boolean rerollRotorHits,
                                           boolean sideSlipCrash, int hexesMoved, Coords crashPos,
                                           int crashElevation, int impactSide) {
<span class="nc" id="L26563">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // we might be off the board after a DFA, so return then
<span class="nc bnc" id="L26567" title="All 2 branches missed.">        if (!game.getBoard().contains(crashPos)) {</span>
<span class="nc" id="L26568">            return vDesc;</span>
        }

<span class="nc bnc" id="L26571" title="All 2 branches missed.">        if (!sideSlipCrash) {</span>
            // report lost movement and crashing
<span class="nc" id="L26573">            r = new Report(6260);</span>
<span class="nc" id="L26574">            r.subject = en.getId();</span>
<span class="nc" id="L26575">            r.newlines = 0;</span>
<span class="nc" id="L26576">            r.addDesc(en);</span>
<span class="nc" id="L26577">            vDesc.addElement(r);</span>
<span class="nc" id="L26578">            int newElevation = 0;</span>
<span class="nc" id="L26579">            IHex fallHex = game.getBoard().getHex(crashPos);</span>

            // May land on roof of building or bridge
<span class="nc bnc" id="L26582" title="All 2 branches missed.">            if (fallHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26583">                newElevation = fallHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc bnc" id="L26584" title="All 2 branches missed.">            } else if (fallHex.containsTerrain(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc" id="L26585">                newElevation = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc bnc" id="L26586" title="All 2 branches missed.">                if (newElevation &gt; crashElevation) {</span>
<span class="nc" id="L26587">                    newElevation = 0; // vtol was under bridge already</span>
                }
            }

<span class="nc" id="L26591">            int fall = crashElevation - newElevation;</span>
<span class="nc bnc" id="L26592" title="All 2 branches missed.">            if (fall == 0) {</span>
                // already on ground, no harm done
<span class="nc" id="L26594">                r = new Report(6265);</span>
<span class="nc" id="L26595">                r.subject = en.getId();</span>
<span class="nc" id="L26596">                vDesc.addElement(r);</span>
<span class="nc" id="L26597">                return vDesc;</span>
            }
            // set elevation 1st to avoid multiple crashes
<span class="nc" id="L26600">            en.setElevation(newElevation);</span>

            // plummets to ground
<span class="nc" id="L26603">            r = new Report(6270);</span>
<span class="nc" id="L26604">            r.subject = en.getId();</span>
<span class="nc" id="L26605">            r.add(fall);</span>
<span class="nc" id="L26606">            vDesc.addElement(r);</span>

            // facing after fall
            String side;
            int table;
<span class="nc" id="L26611">            int facing = Compute.d6() - 1;</span>
<span class="nc bnc" id="L26612" title="All 4 branches missed.">            switch (facing) {</span>
                case 1:
                case 2:
<span class="nc" id="L26615">                    side = &quot;right side&quot;;</span>
<span class="nc" id="L26616">                    table = ToHitData.SIDE_RIGHT;</span>
<span class="nc" id="L26617">                    break;</span>
                case 3:
<span class="nc" id="L26619">                    side = &quot;rear&quot;;</span>
<span class="nc" id="L26620">                    table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L26621">                    break;</span>
                case 4:
                case 5:
<span class="nc" id="L26624">                    side = &quot;left side&quot;;</span>
<span class="nc" id="L26625">                    table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L26626">                    break;</span>
                case 0:
                default:
<span class="nc" id="L26629">                    side = &quot;front&quot;;</span>
<span class="nc" id="L26630">                    table = ToHitData.SIDE_FRONT;</span>
            }

<span class="nc bnc" id="L26633" title="All 2 branches missed.">            if (newElevation &lt;= 0) {</span>
<span class="nc" id="L26634">                boolean waterFall = fallHex.containsTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L26635" title="All 4 branches missed.">                if (waterFall &amp;&amp; fallHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L26636">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L26637">                    r = new Report(2119);</span>
<span class="nc" id="L26638">                    r.subject = en.getId();</span>
<span class="nc" id="L26639">                    r.addDesc(en);</span>
<span class="nc" id="L26640">                    r.add(roll);</span>
<span class="nc" id="L26641">                    r.subject = en.getId();</span>
<span class="nc" id="L26642">                    vDesc.add(r);</span>
<span class="nc bnc" id="L26643" title="All 2 branches missed.">                    if (roll &gt; 3) {</span>
<span class="nc" id="L26644">                        vDesc.addAll(resolveIceBroken(crashPos));</span>
                    } else {
<span class="nc" id="L26646">                        waterFall = false; // saved by ice</span>
                    }
                }
<span class="nc bnc" id="L26649" title="All 2 branches missed.">                if (waterFall) {</span>
                    // falls into water and is destroyed
<span class="nc" id="L26651">                    r = new Report(6275);</span>
<span class="nc" id="L26652">                    r.subject = en.getId();</span>
<span class="nc" id="L26653">                    vDesc.addElement(r);</span>
<span class="nc" id="L26654">                    vDesc.addAll(destroyEntity(en, &quot;Fell into water&quot;, false, false));</span>
                    // not sure, is this salvageable?
                }
            }

            // calculate damage for hitting the surface
<span class="nc" id="L26660">            int damage = (int) Math.round(en.getWeight() / 10.0) * (fall + 1);</span>

            // adjust damage for gravity
<span class="nc" id="L26663">            damage = Math.round(damage * game.getPlanetaryConditions().getGravity());</span>
            // report falling
<span class="nc" id="L26665">            r = new Report(6280);</span>
<span class="nc" id="L26666">            r.subject = en.getId();</span>
<span class="nc" id="L26667">            r.indent();</span>
<span class="nc" id="L26668">            r.addDesc(en);</span>
<span class="nc" id="L26669">            r.add(side);</span>
<span class="nc" id="L26670">            r.add(damage);</span>
            //r.newlines = 0;
<span class="nc" id="L26672">            vDesc.addElement(r);</span>

<span class="nc" id="L26674">            en.setFacing((en.getFacing() + (facing)) % 6);</span>

<span class="nc" id="L26676">            boolean exploded = false;</span>

            // standard damage loop
<span class="nc bnc" id="L26679" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L26680">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L26681">                HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, table);</span>
<span class="nc bnc" id="L26682" title="All 6 branches missed.">                if ((en instanceof VTOL) &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR) &amp;&amp; rerollRotorHits) {</span>
<span class="nc" id="L26683">                    continue;</span>
                }
<span class="nc" id="L26685">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L26686">                int[] isBefore = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26687">                                  en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc" id="L26688">                vDesc.addAll(damageEntity(en, hit, cluster));</span>
<span class="nc" id="L26689">                int[] isAfter = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26690">                                 en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc bnc" id="L26691" title="All 2 branches missed.">                for (int x = 0; x &lt;= 3; x++) {</span>
<span class="nc bnc" id="L26692" title="All 2 branches missed.">                    if (isBefore[x] != isAfter[x]) {</span>
<span class="nc" id="L26693">                        exploded = true;</span>
<span class="nc" id="L26694">                        break;</span>
                    }
                }
<span class="nc" id="L26697">                damage -= cluster;</span>
<span class="nc" id="L26698">            }</span>
<span class="nc bnc" id="L26699" title="All 2 branches missed.">            if (exploded) {</span>
<span class="nc" id="L26700">                r = new Report(6285);</span>
<span class="nc" id="L26701">                r.subject = en.getId();</span>
<span class="nc" id="L26702">                r.addDesc(en);</span>
<span class="nc" id="L26703">                vDesc.addElement(r);</span>
<span class="nc" id="L26704">                vDesc.addAll(explodeVTOLorWiGE(en));</span>
            }

            // check for location exposure
<span class="nc" id="L26708">            vDesc.addAll(doSetLocationsExposure(en, fallHex, false, newElevation));</span>

<span class="nc" id="L26710">        } else {</span>
<span class="nc" id="L26711">            en.setElevation(0);// considered landed in the hex.</span>
            // crashes into ground thanks to sideslip
<span class="nc" id="L26713">            r = new Report(6290);</span>
<span class="nc" id="L26714">            r.subject = en.getId();</span>
<span class="nc" id="L26715">            r.addDesc(en);</span>
<span class="nc" id="L26716">            vDesc.addElement(r);</span>
<span class="nc" id="L26717">            int damage = (int) Math.round(en.getWeight() / 10.0) * (hexesMoved + 1);</span>
<span class="nc" id="L26718">            boolean exploded = false;</span>

            // standard damage loop
<span class="nc bnc" id="L26721" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L26722">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L26723">                HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, impactSide);</span>
<span class="nc" id="L26724">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L26725">                int[] isBefore = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26726">                                  en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc" id="L26727">                vDesc.addAll(damageEntity(en, hit, cluster));</span>
<span class="nc" id="L26728">                int[] isAfter = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26729">                                 en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc bnc" id="L26730" title="All 2 branches missed.">                for (int x = 0; x &lt;= 3; x++) {</span>
<span class="nc bnc" id="L26731" title="All 2 branches missed.">                    if (isBefore[x] != isAfter[x]) {</span>
<span class="nc" id="L26732">                        exploded = true;</span>
<span class="nc" id="L26733">                        break;</span>
                    }
                }
<span class="nc" id="L26736">                damage -= cluster;</span>
<span class="nc" id="L26737">            }</span>
<span class="nc bnc" id="L26738" title="All 2 branches missed.">            if (exploded) {</span>
<span class="nc" id="L26739">                r = new Report(6295);</span>
<span class="nc" id="L26740">                r.subject = en.getId();</span>
<span class="nc" id="L26741">                r.addDesc(en);</span>
<span class="nc" id="L26742">                vDesc.addElement(r);</span>
<span class="nc" id="L26743">                vDesc.addAll(explodeVTOLorWiGE(en));</span>
            }

        }

<span class="nc bnc" id="L26748" title="All 2 branches missed.">        if (game.containsMinefield(crashPos)) {</span>
            // may set off any minefields in the hex
<span class="nc" id="L26750">            enterMinefield(en, crashPos, 0, true, vDesc, 7);</span>
            // it may also clear any minefields that it detonated
<span class="nc" id="L26752">            clearDetonatedMines(crashPos, 5);</span>
<span class="nc" id="L26753">            resetMines();</span>
        }

<span class="nc" id="L26756">        return vDesc;</span>

    }

    /**
     * Explode a VTOL
     *
     * @param en The &lt;code&gt;VTOL&lt;/code&gt; to explode.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of reports
     */
    private Vector&lt;Report&gt; explodeVTOLorWiGE(Tank en) {
<span class="nc" id="L26767">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L26770" title="All 4 branches missed.">        if(en.hasEngine() &amp;&amp; en.getEngine().isFusion()) {</span>
            // fusion engine, no effect
<span class="nc" id="L26772">            r = new Report(6300);</span>
<span class="nc" id="L26773">            r.subject = en.getId();</span>
<span class="nc" id="L26774">            vDesc.addElement(r);</span>
        } else {
<span class="nc" id="L26776">            Coords pos = en.getPosition();</span>
<span class="nc" id="L26777">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26778" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L26779">                ignite(pos, Terrains.FIRE_LVL_NORMAL, vDesc);</span>
            } else {
<span class="nc" id="L26781">                ignite(pos, Terrains.FIRE_LVL_INFERNO, vDesc);</span>
            }
<span class="nc" id="L26783">            vDesc.addAll(destroyEntity(en, &quot;crashed and burned&quot;, false, false));</span>
        }

<span class="nc" id="L26786">        return vDesc;</span>
    }

    /**
     * rolls and resolves one tank critical hit
     *
     * @param t       the &lt;code&gt;Tank&lt;/code&gt; to be critted
     * @param loc     the &lt;code&gt;int&lt;/code&gt; location of the Tank to be critted
     * @param critMod the &lt;code&gt;int&lt;/code&gt; modifier to the crit roll
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    private Vector&lt;Report&gt; criticalTank(Tank t, int loc, int critMod, int damage, boolean damagedByFire) {
<span class="nc" id="L26798">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // roll the critical
<span class="nc" id="L26802">        r = new Report(6305);</span>
<span class="nc" id="L26803">        r.subject = t.getId();</span>
<span class="nc" id="L26804">        r.indent(3);</span>
<span class="nc" id="L26805">        r.add(t.getLocationAbbr(loc));</span>
<span class="nc" id="L26806">        r.newlines = 0;</span>
<span class="nc" id="L26807">        vDesc.add(r);</span>
<span class="nc" id="L26808">        int roll = Compute.d6(2);</span>
<span class="nc" id="L26809">        r = new Report(6310);</span>
<span class="nc" id="L26810">        r.subject = t.getId();</span>
<span class="nc" id="L26811">        String rollString = &quot;&quot;;</span>
<span class="nc bnc" id="L26812" title="All 2 branches missed.">        if (critMod != 0) {</span>
<span class="nc" id="L26813">            rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L26814" title="All 2 branches missed.">            if (critMod &gt; 0) {</span>
<span class="nc" id="L26815">                rollString += &quot;+&quot;;</span>
            }
<span class="nc" id="L26817">            rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L26818">            roll += critMod;</span>
        }
<span class="nc" id="L26820">        rollString += roll;</span>
<span class="nc" id="L26821">        r.add(rollString);</span>
<span class="nc" id="L26822">        r.newlines = 0;</span>
<span class="nc" id="L26823">        vDesc.add(r);</span>

        // now look up on vehicle crits table
<span class="nc" id="L26826">        int critType = t.getCriticalEffect(roll, loc, damagedByFire);</span>
<span class="nc bnc" id="L26827" title="All 2 branches missed.">        if ((critType == Tank.CRIT_NONE)</span>
<span class="nc bnc" id="L26828" title="All 6 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                &amp;&amp; !((t instanceof VTOL) || (t instanceof GunEmplacement))
<span class="nc bnc" id="L26830" title="All 2 branches missed.">                &amp;&amp; !t.getOverThresh()) {</span>
<span class="nc" id="L26831">            r = new Report(6006);</span>
<span class="nc" id="L26832">            r.subject = t.getId();</span>
<span class="nc" id="L26833">            r.newlines = 0;</span>
<span class="nc" id="L26834">            vDesc.add(r);</span>
        }
<span class="nc" id="L26836">        vDesc.addAll(applyCriticalHit(t, loc, new CriticalSlot(0, critType),</span>
                                      true, damage, false));
<span class="nc bnc" id="L26838" title="All 6 branches missed.">        if ((critType != Tank.CRIT_NONE) &amp;&amp; t.hasEngine() &amp;&amp; !t.getEngine().isFusion()</span>
<span class="nc bnc" id="L26839" title="All 4 branches missed.">                &amp;&amp; t.hasQuirk(OptionsConstants.QUIRK_NEG_FRAGILE_FUEL) &amp;&amp; (Compute.d6(2) &gt; 9)) {</span>
            // BOOM!!
<span class="nc" id="L26841">            vDesc.addAll(applyCriticalHit(t, loc, new CriticalSlot(0,</span>
                    Tank.CRIT_FUEL_TANK), true, damage, false));
        }
<span class="nc" id="L26844">        return vDesc;</span>
    }

    /**
     * Checks for aero criticals
     *
     * @param vDesc         - report vector
     * @param a             - the entity being critted
     * @param hit           - the hitdata for the attack
     * @param damage_orig   - the original damage of the attack
     * @param critThresh    - did the attack go over the damage threshold
     * @param critSI        - did the attack damage SI
     * @param ammoExplosion - was the damage from an ammo explosion
     * @param nukeS2S       - was this a ship 2 ship nuke attack
     */
    private void checkAeroCrits(Vector&lt;Report&gt; vDesc, Aero a, HitData hit,
                                int damage_orig, boolean critThresh, boolean critSI,
                                boolean ammoExplosion, boolean nukeS2S) {

        Report r;

<span class="nc" id="L26865">        boolean isCapital = hit.isCapital();</span>
        // get any capital missile critical mods
<span class="nc" id="L26867">        int capitalMissile = hit.getCapMisCritMod();</span>

        // check for nuclear critical
<span class="nc bnc" id="L26870" title="All 2 branches missed.">        if (nukeS2S) {</span>
            // add a control roll
<span class="nc" id="L26872">            PilotingRollData nukePSR = new PilotingRollData(a.getId(), 4,</span>
                    &quot;Nuclear attack&quot;, false);
<span class="nc" id="L26874">            game.addControlRoll(nukePSR);</span>

<span class="nc" id="L26876">            Report.addNewline(vDesc);</span>
            // need some kind of report
<span class="nc" id="L26878">            int nukeroll = Compute.d6(2);</span>
<span class="nc" id="L26879">            r = new Report(9145);</span>
<span class="nc" id="L26880">            r.subject = a.getId();</span>
<span class="nc" id="L26881">            r.indent(3);</span>
<span class="nc" id="L26882">            r.add(capitalMissile);</span>
<span class="nc" id="L26883">            r.add(nukeroll);</span>
<span class="nc" id="L26884">            vDesc.add(r);</span>
<span class="nc bnc" id="L26885" title="All 2 branches missed.">            if (nukeroll &gt;= capitalMissile) {</span>
                // Allow a reroll with edge
<span class="nc bnc" id="L26887" title="All 2 branches missed.">                if (a.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_NUKE_CRIT)</span>
<span class="nc bnc" id="L26888" title="All 2 branches missed.">                        &amp;&amp; a.getCrew().hasEdgeRemaining()) {</span>
<span class="nc" id="L26889">                    a.getCrew().decreaseEdge();</span>
<span class="nc" id="L26890">                    r = new Report(9148);</span>
<span class="nc" id="L26891">                    r.subject = a.getId();</span>
<span class="nc" id="L26892">                    r.indent(3);</span>
<span class="nc" id="L26893">                    r.add(a.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L26894">                    vDesc.add(r);</span>
                    // Reroll
<span class="nc" id="L26896">                    nukeroll = Compute.d6(2);</span>
                    // and report the new results
<span class="nc" id="L26898">                    r = new Report(9149);</span>
<span class="nc" id="L26899">                    r.subject = a.getId();</span>
<span class="nc" id="L26900">                    r.indent(3);</span>
<span class="nc" id="L26901">                    r.add(capitalMissile);</span>
<span class="nc" id="L26902">                    r.add(nukeroll);</span>
<span class="nc bnc" id="L26903" title="All 2 branches missed.">                    r.choose(nukeroll &gt;= capitalMissile);</span>
<span class="nc" id="L26904">                    vDesc.add(r);</span>
<span class="nc bnc" id="L26905" title="All 2 branches missed.">                    if (nukeroll &lt; capitalMissile) {</span>
                        // We might be vaporized by the damage itself, but no additional effect
<span class="nc" id="L26907">                        return;</span>
                    }
                }
<span class="nc" id="L26910">                a.setSI(a.getSI() - (damage_orig * 10));</span>
<span class="nc" id="L26911">                a.damageThisPhase += (damage_orig * 10);</span>
<span class="nc" id="L26912">                r = new Report(9146);</span>
<span class="nc" id="L26913">                r.subject = a.getId();</span>
<span class="nc" id="L26914">                r.add((damage_orig * 10));</span>
<span class="nc" id="L26915">                r.indent(4);</span>
<span class="nc" id="L26916">                r.add(Math.max(a.getSI(), 0));</span>
<span class="nc" id="L26917">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L26918" title="All 2 branches missed.">                if (a.getSI() &lt;= 0) {</span>
                    //No auto-ejection chance here. Nuke would vaporize the pilot.
<span class="nc" id="L26920">                    vDesc.addAll(destroyEntity(a, &quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L26921">                    a.setSI(0);</span>
<span class="nc bnc" id="L26922" title="All 2 branches missed.">                    if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L26923">                        creditKill(a, game.getEntity(hit.getAttackerId()));</span>
                    }
<span class="nc bnc" id="L26925" title="All 2 branches missed.">                } else if (!critSI) {</span>
<span class="nc" id="L26926">                    critSI = true;</span>
                }
            } else {
<span class="nc" id="L26929">                r = new Report(9147);</span>
<span class="nc" id="L26930">                r.subject = a.getId();</span>
<span class="nc" id="L26931">                r.indent(4);</span>
<span class="nc" id="L26932">                vDesc.addElement(r);</span>
            }
        }

        // apply crits
<span class="nc bnc" id="L26937" title="All 2 branches missed.">        if (hit.rolledBoxCars()) {</span>
<span class="nc bnc" id="L26938" title="All 2 branches missed.">            if (hit.isFirstHit()) {</span>
                // Allow edge use to ignore the critical roll
<span class="nc bnc" id="L26940" title="All 2 branches missed.">                if (a.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_LUCKY_CRIT)</span>
<span class="nc bnc" id="L26941" title="All 2 branches missed.">                        &amp;&amp; a.getCrew().hasEdgeRemaining()) {</span>
<span class="nc" id="L26942">                    a.getCrew().decreaseEdge();</span>
<span class="nc" id="L26943">                    r = new Report(9103);</span>
<span class="nc" id="L26944">                    r.subject = a.getId();</span>
<span class="nc" id="L26945">                    r.indent(3);</span>
<span class="nc" id="L26946">                    r.add(a.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L26947">                    vDesc.addElement(r);</span>
                    // Skip the critical roll
<span class="nc" id="L26949">                    return;</span>
                }
<span class="nc" id="L26951">                vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(), &quot;12 to hit&quot;,</span>
                        8, damage_orig, isCapital));
            } else { // Let the user know why the lucky crit doesn't apply
<span class="nc" id="L26954">                r = new Report(9102);</span>
<span class="nc" id="L26955">                r.subject = a.getId();</span>
<span class="nc" id="L26956">                r.indent(3);</span>
<span class="nc" id="L26957">                vDesc.addElement(r);</span>
            }
        }
        // ammo explosions shouldn't affect threshold because they
        // go right to SI
<span class="nc bnc" id="L26962" title="All 4 branches missed.">        if (critThresh &amp;&amp; !ammoExplosion) {</span>
<span class="nc" id="L26963">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;Damage threshold exceeded&quot;, 8, damage_orig, isCapital));
        }
<span class="nc bnc" id="L26966" title="All 4 branches missed.">        if (critSI &amp;&amp; !ammoExplosion) {</span>
<span class="nc" id="L26967">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;SI damaged&quot;, 8, damage_orig, isCapital));
        }
<span class="nc bnc" id="L26970" title="All 4 branches missed.">        if ((capitalMissile &gt; 0) &amp;&amp; !nukeS2S) {</span>
<span class="nc" id="L26971">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;Capital Missile&quot;, capitalMissile, damage_orig, isCapital));
        }
<span class="nc" id="L26974">    }</span>

    private Vector&lt;Report&gt; criticalAero(Aero a, int loc, int critMod,
            String reason, int target, int damage, boolean isCapital) {
<span class="nc" id="L26978">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        //Telemissiles don't take critical hits
<span class="nc bnc" id="L26982" title="All 2 branches missed.">        if (a instanceof TeleMissile) {</span>
<span class="nc" id="L26983">            return vDesc;</span>
        }

        // roll the critical
<span class="nc" id="L26987">        r = new Report(9100);</span>
<span class="nc" id="L26988">        r.subject = a.getId();</span>
<span class="nc" id="L26989">        r.add(reason);</span>
<span class="nc" id="L26990">        r.indent(3);</span>
<span class="nc" id="L26991">        r.newlines = 0;</span>
<span class="nc" id="L26992">        vDesc.add(r);</span>
<span class="nc" id="L26993">        int roll = Compute.d6(2);</span>
<span class="nc" id="L26994">        r = new Report(9101);</span>
<span class="nc" id="L26995">        r.subject = a.getId();</span>
<span class="nc" id="L26996">        r.add(target);</span>
<span class="nc" id="L26997">        String rollString = &quot;&quot;;</span>
<span class="nc bnc" id="L26998" title="All 2 branches missed.">        if (critMod != 0) {</span>
<span class="nc" id="L26999">            rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L27000" title="All 2 branches missed.">            if (critMod &gt; 0) {</span>
<span class="nc" id="L27001">                rollString += &quot;+&quot;;</span>
            }
<span class="nc" id="L27003">            rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L27004">            roll += critMod;</span>
        }
<span class="nc" id="L27006">        rollString += roll;</span>
<span class="nc" id="L27007">        r.add(rollString);</span>
<span class="nc" id="L27008">        r.newlines = 0;</span>
<span class="nc" id="L27009">        vDesc.add(r);</span>

        // now look up on vehicle crits table
<span class="nc" id="L27012">        int critType = a.getCriticalEffect(roll, target);</span>
<span class="nc" id="L27013">        vDesc.addAll(applyCriticalHit(a, loc, new CriticalSlot(0, critType),</span>
                true, damage, isCapital));
<span class="nc" id="L27015">        return vDesc;</span>
    }

    /**
     * Rolls and resolves critical hits on mechs or vehicles. if rollNumber is
     * false, a single hit is applied - needed for MaxTech Heat Scale rule.
     */
    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear,
            int critMod, boolean rollNumber, boolean isCapital, int damage) {
<span class="nc" id="L27024">        return criticalEntity(en, loc, isRear, critMod, rollNumber, isCapital,</span>
                damage, false);
    }

    /**
     * Rolls and resolves critical hits on mechs or vehicles. if rollNumber is
     * false, a single hit is applied - needed for MaxTech Heat Scale rule.
     */
    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear,
            int critMod, boolean rollNumber, boolean isCapital, int damage,
            boolean damagedByFire) {

<span class="nc bnc" id="L27036" title="All 2 branches missed.">        if (en.hasQuirk(&quot;poor_work&quot;)) {</span>
<span class="nc" id="L27037">            critMod += 1;</span>
        }
<span class="nc bnc" id="L27039" title="All 2 branches missed.">        if (en.hasQuirk(OptionsConstants.QUIRK_NEG_PROTOTYPE)) {</span>
<span class="nc" id="L27040">            critMod += 2;</span>
        }

        // Apply modifiers for Anti-penetrative ablation armor
<span class="nc bnc" id="L27044" title="All 2 branches missed.">        if ((en.getArmor(loc, isRear) &gt; 0)</span>
<span class="nc bnc" id="L27045" title="All 2 branches missed.">                &amp;&amp; (en.getArmorType(loc) == EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION)) {</span>
<span class="nc" id="L27046">            critMod -= 2;</span>
        }

<span class="nc bnc" id="L27049" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L27050">            return criticalTank((Tank) en, loc, critMod, damage, damagedByFire);</span>
        }

<span class="nc bnc" id="L27053" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L27054">            return criticalAero((Aero) en, loc, critMod, &quot;unknown&quot;, 8, damage,</span>
                    isCapital);
        }
        CriticalSlot slot;
<span class="nc" id="L27058">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L27060">        Coords coords = en.getPosition();</span>
<span class="nc" id="L27061">        IHex hex = null;</span>
        int hits;
<span class="nc bnc" id="L27063" title="All 2 branches missed.">        if (rollNumber) {</span>
<span class="nc bnc" id="L27064" title="All 2 branches missed.">            if (null != coords) {</span>
<span class="nc" id="L27065">                hex = game.getBoard().getHex(coords);</span>
            }
<span class="nc" id="L27067">            r = new Report(6305);</span>
<span class="nc" id="L27068">            r.subject = en.getId();</span>
<span class="nc" id="L27069">            r.indent(3);</span>
<span class="nc" id="L27070">            r.add(en.getLocationAbbr(loc));</span>
<span class="nc" id="L27071">            r.newlines = 0;</span>
<span class="nc" id="L27072">            vDesc.addElement(r);</span>
<span class="nc" id="L27073">            hits = 0;</span>
<span class="nc" id="L27074">            int roll = Compute.d6(2);</span>
<span class="nc" id="L27075">            r = new Report(6310);</span>
<span class="nc" id="L27076">            r.subject = en.getId();</span>
<span class="nc" id="L27077">            String rollString = &quot;&quot;;</span>
            // industrials get a +2 bonus on the roll
<span class="nc bnc" id="L27079" title="All 4 branches missed.">            if ((en instanceof Mech) &amp;&amp; ((Mech) en).isIndustrial()) {</span>
<span class="nc" id="L27080">                critMod += 2;</span>
            }
            // reinforced structure gets a -1 mod
<span class="nc bnc" id="L27083" title="All 4 branches missed.">            if ((en instanceof Mech) &amp;&amp; ((Mech) en).hasReinforcedStructure()) {</span>
<span class="nc" id="L27084">                critMod -= 1;</span>
            }
<span class="nc bnc" id="L27086" title="All 2 branches missed.">            if (critMod != 0) {</span>
<span class="nc" id="L27087">                rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L27088" title="All 2 branches missed.">                if (critMod &gt; 0) {</span>
<span class="nc" id="L27089">                    rollString += &quot;+&quot;;</span>
                }
<span class="nc" id="L27091">                rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L27092">                roll += critMod;</span>
            }
<span class="nc" id="L27094">            rollString += roll;</span>
<span class="nc" id="L27095">            r.add(rollString);</span>
<span class="nc" id="L27096">            r.newlines = 0;</span>
<span class="nc" id="L27097">            vDesc.addElement(r);</span>
<span class="nc" id="L27098">            boolean advancedCrit = game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVCOMBAT_TACOPS_CRIT_ROLL);
<span class="nc bnc" id="L27100" title="All 8 branches missed.">            if ((!advancedCrit &amp;&amp; (roll &lt;= 7)) || (advancedCrit &amp;&amp; (roll &lt;= 8))) {</span>
                // no effect
<span class="nc" id="L27102">                r = new Report(6005);</span>
<span class="nc" id="L27103">                r.subject = en.getId();</span>
<span class="nc" id="L27104">                vDesc.addElement(r);</span>
<span class="nc" id="L27105">                return vDesc;</span>
<span class="nc bnc" id="L27106" title="All 12 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 8) &amp;&amp; (roll &lt;= 9))</span>
                    || (advancedCrit &amp;&amp; (roll &gt;= 9) &amp;&amp; (roll &lt;= 10))) {
<span class="nc" id="L27108">                hits = 1;</span>
<span class="nc" id="L27109">                r = new Report(6315);</span>
<span class="nc" id="L27110">                r.subject = en.getId();</span>
<span class="nc" id="L27111">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27112" title="All 12 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 10) &amp;&amp; (roll &lt;= 11))</span>
                    || (advancedCrit &amp;&amp; (roll &gt;= 11) &amp;&amp; (roll &lt;= 12))) {
<span class="nc" id="L27114">                hits = 2;</span>
<span class="nc" id="L27115">                r = new Report(6320);</span>
<span class="nc" id="L27116">                r.subject = en.getId();</span>
<span class="nc" id="L27117">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27118" title="All 6 branches missed.">            } else if (advancedCrit &amp;&amp; (roll &gt;= 13) &amp;&amp; (roll &lt;= 14)) {</span>
<span class="nc" id="L27119">                hits = 3;</span>
<span class="nc" id="L27120">                r = new Report(6325);</span>
<span class="nc" id="L27121">                r.subject = en.getId();</span>
<span class="nc" id="L27122">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27123" title="All 8 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 12)) || (advancedCrit &amp;&amp; (roll &gt;= 15))) {</span>
<span class="nc bnc" id="L27124" title="All 2 branches missed.">                if (en instanceof Protomech) {</span>
<span class="nc" id="L27125">                    hits = 3;</span>
<span class="nc" id="L27126">                    r = new Report(6325);</span>
<span class="nc" id="L27127">                    r.subject = en.getId();</span>
<span class="nc" id="L27128">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L27129" title="All 2 branches missed.">                } else if (en.locationIsLeg(loc)) {</span>
<span class="nc" id="L27130">                    CriticalSlot cs = en.getCritical(loc, 0);</span>
<span class="nc bnc" id="L27131" title="All 4 branches missed.">                    if ((cs != null) &amp;&amp; cs.isArmored()) {</span>
<span class="nc" id="L27132">                        r = new Report(6700);</span>
<span class="nc" id="L27133">                        r.subject = en.getId();</span>
<span class="nc" id="L27134">                        r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27135">                        r.newlines = 0;</span>
<span class="nc" id="L27136">                        vDesc.addElement(r);</span>
<span class="nc" id="L27137">                        cs.setArmored(false);</span>
<span class="nc" id="L27138">                        return vDesc;</span>
                    }
                    // limb blown off
<span class="nc" id="L27141">                    r = new Report(6120);</span>
<span class="nc" id="L27142">                    r.subject = en.getId();</span>
<span class="nc" id="L27143">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27144">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L27145" title="All 2 branches missed.">                    if (en.getInternal(loc) &gt; 0) {</span>
<span class="nc" id="L27146">                        en.destroyLocation(loc, true);</span>
                    }
<span class="nc bnc" id="L27148" title="All 2 branches missed.">                    if (null != hex) {</span>
<span class="nc bnc" id="L27149" title="All 2 branches missed.">                        if (!hex.containsTerrain(Terrains.LEGS)) {</span>
<span class="nc" id="L27150">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27151">                                    .createTerrain(Terrains.LEGS, 1));</span>
                        } else {
<span class="nc" id="L27153">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27154">                                    .createTerrain(Terrains.LEGS,</span>
<span class="nc" id="L27155">                                            hex.terrainLevel(Terrains.LEGS) + 1));</span>
                        }
                    }
<span class="nc" id="L27158">                    sendChangedHex(en.getPosition());</span>
<span class="nc" id="L27159">                    return vDesc;</span>
<span class="nc bnc" id="L27160" title="All 4 branches missed.">                } else if ((loc == Mech.LOC_RARM) || (loc == Mech.LOC_LARM)) {</span>
<span class="nc" id="L27161">                    CriticalSlot cs = en.getCritical(loc, 0);</span>
<span class="nc bnc" id="L27162" title="All 4 branches missed.">                    if ((cs != null) &amp;&amp; cs.isArmored()) {</span>
<span class="nc" id="L27163">                        r = new Report(6700);</span>
<span class="nc" id="L27164">                        r.subject = en.getId();</span>
<span class="nc" id="L27165">                        r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27166">                        r.newlines = 0;</span>
<span class="nc" id="L27167">                        vDesc.addElement(r);</span>
<span class="nc" id="L27168">                        cs.setArmored(false);</span>
<span class="nc" id="L27169">                        return vDesc;</span>
                    }

                    // limb blown off
<span class="nc" id="L27173">                    r = new Report(6120);</span>
<span class="nc" id="L27174">                    r.subject = en.getId();</span>
<span class="nc" id="L27175">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27176">                    vDesc.addElement(r);</span>
<span class="nc" id="L27177">                    en.destroyLocation(loc, true);</span>
<span class="nc bnc" id="L27178" title="All 2 branches missed.">                    if (null != hex) {</span>
<span class="nc bnc" id="L27179" title="All 2 branches missed.">                        if (!hex.containsTerrain(Terrains.ARMS)) {</span>
<span class="nc" id="L27180">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27181">                                    .createTerrain(Terrains.ARMS, 1));</span>
                        } else {
<span class="nc" id="L27183">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27184">                                    .createTerrain(Terrains.ARMS,</span>
<span class="nc" id="L27185">                                            hex.terrainLevel(Terrains.ARMS) + 1));</span>
                        }
                    }
<span class="nc" id="L27188">                    sendChangedHex(en.getPosition());</span>
<span class="nc" id="L27189">                    return vDesc;</span>
<span class="nc bnc" id="L27190" title="All 2 branches missed.">                } else if (loc == Mech.LOC_HEAD) {</span>
                    // head blown off
<span class="nc" id="L27192">                    r = new Report(6330);</span>
<span class="nc" id="L27193">                    r.subject = en.getId();</span>
<span class="nc" id="L27194">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27195">                    vDesc.addElement(r);</span>
<span class="nc" id="L27196">                    en.destroyLocation(loc, true);</span>
<span class="nc bnc" id="L27197" title="All 2 branches missed.">                    if (((Mech) en).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED) {</span>
                        // Don't kill a pilot multiple times.
<span class="nc bnc" id="L27199" title="All 2 branches missed.">                        if (Crew.DEATH &gt; en.getCrew().getHits()) {</span>
<span class="nc" id="L27200">                            en.getCrew().setDoomed(true);</span>
<span class="nc" id="L27201">                            Report.addNewline(vDesc);</span>
<span class="nc" id="L27202">                            vDesc.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                        }
                    }
<span class="nc" id="L27205">                    return vDesc;</span>
                } else {
                    // torso hit
<span class="nc" id="L27208">                    hits = 3;</span>
                    // industrials get 4 crits on a modified result of 14
<span class="nc bnc" id="L27210" title="All 6 branches missed.">                    if ((roll &gt;= 14) &amp;&amp; (en instanceof Mech) &amp;&amp; ((Mech) en).isIndustrial()) {</span>
<span class="nc" id="L27211">                        hits = 4;</span>
                    }
<span class="nc" id="L27213">                    r = new Report(6325);</span>
<span class="nc" id="L27214">                    r.subject = en.getId();</span>
<span class="nc" id="L27215">                    vDesc.addElement(r);</span>
                }
            }
<span class="nc" id="L27218">        } else {</span>
<span class="nc" id="L27219">            hits = 1;</span>
        }

        // Check if there is the potential for a reactive armor crit
        // Because reactive armor isn't hittable, the transfer check doesn't
        // consider it
<span class="nc bnc" id="L27225" title="All 2 branches missed.">        boolean possibleReactiveCrit = (en.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27226" title="All 2 branches missed.">                &amp;&amp; (en.getArmorType(loc) == EquipmentType.T_ARMOR_REACTIVE);</span>
<span class="nc" id="L27227">        boolean locContainsReactiveArmor = false;</span>
<span class="nc bnc" id="L27228" title="All 4 branches missed.">        for (int i = 0; (i &lt; en.getNumberOfCriticals(loc)) &amp;&amp; possibleReactiveCrit; i++) {</span>
<span class="nc" id="L27229">            CriticalSlot crit = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L27230" title="All 4 branches missed.">            if ((crit != null) &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27231" title="All 2 branches missed.">                    &amp;&amp; (crit.getMount() != null)</span>
<span class="nc bnc" id="L27232" title="All 2 branches missed.">                    &amp;&amp; crit.getMount().getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L27233">                locContainsReactiveArmor = true;</span>
<span class="nc" id="L27234">                break;</span>
            }
        }
<span class="nc" id="L27237">        possibleReactiveCrit &amp;= locContainsReactiveArmor;</span>

        // transfer criticals, if needed
<span class="nc bnc" id="L27240" title="All 4 branches missed.">        while ((en.canTransferCriticals(loc) &amp;&amp; !possibleReactiveCrit)</span>
<span class="nc bnc" id="L27241" title="All 2 branches missed.">                &amp;&amp; (en.getTransferLocation(loc) != Entity.LOC_DESTROYED)</span>
<span class="nc bnc" id="L27242" title="All 2 branches missed.">                &amp;&amp; (en.getTransferLocation(loc) != Entity.LOC_NONE)) {</span>
<span class="nc" id="L27243">            loc = en.getTransferLocation(loc);</span>
<span class="nc" id="L27244">            r = new Report(6335);</span>
<span class="nc" id="L27245">            r.subject = en.getId();</span>
<span class="nc" id="L27246">            r.indent(3);</span>
<span class="nc" id="L27247">            r.add(en.getLocationAbbr(loc));</span>
<span class="nc" id="L27248">            vDesc.addElement(r);</span>
        }

        // Roll critical hits in this location.
<span class="nc bnc" id="L27252" title="All 2 branches missed.">        while (hits &gt; 0) {</span>

            // Have we hit all available slots in this location?
<span class="nc bnc" id="L27255" title="All 2 branches missed.">            if (en.getHittableCriticals(loc) &lt;= 0) {</span>
<span class="nc" id="L27256">                r = new Report(6340);</span>
<span class="nc" id="L27257">                r.subject = en.getId();</span>
<span class="nc" id="L27258">                r.indent(3);</span>
<span class="nc" id="L27259">                vDesc.addElement(r);</span>
<span class="nc" id="L27260">                break;</span>
            }

            // Randomly pick a slot to be hit.
<span class="nc" id="L27264">            int slotIndex = Compute.randomInt(en.getNumberOfCriticals(loc));</span>
<span class="nc" id="L27265">            slot = en.getCritical(loc, slotIndex);</span>

            // There are certain special cases, like reactive armor
            // some crits aren't normally hittable, except in certain cases
<span class="nc" id="L27269">            boolean reactiveArmorCrit = false;</span>
<span class="nc bnc" id="L27270" title="All 4 branches missed.">            if ((slot != null) &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27271" title="All 2 branches missed.">                    &amp;&amp; (slot.getMount() != null)) {</span>
<span class="nc" id="L27272">                Mounted eq = slot.getMount();</span>
<span class="nc bnc" id="L27273" title="All 4 branches missed.">                if (eq.getType().hasFlag(MiscType.F_REACTIVE) &amp;&amp; (en.getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L27274">                    reactiveArmorCrit = true;</span>
                }
            }

            // Ignore empty or unhitable slots (this
            // includes all previously hit slots).
<span class="nc bnc" id="L27280" title="All 6 branches missed.">            if ((slot != null) &amp;&amp; (slot.isHittable() || reactiveArmorCrit)) {</span>

<span class="nc bnc" id="L27282" title="All 2 branches missed.">                if (slot.isArmored()) {</span>
<span class="nc" id="L27283">                    r = new Report(6710);</span>
<span class="nc" id="L27284">                    r.subject = en.getId();</span>
<span class="nc bnc" id="L27285" title="All 2 branches missed.">                    if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
                        // Pretty sure that only 'mechs have system crits,
                        // but just in case....
<span class="nc bnc" id="L27288" title="All 2 branches missed.">                        if (en instanceof Mech) {</span>
<span class="nc" id="L27289">                            r.add(((Mech) en).getSystemName(slot.getIndex()));</span>
                        }
                    } else {
                        // Shouldn't be null, but we'll be careful...
<span class="nc bnc" id="L27293" title="All 2 branches missed.">                        if (slot.getMount() != null) {</span>
<span class="nc" id="L27294">                            r.add(slot.getMount().getName());</span>
                        }
                    }
<span class="nc" id="L27297">                    vDesc.addElement(r);</span>
<span class="nc" id="L27298">                    slot.setArmored(false);</span>
<span class="nc" id="L27299">                    hits--;</span>
<span class="nc" id="L27300">                    continue;</span>
                }
                // if explosive use edge
<span class="nc bnc" id="L27303" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L27304" title="All 2 branches missed.">                        &amp;&amp; (en.getCrew().hasEdgeRemaining() &amp;&amp; en.getCrew().getOptions()</span>
<span class="nc bnc" id="L27305" title="All 2 branches missed.">                                .booleanOption(OptionsConstants.EDGE_WHEN_EXPLOSION))</span>
<span class="nc bnc" id="L27306" title="All 2 branches missed.">                        &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27307" title="All 2 branches missed.">                        &amp;&amp; slot.getMount().getType().isExplosive(slot.getMount())) {</span>
<span class="nc" id="L27308">                    en.getCrew().decreaseEdge();</span>
<span class="nc" id="L27309">                    r = new Report(6530);</span>
<span class="nc" id="L27310">                    r.subject = en.getId();</span>
<span class="nc" id="L27311">                    r.indent(3);</span>
<span class="nc" id="L27312">                    r.add(en.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L27313">                    vDesc.addElement(r);</span>
<span class="nc" id="L27314">                    continue;</span>
                }

                // check for reactive armor exploding
<span class="nc bnc" id="L27318" title="All 2 branches missed.">                if (reactiveArmorCrit) {</span>
<span class="nc" id="L27319">                    Mounted mount = slot.getMount();</span>
<span class="nc bnc" id="L27320" title="All 4 branches missed.">                    if ((mount != null) &amp;&amp; mount.getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L27321">                        int roll = Compute.d6(2);</span>
<span class="nc" id="L27322">                        r = new Report(6082);</span>
<span class="nc" id="L27323">                        r.subject = en.getId();</span>
<span class="nc" id="L27324">                        r.indent(3);</span>
<span class="nc" id="L27325">                        r.add(roll);</span>
<span class="nc" id="L27326">                        vDesc.addElement(r);</span>
                        // big budda boom
<span class="nc bnc" id="L27328" title="All 2 branches missed.">                        if (roll == 2) {</span>
<span class="nc" id="L27329">                            r = new Report(6083);</span>
<span class="nc" id="L27330">                            r.subject = en.getId();</span>
<span class="nc" id="L27331">                            r.indent(4);</span>
<span class="nc" id="L27332">                            vDesc.addElement(r);</span>
<span class="nc" id="L27333">                            Vector&lt;Report&gt; newReports = new Vector&lt;&gt;(damageEntity(en,</span>
<span class="nc" id="L27334">                                    new HitData(loc), en.getArmor(loc)));</span>
<span class="nc bnc" id="L27335" title="All 2 branches missed.">                            if (en.hasRearArmor(loc)) {</span>
<span class="nc" id="L27336">                                newReports.addAll(damageEntity(en, new HitData(loc, true),</span>
<span class="nc" id="L27337">                                        en.getArmor(loc, true)));</span>
                            }
<span class="nc" id="L27339">                            newReports.addAll(damageEntity(en, new HitData(loc), 1));</span>
<span class="nc bnc" id="L27340" title="All 2 branches missed.">                            for (Report rep : newReports) {</span>
<span class="nc" id="L27341">                                rep.indent(4);</span>
<span class="nc" id="L27342">                            }</span>
<span class="nc" id="L27343">                            vDesc.addAll(newReports);</span>
<span class="nc" id="L27344">                        } else {</span>
                            // If only hittable crits are reactive,
                            // this crit is absorbed
<span class="nc" id="L27347">                            boolean allHittableCritsReactive = true;</span>
<span class="nc bnc" id="L27348" title="All 2 branches missed.">                            for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L27349">                                CriticalSlot crit = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L27350" title="All 2 branches missed.">                                if (crit.isHittable()) {</span>
<span class="nc" id="L27351">                                    allHittableCritsReactive = false;</span>
<span class="nc" id="L27352">                                    break;</span>
                                }
                                // We must have reactive crits to get to this
                                // point, so if nothing else is hittable, we
                                // must only have reactive crits
                            }
<span class="nc bnc" id="L27358" title="All 2 branches missed.">                            if (allHittableCritsReactive) {</span>
<span class="nc" id="L27359">                                hits--;</span>
                            }
                            continue;
                        }
                    }
                }
<span class="nc" id="L27365">                vDesc.addAll(applyCriticalHit(en, loc, slot, true, damage, isCapital));</span>
<span class="nc" id="L27366">                hits--;</span>
            }
<span class="nc" id="L27368">        } // Hit another slot in this location.</span>

<span class="nc" id="L27370">        return vDesc;</span>
    }

    /**
     * Checks for location breach and returns phase logging.
     * &lt;p/&gt;
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc    the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *               checked for a breach.
     * @param hex    the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *               value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *               an attack, and non-null if it occurs during movement.
     */
    private Vector&lt;Report&gt; breachCheck(Entity entity, int loc, IHex hex) {
<span class="nc" id="L27385">        return breachCheck(entity, loc, hex, false);</span>
    }

    /**
     * Checks for location breach and returns phase logging.
     * &lt;p/&gt;
     *
     * @param entity     the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc        the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *                   checked for a breach.
     * @param hex        the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *                   value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *                   an attack, and non-null if it occurs during movement.
     * @param underWater Is the breach check a result of an underwater attack?
     */
    private Vector&lt;Report&gt; breachCheck(Entity entity, int loc, IHex hex, boolean underWater) {
<span class="nc" id="L27401">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // Infantry do not suffer breaches, nor do Telemissiles
        // VTOLs can't operate in vacuum or underwater, so no breaches
<span class="nc bnc" id="L27406" title="All 6 branches missed.">        if (entity instanceof Infantry || entity instanceof TeleMissile || entity instanceof VTOL) {</span>
<span class="nc" id="L27407">            return vDesc;</span>
        }

<span class="nc" id="L27410">        boolean dumping = false;</span>
<span class="nc bnc" id="L27411" title="All 2 branches missed.">        for (Mounted m : entity.getAmmo()) {</span>
<span class="nc bnc" id="L27412" title="All 2 branches missed.">            if (m.isDumping()) {</span>
                // dumping ammo underwater is very stupid thing to do
<span class="nc" id="L27414">                dumping = true;</span>
<span class="nc" id="L27415">                break;</span>
            }
<span class="nc" id="L27417">        }</span>
        // This handles both water and vacuum breaches.
        // Also need to account for hull breaches on surface naval vessels which
        // are technically not &quot;wet&quot;
<span class="nc bnc" id="L27421" title="All 2 branches missed.">        if ((entity.getLocationStatus(loc) &gt; ILocationExposureStatus.NORMAL)</span>
<span class="nc bnc" id="L27422" title="All 4 branches missed.">                || (entity.isSurfaceNaval() &amp;&amp; (loc != ((Tank) entity).getLocTurret()))) {</span>
            // Does the location have armor (check rear armor on Mek)
            // and is the check due to damage?
<span class="nc" id="L27425">            int breachroll = 0;</span>
            // set the target roll for the breach
<span class="nc" id="L27427">            int target = 10;</span>
            // if this is a vacuum check and we are in trace atmosphere then
            // adjust target
<span class="nc bnc" id="L27430" title="All 2 branches missed.">            if ((entity.getLocationStatus(loc) == ILocationExposureStatus.VACUUM)</span>
<span class="nc bnc" id="L27431" title="All 2 branches missed.">                    &amp;&amp; (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_TRACE)) {</span>
<span class="nc" id="L27432">                target = 12;</span>
            }
            // if this is a surface naval vessel and the attack is not from
            // underwater
            // then the breach should only occur on a roll of 12
<span class="nc bnc" id="L27437" title="All 4 branches missed.">            if (entity.isSurfaceNaval() &amp;&amp; !underWater) {</span>
<span class="nc" id="L27438">                target = 12;</span>
            }
<span class="nc bnc" id="L27440" title="All 4 branches missed.">            if ((entity.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27441" title="All 4 branches missed.">                    &amp;&amp; (!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0) &amp;&amp; (null == hex)) {</span>
                // functional HarJel prevents breach
<span class="nc bnc" id="L27443" title="All 2 branches missed.">                if (entity.hasHarJelIn(loc)) {</span>
<span class="nc" id="L27444">                    r = new Report(6342);</span>
<span class="nc" id="L27445">                    r.subject = entity.getId();</span>
<span class="nc" id="L27446">                    r.indent(3);</span>
<span class="nc" id="L27447">                    vDesc.addElement(r);</span>
<span class="nc" id="L27448">                    return vDesc;</span>
                }
<span class="nc bnc" id="L27450" title="All 4 branches missed.">                if ((entity instanceof Mech) &amp;&amp; (((Mech) entity).hasHarJelIIIn(loc)</span>
<span class="nc bnc" id="L27451" title="All 2 branches missed.">                        || ((Mech) entity).hasHarJelIIIIn(loc))) {</span>
<span class="nc" id="L27452">                    r = new Report(6343);</span>
<span class="nc" id="L27453">                    r.subject = entity.getId();</span>
<span class="nc" id="L27454">                    r.indent(3);</span>
<span class="nc" id="L27455">                    vDesc.addElement(r);</span>
<span class="nc" id="L27456">                    target -= 2;</span>
                }
                // Impact-resistant armor easier to breach
<span class="nc bnc" id="L27459" title="All 2 branches missed.">                if ((entity.getArmorType(loc) == EquipmentType.T_ARMOR_IMPACT_RESISTANT)) {</span>
<span class="nc" id="L27460">                    r = new Report(6344);</span>
<span class="nc" id="L27461">                    r.subject = entity.getId();</span>
<span class="nc" id="L27462">                    r.indent(3);</span>
<span class="nc" id="L27463">                    vDesc.addElement(r);</span>
<span class="nc" id="L27464">                    target += 1;</span>
                }
<span class="nc" id="L27466">                breachroll = Compute.d6(2);</span>
<span class="nc" id="L27467">                r = new Report(6345);</span>
<span class="nc" id="L27468">                r.subject = entity.getId();</span>
<span class="nc" id="L27469">                r.indent(3);</span>
<span class="nc" id="L27470">                r.add(entity.getLocationAbbr(loc));</span>
<span class="nc" id="L27471">                r.add(breachroll);</span>
<span class="nc" id="L27472">                r.newlines = 0;</span>
<span class="nc bnc" id="L27473" title="All 2 branches missed.">                if (breachroll &gt;= target) {</span>
<span class="nc" id="L27474">                    r.choose(false);</span>
                } else {
<span class="nc" id="L27476">                    r.choose(true);</span>
                }
<span class="nc" id="L27478">                vDesc.addElement(r);</span>
            }
            // Breach by damage or lack of armor.
<span class="nc bnc" id="L27481" title="All 16 branches missed.">            if ((breachroll &gt;= target) || !(entity.getArmor(loc) &gt; 0)</span>
                    || (dumping &amp;&amp; (!(entity instanceof Mech)
                        || (loc == Mech.LOC_CT) || (loc == Mech.LOC_RT) || (loc == Mech.LOC_LT)))
<span class="nc bnc" id="L27484" title="All 2 branches missed.">                    || !(!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0)) {</span>
                // Functional HarJel prevents breach as long as armor remains
                // (and, presumably, as long as you don't open your chassis on
                // purpose, say to dump ammo...).
<span class="nc bnc" id="L27488" title="All 6 branches missed.">                if ((entity.hasHarJelIn(loc)) &amp;&amp; (entity.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27489" title="All 4 branches missed.">                    &amp;&amp; (!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0) &amp;&amp; !dumping) {</span>
<span class="nc" id="L27490">                    r = new Report(6342);</span>
<span class="nc" id="L27491">                    r.subject = entity.getId();</span>
<span class="nc" id="L27492">                    r.indent(3);</span>
<span class="nc" id="L27493">                    vDesc.addElement(r);</span>
<span class="nc" id="L27494">                    return vDesc;</span>
                }
<span class="nc" id="L27496">                vDesc.addAll(breachLocation(entity, loc, hex, false));</span>
            }
        }
<span class="nc" id="L27499">        return vDesc;</span>
    }

    /**
     * Marks all equipment in a location on an entity as useless.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc    the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *               checked for a breach.
     * @param hex    the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *               value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *               an attack, and non-null if it occurs during movement.
     * @param harJel a &lt;code&gt;boolean&lt;/code&gt; value indicating if the uselessness is
     *               the cause of a critically hit HarJel system
     */
    private Vector&lt;Report&gt; breachLocation(Entity entity, int loc, IHex hex, boolean harJel) {
<span class="nc" id="L27515">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L27518" title="All 2 branches missed.">        if ((entity.getInternal(loc) &lt; 0)</span>
<span class="nc bnc" id="L27519" title="All 2 branches missed.">                || (entity.getLocationStatus(loc) &lt; ILocationExposureStatus.NORMAL)) {</span>
            // already destroyed or breached? don't bother
<span class="nc" id="L27521">            return vDesc;</span>
        }

<span class="nc" id="L27524">        r = new Report(6350);</span>
<span class="nc bnc" id="L27525" title="All 2 branches missed.">        if (harJel) {</span>
<span class="nc" id="L27526">            r.messageId = 6351;</span>
        }
<span class="nc" id="L27528">        r.subject = entity.getId();</span>
<span class="nc" id="L27529">        r.add(entity.getShortName());</span>
<span class="nc" id="L27530">        r.add(entity.getLocationAbbr(loc));</span>
<span class="nc" id="L27531">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L27533" title="All 2 branches missed.">        if (entity instanceof Tank) {</span>
<span class="nc" id="L27534">            vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;, true, true));</span>
<span class="nc" id="L27535">            return vDesc;</span>
        }
<span class="nc bnc" id="L27537" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L27538">            Mech mech = (Mech) entity;</span>
            // equipment and crits will be marked in applyDamage?

            // equipment marked missing
<span class="nc bnc" id="L27542" title="All 2 branches missed.">            for (Mounted mounted : entity.getEquipment()) {</span>
<span class="nc bnc" id="L27543" title="All 2 branches missed.">                if (mounted.getLocation() == loc) {</span>
<span class="nc" id="L27544">                    mounted.setBreached(true);</span>
                }
<span class="nc" id="L27546">            }</span>
            // all critical slots set as useless
<span class="nc bnc" id="L27548" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L27549">                final CriticalSlot cs = entity.getCritical(loc, i);</span>
<span class="nc bnc" id="L27550" title="All 2 branches missed.">                if (cs != null) {</span>
                    // for every undamaged actuator destroyed by breaching,
                    // we make a PSR (see bug 1040858)
<span class="nc bnc" id="L27553" title="All 4 branches missed.">                    if (entity.locationIsLeg(loc) &amp;&amp; entity.canFall(true)) {</span>
<span class="nc bnc" id="L27554" title="All 2 branches missed.">                        if (cs.isHittable()) {</span>
<span class="nc bnc" id="L27555" title="All 3 branches missed.">                            switch (cs.getIndex()) {</span>
                                case Mech.ACTUATOR_UPPER_LEG:
                                case Mech.ACTUATOR_LOWER_LEG:
                                case Mech.ACTUATOR_FOOT:
                                    // leg/foot actuator piloting roll
<span class="nc" id="L27560">                                    game.addPSR(new PilotingRollData(entity.getId(), 1,</span>
                                            &quot;leg/foot actuator hit&quot;));
<span class="nc" id="L27562">                                    break;</span>
                                case Mech.ACTUATOR_HIP:
                                    // hip piloting roll at +0, because we get the +2 anyway
                                    // because the location is breached.
                                    // The phase report will look a bit weird, but the
                                    // roll is correct
<span class="nc" id="L27568">                                    game.addPSR(new PilotingRollData(entity.getId(), 0,</span>
                                            &quot;hip actuator hit&quot;));
                                    break;
                            }
                        }
                    }
<span class="nc" id="L27574">                    cs.setBreached(true);</span>
                }
            }

            // Check location for engine/cockpit breach and report accordingly
<span class="nc bnc" id="L27579" title="All 2 branches missed.">            if (loc == Mech.LOC_CT) {</span>
<span class="nc" id="L27580">                vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;));</span>
<span class="nc bnc" id="L27581" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L27582">                    vDesc.addAll(abandonEntity(entity));</span>
                }
            }
<span class="nc bnc" id="L27585" title="All 2 branches missed.">            if (loc == Mech.LOC_HEAD) {</span>
<span class="nc" id="L27586">                entity.getCrew().setDoomed(true);</span>
<span class="nc" id="L27587">                vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;));</span>
<span class="nc bnc" id="L27588" title="All 2 branches missed.">                if (entity.getLocationStatus(loc) == ILocationExposureStatus.WET) {</span>
<span class="nc" id="L27589">                    r = new Report(6355);</span>
                } else {
<span class="nc" id="L27591">                    r = new Report(6360);</span>
                }
<span class="nc" id="L27593">                r.subject = entity.getId();</span>
<span class="nc" id="L27594">                r.addDesc(entity);</span>
<span class="nc" id="L27595">                vDesc.addElement(r);</span>
            }

            // Set the status of the location.
            // N.B. if we set the status before rolling water PSRs, we get a
            // &quot;LEG DESTROYED&quot; modifier; setting the status after gives a hip
            // actuator modifier.
<span class="nc" id="L27602">            entity.setLocationStatus(loc, ILocationExposureStatus.BREACHED);</span>

            // Did the hull breach destroy the engine?
<span class="nc" id="L27605">            int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L27606" title="All 4 branches missed.">            if (mech.isSuperHeavy() &amp;&amp; mech.hasEngine()</span>
<span class="nc bnc" id="L27607" title="All 2 branches missed.">                    &amp;&amp; (mech.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L27608">                hitsToDestroy = 2;</span>
            }
<span class="nc" id="L27610">            if ((entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_LT)</span>
<span class="nc" id="L27611">                    + entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_CT)</span>
<span class="nc bnc" id="L27612" title="All 2 branches missed.">                    + entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_RT))</span>
                    &gt;= hitsToDestroy) {
<span class="nc" id="L27614">                vDesc.addAll(destroyEntity(entity, &quot;engine destruction&quot;));</span>
<span class="nc bnc" id="L27615" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L27616">                    vDesc.addAll(abandonEntity(entity));</span>
                }
            }

<span class="nc bnc" id="L27620" title="All 2 branches missed.">            if (loc == Mech.LOC_LT) {</span>
<span class="nc" id="L27621">                vDesc.addAll(breachLocation(entity, Mech.LOC_LARM, hex, false));</span>
            }
<span class="nc bnc" id="L27623" title="All 2 branches missed.">            if (loc == Mech.LOC_RT) {</span>
<span class="nc" id="L27624">                vDesc.addAll(breachLocation(entity, Mech.LOC_RARM, hex, false));</span>
            }
        }

<span class="nc" id="L27628">        return vDesc;</span>
    }

    /**
     * Mark the unit as destroyed! Units transported in the destroyed unit will
     * get a chance to escape.
     *
     * @param entity - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *               destroyed.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    private Vector&lt;Report&gt; destroyEntity(Entity entity, String reason) {
<span class="nc" id="L27642">        return destroyEntity(entity, reason, true);</span>
    }

    /**
     * Marks a unit as destroyed! Units transported inside the destroyed unit
     * will get a chance to escape unless the destruction was not survivable.
     *
     * @param entity     - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason     - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *                   destroyed.
     * @param survivable - a &lt;code&gt;boolean&lt;/code&gt; that identifies the destruction as
     *                   unsurvivable for transported units.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    public Vector&lt;Report&gt; destroyEntity(Entity entity, String reason, boolean survivable) {
        // Generally, the entity can still be salvaged.
<span class="nc" id="L27659">        return destroyEntity(entity, reason, survivable, true);</span>
    }

    /**
     * Marks a unit as destroyed! Units transported inside the destroyed unit
     * will get a chance to escape unless the destruction was not survivable.
     *
     * @param entity     - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason     - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *                   destroyed.
     * @param survivable - a &lt;code&gt;boolean&lt;/code&gt; that identifies the destruction as
     *                   unsurvivable for transported units.
     * @param canSalvage - a &lt;code&gt;boolean&lt;/code&gt; that indicates if the unit can be
     *                   salvaged (or cannibalized for spare parts). If
     *                   &lt;code&gt;true&lt;/code&gt;, salvage operations are possible, if
     *                   &lt;code&gt;false&lt;/code&gt;, the unit is too badly damaged.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    public Vector&lt;Report&gt; destroyEntity(Entity entity, String reason, boolean survivable,
                                         boolean canSalvage) {
        // can't destroy an entity if it's already been destroyed        
<span class="nc bnc" id="L27681" title="All 2 branches missed.">        if(entity.isDestroyed()) {</span>
<span class="nc" id="L27682">            return new Vector&lt;Report&gt;();</span>
        }
        
<span class="nc" id="L27685">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
        
        //We'll need this later...
<span class="nc" id="L27689">        Aero ship = null;</span>
<span class="nc bnc" id="L27690" title="All 2 branches missed.">        if (entity.isLargeCraft()) {</span>
<span class="nc" id="L27691">            ship = (Aero) entity;</span>
        }

        // regardless of what was passed in, units loaded onto aeros not on the
        // ground are destroyed
<span class="nc bnc" id="L27696" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>
<span class="nc" id="L27697">            survivable = false;</span>
<span class="nc bnc" id="L27698" title="All 2 branches missed.">        } else if (entity.isAero()) {</span>
<span class="nc" id="L27699">            survivable = true;</span>
        }

        // The unit can suffer an ammo explosion after it has been destroyed.
<span class="nc" id="L27703">        int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L27704" title="All 2 branches missed.">        if (!canSalvage) {</span>
<span class="nc" id="L27705">            entity.setSalvage(false);</span>
<span class="nc" id="L27706">            condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
        }

        // Destroy the entity, unless it's already destroyed.
<span class="nc bnc" id="L27710" title="All 4 branches missed.">        if (!entity.isDoomed() &amp;&amp; !entity.isDestroyed()) {</span>
<span class="nc" id="L27711">            r = new Report(6365);</span>
<span class="nc" id="L27712">            r.subject = entity.getId();</span>
<span class="nc" id="L27713">            r.addDesc(entity);</span>
<span class="nc" id="L27714">            r.add(reason);</span>
<span class="nc" id="L27715">            vDesc.addElement(r);</span>

<span class="nc" id="L27717">            entity.setDoomed(true);</span>

            // Kill any picked up MechWarriors
<span class="nc" id="L27720">            Enumeration&lt;Integer&gt; iter = entity.getPickedUpMechWarriors().elements();</span>
<span class="nc bnc" id="L27721" title="All 2 branches missed.">            while (iter.hasMoreElements()) {</span>
<span class="nc" id="L27722">                int mechWarriorId = iter.nextElement();</span>
<span class="nc" id="L27723">                Entity mw = game.getEntity(mechWarriorId);</span>

                // in some situations, a &quot;picked up&quot; mechwarrior won't actually exist
                // probably this is brought about by picking up a mechwarrior in a previous MekHQ scenario
                // then having the same unit get blown up in a subsequent scenario
                // in that case, we simply move on
<span class="nc bnc" id="L27729" title="All 2 branches missed.">                if(mw == null) {</span>
<span class="nc" id="L27730">                    continue;</span>
                }

<span class="nc" id="L27733">                mw.setDestroyed(true);</span>
                // We can safely remove these, as they can't be targeted
<span class="nc" id="L27735">                game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L27736">                entityUpdate(mw.getId());</span>
<span class="nc" id="L27737">                send(createRemoveEntityPacket(mw.getId(), condition));</span>
<span class="nc" id="L27738">                r = new Report(6370);</span>
<span class="nc" id="L27739">                r.subject = mw.getId();</span>
<span class="nc" id="L27740">                r.addDesc(mw);</span>
<span class="nc" id="L27741">                vDesc.addElement(r);</span>
<span class="nc" id="L27742">            }</span>

            // make any remaining telemissiles operated by this entity
            // out of contact
<span class="nc bnc" id="L27746" title="All 2 branches missed.">            for (int missileId : entity.getTMTracker().getMissiles()) {</span>
<span class="nc" id="L27747">                Entity tm = game.getEntity(missileId);</span>
<span class="nc bnc" id="L27748" title="All 6 branches missed.">                if ((null != tm) &amp;&amp; !tm.isDestroyed() &amp;&amp; (tm instanceof TeleMissile)) {</span>
<span class="nc" id="L27749">                    ((TeleMissile) tm).setOutContact(true);</span>
<span class="nc" id="L27750">                    entityUpdate(tm.getId());</span>
                }
<span class="nc" id="L27752">            }</span>

            // Mechanized BA that could die on a 3+
<span class="nc" id="L27755">            ArrayList&lt;Entity&gt; externalUnits = entity.getExternalUnits();</span>

            // Handle escape of transported units.
<span class="nc bnc" id="L27758" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L27759">                Coords curPos = entity.getPosition();</span>
<span class="nc" id="L27760">                int curFacing = entity.getFacing();</span>
<span class="nc bnc" id="L27761" title="All 2 branches missed.">                for (Entity other : entity.getLoadedUnits()) {</span>
                    //If the unit has been destroyed (as from a cargo hit), skip it
<span class="nc bnc" id="L27763" title="All 2 branches missed.">                    if (other.isDestroyed()) {</span>
<span class="nc" id="L27764">                        continue;</span>
                    }
                    // Can the other unit survive?
<span class="nc" id="L27767">                    boolean survived = false;</span>
<span class="nc bnc" id="L27768" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L27769" title="All 2 branches missed.">                        if ((entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L27770" title="All 2 branches missed.">                                || (entity.getMovementMode() == EntityMovementMode.HYDROFOIL)) {</span>
<span class="nc bnc" id="L27771" title="All 2 branches missed.">                            if (other.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L27772" title="All 2 branches missed.">                                survived = Compute.d6() &lt;= 3;</span>
<span class="nc bnc" id="L27773" title="All 2 branches missed.">                            } else if (other.getMovementMode() == EntityMovementMode.INF_JUMP) {</span>
<span class="nc bnc" id="L27774" title="All 2 branches missed.">                                survived = Compute.d6() == 1;</span>
<span class="nc bnc" id="L27775" title="All 2 branches missed.">                            } else if (other.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L27776" title="All 2 branches missed.">                                survived = Compute.d6() &lt;= 2;</span>
                            }
<span class="nc bnc" id="L27778" title="All 2 branches missed.">                        } else if (entity.getMovementMode() == EntityMovementMode.SUBMARINE) {</span>
<span class="nc bnc" id="L27779" title="All 2 branches missed.">                            if (other.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L27780" title="All 2 branches missed.">                                survived = Compute.d6() == 1;</span>
                            }
                        } else {
<span class="nc bnc" id="L27783" title="All 2 branches missed.">                            survived = Compute.d6() &lt;= 4;</span>
                        }
<span class="nc bnc" id="L27785" title="All 2 branches missed.">                    } else if (entity instanceof Mech) {</span>
                        // mechanized BA can escape on a roll of 1 or 2
<span class="nc bnc" id="L27787" title="All 2 branches missed.">                        if (externalUnits.contains(other)) {</span>
<span class="nc bnc" id="L27788" title="All 2 branches missed.">                            survived = Compute.d6() &lt; 3;</span>
                        }
                    }
<span class="nc bnc" id="L27791" title="All 8 branches missed.">                    if (!survivable || (externalUnits.contains(other) &amp;&amp; !survived)</span>
                            //Don't unload from ejecting spacecraft. The crews aren't in their units...
<span class="nc bnc" id="L27793" title="All 2 branches missed.">                            || (ship != null &amp;&amp; ship.isEjecting())) {</span>
                        // Nope.
<span class="nc" id="L27795">                        other.setDestroyed(true);</span>
                        // We need to unload the unit, since it's ID goes away
<span class="nc" id="L27797">                        entity.unload(other);</span>
                        // Safe to remove, as they aren't targeted
<span class="nc" id="L27799">                        game.moveToGraveyard(other.getId());</span>
<span class="nc" id="L27800">                        send(createRemoveEntityPacket(other.getId(), condition));</span>
<span class="nc" id="L27801">                        r = new Report(6370);</span>
<span class="nc" id="L27802">                        r.subject = other.getId();</span>
<span class="nc" id="L27803">                        r.addDesc(other);</span>
<span class="nc" id="L27804">                        vDesc.addElement(r);</span>
                    }
                    // Can we unload the unit to the current hex?
                    // TODO : unloading into stacking violation is not
                    // explicitly prohibited in the BMRr.
<span class="nc bnc" id="L27809" title="All 2 branches missed.">                    else if ((null != Compute.stackingViolation(game, other.getId(), curPos))</span>
<span class="nc bnc" id="L27810" title="All 2 branches missed.">                             || other.isLocationProhibited(curPos)) {</span>
                        // Nope.
<span class="nc" id="L27812">                        other.setDestroyed(true);</span>
                        // We need to unload the unit, since it's ID goes away
<span class="nc" id="L27814">                        entity.unload(other);</span>
                        // Safe to remove, as they aren't targeted
<span class="nc" id="L27816">                        game.moveToGraveyard(other.getId());</span>
<span class="nc" id="L27817">                        send(createRemoveEntityPacket(other.getId(), condition));</span>
<span class="nc" id="L27818">                        r = new Report(6375);</span>
<span class="nc" id="L27819">                        r.subject = other.getId();</span>
<span class="nc" id="L27820">                        r.addDesc(other);</span>
<span class="nc" id="L27821">                        vDesc.addElement(r);</span>
                    } // End can-not-unload
                    else {
                        // The other unit survives.
<span class="nc" id="L27825">                        unloadUnit(entity, other, curPos, curFacing,</span>
<span class="nc" id="L27826">                                   entity.getElevation(), true, false);</span>
                    }

<span class="nc" id="L27829">                } // Handle the next transported unit.</span>

            } // End has-transported-unit

            // Handle transporting unit.
<span class="nc bnc" id="L27834" title="All 2 branches missed.">            if (Entity.NONE != entity.getTransportId()) {</span>
<span class="nc" id="L27835">                final Entity transport = game.getEntity(entity.getTransportId());</span>
<span class="nc" id="L27836">                Coords curPos = transport.getPosition();</span>
<span class="nc" id="L27837">                int curFacing = transport.getFacing();</span>
<span class="nc bnc" id="L27838" title="All 2 branches missed.">                if (!transport.isLargeCraft()) {</span>
<span class="nc" id="L27839">                    unloadUnit(transport, entity, curPos, curFacing, transport.getElevation());</span>
                }
<span class="nc" id="L27841">                entityUpdate(transport.getId());</span>

                // if this is the last fighter in a fighter squadron then remove
                // the squadron
<span class="nc bnc" id="L27845" title="All 2 branches missed.">                if ((transport instanceof FighterSquadron)</span>
<span class="nc bnc" id="L27846" title="All 2 branches missed.">                        &amp;&amp; transport.getSubEntities().orElse(Collections.emptyList()).isEmpty()) {</span>
<span class="nc" id="L27847">                    transport.setDestroyed(true);</span>
                    // Can't remove this here, otherwise later attacks will fail
                    //game.moveToGraveyard(transport.getId());
                    //entityUpdate(transport.getId());
                    //send(createRemoveEntityPacket(transport.getId(), condition));
<span class="nc" id="L27852">                    r = new Report(6365);</span>
<span class="nc" id="L27853">                    r.subject = transport.getId();</span>
<span class="nc" id="L27854">                    r.addDesc(transport);</span>
<span class="nc" id="L27855">                    r.add(&quot;fighter destruction&quot;);</span>
<span class="nc" id="L27856">                    vDesc.addElement(r);</span>
                }

            } // End unit-is-transported

            // Is this unit towing some trailers?
            // If so, disconnect them
<span class="nc bnc" id="L27863" title="All 2 branches missed.">            if (!entity.getAllTowedUnits().isEmpty()) {</span>
                //Find the first trailer in the list and drop it
                //this will disconnect all that follow too
<span class="nc" id="L27866">                Entity leadTrailer = game.getEntity(entity.getAllTowedUnits().get(0));</span>
<span class="nc" id="L27867">                disconnectUnit(entity, leadTrailer, entity.getPosition());</span>
            }

            // Is this unit a trailer being towed? If so, disconnect it from its tractor
<span class="nc bnc" id="L27871" title="All 2 branches missed.">            if (entity.getTractor() != Entity.NONE) {</span>
<span class="nc" id="L27872">                Entity tractor = game.getEntity(entity.getTractor());</span>
<span class="nc" id="L27873">                disconnectUnit(tractor, entity, tractor.getPosition());</span>
            }

            // Is this unit being swarmed?
<span class="nc" id="L27877">            final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L27878" title="All 2 branches missed.">            if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L27879">                final Entity swarmer = game.getEntity(swarmerId);</span>

<span class="nc" id="L27881">                swarmer.setSwarmTargetId(Entity.NONE);</span>
                // a unit that stopped swarming due to the swarmed unit dieing
                // should be able to move: setSwarmTargetId to Entity.None
                // changes done to true and unloaded to true, need to undo this
<span class="nc" id="L27885">                swarmer.setUnloaded(false);</span>
<span class="nc" id="L27886">                swarmer.setDone(false);</span>
<span class="nc" id="L27887">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L27888">                Report.addNewline(vDesc);</span>
<span class="nc" id="L27889">                r = new Report(6380);</span>
<span class="nc" id="L27890">                r.subject = swarmerId;</span>
<span class="nc" id="L27891">                r.addDesc(swarmer);</span>
<span class="nc" id="L27892">                vDesc.addElement(r);</span>
                // Swarming infantry shouldn't take damage when their target dies
                // http://bg.battletech.com/forums/total-warfare/swarming-question
<span class="nc" id="L27895">                entityUpdate(swarmerId);</span>
            }

            // Is this unit swarming somebody?
<span class="nc" id="L27899">            final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L27900" title="All 2 branches missed.">            if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L27901">                final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L27902">                swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L27903">                entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L27904">                r = new Report(6385);</span>
<span class="nc" id="L27905">                r.subject = swarmed.getId();</span>
<span class="nc" id="L27906">                r.addDesc(swarmed);</span>
<span class="nc" id="L27907">                vDesc.addElement(r);</span>
<span class="nc" id="L27908">                entityUpdate(swarmedId);</span>
            }

            // If in a grapple, release both mechs
<span class="nc bnc" id="L27912" title="All 2 branches missed.">            if (entity.getGrappled() != Entity.NONE) {</span>
<span class="nc" id="L27913">                int grappler = entity.getGrappled();</span>
<span class="nc" id="L27914">                entity.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L27915">                Entity e = game.getEntity(grappler);</span>
<span class="nc bnc" id="L27916" title="All 2 branches missed.">                if (e != null) {</span>
<span class="nc" id="L27917">                    e.setGrappled(Entity.NONE, false);</span>
                }
<span class="nc" id="L27919">                entityUpdate(grappler);</span>
            }
        } // End entity-not-already-destroyed.

        // if using battlefield wreckage rules, then the destruction of this
        // unit
        // might convert the hex to rough
<span class="nc" id="L27926">        Coords curPos = entity.getPosition();</span>
<span class="nc" id="L27927">        IHex entityHex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L27928" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_BATTLE_WRECK)</span>
<span class="nc bnc" id="L27929" title="All 6 branches missed.">                &amp;&amp; (entityHex != null) &amp;&amp; game.getBoard().onGround()</span>
                &amp;&amp; !((entity instanceof Infantry) || (entity instanceof Protomech))) {
            // large support vees will create ultra rough, otherwise rough
<span class="nc bnc" id="L27932" title="All 2 branches missed.">            if (entity instanceof LargeSupportTank) {</span>
<span class="nc bnc" id="L27933" title="All 2 branches missed.">                if (entityHex.terrainLevel(Terrains.ROUGH) &lt; 2) {</span>
<span class="nc" id="L27934">                    entityHex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27935">                            .createTerrain(Terrains.ROUGH, 2));</span>
<span class="nc" id="L27936">                    sendChangedHex(curPos);</span>
                }
<span class="nc bnc" id="L27938" title="All 4 branches missed.">            } else if ((entity.getWeight() &gt;= 40) &amp;&amp; !entityHex.containsTerrain(Terrains.ROUGH)) {</span>
<span class="nc" id="L27939">                entityHex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27940">                        .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L27941">                sendChangedHex(curPos);</span>
            }
        }

        // update our entity, so clients have correct data needed for MekWars stuff
<span class="nc" id="L27946">        entityUpdate(entity.getId());</span>

<span class="nc" id="L27948">        return vDesc;</span>
    }

    /**
     * Makes a piece of equipment on a mech explode! POW! This expects either
     * ammo, or an explosive weapon. Returns a vector of Report objects.
     */
    private Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, int slot) {
<span class="nc" id="L27956">        CriticalSlot critSlot = en.getCritical(loc, slot);</span>
<span class="nc" id="L27957">        Vector&lt;Report&gt; reports = explodeEquipment(en, loc, critSlot.getMount());</span>
<span class="nc bnc" id="L27958" title="All 2 branches missed.">        if (critSlot.getMount2() != null) {</span>
<span class="nc" id="L27959">            reports.addAll(explodeEquipment(en, loc, critSlot.getMount2()));</span>
        }
<span class="nc" id="L27961">        return reports;</span>
    }

    /**
     * Explodes a piece of equipment on the unit.
     */
    public Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, Mounted mounted) { 
<span class="nc" id="L27968">        return explodeEquipment(en, loc, mounted, false);</span>
    }
    
    /**
     * Makes a piece of equipment on a mech explode! POW! This expects either
     * ammo, or an explosive weapon. Returns a vector of Report objects.
     * Possible to override 'is explosive' check
     */
    public Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, Mounted mounted, boolean overrideExplosiveCheck) {
<span class="nc" id="L27977">        final String METHOD_NAME = &quot;explodeEquipment(Entity,int,Mounted)&quot;;</span>
<span class="nc" id="L27978">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        // is this already destroyed?
<span class="nc bnc" id="L27980" title="All 2 branches missed.">        if (mounted.isDestroyed()) {</span>
<span class="nc" id="L27981">            MegaMek.getLogger().error(&quot;Called on destroyed equipment(&quot; + mounted.getName() + &quot;)&quot;);</span>
<span class="nc" id="L27982">            return vDesc;</span>
        }

        // Special case: LAM bomb bays explode the bomb stored there, which may involve going through a
        // launch weapon to the bomb ammo.
<span class="nc bnc" id="L27987" title="All 4 branches missed.">        if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc bnc" id="L27988" title="All 2 branches missed.">            while (mounted.getLinked() != null) {</span>
<span class="nc" id="L27989">                mounted = mounted.getLinked();</span>
            }
            // Fuel tank explodes on 2d6 roll of 10+
<span class="nc bnc" id="L27992" title="All 4 branches missed.">            if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_FUEL)) {</span>
<span class="nc" id="L27993">                Report r = new Report(9120);</span>
<span class="nc" id="L27994">                r.subject = en.getId();</span>
<span class="nc" id="L27995">                int boomTarget = 10;</span>
                // check for possible explosion
<span class="nc" id="L27997">                int fuelRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L27998" title="All 2 branches missed.">                r.choose(fuelRoll &gt;= boomTarget);</span>
<span class="nc bnc" id="L27999" title="All 2 branches missed.">                if (fuelRoll &gt;= boomTarget) {</span>
<span class="nc" id="L28000">                    r.choose(true);</span>
<span class="nc" id="L28001">                    vDesc.add(r);</span>
                } else {
<span class="nc" id="L28003">                    r.choose(false);</span>
<span class="nc" id="L28004">                    vDesc.add(r);</span>
<span class="nc" id="L28005">                    return vDesc;</span>
                }
            }
        }

<span class="nc bnc" id="L28010" title="All 4 branches missed.">        if(!overrideExplosiveCheck &amp;&amp; !mounted.getType().isExplosive(mounted, false)) {</span>
<span class="nc" id="L28011">            return vDesc;</span>
        }

        // Inferno ammo causes heat buildup as well as the damage
<span class="nc bnc" id="L28015" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28016" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L28017" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L28018" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_IATM)</span>
<span class="nc bnc" id="L28019" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L28020" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L28021" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28022">            en.heatBuildup += Math.min(mounted.getExplosionDamage(), 30);</span>
        }

        // Inferno bombs in LAM bomb bays
<span class="nc bnc" id="L28026" title="All 2 branches missed.">        if ((mounted.getType() instanceof BombType)</span>
<span class="nc bnc" id="L28027" title="All 2 branches missed.">                &amp;&amp; (((BombType)mounted.getType()).getBombType() == BombType.B_INFERNO)) {</span>
<span class="nc" id="L28028">            en.heatBuildup += Math.min(mounted.getExplosionDamage(), 30);</span>
        }

        // determine and deal damage
<span class="nc" id="L28032">        int damage = mounted.getExplosionDamage();</span>

        // Smoke ammo halves damage
<span class="nc bnc" id="L28035" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28036" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L28037" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L28038" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L28039" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_LRM_IMP))</span>
<span class="nc bnc" id="L28040" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_SMOKE_WARHEAD)</span>
<span class="nc bnc" id="L28041" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28042">            damage = ((mounted.getExplosionDamage()) / 2);</span>
        }
        // coolant explodes for 2 damage and reduces heat by 3
<span class="nc bnc" id="L28045" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28046" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L28047" title="All 2 branches missed.">                || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_HEAVY_FLAMER))</span>
<span class="nc bnc" id="L28048" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_COOLANT)</span>
<span class="nc bnc" id="L28049" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28050">            damage = 2;</span>
<span class="nc" id="L28051">            en.coolFromExternal += 3;</span>
        }

        // divide damage by 10 for aeros, per TW rules on pg. 161
<span class="nc bnc" id="L28055" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L28056">            int newDamage = (int) Math.floor(damage / 10.0);</span>
<span class="nc bnc" id="L28057" title="All 4 branches missed.">            if ((newDamage == 0) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L28058">                damage = 1;</span>
            } else {
<span class="nc" id="L28060">                damage = newDamage;</span>
            }
        }

<span class="nc bnc" id="L28064" title="All 2 branches missed.">        if (damage &lt;= 0) {</span>
<span class="nc" id="L28065">            return vDesc;</span>
        }

<span class="nc" id="L28068">        Report r = new Report(6390);</span>
<span class="nc" id="L28069">        r.subject = en.getId();</span>
<span class="nc" id="L28070">        r.add(mounted.getName());</span>
<span class="nc" id="L28071">        r.add(damage);</span>
<span class="nc" id="L28072">        r.indent(3);</span>
<span class="nc" id="L28073">        vDesc.addElement(r);</span>
        // Mounted is a weapon and has Hot-Loaded ammo in it and it exploded now
        // we need to roll for chain reaction
<span class="nc bnc" id="L28076" title="All 4 branches missed.">        if ((mounted.getType() instanceof WeaponType) &amp;&amp; mounted.isHotLoaded()) {</span>
<span class="nc" id="L28077">            int roll = Compute.d6(2);</span>
<span class="nc" id="L28078">            int ammoExploded = 0;</span>
<span class="nc" id="L28079">            r = new Report(6077);</span>
<span class="nc" id="L28080">            r.subject = en.getId();</span>
<span class="nc" id="L28081">            r.add(roll);</span>
<span class="nc" id="L28082">            r.indent(2);</span>
<span class="nc" id="L28083">            vDesc.addElement(r);</span>

            // roll of 2-5 means a chain reaction happened
<span class="nc bnc" id="L28086" title="All 2 branches missed.">            if (roll &lt; 6) {</span>
<span class="nc bnc" id="L28087" title="All 2 branches missed.">                for (Mounted ammo : en.getAmmo()) {</span>
<span class="nc bnc" id="L28088" title="All 4 branches missed.">                    if ((ammo.getLocation() == loc) &amp;&amp; (ammo.getExplosionDamage() &gt; 0)</span>
                            // Dead-Fire ammo bins are designed not to explode
                            // from the chain reaction
                            // Of Critted Launchers with DFM or HotLoaded ammo.
<span class="nc bnc" id="L28092" title="All 2 branches missed.">                            &amp;&amp; (((AmmoType) ammo.getType()).getMunitionType() != AmmoType.M_DEAD_FIRE)) {</span>
<span class="nc" id="L28093">                        ammoExploded++;</span>
<span class="nc" id="L28094">                        vDesc.addAll(this.explodeEquipment(en, loc, ammo));</span>
<span class="nc" id="L28095">                        break;</span>
                    }
<span class="nc" id="L28097">                }</span>
<span class="nc bnc" id="L28098" title="All 2 branches missed.">                if (ammoExploded == 0) {</span>
<span class="nc" id="L28099">                    r = new Report(6078);</span>
<span class="nc" id="L28100">                    r.subject = en.getId();</span>
<span class="nc" id="L28101">                    r.indent(2);</span>
<span class="nc" id="L28102">                    vDesc.addElement(r);</span>
                }
            } else {
<span class="nc" id="L28105">                r = new Report(6079);</span>
<span class="nc" id="L28106">                r.subject = en.getId();</span>
<span class="nc" id="L28107">                r.indent(2);</span>
<span class="nc" id="L28108">                vDesc.addElement(r);</span>
            }
        }

<span class="nc" id="L28112">        HitData hit = new HitData(loc);</span>
        // check to determine whether this is capital scale if we have a capital
        // scale entity
<span class="nc bnc" id="L28115" title="All 2 branches missed.">        if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc bnc" id="L28116" title="All 2 branches missed.">            if (((AmmoType) mounted.getType()).isCapital()) {</span>
<span class="nc" id="L28117">                hit.setCapital(true);</span>
            }
        }

        // exploding RISC laser pulse module should cause no normal crits, just
        // automatically crit the first uncritted crit of the laser it's
        // attached to
<span class="nc bnc" id="L28124" title="All 4 branches missed.">        if ((mounted.getType() instanceof MiscType)  &amp;&amp; mounted.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L28125">            hit.setEffect(HitData.EFFECT_NO_CRITICALS);</span>
<span class="nc" id="L28126">            Mounted laser = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L28127" title="All 2 branches missed.">            if (en instanceof Mech) {</span>
<span class="nc bnc" id="L28128" title="All 2 branches missed.">                for (int slot = 0; slot &lt; en.getNumberOfCriticals(laser.getLocation()); slot++) {</span>
<span class="nc" id="L28129">                    CriticalSlot cs = en.getCritical(laser.getLocation(), slot);</span>
<span class="nc bnc" id="L28130" title="All 4 branches missed.">                    if ((cs.getType() == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; cs.getMount().equals(laser)</span>
<span class="nc bnc" id="L28131" title="All 2 branches missed.">                            &amp;&amp; cs.isHittable()) {</span>
<span class="nc" id="L28132">                        cs.setHit(true);</span>
<span class="nc" id="L28133">                        cs.setRepairable(true);</span>
<span class="nc" id="L28134">                        break;</span>
                    }
                }
            }
<span class="nc" id="L28138">            laser.setHit(true);</span>
        }

<span class="nc" id="L28141">        mounted.setShotsLeft(0);</span>

<span class="nc" id="L28143">        int pilotDamage = 2;</span>
<span class="nc bnc" id="L28144" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L28145">            pilotDamage = 1;</span>
        }
<span class="nc bnc" id="L28147" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_CASE_PILOT_DAMAGE)</span>
<span class="nc bnc" id="L28148" title="All 4 branches missed.">                &amp;&amp; (en.locationHasCase(hit.getLocation()) || en.hasCASEII(hit.getLocation()))) {</span>
<span class="nc" id="L28149">            pilotDamage = 1;</span>
        }
<span class="nc bnc" id="L28151" title="All 2 branches missed.">        if (en.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)</span>
<span class="nc bnc" id="L28152" title="All 2 branches missed.">                || en.hasAbility(OptionsConstants.MISC_IRON_MAN)) {</span>
<span class="nc" id="L28153">            pilotDamage -= 1;</span>
        }
        // tanks only take pilot damage when using BVDNI or VDNI
<span class="nc bnc" id="L28156" title="All 4 branches missed.">        if ((en instanceof Tank) &amp;&amp; !(en.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L28157" title="All 2 branches missed.">                || en.hasAbility(OptionsConstants.MD_BVDNI))) {</span>
<span class="nc" id="L28158">            pilotDamage = 0;</span>
        }
<span class="nc bnc" id="L28160" title="All 2 branches missed.">        if (!en.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L28161">            vDesc.addAll(damageCrew(en, pilotDamage, en.getCrew().getCurrentPilotIndex()));</span>
        }
<span class="nc bnc" id="L28163" title="All 4 branches missed.">        if (en.getCrew().isDoomed() || en.getCrew().isDead()) {</span>
<span class="nc" id="L28164">            vDesc.addAll(destroyEntity(en, &quot;crew death&quot;, true));</span>
        } else {
<span class="nc" id="L28166">            Report.addNewline(vDesc);</span>
        }

<span class="nc" id="L28169">        Vector&lt;Report&gt; newReports = damageEntity(en, hit, damage, true);</span>
<span class="nc bnc" id="L28170" title="All 2 branches missed.">        for (Report rep : newReports) {</span>
<span class="nc" id="L28171">            rep.indent(2);</span>
<span class="nc" id="L28172">        }</span>
<span class="nc" id="L28173">        vDesc.addAll(newReports);</span>
<span class="nc" id="L28174">        Report.addNewline(vDesc);</span>

<span class="nc" id="L28176">        return vDesc;</span>
    }

    /**
     * Makes one slot of ammo, determined by certain rules, explode on a mech.
     */
    Vector&lt;Report&gt; explodeAmmoFromHeat(Entity entity) {
<span class="nc" id="L28183">        int damage = 0;</span>
<span class="nc" id="L28184">        int rack = 0;</span>
<span class="nc" id="L28185">        int boomloc = -1;</span>
<span class="nc" id="L28186">        int boomslot = -1;</span>
<span class="nc" id="L28187">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L28189" title="All 2 branches missed.">        for (int j = 0; j &lt; entity.locations(); j++) {</span>
<span class="nc bnc" id="L28190" title="All 2 branches missed.">            for (int k = 0; k &lt; entity.getNumberOfCriticals(j); k++) {</span>
<span class="nc" id="L28191">                CriticalSlot cs = entity.getCritical(j, k);</span>
<span class="nc bnc" id="L28192" title="All 6 branches missed.">                if ((cs == null) || cs.isDestroyed() || cs.isHit()</span>
<span class="nc bnc" id="L28193" title="All 2 branches missed.">                        || (cs.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L28194">                    continue;</span>
                }
<span class="nc" id="L28196">                Mounted mounted = cs.getMount();</span>
<span class="nc bnc" id="L28197" title="All 4 branches missed.">                if ((mounted == null) || (!(mounted.getType() instanceof AmmoType))) {</span>
<span class="nc" id="L28198">                    continue;</span>
                }
<span class="nc" id="L28200">                AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L28201" title="All 2 branches missed.">                if (!atype.isExplosive(mounted)) {</span>
<span class="nc" id="L28202">                    continue;</span>
                }
                // coolant pods and flamer coolant ammo don't explode from heat
<span class="nc bnc" id="L28205" title="All 2 branches missed.">                if ((atype.getAmmoType() == AmmoType.T_COOLANT_POD)</span>
<span class="nc bnc" id="L28206" title="All 2 branches missed.">                        || (((atype.getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L28207" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_HEAVY_FLAMER))</span>
<span class="nc bnc" id="L28208" title="All 2 branches missed.">                                &amp;&amp; (atype.getMunitionType() == AmmoType.M_COOLANT))) {</span>
<span class="nc" id="L28209">                    continue;</span>
                }
                // ignore empty, destroyed, or missing bins
<span class="nc bnc" id="L28212" title="All 2 branches missed.">                if (mounted.getHittableShotsLeft() == 0) {</span>
<span class="nc" id="L28213">                    continue;</span>
                }
                // TW page 160, compare one rack's
                // damage. Ties go to most rounds.
<span class="nc" id="L28217">                int newRack = atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L28218">                int newDamage = mounted.getExplosionDamage();</span>
<span class="nc" id="L28219">                Mounted mount2 = cs.getMount2();</span>
<span class="nc bnc" id="L28220" title="All 4 branches missed.">                if ((mount2 != null) &amp;&amp; (mount2.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28221" title="All 2 branches missed.">                        &amp;&amp; (mount2.getHittableShotsLeft() &gt; 0)) {</span>
                    // must be for same weaponType, so rackSize stays
<span class="nc" id="L28223">                    atype = (AmmoType) mount2.getType();</span>
<span class="nc" id="L28224">                    newRack += atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L28225">                    newDamage += mount2.getExplosionDamage();</span>
                }
<span class="nc bnc" id="L28227" title="All 8 branches missed.">                if (!mounted.isHit()</span>
                        &amp;&amp; ((rack &lt; newRack) || ((rack == newRack) &amp;&amp; (damage &lt; newDamage)))) {
<span class="nc" id="L28229">                    rack = newRack;</span>
<span class="nc" id="L28230">                    damage = newDamage;</span>
<span class="nc" id="L28231">                    boomloc = j;</span>
<span class="nc" id="L28232">                    boomslot = k;</span>
                }
            }
        }
<span class="nc bnc" id="L28236" title="All 4 branches missed.">        if ((boomloc != -1) &amp;&amp; (boomslot != -1)) {</span>
<span class="nc" id="L28237">            CriticalSlot slot = entity.getCritical(boomloc, boomslot);</span>
<span class="nc" id="L28238">            slot.setHit(true);</span>
<span class="nc" id="L28239">            slot.getMount().setHit(true);</span>
<span class="nc bnc" id="L28240" title="All 2 branches missed.">            if (slot.getMount2() != null) {</span>
<span class="nc" id="L28241">                slot.getMount2().setHit(true);</span>
            }
<span class="nc" id="L28243">            vDesc.addAll(explodeEquipment(entity, boomloc, boomslot));</span>
<span class="nc" id="L28244">        } else {</span>
            // Luckily, there is no ammo to explode.
<span class="nc" id="L28246">            Report r = new Report(5105);</span>
<span class="nc" id="L28247">            r.subject = entity.getId();</span>
<span class="nc" id="L28248">            r.indent();</span>
<span class="nc" id="L28249">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L28251">        return vDesc;</span>
    }

    /**
     * Makes a mech fall.
     *
     * @param entity
     *            The Entity that is falling. It is expected that the Entity's
     *            position and elevation reflect the state prior to the fall
     * @param fallPos
     *            The location that the Entity is falling into.
     * @param fallHeight
     *            The height that Entity is falling.
     * @param facing
     *            The facing of the fall. Used to determine the the hit location
     *            and also determines facing after the fall (used as an offset
     *            of the Entity's current facing).
     * @param roll
     *            The PSR required to avoid damage to the pilot/crew.
     * @param intoBasement
     *            Flag that determines whether this is a fall into a basement or
     *            not.
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, Coords fallPos, int fallHeight, int facing,
                                        PilotingRollData roll, boolean intoBasement, boolean fromCliff) {
<span class="nc" id="L28276">        entity.setFallen(true);</span>

<span class="nc" id="L28278">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc" id="L28281">        IHex fallHex = game.getBoard().getHex(fallPos);</span>

<span class="nc" id="L28283">        boolean handlingBasement = false;</span>
<span class="nc" id="L28284">        int damageTable = ToHitData.HIT_NORMAL;</span>

        // we don't need to deal damage yet, if the entity is doing DFA
<span class="nc bnc" id="L28287" title="All 2 branches missed.">        if (entity.isMakingDfa()) {</span>
<span class="nc" id="L28288">            r = new Report(2305);</span>
<span class="nc" id="L28289">            r.subject = entity.getId();</span>
<span class="nc" id="L28290">            vPhaseReport.add(r);</span>
<span class="nc" id="L28291">            entity.setProne(true);</span>
<span class="nc" id="L28292">            return vPhaseReport;</span>
        }

        // facing after fall
        String side;
        int table;
<span class="nc bnc" id="L28298" title="All 4 branches missed.">        switch (facing) {</span>
            case 1:
            case 2:
<span class="nc" id="L28301">                side = &quot;right side&quot;;</span>
<span class="nc" id="L28302">                table = ToHitData.SIDE_RIGHT;</span>
<span class="nc" id="L28303">                break;</span>
            case 3:
<span class="nc" id="L28305">                side = &quot;rear&quot;;</span>
<span class="nc" id="L28306">                table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L28307">                break;</span>
            case 4:
            case 5:
<span class="nc" id="L28310">                side = &quot;left side&quot;;</span>
<span class="nc" id="L28311">                table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L28312">                break;</span>
            case 0:
            default:
<span class="nc" id="L28315">                side = &quot;front&quot;;</span>
<span class="nc" id="L28316">                table = ToHitData.SIDE_FRONT;</span>
        }

<span class="nc" id="L28319">        int waterDepth = 0;</span>
<span class="nc bnc" id="L28320" title="All 2 branches missed.">        if (fallHex.containsTerrain(Terrains.WATER)) {</span>
            // *Only* use this if there actually is water in the hex, otherwise
            // we get ITerrain.LEVEL_NONE, i.e. Integer.minValue...
<span class="nc" id="L28323">            waterDepth = fallHex.terrainLevel(Terrains.WATER);</span>
        }
<span class="nc" id="L28325">        boolean fallOntoBridge = false;</span>
        // only fall onto the bridge if we were in the hex and on it,
        // or we fell from a hex that the bridge exits to
<span class="nc bnc" id="L28328" title="All 4 branches missed.">        if ((entity.climbMode() &amp;&amp; (entity.getPosition() != fallPos)</span>
<span class="nc bnc" id="L28329" title="All 2 branches missed.">                &amp;&amp; fallHex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L28330" title="All 2 branches missed.">                &amp;&amp; fallHex.containsTerrainExit(Terrains.BRIDGE, fallPos.direction(entity.getPosition())))</span>
<span class="nc bnc" id="L28331" title="All 2 branches missed.">                || (entity.getElevation() == fallHex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L28332">            fallOntoBridge = true;</span>
        }
<span class="nc" id="L28334">        int bridgeElev = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L28335">        int buildingElev = fallHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L28336">        int damageHeight = fallHeight;</span>
<span class="nc" id="L28337">        int newElevation = 0;</span>

        // we might have to check if the building/bridge we are falling onto
        // collapses
<span class="nc" id="L28341">        boolean checkCollapse = false;</span>

<span class="nc bnc" id="L28343" title="All 4 branches missed.">        if ((entity.getElevation() &gt;= buildingElev) &amp;&amp; (buildingElev &gt;= 0)) {</span>
            // fallHeight should already reflect this
<span class="nc" id="L28345">            newElevation = buildingElev;</span>
<span class="nc" id="L28346">            checkCollapse = true;</span>
<span class="nc bnc" id="L28347" title="All 6 branches missed.">        } else if (fallOntoBridge &amp;&amp; (entity.getElevation() &gt;= bridgeElev) &amp;&amp; (bridgeElev &gt;= 0)) {</span>
            // fallHeight should already reflect this
<span class="nc" id="L28349">            waterDepth = 0;</span>
<span class="nc" id="L28350">            newElevation = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L28351">            checkCollapse = true;</span>
<span class="nc bnc" id="L28352" title="All 4 branches missed.">        } else if (fallHex.containsTerrain(Terrains.ICE) &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L28353">            waterDepth = 0;</span>
<span class="nc" id="L28354">            newElevation = 0;</span>
            // If we are in a basement, we are at a negative elevation, and so
            // setting newElevation = 0 will cause us to &quot;fall up&quot;
<span class="nc bnc" id="L28357" title="All 2 branches missed.">        } else if ((entity.getMovementMode() != EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L28358" title="All 2 branches missed.">                   &amp;&amp; (game.getBoard().getBuildingAt(fallPos) != null)) {</span>
<span class="nc" id="L28359">            newElevation = entity.getElevation();</span>
        }
        // HACK: if the destination hex is water, assume that the fall height given is
        // to the floor of the hex, and modify it so that it's to the surface
<span class="nc bnc" id="L28363" title="All 2 branches missed.">        else if (waterDepth &gt; 0) {</span>
<span class="nc" id="L28364">            damageHeight = fallHeight - waterDepth;</span>
<span class="nc" id="L28365">            newElevation = -waterDepth;</span>
        }
        // only do these basement checks if we didn't fall onto the building
        // from above
<span class="nc bnc" id="L28369" title="All 2 branches missed.">        if (intoBasement) {</span>
<span class="nc" id="L28370">            Building bldg = game.getBoard().getBuildingAt(fallPos);</span>
<span class="nc" id="L28371">            BasementType basement = bldg.getBasement(fallPos);</span>
<span class="nc bnc" id="L28372" title="All 4 branches missed.">            if ((basement != BasementType.NONE) &amp;&amp; (basement != BasementType.ONE_DEEP_NORMALINFONLY)</span>
<span class="nc bnc" id="L28373" title="All 4 branches missed.">                    &amp;&amp; (entity.getElevation() == 0) &amp;&amp; (bldg.getBasementCollapsed(fallPos))) {</span>

<span class="nc bnc" id="L28375" title="All 2 branches missed.">                if (fallHex.depth(true) == 0) {</span>
<span class="nc" id="L28376">                    MegaMek.getLogger().error(&quot;Entity &quot; + entity.getDisplayName() + &quot; is falling into a depth &quot;</span>
<span class="nc" id="L28377">                            + fallHex.depth(true) + &quot; basement -- not allowed!!&quot;);</span>
<span class="nc" id="L28378">                    return vPhaseReport;</span>
                }
<span class="nc" id="L28380">                damageHeight = basement.getDepth();</span>

<span class="nc" id="L28382">                newElevation = newElevation - damageHeight;</span>

<span class="nc" id="L28384">                handlingBasement = true;</span>
                // May have to adjust hit table for 'mechs
<span class="nc bnc" id="L28386" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc bnc" id="L28387" title="All 4 branches missed.">                    if ((basement == BasementType.TWO_DEEP_FEET)</span>
                            || (basement == BasementType.ONE_DEEP_FEET)) {
<span class="nc" id="L28389">                        damageTable = ToHitData.HIT_KICK;</span>
<span class="nc bnc" id="L28390" title="All 4 branches missed.">                    } else if ((basement == BasementType.TWO_DEEP_HEAD)</span>
                            || (basement == BasementType.ONE_DEEP_HEAD)) {
<span class="nc" id="L28392">                        damageTable = ToHitData.HIT_PUNCH;</span>
                    } else {
<span class="nc" id="L28394">                        damageTable = ToHitData.HIT_NORMAL;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L28399" title="All 2 branches missed.">        if (entity instanceof Protomech) {</span>
<span class="nc" id="L28400">            damageTable = ToHitData.HIT_SPECIAL_PROTO;</span>
        }
        // Falling into water instantly destroys most non-mechs
<span class="nc bnc" id="L28403" title="All 6 branches missed.">        if ((waterDepth &gt; 0)</span>
            &amp;&amp; !(entity instanceof Mech)
            &amp;&amp; !(entity instanceof Protomech)
<span class="nc bnc" id="L28406" title="All 4 branches missed.">            &amp;&amp; !((entity.getRunMP() &gt; 0) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.HOVER))</span>
<span class="nc bnc" id="L28407" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L28408" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L28409" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L28410" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L28411">            vPhaseReport.addAll(destroyEntity(entity, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L28412">            return vPhaseReport;</span>
        }

        // set how deep the mech has fallen
<span class="nc bnc" id="L28416" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28417">            Mech mech = (Mech) entity;</span>
<span class="nc" id="L28418">            mech.setLevelsFallen(damageHeight + waterDepth + 1);</span>
            // an industrial mech now needs to check for a crit at the end of
            // the turn
<span class="nc bnc" id="L28421" title="All 2 branches missed.">            if (mech.isIndustrial()) {</span>
<span class="nc" id="L28422">                mech.setCheckForCrit(true);</span>
            }
        }

        // calculate damage for hitting the surface
<span class="nc" id="L28427">        int damage = (int) Math.round(entity.getWeight() / 10.0)</span>
                     * (damageHeight + 1);
        // different rules (pg. 151 of TW) for battle armor and infantry
<span class="nc bnc" id="L28430" title="All 2 branches missed.">        if (entity instanceof Infantry) {</span>
<span class="nc" id="L28431">            damage = (int) Math.ceil(damageHeight / 2.0);</span>
            // no damage for fall from less than 2 levels
<span class="nc bnc" id="L28433" title="All 2 branches missed.">            if (damageHeight &lt; 2) {</span>
<span class="nc" id="L28434">                damage = 0;</span>
            }
<span class="nc bnc" id="L28436" title="All 2 branches missed.">            if (!(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L28437">                int dice = 3;</span>
<span class="nc bnc" id="L28438" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.INF_MOTORIZED) {</span>
<span class="nc" id="L28439">                    dice = 2;</span>
<span class="nc bnc" id="L28440" title="All 2 branches missed.">                } else if ((entity.getMovementMode() == EntityMovementMode.INF_JUMP)</span>
<span class="nc bnc" id="L28441" title="All 2 branches missed.">                           || ((Infantry) entity).isMechanized()) {</span>
<span class="nc" id="L28442">                    dice = 1;</span>
                }
<span class="nc" id="L28444">                damage = damage * Compute.d6(dice);</span>
            }
        }
        // Different rules (pg 62/63/152 of TW) for Tanks
<span class="nc bnc" id="L28448" title="All 2 branches missed.">        if (entity instanceof Tank) {</span>
            // Falls from less than 2 levels don't damage combat vehicles
            // except if they fall off a sheer cliff
<span class="nc bnc" id="L28451" title="All 4 branches missed.">            if (damageHeight &lt; 2 &amp;&amp; !fromCliff) {</span>
<span class="nc" id="L28452">                damage = 0; </span>
            }
            // Falls from &gt;= 2 elevations damage like crashing VTOLs
            // Ends up being the regular damage: weight / 10 * (height + 1)
            // And this was already computed
        }
        // calculate damage for hitting the ground, but only if we actually fell
        // into water
        // if we fell onto the water surface, that damage is halved.
<span class="nc" id="L28461">        int waterDamage = 0;</span>
<span class="nc bnc" id="L28462" title="All 2 branches missed.">        if (waterDepth &gt; 0) {</span>
<span class="nc" id="L28463">            damage /= 2;</span>
<span class="nc" id="L28464">            waterDamage = ((int) Math.round(entity.getWeight() / 10.0) * (waterDepth + 1)) / 2;</span>
        }

        // If the waterDepth is larger than the fall height, we fell underwater
<span class="nc bnc" id="L28468" title="All 6 branches missed.">        if ((waterDepth &gt;= fallHeight) &amp;&amp; ((waterDepth != 0) || (fallHeight != 0))) {</span>
<span class="nc" id="L28469">            damage = 0;</span>
<span class="nc" id="L28470">            waterDamage = ((int) Math.round(entity.getWeight() / 10.0) * (fallHeight + 1)) / 2;</span>
        }
        // adjust damage for gravity
<span class="nc" id="L28473">        damage = Math</span>
<span class="nc" id="L28474">                .round(damage * game.getPlanetaryConditions().getGravity());</span>
<span class="nc" id="L28475">        waterDamage = Math.round(waterDamage</span>
<span class="nc" id="L28476">                                 * game.getPlanetaryConditions().getGravity());</span>

        // report falling
<span class="nc bnc" id="L28479" title="All 2 branches missed.">        if (waterDamage == 0) {</span>
<span class="nc" id="L28480">            r = new Report(2310);</span>
<span class="nc" id="L28481">            r.subject = entity.getId();</span>
<span class="nc" id="L28482">            r.indent();</span>
<span class="nc" id="L28483">            r.addDesc(entity);</span>
<span class="nc" id="L28484">            r.add(side); // international issue</span>
<span class="nc" id="L28485">            r.add(damage);</span>
<span class="nc bnc" id="L28486" title="All 2 branches missed.">        } else if (damage &gt; 0) {</span>
<span class="nc" id="L28487">            r = new Report(2315);</span>
<span class="nc" id="L28488">            r.subject = entity.getId();</span>
<span class="nc" id="L28489">            r.indent();</span>
<span class="nc" id="L28490">            r.addDesc(entity);</span>
<span class="nc" id="L28491">            r.add(side); // international issue</span>
<span class="nc" id="L28492">            r.add(damage);</span>
<span class="nc" id="L28493">            r.add(waterDamage);</span>
        } else {
<span class="nc" id="L28495">            r = new Report(2310);</span>
<span class="nc" id="L28496">            r.subject = entity.getId();</span>
<span class="nc" id="L28497">            r.indent();</span>
<span class="nc" id="L28498">            r.addDesc(entity);</span>
<span class="nc" id="L28499">            r.add(side); // international issue</span>
<span class="nc" id="L28500">            r.add(waterDamage);</span>
        }
<span class="nc" id="L28502">        vPhaseReport.add(r);</span>

        // Any swarming infantry will be dislodged, but we don't want to
        // interrupt the fall's report. We have to get the ID now because
        // the fall may kill the entity which will reset the attacker ID.
<span class="nc" id="L28507">        final int swarmerId = entity.getSwarmAttackerId();</span>

        // Positioning must be prior to damage for proper handling of breaches
        // Only Mechs can fall prone.
<span class="nc bnc" id="L28511" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28512">            entity.setProne(true);</span>
        }
<span class="nc" id="L28514">        entity.setPosition(fallPos);</span>
<span class="nc" id="L28515">        entity.setElevation(newElevation);</span>
        // Only 'mechs change facing when they fall
<span class="nc bnc" id="L28517" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28518">            entity.setFacing((entity.getFacing() + (facing)) % 6);</span>
<span class="nc" id="L28519">            entity.setSecondaryFacing(entity.getFacing());</span>
        }

        // if falling into a bog-down hex, the entity automatically gets stuck (except when on a bridge or building)
        // but avoid reporting this twice in the case of DFAs
<span class="nc bnc" id="L28524" title="All 4 branches missed.">        if (!entity.isStuck() &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc bnc" id="L28525" title="All 2 branches missed.">            if (fallHex.getBogDownModifier(entity.getMovementMode(),</span>
                    entity instanceof LargeSupportTank) != TargetRoll.AUTOMATIC_SUCCESS) {
<span class="nc" id="L28527">                entity.setStuck(true);</span>
<span class="nc" id="L28528">                r = new Report(2081);</span>
<span class="nc" id="L28529">                r.subject = entity.getId();</span>
<span class="nc" id="L28530">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L28531">                vPhaseReport.add(r);</span>
                // check for quicksand
<span class="nc" id="L28533">                vPhaseReport.addAll(checkQuickSand(fallPos));</span>
            }
        }

        // standard damage loop
<span class="nc bnc" id="L28538" title="All 4 branches missed.">        if ((entity instanceof Infantry) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc bnc" id="L28539" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L28540" title="All 2 branches missed.">                for (int i = 1; i &lt; entity.locations(); i++) {</span>
<span class="nc" id="L28541">                    HitData h = new HitData(i);</span>
<span class="nc" id="L28542">                    vPhaseReport.addAll(damageEntity(entity, h, damage));</span>
<span class="nc" id="L28543">                    addNewLines();</span>
                }
            } else {
<span class="nc" id="L28546">                HitData h = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L28547">                vPhaseReport.addAll(damageEntity(entity, h, damage));</span>
<span class="nc" id="L28548">            }</span>
        } else {
<span class="nc bnc" id="L28550" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L28551">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L28552">                HitData hit = entity.rollHitLocation(damageTable, table);</span>
<span class="nc" id="L28553">                hit.makeFallDamage(true);</span>
<span class="nc" id="L28554">                vPhaseReport.addAll(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L28555">                damage -= cluster;</span>
<span class="nc" id="L28556">            }</span>
        }

<span class="nc bnc" id="L28559" title="All 2 branches missed.">        if (waterDepth &gt; 0) {</span>
<span class="nc bnc" id="L28560" title="All 2 branches missed.">            for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc" id="L28561">                entity.setLocationStatus(loop, ILocationExposureStatus.WET);</span>
            }
        }
        // Water damage
<span class="nc bnc" id="L28565" title="All 2 branches missed.">        while (waterDamage &gt; 0) {</span>
<span class="nc" id="L28566">            int cluster = Math.min(5, waterDamage);</span>
<span class="nc" id="L28567">            HitData hit = entity.rollHitLocation(damageTable, table);</span>
<span class="nc" id="L28568">            hit.makeFallDamage(true);</span>
<span class="nc" id="L28569">            vPhaseReport.addAll(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L28570">            waterDamage -= cluster;</span>
<span class="nc" id="L28571">        }</span>

        // check for location exposure
<span class="nc" id="L28574">        vPhaseReport.addAll(doSetLocationsExposure(entity, fallHex, false,</span>
                                                   -waterDepth));

        // only mechs should roll to avoid pilot damage
        // vehicles may fall due to sideslips
<span class="nc bnc" id="L28579" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28580">            vPhaseReport.addAll(checkPilotAvoidFallDamage(entity, fallHeight, roll));</span>
        }

        // Now dislodge any swarming infantry.
<span class="nc bnc" id="L28584" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L28585">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L28586">            entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L28587">            swarmer.setSwarmTargetId(Entity.NONE);</span>
            // Did the infantry fall into water?
<span class="nc bnc" id="L28589" title="All 2 branches missed.">            if ((waterDepth &gt; 0)</span>
<span class="nc bnc" id="L28590" title="All 2 branches missed.">                &amp;&amp; (swarmer.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
                // Swarming infantry die.
<span class="nc" id="L28592">                swarmer.setPosition(fallPos);</span>
<span class="nc" id="L28593">                r = new Report(2330);</span>
<span class="nc" id="L28594">                r.newlines = 0;</span>
<span class="nc" id="L28595">                r.subject = swarmer.getId();</span>
<span class="nc" id="L28596">                r.addDesc(swarmer);</span>
<span class="nc" id="L28597">                vPhaseReport.add(r);</span>
<span class="nc" id="L28598">                vPhaseReport.addAll(destroyEntity(swarmer, &quot;a watery grave&quot;,</span>
                                                  false));
            } else {
                // Swarming infantry take a 2d6 point hit.
                // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L28603">                r = new Report(2335);</span>
<span class="nc" id="L28604">                r.newlines = 0;</span>
<span class="nc" id="L28605">                r.subject = swarmer.getId();</span>
<span class="nc" id="L28606">                r.addDesc(swarmer);</span>
<span class="nc" id="L28607">                vPhaseReport.add(r);</span>
<span class="nc" id="L28608">                vPhaseReport.addAll(damageEntity(swarmer, swarmer</span>
<span class="nc" id="L28609">                        .rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L28610">                                         ToHitData.SIDE_FRONT), Compute.d6(2)));</span>
<span class="nc" id="L28611">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L28613">            swarmer.setPosition(fallPos);</span>
<span class="nc" id="L28614">            entityUpdate(swarmerId);</span>
<span class="nc bnc" id="L28615" title="All 2 branches missed.">            if (!swarmer.isDone()) {</span>
<span class="nc" id="L28616">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L28617">                swarmer.setDone(true);</span>
<span class="nc" id="L28618">                send(createTurnVectorPacket());</span>
            }
        } // End dislodge-infantry

        // clear all PSRs after a fall -- the Mek has already failed ONE and
        // fallen, it'd be cruel to make it fail some more!
<span class="nc" id="L28624">        game.resetPSRs(entity);</span>

        // if there is a minefield in this hex, then the mech may set it off
<span class="nc bnc" id="L28627" title="All 2 branches missed.">        if (game.containsMinefield(fallPos)</span>
<span class="nc bnc" id="L28628" title="All 2 branches missed.">            &amp;&amp; enterMinefield(entity, fallPos, newElevation, true,</span>
                              vPhaseReport, 12)) {
<span class="nc" id="L28630">            resetMines();</span>
        }
        // if we have to, check if the building/bridge we fell on collapses -
        // unless it's a fall into a basement,
        // then we're already gonna check that in building collapse, where we
        // came from
<span class="nc bnc" id="L28636" title="All 4 branches missed.">        if (checkCollapse &amp;&amp; !handlingBasement) {</span>

<span class="nc" id="L28638">            checkForCollapse(game.getBoard().getBuildingAt(fallPos),</span>
<span class="nc" id="L28639">                             game.getPositionMap(), fallPos, false, vPhaseReport);</span>
        }

<span class="nc" id="L28642">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; checkPilotAvoidFallDamage(Entity entity, int fallHeight, PilotingRollData roll) {
<span class="nc" id="L28646">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L28648" title="All 2 branches missed.">        if (entity.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)</span>
<span class="nc bnc" id="L28649" title="All 2 branches missed.">                || entity.hasAbility(OptionsConstants.MD_TSM_IMPLANT)) {</span>
<span class="nc" id="L28650">            return reports;</span>
        }
        // we want to be able to avoid pilot damage even when it was
        // an automatic fall, only unconsciousness should cause auto-damage
<span class="nc" id="L28654">        roll.removeAutos();</span>

<span class="nc bnc" id="L28656" title="All 2 branches missed.">        if (fallHeight &gt; 1) {</span>
<span class="nc" id="L28657">            roll.addModifier(fallHeight - 1, &quot;height of fall&quot;);</span>
        }

<span class="nc bnc" id="L28660" title="All 2 branches missed.">        if (entity.getCrew().getSlotCount() &gt; 1) {</span>
            //Extract the base from the list of modifiers so we can replace it with the piloting
            //skill of each crew member.
<span class="nc" id="L28663">            List&lt;TargetRollModifier&gt; modifiers = new ArrayList&lt;&gt;(roll.getModifiers());</span>
<span class="nc bnc" id="L28664" title="All 2 branches missed.">            if (modifiers.size() &gt; 0) {</span>
<span class="nc" id="L28665">                modifiers.remove(0);</span>
            }
<span class="nc bnc" id="L28667" title="All 2 branches missed.">            for (int pos = 0; pos &lt; entity.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L28668" title="All 4 branches missed.">                if (entity.getCrew().isMissing(pos) || entity.getCrew().isDead(pos)) {</span>
<span class="nc" id="L28669">                    continue;</span>
                }
                PilotingRollData prd;
<span class="nc bnc" id="L28672" title="All 2 branches missed.">                if (entity.getCrew().isDead(pos)) {</span>
<span class="nc" id="L28673">                    continue;</span>
<span class="nc bnc" id="L28674" title="All 2 branches missed.">                } else if (entity.getCrew().isUnconscious(pos)) {</span>
<span class="nc" id="L28675">                    prd = new PilotingRollData(entity.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                            &quot;Crew member unconscious&quot;);
                } else {
<span class="nc" id="L28678">                    prd = new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L28679">                            entity.getCrew().getPiloting(pos), &quot;Base piloting skill&quot;);</span>
<span class="nc" id="L28680">                    modifiers.forEach(prd::addModifier);</span>
                }
<span class="nc" id="L28682">                reports.addAll(resolvePilotDamageFromFall(entity, prd, pos));</span>
            }
<span class="nc" id="L28684">        } else {</span>
<span class="nc" id="L28685">            reports.addAll(resolvePilotDamageFromFall(entity, roll, 0));</span>
        }
<span class="nc" id="L28687">        return reports;</span>
    }

    private Vector&lt;Report&gt; resolvePilotDamageFromFall(Entity entity, PilotingRollData roll, int crewPos) {
<span class="nc" id="L28691">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L28693" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L28694">            r = new Report(2320);</span>
<span class="nc" id="L28695">            r.subject = entity.getId();</span>
<span class="nc" id="L28696">            r.add(entity.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L28697">            r.addDesc(entity);</span>
<span class="nc" id="L28698">            r.add(entity.getCrew().getName(crewPos));</span>
<span class="nc" id="L28699">            r.indent();</span>
<span class="nc" id="L28700">            reports.add(r);</span>
<span class="nc" id="L28701">            reports.addAll(damageCrew(entity, 1, crewPos));</span>
        } else {
<span class="nc" id="L28703">            int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L28704">            r = new Report(2325);</span>
<span class="nc" id="L28705">            r.subject = entity.getId();</span>
<span class="nc" id="L28706">            r.add(entity.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L28707">            r.addDesc(entity);</span>
<span class="nc" id="L28708">            r.add(entity.getCrew().getName(crewPos));</span>
<span class="nc" id="L28709">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L28710">            r.add(diceRoll);</span>
<span class="nc bnc" id="L28711" title="All 2 branches missed.">            if (diceRoll &gt;= roll.getValue()) {</span>
<span class="nc" id="L28712">                r.choose(true);</span>
<span class="nc" id="L28713">                reports.add(r);</span>
            } else {
<span class="nc" id="L28715">                r.choose(false);</span>
<span class="nc" id="L28716">                reports.add(r);</span>
<span class="nc" id="L28717">                reports.addAll(damageCrew(entity, 1, crewPos));</span>
            }
        }
<span class="nc" id="L28720">        Report.addNewline(reports);</span>
<span class="nc" id="L28721">        return reports;</span>
    }

    /**
     * The mech falls into an unoccupied hex from the given height above
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, Coords fallPos,
                                        int height, PilotingRollData roll) {
<span class="nc" id="L28729">        return doEntityFall(entity, fallPos, height, Compute.d6(1) - 1, roll,</span>
                            false, false);
    }

    /**
     * The mech falls down in place
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, PilotingRollData roll) {
<span class="nc" id="L28737">        boolean fallToSurface = false;</span>
        // on ice
<span class="nc" id="L28739">        int toSubtract = 0;</span>
<span class="nc" id="L28740">        IHex currHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L28741" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L28742" title="All 2 branches missed.">            &amp;&amp; (entity.getElevation() != -currHex.depth())) {</span>
<span class="nc" id="L28743">            fallToSurface = true;</span>
<span class="nc" id="L28744">            toSubtract = 0;</span>
        }
        // on a bridge
<span class="nc bnc" id="L28747" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc" id="L28748">            &amp;&amp; (entity.getElevation() &gt;= currHex</span>
<span class="nc bnc" id="L28749" title="All 2 branches missed.">                .terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L28750">            fallToSurface = true;</span>
<span class="nc" id="L28751">            toSubtract = currHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
        }
        // on a building
<span class="nc bnc" id="L28754" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L28755">            &amp;&amp; (entity.getElevation() &gt;= currHex</span>
<span class="nc bnc" id="L28756" title="All 2 branches missed.">                .terrainLevel(Terrains.BLDG_ELEV))) {</span>
<span class="nc" id="L28757">            fallToSurface = true;</span>
<span class="nc" id="L28758">            toSubtract = currHex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc" id="L28760">        return doEntityFall(entity, entity.getPosition(), entity.getElevation()</span>
<span class="nc bnc" id="L28761" title="All 2 branches missed.">                + (!fallToSurface ? currHex.depth(true) : -toSubtract), roll);</span>
    }

    /**
     * Report: - Any ammo dumps beginning the following round. - Any ammo dumps
     * that have ended with the end of this round.
     */
    private void resolveAmmoDumps() {
        Report r;
<span class="nc bnc" id="L28770" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L28771" title="All 2 branches missed.">            for (Mounted m : entity.getAmmo()) {</span>
<span class="nc bnc" id="L28772" title="All 2 branches missed.">                if (m.isPendingDump()) {</span>
                    // report dumping next round
<span class="nc" id="L28774">                    r = new Report(5110);</span>
<span class="nc" id="L28775">                    r.subject = entity.getId();</span>
<span class="nc" id="L28776">                    r.addDesc(entity);</span>
<span class="nc" id="L28777">                    r.add(m.getName());</span>
<span class="nc" id="L28778">                    addReport(r);</span>
                    // update status
<span class="nc" id="L28780">                    m.setPendingDump(false);</span>
<span class="nc" id="L28781">                    m.setDumping(true);</span>
<span class="nc bnc" id="L28782" title="All 2 branches missed.">                } else if (m.isDumping()) {</span>
                    // report finished dumping
<span class="nc" id="L28784">                    r = new Report(5115);</span>
<span class="nc" id="L28785">                    r.subject = entity.getId();</span>
<span class="nc" id="L28786">                    r.addDesc(entity);</span>
<span class="nc" id="L28787">                    r.add(m.getName());</span>
<span class="nc" id="L28788">                    addReport(r);</span>
                    // update status
<span class="nc" id="L28790">                    m.setDumping(false);</span>
<span class="nc" id="L28791">                    m.setShotsLeft(0);</span>
                }
<span class="nc" id="L28793">            }</span>
            // also do DWP dumping
<span class="nc bnc" id="L28795" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L28796" title="All 2 branches missed.">                for (Mounted m : entity.getWeaponList()) {</span>
<span class="nc bnc" id="L28797" title="All 4 branches missed.">                    if (m.isDWPMounted() &amp;&amp; m.isPendingDump()) {</span>
<span class="nc" id="L28798">                        m.setMissing(true);</span>
<span class="nc" id="L28799">                        r = new Report(5116);</span>
<span class="nc" id="L28800">                        r.subject = entity.getId();</span>
<span class="nc" id="L28801">                        r.addDesc(entity);</span>
<span class="nc" id="L28802">                        r.add(m.getName());</span>
<span class="nc" id="L28803">                        addReport(r);</span>
<span class="nc" id="L28804">                        m.setPendingDump(false);</span>
                        // Also dump all of the ammo in the DWP
<span class="nc bnc" id="L28806" title="All 2 branches missed.">                        for (Mounted ammo : entity.getAmmo()) {</span>
<span class="nc bnc" id="L28807" title="All 2 branches missed.">                            if (m.equals(ammo.getLinkedBy())) {</span>
<span class="nc" id="L28808">                                ammo.setMissing(true);</span>
                            }
<span class="nc" id="L28810">                        }</span>
                    // Check for jettisoning missiles
<span class="nc bnc" id="L28812" title="All 4 branches missed.">                    } else if (m.isBodyMounted() &amp;&amp; m.isPendingDump()</span>
<span class="nc bnc" id="L28813" title="All 2 branches missed.">                            &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L28814" title="All 2 branches missed.">                            &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L28815" title="All 2 branches missed.">                            &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28816">                        m.setMissing(true);</span>
<span class="nc" id="L28817">                        r = new Report(5116);</span>
<span class="nc" id="L28818">                        r.subject = entity.getId();</span>
<span class="nc" id="L28819">                        r.addDesc(entity);</span>
<span class="nc" id="L28820">                        r.add(m.getName());</span>
<span class="nc" id="L28821">                        addReport(r);</span>
<span class="nc" id="L28822">                        m.setPendingDump(false);</span>
                        // Dump all ammo related to this launcher
                        // BA burdened is based on whether the launcher has
                        // ammo left
<span class="nc bnc" id="L28826" title="All 2 branches missed.">                        while ((m.getLinked() != null)</span>
<span class="nc bnc" id="L28827" title="All 2 branches missed.">                                &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28828">                            m.getLinked().setMissing(true);</span>
<span class="nc" id="L28829">                            entity.loadWeapon(m);</span>
                        }
                    }
<span class="nc" id="L28832">                }</span>
            }
<span class="nc" id="L28834">            entity.reloadEmptyWeapons();</span>
<span class="nc" id="L28835">        }</span>
<span class="nc" id="L28836">    }</span>

    /**
     * Checks for fire ignition based on a given target roll. If successful,
     * lights a fire also checks to see that fire is possible in the specified
     * hex.
     *
     * @param c        - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll     - the &lt;code&gt;TargetRoll&lt;/code&gt; for the ignition roll
     * @param bInferno - &lt;code&gt;true&lt;/code&gt; if the fire is an inferno fire. If this
     *                 value is &lt;code&gt;false&lt;/code&gt; the hex will be lit only if it
     *                 contains Woods,jungle or a Building.
     * @param entityId - the entityId responsible for the ignite attempt. If the
     *                 value is Entity.NONE, then the roll attempt will not be
     *                 included in the report.
     */
    public boolean checkIgnition(Coords c, TargetRoll roll, boolean bInferno, int entityId,
                                 Vector&lt;Report&gt; vPhaseReport) {

<span class="nc" id="L28855">        IHex hex = game.getBoard().getHex(c);</span>

        // The hex might be null due to spreadFire translation
        // goes outside of the board limit.
<span class="nc bnc" id="L28859" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28860">            return false;</span>
        }

        // The hex may already be on fire.
<span class="nc bnc" id="L28864" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L28865">            return false;</span>
        }

<span class="nc bnc" id="L28868" title="All 4 branches missed.">        if (!bInferno &amp;&amp; !hex.isIgnitable()) {</span>
<span class="nc" id="L28869">            return false;</span>
        }

<span class="nc" id="L28872">        int fireRoll = Compute.d6(2);</span>
        Report r;
<span class="nc bnc" id="L28874" title="All 2 branches missed.">        if (entityId != Entity.NONE) {</span>
<span class="nc" id="L28875">            r = new Report(3430);</span>
<span class="nc" id="L28876">            r.indent(2);</span>
<span class="nc" id="L28877">            r.subject = entityId;</span>
<span class="nc" id="L28878">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L28879">            r.add(roll.getDesc());</span>
<span class="nc" id="L28880">            r.add(fireRoll);</span>
<span class="nc" id="L28881">            vPhaseReport.add(r);</span>
        }
<span class="nc bnc" id="L28883" title="All 2 branches missed.">        if (fireRoll &gt;= roll.getValue()) {</span>
<span class="nc" id="L28884">            ignite(c, Terrains.FIRE_LVL_NORMAL, vPhaseReport);</span>
<span class="nc" id="L28885">            return true;</span>
        }
<span class="nc" id="L28887">        return false;</span>
    }

    /**
     * Returns true if the hex is set on fire with the specified roll. Of
     * course, also checks to see that fire is possible in the specified hex.
     * This version of the method will not report the attempt roll.
     *
     * @param c        - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll     - the &lt;code&gt;int&lt;/code&gt; target number for the ignition roll
     * @param bInferno - &lt;code&gt;true&lt;/code&gt; if the fire can be lit in any terrain. If
     *                 this value is &lt;code&gt;false&lt;/code&gt; the hex will be lit only if
     *                 it contains Woods, jungle or a Building.
     */
    public boolean checkIgnition(Coords c, TargetRoll roll, boolean bInferno) {
<span class="nc" id="L28902">        return checkIgnition(c, roll, bInferno, Entity.NONE, null);</span>
    }

    /**
     * Returns true if the hex is set on fire with the specified roll. Of
     * course, also checks to see that fire is possible in the specified hex.
     * This version of the method will not report the attempt roll.
     *
     * @param c    - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll - the &lt;code&gt;int&lt;/code&gt; target number for the ignition roll
     */
    public boolean checkIgnition(Coords c, TargetRoll roll) {
        // default signature, assuming only woods can burn
<span class="nc" id="L28915">        return checkIgnition(c, roll, false, Entity.NONE, null);</span>
    }

    /**
     * add fire to a hex
     *
     * @param c         - the &lt;code&gt;Coords&lt;/code&gt; of the hex to be set on fire
     * @param fireLevel - The level of fire, see Terrains
     */
    public void ignite(Coords c, int fireLevel, Vector&lt;Report&gt; vReport) {
        // you can't start fires in some planetary conditions!
<span class="nc bnc" id="L28926" title="All 2 branches missed.">        if (null != game.getPlanetaryConditions().cannotStartFire()) {</span>
<span class="nc bnc" id="L28927" title="All 2 branches missed.">            if (null != vReport) {</span>
<span class="nc" id="L28928">                Report r = new Report(3007);</span>
<span class="nc" id="L28929">                r.indent(2);</span>
<span class="nc" id="L28930">                r.add(game.getPlanetaryConditions().cannotStartFire());</span>
<span class="nc" id="L28931">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L28932">                vReport.add(r);</span>
            }
<span class="nc" id="L28934">            return;</span>
        }

<span class="nc bnc" id="L28937" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_START_FIRE)) {</span>
<span class="nc bnc" id="L28938" title="All 2 branches missed.">            if (null != vReport) {</span>
<span class="nc" id="L28939">                Report r = new Report(3008);</span>
<span class="nc" id="L28940">                r.indent(2);</span>
<span class="nc" id="L28941">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L28942">                vReport.add(r);</span>
            }
<span class="nc" id="L28944">            return;</span>
        }

<span class="nc" id="L28947">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L28948" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28949">            return;</span>
        }

<span class="nc" id="L28952">        Report r = new Report(3005);</span>
<span class="nc" id="L28953">        r.indent(2);</span>
<span class="nc" id="L28954">        r.add(c.getBoardNum());</span>
<span class="nc" id="L28955">        r.type = Report.PUBLIC;</span>

        // Adjust report message for inferno types
<span class="nc bnc" id="L28958" title="All 4 branches missed.">        switch (fireLevel) {</span>
            case Terrains.FIRE_LVL_INFERNO:
<span class="nc" id="L28960">                r.messageId = 3006;</span>
<span class="nc" id="L28961">                break;</span>
            case Terrains.FIRE_LVL_INFERNO_BOMB:
<span class="nc" id="L28963">                r.messageId = 3003;</span>
<span class="nc" id="L28964">                break;</span>
            case Terrains.FIRE_LVL_INFERNO_IV:
<span class="nc" id="L28966">                r.messageId = 3004;</span>
                break;
        }

        // report it
<span class="nc bnc" id="L28971" title="All 2 branches missed.">        if (null != vReport) {</span>
<span class="nc" id="L28972">            vReport.add(r);</span>
        }
<span class="nc" id="L28974">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FIRE, fireLevel));</span>
<span class="nc" id="L28975">        sendChangedHex(c);</span>
<span class="nc" id="L28976">    }</span>

    /**
     * remove fire from a hex
     *
     * @param fireCoords
     * @param reason
     */
    public void removeFire(Coords fireCoords, String reason) {
<span class="nc" id="L28985">        IHex hex = game.getBoard().getHex(fireCoords);</span>
<span class="nc bnc" id="L28986" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28987">            return;</span>
        }
<span class="nc" id="L28989">        hex.removeTerrain(Terrains.FIRE);</span>
<span class="nc" id="L28990">        hex.resetFireTurn();</span>
<span class="nc" id="L28991">        sendChangedHex(fireCoords);</span>
        // fire goes out
<span class="nc" id="L28993">        Report r = new Report(5170, Report.PUBLIC);</span>
<span class="nc" id="L28994">        r.add(fireCoords.getBoardNum());</span>
<span class="nc" id="L28995">        r.add(reason);</span>
<span class="nc" id="L28996">        addReport(r);</span>
<span class="nc" id="L28997">    }</span>

    /**
     * Called when a fire is burning. Called 3 times per fire hex.
     *
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; x-coordinate of the hex
     */
    public void addSmoke(ArrayList&lt;Coords&gt; coords, int windDir, boolean bInferno) {
        // if a tornado, then no smoke!
<span class="nc bnc" id="L29006" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L29007">            return;</span>
        }

<span class="nc" id="L29010">        int smokeLevel = 0;</span>
<span class="nc bnc" id="L29011" title="All 2 branches missed.">        for (Coords smokeCoords : coords) {</span>
<span class="nc" id="L29012">            IHex smokeHex = game.getBoard().getHex(smokeCoords);</span>
            Report r;
<span class="nc bnc" id="L29014" title="All 2 branches missed.">            if (smokeHex == null) {</span>
<span class="nc" id="L29015">                continue;</span>
            }
            // Have to check if it's inferno smoke or from a heavy/hardened
            // building
            // - heavy smoke from those
<span class="nc bnc" id="L29020" title="All 4 branches missed.">            if (bInferno || (Building.MEDIUM &lt; smokeHex.terrainLevel(Terrains.FUEL_TANK))</span>
<span class="nc bnc" id="L29021" title="All 2 branches missed.">                    || (Building.MEDIUM &lt; smokeHex.terrainLevel(Terrains.BUILDING))) {</span>
<span class="nc bnc" id="L29022" title="All 2 branches missed.">                if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_HEAVY) {</span>
                    // heavy smoke fills hex
<span class="nc" id="L29024">                    r = new Report(5180, Report.PUBLIC);</span>
                } else {
<span class="nc" id="L29026">                    r = new Report(5185, Report.PUBLIC);</span>
                }
<span class="nc" id="L29028">                smokeLevel = SmokeCloud.SMOKE_HEAVY;</span>
<span class="nc" id="L29029">                r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29030">                addReport(r);</span>
            } else {
<span class="nc bnc" id="L29032" title="All 2 branches missed.">                if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_HEAVY) {</span>
                    // heavy smoke overpowers light
<span class="nc" id="L29034">                    r = new Report(5190, Report.PUBLIC);</span>
<span class="nc" id="L29035">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29036">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
<span class="nc" id="L29037">                    addReport(r);</span>
<span class="nc bnc" id="L29038" title="All 2 branches missed.">                } else if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_LIGHT) {</span>
                    // light smoke continue to fill hex
<span class="nc" id="L29040">                    r = new Report(5195, Report.PUBLIC);</span>
<span class="nc" id="L29041">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29042">                    addReport(r);</span>
<span class="nc" id="L29043">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
                } else {
<span class="nc" id="L29045">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
                    // light smoke fills hex
<span class="nc" id="L29047">                    r = new Report(5200, Report.PUBLIC);</span>
<span class="nc" id="L29048">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29049">                    addReport(r);</span>
                }
            }
<span class="nc" id="L29052">        }</span>
<span class="nc" id="L29053">        createSmoke(coords, smokeLevel, 0);</span>
<span class="nc" id="L29054">    }</span>

    /**
     * Scans the boards directory for map boards of the appropriate size and
     * returns them.
     *
     * @return A list of relative paths to the board files, without the '.board'
     * extension.
     */
    private List&lt;String&gt; scanForBoardsInDir(final File boardDir, final String basePath,
                                            final BoardDimensions dimensions, List&lt;String&gt; boards) {
<span class="nc bnc" id="L29065" title="All 2 branches missed.">        if (boardDir == null) {</span>
<span class="nc" id="L29066">            throw new IllegalArgumentException(&quot;must provide searchDir&quot;);</span>
<span class="nc bnc" id="L29067" title="All 2 branches missed.">        } else if (basePath == null) {</span>
<span class="nc" id="L29068">            throw new IllegalArgumentException(&quot;must provide basePath&quot;);</span>
<span class="nc bnc" id="L29069" title="All 2 branches missed.">        } else if (dimensions == null) {</span>
<span class="nc" id="L29070">            throw new IllegalArgumentException(&quot;must provide dimensions&quot;);</span>
<span class="nc bnc" id="L29071" title="All 2 branches missed.">        } else if (boards == null) {</span>
<span class="nc" id="L29072">            throw new IllegalArgumentException(&quot;must provide boards&quot;);</span>
        }

<span class="nc" id="L29075">        String[] fileList = boardDir.list();</span>
<span class="nc bnc" id="L29076" title="All 2 branches missed.">        if (fileList != null) {</span>
<span class="nc bnc" id="L29077" title="All 2 branches missed.">            for (String filename : fileList) {</span>
<span class="nc" id="L29078">                File filePath = new MegaMekFile(boardDir, filename).getFile();</span>
<span class="nc bnc" id="L29079" title="All 2 branches missed.">                if (filePath.isDirectory()) {</span>
<span class="nc" id="L29080">                    scanForBoardsInDir(new MegaMekFile(boardDir, filename).getFile(),</span>
<span class="nc" id="L29081">                            basePath.concat(File.separator).concat(filename), dimensions, boards);</span>
                } else {
<span class="nc bnc" id="L29083" title="All 2 branches missed.">                    if (filename.endsWith(&quot;.board&quot;)) { //$NON-NLS-1$</span>
<span class="nc bnc" id="L29084" title="All 2 branches missed.">                        if (Board.boardIsSize(filePath, dimensions)) {</span>
<span class="nc" id="L29085">                            boards.add(basePath.concat(File.separator)</span>
<span class="nc" id="L29086">                                    .concat(filename.substring(0, filename.lastIndexOf(&quot;.&quot;))));</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L29092">        return boards;</span>
    }

    /**
     * Recursively scan the specified path to determine the board sizes
     * available.
     *
     * @param searchDir The directory to search below this path (may be null for all
     *                  in base path).
     * @param sizes     Where to store the discovered board sizes
     */
    private void getBoardSizesInDir(final File searchDir, TreeSet&lt;BoardDimensions&gt; sizes) {
<span class="nc bnc" id="L29104" title="All 2 branches missed.">        if (searchDir == null) {</span>
<span class="nc" id="L29105">            throw new IllegalArgumentException(&quot;must provide searchDir&quot;);</span>
        }

<span class="nc bnc" id="L29108" title="All 2 branches missed.">        if (sizes == null) {</span>
<span class="nc" id="L29109">            throw new IllegalArgumentException(&quot;must provide sizes&quot;);</span>
        }

<span class="nc" id="L29112">        String[] file_list = searchDir.list();</span>

<span class="nc bnc" id="L29114" title="All 2 branches missed.">        if (file_list != null) {</span>
<span class="nc bnc" id="L29115" title="All 2 branches missed.">            for (String filename : file_list) {</span>
<span class="nc" id="L29116">                File query_file = new File(searchDir, filename);</span>

<span class="nc bnc" id="L29118" title="All 2 branches missed.">                if (query_file.isDirectory()) {</span>
<span class="nc" id="L29119">                    getBoardSizesInDir(query_file, sizes);</span>
                } else {
                    try {
<span class="nc bnc" id="L29122" title="All 2 branches missed.">                        if (filename.endsWith(&quot;.board&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L29123">                            BoardDimensions size = Board.getSize(query_file);</span>
<span class="nc bnc" id="L29124" title="All 2 branches missed.">                            if (size == null) {</span>
<span class="nc" id="L29125">                                throw new Exception();</span>
                            }
<span class="nc" id="L29127">                            sizes.add(Board.getSize(query_file));</span>
                        }
<span class="nc" id="L29129">                    } catch (Exception e) {</span>
<span class="nc" id="L29130">                        MegaMek.getLogger().error(&quot;Error parsing board: &quot; + query_file.getAbsolutePath(), e);</span>
<span class="nc" id="L29131">                    }</span>
                }
            }
        }
<span class="nc" id="L29135">    }</span>

    /**
     * Get a list of the available board sizes from the boards data directory.
     *
     * @return A Set containing all the available board sizes.
     */
    private Set&lt;BoardDimensions&gt; getBoardSizes() {
<span class="nc" id="L29143">        TreeSet&lt;BoardDimensions&gt; board_sizes = new TreeSet&lt;&gt;();</span>

<span class="nc" id="L29145">        File boards_dir = Configuration.boardsDir();</span>
        // Slightly overkill sanity check...
<span class="nc bnc" id="L29147" title="All 2 branches missed.">        if (boards_dir.isDirectory()) {</span>
<span class="nc" id="L29148">            getBoardSizesInDir(boards_dir, board_sizes);</span>
        }
<span class="nc" id="L29150">        boards_dir = new File(Configuration.userdataDir(), Configuration.boardsDir().toString());</span>
<span class="nc bnc" id="L29151" title="All 2 branches missed.">        if (boards_dir.isDirectory()) {</span>
<span class="nc" id="L29152">            getBoardSizesInDir(boards_dir, board_sizes);</span>
        }

<span class="nc" id="L29155">        return board_sizes;</span>
    }

    /**
     * Scan for map boards with the specified dimensions.
     *
     * @param dimensions The desired board dimensions.
     * @return A list of path names, minus the '.board' extension, relative to
     * the boards data directory.
     */
    private ArrayList&lt;String&gt; scanForBoards(final BoardDimensions dimensions) {
<span class="nc" id="L29166">        ArrayList&lt;String&gt; boards = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L29168">        File boardDir = Configuration.boardsDir();</span>
<span class="nc" id="L29169">        boards.add(MapSettings.BOARD_GENERATED);</span>
        // just a check...
<span class="nc bnc" id="L29171" title="All 2 branches missed.">        if (!boardDir.isDirectory()) {</span>
<span class="nc" id="L29172">            return boards;</span>
        }

        // scan files
<span class="nc" id="L29176">        List&lt;String&gt; tempList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L29177">        Comparator&lt;String&gt; sortComp = StringUtil.stringComparator();</span>
<span class="nc" id="L29178">        scanForBoardsInDir(boardDir, &quot;&quot;, dimensions, tempList);</span>
        // Check boards in userData dir
<span class="nc" id="L29180">        boardDir = new File(Configuration.userdataDir(), Configuration.boardsDir().toString());</span>
<span class="nc bnc" id="L29181" title="All 2 branches missed.">        if (boardDir.isDirectory()) {</span>
<span class="nc" id="L29182">            scanForBoardsInDir(boardDir, &quot;&quot;, dimensions, tempList);</span>
        }
        // if there are any boards, add these:
<span class="nc bnc" id="L29185" title="All 2 branches missed.">        if (tempList.size() &gt; 0) {</span>
<span class="nc" id="L29186">            boards.add(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L29187">            boards.add(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L29188">            tempList.sort(sortComp);</span>
<span class="nc" id="L29189">            boards.addAll(tempList);</span>
        }

<span class="nc" id="L29192">        return boards;</span>
    }

    /**
     * @return whether this game is double blind or not and we should be blind in
     * the current phase
     */
    private boolean doBlind() {
<span class="nc bnc" id="L29200" title="All 2 branches missed.">        return game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L29201" title="All 2 branches missed.">               &amp;&amp; game.getPhase().isDuringOrAfter(IGame.Phase.PHASE_DEPLOYMENT);</span>
    }

    private boolean suppressBlindBV() {
<span class="nc" id="L29205">        return game.getOptions().booleanOption(OptionsConstants.ADVANCED_SUPPRESS_DB_BV);</span>
    }

    /**
     * In a double-blind game, update only visible entities. Otherwise, update
     * everyone
     */
    public void entityUpdate(int nEntityID) {
<span class="nc" id="L29213">        entityUpdate(nEntityID, new Vector&lt;&gt;(), true, null);</span>
<span class="nc" id="L29214">    }</span>

    /**
     * In a double-blind game, update only visible entities. Otherwise, update
     * everyone
     *
     * @param updateVisibility Flag that determines if whoCanSee needs to be
     *                         called to update who can see the entity for
     *                         double-blind games.
     */
    public void entityUpdate(int nEntityID, Vector&lt;UnitLocation&gt; movePath, boolean updateVisibility,
                             Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc" id="L29226">        Entity eTarget = game.getEntity(nEntityID);</span>
<span class="nc bnc" id="L29227" title="All 2 branches missed.">        if (eTarget == null) {</span>
<span class="nc bnc" id="L29228" title="All 2 branches missed.">            if (game.getOutOfGameEntity(nEntityID) != null) {</span>
<span class="nc" id="L29229">                MegaMek.getLogger().error(&quot;S: attempted to send entity update for out of game entity, id was &quot; + nEntityID);</span>
            } else {
<span class="nc" id="L29231">                MegaMek.getLogger().error(&quot;S: attempted to send entity update for null entity, id was &quot; + nEntityID);</span>
            }

<span class="nc" id="L29234">            return; // do not send the update it will crash the client</span>
        }

        // If we're doing double blind, be careful who can see it...
<span class="nc bnc" id="L29238" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L29239">            Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
            Vector&lt;IPlayer&gt; vCanSee;
<span class="nc bnc" id="L29241" title="All 2 branches missed.">            if (updateVisibility) {</span>
<span class="nc" id="L29242">                vCanSee = whoCanSee(eTarget, true, losCache);</span>
            } else {
<span class="nc" id="L29244">                vCanSee = eTarget.getWhoCanSee();</span>
            }

            // If this unit has ECM, players with units affected by the ECM will
            //  need to know about this entity, even if they can't see it.
            //  Otherwise, the client can't properly report things like to-hits.
<span class="nc bnc" id="L29250" title="All 4 branches missed.">            if ((eTarget.getECMRange() &gt; 0) &amp;&amp; (eTarget.getPosition() != null)) {</span>
<span class="nc" id="L29251">                int ecmRange = eTarget.getECMRange();</span>
<span class="nc" id="L29252">                Coords pos = eTarget.getPosition();</span>
<span class="nc bnc" id="L29253" title="All 2 branches missed.">                for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L29254" title="All 2 branches missed.">                    if ((ent.getPosition() != null)</span>
<span class="nc bnc" id="L29255" title="All 2 branches missed.">                        &amp;&amp; (pos.distance(ent.getPosition()) &lt;= ecmRange)) {</span>
<span class="nc bnc" id="L29256" title="All 2 branches missed.">                        if (!vCanSee.contains(ent.getOwner())) {</span>
<span class="nc" id="L29257">                            vCanSee.add(ent.getOwner());</span>
                        }
                    }
<span class="nc" id="L29260">                }</span>
            }

            // send an entity update to everyone who can see
<span class="nc" id="L29264">            Packet pack = createEntityPacket(nEntityID, movePath);</span>
<span class="nc bnc" id="L29265" title="All 2 branches missed.">            for (int x = 0; x &lt; vCanSee.size(); x++) {</span>
<span class="nc" id="L29266">                IPlayer p = vCanSee.elementAt(x);</span>
<span class="nc" id="L29267">                send(p.getId(), pack);</span>
            }
            // send an entity delete to everyone else
<span class="nc" id="L29270">            pack = createRemoveEntityPacket(nEntityID,</span>
<span class="nc" id="L29271">                                            eTarget.getRemovalCondition());</span>
<span class="nc bnc" id="L29272" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc bnc" id="L29273" title="All 2 branches missed.">                if (!vCanSee.contains(playersVector.elementAt(x))) {</span>
<span class="nc" id="L29274">                    IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29275">                    send(p.getId(), pack);</span>
                }
            }

<span class="nc" id="L29279">            entityUpdateLoadedUnits(eTarget, vCanSee, playersVector);</span>
<span class="nc" id="L29280">        } else {</span>
            // But if we're not, then everyone can see.
<span class="nc" id="L29282">            send(createEntityPacket(nEntityID, movePath));</span>
        }
<span class="nc" id="L29284">    }</span>

    /**
     * Whenever updating an Entity, we also need to update all of its loaded
     * Entity's, otherwise it could cause issues with Clients.
     *
     * @param loader        An Entity being updated that is transporting units that should
     *                      also send an update
     * @param vCanSee       The list of Players who can see the loader.
     * @param playersVector The list of all Players
     */
    private void entityUpdateLoadedUnits(Entity loader,
                                         Vector&lt;IPlayer&gt; vCanSee, Vector&lt;IPlayer&gt; playersVector) {
        Packet pack;

        // In double-blind, the client may not know about the loaded units,
        // so we need to send them.
<span class="nc bnc" id="L29301" title="All 2 branches missed.">        for (Entity eLoaded : loader.getLoadedUnits()) {</span>
            // send an entity update to everyone who can see
<span class="nc" id="L29303">            pack = createEntityPacket(eLoaded.getId(), null);</span>
<span class="nc bnc" id="L29304" title="All 2 branches missed.">            for (int x = 0; x &lt; vCanSee.size(); x++) {</span>
<span class="nc" id="L29305">                IPlayer p = vCanSee.elementAt(x);</span>
<span class="nc" id="L29306">                send(p.getId(), pack);</span>
            }
            // send an entity delete to everyone else
<span class="nc" id="L29309">            pack = createRemoveEntityPacket(eLoaded.getId(),</span>
<span class="nc" id="L29310">                                            eLoaded.getRemovalCondition());</span>
<span class="nc bnc" id="L29311" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc bnc" id="L29312" title="All 2 branches missed.">                if (!vCanSee.contains(playersVector.elementAt(x))) {</span>
<span class="nc" id="L29313">                    IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29314">                    send(p.getId(), pack);</span>
                }
            }
<span class="nc" id="L29317">            entityUpdateLoadedUnits(eLoaded, vCanSee, playersVector);</span>
<span class="nc" id="L29318">        }</span>
<span class="nc" id="L29319">    }</span>

    /**
     * Returns a vector of which players can see this entity, always allowing
     * for sensor detections.
     */
    private Vector&lt;IPlayer&gt; whoCanSee(Entity entity) {
<span class="nc" id="L29326">        return whoCanSee(entity, true, null);</span>
    }

    /**
     * Returns a vector of which players can see the given entity, optionally
     * allowing for sensors to count.
     *
     * @param entity     The entity to check visibility for
     * @param useSensors A flag that determines whether sensors are allowed
     * @return A vector of the players who can see the entity
     */
    private Vector&lt;IPlayer&gt; whoCanSee(Entity entity, boolean useSensors,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29339" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29340">            losCache = new HashMap&lt;&gt;();</span>
        }
        // Some times Null entities are sent to this
<span class="nc bnc" id="L29343" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L29344">            return new Vector&lt;&gt;();</span>
        }

<span class="nc" id="L29347">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29348" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS) &amp;&amp; useSensors) {</span>
<span class="nc" id="L29349">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L29350">                    .getEntitiesVector());</span>
        }

<span class="nc" id="L29353">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>
<span class="nc" id="L29354">        List&lt;Entity&gt; vEntities = game.getEntitiesVector();</span>

<span class="nc" id="L29356">        Vector&lt;IPlayer&gt; vCanSee = new Vector&lt;&gt;();</span>
<span class="nc" id="L29357">        vCanSee.addElement(entity.getOwner());</span>
<span class="nc bnc" id="L29358" title="All 2 branches missed.">        if (bTeamVision) {</span>
<span class="nc" id="L29359">            addTeammates(vCanSee, entity.getOwner());</span>
        }

        // Deal with players who can see all.
<span class="nc bnc" id="L29363" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; p = game.getPlayers(); p.hasMoreElements();) {</span>
<span class="nc" id="L29364">            IPlayer player = p.nextElement();</span>

<span class="nc bnc" id="L29366" title="All 4 branches missed.">            if (player.canSeeAll() &amp;&amp; !vCanSee.contains(player)) {</span>
<span class="nc" id="L29367">                vCanSee.addElement(player);</span>
            }
<span class="nc" id="L29369">        }</span>

        // If the entity is hidden, skip; no one else will be able to see it.
<span class="nc bnc" id="L29372" title="All 2 branches missed.">        if (entity.isHidden()) {</span>
<span class="nc" id="L29373">            return vCanSee;</span>
        }
<span class="nc bnc" id="L29375" title="All 2 branches missed.">        for (Entity spotter : vEntities) {</span>
            // Certain conditions make the spotter ineligible
<span class="nc bnc" id="L29377" title="All 4 branches missed.">            if (!spotter.isActive() || spotter.isOffBoard()</span>
<span class="nc bnc" id="L29378" title="All 2 branches missed.">                    || vCanSee.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29379">                continue;</span>
            }
            // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29382">            EntityTargetPair etp = new EntityTargetPair(spotter, entity);</span>
<span class="nc" id="L29383">            LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29384" title="All 2 branches missed.">            if (los == null) {</span>
<span class="nc" id="L29385">                los = LosEffects.calculateLos(game, spotter.getId(), entity);</span>
<span class="nc" id="L29386">                losCache.put(etp, los);</span>
            }
<span class="nc bnc" id="L29388" title="All 2 branches missed.">            if (Compute.canSee(game, spotter, entity, useSensors, los,</span>
                    allECMInfo)) {
<span class="nc bnc" id="L29390" title="All 2 branches missed.">                if (!vCanSee.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29391">                    vCanSee.addElement(spotter.getOwner());</span>
                }
<span class="nc bnc" id="L29393" title="All 2 branches missed.">                if (bTeamVision) {</span>
<span class="nc" id="L29394">                    addTeammates(vCanSee, spotter.getOwner());</span>
                }
<span class="nc" id="L29396">                addObservers(vCanSee);</span>
            }
<span class="nc" id="L29398">        }</span>
<span class="nc" id="L29399">        return vCanSee;</span>
    }

    /**
     * Determine which players can detect the given entity with sensors.
     * Because recomputing ECM and LosEffects frequently can get expensive, this
     * data can be cached and passed in.
     *
     * @param entity        The Entity being detected.
     * @param allECMInfo    Cached ECMInfo for all Entities in the game.
     * @param losCache      Cached LosEffects for particular Entity/Targetable
     *                      pairs.  Can be passed in null.
     * @return
     */
    private Vector&lt;IPlayer&gt; whoCanDetect(Entity entity,
            List&lt;ECMInfo&gt; allECMInfo,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29416" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29417">            losCache = new HashMap&lt;&gt;();</span>
        }

<span class="nc" id="L29420">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>
<span class="nc" id="L29421">        List&lt;Entity&gt; vEntities = game.getEntitiesVector();</span>

<span class="nc" id="L29423">        Vector&lt;IPlayer&gt; vCanDetect = new Vector&lt;&gt;();</span>

        // If the entity is hidden, skip; no one else will be able to detect it
<span class="nc bnc" id="L29426" title="All 4 branches missed.">        if (entity.isHidden() || entity.isOffBoard()) {</span>
<span class="nc" id="L29427">            return vCanDetect;</span>
        }

<span class="nc bnc" id="L29430" title="All 2 branches missed.">        for (Entity spotter : vEntities) {</span>
<span class="nc bnc" id="L29431" title="All 4 branches missed.">            if (!spotter.isActive() || spotter.isOffBoard()</span>
<span class="nc bnc" id="L29432" title="All 2 branches missed.">                    || vCanDetect.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29433">                continue;</span>
            }
            // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29436">            EntityTargetPair etp = new EntityTargetPair(spotter, entity);</span>
<span class="nc" id="L29437">            LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29438" title="All 2 branches missed.">            if (los == null) {</span>
<span class="nc" id="L29439">                los = LosEffects.calculateLos(game, spotter.getId(), entity);</span>
<span class="nc" id="L29440">                losCache.put(etp, los);</span>
            }
<span class="nc bnc" id="L29442" title="All 2 branches missed.">            if (Compute.inSensorRange(game, los, spotter, entity, allECMInfo)) {</span>
<span class="nc bnc" id="L29443" title="All 2 branches missed.">                if (!vCanDetect.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29444">                    vCanDetect.addElement(spotter.getOwner());</span>
                }
<span class="nc bnc" id="L29446" title="All 2 branches missed.">                if (bTeamVision) {</span>
<span class="nc" id="L29447">                    addTeammates(vCanDetect, spotter.getOwner());</span>
                }
<span class="nc" id="L29449">                addObservers(vCanDetect);</span>
            }
<span class="nc" id="L29451">            }</span>

<span class="nc" id="L29453">        return vCanDetect;</span>
    }

    /**
     * Adds teammates of a player to the Vector. Utility function for whoCanSee.
     */
    private void addTeammates(Vector&lt;IPlayer&gt; vector, IPlayer player) {
<span class="nc" id="L29460">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29461" title="All 2 branches missed.">        for (int j = 0; j &lt; playersVector.size(); j++) {</span>
<span class="nc" id="L29462">            IPlayer p = playersVector.elementAt(j);</span>
<span class="nc bnc" id="L29463" title="All 4 branches missed.">            if (!player.isEnemyOf(p) &amp;&amp; !vector.contains(p)) {</span>
<span class="nc" id="L29464">                vector.addElement(p);</span>
            }
        }
<span class="nc" id="L29467">    }</span>

    /**
     * Adds observers to the Vector. Utility function for whoCanSee.
     */
    private void addObservers(Vector&lt;IPlayer&gt; vector) {
<span class="nc" id="L29473">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29474" title="All 2 branches missed.">        for (int j = 0; j &lt; playersVector.size(); j++) {</span>
<span class="nc" id="L29475">            IPlayer p = playersVector.elementAt(j);</span>
<span class="nc bnc" id="L29476" title="All 4 branches missed.">            if (p.isObserver() &amp;&amp; !vector.contains(p)) {</span>
<span class="nc" id="L29477">                vector.addElement(p);</span>
            }
        }
<span class="nc" id="L29480">    }</span>

    /**
     * Send the complete list of entities to the players. If double_blind is in
     * effect, enforce it by filtering the entities
     */
    private void entityAllUpdate() {
        // If double-blind is in effect, filter each players' list individually,
        // and then quit out...
<span class="nc bnc" id="L29489" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L29490">            Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29491" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc" id="L29492">                IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29493">                send(p.getId(), createFilteredEntitiesPacket(p, null));</span>
            }
<span class="nc" id="L29495">            return;</span>
        }

        // Otherwise, send the full list.
<span class="nc" id="L29499">        send(createEntitiesPacket());</span>
<span class="nc" id="L29500">    }</span>

    /**
     * Filters an entity vector according to LOS
     */
    private List&lt;Entity&gt; filterEntities(IPlayer pViewer,
            List&lt;Entity&gt; vEntities,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29508" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29509">            losCache = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L29511">        Vector&lt;Entity&gt; vCanSee = new Vector&lt;&gt;();</span>
<span class="nc" id="L29512">        Vector&lt;Entity&gt; vMyEntities = new Vector&lt;&gt;();</span>
<span class="nc" id="L29513">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>

        // If they can see all, return the input list
<span class="nc bnc" id="L29516" title="All 2 branches missed.">        if (pViewer.canSeeAll()) {</span>
<span class="nc" id="L29517">            return vEntities;</span>
        }

<span class="nc" id="L29520">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29521" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L29522">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game.getEntitiesVector());</span>
        }

        // If they're an observer, they can see anything seen by any enemy.
<span class="nc bnc" id="L29526" title="All 2 branches missed.">        if (pViewer.isObserver()) {</span>
<span class="nc" id="L29527">            vMyEntities.addAll(vEntities);</span>
<span class="nc bnc" id="L29528" title="All 2 branches missed.">            for (Entity a : vMyEntities) {</span>
<span class="nc bnc" id="L29529" title="All 2 branches missed.">                for (Entity b : vMyEntities) {</span>
<span class="nc bnc" id="L29530" title="All 2 branches missed.">                    if (a.isEnemyOf(b)</span>
<span class="nc bnc" id="L29531" title="All 2 branches missed.">                        &amp;&amp; Compute.canSee(game, b, a, true, null, allECMInfo)) {</span>
<span class="nc" id="L29532">                        addVisibleEntity(vCanSee, a);</span>
<span class="nc" id="L29533">                        break;</span>
                    }
<span class="nc" id="L29535">                }</span>
<span class="nc" id="L29536">            }</span>
<span class="nc" id="L29537">            return vCanSee;</span>
        }

        // If they aren't an observer and can't see all, create the list of
        // &quot;friendly&quot; units.
<span class="nc bnc" id="L29542" title="All 2 branches missed.">        for (Entity e : vEntities) {</span>
<span class="nc bnc" id="L29543" title="All 6 branches missed.">            if ((e.getOwner() == pViewer) || (bTeamVision &amp;&amp; !e.getOwner().isEnemyOf(pViewer))) {</span>
<span class="nc" id="L29544">                vMyEntities.addElement(e);</span>
            }
<span class="nc" id="L29546">        }</span>

        // Then, break down the list by whether they're friendly,
        // or whether or not any friendly unit can see them.
<span class="nc bnc" id="L29550" title="All 2 branches missed.">        for (Entity e : vEntities) {</span>
            // If it's their own unit, obviously, they can see it.
<span class="nc bnc" id="L29552" title="All 2 branches missed.">            if (vMyEntities.contains(e)) {</span>
<span class="nc" id="L29553">                addVisibleEntity(vCanSee, e);</span>
<span class="nc" id="L29554">                continue;</span>
<span class="nc bnc" id="L29555" title="All 2 branches missed.">            } else if (e.isHidden()) {</span>
                // If it's NOT friendly and is hidden, they can't see it,
                // period.
                // LOS doesn't matter.
<span class="nc" id="L29559">                continue;</span>
            }
<span class="nc bnc" id="L29561" title="All 2 branches missed.">            for (Entity spotter : vMyEntities) {</span>

                // If they're off-board, skip it; they can't see anything.
<span class="nc bnc" id="L29564" title="All 2 branches missed.">                if (spotter.isOffBoard()) {</span>
<span class="nc" id="L29565">                    continue;</span>
                }

                // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29569">                EntityTargetPair etp = new EntityTargetPair(spotter, e);</span>
<span class="nc" id="L29570">                LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29571" title="All 2 branches missed.">                if (los == null) {</span>
<span class="nc" id="L29572">                    los = LosEffects.calculateLos(game, spotter.getId(), e);</span>
<span class="nc" id="L29573">                    losCache.put(etp, los);</span>
                }
                // Otherwise, if they can see the entity in question
<span class="nc bnc" id="L29576" title="All 2 branches missed.">                if (Compute.canSee(game, spotter, e, true, los, allECMInfo)) {</span>
<span class="nc" id="L29577">                    addVisibleEntity(vCanSee, e);</span>
<span class="nc" id="L29578">                    break;</span>
                }

                // If this unit has ECM, players with units affected by the ECM
                //  will need to know about this entity, even if they can't see
                //  it.  Otherwise, the client can't properly report things
                //  like to-hits.
<span class="nc bnc" id="L29585" title="All 4 branches missed.">                if ((e.getECMRange() &gt; 0) &amp;&amp; (e.getPosition() != null) &amp;&amp;</span>
<span class="nc bnc" id="L29586" title="All 2 branches missed.">                    (spotter.getPosition() != null)) {</span>
<span class="nc" id="L29587">                    int ecmRange = e.getECMRange();</span>
<span class="nc" id="L29588">                    Coords pos = e.getPosition();</span>
<span class="nc bnc" id="L29589" title="All 2 branches missed.">                    if (pos.distance(spotter.getPosition()) &lt;= ecmRange) {</span>
<span class="nc" id="L29590">                        addVisibleEntity(vCanSee, e);</span>
                    }
                }
<span class="nc" id="L29593">            }</span>
<span class="nc" id="L29594">        }</span>

<span class="nc" id="L29596">        return vCanSee;</span>
    }

    /**
     * Recursive method to add an &lt;code&gt;Entity&lt;/code&gt; and all of its transported
     * units to the list of units visible to a particular player. It is
     * important to ensure that if a unit is in the list of visible units then
     * all of its transported units (and their transported units, and so on) are
     * also considered visible, otherwise it can lead to issues. This method
     * also ensures that no duplicate Entities are added.
     *
     * @param vCanSee A collection of units that can be see
     * @param e       An Entity that is seen and needs to be added to the collection
     *                of seen entities. All of
     */
    private void addVisibleEntity(Vector&lt;Entity&gt; vCanSee, Entity e) {
<span class="nc bnc" id="L29612" title="All 2 branches missed.">        if (!vCanSee.contains(e)) {</span>
<span class="nc" id="L29613">            vCanSee.add(e);</span>
        }
<span class="nc bnc" id="L29615" title="All 2 branches missed.">        for (Entity transported : e.getLoadedUnits()) {</span>
<span class="nc" id="L29616">            addVisibleEntity(vCanSee, transported);</span>
<span class="nc" id="L29617">        }</span>
<span class="nc" id="L29618">    }</span>

    /**
     * Filter a report vector for double blind.
     *
     * @param originalReportVector the original &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt;
     * @param p                    the &lt;code&gt;Player&lt;/code&gt; who should see stuff only visible to
     *                             him
     * @return the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; with stuff only Player p can see
     */
    private Vector&lt;Report&gt; filterReportVector(Vector&lt;Report&gt; originalReportVector, IPlayer p) {
        // If no double blind, no filtering to do
<span class="nc bnc" id="L29630" title="All 2 branches missed.">        if (!doBlind()) {</span>
<span class="nc" id="L29631">            return new Vector&lt;&gt;(originalReportVector);</span>
        }
        // But if it is, then filter everything properly.
<span class="nc" id="L29634">        Vector&lt;Report&gt; filteredReportVector = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29635" title="All 2 branches missed.">        for (Report r : originalReportVector) {</span>
<span class="nc" id="L29636">            Report filteredReport = filterReport(r, p, false);</span>
<span class="nc bnc" id="L29637" title="All 2 branches missed.">            if (filteredReport != null) {</span>
<span class="nc" id="L29638">                filteredReportVector.addElement(filteredReport);</span>
            }
<span class="nc" id="L29640">        }</span>
<span class="nc" id="L29641">        return filteredReportVector;</span>
    }

    /**
     * Filter a single report so that the correct double-blind obscuration takes
     * place. To mark a message as &quot;this should be visible to anyone seeing this
     * entity&quot; set r.subject to the entity id to mark a message as &quot;only visible
     * to the player&quot; set r.player to that player's id and set r.type to
     * Report.PLAYER to mark a message as visible to all, set r.type to
     * Report.PUBLIC
     *
     * @param r         the Report to filter
     * @param p         the Player that we are going to send the filtered report to
     * @param omitCheck boolean indicating that this report happened in the past, so we
     *                  no longer have access to the Player
     * @return a new Report, which has possibly been obscured
     */
    private Report filterReport(Report r, IPlayer p, boolean omitCheck) {
<span class="nc bnc" id="L29659" title="All 6 branches missed.">        if ((r.subject == Entity.NONE) &amp;&amp; (r.type != Report.PLAYER) &amp;&amp; (r.type != Report.PUBLIC)) {</span>
            // Reports that don't have a subject should be public.
<span class="nc" id="L29661">            MegaMek.getLogger().error(&quot;Attempting to filter a Report object that is not public yet &quot;</span>
                            + &quot;but has no subject.\n\t\tmessageId: &quot; + r.messageId);
<span class="nc" id="L29663">            return r;</span>
        }
<span class="nc bnc" id="L29665" title="All 6 branches missed.">        if ((r.type == Report.PUBLIC) || ((p == null) &amp;&amp; !omitCheck)) {</span>
<span class="nc" id="L29666">            return r;</span>
        }
<span class="nc" id="L29668">        Entity entity = game.getEntity(r.subject);</span>
<span class="nc bnc" id="L29669" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L29670">            entity = game.getOutOfGameEntity(r.subject);</span>
        }
<span class="nc" id="L29672">        IPlayer owner = null;</span>
<span class="nc bnc" id="L29673" title="All 2 branches missed.">        if (entity != null) {</span>
<span class="nc" id="L29674">            owner = entity.getOwner();</span>
            // off board (Artillery) units get treated as public messages
<span class="nc bnc" id="L29676" title="All 2 branches missed.">            if (entity.isOffBoard()) {</span>
<span class="nc" id="L29677">                return r;</span>
            }
        }

<span class="nc bnc" id="L29681" title="All 8 branches missed.">        if ((r.type != Report.PLAYER) &amp;&amp; !omitCheck</span>
            &amp;&amp; ((entity == null) || (owner == null))) {
<span class="nc" id="L29683">            MegaMek.getLogger().error(&quot;Attempting to filter a report object that is not public but has a subject (&quot;</span>
                            + entity + &quot;) with owner (&quot; + owner + &quot;).\n\tmessageId: &quot; + r.messageId);
<span class="nc" id="L29685">            return r;</span>
        }

<span class="nc bnc" id="L29688" title="All 4 branches missed.">        boolean shouldObscure = omitCheck</span>
<span class="nc bnc" id="L29689" title="All 4 branches missed.">                                || ((entity != null) &amp;&amp; !entity.hasSeenEntity(p))</span>
<span class="nc bnc" id="L29690" title="All 2 branches missed.">                                || ((r.type == Report.PLAYER) &amp;&amp; (p.getId() != r.player));</span>
        // If suppressing double blind messages, don't send this report at all.
<span class="nc" id="L29692">        if (game.getOptions()</span>
<span class="nc bnc" id="L29693" title="All 4 branches missed.">                .booleanOption(OptionsConstants.ADVANCED_SUPRESS_ALL_DB_MESSAGES)</span>
            &amp;&amp; shouldObscure) {
            // Mark the original report to indicate it was filtered
<span class="nc bnc" id="L29696" title="All 2 branches missed.">            if (p != null) {</span>
<span class="nc" id="L29697">                r.addObscuredRecipient(p.getName());</span>
            }
<span class="nc" id="L29699">            return null;</span>
        }
<span class="nc" id="L29701">        Report copy = new Report(r);</span>
        // Otherwise, obscure data in the report
<span class="nc bnc" id="L29703" title="All 2 branches missed.">        for (int j = 0; j &lt; copy.dataCount(); j++) {</span>
<span class="nc bnc" id="L29704" title="All 2 branches missed.">            if (shouldObscure) {</span>
                // This report should be obscured
<span class="nc bnc" id="L29706" title="All 2 branches missed.">                if (r.isValueObscured(j)) {</span>
<span class="nc" id="L29707">                    copy.hideData(j);</span>
                    // Mark the original report to indicate which players
                    // received an obscured version of it.
<span class="nc bnc" id="L29710" title="All 2 branches missed.">                    if (p != null) {</span>
<span class="nc" id="L29711">                        r.addObscuredRecipient(p.getName());</span>
                    }
                }
            }
        }
<span class="nc" id="L29716">        return copy;</span>
    }

    /**
     *
     * @return a vector which has as its keys the round number and as its
     *         elements vectors that contain all the reports for the specified player
     *         that round. The reports returned this way are properly filtered for
     *         double blind.
     */
    private Vector&lt;Vector&lt;Report&gt;&gt; filterPastReports(
            Vector&lt;Vector&lt;Report&gt;&gt; pastReports, IPlayer p) {
        // Only actually bother with the filtering if double-blind is in effect.
<span class="nc bnc" id="L29729" title="All 2 branches missed.">        if (!doBlind()) {</span>
<span class="nc" id="L29730">            return pastReports;</span>
        }
        // Perform filtering
<span class="nc" id="L29733">        Vector&lt;Vector&lt;Report&gt;&gt; filteredReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29734" title="All 2 branches missed.">        for (Vector&lt;Report&gt; roundReports : pastReports) {</span>
<span class="nc" id="L29735">            Vector&lt;Report&gt; filteredRoundReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29736" title="All 2 branches missed.">            for (Report r : roundReports) {</span>
<span class="nc bnc" id="L29737" title="All 2 branches missed.">                if (r.isObscuredRecipient(p.getName())) {</span>
<span class="nc" id="L29738">                    r = filterReport(r, null, true);</span>
                }
<span class="nc bnc" id="L29740" title="All 2 branches missed.">                if (r != null) {</span>
<span class="nc" id="L29741">                    filteredRoundReports.addElement(r);</span>
                }
<span class="nc" id="L29743">            }</span>
<span class="nc" id="L29744">            filteredReports.addElement(filteredRoundReports);</span>
<span class="nc" id="L29745">        }</span>
<span class="nc" id="L29746">        return filteredReports;</span>
    }

    /**
     * Updates entities graphical &quot;visibility indications&quot; which are used in
     * double-blind games.
     *
     * @param losCache  It can be expensive to have to recompute LoSEffects
     *                  again and again, so in some cases where this may happen,
     *                  the LosEffects are cached.   This can safely be null.
     */
    private void updateVisibilityIndicator(Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29758" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29759">            losCache = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L29761">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29762" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L29763">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L29764">                    .getEntitiesVector());</span>
        }

<span class="nc" id="L29767">        List&lt;Entity&gt; vAllEntities = game.getEntitiesVector();</span>
<span class="nc bnc" id="L29768" title="All 2 branches missed.">        for (Entity e : vAllEntities) {</span>
<span class="nc" id="L29769">            Vector&lt;IPlayer&gt; whoCouldSee = new Vector&lt;&gt;(e.getWhoCanSee());</span>
<span class="nc" id="L29770">            Vector&lt;IPlayer&gt; whoCouldDetect = new Vector&lt;&gt;(e.getWhoCanDetect());</span>
<span class="nc" id="L29771">            e.setVisibleToEnemy(false);</span>
<span class="nc" id="L29772">            e.setDetectedByEnemy(false);</span>
<span class="nc" id="L29773">            e.clearSeenBy();</span>
<span class="nc" id="L29774">            e.clearDetectedBy();</span>
<span class="nc" id="L29775">            Vector&lt;IPlayer&gt; vCanSee = whoCanSee(e, false, losCache);</span>
            // Who can See this unit?
<span class="nc bnc" id="L29777" title="All 2 branches missed.">            for (IPlayer p : vCanSee) {</span>
<span class="nc bnc" id="L29778" title="All 4 branches missed.">                if (e.getOwner().isEnemyOf(p) &amp;&amp; !p.isObserver()) {</span>
<span class="nc" id="L29779">                    e.setVisibleToEnemy(true);</span>
<span class="nc" id="L29780">                    e.setEverSeenByEnemy(true);</span>
                    // If we can see it, it's detected
<span class="nc" id="L29782">                    e.setDetectedByEnemy(true);</span>
                }
<span class="nc" id="L29784">                e.addBeenSeenBy(p);</span>
<span class="nc" id="L29785">            }</span>
            // Who can Detect this unit?
<span class="nc" id="L29787">            Vector&lt;IPlayer&gt; vCanDetect = whoCanDetect(e, allECMInfo, losCache);</span>
<span class="nc bnc" id="L29788" title="All 2 branches missed.">            for (IPlayer p : vCanDetect) {</span>
<span class="nc bnc" id="L29789" title="All 4 branches missed.">                if (e.getOwner().isEnemyOf(p) &amp;&amp; !p.isObserver()) {</span>
<span class="nc" id="L29790">                    e.setDetectedByEnemy(true);</span>
                }
<span class="nc" id="L29792">                e.addBeenDetectedBy(p);</span>
<span class="nc" id="L29793">            }</span>

            // If a client can now see/detect this entity, but couldn't before,
            // then the client needs to be updated with the Entity
<span class="nc" id="L29797">            boolean hasClientWithoutEntity = false;</span>
<span class="nc bnc" id="L29798" title="All 2 branches missed.">            for (IPlayer p : vCanSee) {</span>
<span class="nc bnc" id="L29799" title="All 4 branches missed.">                if (!whoCouldSee.contains(p) &amp;&amp; !whoCouldDetect.contains(p)) {</span>
<span class="nc" id="L29800">                    hasClientWithoutEntity = true;</span>
<span class="nc" id="L29801">                    break;</span>
                }
<span class="nc" id="L29803">            }</span>
<span class="nc bnc" id="L29804" title="All 2 branches missed.">            if (!hasClientWithoutEntity) {</span>
<span class="nc bnc" id="L29805" title="All 2 branches missed.">                for (IPlayer p : vCanDetect) {</span>
<span class="nc bnc" id="L29806" title="All 4 branches missed.">                    if (!whoCouldSee.contains(p) &amp;&amp; !whoCouldDetect.contains(p)) {</span>
<span class="nc" id="L29807">                        hasClientWithoutEntity = true;</span>
<span class="nc" id="L29808">                        break;</span>
                    }
<span class="nc" id="L29810">                }</span>
            }
<span class="nc bnc" id="L29812" title="All 2 branches missed.">            if (hasClientWithoutEntity) {</span>
<span class="nc" id="L29813">                entityUpdate(e.getId(), new Vector&lt;&gt;(), false, losCache);</span>
            } else {
<span class="nc" id="L29815">                sendVisibilityIndicator(e);</span>
            }
<span class="nc" id="L29817">        }</span>
<span class="nc" id="L29818">    }</span>

    /**
     * Checks if an entity added by the client is valid and if so, adds it to
     * the list
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityAdd(Packet c, int connIndex) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L29829">        final List&lt;Entity&gt; entities = (List&lt;Entity&gt;) c.getObject(0);</span>
<span class="nc" id="L29830">        List&lt;Integer&gt; entityIds = new ArrayList&lt;&gt;(entities.size());</span>
        // Map client-received to server-given IDs: 
<span class="nc" id="L29832">        Map&lt;Integer, Integer&gt; idMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L29834" title="All 2 branches missed.">        for (final Entity entity : entities) {</span>

            // Verify the entity's design
<span class="nc bnc" id="L29837" title="All 2 branches missed.">            if (Server.entityVerifier == null) {</span>
<span class="nc" id="L29838">                Server.entityVerifier = EntityVerifier.getInstance(new MegaMekFile(</span>
<span class="nc" id="L29839">                        Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</span>
            }

            // Create a TestEntity instance for supported unit types
<span class="nc" id="L29843">            TestEntity testEntity = null;</span>
<span class="nc" id="L29844">            entity.restore();</span>
<span class="nc bnc" id="L29845" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L29846">                testEntity = new TestMech((Mech) entity, entityVerifier.mechOption, null);</span>
<span class="nc bnc" id="L29847" title="All 2 branches missed.">            } else if ((entity.getEntityType() == Entity.ETYPE_TANK)</span>
<span class="nc bnc" id="L29848" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_GUN_EMPLACEMENT)) {</span>
<span class="nc bnc" id="L29849" title="All 2 branches missed.">                if (entity.isSupportVehicle()) {</span>
<span class="nc" id="L29850">                    testEntity = new TestSupportVehicle(entity, entityVerifier.tankOption, null);</span>
                } else {
<span class="nc" id="L29852">                    testEntity = new TestTank((Tank) entity, entityVerifier.tankOption, null);</span>
                }
<span class="nc bnc" id="L29854" title="All 2 branches missed.">            } else if ((entity.getEntityType() == Entity.ETYPE_AERO)</span>
<span class="nc bnc" id="L29855" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L29856" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L29857" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_FIGHTER_SQUADRON)</span>
<span class="nc bnc" id="L29858" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L29859" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_SPACE_STATION)) {</span>
<span class="nc" id="L29860">                testEntity = new TestAero((Aero) entity, entityVerifier.aeroOption, null);</span>
<span class="nc bnc" id="L29861" title="All 2 branches missed.">            } else if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L29862">                testEntity = new TestBattleArmor((BattleArmor) entity, entityVerifier.baOption, null);</span>
            }

<span class="nc bnc" id="L29865" title="All 2 branches missed.">            if (testEntity != null) {</span>
<span class="nc" id="L29866">                StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L29867" title="All 2 branches missed.">                if (testEntity.correctEntity(sb, TechConstants.getGameTechLevel(game, entity.isClan()))) {</span>
<span class="nc" id="L29868">                    entity.setDesignValid(true);</span>
                } else {
<span class="nc" id="L29870">                    MegaMek.getLogger().error(sb.toString());</span>
<span class="nc bnc" id="L29871" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ALLOWED_ALLOW_ILLEGAL_UNITS)) {</span>
<span class="nc" id="L29872">                        entity.setDesignValid(false);</span>
                    } else {
<span class="nc" id="L29874">                        IPlayer cheater = game.getPlayer(connIndex);</span>
<span class="nc" id="L29875">                        sendServerChat(&quot;Player &quot; + cheater.getName()</span>
                                       + &quot; attempted to add an illegal unit design (&quot;
<span class="nc" id="L29877">                                       + entity.getShortNameRaw()</span>
                                       + &quot;), the unit was rejected.&quot;);
<span class="nc" id="L29879">                        return;</span>
                    }
                }
            }

            // If we're adding a ProtoMech, calculate it's unit number.
<span class="nc bnc" id="L29885" title="All 2 branches missed.">            if (entity instanceof Protomech) {</span>
                // How many ProtoMechs does the player already have?
<span class="nc" id="L29887">                int numPlayerProtos = game</span>
<span class="nc" id="L29888">                        .getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L29889">                            private final int ownerId = entity.getOwnerId();</span>

                            public boolean accept(Entity entity) {
<span class="nc bnc" id="L29892" title="All 2 branches missed.">                                return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L29893" title="All 2 branches missed.">                                        &amp;&amp; (ownerId == entity.getOwnerId());</span>
                            }
                        });

                // According to page 54 of the BMRr, ProtoMechs must be
                // deployed in full Points of five, unless circumstances have
                // reduced the number to less than that.
<span class="nc" id="L29900">                entity.setUnitNumber((short) (numPlayerProtos / 5));</span>
            } // End added-ProtoMech

            // Only assign an entity ID when the client hasn't.
<span class="nc bnc" id="L29904" title="All 2 branches missed.">            if (Entity.NONE == entity.getId()) {</span>
<span class="nc" id="L29905">                entity.setId(getFreeEntityId());</span>
            }

<span class="nc" id="L29908">            int clientSideId = entity.getId();</span>
<span class="nc" id="L29909">            game.addEntity(entity);</span>
            
            // Remember which received ID corresponds to which actual ID
<span class="nc" id="L29912">            idMap.put(clientSideId, entity.getId());</span>

            // Now we relink C3/NC3/C3i to our guys! Yes, this is hackish... but, we
            // do what we must. Its just too bad we have to loop over the entire entities array..
<span class="nc bnc" id="L29916" title="All 6 branches missed.">            if (entity.hasC3() || entity.hasC3i() || entity.hasNavalC3()) {</span>
<span class="nc" id="L29917">                boolean C3iSet = false;</span>

<span class="nc bnc" id="L29919" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>

                    // C3 Checks
<span class="nc bnc" id="L29922" title="All 2 branches missed.">                    if (entity.hasC3()) {</span>
<span class="nc bnc" id="L29923" title="All 2 branches missed.">                        if ((entity.getC3MasterIsUUIDAsString() != null)</span>
<span class="nc bnc" id="L29924" title="All 2 branches missed.">                                &amp;&amp; entity.getC3MasterIsUUIDAsString().equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29925">                            entity.setC3Master(e, false);</span>
<span class="nc" id="L29926">                            entity.setC3MasterIsUUIDAsString(null);</span>
<span class="nc bnc" id="L29927" title="All 2 branches missed.">                        } else if ((e.getC3MasterIsUUIDAsString() != null)</span>
<span class="nc bnc" id="L29928" title="All 2 branches missed.">                                &amp;&amp; e.getC3MasterIsUUIDAsString().equals(entity.getC3UUIDAsString())) {</span>
<span class="nc" id="L29929">                            e.setC3Master(entity, false);</span>
<span class="nc" id="L29930">                            e.setC3MasterIsUUIDAsString(null);</span>
                            // Taharqa: we need to update the other entity for
                            // the
                            // client
                            // or it won't show up right. I am not sure if I
                            // like
                            // the idea of updating other entities in this
                            // method,
                            // but it
                            // will work for now.
<span class="nc bnc" id="L29940" title="All 2 branches missed.">                            if (!entities.contains(e)) {</span>
<span class="nc" id="L29941">                                entityUpdate(e.getId());</span>
                            }
                        }
                    }

                    // C3i Checks
<span class="nc bnc" id="L29947" title="All 4 branches missed.">                    if (entity.hasC3i() &amp;&amp; !C3iSet) {</span>
<span class="nc" id="L29948">                        entity.setC3NetIdSelf();</span>
<span class="nc" id="L29949">                        int pos = 0;</span>
<span class="nc bnc" id="L29950" title="All 2 branches missed.">                        while (pos &lt; Entity.MAX_C3i_NODES) {</span>
                            // We've found a network, join it.
<span class="nc bnc" id="L29952" title="All 2 branches missed.">                            if ((entity.getC3iNextUUIDAsString(pos) != null)</span>
<span class="nc bnc" id="L29953" title="All 2 branches missed.">                                    &amp;&amp; (e.getC3UUIDAsString() != null)</span>
<span class="nc" id="L29954">                                    &amp;&amp; entity.getC3iNextUUIDAsString(pos)</span>
<span class="nc bnc" id="L29955" title="All 2 branches missed.">                                    .equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29956">                                entity.setC3NetId(e);</span>
<span class="nc" id="L29957">                                C3iSet = true;</span>
<span class="nc" id="L29958">                                break;</span>
                            }

<span class="nc" id="L29961">                            pos++;</span>
                        }
                    }

                    // NC3 Checks
<span class="nc bnc" id="L29966" title="All 4 branches missed.">                    if (entity.hasNavalC3() &amp;&amp; !C3iSet) {</span>
<span class="nc" id="L29967">                        entity.setC3NetIdSelf();</span>
<span class="nc" id="L29968">                        int pos = 0;</span>
<span class="nc bnc" id="L29969" title="All 2 branches missed.">                        while (pos &lt; Entity.MAX_C3i_NODES) {</span>
                            // We've found a network, join it.
<span class="nc bnc" id="L29971" title="All 2 branches missed.">                            if ((entity.getNC3NextUUIDAsString(pos) != null)</span>
<span class="nc bnc" id="L29972" title="All 2 branches missed.">                                    &amp;&amp; (e.getC3UUIDAsString() != null)</span>
<span class="nc" id="L29973">                                    &amp;&amp; entity.getNC3NextUUIDAsString(pos)</span>
<span class="nc bnc" id="L29974" title="All 2 branches missed.">                                    .equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29975">                                entity.setC3NetId(e);</span>
<span class="nc" id="L29976">                                C3iSet = true;</span>
<span class="nc" id="L29977">                                break;</span>
                            }

<span class="nc" id="L29980">                            pos++;</span>
                        }
                    }
<span class="nc" id="L29983">                }</span>
            }
            // Give the unit a spotlight, if it has the spotlight quirk
<span class="nc bnc" id="L29986" title="All 2 branches missed.">            entity.setExternalSpotlight(entity.hasExternaSpotlight()</span>
<span class="nc bnc" id="L29987" title="All 2 branches missed.">                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</span>
<span class="nc" id="L29988">            entityIds.add(entity.getId());</span>

<span class="nc bnc" id="L29990" title="All 2 branches missed.">            if (game.getPhase() != Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L29991">                entity.getOwner().changeInitialEntityCount(1);</span>
<span class="nc" id="L29992">                entity.getOwner().changeInitialBV(entity.calculateBattleValue());</span>
            }
<span class="nc" id="L29994">        }</span>
        
        // Cycle through the entities again and update any carried units
        // and carrier units to use the correct server-given IDs.
        // Typically necessary when loading a MUL containing transported units.
        
        // First, deal with units loaded into bays. These are saved for the carrier
        // in MULs and must be restored exactly to recreate the bay loading.
<span class="nc" id="L30002">        Set&lt;Entity&gt; transportCorrected = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L30003" title="All 2 branches missed.">        for (final Entity carrier: entities) {</span>
<span class="nc bnc" id="L30004" title="All 2 branches missed.">            for (int carriedId: carrier.getBayLoadedUnitIds()) {</span>
                // First, see if a bay loaded unit can be found and unloaded,
                // because it might be the wrong unit
<span class="nc" id="L30007">                Entity carried = game.getEntity(carriedId);</span>
<span class="nc bnc" id="L30008" title="All 2 branches missed.">                if (carried == null) {</span>
<span class="nc" id="L30009">                    continue;</span>
                }
<span class="nc" id="L30011">                int bay = carrier.getBay(carried).getBayNumber();</span>
<span class="nc" id="L30012">                carrier.unload(carried);</span>
                // Now, load the correct unit if there is one
<span class="nc bnc" id="L30014" title="All 2 branches missed.">                if (idMap.containsKey(carriedId)) {</span>
<span class="nc" id="L30015">                    Entity newCarried = game.getEntity(idMap.get(carriedId));</span>
<span class="nc bnc" id="L30016" title="All 2 branches missed.">                    if (carrier.canLoad(newCarried, false)) {</span>
<span class="nc" id="L30017">                        carrier.load(newCarried, false, bay);</span>
<span class="nc" id="L30018">                        newCarried.setTransportId(carrier.getId());</span>
                        // Remember that the carried unit should not be treated again below
<span class="nc" id="L30020">                        transportCorrected.add(newCarried);</span>
                    }
                }
<span class="nc" id="L30023">            }</span>
<span class="nc" id="L30024">        }</span>

        // Now restore the transport settings from the entities' transporter IDs
        // With anything other than bays, MULs only show the carrier, not the carried units 
<span class="nc bnc" id="L30028" title="All 2 branches missed.">        for (final Entity entity: entities) {</span>
            // Don't correct those that are already corrected
<span class="nc bnc" id="L30030" title="All 2 branches missed.">            if (transportCorrected.contains(entity)) {</span>
<span class="nc" id="L30031">                continue;</span>
            }
            // Get the original (client side) ID of the transporter
<span class="nc" id="L30034">            int origTrsp = entity.getTransportId();</span>
            // Only act if the unit thinks it is transported
<span class="nc bnc" id="L30036" title="All 2 branches missed.">            if (origTrsp != Entity.NONE) {</span>
                // If the transporter is among the new units, go on with loading 
<span class="nc bnc" id="L30038" title="All 2 branches missed.">                if (idMap.containsKey(origTrsp)) {</span>
                    // The wrong transporter doesn't know of anything and does not need an update
<span class="nc" id="L30040">                    Entity carrier = game.getEntity(idMap.get(origTrsp)); </span>
<span class="nc bnc" id="L30041" title="All 2 branches missed.">                    if (carrier.canLoad(entity, false)) {</span>
                        // The correct transporter must be told it's carrying something and
                        // the carried unit must be told where it is embarked
<span class="nc" id="L30044">                        carrier.load(entity, false);</span>
<span class="nc" id="L30045">                        entity.setTransportId(idMap.get(origTrsp));</span>
                    } else {
                        // This seems to be an invalid carrier; update the entity accordingly
<span class="nc" id="L30048">                        entity.setTransportId(Entity.NONE);</span>
                    }
<span class="nc" id="L30050">                } else {</span>
                    // this transporter does not exist; update the entity accordingly
<span class="nc" id="L30052">                    entity.setTransportId(Entity.NONE);</span>
                }
            }
<span class="nc" id="L30055">        }</span>
        
        // Set the &quot;loaded keepers&quot; which is apparently used for deployment unloading to
        // differentiate between units loaded in the lobby and other carried units
        // When entering a game from the lobby, this list is generated again, but not when 
        // the added entities are loaded during a game. When getting loaded units from a MUL,
        // act as if they were loaded in the lobby.
<span class="nc bnc" id="L30062" title="All 2 branches missed.">        for (final Entity entity: entities) {</span>
<span class="nc bnc" id="L30063" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L30064">                Vector&lt;Integer&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L30065" title="All 2 branches missed.">                for (Entity en : entity.getLoadedUnits()) {</span>
<span class="nc" id="L30066">                    v.add(en.getId());</span>
<span class="nc" id="L30067">                }</span>
<span class="nc" id="L30068">                entity.setLoadedKeepers(v);</span>
            }
<span class="nc" id="L30070">        }</span>

<span class="nc" id="L30072">        send(createAddEntityPacket(entityIds));</span>
<span class="nc" id="L30073">    }</span>

    /**
     * adds a squadron to the game
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveSquadronAdd(Packet c, int connIndex) {

<span class="nc" id="L30083">        final FighterSquadron fs = (FighterSquadron) c.getObject(0);</span>
<span class="nc" id="L30084">        final Vector&lt;Integer&gt; fighters = (Vector&lt;Integer&gt;) c.getObject(1);</span>
<span class="nc bnc" id="L30085" title="All 2 branches missed.">        if (fighters.size() &lt; 1) {</span>
<span class="nc" id="L30086">            return;</span>
        }
        // fs.setOwner(fighters.firstElement().getOwner());
        // Only assign an entity ID when the client hasn't.
<span class="nc bnc" id="L30090" title="All 2 branches missed.">        if (Entity.NONE == fs.getId()) {</span>
<span class="nc" id="L30091">            fs.setId(getFreeEntityId());</span>
        }
<span class="nc" id="L30093">        game.addEntity(fs);</span>
<span class="nc bnc" id="L30094" title="All 2 branches missed.">        for (int id : fighters) {</span>
<span class="nc" id="L30095">            Entity fighter = game.getEntity(id);</span>
<span class="nc bnc" id="L30096" title="All 2 branches missed.">            if (null != fighter) {</span>
<span class="nc" id="L30097">                fs.load(fighter, false);</span>
<span class="nc" id="L30098">                fs.autoSetMaxBombPoints();</span>
<span class="nc" id="L30099">                fighter.setTransportId(fs.getId());</span>
                // If this is the lounge, we want to configure bombs
<span class="nc bnc" id="L30101" title="All 2 branches missed.">                if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30102">                    ((IBomber)fighter).setBombChoices(fs.getBombChoices());</span>
                }
<span class="nc" id="L30104">                entityUpdate(fighter.getId());</span>
            }
<span class="nc" id="L30106">        }</span>
<span class="nc" id="L30107">        send(createAddEntityPacket(fs.getId()));</span>

<span class="nc" id="L30109">    }</span>

    /**
     * Updates an entity with the info from the client. Only valid to do this
     * during the lounge phase, except for heat sink changing.
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityUpdate(Packet c, int connIndex) {
<span class="nc" id="L30118">        Entity entity = (Entity) c.getObject(0);</span>
<span class="nc" id="L30119">        Entity oldEntity = game.getEntity(entity.getId());</span>
<span class="nc bnc" id="L30120" title="All 2 branches missed.">        if ((oldEntity != null)</span>
<span class="nc bnc" id="L30121" title="All 2 branches missed.">                &amp;&amp; ((oldEntity.getOwner() == getPlayer(connIndex)) || (oldEntity</span>
<span class="nc bnc" id="L30122" title="All 2 branches missed.">                        .getOwner().getTeam() == getPlayer(connIndex).getTeam()))) {</span>
<span class="nc" id="L30123">            game.setEntity(entity.getId(), entity);</span>
<span class="nc" id="L30124">            entityUpdate(entity.getId());</span>
            // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30126" title="All 2 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30127">                StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L30128" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) {</span>
<span class="nc" id="L30129">                    message.append(&quot;A Unit &quot;);</span>
<span class="nc" id="L30130">                    message.append('(').append(entity.getOwner().getName()).append(')');</span>
<span class="nc bnc" id="L30131" title="All 2 branches missed.">                } else if (game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP)) {</span>
<span class="nc" id="L30132">                    message.append(&quot;Unit &quot;);</span>
<span class="nc bnc" id="L30133" title="All 2 branches missed.">                    if (!entity.getExternalIdAsString().equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L30134">                        message.append('[')</span>
<span class="nc" id="L30135">                               .append(entity.getExternalIdAsString())</span>
<span class="nc" id="L30136">                               .append(&quot;] &quot;);</span>
                    }
<span class="nc" id="L30138">                    message.append(entity.getId()).append(&quot; (&quot;)</span>
<span class="nc" id="L30139">                           .append(entity.getOwner().getName()).append(')');</span>
                } else {
<span class="nc" id="L30141">                    message.append(&quot;Unit &quot;);</span>
<span class="nc" id="L30142">                    message.append(entity.getDisplayName());</span>
                }
<span class="nc" id="L30144">                message.append(&quot; has been customized.&quot;);</span>
<span class="nc" id="L30145">                sendServerChat(message.toString());</span>
            }
        }
<span class="nc" id="L30148">    }</span>

    /**
     * loads an entity into another one. Meant to be called from the chat lounge
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityLoad(Packet c, int connIndex) {
<span class="nc" id="L30156">        int loadeeId = (Integer) c.getObject(0);</span>
<span class="nc" id="L30157">        int loaderId = (Integer) c.getObject(1);</span>
<span class="nc" id="L30158">        int bayNumber = (Integer) c.getObject(2);</span>
<span class="nc" id="L30159">        Entity loadee = game.getEntity(loadeeId);</span>
<span class="nc" id="L30160">        Entity loader = game.getEntity(loaderId);</span>

<span class="nc bnc" id="L30162" title="All 4 branches missed.">        if ((loadee != null) &amp;&amp; (loader != null)) {</span>
<span class="nc" id="L30163">            loadUnit(loader, loadee, bayNumber);</span>
            // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30165" title="All 2 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
                /*
                 * StringBuffer message = new StringBuffer();
                 * message.append(&quot;Unit &quot;); if
                 * (game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) ||
                 * game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) { if
                 * (!entity.getExternalIdAsString().equals(&quot;-1&quot;)) {
                 * message.append('[') .append(entity.getExternalIdAsString())
                 * .append(&quot;] &quot;); } message.append(entity.getId()).append('(')
                 * .append(entity.getOwner().getName()).append(')'); } else {
                 * message.append(entity.getDisplayName()); }
                 * message.append(&quot; has been customized.&quot;);
                 * sendServerChat(message.toString());
                 */
                // Set this so units can be unloaded in the first movement phase
<span class="nc" id="L30180">                loadee.setLoadedThisTurn(false);</span>
            }
        }
<span class="nc" id="L30183">    }</span>

    /**
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveCustomInit(Packet c, int connIndex) {
        // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30192" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30193">            IPlayer p = (IPlayer) c.getObject(0);</span>
<span class="nc" id="L30194">            sendServerChat(&quot;&quot; + p.getName() + &quot; has customized initiative.&quot;);</span>
        }
<span class="nc" id="L30196">    }</span>

    /**
     * receive and process an entity mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityModeChange(Packet c, int connIndex) {
<span class="nc" id="L30205">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30206">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30207">        int mode = c.getIntValue(2);</span>
<span class="nc" id="L30208">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30209" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30210">            return;</span>
        }
<span class="nc" id="L30212">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30214" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30215">            return;</span>
        }

        try {
            // Check for BA dumping body mounted missile launchers
<span class="nc bnc" id="L30220" title="All 4 branches missed.">            if ((e instanceof BattleArmor) &amp;&amp; (!m.isMissing())</span>
<span class="nc bnc" id="L30221" title="All 2 branches missed.">                    &amp;&amp; m.isBodyMounted()</span>
<span class="nc bnc" id="L30222" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L30223" title="All 2 branches missed.">                    &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L30224" title="All 4 branches missed.">                    &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)</span>
                    &amp;&amp; (mode &lt;= 0)) {
<span class="nc bnc" id="L30226" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
            // a mode change for ammo means dumping or hot loading
<span class="nc bnc" id="L30228" title="All 2 branches missed.">            } else if ((m.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L30229" title="All 6 branches missed.">                &amp;&amp; !m.getType().hasInstantModeSwitch() &amp;&amp; (mode &lt; 0</span>
<span class="nc bnc" id="L30230" title="All 2 branches missed.">                            || mode == 0 &amp;&amp; m.isPendingDump())) {</span>
<span class="nc bnc" id="L30231" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
<span class="nc bnc" id="L30232" title="All 6 branches missed.">            } else if ((m.getType() instanceof WeaponType) &amp;&amp; m.isDWPMounted()</span>
                       &amp;&amp; (mode &lt;= 0)) {
<span class="nc bnc" id="L30234" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
            } else {
<span class="nc bnc" id="L30236" title="All 2 branches missed.">                if (!m.setMode(mode)) {</span>
<span class="nc" id="L30237">                    String message = e.getShortName() + &quot;: &quot; + m.getName() + &quot;: &quot; + e.getLocationName(m.getLocation())</span>
                            + &quot; trying to compensate&quot;;
<span class="nc" id="L30239">                    MegaMek.getLogger().error(message);</span>
<span class="nc" id="L30240">                    sendServerChat(message);</span>
<span class="nc" id="L30241">                    e.setGameOptions();</span>

<span class="nc bnc" id="L30243" title="All 2 branches missed.">                    if (!m.setMode(mode)) {</span>
<span class="nc" id="L30244">                        message = e.getShortName() + &quot;: &quot; + m.getName() + &quot;: &quot; + e.getLocationName(m.getLocation())</span>
                                + &quot; unable to compensate&quot;;
<span class="nc" id="L30246">                        MegaMek.getLogger().error(message);</span>
<span class="nc" id="L30247">                        sendServerChat(message);</span>
                    }

                }
            }
<span class="nc" id="L30252">        } catch (Exception ex) {</span>
<span class="nc" id="L30253">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L30254">        }</span>

<span class="nc" id="L30256">    }</span>

    /**
     * Receive and process an Entity Sensor Change Packet
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySensorChange(Packet c, int connIndex) {
<span class="nc" id="L30264">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30265">        int sensorId = c.getIntValue(1);</span>
<span class="nc" id="L30266">        Entity e = game.getEntity(entityId);</span>
<span class="nc" id="L30267">        e.setNextSensor(e.getSensors().elementAt(sensorId));</span>
<span class="nc" id="L30268">    }</span>

    /**
     * Receive and process an Entity Heat Sinks Change Packet
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySinksChange(Packet c, int connIndex) {
<span class="nc" id="L30276">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30277">        int numSinks = c.getIntValue(1);</span>
<span class="nc" id="L30278">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30279" title="All 4 branches missed.">        if ((e instanceof Mech) &amp;&amp; (connIndex == e.getOwnerId())) {</span>
<span class="nc" id="L30280">            ((Mech)e).setActiveSinksNextRound(numSinks);</span>
        }
<span class="nc" id="L30282">    }</span>

    /**
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityActivateHidden(Packet c, int connIndex) {
<span class="nc" id="L30290">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30291">        IGame.Phase phase = (IGame.Phase)c.getObject(1);</span>
<span class="nc" id="L30292">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30293" title="All 2 branches missed.">        if (connIndex != e.getOwnerId()) {</span>
<span class="nc" id="L30294">            MegaMek.getLogger().error(&quot;Player &quot; + connIndex </span>
<span class="nc" id="L30295">                    + &quot; tried to activate a hidden unit owned by Player &quot; + e.getOwnerId());</span>
<span class="nc" id="L30296">            return;</span>
        }
<span class="nc" id="L30298">        e.setHiddeActivationPhase(phase);</span>
<span class="nc" id="L30299">        entityUpdate(entityId);</span>
<span class="nc" id="L30300">    }</span>


    /**
     * receive and process an entity nova network mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityNovaNetworkModeChange(Packet c, int connIndex) {

        try {
<span class="nc" id="L30312">            int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30313">            String networkID = c.getObject(1).toString();</span>
<span class="nc" id="L30314">            Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30315" title="All 2 branches missed.">            if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30316">                return;</span>
            }
            // FIXME: Greg: This can result in setting the network to link to
            // hostile units.
            // However, it should be caught by both the isMemberOfNetwork test
            // from the c3 module as well as
            // by the clients possible input.
<span class="nc" id="L30323">            e.setNewRoundNovaNetworkString(networkID);</span>
<span class="nc" id="L30324">        } catch (Exception ex) {</span>
<span class="nc" id="L30325">            ex.printStackTrace();</span>
<span class="nc" id="L30326">        }</span>

<span class="nc" id="L30328">    }</span>

    /**
     * receive and process an entity mounted facing change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityMountedFacingChange(Packet c, int connIndex) {
<span class="nc" id="L30337">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30338">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30339">        int facing = c.getIntValue(2);</span>
<span class="nc" id="L30340">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30341" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30342">            return;</span>
        }
<span class="nc" id="L30344">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30346" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30347">            return;</span>
        }
<span class="nc" id="L30349">        m.setFacing(facing);</span>
<span class="nc" id="L30350">    }</span>

    /**
     * receive and process an entity mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityCalledShotChange(Packet c, int connIndex) {
<span class="nc" id="L30359">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30360">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30361">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30362" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30363">            return;</span>
        }
<span class="nc" id="L30365">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30367" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30368">            return;</span>
        }
<span class="nc" id="L30370">        m.getCalledShot().switchCalledShot();</span>
<span class="nc" id="L30371">    }</span>

    /**
     * receive and process an entity system mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySystemModeChange(Packet c, int connIndex) {
<span class="nc" id="L30380">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30381">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30382">        int mode = c.getIntValue(2);</span>
<span class="nc" id="L30383">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30384" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30385">            return;</span>
        }
<span class="nc bnc" id="L30387" title="All 4 branches missed.">        if ((e instanceof Mech) &amp;&amp; (equipId == Mech.SYSTEM_COCKPIT)) {</span>
<span class="nc" id="L30388">            ((Mech) e).setCockpitStatus(mode);</span>
        }
<span class="nc" id="L30390">    }</span>

    /**
     * Receive a packet that contains an Entity ammo change
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityAmmoChange(Packet c, int connIndex) {
<span class="nc" id="L30399">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30400">        int weaponId = c.getIntValue(1);</span>
<span class="nc" id="L30401">        int ammoId = c.getIntValue(2);</span>
<span class="nc" id="L30402">        Entity e = game.getEntity(entityId);</span>

        // Did we receive a request for a valid Entity?
<span class="nc bnc" id="L30405" title="All 2 branches missed.">        if (null == e) {</span>
<span class="nc" id="L30406">            MegaMek.getLogger().error(&quot;Could not find entity# &quot; + entityId);</span>
<span class="nc" id="L30407">            return;</span>
        }
<span class="nc" id="L30409">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30410" title="All 4 branches missed.">        if ((null != player) &amp;&amp; (e.getOwner() != player)) {</span>
<span class="nc" id="L30411">            MegaMek.getLogger().error(&quot;Player &quot; + player.getName() + &quot; does not own the entity &quot; + e.getDisplayName());</span>
<span class="nc" id="L30412">            return;</span>
        }

        // Make sure that the entity has the given equipment.
<span class="nc" id="L30416">        Mounted mWeap = e.getEquipment(weaponId);</span>
<span class="nc" id="L30417">        Mounted mAmmo = e.getEquipment(ammoId);</span>
<span class="nc bnc" id="L30418" title="All 2 branches missed.">        if (null == mAmmo) {</span>
<span class="nc" id="L30419">            MegaMek.getLogger().error(&quot;Entity &quot; + e.getDisplayName() + &quot; does not have ammo #&quot; + ammoId);</span>
<span class="nc" id="L30420">            return;</span>
        }
<span class="nc bnc" id="L30422" title="All 2 branches missed.">        if (!(mAmmo.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L30423">            MegaMek.getLogger().error(&quot;Item #&quot; + ammoId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30424">                    + &quot; is a &quot; + mAmmo.getName() + &quot; and not ammo.&quot;);</span>
<span class="nc" id="L30425">            return;</span>
        }
<span class="nc bnc" id="L30427" title="All 2 branches missed.">        if (null == mWeap) {</span>
<span class="nc" id="L30428">            MegaMek.getLogger().error(&quot;Entity &quot; + e.getDisplayName() + &quot; does not have weapon #&quot; + weaponId);</span>
<span class="nc" id="L30429">            return;</span>
        }
<span class="nc bnc" id="L30431" title="All 2 branches missed.">        if (!(mWeap.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L30432">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30433">                    + &quot; is a &quot; + mWeap.getName() + &quot; and not a weapon.&quot;);</span>
<span class="nc" id="L30434">            return;</span>
        }
<span class="nc bnc" id="L30436" title="All 2 branches missed.">        if (((WeaponType) mWeap.getType()).getAmmoType() == AmmoType.T_NA) {</span>
<span class="nc" id="L30437">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30438">                    + &quot; is a &quot; + mWeap.getName() + &quot; and does not use ammo.&quot;);</span>
<span class="nc" id="L30439">            return;</span>
        }
<span class="nc bnc" id="L30441" title="All 2 branches missed.">        if (mWeap.getType().hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L30442" title="All 2 branches missed.">                &amp;&amp; !mWeap.getType().hasFlag(WeaponType.F_DOUBLE_ONESHOT)) {</span>
<span class="nc" id="L30443">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30444">                    + &quot; is a &quot; + mWeap.getName() + &quot; and cannot use external ammo.&quot;);</span>
<span class="nc" id="L30445">            return;</span>
        }

        // Load the weapon.
<span class="nc" id="L30449">        e.loadWeapon(mWeap, mAmmo);</span>
<span class="nc" id="L30450">    }</span>

    /**
     * Deletes an entity owned by a certain player from the list
     */
    private void receiveEntityDelete(Packet c, int connIndex) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L30457">        List&lt;Integer&gt; ids = (List&lt;Integer&gt;) c.getObject(0);</span>
<span class="nc bnc" id="L30458" title="All 2 branches missed.">        for (Integer entityId : ids) {</span>
<span class="nc" id="L30459">            final Entity entity = game.getEntity(entityId);</span>

            // Only allow players to delete their *own* entities.
<span class="nc bnc" id="L30462" title="All 4 branches missed.">            if ((entity != null) &amp;&amp; (entity.getOwner() == getPlayer(connIndex))) {</span>

                // If we're deleting a ProtoMech, recalculate unit numbers.
<span class="nc bnc" id="L30465" title="All 2 branches missed.">                if (entity instanceof Protomech) {</span>

                    // How many ProtoMechs does the player have (include this one)?
<span class="nc" id="L30468">                    int numPlayerProtos = game.getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L30469">                        private final int ownerId = entity.getOwnerId();</span>

                        public boolean accept(Entity entity) {
<span class="nc bnc" id="L30472" title="All 4 branches missed.">                            return (entity instanceof Protomech) &amp;&amp; (ownerId == entity.getOwnerId());</span>
                        }
                    });

                    // According to page 54 of the BMRr, ProtoMechs must be
                    // deployed in full Points of five, unless &quot;losses&quot; have
                    // reduced the number to less than that.
<span class="nc" id="L30479">                    final char oldMax = (char) (Math.ceil(numPlayerProtos / 5.0) - 1);</span>
<span class="nc" id="L30480">                    char newMax = (char) (Math.ceil((numPlayerProtos - 1) / 5.0) - 1);</span>
<span class="nc" id="L30481">                    short deletedUnitNum = entity.getUnitNumber();</span>

                    // Do we have to update a ProtoMech from the last unit?
<span class="nc bnc" id="L30484" title="All 4 branches missed.">                    if ((oldMax != deletedUnitNum) &amp;&amp; (oldMax != newMax)) {</span>

                        // Yup. Find a ProtoMech from the last unit, and
                        // set it's unit number to the deleted entity.
<span class="nc" id="L30488">                        Iterator&lt;Entity&gt; lastUnit =</span>
<span class="nc" id="L30489">                                game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L30490">                                    private final int ownerId = entity.getOwnerId();</span>

<span class="nc" id="L30492">                                    private final char lastUnitNum = oldMax;</span>

                                    public boolean accept(Entity entity) {
<span class="nc bnc" id="L30495" title="All 2 branches missed.">                                        return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L30496" title="All 2 branches missed.">                                                &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L30497" title="All 2 branches missed.">                                                &amp;&amp; (lastUnitNum == entity.getUnitNumber());</span>
                                    }
                                });
<span class="nc" id="L30500">                        Entity lastUnitMember = lastUnit.next();</span>
<span class="nc" id="L30501">                        lastUnitMember.setUnitNumber(deletedUnitNum);</span>
<span class="nc" id="L30502">                        entityUpdate(lastUnitMember.getId());</span>
                    } // End update-unit-number
                } // End added-ProtoMech

<span class="nc bnc" id="L30506" title="All 2 branches missed.">                if (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT) {</span>
                    // if a unit is removed during deployment just keep going
                    // without adjusting the turn vector.
<span class="nc" id="L30509">                    game.removeTurnFor(entity);</span>
<span class="nc" id="L30510">                    game.removeEntity(entityId, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
                }
            }
<span class="nc" id="L30513">        }</span>

        // during deployment this absolutely must be called before game.removeEntity(), otherwise the game hangs
        // when a unit is removed. Cause unknown.
<span class="nc" id="L30517">        send(createRemoveEntityPacket(ids, IEntityRemovalConditions.REMOVE_NEVER_JOINED));</span>

        // Prevents deployment hanging. Only do this during deployment.
<span class="nc bnc" id="L30520" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc bnc" id="L30521" title="All 2 branches missed.">            for (Integer entityId : ids) {</span>
<span class="nc" id="L30522">                final Entity entity = game.getEntity(entityId);</span>
<span class="nc" id="L30523">                game.removeEntity(entityId, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
<span class="nc" id="L30524">                endCurrentTurn(entity);</span>
<span class="nc" id="L30525">            }</span>
        }
<span class="nc" id="L30527">    }</span>

    /**
     * Sets a player's ready status
     */
    private void receivePlayerDone(Packet pkt, int connIndex) {
<span class="nc" id="L30533">        boolean ready = pkt.getBooleanValue(0);</span>
<span class="nc" id="L30534">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30535" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L30536">            player.setDone(ready);</span>
        }
<span class="nc" id="L30538">    }</span>

    private void receiveInitiativeRerollRequest(Packet pkt, int connIndex) {
<span class="nc" id="L30541">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30542" title="All 2 branches missed.">        if (IGame.Phase.PHASE_INITIATIVE_REPORT != game.getPhase()) {</span>
<span class="nc" id="L30543">            StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L30544" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L30545">                message.append(&quot;Player #&quot;).append(connIndex);</span>
            } else {
<span class="nc" id="L30547">                message.append(player.getName());</span>
            }
<span class="nc" id="L30549">            message.append(&quot; is not allowed to ask for a reroll at this time.&quot;);</span>
<span class="nc" id="L30550">            MegaMek.getLogger().error(message.toString());</span>
<span class="nc" id="L30551">            sendServerChat(message.toString());</span>
<span class="nc" id="L30552">            return;</span>
        }
<span class="nc bnc" id="L30554" title="All 2 branches missed.">        if (game.hasTacticalGenius(player)) {</span>
<span class="nc" id="L30555">            game.addInitiativeRerollRequest(game.getTeamForPlayer(player));</span>
        }
<span class="nc bnc" id="L30557" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L30558">            player.setDone(true);</span>
        }
<span class="nc" id="L30560">        checkReady();</span>
<span class="nc" id="L30561">    }</span>

    /**
     * Sets game options, providing that the player has specified the password
     * correctly.
     *
     * @return true if any options have been successfully changed.
     */
    private boolean receiveGameOptions(Packet packet, int connId) {
<span class="nc" id="L30570">        IPlayer player = game.getPlayer(connId);</span>
        // Check player
<span class="nc bnc" id="L30572" title="All 2 branches missed.">        if (null == player) {</span>
<span class="nc" id="L30573">            MegaMek.getLogger().error(&quot;Server does not recognize player at connection &quot; + connId);</span>
<span class="nc" id="L30574">            return false;</span>
        }

        // check password
<span class="nc bnc" id="L30578" title="All 6 branches missed.">        if ((password != null) &amp;&amp; (password.length() &gt; 0) &amp;&amp; !password.equals(packet.getObject(0))) {</span>
<span class="nc" id="L30579">            sendServerChat(connId, &quot;The password you specified to change game options is incorrect.&quot;);</span>
<span class="nc" id="L30580">            return false;</span>
        }

<span class="nc bnc" id="L30583" title="All 2 branches missed.">        if (game.getPhase().isDuringOrAfter(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L30584">            return false;</span>
        }

<span class="nc" id="L30587">        int changed = 0;</span>

<span class="nc bnc" id="L30589" title="All 2 branches missed.">        for (Enumeration&lt;?&gt; i = ((Vector&lt;?&gt;) packet.getObject(1)).elements(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30590">            IBasicOption option = (IBasicOption) i.nextElement();</span>
<span class="nc" id="L30591">            IOption originalOption = game.getOptions().getOption(option.getName());</span>

<span class="nc bnc" id="L30593" title="All 2 branches missed.">            if (originalOption == null) {</span>
<span class="nc" id="L30594">                continue;</span>
            }

<span class="nc" id="L30597">            String message = &quot;Player &quot; + player.getName() + &quot; changed option \&quot;&quot; +</span>
<span class="nc" id="L30598">                    originalOption.getDisplayableName() + &quot;\&quot; to &quot; + option.getValue().toString() + '.';</span>
<span class="nc" id="L30599">            sendServerChat(message);</span>
<span class="nc" id="L30600">            originalOption.setValue(option.getValue());</span>
<span class="nc" id="L30601">            changed++;</span>
<span class="nc" id="L30602">        }</span>

        // Set proper RNG
<span class="nc" id="L30605">        Compute.setRNG(game.getOptions().intOption(OptionsConstants.BASE_RNG_TYPE));</span>

<span class="nc bnc" id="L30607" title="All 2 branches missed.">        if (changed &gt; 0) {</span>
<span class="nc bnc" id="L30608" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector()) {</span>
<span class="nc" id="L30609">                en.setGameOptions();</span>
<span class="nc" id="L30610">            }</span>
<span class="nc" id="L30611">            entityAllUpdate();</span>
<span class="nc" id="L30612">            return true;</span>
        }
<span class="nc" id="L30614">        return false;</span>
    }

    /**
     * Performs the additional processing of the received options after the the
     * &lt;code&gt;receiveGameOptions&lt;code&gt; done its job; should be called after
     * &lt;code&gt;receiveGameOptions&lt;code&gt; only if the &lt;code&gt;receiveGameOptions&lt;code&gt;
     * returned &lt;code&gt;true&lt;/code&gt;
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveGameOptionsAux(Packet packet, int connId) {
<span class="nc bnc" id="L30627" title="All 2 branches missed.">        for (Enumeration&lt;?&gt; i = ((Vector&lt;?&gt;) packet.getObject(1)).elements(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30628">            IBasicOption option = (IBasicOption) i.nextElement();</span>
<span class="nc" id="L30629">            IOption originalOption = game.getOptions().getOption(option.getName());</span>
<span class="nc bnc" id="L30630" title="All 2 branches missed.">            if (originalOption != null) {</span>
<span class="nc bnc" id="L30631" title="All 2 branches missed.">                if (&quot;maps_include_subdir&quot;.equals(originalOption.getName())) {</span>
<span class="nc" id="L30632">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L30633">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L30634">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L30635">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L30636">                    send(createMapSettingsPacket());</span>
                }
            }
<span class="nc" id="L30639">        }</span>

<span class="nc" id="L30641">    }</span>

    /**
     * Sends out the game victory event to all connections
     */
    private void transmitGameVictoryEventToAll() {
<span class="nc bnc" id="L30647" title="All 2 branches missed.">        for (IConnection conn : connections) {</span>
<span class="nc" id="L30648">            send(conn.getId(), new Packet(Packet.COMMAND_GAME_VICTORY_EVENT));</span>
<span class="nc" id="L30649">        }</span>
<span class="nc" id="L30650">    }</span>

    /**
     * Sends out all player info to the specified connection
     */
    private void transmitAllPlayerConnects(int connId) {
<span class="nc bnc" id="L30656" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30657">            final IPlayer player = i.nextElement();</span>

<span class="nc" id="L30659">            send(connId, createPlayerConnectPacket(player.getId()));</span>
<span class="nc" id="L30660">        }</span>
<span class="nc" id="L30661">    }</span>

    /**
     * Creates a packet informing that the player has connected
     */
    private Packet createPlayerConnectPacket(int playerId) {
<span class="nc" id="L30667">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30668">        data[0] = playerId;</span>
<span class="nc" id="L30669">        data[1] = getPlayer(playerId);</span>
<span class="nc" id="L30670">        return new Packet(Packet.COMMAND_PLAYER_ADD, data);</span>
    }

    /**
     * Creates a packet containing the player info, for update
     */
    private Packet createPlayerUpdatePacket(int playerId) {
<span class="nc" id="L30677">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30678">        data[0] = playerId;</span>
<span class="nc" id="L30679">        data[1] = getPlayer(playerId);</span>
<span class="nc" id="L30680">        return new Packet(Packet.COMMAND_PLAYER_UPDATE, data);</span>
    }

    /**
     * Sends out the player info updates for all players to all connections
     */
    private void transmitAllPlayerUpdates() {
<span class="nc bnc" id="L30687" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30688">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L30689" title="All 2 branches missed.">            if (null != player) {</span>
<span class="nc" id="L30690">                send(createPlayerUpdatePacket(player.getId()));</span>
            }
<span class="nc" id="L30692">        }</span>
<span class="nc" id="L30693">    }</span>

    /**
     * Sends out the player ready stats for all players to all connections
     */
    private void transmitAllPlayerDones() {
<span class="nc bnc" id="L30699" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30700">            final IPlayer player = i.nextElement();</span>

<span class="nc" id="L30702">            send(createPlayerDonePacket(player.getId()));</span>
<span class="nc" id="L30703">        }</span>
<span class="nc" id="L30704">    }</span>

    /**
     * Creates a packet containing the player ready status
     */
    private Packet createPlayerDonePacket(int playerId) {
<span class="nc" id="L30710">        Object[] data = new Object[2];</span>
<span class="nc" id="L30711">        data[0] = playerId;</span>
<span class="nc" id="L30712">        data[1] = getPlayer(playerId).isDone();</span>
<span class="nc" id="L30713">        return new Packet(Packet.COMMAND_PLAYER_READY, data);</span>
    }

    /**
     * Creates a packet containing the current turn vector
     */
    private Packet createTurnVectorPacket() {
<span class="nc" id="L30720">        return new Packet(Packet.COMMAND_SENDING_TURNS, game.getTurnVector());</span>
    }

    /**
     * Creates a packet containing the current turn index
     */
    private Packet createTurnIndexPacket(int playerId) {
<span class="nc" id="L30727">        final Object[] data = new Object[3];</span>
<span class="nc" id="L30728">        data[0] = game.getTurnIndex();</span>
<span class="nc" id="L30729">        data[1] = playerId;</span>
<span class="nc" id="L30730">        return new Packet(Packet.COMMAND_TURN, data);</span>
    }

    /**
     * Creates a packet containing the map settings
     */
    private Packet createMapSettingsPacket() {
<span class="nc" id="L30737">        return new Packet(Packet.COMMAND_SENDING_MAP_SETTINGS, mapSettings);</span>
    }

    private Packet createMapSizesPacket() {
<span class="nc" id="L30741">        Set&lt;BoardDimensions&gt; sizes = getBoardSizes();</span>
<span class="nc" id="L30742">        return new Packet(Packet.COMMAND_SENDING_AVAILABLE_MAP_SIZES, sizes);</span>
    }

    /**
     * Creates a packet containing the planetary conditions
     */
    private Packet createPlanetaryConditionsPacket() {
<span class="nc" id="L30749">        return new Packet(Packet.COMMAND_SENDING_PLANETARY_CONDITIONS,</span>
<span class="nc" id="L30750">                          game.getPlanetaryConditions());</span>
    }

    /**
     * Creates a packet containing the game settings
     */
    private Packet createGameSettingsPacket() {
<span class="nc" id="L30757">        return new Packet(Packet.COMMAND_SENDING_GAME_SETTINGS, game.getOptions());</span>
    }

    /**
     * Creates a packet containing the game board
     */
    private Packet createBoardPacket() {
<span class="nc" id="L30764">        return new Packet(Packet.COMMAND_SENDING_BOARD, game.getBoard());</span>
    }

    /**
     * Creates a packet containing a single entity, for update
     */
    private Packet createEntityPacket(int entityId, Vector&lt;UnitLocation&gt; movePath) {
<span class="nc" id="L30771">        final Entity entity = game.getEntity(entityId);</span>
<span class="nc" id="L30772">        final Object[] data = new Object[3];</span>
<span class="nc" id="L30773">        data[0] = entityId;</span>
<span class="nc" id="L30774">        data[1] = entity;</span>
<span class="nc" id="L30775">        data[2] = movePath;</span>
<span class="nc" id="L30776">        return new Packet(Packet.COMMAND_ENTITY_UPDATE, data);</span>
    }

    /**
     * Creates a packet containing a Vector of Reports
     */
    private Packet createReportPacket(IPlayer p) {
        // When the final report is created, MM sends a null player to create
        // the
        // report. This will handle that issue.
<span class="nc bnc" id="L30786" title="All 4 branches missed.">        if ((p == null) || !doBlind()) {</span>
<span class="nc" id="L30787">            return new Packet(Packet.COMMAND_SENDING_REPORTS, vPhaseReport);</span>
        }
<span class="nc" id="L30789">        return new Packet(Packet.COMMAND_SENDING_REPORTS, filterReportVector(vPhaseReport, p));</span>
    }

    /**
     * Creates a packet containing a Vector of special Reports which needs to be
     * sent during a phase that is not a report phase.
     */
    private Packet createSpecialReportPacket() {
<span class="nc" id="L30797">        return new Packet(Packet.COMMAND_SENDING_REPORTS_SPECIAL, vPhaseReport.clone());</span>
    }

    /**
     * Creates a packet containing a Vector of Reports that represent a Tactical
     * Genius re-roll request which needs to update a current phase's report.
     */
    private Packet createTacticalGeniusReportPacket() {
<span class="nc" id="L30805">        return new Packet(Packet.COMMAND_SENDING_REPORTS_TACTICAL_GENIUS, vPhaseReport.clone());</span>
    }

    /**
     * Creates a packet containing all the round reports
     */
    private Packet createAllReportsPacket(IPlayer p) {
<span class="nc" id="L30812">        return new Packet(Packet.COMMAND_SENDING_REPORTS_ALL,</span>
<span class="nc" id="L30813">                filterPastReports(game.getAllReports(), p));</span>
    }

    /**
     * Creates a packet containing all current entities
     */
    private Packet createEntitiesPacket() {
<span class="nc" id="L30820">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, game.getEntitiesVector());</span>
    }

    /**
     * Creates a packet containing all current and out-of-game entities
     */
    private Packet createFullEntitiesPacket() {
<span class="nc" id="L30827">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30828">        data[0] = game.getEntitiesVector();</span>
<span class="nc" id="L30829">        data[1] = game.getOutOfGameEntitiesVector();</span>
<span class="nc" id="L30830">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, data);</span>
    }

    /**
     * Creates a packet containing all entities visible to the player in a blind
     * game
     */
    private Packet createFilteredEntitiesPacket(IPlayer p, Map&lt;EntityTargetPair,
            LosEffects&gt; losCache) {
<span class="nc" id="L30839">        return new Packet(Packet.COMMAND_SENDING_ENTITIES,</span>
<span class="nc" id="L30840">                filterEntities(p, game.getEntitiesVector(), losCache));</span>
    }

    /**
     * Creates a packet containing all entities, including wrecks, visible to
     * the player in a blind game
     */
    private Packet createFilteredFullEntitiesPacket(IPlayer p) {
<span class="nc" id="L30848">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30849">        data[0] = filterEntities(p, game.getEntitiesVector(), null);</span>
<span class="nc" id="L30850">        data[1] = game.getOutOfGameEntitiesVector();</span>
<span class="nc" id="L30851">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, data);</span>
    }

    private Packet createAddEntityPacket(int entityId) {
<span class="nc" id="L30855">        ArrayList&lt;Integer&gt; entityIds = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L30856">        entityIds.add(entityId);</span>
<span class="nc" id="L30857">        return createAddEntityPacket(entityIds);</span>
    }

    /**
     * Creates a packet detailing the addition of an entity
     */
    private Packet createAddEntityPacket(List&lt;Integer&gt; entityIds) {
<span class="nc" id="L30864">        ArrayList&lt;Entity&gt; entities = new ArrayList&lt;&gt;(entityIds.size());</span>
<span class="nc bnc" id="L30865" title="All 2 branches missed.">        for (Integer id : entityIds) {</span>
<span class="nc" id="L30866">            entities.add(game.getEntity(id));</span>
<span class="nc" id="L30867">        }</span>
<span class="nc" id="L30868">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30869">        data[0] = entityIds;</span>
<span class="nc" id="L30870">        data[1] = entities;</span>
<span class="nc" id="L30871">        return new Packet(Packet.COMMAND_ENTITY_ADD, data);</span>
    }

    /**
     * Creates a packet detailing the removal of an entity. Maintained for
     * backwards compatibility.
     *
     * @param entityId - the &lt;code&gt;int&lt;/code&gt; ID of the entity being removed.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(int entityId) {
<span class="nc" id="L30882">        return createRemoveEntityPacket(entityId, IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
    }

    /**
     * Creates a packet detailing the removal of an entity.
     *
     * @param entityId  - the &lt;code&gt;int&lt;/code&gt; ID of the entity being removed.
     * @param condition - the &lt;code&gt;int&lt;/code&gt; condition the unit was in. This value
     *                  must be one of constants in
     *                  &lt;code&gt;IEntityRemovalConditions&lt;/code&gt;, or an
     *                  &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(int entityId, int condition) {
<span class="nc" id="L30896">        List&lt;Integer&gt; ids = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L30897">        ids.add(entityId);</span>
<span class="nc" id="L30898">        return createRemoveEntityPacket(ids, condition);</span>
    }

    /**
     * Creates a packet detailing the removal of a list of entities.
     *
     * @param entityIds - the &lt;code&gt;int&lt;/code&gt; ID of each entity being removed.
     * @param condition - the &lt;code&gt;int&lt;/code&gt; condition the units were in. This value
     *                  must be one of constants in
     *                  &lt;code&gt;IEntityRemovalConditions&lt;/code&gt;, or an
     *                  &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(List&lt;Integer&gt; entityIds, int condition) {
<span class="nc bnc" id="L30912" title="All 16 branches missed.">        if ((condition != IEntityRemovalConditions.REMOVE_UNKNOWN)</span>
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_IN_RETREAT)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_PUSHED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_SALVAGEABLE)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_EJECTED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_CAPTURED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_DEVASTATED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_NEVER_JOINED)) {
<span class="nc" id="L30920">            throw new IllegalArgumentException(&quot;Unknown unit condition: &quot; + condition);</span>
        }
<span class="nc" id="L30922">        Object[] array = new Object[2];</span>
<span class="nc" id="L30923">        array[0] = entityIds;</span>
<span class="nc" id="L30924">        array[1] = condition;</span>
<span class="nc" id="L30925">        return new Packet(Packet.COMMAND_ENTITY_REMOVE, array);</span>
    }

    /**
     * Creates a packet indicating end of game, including detailed unit status
     */
    private Packet createEndOfGamePacket() {
<span class="nc" id="L30932">        Object[] array = new Object[3];</span>
<span class="nc" id="L30933">        array[0] = getDetailedVictoryReport();</span>
<span class="nc" id="L30934">        array[1] = game.getVictoryPlayerId();</span>
<span class="nc" id="L30935">        array[2] = game.getVictoryTeam();</span>
<span class="nc" id="L30936">        return new Packet(Packet.COMMAND_END_OF_GAME, array);</span>
    }

<span class="fc" id="L30939">    public static String ORIGIN = &quot;***Server&quot;;</span>

    public static String formatChatMessage(String origin, String message) {
<span class="fc" id="L30942">        return origin + &quot;: &quot; + message;</span>
    }

    /**
     * Transmits a chat message to all players
     */
    public void sendChat(int connId, String origin, String message) {
<span class="nc" id="L30949">        send(connId, new Packet(Packet.COMMAND_CHAT, formatChatMessage(origin, message)));</span>
<span class="nc" id="L30950">    }</span>

    /**
     * Transmits a chat message to all players
     */
    private void sendChat(String origin, String message) {
<span class="nc" id="L30956">        String chat = formatChatMessage(origin, message);</span>
<span class="nc" id="L30957">        send(new Packet(Packet.COMMAND_CHAT, chat));</span>
<span class="nc" id="L30958">    }</span>

    public void sendServerChat(int connId, String message) {
<span class="nc" id="L30961">        sendChat(connId, ORIGIN, message);</span>
<span class="nc" id="L30962">    }</span>

    public void sendServerChat(String message) {
<span class="nc" id="L30965">        sendChat(ORIGIN, message);</span>
<span class="nc" id="L30966">    }</span>

    /**
     * Creates a packet containing a hex, and the coordinates it goes at.
     */
    private Packet createHexChangePacket(Coords coords, IHex hex) {
<span class="nc" id="L30972">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30973">        data[0] = coords;</span>
<span class="nc" id="L30974">        data[1] = hex;</span>
<span class="nc" id="L30975">        return new Packet(Packet.COMMAND_CHANGE_HEX, data);</span>
    }

    public void sendSmokeCloudAdded(SmokeCloud cloud) {
<span class="nc" id="L30979">        final Object[] data = new Object[1];</span>
<span class="nc" id="L30980">        data[0] = cloud;</span>
<span class="nc" id="L30981">        send(new Packet(Packet.COMMAND_ADD_SMOKE_CLOUD, data));</span>
<span class="nc" id="L30982">    }</span>

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedHex(Coords coords) {
<span class="nc" id="L30988">        send(createHexChangePacket(coords, game.getBoard().getHex(coords)));</span>
<span class="nc" id="L30989">    }</span>

    /**
     * Creates a packet containing a hex, and the coordinates it goes at.
     */
    private Packet createHexesChangePacket(Set&lt;Coords&gt; coords, Set&lt;IHex&gt; hex) {
<span class="nc" id="L30995">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30996">        data[0] = coords;</span>
<span class="nc" id="L30997">        data[1] = hex;</span>
<span class="nc" id="L30998">        return new Packet(Packet.COMMAND_CHANGE_HEXES, data);</span>
    }

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedHexes(Set&lt;Coords&gt; coords) {
<span class="nc" id="L31005">        Set&lt;IHex&gt; hexes = new LinkedHashSet&lt;&gt;();</span>
<span class="nc bnc" id="L31006" title="All 2 branches missed.">        for (Coords coord : coords) {</span>
<span class="nc" id="L31007">            hexes.add(game.getBoard().getHex(coord));</span>
<span class="nc" id="L31008">        }</span>
<span class="nc" id="L31009">        send(createHexesChangePacket(coords, hexes));</span>
<span class="nc" id="L31010">    }</span>

    /**
     * Creates a packet containing a vector of mines.
     */
    private Packet createMineChangePacket(Coords coords) {
<span class="nc" id="L31016">        return new Packet(Packet.COMMAND_UPDATE_MINEFIELDS, game.getMinefields(coords));</span>
    }

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedMines(Coords coords) {
<span class="nc" id="L31023">        send(createMineChangePacket(coords));</span>
<span class="nc" id="L31024">    }</span>

    public void sendVisibilityIndicator(Entity e) {
<span class="nc" id="L31027">        final Object[] data = new Object[6];</span>
<span class="nc" id="L31028">        data[0] = e.getId();</span>
<span class="nc" id="L31029">        data[1] = e.isEverSeenByEnemy();</span>
<span class="nc" id="L31030">        data[2] = e.isVisibleToEnemy();</span>
<span class="nc" id="L31031">        data[3] = e.isDetectedByEnemy();</span>
<span class="nc" id="L31032">        data[4] = e.getWhoCanSee();</span>
<span class="nc" id="L31033">        data[5] = e.getWhoCanDetect();</span>
<span class="nc" id="L31034">        send(new Packet(Packet.COMMAND_ENTITY_VISIBILITY_INDICATOR, data));</span>
<span class="nc" id="L31035">    }</span>

    /**
     * Creates a packet for an attack
     */
    private Packet createAttackPacket(List&lt;?&gt; vector, int charges) {
<span class="nc" id="L31041">        final Object[] data = new Object[2];</span>
<span class="nc" id="L31042">        data[0] = vector;</span>
<span class="nc" id="L31043">        data[1] = charges;</span>
<span class="nc" id="L31044">        return new Packet(Packet.COMMAND_ENTITY_ATTACK, data);</span>
    }

    /**
     * Creates a packet for an attack
     */
    private Packet createAttackPacket(EntityAction ea, int charge) {
<span class="nc" id="L31051">        Vector&lt;EntityAction&gt; vector = new Vector&lt;&gt;(1);</span>
<span class="nc" id="L31052">        vector.addElement(ea);</span>
<span class="nc" id="L31053">        Object[] data = new Object[2];</span>
<span class="nc" id="L31054">        data[0] = vector;</span>
<span class="nc" id="L31055">        data[1] = charge;</span>
<span class="nc" id="L31056">        return new Packet(Packet.COMMAND_ENTITY_ATTACK, data);</span>
    }

    /**
     *
     */
    private Packet createSpecialHexDisplayPacket(int toPlayer) {
<span class="nc" id="L31063">        Hashtable&lt;Coords, Collection&lt;SpecialHexDisplay&gt;&gt; shdTable = game</span>
<span class="nc" id="L31064">                .getBoard().getSpecialHexDisplayTable();</span>
<span class="nc" id="L31065">        Hashtable&lt;Coords, Collection&lt;SpecialHexDisplay&gt;&gt; shdTable2 = new Hashtable&lt;&gt;();</span>
        LinkedList&lt;SpecialHexDisplay&gt; tempList;
<span class="nc" id="L31067">        IPlayer player = getPlayer(toPlayer);</span>
<span class="nc bnc" id="L31068" title="All 2 branches missed.">        if (player != null) {</span>
<span class="nc bnc" id="L31069" title="All 2 branches missed.">            for (Coords coord : shdTable.keySet()) {</span>
<span class="nc" id="L31070">                tempList = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L31071" title="All 2 branches missed.">                for (SpecialHexDisplay shd : shdTable.get(coord)) {</span>
<span class="nc bnc" id="L31072" title="All 2 branches missed.">                    if (!shd.isObscured(player)) {</span>
<span class="nc" id="L31073">                        tempList.add(0, shd);</span>
                    }
<span class="nc" id="L31075">                }</span>
<span class="nc bnc" id="L31076" title="All 2 branches missed.">                if (!tempList.isEmpty()) {</span>
<span class="nc" id="L31077">                    shdTable2.put(coord, tempList);</span>
                }
<span class="nc" id="L31079">            }</span>
        }
<span class="nc" id="L31081">        return new Packet(Packet.COMMAND_SENDING_SPECIAL_HEX_DISPLAY, shdTable2);</span>
    }

    private Packet createTagInfoUpdatesPacket() {
<span class="nc" id="L31085">        return new Packet(Packet.COMMAND_SENDING_TAGINFO, game.getTagInfo());</span>
    }

    /**
     * Creates a packet containing off board artillery attacks
     */
    private Packet createArtilleryPacket(IPlayer p) {
<span class="nc" id="L31092">        Vector&lt;ArtilleryAttackAction&gt; v = new Vector&lt;&gt;();</span>
<span class="nc" id="L31093">        int team = p.getTeam();</span>
<span class="nc bnc" id="L31094" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; i = game.getAttacks(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L31095">            WeaponHandler wh = (WeaponHandler) i.nextElement();</span>
<span class="nc bnc" id="L31096" title="All 2 branches missed.">            if (wh.waa instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L31097">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc bnc" id="L31098" title="All 4 branches missed.">                if ((aaa.getPlayerId() == p.getId())</span>
                        || ((team != IPlayer.TEAM_NONE)
<span class="nc bnc" id="L31100" title="All 2 branches missed.">                        &amp;&amp; (team == game.getPlayer(aaa.getPlayerId()).getTeam()))</span>
<span class="nc bnc" id="L31101" title="All 2 branches missed.">                        || p.getSeeAll()) {</span>
<span class="nc" id="L31102">                    v.addElement(aaa);</span>
                }
            }
<span class="nc" id="L31105">        }</span>
<span class="nc" id="L31106">        return new Packet(Packet.COMMAND_SENDING_ARTILLERYATTACKS, v);</span>
    }

    private Packet createIlluminatedHexesPacket() {
<span class="nc" id="L31110">        HashSet&lt;Coords&gt; illuminateHexes = game.getIlluminatedPositions();</span>
<span class="nc" id="L31111">        return new Packet(Packet.COMMAND_SENDING_ILLUM_HEXES, illuminateHexes);</span>
    }

    /**
     * Creates a packet containing flares
     */
    private Packet createFlarePacket() {

<span class="nc" id="L31119">        return new Packet(Packet.COMMAND_SENDING_FLARES, game.getFlares());</span>
    }

    /**
     * Send a packet to all connected clients.
     */
    private void send(Packet packet) {
<span class="nc bnc" id="L31126" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L31127">            return;</span>
        }
<span class="nc bnc" id="L31129" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L31130">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L31131">            conn.send(packet);</span>
<span class="nc" id="L31132">        }</span>
<span class="nc" id="L31133">    }</span>

    // WOR
    public void send_Nova_Change(int Id, String net) {
<span class="nc" id="L31137">        Object[] data = {Id, net};</span>
<span class="nc" id="L31138">        Packet packet = new Packet(Packet.COMMAND_ENTITY_NOVA_NETWORK_CHANGE, data);</span>
<span class="nc" id="L31139">        send(packet);</span>
<span class="nc" id="L31140">    }</span>

    private void sendReport() {
<span class="nc" id="L31143">        sendReport(false);</span>
<span class="nc" id="L31144">    }</span>

    /**
     * Send the round report to all connected clients.
     */
    private void sendReport(boolean tacticalGeniusReport) {
<span class="nc bnc" id="L31150" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L31151">            return;</span>
        }

<span class="nc bnc" id="L31154" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L31155">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L31156">            IPlayer p = game.getPlayer(conn.getId());</span>
            Packet packet;
<span class="nc bnc" id="L31158" title="All 2 branches missed.">            if (tacticalGeniusReport) {</span>
<span class="nc" id="L31159">                packet = createTacticalGeniusReportPacket();</span>
            } else {
<span class="nc" id="L31161">                packet = createReportPacket(p);</span>
            }
<span class="nc" id="L31163">            conn.send(packet);</span>
<span class="nc" id="L31164">        }</span>
<span class="nc" id="L31165">    }</span>

    /**
     * Send a packet to a specific connection.
     */
    public void send(int connId, Packet packet) {
<span class="nc bnc" id="L31171" title="All 2 branches missed.">        if (getClient(connId) != null) {</span>
<span class="nc" id="L31172">            getClient(connId).send(packet);</span>
        }
        // What should we do if we've lost this client?
        // For now, nothing.
<span class="nc" id="L31176">    }</span>

    /**
     * Send a packet to a pending connection
     */
    private void sendToPending(int connId, Packet packet) {
<span class="nc" id="L31182">        IConnection pendingConn = getPendingConnection(connId);</span>
<span class="nc bnc" id="L31183" title="All 2 branches missed.">        if (pendingConn != null) {</span>
<span class="nc" id="L31184">            pendingConn.send(packet);</span>
        }
        // What should we do if we've lost this client?
        // For now, nothing.
<span class="nc" id="L31188">    }</span>

    /**
     * Process an in-game command
     */
    private void processCommand(int connId, String commandString) {
        String[] args;
        String commandName;
        // all tokens are read as strings; if they're numbers, string-ize 'em.
        // replaced the tokenizer with the split function.
<span class="nc" id="L31198">        args = commandString.split(&quot;\\s+&quot;);</span>

        // figure out which command this is
<span class="nc" id="L31201">        commandName = args[0].substring(1);</span>

        // process it
<span class="nc" id="L31204">        ServerCommand command = getCommand(commandName);</span>
<span class="nc bnc" id="L31205" title="All 2 branches missed.">        if (command != null) {</span>
<span class="nc" id="L31206">            command.run(connId, args);</span>
        } else {
<span class="nc" id="L31208">            sendServerChat(connId,</span>
                    &quot;Command not recognized.  Type /help for a list of commands.&quot;);
        }
<span class="nc" id="L31211">    }</span>

    // Easter eggs. Happy April Fool's Day!!
    private static final String DUNE_CALL = &quot;They tried and failed?&quot;;

    private static final String DUNE_RESPONSE = &quot;They tried and died!&quot;;

    private static final String STAR_WARS_CALL = &quot;I'd just as soon kiss a Wookiee.&quot;;

    private static final String STAR_WARS_RESPONSE = &quot;I can arrange that!&quot;;

    private static final String INVADER_ZIM_CALL = &quot;What does the G stand for?&quot;;

    private static final String INVADER_ZIM_RESPONSE = &quot;I don't know.&quot;;

    private static final String WARGAMES_CALL = &quot;Shall we play a game?&quot;;

    private static final String WARGAMES_RESPONSE = &quot;Let's play global thermonuclear war.&quot;;

    /**
     * Process a packet from a connection.
     *
     * @param connId
     *            - the &lt;code&gt;int&lt;/code&gt; ID the connection that received the
     *            packet.
     * @param packet
     *            - the &lt;code&gt;Packet&lt;/code&gt; to be processed.
     */
    protected void handle(int connId, Packet packet) {
<span class="nc" id="L31240">        IPlayer player = game.getPlayer(connId);</span>
        // Check player. Please note, the connection may be pending.
<span class="nc bnc" id="L31242" title="All 4 branches missed.">        if ((null == player) &amp;&amp; (null == getPendingConnection(connId))) {</span>
<span class="nc" id="L31243">            MegaMek.getLogger().error(&quot;Server does not recognize player at connection &quot; + connId);</span>
<span class="nc" id="L31244">            return;</span>
        }

<span class="nc bnc" id="L31247" title="All 2 branches missed.">        if (packet == null) {</span>
<span class="nc" id="L31248">            MegaMek.getLogger().error(&quot;Got null packet&quot;);</span>
<span class="nc" id="L31249">            return;</span>
        }
        // act on it
<span class="nc bnc" id="L31252" title="All 42 branches missed.">        switch (packet.getCommand()) {</span>
            case Packet.COMMAND_CLIENT_VERSIONS:
<span class="nc" id="L31254">                receivePlayerVersion(packet, connId);</span>
<span class="nc" id="L31255">                break;</span>
            case Packet.COMMAND_CLOSE_CONNECTION:
                // We have a client going down!
<span class="nc" id="L31258">                IConnection c = getConnection(connId);</span>
<span class="nc bnc" id="L31259" title="All 2 branches missed.">                if (c != null) {</span>
<span class="nc" id="L31260">                    c.close();</span>
                }
                break;
            case Packet.COMMAND_CLIENT_NAME:
<span class="nc" id="L31264">                receivePlayerName(packet, connId);</span>
<span class="nc" id="L31265">                break;</span>
            case Packet.COMMAND_PLAYER_UPDATE:
<span class="nc" id="L31267">                receivePlayerInfo(packet, connId);</span>
<span class="nc" id="L31268">                validatePlayerInfo(connId);</span>
<span class="nc" id="L31269">                send(createPlayerUpdatePacket(connId));</span>
<span class="nc" id="L31270">                break;</span>
            case Packet.COMMAND_PLAYER_READY:
<span class="nc" id="L31272">                receivePlayerDone(packet, connId);</span>
<span class="nc" id="L31273">                send(createPlayerDonePacket(connId));</span>
<span class="nc" id="L31274">                checkReady();</span>
<span class="nc" id="L31275">                break;</span>
            case Packet.COMMAND_REROLL_INITIATIVE:
<span class="nc" id="L31277">                receiveInitiativeRerollRequest(packet, connId);</span>
                // send(createPlayerDonePacket(connId));
<span class="nc" id="L31279">                break;</span>
            case Packet.COMMAND_FORWARD_INITIATIVE:
<span class="nc" id="L31281">                receiveForwardIni(connId);</span>
<span class="nc" id="L31282">                break;</span>
            case Packet.COMMAND_CHAT:
<span class="nc" id="L31284">                String chat = (String) packet.getObject(0);</span>
<span class="nc bnc" id="L31285" title="All 2 branches missed.">                if (chat.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L31286">                    processCommand(connId, chat);</span>
<span class="nc bnc" id="L31287" title="All 2 branches missed.">                } else if (packet.getData().length &gt; 1) {</span>
<span class="nc" id="L31288">                    connId = (int) packet.getObject(1);</span>
<span class="nc bnc" id="L31289" title="All 2 branches missed.">                    if (connId == IPlayer.PLAYER_NONE) {</span>
<span class="nc" id="L31290">                        sendServerChat(chat);</span>
                    } else {
<span class="nc" id="L31292">                        sendServerChat(connId, chat);</span>
                    }
                } else {
<span class="nc" id="L31295">                    sendChat(player.getName(), chat);</span>
                }
                // Easter eggs. Happy April Fool's Day!!
<span class="nc bnc" id="L31298" title="All 2 branches missed.">                if (DUNE_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31299">                    sendServerChat(DUNE_RESPONSE);</span>
<span class="nc bnc" id="L31300" title="All 2 branches missed.">                } else if (STAR_WARS_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31301">                    sendServerChat(STAR_WARS_RESPONSE);</span>
<span class="nc bnc" id="L31302" title="All 2 branches missed.">                } else if (INVADER_ZIM_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31303">                    sendServerChat(INVADER_ZIM_RESPONSE);</span>
<span class="nc bnc" id="L31304" title="All 2 branches missed.">                } else if (WARGAMES_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31305">                    sendServerChat(WARGAMES_RESPONSE);</span>
                }
                break;
            case Packet.COMMAND_BLDG_EXPLODE:
<span class="nc" id="L31309">                DemolitionCharge charge = (DemolitionCharge)packet.getData()[0];</span>
<span class="nc bnc" id="L31310" title="All 2 branches missed.">                if (charge.playerId == connId) {</span>
<span class="nc bnc" id="L31311" title="All 2 branches missed.">                    if (!explodingCharges.contains(charge)) {</span>
<span class="nc" id="L31312">                        explodingCharges.add(charge);</span>
<span class="nc" id="L31313">                        IPlayer p = game.getPlayer(connId);</span>
<span class="nc" id="L31314">                        sendServerChat(p.getName() + &quot; has touched off explosives &quot;</span>
                                + &quot;(handled in end phase)!&quot;);
<span class="nc" id="L31316">                    }</span>
                }
                break;
            case Packet.COMMAND_ENTITY_MOVE:
<span class="nc" id="L31320">                receiveMovement(packet, connId);</span>
<span class="nc" id="L31321">                break;</span>
            case Packet.COMMAND_ENTITY_DEPLOY:
<span class="nc" id="L31323">                receiveDeployment(packet, connId);</span>
<span class="nc" id="L31324">                break;</span>
            case Packet.COMMAND_ENTITY_DEPLOY_UNLOAD:
<span class="nc" id="L31326">                receiveDeploymentUnload(packet, connId);</span>
<span class="nc" id="L31327">                break;</span>
            case Packet.COMMAND_DEPLOY_MINEFIELDS:
<span class="nc" id="L31329">                receiveDeployMinefields(packet, connId);</span>
<span class="nc" id="L31330">                break;</span>
            case Packet.COMMAND_ENTITY_ATTACK:
<span class="nc" id="L31332">                receiveAttack(packet, connId);</span>
<span class="nc" id="L31333">                break;</span>
            case Packet.COMMAND_ENTITY_GTA_HEX_SELECT:
<span class="nc" id="L31335">                receiveGroundToAirHexSelectPacket(packet, connId);</span>
<span class="nc" id="L31336">                break;</span>
            case Packet.COMMAND_ENTITY_ADD:
<span class="nc" id="L31338">                receiveEntityAdd(packet, connId);</span>
<span class="nc" id="L31339">                resetPlayersDone();</span>
<span class="nc" id="L31340">                break;</span>
            case Packet.COMMAND_ENTITY_UPDATE:
<span class="nc" id="L31342">                receiveEntityUpdate(packet, connId);</span>
<span class="nc" id="L31343">                resetPlayersDone();</span>
<span class="nc" id="L31344">                break;</span>
            case Packet.COMMAND_ENTITY_LOAD:
<span class="nc" id="L31346">                receiveEntityLoad(packet, connId);</span>
<span class="nc" id="L31347">                resetPlayersDone();</span>
<span class="nc" id="L31348">                transmitAllPlayerDones();</span>
<span class="nc" id="L31349">                break;</span>
            case Packet.COMMAND_ENTITY_MODECHANGE:
<span class="nc" id="L31351">                receiveEntityModeChange(packet, connId);</span>
<span class="nc" id="L31352">                break;</span>
            case Packet.COMMAND_ENTITY_SENSORCHANGE:
<span class="nc" id="L31354">                receiveEntitySensorChange(packet, connId);</span>
<span class="nc" id="L31355">                break;</span>
            case Packet.COMMAND_ENTITY_SINKSCHANGE:
<span class="nc" id="L31357">                receiveEntitySinksChange(packet, connId);</span>
<span class="nc" id="L31358">                break;</span>
            case Packet.COMMAND_ENTITY_ACTIVATE_HIDDEN:
<span class="nc" id="L31360">                receiveEntityActivateHidden(packet, connId);</span>
<span class="nc" id="L31361">                break;</span>
            case Packet.COMMAND_ENTITY_NOVA_NETWORK_CHANGE:
<span class="nc" id="L31363">                receiveEntityNovaNetworkModeChange(packet, connId);</span>
<span class="nc" id="L31364">                break;</span>
            case Packet.COMMAND_ENTITY_MOUNTED_FACINGCHANGE:
<span class="nc" id="L31366">                receiveEntityMountedFacingChange(packet, connId);</span>
<span class="nc" id="L31367">                break;</span>
            case Packet.COMMAND_ENTITY_CALLEDSHOTCHANGE:
<span class="nc" id="L31369">                receiveEntityCalledShotChange(packet, connId);</span>
<span class="nc" id="L31370">                break;</span>
            case Packet.COMMAND_ENTITY_SYSTEMMODECHANGE:
<span class="nc" id="L31372">                receiveEntitySystemModeChange(packet, connId);</span>
<span class="nc" id="L31373">                break;</span>
            case Packet.COMMAND_ENTITY_AMMOCHANGE:
<span class="nc" id="L31375">                receiveEntityAmmoChange(packet, connId);</span>
<span class="nc" id="L31376">                break;</span>
            case Packet.COMMAND_ENTITY_REMOVE:
<span class="nc" id="L31378">                receiveEntityDelete(packet, connId);</span>
<span class="nc" id="L31379">                resetPlayersDone();</span>
<span class="nc" id="L31380">                break;</span>
            case Packet.COMMAND_ENTITY_WORDER_UPDATE:
<span class="nc" id="L31382">                Object[] data = packet.getData();</span>
<span class="nc" id="L31383">                Entity ent = game.getEntity((Integer) data[0]);</span>
<span class="nc bnc" id="L31384" title="All 2 branches missed.">                if (ent != null) {</span>
<span class="nc" id="L31385">                    Entity.WeaponSortOrder order = (Entity.WeaponSortOrder) data[1];</span>
<span class="nc" id="L31386">                    ent.setWeaponSortOrder(order);</span>
                    // Used by the client but is set in setWeaponSortOrder
<span class="nc" id="L31388">                    ent.setWeapOrderChanged(false);</span>
<span class="nc bnc" id="L31389" title="All 2 branches missed.">                    if (order == Entity.WeaponSortOrder.CUSTOM) {</span>
                        @SuppressWarnings(&quot;unchecked&quot;)
                        // Unchecked cause of limitations in Java when casting
                        // to a collection
<span class="nc" id="L31393">                        Map&lt;Integer, Integer&gt; customWeaponOrder = (Map&lt;Integer, Integer&gt;) data[2];</span>
<span class="nc" id="L31394">                        ent.setCustomWeaponOrder(customWeaponOrder);</span>
                    }
<span class="nc" id="L31396">                }</span>
                break;
            case Packet.COMMAND_SENDING_GAME_SETTINGS:
<span class="nc bnc" id="L31399" title="All 2 branches missed.">                if (receiveGameOptions(packet, connId)) {</span>
<span class="nc" id="L31400">                    resetPlayersDone();</span>
<span class="nc" id="L31401">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31402">                    send(createGameSettingsPacket());</span>
<span class="nc" id="L31403">                    receiveGameOptionsAux(packet, connId);</span>
                }
                break;
            case Packet.COMMAND_SENDING_MAP_SETTINGS:
<span class="nc bnc" id="L31407" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31408">                    MapSettings newSettings = (MapSettings) packet.getObject(0);</span>
<span class="nc bnc" id="L31409" title="All 2 branches missed.">                    if (!mapSettings.equalMapGenParameters(newSettings)) {</span>
<span class="nc" id="L31410">                        sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed map settings&quot;);</span>
                    }
<span class="nc" id="L31412">                    mapSettings = newSettings;</span>
<span class="nc" id="L31413">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L31414">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L31415">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L31416">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L31417">                    mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L31418">                    mapSettings.removeUnavailable();</span>
                    // if still only nulls left, use BOARD_GENERATED
<span class="nc bnc" id="L31420" title="All 2 branches missed.">                    if (mapSettings.getBoardsSelected().next() == null) {</span>
<span class="nc" id="L31421">                        mapSettings.setNullBoards((MapSettings.BOARD_GENERATED));</span>
                    }
<span class="nc" id="L31423">                    resetPlayersDone();</span>
<span class="nc" id="L31424">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31425">                    send(createMapSettingsPacket());</span>
<span class="nc" id="L31426">                }</span>
                break;
            case Packet.COMMAND_SENDING_MAP_DIMENSIONS:
<span class="nc bnc" id="L31429" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31430">                    MapSettings newSettings = (MapSettings) packet.getObject(0);</span>
<span class="nc bnc" id="L31431" title="All 2 branches missed.">                    if (!mapSettings.equalMapGenParameters(newSettings)) {</span>
<span class="nc" id="L31432">                        sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed map dimensions&quot;);</span>
                    }
<span class="nc" id="L31434">                    mapSettings = newSettings;</span>
<span class="nc" id="L31435">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L31436">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L31437">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L31438">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L31439">                    mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L31440">                    mapSettings.removeUnavailable();</span>
                    // if still only nulls left, use BOARD_GENERATED
<span class="nc bnc" id="L31442" title="All 2 branches missed.">                    if (mapSettings.getBoardsSelected().next() == null) {</span>
<span class="nc" id="L31443">                        mapSettings.setNullBoards((MapSettings.BOARD_GENERATED));</span>
                    }
<span class="nc" id="L31445">                    resetPlayersDone();</span>
<span class="nc" id="L31446">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31447">                    send(createMapSettingsPacket());</span>
<span class="nc" id="L31448">                }</span>
                break;
            case Packet.COMMAND_SENDING_PLANETARY_CONDITIONS:
                // MapSettings newSettings = (MapSettings) packet.getObject(0);
<span class="nc bnc" id="L31452" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31453">                    PlanetaryConditions conditions = (PlanetaryConditions) packet.getObject(0);</span>
<span class="nc" id="L31454">                    sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed planetary conditions&quot;);</span>
<span class="nc" id="L31455">                    game.setPlanetaryConditions(conditions);</span>
<span class="nc" id="L31456">                    resetPlayersDone();</span>
<span class="nc" id="L31457">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31458">                    send(createPlanetaryConditionsPacket());</span>
<span class="nc" id="L31459">                }</span>
                break;
            case Packet.COMMAND_UNLOAD_STRANDED:
<span class="nc" id="L31462">                receiveUnloadStranded(packet, connId);</span>
<span class="nc" id="L31463">                break;</span>
            case Packet.COMMAND_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L31465">                receiveArtyAutoHitHexes(packet, connId);</span>
<span class="nc" id="L31466">                break;</span>
            case Packet.COMMAND_CUSTOM_INITIATIVE:
<span class="nc" id="L31468">                receiveCustomInit(packet, connId);</span>
<span class="nc" id="L31469">                resetPlayersDone();</span>
<span class="nc" id="L31470">                transmitAllPlayerDones();</span>
<span class="nc" id="L31471">                break;</span>
            case Packet.COMMAND_LOAD_GAME:
                try {
<span class="nc" id="L31474">                    sendServerChat(getPlayer(connId).getName() + &quot; loaded a new game.&quot;);</span>
<span class="nc" id="L31475">                    setGame((IGame) packet.getObject(0));</span>
<span class="nc bnc" id="L31476" title="All 2 branches missed.">                    for (IConnection conn : connections) {</span>
<span class="nc" id="L31477">                        sendCurrentInfo(conn.getId());</span>
<span class="nc" id="L31478">                    }</span>
<span class="nc" id="L31479">                } catch (Exception e) {</span>
<span class="nc" id="L31480">                    MegaMek.getLogger().error(&quot;Error loading save game sent from client&quot;, e);</span>
<span class="nc" id="L31481">                }</span>
<span class="nc" id="L31482">                break;</span>
            case Packet.COMMAND_SQUADRON_ADD:
<span class="nc" id="L31484">                receiveSquadronAdd(packet, connId);</span>
<span class="nc" id="L31485">                resetPlayersDone();</span>
<span class="nc" id="L31486">                transmitAllPlayerDones();</span>
<span class="nc" id="L31487">                break;</span>
            case Packet.COMMAND_RESET_ROUND_DEPLOYMENT:
<span class="nc" id="L31489">                game.setupRoundDeployment();</span>
<span class="nc" id="L31490">                break;</span>
            case Packet.COMMAND_SPECIAL_HEX_DISPLAY_DELETE:
<span class="nc" id="L31492">                game.getBoard().removeSpecialHexDisplay((Coords) packet.getObject(0),</span>
<span class="nc" id="L31493">                        (SpecialHexDisplay) packet.getObject(1));</span>
<span class="nc" id="L31494">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L31495">                break;</span>
            case Packet.COMMAND_SPECIAL_HEX_DISPLAY_APPEND:
<span class="nc" id="L31497">                game.getBoard().addSpecialHexDisplay((Coords) packet.getObject(0),</span>
<span class="nc" id="L31498">                        (SpecialHexDisplay) packet.getObject(1));</span>
<span class="nc" id="L31499">                sendSpecialHexDisplayPackets();</span>
                break;
        }
<span class="nc" id="L31502">    }</span>

    /**
     * Listen for incoming clients.
     */
    public void run() {
<span class="nc" id="L31508">        Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L31509">        MegaMek.getLogger().info(&quot;s: listening for clients...&quot;);</span>
<span class="nc bnc" id="L31510" title="All 2 branches missed.">        while (connector == currentThread) {</span>
            try {
<span class="nc" id="L31512">                Socket s = serverSocket.accept();</span>
<span class="nc" id="L31513">                synchronized (serverLock) {</span>
<span class="nc" id="L31514">                    int id = getFreeConnectionId();</span>
<span class="nc" id="L31515">                    MegaMek.getLogger().info(&quot;s: accepting player connection #&quot; + id + &quot;...&quot;);</span>

<span class="nc" id="L31517">                    IConnection c = ConnectionFactory.getInstance().createServerConnection(s, id);</span>
<span class="nc" id="L31518">                    c.addConnectionListener(connectionListener);</span>
<span class="nc" id="L31519">                    c.open();</span>
<span class="nc" id="L31520">                    connectionsPending.addElement(c);</span>
<span class="nc" id="L31521">                    ConnectionHandler ch = new ConnectionHandler(c);</span>
<span class="nc" id="L31522">                    Thread newConnThread = new Thread(ch, &quot;Connection &quot; + id);</span>
<span class="nc" id="L31523">                    newConnThread.start();</span>
<span class="nc" id="L31524">                    connectionHandlers.put(id, ch);</span>

<span class="nc" id="L31526">                    greeting(id);</span>
<span class="nc" id="L31527">                    ConnectionWatchdog w = new ConnectionWatchdog(this, id);</span>
<span class="nc" id="L31528">                    watchdogTimer.schedule(w, 1000, 500);</span>
<span class="nc" id="L31529">                }</span>
<span class="nc" id="L31530">            } catch (InterruptedIOException ignored) {</span>
                // ignore , just SOTimeout blowing..
<span class="nc" id="L31532">            } catch (IOException ignored) { }</span>
        }
<span class="nc" id="L31534">    }</span>

    /**
     * Makes one slot of inferno ammo, determined by certain rules, explode on a
     * mech.
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; that should suffer an inferno ammo
     *            explosion.
     */
    private Vector&lt;Report&gt; explodeInfernoAmmoFromHeat(Entity entity) {
<span class="nc" id="L31545">        int damage = 0;</span>
<span class="nc" id="L31546">        int rack = 0;</span>
<span class="nc" id="L31547">        int boomloc = -1;</span>
<span class="nc" id="L31548">        int boomslot = -1;</span>
<span class="nc" id="L31549">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // Find the most destructive Inferno ammo.
<span class="nc bnc" id="L31553" title="All 2 branches missed.">        for (int j = 0; j &lt; entity.locations(); j++) {</span>
<span class="nc bnc" id="L31554" title="All 2 branches missed.">            for (int k = 0; k &lt; entity.getNumberOfCriticals(j); k++) {</span>
<span class="nc" id="L31555">                CriticalSlot cs = entity.getCritical(j, k);</span>
                // Ignore empty, destroyed, hit, and structure slots.
<span class="nc bnc" id="L31557" title="All 6 branches missed.">                if ((cs == null) || cs.isDestroyed() || cs.isHit()</span>
<span class="nc bnc" id="L31558" title="All 2 branches missed.">                        || (cs.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L31559">                    continue;</span>
                }
                // Ignore everything but ammo or LAM bomb bay slots.
<span class="nc" id="L31562">                Mounted mounted = cs.getMount();</span>
                int newRack;
                int newDamage;
<span class="nc bnc" id="L31565" title="All 2 branches missed.">                if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc" id="L31566">                    AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L31567" title="All 2 branches missed.">                    if (!atype.isExplosive(mounted)</span>
<span class="nc bnc" id="L31568" title="All 2 branches missed.">                            || ((atype.getMunitionType() != AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L31569" title="All 2 branches missed.">                            &amp;&amp; (atype.getMunitionType() != AmmoType.M_IATM_IIW))) {</span>
<span class="nc" id="L31570">                        continue;</span>
                    }
                    // ignore empty, destroyed, or missing bins
<span class="nc bnc" id="L31573" title="All 2 branches missed.">                    if (mounted.getHittableShotsLeft() == 0) {</span>
<span class="nc" id="L31574">                        continue;</span>
                    }
                    // Find the most destructive undamaged ammo.
                    // TW page 160, compare one rack's
                    // damage. Ties go to most rounds.
<span class="nc" id="L31579">                    newRack = atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L31580">                    newDamage = mounted.getExplosionDamage();</span>
<span class="nc" id="L31581">                    Mounted mount2 = cs.getMount2();</span>
<span class="nc bnc" id="L31582" title="All 4 branches missed.">                    if ((mount2 != null) &amp;&amp; (mount2.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L31583" title="All 2 branches missed.">                            &amp;&amp; (mount2.getHittableShotsLeft() &gt; 0)) {</span>
                        // must be for same weaponType, so rackSize stays
<span class="nc" id="L31585">                        atype = (AmmoType) mount2.getType();</span>
<span class="nc" id="L31586">                        newRack += atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L31587">                        newDamage += mount2.getExplosionDamage();</span>
                    }
<span class="nc bnc" id="L31589" title="All 2 branches missed.">                } else if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L31590" title="All 2 branches missed.">                        &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc bnc" id="L31591" title="All 2 branches missed.">                    while (mounted.getLinked() != null) {</span>
<span class="nc" id="L31592">                        mounted = mounted.getLinked();</span>
                    }
<span class="nc bnc" id="L31594" title="All 2 branches missed.">                    if (mounted.getExplosionDamage() == 0) {</span>
<span class="nc" id="L31595">                        continue;</span>
                    }
<span class="nc" id="L31597">                    newRack = 1;</span>
<span class="nc" id="L31598">                    newDamage = mounted.getExplosionDamage();</span>
                } else {
                    continue;
                }

<span class="nc bnc" id="L31603" title="All 8 branches missed.">                if (!mounted.isHit()</span>
                        &amp;&amp; ((rack &lt; newRack) || ((rack == newRack) &amp;&amp; (damage &lt; newDamage)))) {
<span class="nc" id="L31605">                    rack = newRack;</span>
<span class="nc" id="L31606">                    damage = newDamage;</span>
<span class="nc" id="L31607">                    boomloc = j;</span>
<span class="nc" id="L31608">                    boomslot = k;</span>
                }
            }
        }
        // Did we find anything to explode?
<span class="nc bnc" id="L31613" title="All 4 branches missed.">        if ((boomloc != -1) &amp;&amp; (boomslot != -1)) {</span>
<span class="nc" id="L31614">            CriticalSlot slot = entity.getCritical(boomloc, boomslot);</span>
<span class="nc" id="L31615">            slot.setHit(true);</span>
<span class="nc" id="L31616">            Mounted equip = slot.getMount();</span>
<span class="nc" id="L31617">            equip.setHit(true);</span>
            // We've allocated heatBuildup to heat in resolveHeat(),
            // so need to add to the entity's heat instead.
<span class="nc bnc" id="L31620" title="All 2 branches missed.">            if ((equip.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L31621" title="All 2 branches missed.">                    || (equip.getLinked() != null</span>
<span class="nc bnc" id="L31622" title="All 2 branches missed.">                        &amp;&amp; equip.getLinked().getType() instanceof BombType</span>
<span class="nc bnc" id="L31623" title="All 2 branches missed.">                        &amp;&amp; ((BombType)equip.getLinked().getType()).getBombType() == BombType.B_INFERNO)) {</span>
<span class="nc" id="L31624">                entity.heat += Math.min(equip.getExplosionDamage(), 30);</span>
            }
<span class="nc" id="L31626">            vDesc.addAll(explodeEquipment(entity, boomloc, boomslot));</span>
<span class="nc" id="L31627">            r = new Report(5155);</span>
<span class="nc" id="L31628">            r.indent();</span>
<span class="nc" id="L31629">            r.subject = entity.getId();</span>
<span class="nc" id="L31630">            r.add(entity.heat);</span>
<span class="nc" id="L31631">            vDesc.addElement(r);</span>
<span class="nc" id="L31632">            entity.heatBuildup = 0;</span>
<span class="nc" id="L31633">        } else { // no ammo to explode</span>
<span class="nc" id="L31634">            r = new Report(5160);</span>
<span class="nc" id="L31635">            r.indent();</span>
<span class="nc" id="L31636">            r.subject = entity.getId();</span>
<span class="nc" id="L31637">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L31639">        return vDesc;</span>
    }

    /**
     * checks for unintended explosion of heavy industrial zone hex and applies
     * damage to entities occupying the hex
     */
    public void checkExplodeIndustrialZone(Coords c, Vector&lt;Report&gt; vDesc) {
        Report r;
<span class="nc" id="L31648">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L31649" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L31650">            return;</span>
        }

<span class="nc bnc" id="L31653" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.INDUSTRIAL)) {</span>
<span class="nc" id="L31654">            return;</span>
        }

<span class="nc" id="L31657">        r = new Report(3590, Report.PUBLIC);</span>
<span class="nc" id="L31658">        r.add(c.getBoardNum());</span>
<span class="nc" id="L31659">        r.indent(2);</span>
<span class="nc" id="L31660">        int effect = Compute.d6(2);</span>
<span class="nc" id="L31661">        r.add(8);</span>
<span class="nc" id="L31662">        r.add(effect);</span>
<span class="nc bnc" id="L31663" title="All 2 branches missed.">        if (effect &gt; 7) {</span>
<span class="nc" id="L31664">            r.choose(true);</span>
<span class="nc" id="L31665">            r.newlines = 0;</span>
<span class="nc" id="L31666">            vDesc.add(r);</span>
<span class="nc" id="L31667">            boolean onFire = false;</span>
<span class="nc" id="L31668">            boolean powerLine = false;</span>
<span class="nc" id="L31669">            boolean minorExp = false;</span>
<span class="nc" id="L31670">            boolean elecExp = false;</span>
<span class="nc" id="L31671">            boolean majorExp = false;</span>
<span class="nc bnc" id="L31672" title="All 2 branches missed.">            if (effect == 8) {</span>
<span class="nc" id="L31673">                onFire = true;</span>
<span class="nc" id="L31674">                r = new Report(3600, Report.PUBLIC);</span>
<span class="nc" id="L31675">                r.newlines = 0;</span>
<span class="nc" id="L31676">                vDesc.add(r);</span>
<span class="nc bnc" id="L31677" title="All 2 branches missed.">            } else if (effect == 9) {</span>
<span class="nc" id="L31678">                powerLine = true;</span>
<span class="nc" id="L31679">                r = new Report(3605, Report.PUBLIC);</span>
<span class="nc" id="L31680">                r.newlines = 0;</span>
<span class="nc" id="L31681">                vDesc.add(r);</span>
<span class="nc bnc" id="L31682" title="All 2 branches missed.">            } else if (effect == 10) {</span>
<span class="nc" id="L31683">                minorExp = true;</span>
<span class="nc" id="L31684">                onFire = true;</span>
<span class="nc" id="L31685">                r = new Report(3610, Report.PUBLIC);</span>
<span class="nc" id="L31686">                r.newlines = 0;</span>
<span class="nc" id="L31687">                vDesc.add(r);</span>
<span class="nc bnc" id="L31688" title="All 2 branches missed.">            } else if (effect == 11) {</span>
<span class="nc" id="L31689">                elecExp = true;</span>
<span class="nc" id="L31690">                r = new Report(3615, Report.PUBLIC);</span>
<span class="nc" id="L31691">                r.newlines = 0;</span>
<span class="nc" id="L31692">                vDesc.add(r);</span>
            } else {
<span class="nc" id="L31694">                onFire = true;</span>
<span class="nc" id="L31695">                majorExp = true;</span>
<span class="nc" id="L31696">                r = new Report(3620, Report.PUBLIC);</span>
<span class="nc" id="L31697">                r.newlines = 0;</span>
<span class="nc" id="L31698">                vDesc.add(r);</span>
            }
            // apply damage here
<span class="nc bnc" id="L31701" title="All 8 branches missed.">            if (powerLine || minorExp || elecExp || majorExp) {</span>
                // cycle through the entities in the hex and apply damage
<span class="nc bnc" id="L31703" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(c)) {</span>
<span class="nc" id="L31704">                    int damage = 3;</span>
<span class="nc bnc" id="L31705" title="All 2 branches missed.">                    if (minorExp) {</span>
<span class="nc" id="L31706">                        damage = 5;</span>
                    }
<span class="nc bnc" id="L31708" title="All 2 branches missed.">                    if (elecExp) {</span>
<span class="nc" id="L31709">                        damage = Compute.d6(1) + 3;</span>
                    }
<span class="nc bnc" id="L31711" title="All 2 branches missed.">                    if (majorExp) {</span>
<span class="nc" id="L31712">                        damage = Compute.d6(2);</span>
                    }
<span class="nc" id="L31714">                    HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L31715" title="All 2 branches missed.">                    if (en instanceof BattleArmor) {</span>
                        // ugly - I have to apply damage to each trooper
                        // separately
<span class="nc bnc" id="L31718" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; en.locations(); loc++) {</span>
<span class="nc bnc" id="L31719" title="All 2 branches missed.">                            if ((IArmorState.ARMOR_NA != en.getInternal(loc))</span>
<span class="nc bnc" id="L31720" title="All 2 branches missed.">                                    &amp;&amp; (IArmorState.ARMOR_DESTROYED != en.getInternal(loc))</span>
<span class="nc bnc" id="L31721" title="All 2 branches missed.">                                    &amp;&amp; (IArmorState.ARMOR_DOOMED != en.getInternal(loc))) {</span>
<span class="nc" id="L31722">                                vDesc.addAll(damageEntity(en, new HitData(loc), damage));</span>
                            }
                        }
                    } else {
<span class="nc" id="L31726">                        vDesc.addAll(damageEntity(en, hit, damage));</span>
                    }
<span class="nc bnc" id="L31728" title="All 2 branches missed.">                    if (majorExp) {</span>
                        // lets pretend that the infernos came from the entity
                        // itself (should give us side_front)
<span class="nc" id="L31731">                        vDesc.addAll(deliverInfernoMissiles(en, en, Compute.d6(2)));</span>
                    }
<span class="nc" id="L31733">                }</span>
            }
<span class="nc" id="L31735">            Report.addNewline(vDesc);</span>
<span class="nc bnc" id="L31736" title="All 4 branches missed.">            if (onFire &amp;&amp; !hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L31737">                ignite(c, Terrains.FIRE_LVL_NORMAL, vDesc);</span>
            }
<span class="nc" id="L31739">        } else {</span>
            // report no explosion
<span class="nc" id="L31741">            r.choose(false);</span>
<span class="nc" id="L31742">            vDesc.add(r);</span>
        }
<span class="nc" id="L31744">    }</span>

    /**
     * Determine the results of an entity moving through a wall of a building
     * after having moved a certain distance. This gets called when a Mech or a
     * Tank enters a building, leaves a building, or travels from one hex to
     * another inside a multi-hex building.
     *
     * @param entity
     *            - the &lt;code&gt;Entity&lt;/code&gt; that passed through a wall. Don't
     *            pass &lt;code&gt;Infantry&lt;/code&gt; units to this method.
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; the entity is passing through.
     * @param lastPos
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex the entity is exiting.
     * @param curPos
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex the entity is entering
     * @param distance
     *            - the &lt;code&gt;int&lt;/code&gt; number of hexes the entity has moved
     *            already this phase.
     * @param why
     *            - the &lt;code&gt;String&lt;/code&gt; explanation for this action.
     * @param backwards
     *            - the &lt;code&gt;boolean&lt;/code&gt; indicating if the entity is
     *            entering the hex backwards
     * @param entering
     *            - a &lt;code&gt;boolean&lt;/code&gt; if the entity is entering or exiting
     *            a building
     */
    private void passBuildingWall(Entity entity, Building bldg, Coords lastPos, Coords curPos,
                                  int distance, String why, boolean backwards,
                                  EntityMovementType overallMoveType, boolean entering) {
        Report r;

<span class="nc bnc" id="L31778" title="All 2 branches missed.">        if (entity instanceof Protomech) {</span>
<span class="nc" id="L31779">            Vector&lt;Report&gt; vBuildingReport = damageBuilding(bldg, 1, curPos);</span>
<span class="nc bnc" id="L31780" title="All 2 branches missed.">            for (Report report : vBuildingReport) {</span>
<span class="nc" id="L31781">                report.subject = entity.getId();</span>
<span class="nc" id="L31782">            }</span>
<span class="nc" id="L31783">            addReport(vBuildingReport);</span>
<span class="nc" id="L31784">        } else {</span>
            // Need to roll based on building type.
<span class="nc" id="L31786">            PilotingRollData psr = entity.rollMovementInBuilding(bldg, distance, why, overallMoveType);</span>

            // Did the entity make the roll?
<span class="nc bnc" id="L31789" title="All 2 branches missed.">            if (0 &lt; doSkillCheckWhileMoving(entity, entity.getElevation(), lastPos, curPos, psr, false)) {</span>

                // Divide the building's current CF by 10, round up.
<span class="nc" id="L31792">                int damage = (int) Math.floor(bldg.getDamageFromScale()</span>
<span class="nc bnc" id="L31793" title="All 2 branches missed.">                        * Math.ceil(bldg.getCurrentCF(entering ? curPos : lastPos) / 10.0));</span>

                // Infantry and Battle armor take different amounts of damage
                // then Meks and vehicles.
<span class="nc bnc" id="L31797" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc" id="L31798">                    damage = bldg.getType() + 1;</span>
                }
                // It is possible that the unit takes no damage.
<span class="nc bnc" id="L31801" title="All 2 branches missed.">                if (damage == 0) {</span>
<span class="nc" id="L31802">                    r = new Report(6440);</span>
<span class="nc" id="L31803">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L31804">                    r.subject = entity.getId();</span>
<span class="nc" id="L31805">                    r.indent(2);</span>
<span class="nc" id="L31806">                    addReport(r);</span>
                } else {
                    // TW, pg. 268: if unit moves forward, damage from front,
                    // if backwards, damage from rear.
<span class="nc" id="L31810">                    int side = ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L31811" title="All 2 branches missed.">                    if (backwards) {</span>
<span class="nc" id="L31812">                        side = ToHitData.SIDE_REAR;</span>
                    }
<span class="nc" id="L31814">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc" id="L31815">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L31816">                    addReport(damageEntity(entity, hit, damage));</span>
                }
            }

            // Infantry and BA are damaged by buildings but do not damage them
<span class="nc bnc" id="L31821" title="All 2 branches missed.">            if (entity instanceof Infantry) {</span>
<span class="nc" id="L31822">                return;</span>
            }
            // Damage the building. The CF can never drop below 0.
<span class="nc" id="L31825">            int toBldg = (int) Math.floor(bldg.getDamageToScale()</span>
<span class="nc" id="L31826">                    * Math.ceil(entity.getWeight() / 10.0));</span>
<span class="nc bnc" id="L31827" title="All 2 branches missed.">            int curCF = bldg.getCurrentCF(entering ? curPos : lastPos);</span>
<span class="nc" id="L31828">            curCF -= Math.min(curCF, toBldg);</span>
<span class="nc bnc" id="L31829" title="All 2 branches missed.">            bldg.setCurrentCF(curCF, entering ? curPos : lastPos);</span>

            // Apply the correct amount of damage to infantry in the building.
            // ASSUMPTION: We inflict toBldg damage to infantry and
            // not the amount to bring building to 0 CF.
<span class="nc bnc" id="L31834" title="All 2 branches missed.">            addReport(damageInfantryIn(bldg, toBldg, entering ? curPos : lastPos));</span>
        }
<span class="nc" id="L31836">    }</span>

    /**
     * check if a building collapses because of a moving entity
     *
     * @param bldg
     *            the &lt;code&gt;Building&lt;/code&gt;
     * @param entity
     *            the &lt;code&gt;Entity&lt;/code&gt;
     * @param curPos
     *            the &lt;code&gt;Coords&lt;/code&gt; of the position of the entity
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating if the building collapses
     */
    private boolean checkBuildingCollapseWhileMoving(Building bldg, Entity entity, Coords curPos) {
<span class="nc" id="L31850">        Coords oldPos = entity.getPosition();</span>
        // Count the moving entity in its current position, not
        // its pre-move position. Be sure to handle nulls.
<span class="nc" id="L31853">        entity.setPosition(curPos);</span>

        // Get the position map of all entities in the game.
<span class="nc" id="L31856">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>

        // Check for collapse of this building due to overloading, and return.
<span class="nc" id="L31859">        boolean rv = checkForCollapse(bldg, positionMap, curPos, true, vPhaseReport);</span>

        // If the entity was not displaced and didn't fall, move it back where it was
<span class="nc bnc" id="L31862" title="All 4 branches missed.">        if (curPos.equals(entity.getPosition()) &amp;&amp; !entity.isProne()) {</span>
<span class="nc" id="L31863">            entity.setPosition(oldPos);</span>
        }
<span class="nc" id="L31865">        return rv;</span>
    }

    public Vector&lt;Report&gt; damageInfantryIn(Building bldg, int damage, Coords hexCoords) {
<span class="nc" id="L31869">        return damageInfantryIn(bldg, damage, hexCoords, WeaponType.WEAPON_NA);</span>
    }

    /**
     * Apply the correct amount of damage that passes on to any infantry unit in
     * the given building, based upon the amount of damage the building just
     * sustained. This amount is a percentage dictated by pg. 172 of TW.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that sustained the damage.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    public Vector&lt;Report&gt; damageInfantryIn(Building bldg, int damage, Coords hexCoords,
                                           int infDamageClass) {
<span class="nc" id="L31882">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L31884" title="All 2 branches missed.">        if (bldg == null) {</span>
<span class="nc" id="L31885">            return vDesc;</span>
        }
        // Calculate the amount of damage the infantry will sustain.
<span class="nc" id="L31888">        float percent = bldg.getDamageReductionFromOutside();</span>
        Report r;

        // Round up at .5 points of damage.
<span class="nc" id="L31892">        int toInf = Math.round(damage * percent);</span>

        // some buildings scale remaining damage
<span class="nc" id="L31895">        toInf = (int) Math.floor(bldg.getDamageToScale() * toInf);</span>

        // Walk through the entities in the game.
<span class="nc bnc" id="L31898" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc" id="L31899">            final Coords coords = entity.getPosition();</span>

            // If the entity is infantry in the affected hex?
<span class="nc bnc" id="L31902" title="All 6 branches missed.">            if ((entity instanceof Infantry) &amp;&amp; bldg.isIn(coords) &amp;&amp; coords.equals(hexCoords)) {</span>
                // Is the entity is inside of the building
                // (instead of just on top of it)?
<span class="nc bnc" id="L31905" title="All 2 branches missed.">                if (Compute.isInBuilding(game, entity, coords)) {</span>

                    // Report if the infantry receive no points of damage.
<span class="nc bnc" id="L31908" title="All 2 branches missed.">                    if (toInf == 0) {</span>
<span class="nc" id="L31909">                        r = new Report(6445);</span>
<span class="nc" id="L31910">                        r.indent(3);</span>
<span class="nc" id="L31911">                        r.subject = entity.getId();</span>
<span class="nc" id="L31912">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L31913">                        vDesc.addElement(r);</span>
                    } else {
                        // Yup. Damage the entity.
<span class="nc" id="L31916">                        r = new Report(6450);</span>
<span class="nc" id="L31917">                        r.indent(3);</span>
<span class="nc" id="L31918">                        r.subject = entity.getId();</span>
<span class="nc" id="L31919">                        r.add(toInf);</span>
<span class="nc" id="L31920">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L31921">                        vDesc.addElement(r);</span>
                        // need to adjust damage to conventional infantry
                        // TW page 217 says left over damage gets treated as
                        // direct fire ballistic damage
<span class="nc bnc" id="L31925" title="All 2 branches missed.">                        if (!(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L31926">                            toInf = Compute.directBlowInfantryDamage(toInf, 0,</span>
                                    WeaponType.WEAPON_DIRECT_FIRE, false, false);
                        }
<span class="nc" id="L31929">                        int remaining = toInf;</span>
<span class="nc" id="L31930">                        int cluster = toInf;</span>
                        // Battle Armor units use 5 point clusters.
<span class="nc bnc" id="L31932" title="All 2 branches missed.">                        if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L31933">                            cluster = 5;</span>
                        }
<span class="nc bnc" id="L31935" title="All 2 branches missed.">                        while (remaining &gt; 0) {</span>
<span class="nc" id="L31936">                            int next = Math.min(cluster, remaining);</span>
<span class="nc" id="L31937">                            HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L31938">                            vDesc.addAll((damageEntity(entity, hit, next)));</span>
<span class="nc" id="L31939">                            remaining -= next;</span>
<span class="nc" id="L31940">                        }</span>
                    }

<span class="nc" id="L31943">                    Report.addNewline(vDesc);</span>
                } // End infantry-inside-building
            } // End entity-is-infantry-in-building-hex
<span class="nc" id="L31946">        } // Handle the next entity</span>

<span class="nc" id="L31948">        return vDesc;</span>
    } // End private void damageInfantryIn( Building, int )

    /**
     * Determine if the given building should collapse. If so, inflict the
     * appropriate amount of damage on each entity in the building and update
     * the clients. If the building does not collapse, determine if any entities
     * crash through its floor into its basement. Again, apply appropriate
     * damage.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; being checked. This value should
     *            not be &lt;code&gt;null&lt;/code&gt;.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be checked
     * @return &lt;code&gt;true&lt;/code&gt; if the building collapsed.
     */
    public boolean checkForCollapse(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                    Coords coords, boolean checkBecauseOfDamage,
                                    Vector&lt;Report&gt; vPhaseReport) {

        // If the input is meaningless, do nothing and throw no exception.
<span class="nc bnc" id="L31975" title="All 8 branches missed.">        if ((bldg == null) || (positionMap == null) || positionMap.isEmpty()</span>
<span class="nc bnc" id="L31976" title="All 4 branches missed.">                || (coords == null) || !bldg.isIn(coords) || !bldg.hasCFIn(coords)) {</span>
<span class="nc" id="L31977">            return false;</span>
        }

        // Get the building's current CF.
<span class="nc" id="L31981">        int currentCF = bldg.getCurrentCF(coords);</span>

        // Track all units that fall into the building's basement by Coords.
<span class="nc" id="L31984">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; basementMap = new Hashtable&lt;&gt;();</span>

        // look for a collapse.
<span class="nc" id="L31987">        boolean collapse = false;</span>

<span class="nc" id="L31989">        boolean basementCollapse = false;</span>

<span class="nc" id="L31991">        boolean topFloorCollapse = false;</span>

<span class="nc bnc" id="L31993" title="All 4 branches missed.">        if (checkBecauseOfDamage &amp;&amp; (currentCF &lt;= 0)) {</span>
<span class="nc" id="L31994">            collapse = true;</span>
        }

        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L31998">        final Vector&lt;Entity&gt; vector = positionMap.get(coords);</span>

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32001" title="All 2 branches missed.">        if (vector != null) {</span>
            // How many levels does this building have in this hex?
<span class="nc" id="L32003">            final IHex curHex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L32004">            final int numFloors = Math.max(0, curHex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L32005">            final int bridgeEl = curHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L32006">            int numLoads = numFloors;</span>
<span class="nc bnc" id="L32007" title="All 2 branches missed.">            if (bridgeEl != ITerrain.LEVEL_NONE) {</span>
<span class="nc" id="L32008">                numLoads++;</span>
            }
<span class="nc bnc" id="L32010" title="All 2 branches missed.">            if (numLoads &lt; 1) {</span>
<span class="nc" id="L32011">                MegaMek.getLogger().error(&quot;Check for collapse: hex &quot; + coords.toString() </span>
                        + &quot; has no bridge or building&quot;);
<span class="nc" id="L32013">                return false;</span>
            }

            // Track the load of each floor (and of the roof) separately.
            // Track all units that fall into the basement in this hex.
            // track all floors, ground at index 0, the first floor is at
            // index 1, the second is at index 1, etc., and the roof is
            // at index (numFloors).
            // if bridge is present, bridge will be numFloors+1
<span class="nc" id="L32022">            double[] loads = new double[numLoads + 1];</span>
            // WiGEs flying over the building are also tracked, but can only collapse the top floor
            // and only count 25% of their tonnage.
<span class="nc" id="L32025">            double wigeLoad = 0;</span>
            // track all units that might fall into the basement
<span class="nc" id="L32027">            Vector&lt;Entity&gt; basement = new Vector&lt;&gt;();</span>

<span class="nc" id="L32029">            boolean recheckLoop = true;</span>
<span class="nc bnc" id="L32030" title="All 4 branches missed.">            for (int i = 0; (i &lt; 2) &amp;&amp; recheckLoop; i++) {</span>
<span class="nc" id="L32031">                recheckLoop = false;</span>
<span class="nc" id="L32032">                Arrays.fill(loads, 0);</span>

                // Walk through the entities in this position.
<span class="nc" id="L32035">                Enumeration&lt;Entity&gt; entities = vector.elements();</span>
<span class="nc bnc" id="L32036" title="All 4 branches missed.">                while (!collapse &amp;&amp; entities.hasMoreElements()) {</span>
<span class="nc" id="L32037">                    final Entity entity = entities.nextElement();</span>
                    // WiGEs can collapse the top floor of a building by flying over it.
<span class="nc" id="L32039">                    final int entityElev = entity.getElevation();</span>
<span class="nc bnc" id="L32040" title="All 4 branches missed.">                    final boolean wigeFlyover = entity.getMovementMode() == EntityMovementMode.WIGE</span>
                            &amp;&amp; entityElev == numFloors + 1;

<span class="nc bnc" id="L32043" title="All 4 branches missed.">                    if (entityElev != bridgeEl &amp;&amp; !wigeFlyover) {</span>
                        // Ignore entities not *inside* the building
<span class="nc bnc" id="L32045" title="All 2 branches missed.">                        if (entityElev &gt; numFloors) {</span>
<span class="nc" id="L32046">                            continue;</span>
                        }
                    }
                    
                    // if we're under a bridge, we can't collapse the bridge
<span class="nc bnc" id="L32051" title="All 2 branches missed.">                    if (entityElev &lt; bridgeEl) {</span>
<span class="nc" id="L32052">                        continue;</span>
                    }

<span class="nc bnc" id="L32055" title="All 2 branches missed.">                    if ((entity.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L32056" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L32057" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L32058" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L32059" title="All 2 branches missed.">                            || entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L32060">                        continue; // under the bridge even at same level</span>
                    }

<span class="nc bnc" id="L32063" title="All 2 branches missed.">                    if (entityElev == 0) {</span>
<span class="nc" id="L32064">                        basement.add(entity);</span>
                    }

                    // units already in the basement
<span class="nc bnc" id="L32068" title="All 2 branches missed.">                    if (entityElev &lt; 0) {</span>
<span class="nc" id="L32069">                        continue;</span>
                    }

                    // Add the weight to the correct floor.
<span class="nc" id="L32073">                    double load = entity.getWeight();</span>
<span class="nc" id="L32074">                    int floor = entityElev;</span>
<span class="nc bnc" id="L32075" title="All 2 branches missed.">                    if (floor == bridgeEl) {</span>
<span class="nc" id="L32076">                        floor = numLoads;</span>
                    }
                    // Entities on the roof fall to the previous top floor/new roof
<span class="nc bnc" id="L32079" title="All 4 branches missed.">                    if (topFloorCollapse &amp;&amp; floor == numFloors) {</span>
<span class="nc" id="L32080">                        floor--;</span>
                    }

<span class="nc bnc" id="L32083" title="All 2 branches missed.">                    if (wigeFlyover) {</span>
<span class="nc" id="L32084">                        wigeLoad += load;</span>
<span class="nc bnc" id="L32085" title="All 2 branches missed.">                        if (wigeLoad &gt; currentCF * 4) {</span>
<span class="nc" id="L32086">                            topFloorCollapse = true;</span>
<span class="nc" id="L32087">                            loads[numFloors - 1] += loads[numFloors];</span>
<span class="nc" id="L32088">                            loads[numFloors] = 0;</span>
                        }
                    } else {
<span class="nc" id="L32091">                        loads[floor] += load;</span>
<span class="nc bnc" id="L32092" title="All 2 branches missed.">                        if (loads[floor] &gt; currentCF) {</span>
                            // If the load on any floor but the ground floor
                            // exceeds the building's current CF it collapses.
<span class="nc bnc" id="L32095" title="All 2 branches missed.">                            if (floor != 0) {</span>
<span class="nc" id="L32096">                                collapse = true;</span>
<span class="nc bnc" id="L32097" title="All 2 branches missed.">                            } else if (!bldg.getBasementCollapsed(coords)) {</span>
<span class="nc" id="L32098">                                basementCollapse = true;</span>
                            }
                        }
                    } // End increase-load
<span class="nc" id="L32102">                } // Handle the next entity.</span>

                // Track all entities that fell into the basement.
<span class="nc bnc" id="L32105" title="All 2 branches missed.">                if (basementCollapse) {</span>
<span class="nc" id="L32106">                    basementMap.put(coords, basement);</span>
                }

                // did anyone fall into the basement?
<span class="nc bnc" id="L32110" title="All 6 branches missed.">                if (!basementMap.isEmpty() &amp;&amp; (bldg.getBasement(coords) != BasementType.NONE) &amp;&amp; !collapse) {</span>
<span class="nc" id="L32111">                    collapseBasement(bldg, basementMap, coords, vPhaseReport);</span>
<span class="nc bnc" id="L32112" title="All 2 branches missed.">                    if (currentCF == 0) {</span>
<span class="nc" id="L32113">                        collapse = true;</span>
<span class="nc" id="L32114">                        recheckLoop = false;</span>
                    } else {
<span class="nc" id="L32116">                        recheckLoop = true; // basement collapse might cause a further collapse</span>
                    }
                } else {
<span class="nc" id="L32119">                    recheckLoop = false; // don't check again, we didn't change the CF</span>
                }
<span class="nc bnc" id="L32121" title="All 2 branches missed.">                if (collapse) {</span>
<span class="nc" id="L32122">                    recheckLoop = false;</span>
                    // recheck if the basement collapsed since the basement falls
                    // might trigger a greater collapse.
                }
            } // End have-entities-here
        }

        // Collapse the building if the flag is set.
<span class="nc bnc" id="L32130" title="All 2 branches missed.">        if (collapse) {</span>
<span class="nc" id="L32131">            Report r = new Report(2375, Report.PUBLIC);</span>
<span class="nc" id="L32132">            r.add(bldg.getName());</span>
<span class="nc" id="L32133">            vPhaseReport.add(r);</span>

<span class="nc" id="L32135">            collapseBuilding(bldg, positionMap, coords, false, vPhaseReport);</span>
<span class="nc bnc" id="L32136" title="All 2 branches missed.">        } else if (topFloorCollapse) {</span>
<span class="nc" id="L32137">                Report r = new Report(2376, Report.PUBLIC);</span>
<span class="nc" id="L32138">                r.add(bldg.getName());</span>
<span class="nc" id="L32139">                vPhaseReport.add(r);</span>

<span class="nc" id="L32141">                collapseBuilding(bldg, positionMap, coords, false, true, vPhaseReport);</span>
        }

        // Return true if the building collapsed.
<span class="nc bnc" id="L32145" title="All 4 branches missed.">        return collapse || topFloorCollapse;</span>

    } // End private boolean checkForCollapse( Building, Hashtable )

    public void collapseBuilding(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L32151">        collapseBuilding(bldg, positionMap, coords, true, false, vPhaseReport);</span>
<span class="nc" id="L32152">    }</span>

    public void collapseBuilding(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, boolean collapseAll, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L32156">        collapseBuilding(bldg, positionMap, coords, collapseAll, false, vPhaseReport);</span>
<span class="nc" id="L32157">    }</span>

    /**
     * Collapse a building basement. Inflict the appropriate amount of damage on
     * all entities that fell to the basement. Update all clients.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; that has collapsed.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - The &lt;code&gt;Coords&gt;&lt;/code&gt; of the building basement hex that
     *            has collapsed
     */
    public void collapseBasement(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L32176" title="All 2 branches missed.">        if (!bldg.hasCFIn(coords)) {</span>
<span class="nc" id="L32177">            return;</span>
        }
        int runningCFTotal;
<span class="nc" id="L32180">        runningCFTotal = bldg.getCurrentCF(coords);</span>

        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32183">        final Vector&lt;Entity&gt; entities = positionMap.get(coords);</span>

<span class="nc bnc" id="L32185" title="All 2 branches missed.">        if (bldg.getBasement(coords) == BasementType.NONE) {</span>
<span class="nc" id="L32186">            return;</span>
        } else {
<span class="nc" id="L32188">            bldg.collapseBasement(coords, game.getBoard(), vPhaseReport);</span>
        }

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32192" title="All 2 branches missed.">        if (entities != null) {</span>

            // Sort in elevation order
<span class="nc" id="L32195">            entities.sort((a, b) -&gt; {</span>
<span class="nc bnc" id="L32196" title="All 2 branches missed.">                if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32197">                    return -1;</span>
<span class="nc bnc" id="L32198" title="All 2 branches missed.">                } else if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32199">                    return 1;</span>
                }
<span class="nc" id="L32201">                return 0;</span>
            });
            // Walk through the entities in this position.
<span class="nc bnc" id="L32204" title="All 2 branches missed.">            for (Entity entity : entities) {</span>

                // int floor = entity.getElevation();

<span class="nc" id="L32208">                int cfDamage = (int) Math.ceil(Math.round(entity.getWeight() / 10.0));</span>

                // all entities should fall
                // ASSUMPTION: PSR to avoid pilot damage
<span class="nc" id="L32212">                PilotingRollData psr = entity.getBasePilotingRoll();</span>
<span class="nc" id="L32213">                entity.addPilotingModifierForTerrain(psr, coords);</span>

                // fall into basement
<span class="nc bnc" id="L32216" title="All 2 branches missed.">                if ((bldg.getBasement(coords) == BasementType.TWO_DEEP_HEAD)</span>
<span class="nc bnc" id="L32217" title="All 2 branches missed.">                        || (bldg.getBasement(coords) == BasementType.TWO_DEEP_FEET)) {</span>
<span class="nc" id="L32218">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is falling 2 floors into &quot; + coords.toString());</span>
                    // Damage is determined by the depth of the basement, so a
                    //  fall of 0 elevation is correct in this case
<span class="nc" id="L32221">                    vPhaseReport.addAll(doEntityFall(entity, coords, 0,</span>
<span class="nc" id="L32222">                            Compute.d6(), psr, true, false));</span>
<span class="nc" id="L32223">                    runningCFTotal -= cfDamage * 2;</span>
<span class="nc bnc" id="L32224" title="All 2 branches missed.">                } else if ((bldg.getBasement(coords) != BasementType.NONE)</span>
<span class="nc bnc" id="L32225" title="All 2 branches missed.">                           &amp;&amp; (bldg.getBasement(coords) != BasementType.ONE_DEEP_NORMALINFONLY)) {</span>
<span class="nc" id="L32226">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is falling 1 floor into &quot; + coords.toString());</span>
                    // Damage is determined by the depth of the basement, so a
                    //  fall of 0 elevation is correct in this case
<span class="nc" id="L32229">                    vPhaseReport.addAll(doEntityFall(entity, coords, 0,</span>
<span class="nc" id="L32230">                            Compute.d6(), psr, true, false));</span>
<span class="nc" id="L32231">                    runningCFTotal -= cfDamage;</span>
                } else {
<span class="nc" id="L32233">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is not falling into &quot; + coords.toString());</span>
                }

                // Update this entity.
                // ASSUMPTION: this is the correct thing to do.
<span class="nc" id="L32238">                entityUpdate(entity.getId());</span>

<span class="nc" id="L32240">            } // Handle the next entity.</span>

        } // End have-entities-here.

        // Update the building
<span class="nc bnc" id="L32245" title="All 2 branches missed.">        if (runningCFTotal &lt; 0) {</span>
<span class="nc" id="L32246">            bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32247">            bldg.setPhaseCF(0, coords);</span>
        } else {
<span class="nc" id="L32249">            bldg.setCurrentCF(runningCFTotal, coords);</span>
<span class="nc" id="L32250">            bldg.setPhaseCF(runningCFTotal, coords);</span>
        }
<span class="nc" id="L32252">        sendChangedHex(coords);</span>
<span class="nc" id="L32253">        Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L32254">        buildings.add(bldg);</span>
<span class="nc" id="L32255">        sendChangedBuildings(buildings);</span>
<span class="nc" id="L32256">    }</span>

    /**
     * Collapse a building hex. Inflict the appropriate amount of damage on all
     * entities in the building. Update all clients.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; that has collapsed.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - The &lt;code&gt;Coords&gt;&lt;/code&gt; of the building hex that has
     *            collapsed
     * @param collapseAll
     *            - A &lt;code&gt;boolean&lt;/code&gt; indicating whether or not this
     *            collapse of a hex should be able to collapse the whole
     *            building
     * @param topFloor
     *            - A &lt;code&gt;boolean&lt;/code&gt; indicating that only the top floor collapses
     *              (from a WiGE flying over the top).
     *
     */
    public void collapseBuilding(Building bldg,
            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap, Coords coords,
            boolean collapseAll, boolean topFloor, Vector&lt;Report&gt; vPhaseReport) {
        // sometimes, buildings that reach CF 0 decide against collapsing
        // but we want them to go away anyway, as a building with CF 0 cannot stand
<span class="nc bnc" id="L32286" title="All 2 branches missed.">        final int phaseCF = bldg.hasCFIn(coords) ? bldg.getPhaseCF(coords) : 0;</span>

        // Loop through the hexes in the building, and apply
        // damage to all entities inside or on top of the building.
        Report r;
        
        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32293">        final Vector&lt;Entity&gt; vector = positionMap.get(coords);</span>

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32296" title="All 2 branches missed.">        if (vector != null) {</span>

            // How many levels does this building have in this hex?
<span class="nc" id="L32299">            final IHex curHex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L32300">            final int bridgeEl = curHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L32301">            final int numFloors = Math.max(bridgeEl,</span>
<span class="nc" id="L32302">                    curHex.terrainLevel(Terrains.BLDG_ELEV));</span>

            // Now collapse the building in this hex, so entities fall to
            // the ground
<span class="nc bnc" id="L32306" title="All 4 branches missed.">            if (topFloor &amp;&amp; numFloors &gt; 1) {</span>
<span class="nc" id="L32307">                curHex.removeTerrain(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L32308">                curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.BLDG_ELEV, numFloors - 1));</span>
<span class="nc" id="L32309">                sendChangedHex(coords);</span>
            } else {
<span class="nc" id="L32311">                bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32312">                bldg.setPhaseCF(0, coords);</span>
<span class="nc" id="L32313">                send(createCollapseBuildingPacket(coords));</span>
<span class="nc" id="L32314">                game.getBoard().collapseBuilding(coords);</span>
            }

            // Sort in elevation order
<span class="nc" id="L32318">            vector.sort((a, b) -&gt; {</span>
<span class="nc bnc" id="L32319" title="All 2 branches missed.">                if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32320">                    return -1;</span>
<span class="nc bnc" id="L32321" title="All 2 branches missed.">                } else if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32322">                    return 1;</span>
                }
<span class="nc" id="L32324">                return 0;</span>
            });
            // Walk through the entities in this position.
<span class="nc" id="L32327">            Enumeration&lt;Entity&gt; entities = vector.elements();</span>
<span class="nc bnc" id="L32328" title="All 2 branches missed.">            while (entities.hasMoreElements()) {</span>
<span class="nc" id="L32329">                final Entity entity = entities.nextElement();</span>
                // all gun emplacements are simply destroyed
<span class="nc bnc" id="L32331" title="All 2 branches missed.">                if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L32332">                    vPhaseReport.addAll(destroyEntity(entity, &quot;building collapse&quot;));</span>
<span class="nc" id="L32333">                    addNewLines();</span>
<span class="nc" id="L32334">                    continue;</span>
                }

<span class="nc" id="L32337">                int floor = entity.getElevation();</span>
                // If only the top floor collapses, we only care about units on the top level
                // or on the roof.
<span class="nc bnc" id="L32340" title="All 4 branches missed.">                if (topFloor &amp;&amp; floor &lt; numFloors - 1) {</span>
<span class="nc" id="L32341">                    continue;</span>
                }
                // units trapped in a basement under a collapsing building are
                // destroyed
<span class="nc bnc" id="L32345" title="All 2 branches missed.">                if (floor &lt; 0) {</span>
<span class="nc" id="L32346">                    vPhaseReport.addAll(destroyEntity(entity,</span>
                            &quot;Crushed under building rubble&quot;, false, false));
                }

                // Ignore units above the building / bridge.
<span class="nc bnc" id="L32351" title="All 2 branches missed.">                if (floor &gt; numFloors) {</span>
<span class="nc" id="L32352">                    continue;</span>
                }

                // Treat units on the roof like
                // they were in the top floor.
<span class="nc bnc" id="L32357" title="All 2 branches missed.">                if (floor == numFloors) {</span>
<span class="nc" id="L32358">                    floor--;</span>
                }

                // Calculate collapse damage for this entity.
<span class="nc" id="L32362">                int damage = (int) Math.floor(bldg.getDamageFromScale()</span>
<span class="nc" id="L32363">                        * Math.ceil((phaseCF * (numFloors - floor)) / 10.0));</span>

                // Infantry suffer more damage.
<span class="nc bnc" id="L32366" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc bnc" id="L32367" title="All 4 branches missed.">                    if ((entity instanceof BattleArmor) || ((Infantry) entity).isMechanized()) {</span>
<span class="nc" id="L32368">                        damage *= 2;</span>
                    } else {
<span class="nc" id="L32370">                        damage *= 3;</span>
                    }
                }

                // Apply collapse damage the entity.
<span class="nc" id="L32375">                r = new Report(6455);</span>
<span class="nc" id="L32376">                r.indent();</span>
<span class="nc" id="L32377">                r.subject = entity.getId();</span>
<span class="nc" id="L32378">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L32379">                r.add(damage);</span>
<span class="nc" id="L32380">                vPhaseReport.add(r);</span>
<span class="nc" id="L32381">                int remaining = damage;</span>
<span class="nc" id="L32382">                int cluster = damage;</span>
<span class="nc bnc" id="L32383" title="All 6 branches missed.">                if ((entity instanceof BattleArmor) || (entity instanceof Mech)</span>
                        || (entity instanceof Tank)) {
<span class="nc" id="L32385">                    cluster = 5;</span>
                }
<span class="nc bnc" id="L32387" title="All 2 branches missed.">                while (remaining &gt; 0) {</span>
<span class="nc" id="L32388">                    int next = Math.min(cluster, remaining);</span>
                    int table;
<span class="nc bnc" id="L32390" title="All 2 branches missed.">                    if (entity instanceof Protomech) {</span>
<span class="nc" id="L32391">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
<span class="nc bnc" id="L32392" title="All 2 branches missed.">                    } else if (entity.getElevation() == numFloors) {</span>
<span class="nc" id="L32393">                        table = ToHitData.HIT_NORMAL;</span>
                    } else {
<span class="nc" id="L32395">                        table = ToHitData.HIT_PUNCH;</span>
                    }
<span class="nc" id="L32397">                    HitData hit = entity.rollHitLocation(table, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L32398">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L32399">                    vPhaseReport.addAll(damageEntity(entity, hit, next));</span>
<span class="nc" id="L32400">                    remaining -= next;</span>
<span class="nc" id="L32401">                }</span>
<span class="nc" id="L32402">                vPhaseReport.add(new Report(1210, Report.PUBLIC));</span>

                // all entities should fall
<span class="nc" id="L32405">                floor = entity.getElevation();</span>
<span class="nc bnc" id="L32406" title="All 4 branches missed.">                if ((floor &gt; 0) || (floor == bridgeEl)) {</span>
                    // ASSUMPTION: PSR to avoid pilot damage
                    // should use mods for entity damage and
                    // 20+ points of collapse damage (if any).
<span class="nc" id="L32410">                    PilotingRollData psr = entity.getBasePilotingRoll();</span>
<span class="nc" id="L32411">                    entity.addPilotingModifierForTerrain(psr, coords);</span>
<span class="nc bnc" id="L32412" title="All 2 branches missed.">                    if (damage &gt;= 20) {</span>
<span class="nc" id="L32413">                        psr.addModifier(1, &quot;20+ damage&quot;);</span>
                    }
<span class="nc" id="L32415">                    vPhaseReport.addAll(doEntityFallsInto(entity, coords, psr,</span>
                            true));
                }
                // Update this entity.
                // ASSUMPTION: this is the correct thing to do.
<span class="nc" id="L32420">                entityUpdate(entity.getId());</span>

<span class="nc" id="L32422">            } // Handle the next entity.</span>

<span class="nc" id="L32424">        } // End have-entities-here.</span>

        else {
            // Update the building.
<span class="nc" id="L32428">            bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32429">            bldg.setPhaseCF(0, coords);</span>
<span class="nc" id="L32430">            send(createCollapseBuildingPacket(coords));</span>
<span class="nc" id="L32431">            game.getBoard().collapseBuilding(coords);</span>
        }
        // if more than half of the hexes are gone, collapse all
<span class="nc bnc" id="L32434" title="All 2 branches missed.">        if (bldg.getCollapsedHexCount() &gt; (bldg.getOriginalHexCount() / 2)) {</span>
<span class="nc" id="L32435">            for (Enumeration&lt;Coords&gt; coordsEnum = bldg.getCoords(); coordsEnum</span>
<span class="nc bnc" id="L32436" title="All 2 branches missed.">                    .hasMoreElements();) {</span>
<span class="nc" id="L32437">                coords = coordsEnum.nextElement();</span>
<span class="nc" id="L32438">                collapseBuilding(bldg, game.getPositionMap(), coords, false,</span>
                        vPhaseReport);
            }
        }

<span class="nc" id="L32443">    } // End private void collapseBuilding( Building )</span>

    /**
     * Tell the clients to replace the given building with rubble hexes.
     *
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; that has collapsed.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createCollapseBuildingPacket(Coords coords) {
<span class="nc" id="L32452">        Vector&lt;Coords&gt; coordsV = new Vector&lt;&gt;();</span>
<span class="nc" id="L32453">        coordsV.addElement(coords);</span>
<span class="nc" id="L32454">        return createCollapseBuildingPacket(coordsV);</span>
    }

    /**
     * Tell the clients to replace the given building hexes with rubble hexes.
     *
     * @param coords - a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Coords&lt;/code&gt;s that has
     *               collapsed.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createCollapseBuildingPacket(Vector&lt;Coords&gt; coords) {
<span class="nc" id="L32465">        return new Packet(Packet.COMMAND_BLDG_COLLAPSE, coords);</span>
    }

    /**
     * Tell the clients to update the CFs of the given buildings.
     *
     * @param buildings - a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Building&lt;/code&gt;s that need to
     *                  be updated.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createUpdateBuildingPacket(Vector&lt;Building&gt; buildings) {
<span class="nc" id="L32476">        return new Packet(Packet.COMMAND_BLDG_UPDATE, buildings);</span>
    }

    /**
     * Apply this phase's damage to all buildings. Buildings may collapse due to
     * damage.
     */
    private void applyBuildingDamage() {

        // Walk through the buildings in the game.
        // Build the collapse and update vectors as you go.
        // N.B. never, NEVER, collapse buildings while you are walking through
        // the Enumeration from megamek.common.Board#getBuildings.
<span class="nc" id="L32489">        Map&lt;Building, Vector&lt;Coords&gt;&gt; collapse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L32490">        Map&lt;Building, Vector&lt;Coords&gt;&gt; update = new HashMap&lt;&gt;();</span>
<span class="nc" id="L32491">        Enumeration&lt;Building&gt; buildings = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L32492" title="All 2 branches missed.">        while (buildings.hasMoreElements()) {</span>
<span class="nc" id="L32493">            Building bldg = buildings.nextElement();</span>
<span class="nc" id="L32494">            Vector&lt;Coords&gt; collapseCoords = new Vector&lt;&gt;();</span>
<span class="nc" id="L32495">            Vector&lt;Coords&gt; updateCoords = new Vector&lt;&gt;();</span>
<span class="nc" id="L32496">            Enumeration&lt;Coords&gt; buildingCoords = bldg.getCoords();</span>
<span class="nc bnc" id="L32497" title="All 2 branches missed.">            while (buildingCoords.hasMoreElements()) {</span>
<span class="nc" id="L32498">                Coords coords = buildingCoords.nextElement();</span>
                // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32500" title="All 2 branches missed.">                if (bldg.getCurrentCF(coords) == 0) {</span>
<span class="nc" id="L32501">                    collapseCoords.addElement(coords);</span>
                }
                // If the building took damage this round, update it.
<span class="nc bnc" id="L32504" title="All 2 branches missed.">                else if (bldg.getPhaseCF(coords) != bldg.getCurrentCF(coords)) {</span>
<span class="nc" id="L32505">                    bldg.setPhaseCF(bldg.getCurrentCF(coords), coords);</span>
<span class="nc" id="L32506">                    updateCoords.addElement(coords);</span>
                }
<span class="nc" id="L32508">            }</span>
<span class="nc" id="L32509">            collapse.put(bldg, collapseCoords);</span>
<span class="nc" id="L32510">            update.put(bldg, updateCoords);</span>
<span class="nc" id="L32511">        } // Handle the next building</span>

        // If we have any buildings to collapse, collapse them now.
<span class="nc bnc" id="L32514" title="All 2 branches missed.">        if (!collapse.isEmpty()) {</span>

            // Get the position map of all entities in the game.
<span class="nc" id="L32517">            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game</span>
<span class="nc" id="L32518">                    .getPositionMap();</span>

            // Walk through the hexes that have collapsed.
<span class="nc bnc" id="L32521" title="All 2 branches missed.">            for (Building bldg : collapse.keySet()) {</span>
<span class="nc" id="L32522">                Vector&lt;Coords&gt; coordsVector = collapse.get(bldg);</span>
<span class="nc bnc" id="L32523" title="All 2 branches missed.">                for (Coords coords : coordsVector) {</span>
<span class="nc" id="L32524">                    Report r = new Report(6460, Report.PUBLIC);</span>
<span class="nc" id="L32525">                    r.add(bldg.getName());</span>
<span class="nc" id="L32526">                    addReport(r);</span>
<span class="nc" id="L32527">                    collapseBuilding(bldg, positionMap, coords, vPhaseReport);</span>
<span class="nc" id="L32528">                }</span>
<span class="nc" id="L32529">            }</span>
        }

        // check for buildings which should collapse due to being overloaded now
        // CF is reduced
<span class="nc bnc" id="L32534" title="All 2 branches missed.">        if (!update.isEmpty()) {</span>
<span class="nc" id="L32535">            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>
<span class="nc bnc" id="L32536" title="All 2 branches missed.">            for (Building bldg : update.keySet()) {</span>
<span class="nc" id="L32537">                Vector&lt;Coords&gt; updateCoords = update.get(bldg);</span>
<span class="nc" id="L32538">                Vector&lt;Coords&gt; coordsToRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32539" title="All 2 branches missed.">                for (Coords coords : updateCoords) {</span>
<span class="nc bnc" id="L32540" title="All 2 branches missed.">                    if (checkForCollapse(bldg, positionMap, coords, false,</span>
                                         vPhaseReport)) {
<span class="nc" id="L32542">                        coordsToRemove.add(coords);</span>
                    }
<span class="nc" id="L32544">                }</span>
<span class="nc" id="L32545">                updateCoords.removeAll(coordsToRemove);</span>
<span class="nc" id="L32546">                update.put(bldg, updateCoords);</span>
<span class="nc" id="L32547">            }</span>
        }

        // If we have any buildings to update, send the message.
<span class="nc bnc" id="L32551" title="All 2 branches missed.">        if (!update.isEmpty()) {</span>
<span class="nc" id="L32552">            sendChangedBuildings(new Vector&lt;&gt;(update.keySet()));</span>
        }
<span class="nc" id="L32554">    }</span>

    /**
     * Apply the given amount of damage to the building. Please note, this
     * method does &lt;b&gt;not&lt;/b&gt; apply any damage to units inside the building,
     * update the clients, or check for the building's collapse.
     * &lt;p/&gt;
     * A default message will be used to describe why the building took the
     * damage.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that has been damaged. This value
     *               should not be &lt;code&gt;null&lt;/code&gt;, but no exception will occur.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be damaged
     * @return a &lt;code&gt;Report&lt;/code&gt; to be shown to the players.
     */
    public Vector&lt;Report&gt; damageBuilding(Building bldg, int damage,
                                         Coords coords) {
<span class="nc" id="L32572">        final String defaultWhy = &quot; absorbs &quot;;</span>
<span class="nc" id="L32573">        return damageBuilding(bldg, damage, defaultWhy, coords);</span>
    }

    /**
     * Apply the given amount of damage to the building. Please note, this
     * method does &lt;b&gt;not&lt;/b&gt; apply any damage to units inside the building,
     * update the clients, or check for the building's collapse.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that has been damaged. This value
     *               should not be &lt;code&gt;null&lt;/code&gt;, but no exception will occur.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param why    - the &lt;code&gt;String&lt;/code&gt; message that describes why the
     *               building took the damage.
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be damaged
     * @return a &lt;code&gt;Report&lt;/code&gt; to be shown to the players.
     */
    public Vector&lt;Report&gt; damageBuilding(Building bldg, int damage, String why, Coords coords) {
<span class="nc" id="L32590">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L32591">        Report r = new Report(1210, Report.PUBLIC);</span>

        // Do nothing if no building or no damage was passed.
<span class="nc bnc" id="L32594" title="All 4 branches missed.">        if ((bldg != null) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L32595">            r.messageId = 3435;</span>
<span class="nc" id="L32596">            r.add(bldg.toString());</span>
<span class="nc" id="L32597">            r.add(why);</span>
<span class="nc" id="L32598">            r.add(damage);</span>
<span class="nc" id="L32599">            vPhaseReport.add(r);</span>
<span class="nc" id="L32600">            int curArmor = bldg.getArmor(coords);</span>
<span class="nc bnc" id="L32601" title="All 2 branches missed.">            if (curArmor &gt;= damage) {</span>
<span class="nc" id="L32602">                curArmor -= Math.min(curArmor, damage);</span>
<span class="nc" id="L32603">                bldg.setArmor(curArmor, coords);</span>
<span class="nc" id="L32604">                r = new Report(3436, Report.PUBLIC);</span>
<span class="nc" id="L32605">                r.indent(0);</span>
<span class="nc" id="L32606">                r.add(damage);</span>
<span class="nc" id="L32607">                r.add(curArmor);</span>
<span class="nc" id="L32608">                vPhaseReport.add(r);</span>
            } else {
<span class="nc" id="L32610">                r.add(damage);</span>
<span class="nc bnc" id="L32611" title="All 2 branches missed.">                if (curArmor &gt; 0) {</span>
<span class="nc" id="L32612">                    bldg.setArmor(0, coords);</span>
<span class="nc" id="L32613">                    damage = damage - curArmor;</span>
<span class="nc" id="L32614">                    r = new Report(3436, Report.PUBLIC);</span>
<span class="nc" id="L32615">                    r.indent(0);</span>
<span class="nc" id="L32616">                    r.add(curArmor);</span>
<span class="nc" id="L32617">                    r.add(0);</span>
<span class="nc" id="L32618">                    vPhaseReport.add(r);</span>
                }
<span class="nc" id="L32620">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
<span class="nc bnc" id="L32621" title="All 2 branches missed.">                if (bldg.getDamageToScale() &lt; 1.0) {</span>
<span class="nc" id="L32622">                    r = new Report(3437, Report.PUBLIC);</span>
<span class="nc" id="L32623">                    r.indent(0);</span>
<span class="nc" id="L32624">                    r.add(damage);</span>
<span class="nc" id="L32625">                    vPhaseReport.add(r);</span>
                }
<span class="nc bnc" id="L32627" title="All 2 branches missed.">                if (bldg.getDamageToScale() &gt; 1.0) {</span>
<span class="nc" id="L32628">                    r = new Report(3438, Report.PUBLIC);</span>
<span class="nc" id="L32629">                    r.indent(0);</span>
<span class="nc" id="L32630">                    r.add(damage);</span>
<span class="nc" id="L32631">                    vPhaseReport.add(r);</span>
                }
<span class="nc" id="L32633">                int curCF = bldg.getCurrentCF(coords);</span>
<span class="nc" id="L32634">                final int startingCF = curCF;</span>
<span class="nc" id="L32635">                curCF -= Math.min(curCF, damage);</span>
<span class="nc" id="L32636">                bldg.setCurrentCF(curCF, coords);</span>

<span class="nc" id="L32638">                r = new Report(6436, Report.PUBLIC);</span>
<span class="nc" id="L32639">                r.indent(1);</span>
<span class="nc bnc" id="L32640" title="All 2 branches missed.">                String fontColorOpen = curCF &lt;= 0 ? &quot;&lt;font color='C00000'&gt;&quot; : &quot;&quot;;</span>
<span class="nc bnc" id="L32641" title="All 2 branches missed.">                String fontColorClose = curCF &lt;= 0 ? &quot;&lt;/font&gt;&quot; : &quot;&quot;;</span>
<span class="nc" id="L32642">                r.add(String.format(&quot;%s%s%s&quot;, fontColorOpen, curCF, fontColorClose));</span>
<span class="nc" id="L32643">                vPhaseReport.add(r);</span>

<span class="nc" id="L32645">                final int damageThresh = (int) Math.ceil(bldg.getPhaseCF(coords) / 10.0);</span>

                // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32648" title="All 4 branches missed.">                if ((curCF == 0) &amp;&amp; (startingCF != 0)) {</span>
<span class="nc bnc" id="L32649" title="All 2 branches missed.">                    if (bldg instanceof FuelTank) {</span>
                        // If this is a fuel tank, we'll give it its own
                        // message.
<span class="nc" id="L32652">                        r = new Report(3441);</span>
<span class="nc" id="L32653">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32654">                        r.indent(0);</span>
<span class="nc" id="L32655">                        vPhaseReport.add(r);</span>
                        // ...But we ALSO need to blow up everything nearby.
                        // Bwahahahahaha...
<span class="nc" id="L32658">                        r = new Report(3560);</span>
<span class="nc" id="L32659">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32660">                        r.newlines = 1;</span>
<span class="nc" id="L32661">                        vPhaseReport.add(r);</span>
<span class="nc" id="L32662">                        Vector&lt;Report&gt; vRep = new Vector&lt;&gt;();</span>
<span class="nc" id="L32663">                        doExplosion(((FuelTank) bldg).getMagnitude(), 10,</span>
<span class="nc" id="L32664">                                false, bldg.getCoords().nextElement(), true,</span>
                                vRep, null, -1);
<span class="nc" id="L32666">                        Report.indentAll(vRep, 2);</span>
<span class="nc" id="L32667">                        vPhaseReport.addAll(vRep);</span>
<span class="nc" id="L32668">                        return vPhaseReport;</span>
                    }
<span class="nc bnc" id="L32670" title="All 2 branches missed.">                    if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L32671">                        r = new Report(3442);</span>
<span class="nc" id="L32672">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32673">                        r.indent(0);</span>
<span class="nc" id="L32674">                        vPhaseReport.add(r);</span>
                    } else {
<span class="nc" id="L32676">                        r = new Report(3440);</span>
<span class="nc" id="L32677">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32678">                        r.indent(0);</span>
<span class="nc" id="L32679">                        vPhaseReport.add(r);</span>
                    }
<span class="nc bnc" id="L32681" title="All 4 branches missed.">                } else if ((curCF &lt; startingCF) &amp;&amp; (damage &gt; damageThresh)) {</span>
                    // need to check for crits
                    // don't bother unless we have some gun emplacements
<span class="nc" id="L32684">                    Vector&lt;GunEmplacement&gt; guns = game</span>
<span class="nc" id="L32685">                            .getGunEmplacements(coords);</span>
<span class="nc bnc" id="L32686" title="All 2 branches missed.">                    if (guns.size() &gt; 0) {</span>
<span class="nc" id="L32687">                        vPhaseReport.addAll(criticalGunEmplacement(guns, bldg,</span>
                                coords));
                    }
                }
            }
        }
<span class="nc" id="L32693">        Report.indentAll(vPhaseReport, 2);</span>
<span class="nc" id="L32694">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; criticalGunEmplacement(Vector&lt;GunEmplacement&gt; guns, Building bldg,
                                                  Coords coords) {
<span class="nc" id="L32699">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L32701">        r = new Report(3800);</span>
<span class="nc" id="L32702">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32703">        r.indent(0);</span>
<span class="nc" id="L32704">        vDesc.add(r);</span>

<span class="nc" id="L32706">        int critRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L32707" title="All 2 branches missed.">        if (critRoll &lt; 6) {</span>
<span class="nc" id="L32708">            r = new Report(3805);</span>
<span class="nc" id="L32709">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32710">            r.indent(1);</span>
<span class="nc" id="L32711">            vDesc.add(r);</span>
<span class="nc bnc" id="L32712" title="All 2 branches missed.">        } else if (critRoll == 6) {</span>
            // weapon malfunction
            // lets just randomly determine which weapon gets hit
<span class="nc" id="L32715">            Vector&lt;Mounted&gt; wpns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32716" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32717" title="All 2 branches missed.">                for (Mounted wpn : gun.getWeaponList()) {</span>
<span class="nc bnc" id="L32718" title="All 4 branches missed.">                    if (!wpn.isHit() &amp;&amp; !wpn.isJammed()</span>
<span class="nc bnc" id="L32719" title="All 2 branches missed.">                        &amp;&amp; !wpn.jammedThisPhase()) {</span>
<span class="nc" id="L32720">                        wpns.add(wpn);</span>
                    }
<span class="nc" id="L32722">                }</span>
<span class="nc" id="L32723">            }</span>
<span class="nc bnc" id="L32724" title="All 2 branches missed.">            if (wpns.size() &gt; 0) {</span>
<span class="nc" id="L32725">                Mounted weapon = wpns.elementAt(Compute.randomInt(wpns.size()));</span>
<span class="nc" id="L32726">                weapon.setJammed(true);</span>
<span class="nc" id="L32727">                ((GunEmplacement) weapon.getEntity()).addJammedWeapon(weapon);</span>
<span class="nc" id="L32728">                r = new Report(3845);</span>
<span class="nc" id="L32729">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32730">                r.indent(1);</span>
<span class="nc" id="L32731">                r.add(weapon.getDesc());</span>
<span class="nc" id="L32732">            } else {</span>
<span class="nc" id="L32733">                r = new Report(3846);</span>
<span class="nc" id="L32734">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32735">                r.indent(1);</span>
            }
<span class="nc" id="L32737">            vDesc.add(r);</span>
<span class="nc bnc" id="L32738" title="All 2 branches missed.">        } else if (critRoll == 7) {</span>
            // gunners stunned
<span class="nc bnc" id="L32740" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32741">                gun.stunCrew();</span>
<span class="nc" id="L32742">                r = new Report(3810);</span>
<span class="nc" id="L32743">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32744">                r.indent(1);</span>
<span class="nc" id="L32745">                vDesc.add(r);</span>
<span class="nc" id="L32746">            }</span>
<span class="nc bnc" id="L32747" title="All 2 branches missed.">        } else if (critRoll == 8) {</span>
            // weapon destroyed
            // lets just randomly determine which weapon gets hit
<span class="nc" id="L32750">            Vector&lt;Mounted&gt; wpns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32751" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32752" title="All 2 branches missed.">                for (Mounted wpn : gun.getWeaponList()) {</span>
<span class="nc bnc" id="L32753" title="All 2 branches missed.">                    if (!wpn.isHit()) {</span>
<span class="nc" id="L32754">                        wpns.add(wpn);</span>
                    }
<span class="nc" id="L32756">                }</span>
<span class="nc" id="L32757">            }</span>
<span class="nc bnc" id="L32758" title="All 2 branches missed.">            if (wpns.size() &gt; 0) {</span>
<span class="nc" id="L32759">                Mounted weapon = wpns.elementAt(Compute.randomInt(wpns.size()));</span>
<span class="nc" id="L32760">                weapon.setHit(true);</span>
<span class="nc" id="L32761">                r = new Report(3840);</span>
<span class="nc" id="L32762">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32763">                r.indent(1);</span>
<span class="nc" id="L32764">                r.add(weapon.getDesc());</span>
<span class="nc" id="L32765">            } else {</span>
<span class="nc" id="L32766">                r = new Report(3841);</span>
<span class="nc" id="L32767">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32768">                r.indent(1);</span>
            }
<span class="nc" id="L32770">            vDesc.add(r);</span>
<span class="nc bnc" id="L32771" title="All 2 branches missed.">        } else if (critRoll == 9) {</span>
            // gunners killed
<span class="nc" id="L32773">            r = new Report(3815);</span>
<span class="nc" id="L32774">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32775">            r.indent(1);</span>
<span class="nc" id="L32776">            vDesc.add(r);</span>
<span class="nc bnc" id="L32777" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32778">                gun.getCrew().setDoomed(true);</span>
<span class="nc" id="L32779">            }</span>
<span class="nc bnc" id="L32780" title="All 2 branches missed.">        } else if (critRoll == 10) {</span>
<span class="nc bnc" id="L32781" title="All 2 branches missed.">            if (Compute.d6() &gt; 3) {</span>
                // turret lock
<span class="nc" id="L32783">                r = new Report(3820);</span>
<span class="nc" id="L32784">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32785">                r.indent(1);</span>
<span class="nc" id="L32786">                vDesc.add(r);</span>
<span class="nc bnc" id="L32787" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32788">                    gun.lockTurret(gun.getLocTurret());</span>
<span class="nc" id="L32789">                }</span>
            } else {
                // turret jam
<span class="nc" id="L32792">                r = new Report(3825);</span>
<span class="nc" id="L32793">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32794">                r.indent(1);</span>
<span class="nc" id="L32795">                vDesc.add(r);</span>
<span class="nc bnc" id="L32796" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32797" title="All 2 branches missed.">                    if (gun.isTurretEverJammed(gun.getLocTurret())) {</span>
<span class="nc" id="L32798">                        gun.lockTurret(gun.getLocTurret());</span>
                    } else {
<span class="nc" id="L32800">                        gun.jamTurret(gun.getLocTurret());</span>
                    }
<span class="nc" id="L32802">                }</span>
            }
<span class="nc bnc" id="L32804" title="All 2 branches missed.">        } else if (critRoll == 11) {</span>
<span class="nc" id="L32805">            r = new Report(3830);</span>
<span class="nc" id="L32806">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32807">            r.indent(1);</span>
<span class="nc" id="L32808">            r.add(bldg.getName());</span>
<span class="nc" id="L32809">            int boom = 0;</span>
<span class="nc bnc" id="L32810" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32811" title="All 2 branches missed.">                for (Mounted ammo : gun.getAmmo()) {</span>
<span class="nc" id="L32812">                    ammo.setHit(true);</span>
<span class="nc bnc" id="L32813" title="All 2 branches missed.">                    if (ammo.getType().isExplosive(ammo)) {</span>
<span class="nc" id="L32814">                        boom += ammo.getHittableShotsLeft()</span>
<span class="nc" id="L32815">                                * ((AmmoType) ammo.getType())</span>
<span class="nc" id="L32816">                                .getDamagePerShot()</span>
<span class="nc" id="L32817">                                * ((AmmoType) ammo.getType()).getRackSize();</span>
                    }
<span class="nc" id="L32819">                }</span>
<span class="nc" id="L32820">            }</span>
<span class="nc" id="L32821">            boom = (int) Math.floor(bldg.getDamageToScale() * boom);</span>
            
<span class="nc bnc" id="L32823" title="All 2 branches missed.">            if (boom == 0) {</span>
<span class="nc" id="L32824">                Report rNoAmmo = new Report(3831);</span>
<span class="nc" id="L32825">                rNoAmmo.type = Report.PUBLIC;</span>
<span class="nc" id="L32826">                rNoAmmo.indent(1);</span>
<span class="nc" id="L32827">                vDesc.add(rNoAmmo);</span>
<span class="nc" id="L32828">                return vDesc;</span>
            }
            
<span class="nc" id="L32831">            r.add(boom);</span>
<span class="nc" id="L32832">            int curCF = bldg.getCurrentCF(coords);</span>
<span class="nc" id="L32833">            curCF -= Math.min(curCF, boom);</span>
<span class="nc" id="L32834">            bldg.setCurrentCF(curCF, coords);</span>
<span class="nc" id="L32835">            r.add(bldg.getCurrentCF(coords));</span>
<span class="nc" id="L32836">            vDesc.add(r);</span>
            // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32838" title="All 4 branches missed.">            if ((curCF == 0) &amp;&amp; (bldg.getPhaseCF(coords) != 0)) {</span>
                
                // when a building collapses due to an ammo explosion, we can consider
                // that turret annihilated for the purposes of salvage.
<span class="nc bnc" id="L32842" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32843">                    vDesc.addAll(destroyEntity(gun, &quot;ammo explosion&quot;, false, false));</span>
<span class="nc" id="L32844">                }</span>
                
<span class="nc bnc" id="L32846" title="All 2 branches missed.">                if (bldg instanceof FuelTank) {</span>
                    // If this is a fuel tank, we'll give it its own
                    // message.
<span class="nc" id="L32849">                    r = new Report(3441);</span>
<span class="nc" id="L32850">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L32851">                    r.indent(0);</span>
<span class="nc" id="L32852">                    vDesc.add(r);</span>
                    // ...But we ALSO need to blow up everything nearby.
                    // Bwahahahahaha...
<span class="nc" id="L32855">                    r = new Report(3560);</span>
<span class="nc" id="L32856">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L32857">                    r.newlines = 1;</span>
<span class="nc" id="L32858">                    vDesc.add(r);</span>
<span class="nc" id="L32859">                    Vector&lt;Report&gt; vRep = new Vector&lt;&gt;();</span>
<span class="nc" id="L32860">                    doExplosion(((FuelTank) bldg).getMagnitude(), 10, false,</span>
<span class="nc" id="L32861">                                bldg.getCoords().nextElement(), true, vRep, null,</span>
                                -1);
<span class="nc" id="L32863">                    Report.indentAll(vRep, 2);</span>
<span class="nc" id="L32864">                    vDesc.addAll(vRep);</span>
<span class="nc" id="L32865">                    return vPhaseReport;</span>
                }
<span class="nc bnc" id="L32867" title="All 2 branches missed.">                if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L32868">                    r = new Report(3442);</span>
                } else {
<span class="nc" id="L32870">                    r = new Report(3440);</span>
                }
<span class="nc" id="L32872">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32873">                r.indent(0);</span>
<span class="nc" id="L32874">                vDesc.add(r);</span>
            }
<span class="nc bnc" id="L32876" title="All 2 branches missed.">        } else if (critRoll == 12) {</span>
            // non-weapon equipment is hit
<span class="nc" id="L32878">            Vector&lt;Mounted&gt; equipmentList = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32879" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32880" title="All 2 branches missed.">                for (Mounted equipment : gun.getMisc()) {</span>
<span class="nc bnc" id="L32881" title="All 2 branches missed.">                    if (!equipment.isHit()) {</span>
<span class="nc" id="L32882">                        equipmentList.add(equipment);</span>
                    }
<span class="nc" id="L32884">                }</span>
<span class="nc" id="L32885">            }</span>
            
<span class="nc bnc" id="L32887" title="All 2 branches missed.">            if (equipmentList.size() &gt; 0) {</span>
<span class="nc" id="L32888">                Mounted equipment = equipmentList.elementAt(Compute.randomInt(equipmentList.size()));</span>
<span class="nc" id="L32889">                equipment.setHit(true);</span>
<span class="nc" id="L32890">                r = new Report(3840);</span>
<span class="nc" id="L32891">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32892">                r.indent(1);</span>
<span class="nc" id="L32893">                r.add(equipment.getDesc());</span>
<span class="nc" id="L32894">            } else {</span>
<span class="nc" id="L32895">                r = new Report(3835);</span>
<span class="nc" id="L32896">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32897">                r.indent(1);</span>
            }
<span class="nc" id="L32899">            vDesc.add(r);</span>
        }

<span class="nc" id="L32902">        return vDesc;</span>
    }

    public void sendChangedBuildings(Vector&lt;Building&gt; buildings) {
<span class="nc" id="L32906">        send(createUpdateBuildingPacket(buildings));</span>
<span class="nc" id="L32907">    }</span>

    /**
     * Receives an packet to unload entity is stranded on immobile transports,
     * and queue all valid requests for execution. If all players that have
     * stranded entities have answered, executes the pending requests and end
     * the current turn.
     */
    private void receiveUnloadStranded(Packet packet, int connId) {
        GameTurn.UnloadStrandedTurn turn;
<span class="nc" id="L32917">        final IPlayer player = game.getPlayer(connId);</span>
<span class="nc" id="L32918">        int[] entityIds = (int[]) packet.getObject(0);</span>
        Vector&lt;IPlayer&gt; declared;
        IPlayer other;
        Enumeration&lt;EntityAction&gt; pending;
        UnloadStrandedAction action;
        Entity entity;

        // Is this the right phase?
<span class="nc bnc" id="L32926" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L32927">            MegaMek.getLogger().error(&quot;Server got unload stranded packet in wrong phase&quot;);</span>
<span class="nc" id="L32928">            return;</span>
        }

        // Are we in an &quot;unload stranded entities&quot; turn?
<span class="nc bnc" id="L32932" title="All 2 branches missed.">        if (game.getTurn() instanceof GameTurn.UnloadStrandedTurn) {</span>
<span class="nc" id="L32933">            turn = (GameTurn.UnloadStrandedTurn) game.getTurn();</span>
        } else {
<span class="nc" id="L32935">            MegaMek.getLogger().error(&quot;Server got unload stranded packet out of sequence&quot;);</span>
<span class="nc" id="L32936">            sendServerChat(player.getName() + &quot; should not be sending 'unload stranded entity' packets at this time.&quot;);</span>
<span class="nc" id="L32937">            return;</span>
        }

        // Can this player act right now?
<span class="nc bnc" id="L32941" title="All 2 branches missed.">        if (!turn.isValid(connId, game)) {</span>
<span class="nc" id="L32942">            MegaMek.getLogger().error(&quot;Server got unload stranded packet from invalid player&quot;);</span>
<span class="nc" id="L32943">            sendServerChat(player.getName() + &quot; should not be sending 'unload stranded entity' packets.&quot;);</span>
<span class="nc" id="L32944">            return;</span>
        }

        // Did the player already send an 'unload' request?
        // N.B. we're also building the list of players who
        // have declared their &quot;unload stranded&quot; actions.
<span class="nc" id="L32950">        declared = new Vector&lt;&gt;();</span>
<span class="nc" id="L32951">        pending = game.getActions();</span>
<span class="nc bnc" id="L32952" title="All 2 branches missed.">        while (pending.hasMoreElements()) {</span>
<span class="nc" id="L32953">            action = (UnloadStrandedAction) pending.nextElement();</span>
<span class="nc bnc" id="L32954" title="All 2 branches missed.">            if (action.getPlayerId() == connId) {</span>
<span class="nc" id="L32955">                MegaMek.getLogger().error(&quot;Server got multiple unload stranded packets from player&quot;);</span>
<span class="nc" id="L32956">                sendServerChat(player.getName() + &quot; should not send multiple 'unload stranded entity' packets.&quot;);</span>
<span class="nc" id="L32957">                return;</span>
            }
            // This player is not from the current connection.
            // Record this player to determine if this turn is done.
<span class="nc" id="L32961">            other = game.getPlayer(action.getPlayerId());</span>
<span class="nc bnc" id="L32962" title="All 2 branches missed.">            if (!declared.contains(other)) {</span>
<span class="nc" id="L32963">                declared.addElement(other);</span>
            }
        } // Handle the next &quot;unload stranded&quot; action.

        // Make sure the player selected at least *one* valid entity ID.
<span class="nc" id="L32968">        boolean foundValid = false;</span>
<span class="nc bnc" id="L32969" title="All 4 branches missed.">        for (int index = 0; (null != entityIds) &amp;&amp; (index &lt; entityIds.length); index++) {</span>
<span class="nc" id="L32970">            entity = game.getEntity(entityIds[index]);</span>
<span class="nc bnc" id="L32971" title="All 2 branches missed.">            if (!game.getTurn().isValid(connId, entity, game)) {</span>
<span class="nc" id="L32972">                MegaMek.getLogger().error(&quot;Server got unload stranded packet for invalid entity&quot;);</span>
<span class="nc" id="L32973">                StringBuilder message = new StringBuilder();</span>
<span class="nc" id="L32974">                message.append(player.getName()).append(&quot; can not unload stranded entity &quot;);</span>
<span class="nc bnc" id="L32975" title="All 2 branches missed.">                if (null == entity) {</span>
<span class="nc" id="L32976">                    message.append('#').append(entityIds[index]);</span>
                } else {
<span class="nc" id="L32978">                    message.append(entity.getDisplayName());</span>
                }
<span class="nc" id="L32980">                message.append(&quot; at this time.&quot;);</span>
<span class="nc" id="L32981">                sendServerChat(message.toString());</span>
<span class="nc" id="L32982">            } else {</span>
<span class="nc" id="L32983">                foundValid = true;</span>
<span class="nc" id="L32984">                game.addAction(new UnloadStrandedAction(connId, entityIds[index]));</span>
            }
        }

        // Did the player choose not to unload any valid stranded entity?
<span class="nc bnc" id="L32989" title="All 2 branches missed.">        if (!foundValid) {</span>
<span class="nc" id="L32990">            game.addAction(new UnloadStrandedAction(connId, Entity.NONE));</span>
        }

        // Either way, the connection's player has now declared.
<span class="nc" id="L32994">        declared.addElement(player);</span>

        // Are all players who are unloading entities done? Walk
        // through the turn's stranded entities, and look to see
        // if their player has finished their turn.
<span class="nc" id="L32999">        entityIds = turn.getEntityIds();</span>
<span class="nc bnc" id="L33000" title="All 2 branches missed.">        for (int entityId : entityIds) {</span>
<span class="nc" id="L33001">            entity = game.getEntity(entityId);</span>
<span class="nc" id="L33002">            other = entity.getOwner();</span>
<span class="nc bnc" id="L33003" title="All 2 branches missed.">            if (!declared.contains(other)) {</span>
                // At least one player still needs to declare.
<span class="nc" id="L33005">                return;</span>
            }
        }

        // All players have declared whether they're unloading stranded units.
        // Walk the list of pending actions and unload the entities.
<span class="nc" id="L33011">        pending = game.getActions();</span>
<span class="nc bnc" id="L33012" title="All 2 branches missed.">        while (pending.hasMoreElements()) {</span>
<span class="nc" id="L33013">            action = (UnloadStrandedAction) pending.nextElement();</span>

            // Some players don't want to unload any stranded units.
<span class="nc bnc" id="L33016" title="All 2 branches missed.">            if (Entity.NONE != action.getEntityId()) {</span>
<span class="nc" id="L33017">                entity = game.getEntity(action.getEntityId());</span>
<span class="nc bnc" id="L33018" title="All 2 branches missed.">                if (null == entity) {</span>
                    // After all this, we couldn't find the entity!!!
<span class="nc" id="L33020">                    MegaMek.getLogger().error(&quot;Server could not find stranded entity #&quot;</span>
<span class="nc" id="L33021">                            + action.getEntityId() + &quot; to unload!!!&quot;);</span>
                } else {
                    // Unload the entity. Get the unit's transporter.
<span class="nc" id="L33024">                    Entity transporter = game</span>
<span class="nc" id="L33025">                            .getEntity(entity.getTransportId());</span>
<span class="nc" id="L33026">                    unloadUnit(transporter, entity, transporter.getPosition(),</span>
<span class="nc" id="L33027">                               transporter.getFacing(), transporter.getElevation());</span>
<span class="nc" id="L33028">                }</span>
            }

        } // Handle the next pending unload action

        // Clear the list of pending units and move to the next turn.
<span class="nc" id="L33034">        game.resetActions();</span>
<span class="nc" id="L33035">        changeToNextTurn(connId);</span>
<span class="nc" id="L33036">    }</span>

    /**
     * For all current artillery attacks in the air from this entity with this
     * weapon, clear the list of spotters. Needed because firing another round
     * before first lands voids spotting.
     *
     * @param entityID the &lt;code&gt;int&lt;/code&gt; id of the entity
     * @param weaponID the &lt;code&gt;int&lt;/code&gt; id of the weapon
     */
    private void clearArtillerySpotters(int entityID, int weaponID) {
<span class="nc bnc" id="L33047" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; i = game.getAttacks(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L33048">            WeaponHandler wh = (WeaponHandler) i.nextElement();</span>
<span class="nc bnc" id="L33049" title="All 2 branches missed.">            if ((wh.waa instanceof ArtilleryAttackAction)</span>
<span class="nc bnc" id="L33050" title="All 2 branches missed.">                &amp;&amp; (wh.waa.getEntityId() == entityID)</span>
<span class="nc bnc" id="L33051" title="All 2 branches missed.">                &amp;&amp; (wh.waa.getWeaponId() == weaponID)) {</span>
<span class="nc" id="L33052">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc" id="L33053">                aaa.setSpotterIds(null);</span>
            }
<span class="nc" id="L33055">        }</span>
<span class="nc" id="L33056">    }</span>

    /**
     * Credits a Kill for an entity, if the target got killed.
     *
     * @param target   The &lt;code&gt;Entity&lt;/code&gt; that got killed.
     * @param attacker The &lt;code&gt;Entity&lt;/code&gt; that did the killing.
     */
    public void creditKill(Entity target, Entity attacker) {
        // Kills should be credited for each individual fighter, instead of the
        // squadron
<span class="nc bnc" id="L33067" title="All 2 branches missed.">        if (target instanceof FighterSquadron) {</span>
<span class="nc" id="L33068">            return;</span>
        }
        // If a squadron scores a kill, assign it randomly to one of the member fighters
<span class="nc bnc" id="L33071" title="All 2 branches missed.">        if (attacker instanceof FighterSquadron) {</span>
<span class="nc" id="L33072">            Entity killer = attacker.getLoadedUnits().get(Compute.randomInt(attacker.getLoadedUnits().size()));</span>
<span class="nc bnc" id="L33073" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L33074">                attacker = killer;</span>
            }
        }
<span class="nc bnc" id="L33077" title="All 4 branches missed.">        if ((target.isDoomed() || target.getCrew().isDoomed())</span>
<span class="nc bnc" id="L33078" title="All 4 branches missed.">            &amp;&amp; !target.getGaveKillCredit() &amp;&amp; (attacker != null)) {</span>
<span class="nc" id="L33079">            attacker.addKill(target);</span>
        }
<span class="nc" id="L33081">    }</span>

    /**
     * pre-treats a physical attack
     *
     * @param aaa The &lt;code&gt;AbstractAttackAction&lt;/code&gt; of the physical attack
     *            to pre-treat
     * @return The &lt;code&gt;PhysicalResult&lt;/code&gt; of that action, including
     * possible damage.
     */
    private PhysicalResult preTreatPhysicalAttack(AbstractAttackAction aaa) {
<span class="nc" id="L33092">        final Entity ae = game.getEntity(aaa.getEntityId());</span>
<span class="nc" id="L33093">        int damage = 0;</span>
<span class="nc" id="L33094">        PhysicalResult pr = new PhysicalResult();</span>
<span class="nc" id="L33095">        ToHitData toHit = new ToHitData();</span>
<span class="nc" id="L33096">        pr.roll = Compute.d6(2);</span>
<span class="nc" id="L33097">        pr.aaa = aaa;</span>
<span class="nc bnc" id="L33098" title="All 2 branches missed.">        if (aaa instanceof BrushOffAttackAction) {</span>
<span class="nc" id="L33099">            BrushOffAttackAction baa = (BrushOffAttackAction) aaa;</span>
<span class="nc" id="L33100">            int arm = baa.getArm();</span>
<span class="nc" id="L33101">            baa.setArm(BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33102">            toHit = BrushOffAttackAction.toHit(game, aaa.getEntityId(),</span>
<span class="nc" id="L33103">                    aaa.getTarget(game), BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33104">            baa.setArm(BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33105">            pr.toHitRight = BrushOffAttackAction.toHit(game, aaa.getEntityId(),</span>
<span class="nc" id="L33106">                    aaa.getTarget(game), BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33107">            damage = BrushOffAttackAction.getDamageFor(ae, BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33108">            pr.damageRight = BrushOffAttackAction.getDamageFor(ae, BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33109">            baa.setArm(arm);</span>
<span class="nc" id="L33110">            pr.rollRight = Compute.d6(2);</span>
<span class="nc bnc" id="L33111" title="All 2 branches missed.">        } else if (aaa instanceof ChargeAttackAction) {</span>
<span class="nc" id="L33112">            ChargeAttackAction caa = (ChargeAttackAction) aaa;</span>
<span class="nc" id="L33113">            toHit = caa.toHit(game);</span>
<span class="nc bnc" id="L33114" title="All 2 branches missed.">            if (caa.getTarget(game) instanceof Entity) {</span>
<span class="nc" id="L33115">                Entity target = (Entity) caa.getTarget(game);</span>
<span class="nc" id="L33116">                damage = ChargeAttackAction.getDamageFor(ae, target,</span>
<span class="nc" id="L33117">                        game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
<span class="nc" id="L33118">                        toHit.getMoS());</span>
<span class="nc" id="L33119">            } else {</span>
<span class="nc" id="L33120">                damage = ChargeAttackAction.getDamageFor(ae);</span>
            }
<span class="nc bnc" id="L33122" title="All 2 branches missed.">        } else if (aaa instanceof AirmechRamAttackAction) {</span>
<span class="nc" id="L33123">            AirmechRamAttackAction raa = (AirmechRamAttackAction) aaa;</span>
<span class="nc" id="L33124">            toHit = raa.toHit(game);</span>
<span class="nc" id="L33125">            damage = AirmechRamAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33126" title="All 2 branches missed.">        } else if (aaa instanceof ClubAttackAction) {</span>
<span class="nc" id="L33127">            ClubAttackAction caa = (ClubAttackAction) aaa;</span>
<span class="nc" id="L33128">            toHit = caa.toHit(game);</span>
<span class="nc" id="L33129">            damage = ClubAttackAction.getDamageFor(ae, caa.getClub(),</span>
<span class="nc" id="L33130">                    caa.getTarget(game).isConventionalInfantry(), caa.isZweihandering());</span>
<span class="nc bnc" id="L33131" title="All 2 branches missed.">            if (caa.getTargetType() == Targetable.TYPE_BUILDING) {</span>
<span class="nc" id="L33132">                EquipmentType clubType = caa.getClub().getType();</span>
<span class="nc bnc" id="L33133" title="All 2 branches missed.">                if (clubType.hasSubType(MiscType.S_BACKHOE)</span>
<span class="nc bnc" id="L33134" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_CHAINSAW)</span>
<span class="nc bnc" id="L33135" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_MINING_DRILL)</span>
<span class="nc bnc" id="L33136" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_PILE_DRIVER)) {</span>
<span class="nc" id="L33137">                    damage += Compute.d6(1);</span>
<span class="nc bnc" id="L33138" title="All 2 branches missed.">                } else if (clubType.hasSubType(MiscType.S_DUAL_SAW)) {</span>
<span class="nc" id="L33139">                    damage += Compute.d6(2);</span>
<span class="nc bnc" id="L33140" title="All 2 branches missed.">                } else if (clubType.hasSubType(MiscType.S_ROCK_CUTTER)) {</span>
<span class="nc" id="L33141">                    damage += Compute.d6(3);</span>
                }
<span class="nc bnc" id="L33143" title="All 2 branches missed.">                else if (clubType.hasSubType(MiscType.S_WRECKING_BALL)) {</span>
<span class="nc" id="L33144">                    damage += Compute.d6(4);</span>
                }
            }
<span class="nc bnc" id="L33147" title="All 2 branches missed.">        } else if (aaa instanceof DfaAttackAction) {</span>
<span class="nc" id="L33148">            DfaAttackAction daa = (DfaAttackAction) aaa;</span>
<span class="nc" id="L33149">            toHit = daa.toHit(game);</span>
<span class="nc" id="L33150">            damage = DfaAttackAction.getDamageFor(ae, daa.getTarget(game).isConventionalInfantry());</span>
<span class="nc bnc" id="L33151" title="All 2 branches missed.">        } else if (aaa instanceof KickAttackAction) {</span>
<span class="nc" id="L33152">            KickAttackAction kaa = (KickAttackAction) aaa;</span>
<span class="nc" id="L33153">            toHit = kaa.toHit(game);</span>
<span class="nc" id="L33154">            damage = KickAttackAction.getDamageFor(ae, kaa.getLeg(),</span>
<span class="nc" id="L33155">                    kaa.getTarget(game).isConventionalInfantry());</span>
<span class="nc bnc" id="L33156" title="All 2 branches missed.">        } else if (aaa instanceof ProtomechPhysicalAttackAction) {</span>
<span class="nc" id="L33157">            ProtomechPhysicalAttackAction paa = (ProtomechPhysicalAttackAction) aaa;</span>
<span class="nc" id="L33158">            toHit = paa.toHit(game);</span>
<span class="nc" id="L33159">            damage = ProtomechPhysicalAttackAction.getDamageFor(ae, paa.getTarget(game));</span>
<span class="nc bnc" id="L33160" title="All 2 branches missed.">        } else if (aaa instanceof PunchAttackAction) {</span>
<span class="nc" id="L33161">            PunchAttackAction paa = (PunchAttackAction) aaa;</span>
<span class="nc" id="L33162">            int arm = paa.getArm();</span>
            int damageRight;
<span class="nc" id="L33164">            paa.setArm(PunchAttackAction.LEFT);</span>
<span class="nc" id="L33165">            toHit = paa.toHit(game);</span>
<span class="nc" id="L33166">            paa.setArm(PunchAttackAction.RIGHT);</span>
<span class="nc" id="L33167">            ToHitData toHitRight = paa.toHit(game);</span>
<span class="nc" id="L33168">            damage = PunchAttackAction.getDamageFor(ae, PunchAttackAction.LEFT,</span>
<span class="nc" id="L33169">                    paa.getTarget(game).isConventionalInfantry(), paa.isZweihandering());</span>
<span class="nc" id="L33170">            damageRight = PunchAttackAction.getDamageFor(ae, PunchAttackAction.RIGHT,</span>
<span class="nc" id="L33171">                    paa.getTarget(game).isConventionalInfantry(), paa.isZweihandering());</span>
<span class="nc" id="L33172">            paa.setArm(arm);</span>
            // If we're punching while prone (at a Tank,
            // duh), then we can only use one arm.
<span class="nc bnc" id="L33175" title="All 2 branches missed.">            if (ae.isProne()) {</span>
<span class="nc" id="L33176">                double oddsLeft = Compute.oddsAbove(toHit.getValue(),</span>
<span class="nc" id="L33177">                        ae.hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING));</span>
<span class="nc" id="L33178">                double oddsRight = Compute.oddsAbove(toHitRight.getValue(),</span>
<span class="nc" id="L33179">                        ae.hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING));</span>
                // Use the best attack.
<span class="nc bnc" id="L33181" title="All 2 branches missed.">                if ((oddsLeft * damage) &gt; (oddsRight * damageRight)) {</span>
<span class="nc" id="L33182">                    paa.setArm(PunchAttackAction.LEFT);</span>
                } else {
<span class="nc" id="L33184">                    paa.setArm(PunchAttackAction.RIGHT);</span>
                }
            }
<span class="nc" id="L33187">            pr.damageRight = damageRight;</span>
<span class="nc" id="L33188">            pr.toHitRight = toHitRight;</span>
<span class="nc" id="L33189">            pr.rollRight = Compute.d6(2);</span>
<span class="nc bnc" id="L33190" title="All 2 branches missed.">        } else if (aaa instanceof PushAttackAction) {</span>
<span class="nc" id="L33191">            PushAttackAction paa = (PushAttackAction) aaa;</span>
<span class="nc" id="L33192">            toHit = paa.toHit(game);</span>
<span class="nc bnc" id="L33193" title="All 2 branches missed.">        } else if (aaa instanceof TripAttackAction) {</span>
<span class="nc" id="L33194">            TripAttackAction paa = (TripAttackAction) aaa;</span>
<span class="nc" id="L33195">            toHit = paa.toHit(game);</span>
<span class="nc bnc" id="L33196" title="All 2 branches missed.">        } else if (aaa instanceof LayExplosivesAttackAction) {</span>
<span class="nc" id="L33197">            LayExplosivesAttackAction leaa = (LayExplosivesAttackAction) aaa;</span>
<span class="nc" id="L33198">            toHit = leaa.toHit(game);</span>
<span class="nc" id="L33199">            damage = LayExplosivesAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33200" title="All 2 branches missed.">        } else if (aaa instanceof ThrashAttackAction) {</span>
<span class="nc" id="L33201">            ThrashAttackAction taa = (ThrashAttackAction) aaa;</span>
<span class="nc" id="L33202">            toHit = taa.toHit(game);</span>
<span class="nc" id="L33203">            damage = ThrashAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33204" title="All 2 branches missed.">        } else if (aaa instanceof JumpJetAttackAction) {</span>
<span class="nc" id="L33205">            JumpJetAttackAction jaa = (JumpJetAttackAction) aaa;</span>
<span class="nc" id="L33206">            toHit = jaa.toHit(game);</span>
<span class="nc bnc" id="L33207" title="All 2 branches missed.">            if (jaa.getLeg() == JumpJetAttackAction.BOTH) {</span>
<span class="nc" id="L33208">                damage = JumpJetAttackAction.getDamageFor(ae, JumpJetAttackAction.LEFT);</span>
<span class="nc" id="L33209">                pr.damageRight = JumpJetAttackAction.getDamageFor(ae, JumpJetAttackAction.LEFT);</span>
            } else {
<span class="nc" id="L33211">                damage = JumpJetAttackAction.getDamageFor(ae, jaa.getLeg());</span>
<span class="nc" id="L33212">                pr.damageRight = 0;</span>
            }
<span class="nc" id="L33214">            ae.heatBuildup += (damage + pr.damageRight) / 3;</span>
<span class="nc bnc" id="L33215" title="All 2 branches missed.">        } else if (aaa instanceof GrappleAttackAction) {</span>
<span class="nc" id="L33216">            GrappleAttackAction taa = (GrappleAttackAction) aaa;</span>
<span class="nc" id="L33217">            toHit = taa.toHit(game);</span>
<span class="nc bnc" id="L33218" title="All 2 branches missed.">        } else if (aaa instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L33219">            BreakGrappleAttackAction taa = (BreakGrappleAttackAction) aaa;</span>
<span class="nc" id="L33220">            toHit = taa.toHit(game);</span>
<span class="nc bnc" id="L33221" title="All 2 branches missed.">        } else if (aaa instanceof RamAttackAction) {</span>
<span class="nc" id="L33222">            RamAttackAction raa = (RamAttackAction) aaa;</span>
<span class="nc" id="L33223">            toHit = raa.toHit(game);</span>
<span class="nc" id="L33224">            damage = RamAttackAction.getDamageFor((IAero) ae, (Entity) aaa.getTarget(game));</span>
<span class="nc bnc" id="L33225" title="All 2 branches missed.">        } else if (aaa instanceof TeleMissileAttackAction) {</span>
<span class="nc" id="L33226">            TeleMissileAttackAction taa = (TeleMissileAttackAction) aaa;</span>
<span class="nc" id="L33227">            assignTeleMissileAMS(taa);</span>
<span class="nc" id="L33228">            taa.calcCounterAV(game, taa.getTarget(game));</span>
<span class="nc" id="L33229">            toHit = taa.toHit(game);</span>
<span class="nc" id="L33230">            damage = TeleMissileAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33231" title="All 2 branches missed.">        } else if (aaa instanceof BAVibroClawAttackAction) {</span>
<span class="nc" id="L33232">            BAVibroClawAttackAction bvca = (BAVibroClawAttackAction) aaa;</span>
<span class="nc" id="L33233">            toHit = bvca.toHit(game);</span>
<span class="nc" id="L33234">            damage = BAVibroClawAttackAction.getDamageFor(ae);</span>
        }
<span class="nc" id="L33236">        pr.toHit = toHit;</span>
<span class="nc" id="L33237">        pr.damage = damage;</span>
<span class="nc" id="L33238">        return pr;</span>
    }

    /**
     * Resolve a Physical Attack
     *
     * @param pr  The &lt;code&gt;PhysicalResult&lt;/code&gt; of the physical attack
     * @param cen The &lt;code&gt;int&lt;/code&gt; Entity Id of the entity whose physical
     *            attack was last resolved
     */
    private void resolvePhysicalAttack(PhysicalResult pr, int cen) {
<span class="nc" id="L33249">        AbstractAttackAction aaa = pr.aaa;</span>
<span class="nc bnc" id="L33250" title="All 2 branches missed.">        if (aaa instanceof PunchAttackAction) {</span>
<span class="nc" id="L33251">            PunchAttackAction paa = (PunchAttackAction) aaa;</span>
<span class="nc bnc" id="L33252" title="All 2 branches missed.">            if (paa.getArm() == PunchAttackAction.BOTH) {</span>
<span class="nc" id="L33253">                paa.setArm(PunchAttackAction.LEFT);</span>
<span class="nc" id="L33254">                pr.aaa = paa;</span>
<span class="nc" id="L33255">                resolvePunchAttack(pr, cen);</span>
<span class="nc" id="L33256">                cen = paa.getEntityId();</span>
<span class="nc" id="L33257">                paa.setArm(PunchAttackAction.RIGHT);</span>
<span class="nc" id="L33258">                pr.aaa = paa;</span>
<span class="nc" id="L33259">                resolvePunchAttack(pr, cen);</span>
            } else {
<span class="nc" id="L33261">                resolvePunchAttack(pr, cen);</span>
<span class="nc" id="L33262">                cen = paa.getEntityId();</span>
            }
<span class="nc bnc" id="L33264" title="All 2 branches missed.">        } else if (aaa instanceof KickAttackAction) {</span>
<span class="nc" id="L33265">            resolveKickAttack(pr, cen);</span>
<span class="nc" id="L33266">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33267" title="All 2 branches missed.">        } else if (aaa instanceof BrushOffAttackAction) {</span>
<span class="nc" id="L33268">            BrushOffAttackAction baa = (BrushOffAttackAction) aaa;</span>
<span class="nc bnc" id="L33269" title="All 2 branches missed.">            if (baa.getArm() == BrushOffAttackAction.BOTH) {</span>
<span class="nc" id="L33270">                baa.setArm(BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33271">                pr.aaa = baa;</span>
<span class="nc" id="L33272">                resolveBrushOffAttack(pr, cen);</span>
<span class="nc" id="L33273">                cen = baa.getEntityId();</span>
<span class="nc" id="L33274">                baa.setArm(BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33275">                pr.aaa = baa;</span>
<span class="nc" id="L33276">                resolveBrushOffAttack(pr, cen);</span>
            } else {
<span class="nc" id="L33278">                resolveBrushOffAttack(pr, cen);</span>
<span class="nc" id="L33279">                cen = baa.getEntityId();</span>
            }
<span class="nc bnc" id="L33281" title="All 2 branches missed.">        } else if (aaa instanceof ThrashAttackAction) {</span>
<span class="nc" id="L33282">            resolveThrashAttack(pr, cen);</span>
<span class="nc" id="L33283">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33284" title="All 2 branches missed.">        } else if (aaa instanceof ProtomechPhysicalAttackAction) {</span>
<span class="nc" id="L33285">            resolveProtoAttack(pr, cen);</span>
<span class="nc" id="L33286">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33287" title="All 2 branches missed.">        } else if (aaa instanceof ClubAttackAction) {</span>
<span class="nc" id="L33288">            resolveClubAttack(pr, cen);</span>
<span class="nc" id="L33289">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33290" title="All 2 branches missed.">        } else if (aaa instanceof PushAttackAction) {</span>
<span class="nc" id="L33291">            resolvePushAttack(pr, cen);</span>
<span class="nc" id="L33292">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33293" title="All 2 branches missed.">        } else if (aaa instanceof ChargeAttackAction) {</span>
<span class="nc" id="L33294">            resolveChargeAttack(pr, cen);</span>
<span class="nc" id="L33295">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33296" title="All 2 branches missed.">        } else if (aaa instanceof AirmechRamAttackAction) {</span>
<span class="nc" id="L33297">            resolveAirmechRamAttack(pr, cen);</span>
<span class="nc" id="L33298">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33299" title="All 2 branches missed.">        } else if (aaa instanceof DfaAttackAction) {</span>
<span class="nc" id="L33300">            resolveDfaAttack(pr, cen);</span>
<span class="nc" id="L33301">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33302" title="All 2 branches missed.">        } else if (aaa instanceof LayExplosivesAttackAction) {</span>
<span class="nc" id="L33303">            resolveLayExplosivesAttack(pr);</span>
<span class="nc" id="L33304">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33305" title="All 2 branches missed.">        } else if (aaa instanceof TripAttackAction) {</span>
<span class="nc" id="L33306">            resolveTripAttack(pr, cen);</span>
<span class="nc" id="L33307">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33308" title="All 2 branches missed.">        } else if (aaa instanceof JumpJetAttackAction) {</span>
<span class="nc" id="L33309">            resolveJumpJetAttack(pr, cen);</span>
<span class="nc" id="L33310">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33311" title="All 2 branches missed.">        } else if (aaa instanceof GrappleAttackAction) {</span>
<span class="nc" id="L33312">            resolveGrappleAttack(pr, cen);</span>
<span class="nc" id="L33313">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33314" title="All 2 branches missed.">        } else if (aaa instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L33315">            resolveBreakGrappleAttack(pr, cen);</span>
<span class="nc" id="L33316">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33317" title="All 2 branches missed.">        } else if (aaa instanceof RamAttackAction) {</span>
<span class="nc" id="L33318">            resolveRamAttack(pr, cen);</span>
<span class="nc" id="L33319">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33320" title="All 2 branches missed.">        } else if (aaa instanceof TeleMissileAttackAction) {</span>
<span class="nc" id="L33321">            resolveTeleMissileAttack(pr, cen);</span>
<span class="nc" id="L33322">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33323" title="All 2 branches missed.">        } else if (aaa instanceof BAVibroClawAttackAction) {</span>
<span class="nc" id="L33324">            resolveBAVibroClawAttack(pr, cen);</span>
<span class="nc" id="L33325">            cen = aaa.getEntityId();</span>
        } else {
<span class="nc" id="L33327">            MegaMek.getLogger().error(&quot;Unknown attack action declared.&quot;);</span>
        }
        // Not all targets are Entities.
<span class="nc" id="L33330">        Targetable target = game.getTarget(aaa.getTargetType(), aaa.getTargetId());</span>
<span class="nc bnc" id="L33331" title="All 2 branches missed.">        if (target instanceof Entity) {</span>
<span class="nc" id="L33332">            Entity targetEntity = (Entity) target;</span>
<span class="nc" id="L33333">            targetEntity.setStruck(true);</span>
<span class="nc" id="L33334">            targetEntity.addAttackedByThisTurn(target.getTargetId());</span>
<span class="nc" id="L33335">            creditKill(targetEntity, game.getEntity(cen));</span>
        }
<span class="nc" id="L33337">    }</span>

    /**
     * Add any extreme gravity PSRs the entity gets due to its movement
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; to check.
     * @param step
     *            The last &lt;code&gt;MoveStep&lt;/code&gt; of this entity
     * @param moveType
     *            The movement type for the MovePath the supplied MoveStep comes
     *            from. This generally comes from the last step in the move
     *            path.
     * @param curPos
     *            The current &lt;code&gt;Coords&lt;/code&gt; of this entity
     * @param cachedMaxMPExpenditure
     *            Server checks run/jump MP at start of move, as appropriate,
     *            caches to avoid mid-move change in MP causing erroneous grav
     *            check
     */
    private void checkExtremeGravityMovement(Entity entity, MoveStep step,
                                             EntityMovementType moveType, Coords curPos,
                                             int cachedMaxMPExpenditure) {
        PilotingRollData rollTarget;
<span class="nc bnc" id="L33361" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getGravity() != 1) {</span>
<span class="nc bnc" id="L33362" title="All 4 branches missed.">            if ((entity instanceof Mech) || (entity instanceof Tank)) {</span>
<span class="nc bnc" id="L33363" title="All 12 branches missed.">                if ((moveType == EntityMovementType.MOVE_WALK)</span>
                        || (moveType == EntityMovementType.MOVE_VTOL_WALK)
                        || (moveType == EntityMovementType.MOVE_RUN)
                        || (moveType == EntityMovementType.MOVE_SPRINT)
                        || (moveType == EntityMovementType.MOVE_VTOL_RUN)
                        || (moveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L33369">                    int limit = cachedMaxMPExpenditure;</span>
<span class="nc bnc" id="L33370" title="All 4 branches missed.">                    if (step.isOnlyPavement() &amp;&amp; entity.isEligibleForPavementBonus()) {</span>
<span class="nc" id="L33371">                        limit++;</span>
                    }
<span class="nc bnc" id="L33373" title="All 2 branches missed.">                    if (step.getMpUsed() &gt; limit) {</span>
                        // We moved too fast, let's make PSR to see if we get
                        // damage
<span class="nc" id="L33376">                        game.addExtremeGravityPSR(entity.checkMovedTooFast(</span>
                                step, moveType));
                    }
<span class="nc bnc" id="L33379" title="All 2 branches missed.">                } else if (moveType == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L33380">                    MegaMek.getLogger().debug(&quot;Gravity move check jump: &quot; </span>
<span class="nc" id="L33381">                            + step.getMpUsed() + &quot;/&quot; + cachedMaxMPExpenditure);</span>
<span class="nc" id="L33382">                    int origWalkMP = entity.getWalkMP(false, false);</span>
<span class="nc" id="L33383">                    int gravWalkMP = entity.getWalkMP();</span>
<span class="nc bnc" id="L33384" title="All 2 branches missed.">                    if (step.getMpUsed() &gt; cachedMaxMPExpenditure) {</span>
                        // Jumped too far, make PSR to see if we get damaged
<span class="nc" id="L33386">                        game.addExtremeGravityPSR(entity.checkMovedTooFast(</span>
                                step, moveType));
<span class="nc bnc" id="L33388" title="All 4 branches missed.">                    } else if ((game.getPlanetaryConditions().getGravity() &gt; 1)</span>
                            &amp;&amp; ((origWalkMP - gravWalkMP) &gt; 0)) {
                        // jumping in high g is bad for your legs
                        // Damage dealt = 1 pt for each MP lost due to gravity
                        // Ignore this if no damage would be dealt
<span class="nc" id="L33393">                        rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L33394">                        entity.addPilotingModifierForTerrain(rollTarget, step);</span>
<span class="nc" id="L33395">                        int gravMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L33396">                                .getGravityPilotPenalty();</span>
<span class="nc bnc" id="L33397" title="All 4 branches missed.">                        if ((gravMod != 0) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L33398">                            rollTarget.addModifier(gravMod, game</span>
<span class="nc" id="L33399">                                    .getPlanetaryConditions().getGravity()</span>
                                    + &quot;G gravity&quot;);
                        }
<span class="nc" id="L33402">                        rollTarget.append(new PilotingRollData(entity.getId(),</span>
                                0, &quot;jumped in high gravity&quot;));
<span class="nc" id="L33404">                        game.addExtremeGravityPSR(rollTarget);</span>
                    }
                }
            }
        }
<span class="nc" id="L33409">    }</span>

    /**
     * Damage the inner structure of a mech's leg / a tank's front. This only
     * happens when the Entity fails an extreme Gravity PSR.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; to damage.
     * @param damage The &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    private Vector&lt;Report&gt; doExtremeGravityDamage(Entity entity, int damage) {
<span class="nc" id="L33419">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        HitData hit;
<span class="nc bnc" id="L33421" title="All 2 branches missed.">        if (entity instanceof BipedMech) {</span>
<span class="nc bnc" id="L33422" title="All 2 branches missed.">            for (int i = 6; i &lt;= 7; i++) {</span>
<span class="nc" id="L33423">                hit = new HitData(i);</span>
<span class="nc" id="L33424">                vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                        DamageType.NONE, true));
            }
        }
<span class="nc bnc" id="L33428" title="All 2 branches missed.">        if (entity instanceof QuadMech) {</span>
<span class="nc bnc" id="L33429" title="All 2 branches missed.">            for (int i = 4; i &lt;= 7; i++) {</span>
<span class="nc" id="L33430">                hit = new HitData(i);</span>
<span class="nc" id="L33431">                vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                        DamageType.NONE, true));
            }
<span class="nc bnc" id="L33434" title="All 2 branches missed.">        } else if (entity instanceof Tank) {</span>
<span class="nc" id="L33435">            hit = new HitData(Tank.LOC_FRONT);</span>
<span class="nc" id="L33436">            vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                    DamageType.NONE, true));
<span class="nc" id="L33438">            vPhaseReport.addAll(vehicleMotiveDamage((Tank)entity, 0));</span>
        }
<span class="nc" id="L33440">        return vPhaseReport;</span>
    }

    /**
     * Eject an Entity.
     *
     * @param entity    The &lt;code&gt;Entity&lt;/code&gt; to eject.
     * @param autoEject The &lt;code&gt;boolean&lt;/code&gt; state of the entity's auto- ejection
     *                  system
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; ejectEntity(Entity entity, boolean autoEject) {
<span class="nc" id="L33452">        return ejectEntity(entity, autoEject, false);</span>
    }

    /**
     * Eject an Entity.
     *
     * @param entity            The &lt;code&gt;Entity&lt;/code&gt; to eject.
     * @param autoEject         The &lt;code&gt;boolean&lt;/code&gt; state of the entity's auto- ejection
     *                          system
     * @param skin_of_the_teeth Perform a skin of the teeth ejection
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; ejectEntity(Entity entity, boolean autoEject,
                                      boolean skin_of_the_teeth) {
<span class="nc" id="L33466">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L33470" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L33471">            return vDesc;</span>
        }

        // If the crew are already dead, don't bother
<span class="nc bnc" id="L33475" title="All 2 branches missed.">        if (entity.isCarcass()) {</span>
<span class="nc" id="L33476">            return vDesc;</span>
        }

        // Mek and fighter pilots may get hurt during ejection,
        // and run around the board afterwards.
<span class="nc bnc" id="L33481" title="All 4 branches missed.">        if (entity instanceof Mech || entity.isFighter()) {</span>
<span class="nc" id="L33482">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L33483" title="All 2 branches missed.">            Coords targetCoords = (null != entity.getPosition())</span>
<span class="nc" id="L33484">                ? entity.getPosition().translated((facing + 3) % 6) : null;</span>
<span class="nc bnc" id="L33485" title="All 4 branches missed.">            if (entity.isSpaceborne() &amp;&amp; entity.getPosition() != null) {</span>
                //Pilots in space should eject into the fighter's hex, not behind it
<span class="nc" id="L33487">                targetCoords = entity.getPosition();</span>
            }

<span class="nc bnc" id="L33490" title="All 2 branches missed.">            if (autoEject) {</span>
<span class="nc" id="L33491">                r = new Report(6395);</span>
<span class="nc" id="L33492">                r.subject = entity.getId();</span>
<span class="nc" id="L33493">                r.addDesc(entity);</span>
<span class="nc" id="L33494">                r.indent(2);</span>
<span class="nc" id="L33495">                vDesc.addElement(r);</span>
            }

            // okay, print the info
<span class="nc" id="L33499">            PilotingRollData rollTarget = getEjectModifiers(game, entity,</span>
<span class="nc" id="L33500">                    entity.getCrew().getCurrentPilotIndex(), autoEject);</span>
<span class="nc" id="L33501">            r = new Report(2180);</span>
<span class="nc" id="L33502">            r.subject = entity.getId();</span>
<span class="nc" id="L33503">            r.addDesc(entity);</span>
<span class="nc" id="L33504">            r.add(rollTarget.getLastPlainDesc(), true);</span>
<span class="nc" id="L33505">            r.indent();</span>
<span class="nc" id="L33506">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L33507" title="All 2 branches missed.">            for (int crewPos = 0; crewPos &lt; entity.getCrew().getSlotCount(); crewPos++) {</span>
<span class="nc bnc" id="L33508" title="All 2 branches missed.">                if (entity.getCrew().isMissing(crewPos)) {</span>
<span class="nc" id="L33509">                    continue;</span>
                }
<span class="nc" id="L33511">                rollTarget = getEjectModifiers(game, entity, crewPos,</span>
                        autoEject);
                // roll
<span class="nc" id="L33514">                final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc bnc" id="L33515" title="All 2 branches missed.">                if (entity.getCrew().getSlotCount() &gt; 1) {</span>
<span class="nc" id="L33516">                    r = new Report(2193);</span>
<span class="nc" id="L33517">                    r.add(entity.getCrew().getNameAndRole(crewPos));</span>
                } else {
<span class="nc" id="L33519">                    r = new Report(2190);</span>
                }
<span class="nc" id="L33521">                r.subject = entity.getId();</span>
<span class="nc" id="L33522">                r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L33523">                r.add(rollTarget.getDesc());</span>
<span class="nc" id="L33524">                r.add(diceRoll);</span>
<span class="nc" id="L33525">                r.indent();</span>
<span class="nc bnc" id="L33526" title="All 2 branches missed.">                if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L33527">                    r.choose(false);</span>
<span class="nc" id="L33528">                    vDesc.addElement(r);</span>
<span class="nc" id="L33529">                    Report.addNewline(vDesc);</span>
<span class="nc bnc" id="L33530" title="All 2 branches missed.">                    if ((rollTarget.getValue() - diceRoll) &gt; 1) {</span>
                        // Pilots take damage based on ejection roll MoF
<span class="nc" id="L33532">                        int damage = (rollTarget.getValue() - diceRoll);</span>
<span class="nc bnc" id="L33533" title="All 2 branches missed.">                        if (entity instanceof Mech) {</span>
                            // MechWarriors only take 1 damage per 2 points of MoF
<span class="nc" id="L33535">                            damage /= 2;</span>
                        }
<span class="nc bnc" id="L33537" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_DIFFICULT_EJECT)) {</span>
<span class="nc" id="L33538">                            damage++;</span>
                        }
<span class="nc" id="L33540">                        vDesc.addAll(damageCrew(entity, damage, crewPos));</span>
                    }

                    // If this is a skin of the teeth ejection...
<span class="nc bnc" id="L33544" title="All 4 branches missed.">                    if (skin_of_the_teeth &amp;&amp; (entity.getCrew().getHits(crewPos) &lt; 6)) {</span>
<span class="nc" id="L33545">                        Report.addNewline(vDesc);</span>
<span class="nc" id="L33546">                        vDesc.addAll(damageCrew(entity, 6 - entity.getCrew()</span>
<span class="nc" id="L33547">                                                                .getHits(crewPos)));</span>
                    }
                } else {
<span class="nc" id="L33550">                    r.choose(true);</span>
<span class="nc" id="L33551">                    vDesc.addElement(r);</span>
                }
            }
            // create the MechWarrior in any case, for campaign tracking
<span class="nc" id="L33555">            MechWarrior pilot = new MechWarrior(entity);</span>
<span class="nc" id="L33556">            pilot.setDeployed(true);</span>
<span class="nc" id="L33557">            pilot.setId(getFreeEntityId());</span>
<span class="nc" id="L33558">            pilot.setLanded(false);</span>
<span class="nc bnc" id="L33559" title="All 2 branches missed.">            if (entity.isSpaceborne()) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L33561">                pilot.setVectors(entity.getVectors());</span>
<span class="nc" id="L33562">                pilot.setFacing(entity.getFacing());</span>
<span class="nc" id="L33563">                pilot.setCurrentVelocity(entity.getVelocity());</span>
                //If the pilot ejects, he should no longer be accelerating
<span class="nc" id="L33565">                pilot.setNextVelocity(entity.getVelocity());</span>
<span class="nc bnc" id="L33566" title="All 2 branches missed.">            } else if (entity.isAirborne()) {</span>
<span class="nc" id="L33567">                pilot.setAltitude(entity.getAltitude());</span>
            }
            //Pilot flight suits are vacuum-rated. MechWarriors wear shorts...
<span class="nc" id="L33570">            pilot.setSpaceSuit(entity.isAero());</span>
<span class="nc" id="L33571">            game.addEntity(pilot);</span>
<span class="nc" id="L33572">            send(createAddEntityPacket(pilot.getId()));</span>
            // make him not get a move this turn
<span class="nc" id="L33574">            pilot.setDone(true);</span>
<span class="nc" id="L33575">            int living = 0;</span>
<span class="nc bnc" id="L33576" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L33577" title="All 4 branches missed.">                if (!entity.getCrew().isDead(i) &amp;&amp; entity.getCrew().getHits(i) &lt; Crew.DEATH) {</span>
<span class="nc" id="L33578">                    living++;</span>
                }
            }
<span class="nc" id="L33581">            pilot.setInternal(living, MechWarrior.LOC_INFANTRY);</span>
<span class="nc bnc" id="L33582" title="All 4 branches missed.">            if (entity.getCrew().isDead() || entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
<span class="nc" id="L33583">                pilot.setDoomed(true);</span>
            }

<span class="nc bnc" id="L33586" title="All 2 branches missed.">            if (entity.getCrew().isDoomed()) {</span>
<span class="nc" id="L33587">                vDesc.addAll(destroyEntity(pilot, &quot;deadly ejection&quot;, false,</span>
                                           false));
            } else {
                // Add the pilot as an infantry unit on the battlefield.
<span class="nc bnc" id="L33591" title="All 2 branches missed.">                if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L33592">                    pilot.setPosition(targetCoords);</span>
                    // report safe ejection
<span class="nc" id="L33594">                    r = new Report(6400);</span>
<span class="nc" id="L33595">                    r.subject = entity.getId();</span>
<span class="nc" id="L33596">                    r.indent(3);</span>
<span class="nc" id="L33597">                    vDesc.addElement(r);</span>
                    // Update the entity
<span class="nc" id="L33599">                    entityUpdate(pilot.getId());</span>
                    // check if the pilot lands in a minefield
<span class="nc bnc" id="L33601" title="All 2 branches missed.">                    if (!entity.isAirborne()) {</span>
<span class="nc" id="L33602">                        vDesc.addAll(doEntityDisplacementMinefieldCheck(pilot,</span>
<span class="nc" id="L33603">                                entity.getPosition(), targetCoords,</span>
<span class="nc" id="L33604">                                entity.getElevation()));</span>
                    }
                } else {
                    // ejects safely
<span class="nc" id="L33608">                    r = new Report(6410);</span>
<span class="nc" id="L33609">                    r.subject = entity.getId();</span>
<span class="nc" id="L33610">                    r.indent(3);</span>
<span class="nc" id="L33611">                    vDesc.addElement(r);</span>
<span class="nc" id="L33612">                    game.removeEntity(pilot.getId(),</span>
                                      IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L33614">                    send(createRemoveEntityPacket(pilot.getId(),</span>
                                                  IEntityRemovalConditions.REMOVE_IN_RETREAT));
                    // }
                }
<span class="nc bnc" id="L33618" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)</span>
                        // Don't create a pilot entity on low-atmospheric maps
<span class="nc bnc" id="L33620" title="All 2 branches missed.">                        || game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L33621">                    game.removeEntity(pilot.getId(),</span>
                                      IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L33623">                    send(createRemoveEntityPacket(pilot.getId(),</span>
                                                  IEntityRemovalConditions.REMOVE_IN_RETREAT));
                }

                // If this is a skin of the teeth ejection...
<span class="nc bnc" id="L33628" title="All 4 branches missed.">                if (skin_of_the_teeth &amp;&amp; (pilot.getCrew().getHits() &lt; 5)) {</span>
<span class="nc" id="L33629">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L33630">                    vDesc.addAll(damageCrew(pilot, 5 - pilot.getCrew()</span>
<span class="nc" id="L33631">                                                            .getHits()));</span>
                }
            } // Crew safely ejects.

            // ejection damages the cockpit
            // kind of irrelevant in stand-alone games, but important for MekHQ
<span class="nc bnc" id="L33637" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L33638">                Mech mech = (Mech) entity;</span>
                // in case of mechs with 'full head ejection', the head is treated as blown off
<span class="nc bnc" id="L33640" title="All 2 branches missed.">                if (mech.hasFullHeadEject()) {</span>
<span class="nc" id="L33641">                    entity.destroyLocation(Mech.LOC_HEAD, true);</span>
                } else {
<span class="nc bnc" id="L33643" title="All 2 branches missed.">                    for (CriticalSlot slot : (mech.getCockpit())) {</span>
<span class="nc" id="L33644">                        slot.setDestroyed(true);</span>
<span class="nc" id="L33645">                    }</span>
                }
            }            
<span class="nc" id="L33648">        } // End entity-is-Mek or fighter</span>
<span class="nc bnc" id="L33649" title="All 4 branches missed.">        else if (game.getBoard().contains(entity.getPosition())</span>
                 &amp;&amp; (entity instanceof Tank)) {
<span class="nc" id="L33651">            EjectedCrew crew = new EjectedCrew(entity);</span>
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33654">            crew.setGame(game);</span>
<span class="nc" id="L33655">            crew.setDeployed(true);</span>
<span class="nc" id="L33656">            crew.setId(getFreeEntityId());</span>
            // Make them not get a move this turn
<span class="nc" id="L33658">            crew.setDone(true);</span>
            // Place on board
            // Vehicles don't have ejection systems, so crew must abandon into
            // a legal hex
<span class="nc" id="L33662">            Coords legalPosition = null;</span>
<span class="nc bnc" id="L33663" title="All 2 branches missed.">            if (!crew.isLocationProhibited(entity.getPosition())) {</span>
<span class="nc" id="L33664">                legalPosition = entity.getPosition();</span>
            } else {
<span class="nc bnc" id="L33666" title="All 4 branches missed.">                for (int dir = 0; (dir &lt; 6) &amp;&amp; (legalPosition == null); dir++) {</span>
<span class="nc" id="L33667">                    Coords adjCoords = entity.getPosition().translated(dir);</span>
<span class="nc bnc" id="L33668" title="All 2 branches missed.">                    if (!crew.isLocationProhibited(adjCoords)) {</span>
<span class="nc" id="L33669">                        legalPosition = adjCoords;</span>
                    }
                }
            }
            // Cannot abandon if there is no legal hex. This shouldn't have been allowed
<span class="nc bnc" id="L33674" title="All 2 branches missed.">            if (legalPosition == null) {</span>
<span class="nc" id="L33675">                MegaMek.getLogger().error(&quot;Vehicle crews cannot abandon if there is no legal hex!&quot;);</span>
<span class="nc" id="L33676">                return vDesc;</span>
            }
<span class="nc" id="L33678">            crew.setPosition(legalPosition);</span>
            // Add Entity to game
<span class="nc" id="L33680">            game.addEntity(crew);</span>
            // Tell clients about new entity
<span class="nc" id="L33682">            send(createAddEntityPacket(crew.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33684">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L33686">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew,</span>
<span class="nc" id="L33687">                    entity.getPosition(), entity.getPosition(),</span>
<span class="nc" id="L33688">                    entity.getElevation()));</span>
<span class="nc bnc" id="L33689" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33690">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33691">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        } //End ground vehicles

        // Mark the entity's crew as &quot;ejected&quot;.
<span class="nc" id="L33696">        entity.getCrew().setEjected(true);</span>
<span class="nc bnc" id="L33697" title="All 2 branches missed.">        if (entity instanceof VTOL) {</span>
<span class="nc" id="L33698">            vDesc.addAll(crashVTOLorWiGE((VTOL) entity));</span>
        }
<span class="nc" id="L33700">        vDesc.addAll(destroyEntity(entity, &quot;ejection&quot;, true, true));</span>

        // only remove the unit that ejected manually
<span class="nc bnc" id="L33703" title="All 2 branches missed.">        if (!autoEject) {</span>
<span class="nc" id="L33704">            game.removeEntity(entity.getId(),</span>
                    IEntityRemovalConditions.REMOVE_EJECTED);
<span class="nc" id="L33706">            send(createRemoveEntityPacket(entity.getId(),</span>
                    IEntityRemovalConditions.REMOVE_EJECTED));
        }
<span class="nc" id="L33709">        return vDesc;</span>
    }
    
    /**
     * Abandon a spacecraft (large or small).
     *
     * @param entity  The &lt;code&gt;Aero&lt;/code&gt; to eject.
     * @param inSpace Is this ship spaceborne?
     * @param airborne Is this ship in atmospheric flight?
     * @param pos The coords of this ejection. Needed when abandoning a grounded ship
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the gamelog.
     */
    public Vector&lt;Report&gt; ejectSpacecraft(Aero entity, boolean inSpace, boolean airborne, Coords pos) {
<span class="nc" id="L33722">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L33726" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L33727">            return vDesc;</span>
        }

        // If the crew are already dead, don't bother
<span class="nc bnc" id="L33731" title="All 2 branches missed.">        if (entity.isCarcass()) {</span>
<span class="nc" id="L33732">            return vDesc;</span>
        }

        // Try to launch some escape pods and lifeboats, if any are left
<span class="nc bnc" id="L33736" title="All 8 branches missed.">        if ((inSpace &amp;&amp; (entity.getPodsLeft() &gt; 0 || entity.getLifeBoatsLeft() &gt; 0))</span>
<span class="nc bnc" id="L33737" title="All 2 branches missed.">                || (airborne &amp;&amp; entity.getPodsLeft() &gt; 0)) {</span>
            // Report the ejection
<span class="nc" id="L33739">            PilotingRollData rollTarget = getEjectModifiers(game, entity,</span>
<span class="nc" id="L33740">                    entity.getCrew().getCurrentPilotIndex(), false);</span>
<span class="nc" id="L33741">            r = new Report(2180);</span>
<span class="nc" id="L33742">            r.subject = entity.getId();</span>
<span class="nc" id="L33743">            r.addDesc(entity);</span>
<span class="nc" id="L33744">            r.add(rollTarget.getLastPlainDesc(), true);</span>
<span class="nc" id="L33745">            r.indent();</span>
<span class="nc" id="L33746">            vDesc.addElement(r);</span>
<span class="nc" id="L33747">            int roll = Compute.d6(2);</span>
<span class="nc" id="L33748">            int MOS = (roll - Math.max(2, rollTarget.getValue()));</span>
            //Report the roll
<span class="nc" id="L33750">            r = new Report(2190);</span>
<span class="nc" id="L33751">            r.subject = entity.getId();</span>
<span class="nc" id="L33752">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L33753">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L33754">            r.add(roll);</span>
<span class="nc" id="L33755">            r.indent();</span>
<span class="nc bnc" id="L33756" title="All 2 branches missed.">            r.choose(roll &gt;= rollTarget.getValue());</span>
<span class="nc" id="L33757">            vDesc.addElement(r);</span>
            //Per SO p27, you get a certain number of escape pods away per turn per 100k tons of ship
<span class="nc" id="L33759">            int escapeMultiplier = (int) (entity.getWeight() / 100000);</span>
            //Set up the maximum number that CAN launch
<span class="nc" id="L33761">            int toLaunch = 0;</span>
<span class="nc bnc" id="L33762" title="All 2 branches missed.">            if (roll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L33763">                toLaunch = 1;</span>
            } else {
<span class="nc" id="L33765">                toLaunch = (1 + MOS) * Math.max(1, escapeMultiplier);</span>
            }
            //And now modify it based on what the unit actually has TO launch
<span class="nc" id="L33768">            int launchCounter = toLaunch;</span>
<span class="nc" id="L33769">            int totalLaunched = 0;</span>
<span class="nc" id="L33770">            boolean isPod = false;</span>
<span class="nc bnc" id="L33771" title="All 2 branches missed.">            while (launchCounter &gt; 0) {</span>
<span class="nc" id="L33772">                int launched = 0;</span>
<span class="nc bnc" id="L33773" title="All 6 branches missed.">                if (entity.getPodsLeft() &gt; 0 &amp;&amp; (airborne || entity.getPodsLeft() &gt;= entity.getLifeBoatsLeft())) {</span>
                    //Entity has more escape pods than lifeboats (or equal numbers)
<span class="nc" id="L33775">                    launched = Math.min(launchCounter, entity.getPodsLeft());</span>
<span class="nc" id="L33776">                    entity.setLaunchedEscapePods(entity.getLaunchedEscapePods() + launched);</span>
<span class="nc" id="L33777">                    totalLaunched += launched;</span>
<span class="nc" id="L33778">                    launchCounter -= launched;</span>
<span class="nc" id="L33779">                    isPod = true;</span>
<span class="nc bnc" id="L33780" title="All 6 branches missed.">                } else if (inSpace &amp;&amp; entity.getLifeBoatsLeft() &gt; 0 &amp;&amp; (entity.getLifeBoatsLeft() &gt; entity.getPodsLeft())) {</span>
                    //Entity has more lifeboats left
<span class="nc" id="L33782">                    launched = Math.min(launchCounter, entity.getLifeBoatsLeft());</span>
<span class="nc" id="L33783">                    entity.setLaunchedLifeBoats(entity.getLaunchedLifeBoats() + launched);</span>
<span class="nc" id="L33784">                    totalLaunched += launched;</span>
<span class="nc" id="L33785">                    launchCounter -= launched;</span>
                } else {
                    //We've run out of both. End the loop
                    break;
                }
<span class="nc" id="L33790">            }</span>
<span class="nc" id="L33791">            int nEscaped = Math.min((entity.getCrew().getCurrentSize() + entity.getNPassenger()), (totalLaunched * 6));</span>
            //Report how many pods launched and how many escaped
<span class="nc bnc" id="L33793" title="All 2 branches missed.">            if (totalLaunched &gt; 0) {</span>
<span class="nc" id="L33794">                r = new Report(6401);</span>
<span class="nc" id="L33795">                r.subject = entity.getId();</span>
<span class="nc" id="L33796">                r.indent();</span>
<span class="nc" id="L33797">                r.add(totalLaunched);</span>
<span class="nc" id="L33798">                r.add(nEscaped);</span>
<span class="nc" id="L33799">                vDesc.addElement(r);</span>
            }
<span class="nc" id="L33801">            EscapePods pods = new EscapePods(entity,totalLaunched,isPod);</span>
<span class="nc" id="L33802">            entity.addEscapeCraft(pods.getExternalIdAsString());</span>
            //Update the personnel numbers
            
            //If there are passengers aboard, get them out first
<span class="nc bnc" id="L33806" title="All 2 branches missed.">            if (entity.getNPassenger() &gt; 0) {</span>
<span class="nc" id="L33807">                int change = Math.min(entity.getNPassenger(), nEscaped);</span>
<span class="nc" id="L33808">                entity.setNPassenger(Math.max(entity.getNPassenger() - nEscaped, 0));</span>
<span class="nc" id="L33809">                pods.addPassengers(entity.getExternalIdAsString(), change);</span>
<span class="nc" id="L33810">                nEscaped -= change;</span>
            }
            //Now get the crew out with such space as is left
<span class="nc bnc" id="L33813" title="All 2 branches missed.">            if (nEscaped &gt; 0) {</span>
<span class="nc" id="L33814">                entity.setNCrew(entity.getNCrew() - nEscaped);</span>
<span class="nc" id="L33815">                entity.getCrew().setCurrentSize(Math.max(0, entity.getCrew().getCurrentSize() - nEscaped));</span>
<span class="nc" id="L33816">                pods.addNOtherCrew(entity.getExternalIdAsString(), nEscaped);</span>
                //*Damage* the host ship's crew to account for the people that left
<span class="nc" id="L33818">                vDesc.addAll(damageCrew(entity,entity.getCrew().calculateHits()));</span>
<span class="nc bnc" id="L33819" title="All 2 branches missed.">                if (entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
                    //Then we've finished ejecting
<span class="nc" id="L33821">                    entity.getCrew().setEjected(true);</span>
                }
            }
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33826">            pods.setPosition(entity.getPosition());</span>
<span class="nc" id="L33827">            pods.setGame(game);</span>
<span class="nc" id="L33828">            pods.setDeployed(true);</span>
<span class="nc" id="L33829">            pods.setId(getFreeEntityId());</span>
            //Escape craft retain the heading and velocity of the unit they eject from
<span class="nc" id="L33831">            pods.setVectors(entity.getVectors());</span>
<span class="nc" id="L33832">            pods.setFacing(entity.getFacing());</span>
<span class="nc" id="L33833">            pods.setCurrentVelocity(entity.getCurrentVelocity());</span>
            //If the crew ejects, they should no longer be accelerating
<span class="nc" id="L33835">            pods.setNextVelocity(entity.getVelocity());</span>
<span class="nc bnc" id="L33836" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L33837">                pods.setAltitude(entity.getAltitude());</span>
            }
            // Add Entity to game
<span class="nc" id="L33840">            game.addEntity(pods);</span>
            // No movement this turn
<span class="nc" id="L33842">            pods.setDone(true);</span>
            // Tell clients about new entity
<span class="nc" id="L33844">            send(createAddEntityPacket(pods.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33846">            entityUpdate(pods.getId());</span>
<span class="nc bnc" id="L33847" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33848">                game.removeEntity(pods.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33849">                send(createRemoveEntityPacket(pods.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
<span class="nc" id="L33851">        } // End Escape Pod/Lifeboat Ejection</span>
        else {
<span class="nc bnc" id="L33853" title="All 2 branches missed.">            if (airborne) {</span>
                // Can't abandon in atmosphere with no escape pods
<span class="nc" id="L33855">                r = new Report(6402);</span>
<span class="nc" id="L33856">                r.subject = entity.getId();</span>
<span class="nc" id="L33857">                r.addDesc(entity);</span>
<span class="nc" id="L33858">                r.indent();</span>
<span class="nc" id="L33859">                vDesc.addElement(r);</span>
<span class="nc" id="L33860">                return vDesc;</span>
            }
            
            // Eject up to 50 spacesuited crewmen out the nearest airlock!
            // This only works in space or on the ground
<span class="nc" id="L33865">            int nEscaped = Math.min(entity.getNPassenger() + entity.getCrew().getCurrentSize(), 50);</span>
<span class="nc" id="L33866">            EjectedCrew crew = new EjectedCrew(entity, nEscaped);</span>
<span class="nc" id="L33867">            entity.addEscapeCraft(crew.getExternalIdAsString());</span>
            
            //Report the escape
<span class="nc" id="L33870">            r = new Report(6403);</span>
<span class="nc" id="L33871">            r.subject = entity.getId();</span>
<span class="nc" id="L33872">            r.addDesc(entity);</span>
<span class="nc" id="L33873">            r.add(nEscaped);</span>
<span class="nc" id="L33874">            r.indent();</span>
<span class="nc" id="L33875">            vDesc.addElement(r);</span>

            //If there are passengers aboard, get them out first
<span class="nc bnc" id="L33878" title="All 2 branches missed.">            if (entity.getNPassenger() &gt; 0) {</span>
<span class="nc" id="L33879">                int change = Math.min(entity.getNPassenger(), nEscaped);</span>
<span class="nc" id="L33880">                entity.setNPassenger(Math.max(entity.getNPassenger() - nEscaped, 0));</span>
<span class="nc" id="L33881">                crew.addPassengers(entity.getExternalIdAsString(), change);</span>
<span class="nc" id="L33882">                nEscaped -= change;</span>
            }
            //Now get the crew out with such airlock space as is left
<span class="nc bnc" id="L33885" title="All 2 branches missed.">            if (nEscaped &gt; 0) {</span>
<span class="nc" id="L33886">                entity.setNCrew(entity.getNCrew() - nEscaped);</span>
<span class="nc" id="L33887">                entity.getCrew().setCurrentSize(Math.max(0, entity.getCrew().getCurrentSize() - nEscaped));</span>
<span class="nc" id="L33888">                crew.addNOtherCrew(entity.getExternalIdAsString(), nEscaped);</span>
                //*Damage* the host ship's crew to account for the people that left
<span class="nc" id="L33890">                vDesc.addAll(damageCrew(entity,entity.getCrew().calculateHits()));</span>
<span class="nc bnc" id="L33891" title="All 2 branches missed.">                if (entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
                    //Then we've finished ejecting
<span class="nc" id="L33893">                    entity.getCrew().setEjected(true);</span>
                }
            }
            
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33899">            crew.setGame(game);</span>
<span class="nc" id="L33900">            crew.setDeployed(true);</span>
<span class="nc" id="L33901">            crew.setId(getFreeEntityId());</span>
<span class="nc bnc" id="L33902" title="All 2 branches missed.">            if (inSpace) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L33904">                crew.setVectors(entity.getVectors());</span>
<span class="nc" id="L33905">                crew.setFacing(entity.getFacing());</span>
<span class="nc" id="L33906">                crew.setCurrentVelocity(entity.getVelocity());</span>
                //If the crew ejects, they should no longer be accelerating
<span class="nc" id="L33908">                crew.setNextVelocity(entity.getVelocity());</span>
                // We're going to be nice and assume a ship has enough spacesuits for everyone aboard...
<span class="nc" id="L33910">                crew.setSpaceSuit(true);</span>
<span class="nc" id="L33911">                crew.setPosition(entity.getPosition());</span>
            } else {
                // On the ground, crew must abandon into a legal hex
<span class="nc" id="L33914">                Coords legalPosition = null;</span>
                //Small Craft can just abandon into the hex they occupy
<span class="nc bnc" id="L33916" title="All 4 branches missed.">                if (!entity.isLargeCraft() &amp;&amp; !crew.isLocationProhibited(entity.getPosition())) {</span>
<span class="nc" id="L33917">                    legalPosition = entity.getPosition();</span>
                } else {
                    //Use the passed in coords. We already calculated whether they're legal or not
<span class="nc" id="L33920">                    legalPosition = pos;</span>
                }
                // Cannot abandon if there is no legal hex.  This shoudln't have
                // been allowed
<span class="nc bnc" id="L33924" title="All 2 branches missed.">                if (legalPosition == null) {</span>
<span class="nc" id="L33925">                    MegaMek.getLogger().error(&quot;Spacecraft crews cannot abandon if there is no legal hex!&quot;);</span>
<span class="nc" id="L33926">                    return vDesc;</span>
                }
<span class="nc" id="L33928">                crew.setPosition(legalPosition);</span>
            }
            // Add Entity to game
<span class="nc" id="L33931">            game.addEntity(crew);</span>
            // No movement this turn
<span class="nc" id="L33933">            crew.setDone(true);</span>
            // Tell clients about new entity
<span class="nc" id="L33935">            send(createAddEntityPacket(crew.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33937">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L33939">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew,</span>
<span class="nc" id="L33940">                    entity.getPosition(), entity.getPosition(),</span>
<span class="nc" id="L33941">                    entity.getElevation()));</span>
<span class="nc bnc" id="L33942" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33943">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33944">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        }
        // If we get here, end movement and return the report
<span class="nc" id="L33948">        entity.setDone(true);</span>
<span class="nc" id="L33949">        entityUpdate(entity.getId());</span>
<span class="nc" id="L33950">        return vDesc;</span>
    }

    public static PilotingRollData getEjectModifiers(IGame game,
            Entity entity, int crewPos, boolean autoEject) {
<span class="nc" id="L33955">        int facing = entity.getFacing();</span>
<span class="nc bnc" id="L33956" title="All 2 branches missed.">        if (entity.isPartOfFighterSquadron()) {</span>
            // Because the components of a squadron have no position and will pass the next test
<span class="nc" id="L33958">            Entity squadron = game.getEntity(entity.getTransportId());</span>
<span class="nc" id="L33959">            return getEjectModifiers(game, entity, crewPos, autoEject, squadron.getPosition(),</span>
                    &quot;ejecting&quot;);
        }
<span class="nc bnc" id="L33962" title="All 2 branches missed.">        if(null == entity.getPosition()) {</span>
            // Off-board unit?
<span class="nc" id="L33964">            return new PilotingRollData(entity.getId(), entity.getCrew().getPiloting(), &quot;ejecting&quot;);</span>
        }
<span class="nc" id="L33966">        Coords targetCoords = entity.getPosition().translated((facing + 3) % 6);</span>
<span class="nc" id="L33967">        return getEjectModifiers(game, entity, crewPos, autoEject, targetCoords,</span>
                &quot;ejecting&quot;);
    }

    public static PilotingRollData getEjectModifiers(IGame game, Entity entity, int crewPos,
            boolean autoEject, Coords targetCoords, String desc) {
<span class="nc" id="L33973">        PilotingRollData rollTarget = new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L33974">                entity.getCrew().getPiloting(crewPos), desc);</span>
        // Per SO p26, fighters can eject as per TO rules on 196 with some exceptions
<span class="nc bnc" id="L33976" title="All 2 branches missed.">        if (entity.isProne()) {</span>
<span class="nc" id="L33977">            rollTarget.addModifier(5, &quot;Mech is prone&quot;);</span>
        }
<span class="nc bnc" id="L33979" title="All 2 branches missed.">        if (entity.getCrew().isUnconscious(crewPos)) {</span>
<span class="nc" id="L33980">            rollTarget.addModifier(3, &quot;pilot unconscious&quot;);</span>
        }
<span class="nc bnc" id="L33982" title="All 2 branches missed.">        if (autoEject) {</span>
<span class="nc" id="L33983">            rollTarget.addModifier(1, &quot;automatic ejection&quot;);</span>
        }
        // Per SO p27, Large Craft roll too, to see how many escape pods launch successfully
<span class="nc bnc" id="L33986" title="All 4 branches missed.">        if ((entity.isAero() &amp;&amp; ((IAero)entity).isOutControl())</span>
<span class="nc bnc" id="L33987" title="All 4 branches missed.">                || (entity.isPartOfFighterSquadron() &amp;&amp; ((IAero)game.getEntity(entity.getTransportId())).isOutControl())) {</span>
<span class="nc" id="L33988">            rollTarget.addModifier(5, &quot;Out of Control&quot;);</span>
        }
        // A decreased large craft crew makes it harder to eject large numbers of pods
<span class="nc bnc" id="L33991" title="All 4 branches missed.">        if (entity.isLargeCraft() &amp;&amp; entity.getCrew().getHits() &gt; 0) {</span>
<span class="nc" id="L33992">            rollTarget.addModifier(entity.getCrew().getHits(), &quot;Crew hits&quot;);</span>
        }
<span class="nc bnc" id="L33994" title="All 2 branches missed.">        if ((entity instanceof Mech)</span>
<span class="nc" id="L33995">                &amp;&amp; (entity.getInternal(Mech.LOC_HEAD) &lt; entity</span>
<span class="nc bnc" id="L33996" title="All 2 branches missed.">                        .getOInternal(Mech.LOC_HEAD))) {</span>
<span class="nc" id="L33997">            rollTarget.addModifier(</span>
<span class="nc" id="L33998">                    entity.getOInternal(Mech.LOC_HEAD)</span>
<span class="nc" id="L33999">                            - entity.getInternal(Mech.LOC_HEAD),</span>
                    &quot;Head Internal Structure Damage&quot;);
        }
<span class="nc" id="L34002">        IHex targetHex = game.getBoard().getHex(targetCoords);</span>
        //Terrain modifiers should only apply if the unit is on the ground...
<span class="nc bnc" id="L34004" title="All 4 branches missed.">        if (!entity.isSpaceborne() &amp;&amp; !entity.isAirborne()) {</span>
<span class="nc bnc" id="L34005" title="All 2 branches missed.">            if (targetHex != null) {</span>
<span class="nc bnc" id="L34006" title="All 2 branches missed.">                if ((targetHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34007" title="All 2 branches missed.">                        &amp;&amp; !targetHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34008">                    rollTarget.addModifier(-1, &quot;landing in water&quot;);</span>
<span class="nc bnc" id="L34009" title="All 2 branches missed.">                } else if (targetHex.containsTerrain(Terrains.ROUGH)) {</span>
<span class="nc" id="L34010">                    rollTarget.addModifier(0, &quot;landing in rough&quot;);</span>
<span class="nc bnc" id="L34011" title="All 2 branches missed.">                } else if (targetHex.containsTerrain(Terrains.RUBBLE)) {</span>
<span class="nc" id="L34012">                    rollTarget.addModifier(0, &quot;landing in rubble&quot;);</span>
<span class="nc bnc" id="L34013" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 1) {</span>
<span class="nc" id="L34014">                    rollTarget.addModifier(2, &quot;landing in light woods&quot;);</span>
<span class="nc bnc" id="L34015" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 2) {</span>
<span class="nc" id="L34016">                    rollTarget.addModifier(3, &quot;landing in heavy woods&quot;);</span>
<span class="nc bnc" id="L34017" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 3) {</span>
<span class="nc" id="L34018">                    rollTarget.addModifier(4, &quot;landing in ultra heavy woods&quot;);</span>
<span class="nc bnc" id="L34019" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 1) {</span>
<span class="nc" id="L34020">                    rollTarget.addModifier(3, &quot;landing in light jungle&quot;);</span>
<span class="nc bnc" id="L34021" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 2) {</span>
<span class="nc" id="L34022">                    rollTarget.addModifier(5, &quot;landing in heavy jungle&quot;);</span>
<span class="nc bnc" id="L34023" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 3) {</span>
<span class="nc" id="L34024">                    rollTarget.addModifier(7, &quot;landing in ultra heavy jungle&quot;);</span>
<span class="nc bnc" id="L34025" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.BLDG_ELEV) &gt; 0) {</span>
<span class="nc" id="L34026">                    rollTarget.addModifier(</span>
<span class="nc" id="L34027">                            targetHex.terrainLevel(Terrains.BLDG_ELEV),</span>
                            &quot;landing in a building&quot;);
                } else {
<span class="nc" id="L34030">                    rollTarget.addModifier(-2, &quot;landing in clear terrain&quot;);</span>
                }
            } else {
<span class="nc" id="L34033">                rollTarget.addModifier(-2, &quot;landing off the board&quot;);</span>
            }
        }
<span class="nc bnc" id="L34036" title="All 2 branches missed.">        if (!entity.isSpaceborne()) {</span>
            //At present, the UI lets you set these atmospheric conditions for a space battle, but it shouldn't
            //That's a fix for another day, probably when I get around to space terrain and 'weather'
<span class="nc bnc" id="L34039" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getGravity() == 0) {</span>
<span class="nc" id="L34040">                rollTarget.addModifier(3, &quot;Zero-G&quot;);</span>
<span class="nc bnc" id="L34041" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getGravity() &lt; .8) {</span>
<span class="nc" id="L34042">                rollTarget.addModifier(2, &quot;Low-G&quot;);</span>
<span class="nc bnc" id="L34043" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getGravity() &gt; 1.2) {</span>
<span class="nc" id="L34044">                rollTarget.addModifier(2, &quot;High-G&quot;);</span>
            }
        
            //Vacuum shouldn't apply to ASF ejection since they're designed for it, but the rules don't specify
            //High and low pressures make more sense to apply to all
<span class="nc bnc" id="L34049" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_VACUUM) {</span>
<span class="nc" id="L34050">                rollTarget.addModifier(3, &quot;Vacuum&quot;);</span>
<span class="nc bnc" id="L34051" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_VHIGH) {</span>
<span class="nc" id="L34052">                rollTarget.addModifier(2, &quot;Very High Atmosphere Pressure&quot;);</span>
<span class="nc bnc" id="L34053" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_TRACE) {</span>
<span class="nc" id="L34054">                rollTarget.addModifier(2, &quot;Trace atmosphere&quot;);</span>
            }
        }

<span class="nc bnc" id="L34058" title="All 2 branches missed.">        if ((game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW)</span>
<span class="nc bnc" id="L34059" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_ICE_STORM)</span>
<span class="nc bnc" id="L34060" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_DOWNPOUR)</span>
<span class="nc bnc" id="L34061" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_STRONG_GALE)) {</span>
<span class="nc" id="L34062">            rollTarget.addModifier(2, &quot;Bad Weather&quot;);</span>
        }

<span class="nc bnc" id="L34065" title="All 2 branches missed.">        if ((game.getPlanetaryConditions().getWindStrength() &gt;= PlanetaryConditions.WI_STORM)</span>
<span class="nc bnc" id="L34066" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_BLIZZARD)</span>
<span class="nc bnc" id="L34067" title="All 2 branches missed.">                || ((game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW) &amp;&amp; (game</span>
<span class="nc bnc" id="L34068" title="All 2 branches missed.">                        .getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_STRONG_GALE))) {</span>
<span class="nc" id="L34069">            rollTarget.addModifier(3, &quot;Really Bad Weather&quot;);</span>
        }
<span class="nc" id="L34071">        return rollTarget;</span>
    }

    /**
     * Creates a new Ballistic Infantry unit at the end of the movement phase
     */
    public void resolveCallSupport() {
<span class="nc bnc" id="L34078" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L34079" title="All 4 branches missed.">            if ((e instanceof Infantry) &amp;&amp; ((Infantry) e).getIsCallingSupport()) {</span>

                // Now lets create a new foot platoon
<span class="nc" id="L34082">                Infantry guerrilla = new Infantry();</span>
<span class="nc" id="L34083">                guerrilla.setChassis(&quot;Insurgents&quot;);</span>
<span class="nc" id="L34084">                guerrilla.setModel(&quot;(Rifle)&quot;);</span>
<span class="nc" id="L34085">                guerrilla.setSquadN(4);</span>
<span class="nc" id="L34086">                guerrilla.setSquadSize(7);</span>
<span class="nc" id="L34087">                guerrilla.autoSetInternal();</span>
<span class="nc" id="L34088">                guerrilla.getCrew().setGunnery(5, 0);</span>
                try {
<span class="nc" id="L34090">                    guerrilla.addEquipment(EquipmentType.get(EquipmentTypeLookup.INFANTRY_ASSAULT_RIFLE),</span>
                            Infantry.LOC_INFANTRY);
<span class="nc" id="L34092">                    guerrilla.setPrimaryWeapon((InfantryWeapon) InfantryWeapon</span>
<span class="nc" id="L34093">                            .get(EquipmentTypeLookup.INFANTRY_ASSAULT_RIFLE));</span>
<span class="nc" id="L34094">                } catch (Exception ex) {</span>
<span class="nc" id="L34095">                    ex.printStackTrace();</span>
<span class="nc" id="L34096">                }</span>
<span class="nc" id="L34097">                guerrilla.setDeployed(true);</span>
<span class="nc" id="L34098">                guerrilla.setDone(true);</span>
<span class="nc" id="L34099">                guerrilla.setId(getFreeEntityId());</span>
<span class="nc" id="L34100">                guerrilla.setOwner(e.getOwner());</span>
<span class="nc" id="L34101">                game.addEntity(guerrilla);</span>

                // Add the infantry unit on the battlefield. Should spawn within 3 hexes
                // First get coords then loop over some targets
<span class="nc" id="L34105">                Coords tmpCoords = e.getPosition();</span>
<span class="nc" id="L34106">                Coords targetCoords = null;</span>
<span class="nc bnc" id="L34107" title="All 2 branches missed.">                while (!game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34108">                    targetCoords = Compute.scatter(tmpCoords, (Compute.d6(1) / 2));</span>
<span class="nc bnc" id="L34109" title="All 2 branches missed.">                    if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34110">                        guerrilla.setPosition(targetCoords);</span>
<span class="nc" id="L34111">                        break;</span>
                    }
                }
<span class="nc" id="L34114">                send(createAddEntityPacket(guerrilla.getId()));</span>
<span class="nc" id="L34115">                ((Infantry) e).setIsCallingSupport(false);</span>
                /*
                // Update the entity
                entityUpdate(guerrilla.getId());
                Report r = new Report(5535, Report.PUBLIC);
                r.subject = e.getId();
                r.addDesc(e);
                addReport(r);*/
            }
<span class="nc" id="L34124">        }</span>
<span class="nc" id="L34125">    }</span>

    /**
     * Abandon an Entity.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; to abandon.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; abandonEntity(Entity entity) {
<span class="nc" id="L34134">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L34138" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L34139">            return vDesc;</span>
        }

<span class="nc bnc" id="L34142" title="All 4 branches missed.">        if (entity.getCrew().isDoomed() || entity.getCrew().isDead()) {</span>
<span class="nc" id="L34143">            return vDesc;</span>
        }

<span class="nc" id="L34146">        Coords targetCoords = entity.getPosition();</span>

<span class="nc bnc" id="L34148" title="All 6 branches missed.">        if (entity instanceof Mech || (entity.isAero() &amp;&amp; !entity.isAirborne())) {</span>
            // okay, print the info
<span class="nc" id="L34150">            r = new Report(2027);</span>
<span class="nc" id="L34151">            r.subject = entity.getId();</span>
<span class="nc" id="L34152">            r.add(entity.getCrew().getName());</span>
<span class="nc" id="L34153">            r.addDesc(entity);</span>
<span class="nc" id="L34154">            r.indent(3);</span>
<span class="nc" id="L34155">            vDesc.addElement(r);</span>
            // Don't make ill-equipped pilots abandon into vacuum
<span class="nc bnc" id="L34157" title="All 4 branches missed.">            if (game.getPlanetaryConditions().isVacuum() &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L34158">                return vDesc;</span>
            }

            // create the MechWarrior in any case, for campaign tracking
<span class="nc" id="L34162">            MechWarrior pilot = new MechWarrior(entity);</span>
<span class="nc" id="L34163">            pilot.getCrew().setUnconscious(entity.getCrew().isUnconscious());</span>
<span class="nc" id="L34164">            pilot.setDeployed(true);</span>
<span class="nc" id="L34165">            pilot.setId(getFreeEntityId());</span>
            //Pilot flight suits are vacuum-rated. MechWarriors wear shorts...
<span class="nc" id="L34167">            pilot.setSpaceSuit(entity.isAero());</span>
<span class="nc bnc" id="L34168" title="All 2 branches missed.">            if (entity.isSpaceborne()) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L34170">                pilot.setVectors(entity.getVectors());</span>
<span class="nc" id="L34171">                pilot.setFacing(entity.getFacing());</span>
<span class="nc" id="L34172">                pilot.setCurrentVelocity(entity.getVelocity());</span>
                //If the pilot ejects, he should no longer be accelerating
<span class="nc" id="L34174">                pilot.setNextVelocity(entity.getVelocity());</span>
            }
<span class="nc" id="L34176">            game.addEntity(pilot);</span>
<span class="nc" id="L34177">            send(createAddEntityPacket(pilot.getId()));</span>
            // make him not get a move this turn
<span class="nc" id="L34179">            pilot.setDone(true);</span>
            // Add the pilot as an infantry unit on the battlefield.
<span class="nc bnc" id="L34181" title="All 2 branches missed.">            if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34182">                pilot.setPosition(targetCoords);</span>
            }
<span class="nc" id="L34184">            pilot.setCommander(entity.isCommander());</span>
            // Update the entity
<span class="nc" id="L34186">            entityUpdate(pilot.getId());</span>
            // check if the pilot lands in a minefield
<span class="nc" id="L34188">            vDesc.addAll(doEntityDisplacementMinefieldCheck(pilot, entity.getPosition(),</span>
<span class="nc" id="L34189">                    targetCoords, entity.getElevation()));</span>
<span class="nc bnc" id="L34190" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34191">                game.removeEntity(pilot.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34192">                send(createRemoveEntityPacket(pilot.getId(),</span>
                        IEntityRemovalConditions.REMOVE_IN_RETREAT));
            }
<span class="nc" id="L34195">        } // End entity-is-Mek or Aero</span>
<span class="nc bnc" id="L34196" title="All 4 branches missed.">        else if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT)</span>
                 &amp;&amp; (entity instanceof Tank)) {
            // Don't make them abandon into vacuum
<span class="nc bnc" id="L34199" title="All 2 branches missed.">            if (game.getPlanetaryConditions().isVacuum()) {</span>
<span class="nc" id="L34200">                return vDesc;</span>
            }
<span class="nc" id="L34202">            EjectedCrew crew = new EjectedCrew(entity);</span>
<span class="nc" id="L34203">            crew.setDeployed(true);</span>
<span class="nc" id="L34204">            crew.setId(getFreeEntityId());</span>
<span class="nc" id="L34205">            game.addEntity(crew);</span>
<span class="nc" id="L34206">            send(createAddEntityPacket(crew.getId()));</span>
            // Make them not get a move this turn
<span class="nc" id="L34208">            crew.setDone(true);</span>
            // Place on board
<span class="nc bnc" id="L34210" title="All 2 branches missed.">            if(game.getBoard().contains(entity.getPosition())) {</span>
<span class="nc" id="L34211">                crew.setPosition(entity.getPosition());</span>
            }
            // Update the entity
<span class="nc" id="L34214">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L34216">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew, entity.getPosition(),</span>
<span class="nc" id="L34217">                    entity.getPosition(), entity.getElevation()));</span>
<span class="nc bnc" id="L34218" title="All 2 branches missed.">            if(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34219">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34220">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        }

        // Mark the entity's crew as &quot;ejected&quot;.
<span class="nc" id="L34225">        entity.getCrew().setEjected(true);</span>

<span class="nc" id="L34227">        return vDesc;</span>
    }

    /**
     * Checks if ejected MechWarriors are eligible to be picked up, and if so,
     * captures them or picks them up
     */
    private void resolveMechWarriorPickUp() {
        Report r;

        // fetch all mechWarriors that are not picked up
<span class="nc" id="L34238">        Iterator&lt;Entity&gt; mechWarriors = game.getSelectedEntities(entity -&gt; {</span>
<span class="nc bnc" id="L34239" title="All 2 branches missed.">                    if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L34240">                        MechWarrior mw = (MechWarrior) entity;</span>
<span class="nc bnc" id="L34241" title="All 2 branches missed.">                        return (mw.getPickedUpById() == Entity.NONE)</span>
<span class="nc bnc" id="L34242" title="All 2 branches missed.">                                &amp;&amp; !mw.isDoomed()</span>
<span class="nc bnc" id="L34243" title="All 2 branches missed.">                                &amp;&amp; (mw.getTransportId() == Entity.NONE);</span>
                    }
<span class="nc" id="L34245">                    return false;</span>
                });
        // loop through them, check if they are in a hex occupied by another
        // unit
<span class="nc bnc" id="L34249" title="All 2 branches missed.">        while (mechWarriors.hasNext()) {</span>
<span class="nc" id="L34250">            boolean pickedUp = false;</span>
<span class="nc" id="L34251">            MechWarrior e = (MechWarrior) mechWarriors.next();</span>
            // Check for owner entities first...
<span class="nc bnc" id="L34253" title="All 2 branches missed.">            for (Entity pe : game.getEntitiesVector(e.getPosition())) {</span>
<span class="nc bnc" id="L34254" title="All 6 branches missed.">                if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34255" title="All 4 branches missed.">                        || (pe.isAirborne() &amp;&amp; !pe.isSpaceborne())</span>
<span class="nc bnc" id="L34256" title="All 2 branches missed.">                        || (pe.getElevation() != e.getElevation())</span>
<span class="nc bnc" id="L34257" title="All 2 branches missed.">                        || (pe.getOwnerId() != e.getOwnerId())</span>
<span class="nc bnc" id="L34258" title="All 2 branches missed.">                        || (pe.getId() == e.getId())) {</span>
<span class="nc" id="L34259">                    continue;</span>
                }
<span class="nc bnc" id="L34261" title="All 2 branches missed.">                if (pe instanceof MechWarrior) {</span>
                    // MWs have a beer together
<span class="nc" id="L34263">                    r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34264">                    r.add(pe.getDisplayName());</span>
<span class="nc" id="L34265">                    addReport(r);</span>
<span class="nc" id="L34266">                    continue;</span>
                }
                // Pick up the unit.
<span class="nc" id="L34269">                pe.pickUp(e);</span>
                // The picked unit is being carried by the loader.
<span class="nc" id="L34271">                e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34272">                e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34273">                pickedUp = true;</span>
<span class="nc" id="L34274">                r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34275">                r.add(e.getDisplayName());</span>
<span class="nc" id="L34276">                r.addDesc(pe);</span>
<span class="nc" id="L34277">                addReport(r);</span>
<span class="nc" id="L34278">                break;</span>
            }
            // Check for allied entities next...
<span class="nc bnc" id="L34281" title="All 2 branches missed.">            if (!pickedUp) {</span>
<span class="nc bnc" id="L34282" title="All 2 branches missed.">                for (Entity pe : game.getEntitiesVector(e.getPosition())) {</span>
<span class="nc bnc" id="L34283" title="All 6 branches missed.">                    if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34284" title="All 4 branches missed.">                            || (pe.isAirborne() &amp;&amp; !pe.isSpaceborne())</span>
<span class="nc bnc" id="L34285" title="All 2 branches missed.">                            || (pe.getElevation() != e.getElevation())</span>
<span class="nc bnc" id="L34286" title="All 4 branches missed.">                            || (pe.getOwnerId() == e.getOwnerId()) || (pe.getId() == e.getId())</span>
<span class="nc bnc" id="L34287" title="All 2 branches missed.">                            || (pe.getOwner().getTeam() == IPlayer.TEAM_NONE)</span>
<span class="nc bnc" id="L34288" title="All 2 branches missed.">                            || (pe.getOwner().getTeam() != e.getOwner().getTeam())) {</span>
<span class="nc" id="L34289">                        continue;</span>
                    }
<span class="nc bnc" id="L34291" title="All 2 branches missed.">                    if (pe instanceof MechWarrior) {</span>
                        // MWs have a beer together
<span class="nc" id="L34293">                        r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34294">                        r.add(pe.getDisplayName());</span>
<span class="nc" id="L34295">                        addReport(r);</span>
<span class="nc" id="L34296">                        continue;</span>
                    }
                    // Pick up the unit.
<span class="nc" id="L34299">                    pe.pickUp(e);</span>
                    // The picked unit is being carried by the loader.
<span class="nc" id="L34301">                    e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34302">                    e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34303">                    pickedUp = true;</span>
<span class="nc" id="L34304">                    r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34305">                    r.add(e.getDisplayName());</span>
<span class="nc" id="L34306">                    r.addDesc(pe);</span>
<span class="nc" id="L34307">                    addReport(r);</span>
<span class="nc" id="L34308">                    break;</span>
                }
            }
            // Now check for anyone else...
<span class="nc bnc" id="L34312" title="All 2 branches missed.">            if (!pickedUp) {</span>
<span class="nc" id="L34313">                Iterator&lt;Entity&gt; pickupEnemyEntities = game.getEnemyEntities(e.getPosition(), e);</span>
<span class="nc bnc" id="L34314" title="All 2 branches missed.">                while (pickupEnemyEntities.hasNext()) {</span>
<span class="nc" id="L34315">                    Entity pe = pickupEnemyEntities.next();</span>
<span class="nc bnc" id="L34316" title="All 6 branches missed.">                    if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34317" title="All 4 branches missed.">                            || pe.isAirborne() || (pe.getElevation() != e.getElevation())) {</span>
<span class="nc" id="L34318">                        continue;</span>
                    }
<span class="nc bnc" id="L34320" title="All 2 branches missed.">                    if (pe instanceof MechWarrior) {</span>
                        // MWs have a beer together
<span class="nc" id="L34322">                        r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34323">                        r.add(pe.getDisplayName());</span>
<span class="nc" id="L34324">                        addReport(r);</span>
<span class="nc" id="L34325">                        continue;</span>
                    }
                    // Capture the unit.
<span class="nc" id="L34328">                    pe.pickUp(e);</span>
                    // The captured unit is being carried by the loader.
<span class="nc" id="L34330">                    e.setCaptured(true);</span>
<span class="nc" id="L34331">                    e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34332">                    e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34333">                    pickedUp = true;</span>
<span class="nc" id="L34334">                    r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34335">                    r.add(e.getDisplayName());</span>
<span class="nc" id="L34336">                    r.addDesc(pe);</span>
<span class="nc" id="L34337">                    addReport(r);</span>
<span class="nc" id="L34338">                    break;</span>
                }
            }
<span class="nc bnc" id="L34341" title="All 2 branches missed.">            if (pickedUp) {</span>
                // Remove the picked-up unit from the screen.
<span class="nc" id="L34343">                e.setPosition(null);</span>
                // Update the loaded unit.
<span class="nc" id="L34345">                entityUpdate(e.getId());</span>
            }
<span class="nc" id="L34347">        }</span>
<span class="nc" id="L34348">    }</span>

    /**
     * destroy all wheeled and tracked Tanks that got displaced into water
     */
    private void resolveSinkVees() {
<span class="nc" id="L34354">        Iterator&lt;Entity&gt; sinkableTanks = game.getSelectedEntities(entity -&gt; {</span>
<span class="nc bnc" id="L34355" title="All 6 branches missed.">                    if (entity.isOffBoard() || (entity.getPosition() == null)</span>
                            || !(entity instanceof Tank)) {
<span class="nc" id="L34357">                        return false;</span>
                    }
<span class="nc" id="L34359">                    final IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34360" title="All 2 branches missed.">                    final boolean onBridge = (hex.terrainLevel(Terrains.BRIDGE) &gt; 0)</span>
<span class="nc bnc" id="L34361" title="All 2 branches missed.">                            &amp;&amp; (entity.getElevation() == hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
<span class="nc bnc" id="L34362" title="All 2 branches missed.">                    return ((entity.getMovementMode() == EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L34363" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.WHEELED)</span>
<span class="nc bnc" id="L34364" title="All 2 branches missed.">                            || ((entity.getMovementMode() == EntityMovementMode.HOVER)))</span>
<span class="nc bnc" id="L34365" title="All 6 branches missed.">                            &amp;&amp; entity.isImmobile() &amp;&amp; (hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34366" title="All 2 branches missed.">                            &amp;&amp; !onBridge &amp;&amp; !(entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS))</span>
<span class="nc bnc" id="L34367" title="All 2 branches missed.">                            &amp;&amp; !(entity.hasWorkingMisc(MiscType.F_FLOTATION_HULL));</span>
                });
<span class="nc bnc" id="L34369" title="All 2 branches missed.">        while (sinkableTanks.hasNext()) {</span>
<span class="nc" id="L34370">            Entity e = sinkableTanks.next();</span>
<span class="nc" id="L34371">            addReport(destroyEntity(e, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L34372">        }</span>
<span class="nc" id="L34373">    }</span>

    /**
     * let all Entities make their &quot;break-free-of-swamp-stickyness&quot; PSR
     */
    private void doTryUnstuck() {
<span class="nc bnc" id="L34379" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L34380">            return;</span>
        }

        Report r;

<span class="nc" id="L34385">        Iterator&lt;Entity&gt; stuckEntities = game.getSelectedEntities(Entity::isStuck);</span>
        PilotingRollData rollTarget;
<span class="nc bnc" id="L34387" title="All 2 branches missed.">        while (stuckEntities.hasNext()) {</span>
<span class="nc" id="L34388">            Entity entity = stuckEntities.next();</span>
<span class="nc bnc" id="L34389" title="All 2 branches missed.">            if (entity.getPosition() == null) {</span>
<span class="nc bnc" id="L34390" title="All 2 branches missed.">                if (entity.isDeployed()) {</span>
<span class="nc" id="L34391">                    MegaMek.getLogger().info(&quot;Entity #&quot; + entity.getId() + &quot; does not know its position.&quot;);</span>
                } else { // If the Entity isn't deployed, then something goofy
                    // happened.  We'll just unstuck the Entity
<span class="nc" id="L34394">                    entity.setStuck(false);</span>
<span class="nc" id="L34395">                    MegaMek.getLogger().info(&quot;Entity #&quot; + entity.getId() + &quot; was stuck in a swamp, but not deployed. Stuck state reset&quot;);</span>
                }
<span class="nc" id="L34397">                continue;</span>
            }
<span class="nc" id="L34399">            rollTarget = entity.getBasePilotingRoll();</span>
<span class="nc" id="L34400">            entity.addPilotingModifierForTerrain(rollTarget);</span>
            // apart from swamp &amp; liquid magma, -1 modifier
<span class="nc" id="L34402">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc" id="L34403">            hex.getUnstuckModifier(entity.getElevation(), rollTarget);</span>
            // okay, print the info
<span class="nc" id="L34405">            r = new Report(2340);</span>
<span class="nc" id="L34406">            r.addDesc(entity);</span>
<span class="nc" id="L34407">            addReport(r);</span>

            // roll
<span class="nc" id="L34410">            final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L34411">            r = new Report(2190);</span>
<span class="nc" id="L34412">            r.subject = entity.getId();</span>
<span class="nc" id="L34413">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L34414">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L34415">            r.add(diceRoll);</span>
<span class="nc bnc" id="L34416" title="All 2 branches missed.">            if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L34417">                r.choose(false);</span>
            } else {
<span class="nc" id="L34419">                r.choose(true);</span>
<span class="nc" id="L34420">                entity.setStuck(false);</span>
<span class="nc" id="L34421">                entity.setCanUnstickByJumping(false);</span>
<span class="nc" id="L34422">                entity.setElevation(0);</span>
<span class="nc" id="L34423">                entityUpdate(entity.getId());</span>
            }
<span class="nc" id="L34425">            addReport(r);</span>
<span class="nc" id="L34426">        }</span>
<span class="nc" id="L34427">    }</span>

    /**
     * Remove all iNarc pods from all vehicles that did not move and shoot this
     * round NOTE: this is not quite what the rules say, the player should be
     * able to choose whether or not to remove all iNarc Pods that are attached.
     */
    private void resolveVeeINarcPodRemoval() {
<span class="nc" id="L34435">        Iterator&lt;Entity&gt; vees = game.getSelectedEntities(</span>
<span class="nc bnc" id="L34436" title="All 4 branches missed.">                entity -&gt; (entity instanceof Tank) &amp;&amp; (entity.mpUsed == 0));</span>
        boolean canSwipePods;
<span class="nc bnc" id="L34438" title="All 2 branches missed.">        while (vees.hasNext()) {</span>
<span class="nc" id="L34439">            canSwipePods = true;</span>
<span class="nc" id="L34440">            Entity entity = vees.next();</span>
<span class="nc bnc" id="L34441" title="All 2 branches missed.">            for (int i = 0; i &lt;= 5; i++) {</span>
<span class="nc bnc" id="L34442" title="All 2 branches missed.">                if (entity.weaponFiredFrom(i)) {</span>
<span class="nc" id="L34443">                    canSwipePods = false;</span>
                }
            }
<span class="nc bnc" id="L34446" title="All 2 branches missed.">            if (((Tank) entity).getStunnedTurns() &gt; 0) {</span>
<span class="nc" id="L34447">                canSwipePods = false;</span>
            }
<span class="nc bnc" id="L34449" title="All 4 branches missed.">            if (canSwipePods &amp;&amp; entity.hasINarcPodsAttached()</span>
<span class="nc bnc" id="L34450" title="All 2 branches missed.">                &amp;&amp; entity.getCrew().isActive()) {</span>
<span class="nc" id="L34451">                entity.removeAllINarcPods();</span>
<span class="nc" id="L34452">                Report r = new Report(2345);</span>
<span class="nc" id="L34453">                r.addDesc(entity);</span>
<span class="nc" id="L34454">                addReport(r);</span>
            }
<span class="nc" id="L34456">        }</span>
<span class="nc" id="L34457">    }</span>

    /*
     * //See note above where knownDeadEntities variable is declared private
     * void deadEntitiesCleanup() { Entity en = null; for(Enumeration k =
     * game.getGraveyardEntities(); k.hasMoreElements(); en = (Entity)
     * k.nextElement()) { if (en != null) { if (!knownDeadEntities.contains(en))
     * { knownDeadEntities.add(en); } } } }
     */

    /**
     * remove Ice in the hex that's at the passed coords, and let entities fall
     * into water below it, if there is water
     *
     * @param c the &lt;code&gt;Coords&lt;/code&gt; of the hex where ice should be removed
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; for the phase report
     */
    private Vector&lt;Report&gt; resolveIceBroken(Coords c) {
<span class="nc" id="L34475">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L34476">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L34477">        hex.removeTerrain(Terrains.ICE);</span>
<span class="nc" id="L34478">        sendChangedHex(c);</span>
        // if there is water below the ice
<span class="nc bnc" id="L34480" title="All 2 branches missed.">        if (hex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
            // drop entities on the surface into the water
<span class="nc bnc" id="L34482" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector(c)) {</span>
                // If the unit is on the surface, and is no longer allowed in
                // the hex
<span class="nc bnc" id="L34485" title="All 2 branches missed.">                boolean isHoverOrWiGE = (e.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34486" title="All 2 branches missed.">                        || (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc bnc" id="L34487" title="All 2 branches missed.">                if ((e.getElevation() == 0)</span>
<span class="nc bnc" id="L34488" title="All 4 branches missed.">                        &amp;&amp; !(hex.containsTerrain(Terrains.BLDG_ELEV, 0))</span>
<span class="nc bnc" id="L34489" title="All 2 branches missed.">                        &amp;&amp; !(isHoverOrWiGE &amp;&amp; (e.getRunMP() &gt;= 0))</span>
<span class="nc bnc" id="L34490" title="All 2 branches missed.">                        &amp;&amp; (e.getMovementMode() != EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L34491" title="All 4 branches missed.">                        &amp;&amp; !e.hasUMU()</span>
<span class="nc bnc" id="L34492" title="All 2 branches missed.">                        &amp;&amp; !(e instanceof QuadVee &amp;&amp; e.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)) {</span>
<span class="nc" id="L34493">                    vPhaseReport.addAll(doEntityFallsInto(e, c,</span>
                            new PilotingRollData(TargetRoll.AUTOMATIC_FAIL),
                            true));
                }
<span class="nc" id="L34497">            }</span>
        }
<span class="nc" id="L34499">        return vPhaseReport;</span>
    }

    /**
     * melt any snow or ice in a hex, including checking for the effects of
     * breaking through ice
     */
    private Vector&lt;Report&gt; meltIceAndSnow(Coords c, int entityId) {
<span class="nc" id="L34507">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L34509">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L34510">        r = new Report(3069);</span>
<span class="nc" id="L34511">        r.indent(2);</span>
<span class="nc" id="L34512">        r.subject = entityId;</span>
<span class="nc" id="L34513">        vDesc.add(r);</span>
<span class="nc bnc" id="L34514" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L34515">            hex.removeTerrain(Terrains.SNOW);</span>
<span class="nc" id="L34516">            sendChangedHex(c);</span>
        }
<span class="nc bnc" id="L34518" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34519">            vDesc.addAll(resolveIceBroken(c));</span>
        }
        // if we were not in water, then add mud
<span class="nc bnc" id="L34522" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L34523" title="All 2 branches missed.">            &amp;&amp; !hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L34524">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.MUD, 1));
<span class="nc" id="L34526">            sendChangedHex(c);</span>
        }
<span class="nc" id="L34528">        return vDesc;</span>
    }

    /**
     * check to see if a swamp hex becomes quicksand
     */
    private Vector&lt;Report&gt; checkQuickSand(Coords c) {
<span class="nc" id="L34535">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L34537">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L34538" title="All 2 branches missed.">        if (hex.terrainLevel(Terrains.SWAMP) == 1) {</span>
<span class="nc bnc" id="L34539" title="All 2 branches missed.">            if (Compute.d6(2) == 12) {</span>
                // better find a rope
<span class="nc" id="L34541">                hex.removeTerrain(Terrains.SWAMP);</span>
<span class="nc" id="L34542">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.SWAMP, 2));</span>
<span class="nc" id="L34543">                sendChangedHex(c);</span>
<span class="nc" id="L34544">                r = new Report(2440);</span>
<span class="nc" id="L34545">                r.indent(1);</span>
<span class="nc" id="L34546">                vDesc.add(r);</span>
            }
        }
<span class="nc" id="L34549">        return vDesc;</span>
    }

    /**
     * check for vehicle fire, according to the MaxTech rules
     *
     * @param tank    the &lt;code&gt;Tank&lt;/code&gt; to be checked
     * @param inferno a &lt;code&gt;boolean&lt;/code&gt; parameter whether or not this check is
     *                because of inferno fire
     */
    public Vector&lt;Report&gt; checkForVehicleFire(Tank tank, boolean inferno) {
<span class="nc" id="L34560">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L34561">        int boomRoll = Compute.d6(2);</span>
<span class="nc" id="L34562">        int penalty = 0;</span>
<span class="nc bnc" id="L34563" title="All 3 branches missed.">        switch (tank.getMovementMode()) {</span>
            case HOVER:
<span class="nc" id="L34565">                penalty = 4;</span>
<span class="nc" id="L34566">                break;</span>
            case VTOL:
            case WHEELED:
<span class="nc" id="L34569">                penalty = 2;</span>
<span class="nc" id="L34570">                break;</span>
            default:
                break;
        }
<span class="nc bnc" id="L34574" title="All 2 branches missed.">        if (inferno) {</span>
<span class="nc" id="L34575">            boomRoll = 12;</span>
        }
<span class="nc" id="L34577">        Report r = new Report(5250);</span>
<span class="nc" id="L34578">        r.subject = tank.getId();</span>
<span class="nc" id="L34579">        r.addDesc(tank);</span>
<span class="nc" id="L34580">        r.add(8 - penalty);</span>
<span class="nc" id="L34581">        r.add(boomRoll);</span>
<span class="nc bnc" id="L34582" title="All 2 branches missed.">        if ((boomRoll + penalty) &lt; 8) {</span>
            // phew!
<span class="nc" id="L34584">            r.choose(true);</span>
<span class="nc" id="L34585">            vPhaseReport.add(r);</span>
        } else {
            // eek
<span class="nc bnc" id="L34588" title="All 2 branches missed.">            if (!inferno) {</span>
<span class="nc" id="L34589">                r.choose(false);</span>
<span class="nc" id="L34590">                vPhaseReport.add(r);</span>
            }
<span class="nc bnc" id="L34592" title="All 2 branches missed.">            if ((boomRoll + penalty) &lt; 10) {</span>
<span class="nc" id="L34593">                addReport(vehicleMotiveDamage(tank, penalty - 1));</span>
            } else {
<span class="nc" id="L34595">                vPhaseReport.addAll(resolveVehicleFire(tank, false));</span>
<span class="nc bnc" id="L34596" title="All 2 branches missed.">                if ((boomRoll + penalty) &gt;= 12) {</span>
<span class="nc" id="L34597">                    r = new Report(5255);</span>
<span class="nc" id="L34598">                    r.subject = tank.getId();</span>
<span class="nc" id="L34599">                    r.indent(3);</span>
<span class="nc" id="L34600">                    vPhaseReport.add(r);</span>
<span class="nc" id="L34601">                    tank.setOnFire(inferno);</span>
                }
            }
        }
<span class="nc" id="L34605">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; resolveVehicleFire(Tank tank, boolean existingStatus) {
<span class="nc" id="L34609">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L34610" title="All 4 branches missed.">        if (existingStatus &amp;&amp; !tank.isOnFire()) {</span>
<span class="nc" id="L34611">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L34613" title="All 2 branches missed.">        for (int i = 0; i &lt; tank.locations(); i++) {</span>
<span class="nc bnc" id="L34614" title="All 6 branches missed.">            if ((i == Tank.LOC_BODY) || ((tank instanceof VTOL) &amp;&amp; (i == VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L34615">                continue;</span>
            }
<span class="nc bnc" id="L34617" title="All 4 branches missed.">            if (existingStatus &amp;&amp; !tank.isLocationBurning(i)) {</span>
<span class="nc" id="L34618">                continue;</span>
            }
<span class="nc" id="L34620">            HitData hit = new HitData(i);</span>
<span class="nc" id="L34621">            int damage = Compute.d6(1);</span>
<span class="nc" id="L34622">            vPhaseReport.addAll(damageEntity(tank, hit, damage));</span>
<span class="nc bnc" id="L34623" title="All 4 branches missed.">            if ((damage == 1) &amp;&amp; existingStatus) {</span>
<span class="nc" id="L34624">                tank.extinguishLocation(i);</span>
            }
        }
<span class="nc" id="L34627">        return vPhaseReport;</span>
    }

    public Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier) {
<span class="nc" id="L34631">        return vehicleMotiveDamage(te, modifier, false, -1, false);</span>
    }

    private Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier, boolean noRoll,
                                               int damageType) {
<span class="nc" id="L34636">        return vehicleMotiveDamage(te, modifier, noRoll, damageType, false);</span>
    }

    /**
     * do vehicle movement damage
     *
     * @param te         the Tank to damage
     * @param modifier   the modifier to the roll
     * @param noRoll     don't roll, immediately deal damage
     * @param damageType the type to deal (1 = minor, 2 = moderate, 3 = heavy
     * @param jumpDamage is this a movement damage roll from using vehicular JJs
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing what to add to the turn log
     */
    private Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier, boolean noRoll,
                                               int damageType, boolean jumpDamage) {
<span class="nc" id="L34651">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L34653" title="All 6 branches missed.">        switch (te.getMovementMode()) {</span>
            case HOVER:
            case HYDROFOIL:
<span class="nc bnc" id="L34656" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34657">                    modifier -= 1;</span>
                } else {
<span class="nc" id="L34659">                    modifier += 3;</span>
                }
<span class="nc" id="L34661">                break;</span>
            case WHEELED:
<span class="nc bnc" id="L34663" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34664">                    modifier += 1;</span>
                } else {
<span class="nc" id="L34666">                    modifier += 2;</span>
                }
<span class="nc" id="L34668">                break;</span>
            case WIGE:
<span class="nc bnc" id="L34670" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34671">                    modifier -= 2;</span>
                } else {
<span class="nc" id="L34673">                    modifier += 4;</span>
                }
<span class="nc" id="L34675">                break;</span>
            case TRACKED:
<span class="nc bnc" id="L34677" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34678">                    modifier += 2;</span>
                }
                break;
            case VTOL:
                // VTOL don't roll, auto -1 MP as long as the rotor location
                // still exists (otherwise don't bother reporting).
<span class="nc bnc" id="L34684" title="All 4 branches missed.">                if (!(te.isLocationBad(VTOL.LOC_ROTOR) || te.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L34685">                    te.setMotiveDamage(te.getMotiveDamage() + 1);</span>
<span class="nc bnc" id="L34686" title="All 2 branches missed.">                    if (te.getOriginalWalkMP() &gt; te.getMotiveDamage()) {</span>
<span class="nc" id="L34687">                        r = new Report(6660);</span>
<span class="nc" id="L34688">                        r.indent(3);</span>
<span class="nc" id="L34689">                        r.subject = te.getId();</span>
<span class="nc" id="L34690">                        vDesc.add(r);</span>
                    } else {
<span class="nc" id="L34692">                        r = new Report(6670);</span>
<span class="nc" id="L34693">                        r.subject = te.getId();</span>
<span class="nc" id="L34694">                        vDesc.add(r);</span>
<span class="nc" id="L34695">                        te.immobilize();</span>
                        // Being reduced to 0 MP by rotor damage forces a
                        // landing
                        // like an engine hit...
<span class="nc bnc" id="L34699" title="All 2 branches missed.">                        if (te.isAirborneVTOLorWIGE()</span>
                            // ...but don't bother to resolve that if we're
                            // already otherwise destroyed.
<span class="nc bnc" id="L34702" title="All 4 branches missed.">                            &amp;&amp; !(te.isDestroyed() || te.isDoomed())) {</span>
<span class="nc" id="L34703">                            vDesc.addAll(forceLandVTOLorWiGE(te));</span>
                        }
                    }
                }
                // This completes our handling of VTOLs; the rest of the method
                // doesn't need to worry about them anymore.
<span class="nc" id="L34709">                return vDesc;</span>
            default:
                break;
        }
        // Apply vehicle effectiveness...except for jumps.
<span class="nc bnc" id="L34714" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)</span>
                &amp;&amp; !jumpDamage) {
<span class="nc" id="L34716">            modifier = Math.max(modifier - 1, 0);</span>
        }

<span class="nc bnc" id="L34719" title="All 2 branches missed.">        if (te.hasWorkingMisc(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L34720">            modifier -= 2;</span>
        }
<span class="nc" id="L34722">        int roll = Compute.d6(2) + modifier;</span>
<span class="nc" id="L34723">        r = new Report(6306);</span>
<span class="nc" id="L34724">        r.subject = te.getId();</span>
<span class="nc" id="L34725">        r.newlines = 0;</span>
<span class="nc" id="L34726">        r.indent(3);</span>
<span class="nc" id="L34727">        vDesc.add(r);</span>
<span class="nc bnc" id="L34728" title="All 2 branches missed.">        if (!noRoll) {</span>
<span class="nc" id="L34729">            r = new Report(6310);</span>
<span class="nc" id="L34730">            r.subject = te.getId();</span>
<span class="nc" id="L34731">            r.add(roll);</span>
<span class="nc" id="L34732">            r.newlines = 0;</span>
<span class="nc" id="L34733">            vDesc.add(r);</span>
<span class="nc" id="L34734">            r = new Report(3340);</span>
<span class="nc" id="L34735">            r.add(modifier);</span>
<span class="nc" id="L34736">            r.subject = te.getId();</span>
<span class="nc" id="L34737">            vDesc.add(r);</span>
        }

<span class="nc bnc" id="L34740" title="All 8 branches missed.">        if ((noRoll &amp;&amp; (damageType == 0)) || (!noRoll &amp;&amp; (roll &lt;= 5))) {</span>
            // no effect
<span class="nc" id="L34742">            r = new Report(6005);</span>
<span class="nc" id="L34743">            r.subject = te.getId();</span>
<span class="nc" id="L34744">            r.indent(3);</span>
<span class="nc" id="L34745">            vDesc.add(r);</span>
<span class="nc bnc" id="L34746" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 1)) || (!noRoll &amp;&amp; (roll &lt;= 7))) {</span>
            // minor damage
<span class="nc" id="L34748">            r = new Report(6470);</span>
<span class="nc" id="L34749">            r.subject = te.getId();</span>
<span class="nc" id="L34750">            r.indent(3);</span>
<span class="nc" id="L34751">            vDesc.add(r);</span>
<span class="nc" id="L34752">            te.addMovementDamage(1);</span>
<span class="nc bnc" id="L34753" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 2)) || (!noRoll &amp;&amp; (roll &lt;= 9))) {</span>
            // moderate damage
<span class="nc" id="L34755">            r = new Report(6471);</span>
<span class="nc" id="L34756">            r.subject = te.getId();</span>
<span class="nc" id="L34757">            r.indent(3);</span>
<span class="nc" id="L34758">            vDesc.add(r);</span>
<span class="nc" id="L34759">            te.addMovementDamage(2);</span>
<span class="nc bnc" id="L34760" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 3)) || (!noRoll &amp;&amp; (roll &lt;= 11))) {</span>
            // heavy damage
<span class="nc" id="L34762">            r = new Report(6472);</span>
<span class="nc" id="L34763">            r.subject = te.getId();</span>
<span class="nc" id="L34764">            r.indent(3);</span>
<span class="nc" id="L34765">            vDesc.add(r);</span>
<span class="nc" id="L34766">            te.addMovementDamage(3);</span>
        } else {
<span class="nc" id="L34768">            r = new Report(6473);</span>
<span class="nc" id="L34769">            r.subject = te.getId();</span>
<span class="nc" id="L34770">            r.indent(3);</span>
<span class="nc" id="L34771">            vDesc.add(r);</span>
<span class="nc" id="L34772">            te.addMovementDamage(4);</span>
        }
        // These checks should perhaps be moved to Tank.applyDamage(), but I'm
        // unsure how to *report* any outcomes from there. Note that these treat
        // being reduced to 0 MP and being actually immobilized as the same thing,
        // which for these particular purposes may or may not be the intent of
        // the rules in all cases.
        // Immobile hovercraft on water sink...
<span class="nc bnc" id="L34780" title="All 2 branches missed.">        if (((te.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34781" title="All 4 branches missed.">                || ((te.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (te.getElevation() == 0)))</span>
<span class="nc bnc" id="L34782" title="All 4 branches missed.">                &amp;&amp; (te.isMovementHitPending() || (te.getWalkMP() &lt;= 0))</span>
                // HACK: Have to check for *pending* hit here and below.
<span class="nc bnc" id="L34784" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(te.getPosition()).terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34785" title="All 2 branches missed.">                &amp;&amp; !game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34786">            vDesc.addAll(destroyEntity(te, &quot;a watery grave&quot;, false));</span>
        }
        // ...while immobile WiGEs crash.
<span class="nc bnc" id="L34789" title="All 4 branches missed.">        if (((te.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (te.isAirborneVTOLorWIGE()))</span>
<span class="nc bnc" id="L34790" title="All 4 branches missed.">                &amp;&amp; (te.isMovementHitPending() || (te.getWalkMP() &lt;= 0))) {</span>
            // report problem: add tab
<span class="nc" id="L34792">            vDesc.addAll(crashVTOLorWiGE(te));</span>
        }
<span class="nc" id="L34794">        return vDesc;</span>
    }

    /**
     * Add a whole lotta Reports to the players report queues as well as the
     * Master report queue vPhaseReport.
     */
    private void addReport(Vector&lt;Report&gt; reports) {
<span class="nc" id="L34802">        vPhaseReport.addAll(reports);</span>
<span class="nc" id="L34803">    }</span>

    /**
     * Add a whole lotta Reports to the players report queues as well as the
     * Master report queue vPhaseReport, indenting each report by the passed
     * value.
     */
    private void addReport(Vector&lt;Report&gt; reports, int indents) {
<span class="nc bnc" id="L34811" title="All 2 branches missed.">        for (Report r : reports) {</span>
<span class="nc" id="L34812">            r.indent(indents);</span>
<span class="nc" id="L34813">            vPhaseReport.add(r);</span>
<span class="nc" id="L34814">        }</span>
<span class="nc" id="L34815">    }</span>

    /**
     * Add a single report to the report queue of all players and the master
     * vPhaseReport queue
     */
    private void addReport(Report report) {
<span class="nc" id="L34822">        vPhaseReport.addElement(report);</span>
<span class="nc" id="L34823">    }</span>

    /**
     * New Round has started clear everyone's report queue
     */
    private void clearReports() {
<span class="nc" id="L34829">        vPhaseReport.removeAllElements();</span>
<span class="nc" id="L34830">    }</span>

    /**
     * make sure all the new lines that were added to the old vPhaseReport get
     * added to all of the players filters
     */
    private void addNewLines() {
<span class="nc" id="L34837">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L34838">    }</span>

    /**
     * resolve the landing of an assault drop
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; for which to resolve it
     */
    public void doAssaultDrop(Entity entity) {
        //resolve according to SO p.22

<span class="nc" id="L34848">        Report r = new Report(2380);</span>

        // whatever else happens, this entity is on the ground now
<span class="nc" id="L34851">        entity.setAltitude(0);</span>

        PilotingRollData psr;
        // LAMs that convert to fighter mode on the landing turn are processed as crashes
<span class="nc bnc" id="L34855" title="All 2 branches missed.">        if ((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L34856" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER)) {</span>
<span class="nc" id="L34857">            addReport(processCrash(entity, 0, entity.getPosition()));</span>
<span class="nc" id="L34858">            return;</span>
        }
<span class="nc bnc" id="L34860" title="All 4 branches missed.">        if ((entity instanceof Protomech) || (entity instanceof BattleArmor)) {</span>
<span class="nc" id="L34861">            psr = new PilotingRollData(entity.getId(), 5, &quot;landing assault drop&quot;);</span>
<span class="nc bnc" id="L34862" title="All 2 branches missed.">        } else if (entity instanceof Infantry) {</span>
<span class="nc" id="L34863">            psr = new PilotingRollData(entity.getId(), 4, &quot;landing assault drop&quot;);</span>
        } else {
<span class="nc" id="L34865">            psr = entity.getBasePilotingRoll();</span>
        }
<span class="nc" id="L34867">        int roll = Compute.d6(2);</span>
        // check for a safe landing
<span class="nc" id="L34869">        addNewLines();</span>
<span class="nc" id="L34870">        r.subject = entity.getId();</span>
<span class="nc" id="L34871">        r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L34872">        r.add(psr);</span>
<span class="nc" id="L34873">        r.add(roll);</span>
<span class="nc" id="L34874">        r.newlines = 1;</span>
<span class="nc bnc" id="L34875" title="All 2 branches missed.">        r.choose(roll &gt;= psr.getValue());</span>
<span class="nc" id="L34876">        addReport(r);</span>

        // if we are on an atmospheric map or the entity is off the map for some reason
<span class="nc bnc" id="L34879" title="All 4 branches missed.">        if (game.getBoard().inAtmosphere() || entity.getPosition() == null) {</span>
            // then just remove the entity
            // TODO : for this and when the unit scatters off the board, we should really still
            // TODO : apply damage before we remove, but this causes all kinds of problems for
            // TODO : doEntityFallsInto and related methods which expect a coord on the board
            // TODO : - need to make those more robust
<span class="nc" id="L34885">            r = new Report(2388);</span>
<span class="nc" id="L34886">            addReport(r);</span>
<span class="nc" id="L34887">            r.subject = entity.getId();</span>
<span class="nc" id="L34888">            r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L34889">            game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34890">            return;</span>
        }

<span class="nc bnc" id="L34893" title="All 2 branches missed.">        if (roll &lt; psr.getValue()) {</span>
<span class="nc" id="L34894">            int fallHeight = psr.getValue() - roll;</span>

            // if you fail by more than 7, you automatically fail
<span class="nc bnc" id="L34897" title="All 2 branches missed.">            if (fallHeight &gt; 7) {</span>
<span class="nc" id="L34898">                addReport(destroyEntity(entity, &quot;failed assault drop&quot;, false, false));</span>
<span class="nc" id="L34899">                entityUpdate(entity.getId());</span>
<span class="nc" id="L34900">                return;</span>
            }

            // determine where we really land
<span class="nc" id="L34904">            Coords c = Compute.scatterAssaultDrop(entity.getPosition(), fallHeight);</span>
<span class="nc" id="L34905">            int distance = entity.getPosition().distance(c);</span>
<span class="nc" id="L34906">            r = new Report(2385);</span>
<span class="nc" id="L34907">            r.subject = entity.getId();</span>
<span class="nc" id="L34908">            r.add(distance);</span>
<span class="nc" id="L34909">            r.indent();</span>
<span class="nc" id="L34910">            r.newlines = 0;</span>
<span class="nc" id="L34911">            addReport(r);</span>
<span class="nc bnc" id="L34912" title="All 2 branches missed.">            if (!game.getBoard().contains(c)) {</span>
<span class="nc" id="L34913">                r = new Report(2386);</span>
<span class="nc" id="L34914">                addReport(r);</span>
<span class="nc" id="L34915">                game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34916">                return;</span>
            } else {
<span class="nc" id="L34918">                r = new Report(2387);</span>
<span class="nc" id="L34919">                r.add(c.getBoardNum());</span>
<span class="nc" id="L34920">                addReport(r);</span>
            }
<span class="nc" id="L34922">            entity.setPosition(c);</span>

            // do fall damage from accidental fall
            //set elevation to fall height above ground or building roof
<span class="nc" id="L34926">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34927" title="All 2 branches missed.">            int bldgElev = hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L34928">                    ? hex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L34929">            entity.setElevation(fallHeight + bldgElev);</span>
<span class="nc bnc" id="L34930" title="All 2 branches missed.">            if (entity.isConventionalInfantry()) {</span>
<span class="nc" id="L34931">                HitData hit = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L34932">                addReport(damageEntity(entity, hit, 1));</span>
                // LAMs that convert to fighter mode on the landing turn are processed as crashes regardless of roll
<span class="nc" id="L34934">            } else {</span>
<span class="nc" id="L34935">                addReport(doEntityFallsInto(entity, c, psr, true));</span>
            }
<span class="nc" id="L34937">        } else {</span>
            // set entity to expected elevation
<span class="nc" id="L34939">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34940" title="All 2 branches missed.">            int bldgElev = hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L34941">                    ? hex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L34942">            entity.setElevation(bldgElev);</span>

<span class="nc" id="L34944">            Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L34945" title="All 2 branches missed.">            if (bldg != null) {</span>
                // whoops we step on the roof
<span class="nc" id="L34947">                checkBuildingCollapseWhileMoving(bldg, entity, entity.getPosition());</span>
            }

            // finally, check for any stacking violations
<span class="nc" id="L34951">            Entity violated = Compute.stackingViolation(game, entity, entity.getPosition(), null);</span>
<span class="nc bnc" id="L34952" title="All 2 branches missed.">            if (violated != null) {</span>
                // StratOps explicitly says that this is not treated as an accident
                // fall from above
                // so we just need to displace the violating unit
                // check to see if the violating unit is a DropShip and if so, then
                // displace the unit dropping instead
<span class="nc bnc" id="L34958" title="All 2 branches missed.">                if (violated instanceof Dropship) {</span>
<span class="nc" id="L34959">                    violated = entity;</span>
                }
<span class="nc" id="L34961">                Coords targetDest = Compute.getValidDisplacement(game, violated.getId(),</span>
<span class="nc" id="L34962">                        violated.getPosition(), Compute.d6() - 1);</span>
<span class="nc bnc" id="L34963" title="All 2 branches missed.">                if (null != targetDest) {</span>
<span class="nc" id="L34964">                    doEntityDisplacement(violated, violated.getPosition(), targetDest, null);</span>
<span class="nc" id="L34965">                    entityUpdate(violated.getId());</span>
                } else {
                    // ack! automatic death! Tanks
                    // suffer an ammo/power plant hit.
                    // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L34970">                    vPhaseReport.addAll(destroyEntity(entity, &quot;impossible displacement&quot;,</span>
                            entity instanceof Mech, entity instanceof Mech));
                }
            }
        }
<span class="nc" id="L34975">    }</span>

    /**
     * resolve assault drops for all entities
     */
    void doAllAssaultDrops() {
<span class="nc bnc" id="L34981" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L34982" title="All 4 branches missed.">            if (e.isAssaultDropInProgress() &amp;&amp; e.isDeployed()) {</span>
<span class="nc" id="L34983">                doAssaultDrop(e);</span>
<span class="nc" id="L34984">                e.setLandedAssaultDrop();</span>
            }
<span class="nc" id="L34986">        }</span>
<span class="nc" id="L34987">    }</span>

    /**
     * do damage from magma
     *
     * @param en       the affected &lt;code&gt;Entity&lt;/code&gt;
     * @param eruption &lt;code&gt;boolean&lt;/code&gt; indicating whether or not this is because
     *                 of an eruption
     */
    void doMagmaDamage(Entity en, boolean eruption) {
<span class="nc bnc" id="L34997" title="All 4 branches missed.">        if ((((en.getMovementMode() == EntityMovementMode.VTOL) &amp;&amp; (en.getElevation() &gt; 0))</span>
<span class="nc bnc" id="L34998" title="All 2 branches missed.">                || (en.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34999" title="All 2 branches missed.">                || ((en.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L35000" title="All 6 branches missed.">                &amp;&amp; (en.getOriginalWalkMP() &gt; 0) &amp;&amp; !eruption)) &amp;&amp; !en.isImmobile()) {</span>
<span class="nc" id="L35001">            return;</span>
        }
        Report r;
<span class="nc" id="L35004">        boolean isMech = en instanceof Mech;</span>
<span class="nc bnc" id="L35005" title="All 2 branches missed.">        if (isMech) {</span>
<span class="nc" id="L35006">            r = new Report(2405);</span>
        } else {
<span class="nc" id="L35008">            r = new Report(2400);</span>
        }
<span class="nc" id="L35010">        r.addDesc(en);</span>
<span class="nc" id="L35011">        r.subject = en.getId();</span>
<span class="nc" id="L35012">        addReport(r);</span>
<span class="nc bnc" id="L35013" title="All 2 branches missed.">        if (isMech) {</span>
            HitData h;
<span class="nc bnc" id="L35015" title="All 2 branches missed.">            for (int i = 0; i &lt; en.locations(); i++) {</span>
<span class="nc bnc" id="L35016" title="All 6 branches missed.">                if (eruption || en.locationIsLeg(i) || en.isProne()) {</span>
<span class="nc" id="L35017">                    h = new HitData(i);</span>
<span class="nc" id="L35018">                    addReport(damageEntity(en, h, Compute.d6(2)));</span>
                }
            }
        } else {
<span class="nc" id="L35022">            addReport(destroyEntity(en, &quot;fell into magma&quot;, false, false));</span>
        }
<span class="nc" id="L35024">        addNewLines();</span>
<span class="nc" id="L35025">    }</span>

    /**
     * sink any entities in quicksand in the current hex
     */
    public void doSinkEntity(Entity en) {
        Report r;
<span class="nc" id="L35032">        r = new Report(2445);</span>
<span class="nc" id="L35033">        r.addDesc(en);</span>
<span class="nc" id="L35034">        r.subject = en.getId();</span>
<span class="nc" id="L35035">        addReport(r);</span>
<span class="nc" id="L35036">        en.setElevation(en.getElevation() - 1);</span>
        // if this means the entity is below the ground, then bye-bye!
<span class="nc bnc" id="L35038" title="All 2 branches missed.">        if (Math.abs(en.getElevation()) &gt; en.getHeight()) {</span>
<span class="nc" id="L35039">            addReport(destroyEntity(en, &quot;quicksand&quot;));</span>
        }
<span class="nc" id="L35041">    }</span>

    /**
     * deal area saturation damage to an individual hex
     *
     * @param coords         The hex being hit
     * @param attackSource   The location the attack came from. For hit table resolution
     * @param damage         Amount of damage to deal to each entity
     * @param ammo           The ammo type being used
     * @param subjectId      Subject for reports
     * @param killer         Who should be credited with kills
     * @param exclude        Entity that should take no damage (used for homing splash)
     * @param flak           Flak, hits flying units only, instead of flyers being immune
     * @param altitude       Absolute altitude for flak attack
     * @param vPhaseReport   The Vector of Reports for the phase report
     * @param asfFlak        Is this flak against ASF?
     * @param alreadyHit     a vector of unit ids for units that have already been hit that
     *                       will be ignored
     * @param variableDamage if true, treat damage as the number of six-sided dice to roll
     */
    public Vector&lt;Integer&gt; artilleryDamageHex(Coords coords,
            Coords attackSource, int damage, AmmoType ammo, int subjectId,
            Entity killer, Entity exclude, boolean flak, int altitude,
            Vector&lt;Report&gt; vPhaseReport, boolean asfFlak,
            Vector&lt;Integer&gt; alreadyHit, boolean variableDamage) {

<span class="nc" id="L35067">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35068" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L35069">            return alreadyHit; // not on board.</span>
        }

        Report r;

        // Non-flak artillery damages terrain
<span class="nc bnc" id="L35075" title="All 2 branches missed.">        if (!flak) {</span>
            // Report that damage applied to terrain, if there's TF to damage
<span class="nc" id="L35077">            IHex h = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35078" title="All 4 branches missed.">            if ((h != null) &amp;&amp; h.hasTerrainfactor()) {</span>
<span class="nc" id="L35079">                r = new Report(3384);</span>
<span class="nc" id="L35080">                r.indent(2);</span>
<span class="nc" id="L35081">                r.subject = subjectId;</span>
<span class="nc" id="L35082">                r.add(coords.getBoardNum());</span>
<span class="nc" id="L35083">                r.add(damage * 2);</span>
<span class="nc" id="L35084">                vPhaseReport.addElement(r);</span>
            }
            // Update hex and report any changes
<span class="nc" id="L35087">            Vector&lt;Report&gt; newReports = tryClearHex(coords, damage * 2, subjectId);</span>
<span class="nc bnc" id="L35088" title="All 2 branches missed.">            for (Report nr : newReports) {</span>
<span class="nc" id="L35089">                nr.indent(3);</span>
<span class="nc" id="L35090">            }</span>
<span class="nc" id="L35091">            vPhaseReport.addAll(newReports);</span>
        }
        
<span class="nc bnc" id="L35094" title="All 2 branches missed.">        boolean isFuelAirBomb = </span>
                ammo != null &amp;&amp;
<span class="nc bnc" id="L35096" title="All 2 branches missed.">                (BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_SMALL ||</span>
<span class="nc bnc" id="L35097" title="All 2 branches missed.">                BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_LARGE);</span>
        
<span class="nc" id="L35099">        Building bldg = game.getBoard().getBuildingAt(coords);</span>
<span class="nc" id="L35100">        int bldgAbsorbs = 0;</span>
<span class="nc bnc" id="L35101" title="All 4 branches missed.">        if ((bldg != null)</span>
<span class="nc bnc" id="L35102" title="All 2 branches missed.">                &amp;&amp; !(flak &amp;&amp; (((altitude &gt; hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L35103" title="All 2 branches missed.">                || (altitude &gt; hex.terrainLevel(Terrains.BRIDGE_ELEV)))))) {</span>
<span class="nc" id="L35104">            bldgAbsorbs = bldg.getAbsorbtion(coords);</span>
<span class="nc bnc" id="L35105" title="All 4 branches missed.">            if (!((ammo != null) &amp;&amp; (ammo.getMunitionType() == AmmoType.M_FLECHETTE))) {</span>
<span class="nc" id="L35106">                int actualDamage = damage;</span>
                
<span class="nc bnc" id="L35108" title="All 2 branches missed.">                if(isFuelAirBomb) {</span>
                    // light buildings take 1.5x damage from fuel-air bombs
<span class="nc bnc" id="L35110" title="All 2 branches missed.">                    if(bldg.getType() == Building.LIGHT) {</span>
<span class="nc" id="L35111">                        actualDamage = (int) Math.ceil(actualDamage * 1.5);</span>
                        
<span class="nc" id="L35113">                        r = new Report(9991);</span>
<span class="nc" id="L35114">                        r.indent(1);</span>
<span class="nc" id="L35115">                        r.subject = killer.getId();</span>
<span class="nc" id="L35116">                        r.newlines = 1;</span>
<span class="nc" id="L35117">                        vPhaseReport.addElement(r);</span>
                    } 

                    // armored and &quot;castle brian&quot; buildings take .5 damage from fuel-air bombs
                    // but I have no idea how to determine if a building is a castle or a brian
                    // note that being armored and being &quot;light&quot; are not mutually exclusive
<span class="nc bnc" id="L35123" title="All 2 branches missed.">                    if(bldg.getArmor(coords) &gt; 0) {</span>
<span class="nc" id="L35124">                        actualDamage = (int) Math.floor(actualDamage * .5);</span>
                        
<span class="nc" id="L35126">                        r = new Report(9992);</span>
<span class="nc" id="L35127">                        r.indent(1);</span>
<span class="nc" id="L35128">                        r.subject = killer.getId();</span>
<span class="nc" id="L35129">                        r.newlines = 1;</span>
<span class="nc" id="L35130">                        vPhaseReport.addElement(r);</span>
                    }
                }             
                
                
                // damage the building
<span class="nc" id="L35136">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, actualDamage, coords);</span>
<span class="nc bnc" id="L35137" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L35138">                    report.subject = subjectId;</span>
<span class="nc" id="L35139">                }</span>
<span class="nc" id="L35140">                vPhaseReport.addAll(buildingReport);</span>
            }
        }

<span class="nc bnc" id="L35144" title="All 4 branches missed.">        if (flak &amp;&amp; ((altitude &lt;= 0)</span>
<span class="nc bnc" id="L35145" title="All 2 branches missed.">                || (altitude &lt;= hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L35146" title="All 2 branches missed.">                || (altitude == hex.terrainLevel(Terrains.BRIDGE_ELEV)))) {</span>
            // Flak in this hex would only hit landed units
<span class="nc" id="L35148">            return alreadyHit;</span>
        }

        // get units in hex
<span class="nc bnc" id="L35152" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {  </span>
            // Check: is entity excluded?
<span class="nc bnc" id="L35154" title="All 4 branches missed.">            if ((entity == exclude) || alreadyHit.contains(entity.getId())) {</span>
<span class="nc" id="L35155">                continue;</span>
            } else {
<span class="nc" id="L35157">                alreadyHit.add(entity.getId());</span>
            }
            
<span class="nc" id="L35160">            AreaEffectHelper.artilleryDamageEntity(entity, damage, bldg, bldgAbsorbs, </span>
                    variableDamage, asfFlak, flak, altitude,
                    attackSource, ammo, coords, isFuelAirBomb,
                    killer, hex, subjectId, vPhaseReport, this);
<span class="nc" id="L35164">        }</span>

<span class="nc" id="L35166">        return alreadyHit;</span>
    }

    /**
     * deal area saturation damage to the map, used for artillery
     *
     * @param centre       The hex on which damage is centred
     * @param attackSource The position the attack came from
     * @param ammo         The ammo type doing the damage
     * @param subjectId    Subject for reports
     * @param killer       Who should be credited with kills
     * @param flak         Flak, hits flying units only, instead of flyers being immune
     * @param altitude     Absolute altitude for flak attack
     * @param mineClear    Does this clear mines?
     * @param vPhaseReport The Vector of Reports for the phase report
     * @param asfFlak      Is this flak against ASF?
     * @param attackingBA  How many BA suits are in the squad if this is a BA Tube arty
     *                     attack, -1 otherwise
     */
    public void artilleryDamageArea(Coords centre, Coords attackSource,
            AmmoType ammo, int subjectId, Entity killer, boolean flak,
            int altitude, boolean mineClear, Vector&lt;Report&gt; vPhaseReport,
            boolean asfFlak, int attackingBA) {
<span class="nc" id="L35189">        DamageFalloff damageFalloff = AreaEffectHelper.calculateDamageFallOff(ammo, attackingBA, mineClear);</span>
        
<span class="nc" id="L35191">        int damage = damageFalloff.damage;</span>
<span class="nc" id="L35192">        int falloff = damageFalloff.falloff;</span>
<span class="nc bnc" id="L35193" title="All 2 branches missed.">        if(damageFalloff.clusterMunitionsFlag) {</span>
<span class="nc" id="L35194">            attackSource = centre;</span>
        }
        
<span class="nc" id="L35197">        artilleryDamageArea(centre, attackSource, ammo, subjectId, killer,</span>
                damage, falloff, flak, altitude, vPhaseReport, asfFlak);
<span class="nc" id="L35199">    }</span>

    /**
     * Deals area-saturation damage to an area of the board. Used for artillery,
     * bombs, or anything else with linear decrease in damage
     *
     * @param centre
     *            The hex on which damage is centred
     * @param attackSource
     *            The position the attack came from
     * @param ammo
     *            The ammo type doing the damage
     * @param subjectId
     *            Subject for reports
     * @param killer
     *            Who should be credited with kills
     * @param damage
     *            Damage at ground zero
     * @param falloff
     *            Reduction in damage for each hex of distance
     * @param flak
     *            Flak, hits flying units only, instead of flyers being immune
     * @param altitude
     *            Absolute altitude for flak attack
     * @param vPhaseReport
     *            The Vector of Reports for the phase report
     * @param asfFlak
     *            Is this flak against ASF?
     */
    public void artilleryDamageArea(Coords centre, Coords attackSource, AmmoType ammo, int subjectId,
                                    Entity killer, int damage, int falloff, boolean flak, int altitude,
                                    Vector&lt;Report&gt; vPhaseReport, boolean asfFlak) {
<span class="nc" id="L35231">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L35232" title="All 2 branches missed.">        for (int ring = 0; damage &gt; 0; ring++, damage -= falloff) {</span>
<span class="nc" id="L35233">            List&lt;Coords&gt; hexes = centre.allAtDistance(ring);</span>
<span class="nc bnc" id="L35234" title="All 2 branches missed.">            for (Coords c : hexes) {</span>
<span class="nc" id="L35235">                alreadyHit = artilleryDamageHex(c, attackSource, damage, ammo,</span>
                        subjectId, killer, null, flak, altitude, vPhaseReport,
                        asfFlak, alreadyHit, false);
<span class="nc" id="L35238">            }</span>
<span class="nc" id="L35239">            attackSource = centre; // all splash comes from ground zero</span>
        }
<span class="nc" id="L35241">    }</span>

    public void deliverBombDamage(Coords centre, int type, int subjectId, Entity killer,
                                  Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L35245">        int range = 0;</span>
<span class="nc" id="L35246">        int damage = 10;</span>
<span class="nc bnc" id="L35247" title="All 2 branches missed.">        if (type == BombType.B_CLUSTER) {</span>
<span class="nc" id="L35248">            range = 1;</span>
<span class="nc" id="L35249">            damage = 5;</span>
        }
<span class="nc" id="L35251">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>

<span class="nc" id="L35253">        alreadyHit = artilleryDamageHex(centre, centre, damage, null,</span>
                subjectId, killer, null, false, 0, vPhaseReport, false,
                alreadyHit, false);
<span class="nc bnc" id="L35256" title="All 2 branches missed.">        if (range &gt; 0) {</span>
<span class="nc" id="L35257">            List&lt;Coords&gt; hexes = centre.allAtDistance(range);</span>
<span class="nc bnc" id="L35258" title="All 2 branches missed.">            for (Coords c : hexes) {</span>
<span class="nc" id="L35259">                alreadyHit = artilleryDamageHex(c, centre, damage, null,</span>
                        subjectId, killer, null, false, 0, vPhaseReport, false,
                        alreadyHit, false);
<span class="nc" id="L35262">            }</span>
        }
<span class="nc" id="L35264">    }</span>

    /**
     * deliver inferno bomb
     *
     * @param coords    the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     * @param ae        the attacking &lt;code&gt;entity&lt;code&gt;
     * @param subjectId the &lt;code&gt;int&lt;/code&gt; id of the target
     */
    public void deliverBombInferno(Coords coords, Entity ae, int subjectId,
                                   Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L35275">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
        // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L35278" title="All 2 branches missed.">        if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_BOMB) {</span>
<span class="nc" id="L35279">            ignite(coords, Terrains.FIRE_LVL_INFERNO_BOMB, vPhaseReport);</span>
        }
        // possibly melt ice and snow
<span class="nc bnc" id="L35282" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L35283">            vPhaseReport.addAll(meltIceAndSnow(coords, subjectId));</span>
        }
<span class="nc bnc" id="L35285" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {</span>
<span class="nc bnc" id="L35286" title="All 4 branches missed.">            if (entity.isAirborne() || entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L35287">                continue;</span>
            }
            // TacOps, p. 359 - treat as if hit by 5 inferno missiles
<span class="nc" id="L35290">            r = new Report(6696);</span>
<span class="nc" id="L35291">            r.indent(3);</span>
<span class="nc" id="L35292">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L35293">            r.subject = entity.getId();</span>
<span class="nc" id="L35294">            r.newlines = 0;</span>
<span class="nc" id="L35295">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L35296" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L35297">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L35299">            Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae, entity, 5);</span>
<span class="nc" id="L35300">            Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L35301">            vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L35302">        }</span>
<span class="nc" id="L35303">    }</span>

    /**
     * Resolve any Infantry units which are fortifying hexes
     */
    void resolveFortify() {
        Report r;
<span class="nc bnc" id="L35310" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L35311" title="All 2 branches missed.">            if (ent instanceof Infantry) {</span>
<span class="nc" id="L35312">                Infantry inf = (Infantry) ent;</span>
<span class="nc" id="L35313">                int dig = inf.getDugIn();</span>
<span class="nc bnc" id="L35314" title="All 2 branches missed.">                if (dig == Infantry.DUG_IN_WORKING) {</span>
<span class="nc" id="L35315">                    r = new Report(5300);</span>
<span class="nc" id="L35316">                    r.addDesc(inf);</span>
<span class="nc" id="L35317">                    r.subject = inf.getId();</span>
<span class="nc" id="L35318">                    addReport(r);</span>
<span class="nc bnc" id="L35319" title="All 2 branches missed.">                } else if (dig == Infantry.DUG_IN_FORTIFYING2) {</span>
<span class="nc" id="L35320">                    Coords c = inf.getPosition();</span>
<span class="nc" id="L35321">                    r = new Report(5305);</span>
<span class="nc" id="L35322">                    r.addDesc(inf);</span>
<span class="nc" id="L35323">                    r.add(c.getBoardNum());</span>
<span class="nc" id="L35324">                    r.subject = inf.getId();</span>
<span class="nc" id="L35325">                    addReport(r);</span>
                    // fortification complete - add to map
<span class="nc" id="L35327">                    IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L35328">                    hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FORTIFIED, 1));
<span class="nc" id="L35330">                    sendChangedHex(c);</span>
                    // Clear the dig in for any units in same hex, since they
                    // get it for free by fort
<span class="nc bnc" id="L35333" title="All 2 branches missed.">                    for (Entity ent2 : game.getEntitiesVector(c)) {</span>
<span class="nc bnc" id="L35334" title="All 2 branches missed.">                        if (ent2 instanceof Infantry) {</span>
<span class="nc" id="L35335">                            Infantry inf2 = (Infantry) ent;</span>
<span class="nc" id="L35336">                            inf2.setDugIn(Infantry.DUG_IN_NONE);</span>
                        }
<span class="nc" id="L35338">                    }</span>
                }
            }
<span class="nc" id="L35341">        }</span>
<span class="nc" id="L35342">    }</span>

    /**
     * Check if spikes get broken in the given location
     *
     * @param e   The {@link Entity} to check
     * @param loc The location index
     * @return    A report showing the results of the roll
     */
    private Report checkBreakSpikes(Entity e, int loc) {
<span class="nc" id="L35352">        int roll = Compute.d6(2);</span>
        Report r;
<span class="nc bnc" id="L35354" title="All 2 branches missed.">        if (roll &lt; 9) {</span>
<span class="nc" id="L35355">            r = new Report(4445);</span>
<span class="nc" id="L35356">            r.indent(2);</span>
<span class="nc" id="L35357">            r.add(roll);</span>
<span class="nc" id="L35358">            r.subject = e.getId();</span>
        } else {
<span class="nc" id="L35360">            r = new Report(4440);</span>
<span class="nc" id="L35361">            r.indent(2);</span>
<span class="nc" id="L35362">            r.add(roll);</span>
<span class="nc" id="L35363">            r.subject = e.getId();</span>
<span class="nc bnc" id="L35364" title="All 2 branches missed.">            for (Mounted m : e.getMisc()) {</span>
<span class="nc bnc" id="L35365" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_SPIKES)</span>
<span class="nc bnc" id="L35366" title="All 2 branches missed.">                        &amp;&amp; (m.getLocation() == loc)) {</span>
<span class="nc" id="L35367">                    m.setHit(true);</span>
                }
<span class="nc" id="L35369">            }</span>
        }
<span class="nc" id="L35371">        return r;</span>
    }

    /**
     * @return a &lt;code&gt;String&lt;/code&gt; representing the hostname
     */
    public String getHost() {
        try {
<span class="nc" id="L35379">            return InetAddress.getLocalHost().getHostName();</span>
<span class="nc" id="L35380">        } catch (UnknownHostException e) {</span>
<span class="nc" id="L35381">            e.printStackTrace();</span>
<span class="nc" id="L35382">            return &quot;&quot;;</span>
        }
    }

    /**
     * @return the &lt;code&gt;int&lt;/code&gt; this server is listening on
     */
    public int getPort() {
<span class="nc" id="L35390">        return serverSocket.getLocalPort();</span>
    }

    /**
     * Loops through all the attacks the game has. Checks if they care about
     * current phase, if so, runs them, and removes them if they don't want to
     * stay. TODO : Refactor the new entity announcement out of here.
     */
    private void handleAttacks() {
<span class="nc" id="L35399">        handleAttacks(false);</span>
<span class="nc" id="L35400">    }</span>

    private void handleAttacks(boolean pointblankShot) {
        Report r;
<span class="nc" id="L35404">        int lastAttackerId = -1;</span>
        Vector&lt;AttackHandler&gt; currentAttacks, keptAttacks;
<span class="nc" id="L35406">        currentAttacks = game.getAttacksVector();</span>
<span class="nc" id="L35407">        keptAttacks = new Vector&lt;&gt;();</span>
<span class="nc" id="L35408">        Vector&lt;Report&gt; handleAttackReports = new Vector&lt;&gt;();</span>
        // first, do any TAGs, so homing arty will have TAG
<span class="nc bnc" id="L35410" title="All 2 branches missed.">        for (AttackHandler ah : currentAttacks) {</span>
<span class="nc bnc" id="L35411" title="All 2 branches missed.">            if (!(ah instanceof TAGHandler)) {</span>
<span class="nc" id="L35412">                continue;</span>
            }
<span class="nc bnc" id="L35414" title="All 2 branches missed.">            if (ah.cares(game.getPhase())) {</span>
<span class="nc" id="L35415">                int aId = ah.getAttackerId();</span>
<span class="nc bnc" id="L35416" title="All 4 branches missed.">                if ((aId != lastAttackerId) &amp;&amp; !ah.announcedEntityFiring()) {</span>
                    // report who is firing
<span class="nc bnc" id="L35418" title="All 2 branches missed.">                    if (pointblankShot) {</span>
<span class="nc" id="L35419">                        r = new Report(3102);</span>
                    } else {
<span class="nc" id="L35421">                        r = new Report(3100);</span>
                    }
<span class="nc" id="L35423">                    r.subject = aId;</span>
<span class="nc" id="L35424">                    Entity ae = game.getEntity(aId);</span>
<span class="nc" id="L35425">                    r.addDesc(ae);</span>
<span class="nc" id="L35426">                    handleAttackReports.addElement(r);</span>
<span class="nc" id="L35427">                    ah.setAnnouncedEntityFiring(true);</span>
<span class="nc" id="L35428">                    lastAttackerId = aId;</span>
                }
<span class="nc" id="L35430">                boolean keep = ah.handle(game.getPhase(), handleAttackReports);</span>
<span class="nc bnc" id="L35431" title="All 2 branches missed.">                if (keep) {</span>
<span class="nc" id="L35432">                    keptAttacks.add(ah);</span>
                }
<span class="nc" id="L35434">                Report.addNewline(handleAttackReports);</span>
            }
<span class="nc" id="L35436">        }</span>
        // now resolve everything but TAG
<span class="nc bnc" id="L35438" title="All 2 branches missed.">        for (AttackHandler ah : currentAttacks) {</span>
<span class="nc bnc" id="L35439" title="All 2 branches missed.">            if (ah instanceof TAGHandler) {</span>
<span class="nc" id="L35440">                continue;</span>
            }
<span class="nc bnc" id="L35442" title="All 2 branches missed.">            if (ah.cares(game.getPhase())) {</span>
<span class="nc" id="L35443">                int aId = ah.getAttackerId();</span>
<span class="nc bnc" id="L35444" title="All 4 branches missed.">                if ((aId != lastAttackerId) &amp;&amp; !ah.announcedEntityFiring()) {</span>
                    // if this is a new attacker then resolve any
                    // standard-to-cap damage
                    // from previous
<span class="nc" id="L35448">                    handleAttackReports.addAll(checkFatalThresholds(aId,</span>
                            lastAttackerId));
                    // report who is firing
<span class="nc bnc" id="L35451" title="All 2 branches missed.">                    if (pointblankShot) {</span>
<span class="nc" id="L35452">                        r = new Report(3102);</span>
<span class="nc bnc" id="L35453" title="All 2 branches missed.">                    } else if (ah.isStrafing()) {</span>
<span class="nc" id="L35454">                        r = new Report(3101);</span>
                    } else {
<span class="nc" id="L35456">                        r = new Report(3100);</span>
                    }
<span class="nc" id="L35458">                    r.subject = aId;</span>
<span class="nc" id="L35459">                    Entity ae = game.getEntity(aId);</span>
                    // for arty, attacker may be dead, or fled, so check out-of-
                    // game entities
<span class="nc bnc" id="L35462" title="All 2 branches missed.">                    if (ae == null) {</span>
<span class="nc" id="L35463">                        ae = game.getOutOfGameEntity(aId);</span>
                    }
<span class="nc" id="L35465">                    r.addDesc(ae);</span>
<span class="nc" id="L35466">                    handleAttackReports.addElement(r);</span>
<span class="nc" id="L35467">                    ah.setAnnouncedEntityFiring(true);</span>
<span class="nc" id="L35468">                    lastAttackerId = aId;</span>
                }
<span class="nc" id="L35470">                boolean keep = ah.handle(game.getPhase(), handleAttackReports);</span>
<span class="nc bnc" id="L35471" title="All 2 branches missed.">                if (keep) {</span>
<span class="nc" id="L35472">                    keptAttacks.add(ah);</span>
                }
<span class="nc" id="L35474">                Report.addNewline(handleAttackReports);</span>
<span class="nc" id="L35475">            } else {</span>
<span class="nc" id="L35476">                keptAttacks.add(ah);</span>
            }
<span class="nc" id="L35478">        }</span>
        // resolve standard to capital one more time
<span class="nc" id="L35480">        handleAttackReports.addAll(checkFatalThresholds(lastAttackerId,</span>
                lastAttackerId));
<span class="nc bnc" id="L35482" title="All 2 branches missed.">        if (handleAttackReports.size() &gt; 0) {</span>
<span class="nc" id="L35483">            Report.addNewline(handleAttackReports);</span>
        }
<span class="nc" id="L35485">        addReport(handleAttackReports);</span>
        // HACK, but anything else seems to run into weird problems.
<span class="nc" id="L35487">        game.setAttacksVector(keptAttacks);</span>
<span class="nc" id="L35488">    }</span>

    /**
     * @return the current server instance
     */
    public static Server getServerInstance() {
<span class="fc" id="L35494">        return serverInstance;</span>
    }

    /**
     * create a &lt;code&gt;SmokeCloud&lt;/code&gt; object and add it to the server list
     *
     * @param coords   the location to create the smoke
     * @param level    1=Light 2=Heavy Smoke 3:light LI smoke 4: Heavy LI smoke
     * @param duration How long the smoke will last.
     */
    public void createSmoke(Coords coords, int level, int duration) {
<span class="nc" id="L35505">        SmokeCloud cloud = new SmokeCloud(coords, level, duration);</span>
<span class="nc" id="L35506">        game.addSmokeCloud(cloud);</span>
<span class="nc" id="L35507">        sendSmokeCloudAdded(cloud);</span>
<span class="nc" id="L35508">    }</span>

    /**
     * create a &lt;code&gt;SmokeCloud&lt;/code&gt; object and add it to the server list
     *
     * @param coords   the location to create the smoke
     * @param level    1=Light 2=Heavy Smoke 3:light LI smoke 4: Heavy LI smoke
     * @param duration duration How long the smoke will last.
     */
    public void createSmoke(ArrayList&lt;Coords&gt; coords, int level, int duration) {
<span class="nc" id="L35518">        SmokeCloud cloud = new SmokeCloud(coords, level, duration);</span>
<span class="nc" id="L35519">        game.addSmokeCloud(cloud);</span>
<span class="nc" id="L35520">        sendSmokeCloudAdded(cloud);</span>
<span class="nc" id="L35521">    }</span>

    /**
     * Update the map with a new set of coords.
     *
     * @param newCoords the location to move the smoke to
     */
    public void updateSmoke(SmokeCloud cloud, ArrayList&lt;Coords&gt; newCoords) {
<span class="nc" id="L35529">        removeSmokeTerrain(cloud);</span>
<span class="nc" id="L35530">        cloud.getCoordsList().clear();</span>
<span class="nc" id="L35531">        cloud.getCoordsList().addAll(newCoords);</span>
<span class="nc" id="L35532">    }</span>

    /**
     * remove a cloud from the map
     *
     * @param cloud the location to remove the smoke from
     */
    public void removeSmokeTerrain(SmokeCloud cloud) {
<span class="nc bnc" id="L35540" title="All 2 branches missed.">        for (Coords coords : cloud.getCoordsList()) {</span>
<span class="nc" id="L35541">            IHex nextHex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35542" title="All 4 branches missed.">            if ((nextHex != null) &amp;&amp; nextHex.containsTerrain(Terrains.SMOKE)) {</span>
<span class="nc" id="L35543">                nextHex.removeTerrain(Terrains.SMOKE);</span>
<span class="nc" id="L35544">                sendChangedHex(coords);</span>
            }
<span class="nc" id="L35546">        }</span>
<span class="nc" id="L35547">    }</span>

    public List&lt;SmokeCloud&gt; getSmokeCloudList() {
<span class="nc" id="L35550">        return game.getSmokeCloudList();</span>
    }

    /**
     * Check to see if blowing sand caused damage to airborne VTOL/WIGEs
     */
    private Vector&lt;Report&gt; resolveBlowingSandDamage() {
<span class="nc" id="L35557">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L35558">        vFullReport.add(new Report(5002, Report.PUBLIC));</span>
<span class="nc" id="L35559">        int damage_bonus = Math.max(0, game.getPlanetaryConditions().getWindStrength()</span>
                - PlanetaryConditions.WI_MOD_GALE);
        // cycle through each team and damage 1d6 airborne VTOL/WiGE
<span class="nc bnc" id="L35562" title="All 2 branches missed.">        for (Enumeration&lt;Team&gt; loop = game.getTeams(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L35563">            Team team = loop.nextElement();</span>
<span class="nc" id="L35564">            Vector&lt;Integer&gt; airborne = team.getAirborneVTOL();</span>
<span class="nc bnc" id="L35565" title="All 2 branches missed.">            if (airborne.size() &gt; 0) {</span>
                // how many units are affected
<span class="nc" id="L35567">                int unitsAffected = Math.min(Compute.d6(), airborne.size());</span>
<span class="nc bnc" id="L35568" title="All 4 branches missed.">                while ((unitsAffected &gt; 0) &amp;&amp; (airborne.size() &gt; 0)) {</span>
<span class="nc" id="L35569">                    int loc = Compute.randomInt(airborne.size());</span>
<span class="nc" id="L35570">                    Entity en = game.getEntity(airborne.get(loc));</span>
<span class="nc" id="L35571">                    int damage = Math.max(1, Compute.d6() / 2) + damage_bonus;</span>
<span class="nc bnc" id="L35572" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L35573">                        HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_RANDOM);</span>
<span class="nc" id="L35574">                        vFullReport.addAll(damageEntity(en, hit, 1));</span>
<span class="nc" id="L35575">                        damage--;</span>
<span class="nc" id="L35576">                    }</span>
<span class="nc" id="L35577">                    unitsAffected--;</span>
<span class="nc" id="L35578">                    airborne.remove(loc);</span>
<span class="nc" id="L35579">                }</span>
            }
<span class="nc" id="L35581">        }</span>
<span class="nc" id="L35582">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L35583">        return vFullReport;</span>
    }

    /**
     * let an entity lay a mine
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that should lay a mine
     * @param mineId an &lt;code&gt;int&lt;/code&gt; pointing to the mine
     */
    private void layMine(Entity entity, int mineId, Coords coords) {
<span class="nc" id="L35593">        Mounted mine = entity.getEquipment(mineId);</span>
        Report r;
<span class="nc bnc" id="L35595" title="All 2 branches missed.">        if (!mine.isMissing()) {</span>
<span class="nc" id="L35596">            int reportId = 0;</span>
<span class="nc bnc" id="L35597" title="All 5 branches missed.">            switch (mine.getMineType()) {</span>
                case Mounted.MINE_CONVENTIONAL:
<span class="nc" id="L35599">                    deliverThunderMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35600">                            entity.getId());</span>
<span class="nc" id="L35601">                    reportId = 3500;</span>
<span class="nc" id="L35602">                    break;</span>
                case Mounted.MINE_VIBRABOMB:
<span class="nc" id="L35604">                    deliverThunderVibraMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35605">                            mine.getVibraSetting(), entity.getId());</span>
<span class="nc" id="L35606">                    reportId = 3505;</span>
<span class="nc" id="L35607">                    break;</span>
                case Mounted.MINE_ACTIVE:
<span class="nc" id="L35609">                    deliverThunderActiveMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35610">                            entity.getId());</span>
<span class="nc" id="L35611">                    reportId = 3510;</span>
<span class="nc" id="L35612">                    break;</span>
                case Mounted.MINE_INFERNO:
<span class="nc" id="L35614">                    deliverThunderInfernoMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35615">                            entity.getId());</span>
<span class="nc" id="L35616">                    reportId = 3515;</span>
                    break;
                // TODO : command-detonated mines
                // case 2:
            }
<span class="nc" id="L35621">            mine.setShotsLeft(mine.getUsableShotsLeft() - 1);</span>
<span class="nc bnc" id="L35622" title="All 2 branches missed.">            if (mine.getUsableShotsLeft() &lt;= 0) {</span>
<span class="nc" id="L35623">                mine.setMissing(true);</span>
            }
<span class="nc" id="L35625">            r = new Report(reportId);</span>
<span class="nc" id="L35626">            r.subject = entity.getId();</span>
<span class="nc" id="L35627">            r.addDesc(entity);</span>
<span class="nc" id="L35628">            r.add(coords.getBoardNum());</span>
<span class="nc" id="L35629">            addReport(r);</span>
<span class="nc" id="L35630">            entity.setLayingMines(true);</span>
        }
<span class="nc" id="L35632">    }</span>

    public void reportRoll(Roll roll) {
<span class="nc" id="L35635">        Report r = new Report(1230);</span>
<span class="nc" id="L35636">        r.add(roll.getReport());</span>
<span class="nc" id="L35637">        addReport(r);</span>
<span class="nc" id="L35638">    }</span>

    private void registerWithServerBrowser(boolean register, String urlString) {
        try {
<span class="nc" id="L35642">            URL url = new URL(urlString);</span>
<span class="nc" id="L35643">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L35644">            conn.setDoOutput(true);</span>
<span class="nc" id="L35645">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span>
<span class="nc" id="L35646">            DataOutputStream printout = new DataOutputStream(</span>
<span class="nc" id="L35647">                    conn.getOutputStream());</span>
            String content;
<span class="nc" id="L35649">            content = &quot;port=&quot;</span>
<span class="nc" id="L35650">                      + URLEncoder.encode(</span>
<span class="nc" id="L35651">                              Integer.toString(serverSocket.getLocalPort()), &quot;UTF-8&quot;);</span>
<span class="nc bnc" id="L35652" title="All 2 branches missed.">            if (register) {</span>
<span class="nc bnc" id="L35653" title="All 2 branches missed.">                for (IConnection iconn : connections) {</span>
<span class="nc" id="L35654">                    content += &quot;&amp;players[]=&quot; + (getPlayer(iconn.getId()).getName());</span>
<span class="nc" id="L35655">                }</span>
<span class="nc bnc" id="L35656" title="All 2 branches missed.">                if ((game.getPhase() != Phase.PHASE_LOUNGE)</span>
<span class="nc bnc" id="L35657" title="All 2 branches missed.">                        &amp;&amp; (game.getPhase() != Phase.PHASE_UNKNOWN)) {</span>
<span class="nc" id="L35658">                    content += &quot;&amp;close=yes&quot;;</span>
                }
<span class="nc" id="L35660">                content += &quot;&amp;version=&quot; + MegaMek.VERSION;</span>
<span class="nc bnc" id="L35661" title="All 2 branches missed.">                if (isPassworded()) {</span>
<span class="nc" id="L35662">                    content += &quot;&amp;pw=yes&quot;;</span>
                }
            } else {
<span class="nc" id="L35665">                content += &quot;&amp;delete=yes&quot;;</span>
            }
<span class="nc bnc" id="L35667" title="All 2 branches missed.">            if (serverAccessKey != null) {</span>
<span class="nc" id="L35668">                content += &quot;&amp;key=&quot; + serverAccessKey;</span>
            }
<span class="nc" id="L35670">            printout.writeBytes(content);</span>
<span class="nc" id="L35671">            printout.flush();</span>
<span class="nc" id="L35672">            BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream()));</span>
            String line;
<span class="nc bnc" id="L35674" title="All 2 branches missed.">            if (conn.getResponseCode() == 200) {</span>
<span class="nc bnc" id="L35675" title="All 2 branches missed.">                while ((line = rd.readLine()) != null) {</span>
<span class="nc bnc" id="L35676" title="All 2 branches missed.">                    if (serverAccessKey == null) {</span>
<span class="nc" id="L35677">                        serverAccessKey = line;</span>
                    }
                }
            }
<span class="nc" id="L35681">            rd.close();</span>
<span class="nc" id="L35682">            printout.close();</span>
<span class="nc" id="L35683">        } catch (Exception ignored) {</span>
<span class="nc" id="L35684">        }</span>
<span class="nc" id="L35685">    }</span>

    public Set&lt;Coords&gt; getHexUpdateSet() {
<span class="nc" id="L35688">        return hexUpdateSet;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>