<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Building.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Building.java</span></div><h1>Building.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2000-2002 Ben Mazur (bmazur@sev.org)
* Copyright (C) 2018 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/

package megamek.common;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.Vector;

/**
 * This class represents a single, possibly multi-hex building on the board.
 *
 * @author Suvarov454@sourceforge.net (James A. Damour )
 * @version $Revision$
 */
public class Building implements Serializable {
    private static final long serialVersionUID = -8236017592012683793L;

    /**
     * Generic flag for uninitialized values.
     */
    protected static final int UNKNOWN = -1;
    
    // The Building Types
    public static final int LIGHT = 1;
    public static final int MEDIUM = 2;
    public static final int HEAVY = 3;
    public static final int HARDENED = 4;
    public static final int WALL = 5;
    
    /**
     * The Building Type of the building; equal to the terrain elevation of the BUILDING terrain of a hex.
     */
<span class="nc" id="L52">    private int type = Building.UNKNOWN;</span>
    
    // The Building Classes
    public static final int STANDARD = 0;
    public static final int HANGAR = 1;
    public static final int FORTRESS = 2;
    public static final int GUN_EMPLACEMENT = 3;
    // TODO: leaving out Castles Brian until issues with damage scaling are resolved
    // public static final int CASTLE_BRIAN = 3;
    
    /**
     * The Building Class of the building; equal to the terrain elevation of the BUILDING CLASS terrain of a hex.
     */
<span class="nc" id="L65">    private int bldgClass = Building.STANDARD;</span>
    
    /**
     * The ID of this building.
     */
<span class="nc" id="L70">    private int id = Building.UNKNOWN;</span>

    /**
     * The coordinates of every hex of this building.
     */
<span class="nc" id="L75">    private Vector&lt;Coords&gt; coordinates = new Vector&lt;Coords&gt;();</span>

    /**
     * The Basement type of the building.
     */
<span class="nc" id="L80">    private Map&lt;Coords,BasementType&gt; basement = new HashMap&lt;Coords,BasementType&gt;();</span>

<span class="nc" id="L82">    private int collapsedHexes = 0;</span>

<span class="nc" id="L84">    private int originalHexes = 0;</span>

    /**
     * The current construction factor of the building hexes. Any damage
     * immediately updates this value.
     */
<span class="nc" id="L90">    private Map&lt;Coords, Integer&gt; currentCF = new HashMap&lt;Coords, Integer&gt;();</span>
    
    /**
     * The construction factor of the building hexes at the start of this attack
     * phase. Damage that is received during the phase is applied at the end of
     * the phase.
     */
<span class="nc" id="L97">    private Map&lt;Coords, Integer&gt; phaseCF = new HashMap&lt;Coords, Integer&gt;();</span>
    
    /**
     * The current armor of the building hexes.
     */
<span class="nc" id="L102">    private Map&lt;Coords, Integer&gt; armor = new HashMap&lt;Coords, Integer&gt;();</span>

    /**
     * The current state of the basement.
     */
<span class="nc" id="L107">    private Map&lt;Coords, Boolean&gt; basementCollapsed = new HashMap&lt;Coords, Boolean&gt;();</span>

    /**
     * The name of the building.
     */
<span class="nc" id="L112">    private String name = null;</span>

    /**
     * Flag that indicates whether this building is burning
     */
<span class="nc" id="L117">    private Map&lt;Coords, Boolean&gt; burning = new HashMap&lt;Coords, Boolean&gt;();</span>

    public class DemolitionCharge implements Serializable {
        /**
         *
         */
        private static final long serialVersionUID = -6655782801564155668L;
        public int damage;
        public int playerId;
        public Coords pos;
        /**
         * A UUID to keep track of the identify of this demolition charge.
         * Since we could have multiple charges in the same building hex, we
         * can't track identity based upon owner and damage.  Additionally,
         * since we pass objects across the network, we need a mechanism to
         * track identify other than memory address.
         */
<span class="nc" id="L134">        public UUID uuid = UUID.randomUUID();</span>

<span class="nc" id="L136">        public DemolitionCharge(int playerId, int damage, Coords p) {</span>
<span class="nc" id="L137">            this.damage = damage;</span>
<span class="nc" id="L138">            this.playerId = playerId;</span>
<span class="nc" id="L139">            this.pos = p;</span>
<span class="nc" id="L140">        }</span>

        @Override
        public int hashCode() {
<span class="nc" id="L144">            return uuid.hashCode();</span>
        }

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L149" title="All 2 branches missed.">            if (o instanceof DemolitionCharge) {</span>
<span class="nc" id="L150">                return uuid.equals(((DemolitionCharge)o).uuid);</span>
            }
<span class="nc" id="L152">            return false;</span>
        }
    }

<span class="nc" id="L156">    private List&lt;DemolitionCharge&gt; demolitionCharges = new ArrayList&lt;&gt;();</span>

    /**
     * Update this building to include the new hex (and all hexes off the new
     * hex, which aren't already included).
     *
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the new hex.
     * @param board
     *            - the game's &lt;code&gt;IBoard&lt;/code&gt; object.
     * @exception an
     *                &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown if
     *                the given coordinates do not contain a building, or if the
     *                building covers multiple hexes with different CF.
     */
    protected void include(Coords coords, IBoard board, int structureType) {

        // If the hex is already in the building, we've covered it before.
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (isIn(coords)) {</span>
<span class="nc" id="L175">            return;</span>
        }

        // Get the nextHex hex.
<span class="nc" id="L179">        IHex nextHex = board.getHex(coords);</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">        if ((null == nextHex) || !(nextHex.containsTerrain(structureType))) {</span>
<span class="nc" id="L181">            return;</span>
        }

<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (structureType == Terrains.BUILDING) {</span>
            // Error if the Building Type (Light, Medium...) or Building Class (Standard, Hangar...) is off.
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (type != nextHex.terrainLevel(Terrains.BUILDING)) {</span>
<span class="nc" id="L187">                throw new IllegalArgumentException(&quot;The coordinates, &quot;</span>
<span class="nc" id="L188">                        + coords.getBoardNum()</span>
                        + &quot;, should contain the same type of building as &quot;
<span class="nc" id="L190">                        + coordinates.elementAt(0).getBoardNum());</span>
            }
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (bldgClass != nextHex.terrainLevel(Terrains.BLDG_CLASS)) {</span>
<span class="nc" id="L193">                throw new IllegalArgumentException(&quot;The coordinates, &quot;</span>
<span class="nc" id="L194">                        + coords.getBoardNum()</span>
                        + &quot;, should contain the same class of building as &quot;
<span class="nc" id="L196">                        + coordinates.elementAt(0).getBoardNum());</span>
            }

        }
        // We passed our tests, add the next hex to this building.
<span class="nc" id="L201">        coordinates.addElement(coords);</span>
<span class="nc" id="L202">        originalHexes++;</span>
<span class="nc" id="L203">        currentCF.put(coords, nextHex.terrainLevel(Terrains.BLDG_CF));</span>
<span class="nc" id="L204">        phaseCF.put(coords, nextHex.terrainLevel(Terrains.BLDG_CF));</span>
<span class="nc" id="L205">        basement.put(coords, BasementType.getType(nextHex.terrainLevel(Terrains.BLDG_BASEMENT_TYPE)));</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">        basementCollapsed.put(coords, nextHex.terrainLevel(Terrains.BLDG_BASE_COLLAPSED) == 1);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (structureType == Terrains.BRIDGE) {</span>
<span class="nc" id="L208">            currentCF.put(coords, nextHex.terrainLevel(Terrains.BRIDGE_CF));</span>
<span class="nc" id="L209">            phaseCF.put(coords, nextHex.terrainLevel(Terrains.BRIDGE_CF));</span>
        }
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (structureType == Terrains.FUEL_TANK) {</span>
<span class="nc" id="L212">            currentCF.put(coords, nextHex.terrainLevel(Terrains.FUEL_TANK_CF));</span>
<span class="nc" id="L213">            phaseCF.put(coords, nextHex.terrainLevel(Terrains.FUEL_TANK_CF));</span>
        }
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (nextHex.containsTerrain(Terrains.BLDG_ARMOR)) {</span>
<span class="nc" id="L216">            armor.put(coords, nextHex.terrainLevel(Terrains.BLDG_ARMOR));</span>
        } else {
<span class="nc" id="L218">            armor.put(coords, 0);</span>
        }

<span class="nc" id="L221">        burning.put(coords, false);</span>

        // Walk through the exit directions and
        // identify all hexes in this building.
<span class="nc bnc" id="L225" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>

            // Does the building exit in this direction?
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (nextHex.containsTerrainExit(structureType, dir)) {</span>
<span class="nc" id="L229">                include(coords.translated(dir), board, structureType);</span>
            }

        }

<span class="nc" id="L234">    } // End void protected include( Coords, Board )</span>


    /**
     * Basement handlers
     */
<span class="nc" id="L240">    public enum BasementType {</span>
<span class="nc" id="L241">        UNKNOWN(0,0, Messages.getString(&quot;Building.BasementUnknown&quot;)),</span>
<span class="nc" id="L242">        NONE(1,0, Messages.getString(&quot;Building.BasementNone&quot;)),</span>
<span class="nc" id="L243">        TWO_DEEP_FEET(2,2,Messages.getString(&quot;Building.BasementTwoDeepFeet&quot;)),</span>
<span class="nc" id="L244">        ONE_DEEP_FEET(3,1,Messages.getString(&quot;Building.BasementOneDeepFeet&quot;)),</span>
<span class="nc" id="L245">        ONE_DEEP_NORMAL(4,1,Messages.getString(&quot;Building.BasementOneDeepNormal&quot;)),</span>
<span class="nc" id="L246">        ONE_DEEP_NORMALINFONLY(5,1,Messages.getString(&quot;Building.BasementOneDeepNormalInfOnly&quot;)),</span>
<span class="nc" id="L247">        ONE_DEEP_HEAD(6,1,Messages.getString(&quot;Building.BasementOneDeepHead&quot;)),</span>
<span class="nc" id="L248">        TWO_DEEP_HEAD(7,2,Messages.getString(&quot;Building.BasementTwoDeepHead&quot;));</span>

        private int value;
        private int depth;
        private String desc;

<span class="nc" id="L254">        BasementType(int type, int depth, String desc) {</span>
<span class="nc" id="L255">            value = type;</span>
<span class="nc" id="L256">            this.depth = depth;</span>
<span class="nc" id="L257">            this.desc = desc;</span>
<span class="nc" id="L258">        }</span>

        public int getValue() {
<span class="nc" id="L261">            return value;</span>
        }

        public int getDepth() {
<span class="nc" id="L265">            return depth;</span>
        }

        public String getDesc() {
<span class="nc" id="L269">            return desc;</span>
        }

        public static BasementType getType(int value) {
<span class="nc bnc" id="L273" title="All 2 branches missed.">            for (BasementType type : BasementType.values()) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (type.getValue() == value) {</span>
<span class="nc" id="L275">                    return type;</span>
                }
            }
<span class="nc" id="L278">            return UNKNOWN;</span>
        }
    }

    /**
     * Construct a building for the given coordinates from the board's
     * information. If the building covers multiple hexes, every hex will be
     * included in the building.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; of a hex of the building. If the
     *            building covers multiple hexes, this constructor will include
     *            them all in this building automatically.
     * @param board
     *            - the game's &lt;code&gt;Board&lt;/code&gt; object.
     * @exception an
     *                &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown if
     *                the given coordinates do not contain a building, or if the
     *                building covers multiple hexes with different CFs.
     */
<span class="nc" id="L298">    public Building(Coords coords, IBoard board, int structureType, BasementType basementType) {</span>

        // The ID of the building will be deterministic based on the
        // position of its first hex. 9,999 hexes in the Y direction
        // ought to be enough for anyone.
        //
        // ASSUMPTION: this will be unique ID across ALL the building's
        // hexes for ALL the clients of this board.
<span class="nc" id="L306">        id = coords.getX() * 10000 + coords.getY();</span>

        // The building occupies the given coords, at least.
<span class="nc" id="L309">        coordinates.addElement(coords);</span>
<span class="nc" id="L310">        originalHexes++;</span>

<span class="nc" id="L312">        burning.put(coords, false);</span>

        // Get the Hex for those coords.
<span class="nc" id="L315">        IHex startHex = board.getHex(coords);</span>

        // Read our construction type from the hex.
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (!startHex.containsTerrain(structureType)) {</span>
<span class="nc" id="L319">            throw new IllegalArgumentException(&quot;The coordinates, &quot;</span>
<span class="nc" id="L320">                    + coords.getBoardNum() + &quot;, do not contain a building.&quot;);</span>
        }
<span class="nc" id="L322">        type = startHex.terrainLevel(structureType);</span>
<span class="nc" id="L323">        bldgClass = startHex.terrainLevel(Terrains.BLDG_CLASS);</span>

        // Insure that we've got a good type (and initialize our CF).
<span class="nc" id="L326">        currentCF.put(coords, getDefaultCF(type));</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (currentCF.get(coords) == Building.UNKNOWN) {</span>
<span class="nc" id="L328">            throw new IllegalArgumentException(&quot;Unknown construction type: &quot;</span>
                    + type + &quot;.  The board is invalid.&quot;);
        }

        // Now read the *real* CF, if the board specifies one.
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if ((structureType == Terrains.BUILDING)</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                &amp;&amp; startHex.containsTerrain(Terrains.BLDG_CF)) {</span>
<span class="nc" id="L335">            currentCF.put(coords, startHex.terrainLevel(Terrains.BLDG_CF));</span>
        }
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if ((structureType == Terrains.BRIDGE)</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                &amp;&amp; startHex.containsTerrain(Terrains.BRIDGE_CF)) {</span>
<span class="nc" id="L339">            currentCF.put(coords, startHex.terrainLevel(Terrains.BRIDGE_CF));</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if ((structureType == Terrains.FUEL_TANK)</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                &amp;&amp; startHex.containsTerrain(Terrains.FUEL_TANK_CF)) {</span>
<span class="nc" id="L343">            currentCF.put(coords, startHex.terrainLevel(Terrains.FUEL_TANK_CF));</span>
        }
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (startHex.containsTerrain(Terrains.BLDG_ARMOR)) {</span>
<span class="nc" id="L346">            armor.put(coords, startHex.terrainLevel(Terrains.BLDG_ARMOR));</span>
        } else {
<span class="nc" id="L348">            armor.put(coords, 0);</span>
        }

<span class="nc" id="L351">        phaseCF.putAll(currentCF);</span>

<span class="nc" id="L353">        basement.put(coords, basementType);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">        basementCollapsed.put(coords, startHex.terrainLevel(Terrains.BLDG_BASE_COLLAPSED) == 1);</span>

        // Walk through the exit directions and
        // identify all hexes in this building.
<span class="nc bnc" id="L358" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>

            // Does the building exit in this direction?
<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (startHex.containsTerrainExit(structureType, dir)) {</span>
<span class="nc" id="L362">                include(coords.translated(dir), board, structureType);</span>
            }

        }

        // Set the building's name.
<span class="nc" id="L368">        StringBuffer buffer = new StringBuffer();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (structureType == Terrains.FUEL_TANK) {</span>
<span class="nc" id="L370">            buffer.append(&quot;Fuel Tank #&quot;);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">        } else if (getType() == Building.WALL) {</span>
<span class="nc" id="L372">            buffer.append(&quot;Wall #&quot;);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        } else if (structureType == Terrains.BUILDING) {</span>
<span class="nc" id="L374">            buffer.append(&quot;Building #&quot;);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        } else if (structureType == Terrains.BRIDGE) {</span>
<span class="nc" id="L376">            buffer.append(&quot;Bridge #&quot;);</span>
        } else {
<span class="nc" id="L378">            buffer.append(&quot;Structure #&quot;);</span>
        }
<span class="nc" id="L380">        buffer.append(id);</span>
<span class="nc" id="L381">        name = buffer.toString();</span>

<span class="nc" id="L383">    } // End public Building( Coords, Board )</span>

    /**
     * Get the ID of this building. The same ID applies to all hexes.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; ID of the building.
     */
    public int getId() {
<span class="nc" id="L391">        return id;</span>
    }

    /**
     * Determine if the building occupies given coordinates. Multi-hex buildings
     * will occupy multiple coordinates. Only one building per hex.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; being examined.
     * @return &lt;code&gt;true&lt;/code&gt; if the building occupies the coordinates.
     *         &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean isIn(Coords coords) {
<span class="nc" id="L404">        return coordinates.contains(coords);</span>
    }

    /**
     * Determins if the coord exist in the currentCF has.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; being examined.
     * @return &lt;code&gt;true&lt;/code&gt; if the building has CF at the coordinates.
     *         &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean hasCFIn(Coords coords) {
<span class="nc" id="L416">        return currentCF.containsKey(coords);</span>

    }

    /**
     * Get the coordinates that the building occupies.
     *
     * @return an &lt;code&gt;Enumeration&lt;/code&gt; of the &lt;code&gt;Coord&lt;/code&gt; objects.
     */
    public Enumeration&lt;Coords&gt; getCoords() {
<span class="nc" id="L426">        return coordinates.elements();</span>
    }

    /**
     * Get the construction type of the building. This value will be one of the
     * constants, LIGHT, MEDIUM, HEAVY, or HARDENED.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; code of the building's construction type.
     */
    public int getType() {
<span class="nc" id="L436">        return type;</span>
    }

    /**
     * Get the building class, per TacOps rules.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; code of the building's classification.
     */
    public int getBldgClass() {
<span class="nc" id="L445">        return bldgClass;</span>
    }

    /**
     * Get the building basement, per TacOps rules.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; code of the buildingbasement type.
     */
    public boolean getBasementCollapsed(Coords coords) {
<span class="nc" id="L454">        return basementCollapsed.get(coords);</span>
    }

    public void collapseBasement(Coords coords, IBoard board,
            Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L459" title="All 4 branches missed.">        if ((basement.get(coords) == BasementType.NONE) || (basement.get(coords) == BasementType.ONE_DEEP_NORMALINFONLY)) {</span>
<span class="nc" id="L460">            System.err.println(&quot;hex has no basement to collapse&quot;);</span>
<span class="nc" id="L461">            return;</span>
        }
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (basementCollapsed.get(coords)) {</span>
<span class="nc" id="L464">            System.err.println(&quot;hex has basement that already collapsed&quot;);</span>
<span class="nc" id="L465">            return;</span>
        }
<span class="nc" id="L467">        Report r = new Report(2112, Report.PUBLIC);</span>
<span class="nc" id="L468">        r.add(getName());</span>
<span class="nc" id="L469">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L470">        vPhaseReport.add(r);</span>
<span class="nc" id="L471">        System.err.println(&quot;basement &quot; + basement + &quot;is collapsing, hex:&quot;</span>
<span class="nc" id="L472">                + coords.toString() + &quot; set terrain!&quot;);</span>
<span class="nc" id="L473">        board.getHex(coords).addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.BLDG_BASE_COLLAPSED, 1));
<span class="nc" id="L475">        basementCollapsed.put(coords, true);</span>

<span class="nc" id="L477">    }</span>

    /**
     * Roll what kind of basement this building has
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; of theb building to roll for
     * @param vPhaseReport the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phasereport
     * @return a &lt;code&gt;boolean&lt;/code&gt; indicating wether the hex and building was changed or not
     */
    public boolean rollBasement(Coords coords, IBoard board, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (basement.get(coords) == BasementType.UNKNOWN) {</span>
<span class="nc" id="L487">            IHex hex = board.getHex(coords);</span>
<span class="nc" id="L488">            Report r = new Report(2111, Report.PUBLIC);</span>
<span class="nc" id="L489">            r.add(getName());</span>
<span class="nc" id="L490">            r.add(coords.getBoardNum());</span>
<span class="nc" id="L491">            int basementRoll = Compute.d6(2);</span>
<span class="nc" id="L492">            r.add(basementRoll);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">            if (basementRoll == 2) {</span>
<span class="nc" id="L494">                basement.put(coords, BasementType.TWO_DEEP_FEET);</span>
<span class="nc" id="L495">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L496">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">            } else if (basementRoll == 3) {</span>
<span class="nc" id="L498">                basement.put(coords, BasementType.ONE_DEEP_FEET);</span>
<span class="nc" id="L499">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L500">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">            } else if (basementRoll == 4) {</span>
<span class="nc" id="L502">                basement.put(coords, BasementType.ONE_DEEP_NORMAL);</span>
<span class="nc" id="L503">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L504">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">            } else if (basementRoll == 10) {</span>
<span class="nc" id="L506">                basement.put(coords, BasementType.ONE_DEEP_NORMAL);</span>
<span class="nc" id="L507">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L508">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">            } else if (basementRoll == 11) {</span>
<span class="nc" id="L510">                basement.put(coords, BasementType.ONE_DEEP_HEAD);</span>
<span class="nc" id="L511">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L512">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">            } else if (basementRoll == 12) {</span>
<span class="nc" id="L514">                basement.put(coords, BasementType.TWO_DEEP_HEAD);</span>
<span class="nc" id="L515">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L516">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
            } else {
<span class="nc" id="L518">                basement.put(coords, BasementType.NONE);</span>
<span class="nc" id="L519">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L520">                        Terrains.BLDG_BASEMENT_TYPE, basement.get(coords).getValue()));</span>
            }
<span class="nc" id="L522">            r.add(BasementType.getType(hex.terrainLevel(Terrains.BLDG_BASEMENT_TYPE)).desc);</span>
<span class="nc" id="L523">            vPhaseReport.add(r);</span>
<span class="nc" id="L524">            return true;</span>
        }
<span class="nc" id="L526">        return false;</span>
    }

    /**
     * Get the current construction factor of the building hex at the passed
     * coords. Any damage immediately updates this value.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&gt; of the hex in question
     *
     * @return the &lt;code&gt;int&lt;/code&gt; value of the building hex's current
     *         construction factor. This value will be greater than or equal to
     *         zero.
     */
    public int getCurrentCF(Coords coords) {
<span class="nc" id="L541">        return currentCF.get(coords);</span>
    }

    /**
     * Get the construction factor of the building hex at the passed coords at
     * the start of the current phase. Damage that is received during the phase
     * is applied at the end of the phase.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&gt; of the hex in question
     * @return the &lt;code&gt;int&lt;/code&gt; value of the building's construction factor
     *         at the start of this phase. This value will be greater than or
     *         equal to zero.
     */
    public int getPhaseCF(Coords coords) {
<span class="nc" id="L556">        return phaseCF.get(coords);</span>
    }

    public int getArmor(Coords coords) {
<span class="nc" id="L560">        return armor.get(coords);</span>
    }

    /**
     * Set the current construction factor of the building hex. Call this method
     * immediately when the building sustains any damage.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&gt; of the hex in question
     * @param cf
     *            - the &lt;code&gt;int&lt;/code&gt; value of the building hex's current
     *            construction factor. This value must be greater than or equal
     *            to zero.
     * @exception If
     *                the passed value is less than zero, an
     *                &lt;code&gt;IllegalArgumentException&lt;/code&gt; is thrown.
     */
    public void setCurrentCF(int cf, Coords coords) {
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if (cf &lt; 0) {</span>
<span class="nc" id="L579">            throw new IllegalArgumentException(</span>
                    &quot;Invalid value for Construction Factor: &quot; + cf);
        }

<span class="nc" id="L583">        currentCF.put(coords, cf);</span>
<span class="nc" id="L584">    }</span>

    /**
     * Set the construction factor of the building hex for the start of the next
     * phase. Call this method at the end of the phase to apply damage sustained
     * by the building during the phase.
     *
     * @param coords
     *            - the &lt;code&gt;Coords&gt; of the hex in question
     * @param cf
     *            - the &lt;code&gt;int&lt;/code&gt; value of the building's current
     *            construction factor. This value must be greater than or equal
     *            to zero.
     * @exception If
     *                the passed value is less than zero, an
     *                &lt;code&gt;IllegalArgumentException&lt;/code&gt; is thrown.
     */
    public void setPhaseCF(int cf, Coords coords) {
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (cf &lt; 0) {</span>
<span class="nc" id="L603">            throw new IllegalArgumentException(</span>
                    &quot;Invalid value for Construction Factor: &quot; + cf);
        }

<span class="nc" id="L607">        phaseCF.put(coords, cf);</span>
<span class="nc" id="L608">    }</span>

    public void setArmor(int a, Coords coords) {
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (a &lt; 0) {</span>
<span class="nc" id="L612">            throw new IllegalArgumentException(&quot;Invalid value for armor: &quot; + a);</span>
        }

<span class="nc" id="L615">        armor.put(coords, a);</span>
<span class="nc" id="L616">    }</span>

    /**
     * Get the name of this building.
     *
     * @return the &lt;code&gt;String&lt;/code&gt; name of this building.
     */
    public String getName() {
<span class="nc" id="L624">        return name;</span>
    }

    /**
     * Get the default construction factor for the given type of building.
     *
     * @param type
     *            - the &lt;code&gt;int&lt;/code&gt; construction type of the building.
     * @return the &lt;code&gt;int&lt;/code&gt; default construction factor for that type of
     *         building. If a bad type value is passed, the constant
     *         &lt;code&gt;Building.UNKNOWN&lt;/code&gt; will be returned instead.
     */
    public static int getDefaultCF(int type) {
<span class="nc" id="L637">        int retval = Building.UNKNOWN;</span>
<span class="nc bnc" id="L638" title="All 5 branches missed.">        switch (type) {</span>
            case Building.LIGHT:
<span class="nc" id="L640">                retval = 15;</span>
<span class="nc" id="L641">                break;</span>
            case Building.MEDIUM:
<span class="nc" id="L643">                retval = 40;</span>
<span class="nc" id="L644">                break;</span>
            case Building.HEAVY:
<span class="nc" id="L646">                retval = 90;</span>
<span class="nc" id="L647">                break;</span>
            case Building.HARDENED:
            case Building.WALL:
<span class="nc" id="L650">                retval = 120;</span>
                break;
        }
<span class="nc" id="L653">        return retval;</span>
    }

    /**
     * Override &lt;code&gt;Object#equals(Object)&lt;/code&gt;.
     *
     * @param obj
     *            - the other &lt;code&gt;Object&lt;/code&gt; to compare to this
     *            &lt;code&gt;Building&lt;/code&gt;.
     * @return &lt;code&gt;true&lt;/code&gt; if the other object is the same as this
     *         &lt;code&gt;Building&lt;/code&gt;. The value &lt;code&gt;false&lt;/code&gt; will be
     *         returned if the other object is &lt;code&gt;null&lt;/code&gt;, is not a
     *         &lt;code&gt;Buildig&lt;/code&gt;, or if it is not the same as this
     *         &lt;code&gt;Building&lt;/code&gt;.
     */
    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if(this == obj) {</span>
<span class="nc" id="L671">            return true;</span>
        }
<span class="nc bnc" id="L673" title="All 2 branches missed.">        if(!(obj instanceof Building)) {</span>
<span class="nc" id="L674">            return false;</span>
        }
        // True until we're talking about more than one Board per Game.
<span class="nc" id="L677">        final Building other = (Building) obj;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">        return (id == other.id);</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L683">        return id;</span>
    }

    /**
     * Get a String for this building.
     */
    @Override
    public String toString() {

        // Assemble the string in pieces.
<span class="nc" id="L693">        StringBuffer buf = new StringBuffer();</span>

        // Add the building type to the buffer.
<span class="nc bnc" id="L696" title="All 6 branches missed.">        switch (getType()) {</span>
            case Building.LIGHT:
<span class="nc" id="L698">                buf.append(&quot;Light &quot;);</span>
<span class="nc" id="L699">                break;</span>
            case Building.MEDIUM:
<span class="nc" id="L701">                buf.append(&quot;Medium &quot;);</span>
<span class="nc" id="L702">                break;</span>
            case Building.HEAVY:
<span class="nc" id="L704">                buf.append(&quot;Heavy &quot;);</span>
<span class="nc" id="L705">                break;</span>
            case Building.HARDENED:
<span class="nc" id="L707">                buf.append(&quot;Hardened &quot;);</span>
<span class="nc" id="L708">                break;</span>
            case Building.WALL:
<span class="nc" id="L710">                buf.append(&quot;&quot;);</span>
                break;
        }

<span class="nc bnc" id="L714" title="All 4 branches missed.">        switch (getBldgClass()) {</span>
            case Building.HANGAR:
<span class="nc" id="L716">                buf.append(&quot;Hangar &quot;);</span>
<span class="nc" id="L717">                break;</span>
            case Building.FORTRESS:
<span class="nc" id="L719">                buf.append(&quot;Fortress &quot;);</span>
<span class="nc" id="L720">                break;</span>
            case Building.GUN_EMPLACEMENT:
<span class="nc" id="L722">                buf.append(&quot;Gun Emplacement&quot;);</span>
<span class="nc" id="L723">                break;</span>
            // case Building.CASTLE_BRIAN:
            // buf.append(&quot;Castle Brian &quot;);
            // break;
            default:
<span class="nc" id="L728">                buf.append(&quot;Standard &quot;);</span>
        }

        // Add the building's name.
<span class="nc" id="L732">        buf.append(name);</span>

        // Return the string.
<span class="nc" id="L735">        return buf.toString();</span>
    }

    /**
     * Determine if this building is on fire.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the building is on fire.
     */
    public boolean isBurning(Coords coords) {
<span class="nc" id="L744">        return burning.get(coords);</span>
    }

    /**
     * Set the flag that indicates that this building is on fire.
     *
     * @param onFire
     *            - a &lt;code&gt;boolean&lt;/code&gt; value that indicates whether this
     *            building is on fire.
     */
    public void setBurning(boolean onFire, Coords coords) {
<span class="nc" id="L755">        burning.put(coords, onFire);</span>
<span class="nc" id="L756">    }</span>

    public void addDemolitionCharge(int playerId, int damage, Coords pos) {
<span class="nc" id="L759">        DemolitionCharge charge = new DemolitionCharge(playerId, damage, pos);</span>
<span class="nc" id="L760">        demolitionCharges.add(charge);</span>
<span class="nc" id="L761">    }</span>

    public void removeDemolitionCharge(DemolitionCharge charge) {
<span class="nc" id="L764">        demolitionCharges.remove(charge);</span>
<span class="nc" id="L765">    }</span>

    public List&lt;DemolitionCharge&gt; getDemolitionCharges() {
<span class="nc" id="L768">        return demolitionCharges;</span>
    }

    public void setDemolitionCharges(List&lt;DemolitionCharge&gt; charges) {
<span class="nc" id="L772">        demolitionCharges = charges;</span>
<span class="nc" id="L773">    }</span>

    /**
     * Remove one building hex from the building
     *
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex to be removed
     */
    public void removeHex(Coords coords) {
<span class="nc" id="L782">        coordinates.remove(coords);</span>
<span class="nc" id="L783">        currentCF.remove(coords);</span>
<span class="nc" id="L784">        phaseCF.remove(coords);</span>
<span class="nc" id="L785">        collapsedHexes++;</span>
<span class="nc" id="L786">    }</span>

    public int getOriginalHexCount() {
<span class="nc" id="L789">        return originalHexes;</span>
    }

    public int getCollapsedHexCount() {
<span class="nc" id="L793">        return collapsedHexes;</span>
    }

    /**
     *
     * @return the damage scale multiplier for units passing through this
     *         building
     */
    public double getDamageFromScale() {
<span class="nc bnc" id="L802" title="All 3 branches missed.">        switch (getBldgClass()) {</span>
            case Building.HANGAR:
<span class="nc" id="L804">                return 0.5;</span>
            case Building.FORTRESS:
            case Building.GUN_EMPLACEMENT:
<span class="nc" id="L807">                return 2.0;</span>
                // case Building.CASTLE_BRIAN:
                // return 10.0;
            default:
<span class="nc" id="L811">                return 1.0;</span>
        }
    }

    /**
     *
     * @return the damage scale multiplier for damage applied to this building
     *         (and occupants)
     */
    public double getDamageToScale() {
<span class="nc bnc" id="L821" title="All 2 branches missed.">        switch (getBldgClass()) {</span>
            case Building.FORTRESS:
            case Building.GUN_EMPLACEMENT:
<span class="nc" id="L824">                return 0.5;</span>
                // case Building.CASTLE_BRIAN:
                // return 0.1;
            default:
<span class="nc" id="L828">                return 1.0;</span>
        }
    }

    /**
     *
     * @return the amount of damage the building absorbs
     */
    public int getAbsorbtion(Coords pos) {
        // if(getBldgClass() == Building.CASTLE_BRIAN) {
        // return (int) Math.ceil(getPhaseCF(pos));
        // }
<span class="nc" id="L840">        return (int) Math.ceil(getPhaseCF(pos) / 10.0);</span>
    }

    /**
     * Returns the percentage of damage done to the building for attacks against
     * infantry in the building from other units within the building.  TW pg175.
     *
     * @return
     */
    public double getInfDmgFromInside() {
<span class="nc bnc" id="L850" title="All 4 branches missed.">         switch (getType()) {</span>
            case Building.LIGHT:
            case Building.MEDIUM:
<span class="nc" id="L853">                return 0.0;</span>
            case Building.HEAVY:
<span class="nc" id="L855">                return 0.5;</span>
            case Building.HARDENED:
<span class="nc" id="L857">                return 0.75;</span>
            default:
<span class="nc" id="L859">                return 0;</span>
        }
    }

    /**
     * Per page 172 of Total Warfare, this is the fraction of a weapon's damage that
     * passes through to infantry inside the building.
     * @return Damage fraction.
     */
    public float getDamageReductionFromOutside() {
<span class="nc bnc" id="L869" title="All 4 branches missed.">        switch (getType()) {</span>
            case Building.LIGHT:
<span class="nc" id="L871">                return 0.75f;</span>
            case Building.MEDIUM:
<span class="nc" id="L873">                return 0.5f;</span>
            case Building.HEAVY:
<span class="nc" id="L875">                return 0.25f;</span>
            default:
<span class="nc" id="L877">                return 0f;</span>
        }
    }

    public BasementType getBasement(Coords coords) {
<span class="nc" id="L882">        return basement.get(coords);</span>
    }

    public void setBasement(Coords coords, BasementType basement) {
<span class="nc" id="L886">        this.basement.put(coords, basement);</span>
<span class="nc" id="L887">    }</span>

    public void setBasementCollapsed(Coords coords, boolean collapsed) {
<span class="nc" id="L890">        basementCollapsed.put(coords, collapsed);</span>
<span class="nc" id="L891">    }</span>



} // End public class Building implements Serializable
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>