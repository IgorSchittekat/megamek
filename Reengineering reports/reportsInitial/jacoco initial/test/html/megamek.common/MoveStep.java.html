<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MoveStep.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">MoveStep.java</span></div><h1>MoveStep.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program; if not, write to the Free Software Foundation, Inc., 59 Temple
 * Place, Suite 330, Boston, MA 02111-1307 USA
 */

/*
 * Created on Aug 28, 2003
 */
package megamek.common;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.TreeMap;
import java.util.Vector;

import megamek.common.IGame.Phase;
import megamek.common.MovePath.MoveStepType;
import megamek.common.logging.DefaultMmLogger;
import megamek.common.logging.MMLogger;
import megamek.common.options.OptionsConstants;
import megamek.common.pathfinder.CachedEntityState;

/**
 * A single step in the entity's movement.  Since the path planner uses shallow
 * copies of MovePaths, multiple paths may share the same MoveStep, so this
 * class needs to be agnostic of what path it belongs to.
 */
public class MoveStep implements Serializable {
    /**
     *
     */
    private static final long serialVersionUID = -6075640793056182285L;
<span class="fc" id="L48">    private MoveStepType type = MoveStepType.NONE;</span>
<span class="fc" id="L49">    private int targetId = Entity.NONE;</span>
<span class="fc" id="L50">    private int targetType = Targetable.TYPE_ENTITY;</span>
    private Coords targetPos;

    private Coords position;
    private int facing;

    private int mp; // this step
    private int mpUsed; // whole path

    private int heat; // this step
    private int totalHeat;

    private int distance;
    private int leapDistance;

<span class="fc" id="L65">    private int elevation = -999;</span>
<span class="fc" id="L66">    private int altitude = -999;</span>

<span class="fc" id="L68">    private int mineToLay = -1;</span>

    /**
     * This step's static movement type. Additional steps in the path will not
     * change this value.
     */
    private EntityMovementType movementType;
    /**
     * The movement mode after this step completes. Mode conversions will modify it, though
     * it may not take effect until the end of movement.
     */
<span class="fc" id="L79">    private EntityMovementMode movementMode = EntityMovementMode.NONE;</span>

    private boolean isProne;
    private boolean isFlying;
    private boolean isHullDown;
    private boolean climbMode;

    private boolean danger; // keep psr
    private boolean pastDanger;
    private boolean docking;
    private boolean isUsingMASC;
    private int targetNumberMASC; // psr
    //
    private boolean firstStep; // check if no previous
    private boolean isTurning; // method
    private boolean isUnloaded;
    private boolean hasEverUnloaded;
    private boolean prevStepOnPavement; // prev
    private boolean hasJustStood;
    private boolean thisStepBackwards;
    private boolean onlyPavement; // additive
    private boolean isPavementStep;
<span class="fc" id="L101">    private boolean isRunProhibited = false;</span>
<span class="fc" id="L102">    private boolean isStackingViolation = false;</span>
<span class="fc" id="L103">    private boolean isDiggingIn = false;</span>
<span class="fc" id="L104">    private boolean isTakingCover = false;</span>
<span class="fc" id="L105">    private int wigeBonus = 0;</span>
<span class="fc" id="L106">    private int nWigeDescent = 0;</span>
    
    /**
     * The Entity that is taking this MoveStep.
     */
<span class="fc" id="L111">    private Entity entity = null;</span>

    /**
     * Determines if this MoveStep is part of a MovePath that is jumping.
     */
<span class="fc" id="L116">    private boolean isJumpingPath = false;</span>

    /**
     * Determines if this MoveStep is part of a MovePath that is moving
     * carefully.
     */
<span class="fc" id="L122">    private boolean isCarefulPath = true;</span>
    
    /*
     * Aero related stuf
     */
<span class="fc" id="L127">    private int velocity = -999;</span>
<span class="fc" id="L128">    private int velocityN = -999;</span>

    // also keep track of velocity left to spend
<span class="fc" id="L131">    private int velocityLeft = 0;</span>
    // how many turns?
<span class="fc" id="L133">    private int nTurns = 0;</span>
<span class="fc" id="L134">    private int nRolls = 0;</span>
    // does the unit have a free turn available
<span class="fc" id="L136">    private boolean freeTurn = false;</span>
    // how many hexes straight has the unit traveled
<span class="fc" id="L138">    private int nStraight = 0;</span>
    // how many altitude down
<span class="fc" id="L140">    private int nDown = 0;</span>
    // how many hexes moved in this velocity &quot;chunk&quot; (for aero on ground maps)
<span class="fc" id="L142">    private int nMoved = 0;</span>
    // for Aeros, they may get pushed off board by OOC
<span class="fc" id="L144">    private boolean offBoard = false;</span>
    // for optional vector movement
    private int[] mv;
<span class="fc" id="L147">    private int recoveryUnit = -1;</span>
    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched;
<span class="fc" id="L149">    private boolean isEvading = false;</span>
<span class="fc" id="L150">    private boolean isShuttingDown = false;</span>
<span class="fc" id="L151">    private boolean isStartingUp = false;</span>
<span class="fc" id="L152">    private boolean isSelfDestructing = false;</span>
<span class="fc" id="L153">    private boolean isRolled = false;</span>

    // for maneuvers
<span class="fc" id="L156">    private int maneuverType = ManeuverType.MAN_NONE;</span>
    // steps associated with maneuvers have no cost
<span class="fc" id="L158">    private boolean noCost = false;</span>
    // is this step part of a maneuver?
<span class="fc" id="L160">    private boolean maneuver = false;</span>

    private Minefield mf;

    /**
     * Flag that indicates that this step is into prohibited terrain.
     * &lt;p/&gt;
     * If the unit is jumping, this step is only invalid if it is the end of the
     * path.
     */
<span class="fc" id="L170">    private boolean terrainInvalid = false;</span>

    /**
     * A collection of buildings that are crushed during this move step. This is
     * used for landed Aerodyne Dropships and Mobile Structures.
     */
    private ArrayList&lt;Coords&gt; crushedBuildingLocs;

    /**
     * Global logging instance.
     */
    private MMLogger logger;

    /**
     * Create a step of the given type.
     *
     * @param type - should match one of the MovePath constants, but this is not
     *             currently checked.
     */
<span class="fc" id="L189">    public MoveStep(MovePath path, MoveStepType type) {</span>
<span class="fc" id="L190">        this.type = type;</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if (path != null) {</span>
<span class="fc" id="L192">            entity = path.getEntity();</span>
<span class="fc" id="L193">            isJumpingPath = path.isJumping();</span>
<span class="fc" id="L194">            isCarefulPath = path.isCareful();</span>
        }
<span class="pc bpc" id="L196" title="5 of 10 branches missed.">        if ((type == MoveStepType.UNLOAD) || (type == MoveStepType.LAUNCH)</span>
                || (type == MoveStepType.DROP) || (type == MoveStepType.UNDOCK)
                || (type == MoveStepType.DISCONNECT)) {
<span class="nc" id="L199">            hasEverUnloaded = true;</span>
        } else {
<span class="fc" id="L201">            hasEverUnloaded = false;</span>
        }
<span class="fc" id="L203">    }</span>

    /**
     * Create a step with the given target and a position for that target
     *
     * @param type   - should match one of the MovePath constants, but this is not
     *               currently checked.
     * @param target - the &lt;code&gt;Targetable&lt;/code&gt; that is the target of this step.
     *               For example, the enemy being charged.
     * @param pos    = the &lt;code&gt;Coords&lt;/code&gt; for the target position.
     */
    public MoveStep(MovePath path, MoveStepType type, Targetable target,
                    Coords pos) {
<span class="nc" id="L216">        this(path, type);</span>
<span class="nc" id="L217">        targetId = target.getTargetId();</span>
<span class="nc" id="L218">        targetType = target.getTargetType();</span>
<span class="nc" id="L219">        targetPos = pos;</span>
<span class="nc bnc" id="L220" title="All 10 branches missed.">        if ((type == MoveStepType.UNLOAD) || (type == MoveStepType.LAUNCH)</span>
                || (type == MoveStepType.DROP) || (type == MoveStepType.UNDOCK)
                || (type == MoveStepType.DISCONNECT)) {
<span class="nc" id="L223">            hasEverUnloaded = true;</span>
        } else {
<span class="nc" id="L225">            hasEverUnloaded = false;</span>
        }
<span class="nc" id="L227">    }</span>

    /**
     * Create a step with the given target.
     *
     * @param type   - should match one of the MovePath constants, but this is not
     *               currently checked.
     * @param target - the &lt;code&gt;Targetable&lt;/code&gt; that is the target of this step.
     *               For example, the enemy being charged.
     */
    public MoveStep(MovePath path, MoveStepType type, Targetable target) {
<span class="nc" id="L238">        this(path, type);</span>
<span class="nc" id="L239">        targetId = target.getTargetId();</span>
<span class="nc" id="L240">        targetType = target.getTargetType();</span>
<span class="nc bnc" id="L241" title="All 10 branches missed.">        if ((type == MoveStepType.UNLOAD) || (type == MoveStepType.LAUNCH)</span>
                || (type == MoveStepType.DROP) || (type == MoveStepType.UNDOCK)
                || (type == MoveStepType.DISCONNECT)) {
<span class="nc" id="L244">            hasEverUnloaded = true;</span>
        } else {
<span class="nc" id="L246">            hasEverUnloaded = false;</span>
        }
<span class="nc" id="L248">    }</span>

    /**
     * Create a step with the given mine to lay.
     *
     * @param path
     * @param type      - should match one of the MovePath constants, but this is not
     *                  currently checked.
     * @param mineToLay - the &lt;code&gt;int&lt;/code&gt; that is the id of the mine that should
     *                  be laid in this step.
     */
    public MoveStep(MovePath path, MoveStepType type, int mineToLay) {
<span class="nc" id="L260">        this(path, type);</span>
<span class="nc" id="L261">        this.mineToLay = mineToLay;</span>
<span class="nc" id="L262">    }</span>

    /**
     * Create a step with the units to launch or drop.
     *
     * @param path
     * @param type    - should match one of the MovePath constants, but this is not
     *                currently checked.
     * @param targets - vector of integers identifying the entities to launch
     */
    public MoveStep(MovePath path, MoveStepType type,
                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; targets) {
<span class="nc" id="L274">        this(path, type);</span>
<span class="nc" id="L275">        launched = targets;</span>
<span class="nc bnc" id="L276" title="All 10 branches missed.">        if ((type == MoveStepType.UNLOAD) || (type == MoveStepType.LAUNCH)</span>
                || (type == MoveStepType.DROP) || (type == MoveStepType.UNDOCK)
                || (type == MoveStepType.DISCONNECT)) {
<span class="nc" id="L279">            hasEverUnloaded = true;</span>
        } else {
<span class="nc" id="L281">            hasEverUnloaded = false;</span>
        }
<span class="nc" id="L283">    }</span>

    public MoveStep(MovePath path, MoveStepType type, int recovery,
                    int mineToLay) {
<span class="nc" id="L287">        this(path, type);</span>
<span class="nc" id="L288">        recoveryUnit = recovery;</span>
<span class="nc" id="L289">        this.mineToLay = mineToLay;</span>
<span class="nc" id="L290">    }</span>

    public MoveStep(MovePath path, MoveStepType type, boolean noCost) {
<span class="nc" id="L293">        this(path, type);</span>
<span class="nc" id="L294">        this.noCost = noCost;</span>
<span class="nc" id="L295">    }</span>

    public MoveStep(MovePath path, MoveStepType type, boolean noCost,
                    boolean isManeuver) {
<span class="nc" id="L299">        this(path, type);</span>
<span class="nc" id="L300">        this.noCost = noCost;</span>
<span class="nc" id="L301">        maneuver = isManeuver;</span>
<span class="nc" id="L302">    }</span>

    public MoveStep(MovePath path, MoveStepType type, int recovery,
                    int mineToLay, int manType) {
<span class="nc" id="L306">        this(path, type);</span>
<span class="nc" id="L307">        recoveryUnit = recovery;</span>
<span class="nc" id="L308">        this.mineToLay = mineToLay;</span>
<span class="nc" id="L309">        maneuverType = manType;</span>
<span class="nc" id="L310">    }</span>

    public MoveStep(MovePath path, MoveStepType type, Minefield mf) {
<span class="nc" id="L313">        this(path, type);</span>
<span class="nc" id="L314">        this.mf = mf;</span>
<span class="nc" id="L315">    }</span>

    /**
     * Get the logging instance for this class.
     * 
     * @return The logger for this class.
     */
    private MMLogger getLogger() {
<span class="nc bnc" id="L323" title="All 2 branches missed.">        return null == logger ? logger = DefaultMmLogger.getInstance() : logger;</span>
    }

    @Override
    public String toString() {
<span class="nc bnc" id="L328" title="All 41 branches missed.">        switch (type) {</span>
            case BACKWARDS:
<span class="nc" id="L330">                return &quot;B&quot;;</span>
            case CHARGE:
<span class="nc" id="L332">                return &quot;Ch&quot;;</span>
            case DFA:
<span class="nc" id="L334">                return &quot;DFA&quot;;</span>
            case FORWARDS:
<span class="nc" id="L336">                return &quot;F&quot;;</span>
            case CAREFUL_STAND:
            case GET_UP:
<span class="nc" id="L339">                return &quot;Up&quot;;</span>
            case GO_PRONE:
<span class="nc" id="L341">                return &quot;Prone&quot;;</span>
            case START_JUMP:
<span class="nc" id="L343">                return &quot;StrJump&quot;;</span>
            case TURN_LEFT:
<span class="nc" id="L345">                return &quot;L&quot;;</span>
            case TURN_RIGHT:
<span class="nc" id="L347">                return &quot;R&quot;;</span>
            case LATERAL_LEFT:
<span class="nc" id="L349">                return &quot;ShL&quot;;</span>
            case LATERAL_RIGHT:
<span class="nc" id="L351">                return &quot;ShR&quot;;</span>
            case LATERAL_LEFT_BACKWARDS:
<span class="nc" id="L353">                return &quot;ShLB&quot;;</span>
            case LATERAL_RIGHT_BACKWARDS:
<span class="nc" id="L355">                return &quot;ShRB&quot;;</span>
            case UNJAM_RAC:
<span class="nc" id="L357">                return &quot;Unjam&quot;;</span>
            case SEARCHLIGHT:
<span class="nc" id="L359">                return &quot;SLight&quot;;</span>
            case LOAD:
<span class="nc" id="L361">                return &quot;Load&quot;;</span>
            case UNLOAD:
<span class="nc" id="L363">                return &quot;Unload&quot;;</span>
            case EJECT:
<span class="nc" id="L365">                return &quot;Eject&quot;;</span>
            case UP:
<span class="nc" id="L367">                return &quot;U&quot;;</span>
            case DOWN:
<span class="nc" id="L369">                return &quot;D&quot;;</span>
            case HULL_DOWN:
<span class="nc" id="L371">                return &quot;HullDown&quot;;</span>
            case CLIMB_MODE_ON:
<span class="nc" id="L373">                return &quot;CM+&quot;;</span>
            case CLIMB_MODE_OFF:
<span class="nc" id="L375">                return &quot;CM-&quot;;</span>
            case TAKEOFF:
<span class="nc" id="L377">                return &quot;Takeoff&quot;;</span>
            case VTAKEOFF:
<span class="nc" id="L379">                return &quot;Vertical Takeoff&quot;;</span>
            case LAND:
<span class="nc" id="L381">                return &quot;Landing&quot;;</span>
            case VLAND:
<span class="nc" id="L383">                return &quot;Vertical Landing&quot;;</span>
            case ACC:
<span class="nc" id="L385">                return &quot;Acc&quot;;</span>
            case DEC:
<span class="nc" id="L387">                return &quot;Dec&quot;;</span>
            case MANEUVER:
<span class="nc" id="L389">                return &quot;Maneuver&quot;;</span>
            case RETURN:
<span class="nc" id="L391">                return &quot;Fly Off (Return)&quot;;</span>
            case OFF:
<span class="nc" id="L393">                return &quot;Fly Off&quot;;</span>
            case FLEE:
<span class="nc" id="L395">                return &quot;Flee&quot;;</span>
            case EVADE:
<span class="nc" id="L397">                return &quot;Evade&quot;;</span>
            case CONVERT_MODE:
<span class="nc" id="L399">                return &quot;ConvMode&quot;;</span>
            case TOW:
<span class="nc" id="L401">                return &quot;Tow&quot;;</span>
            case DISCONNECT:
<span class="nc" id="L403">                return &quot;Disconnect&quot;;</span>
            case THRUST:
<span class="nc" id="L405">                return &quot;Thrust&quot;;</span>
            case YAW:
<span class="nc" id="L407">                return &quot;Yaw&quot;;</span>
            case HOVER:
<span class="nc" id="L409">                return &quot;Hover&quot;;</span>
            default:
<span class="nc" id="L411">                return &quot;???&quot;;</span>
        }
    }

    public MoveStepType getType() {
<span class="nc" id="L416">        return type;</span>
    }

    /**
     * Set the target of the current step.
     *
     * @param target - the &lt;code&gt;Targetable&lt;/code&gt; that is the target of this step.
     *               For example, the enemy being charged. If there is no target,
     *               pass a &lt;code&gt;null&lt;/code&gt;
     */
    public void setTarget(Targetable target) {
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L428">            targetId = Entity.NONE;</span>
<span class="nc" id="L429">            targetType = Targetable.TYPE_ENTITY;</span>
        } else {
<span class="nc" id="L431">            targetId = target.getTargetId();</span>
<span class="nc" id="L432">            targetType = target.getTargetType();</span>
        }
<span class="nc" id="L434">    }</span>
    
    /**
     * Turns VTOL bombing on or off for this step.
     */
    public void setVTOLBombing(boolean bombing) {
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (bombing) {</span>
<span class="nc" id="L441">            setTarget(new HexTarget(getPosition(), Targetable.TYPE_HEX_AERO_BOMB));</span>
        } else {
<span class="nc" id="L443">            setTarget(null);</span>
        }
<span class="nc" id="L445">    }</span>

    /**
     * Turns VTOL strafing on or off for this step.
     */
    public void setStrafing(boolean strafing) {
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (strafing) {</span>
<span class="nc" id="L452">            setTarget(new HexTarget(getPosition(), Targetable.TYPE_HEX_CLEAR));</span>
        } else {
<span class="nc" id="L454">            setTarget(null);</span>
        }
<span class="nc" id="L456">    }</span>

    /**
     * Get the target of the current step.
     *
     * @param game - The &lt;code&gt;Game&lt;/code&gt; object.
     * @return The &lt;code&gt;Targetable&lt;/code&gt; that is the target of this step. For
     *         example, the enemy being charged. This value may be
     *         &lt;code&gt;null&lt;/code&gt;
     */
    public Targetable getTarget(IGame game) {
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (targetId == Entity.NONE) {</span>
<span class="nc" id="L468">            return null;</span>
        }
<span class="nc" id="L470">        return game.getTarget(targetType, targetId);</span>
    }

    public Coords getTargetPosition() {
<span class="nc" id="L474">        return targetPos;</span>
    }

    public TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; getLaunched() {
<span class="nc bnc" id="L478" title="All 2 branches missed.">        if(launched == null) {</span>
<span class="nc" id="L479">            launched = new TreeMap&lt;&gt;();</span>
        }
        
<span class="nc" id="L482">        return launched;</span>
    }

    /**
     * Helper for compile(), to deal with steps that move to a new hex.
     *
     * @param game
     * @param entity
     * @param prev
     */
    private void compileMove(final IGame game, final Entity entity,
                             MoveStep prev, CachedEntityState cachedEntityState) {

<span class="nc" id="L495">        IHex destHex = game.getBoard().getHex(getPosition());</span>

        // Check for pavement movement.
<span class="nc bnc" id="L498" title="All 4 branches missed.">        if (!entity.isAirborne() &amp;&amp; Compute.canMoveOnPavement(game, prev.getPosition(), getPosition(), this)) {</span>
<span class="nc" id="L499">            setPavementStep(true);</span>
        } else {
<span class="nc" id="L501">            setPavementStep(false);</span>
<span class="nc" id="L502">            setOnlyPavement(false);</span>
        }

<span class="nc" id="L505">        setHasJustStood(false);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (prev.isThisStepBackwards() != isThisStepBackwards()) {</span>
<span class="nc" id="L507">            setDistance(0); // start over after shifting gears</span>
        }
<span class="nc" id="L509">        addDistance(1);</span>

        // need to reduce velocity left for aerospace units (and also reset
        // nTurns)
        // this is handled differently by aerospace units operating on the
        // ground map and by spheroids in atmosphere
<span class="nc bnc" id="L515" title="All 4 branches missed.">        if (entity.isAirborne() &amp;&amp; game.getBoard().onGround()) {</span>
<span class="nc" id="L516">            setNMoved(getNMoved() + 1);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">            if ((entity.getMovementMode() != EntityMovementMode.SPHEROID)</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                    &amp;&amp; (getNMoved() &gt;= 16)) {</span>
<span class="nc" id="L519">                setVelocityLeft(getVelocityLeft() - 1);</span>
<span class="nc" id="L520">                setNMoved(0);</span>
            }
<span class="nc bnc" id="L522" title="All 4 branches missed.">        } else if (entity.isAirborne() &amp;&amp; !game.useVectorMove()</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                &amp;&amp; !useSpheroidAtmosphere(game, entity)) {</span>
<span class="nc" id="L524">            setVelocityLeft(getVelocityLeft() - 1);</span>
<span class="nc" id="L525">            setNTurns(0);</span>
        }

        // Track number of moves straight for aero free moves in atmosphere, vehicle turn modes, and bootlegger maneuver
<span class="nc" id="L529">        setNStraight(getNStraight() + 1);</span>
        // if in atmosphere, then I need to know if this move qualifies the unit
        // for a free turn
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (useAeroAtmosphere(game, entity)) {</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">            if (game.getBoard().onGround() &amp;&amp; (getNStraight() &gt; 7)) {</span>
                // if flying on ground map, then you have to fly at least 8
                // straight hexes between turns (free or not)
                // http://www.classicbattletech.com/forums/index.php/topic,37171.new.html#new
<span class="nc" id="L537">                setNTurns(0);</span>
            }
                        
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (!hasFreeTurn()) {</span>
                // check conditions
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (dueFreeTurn()) {</span>
<span class="nc" id="L543">                    setFreeTurn(true);</span>
                }
            }
        }

<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (getType() == MoveStepType.DFA) {</span>
<span class="nc" id="L549">            IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L550">            setElevation(Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV)));</span>
            // If we're DFA-ing, we want to be 1 above the level of the target.
            // However, if that puts us in the ground, we're instead 1 above the
            // level of the hex right before the target.
<span class="nc" id="L554">            int otherEl = 0;</span>
<span class="nc" id="L555">            IHex hex2 = game.getBoard().getHex(prev.getPosition());</span>
<span class="nc" id="L556">            otherEl = Math.max(0, hex2.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">            if (otherEl &gt; getElevation()) {</span>
<span class="nc" id="L558">                setElevation(otherEl);</span>
            }
<span class="nc" id="L560">            setElevation(getElevation() + 1);</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">        } else if (isJumping()) {</span>
<span class="nc" id="L562">            IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L563">            int maxElevation = (entity.getJumpMP() + entity.getElevation() + game</span>
<span class="nc" id="L564">                    .getBoard().getHex(entity.getPosition()).surface())</span>
<span class="nc" id="L565">                    - hex.surface();</span>
<span class="nc" id="L566">            int building = hex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L567">            int depth = -hex.depth(true);</span>
            // need to adjust depth for potential ice over water
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if ((hex.containsTerrain(Terrains.ICE) &amp;&amp; hex</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                    .containsTerrain(Terrains.WATER))</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L572">                depth = 0;</span>
            }
            // grounded dropships are treated as level 10 buildings for purposes
            // of jumping over
<span class="nc" id="L576">            boolean grdDropship = false;</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">            if (building &lt; 10) {</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                for (Entity inHex : game.getEntitiesVector(getPosition())) {</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                    if (inHex.equals(entity)) {</span>
<span class="nc" id="L580">                        continue;</span>
                    }
<span class="nc bnc" id="L582" title="All 4 branches missed.">                    if ((inHex instanceof Dropship) &amp;&amp; !inHex.isAirborne()</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                            &amp;&amp; !inHex.isSpaceborne()) {</span>
<span class="nc" id="L584">                        building = 10;</span>
<span class="nc" id="L585">                        grdDropship = true;</span>
                    }
<span class="nc" id="L587">                }</span>
            }
<span class="nc bnc" id="L589" title="All 4 branches missed.">            if ((entity instanceof Infantry) &amp;&amp; !grdDropship) {</span>
                // infantry can jump into a building
<span class="nc" id="L591">                setElevation(Math.max(depth, Math.min(building, maxElevation)));</span>
            } else {
<span class="nc" id="L593">                setElevation(Math.max(depth, building));</span>
            }
<span class="nc bnc" id="L595" title="All 2 branches missed.">            if (climbMode()</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    &amp;&amp; (maxElevation &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L597">                setElevation(Math.max(getElevation(),</span>
<span class="nc" id="L598">                        hex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
            }
<span class="nc" id="L600">        } else {</span>
<span class="nc" id="L601">            Building bld = game.getBoard().getBuildingAt(getPosition());</span>

<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (bld != null) {</span>
<span class="nc" id="L604">                IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L605">                int maxElevation = (entity.getElevation() + game.getBoard()</span>
<span class="nc" id="L606">                        .getHex(entity.getPosition()).surface())</span>
<span class="nc" id="L607">                        - hex.surface();</span>

                // Meks can climb up level 2 walls or less while everything
                // can only climb up one level
<span class="nc bnc" id="L611" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L612">                    maxElevation += 2;</span>
                } else {
<span class="nc" id="L614">                    maxElevation++;</span>
                }

<span class="nc bnc" id="L617" title="All 2 branches missed.">                if (bld.getType() == Building.WALL) {</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                    if (maxElevation &gt;= hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L619">                        setElevation(Math.max(getElevation(),</span>
<span class="nc" id="L620">                                hex.terrainLevel(Terrains.BLDG_ELEV)));</span>
                    } else {// if the wall is taller then the unit then they
                        // cannot climb it or enter it
<span class="nc" id="L623">                        return;</span>
                    }
                } else {
                    // System.err.println(&quot; Entity &quot;+ entity.getDisplayName()
                    // +&quot; moving from elevation &quot; +
                    // game.getBoard().getHex(prev.getPosition()) + &quot; to &quot; +
                    // game.getBoard().getHex(getPosition()) +
                    // &quot; at assumed elevation &quot; +
                    // elevation + &quot; climb = &quot; + climbMode());
<span class="nc" id="L632">                    setElevation(entity</span>
<span class="nc" id="L633">                            .calcElevation(</span>
<span class="nc" id="L634">                                    game.getBoard().getHex(prev.getPosition()),</span>
<span class="nc" id="L635">                                    game.getBoard().getHex(getPosition()),</span>
                                    elevation,
<span class="nc" id="L637">                                    climbMode(),</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                                    (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                                            &amp;&amp; (prev.getType() == MoveStepType.CLIMB_MODE_OFF)));</span>
                    // System.err.println(&quot; Entity &quot;+ entity.getDisplayName()
                    // +&quot; result was &quot; + elevation);

                }
<span class="nc" id="L644">            } else {</span>
                // System.err.println(&quot; Entity &quot;+ entity.getDisplayName()
                // +&quot; moving from elevation &quot; +
                // game.getBoard().getHex(prev.getPosition()) + &quot; to &quot; +
                // game.getBoard().getHex(getPosition()) +
                // &quot; at assumed elevation &quot; +
                // elevation + &quot; climb = &quot; + climbMode());
<span class="nc" id="L651">                setElevation(entity</span>
<span class="nc" id="L652">                        .calcElevation(</span>
<span class="nc" id="L653">                                game.getBoard().getHex(prev.getPosition()),</span>
<span class="nc" id="L654">                                game.getBoard().getHex(getPosition()),</span>
                                elevation,
<span class="nc" id="L656">                                climbMode(),</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                                (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                                        &amp;&amp; (prev.getType() == MoveStepType.CLIMB_MODE_OFF)));</span>
                // System.err.println(&quot; Entity &quot;+ entity.getDisplayName()
                // +&quot; result was &quot; + elevation);
            }
        }

        // if this is a flying aero, then there is no MP cost for moving
<span class="nc bnc" id="L665" title="All 4 branches missed.">        if ((prev.getAltitude() &gt; 0) || game.getBoard().inSpace()) {</span>
<span class="nc" id="L666">            setMp(0);</span>
            // if this is a spheroid in atmosphere then the cost is always one
            // if it is the very first step, we prepend the cost of hovering for convenience
<span class="nc bnc" id="L669" title="All 2 branches missed.">            if (useSpheroidAtmosphere(game, entity)) {</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                if (game.getBoard().onGround()) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                    if ((distance % 8) == 1) {</span>
<span class="nc" id="L672">                        setMp(1);</span>
                    }
                } else {
<span class="nc" id="L675">                    setMp(1);</span>
                }
            }
        } else {
<span class="nc" id="L679">            calcMovementCostFor(game, prev, cachedEntityState);</span>
        }
        // check for water
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (!isPavementStep()</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">                &amp;&amp; (destHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">                &amp;&amp; !(destHex.containsTerrain(Terrains.ICE) &amp;&amp; (elevation &gt;= 0))</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">                &amp;&amp; !(destHex.terrainLevel(Terrains.BRIDGE_ELEV) == elevation)</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                &amp;&amp; !cachedEntityState.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L694">            setRunProhibited(true);</span>
        }
<span class="nc bnc" id="L696" title="All 2 branches missed.">        if (entity.getMovedBackwards()</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">                &amp;&amp; !entity.hasQuirk(OptionsConstants.QUIRK_POS_POWER_REVERSE)) {</span>
<span class="nc" id="L698">            setRunProhibited(true);</span>
        }

<span class="nc" id="L701">        int magmaLevel = destHex.terrainLevel(Terrains.MAGMA);</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (elevation &gt; 0) {</span>
<span class="nc" id="L703">            magmaLevel = 0;</span>
        }
        // Check for fire or magma crust in the new hex.
<span class="nc bnc" id="L706" title="All 4 branches missed.">        if (destHex.containsTerrain(Terrains.FIRE) || (magmaLevel == 1)) {</span>
<span class="nc" id="L707">            heat = 2;</span>
<span class="nc" id="L708">            totalHeat += 2;</span>
        }
        // Check for liquid magma
<span class="nc bnc" id="L711" title="All 2 branches missed.">        else if (magmaLevel == 2) {</span>
<span class="nc" id="L712">            heat = 5;</span>
<span class="nc" id="L713">            totalHeat += 5;</span>
        }

        // Checks for landed dropships collapsing buildings
<span class="nc bnc" id="L717" title="All 4 branches missed.">        if ((entity instanceof Dropship) &amp;&amp; !entity.isAirborne()) {</span>
<span class="nc" id="L718">            ArrayList&lt;Coords&gt; secondaryPositions = new ArrayList&lt;Coords&gt;();</span>
<span class="nc" id="L719">            secondaryPositions.add(getPosition());</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">            for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L721">                secondaryPositions.add(getPosition().translated(dir));</span>
            }
<span class="nc bnc" id="L723" title="All 2 branches missed.">            for (Coords pos : secondaryPositions) {</span>
<span class="nc" id="L724">                Building bld = game.getBoard().getBuildingAt(pos);</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">                if (bld != null) {</span>
<span class="nc" id="L726">                    getCrushedBuildingLocs().add(pos);</span>
                    // This is dangerous!
<span class="nc" id="L728">                    danger = true;</span>
                }
<span class="nc" id="L730">            }</span>
        }
        
        // WiGEs get bonus MP for each string of three consecutive hexes they descend.
<span class="nc bnc" id="L734" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                &amp;&amp; getClearance() &gt; 0</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>

<span class="nc" id="L738">            if (game.getBoard().getHex(getPosition()).ceiling()</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">                    &lt; game.getBoard().getHex(prev.getPosition()).ceiling()) {</span>
<span class="nc" id="L740">                nWigeDescent = prev.getNWigeDescent() + 1;</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">                if (nWigeDescent &gt;= 3) {</span>
<span class="nc" id="L742">                    wigeBonus++;</span>
<span class="nc" id="L743">                    nWigeDescent = 0;</span>
                }
            } else {
<span class="nc" id="L746">                nWigeDescent = 0;</span>
            }
        }

<span class="nc" id="L750">    }</span>

    /**
     * Compile the static move data for this step.
     *
     * @param game   the &lt;code&gt;Game&lt;/code&gt; being played.
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; taking this step.
     * @param prev   the previous step in the path.
     */
    protected void compile(final IGame game, final Entity entity, MoveStep prev, CachedEntityState cachedEntityState) {
<span class="nc" id="L760">        final boolean isInfantry = entity instanceof Infantry;</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">        boolean isFieldArtillery = (entity instanceof Infantry)</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                &amp;&amp; ((Infantry) entity).hasActiveFieldArtillery();</span>
<span class="nc" id="L763">        copy(game, prev);</span>

        // Is this the first step?
<span class="nc bnc" id="L766" title="All 2 branches missed.">        if (prev == null) {</span>
<span class="nc" id="L767">            prev = new MoveStep(null, MoveStepType.FORWARDS);</span>
<span class="nc" id="L768">            prev.setFromEntity(entity, game);</span>
<span class="nc" id="L769">            prev.isCarefulPath = isCareful();</span>
<span class="nc" id="L770">            prev.isJumpingPath = isJumping();</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            setFirstStep(prev.mpUsed == 0); // Bug 1519330 - its not a first step when continuing after a fall</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">        } else if (prev.isFirstStep() // Some step types don't remove first step status</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">                &amp;&amp; ((prev.getType() == MoveStepType.CLIMB_MODE_ON)</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">                        || (prev.getType() == MoveStepType.CLIMB_MODE_OFF))) {</span>
<span class="nc" id="L775">            setFirstStep(true);</span>
        }
<span class="nc bnc" id="L777" title="All 41 branches missed.">        switch (getType()) {</span>
            case UNLOAD:
            case DISCONNECT:
                // Infantry in immobilized transporters get
                // a special &quot;unload stranded&quot; game turn.
                // So do trailers on an immobilized tractor
<span class="nc" id="L783">                hasEverUnloaded = true;</span>
<span class="nc" id="L784">                setMp(0);</span>
<span class="nc" id="L785">                break;</span>
            case LOAD:
            case TOW:
<span class="nc" id="L788">                setMp(1);</span>
<span class="nc" id="L789">                break;</span>
            case MOUNT:
<span class="nc" id="L791">                setMp(0);</span>
<span class="nc" id="L792">                break;</span>
            case TURN_LEFT:
            case TURN_RIGHT:
                // Check for pavement movement.
<span class="nc bnc" id="L796" title="All 4 branches missed.">                if (!entity.isAirborne() &amp;&amp; Compute.canMoveOnPavement(game, prev.getPosition(), getPosition(), this)) {</span>
<span class="nc" id="L797">                    setPavementStep(true);</span>
                } else {
<span class="nc" id="L799">                    setPavementStep(false);</span>
<span class="nc" id="L800">                    setOnlyPavement(false);</span>
                }

                // Infantry can turn for free, except for field artillery
<span class="nc bnc" id="L804" title="All 8 branches missed.">                setMp((isJumping() || isHasJustStood() || (isInfantry &amp;&amp; !isFieldArtillery)) ? 0</span>
<span class="nc" id="L805">                        : 1);</span>
<span class="nc" id="L806">                setNStraight(0);</span>
<span class="nc bnc" id="L807" title="All 4 branches missed.">                if (entity.isAirborne() &amp;&amp; (entity.isAero())) {</span>
<span class="nc" id="L808">                    setMp(asfTurnCost(game, getType(), entity));</span>
<span class="nc" id="L809">                    setNTurns(getNTurns() + 1);</span>

<span class="nc bnc" id="L811" title="All 2 branches missed.">                    if (useAeroAtmosphere(game, entity)) {</span>
<span class="nc" id="L812">                        setFreeTurn(false);</span>
                    }
                }

                // tripods with all their legs only pay for their first facing change
<span class="nc bnc" id="L817" title="All 8 branches missed.">                if ((getEntity() instanceof TripodMech) &amp;&amp; (((Mech) getEntity()).countBadLegs() &lt; 1)</span>
                        &amp;&amp; ((prev.type == MoveStepType.TURN_LEFT) || (prev.type == MoveStepType.TURN_RIGHT))) {
<span class="nc" id="L819">                    setMp(0);</span>
                }
<span class="nc bnc" id="L821" title="All 2 branches missed.">                if (entity.isDropping()) {</span>
<span class="nc" id="L822">                    setMp(0);</span>
                }
<span class="nc" id="L824">                adjustFacing(getType());</span>
<span class="nc" id="L825">                break;</span>
            case BACKWARDS:
<span class="nc" id="L827">                moveInDir((getFacing() + 3) % 6);</span>
<span class="nc" id="L828">                setThisStepBackwards(true);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (!entity.hasQuirk(OptionsConstants.QUIRK_POS_POWER_REVERSE)) {</span>
<span class="nc" id="L830">                    setRunProhibited(true);</span>
                }
<span class="nc" id="L832">                compileMove(game, entity, prev, cachedEntityState);</span>
<span class="nc" id="L833">                break;</span>
            case FORWARDS:
            case DFA:
            case SWIM:
                // step forwards or backwards
<span class="nc" id="L838">                moveInDir(getFacing());</span>
<span class="nc" id="L839">                setThisStepBackwards(false);</span>
<span class="nc" id="L840">                compileMove(game, entity, prev, cachedEntityState);</span>
<span class="nc" id="L841">                break;</span>
            case CHARGE:
<span class="nc bnc" id="L843" title="All 4 branches missed.">                if (!(entity.isAirborne()) || !game.useVectorMove()) {</span>
<span class="nc" id="L844">                    moveInDir(getFacing());</span>
<span class="nc" id="L845">                    setThisStepBackwards(false);</span>
<span class="nc" id="L846">                    compileMove(game, entity, prev, cachedEntityState);</span>
                }
                break;
            case LATERAL_LEFT_BACKWARDS:
            case LATERAL_RIGHT_BACKWARDS:
<span class="nc" id="L851">                moveInDir((MovePath.getAdjustedFacing(getFacing(),</span>
<span class="nc" id="L852">                        MovePath.turnForLateralShift(getType())) + 3) % 6);</span>
<span class="nc" id="L853">                setThisStepBackwards(true);</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">                if (!entity.hasQuirk(OptionsConstants.QUIRK_POS_POWER_REVERSE)) {</span>
<span class="nc" id="L855">                    setRunProhibited(true);</span>
                }
<span class="nc" id="L857">                compileMove(game, entity, prev, cachedEntityState);</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
<span class="nc" id="L859">                    setMp(0);</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">                } else if (entity.isUsingManAce()</span>
                        &amp; (entity instanceof QuadMech)) {
<span class="nc" id="L862">                    setMp(getMp());</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">                } else if (isJumping() &amp;&amp;</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">                        (entity.getJumpType() == Mech.JUMP_BOOSTER)) {</span>
<span class="nc" id="L865">                    setMp(1);</span>
                } else {
<span class="nc" id="L867">                    setMp(getMp() + 1); // +1 for side step</span>
                }
<span class="nc" id="L869">                break;</span>
            case LATERAL_LEFT:
            case LATERAL_RIGHT:
<span class="nc" id="L872">                moveInDir(MovePath.getAdjustedFacing(getFacing(),</span>
<span class="nc" id="L873">                        MovePath.turnForLateralShift(getType())));</span>
<span class="nc" id="L874">                setThisStepBackwards(false);</span>
<span class="nc" id="L875">                compileMove(game, entity, prev, cachedEntityState);</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
<span class="nc" id="L877">                    setMp(0);</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">                } else if (entity.isUsingManAce()</span>
                        &amp; (entity instanceof QuadMech)) {
<span class="nc" id="L880">                    setMp(getMp());</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">                } else if (isJumping() &amp;&amp;</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                        (entity.getJumpType() == Mech.JUMP_BOOSTER)) {</span>
<span class="nc" id="L883">                    setMp(1);</span>
                } else {
<span class="nc" id="L885">                    setMp(getMp() + 1); // +1 for side step</span>
                }
<span class="nc" id="L887">                break;</span>
            case GET_UP:
                // mechs with 1 MP are allowed to get up
<span class="nc bnc" id="L890" title="All 2 branches missed.">                setMp(cachedEntityState.getRunMP() == 1 ? 1 : 2);</span>
<span class="nc" id="L891">                setHasJustStood(true);</span>
<span class="nc" id="L892">                break;</span>
            case CAREFUL_STAND:
<span class="nc bnc" id="L894" title="All 2 branches missed.">                if (cachedEntityState.getWalkMP() &lt;= 2) {</span>
<span class="nc" id="L895">                    entity.setCarefulStand(false);</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">                    setMp(cachedEntityState.getRunMP() == 1 ? 1 : 2);</span>
                } else {
<span class="nc" id="L898">                    setMp(cachedEntityState.getWalkMP());</span>
                }
<span class="nc" id="L900">                setHasJustStood(true);</span>
<span class="nc" id="L901">                break;</span>
            case GO_PRONE:
<span class="nc bnc" id="L903" title="All 2 branches missed.">                if (!entity.isHullDown()) {</span>
<span class="nc" id="L904">                    setMp(1);</span>
                }
                break;
            case START_JUMP:
<span class="nc" id="L908">                entity.setIsJumpingNow(true);</span>
<span class="nc" id="L909">                break;</span>
            case UP:
<span class="nc bnc" id="L911" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
<span class="nc" id="L912">                    setAltitude(altitude + 1);</span>
<span class="nc" id="L913">                    setMp(2);</span>
                } else {
<span class="nc bnc" id="L915" title="All 2 branches missed.">                    if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
                        // If on the ground, pay liftoff cost. If airborne, pay 1 MP to increase elevation
                        // (LAMs and glider protomechs only)
<span class="nc bnc" id="L918" title="All 2 branches missed.">                        if (getClearance() == 0) {</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                            setMp((entity instanceof Protomech)? 4 : 5);</span>
                        } else {
<span class="nc" id="L921">                            setMp(1);</span>
                        }
                    } else {
<span class="nc bnc" id="L924" title="All 2 branches missed.">                        if (entity instanceof Protomech) {</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">                            setMp(isJumping() ? 0 : 2);</span>
                        } else {
<span class="nc bnc" id="L927" title="All 2 branches missed.">                            setMp(isJumping() ? 0 : 1);</span>
                        }
                    }
<span class="nc" id="L930">                    setElevation(elevation + 1);</span>
                }
<span class="nc" id="L932">                break;</span>
            case DOWN:
<span class="nc bnc" id="L934" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
<span class="nc" id="L935">                    setAltitude(altitude - 1);</span>
                    // it costs nothing (and may increase velocity)
<span class="nc" id="L937">                    setMp(0);</span>
<span class="nc" id="L938">                    setNDown(getNDown() + 1);</span>
                } else {
<span class="nc" id="L940">                    setElevation(elevation - 1);</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">                    if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L942">                        setMp(0);</span>
                    } else {
<span class="nc bnc" id="L944" title="All 2 branches missed.">                        if (entity instanceof Protomech) {</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">                            setMp(isJumping() ? 0 : 2);</span>
                        } else {
<span class="nc bnc" id="L947" title="All 2 branches missed.">                            setMp(isJumping() ? 0 : 1);</span>
                        }
                    }
                }
<span class="nc" id="L951">                break;</span>
            case HULL_DOWN:
<span class="nc bnc" id="L953" title="All 4 branches missed.">                if (isProne() &amp;&amp; (entity instanceof Mech)) {</span>
<span class="nc" id="L954">                    int mpUsed = 1;</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                    if (entity instanceof BipedMech) {</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">                        for (int location = Mech.LOC_RLEG; location &lt;= Mech.LOC_LLEG; location++) {</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                            if (entity.isLocationBad(location)) {</span>
<span class="nc" id="L958">                                mpUsed += 99;</span>
<span class="nc" id="L959">                                break;</span>
                            }
<span class="nc" id="L961">                            mpUsed += ((Mech) entity)</span>
<span class="nc" id="L962">                                    .countLegActuatorCrits(location);</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">                            if (((Mech) entity).legHasHipCrit(location)) {</span>
<span class="nc" id="L964">                                mpUsed += 1;</span>
                            }
                        }
                    } else {
<span class="nc bnc" id="L968" title="All 2 branches missed.">                        for (int location = Mech.LOC_RARM; location &lt;= Mech.LOC_LLEG; location++) {</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">                            if (entity.isLocationBad(location)) {</span>
<span class="nc" id="L970">                                mpUsed += 99;</span>
<span class="nc" id="L971">                                break;</span>
                            }
<span class="nc" id="L973">                            mpUsed += ((QuadMech) entity)</span>
<span class="nc" id="L974">                                    .countLegActuatorCrits(location);</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">                            if (((QuadMech) entity).legHasHipCrit(location)) {</span>
<span class="nc" id="L976">                                mpUsed += 1;</span>
                            }
                        }
                    }
<span class="nc" id="L980">                    setMp(mpUsed);</span>
<span class="nc" id="L981">                } else {</span>
<span class="nc" id="L982">                    setMp(2);</span>
                }
<span class="nc" id="L984">                break;</span>
            case CLIMB_MODE_ON:
<span class="nc" id="L986">                setClimbMode(true);</span>
<span class="nc" id="L987">                break;</span>
            case CLIMB_MODE_OFF:
<span class="nc" id="L989">                setClimbMode(false);</span>
<span class="nc" id="L990">                break;</span>
            case SHAKE_OFF_SWARMERS:
                // Counts as flank move but you can only use cruise MP
<span class="nc" id="L993">                setMp(cachedEntityState.getRunMP() - cachedEntityState.getWalkMP());</span>
<span class="nc" id="L994">                break;</span>
            case TAKEOFF:
            case VTAKEOFF:
<span class="nc" id="L997">                setMp(0);</span>
<span class="nc" id="L998">                break;</span>
            case LAND:
            case VLAND:
<span class="nc" id="L1001">                setMp(0);</span>
<span class="nc" id="L1002">                setAltitude(0);</span>
<span class="nc" id="L1003">                break;</span>
            case ACCN:
<span class="nc" id="L1005">                setVelocityN(getVelocityN() + 1);</span>
<span class="nc" id="L1006">                setMp(1);</span>
<span class="nc" id="L1007">                break;</span>
            case DECN:
<span class="nc" id="L1009">                setVelocityN(getVelocityN() - 1);</span>
<span class="nc" id="L1010">                setMp(1);</span>
<span class="nc" id="L1011">                break;</span>
            case ACC:
<span class="nc" id="L1013">                setVelocity(getVelocity() + 1);</span>
<span class="nc" id="L1014">                setVelocityLeft(getVelocityLeft() + 1);</span>
<span class="nc" id="L1015">                setMp(1);</span>
<span class="nc" id="L1016">                break;</span>
            case DEC:
<span class="nc" id="L1018">                setVelocity(getVelocity() - 1);</span>
<span class="nc" id="L1019">                setVelocityLeft(getVelocityLeft() - 1);</span>
<span class="nc" id="L1020">                setMp(1);</span>
<span class="nc" id="L1021">                break;</span>
            case EVADE:
<span class="nc" id="L1023">                setEvading(true);</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
<span class="nc" id="L1025">                    setMp(2);</span>
                }
                break;
            case SHUTDOWN:
<span class="nc" id="L1029">                setShuttingDown(true);</span>
                // Do something here...
<span class="nc" id="L1031">                break;</span>
            case STARTUP:
<span class="nc" id="L1033">                setStartingUp(true);</span>
                // Do something here...
<span class="nc" id="L1035">                break;</span>
            case SELF_DESTRUCT:
<span class="nc" id="L1037">                setSelfDestructing(true);</span>
                // Do something here...
<span class="nc" id="L1039">                break;</span>
            case ROLL:
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                if (prev.isRolled) {</span>
<span class="nc" id="L1042">                    isRolled = false;</span>
                } else {
<span class="nc" id="L1044">                    isRolled = true;</span>
                }
                // doesn't cost anything if previous was a yaw
<span class="nc bnc" id="L1047" title="All 2 branches missed.">                if (prev.getType() != MoveStepType.YAW) {</span>
<span class="nc" id="L1048">                    setMp(1);</span>
<span class="nc" id="L1049">                    setNRolls(getNRolls() + 1);</span>
                } else {
<span class="nc" id="L1051">                    setMp(0);</span>
                }
<span class="nc" id="L1053">                break;</span>
            case LAUNCH:
            case DROP:
<span class="nc" id="L1056">                hasEverUnloaded = true;</span>
<span class="nc" id="L1057">                setMp(0);</span>
<span class="nc" id="L1058">                break;</span>
            case RECOVER:
<span class="nc" id="L1060">                setMp(0);</span>
<span class="nc" id="L1061">                break;</span>
            case JOIN:
<span class="nc" id="L1063">                setMp(0);</span>
<span class="nc" id="L1064">                break;</span>
            case THRUST:
<span class="nc" id="L1066">                setVectors(Compute.changeVectors(getVectors(), getFacing()));</span>
<span class="nc" id="L1067">                setMp(1);</span>
<span class="nc" id="L1068">                break;</span>
            case YAW:
<span class="nc" id="L1070">                setNRolls(getNRolls() + 1);</span>
<span class="nc" id="L1071">                reverseFacing();</span>
<span class="nc" id="L1072">                setMp(2);</span>
<span class="nc" id="L1073">                break;</span>
            case HOVER:
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L1076">                    setMp(2);</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">                    if (entity instanceof LandAirMech</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">                            &amp;&amp; entity.getAltitude() &gt; 0) {</span>
<span class="nc" id="L1080">                        setMp(10);</span>
<span class="nc" id="L1081">                        setElevation(altitude * 10);</span>
<span class="nc" id="L1082">                        setAltitude(0);</span>
                    } else {
<span class="nc bnc" id="L1084" title="All 2 branches missed.">                        setMp(entity instanceof Protomech? 4 : 5);</span>
                    }
                }
                break;
            case MANEUVER:
<span class="nc" id="L1089">                int cost = ManeuverType.getCost(getManeuverType(),</span>
<span class="nc" id="L1090">                        getVelocity());</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">                if (entity.isUsingManAce()) {</span>
<span class="nc" id="L1092">                    cost = Math.max(cost - 1, 0);</span>
                }
<span class="nc" id="L1094">                setMp(cost);</span>
<span class="nc" id="L1095">                break;</span>
            case LOOP:
<span class="nc" id="L1097">                setVelocityLeft(getVelocityLeft() - 4);</span>
<span class="nc" id="L1098">                setMp(0);</span>
<span class="nc" id="L1099">                break;</span>
            case CONVERT_MODE:
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                if (entity instanceof QuadVee) {</span>
<span class="nc" id="L1102">                    setMp(((QuadVee)entity).conversionCost());</span>
                } else {
<span class="nc" id="L1104">                    setMp(0);</span>
                }
<span class="nc" id="L1106">                movementMode = entity.nextConversionMode(prev.getMovementMode());</span>
<span class="nc" id="L1107">                break;</span>
            case BOOTLEGGER:
<span class="nc" id="L1109">                reverseFacing();</span>
<span class="nc" id="L1110">                setMp(2);</span>
<span class="nc" id="L1111">                break;</span>
            default:
<span class="nc" id="L1113">                setMp(0);</span>
        }

<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (noCost) {</span>
<span class="nc" id="L1117">            setMp(0);</span>
        }
        
<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if (type != MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L1121">            movementMode = prev.getMovementMode();</span>
        }

        // Tanks can just drive out of hull-down.  If we're a tank, and we moved
        //  then we are no longer hull-down.
<span class="nc bnc" id="L1126" title="All 4 branches missed.">        if ((entity instanceof Tank</span>
                || (entity instanceof QuadVee
<span class="nc bnc" id="L1128" title="All 4 branches missed.">                        &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE))</span>
                &amp;&amp; (distance &gt; 0)) {
<span class="nc" id="L1130">            setHullDown(false);</span>
        }

        // Update the entity's total MP used.
<span class="nc" id="L1134">        addMpUsed(getMp());</span>

        // Check for a stacking violation.
<span class="nc" id="L1137">        final Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L1138">                entity, getElevation(), getPosition(), null);</span>
<span class="nc bnc" id="L1139" title="All 4 branches missed.">        if ((violation != null) &amp;&amp; (getType() != MoveStepType.CHARGE)</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">                &amp;&amp; (getType() != MoveStepType.DFA)) {</span>
<span class="nc" id="L1141">            setStackingViolation(true);</span>
        }

        // set moveType, illegal, trouble flags
<span class="nc" id="L1145">        compileIllegal(game, entity, prev, cachedEntityState);</span>
<span class="nc" id="L1146">    }</span>

    /**
     * Returns whether the two step types contain opposite turns
     */
    boolean oppositeTurn(MoveStep turn2) {
<span class="nc bnc" id="L1152" title="All 3 branches missed.">        switch (type) {</span>
            case TURN_LEFT:
<span class="nc bnc" id="L1154" title="All 2 branches missed.">                return turn2.getType() == MoveStepType.TURN_RIGHT;</span>
            case TURN_RIGHT:
<span class="nc bnc" id="L1156" title="All 2 branches missed.">                return turn2.getType() == MoveStepType.TURN_LEFT;</span>
            default:
<span class="nc" id="L1158">                return false;</span>
        }
    }

    protected void setElevation(int el) {
<span class="nc" id="L1163">        elevation = el;</span>
<span class="nc" id="L1164">    }</span>

    protected void setAltitude(int alt) {
<span class="nc" id="L1167">        altitude = alt;</span>
<span class="nc" id="L1168">    }</span>

    /**
     * Takes the given state as the previous state and sets flags from it.
     *
     * @param game
     * @param prev
     */
    public void copy(final IGame game, MoveStep prev) {
<span class="nc bnc" id="L1177" title="All 2 branches missed.">        if (prev == null) {</span>
<span class="nc" id="L1178">            setFromEntity(getEntity(), game);</span>
<span class="nc" id="L1179">            return;</span>
        }
<span class="nc" id="L1181">        hasJustStood = prev.hasJustStood;</span>
<span class="nc" id="L1182">        facing = prev.getFacing();</span>
<span class="nc" id="L1183">        position = prev.getPosition();</span>

<span class="nc" id="L1185">        distance = prev.getDistance();</span>
<span class="nc" id="L1186">        mpUsed = prev.mpUsed;</span>
<span class="nc" id="L1187">        totalHeat = prev.totalHeat;</span>
<span class="nc" id="L1188">        isPavementStep = prev.isPavementStep;</span>
<span class="nc" id="L1189">        onlyPavement = prev.onlyPavement;</span>
<span class="nc" id="L1190">        wigeBonus = prev.wigeBonus;</span>
<span class="nc" id="L1191">        nWigeDescent = prev.nWigeDescent;</span>
<span class="nc" id="L1192">        thisStepBackwards = prev.thisStepBackwards;</span>
<span class="nc" id="L1193">        isProne = prev.isProne;</span>
<span class="nc" id="L1194">        isFlying = prev.isFlying;</span>
<span class="nc" id="L1195">        isHullDown = prev.isHullDown;</span>
<span class="nc" id="L1196">        climbMode = prev.climbMode;</span>
<span class="nc" id="L1197">        isRunProhibited = prev.isRunProhibited;</span>
<span class="nc" id="L1198">        hasEverUnloaded = prev.hasEverUnloaded;</span>
<span class="nc" id="L1199">        elevation = prev.elevation;</span>
<span class="nc" id="L1200">        altitude = prev.altitude;</span>
<span class="nc" id="L1201">        velocity = prev.velocity;</span>
<span class="nc" id="L1202">        velocityN = prev.velocityN;</span>
<span class="nc" id="L1203">        velocityLeft = prev.velocityLeft;</span>
<span class="nc" id="L1204">        nTurns = prev.nTurns;</span>
<span class="nc" id="L1205">        isEvading = prev.isEvading;</span>
<span class="nc" id="L1206">        isShuttingDown = prev.isShuttingDown;</span>
<span class="nc" id="L1207">        isStartingUp = prev.isStartingUp;</span>
<span class="nc" id="L1208">        isSelfDestructing = prev.isSelfDestructing;</span>
<span class="nc" id="L1209">        nRolls = prev.nRolls;</span>
<span class="nc" id="L1210">        isRolled = prev.isRolled;</span>
<span class="nc" id="L1211">        mv = prev.mv.clone();</span>
<span class="nc" id="L1212">        freeTurn = prev.freeTurn;</span>
<span class="nc" id="L1213">        nStraight = prev.nStraight;</span>
<span class="nc" id="L1214">        nDown = prev.nDown;</span>
<span class="nc" id="L1215">        nMoved = prev.nMoved;</span>
<span class="nc" id="L1216">    }</span>

    /**
     * Sets this state as coming from the entity.
     *
     * @param entity
     */
    public void setFromEntity(Entity entity, IGame game) {
<span class="nc" id="L1224">        this.entity = entity;</span>
<span class="nc" id="L1225">        position = entity.getPosition();</span>
<span class="nc" id="L1226">        facing = entity.getFacing();</span>
        // elevation
<span class="nc" id="L1228">        mpUsed = entity.mpUsed;</span>
<span class="nc" id="L1229">        distance = entity.delta_distance;</span>
<span class="nc" id="L1230">        isProne = entity.isProne();</span>
<span class="nc bnc" id="L1231" title="All 4 branches missed.">        isFlying = entity.isAirborne() || entity.isAirborneVTOLorWIGE();</span>
<span class="nc" id="L1232">        isHullDown = entity.isHullDown();</span>
<span class="nc" id="L1233">        climbMode = entity.climbMode();</span>
<span class="nc" id="L1234">        thisStepBackwards = entity.inReverse;</span>
        // Moving in reverse prohibits running
<span class="nc bnc" id="L1236" title="All 2 branches missed.">        if (thisStepBackwards) {</span>
<span class="nc" id="L1237">            isRunProhibited = true;</span>
        }

<span class="nc" id="L1240">        elevation = entity.getElevation();</span>
<span class="nc" id="L1241">        altitude = entity.getAltitude();</span>
<span class="nc" id="L1242">        movementType = entity.moved;</span>
<span class="nc" id="L1243">        movementMode = entity.getMovementMode();</span>

<span class="nc" id="L1245">        isRolled = false;</span>
<span class="nc" id="L1246">        freeTurn = false;</span>
<span class="nc" id="L1247">        nStraight = 0;</span>
<span class="nc" id="L1248">        nDown = 0;</span>

        // for some reason, doing it directly is adjusting the entity's vector
        // itself
        // which causes problems when canceling the action
        // what a hack. but I can't figure out what is going wrong
        // this works but god is it ugly
        // TODO: figure this out
<span class="nc" id="L1256">        int[] tempMv = entity.getVectors();</span>

<span class="nc" id="L1258">        mv = new int[]{0, 0, 0, 0, 0, 0};</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L1260">            mv[i] = tempMv[i];</span>
        }

        // if ASF get velocity
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L1265">            IAero a = (IAero) entity;</span>
<span class="nc" id="L1266">            velocity = a.getCurrentVelocity();</span>
<span class="nc" id="L1267">            velocityN = a.getNextVelocity();</span>
<span class="nc" id="L1268">            velocityLeft = a.getCurrentVelocity() - entity.delta_distance;</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">            if (game.getBoard().onGround()) {</span>
<span class="nc" id="L1270">                velocityLeft = a.getCurrentVelocity() - (entity.delta_distance / 16);</span>
            }
<span class="nc" id="L1272">            isRolled = false;// a.isRolled();</span>
<span class="nc" id="L1273">            nStraight = a.getStraightMoves();</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">            if (dueFreeTurn()) {</span>
<span class="nc" id="L1275">                setFreeTurn(true);</span>
            }
        }

<span class="nc" id="L1279">        EntityMovementMode nMove = entity.getMovementMode();</span>

        // tanks with stunned crew can't flank
<span class="nc bnc" id="L1282" title="All 4 branches missed.">        if ((entity instanceof Tank) &amp;&amp; (((Tank) entity).getStunnedTurns() &gt; 0)) {</span>
<span class="nc" id="L1283">            isRunProhibited = true;</span>
        }
        
        //Cannot run while using Mek tracks
<span class="nc bnc" id="L1287" title="All 6 branches missed.">        if (entity instanceof Mech &amp;&amp; entity.getMovementMode() == EntityMovementMode.TRACKED</span>
                &amp;&amp; !(entity instanceof QuadVee)) {
<span class="nc" id="L1289">            isRunProhibited = true;</span>
        }

        // check pavement &amp; water
<span class="nc bnc" id="L1293" title="All 2 branches missed.">        if (position != null) {</span>
<span class="nc" id="L1294">            IHex curHex = game.getBoard().getHex(position);</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">            if (curHex.hasPavement()) {</span>
<span class="nc" id="L1296">                onlyPavement = true;</span>
<span class="nc" id="L1297">                isPavementStep = true;</span>
                // if we previously moved, and didn't get a pavement bonus, we
                // shouldn't now get one, either (this can happen when skidding
                // onto a pavement hex
<span class="nc bnc" id="L1301" title="All 4 branches missed.">                if (!entity.gotPavementBonus</span>
                        &amp;&amp; (entity.delta_distance &gt; 0)) {
<span class="nc" id="L1303">                    onlyPavement = false;</span>
                }
            }
            // if entity already moved into water it can't run now
<span class="nc bnc" id="L1307" title="All 2 branches missed.">            if (curHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L1308" title="All 12 branches missed.">                    &amp;&amp; (entity.getElevation() &lt; 0) &amp;&amp; (distance &gt; 0)</span>
                    &amp;&amp; (nMove != EntityMovementMode.NAVAL)
                    &amp;&amp; (nMove != EntityMovementMode.HYDROFOIL)
                    &amp;&amp; (nMove != EntityMovementMode.SUBMARINE)
                    &amp;&amp; (nMove != EntityMovementMode.INF_UMU)) {
<span class="nc" id="L1313">                isRunProhibited = true;</span>
            }
        }
<span class="nc" id="L1316">    }</span>

    /**
     * Adjusts facing to comply with the type of step indicated.
     *
     * @param stepType
     */
    public void adjustFacing(MoveStepType stepType) {
<span class="nc" id="L1324">        facing = MovePath.getAdjustedFacing(facing, stepType);</span>
<span class="nc" id="L1325">    }</span>

    /**
     * For yaws, reverse the current facing
     */
    public void reverseFacing() {
<span class="nc" id="L1331">        facing = MovePath.getAdjustedFacing(facing, MoveStepType.TURN_RIGHT);</span>
<span class="nc" id="L1332">        facing = MovePath.getAdjustedFacing(facing, MoveStepType.TURN_RIGHT);</span>
<span class="nc" id="L1333">        facing = MovePath.getAdjustedFacing(facing, MoveStepType.TURN_RIGHT);</span>
<span class="nc" id="L1334">    }</span>

    /**
     * Moves the position one hex in the direction indicated. Does not change
     * facing.
     *
     * @param dir
     */
    public void moveInDir(int dir) {
<span class="nc" id="L1343">        position = position.translated(dir);</span>
<span class="nc" id="L1344">    }</span>

    /**
     * Adds a certain amount to the distance parameter.
     *
     * @param increment
     */
    public void addDistance(int increment) {
<span class="nc" id="L1352">        distance += increment;</span>
<span class="nc" id="L1353">    }</span>

    /**
     * Adds a certain amount to the mpUsed parameter.
     *
     * @param increment
     */
    public void addMpUsed(int increment) {
<span class="nc" id="L1361">        mpUsed += increment;</span>
<span class="nc" id="L1362">    }</span>

    /**
     * @return
     */
    public boolean isDanger() {
<span class="nc" id="L1368">        return danger;</span>
    }

    /**
     * @return
     */
    public int getDistance() {
<span class="nc" id="L1375">        return distance;</span>
    }

    /**
     * @return
     */
    public int getLeapDistance() {
<span class="nc" id="L1382">        return leapDistance;</span>
    }

    /**
     * @return
     */
    public int getFacing() {
<span class="nc" id="L1389">        return facing;</span>
    }

    /**
     * @return
     */
    public boolean isFirstStep() {
<span class="nc" id="L1396">        return firstStep;</span>
    }

    /**
     * @return
     */
    public boolean isHasJustStood() {
<span class="nc" id="L1403">        return hasJustStood;</span>
    }

    public boolean isPavementStep() {
<span class="nc" id="L1407">        return isPavementStep;</span>
    }

    /**
     * @return
     */
    public boolean isProne() {
<span class="nc" id="L1414">        return isProne;</span>
    }

    /**
     * Returns true if the entity is flying on this step.
     *
     * @return
     */
    public boolean isFlying() {
<span class="nc" id="L1423">        return isFlying;</span>
    }

    public boolean isHullDown() {
<span class="nc" id="L1427">        return isHullDown;</span>
    }

    public boolean climbMode() {
<span class="nc" id="L1431">        return climbMode;</span>
    }

    /**
     * @return
     */
    public boolean isTurning() {
<span class="nc" id="L1438">        return isTurning;</span>
    }

    /**
     * @return
     */
    public boolean isUnloaded() {
<span class="nc" id="L1445">        return isUnloaded;</span>
    }

    /**
     * @return
     */
    public boolean isUsingMASC() {
<span class="nc" id="L1452">        return isUsingMASC;</span>
    }

    public boolean isEvading() {
<span class="nc" id="L1456">        return isEvading;</span>
    }

    public boolean isShuttingDown() {
<span class="nc" id="L1460">        return isShuttingDown;</span>
    }

    public boolean isStartingUp() {
<span class="nc" id="L1464">        return isStartingUp;</span>
    }

    public boolean isSelfDestructing() {
<span class="nc" id="L1468">        return isSelfDestructing;</span>
    }

    public boolean isRolled() {
<span class="nc" id="L1472">        return isRolled;</span>
    }
    
    public boolean isVTOLBombingStep() {
<span class="nc bnc" id="L1476" title="All 2 branches missed.">        return targetType == Targetable.TYPE_HEX_AERO_BOMB;</span>
    }
    
    public boolean isStrafingStep() {
<span class="nc bnc" id="L1480" title="All 2 branches missed.">        return targetType == Targetable.TYPE_HEX_CLEAR;</span>
    }
    
    /**
     * Determine if this is a legal step as part of the supplied MovePath.
     *
     * @param path  A MovePath that contains this step.
     * @return &lt;code&gt;true&lt;/code&gt; if the step is legal. &lt;code&gt;false&lt;/code&gt;
     *         otherwise.
     */
    public boolean isLegal(MovePath path) {
        // A step is legal if it's static movement type is not illegal,
        // and it is either a valid end position, or not an end position.
<span class="nc bnc" id="L1493" title="All 2 branches missed.">        return ((movementType != EntityMovementType.MOVE_ILLEGAL)</span>
<span class="nc bnc" id="L1494" title="All 4 branches missed.">                &amp;&amp; (isLegalEndPos() || !isEndPos(path)));</span>
    }

    /**
     * Return this step's movement type.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; constant for this step's movement type.
     */
    public EntityMovementType getMovementType(boolean isLastStep) {
<span class="nc" id="L1503">        EntityMovementType moveType = movementType;</span>
        // If this step's position is the end of the path, and it is not
        // a valid end postion, then the movement type is &quot;illegal&quot;.
<span class="nc bnc" id="L1506" title="All 4 branches missed.">        if (isLastStep &amp;&amp; !isLegalEndPos()) {</span>
<span class="nc" id="L1507">            moveType = EntityMovementType.MOVE_ILLEGAL;</span>
        }
<span class="nc" id="L1509">        return moveType;</span>
    }
    
    public EntityMovementMode getMovementMode() {
<span class="nc bnc" id="L1513" title="All 2 branches missed.">        if (movementMode == EntityMovementMode.NONE) {</span>
<span class="nc" id="L1514">            return getEntity().getMovementMode();</span>
        }
<span class="nc" id="L1516">        return movementMode;</span>
    }

    /**
     * Check to see if this step's position is a valid end of a path.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this step's position is a legal end of a
     *         path. If the step is not legal for an end of a path, then
     *         &lt;code&gt;false&lt;/code&gt; is returned.
     */
    public boolean isLegalEndPos() {
        // Can't be a stacking violation.
<span class="nc" id="L1528">        boolean legal = true;</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">        if (isStackingViolation) {</span>
<span class="nc" id="L1530">            legal = false;</span>
<span class="nc bnc" id="L1531" title="All 2 branches missed.">        } else if (terrainInvalid) {</span>
            // Can't be into invalid terrain.
<span class="nc" id="L1533">            legal = false;</span>
<span class="nc bnc" id="L1534" title="All 4 branches missed.">        } else if (isJumping() &amp;&amp; (distance == 0)) {</span>
            // Can't jump zero hexes.
<span class="nc" id="L1536">            legal = false;</span>
<span class="nc bnc" id="L1537" title="All 12 branches missed.">        } else if (hasEverUnloaded &amp;&amp; (type != MoveStepType.UNLOAD)</span>
                &amp;&amp; (type != MoveStepType.LAUNCH) &amp;&amp; (type != MoveStepType.DROP)
                &amp;&amp; (type != MoveStepType.UNDOCK) &amp;&amp; (type != MoveStepType.DISCONNECT)
<span class="nc bnc" id="L1540" title="All 2 branches missed.">                &amp;&amp; (getAltitude() == 0)) {</span>
            // Can't be after unloading BA/inf
<span class="nc" id="L1542">            legal = false;</span>
        }
<span class="nc" id="L1544">        return legal;</span>
    }

    /**
     * Update this step's status as the ending position of a path.
     *
     * @param isEnd the &lt;code&gt;boolean&lt;/code&gt; flag that specifies that this step's
     *              position is the end of a path.
     * @return &lt;code&gt;true&lt;/code&gt; if the path needs to keep updating the steps.
     *         &lt;code&gt;false&lt;/code&gt; if the update of the path is complete.
     * @see &lt;code&gt;#isLegalEndPos()&lt;/code&gt;
     * @see &lt;code&gt;#isEndPos&lt;/code&gt;
     * @see &lt;code&gt;MovePath#addStep( MoveStep )&lt;/code&gt;
     */
    public boolean setEndPos(boolean isEnd) {
<span class="nc" id="L1559">        boolean isEndPos = true;</span>
        // A step that is always illegal is always the end of the path.
<span class="nc bnc" id="L1561" title="All 2 branches missed.">        if (EntityMovementType.MOVE_ILLEGAL == movementType) {</span>
<span class="nc" id="L1562">            isEnd = true;</span>
        }

        // If this step didn't already know it's status as the ending
        // position of a path, then there are more updates to do.
<span class="nc bnc" id="L1567" title="All 2 branches missed.">        boolean moreUpdates = (isEndPos != isEnd);</span>
<span class="nc" id="L1568">        isEndPos = isEnd;</span>

        // If this step isn't the end step anymore, we might not be in danger
        // after all
<span class="nc" id="L1572">        IHex pos = getGame().getBoard().getHex(position);</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">        if (getGame().getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_PSR_JUMP_HEAVY_WOODS)) {</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">            if (!isEnd</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">                    &amp;&amp; isJumping()</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">                    &amp;&amp; (pos.containsTerrain(Terrains.WOODS, 2) </span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">                            || pos.containsTerrain(Terrains.WOODS, 3))) {</span>
<span class="nc" id="L1578">                danger = false;</span>
<span class="nc" id="L1579">                pastDanger = false;</span>
            }
        }

<span class="nc" id="L1583">        return moreUpdates;</span>
    }
    
    /**
     * Returns true if a step is considered to be in an end position for the
     * given MovePath. A step is in an end position if it is the last legal
     * step, or is an illegal step past the last legal step.
     * 
     * @param path
     * @return
     */
    public boolean isEndPos(MovePath path) {
        // A step that is illegal is always the end of the path.
<span class="nc bnc" id="L1596" title="All 2 branches missed.">        if (EntityMovementType.MOVE_ILLEGAL == movementType) {</span>
<span class="nc" id="L1597">            return true;</span>
        }
        
<span class="nc bnc" id="L1600" title="All 2 branches missed.">        if (path == null) {</span>
<span class="nc" id="L1601">            return true;</span>
        }
        
        // A step is an end position if it is the last legal step.
<span class="nc" id="L1605">        Vector&lt;MoveStep&gt; steps = path.getStepVector();</span>
        // Starting from the end, each step is considered the last step until
        // we find a legal last step
<span class="nc" id="L1608">        boolean lastStep = true;</span>
<span class="nc bnc" id="L1609" title="All 2 branches missed.">        for (int i = steps.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L1610">            MoveStep step = steps.get(i);</span>
<span class="nc" id="L1611">            boolean stepMatch = this.equals(step);</span>
<span class="nc bnc" id="L1612" title="All 2 branches missed.">            if (lastStep) {</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">                lastStep &amp;= step.getMovementType(true) == EntityMovementType.MOVE_ILLEGAL;</span>
            }
            // If there is a legal step after us, we're not the end
<span class="nc bnc" id="L1616" title="All 4 branches missed.">            if ((step.getMovementType(lastStep) != EntityMovementType.MOVE_ILLEGAL)</span>
                    &amp;&amp; !stepMatch) {
<span class="nc" id="L1618">                return false;</span>
            // If we found the current step, no need to check the others
<span class="nc bnc" id="L1620" title="All 2 branches missed.">            } else if (stepMatch) {</span>
<span class="nc" id="L1621">                return true;</span>
            }
        }
        // Shouldn't reach here, since this step is assumed be in the step list
<span class="nc" id="L1625">        return false;        </span>
    }

    /**
     * @return
     */
    public int getMpUsed() {
<span class="nc" id="L1632">        return mpUsed;</span>
    }

    /**
     * @return
     */
    public boolean isOnlyPavement() {
<span class="nc" id="L1639">        return onlyPavement;</span>
    }
    
    public int getWiGEBonus() {
<span class="nc" id="L1643">        return wigeBonus;</span>
    }
    
    public int getNWigeDescent() {
<span class="nc" id="L1647">        return nWigeDescent;</span>
    }

    /**
     * @return
     */
    public boolean isPastDanger() {
<span class="nc" id="L1654">        return pastDanger;</span>
    }
    
    public void setPastDanger(boolean pastDanger) {
<span class="nc" id="L1658">        this.pastDanger = pastDanger;</span>
<span class="nc" id="L1659">    }</span>

    /**
     * @return
     */
    public boolean isDocking() {
<span class="nc" id="L1665">        return docking;</span>
    }

    public void setDocking(boolean tf) {
<span class="nc" id="L1669">        docking = tf;</span>
<span class="nc" id="L1670">    }</span>

    /**
     * @return
     */
    public Coords getPosition() {
<span class="nc" id="L1676">        return position;</span>
    }

    /**
     * @return
     */
    public boolean isPrevStepOnPavement() {
<span class="nc" id="L1683">        return prevStepOnPavement;</span>
    }

    /**
     * @return
     */
    public int getTargetNumberMASC() {
<span class="nc" id="L1690">        return targetNumberMASC;</span>
    }

    /**
     * @return
     */
    public boolean isThisStepBackwards() {
<span class="nc" id="L1697">        return thisStepBackwards;</span>
    }

    /**
     * @param b
     */
    public void setDanger(boolean b) {
<span class="nc" id="L1704">        danger = b;</span>
<span class="nc" id="L1705">    }</span>

    /**
     * @param i
     */
    protected void setDistance(int i) {
<span class="nc" id="L1711">        distance = i;</span>
<span class="nc" id="L1712">    }</span>

    /**
     * @param i
     */
    protected void setLeapDistance(int i) {
<span class="nc" id="L1718">        leapDistance = i;</span>
<span class="nc" id="L1719">    }</span>

    /**
     * @param i
     */
    protected void setFacing(int i) {
<span class="nc" id="L1725">        facing = i;</span>
<span class="nc" id="L1726">    }</span>

    /**
     * @param b
     */
    protected void setFirstStep(boolean b) {
<span class="nc" id="L1732">        firstStep = b;</span>
<span class="nc" id="L1733">    }</span>

    /**
     * @param b
     */
    protected void setHasJustStood(boolean b) {
<span class="nc" id="L1739">        hasJustStood = b;</span>
<span class="nc" id="L1740">    }</span>

    /**
     * @param b
     */
    protected void setPavementStep(boolean b) {
<span class="nc" id="L1746">        isPavementStep = b;</span>
<span class="nc" id="L1747">    }</span>

    /**
     * @param b
     */
    protected void setProne(boolean b) {
<span class="nc" id="L1753">        isProne = b;</span>
<span class="nc" id="L1754">    }</span>

    /**
     * Sets whether the entity is flying or not.
     *
     * @param b is this entity flying?
     */
    protected void setFlying(boolean b) {
<span class="nc" id="L1762">        isFlying = b;</span>
<span class="nc" id="L1763">    }</span>

    protected void setHullDown(boolean b) {
<span class="nc" id="L1766">        isHullDown = b;</span>
<span class="nc" id="L1767">    }</span>

    protected void setClimbMode(boolean b) {
<span class="nc" id="L1770">        climbMode = b;</span>
<span class="nc" id="L1771">    }</span>

    /**
     * @param b
     */
    protected void setTurning(boolean b) {
<span class="nc" id="L1777">        isTurning = b;</span>
<span class="nc" id="L1778">    }</span>

    /**
     * @param b
     */
    protected void setUnloaded(boolean b) {
<span class="nc" id="L1784">        isUnloaded = b;</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">        if (b) {</span>
<span class="nc" id="L1786">            hasEverUnloaded = true;</span>
        }
<span class="nc" id="L1788">    }</span>

    /**
     * @param b
     */
    protected void setUsingMASC(boolean b) {
<span class="nc" id="L1794">        isUsingMASC = b;</span>
<span class="nc" id="L1795">    }</span>

    /**
     * @param i
     */
    public void setMovementType(EntityMovementType i) {
<span class="nc" id="L1801">        movementType = i;</span>
<span class="nc" id="L1802">    }</span>

    protected void setEvading(boolean b) {
<span class="nc" id="L1805">        isEvading = b;</span>
<span class="nc" id="L1806">    }</span>

    protected void setShuttingDown(boolean b) {
<span class="nc" id="L1809">        isShuttingDown = b;</span>
<span class="nc" id="L1810">    }</span>

    protected void setStartingUp(boolean b) {
<span class="nc" id="L1813">        isStartingUp = b;</span>
<span class="nc" id="L1814">    }</span>

    protected void setSelfDestructing(boolean b) {
<span class="nc" id="L1817">        isSelfDestructing = b;</span>
<span class="nc" id="L1818">    }</span>
    
    /**
     * @param b
     */
    protected void setOnlyPavement(boolean b) {
<span class="nc" id="L1824">        onlyPavement = b;</span>
<span class="nc" id="L1825">    }</span>
    
    protected void setWiGEBonus(int i) {
<span class="nc" id="L1828">        wigeBonus = i;</span>
<span class="nc" id="L1829">    }</span>

    protected void setTargetNumberMASC(int i) {
<span class="nc" id="L1832">        targetNumberMASC = i;</span>
<span class="nc" id="L1833">    }</span>

    protected void setThisStepBackwards(boolean b) {
<span class="nc" id="L1836">        thisStepBackwards = b;</span>
<span class="nc" id="L1837">    }</span>

    /**
     * Returns the mp used for just this step.
     */
    public int getMp() {
<span class="nc" id="L1843">        return mp;</span>
    }

    /**
     * sets the mp for this step.
     *
     * @param i the mp for this step.
     */
    protected void setMp(int i) {
<span class="nc" id="L1852">        mp = i;</span>
<span class="nc" id="L1853">    }</span>

    protected void setRunProhibited(boolean isRunProhibited) {
<span class="nc" id="L1856">        this.isRunProhibited = isRunProhibited;</span>
<span class="nc" id="L1857">    }</span>

    boolean isRunProhibited() {
<span class="nc" id="L1860">        return isRunProhibited;</span>
    }

    protected void setStackingViolation(boolean isStackingViolation) {
<span class="nc" id="L1864">        this.isStackingViolation = isStackingViolation;</span>
<span class="nc" id="L1865">    }</span>

    boolean isStackingViolation() {
<span class="nc" id="L1868">        return isStackingViolation;</span>
    }

    /**
     * This function checks that a step is legal. And adjust the movement type.
     * This only checks for things that can make this step by itself illegal.
     * Things that can make a step illegal as part of a movement path are
     * considered in MovePath.addStep.
     *
     * @param game
     * @param entity
     * @param prev
     */
    private void compileIllegal(final IGame game, final Entity entity,
            final MoveStep prev, CachedEntityState cachedEntityState) {
<span class="nc" id="L1883">        final MoveStepType stepType = getType();</span>
<span class="nc" id="L1884">        final boolean isInfantry = entity instanceof Infantry;</span>

<span class="nc" id="L1886">        Coords curPos = getPosition();</span>
<span class="nc" id="L1887">        Coords lastPos = prev.getPosition();</span>
<span class="nc" id="L1888">        boolean isUnjammingRAC = entity.isUnjammingRAC();</span>
<span class="nc" id="L1889">        prevStepOnPavement = prev.isPavementStep();</span>
<span class="nc" id="L1890">        isTurning = prev.isTurning();</span>
<span class="nc" id="L1891">        isUnloaded = prev.isUnloaded();</span>

        // Infantry get a first step if all they've done is spin on the spot.
<span class="nc bnc" id="L1894" title="All 4 branches missed.">        if (isInfantry &amp;&amp; ((getMpUsed() - getMp()) == 0)) {</span>
<span class="nc" id="L1895">            setFirstStep(true);</span>

            // getMpUsed() is the MPs used in the whole MovePath
            // getMp() is the MPs used in the last (illegal) step (this step)
            // if the difference between the whole path and this step is 0
            // then this must be their first step
        }

        // guilty until proven innocent
<span class="nc" id="L1904">        movementType = EntityMovementType.MOVE_ILLEGAL;</span>

        // Crushing buildings creates rubble, and Dropships can't drive on
        // rubble, so they get stuck
<span class="nc bnc" id="L1908" title="All 2 branches missed.">        if ((entity instanceof Dropship)</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">                &amp;&amp; !prev.getCrushedBuildingLocs().isEmpty()) {</span>
<span class="nc" id="L1910">            return;</span>
        }
        // AERO STUFF
        // I am going to put in a whole seperate section for Aeros and just
        // return from it
        // only if Aeros are airborne, otherwise they should move like other
        // units
<span class="nc bnc" id="L1917" title="All 4 branches missed.">        if (type == MoveStepType.HOVER &amp;&amp; entity instanceof LandAirMech</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">                &amp;&amp; entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L1919" title="All 2 branches missed.">                &amp;&amp; entity.getAltitude() &lt;= 3) {</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">            if (mpUsed &lt;= cachedEntityState.getWalkMP()) {</span>
<span class="nc" id="L1921">                movementType = EntityMovementType.MOVE_VTOL_WALK;</span>
<span class="nc bnc" id="L1922" title="All 2 branches missed.">            } else if (mpUsed &lt;= cachedEntityState.getRunMP()) {</span>
<span class="nc" id="L1923">                movementType = EntityMovementType.MOVE_VTOL_RUN;</span>
            } else {
<span class="nc" id="L1925">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
<span class="nc" id="L1927">            return;</span>
        }
        
<span class="nc bnc" id="L1930" title="All 4 branches missed.">        if ((prev.getAltitude() &gt; 0) || game.getBoard().inSpace()) {</span>
            //Ejected crew/pilots just drift or parachute, resulting in a move_none type
<span class="nc bnc" id="L1932" title="All 2 branches missed.">            if (entity instanceof EjectedCrew) {</span>
<span class="nc" id="L1933">                movementType = EntityMovementType.MOVE_NONE;</span>
<span class="nc" id="L1934">                return;</span>
            }

            // If airborne and some other non-Aero unit then everything is illegal, except
            // turns and AirMech 
<span class="nc bnc" id="L1939" title="All 2 branches missed.">            if (!entity.isAero()) {</span>
<span class="nc bnc" id="L1940" title="All 3 branches missed.">                switch (type) {</span>
                    case TURN_LEFT:
                    case TURN_RIGHT:
<span class="nc" id="L1943">                        movementType = EntityMovementType.MOVE_WALK;</span>
                    case CONVERT_MODE:
<span class="nc" id="L1945">                        movementType = EntityMovementType.MOVE_NONE;</span>
                    default:
                        break;
                }
<span class="nc" id="L1949">                return;</span>
            }

<span class="nc" id="L1952">            int tmpSafeTh = cachedEntityState.getWalkMP();</span>
<span class="nc" id="L1953">            IAero a = (IAero) entity;</span>

            // if the vessel is &quot;immobile&quot; due to shutdown or pilot black out
            // then all moves are illegal
<span class="nc bnc" id="L1957" title="All 2 branches missed.">            if (entity.isImmobile()) {</span>
<span class="nc" id="L1958">                return;</span>
            }

            // can't let players do an illegal move and use that to go less than
            // velocity
<span class="nc bnc" id="L1963" title="All 2 branches missed.">            if (!isFirstStep()</span>
<span class="nc bnc" id="L1964" title="All 2 branches missed.">                    &amp;&amp; (prev.getMovementType(false) == EntityMovementType.MOVE_ILLEGAL)) {</span>
<span class="nc" id="L1965">                return;</span>
            }

            // check the fuel requirements
<span class="nc bnc" id="L1969" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_FUEL_CONSUMPTION)) {</span>
<span class="nc" id="L1970">                int fuelUsed = mpUsed + Math.max(mpUsed - cachedEntityState.getWalkMP(), 0);</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                if (fuelUsed &gt; a.getFuel()) {</span>
<span class="nc" id="L1972">                    return;</span>
                }
            }

            // **Space turning limits**//
<span class="nc bnc" id="L1977" title="All 2 branches missed.">            if (game.getBoard().inSpace()) {</span>
                // space stations can only turn and launch space craft
<span class="nc bnc" id="L1979" title="All 10 branches missed.">                if ((entity instanceof SpaceStation)</span>
                        &amp;&amp; !((type == MoveStepType.TURN_LEFT)
                                || (type == MoveStepType.TURN_RIGHT)
                                || (type == MoveStepType.LAUNCH)
                                || (type == MoveStepType.UNDOCK))) {
<span class="nc" id="L1984">                    return;</span>
                }

                // unless velocity is zero ASFs must move forward one hex before
                // making turns in space
<span class="nc bnc" id="L1989" title="All 10 branches missed.">                if (!game.useVectorMove()</span>
                        &amp;&amp; (distance == 0)
                        &amp;&amp; (velocity != 0)
                        &amp;&amp; ((type == MoveStepType.TURN_LEFT) || (type == MoveStepType.TURN_RIGHT))) {
<span class="nc" id="L1993">                    return;</span>
                }

                // no more than two turns in one hex unless velocity is zero for
                // anything except ASF in space
<span class="nc bnc" id="L1998" title="All 6 branches missed.">                if (!game.useVectorMove() &amp;&amp; (a instanceof SmallCraft)</span>
<span class="nc bnc" id="L1999" title="All 2 branches missed.">                        &amp;&amp; (velocity != 0) &amp;&amp; (getNTurns() &gt; 2)) {</span>
<span class="nc" id="L2000">                    return;</span>
                }

                // for warships the limit is one
<span class="nc bnc" id="L2004" title="All 6 branches missed.">                if (!game.useVectorMove() &amp;&amp; (a instanceof Jumpship)</span>
<span class="nc bnc" id="L2005" title="All 2 branches missed.">                        &amp;&amp; (velocity != 0) &amp;&amp; (getNTurns() &gt; 1)) {</span>
<span class="nc" id="L2006">                    return;</span>
                }
            }

            // atmosphere has its own rules about turning
<span class="nc bnc" id="L2011" title="All 6 branches missed.">            if (useAeroAtmosphere(game, entity)</span>
                    &amp;&amp; ((type == MoveStepType.TURN_LEFT) || (type == MoveStepType.TURN_RIGHT))
<span class="nc bnc" id="L2013" title="All 2 branches missed.">                    &amp;&amp; !prev.canAeroTurn(game)) {</span>
<span class="nc" id="L2014">                return;</span>
            }
            
            // spheroids in atmosphere can move a max of 1 hex on the low atmo map
            // and 8 hexes on the ground map, regardless of any other considerations
            // unless they're out of control, in which case, well...
<span class="nc bnc" id="L2020" title="All 2 branches missed.">            if(useSpheroidAtmosphere(game, entity) &amp;&amp; </span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">            		(((IAero) entity).isOutControlTotal() ||</span>
<span class="nc bnc" id="L2022" title="All 4 branches missed.">                    (!game.getBoard().onGround() &amp;&amp; (this.getDistance() &gt; 1) || </span>
<span class="nc bnc" id="L2023" title="All 4 branches missed.">                            (game.getBoard().onGround() &amp;&amp; (getDistance() &gt; 8))))) {</span>
<span class="nc" id="L2024">                return;</span>
            }

<span class="nc bnc" id="L2027" title="All 2 branches missed.">            if ((type == MoveStepType.FORWARDS)</span>
<span class="nc bnc" id="L2028" title="All 4 branches missed.">                    &amp;&amp; game.getBoard().inAtmosphere() &amp;&amp; !a.isOutControl()) {</span>
<span class="nc" id="L2029">                IHex desth = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L2030" title="All 2 branches missed.">                if (altitude &lt;= desth.ceiling(true)) {</span>
<span class="nc" id="L2031">                    return; // can't fly into a cliff face or woods (unless out</span>
                    // of control)
                }
            }

            /*
             * TODO: better to disable this in movement display //don't let them
             * evade more than once if(type == MoveStepType.EVADE ) {
             * if(isEvading) { return; } else { setEvading(true); } }
             */

            // check for thruster damage
<span class="nc bnc" id="L2043" title="All 2 branches missed.">            if ((type == MoveStepType.TURN_LEFT)</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">                    &amp;&amp; (a.getRightThrustHits() &gt; 2)</span>
<span class="nc bnc" id="L2045" title="All 2 branches missed.">                    &amp;&amp; !useSpheroidAtmosphere(game, entity)) {</span>
<span class="nc" id="L2046">                return;</span>
            }
<span class="nc bnc" id="L2048" title="All 2 branches missed.">            if ((type == MoveStepType.TURN_RIGHT)</span>
<span class="nc bnc" id="L2049" title="All 2 branches missed.">                    &amp;&amp; (a.getLeftThrustHits() &gt; 2)</span>
<span class="nc bnc" id="L2050" title="All 2 branches missed.">                    &amp;&amp; !useSpheroidAtmosphere(game, entity)) {</span>
<span class="nc" id="L2051">                return;</span>
            }

            // no moves after launching fighters, unless we were undocking
<span class="nc bnc" id="L2055" title="All 4 branches missed.">            if (!isFirstStep() &amp;&amp; (prev.getType() == MoveStepType.LAUNCH) &amp;&amp;</span>
<span class="nc bnc" id="L2056" title="All 2 branches missed.">                    (getType() != MoveStepType.UNDOCK)) {</span>
<span class="nc" id="L2057">                return;</span>
            }

            // no moves after launching dropships, unless we are launching
<span class="nc bnc" id="L2061" title="All 4 branches missed.">            if (!isFirstStep() &amp;&amp; (prev.getType() == MoveStepType.UNDOCK) &amp;&amp;</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">                    (getType() != MoveStepType.LAUNCH)) {</span>
<span class="nc" id="L2063">                return;</span>
            }

            // no moves after being recovered
<span class="nc bnc" id="L2067" title="All 4 branches missed.">            if (!isFirstStep() &amp;&amp; (prev.getType() == MoveStepType.RECOVER)) {</span>
<span class="nc" id="L2068">                return;</span>
            }

            // no moves after joining
<span class="nc bnc" id="L2072" title="All 4 branches missed.">            if (!isFirstStep() &amp;&amp; (prev.getType() == MoveStepType.JOIN)) {</span>
<span class="nc" id="L2073">                return;</span>
            }

            // no moves after landing
<span class="nc bnc" id="L2077" title="All 2 branches missed.">            if (!isFirstStep()</span>
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                    &amp;&amp; ((prev.getType() == MoveStepType.LAND) || (prev</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                    .getType() == MoveStepType.VLAND))) {</span>
<span class="nc" id="L2080">                return;</span>
            }

            // can only use safe thrust when ammo (or bomb) dumping
            // (unless out of control?)
<span class="nc" id="L2085">            boolean bDumping = false;// a.isDumpingBombs();</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">            for (Mounted mo : entity.getAmmo()) {</span>
<span class="nc bnc" id="L2087" title="All 2 branches missed.">                if (mo.isDumping()) {</span>
<span class="nc" id="L2088">                    bDumping = true;</span>
<span class="nc" id="L2089">                    break;</span>
                }
<span class="nc" id="L2091">            }</span>

<span class="nc bnc" id="L2093" title="All 6 branches missed.">            if (bDumping &amp;&amp; (getMpUsed() &gt; tmpSafeTh) &amp;&amp; !a.isRandomMove()) {</span>
<span class="nc" id="L2094">                return;</span>
            }

            // check to make sure there is velocity left to spend
<span class="nc bnc" id="L2098" title="All 4 branches missed.">            if ((getVelocityLeft() &gt;= 0) || useSpheroidAtmosphere(game, entity)) {</span>
                // when aeros are flying on the ground mapsheet we need an
                // additional check
                // because velocityLeft is only decremented at intervals of 16
                // hexes
<span class="nc bnc" id="L2103" title="All 2 branches missed.">                if (useAeroAtmosphere(game, entity)</span>
<span class="nc bnc" id="L2104" title="All 2 branches missed.">                        &amp;&amp; game.getBoard().onGround()</span>
<span class="nc bnc" id="L2105" title="All 4 branches missed.">                        &amp;&amp; (getVelocityLeft() == 0) &amp;&amp; (getNMoved() &gt; 0)) {</span>
<span class="nc" id="L2106">                    return;</span>
                }
<span class="nc bnc" id="L2108" title="All 2 branches missed.">                if (getMpUsed() &lt;= tmpSafeTh) {</span>
<span class="nc" id="L2109">                    movementType = EntityMovementType.MOVE_SAFE_THRUST;</span>
<span class="nc bnc" id="L2110" title="All 2 branches missed.">                } else if (getMpUsed() &lt;= cachedEntityState.getRunMPwithoutMASC()) {</span>
<span class="nc" id="L2111">                    movementType = EntityMovementType.MOVE_OVER_THRUST;</span>
<span class="nc bnc" id="L2112" title="All 2 branches missed.">                } else if (a.isRandomMove()) {</span>
                    // if random move then allow it to be over thrust allowance
<span class="nc" id="L2114">                    movementType = EntityMovementType.MOVE_OVER_THRUST;</span>
                }
            }

<span class="nc" id="L2118">            return;</span>
        } // end AERO stuff

<span class="nc bnc" id="L2121" title="All 2 branches missed.">        if (prev.isDiggingIn) {</span>
<span class="nc" id="L2122">            isDiggingIn = true;</span>
<span class="nc bnc" id="L2123" title="All 4 branches missed.">            if ((type != MoveStepType.TURN_LEFT)</span>
                    &amp;&amp; (type != MoveStepType.TURN_RIGHT)) {
<span class="nc" id="L2125">                return; // can't move when digging in</span>
            }
<span class="nc" id="L2127">            movementType = EntityMovementType.MOVE_NONE;</span>
<span class="nc bnc" id="L2128" title="All 4 branches missed.">        } else if ((type == MoveStepType.DIG_IN)</span>
                || (type == MoveStepType.FORTIFY)) {
<span class="nc bnc" id="L2130" title="All 4 branches missed.">            if (!isInfantry || !isFirstStep()) {</span>
<span class="nc" id="L2131">                return; // can't dig in</span>
            }
<span class="nc" id="L2133">            Infantry inf = (Infantry) entity;</span>
<span class="nc bnc" id="L2134" title="All 2 branches missed.">            if ((inf.getDugIn() != Infantry.DUG_IN_NONE)</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">                    &amp;&amp; (inf.getDugIn() != Infantry.DUG_IN_COMPLETE)) {</span>
<span class="nc" id="L2136">                return; // already dug in</span>
            }
<span class="nc" id="L2138">            if (game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2139" title="All 2 branches missed.">                    .containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc" id="L2140">                    || game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2141" title="All 2 branches missed.">                    .containsTerrain(Terrains.FORTIFIED)</span>
<span class="nc" id="L2142">                    || game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">                    .containsTerrain(Terrains.BUILDING)</span>
<span class="nc" id="L2144">                    || game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2145" title="All 2 branches missed.">                    .containsTerrain(Terrains.ROAD)) {</span>
                // already fortified - pointless, or terrain is illegal for
                // digging in
<span class="nc" id="L2148">                return;</span>
            }
<span class="nc" id="L2150">            isDiggingIn = true;</span>
<span class="nc" id="L2151">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
        
        // Taking cover should happen as the last action
<span class="nc bnc" id="L2155" title="All 2 branches missed.">        if (prev.isTakingCover) {</span>
<span class="nc" id="L2156">            return;</span>
        }
        
<span class="nc bnc" id="L2159" title="All 2 branches missed.">        if (type == MoveStepType.TAKE_COVER) {</span>
            // Only Infantry can take cover
<span class="nc bnc" id="L2161" title="All 2 branches missed.">            if (!isInfantry) {</span>
<span class="nc" id="L2162">                return;</span>
            }
            // If there's no valid cover, it's illegal
<span class="nc bnc" id="L2165" title="All 2 branches missed.">            if (!Infantry.hasValidCover(game, getPosition(), getElevation())) {</span>
<span class="nc" id="L2166">                return;</span>
            }
<span class="nc" id="L2168">            isTakingCover = true;</span>
<span class="nc" id="L2169">            movementType = prev.getMovementType(false);</span>
<span class="nc" id="L2170">            return;</span>
        }

        // WIGEs can take off on their first step...
<span class="nc bnc" id="L2174" title="All 4 branches missed.">        if ((type == MoveStepType.UP) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">                &amp;&amp; (prev.getClearance() == 0)) {</span>
<span class="nc bnc" id="L2176" title="All 4 branches missed.">            if (firstStep &amp;&amp; (cachedEntityState.getRunMP() &gt;= mp)) {</span>
<span class="nc" id="L2177">                movementType = EntityMovementType.MOVE_VTOL_WALK;</span>
            } else {
<span class="nc" id="L2179">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2180">                return;</span>
            }
        }

        // WIGEs need to be able to land too, or even descend
<span class="nc bnc" id="L2185" title="All 4 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WIGE</span>
                &amp;&amp; type == MoveStepType.DOWN
<span class="nc bnc" id="L2187" title="All 2 branches missed.">                &amp;&amp; getClearance() &lt; prev.getClearance()) { // landing</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">            if (prev.getMovementType(false) == EntityMovementType.MOVE_VTOL_RUN</span>
<span class="nc bnc" id="L2189" title="All 2 branches missed.">                    || prev.getMovementType(false) == EntityMovementType.MOVE_VTOL_SPRINT) {</span>
<span class="nc" id="L2190">                movementType = prev.getMovementType(false);</span>
            } else {
<span class="nc" id="L2192">                movementType = EntityMovementType.MOVE_VTOL_WALK;</span>
            }
        }

        // check to see if it's trying to flee and can legally do so.
<span class="nc bnc" id="L2197" title="All 4 branches missed.">        if ((type == MoveStepType.FLEE) &amp;&amp; entity.canFlee()) {</span>
<span class="nc" id="L2198">            movementType = EntityMovementType.MOVE_LEGAL;</span>
        }

<span class="nc bnc" id="L2201" title="All 4 branches missed.">        if ((type == MoveStepType.CLIMB_MODE_ON)</span>
                || (type == MoveStepType.CLIMB_MODE_OFF)) {
<span class="nc" id="L2203">            movementType = prev.movementType;</span>
        }
        // check for ejection (always legal?)
<span class="nc bnc" id="L2206" title="All 2 branches missed.">        if (type == MoveStepType.EJECT) {</span>
<span class="nc" id="L2207">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
<span class="nc bnc" id="L2209" title="All 2 branches missed.">        if (type == MoveStepType.SEARCHLIGHT) {</span>
<span class="nc" id="L2210">            movementType = prev.movementType;</span>
        }
<span class="nc bnc" id="L2212" title="All 2 branches missed.">        if (type == MoveStepType.UNJAM_RAC) {</span>
<span class="nc" id="L2213">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
        // infantry are allowed to clear mines
<span class="nc bnc" id="L2216" title="All 4 branches missed.">        if ((type == MoveStepType.CLEAR_MINEFIELD)</span>
                &amp;&amp; (entity instanceof Infantry)) {
<span class="nc" id="L2218">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
        // check for evasion
<span class="nc bnc" id="L2221" title="All 2 branches missed.">        if (type == MoveStepType.EVADE) {</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">            if (entity.hasHipCrit()</span>
<span class="nc bnc" id="L2223" title="All 6 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WIGE</span>
                            &amp;&amp; (entity instanceof LandAirMech || entity instanceof Protomech)
<span class="nc bnc" id="L2225" title="All 2 branches missed.">                            &amp;&amp; getClearance() &gt; 0)) {</span>
<span class="nc" id="L2226">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2227">                return;</span>
            }                
            // evading means running
<span class="nc" id="L2230">            movementType = EntityMovementType.MOVE_RUN;</span>
        }
<span class="nc bnc" id="L2232" title="All 2 branches missed.">        if (type == MoveStepType.SHUTDOWN) {</span>
<span class="nc" id="L2233">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
<span class="nc bnc" id="L2235" title="All 2 branches missed.">        if (type == MoveStepType.STARTUP) {</span>
<span class="nc" id="L2236">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
<span class="nc bnc" id="L2238" title="All 2 branches missed.">        if (type == MoveStepType.SELF_DESTRUCT) {</span>
<span class="nc" id="L2239">            movementType = EntityMovementType.MOVE_NONE;</span>
        }
<span class="nc bnc" id="L2241" title="All 2 branches missed.">        if (type == MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L2242">            movementType = EntityMovementType.MOVE_NONE;</span>
        }

        // check for valid jump mp
<span class="nc bnc" id="L2246" title="All 2 branches missed.">        if (isJumping()</span>
<span class="nc bnc" id="L2247" title="All 2 branches missed.">                &amp;&amp; (getMpUsed() &lt;= entity.getJumpMPWithTerrain())</span>
<span class="nc bnc" id="L2248" title="All 2 branches missed.">                &amp;&amp; !isProne()</span>
<span class="nc bnc" id="L2249" title="All 4 branches missed.">                &amp;&amp; !isHullDown()</span>
                &amp;&amp; !((entity instanceof Protomech) &amp;&amp; (entity
<span class="nc bnc" id="L2251" title="All 2 branches missed.">                .getInternal(Protomech.LOC_LEG) == IArmorState.ARMOR_DESTROYED))</span>
<span class="nc bnc" id="L2252" title="All 4 branches missed.">                &amp;&amp; (!entity.isStuck() || entity.canUnstickByJumping())) {</span>
<span class="nc" id="L2253">            movementType = EntityMovementType.MOVE_JUMP;</span>
        }

        // legged Protos may make one facing change
<span class="nc bnc" id="L2257" title="All 4 branches missed.">        if (isFirstStep()</span>
                &amp;&amp; (entity instanceof Protomech)
<span class="nc bnc" id="L2259" title="All 6 branches missed.">                &amp;&amp; (entity.getInternal(Protomech.LOC_LEG) == IArmorState.ARMOR_DESTROYED)</span>
                &amp;&amp; ((stepType == MoveStepType.TURN_LEFT) || (stepType == MoveStepType.TURN_RIGHT))
<span class="nc bnc" id="L2261" title="All 2 branches missed.">                &amp;&amp; !entity.isStuck()) {</span>
<span class="nc" id="L2262">            movementType = EntityMovementType.MOVE_WALK;</span>
        }
        // Infantry that is first stepping and turning is legal
<span class="nc bnc" id="L2265" title="All 6 branches missed.">        if (isInfantry</span>
                &amp;&amp; ((stepType == MoveStepType.TURN_LEFT) || (stepType == MoveStepType.TURN_RIGHT))
<span class="nc bnc" id="L2267" title="All 2 branches missed.">                &amp;&amp; isFirstStep()) {</span>
<span class="nc bnc" id="L2268" title="All 2 branches missed.">            if (isJumping()) {</span>
<span class="nc" id="L2269">                movementType = EntityMovementType.MOVE_JUMP;</span>
            } else {
<span class="nc" id="L2271">                movementType = EntityMovementType.MOVE_WALK;</span>
            }
        }

<span class="nc" id="L2275">        int bonus = wigeBonus;</span>
<span class="nc" id="L2276">        entity.wigeBonus = wigeBonus;</span>
<span class="nc bnc" id="L2277" title="All 2 branches missed.">        if (entity.isEligibleForPavementBonus()</span>
<span class="nc bnc" id="L2278" title="All 2 branches missed.">                &amp;&amp; isOnlyPavement()) {</span>
<span class="nc" id="L2279">            bonus++;</span>
<span class="nc" id="L2280">            entity.gotPavementBonus = true;</span>
        }
<span class="nc" id="L2282">        int tmpWalkMP = cachedEntityState.getWalkMP() + bonus;</span>
<span class="nc" id="L2283">        int runMP = cachedEntityState.getRunMP() + bonus;</span>
<span class="nc" id="L2284">        int runMPnoMASC = cachedEntityState.getRunMPwithoutMASC() + bonus;</span>
<span class="nc" id="L2285">        int sprintMP = cachedEntityState.getSprintMP() + bonus;</span>
<span class="nc" id="L2286">        int sprintMPnoMASC = cachedEntityState.getSprintMPwithoutMASC() + bonus;</span>
<span class="nc" id="L2287">        final boolean isMASCUsed = entity.isMASCUsed();</span>
<span class="nc" id="L2288">        final boolean hasPoorPerformance = entity</span>
<span class="nc" id="L2289">                .hasQuirk(OptionsConstants.QUIRK_NEG_POOR_PERFORMANCE);</span>

        // WiGEs, AirMechs, and glider ProtoMechs have different MP for ground and airborne movement
<span class="nc bnc" id="L2292" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L2293" title="All 4 branches missed.">            if (getClearance() &lt;= 0 &amp;&amp; type != MoveStepType.UP) {</span>
<span class="nc bnc" id="L2294" title="All 2 branches missed.">                if (entity instanceof LandAirMech) {</span>
                    // On the ground or underwater use AirMech walk/run.
                    // Sprint can only be used on the ground, so that is already set.
<span class="nc" id="L2297">                    tmpWalkMP = ((LandAirMech)entity).getAirMechWalkMP();</span>
<span class="nc" id="L2298">                    runMPnoMASC = ((LandAirMech)entity).getAirMechRunMP();</span>
                    // LAMs cannot use hardened armor, which makes runMP a simpler calculation.
<span class="nc bnc" id="L2300" title="All 2 branches missed.">                    runMP = ((LandAirMech)entity).hasArmedMASC()? tmpWalkMP * 2 : runMPnoMASC;</span>
                } else {
                    // Only 1 ground MP for ground effect vehicles and glider protomechs
<span class="nc" id="L2303">                    tmpWalkMP = runMP = runMPnoMASC = sprintMP = sprintMPnoMASC = 1;</span>
                }
<span class="nc bnc" id="L2305" title="All 2 branches missed.">            } else if (entity instanceof LandAirMech) {</span>
                // LAMs cannot use overdrive and MASC does not effect airborne MP.
<span class="nc" id="L2307">                tmpWalkMP = ((LandAirMech)entity).getAirMechCruiseMP();</span>
<span class="nc" id="L2308">                runMP = runMPnoMASC = sprintMP = sprintMPnoMASC = ((LandAirMech)entity).getAirMechFlankMP();</span>
            }
        }

<span class="nc" id="L2312">        IHex currHex = game.getBoard().getHex(curPos);</span>
<span class="nc" id="L2313">        IHex lastHex = game.getBoard().getHex(lastPos);</span>
        
        // Bootlegger ends movement
<span class="nc bnc" id="L2316" title="All 2 branches missed.">        if (prev.type == MoveStepType.BOOTLEGGER) {</span>
<span class="nc" id="L2317">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2318">            return;</span>
        }
        
<span class="nc bnc" id="L2321" title="All 2 branches missed.">        if (stepType == MoveStepType.CONVERT_MODE) {</span>
            //QuadVees and LAMs cannot convert in water, and Mech tracks cannot be used in water.
<span class="nc bnc" id="L2323" title="All 2 branches missed.">            if (currHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L2324" title="All 2 branches missed.">                    &amp;&amp; getClearance() &lt; 0) {</span>
<span class="nc" id="L2325">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
            //QuadVees and LAMs cannot convert while prone. Mechs with tracks don't actually convert,
            //and can switch to track mode while prone then stand.
<span class="nc bnc" id="L2329" title="All 2 branches missed.">            if (getEntity().isProne()</span>
<span class="nc bnc" id="L2330" title="All 4 branches missed.">                    &amp;&amp; (getEntity() instanceof QuadVee || getEntity() instanceof LandAirMech)) {</span>
<span class="nc" id="L2331">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
            // Illegal LAM conversions due to damage have to be determined by entire path, because
            // some conversions take two convert steps and can be legal even though the first one
            // is illegal on its own.
        }
        
<span class="nc bnc" id="L2338" title="All 2 branches missed.">        if (isVTOLBombingStep()) {</span>
<span class="nc bnc" id="L2339" title="All 4 branches missed.">            if (!getEntity().isBomber() || getClearance() &lt;= 0) {</span>
<span class="nc" id="L2340">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc bnc" id="L2341" title="All 2 branches missed.">            } else if (isFirstStep()) {</span>
<span class="nc" id="L2342">                movementType = EntityMovementType.MOVE_NONE;</span>
            } else {
<span class="nc" id="L2344">                movementType = prev.getMovementType(false);</span>
            }
        }
        
<span class="nc bnc" id="L2348" title="All 2 branches missed.">        if ((getEntity().getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L2349" title="All 2 branches missed.">                &amp;&amp; (currHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L2350" title="All 2 branches missed.">                &amp;&amp; lastHex.containsTerrain(Terrains.WATER) &amp;&amp; (entity</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">                .relHeight() &lt; currHex.surface()))) {</span>
<span class="nc" id="L2352">            tmpWalkMP = entity.getActiveUMUCount();</span>
        }

<span class="nc bnc" id="L2355" title="All 2 branches missed.">        if ((getEntity().getMovementMode() == EntityMovementMode.BIPED_SWIM)</span>
<span class="nc bnc" id="L2356" title="All 2 branches missed.">                || (getEntity().getMovementMode() == EntityMovementMode.QUAD_SWIM)</span>
<span class="nc bnc" id="L2357" title="All 2 branches missed.">                || ((getEntity() instanceof Infantry</span>
<span class="nc bnc" id="L2358" title="All 2 branches missed.">                        &amp;&amp; getEntity().getMovementMode() == EntityMovementMode.SUBMARINE))) {</span>
<span class="nc" id="L2359">            tmpWalkMP = entity.getActiveUMUCount();</span>
        }

<span class="nc bnc" id="L2362" title="All 2 branches missed.">        if ((getEntity().getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L2363" title="All 2 branches missed.">                &amp;&amp; getClearance() &gt; 0</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">                &amp;&amp; !(getEntity() instanceof VTOL)) {</span>
<span class="nc" id="L2365">            tmpWalkMP = entity.getJumpMP();</span>
        }
        // check for valid walk/run mp
<span class="nc bnc" id="L2368" title="All 6 branches missed.">        if (!isJumping() &amp;&amp; !entity.isStuck() &amp;&amp; (tmpWalkMP &gt; 0)</span>
<span class="nc bnc" id="L2369" title="All 2 branches missed.">                &amp;&amp; (getMp() &gt; 0)) {</span>
            // Prone mechs can only spend MP to turn or get up
<span class="nc bnc" id="L2371" title="All 16 branches missed.">            if ((stepType != MoveStepType.TURN_LEFT)</span>
                    &amp;&amp; (stepType != MoveStepType.TURN_RIGHT)
                    &amp;&amp; (stepType != MoveStepType.GET_UP)
                    &amp;&amp; (stepType != MoveStepType.LOAD)
                    &amp;&amp; (stepType != MoveStepType.CAREFUL_STAND)
                    &amp;&amp; (stepType != MoveStepType.HULL_DOWN)
                    &amp;&amp; (stepType != MoveStepType.GO_PRONE)
                    &amp;&amp; !(entity instanceof Tank) // Tanks can drive out of
                    // hull-down
<span class="nc bnc" id="L2380" title="All 4 branches missed.">                    &amp;&amp; (isProne() || isHullDown())) {</span>
<span class="nc" id="L2381">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2382">                return;</span>
            }
            
            // WiGEs that land are finished with movement
<span class="nc bnc" id="L2386" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L2387" title="All 2 branches missed.">                    &amp;&amp; prev.getType() == MoveStepType.DOWN</span>
<span class="nc bnc" id="L2388" title="All 2 branches missed.">                    &amp;&amp; getClearance() == 0) {</span>
<span class="nc" id="L2389">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2390">                return;</span>
            }

<span class="nc bnc" id="L2393" title="All 2 branches missed.">            if (getMpUsed() &lt;= tmpWalkMP) {</span>
<span class="nc bnc" id="L2394" title="All 2 branches missed.">                if ((getEntity().getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L2395" title="All 2 branches missed.">                        || getEntity().getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L2396" title="All 2 branches missed.">                        &amp;&amp; getClearance() &gt; 0) {</span>
<span class="nc" id="L2397">                    movementType = EntityMovementType.MOVE_VTOL_WALK;</span>
                } else {
<span class="nc" id="L2399">                    movementType = EntityMovementType.MOVE_WALK;</span>
                    // Vehicles moving along pavement get &quot;road bonus&quot; of 1 MP.
                    // N.B. The Ask Precentor Martial forum said that a 4/6
                    // tank on a road can move 5/7, **not** 5/8.
                }
<span class="nc bnc" id="L2404" title="All 2 branches missed.">            } else if ((entity instanceof Infantry)</span>
<span class="nc bnc" id="L2405" title="All 2 branches missed.">                    &amp;&amp; (curPos.distance(entity.getPosition()) == 1)</span>
<span class="nc bnc" id="L2406" title="All 2 branches missed.">                    &amp;&amp; (lastPos.equals(entity.getPosition()))) {</span>
                // This ensures that Infantry always get their minimum 1 hex
                //  movement when TO fast infantry movement is on.
                // A movepath that consists of a single step from one hex to the
                // next should always be a walk, since it's covered under the
                // infantry's 1 free movement
<span class="nc bnc" id="L2412" title="All 2 branches missed.">                if ((getEntity().getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L2413" title="All 2 branches missed.">                        &amp;&amp; getClearance() &gt; 0) {</span>
<span class="nc" id="L2414">                    movementType = EntityMovementType.MOVE_VTOL_WALK;</span>
                } else {
<span class="nc" id="L2416">                    movementType = EntityMovementType.MOVE_WALK;</span>
                }
<span class="nc bnc" id="L2418" title="All 4 branches missed.">            } else if ((((getMpUsed() &lt;= runMP) &amp;&amp; isMASCUsed)</span>
<span class="nc bnc" id="L2419" title="All 4 branches missed.">                    || (getMpUsed() &lt;= runMPnoMASC)) &amp;&amp; !isRunProhibited()) {</span>
                // Poor performance requires spending all walk MP in the
                //  previous round in order to flank
<span class="nc bnc" id="L2422" title="All 2 branches missed.">                if (hasPoorPerformance</span>
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                        &amp;&amp; (entity.getMpUsedLastRound() &lt; cachedEntityState.getWalkMP())) {</span>
<span class="nc" id="L2424">                    movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2425">                    return;</span>
                }
<span class="nc bnc" id="L2427" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L2428" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L2429" title="All 2 branches missed.">                        &amp;&amp; getClearance() &gt; 0) {</span>
<span class="nc" id="L2430">                    movementType = EntityMovementType.MOVE_VTOL_RUN;</span>
                } else {
<span class="nc" id="L2432">                    movementType = EntityMovementType.MOVE_RUN;</span>
                }
<span class="nc bnc" id="L2434" title="All 4 branches missed.">            } else if ((getMpUsed() &lt;= runMP) &amp;&amp; !isRunProhibited()</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">                    &amp;&amp; !isEvading()) {</span>
<span class="nc" id="L2436">                setUsingMASC(true);</span>
<span class="nc" id="L2437">                setTargetNumberMASC(entity.getMASCTarget());</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2439">                    movementType = EntityMovementType.MOVE_VTOL_RUN;</span>
                } else {
<span class="nc" id="L2441">                    movementType = EntityMovementType.MOVE_RUN;</span>
                }
<span class="nc bnc" id="L2443" title="All 2 branches missed.">            } else if (canUseSprint(game)</span>
<span class="nc bnc" id="L2444" title="All 2 branches missed.">                    &amp;&amp; ((getMpUsed() &lt;= sprintMPnoMASC)</span>
<span class="nc bnc" id="L2445" title="All 4 branches missed.">                            || ((getMpUsed() &lt;= sprintMP) &amp;&amp; isMASCUsed))</span>
<span class="nc bnc" id="L2446" title="All 4 branches missed.">                    &amp;&amp; !isRunProhibited() &amp;&amp; !isEvading()) {</span>
<span class="nc bnc" id="L2447" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L2448" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L2449" title="All 2 branches missed.">                                &amp;&amp; getClearance() &gt; 0)) {</span>
<span class="nc" id="L2450">                    movementType = EntityMovementType.MOVE_VTOL_SPRINT;</span>
                } else {
<span class="nc" id="L2452">                    movementType = EntityMovementType.MOVE_SPRINT;</span>
                }
<span class="nc bnc" id="L2454" title="All 2 branches missed.">            } else if ((getMpUsed() &lt;= sprintMP)</span>
<span class="nc bnc" id="L2455" title="All 4 branches missed.">                    &amp;&amp; !isRunProhibited() &amp;&amp; !isEvading()</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_SPRINT)) {</span>
<span class="nc" id="L2457">                setUsingMASC(true);</span>
<span class="nc" id="L2458">                setTargetNumberMASC(entity.getMASCTarget());</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2460">                    movementType = EntityMovementType.MOVE_VTOL_SPRINT;</span>
                } else {
<span class="nc" id="L2462">                    movementType = EntityMovementType.MOVE_SPRINT;</span>
                }
            }
        }
        
        // If using vehicle acceleration restrictions, it is impossible to go from a stop to overdrive.
        // Stop to flank or cruise to overdrive is permitted with a driving check (&quot;gunning it&quot;).
<span class="nc bnc" id="L2469" title="All 8 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ACCELERATION)</span>
                &amp;&amp; movementType == EntityMovementType.MOVE_SPRINT
                &amp;&amp; (entity instanceof Tank
<span class="nc bnc" id="L2472" title="All 8 branches missed.">                        || (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE))</span>
                &amp;&amp; (entity.movedLastRound == EntityMovementType.MOVE_NONE
                    || entity.movedLastRound == EntityMovementType.MOVE_SKID
                    || entity.movedLastRound == EntityMovementType.MOVE_JUMP)) {
<span class="nc" id="L2476">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }
        // 0 MP infantry units can move 1 hex
<span class="nc bnc" id="L2479" title="All 2 branches missed.">        if (isInfantry</span>
<span class="nc bnc" id="L2480" title="All 2 branches missed.">                &amp;&amp; (cachedEntityState.getWalkMP() == 0)</span>
<span class="nc bnc" id="L2481" title="All 2 branches missed.">                &amp;&amp; getEntity().getPosition().equals(prev.getPosition())</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">                &amp;&amp; (prev.getElevation() == entity.getElevation())</span>
<span class="nc bnc" id="L2483" title="All 2 branches missed.">                &amp;&amp; (getEntity().getPosition().distance(getPosition()) &lt;= 1)</span>
<span class="nc" id="L2484">                &amp;&amp; (Math.abs(entity.getElevation() - getElevation()) </span>
<span class="nc bnc" id="L2485" title="All 4 branches missed.">                        &lt;= entity.getMaxElevationChange())</span>
                &amp;&amp; (movementType != EntityMovementType.MOVE_JUMP)) {
<span class="nc" id="L2487">            movementType = EntityMovementType.MOVE_WALK;</span>
        }

        // Free facing changes are legal
<span class="nc bnc" id="L2491" title="All 4 branches missed.">        if (((stepType == MoveStepType.TURN_LEFT) || (stepType == MoveStepType.TURN_RIGHT))</span>
<span class="nc bnc" id="L2492" title="All 2 branches missed.">                &amp;&amp; (getMp() == 0)) {</span>
<span class="nc" id="L2493">            movementType = prev.movementType;</span>
        }

        // Mechanical Jump Boosters don't allow facing changes
<span class="nc bnc" id="L2497" title="All 2 branches missed.">        if (isJumping()</span>
<span class="nc bnc" id="L2498" title="All 6 branches missed.">                &amp;&amp; (entity.getJumpType() == Mech.JUMP_BOOSTER)</span>
                &amp;&amp; ((stepType == MoveStepType.TURN_LEFT) || (stepType == MoveStepType.TURN_RIGHT))) {
<span class="nc" id="L2500">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // going prone from hull down is legal and costs 0
<span class="nc bnc" id="L2504" title="All 4 branches missed.">        if ((getMp() == 0) &amp;&amp; (stepType == MoveStepType.GO_PRONE)</span>
<span class="nc bnc" id="L2505" title="All 2 branches missed.">                &amp;&amp; isHullDown()) {</span>
<span class="nc" id="L2506">            movementType = prev.movementType;</span>
        }

<span class="nc bnc" id="L2509" title="All 4 branches missed.">        if ((movementType == EntityMovementType.MOVE_WALK)</span>
                &amp;&amp; (prev.movementType == EntityMovementType.MOVE_RUN)) {
<span class="nc" id="L2511">            movementType = EntityMovementType.MOVE_RUN;</span>
<span class="nc bnc" id="L2512" title="All 4 branches missed.">        } else if ((movementType == EntityMovementType.MOVE_VTOL_WALK)</span>
                &amp;&amp; (prev.movementType == EntityMovementType.MOVE_VTOL_RUN)) {
<span class="nc" id="L2514">            movementType = EntityMovementType.MOVE_VTOL_RUN;</span>
<span class="nc bnc" id="L2515" title="All 6 branches missed.">        } else if (((movementType == EntityMovementType.MOVE_WALK) || (movementType == EntityMovementType.MOVE_RUN))</span>
                &amp;&amp; (prev.movementType == EntityMovementType.MOVE_SPRINT)) {
<span class="nc" id="L2517">            movementType = EntityMovementType.MOVE_SPRINT;</span>
<span class="nc bnc" id="L2518" title="All 6 branches missed.">        } else if (((movementType == EntityMovementType.MOVE_VTOL_WALK)</span>
                || (movementType == EntityMovementType.MOVE_VTOL_RUN))
                &amp;&amp; (prev.movementType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L2521">            movementType = EntityMovementType.MOVE_VTOL_SPRINT;</span>
        }
        
<span class="nc bnc" id="L2524" title="All 4 branches missed.">        if (entity.isGyroDestroyed() &amp;&amp; !((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L2525" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER))) {</span>
            //A prone 'Mech with a destroyed gyro can only change a single hex side, or eject
<span class="nc bnc" id="L2527" title="All 2 branches missed.">            if (entity.isProne()) {</span>
<span class="nc bnc" id="L2528" title="All 4 branches missed.">                if (((stepType != MoveStepType.TURN_LEFT &amp;&amp; stepType != MoveStepType.TURN_RIGHT)</span>
<span class="nc bnc" id="L2529" title="All 4 branches missed.">                        || getMpUsed() &gt; 1) &amp;&amp; stepType != MoveStepType.EJECT) {</span>
<span class="nc" id="L2530">                    movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                }
            } else {
                //Normally a 'Mech falls immediately when the gyro is destroyed and can't stand again.
                //QuadVees using vehicle mode and 'Mechs using tracks do not fall and can continue to
                //stand, but cannot use non-tracked/wheeled MP except for a QuadVee converting back to
                //vehicle mode. This also covers a 'Mech that started with a destroyed gyro but was not
                //set to deploy prone. Perhaps that should not be allowed.
<span class="nc bnc" id="L2538" title="All 2 branches missed.">                if (getMp() &gt; 0) {</span>
<span class="nc bnc" id="L2539" title="All 2 branches missed.">                    boolean isTracked = entity.getMovementMode() == EntityMovementMode.TRACKED</span>
<span class="nc bnc" id="L2540" title="All 2 branches missed.">                            || entity.getMovementMode() == EntityMovementMode.WHEELED;</span>
<span class="nc bnc" id="L2541" title="All 2 branches missed.">                    if (entity instanceof QuadVee) {</span>
                        //We are in 'Mech/non-tracked mode if the end mode is vee and we are converting
                        //of the end mode is 'Mech and we are not converting.
<span class="nc bnc" id="L2544" title="All 4 branches missed.">                        if (isTracked == entity.isConvertingNow() &amp;&amp; stepType != MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L2545">                            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                        }
<span class="nc bnc" id="L2547" title="All 2 branches missed.">                    } else if (!isTracked) {</span>
                        //Non QuadVee tracked 'Mechs don't actually convert. They just go, so we only need to
                        //know the end mode.
<span class="nc" id="L2550">                        movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                    }
                }
            }
        }                

        // Mechs with no arms and a missing leg cannot attempt to stand
<span class="nc bnc" id="L2557" title="All 6 branches missed.">        if (((stepType == MoveStepType.GET_UP) ||</span>
                (stepType == MoveStepType.CAREFUL_STAND)) &amp;&amp;
                (entity instanceof Mech) &amp;&amp;
<span class="nc bnc" id="L2560" title="All 2 branches missed.">                entity.isLocationBad(Mech.LOC_LARM) &amp;&amp;</span>
<span class="nc bnc" id="L2561" title="All 2 branches missed.">                entity.isLocationBad(Mech.LOC_RARM) &amp;&amp;</span>
<span class="nc bnc" id="L2562" title="All 2 branches missed.">                (entity.isLocationBad(Mech.LOC_RLEG) ||</span>
<span class="nc bnc" id="L2563" title="All 2 branches missed.">                        entity.isLocationBad(Mech.LOC_LLEG))) {</span>
<span class="nc" id="L2564">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2565">            return;</span>
        }

        // Mechs with 1 MP are allowed to get up, except
        // if they've used that 1MP up already
<span class="nc bnc" id="L2570" title="All 6 branches missed.">        if ((MoveStepType.GET_UP == stepType) &amp;&amp; (1 == cachedEntityState.getRunMP())</span>
<span class="nc bnc" id="L2571" title="All 2 branches missed.">                &amp;&amp; (entity.mpUsed &lt; 1) &amp;&amp; !entity.isStuck()) {</span>
<span class="nc" id="L2572">            movementType = EntityMovementType.MOVE_RUN;</span>
        }

<span class="nc bnc" id="L2575" title="All 4 branches missed.">        if ((MoveStepType.CAREFUL_STAND == stepType) &amp;&amp; (entity.mpUsed &gt; 1)) {</span>
<span class="nc" id="L2576">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

<span class="nc bnc" id="L2579" title="All 6 branches missed.">        if (isFirstStep()</span>
                &amp;&amp; ((stepType == MoveStepType.TAKEOFF) || (stepType == MoveStepType.VTAKEOFF))) {
<span class="nc" id="L2581">            movementType = EntityMovementType.MOVE_SAFE_THRUST;</span>
        } else

            // VTOLs with a damaged flight stabiliser can't flank
<span class="nc bnc" id="L2585" title="All 6 branches missed.">            if ((entity instanceof VTOL)</span>
                    &amp;&amp; (movementType == EntityMovementType.MOVE_VTOL_RUN
                        || movementType == EntityMovementType.MOVE_VTOL_SPRINT)
<span class="nc bnc" id="L2588" title="All 2 branches missed.">                    &amp;&amp; ((VTOL) entity).isStabiliserHit(VTOL.LOC_ROTOR)) {</span>
<span class="nc" id="L2589">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }

        // check for UMU infantry on land
<span class="nc bnc" id="L2593" title="All 2 branches missed.">        if ((entity.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc" id="L2594">                &amp;&amp; !game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2595" title="All 4 branches missed.">                .containsTerrain(Terrains.WATER)</span>
                &amp;&amp; (movementType == EntityMovementType.MOVE_RUN)) {
<span class="nc" id="L2597">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // amnesty for the first step
<span class="nc bnc" id="L2601" title="All 4 branches missed.">        if (isFirstStep() &amp;&amp; (movementType == EntityMovementType.MOVE_ILLEGAL)</span>
<span class="nc bnc" id="L2602" title="All 4 branches missed.">                &amp;&amp; (cachedEntityState.getWalkMP() &gt; 0) &amp;&amp; !entity.isProne()</span>
<span class="nc bnc" id="L2603" title="All 4 branches missed.">                &amp;&amp; !entity.isHullDown() &amp;&amp; !entity.isStuck()</span>
<span class="nc bnc" id="L2604" title="All 4 branches missed.">                &amp;&amp; !entity.isGyroDestroyed() &amp;&amp; (stepType == MoveStepType.FORWARDS)) {</span>
<span class="nc" id="L2605">            movementType = EntityMovementType.MOVE_RUN;</span>
        }
        
        // Bimodal LAMs cannot spend MP when converting to fighter mode on the ground.
<span class="nc bnc" id="L2609" title="All 2 branches missed.">        if (entity instanceof LandAirMech</span>
<span class="nc bnc" id="L2610" title="All 2 branches missed.">                &amp;&amp; ((LandAirMech)entity).getLAMType() == LandAirMech.LAM_BIMODAL</span>
<span class="nc bnc" id="L2611" title="All 8 branches missed.">                &amp;&amp; entity.getConversionMode() == LandAirMech.CONV_MODE_MECH</span>
                &amp;&amp; movementMode == EntityMovementMode.AERODYNE
                &amp;&amp; altitude == 0
                &amp;&amp; mp &gt; 0) {
<span class="nc" id="L2615">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // Is the entity unloading passengers?
<span class="nc bnc" id="L2619" title="All 2 branches missed.">        if (stepType == MoveStepType.UNLOAD) {</span>

<span class="nc bnc" id="L2621" title="All 2 branches missed.">            if (entity instanceof Aero) {</span>
<span class="nc" id="L2622">                movementType = EntityMovementType.MOVE_NONE;</span>
            } else {

<span class="nc bnc" id="L2625" title="All 2 branches missed.">                if (isFirstStep()) {</span>
<span class="nc bnc" id="L2626" title="All 2 branches missed.">                    if (getMpUsed() &lt;= cachedEntityState.getRunMP()) {</span>
<span class="nc" id="L2627">                        movementType = EntityMovementType.MOVE_RUN;</span>
<span class="nc bnc" id="L2628" title="All 2 branches missed.">                        if (getMpUsed() &lt;= cachedEntityState.getWalkMP()) {</span>
<span class="nc" id="L2629">                            movementType = EntityMovementType.MOVE_WALK;</span>
                        }
                    }
                } else {
<span class="nc" id="L2633">                    movementType = prev.getMovementType(false);</span>
                }

                // Prone Meks are able to unload, if they have the MP.
<span class="nc bnc" id="L2637" title="All 2 branches missed.">                if ((getMpUsed() &lt;= cachedEntityState.getRunMP())</span>
<span class="nc bnc" id="L2638" title="All 6 branches missed.">                        &amp;&amp; (entity.isProne() || entity.isHullDown())</span>
                        &amp;&amp; (movementType == EntityMovementType.MOVE_ILLEGAL)) {
<span class="nc" id="L2640">                    movementType = EntityMovementType.MOVE_RUN;</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">                    if (getMpUsed() &lt;= cachedEntityState.getWalkMP()) {</span>
<span class="nc" id="L2642">                        movementType = EntityMovementType.MOVE_WALK;</span>
                    }
                }

                // Can't unload units into prohibited terrain
                // or into stacking violation.
<span class="nc" id="L2648">                Targetable target = getTarget(game);</span>
<span class="nc bnc" id="L2649" title="All 2 branches missed.">                if (target instanceof Entity) {</span>
                    //Change the destination hex if an unload dialog box set it elsewhere
<span class="nc bnc" id="L2651" title="All 2 branches missed.">                    if (getTargetPosition() != null) {</span>
<span class="nc" id="L2652">                        curPos = getTargetPosition();</span>
                    }
<span class="nc" id="L2654">                    Entity other = (Entity) target;</span>
<span class="nc bnc" id="L2655" title="All 2 branches missed.">                    if ((null != Compute.stackingViolation(game, other, curPos,</span>
<span class="nc bnc" id="L2656" title="All 2 branches missed.">                            entity)) || other.isLocationProhibited(curPos, getElevation())) {</span>
<span class="nc" id="L2657">                        movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                    }
<span class="nc" id="L2659">                } else {</span>
<span class="nc" id="L2660">                    movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                }
            }
        }
        
        // Is the entity trying to drop a trailer?
<span class="nc bnc" id="L2666" title="All 2 branches missed.">        if (stepType == MoveStepType.DISCONNECT) {</span>
            
            // If this isn't the first step, trailer position isn't updated by Server.processTrailerMovement()
            // before this step, so they don't drop off in the right place
<span class="nc bnc" id="L2670" title="All 2 branches missed.">            if (!isFirstStep()) {</span>
<span class="nc" id="L2671">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            } else {
<span class="nc" id="L2673">                movementType = EntityMovementType.MOVE_WALK;</span>
            }

            // Can't unload units into prohibited terrain
            // or into stacking violation.
<span class="nc" id="L2678">            Targetable target = getTarget(game);</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">            if (target instanceof Entity) {</span>
<span class="nc" id="L2680">                Entity other = (Entity) target;</span>
<span class="nc bnc" id="L2681" title="All 2 branches missed.">                if ((null != Compute.stackingViolation(game, other, curPos,</span>
<span class="nc bnc" id="L2682" title="All 2 branches missed.">                        entity)) || other.isLocationProhibited(curPos, getElevation())) {</span>
<span class="nc" id="L2683">                    movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                }
<span class="nc" id="L2685">            } else {</span>
<span class="nc" id="L2686">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
        
        }

<span class="nc bnc" id="L2691" title="All 2 branches missed.">        if (stepType == MoveStepType.SHAKE_OFF_SWARMERS) {</span>
<span class="nc bnc" id="L2692" title="All 4 branches missed.">            if ((getMp() == 0) || !(entity instanceof Tank)) {</span>
                // Can't shake off swarmers if you can't flank
<span class="nc" id="L2694">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            } else {
                // And its always considered to be flank movement
<span class="nc bnc" id="L2697" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2698">                    movementType = EntityMovementType.MOVE_VTOL_RUN;</span>
                } else {
<span class="nc" id="L2700">                    movementType = EntityMovementType.MOVE_RUN;</span>
                }
            }
        }

        // Can't run or jump if unjamming a RAC.
<span class="nc bnc" id="L2706" title="All 10 branches missed.">        if (isUnjammingRAC</span>
                &amp;&amp; ((movementType == EntityMovementType.MOVE_RUN)
                || (movementType == EntityMovementType.MOVE_SPRINT)
                || (movementType == EntityMovementType.MOVE_VTOL_RUN
                || (movementType == EntityMovementType.MOVE_VTOL_SPRINT)) 
<span class="nc bnc" id="L2711" title="All 2 branches missed.">                || isJumping())) {</span>
<span class="nc" id="L2712">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // only standing mechs may go prone
<span class="nc bnc" id="L2716" title="All 2 branches missed.">        if ((stepType == MoveStepType.GO_PRONE)</span>
<span class="nc bnc" id="L2717" title="All 6 branches missed.">                &amp;&amp; (isProne() || !(entity instanceof Mech) || entity.isStuck())) {</span>
<span class="nc" id="L2718">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // Standing mechs and vehicles in fortified terrain can hull-down
<span class="nc bnc" id="L2722" title="All 2 branches missed.">        if (stepType == MoveStepType.HULL_DOWN) {</span>
<span class="nc bnc" id="L2723" title="All 6 branches missed.">            if ((isHullDown()</span>
                    || !((entity instanceof Mech) || (entity instanceof Tank)) || entity
<span class="nc bnc" id="L2725" title="All 2 branches missed.">                    .isStuck())) {</span>
<span class="nc" id="L2726">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
<span class="nc bnc" id="L2728" title="All 4 branches missed.">            if (entity instanceof Tank</span>
                    || (entity instanceof QuadVee
<span class="nc bnc" id="L2730" title="All 2 branches missed.">                            &amp;&amp; ((entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</span>
<span class="nc bnc" id="L2731" title="All 2 branches missed.">                                    != entity.isConvertingNow()))) {</span>
                //Tanks and QuadVees ending movement in vehicle mode require a fortified hex.
<span class="nc" id="L2733">                if (!(game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2734" title="All 2 branches missed.">                        .containsTerrain(Terrains.FORTIFIED))) {</span>
<span class="nc" id="L2735">                    movementType = EntityMovementType.MOVE_ILLEGAL;</span>
                }
<span class="nc bnc" id="L2737" title="All 2 branches missed.">            } else if (entity.isGyroDestroyed()) {</span>
                // Mechs need to check for valid Gyros
<span class="nc" id="L2739">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
        }

        // initially prone mechs can't charge
<span class="nc bnc" id="L2744" title="All 4 branches missed.">        if (((stepType == MoveStepType.CHARGE) || (stepType == MoveStepType.DFA))</span>
<span class="nc bnc" id="L2745" title="All 2 branches missed.">                &amp;&amp; entity.isProne()) {</span>
<span class="nc" id="L2746">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // do not allow to move onto a bridge if there's no exit in lastPos's
        // direction, unless jumping
<span class="nc bnc" id="L2751" title="All 2 branches missed.">        if (!isFirstStep()</span>
<span class="nc bnc" id="L2752" title="All 4 branches missed.">                &amp;&amp; !curPos.equals(lastPos)</span>
                &amp;&amp; climbMode
<span class="nc bnc" id="L2754" title="All 2 branches missed.">                &amp;&amp; entity.getMovementMode() != EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L2755" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L2756" title="All 4 branches missed.">                    || getClearance() == 0)</span>
                &amp;&amp; (movementType != EntityMovementType.MOVE_JUMP)
<span class="nc" id="L2758">                &amp;&amp; game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2759" title="All 2 branches missed.">                .containsTerrain(Terrains.BRIDGE)</span>
<span class="nc" id="L2760">                &amp;&amp; !game.getBoard()</span>
<span class="nc" id="L2761">                .getHex(curPos)</span>
<span class="nc bnc" id="L2762" title="All 2 branches missed.">                .containsTerrainExit(Terrains.BRIDGE,</span>
<span class="nc" id="L2763">                        curPos.direction(lastPos))</span>
<span class="nc" id="L2764">                &amp;&amp; (getElevation() + entity.getHeight()</span>
<span class="nc bnc" id="L2765" title="All 2 branches missed.">                        &gt;= game.getBoard().getHex(curPos).terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L2766">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // super heavy mechs can't climb on buildings
<span class="nc bnc" id="L2770" title="All 2 branches missed.">        if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L2771" title="All 4 branches missed.">                &amp;&amp; ((Mech) entity).isSuperHeavy()</span>
                &amp;&amp; climbMode
<span class="nc" id="L2773">                &amp;&amp; game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L2774" title="All 2 branches missed.">                .containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L2775">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // TO p.325 - Mine dispensers
<span class="nc bnc" id="L2779" title="All 4 branches missed.">        if ((type == MoveStepType.LAY_MINE) &amp;&amp; !entity.canLayMine()) {</span>
<span class="nc" id="L2780">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2781">            return;</span>
        }
        
<span class="nc bnc" id="L2784" title="All 4 branches missed.">        if ((type == MoveStepType.LAY_MINE) &amp;&amp; entity.canLayMine()) {</span>
            //All units may only lay mines on its first or last step.
            //BA additionally have to use Jump or VTOL movement.
<span class="nc" id="L2787">            movementType = prev.movementType;</span>

<span class="nc bnc" id="L2789" title="All 2 branches missed.">            if (entity instanceof BattleArmor &amp;&amp;</span>
<span class="nc bnc" id="L2790" title="All 8 branches missed.">                    !(isFirstStep()</span>
                            || (prev.movementType == EntityMovementType.MOVE_JUMP)
                            || (prev.movementType == EntityMovementType.MOVE_VTOL_RUN)
                            || (prev.movementType == EntityMovementType.MOVE_VTOL_WALK))) {
<span class="nc" id="L2794">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            }
        }
<span class="nc bnc" id="L2797" title="All 4 branches missed.">        if (prev.type == MoveStepType.LAY_MINE &amp;&amp; !prev.isFirstStep()) {</span>
<span class="nc" id="L2798">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2799">            return;</span>
        }


<span class="nc bnc" id="L2803" title="All 2 branches missed.">        if (stepType == MoveStepType.MOUNT) {</span>
<span class="nc" id="L2804">            movementType = EntityMovementType.MOVE_WALK;</span>
        }
        
<span class="nc bnc" id="L2807" title="All 2 branches missed.">        if (stepType == MoveStepType.BOOTLEGGER) {</span>
            // Bootlegger requires three hexes straight and is illegal for tracked, WiGE, or naval.
<span class="nc bnc" id="L2809" title="All 2 branches missed.">            if (prev.nStraight &lt; 3</span>
<span class="nc bnc" id="L2810" title="All 2 branches missed.">                    || (entity.getMovementMode() != EntityMovementMode.WHEELED</span>
<span class="nc bnc" id="L2811" title="All 2 branches missed.">                    &amp;&amp; entity.getMovementMode() != EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L2812" title="All 2 branches missed.">                    &amp;&amp; entity.getMovementMode() != EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L2813">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
            } else {
<span class="nc" id="L2815">                danger = true;</span>
            }            
        }

        // check if this movement is illegal for reasons other than points
<span class="nc bnc" id="L2820" title="All 4 branches missed.">        if (!isMovementPossible(game, lastPos, prev.getElevation(), cachedEntityState)</span>
                || isUnloaded) {
<span class="nc" id="L2822">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // If the previous step is always illegal, then so is this one
<span class="nc bnc" id="L2826" title="All 2 branches missed.">        if (EntityMovementType.MOVE_ILLEGAL == prev.movementType) {</span>
<span class="nc" id="L2827">            movementType = EntityMovementType.MOVE_ILLEGAL;</span>
        }

        // Don't compute danger if the step is illegal.
<span class="nc bnc" id="L2831" title="All 2 branches missed.">        if (movementType == EntityMovementType.MOVE_ILLEGAL) {</span>
<span class="nc" id="L2832">            return;</span>
        }
        
        // Danger is flagged for PSR checks by entire path when a new step is added, since turning
        // while running on pavement does cannot trigger the danger flag if the turn occurs before
        // enough MP are spent to require running.

        // getting up is also danger
<span class="nc bnc" id="L2840" title="All 2 branches missed.">        if (stepType == MoveStepType.GET_UP) {</span>
<span class="nc" id="L2841">            danger = true;</span>
        }

        // set past danger
<span class="nc" id="L2845">        pastDanger |= danger;</span>

        // Record if we're turning *after* check for danger,
        // because the danger lies in moving *after* turn.
<span class="nc bnc" id="L2849" title="All 3 branches missed.">        switch (stepType) {</span>
            case TURN_LEFT:
            case TURN_RIGHT:
<span class="nc" id="L2852">                setTurning(true);</span>
<span class="nc" id="L2853">                break;</span>
            case UNLOAD:
            case DISCONNECT:
                // Unloading must be the last step.
<span class="nc" id="L2857">                setUnloaded(true);</span>
<span class="nc" id="L2858">                break;</span>
            default:
<span class="nc" id="L2860">                setTurning(false);</span>
                break;
        }

        // update prone state
<span class="nc bnc" id="L2865" title="All 2 branches missed.">        if (stepType == MoveStepType.GO_PRONE) {</span>
<span class="nc" id="L2866">            setProne(true);</span>
<span class="nc" id="L2867">            setHullDown(false);</span>
<span class="nc bnc" id="L2868" title="All 2 branches missed.">        } else if (stepType == MoveStepType.GET_UP) {</span>
<span class="nc" id="L2869">            setProne(false);</span>
<span class="nc" id="L2870">            setHullDown(false);</span>
<span class="nc bnc" id="L2871" title="All 2 branches missed.">        } else if (stepType == MoveStepType.HULL_DOWN) {</span>
<span class="nc" id="L2872">            setProne(false);</span>
<span class="nc" id="L2873">            setHullDown(true);</span>
        }

<span class="nc bnc" id="L2876" title="All 2 branches missed.">        if (entity.isCarefulStand()) {</span>
<span class="nc" id="L2877">            movementType = EntityMovementType.MOVE_CAREFUL_STAND;</span>
        }

        // only walking speed in Tornados
<span class="nc bnc" id="L2881" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_TORNADO_F4) {</span>
<span class="nc bnc" id="L2882" title="All 2 branches missed.">            if (getMpUsed() &gt; tmpWalkMP) {</span>
<span class="nc" id="L2883">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2884">                return;</span>
            }
        }
        
        // Vehicles carrying mechanized BA can't jump, VTOL, or WiGE
<span class="nc bnc" id="L2889" title="All 2 branches missed.">        if (entity instanceof Tank</span>
<span class="nc bnc" id="L2890" title="All 2 branches missed.">                &amp;&amp; entity.getExternalUnits().size() &gt; 0) {</span>
<span class="nc bnc" id="L2891" title="All 8 branches missed.">            if ((movementType == EntityMovementType.MOVE_JUMP)</span>
                    || (movementType == EntityMovementType.MOVE_VTOL_WALK)
                    || (movementType == EntityMovementType.MOVE_VTOL_RUN)
                    || (movementType == EntityMovementType.MOVE_VTOL_SPRINT)
<span class="nc bnc" id="L2895" title="All 2 branches missed.">                    || ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L2896" title="All 2 branches missed.">                        &amp;&amp; getClearance() &gt; 0)) {</span>
<span class="nc" id="L2897">                movementType = EntityMovementType.MOVE_ILLEGAL;</span>
<span class="nc" id="L2898">                return;</span>
            }            
        }
<span class="nc" id="L2901">    }</span>

    public int getTotalHeat() {
<span class="nc" id="L2904">        return totalHeat;</span>
    }

    public int getHeat() {
<span class="nc" id="L2908">        return heat;</span>
    }

    /**
     * Amount of movement points required to move from start to dest
     */
    protected void calcMovementCostFor(IGame game, MoveStep prevStep, CachedEntityState cachedEntityState) {
<span class="nc" id="L2915">        final Coords prev = prevStep.getPosition();</span>
<span class="nc" id="L2916">        final int prevEl = prevStep.getElevation();</span>
<span class="nc" id="L2917">        final EntityMovementMode moveMode = getEntity()</span>
<span class="nc" id="L2918">                .getMovementMode();</span>
<span class="nc" id="L2919">        final IHex srcHex = game.getBoard().getHex(prev);</span>
<span class="nc" id="L2920">        final IHex destHex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L2921">        final boolean isInfantry = getEntity() instanceof Infantry;</span>
<span class="nc bnc" id="L2922" title="All 2 branches missed.">        final boolean isSuperHeavyMech = (getEntity() instanceof Mech)</span>
<span class="nc bnc" id="L2923" title="All 2 branches missed.">                &amp;&amp; ((Mech) getEntity()).isSuperHeavy();</span>
<span class="nc bnc" id="L2924" title="All 2 branches missed.">        final boolean isMechanizedInfantry = isInfantry</span>
<span class="nc bnc" id="L2925" title="All 2 branches missed.">                &amp;&amp; ((Infantry) getEntity()).isMechanized();</span>
<span class="nc" id="L2926">        final boolean isProto = getEntity() instanceof Protomech;</span>
<span class="nc" id="L2927">        final boolean isMech = getEntity() instanceof Mech;</span>
<span class="nc bnc" id="L2928" title="All 2 branches missed.">        final boolean isAmphibious = cachedEntityState.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS) || </span>
<span class="nc bnc" id="L2929" title="All 2 branches missed.">                cachedEntityState.hasWorkingMisc(MiscType.F_LIMITED_AMPHIBIOUS);</span>
<span class="nc" id="L2930">        int nSrcEl = srcHex.getLevel() + prevEl;</span>
<span class="nc" id="L2931">        int nDestEl = destHex.getLevel() + elevation;</span>

<span class="nc" id="L2933">        mp = 1;</span>


        // 0 MP infantry units can move 1 hex
<span class="nc bnc" id="L2937" title="All 2 branches missed.">        if (isInfantry</span>
<span class="nc bnc" id="L2938" title="All 4 branches missed.">                &amp;&amp; (cachedEntityState.getWalkMP() == 0)</span>
                &amp;&amp; (moveMode != EntityMovementMode.SUBMARINE)
<span class="nc bnc" id="L2940" title="All 2 branches missed.">                &amp;&amp; getEntity().getPosition().equals(prev)</span>
<span class="nc bnc" id="L2941" title="All 2 branches missed.">                &amp;&amp; (getEntity().getPosition().distance(getPosition()) == 1)</span>
<span class="nc bnc" id="L2942" title="All 2 branches missed.">                &amp;&amp; (!isJumping())) {</span>
<span class="nc" id="L2943">            mp = 0;</span>
<span class="nc" id="L2944">            return;</span>
        }


<span class="nc" id="L2948">        boolean applyNightPen =</span>
<span class="nc bnc" id="L2949" title="All 2 branches missed.">                !game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_NIGHT_MOVE_PEN);</span>
<span class="nc bnc" id="L2950" title="All 2 branches missed.">        boolean carefulExempt =</span>
<span class="nc bnc" id="L2951" title="All 2 branches missed.">                (moveMode == EntityMovementMode.VTOL) || isJumping();</span>

        // Apply careful movement MP penalties for fog and light (TO pg 63)
<span class="nc bnc" id="L2954" title="All 8 branches missed.">        if (!game.getBoard().inSpace() &amp;&amp; isCareful() &amp;&amp; applyNightPen</span>
                &amp;&amp; !carefulExempt) {
            // Fog
<span class="nc bnc" id="L2957" title="All 3 branches missed.">            switch (game.getPlanetaryConditions().getFog()) {</span>
                case PlanetaryConditions.FOG_LIGHT:
<span class="nc" id="L2959">                    mp += 1;</span>
<span class="nc" id="L2960">                    break;</span>
                case PlanetaryConditions.FOG_HEAVY:
<span class="nc" id="L2962">                    mp += 2;</span>
                    break;
            }
            // Light
<span class="nc bnc" id="L2966" title="All 4 branches missed.">            switch (game.getPlanetaryConditions().getLight()){</span>
                case PlanetaryConditions.L_FULL_MOON:
<span class="nc" id="L2968">                    mp += 1;</span>
<span class="nc" id="L2969">                    break;</span>
                case  PlanetaryConditions.L_MOONLESS:
<span class="nc" id="L2971">                    mp += 2;</span>
<span class="nc" id="L2972">                    break;</span>
                case PlanetaryConditions.L_PITCH_BLACK:
<span class="nc" id="L2974">                    mp += 3;</span>
                    break;
            }
        }


        // VTOLs pay 1 for everything
<span class="nc bnc" id="L2981" title="All 2 branches missed.">        if (moveMode == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2982">            return;</span>
        }

        // jumping always costs 1, unless fog or poor light
<span class="nc bnc" id="L2986" title="All 2 branches missed.">        if (isJumping()) {</span>
<span class="nc" id="L2987">            return;</span>
        }

        // Account for terrain, unless we're moving along a road.
<span class="nc bnc" id="L2991" title="All 2 branches missed.">        if (!isPavementStep()) {</span>

<span class="nc bnc" id="L2993" title="All 4 branches missed.">            if ((moveMode != EntityMovementMode.BIPED_SWIM)</span>
                    &amp;&amp; (moveMode != EntityMovementMode.QUAD_SWIM)
<span class="nc bnc" id="L2995" title="All 2 branches missed.">                    &amp;&amp; getClearance() == 0) {</span>
<span class="nc" id="L2996">                mp += destHex.movementCost(getEntity());</span>
            }

            // if this is an amphibious unit crossing water, increment movement cost by 1
<span class="nc bnc" id="L3000" title="All 6 branches missed.">            if(isAmphibious &amp;&amp; !destHex.containsTerrain(Terrains.ICE) &amp;&amp; (destHex.terrainLevel(Terrains.WATER) &gt; 0)) {</span>
<span class="nc" id="L3001">                mp++;</span>
            }
            
            // non-hovers, non-navals and non-VTOLs check for water depth and
            // are affected by swamp
<span class="nc bnc" id="L3006" title="All 18 branches missed.">            if ((moveMode != EntityMovementMode.HOVER)</span>
                    &amp;&amp; (moveMode != EntityMovementMode.NAVAL)
                    &amp;&amp; (moveMode != EntityMovementMode.HYDROFOIL)
                    &amp;&amp; (moveMode != EntityMovementMode.SUBMARINE)
                    &amp;&amp; (moveMode != EntityMovementMode.INF_UMU)
                    &amp;&amp; (moveMode != EntityMovementMode.VTOL)
                    &amp;&amp; (moveMode != EntityMovementMode.BIPED_SWIM)
                    &amp;&amp; (moveMode != EntityMovementMode.QUAD_SWIM)
                    &amp;&amp; (moveMode != EntityMovementMode.WIGE)) {
                // no additional cost when moving on surface of ice.
<span class="nc bnc" id="L3016" title="All 2 branches missed.">                if (!destHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L3017" title="All 2 branches missed.">                        || (nDestEl &lt; destHex.surface())) {</span>
<span class="nc bnc" id="L3018" title="All 4 branches missed.">                    if ((destHex.terrainLevel(Terrains.WATER) == 1) &amp;&amp; !isAmphibious) {</span>
<span class="nc" id="L3019">                        mp++;</span>
<span class="nc bnc" id="L3020" title="All 4 branches missed.">                    } else if ((destHex.terrainLevel(Terrains.WATER) &gt; 1) &amp;&amp; !isAmphibious) {</span>
<span class="nc bnc" id="L3021" title="All 6 branches missed.">                        if (getEntity().hasAbility(OptionsConstants.PILOT_TM_FROGMAN)</span>
                                &amp;&amp; ((entity instanceof Mech) || (entity instanceof Protomech))) {
<span class="nc" id="L3023">                            mp += 2;</span>
                        } else {
<span class="nc" id="L3025">                            mp += 3;</span>
                        }
                    }
                }
                // if using non-careful movement on ice then reduce cost
<span class="nc bnc" id="L3030" title="All 2 branches missed.">                if (destHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L3031" title="All 2 branches missed.">                        &amp;&amp; !isCareful()</span>
<span class="nc bnc" id="L3032" title="All 2 branches missed.">                        &amp;&amp; (nDestEl == destHex.surface())) {</span>
<span class="nc" id="L3033">                    mp--;</span>
                }

            }
        } // End not-along-road

        // non-WIGEs pay for elevation differences
<span class="nc bnc" id="L3040" title="All 4 branches missed.">        if ((nSrcEl != nDestEl) &amp;&amp; (moveMode != EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L3041">            int delta_e = Math.abs(nSrcEl - nDestEl);</span>
<span class="nc bnc" id="L3042" title="All 8 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_LEAPING) &amp;&amp; isMech</span>
                    &amp;&amp; (delta_e &gt; 2) &amp;&amp; (nDestEl &lt; nSrcEl)) {
                // leaping (moving down more than 2 hexes) always costs 4 mp
                // regardless of anything else
<span class="nc" id="L3046">                mp = 4;</span>
<span class="nc" id="L3047">                return;</span>
            }
            // non-flying Infantry and ground vehicles are charged double.
<span class="nc bnc" id="L3050" title="All 2 branches missed.">            if ((isInfantry</span>
<span class="nc bnc" id="L3051" title="All 2 branches missed.">                    &amp;&amp; !((getMovementType(false) == EntityMovementType.MOVE_VTOL_WALK)</span>
<span class="nc bnc" id="L3052" title="All 8 branches missed.">                            || (getMovementType(false) == EntityMovementType.MOVE_VTOL_RUN)))</span>
                    || ((moveMode == EntityMovementMode.TRACKED)
                            || (moveMode == EntityMovementMode.WHEELED)
                            || (moveMode == EntityMovementMode.HOVER))) {
<span class="nc" id="L3056">                delta_e *= 2;</span>
            }
<span class="nc bnc" id="L3058" title="All 2 branches missed.">            if (entity.hasAbility(OptionsConstants.PILOT_TM_MOUNTAINEER)) {</span>
<span class="nc" id="L3059">                mp += delta_e - 1;</span>
            } else {
<span class="nc" id="L3061">                mp += delta_e;</span>
            }
        }

        // WiGEs in climb mode pay 2 extra MP to stay at the same flight level
        // if more than one elevation above the underlying terrain.
        // If the destination contains a building, the WiGE must pay the extra MP if flying
        // more than one elevation above its top or if climbing a level to get above it.
        // See http://bg.battletech.com/forums/index.php?topic=51081.msg1297747#msg1297747
<span class="nc bnc" id="L3070" title="All 6 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; distance &gt; 0 &amp;&amp; (getClearance() &gt; 1</span>
<span class="nc bnc" id="L3071" title="All 2 branches missed.">                || (destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L3072" title="All 2 branches missed.">                        &amp;&amp; destHex.ceiling() &gt; srcHex.ceiling()))) {</span>
<span class="nc" id="L3073">            mp += 2;</span>
        }
        
        // WIGEs spend one extra MP to ascend a sheer cliff, TO p.39
<span class="nc bnc" id="L3077" title="All 4 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WIGE </span>
                &amp;&amp; distance &gt; 0 
<span class="nc bnc" id="L3079" title="All 4 branches missed.">                &amp;&amp; destHex.hasCliffTopTowards(srcHex)</span>
                &amp;&amp; nDestEl &gt; nSrcEl) {
<span class="nc" id="L3081">            mp += 1;</span>
        }

        // If we entering a building, all non-infantry pay additional MP.
<span class="nc bnc" id="L3085" title="All 2 branches missed.">        if (nDestEl &lt; destHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L3086">            Building bldg = game.getBoard().getBuildingAt(getPosition());</span>
            // check for inside hangar movement
<span class="nc bnc" id="L3088" title="All 4 branches missed.">            if ((null != prev)</span>
                    &amp;&amp; (null != bldg)
<span class="nc bnc" id="L3090" title="All 2 branches missed.">                    &amp;&amp; bldg.isIn(prev)</span>
<span class="nc bnc" id="L3091" title="All 2 branches missed.">                    &amp;&amp; (bldg.getBldgClass() == Building.HANGAR)</span>
<span class="nc" id="L3092">                    &amp;&amp; (destHex.terrainLevel(Terrains.BLDG_ELEV) &gt; getEntity()</span>
<span class="nc bnc" id="L3093" title="All 2 branches missed.">                            .height())) {</span>
<span class="nc" id="L3094">                mp += 0;</span>
<span class="nc bnc" id="L3095" title="All 4 branches missed.">            } else if (!isInfantry &amp;&amp; !isSuperHeavyMech) {</span>
<span class="nc bnc" id="L3096" title="All 2 branches missed.">                if (!isProto) {</span>
                    // non-protos pay extra according to the building type
<span class="nc" id="L3098">                    mp += bldg.getType();</span>
<span class="nc bnc" id="L3099" title="All 2 branches missed.">                    if (bldg.getBldgClass() == Building.HANGAR) {</span>
<span class="nc" id="L3100">                        mp--;</span>
                    }
<span class="nc bnc" id="L3102" title="All 2 branches missed.">                    if (bldg.getBldgClass() == Building.FORTRESS) {</span>
<span class="nc" id="L3103">                        mp++;</span>
                    }
                } else {
                    // protos pay one extra
<span class="nc" id="L3107">                    mp += 1;</span>
                }
<span class="nc bnc" id="L3109" title="All 2 branches missed.">            } else if (isMechanizedInfantry) {</span>
                // mechanized infantry pays 1 extra
<span class="nc" id="L3111">                mp += 1;</span>
            }
        }

        // Infantry (except mechanized) pay 1 less MP to enter woods
<span class="nc bnc" id="L3116" title="All 4 branches missed.">        if (isInfantry &amp;&amp; !isMechanizedInfantry</span>
<span class="nc bnc" id="L3117" title="All 4 branches missed.">                &amp;&amp; destHex.containsTerrain(Terrains.WOODS)</span>
                &amp;&amp; !isPavementStep) {
<span class="nc" id="L3119">            mp--;</span>

            // Ensures that Infantry always pay at least 1 mp when 
            // entering woods or jungle
<span class="nc bnc" id="L3123" title="All 2 branches missed.">            if (mp &lt;= 0) {</span>
<span class="nc" id="L3124">                mp = 1;</span>
            }
        }        
<span class="nc" id="L3127">    }</span>

    /**
     * Is movement possible from a previous position to this one?
     * &lt;p/&gt;
     * This function does not comment on whether an overall movement path is
     * possible, just whether the &lt;em&gt;current&lt;/em&gt; step is possible.
     */
    public boolean isMovementPossible(IGame game, Coords src, int srcEl, CachedEntityState cachedEntityState) {
<span class="nc" id="L3136">        final IHex srcHex = game.getBoard().getHex(src);</span>
<span class="nc" id="L3137">        final Coords dest = getPosition();</span>
<span class="nc" id="L3138">        final IHex destHex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L3139">        final Entity entity = getEntity();</span>

<span class="nc bnc" id="L3141" title="All 2 branches missed.">        if (null == dest) {</span>
<span class="nc" id="L3142">            throw getLogger().error(new IllegalStateException(&quot;Step has no position&quot;));</span>
        }
<span class="nc bnc" id="L3144" title="All 2 branches missed.">        if (src.distance(dest) &gt; 1) {</span>
<span class="nc" id="L3145">            StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L3146">            buf.append(&quot;Coordinates &quot;).append(src.toString()).append(&quot; and &quot;)</span>
<span class="nc" id="L3147">                    .append(dest.toString()).append(&quot; are not adjacent.&quot;);</span>
<span class="nc" id="L3148">            throw getLogger().error(new IllegalArgumentException(buf.toString()));</span>
        }

        // Assault dropping units cannot move
<span class="nc bnc" id="L3152" title="All 6 branches missed.">        if ((entity.isAssaultDropInProgress() || entity.isDropping())</span>
                &amp;&amp; !((entity instanceof LandAirMech)
<span class="nc bnc" id="L3154" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L3155" title="All 2 branches missed.">                &amp;&amp; (entity.getAltitude() &lt;= 3))) {</span>
<span class="nc" id="L3156">            return false;</span>
        }
        
        // If we're a tank and immobile, check if we try to unjam
        // or eject and the crew is not unconscious
<span class="nc bnc" id="L3161" title="All 2 branches missed.">        if ((entity instanceof Tank)</span>
<span class="nc bnc" id="L3162" title="All 8 branches missed.">                &amp;&amp; !entity.getCrew().isUnconscious()</span>
                &amp;&amp; ((type == MoveStepType.UNJAM_RAC)
                || (type == MoveStepType.EJECT) || (type == MoveStepType.SEARCHLIGHT))) {
<span class="nc" id="L3165">            return true;</span>
        }

        // We're wanting to startup our reactor and we're not unconscious
<span class="nc bnc" id="L3169" title="All 4 branches missed.">        if ((type == MoveStepType.STARTUP) &amp;&amp; !entity.getCrew().isUnconscious()) {</span>
<span class="nc" id="L3170">            return true;</span>
        }

        // We're wanting to self destruct our reactor and we're not unconscious
<span class="nc bnc" id="L3174" title="All 2 branches missed.">        if ((type == MoveStepType.SELF_DESTRUCT)</span>
<span class="nc bnc" id="L3175" title="All 2 branches missed.">                &amp;&amp; !entity.getCrew().isUnconscious()) {</span>
<span class="nc" id="L3176">            return true;</span>
        }

        // If you want to flee, and you can flee, flee.
<span class="nc bnc" id="L3180" title="All 2 branches missed.">        if ((type == MoveStepType.FLEE)</span>
<span class="nc bnc" id="L3181" title="All 2 branches missed.">                &amp;&amp; entity.canFlee()) {</span>
<span class="nc" id="L3182">            return true;</span>
        }

        // super-easy
<span class="nc bnc" id="L3186" title="All 2 branches missed.">        if (entity.isImmobile()) {</span>
            // System.err.println(&quot;illegal - immobile&quot;);
<span class="nc" id="L3188">            return false;</span>
        }

        // Hidden units, and activating hidden units cannot move 
        // unless it is the movement phase and the plan is to activate then
        // if we're in this method, we're implicitly in the movement phase
<span class="nc bnc" id="L3194" title="All 6 branches missed.">        if (entity.isHidden() || (entity.isHiddenActivating() &amp;&amp; (entity.hiddenActivationPhase != Phase.PHASE_MOVEMENT))) {</span>
<span class="nc" id="L3195">            return false;</span>
        }

        // another easy check
<span class="nc bnc" id="L3199" title="All 2 branches missed.">        if (!game.getBoard().contains(dest)) {</span>
            // System.err.println(&quot;board doesn't contain destination&quot;);
<span class="nc" id="L3201">            return false;</span>
        }

        // can't enter impassable hex
<span class="nc bnc" id="L3205" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.IMPASSABLE)) {</span>
            // System.err.println(&quot;can't enter impassable hex&quot;);

<span class="nc" id="L3208">            return false;</span>
        }

<span class="nc" id="L3211">        final int srcAlt = srcEl + srcHex.getLevel();</span>
<span class="nc" id="L3212">        final int destAlt = elevation + destHex.getLevel();</span>

<span class="nc" id="L3214">        Building bld = game.getBoard().getBuildingAt(dest);</span>

<span class="nc bnc" id="L3216" title="All 2 branches missed.">        if (bld != null) {</span>
            // protomechs that are jumping can't change the level inside a
            // building,
            // they can only jump onto a building or out of it
<span class="nc bnc" id="L3220" title="All 6 branches missed.">            if (src.equals(dest) &amp;&amp; (srcAlt != destAlt)</span>
                    &amp;&amp; (entity instanceof Protomech)
<span class="nc bnc" id="L3222" title="All 2 branches missed.">                    &amp;&amp; (getMovementType(false) == EntityMovementType.MOVE_JUMP)) {</span>
                // System.err
                // .println(&quot;no jumping inside buildings to change levels&quot;);
<span class="nc" id="L3225">                return false;</span>
            }
<span class="nc" id="L3227">            IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L3228">            int maxElevation = (2 + entity.getElevation() + game.getBoard()</span>
<span class="nc" id="L3229">                    .getHex(entity.getPosition()).surface())</span>
<span class="nc" id="L3230">                    - hex.surface();</span>

<span class="nc bnc" id="L3232" title="All 2 branches missed.">            if ((bld.getType() == Building.WALL)</span>
<span class="nc bnc" id="L3233" title="All 2 branches missed.">                    &amp;&amp; (maxElevation &lt; hex.terrainLevel(Terrains.BLDG_ELEV))) {</span>
                // System.err.println(&quot;soemthing about walls&quot;);
<span class="nc" id="L3235">                return false;</span>
            }

            // only infantry can enter an armored building
<span class="nc bnc" id="L3239" title="All 2 branches missed.">            if ((elevation &lt; hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L3240" title="All 4 branches missed.">                    &amp;&amp; (bld.getArmor(dest) &gt; 0)</span>
                    &amp;&amp; !(entity instanceof Infantry)) {
                // System.err.println(&quot;no entering armored buildings for non-inf&quot;);
<span class="nc" id="L3243">                return false;</span>
            }

            // only infantry can enter a gun emplacement
<span class="nc bnc" id="L3247" title="All 2 branches missed.">            if ((elevation &lt; hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L3248" title="All 4 branches missed.">                    &amp;&amp; (bld.getBldgClass() == Building.GUN_EMPLACEMENT)</span>
                    &amp;&amp; !(entity instanceof Infantry)) {
                // System.err.println(&quot;no entering gun-emplacements for non-inf&quot;);
<span class="nc" id="L3251">                return false;</span>
            }
        }

        // Can't back up across an elevation change.
<span class="nc bnc" id="L3256" title="All 2 branches missed.">        if (!(entity instanceof VTOL)</span>
<span class="nc bnc" id="L3257" title="All 2 branches missed.">                &amp;&amp; isThisStepBackwards()</span>
<span class="nc bnc" id="L3258" title="All 6 branches missed.">                &amp;&amp; !(isJumping() &amp;&amp; (entity.getJumpType() == Mech.JUMP_BOOSTER))</span>
<span class="nc bnc" id="L3259" title="All 2 branches missed.">                &amp;&amp; (((destAlt != srcAlt) &amp;&amp; !game.getOptions().booleanOption(</span>
<span class="nc" id="L3260">                OptionsConstants.ADVGRNDMOV_TACOPS_WALK_BACKWARDS)) || (game.getOptions()</span>
<span class="nc bnc" id="L3261" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_WALK_BACKWARDS) &amp;&amp; (Math</span>
<span class="nc bnc" id="L3262" title="All 2 branches missed.">                .abs(destAlt - srcAlt) &gt; 1)))) {</span>
            // System.err.println(&quot;Can't back up across an elevation change.&quot;);
<span class="nc" id="L3264">            return false;</span>
        }

        // Swarming entities can't move.
<span class="nc bnc" id="L3268" title="All 2 branches missed.">        if (Entity.NONE != entity.getSwarmTargetId()) {</span>
            // System.err.println(&quot;no moving for swarming infantry&quot;);
<span class="nc" id="L3270">            return false;</span>
        }

<span class="nc bnc" id="L3273" title="All 2 branches missed.">        if (type == MoveStepType.MOUNT) {</span>
<span class="nc" id="L3274">            return true;</span>
        }

        // The entity is trying to load. Check for a valid move.
<span class="nc bnc" id="L3278" title="All 2 branches missed.">        if (type == MoveStepType.LOAD) {</span>

            // Transports can't load after the first step.
<span class="nc bnc" id="L3281" title="All 2 branches missed.">            if (!firstStep) {</span>
<span class="nc" id="L3282">                return false;</span>
            }

            // Find the unit being loaded.
<span class="nc" id="L3286">            Entity other = null;</span>
<span class="nc" id="L3287">            Iterator&lt;Entity&gt; entities = game.getEntities(src);</span>
<span class="nc bnc" id="L3288" title="All 2 branches missed.">            while (entities.hasNext()) {</span>

                // Is the other unit friendly and not the current entity?
<span class="nc" id="L3291">                other = entities.next();</span>
<span class="nc bnc" id="L3292" title="All 2 branches missed.">                if (!entity.getOwner().isEnemyOf(other.getOwner())</span>
<span class="nc bnc" id="L3293" title="All 2 branches missed.">                        &amp;&amp; !entity.equals(other)) {</span>

                    // The moving unit should be able to load the other unit.
<span class="nc bnc" id="L3296" title="All 2 branches missed.">                    if (!entity.canLoad(other)) {</span>
<span class="nc" id="L3297">                        return false;</span>
                    }

                    // The other unit should be able to have a turn.
<span class="nc bnc" id="L3301" title="All 2 branches missed.">                    if (!other.isLoadableThisTurn()) {</span>
<span class="nc" id="L3302">                        return false;</span>
                    }

                    // We can stop looking.
                    break;
                }
                // Nope. Discard it.
<span class="nc" id="L3309">                other = null;</span>

            } // Check the next entity in this position.

            // We were supposed to find someone to load.
<span class="nc bnc" id="L3314" title="All 2 branches missed.">            if (other == null) {</span>
<span class="nc" id="L3315">                return false;</span>
            }

        } // End STEP_LOAD-checks
        
        // The entity is trying to tow. Check for a valid move.
<span class="nc bnc" id="L3321" title="All 2 branches missed.">        if (type == MoveStepType.TOW) {</span>

            // Find the unit being towed.
<span class="nc" id="L3324">            Entity other = game.getEntity(entity.getTowing());</span>

            // The moving unit should be able to tow the other unit.
<span class="nc bnc" id="L3327" title="All 2 branches missed.">            if (!entity.canTow(other.getId())) {</span>
<span class="nc" id="L3328">                return false;</span>
            }
        } // End STEP_TOW-checks

        // mechs dumping ammo can't run
<span class="nc" id="L3333">        boolean bDumping = false;</span>
<span class="nc bnc" id="L3334" title="All 2 branches missed.">        for (Mounted mo : entity.getAmmo()) {</span>
<span class="nc bnc" id="L3335" title="All 2 branches missed.">            if (mo.isDumping()) {</span>
<span class="nc" id="L3336">                bDumping = true;</span>
<span class="nc" id="L3337">                break;</span>
            }
<span class="nc" id="L3339">        }</span>
<span class="nc bnc" id="L3340" title="All 12 branches missed.">        if (bDumping</span>
                &amp;&amp; ((movementType == EntityMovementType.MOVE_RUN)
                || (movementType == EntityMovementType.MOVE_SPRINT)
                || (movementType == EntityMovementType.MOVE_VTOL_RUN)
                || (movementType == EntityMovementType.MOVE_VTOL_SPRINT)
                || (movementType == EntityMovementType.MOVE_JUMP))) {
<span class="nc" id="L3346">            return false;</span>
        }

        // check elevation difference &gt; max
<span class="nc" id="L3350">        EntityMovementMode nMove = entity.getMovementMode();</span>

        // Make sure that if it's a VTOL unit with the VTOL MP listed as jump
        // MP...
        // That it can't jump.
<span class="nc bnc" id="L3355" title="All 4 branches missed.">        if ((movementType == EntityMovementType.MOVE_JUMP)</span>
                &amp;&amp; (nMove == EntityMovementMode.VTOL)) {
<span class="nc" id="L3357">            return false;</span>
        }

    
        
<span class="nc bnc" id="L3362" title="All 4 branches missed.">        if ((movementType != EntityMovementType.MOVE_JUMP)</span>
                &amp;&amp; (nMove != EntityMovementMode.VTOL)) {
<span class="nc" id="L3364">            int maxDown = entity.getMaxElevationDown(srcAlt);</span>
<span class="nc bnc" id="L3365" title="All 4 branches missed.">            if (movementMode == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L3366" title="All 2 branches missed.">                    &amp;&amp; (srcEl == 0 || (srcHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L3367" title="All 2 branches missed.">                            &amp;&amp; (srcHex.terrainLevel(Terrains.BLDG_ELEV) &gt;= srcEl)))) {</span>
<span class="nc" id="L3368">                maxDown = entity.getMaxElevationChange();</span>
            }
<span class="nc bnc" id="L3370" title="All 6 branches missed.">            if ((((srcAlt - destAlt) &gt; 0) &amp;&amp; ((srcAlt - destAlt) &gt; maxDown))</span>
                    || (((destAlt - srcAlt) &gt; 0) &amp;&amp; ((destAlt - srcAlt) &gt; entity
<span class="nc bnc" id="L3372" title="All 2 branches missed.">                    .getMaxElevationChange()))) {</span>
                // System.err.println(&quot;jump VTOL check failed&quot;);
<span class="nc" id="L3374">                return false;</span>
            }
        }
        
        // Sheer Cliffs, TO p.39
        // Roads over cliffs cancel the cliff effects for units that move on roads
<span class="nc bnc" id="L3380" title="All 2 branches missed.">        boolean vehicleAffectedByCliff = entity instanceof Tank </span>
<span class="nc bnc" id="L3381" title="All 2 branches missed.">                &amp;&amp; !entity.isAirborneVTOLorWIGE();</span>
<span class="nc bnc" id="L3382" title="All 2 branches missed.">        boolean quadveeVehMode = entity instanceof QuadVee </span>
<span class="nc bnc" id="L3383" title="All 2 branches missed.">                &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE;</span>
<span class="nc" id="L3384">        int stepHeight = destAlt - srcAlt;</span>
        // Cliffs should only exist towards 1 or 2 level drops, check just to make sure
        // Everything that does not have a 1 or 2 level drop shouldn't be handled as a cliff
<span class="nc bnc" id="L3387" title="All 2 branches missed.">        boolean isUpCliff = !src.equals(dest)</span>
<span class="nc bnc" id="L3388" title="All 6 branches missed.">                &amp;&amp; destHex.hasCliffTopTowards(srcHex)</span>
                &amp;&amp; (stepHeight == 1 || stepHeight == 2);
<span class="nc bnc" id="L3390" title="All 2 branches missed.">        boolean isDownCliff = !src.equals(dest) </span>
<span class="nc bnc" id="L3391" title="All 6 branches missed.">                &amp;&amp; srcHex.hasCliffTopTowards(destHex)</span>
                &amp;&amp; (stepHeight == -1 || stepHeight == -2);
        
        // For vehicles exc. VTOL, WIGE, upward Sheer Cliffs is forbidden
        // QuadVees in vehicle mode drive as vehicles, IO p.133
<span class="nc bnc" id="L3396" title="All 8 branches missed.">        if ((vehicleAffectedByCliff || quadveeVehMode) </span>
                &amp;&amp; isUpCliff
                &amp;&amp; !isPavementStep) {
<span class="nc" id="L3399">            return false;</span>
        }

        // For Infantry, up or down sheer cliffs requires a climbing action 
        // except for Mountain Troops across a level 1 cliff.
        // Climbing actions do not seem to be implemented, so Infantry cannot
        // cross sheer cliffs at all except for Mountain Troops across a level 1 cliff.
<span class="nc bnc" id="L3406" title="All 8 branches missed.">        if (entity instanceof Infantry </span>
                &amp;&amp; (isUpCliff || isDownCliff)
                &amp;&amp; !isPavementStep) {

<span class="nc" id="L3410">            boolean isMountainTroop = ((Infantry)entity).hasSpecialization(Infantry.MOUNTAIN_TROOPS);</span>
<span class="nc bnc" id="L3411" title="All 4 branches missed.">            if (!isMountainTroop || stepHeight == 2) {</span>
<span class="nc" id="L3412">                return false;</span>
            }
        }
        
<span class="nc bnc" id="L3416" title="All 4 branches missed.">        if ((entity instanceof Mech) &amp;&amp; ((srcAlt - destAlt) &gt; 2)) {</span>
<span class="nc" id="L3417">            setLeapDistance(srcAlt - destAlt);</span>
        }

        // Units moving backwards may not change elevation levels.
<span class="nc bnc" id="L3421" title="All 10 branches missed.">        if (((type == MoveStepType.BACKWARDS)</span>
                || (type == MoveStepType.LATERAL_LEFT_BACKWARDS) || (type == MoveStepType.LATERAL_RIGHT_BACKWARDS))
                &amp;&amp; (destAlt != srcAlt)
                &amp;&amp; !(entity instanceof VTOL)
<span class="nc bnc" id="L3425" title="All 4 branches missed.">                &amp;&amp; !(isJumping() &amp;&amp; (entity.getJumpType() == Mech.JUMP_BOOSTER))) {</span>
            // Generally forbidden without TacOps Expanded Backward Movement p.22
<span class="nc bnc" id="L3427" title="All 2 branches missed.">            if (!game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_WALK_BACKWARDS)) {</span>
<span class="nc" id="L3428">                return false;</span>
            }
            // Even with Expanded Backward Movement, ...
            // May not move across a cliff (up) moving backwards at all
<span class="nc bnc" id="L3432" title="All 2 branches missed.">            if (destHex.containsTerrain(Terrains.CLIFF_TOP)</span>
<span class="nc bnc" id="L3433" title="All 2 branches missed.">                    &amp;&amp; destHex.getTerrain(Terrains.CLIFF_TOP).hasExitsSpecified()</span>
<span class="nc bnc" id="L3434" title="All 2 branches missed.">                    &amp;&amp; ((destHex.getTerrain(Terrains.CLIFF_TOP).getExits() &amp; (1 &lt;&lt; dest.direction(src))) != 0) </span>
<span class="nc bnc" id="L3435" title="All 2 branches missed.">                    &amp;&amp; (!src.equals(dest))) {</span>
<span class="nc" id="L3436">                return false;</span>
            }
            // May not move across a cliff (down) moving backwards at all
<span class="nc bnc" id="L3439" title="All 2 branches missed.">            if (srcHex.containsTerrain(Terrains.CLIFF_TOP)</span>
<span class="nc bnc" id="L3440" title="All 2 branches missed.">                    &amp;&amp; srcHex.getTerrain(Terrains.CLIFF_TOP).hasExitsSpecified()</span>
<span class="nc bnc" id="L3441" title="All 2 branches missed.">                    &amp;&amp; ((srcHex.getTerrain(Terrains.CLIFF_TOP).getExits() &amp; (1 &lt;&lt; src.direction(dest))) != 0)</span>
<span class="nc bnc" id="L3442" title="All 2 branches missed.">                    &amp;&amp; (!src.equals(dest))) {</span>
<span class="nc" id="L3443">                return false;</span>
            }
            // May not move across more than 1 level 
<span class="nc bnc" id="L3446" title="All 2 branches missed.">            if (Math.abs(destAlt - srcAlt) &gt; 1) {</span>
<span class="nc" id="L3447">                return false;</span>
            }
        }

        // WiGEs can't move backwards
<span class="nc bnc" id="L3452" title="All 4 branches missed.">        if ((type == MoveStepType.BACKWARDS)</span>
                &amp;&amp; (nMove == EntityMovementMode.WIGE)) {
<span class="nc" id="L3454">            return false;</span>
        }

        // Can't run into water unless hovering, naval, first step, using a
        // bridge, or fly.
<span class="nc bnc" id="L3459" title="All 22 branches missed.">        if (((movementType == EntityMovementType.MOVE_RUN)</span>
                || (movementType == EntityMovementType.MOVE_SPRINT)
                || (movementType == EntityMovementType.MOVE_VTOL_RUN)
                || (movementType == EntityMovementType.MOVE_VTOL_SPRINT))
                &amp;&amp; (nMove != EntityMovementMode.HOVER)
                &amp;&amp; (nMove != EntityMovementMode.NAVAL)
                &amp;&amp; (nMove != EntityMovementMode.HYDROFOIL)
                &amp;&amp; (nMove != EntityMovementMode.SUBMARINE)
                &amp;&amp; (nMove != EntityMovementMode.INF_UMU)
                &amp;&amp; (nMove != EntityMovementMode.VTOL)
                &amp;&amp; (nMove != EntityMovementMode.WIGE)
<span class="nc bnc" id="L3470" title="All 2 branches missed.">                &amp;&amp; !cachedEntityState.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)</span>
<span class="nc bnc" id="L3471" title="All 2 branches missed.">                &amp;&amp; (destHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L3472" title="All 4 branches missed.">                &amp;&amp; !(destHex.containsTerrain(Terrains.ICE) &amp;&amp; (elevation &gt;= 0))</span>
<span class="nc bnc" id="L3473" title="All 2 branches missed.">                &amp;&amp; !dest.equals(entity.getPosition())</span>
<span class="nc bnc" id="L3474" title="All 2 branches missed.">                &amp;&amp; !isFirstStep()</span>
<span class="nc bnc" id="L3475" title="All 2 branches missed.">                &amp;&amp; !isPavementStep()) {</span>
<span class="nc" id="L3476">            return false;</span>
        }

        // ugh, stacking checks. well, maybe we're immune!
<span class="nc bnc" id="L3480" title="All 6 branches missed.">        if (!isJumping() &amp;&amp; (type != MoveStepType.CHARGE)</span>
                &amp;&amp; (type != MoveStepType.DFA)) {
            // can't move a mech into a hex with an enemy mech
<span class="nc bnc" id="L3483" title="All 2 branches missed.">            if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L3484" title="All 2 branches missed.">                    &amp;&amp; Compute.isEnemyIn(game, entity, dest, true, true,</span>
<span class="nc" id="L3485">                    getElevation())) {</span>
<span class="nc" id="L3486">                return false;</span>
            }

            // Can't move out of a hex with an enemy unit unless we started
            // there, BUT we're allowed to turn, unload/Disconnect, or go prone.
<span class="nc bnc" id="L3491" title="All 2 branches missed.">            if (Compute.isEnemyIn(game, entity, src, false,</span>
                    entity instanceof Mech, srcEl)
<span class="nc bnc" id="L3493" title="All 12 branches missed.">                    &amp;&amp; !src.equals(entity.getPosition())</span>
                    &amp;&amp; (type != MoveStepType.TURN_LEFT)
                    &amp;&amp; (type != MoveStepType.TURN_RIGHT)
                    &amp;&amp; (type != MoveStepType.UNLOAD)
                    &amp;&amp; (type != MoveStepType.DISCONNECT)
                    &amp;&amp; (type != MoveStepType.GO_PRONE)) {
<span class="nc" id="L3499">                return false;</span>
            }

            // cant move through a hex with a LargeSupportTank or a grounded
            // Dropship unless infantry
            // or a VTOL at high enough elevation
<span class="nc bnc" id="L3505" title="All 2 branches missed.">            if (!(entity instanceof Infantry)) {</span>
<span class="nc" id="L3506">                boolean validRoadTrain = false;</span>
<span class="nc bnc" id="L3507" title="All 2 branches missed.">                for (Entity inHex : game.getEntitiesVector(src)) {</span>
<span class="nc bnc" id="L3508" title="All 2 branches missed.">                    if (inHex.equals(entity)) {</span>
<span class="nc" id="L3509">                        continue;</span>
                    }
                    
                    //ignore the first trailer behind a non-superheavy tractor
                    //which can be in the same hex
<span class="nc bnc" id="L3514" title="All 4 branches missed.">                    if (!entity.getAllTowedUnits().isEmpty() &amp;&amp; !entity.isSuperHeavy()) {</span>
<span class="nc" id="L3515">                        Entity firstTrailer = game.getEntity(entity.getAllTowedUnits().get(0));</span>
<span class="nc bnc" id="L3516" title="All 2 branches missed.">                        if (inHex.equals(firstTrailer)) {</span>
<span class="nc" id="L3517">                            validRoadTrain = true;</span>
                        }
                    }
                    
<span class="nc bnc" id="L3521" title="All 2 branches missed.">                    if ((inHex instanceof LargeSupportTank)</span>
<span class="nc bnc" id="L3522" title="All 4 branches missed.">                            || (!entity.getAllTowedUnits().isEmpty() &amp;&amp; !validRoadTrain)</span>
<span class="nc bnc" id="L3523" title="All 4 branches missed.">                            || (!inHex.getAllTowedUnits().isEmpty())</span>
                            || ((inHex instanceof Dropship)
<span class="nc bnc" id="L3525" title="All 2 branches missed.">                            &amp;&amp; !inHex.isAirborne() &amp;&amp; !inHex</span>
<span class="nc bnc" id="L3526" title="All 2 branches missed.">                            .isSpaceborne())) {</span>
<span class="nc bnc" id="L3527" title="All 2 branches missed.">                        if (getElevation() &lt;= inHex.height()) {</span>
<span class="nc" id="L3528">                            return false;</span>
                        }
                    }
<span class="nc" id="L3531">                }</span>
            }
        }

        // can't jump over too-high terrain
<span class="nc bnc" id="L3536" title="All 2 branches missed.">        if ((movementType == EntityMovementType.MOVE_JUMP)</span>
<span class="nc" id="L3537">                &amp;&amp; (destAlt &gt; (entity.getElevation()</span>
<span class="nc" id="L3538">                + entity.game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L3539" title="All 2 branches missed.">                .getLevel() + entity.getJumpMPWithTerrain() + (type == MoveStepType.DFA ? 1</span>
<span class="nc bnc" id="L3540" title="All 2 branches missed.">                : 0)))) {</span>
            // System.err.println(&quot;can't jump over too-high terrain&quot;);
<span class="nc" id="L3542">            return false;</span>
        }

        // Certain movement types have terrain restrictions; terrain
        // restrictions are lifted when moving along a road or bridge,
        // or when flying. Naval movement does not have the pavement
        // exemption.
<span class="nc bnc" id="L3549" title="All 10 branches missed.">        if (entity.isLocationProhibited(dest, getElevation())</span>
                // Units in prohibited terran should still be able to unload/disconnect
                &amp;&amp; (type != MoveStepType.UNLOAD)
                &amp;&amp; (type != MoveStepType.DISCONNECT)
                // Should allow vertical takeoffs
                &amp;&amp; (type != MoveStepType.VTAKEOFF)
                // QuadVees can convert to vehicle mode even if they cannot enter the terrain
                &amp;&amp; (type != MoveStepType.CONVERT_MODE)
<span class="nc bnc" id="L3557" title="All 14 branches missed.">                &amp;&amp; (!isPavementStep() || (nMove == EntityMovementMode.NAVAL)</span>
                || (nMove == EntityMovementMode.HYDROFOIL) || (nMove == EntityMovementMode.SUBMARINE))
                &amp;&amp; (movementType != EntityMovementType.MOVE_VTOL_WALK)
                &amp;&amp; (movementType != EntityMovementType.MOVE_VTOL_RUN)
                &amp;&amp; (movementType != EntityMovementType.MOVE_VTOL_SPRINT)) {

            // We're allowed to pass *over* invalid
            // terrain, but we can't end there.
<span class="nc bnc" id="L3565" title="All 2 branches missed.">            if (isJumping()) {</span>
<span class="nc" id="L3566">                terrainInvalid = true;</span>
            } else {
                // This is an illegal move.
                // System.err.println(&quot;landing in illegal terrain&quot;);
<span class="nc" id="L3570">                return false;</span>
            }
        }

        // We need extra checking for dropships, due to secondary positions
        // if the Dropship is taking off, movetype will be safe thrust
<span class="nc bnc" id="L3576" title="All 4 branches missed.">        if ((entity instanceof Dropship) &amp;&amp; !entity.isAirborne()</span>
<span class="nc bnc" id="L3577" title="All 10 branches missed.">                &amp;&amp; isPavementStep() &amp;&amp; entity.isLocationProhibited(dest, getElevation())</span>
                &amp;&amp; (movementType != EntityMovementType.MOVE_SAFE_THRUST)
                &amp;&amp; (type != MoveStepType.LOAD)
                &amp;&amp; (type != MoveStepType.UNLOAD)) {
<span class="nc bnc" id="L3581" title="All 2 branches missed.">            for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L3582">                Coords secondaryCoords = dest.translated(dir);</span>
<span class="nc" id="L3583">                IHex secondaryHex = game.getBoard().getHex(secondaryCoords);</span>
<span class="nc bnc" id="L3584" title="All 2 branches missed.">                if (!secondaryHex.hasPavement()) {</span>
<span class="nc" id="L3585">                    return false;</span>
                }
            }
        }
        
        //If we're a land train with mixed motive types, use the most restrictive type
        //to determine terrain restrictions
<span class="nc bnc" id="L3592" title="All 10 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()</span>
                &amp;&amp; (type != MoveStepType.LOAD
                    &amp;&amp; type != MoveStepType.UNLOAD
                    &amp;&amp; type != MoveStepType.TOW
                    &amp;&amp; type != MoveStepType.DISCONNECT)) {
<span class="nc" id="L3597">            boolean prohibitedByTrailer = false;</span>
            //Add up the trailers
<span class="nc bnc" id="L3599" title="All 2 branches missed.">            for (int id : entity.getAllTowedUnits()) {</span>
<span class="nc" id="L3600">                Entity tr = game.getEntity(id);</span>
<span class="nc" id="L3601">                prohibitedByTrailer = tr.isLocationProhibited(dest, getElevation());</span>
<span class="nc bnc" id="L3602" title="All 2 branches missed.">                if (prohibitedByTrailer) {</span>
<span class="nc" id="L3603">                    return false;</span>
                }
<span class="nc" id="L3605">            }</span>
        }

        // Jumping into a building hex below the roof ends the move
        // assume this applies also to sylph vtol movement
<span class="nc bnc" id="L3610" title="All 2 branches missed.">        if (!(src.equals(dest))</span>
<span class="nc bnc" id="L3611" title="All 2 branches missed.">                &amp;&amp; (src != entity.getPosition())</span>
<span class="nc bnc" id="L3612" title="All 4 branches missed.">                &amp;&amp; (isJumping() || (entity.getMovementMode() == EntityMovementMode.VTOL))</span>
<span class="nc bnc" id="L3613" title="All 2 branches missed.">                &amp;&amp; (srcEl &lt; srcHex.terrainLevel(Terrains.BLDG_ELEV))) {</span>
            // System.err.println(&quot;jumping into side of building&quot;);

<span class="nc" id="L3616">            return false;</span>
        }

        // If we are *in* restricted terrain, we can only leave via roads.
<span class="nc bnc" id="L3620" title="All 16 branches missed.">        if ((movementType != EntityMovementType.MOVE_JUMP)</span>
                &amp;&amp; (movementType != EntityMovementType.MOVE_VTOL_WALK)
                &amp;&amp; (movementType != EntityMovementType.MOVE_VTOL_RUN)
                &amp;&amp; (movementType != EntityMovementType.MOVE_VTOL_SPRINT)
                // Units in prohibited terran should still be able to unload/disconnect
                &amp;&amp; (type != MoveStepType.UNLOAD)
                &amp;&amp; (type != MoveStepType.DISCONNECT)
                // Should allow vertical takeoffs
                &amp;&amp; (type != MoveStepType.VTAKEOFF)
                // QuadVees can still convert to vehicle mode in prohibited terrain, but cannot leave
                &amp;&amp; (type != MoveStepType.CONVERT_MODE)
<span class="nc bnc" id="L3631" title="All 4 branches missed.">                &amp;&amp; entity.isLocationProhibited(src, getElevation()) &amp;&amp; !isPavementStep()) {</span>
            // System.err.println(&quot;in restricted terrain&quot;);
<span class="nc" id="L3633">            return false;</span>
        }
<span class="nc bnc" id="L3635" title="All 2 branches missed.">        if (type == MoveStepType.UP) {</span>
<span class="nc bnc" id="L3636" title="All 2 branches missed.">            if (!(entity.canGoUp(elevation - 1, getPosition()))) {</span>
                // System.err.println(&quot;cant go up anymore&quot;);

<span class="nc" id="L3639">                return false;</span>
            }
        }
<span class="nc bnc" id="L3642" title="All 2 branches missed.">        if (type == MoveStepType.DOWN) {</span>
<span class="nc bnc" id="L3643" title="All 2 branches missed.">            if (!(entity.canGoDown(elevation + 1, getPosition()))) {</span>
                // System.err.println(&quot;cant go down anymore&quot;);
<span class="nc" id="L3645">                return false;// We can't intentionally crash.</span>
            }
        }
<span class="nc bnc" id="L3648" title="All 2 branches missed.">        if (entity instanceof VTOL) {</span>
<span class="nc bnc" id="L3649" title="All 16 branches missed.">            if ((type == MoveStepType.BACKWARDS)</span>
                    || (type == MoveStepType.FORWARDS)
                    || (type == MoveStepType.LATERAL_LEFT)
                    || (type == MoveStepType.LATERAL_LEFT_BACKWARDS)
                    || (type == MoveStepType.LATERAL_RIGHT)
                    || (type == MoveStepType.LATERAL_RIGHT_BACKWARDS)
                    || (type == MoveStepType.TURN_LEFT)
                    || (type == MoveStepType.TURN_RIGHT)) {
<span class="nc bnc" id="L3657" title="All 2 branches missed.">                if (getClearance() == 0) {// can't move on the ground.</span>
<span class="nc" id="L3658">                    return false;</span>
                }
            }
        }
<span class="nc bnc" id="L3662" title="All 4 branches missed.">        if ((entity instanceof VTOL || entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L3663" title="All 14 branches missed.">                &amp;&amp; getClearance() &gt; 0</span>
                &amp;&amp; ((type == MoveStepType.BACKWARDS) || (type == MoveStepType.FORWARDS)
                        || (type == MoveStepType.LATERAL_LEFT) || (type == MoveStepType.LATERAL_LEFT_BACKWARDS)
                        || (type == MoveStepType.LATERAL_RIGHT) || (type == MoveStepType.LATERAL_RIGHT_BACKWARDS))) {
            // It's possible to fly under a bridge.
<span class="nc bnc" id="L3668" title="All 2 branches missed.">            if (destHex.containsTerrain(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc bnc" id="L3669" title="All 2 branches missed.">                if (elevation == destHex.terrainLevel(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc" id="L3670">                    return false;</span>
                }
<span class="nc bnc" id="L3672" title="All 2 branches missed.">            } else if (elevation &lt;= (destHex.ceiling() - destHex.surface())) {</span>
                // VTOLs and WiGEs can fly through woods and jungle below the level of the treetops on a road.
<span class="nc bnc" id="L3674" title="All 4 branches missed.">                if (destHex.containsTerrain(Terrains.WOODS) || destHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L3675">                    return destHex.containsTerrainExit(Terrains.ROAD, dest.direction(src));</span>
                }
                // System.err.println(&quot;can't fly into woods or a cliff face&quot;);
<span class="nc" id="L3678">                return false; // can't fly into woods or a cliff face</span>
            }
        }

        // check the elevation is valid for the type of entity and hex
<span class="nc bnc" id="L3683" title="All 2 branches missed.">        if ((type != MoveStepType.DFA)</span>
<span class="nc bnc" id="L3684" title="All 2 branches missed.">                &amp;&amp; !entity.isElevationValid(elevation, destHex)) {</span>
<span class="nc bnc" id="L3685" title="All 2 branches missed.">            if (isJumping()) {</span>
<span class="nc" id="L3686">                terrainInvalid = true;</span>
            } else {
                // System.err.println(&quot;isElevationValid failed destHex is &quot; +
                // dest.toString());
<span class="nc" id="L3690">                return false;</span>
            }
        }

<span class="nc" id="L3694">        return true;</span>
    }

    public int getElevation() {
<span class="nc" id="L3698">        return elevation;</span>
    }
    
    /**
     * In hexes with buildings, returns the elevation relative to the roof. Otherwise returns the elevation
     * relative to the surface.
     */
    public int getClearance() {
<span class="nc" id="L3706">        IHex hex = entity.getGame().getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L3707" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L3708">            return elevation - hex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc" id="L3710">        return elevation;</span>
    }
    
    public int getAltitude() {
<span class="nc" id="L3714">        return altitude;</span>
    }

    public int getMineToLay() {
<span class="nc" id="L3718">        return mineToLay;</span>
    }

    protected void setMineToLay(int mineId) {
<span class="nc" id="L3722">        mineToLay = mineId;</span>
<span class="nc" id="L3723">    }</span>

    protected void setVelocity(int vel) {
<span class="nc" id="L3726">        velocity = vel;</span>
<span class="nc" id="L3727">    }</span>

    public int getVelocity() {
<span class="nc" id="L3730">        return velocity;</span>
    }

    protected void setVelocityN(int vel) {
<span class="nc" id="L3734">        velocityN = vel;</span>
<span class="nc" id="L3735">    }</span>

    public int getVelocityN() {
<span class="nc" id="L3738">        return velocityN;</span>
    }

    protected void setVelocityLeft(int vel) {
<span class="nc" id="L3742">        velocityLeft = vel;</span>
<span class="nc" id="L3743">    }</span>

    public int getVelocityLeft() {
<span class="nc" id="L3746">        return velocityLeft;</span>
    }

    public int asfTurnCost(IGame game, MoveStepType direction, Entity entity) {

        // jumpships (but not space stations and warships) never pay
<span class="nc bnc" id="L3752" title="All 6 branches missed.">        if ((entity instanceof Jumpship) &amp;&amp; !(entity instanceof Warship)</span>
                &amp;&amp; !(entity instanceof SpaceStation)) {
<span class="nc" id="L3754">            return 0;</span>
        }

        // if we're behaving like a spheroid in atmosphere, we can spin around to our heart's content
<span class="nc bnc" id="L3758" title="All 2 branches missed.">        if (useSpheroidAtmosphere(game, entity)) {</span>
<span class="nc" id="L3759">            return 0;</span>
        }
        
        // if in atmosphere, the rules are different
<span class="nc bnc" id="L3763" title="All 2 branches missed.">        if (useAeroAtmosphere(game, entity)) {</span>
            // if they have a free turn, then this move is free
<span class="nc bnc" id="L3765" title="All 2 branches missed.">            if (hasFreeTurn()) {</span>
<span class="nc" id="L3766">                return 0;</span>
            }
            // it costs half the current velocity (rounded up)
<span class="nc" id="L3769">            return (int) Math.ceil(getVelocity() / 2.0);</span>
        }

        // first check for thruster damage
        // put illegal for more than three thruster hits in CompileIllegal
<span class="nc" id="L3774">        IAero a = (IAero) entity;</span>
<span class="nc" id="L3775">        int thrustCost = 0;</span>
<span class="nc bnc" id="L3776" title="All 2 branches missed.">        if (direction == MoveStepType.TURN_LEFT) {</span>
<span class="nc" id="L3777">            thrustCost = a.getLeftThrustHits();</span>
        }
<span class="nc bnc" id="L3779" title="All 2 branches missed.">        if (direction == MoveStepType.TURN_RIGHT) {</span>
<span class="nc" id="L3780">            thrustCost = a.getRightThrustHits();</span>
        }

<span class="nc bnc" id="L3783" title="All 2 branches missed.">        if (game.useVectorMove()) {</span>
            // velocity doesn't factor into advanced movement
<span class="nc" id="L3785">            return (1 + thrustCost);</span>
        }

        // based on velocity
<span class="nc bnc" id="L3789" title="All 2 branches missed.">        if (velocity &lt; 3) {</span>
<span class="nc" id="L3790">            return 1 + thrustCost;</span>
<span class="nc bnc" id="L3791" title="All 4 branches missed.">        } else if ((velocity &gt; 2) &amp;&amp; (velocity &lt; 6)) {</span>
<span class="nc" id="L3792">            return 2 + thrustCost;</span>
<span class="nc bnc" id="L3793" title="All 4 branches missed.">        } else if ((velocity &gt; 5) &amp;&amp; (velocity &lt; 8)) {</span>
<span class="nc" id="L3794">            return 3 + thrustCost;</span>
<span class="nc bnc" id="L3795" title="All 4 branches missed.">        } else if ((velocity &gt; 7) &amp;&amp; (velocity &lt; 10)) {</span>
<span class="nc" id="L3796">            return 4 + thrustCost;</span>
<span class="nc bnc" id="L3797" title="All 2 branches missed.">        } else if (velocity == 10) {</span>
<span class="nc" id="L3798">            return 5 + thrustCost;</span>
<span class="nc bnc" id="L3799" title="All 2 branches missed.">        } else if (velocity == 11) {</span>
<span class="nc" id="L3800">            return 6 + thrustCost;</span>
        }
<span class="nc" id="L3802">        return (((6 + velocity) - 11) + thrustCost);</span>
    }

    protected void setNTurns(int turns) {
<span class="nc" id="L3806">        nTurns = turns;</span>
<span class="nc" id="L3807">    }</span>

    public int getNTurns() {
<span class="nc" id="L3810">        return nTurns;</span>
    }

    protected void setNMoved(int moved) {
<span class="nc" id="L3814">        nMoved = moved;</span>
<span class="nc" id="L3815">    }</span>

    public int getNMoved() {
<span class="nc" id="L3818">        return nMoved;</span>
    }

    protected void setNRolls(int rolls) {
<span class="nc" id="L3822">        nRolls = rolls;</span>
<span class="nc" id="L3823">    }</span>

    public int getNRolls() {
<span class="nc" id="L3826">        return nRolls;</span>
    }

    protected void setOffBoard(boolean b) {
<span class="nc" id="L3830">        offBoard = b;</span>
<span class="nc" id="L3831">    }</span>

    public boolean isOffBoard() {
<span class="nc" id="L3834">        return offBoard;</span>
    }

    public int[] getVectors() {
<span class="nc" id="L3838">        return mv;</span>
    }

    protected void setVectors(int[] v) {
<span class="nc bnc" id="L3842" title="All 2 branches missed.">        if (v.length != 6) {</span>
<span class="nc" id="L3843">            return;</span>
        }

<span class="nc" id="L3846">        mv = v;</span>
<span class="nc" id="L3847">    }</span>

    public boolean hasFreeTurn() {
<span class="nc" id="L3850">        return freeTurn;</span>
    }

    protected void setFreeTurn(boolean b) {
<span class="nc" id="L3854">        freeTurn = b;</span>
<span class="nc" id="L3855">    }</span>

    public int getNStraight() {
<span class="nc" id="L3858">        return nStraight;</span>
    }

    protected void setNStraight(int i) {
<span class="nc" id="L3862">        nStraight = i;</span>
<span class="nc" id="L3863">    }</span>

    /**
     * can this aero turn for any reason in atmosphere?
     */
    public boolean canAeroTurn(IGame game) {
<span class="nc" id="L3869">        Entity en = getEntity();</span>
        
<span class="nc bnc" id="L3871" title="All 2 branches missed.">        if (!en.isAero()) {</span>
<span class="nc" id="L3872">            return false;</span>
        }
        
        // spheroids in atmo can spin around like a centrifuge all they want
<span class="nc bnc" id="L3876" title="All 2 branches missed.">        if(useSpheroidAtmosphere(game, en)) {</span>
<span class="nc" id="L3877">            return true;</span>
        }

<span class="nc bnc" id="L3880" title="All 2 branches missed.">        if (dueFreeTurn()) {</span>
<span class="nc" id="L3881">            return true;</span>
        }

        // if its part of a maneuver then you can turn
<span class="nc bnc" id="L3885" title="All 2 branches missed.">        if (isManeuver()) {</span>
<span class="nc" id="L3886">            return true;</span>
        }

<span class="nc bnc" id="L3889" title="All 2 branches missed.">        if (en instanceof ConvFighter) {</span>
            // conventional fighters can only turn on free turns or maneuvers
<span class="nc" id="L3891">            return false;</span>
        }

        // cant use thrust turns in the first hex of movement (or first 8 if
        // ground)
<span class="nc bnc" id="L3896" title="All 2 branches missed.">        if (game.getBoard().onGround()) {</span>
            // if flying on the ground map then they need to move 8 hexes first
<span class="nc bnc" id="L3898" title="All 2 branches missed.">            if (distance &lt; 8) {</span>
<span class="nc" id="L3899">                return false;</span>
            }
<span class="nc bnc" id="L3901" title="All 2 branches missed.">        } else if (distance == 0) {</span>
<span class="nc" id="L3902">            return false;</span>
        }

        // must have been no prior turns in this hex (or 8 hexes if on ground)
<span class="nc bnc" id="L3906" title="All 2 branches missed.">        return getNTurns() == 0;</span>

    }

    public boolean dueFreeTurn() {

<span class="nc" id="L3912">        Entity en = getEntity();</span>
<span class="nc" id="L3913">        int straight = getNStraight();</span>
<span class="nc" id="L3914">        int vel = getVelocity();</span>
<span class="nc" id="L3915">        int thresh = 99;</span>

        // I will assume that small craft should be treated as dropships?
<span class="nc bnc" id="L3918" title="All 2 branches missed.">        if (en instanceof SmallCraft) {</span>
<span class="nc bnc" id="L3919" title="All 2 branches missed.">            if (vel &gt; 15) {</span>
<span class="nc" id="L3920">                thresh = 6;</span>
<span class="nc bnc" id="L3921" title="All 2 branches missed.">            } else if (vel &gt; 12) {</span>
<span class="nc" id="L3922">                thresh = 5;</span>
<span class="nc bnc" id="L3923" title="All 2 branches missed.">            } else if (vel &gt; 9) {</span>
<span class="nc" id="L3924">                thresh = 4;</span>
<span class="nc bnc" id="L3925" title="All 2 branches missed.">            } else if (vel &gt; 6) {</span>
<span class="nc" id="L3926">                thresh = 3;</span>
<span class="nc bnc" id="L3927" title="All 2 branches missed.">            } else if (vel &gt; 3) {</span>
<span class="nc" id="L3928">                thresh = 2;</span>
            } else {
<span class="nc" id="L3930">                thresh = 1;</span>
            }
<span class="nc bnc" id="L3932" title="All 2 branches missed.">        } else if (en instanceof ConvFighter) {</span>
<span class="nc bnc" id="L3933" title="All 2 branches missed.">            if (vel &gt; 15) {</span>
<span class="nc" id="L3934">                thresh = 4;</span>
<span class="nc bnc" id="L3935" title="All 2 branches missed.">            } else if (vel &gt; 12) {</span>
<span class="nc" id="L3936">                thresh = 3;</span>
<span class="nc bnc" id="L3937" title="All 2 branches missed.">            } else if (vel &gt; 9) {</span>
<span class="nc" id="L3938">                thresh = 2;</span>
            } else {
<span class="nc" id="L3940">                thresh = 1;</span>
            }
        } else {
<span class="nc bnc" id="L3943" title="All 2 branches missed.">            if (vel &gt; 15) {</span>
<span class="nc" id="L3944">                thresh = 5;</span>
<span class="nc bnc" id="L3945" title="All 2 branches missed.">            } else if (vel &gt; 12) {</span>
<span class="nc" id="L3946">                thresh = 4;</span>
<span class="nc bnc" id="L3947" title="All 2 branches missed.">            } else if (vel &gt; 9) {</span>
<span class="nc" id="L3948">                thresh = 3;</span>
<span class="nc bnc" id="L3949" title="All 2 branches missed.">            } else if (vel &gt; 6) {</span>
<span class="nc" id="L3950">                thresh = 2;</span>
            } else {
<span class="nc" id="L3952">                thresh = 1;</span>
            }
        }

        // different rules if flying on the ground map
<span class="nc bnc" id="L3957" title="All 4 branches missed.">        if (en.game.getBoard().onGround() &amp;&amp; (getElevation() &gt; 0)) {</span>
<span class="nc bnc" id="L3958" title="All 2 branches missed.">            if (en instanceof Dropship) {</span>
<span class="nc" id="L3959">                thresh = vel * 8;</span>
<span class="nc bnc" id="L3960" title="All 2 branches missed.">            } else if (en instanceof SmallCraft) {</span>
<span class="nc" id="L3961">                thresh = 8 + ((vel - 1) * 6);</span>
            } else {
<span class="nc" id="L3963">                thresh = 8 + ((vel - 1) * 4);</span>
            }
        }

<span class="nc bnc" id="L3967" title="All 2 branches missed.">        if (straight &gt;= thresh) {</span>
<span class="nc" id="L3968">            return true;</span>
        }

<span class="nc" id="L3971">        return false;</span>

    }

    protected void setNDown(int i) {
<span class="nc" id="L3976">        nDown = i;</span>
<span class="nc" id="L3977">    }</span>

    public int getNDown() {
<span class="nc" id="L3980">        return nDown;</span>
    }

    public int getRecoveryUnit() {
<span class="nc" id="L3984">        return recoveryUnit;</span>
    }

    protected void setRecoveryUnit(int i) {
<span class="nc" id="L3988">        recoveryUnit = i;</span>
<span class="nc" id="L3989">    }</span>

    public int getManeuverType() {
<span class="nc" id="L3992">        return maneuverType;</span>
    }

    public boolean hasNoCost() {
<span class="nc" id="L3996">        return noCost;</span>
    }

    public boolean isManeuver() {
<span class="nc" id="L4000">        return maneuver;</span>
    }

    public Minefield getMinefield() {
<span class="nc" id="L4004">        return mf;</span>
    }

    /**
     * Should we treat this movement as if it is occuring for an aerodyne unit
     * flying in atmosphere?
     */
    boolean useAeroAtmosphere(IGame game, Entity en) {
<span class="nc bnc" id="L4012" title="All 2 branches missed.">        if (!en.isAero()) {</span>
<span class="nc" id="L4013">            return false;</span>
        }
<span class="nc bnc" id="L4015" title="All 2 branches missed.">        if (((IAero) en).isSpheroid()) {</span>
<span class="nc" id="L4016">            return false;</span>
        }
        // are we in space?
<span class="nc bnc" id="L4019" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L4020">            return false;</span>
        }
        // are we airborne in non-vacuum?
<span class="nc bnc" id="L4023" title="All 4 branches missed.">        return en.isAirborne() &amp;&amp; !game.getPlanetaryConditions().isVacuum();</span>
    }

    /**
     * Should we treat this movement as if it is occurring for a spheroid unit
     * flying in atmosphere?
     */
    public boolean useSpheroidAtmosphere(IGame game, Entity en) {
<span class="nc" id="L4031">        return Compute.useSpheroidAtmosphere(game, en);</span>
    }

    /**
     * @return An {@link ArrayList} of {@link Coords} containing buildings within a dropship's landing zone.
     */
    public ArrayList&lt;Coords&gt; getCrushedBuildingLocs() {
<span class="nc bnc" id="L4038" title="All 2 branches missed.">        if(crushedBuildingLocs == null) {</span>
<span class="nc" id="L4039">            crushedBuildingLocs = new ArrayList&lt;&gt;();</span>
        }
        
<span class="nc" id="L4042">        return crushedBuildingLocs;</span>
    }

    public Entity getEntity() {
<span class="nc" id="L4046">        return entity;</span>
    }

    public IGame getGame() {
<span class="nc bnc" id="L4050" title="All 2 branches missed.">        if (getEntity() != null) {</span>
<span class="nc" id="L4051">            return getEntity().getGame();</span>
        } else {
<span class="nc" id="L4053">            return null;</span>
        }
    }

    public boolean isJumping() {
        // Need to consider if our type is START_JUMP, as when adding a
        // START_JUMP step, the MovePath may not be considered jumping yet
<span class="nc bnc" id="L4060" title="All 4 branches missed.">        return isJumpingPath || (type == MoveStepType.START_JUMP);</span>
    }

    public boolean isCareful() {
<span class="nc" id="L4064">        return isCarefulPath;</span>
    }
    
    /**
     * Helper function to determine whether sprint is available as a game option to the entity
     */
    public boolean canUseSprint(IGame game) {
<span class="nc bnc" id="L4071" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_SPRINT)) {</span>
<span class="nc" id="L4072">            return false;</span>
        }
<span class="nc bnc" id="L4074" title="All 4 branches missed.">        if (entity instanceof Tank</span>
<span class="nc bnc" id="L4075" title="All 2 branches missed.">                || (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)) {</span>
<span class="nc" id="L4076">            return  game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS);</span>
        }
<span class="nc bnc" id="L4078" title="All 2 branches missed.">        if (entity instanceof LandAirMech) {</span>
<span class="nc bnc" id="L4079" title="All 2 branches missed.">            return entity.getConversionMode() == LandAirMech.CONV_MODE_MECH</span>
<span class="nc bnc" id="L4080" title="All 2 branches missed.">                    || (entity.getConversionMode() == LandAirMech.CONV_MODE_AIRMECH</span>
<span class="nc bnc" id="L4081" title="All 2 branches missed.">                            &amp;&amp; getClearance() &lt;= 0);</span>
        }
<span class="nc" id="L4083">        return entity instanceof Mech;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>