<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MiniMap.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">MiniMap.java</span></div><h1>MiniMap.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 * Copyright (C) 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 * for more details.
 */
package megamek.client.ui.swing;

import java.awt.BasicStroke;
import java.awt.Color;
import java.awt.Container;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GraphicsConfiguration;
import java.awt.GraphicsDevice;
import java.awt.GraphicsEnvironment;
import java.awt.Image;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.Stroke;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.awt.event.ComponentListener;
import java.awt.event.InputEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionAdapter;
import java.awt.event.MouseMotionListener;
import java.awt.event.MouseWheelEvent;
import java.awt.event.MouseWheelListener;
import java.awt.font.FontRenderContext;
import java.awt.font.GlyphVector;
import java.awt.geom.AffineTransform;
import java.awt.geom.Path2D;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.Reader;
import java.io.StreamTokenizer;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;
import java.util.Vector;

import javax.imageio.ImageIO;
import javax.swing.JDialog;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.SwingUtilities;

import megamek.client.Client;
import megamek.client.event.BoardViewEvent;
import megamek.client.event.BoardViewListener;
import megamek.client.event.BoardViewListenerAdapter;
import megamek.client.ui.IBoardView;
import megamek.client.ui.Messages;
import megamek.common.Aero;
import megamek.common.Configuration;
import megamek.common.Coords;
import megamek.common.Entity;
import megamek.common.EntityMovementMode;
import megamek.common.EntityVisibilityUtils;
import megamek.common.GameTurn;
import megamek.common.GunEmplacement;
import megamek.common.IBoard;
import megamek.common.IGame;
import megamek.common.IHex;
import megamek.common.Mech;
import megamek.common.MechWarrior;
import megamek.common.Protomech;
import megamek.common.Tank;
import megamek.common.Targetable;
import megamek.common.Terrains;
import megamek.common.VTOL;
import megamek.common.IGame.Phase;
import megamek.common.actions.AttackAction;
import megamek.common.actions.EntityAction;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.event.BoardEvent;
import megamek.common.event.BoardListener;
import megamek.common.event.BoardListenerAdapter;
import megamek.common.event.GameBoardChangeEvent;
import megamek.common.event.GameBoardNewEvent;
import megamek.common.event.GameListener;
import megamek.common.event.GameListenerAdapter;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GameTurnChangeEvent;
import megamek.common.util.ImageUtil;
import megamek.common.util.fileUtils.MegaMekFile;

/**
 * Displays all the mapsheets in a scaled-down size. TBD refactorings: -make a
 * real public API for this with interfaces -decouple rest of the application
 * -use JPanel instead of canvas -move the buttons from graphics to real Swing
 * buttons -clean up listenercode.. -initializecolors is fugly -uses exception
 * to return from method? -uses break-to-label -uses while-true
 */
<span class="nc bnc" id="L112" title="All 2 branches missed.">public class MiniMap extends JPanel {</span>
    private static final long serialVersionUID = 6964529682842424060L;
<span class="nc" id="L114">    private static final Color[] m_terrainColors = new Color[Terrains.SIZE];</span>
    private static Color HEAVY_WOODS;
    private static Color ULTRA_HEAVY_WOODS;
    private static Color BACKGROUND;
    private static Color SINKHOLE;
    private static Color SMOKE_AND_FIRE;

    private static final int SHOW_NO_HEIGHT = 0;
    private static final int SHOW_GROUND_HEIGHT = 1;
    private static final int SHOW_BUILDING_HEIGHT = 2;
    private static final int SHOW_TOTAL_HEIGHT = 3;
    private static final int NBR_MODES = 3;

    private static final int SCROLL_PANE_WIDTH = 160;
    private static final int SCROLL_PANE_HEIGHT = 200;

    private BufferedImage m_mapImage;
    private IBoardView m_bview;
    private IGame m_game;
    private IBoard m_board;
    private Container m_dialog;
    private static final int margin = 6;
    private int topMargin;
    private int leftMargin;
    //This value is variable.
    //if the container m_dialog is an instance of JDialog, it is 14. otherwise 0.
<span class="nc" id="L140">    private int buttonHeight = 0;</span>
<span class="nc" id="L141">    private boolean minimized = false;</span>
    private int heightBufer;
<span class="nc" id="L143">    private int unitSize = 6;// variable which define size of triangle for</span>
    // unit representation
<span class="nc" id="L145">    private Vector&lt;int[]&gt; roadHexIndexes = new Vector&lt;int[]&gt;();</span>
<span class="nc" id="L146">    private int zoom = GUIPreferences.getInstance().getMinimapZoom();</span>
<span class="nc" id="L147">    private int[] fontSize = {6, 8, 10, 12, 14, 16};</span>
<span class="nc" id="L148">    private int[] hexSide = {3, 5, 6, 8, 10, 12};</span>
<span class="nc" id="L149">    private int[] hexSideByCos30 = {3, 4, 5, 7, 9, 10};</span>
<span class="nc" id="L150">    private int[] hexSideBySin30 = {2, 2, 3, 4, 5, 6};</span>
<span class="nc" id="L151">    private int[] halfRoadWidthByCos30 = {0, 0, 1, 2, 2, 3};</span>
<span class="nc" id="L152">    private int[] halfRoadWidthBySin30 = {0, 0, 1, 1, 1, 2};</span>
<span class="nc" id="L153">    private int[] halfRoadWidth = {0, 0, 1, 2, 3, 3};</span>
<span class="nc" id="L154">    private int[] unitSizes = {5, 6, 7, 8, 9, 10};</span>
<span class="nc" id="L155">    private int[] stratZoom = {8, 9, 11, 12, 14, 16};</span>
<span class="nc" id="L156">    private int[] unitBorder = {1, 1, 1, 2, 2, 2};</span>

<span class="nc" id="L158">    private int heightDisplayMode = SHOW_NO_HEIGHT;</span>
    Coords firstLOS;
    Coords secondLOS;

    private Client m_client;

<span class="nc" id="L164">    private ClientGUI clientgui = null;</span>

<span class="nc" id="L166">    boolean dirtyMap = true;</span>
    boolean[][] dirty;
    private Image terrainBuffer;
    
    // Here come the Strat Ops / NATO unit symbols
<span class="nc" id="L171">    Map&lt;Coords, Integer&gt; multiUnits = new HashMap&lt;Coords, Integer&gt;();</span>
    private static final Path2D STRAT_BASERECT;
    private static final Path2D STRAT_INFANTRY;
    private static final Path2D STRAT_MECH;
    private static final Path2D STRAT_VTOL;
    private static final Path2D STRAT_TANKTRACKED;
    private static final Path2D STRAT_AERO;
    private static final Path2D STRAT_SPHEROID;
    private static final Path2D STRAT_HOVER;
    private static final Path2D STRAT_WHEELED;
    private static final Path2D STRAT_NAVAL;
<span class="nc" id="L182">    private static final Dimension SYMBOLSIZE = new Dimension(167,103);</span>
<span class="nc" id="L183">    private static final String[] STRAT_WEIGHTS = { &quot;L&quot;, &quot;L&quot;, &quot;M&quot;, &quot;H&quot;, &quot;A&quot;, &quot;A&quot; };</span>
<span class="nc" id="L184">    private static final double STRAT_CX = SYMBOLSIZE.getWidth()/5; // X center for two symbols</span>
    
    static {
        // Base rectangle for all units
<span class="nc" id="L188">        STRAT_BASERECT = new Path2D.Double();</span>
<span class="nc" id="L189">        STRAT_BASERECT.moveTo(-SYMBOLSIZE.getWidth()/2, -SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L190">        STRAT_BASERECT.lineTo( SYMBOLSIZE.getWidth()/2, -SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L191">        STRAT_BASERECT.lineTo( SYMBOLSIZE.getWidth()/2,  SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L192">        STRAT_BASERECT.lineTo(-SYMBOLSIZE.getWidth()/2,  SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L193">        STRAT_BASERECT.closePath();</span>
        
        // Infantry Symbol
<span class="nc" id="L196">        STRAT_INFANTRY = new Path2D.Double();</span>
<span class="nc" id="L197">        STRAT_INFANTRY.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L198">        STRAT_INFANTRY.moveTo(-SYMBOLSIZE.getWidth()/2, -SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L199">        STRAT_INFANTRY.lineTo( SYMBOLSIZE.getWidth()/2,  SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L200">        STRAT_INFANTRY.moveTo(-SYMBOLSIZE.getWidth()/2,  SYMBOLSIZE.getHeight()/2);</span>
<span class="nc" id="L201">        STRAT_INFANTRY.lineTo( SYMBOLSIZE.getWidth()/2, -SYMBOLSIZE.getHeight()/2);</span>
        
<span class="nc" id="L203">        STRAT_VTOL = new Path2D.Double();</span>
<span class="nc" id="L204">        STRAT_VTOL.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L205">        STRAT_VTOL.moveTo(-SYMBOLSIZE.getWidth()/4, -SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L206">        STRAT_VTOL.lineTo(-SYMBOLSIZE.getWidth()/4,  SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L207">        STRAT_VTOL.lineTo( 0,  0);</span>
<span class="nc" id="L208">        STRAT_VTOL.lineTo(-SYMBOLSIZE.getWidth()/4, -SYMBOLSIZE.getHeight()/4);</span>
        
<span class="nc" id="L210">        STRAT_VTOL.moveTo( SYMBOLSIZE.getWidth()/4,  SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L211">        STRAT_VTOL.lineTo( SYMBOLSIZE.getWidth()/4, -SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L212">        STRAT_VTOL.lineTo( 0, 0);</span>
<span class="nc" id="L213">        STRAT_VTOL.closePath();</span>
        
<span class="nc" id="L215">        STRAT_TANKTRACKED = new Path2D.Double();</span>
<span class="nc" id="L216">        STRAT_TANKTRACKED.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L217">        double small = SYMBOLSIZE.getWidth()/20; </span>
<span class="nc" id="L218">        STRAT_TANKTRACKED.moveTo(-SYMBOLSIZE.getWidth()/3+small, -SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L219">        STRAT_TANKTRACKED.lineTo( SYMBOLSIZE.getWidth()/3-small, -SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L220">        STRAT_TANKTRACKED.lineTo( SYMBOLSIZE.getWidth()/3,       -SYMBOLSIZE.getHeight()/4+small);</span>
<span class="nc" id="L221">        STRAT_TANKTRACKED.lineTo( SYMBOLSIZE.getWidth()/3,        SYMBOLSIZE.getHeight()/4-small);</span>
<span class="nc" id="L222">        STRAT_TANKTRACKED.lineTo( SYMBOLSIZE.getWidth()/3-small,  SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L223">        STRAT_TANKTRACKED.lineTo(-SYMBOLSIZE.getWidth()/3+small,  SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L224">        STRAT_TANKTRACKED.lineTo(-SYMBOLSIZE.getWidth()/3,        SYMBOLSIZE.getHeight()/4-small);</span>
<span class="nc" id="L225">        STRAT_TANKTRACKED.lineTo(-SYMBOLSIZE.getWidth()/3,       -SYMBOLSIZE.getHeight()/4+small);</span>
<span class="nc" id="L226">        STRAT_TANKTRACKED.closePath();</span>
        
<span class="nc" id="L228">        STRAT_MECH = new Path2D.Double();</span>
<span class="nc" id="L229">        STRAT_MECH.append(STRAT_BASERECT, false);</span>
        
<span class="nc" id="L231">        STRAT_MECH.moveTo(-STRAT_CX-1.5*small, -SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L232">        STRAT_MECH.lineTo(-STRAT_CX-3.0*small,  SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L233">        STRAT_MECH.lineTo(-STRAT_CX+3.0*small,  SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L234">        STRAT_MECH.lineTo(-STRAT_CX+1.5*small, -SYMBOLSIZE.getHeight()/4);</span>
<span class="nc" id="L235">        STRAT_MECH.closePath();</span>
        
<span class="nc" id="L237">        STRAT_AERO = new Path2D.Double();</span>
<span class="nc" id="L238">        STRAT_AERO.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L239">        double rad = SYMBOLSIZE.getWidth()/5;</span>
<span class="nc" id="L240">        double r72 = Math.toRadians(72);</span>
<span class="nc" id="L241">        STRAT_AERO.moveTo(-STRAT_CX+rad/3*Math.cos(Math.PI/2+2*r72), rad/3*Math.sin(Math.PI/2+2*r72));</span>
<span class="nc" id="L242">        STRAT_AERO.lineTo(-STRAT_CX+rad*Math.cos(Math.PI/2+1*r72), -rad*Math.sin(Math.PI/2+1*r72));</span>
<span class="nc" id="L243">        STRAT_AERO.lineTo(-STRAT_CX+rad/3*Math.cos(Math.PI/2+1*r72), rad/3*Math.sin(Math.PI/2+1*r72));</span>
<span class="nc" id="L244">        STRAT_AERO.lineTo(-STRAT_CX+rad*Math.cos(Math.PI/2+2*r72), -rad*Math.sin(Math.PI/2+2*r72));</span>
<span class="nc" id="L245">        STRAT_AERO.lineTo(-STRAT_CX+rad/3*Math.cos(Math.PI/2), rad/3*Math.sin(Math.PI/2));</span>
<span class="nc" id="L246">        STRAT_AERO.lineTo(-STRAT_CX+rad*Math.cos(Math.PI/2+3*r72), -rad*Math.sin(Math.PI/2+3*r72));</span>
<span class="nc" id="L247">        STRAT_AERO.lineTo(-STRAT_CX+rad/3*Math.cos(Math.PI/2+4*r72), rad/3*Math.sin(Math.PI/2+4*r72));</span>
<span class="nc" id="L248">        STRAT_AERO.lineTo(-STRAT_CX+rad*Math.cos(Math.PI/2+4*r72), -rad*Math.sin(Math.PI/2+4*r72));</span>
<span class="nc" id="L249">        STRAT_AERO.lineTo(-STRAT_CX+rad/3*Math.cos(Math.PI/2+3*r72), rad/3*Math.sin(Math.PI/2+3*r72));</span>
<span class="nc" id="L250">        STRAT_AERO.lineTo(-STRAT_CX+rad*Math.cos(Math.PI/2),       -rad*Math.sin(Math.PI/2));</span>
<span class="nc" id="L251">        STRAT_AERO.closePath();</span>
        
<span class="nc" id="L253">        STRAT_SPHEROID = new Path2D.Double();</span>
<span class="nc" id="L254">        STRAT_SPHEROID.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L255">        STRAT_SPHEROID.moveTo(rad*Math.cos(Math.PI/2),       -rad*Math.sin(Math.PI/2));</span>
<span class="nc" id="L256">        STRAT_SPHEROID.lineTo(rad*Math.cos(Math.PI/2+r72),   -rad*Math.sin(Math.PI/2+r72));</span>
<span class="nc" id="L257">        STRAT_SPHEROID.lineTo(rad*Math.cos(Math.PI/2+2*r72), -rad*Math.sin(Math.PI/2+2*r72));</span>
<span class="nc" id="L258">        STRAT_SPHEROID.lineTo(rad*Math.cos(Math.PI/2+3*r72), -rad*Math.sin(Math.PI/2+3*r72));</span>
<span class="nc" id="L259">        STRAT_SPHEROID.lineTo(rad*Math.cos(Math.PI/2+4*r72), -rad*Math.sin(Math.PI/2+4*r72));</span>
<span class="nc" id="L260">        STRAT_SPHEROID.closePath();</span>
        
<span class="nc" id="L262">        STRAT_HOVER = new Path2D.Double();</span>
<span class="nc" id="L263">        STRAT_HOVER.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L264">        STRAT_HOVER.moveTo(-SYMBOLSIZE.getWidth()/3,  small);</span>
<span class="nc" id="L265">        STRAT_HOVER.lineTo(-SYMBOLSIZE.getWidth()/3, -small);</span>
<span class="nc" id="L266">        STRAT_HOVER.lineTo( SYMBOLSIZE.getWidth()/3, -small);</span>
<span class="nc" id="L267">        STRAT_HOVER.lineTo( SYMBOLSIZE.getWidth()/3,  small);</span>

<span class="nc" id="L269">        STRAT_HOVER.moveTo(-SYMBOLSIZE.getWidth()/6, -small);</span>
<span class="nc" id="L270">        STRAT_HOVER.lineTo(-SYMBOLSIZE.getWidth()/6, +small);</span>
<span class="nc" id="L271">        STRAT_HOVER.moveTo(0, -small);</span>
<span class="nc" id="L272">        STRAT_HOVER.lineTo(0, +small);</span>
<span class="nc" id="L273">        STRAT_HOVER.moveTo( SYMBOLSIZE.getWidth()/6, -small);</span>
<span class="nc" id="L274">        STRAT_HOVER.lineTo( SYMBOLSIZE.getWidth()/6, +small);</span>
        
<span class="nc" id="L276">        STRAT_WHEELED = new Path2D.Double();</span>
<span class="nc" id="L277">        STRAT_WHEELED.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L278">        double smallr = SYMBOLSIZE.getWidth()/17;</span>
<span class="nc" id="L279">        STRAT_WHEELED.moveTo(-STRAT_CX-smallr*2, -smallr);</span>
<span class="nc" id="L280">        STRAT_WHEELED.lineTo(+STRAT_CX+smallr*2, -smallr);</span>
<span class="nc" id="L281">        STRAT_WHEELED.moveTo(-STRAT_CX, -smallr);</span>
<span class="nc" id="L282">        STRAT_WHEELED.lineTo(-STRAT_CX-smallr, 0);</span>
<span class="nc" id="L283">        STRAT_WHEELED.lineTo(-STRAT_CX, +smallr);</span>
<span class="nc" id="L284">        STRAT_WHEELED.lineTo(-STRAT_CX+smallr, 0);</span>
<span class="nc" id="L285">        STRAT_WHEELED.closePath();</span>
<span class="nc" id="L286">        STRAT_WHEELED.moveTo( STRAT_CX, -smallr);</span>
<span class="nc" id="L287">        STRAT_WHEELED.lineTo( STRAT_CX-smallr, 0);</span>
<span class="nc" id="L288">        STRAT_WHEELED.lineTo( STRAT_CX, +smallr);</span>
<span class="nc" id="L289">        STRAT_WHEELED.lineTo( STRAT_CX+smallr, 0);</span>
<span class="nc" id="L290">        STRAT_WHEELED.closePath();</span>
<span class="nc" id="L291">        STRAT_WHEELED.moveTo(0, -smallr);</span>
<span class="nc" id="L292">        STRAT_WHEELED.lineTo(-smallr, 0);</span>
<span class="nc" id="L293">        STRAT_WHEELED.lineTo(0, +smallr);</span>
<span class="nc" id="L294">        STRAT_WHEELED.lineTo(smallr, 0);</span>
<span class="nc" id="L295">        STRAT_WHEELED.closePath();</span>
        
<span class="nc" id="L297">        STRAT_NAVAL = new Path2D.Double();</span>
<span class="nc" id="L298">        STRAT_NAVAL.append(STRAT_BASERECT, false);</span>
<span class="nc" id="L299">        STRAT_NAVAL.moveTo(0, -SYMBOLSIZE.getHeight()/3);</span>
<span class="nc" id="L300">        STRAT_NAVAL.lineTo(0,  SYMBOLSIZE.getHeight()/3);</span>
<span class="nc" id="L301">        STRAT_NAVAL.moveTo(-STRAT_CX/2, -SYMBOLSIZE.getHeight()/5);</span>
<span class="nc" id="L302">        STRAT_NAVAL.lineTo( STRAT_CX/2, -SYMBOLSIZE.getHeight()/5);</span>
        
<span class="nc" id="L304">        STRAT_NAVAL.moveTo(rad, 0);</span>
<span class="nc" id="L305">        STRAT_NAVAL.curveTo(</span>
<span class="nc" id="L306">                rad*0.8, SYMBOLSIZE.getHeight()/3*0.8,</span>
<span class="nc" id="L307">                rad*0.8, SYMBOLSIZE.getHeight()/3*0.8,</span>
<span class="nc" id="L308">                0, SYMBOLSIZE.getHeight()/3);</span>
<span class="nc" id="L309">        STRAT_NAVAL.curveTo(</span>
<span class="nc" id="L310">                -rad*0.8, SYMBOLSIZE.getHeight()/3*0.8,</span>
<span class="nc" id="L311">                -rad*0.8, SYMBOLSIZE.getHeight()/3*0.8,</span>
                -rad, 0);
<span class="nc" id="L313">    }</span>
    
    // are we drag-scrolling?
<span class="nc" id="L316">    private boolean dragging = false;</span>

    /**
     * Creates and lays out a new mech display.
     */
<span class="nc" id="L321">    public MiniMap(Container d, IGame g, IBoardView bview) throws IOException {</span>
<span class="nc" id="L322">        m_game = g;</span>
<span class="nc" id="L323">        m_bview = bview;</span>
<span class="nc" id="L324">        m_dialog = d;</span>
<span class="nc" id="L325">        m_board = m_game.getBoard();</span>
<span class="nc" id="L326">        m_bview.addBoardViewListener(boardViewListener);</span>
<span class="nc" id="L327">        m_game.addGameListener(gameListener);</span>
<span class="nc" id="L328">        m_board.addBoardListener(boardListener);</span>
<span class="nc" id="L329">        initialize();</span>
<span class="nc" id="L330">    }</span>

<span class="nc" id="L332">    public MiniMap(Container d, IBoard b) throws IOException {</span>
<span class="nc" id="L333">        m_dialog = d;</span>
<span class="nc" id="L334">        m_board = b;</span>
<span class="nc" id="L335">        initialize();</span>
<span class="nc" id="L336">    }</span>

    public MiniMap(Container d, ClientGUI c, IBoardView bview) throws IOException {
<span class="nc" id="L339">        this(d, c.getClient().getGame(), bview);</span>
<span class="nc" id="L340">        clientgui = c;</span>

        // this may come in useful later...
<span class="nc" id="L343">        m_client = c.getClient();</span>
<span class="nc bnc" id="L344" title="All 4 branches missed.">        assert (m_client != null);</span>
<span class="nc" id="L345">    }</span>

    public void setBoard(IBoard board) {
<span class="nc" id="L348">        m_board = board;</span>
<span class="nc" id="L349">        initializeMap();</span>
<span class="nc" id="L350">    }</span>

    private void initialize() throws IOException {
<span class="nc" id="L353">        initializeColors();</span>
<span class="nc" id="L354">        addMouseListener(mouseListener);</span>
<span class="nc" id="L355">        addMouseMotionListener(mouseMotionListener);</span>
<span class="nc" id="L356">        addMouseWheelListener(mouseWheelListener);</span>
<span class="nc" id="L357">        addComponentListener(componentListener);</span>
<span class="nc" id="L358">        m_dialog.addComponentListener(componentListener);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (m_dialog instanceof JDialog) {</span>
<span class="nc" id="L360">            buttonHeight = 14;</span>
<span class="nc" id="L361">            ((JDialog) m_dialog).setResizable(false);</span>

            // TODO: replace this quick-and-dirty with some real size
            // calculator.
<span class="nc" id="L365">            Dimension size = getSize();</span>
<span class="nc" id="L366">            boolean updateSize = false;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            if (size.width &lt; GUIPreferences.getInstance().getMinimumSizeWidth()) {</span>
<span class="nc" id="L368">                size.width = GUIPreferences.getInstance().getMinimumSizeWidth();</span>
<span class="nc" id="L369">                updateSize = true;</span>
            }
<span class="nc" id="L371">            if (size.height &lt; GUIPreferences.getInstance()</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">                                            .getMinimumSizeHeight()) {</span>
<span class="nc" id="L373">                size.height = GUIPreferences.getInstance()</span>
<span class="nc" id="L374">                                            .getMinimumSizeHeight();</span>
<span class="nc" id="L375">                updateSize = true;</span>
            }
<span class="nc bnc" id="L377" title="All 2 branches missed.">            if (updateSize) {</span>
<span class="nc" id="L378">                setSize(size);</span>
            }
<span class="nc" id="L380">            setLocation(GUIPreferences.getInstance().getMinimapPosX(),</span>
<span class="nc" id="L381">                        GUIPreferences.getInstance().getMinimapPosY());</span>

<span class="nc" id="L383">            ((JDialog) m_dialog).pack();</span>
        }
<span class="nc" id="L385">    }</span>

    @Override
    public synchronized void update(Graphics g) {
<span class="nc" id="L389">        paint(g);</span>
<span class="nc" id="L390">    }</span>

    @Override
    public void paint(Graphics g) {
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (m_mapImage != null) {</span>
<span class="nc" id="L395">            g.drawImage(m_mapImage, 0, 0, this);</span>
            // drawBox(g); this would be a nice place to draw a visible-area box
<span class="nc" id="L397">            paintBVSection(g); // Happy to oblige</span>
        }
<span class="nc" id="L399">    }</span>

    /**
     * Initialize default colours and override with config file if there is one.
     */
    private void initializeColors() throws IOException {

        // set up defaults -- this might go away later...
<span class="nc" id="L407">        BACKGROUND = Color.black;</span>
<span class="nc" id="L408">        m_terrainColors[0] = new Color(218, 215, 170);</span>
<span class="nc" id="L409">        SINKHOLE = new Color(218, 215, 170);</span>
<span class="nc" id="L410">        m_terrainColors[Terrains.WOODS] = new Color(180, 230, 130);</span>
<span class="nc" id="L411">        HEAVY_WOODS = new Color(160, 200, 100);</span>
<span class="nc" id="L412">        ULTRA_HEAVY_WOODS = new Color(0, 100, 0);</span>
<span class="nc" id="L413">        m_terrainColors[Terrains.ROUGH] = new Color(215, 181, 0);</span>
<span class="nc" id="L414">        m_terrainColors[Terrains.RUBBLE] = new Color(200, 200, 200);</span>
<span class="nc" id="L415">        m_terrainColors[Terrains.WATER] = new Color(200, 247, 253);</span>
<span class="nc" id="L416">        m_terrainColors[Terrains.PAVEMENT] = new Color(204, 204, 204);</span>
<span class="nc" id="L417">        m_terrainColors[Terrains.ROAD] = new Color(71, 79, 107);</span>
<span class="nc" id="L418">        m_terrainColors[Terrains.FIRE] = Color.red;</span>
<span class="nc" id="L419">        m_terrainColors[Terrains.SMOKE] = new Color(204, 204, 204);</span>
<span class="nc" id="L420">        SMOKE_AND_FIRE = new Color(153, 0, 0);</span>
<span class="nc" id="L421">        m_terrainColors[Terrains.SWAMP] = new Color(49, 136, 74);</span>
<span class="nc" id="L422">        m_terrainColors[Terrains.BUILDING] = new Color(204, 204, 204);</span>
<span class="nc" id="L423">        m_terrainColors[Terrains.FUEL_TANK] = new Color(255, 204, 204);</span>
<span class="nc" id="L424">        m_terrainColors[Terrains.BRIDGE] = new Color(109, 55, 25);</span>
<span class="nc" id="L425">        m_terrainColors[Terrains.ICE] = new Color(204, 204, 255);</span>
<span class="nc" id="L426">        m_terrainColors[Terrains.MAGMA] = new Color(200, 0, 0);</span>
        //m_terrainColors[Terrains.MUD] = new Color(218, 160, 100);
<span class="nc" id="L428">        m_terrainColors[Terrains.JUNGLE] = new Color(180, 230, 130);</span>
<span class="nc" id="L429">        m_terrainColors[Terrains.FIELDS] = new Color(250, 255, 205);</span>
<span class="nc" id="L430">        m_terrainColors[Terrains.INDUSTRIAL] = new Color(112, 138, 144);</span>
<span class="nc" id="L431">        m_terrainColors[Terrains.SPACE] = Color.gray;</span>

        // now try to read in the config file
        int red;
        int green;
        int blue;

<span class="nc" id="L438">        File coloursFile = new MegaMekFile(</span>
<span class="nc" id="L439">                Configuration.hexesDir(), GUIPreferences.getInstance().getMinimapColours()</span>
<span class="nc" id="L440">        ).getFile();</span>

        // only while the defaults are hard-coded!
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (!coloursFile.exists()) {</span>
<span class="nc" id="L444">            return;</span>
        }

<span class="nc" id="L447">        Reader cr = new FileReader(coloursFile);</span>
<span class="nc" id="L448">        StreamTokenizer st = new StreamTokenizer(cr);</span>

<span class="nc" id="L450">        st.lowerCaseMode(true);</span>
<span class="nc" id="L451">        st.quoteChar('&quot;');</span>
<span class="nc" id="L452">        st.commentChar('#');</span>

        scan:
        while (true) {
<span class="nc" id="L456">            red = 0;</span>
<span class="nc" id="L457">            green = 0;</span>
<span class="nc" id="L458">            blue = 0;</span>

<span class="nc bnc" id="L460" title="All 4 branches missed.">            switch (st.nextToken()) {</span>
                case StreamTokenizer.TT_EOF:
<span class="nc" id="L462">                    break scan;</span>
                case StreamTokenizer.TT_EOL:
<span class="nc" id="L464">                    break scan;</span>
                case StreamTokenizer.TT_WORD:
                    // read in
<span class="nc" id="L467">                    String key = st.sval;</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                    if (key.equals(&quot;unitsize&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L469">                        st.nextToken();</span>
<span class="nc" id="L470">                        unitSize = (int) st.nval;</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">                    } else if (key.equals(&quot;background&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L472">                        st.nextToken();</span>
<span class="nc" id="L473">                        red = (int) st.nval;</span>
<span class="nc" id="L474">                        st.nextToken();</span>
<span class="nc" id="L475">                        green = (int) st.nval;</span>
<span class="nc" id="L476">                        st.nextToken();</span>
<span class="nc" id="L477">                        blue = (int) st.nval;</span>

<span class="nc" id="L479">                        BACKGROUND = new Color(red, green, blue);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                    } else if (key.equals(&quot;heavywoods&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L481">                        st.nextToken();</span>
<span class="nc" id="L482">                        red = (int) st.nval;</span>
<span class="nc" id="L483">                        st.nextToken();</span>
<span class="nc" id="L484">                        green = (int) st.nval;</span>
<span class="nc" id="L485">                        st.nextToken();</span>
<span class="nc" id="L486">                        blue = (int) st.nval;</span>

<span class="nc" id="L488">                        HEAVY_WOODS = new Color(red, green, blue);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                    } else if (key.equals(&quot;ultraheavywoods&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L490">                        st.nextToken();</span>
<span class="nc" id="L491">                        red = (int) st.nval;</span>
<span class="nc" id="L492">                        st.nextToken();</span>
<span class="nc" id="L493">                        green = (int) st.nval;</span>
<span class="nc" id="L494">                        st.nextToken();</span>
<span class="nc" id="L495">                        blue = (int) st.nval;</span>

<span class="nc" id="L497">                        ULTRA_HEAVY_WOODS = new Color(red, green, blue);</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                    } else if (key.equals(&quot;sinkhole&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L499">                        st.nextToken();</span>
<span class="nc" id="L500">                        red = (int) st.nval;</span>
<span class="nc" id="L501">                        st.nextToken();</span>
<span class="nc" id="L502">                        green = (int) st.nval;</span>
<span class="nc" id="L503">                        st.nextToken();</span>
<span class="nc" id="L504">                        blue = (int) st.nval;</span>

<span class="nc" id="L506">                        SINKHOLE = new Color(red, green, blue);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                    } else if (key.equals(&quot;smokeandfire&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L508">                        st.nextToken();</span>
<span class="nc" id="L509">                        red = (int) st.nval;</span>
<span class="nc" id="L510">                        st.nextToken();</span>
<span class="nc" id="L511">                        green = (int) st.nval;</span>
<span class="nc" id="L512">                        st.nextToken();</span>
<span class="nc" id="L513">                        blue = (int) st.nval;</span>

<span class="nc" id="L515">                        SMOKE_AND_FIRE = new Color(red, green, blue);</span>
                    } else {
<span class="nc" id="L517">                        st.nextToken();</span>
<span class="nc" id="L518">                        red = (int) st.nval;</span>
<span class="nc" id="L519">                        st.nextToken();</span>
<span class="nc" id="L520">                        green = (int) st.nval;</span>
<span class="nc" id="L521">                        st.nextToken();</span>
<span class="nc" id="L522">                        blue = (int) st.nval;</span>

<span class="nc" id="L524">                        m_terrainColors[Terrains.getType(key)] = new Color(red,</span>
                                                                           green, blue);
                    }
            }
        }

<span class="nc" id="L530">        cr.close();</span>
<span class="nc" id="L531">    }</span>

    private void clean() {
<span class="nc" id="L534">        dirtyMap = false;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">        for (int i = 0; i &lt; dirty.length; i++) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">            for (int j = 0; j &lt; dirty[i].length; j++) {</span>
<span class="nc" id="L537">                dirty[i][j] = false;</span>
            }
        }
<span class="nc" id="L540">    }</span>

    void initializeMap() {

        // sanity check (cfg file could be hosed)
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (zoom &lt; 0) {</span>
<span class="nc" id="L546">            zoom = 0;</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        } else if (zoom &gt; (hexSide.length - 1)) {</span>
<span class="nc" id="L548">            zoom = (hexSide.length - 1);</span>
        }

        int requiredWidth, requiredHeight;
<span class="nc" id="L552">        int currentHexSide = hexSide[zoom];</span>
<span class="nc" id="L553">        int currentHexSideByCos30 = hexSideByCos30[zoom];</span>
<span class="nc" id="L554">        int currentHexSideBySin30 = hexSideBySin30[zoom];</span>
<span class="nc" id="L555">        topMargin = margin;</span>
<span class="nc" id="L556">        leftMargin = margin;</span>
<span class="nc" id="L557">        requiredWidth = (m_board.getWidth()</span>
                         * (currentHexSide + currentHexSideBySin30))
                        + currentHexSideBySin30 + (2 * margin);
<span class="nc" id="L560">        requiredHeight = (((2 * m_board.getHeight()) + 1)</span>
                          * currentHexSideByCos30) + (2 * margin) + buttonHeight;

<span class="nc" id="L563">        dirty = new boolean[(m_board.getWidth() / 10) + 1][(m_board.getHeight() / 10) + 1];</span>
<span class="nc" id="L564">        dirtyMap = true;</span>
        
<span class="nc" id="L566">        unitSize = unitSizes[zoom];</span>

        // ensure its on screen
<span class="nc" id="L569">        Rectangle virtualBounds = new Rectangle();</span>
        GraphicsEnvironment ge = GraphicsEnvironment
<span class="nc" id="L571">                .getLocalGraphicsEnvironment();</span>
<span class="nc" id="L572">        GraphicsDevice[] gs = ge.getScreenDevices();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        for (int j = 0; j &lt; gs.length; j++) {</span>
<span class="nc" id="L574">            GraphicsDevice gd = gs[j];</span>
<span class="nc" id="L575">            GraphicsConfiguration[] gc = gd.getConfigurations();</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">            for (int i = 0; i &lt; gc.length; i++) {</span>
<span class="nc" id="L577">                virtualBounds = virtualBounds.union(gc[i].getBounds());</span>
            }
        }
        // zoom out if its too big for the screen
<span class="nc bnc" id="L581" title="All 6 branches missed.">        while ((zoom &gt; 0)</span>
               &amp;&amp; ((requiredWidth &gt; virtualBounds.width) || (requiredHeight &gt; virtualBounds.height))) {
<span class="nc" id="L583">            zoom--;</span>
<span class="nc" id="L584">            currentHexSide = hexSide[zoom];</span>
<span class="nc" id="L585">            currentHexSideByCos30 = hexSideByCos30[zoom];</span>
<span class="nc" id="L586">            currentHexSideBySin30 = hexSideBySin30[zoom];</span>
<span class="nc" id="L587">            requiredWidth = (m_board.getWidth()</span>
                             * (currentHexSide + currentHexSideBySin30))
                            + currentHexSideBySin30 + (2 * margin);
<span class="nc" id="L590">            requiredHeight = (((2 * m_board.getHeight()) + 1)</span>
                              * currentHexSideByCos30) + (2 * margin) + buttonHeight;
        }
<span class="nc" id="L593">        int x = getParent().getLocation().x;</span>
<span class="nc" id="L594">        int y = getParent().getLocation().y;</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if ((x + requiredWidth) &gt; virtualBounds.getMaxX()) {</span>
<span class="nc" id="L596">            x = (int) (virtualBounds.getMaxX() - requiredWidth);</span>
        }
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (x &lt; virtualBounds.getMinX()) {</span>
<span class="nc" id="L599">            x = (int) (virtualBounds.getMinX());</span>
        }
<span class="nc bnc" id="L601" title="All 2 branches missed.">        if ((y + requiredHeight) &gt; virtualBounds.getMaxY()) {</span>
<span class="nc" id="L602">            y = (int) (virtualBounds.getMaxY() - requiredHeight);</span>
        }
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (y &lt; virtualBounds.getMinY()) {</span>
<span class="nc" id="L605">            y = (int) (virtualBounds.getMinY());</span>
        }
<span class="nc" id="L607">        getParent().setLocation(x, y);</span>
<span class="nc" id="L608">        int xTemp = requiredWidth;</span>
<span class="nc" id="L609">        int yTemp = requiredHeight;</span>

<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (m_dialog instanceof JScrollPane) {</span>
            //For the scrollPane, enforce the minimum size.
<span class="nc bnc" id="L613" title="All 2 branches missed.">            if (requiredWidth &lt; SCROLL_PANE_WIDTH) {</span>
<span class="nc" id="L614">                xTemp = SCROLL_PANE_WIDTH;</span>
            }
<span class="nc bnc" id="L616" title="All 2 branches missed.">            if (requiredHeight &lt; SCROLL_PANE_HEIGHT) {</span>
<span class="nc" id="L617">                yTemp = SCROLL_PANE_HEIGHT;</span>
            }
        }
        
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (minimized) {</span>
<span class="nc" id="L622">            yTemp = 14;</span>
        }
        
<span class="nc" id="L625">        setSize(xTemp, yTemp);</span>
<span class="nc" id="L626">        setPreferredSize(new Dimension(xTemp, yTemp));</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (m_dialog instanceof JDialog) {</span>
<span class="nc" id="L628">            ((JDialog) m_dialog).pack();</span>
        }
        // m_dialog.setVisible(true);
<span class="nc" id="L631">        m_mapImage = ImageUtil.createAcceleratedImage(getSize().width, getSize().height);</span>

<span class="nc" id="L633">        terrainBuffer = createImage(getSize().width, getSize().height);</span>
<span class="nc" id="L634">        Graphics gg = terrainBuffer.getGraphics();</span>
<span class="nc" id="L635">        gg.setColor(BACKGROUND);</span>
<span class="nc" id="L636">        gg.fillRect(0, 0, getSize().width, getSize().height);</span>

<span class="nc bnc" id="L638" title="All 2 branches missed.">        if (getSize().width &gt; requiredWidth) {</span>
<span class="nc" id="L639">            leftMargin = ((getSize().width - requiredWidth) / 2) + margin;</span>
        }
<span class="nc bnc" id="L641" title="All 2 branches missed.">        if (getSize().height &gt; requiredHeight) {</span>
<span class="nc" id="L642">            topMargin = ((getSize().height - requiredHeight) / 2) + margin;</span>
        }
<span class="nc" id="L644">        drawMap();</span>
<span class="nc" id="L645">        revalidate();</span>
<span class="nc" id="L646">    }</span>

<span class="nc" id="L648">    protected long lastDrawMapReq = 0;</span>
<span class="nc" id="L649">    protected long lastDrawStarted = 0;</span>
<span class="nc" id="L650">    protected Runnable drawMapable = new Runnable() {</span>
<span class="nc" id="L651">        protected final int redrawDelay = 0;</span>

        public void run() {
            try {
<span class="nc bnc" id="L655" title="All 2 branches missed.">                if ((System.currentTimeMillis() - lastDrawMapReq) &gt; redrawDelay) {</span>
<span class="nc" id="L656">                    drawMapOrig();</span>
                } else {
                    try {
<span class="nc" id="L659">                        Thread.sleep(50);</span>
<span class="nc" id="L660">                    } catch (InterruptedException ie) {</span>
                        // should never happen
<span class="nc" id="L662">                    }</span>
<span class="nc" id="L663">                    SwingUtilities.invokeLater(drawMapable);</span>
                }
<span class="nc" id="L665">            } catch (Throwable t) {</span>
<span class="nc" id="L666">                t.printStackTrace();</span>
<span class="nc" id="L667">            }</span>
<span class="nc" id="L668">        }</span>
    };

    /**
     * this replaces the original drawmap to speed up updates this can be called
     * any time necessary
     */
    public synchronized void drawMap() {
<span class="nc" id="L676">        lastDrawMapReq = System.currentTimeMillis();</span>
<span class="nc" id="L677">        SwingUtilities.invokeLater(drawMapable);</span>
<span class="nc" id="L678">    }</span>

    /**
     * update the backbuffer and repaint.. should not require a synchronized but
     * i left it there anyways
     */
    protected synchronized void drawMapOrig() {
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (lastDrawStarted &gt; lastDrawMapReq) {</span>
<span class="nc" id="L686">            return;</span>
        }
<span class="nc" id="L688">        lastDrawStarted = System.currentTimeMillis();</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (m_mapImage == null) {</span>
<span class="nc" id="L690">            return;</span>
        }

<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (!m_dialog.isVisible()) {</span>
<span class="nc" id="L694">            return;</span>
        }

<span class="nc" id="L697">        Graphics g = m_mapImage.getGraphics();</span>
        // Activate AA
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getAntiAliasing()) {</span>
<span class="nc" id="L700">            ((Graphics2D)g).setRenderingHint(</span>
                    RenderingHints.KEY_ANTIALIASING,
                    RenderingHints.VALUE_ANTIALIAS_ON);
        }
        
<span class="nc" id="L705">        Color oldColor = g.getColor();</span>
<span class="nc" id="L706">        g.setColor(oldColor);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (!minimized) {</span>
<span class="nc" id="L708">            roadHexIndexes.removeAllElements();</span>
<span class="nc" id="L709">            Graphics gg = terrainBuffer.getGraphics();</span>
            // Activate AA
<span class="nc bnc" id="L711" title="All 2 branches missed.">            if (GUIPreferences.getInstance().getAntiAliasing()) {</span>
<span class="nc" id="L712">                ((Graphics2D)gg).setRenderingHint(</span>
                        RenderingHints.KEY_ANTIALIASING,
                        RenderingHints.VALUE_ANTIALIAS_ON);
            }
<span class="nc bnc" id="L716" title="All 2 branches missed.">            for (int j = 0; j &lt; m_board.getWidth(); j++) {</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                for (int k = 0; k &lt; m_board.getHeight(); k++) {</span>
<span class="nc" id="L718">                    IHex h = m_board.getHex(j, k);</span>
<span class="nc bnc" id="L719" title="All 4 branches missed.">                    if (dirtyMap || dirty[j / 10][k / 10]) {</span>
<span class="nc" id="L720">                        gg.setColor(terrainColor(h, j, k));</span>
<span class="nc" id="L721">                        paintCoord(gg, j, k, true);</span>
                    }
<span class="nc" id="L723">                    addRoadElements(h, j, k);</span>
                    // Color invalid hexes red when in the Map Editor
<span class="nc bnc" id="L725" title="All 2 branches missed.">                    if ((m_game != null) &amp;&amp; </span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                            (m_game.getPhase() == IGame.Phase.PHASE_UNKNOWN)</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">                            &amp;&amp; !h.isValid(null)) {</span>
<span class="nc" id="L728">                        gg.setColor(GUIPreferences.getInstance().getWarningColor());</span>
<span class="nc" id="L729">                        paintCoord(gg, j, k, true);</span>
                    }
                }
            }
            // draw backbuffer
<span class="nc" id="L734">            g.drawImage(terrainBuffer, 0, 0, this);</span>

<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (firstLOS != null) {</span>
<span class="nc" id="L737">                paintSingleCoordBorder(g, firstLOS.getX(), firstLOS.getY(), Color.red);</span>
            }
<span class="nc bnc" id="L739" title="All 2 branches missed.">            if (secondLOS != null) {</span>
<span class="nc" id="L740">                paintSingleCoordBorder(g, secondLOS.getX(), secondLOS.getY(), Color.red);</span>
            }

<span class="nc bnc" id="L743" title="All 2 branches missed.">            if (!roadHexIndexes.isEmpty()) {</span>
<span class="nc" id="L744">                paintRoads(g);</span>
            }

<span class="nc bnc" id="L747" title="All 2 branches missed.">            if (SHOW_NO_HEIGHT != heightDisplayMode) {</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">                for (int j = 0; j &lt; m_board.getWidth(); j++) {</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">                    for (int k = 0; k &lt; m_board.getHeight(); k++) {</span>
<span class="nc" id="L750">                        IHex h = m_board.getHex(j, k);</span>
<span class="nc" id="L751">                        paintHeight(g, h, j, k);</span>
                    }
                }
            }

            // draw Drop Zone
<span class="nc bnc" id="L757" title="All 4 branches missed.">            if ((null != m_client) &amp;&amp; (null != m_game)) { // sanity check!</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">                if (IGame.Phase.PHASE_DEPLOYMENT == m_game.getPhase()) {</span>
<span class="nc" id="L759">                    GameTurn turn = m_game.getTurn();</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">                    if ((turn != null)</span>
<span class="nc" id="L761">                        &amp;&amp; (turn.getPlayerNum() == m_client.getLocalPlayer()</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                                                           .getId())) {</span>
<span class="nc" id="L763">                        Entity depEnt = m_bview.getDeployingEntity();</span>
                        int dir;
                        // We need to draw the same deployment zone as boardview
<span class="nc bnc" id="L766" title="All 2 branches missed.">                        if (depEnt != null &amp;&amp;</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">                            depEnt.getOwnerId() == turn.getPlayerNum()) {</span>
<span class="nc" id="L768">                            dir = depEnt.getStartingPos();</span>
                        } else { // if we can't get the deploy zone from the 
                            // board view, punt and use the players zone
<span class="nc" id="L771">                            dir = m_client.getLocalPlayer().getStartingPos();</span>
                        }

<span class="nc bnc" id="L774" title="All 2 branches missed.">                        for (int j = 0; j &lt; m_board.getWidth(); j++) {</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">                            for (int k = 0; k &lt; m_board.getHeight(); k++) {</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">                                if (m_board.isLegalDeployment(</span>
                                        new Coords(j, k), dir)) {
<span class="nc" id="L778">                                    paintSingleCoordBorder(g, j, k,</span>
                                                           Color.yellow);
                                }
                            }
                        }
                    }
                }
                
                // draw declared fire
<span class="nc bnc" id="L787" title="All 2 branches missed.">                if ((IGame.Phase.PHASE_FIRING == m_game.getPhase())</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                    || (IGame.Phase.PHASE_PHYSICAL == m_game.getPhase())) {</span>
<span class="nc" id="L789">                    for (Enumeration&lt;EntityAction&gt; iter = m_game.getActions(); iter</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">                            .hasMoreElements(); ) {</span>
<span class="nc" id="L791">                        EntityAction action = iter.nextElement();</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">                        if (action instanceof AttackAction) {</span>
<span class="nc" id="L793">                            paintAttack(g, (AttackAction) action);</span>
                        }
<span class="nc" id="L795">                    }</span>
                }

<span class="nc" id="L798">                multiUnits.clear();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">                for (Entity e : m_game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">                    if (e.getPosition() == null) {</span>
<span class="nc" id="L801">                        continue;</span>
                    }
<span class="nc" id="L803">                    paintUnit(g, e);</span>
<span class="nc" id="L804">                }</span>
            }
<span class="nc" id="L806">            clean();</span>
        }

<span class="nc bnc" id="L809" title="All 4 branches missed.">        if ((m_client != null) &amp;&amp; (m_client.getArtilleryAutoHit() != null)) {</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">            for (int i = 0; i &lt; m_client.getArtilleryAutoHit().size(); i++) {</span>
<span class="nc" id="L811">                drawAutoHit(g, m_client.getArtilleryAutoHit().get(i));</span>
            }
        }

<span class="nc bnc" id="L815" title="All 2 branches missed.">        if (m_dialog instanceof JDialog) {</span>
<span class="nc" id="L816">            drawBtn(g);</span>
        }

<span class="nc" id="L819">        repaint();</span>
<span class="nc" id="L820">    }</span>
    
    private void paintBVSection(Graphics g) {
<span class="nc bnc" id="L823" title="All 4 branches missed.">        if (minimized || (m_bview == null)) {</span>
<span class="nc" id="L824">            return;</span>
        }
<span class="nc" id="L826">        double[] relSize = m_bview.getVisibleArea();</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">        for (int i=0;i&lt;4;i++) relSize[i] = Math.min(1, Math.max(0,relSize[i]));</span>
        
<span class="nc" id="L829">        Color sc = g.getColor();</span>
<span class="nc" id="L830">        Stroke sbs = ((Graphics2D) g).getStroke();</span>
        
        // thicker but translucent rect
<span class="nc" id="L833">        g.setColor(new Color(100,100,160,80));</span>
<span class="nc" id="L834">        ((Graphics2D) g).setStroke(new BasicStroke(zoom+2));</span>
        
<span class="nc" id="L836">        g.drawRect(</span>
<span class="nc" id="L837">                (int)(relSize[0]*             (hexSide[zoom] + hexSideBySin30[zoom])*m_board.getWidth())+leftMargin,</span>
<span class="nc" id="L838">                (int)(relSize[1]*2*hexSideByCos30[zoom]*m_board.getHeight())+topMargin,</span>
<span class="nc" id="L839">                (int)((relSize[2]-relSize[0])*(hexSide[zoom] + hexSideBySin30[zoom])*m_board.getWidth()),</span>
<span class="nc" id="L840">                (int)((relSize[3]-relSize[1])*2*hexSideByCos30[zoom]*m_board.getHeight()));</span>
        
        // thin less translucent rect
<span class="nc" id="L843">        g.setColor(new Color(255,255,255,180));</span>
<span class="nc" id="L844">        ((Graphics2D) g).setStroke(new BasicStroke(zoom/2));</span>

<span class="nc" id="L846">        g.drawRect(</span>
<span class="nc" id="L847">                (int)(relSize[0]*(hexSide[zoom] + hexSideBySin30[zoom])*m_board.getWidth())+leftMargin,</span>
<span class="nc" id="L848">                (int)(relSize[1]*2*hexSideByCos30[zoom]*m_board.getHeight())+topMargin,</span>
<span class="nc" id="L849">                (int)((relSize[2]-relSize[0])*(hexSide[zoom] + hexSideBySin30[zoom])*m_board.getWidth()),</span>
<span class="nc" id="L850">                (int)((relSize[3]-relSize[1])*2*hexSideByCos30[zoom]*m_board.getHeight()));</span>
        
        // restore values
<span class="nc" id="L853">        ((Graphics2D) g).setStroke(sbs);</span>
<span class="nc" id="L854">        g.setColor(sc);</span>
        
<span class="nc" id="L856">    }</span>

    /**
     * Draws a red crosshair for artillery autohit hexes (predesignated only).
     */
    private void drawAutoHit(Graphics g, Coords hex) {
<span class="nc" id="L862">        int baseX = (hex.getX() * (hexSide[zoom] + hexSideBySin30[zoom])) + leftMargin</span>
                    + hexSide[zoom];
<span class="nc" id="L864">        int baseY = (((2 * hex.getY()) + 1 + (hex.getX() % 2)) * hexSideByCos30[zoom])</span>
                    + topMargin;
<span class="nc" id="L866">        Color alt = g.getColor();</span>
<span class="nc" id="L867">        g.setColor(Color.RED);</span>
<span class="nc" id="L868">        g.drawOval(baseX - (unitSize - 1), baseY - (unitSize - 1),</span>
                   (2 * unitSize) - 2, (2 * unitSize) - 2);
<span class="nc" id="L870">        g.drawLine(baseX - unitSize - 1, baseY, (baseX - unitSize) + 3, baseY);</span>
<span class="nc" id="L871">        g.drawLine(baseX + unitSize + 1, baseY, (baseX + unitSize) - 3, baseY);</span>
<span class="nc" id="L872">        g.drawLine(baseX, baseY - unitSize - 1, baseX, (baseY - unitSize) + 3);</span>
<span class="nc" id="L873">        g.drawLine(baseX, baseY + unitSize + 1, baseX, (baseY + unitSize) - 3);</span>
<span class="nc" id="L874">        g.setColor(alt);</span>
<span class="nc" id="L875">    }</span>

    /**
     * Draws green JButton in the bottom to close and open mini map. Height of
     * button is fixed to 14pix.
     */
    private void drawBtn(Graphics g) {
<span class="nc" id="L882">        int[] xPoints = new int[3];</span>
<span class="nc" id="L883">        int[] yPoints = new int[3];</span>
<span class="nc" id="L884">        Color oldColor = g.getColor();</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if (minimized) {</span>
<span class="nc" id="L886">            xPoints[0] = Math.round((getSize().width - 11) / 2);</span>
<span class="nc" id="L887">            yPoints[0] = getSize().height - 10;</span>
<span class="nc" id="L888">            xPoints[1] = xPoints[0] + 11;</span>
<span class="nc" id="L889">            yPoints[1] = yPoints[0];</span>
<span class="nc" id="L890">            xPoints[2] = xPoints[0] + 6;</span>
<span class="nc" id="L891">            yPoints[2] = yPoints[0] + 5;</span>
        } else {
<span class="nc" id="L893">            xPoints[0] = Math.round((getSize().width - 11) / 2);</span>
<span class="nc" id="L894">            yPoints[0] = getSize().height - 4;</span>
<span class="nc" id="L895">            xPoints[1] = xPoints[0] + 11;</span>
<span class="nc" id="L896">            yPoints[1] = yPoints[0];</span>
<span class="nc" id="L897">            xPoints[2] = xPoints[0] + 5;</span>
<span class="nc" id="L898">            yPoints[2] = yPoints[0] - 5;</span>
        }
<span class="nc" id="L900">        g.setColor(Color.green.darker().darker());</span>
<span class="nc" id="L901">        g.fillRect(0, getSize().height - 14, getSize().width, 14);</span>
<span class="nc" id="L902">        g.setColor(Color.green.darker());</span>
<span class="nc" id="L903">        g.drawLine(0, getSize().height - 14, getSize().width,</span>
<span class="nc" id="L904">                   getSize().height - 14);</span>
<span class="nc" id="L905">        g.drawLine(0, getSize().height - 14, 0, getSize().height);</span>
<span class="nc" id="L906">        g.setColor(Color.black);</span>
<span class="nc" id="L907">        g.drawLine(0, getSize().height - 1, getSize().width,</span>
<span class="nc" id="L908">                   getSize().height - 1);</span>
<span class="nc" id="L909">        g.drawLine(getSize().width - 1, getSize().height - 14,</span>
<span class="nc" id="L910">                   getSize().width - 1, getSize().height);</span>
<span class="nc" id="L911">        g.setColor(Color.yellow);</span>
<span class="nc" id="L912">        g.fillPolygon(xPoints, yPoints, 3);</span>

        // drawing &quot;+&quot; and &quot;-&quot; buttons
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (!minimized) {</span>
<span class="nc" id="L916">            g.setColor(Color.black);</span>
<span class="nc" id="L917">            g.drawLine(14 - 1, getSize().height - 14, 14 - 1, getSize().height);</span>
<span class="nc" id="L918">            g.drawLine(getSize().width - 14 - 1, getSize().height - 14,</span>
<span class="nc" id="L919">                       getSize().width - 14 - 1, getSize().height);</span>
<span class="nc" id="L920">            g.setColor(Color.green.darker());</span>
<span class="nc" id="L921">            g.drawLine(14, getSize().height - 14, 14, getSize().height);</span>
<span class="nc" id="L922">            g.drawLine(getSize().width - 14, getSize().height - 14,</span>
<span class="nc" id="L923">                       getSize().width - 14, getSize().height);</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">            if (zoom == 0) {</span>
<span class="nc" id="L925">                g.setColor(Color.gray.brighter());</span>
            } else {
<span class="nc" id="L927">                g.setColor(Color.yellow);</span>
            }
<span class="nc" id="L929">            g.fillRect(3, (getSize().height - 14) + 6, 8, 2);</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">            if (zoom == (hexSide.length - 1)) {</span>
<span class="nc" id="L931">                g.setColor(Color.gray.brighter());</span>
            } else {
<span class="nc" id="L933">                g.setColor(Color.yellow);</span>
            }
<span class="nc" id="L935">            g.fillRect((getSize().width - 14) + 3, (getSize().height - 14) + 6, 8,</span>
                       2);
<span class="nc" id="L937">            g.fillRect((getSize().width - 14) + 6, (getSize().height - 14) + 3, 2,</span>
                       8);

<span class="nc bnc" id="L940" title="All 2 branches missed.">            if (zoom &gt; 2) {</span>
                // JButton for displying heights.
<span class="nc" id="L942">                g.setColor(Color.black);</span>
<span class="nc" id="L943">                g.drawLine(28 - 1, getSize().height - 14, 28 - 1,</span>
<span class="nc" id="L944">                           getSize().height);</span>
<span class="nc" id="L945">                g.setColor(Color.green.darker());</span>
<span class="nc" id="L946">                g.drawLine(28, getSize().height - 14, 28, getSize().height);</span>
<span class="nc" id="L947">                g.setColor(Color.yellow);</span>
                String label;
<span class="nc bnc" id="L949" title="All 5 branches missed.">                switch (heightDisplayMode) {</span>
                    case SHOW_NO_HEIGHT:
<span class="nc" id="L951">                        label = Messages.getString(&quot;MiniMap.NoHeightLabel&quot;); </span>
<span class="nc" id="L952">                        break;</span>
                    case SHOW_GROUND_HEIGHT:
<span class="nc" id="L954">                        label = Messages.getString(&quot;MiniMap.GroundHeightLabel&quot;);</span>
<span class="nc" id="L955">                        break;</span>
                    case SHOW_BUILDING_HEIGHT:
<span class="nc" id="L957">                        label = Messages.getString(&quot;MiniMap.BuildingHeightLabel&quot;); </span>
<span class="nc" id="L958">                        break;</span>
                    case SHOW_TOTAL_HEIGHT:
<span class="nc" id="L960">                        label = Messages.getString(&quot;MiniMap.TotalHeightLabel&quot;); </span>
<span class="nc" id="L961">                        break;</span>
                    default:
<span class="nc" id="L963">                        label = &quot;&quot;;</span>
                }
<span class="nc" id="L965">                g.drawString(label, 17, (getSize().height - 14) + 12);</span>
            }
        }

<span class="nc" id="L969">        g.setColor(oldColor);</span>

<span class="nc" id="L971">    }</span>

    private void paintHeight(Graphics g, IHex h, int x, int y) {
<span class="nc bnc" id="L974" title="All 2 branches missed.">        if (heightDisplayMode == SHOW_NO_HEIGHT) {</span>
<span class="nc" id="L975">            return;</span>
        }
<span class="nc bnc" id="L977" title="All 2 branches missed.">        if (zoom &gt; 2) {</span>
<span class="nc" id="L978">            int baseX = (x * (hexSide[zoom] + hexSideBySin30[zoom])) + leftMargin;</span>
<span class="nc" id="L979">            int baseY = (((2 * y) + 1 + (x % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
<span class="nc" id="L980">            g.setColor(Color.white);</span>
<span class="nc" id="L981">            int height = 0;</span>
<span class="nc bnc" id="L982" title="All 4 branches missed.">            if ((h.getTerrain(Terrains.BUILDING) != null)</span>
                &amp;&amp; (heightDisplayMode == SHOW_BUILDING_HEIGHT)) {
<span class="nc" id="L984">                height = h.ceiling();</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">            } else if (heightDisplayMode == SHOW_GROUND_HEIGHT) {</span>
<span class="nc" id="L986">                height = h.floor();</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">            } else if (heightDisplayMode == SHOW_TOTAL_HEIGHT) {</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">                height = ((h.getTerrain(Terrains.BUILDING) != null) || (h</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">                        .getTerrain(Terrains.FUEL_TANK) != null)) ? h.ceiling()</span>
<span class="nc" id="L990">                        : h.floor();</span>
            }
<span class="nc bnc" id="L992" title="All 2 branches missed.">            if (height != 0) {</span>
<span class="nc" id="L993">                g.drawString(height + &quot;&quot;, baseX + 5, baseY + 5); //$NON-NLS-1$</span>
            }
        }
<span class="nc" id="L996">    }</span>

    private void paintSingleCoordBorder(Graphics g, int x, int y, Color c) {
<span class="nc" id="L999">        int baseX = (x * (hexSide[zoom] + hexSideBySin30[zoom])) + leftMargin;</span>
<span class="nc" id="L1000">        int baseY = (((2 * y) + 1 + (x % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
<span class="nc" id="L1001">        int[] xPoints = new int[6];</span>
<span class="nc" id="L1002">        int[] yPoints = new int[6];</span>
<span class="nc" id="L1003">        xPoints[0] = baseX;</span>
<span class="nc" id="L1004">        yPoints[0] = baseY;</span>
<span class="nc" id="L1005">        xPoints[1] = baseX + hexSideBySin30[zoom];</span>
<span class="nc" id="L1006">        yPoints[1] = baseY + hexSideByCos30[zoom];</span>
<span class="nc" id="L1007">        xPoints[2] = xPoints[1] + hexSide[zoom];</span>
<span class="nc" id="L1008">        yPoints[2] = yPoints[1];</span>
<span class="nc" id="L1009">        xPoints[3] = xPoints[2] + hexSideBySin30[zoom];</span>
<span class="nc" id="L1010">        yPoints[3] = baseY;</span>
<span class="nc" id="L1011">        xPoints[4] = xPoints[2];</span>
<span class="nc" id="L1012">        yPoints[4] = baseY - hexSideByCos30[zoom];</span>
<span class="nc" id="L1013">        xPoints[5] = xPoints[1];</span>
<span class="nc" id="L1014">        yPoints[5] = yPoints[4];</span>
<span class="nc" id="L1015">        g.setColor(c);</span>
<span class="nc" id="L1016">        g.drawPolygon(xPoints, yPoints, 6);</span>
<span class="nc" id="L1017">    }</span>

    private void paintCoord(Graphics g, int x, int y, boolean border) {
<span class="nc" id="L1020">        int baseX = (x * (hexSide[zoom] + hexSideBySin30[zoom])) + leftMargin;</span>
<span class="nc" id="L1021">        int baseY = (((2 * y) + 1 + (x % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
<span class="nc" id="L1022">        int[] xPoints = new int[6];</span>
<span class="nc" id="L1023">        int[] yPoints = new int[6];</span>
<span class="nc" id="L1024">        xPoints[0] = baseX;</span>
<span class="nc" id="L1025">        yPoints[0] = baseY;</span>
<span class="nc" id="L1026">        xPoints[1] = baseX + hexSideBySin30[zoom];</span>
<span class="nc" id="L1027">        yPoints[1] = baseY + hexSideByCos30[zoom];</span>
<span class="nc" id="L1028">        xPoints[2] = xPoints[1] + hexSide[zoom];</span>
<span class="nc" id="L1029">        yPoints[2] = yPoints[1];</span>
<span class="nc" id="L1030">        xPoints[3] = xPoints[2] + hexSideBySin30[zoom];</span>
<span class="nc" id="L1031">        yPoints[3] = baseY;</span>
<span class="nc" id="L1032">        xPoints[4] = xPoints[2];</span>
<span class="nc" id="L1033">        yPoints[4] = baseY - hexSideByCos30[zoom];</span>
<span class="nc" id="L1034">        xPoints[5] = xPoints[1];</span>
<span class="nc" id="L1035">        yPoints[5] = yPoints[4];</span>
<span class="nc" id="L1036">        g.fillPolygon(xPoints, yPoints, 6);</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">        if (border) {</span>
<span class="nc" id="L1038">            Color oldColor = g.getColor();</span>
<span class="nc" id="L1039">            g.setColor(oldColor.darker());</span>
<span class="nc" id="L1040">            g.drawPolygon(xPoints, yPoints, 6);</span>
<span class="nc" id="L1041">            g.setColor(oldColor);</span>
        }
<span class="nc" id="L1043">    }</span>

    /**
     * Draw a line to represent an attack
     */
    private void paintAttack(Graphics g, AttackAction attack) {
<span class="nc" id="L1049">        Entity source = m_game.getEntity(attack.getEntityId());</span>
<span class="nc" id="L1050">        Targetable target = m_game.getTarget(attack.getTargetType(),</span>
<span class="nc" id="L1051">                attack.getTargetId());</span>
        // sanity check...
<span class="nc bnc" id="L1053" title="All 4 branches missed.">        if ((null == source) || (null == target)) {</span>
<span class="nc" id="L1054">            return;</span>
        }

<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (attack.getTargetType() == Targetable.TYPE_INARC_POD) {</span>
            // iNarc pods don't have a position, so lets scrap this idea, shall
            // we?
<span class="nc" id="L1060">            return;</span>
        }
<span class="nc bnc" id="L1062" title="All 2 branches missed.">        if (attack instanceof WeaponAttackAction) {</span>
<span class="nc" id="L1063">            WeaponAttackAction waa = (WeaponAttackAction) attack;</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">            if ((attack.getTargetType() == Targetable.TYPE_HEX_ARTILLERY)</span>
<span class="nc" id="L1065">                    &amp;&amp; (waa.getEntity(m_game).getOwner().getId() != m_client</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">                            .getLocalPlayer().getId())) {</span>
<span class="nc" id="L1067">                return;</span>
            }
        }
<span class="nc" id="L1070">        Color oldColor = g.getColor();</span>

<span class="nc" id="L1072">        int[] xPoints = new int[4];</span>
<span class="nc" id="L1073">        int[] yPoints = new int[4];</span>

<span class="nc" id="L1075">        xPoints[0] = ((source.getPosition().getX() * (hexSide[zoom] + hexSideBySin30[zoom]))</span>
                + leftMargin + ((int) 1.5 * hexSide[zoom])) - 2;
<span class="nc" id="L1077">        yPoints[0] = (((2 * source.getPosition().getY()) + 1 + (source</span>
<span class="nc" id="L1078">                .getPosition().getX() % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
<span class="nc" id="L1079">        xPoints[1] = ((target.getPosition().getX() * (hexSide[zoom] + hexSideBySin30[zoom]))</span>
                + leftMargin + ((int) 1.5 * hexSide[zoom])) - 2;
<span class="nc" id="L1081">        yPoints[1] = (((2 * target.getPosition().getY()) + 1 + (target</span>
<span class="nc" id="L1082">                .getPosition().getX() % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
<span class="nc" id="L1083">        xPoints[2] = xPoints[1] + 2;</span>
<span class="nc" id="L1084">        xPoints[3] = xPoints[0] + 2;</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">        if (((source.getPosition().getX() &gt; target.getPosition().getX()) &amp;&amp; (source</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                .getPosition().getY() &lt; target.getPosition().getY()))</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                || ((source.getPosition().getX() &lt; target.getPosition().getX()) &amp;&amp; (source</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">                        .getPosition().getY() &gt; target.getPosition().getY()))) {</span>
<span class="nc" id="L1089">            yPoints[3] = yPoints[0] + 2;</span>
<span class="nc" id="L1090">            yPoints[2] = yPoints[1] + 2;</span>
        } else {
<span class="nc" id="L1092">            yPoints[3] = yPoints[0] - 2;</span>
<span class="nc" id="L1093">            yPoints[2] = yPoints[1] - 2;</span>
        }
<span class="nc" id="L1095">        g.setColor(source.getOwner().getColour().getColour());</span>
<span class="nc" id="L1096">        g.fillPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1097">        g.setColor(Color.black);</span>
<span class="nc" id="L1098">        g.drawPolygon(xPoints, yPoints, 4);</span>

        // if this is mutual fire, draw a half-and-half line
<span class="nc" id="L1101">        for (Enumeration&lt;EntityAction&gt; iter = m_game.getActions(); iter</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">                .hasMoreElements();) {</span>
<span class="nc" id="L1103">            EntityAction action = iter.nextElement();</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">            if (action instanceof AttackAction) {</span>
<span class="nc" id="L1105">                AttackAction otherAttack = (AttackAction) action;</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">                if ((attack.getEntityId() == otherAttack.getTargetId())</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                        &amp;&amp; (otherAttack.getEntityId() == attack.getTargetId())) {</span>
                    // attackTarget _must_ be an entity since it's shooting back
                    // (?)
<span class="nc" id="L1110">                    Entity attackTarget = m_game.getEntity(otherAttack.getEntityId());</span>
<span class="nc" id="L1111">                    g.setColor(attackTarget.getOwner().getColour().getColour());</span>

<span class="nc" id="L1113">                    xPoints[0] = xPoints[3];</span>
<span class="nc" id="L1114">                    yPoints[0] = yPoints[3];</span>
<span class="nc" id="L1115">                    xPoints[1] = xPoints[2];</span>
<span class="nc" id="L1116">                    yPoints[1] = yPoints[2];</span>
<span class="nc" id="L1117">                    xPoints[2] = xPoints[1] + 2;</span>
<span class="nc" id="L1118">                    xPoints[3] = xPoints[0] + 2;</span>
<span class="nc" id="L1119">                    if (((source.getPosition().getX() &gt; target.getPosition()</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">                            .getX()) &amp;&amp; (source.getPosition().getY() &lt; target</span>
<span class="nc bnc" id="L1121" title="All 2 branches missed.">                            .getPosition().getY()))</span>
<span class="nc" id="L1122">                            || ((source.getPosition().getX() &lt; target</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                                    .getPosition().getX()) &amp;&amp; (source</span>
<span class="nc" id="L1124">                                    .getPosition().getY() &gt; target</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                                    .getPosition().getY()))) {</span>
<span class="nc" id="L1126">                        yPoints[3] = yPoints[0] + 2;</span>
<span class="nc" id="L1127">                        yPoints[2] = yPoints[1] + 2;</span>
                    } else {
<span class="nc" id="L1129">                        yPoints[3] = yPoints[0] - 2;</span>
<span class="nc" id="L1130">                        yPoints[2] = yPoints[1] - 2;</span>
                    }
<span class="nc" id="L1132">                    g.fillPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1133">                    g.setColor(Color.black);</span>
<span class="nc" id="L1134">                    g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1135">                    break;</span>
                }
            }
<span class="nc" id="L1138">        }</span>

<span class="nc" id="L1140">        g.setColor(oldColor);</span>
<span class="nc" id="L1141">    }</span>

    private void paintUnit(Graphics g, Entity entity) {
<span class="nc" id="L1144">        int baseX = (entity.getPosition().getX() * (hexSide[zoom] + hexSideBySin30[zoom]))</span>
                + leftMargin + hexSide[zoom];
<span class="nc" id="L1146">        int baseY = (((2 * entity.getPosition().getY()) + 1 + (entity</span>
<span class="nc" id="L1147">                .getPosition().getX() % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
        int[] xPoints;
        int[] yPoints;

<span class="nc bnc" id="L1151" title="All 2 branches missed.">        if (EntityVisibilityUtils.onlyDetectedBySensors(m_bview.getLocalPlayer(), entity)) { // Sensor Return</span>
<span class="nc" id="L1152">            String sensorReturn = &quot;?&quot;;           </span>
<span class="nc" id="L1153">            Font font = new Font(&quot;SansSerif&quot;, Font.BOLD, fontSize[zoom]); //$NON-NLS-1$            </span>
<span class="nc" id="L1154">            int width = getFontMetrics(font).stringWidth(sensorReturn) / 2;</span>
<span class="nc" id="L1155">            int height = getFontMetrics(font).getHeight() / 2 - 2;</span>
<span class="nc" id="L1156">            g.setFont(font);</span>
<span class="nc" id="L1157">            g.setColor(Color.RED);</span>
<span class="nc" id="L1158">            g.drawString(sensorReturn, baseX - width, baseY + height);</span>
<span class="nc" id="L1159">            return;</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">        } else if (!EntityVisibilityUtils.detectedOrHasVisual(m_bview.getLocalPlayer(), m_game, entity)) { // Unseen Unit</span>
            // Do nothing
<span class="nc" id="L1162">            return;</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">        } else if (entity instanceof Mech) {</span>
<span class="nc" id="L1164">            xPoints = new int[3];</span>
<span class="nc" id="L1165">            yPoints = new int[3];</span>
<span class="nc" id="L1166">            xPoints[0] = baseX;</span>
<span class="nc" id="L1167">            yPoints[0] = baseY - unitSize;</span>
<span class="nc" id="L1168">            xPoints[1] = baseX - unitSize;</span>
<span class="nc" id="L1169">            yPoints[1] = baseY + (unitSize / 2);</span>
<span class="nc" id="L1170">            xPoints[2] = baseX + unitSize;</span>
<span class="nc" id="L1171">            yPoints[2] = baseY + (unitSize / 2);</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">        } else if (entity instanceof VTOL) {</span>
<span class="nc" id="L1173">            xPoints = new int[8];</span>
<span class="nc" id="L1174">            yPoints = new int[8];</span>
<span class="nc" id="L1175">            xPoints[0] = baseX - unitSize;</span>
<span class="nc" id="L1176">            xPoints[1] = baseX - (unitSize / 3);</span>
<span class="nc" id="L1177">            xPoints[2] = baseX;</span>
<span class="nc" id="L1178">            xPoints[3] = baseX + (unitSize / 3);</span>
<span class="nc" id="L1179">            xPoints[4] = baseX + unitSize;</span>
<span class="nc" id="L1180">            xPoints[5] = xPoints[3];</span>
<span class="nc" id="L1181">            xPoints[6] = xPoints[2];</span>
<span class="nc" id="L1182">            xPoints[7] = xPoints[1];</span>
<span class="nc" id="L1183">            yPoints[0] = baseY;</span>
<span class="nc" id="L1184">            yPoints[1] = baseY - (unitSize / 3);</span>
<span class="nc" id="L1185">            yPoints[2] = baseY - unitSize;</span>
<span class="nc" id="L1186">            yPoints[3] = baseY - (unitSize / 3);</span>
<span class="nc" id="L1187">            yPoints[4] = baseY;</span>
<span class="nc" id="L1188">            yPoints[5] = baseY + (unitSize / 3);</span>
<span class="nc" id="L1189">            yPoints[6] = baseY + unitSize;</span>
<span class="nc" id="L1190">            yPoints[7] = baseY + (unitSize / 3);</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">        } else if (entity instanceof Tank) {</span>
<span class="nc" id="L1192">            xPoints = new int[4];</span>
<span class="nc" id="L1193">            yPoints = new int[4];</span>
<span class="nc" id="L1194">            xPoints[0] = baseX - ((unitSize * 2) / 3);</span>
<span class="nc" id="L1195">            yPoints[0] = baseY - ((unitSize * 2) / 3);</span>
<span class="nc" id="L1196">            xPoints[1] = baseX - ((unitSize * 2) / 3);</span>
<span class="nc" id="L1197">            yPoints[1] = baseY + ((unitSize * 2) / 3);</span>
<span class="nc" id="L1198">            xPoints[2] = baseX + ((unitSize * 2) / 3);</span>
<span class="nc" id="L1199">            yPoints[2] = baseY + ((unitSize * 2) / 3);</span>
<span class="nc" id="L1200">            xPoints[3] = baseX + ((unitSize * 2) / 3);</span>
<span class="nc" id="L1201">            yPoints[3] = baseY - ((unitSize * 2) / 3);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">        } else if (entity instanceof Protomech) {</span>
<span class="nc" id="L1203">            xPoints = new int[3];</span>
<span class="nc" id="L1204">            yPoints = new int[3];</span>
<span class="nc" id="L1205">            xPoints[0] = baseX;</span>
<span class="nc" id="L1206">            yPoints[0] = baseY + unitSize;</span>
<span class="nc" id="L1207">            xPoints[1] = baseX + unitSize;</span>
<span class="nc" id="L1208">            yPoints[1] = baseY - (unitSize / 2);</span>
<span class="nc" id="L1209">            xPoints[2] = baseX - unitSize;</span>
<span class="nc" id="L1210">            yPoints[2] = baseY - (unitSize / 2);</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">        } else if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L1212">            int twip = (unitSize * 2) / 3;</span>
<span class="nc" id="L1213">            xPoints = new int[8];</span>
<span class="nc" id="L1214">            yPoints = new int[8];</span>
<span class="nc" id="L1215">            xPoints[0] = baseX - (twip / 2);</span>
<span class="nc" id="L1216">            yPoints[0] = baseY - ((twip * 3) / 2);</span>
<span class="nc" id="L1217">            xPoints[1] = xPoints[0] - twip;</span>
<span class="nc" id="L1218">            yPoints[1] = yPoints[0] + twip;</span>
<span class="nc" id="L1219">            xPoints[2] = xPoints[1];</span>
<span class="nc" id="L1220">            yPoints[2] = yPoints[1] + twip;</span>
<span class="nc" id="L1221">            xPoints[3] = xPoints[2] + twip;</span>
<span class="nc" id="L1222">            yPoints[3] = yPoints[2] + twip;</span>
<span class="nc" id="L1223">            xPoints[4] = xPoints[3] + twip;</span>
<span class="nc" id="L1224">            yPoints[4] = yPoints[3];</span>
<span class="nc" id="L1225">            xPoints[5] = xPoints[4] + twip;</span>
<span class="nc" id="L1226">            yPoints[5] = yPoints[4] - twip;</span>
<span class="nc" id="L1227">            xPoints[6] = xPoints[5];</span>
<span class="nc" id="L1228">            yPoints[6] = yPoints[5] - twip;</span>
<span class="nc" id="L1229">            xPoints[7] = xPoints[6] - twip;</span>
<span class="nc" id="L1230">            yPoints[7] = yPoints[6] - twip;</span>
<span class="nc" id="L1231">        } else {</span>
            // entity instanceof Infantry
<span class="nc" id="L1233">            xPoints = new int[4];</span>
<span class="nc" id="L1234">            yPoints = new int[4];</span>
<span class="nc" id="L1235">            xPoints[0] = baseX;</span>
<span class="nc" id="L1236">            yPoints[0] = baseY - unitSize;</span>
<span class="nc" id="L1237">            xPoints[1] = baseX - unitSize;</span>
<span class="nc" id="L1238">            yPoints[1] = baseY;</span>
<span class="nc" id="L1239">            xPoints[2] = baseX;</span>
<span class="nc" id="L1240">            yPoints[2] = baseY + unitSize;</span>
<span class="nc" id="L1241">            xPoints[3] = baseX + unitSize;</span>
<span class="nc" id="L1242">            yPoints[3] = baseY;</span>
        }

<span class="nc" id="L1245">        Graphics2D g2 = (Graphics2D)g;</span>
<span class="nc" id="L1246">        Stroke svStroke = g2.getStroke();</span>

        // Choose player or team color depending on preferences
<span class="nc" id="L1249">        Color iconColor = entity.getOwner().getColour().getColour(false);</span>
<span class="nc bnc" id="L1250" title="All 4 branches missed.">        if (GUIPreferences.getInstance().getTeamColoring() &amp;&amp; (m_client != null)) {</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">            boolean isLocalTeam = entity.getOwner().getTeam() == m_client.getLocalPlayer().getTeam();</span>
<span class="nc" id="L1252">            boolean isLocalPlayer = entity.getOwner().equals(m_client.getLocalPlayer());</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">            if (isLocalPlayer) {</span>
<span class="nc" id="L1254">                iconColor = GUIPreferences.getInstance().getMyUnitColor();</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">            } else if (isLocalTeam) {</span>
<span class="nc" id="L1256">                iconColor = GUIPreferences.getInstance().getAllyUnitColor();</span>
            } else {
<span class="nc" id="L1258">                iconColor = GUIPreferences.getInstance().getEnemyUnitColor();</span>
            }
        }

<span class="nc bnc" id="L1262" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getBoolean(GUIPreferences.MMSYMBOL)) {</span>
<span class="nc" id="L1263">            AffineTransform svTransform = g2.getTransform();</span>

            // Transform for placement and scaling
<span class="nc" id="L1266">            AffineTransform t = AffineTransform.getTranslateInstance(baseX, baseY);</span>
<span class="nc" id="L1267">            t.scale(stratZoom[zoom]/100.0d, fontSize[zoom]/100.0d);</span>
<span class="nc" id="L1268">            g2.transform(t);</span>

            // Add a position shift if multiple units are present in this hex
<span class="nc" id="L1271">            Coords p = entity.getPosition();</span>
<span class="nc" id="L1272">            Integer eStack = multiUnits.get(p);</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">            if (eStack == null) eStack = 0;</span>
<span class="nc" id="L1274">            eStack++;</span>
<span class="nc" id="L1275">            multiUnits.put(p, eStack);</span>
<span class="nc" id="L1276">            g2.translate(20*(eStack-1), -20*(eStack-1));</span>

            // White border to set off the icon from the background
<span class="nc" id="L1279">            g2.setStroke(new BasicStroke(30f, BasicStroke.CAP_SQUARE, BasicStroke.JOIN_BEVEL));</span>
<span class="nc" id="L1280">            g2.setColor(new Color(255,255,255,150));</span>
<span class="nc" id="L1281">            g2.draw(STRAT_BASERECT);</span>

            // Black background to fill forms like the Dropship
<span class="nc" id="L1284">            g2.setColor(Color.BLACK);</span>
<span class="nc" id="L1285">            g2.fill(STRAT_BASERECT);</span>

            // Rectangle border for all units
<span class="nc" id="L1288">            g2.setStroke(new BasicStroke(8f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER));</span>
<span class="nc" id="L1289">            g2.draw(STRAT_BASERECT);</span>

            // Select the correct form for the entity
            Path2D form;
<span class="nc bnc" id="L1293" title="All 4 branches missed.">            if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
<span class="nc" id="L1294">                form = STRAT_MECH;</span>
<span class="nc" id="L1295">                g2.setStroke(new BasicStroke(1f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER));</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">            } else if (entity instanceof VTOL) {</span>
<span class="nc" id="L1297">                form = STRAT_VTOL;</span>
<span class="nc" id="L1298">                g2.setStroke(new BasicStroke(1f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER));</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.HOVER) {</span>
<span class="nc" id="L1301">                    form = STRAT_HOVER;</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L1303">                    form = STRAT_WHEELED;</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">                } else if ((entity.getMovementMode() == EntityMovementMode.HYDROFOIL) ||</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">                        (entity.getMovementMode() == EntityMovementMode.NAVAL)) {</span>
<span class="nc" id="L1306">                    form = STRAT_NAVAL; </span>
                } else {
<span class="nc" id="L1308">                    form = STRAT_TANKTRACKED;</span>
                }
<span class="nc bnc" id="L1310" title="All 2 branches missed.">            } else if (entity.isAero()) {</span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">                if (entity.isFighter()) {</span>
<span class="nc" id="L1312">                    form = STRAT_AERO;</span>
                } else {
<span class="nc" id="L1314">                    form = STRAT_SPHEROID;</span>
                }
<span class="nc" id="L1316">                g2.setStroke(new BasicStroke(1f, BasicStroke.CAP_BUTT, BasicStroke.JOIN_MITER));</span>
            } else {
<span class="nc" id="L1318">                form = STRAT_INFANTRY;</span>
            }

            // Fill the form in player color / team color
<span class="nc" id="L1322">            g.setColor(iconColor);</span>
<span class="nc" id="L1323">            g2.fill(form);</span>

            // Add the weight class or other lettering for certain units
<span class="nc" id="L1326">            g.setColor(Color.BLACK);</span>
<span class="nc bnc" id="L1327" title="All 6 branches missed.">            if ((entity instanceof Protomech) || (entity instanceof Mech) || (entity instanceof Aero)) {</span>
<span class="nc" id="L1328">                String s = &quot;&quot;;</span>
<span class="nc bnc" id="L1329" title="All 2 branches missed.">                if (entity instanceof Protomech) {</span>
<span class="nc" id="L1330">                    s = &quot;P&quot;;</span>
<span class="nc bnc" id="L1331" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; ((Mech)entity).isIndustrial()) {</span>
<span class="nc" id="L1332">                    s = &quot;I&quot;;</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">                } else if (entity.getWeightClass() &lt; 6) {</span>
<span class="nc" id="L1334">                    s = STRAT_WEIGHTS[entity.getWeightClass()];</span>
                }
<span class="nc bnc" id="L1336" title="All 2 branches missed.">                if (!s.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1337">                    FontRenderContext fontContext = new FontRenderContext(null, true, true);</span>
<span class="nc" id="L1338">                    Font font = new Font(&quot;SansSerif&quot;, Font.BOLD, 100);</span>
<span class="nc" id="L1339">                    FontMetrics currentMetrics = getFontMetrics(font);</span>
<span class="nc" id="L1340">                    int stringWidth = currentMetrics.stringWidth(s);</span>
<span class="nc" id="L1341">                    GlyphVector gv = font.createGlyphVector(fontContext, s);</span>
<span class="nc" id="L1342">                    g2.fill(gv.getOutline((int)STRAT_CX-stringWidth/2,(float)SYMBOLSIZE.getHeight()/3.0f));</span>
                }
<span class="nc bnc" id="L1344" title="All 2 branches missed.">            } else if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L1345">                g2.setColor(Color.black);</span>
<span class="nc" id="L1346">                g2.fillOval(0 - 25, 0 - 25, 50, 50);</span>
            }
            // Draw the unit icon in black
<span class="nc" id="L1349">            g2.draw(form);</span>

<span class="nc" id="L1351">            g2.setTransform(svTransform);</span>
            
<span class="nc" id="L1353">        } else {</span>
            // Drawn a circle for MechWarriors
<span class="nc bnc" id="L1355" title="All 2 branches missed.">            if (entity instanceof MechWarrior) {</span>
                // Draw a slight dark border
<span class="nc" id="L1357">                int radius = unitSize - 3;</span>
<span class="nc" id="L1358">                int dia = radius * 2;</span>
<span class="nc" id="L1359">                ((Graphics2D)g).setStroke(new BasicStroke(unitBorder[zoom]+2));</span>
<span class="nc" id="L1360">                g.setColor(new Color(100,100,100,200));</span>
<span class="nc" id="L1361">                g.drawOval(baseX - radius, baseY - radius, dia, dia);</span>

                // Fill the form in player color / team color
<span class="nc" id="L1364">                g.setColor(iconColor);</span>
<span class="nc" id="L1365">                g.fillOval(baseX - radius, baseY - radius, dia, dia);</span>

                // Draw a white border to better show the player color
<span class="nc" id="L1368">                ((Graphics2D)g).setStroke(new BasicStroke(unitBorder[zoom]));</span>
<span class="nc" id="L1369">                g.setColor(Color.WHITE);</span>
<span class="nc" id="L1370">                g.drawOval(baseX - radius, baseY - radius, dia, dia);</span>
<span class="nc" id="L1371">            } else {</span>
                // Draw a slight dark border to set off the icon from the background
<span class="nc" id="L1373">                ((Graphics2D)g).setStroke(new BasicStroke(unitBorder[zoom]+2));</span>
<span class="nc" id="L1374">                g.setColor(new Color(100,100,100,200));</span>
<span class="nc" id="L1375">                g.drawPolygon(xPoints, yPoints, xPoints.length);</span>

                // Fill the form in player color / team color
<span class="nc" id="L1378">                g.setColor(iconColor);</span>
<span class="nc" id="L1379">                g.fillPolygon(xPoints, yPoints, xPoints.length);</span>

                // Draw a white border to better show the player color
                // maybe useful later: if (!entity.isSelectableThisTurn()) {
<span class="nc" id="L1383">                ((Graphics2D)g).setStroke(new BasicStroke(unitBorder[zoom]));</span>
<span class="nc" id="L1384">                g.setColor(Color.WHITE);</span>
<span class="nc" id="L1385">                g.drawPolygon(xPoints, yPoints, xPoints.length);</span>
            }

        }
        
        // Create a colored circle if this is the selected unit
<span class="nc bnc" id="L1391" title="All 2 branches missed.">        Entity se = (clientgui == null) ? null : </span>
<span class="nc" id="L1392">            m_game.getEntity(clientgui.getSelectedEntityNum());</span>
        
<span class="nc bnc" id="L1394" title="All 2 branches missed.">        if (entity == se) {</span>
<span class="nc" id="L1395">            g2.setStroke(new BasicStroke(unitBorder[zoom]+1));</span>
<span class="nc" id="L1396">            g2.setColor(GUIPreferences.getInstance().getColor(</span>
                    GUIPreferences.ADVANCED_UNITOVERVIEW_SELECTED_COLOR));
<span class="nc" id="L1398">            int rad = unitSize*2-1;</span>
<span class="nc" id="L1399">            g2.drawOval(baseX-rad, baseY-rad, rad*2, rad*2);</span>
        }

<span class="nc" id="L1402">        g2.setStroke(svStroke);</span>
<span class="nc" id="L1403">    }</span>

    private void paintRoads(Graphics g) {
<span class="nc" id="L1406">        int exits = 0;</span>
        int baseX, baseY, x, y;
<span class="nc" id="L1408">        int[] xPoints = new int[4];</span>
<span class="nc" id="L1409">        int[] yPoints = new int[4];</span>
<span class="nc" id="L1410">        Color oldColor = g.getColor();</span>
<span class="nc" id="L1411">        g.setColor(m_terrainColors[Terrains.ROAD]);</span>
<span class="nc" id="L1412">        for (Enumeration&lt;int[]&gt; iter = roadHexIndexes.elements(); iter</span>
<span class="nc bnc" id="L1413" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L1414">            int[] hex = iter.nextElement();</span>
<span class="nc" id="L1415">            x = hex[0];</span>
<span class="nc" id="L1416">            y = hex[1];</span>
<span class="nc" id="L1417">            baseX = (x * (hexSide[zoom] + hexSideBySin30[zoom])) + leftMargin</span>
                    + hexSide[zoom];
<span class="nc" id="L1419">            baseY = (((2 * y) + 1 + (x % 2)) * hexSideByCos30[zoom]) + topMargin;</span>
<span class="nc" id="L1420">            exits = hex[2];</span>
            // Is there a North exit?
<span class="nc bnc" id="L1422" title="All 2 branches missed.">            if (0 != (exits &amp; 0x0001)) {</span>
<span class="nc" id="L1423">                xPoints[0] = baseX - halfRoadWidth[zoom];</span>
<span class="nc" id="L1424">                yPoints[0] = baseY;</span>
<span class="nc" id="L1425">                xPoints[1] = baseX - halfRoadWidth[zoom];</span>
<span class="nc" id="L1426">                yPoints[1] = baseY - hexSideByCos30[zoom];</span>
<span class="nc" id="L1427">                xPoints[2] = baseX + halfRoadWidth[zoom];</span>
<span class="nc" id="L1428">                yPoints[2] = baseY - hexSideByCos30[zoom];</span>
<span class="nc" id="L1429">                xPoints[3] = baseX + halfRoadWidth[zoom];</span>
<span class="nc" id="L1430">                yPoints[3] = baseY;</span>
<span class="nc" id="L1431">                g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1432">                g.fillPolygon(xPoints, yPoints, 4);</span>
            }
            // Is there a North-East exit?
<span class="nc bnc" id="L1435" title="All 2 branches missed.">            if (0 != (exits &amp; 0x0002)) {</span>
<span class="nc" id="L1436">                xPoints[0] = baseX - halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1437">                yPoints[0] = baseY - halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1438">                xPoints[1] = Math.round((baseX + ((3 * hexSide[zoom]) / 4))</span>
                                        - halfRoadWidthBySin30[zoom]);
<span class="nc" id="L1440">                yPoints[1] = Math.round(baseY - (hexSideByCos30[zoom] / 2)</span>
                                        - halfRoadWidthByCos30[zoom]);
<span class="nc" id="L1442">                xPoints[2] = xPoints[1] + (2 * halfRoadWidthBySin30[zoom]);</span>
<span class="nc" id="L1443">                yPoints[2] = yPoints[1] + (2 * halfRoadWidthByCos30[zoom]);</span>
<span class="nc" id="L1444">                xPoints[3] = baseX + halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1445">                yPoints[3] = baseY + halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1446">                g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1447">                g.fillPolygon(xPoints, yPoints, 4);</span>
            }
            // Is there a South-East exit?
<span class="nc bnc" id="L1450" title="All 2 branches missed.">            if (0 != (exits &amp; 0x0004)) {</span>
<span class="nc" id="L1451">                xPoints[0] = baseX + halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1452">                yPoints[0] = baseY - halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1453">                xPoints[1] = Math.round(baseX + ((3 * hexSide[zoom]) / 4)</span>
                                        + halfRoadWidthBySin30[zoom]);
<span class="nc" id="L1455">                yPoints[1] = Math.round((baseY + (hexSideByCos30[zoom] / 2))</span>
                                        - halfRoadWidthByCos30[zoom]);
<span class="nc" id="L1457">                xPoints[2] = xPoints[1] - (2 * halfRoadWidthBySin30[zoom]);</span>
<span class="nc" id="L1458">                yPoints[2] = yPoints[1] + (2 * halfRoadWidthByCos30[zoom]);</span>
<span class="nc" id="L1459">                xPoints[3] = baseX - halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1460">                yPoints[3] = baseY + halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1461">                g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1462">                g.fillPolygon(xPoints, yPoints, 4);</span>
            }
            // Is there a South exit?
<span class="nc bnc" id="L1465" title="All 2 branches missed.">            if (0 != (exits &amp; 0x0008)) {</span>
<span class="nc" id="L1466">                xPoints[0] = baseX + halfRoadWidth[zoom];</span>
<span class="nc" id="L1467">                yPoints[0] = baseY;</span>
<span class="nc" id="L1468">                xPoints[1] = baseX + halfRoadWidth[zoom];</span>
<span class="nc" id="L1469">                yPoints[1] = baseY + hexSideByCos30[zoom];</span>
<span class="nc" id="L1470">                xPoints[2] = baseX - halfRoadWidth[zoom];</span>
<span class="nc" id="L1471">                yPoints[2] = baseY + hexSideByCos30[zoom];</span>
<span class="nc" id="L1472">                xPoints[3] = baseX - halfRoadWidth[zoom];</span>
<span class="nc" id="L1473">                yPoints[3] = baseY;</span>
<span class="nc" id="L1474">                g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1475">                g.fillPolygon(xPoints, yPoints, 4);</span>
            }
            // Is there a South-West exit?
<span class="nc bnc" id="L1478" title="All 2 branches missed.">            if (0 != (exits &amp; 0x0010)) {</span>
<span class="nc" id="L1479">                xPoints[0] = baseX + halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1480">                yPoints[0] = baseY + halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1481">                xPoints[1] = Math.round((baseX - ((3 * hexSide[zoom]) / 4))</span>
                                        + halfRoadWidthBySin30[zoom]);
<span class="nc" id="L1483">                yPoints[1] = Math.round(baseY + (hexSideByCos30[zoom] / 2)</span>
                                        + halfRoadWidthByCos30[zoom]);
<span class="nc" id="L1485">                xPoints[2] = xPoints[1] - (2 * halfRoadWidthBySin30[zoom]);</span>
<span class="nc" id="L1486">                yPoints[2] = yPoints[1] - (2 * halfRoadWidthByCos30[zoom]);</span>
<span class="nc" id="L1487">                xPoints[3] = baseX - halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1488">                yPoints[3] = baseY - halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1489">                g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1490">                g.fillPolygon(xPoints, yPoints, 4);</span>
            }
            // Is there a North-West exit?
<span class="nc bnc" id="L1493" title="All 2 branches missed.">            if (0 != (exits &amp; 0x0020)) {</span>
<span class="nc" id="L1494">                xPoints[0] = baseX - halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1495">                yPoints[0] = baseY + halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1496">                xPoints[1] = Math.round(baseX - ((3 * hexSide[zoom]) / 4)</span>
                                        - halfRoadWidthBySin30[zoom]);
<span class="nc" id="L1498">                yPoints[1] = Math.round((baseY - (hexSideByCos30[zoom] / 2))</span>
                                        + halfRoadWidthByCos30[zoom]);
<span class="nc" id="L1500">                xPoints[2] = xPoints[1] + (2 * halfRoadWidthBySin30[zoom]);</span>
<span class="nc" id="L1501">                yPoints[2] = yPoints[1] - (2 * halfRoadWidthByCos30[zoom]);</span>
<span class="nc" id="L1502">                xPoints[3] = baseX + halfRoadWidthBySin30[zoom];</span>
<span class="nc" id="L1503">                yPoints[3] = baseY - halfRoadWidthByCos30[zoom];</span>
<span class="nc" id="L1504">                g.drawPolygon(xPoints, yPoints, 4);</span>
<span class="nc" id="L1505">                g.fillPolygon(xPoints, yPoints, 4);</span>
            }

<span class="nc" id="L1508">        }</span>
<span class="nc" id="L1509">        g.setColor(oldColor);</span>
<span class="nc" id="L1510">    }</span>

    /**
     * check if hex contains roadelements and if it does, add to roadHexIndexes
     */
    private void addRoadElements(IHex x, int boardX, int boardY) {
<span class="nc" id="L1516">        final int[] roadTypes = new int[]{Terrains.ROAD, Terrains.BRIDGE};</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">        for (int j : roadTypes) {</span>
<span class="nc bnc" id="L1518" title="All 4 branches missed.">            if ((x.getTerrain(j) != null) &amp;&amp; (m_terrainColors[j] != null)) {</span>
<span class="nc" id="L1519">                int[] roadHex = {boardX, boardY, x.getTerrain(j).getExits()};</span>
<span class="nc" id="L1520">                roadHexIndexes.addElement(roadHex);</span>
            }
        }
<span class="nc" id="L1523">    }</span>

    private Color terrainColor(IHex x, int boardX, int boardY) {
<span class="nc" id="L1526">        Color terrColor = m_terrainColors[0];</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">        if (x.getLevel() &lt; 0) {</span>
            // sinkholes have their own colour
<span class="nc" id="L1529">            terrColor = SINKHOLE;</span>
        }

<span class="nc" id="L1532">        int terrain = 0;</span>
        // Check for Smoke and Fire - this overrides any other colors
<span class="nc bnc" id="L1534" title="All 4 branches missed.">        if (x.containsTerrain(Terrains.SMOKE) &amp;&amp; x.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L1535">            terrColor = SMOKE_AND_FIRE;</span>
        // Check for Fire - this overrides any other colors
<span class="nc bnc" id="L1537" title="All 2 branches missed.">        } else if (x.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L1538">            terrColor = m_terrainColors[Terrains.FIRE];</span>
        } else { // Otherwise, color based on terrains - higher valued terrains take color precedence
<span class="nc bnc" id="L1540" title="All 2 branches missed.">            for (int j = m_terrainColors.length - 1; j &gt;= 0; j--) {</span>
<span class="nc bnc" id="L1541" title="All 4 branches missed.">                if ((x.getTerrain(j) != null) &amp;&amp; (m_terrainColors[j] != null)) {</span>
<span class="nc bnc" id="L1542" title="All 4 branches missed.">                    if ((j == Terrains.ROAD) || (j == Terrains.BRIDGE)) {</span>
<span class="nc" id="L1543">                        continue;</span>
                    }
<span class="nc" id="L1545">                    terrColor = m_terrainColors[j];</span>
<span class="nc" id="L1546">                    terrain = j;</span>
                    // make heavy woods darker
<span class="nc bnc" id="L1548" title="All 6 branches missed.">                    if (((j == Terrains.WOODS) || (j == Terrains.JUNGLE)) &amp;&amp; (x.getTerrain(j).getLevel() == 2)) {</span>
<span class="nc" id="L1549">                        terrColor = HEAVY_WOODS;</span>
                    }
<span class="nc bnc" id="L1551" title="All 6 branches missed.">                    if (((j == Terrains.WOODS) || (j == Terrains.JUNGLE)) &amp;&amp; (x.getTerrain(j).getLevel() &gt; 2)) {</span>
<span class="nc" id="L1552">                        terrColor = ULTRA_HEAVY_WOODS;</span>
                    }
                    break;
                }
            }
        }
<span class="nc" id="L1558">        int level = 0;</span>

        int r, g, b;
<span class="nc bnc" id="L1561" title="All 3 branches missed.">        switch (terrain) {</span>
            case 0:
            case Terrains.WOODS:
            case Terrains.JUNGLE:
            case Terrains.ROUGH:
            case Terrains.RUBBLE:
            case Terrains.WATER:
            case Terrains.PAVEMENT:
            case Terrains.ICE:
            case Terrains.FIELDS:
<span class="nc" id="L1571">                level = Math.abs(x.floor());</span>
                // By experiment it is possible to make only 6 distinctive color
                // steps
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                if (level &gt; 10) {</span>
<span class="nc" id="L1575">                    level = 10;</span>
                }
<span class="nc" id="L1577">                r = terrColor.getRed() - (level * 15);</span>
<span class="nc" id="L1578">                g = terrColor.getGreen() - (level * 15);</span>
<span class="nc" id="L1579">                b = terrColor.getBlue() - (level * 15);</span>
<span class="nc bnc" id="L1580" title="All 2 branches missed.">                if (r &lt; 0) {</span>
<span class="nc" id="L1581">                    r = 0;</span>
                }
<span class="nc bnc" id="L1583" title="All 2 branches missed.">                if (g &lt; 0) {</span>
<span class="nc" id="L1584">                    g = 0;</span>
                }
<span class="nc bnc" id="L1586" title="All 2 branches missed.">                if (b &lt; 0) {</span>
<span class="nc" id="L1587">                    b = 0;</span>
                }
<span class="nc" id="L1589">                return new Color(r, g, b);</span>
            case Terrains.FUEL_TANK:
            case Terrains.BUILDING:
<span class="nc" id="L1592">                level = Math.abs(x.ceiling());</span>
                // By experiment it is possible to make only 6 distinctive color
                // steps
<span class="nc bnc" id="L1595" title="All 2 branches missed.">                if (level &gt; 10) {</span>
<span class="nc" id="L1596">                    level = 10;</span>
                }
<span class="nc" id="L1598">                r = terrColor.getRed() - (level * 15);</span>
<span class="nc" id="L1599">                g = terrColor.getGreen() - (level * 15);</span>
<span class="nc" id="L1600">                b = terrColor.getBlue() - (level * 15);</span>
<span class="nc bnc" id="L1601" title="All 2 branches missed.">                if (r &lt; 0) {</span>
<span class="nc" id="L1602">                    r = 0;</span>
                }
<span class="nc bnc" id="L1604" title="All 2 branches missed.">                if (g &lt; 0) {</span>
<span class="nc" id="L1605">                    g = 0;</span>
                }
<span class="nc bnc" id="L1607" title="All 2 branches missed.">                if (b &lt; 0) {</span>
<span class="nc" id="L1608">                    b = 0;</span>
                }
<span class="nc" id="L1610">                return new Color(r, g, b);</span>

        }
        /*
         * if (terrain &lt; 5){ level = (int) Math.abs(x.floor()); // By experiment
         * it is possible to make only 6 distinctive color steps if (level &gt; 5)
         * level = 5; int r = terrColor.getRed()-level30; int g =
         * terrColor.getGreen()-level30; int b = terrColor.getBlue()-level30; if
         * (r &lt; 0) r = 0; if (g &lt; 0) g = 0; if (b &lt; 0) b = 0; return new
         * Color(r, g, b); }
         */
<span class="nc" id="L1621">        return terrColor;</span>
    }

    private Coords translateCoords(int x, int y) {
<span class="nc" id="L1625">        int gridX = (x / (hexSideBySin30[zoom] + hexSide[zoom]));</span>
<span class="nc" id="L1626">        int restX = x % (hexSideBySin30[zoom] + hexSide[zoom]);</span>
<span class="nc" id="L1627">        int gridY = (y / (2 * hexSideByCos30[zoom]));</span>
<span class="nc" id="L1628">        int restY = y % (2 * hexSideByCos30[zoom]);</span>

<span class="nc bnc" id="L1630" title="All 2 branches missed.">        boolean evenColumn = (gridX &amp; 1) == 0;</span>

<span class="nc bnc" id="L1632" title="All 2 branches missed.">        if (restY &lt; hexSideByCos30[zoom]) {</span>
<span class="nc bnc" id="L1633" title="All 2 branches missed.">            if (evenColumn) {</span>
<span class="nc bnc" id="L1634" title="All 2 branches missed.">                if (restX &lt; ((((restY - hexSideByCos30[zoom])</span>
                               * hexSideBySin30[zoom]) / hexSideByCos30[zoom]) * -1)) {
<span class="nc" id="L1636">                    gridX--;</span>
<span class="nc" id="L1637">                    gridY--;</span>
                }
            } else {
<span class="nc bnc" id="L1640" title="All 2 branches missed.">                if (restX &lt; ((restY * hexSideBySin30[zoom]) / hexSideByCos30[zoom])) {</span>
<span class="nc" id="L1641">                    gridX--;</span>
                } else {
<span class="nc" id="L1643">                    gridY--;</span>
                }
            }
        } else {
<span class="nc bnc" id="L1647" title="All 2 branches missed.">            if (evenColumn) {</span>
<span class="nc bnc" id="L1648" title="All 2 branches missed.">                if (restX &lt; (((restY - hexSideByCos30[zoom])</span>
                              * hexSideBySin30[zoom]) / hexSideByCos30[zoom])) {
<span class="nc" id="L1650">                    gridX--;</span>
                }
            } else {
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                if (restX &lt; ((((restY - (2 * hexSideByCos30[zoom]))</span>
                               * hexSideBySin30[zoom]) / hexSideByCos30[zoom]) * -1)) {
<span class="nc" id="L1655">                    gridX--;</span>
                }
            }
        }
        /*
         * restX = hexSideBySin30[zoom] + hexSide[zoom] - restX; restY -=
         * hexSideByCos30[zoom]; if (hexSideBySin30[zoom]restX &gt;
         * hexSideByCos30[zoom]restY) gridX ++; if (-hexSideBySin30[zoom]restX &gt;
         * hexSideByCos30[zoom]restY) gridY --;
         */
<span class="nc bnc" id="L1665" title="All 2 branches missed.">        if (gridX &lt; 0) {</span>
<span class="nc" id="L1666">            gridX = 0;</span>
        }
<span class="nc bnc" id="L1668" title="All 2 branches missed.">        if (gridY &lt; 0) {</span>
<span class="nc" id="L1669">            gridY = 0;</span>
        }

<span class="nc" id="L1672">        return new Coords(gridX, gridY);</span>
    }

    protected void zoomIn() {
<span class="nc bnc" id="L1676" title="All 2 branches missed.">        if (zoom == 0) {</span>
<span class="nc" id="L1677">            return;</span>
        }
<span class="nc" id="L1679">        zoom--;</span>
<span class="nc" id="L1680">        initializeMap();</span>
<span class="nc" id="L1681">    }</span>

    protected void zoomOut() {
<span class="nc bnc" id="L1684" title="All 2 branches missed.">        if (zoom == (hexSide.length - 1)) {</span>
<span class="nc" id="L1685">            return;</span>
        }
<span class="nc" id="L1687">        zoom++;</span>
<span class="nc" id="L1688">        initializeMap();</span>
<span class="nc" id="L1689">    }</span>

    void processMouseClick(int x, int y, MouseEvent me) {
<span class="nc bnc" id="L1692" title="All 4 branches missed.">        if (y &gt; (getSize().height - 14) &amp;&amp; !dragging) {</span>
<span class="nc bnc" id="L1693" title="All 2 branches missed.">            if (minimized) {</span>
<span class="nc" id="L1694">                setSize(getSize().width, heightBufer);</span>
<span class="nc" id="L1695">                m_mapImage =  ImageUtil.createAcceleratedImage(getSize().width, heightBufer);</span>
<span class="nc" id="L1696">                minimized = false;</span>
<span class="nc" id="L1697">                initializeMap();</span>
            } else {
<span class="nc bnc" id="L1699" title="All 2 branches missed.">                if (x &lt; 14) {</span>
<span class="nc bnc" id="L1700" title="All 2 branches missed.">                    if (GUIPreferences.getInstance().getMouseWheelZoomFlip()) {</span>
<span class="nc" id="L1701">                        zoomIn();</span>
                    } else {
<span class="nc" id="L1703">                        zoomOut();</span>
                    }
<span class="nc bnc" id="L1705" title="All 4 branches missed.">                } else if ((x &lt; 28) &amp;&amp; (zoom &gt; 2)) {</span>
<span class="nc bnc" id="L1706" title="All 2 branches missed.">                    heightDisplayMode = ((++heightDisplayMode) &gt; NBR_MODES) ? 0 : heightDisplayMode;</span>
<span class="nc" id="L1707">                    initializeMap();</span>
<span class="nc bnc" id="L1708" title="All 2 branches missed.">                } else if (x &gt; (getSize().width - 14)) {</span>
<span class="nc bnc" id="L1709" title="All 2 branches missed.">                    if (GUIPreferences.getInstance().getMouseWheelZoomFlip()) {</span>
<span class="nc" id="L1710">                        zoomOut();</span>
                    } else {
<span class="nc" id="L1712">                        zoomIn();</span>
                    }
                } else {
                    // Minimize button
<span class="nc" id="L1716">                    heightBufer = getSize().height;</span>
<span class="nc" id="L1717">                    setSize(getSize().width, 14);</span>

<span class="nc" id="L1719">                    m_mapImage = ImageUtil.createAcceleratedImage(Math.max(1, getSize().width), 14);</span>

<span class="nc" id="L1721">                    minimized = true;</span>
<span class="nc" id="L1722">                    initializeMap();</span>
                }  
            }
<span class="nc bnc" id="L1725" title="All 2 branches missed.">        } else if (m_bview != null) {</span>
<span class="nc bnc" id="L1726" title="All 6 branches missed.">            if ((x &lt; margin) || (x &gt; (getSize().width - leftMargin))</span>
                || (y &lt; topMargin)
<span class="nc bnc" id="L1728" title="All 2 branches missed.">                || (y &gt; (getSize().height - topMargin - 14))) {</span>
<span class="nc" id="L1729">                return;</span>
            }
<span class="nc bnc" id="L1731" title="All 2 branches missed.">            if ((me.getModifiers() &amp; InputEvent.CTRL_MASK) != 0) {</span>
<span class="nc" id="L1732">                m_bview.checkLOS(translateCoords(x - leftMargin, y - topMargin));</span>
            } else {
<span class="nc" id="L1734">                m_bview.centerOnPointRel(</span>
<span class="nc" id="L1735">                        ((double)(x - leftMargin))/(double)((hexSideBySin30[zoom] + hexSide[zoom])*m_board.getWidth()),</span>
<span class="nc" id="L1736">                        ((double)(y - topMargin))/(double)(2 * hexSideByCos30[zoom]*m_board.getHeight()));</span>
<span class="nc" id="L1737">                m_bview.stopSoftCentering();</span>
<span class="nc" id="L1738">                repaint();</span>
            }
        }
<span class="nc" id="L1741">    }</span>

    public int getZoom() {
<span class="nc" id="L1744">        return zoom;</span>
    }

    public void setZoom(int z) {
<span class="nc" id="L1748">        zoom = z;</span>
<span class="nc" id="L1749">    }</span>

<span class="nc" id="L1751">    protected BoardListener boardListener = new BoardListenerAdapter() {</span>
        @Override
        public void boardNewBoard(BoardEvent b) {
<span class="nc" id="L1754">            initializeMap();</span>
<span class="nc" id="L1755">        }</span>

        @Override
        public void boardChangedHex(BoardEvent b) {
<span class="nc bnc" id="L1759" title="All 2 branches missed.">            if (dirty == null) {</span>
<span class="nc" id="L1760">                dirtyMap = true;</span>
            } else {
                /*
                 * this must be tolerant since it might be called without
                 * notifying us of the boardsize first
                 */
<span class="nc" id="L1766">                int x = b.getCoords().getX();</span>
<span class="nc" id="L1767">                int y = b.getCoords().getY();</span>
<span class="nc bnc" id="L1768" title="All 4 branches missed.">                if ((x &gt;= dirty.length) || (y &gt;= dirty[x].length)) {</span>
<span class="nc" id="L1769">                    dirtyMap = true;</span>
<span class="nc" id="L1770">                    return;</span>
                }
<span class="nc" id="L1772">                dirty[x / 10][y / 10] = true;</span>
            }

<span class="nc" id="L1775">        }</span>
    };

<span class="nc" id="L1778">    protected GameListener gameListener = new GameListenerAdapter() {</span>
        @Override
        public void gamePhaseChange(GamePhaseChangeEvent e) {
<span class="nc bnc" id="L1781" title="All 4 branches missed.">            if (GUIPreferences.getInstance().getGameSummaryMiniMap() &amp;&amp; ((e.getOldPhase() == Phase.PHASE_DEPLOYMENT)</span>
<span class="nc bnc" id="L1782" title="All 4 branches missed.">                    || (e.getOldPhase() == Phase.PHASE_MOVEMENT) || (e.getOldPhase() == Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L1783" title="All 4 branches missed.">                    || (e.getOldPhase() == Phase.PHASE_FIRING) || (e.getOldPhase() == Phase.PHASE_PHYSICAL))) {</span>
<span class="nc" id="L1784">                File dir = new File(Configuration.gameSummaryImagesMMDir(), m_game.getUUIDString());</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">                if (!dir.exists()) {</span>
<span class="nc" id="L1786">                    dir.mkdirs();</span>
                }
<span class="nc" id="L1788">				File imgFile = new File(dir, &quot;round_&quot; + m_game.getRoundCount() + &quot;_&quot; + e.getOldPhase().ordinal() + &quot;_&quot;</span>
<span class="nc" id="L1789">						+ IGame.Phase.getDisplayableName(e.getOldPhase()) + &quot;.png&quot;);</span>
                try {
<span class="nc" id="L1791">                    ImageIO.write(m_mapImage, &quot;png&quot;, imgFile);</span>
<span class="nc" id="L1792">                } catch (IOException e1) {</span>
<span class="nc" id="L1793">                    e1.printStackTrace();</span>
<span class="nc" id="L1794">                }</span>

            }
<span class="nc" id="L1797">            drawMap();</span>
<span class="nc" id="L1798">        }</span>

        @Override
        public void gameTurnChange(GameTurnChangeEvent e) {
<span class="nc" id="L1802">            drawMap();</span>
<span class="nc" id="L1803">        }</span>

        @Override
        public void gameBoardNew(GameBoardNewEvent e) {
<span class="nc" id="L1807">            IBoard b = e.getOldBoard();</span>
<span class="nc bnc" id="L1808" title="All 2 branches missed.">            if (b != null) {</span>
<span class="nc" id="L1809">                b.removeBoardListener(boardListener);</span>
            }
<span class="nc" id="L1811">            b = e.getNewBoard();</span>
<span class="nc bnc" id="L1812" title="All 2 branches missed.">            if (b != null) {</span>
<span class="nc" id="L1813">                b.addBoardListener(boardListener);</span>
            }
<span class="nc" id="L1815">            m_board = b;</span>
<span class="nc" id="L1816">            initializeMap();</span>
<span class="nc" id="L1817">        }</span>

        @Override
        public void gameBoardChanged(GameBoardChangeEvent e) {
<span class="nc" id="L1821">            drawMap();</span>
<span class="nc" id="L1822">        }</span>
    };

<span class="nc" id="L1825">    BoardViewListener boardViewListener = new BoardViewListenerAdapter() {</span>
        @Override
        public void hexCursor(BoardViewEvent b) {
<span class="nc" id="L1828">            update();</span>
<span class="nc" id="L1829">        }</span>
        
        @Override
        public void hexMoused(BoardViewEvent b) {
<span class="nc" id="L1833">            update();</span>
<span class="nc" id="L1834">        }</span>

        @Override
        public void boardHexHighlighted(BoardViewEvent b) {
<span class="nc" id="L1838">            update();</span>
<span class="nc" id="L1839">        }</span>

        @Override
        public void hexSelected(BoardViewEvent b) {
<span class="nc" id="L1843">            update();</span>
<span class="nc" id="L1844">        }</span>

        @Override
        public void firstLOSHex(BoardViewEvent b) {
<span class="nc" id="L1848">            secondLOS = null;</span>
<span class="nc" id="L1849">            firstLOS = b.getCoords();</span>
<span class="nc" id="L1850">            drawMap();</span>
<span class="nc" id="L1851">        }</span>

        @Override
        public void secondLOSHex(BoardViewEvent b, Coords c) {
<span class="nc" id="L1855">            firstLOS = c;</span>
<span class="nc" id="L1856">            secondLOS = b.getCoords();</span>
<span class="nc" id="L1857">            drawMap();</span>
<span class="nc" id="L1858">        }</span>

        private void update() {
<span class="nc" id="L1861">            firstLOS = null;</span>
<span class="nc" id="L1862">            secondLOS = null;</span>
<span class="nc" id="L1863">            drawMap();</span>
<span class="nc" id="L1864">        }</span>
    };

<span class="nc" id="L1867">    MouseListener mouseListener = new MouseAdapter() {</span>

        public void mouseReleased(MouseEvent me) {
            // Center main map on clicked area, if there was no dragging
<span class="nc bnc" id="L1871" title="All 4 branches missed.">            if (m_dialog instanceof JDialog &amp;&amp; !dragging) {</span>
<span class="nc" id="L1872">                processMouseClick(me.getX(), me.getY(), me);</span>
            }
            // Clear up variables related to dragging
<span class="nc" id="L1875">            dragging = false;</span>
<span class="nc" id="L1876">            setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));</span>
<span class="nc" id="L1877">        }</span>

    };

<span class="nc" id="L1881">    MouseMotionListener mouseMotionListener = new MouseMotionAdapter() {</span>

        @Override
        public void mouseDragged(MouseEvent e) {
<span class="nc bnc" id="L1885" title="All 2 branches missed.">            if (!dragging) {</span>
<span class="nc" id="L1886">                dragging = true;</span>
<span class="nc" id="L1887">                setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));</span>
            }
<span class="nc" id="L1889">            processMouseClick(e.getX(), e.getY(), e);</span>
<span class="nc" id="L1890">        }</span>
    };

<span class="nc" id="L1893">    MouseWheelListener mouseWheelListener = new MouseWheelListener() {</span>
        public void mouseWheelMoved(MouseWheelEvent we) {
<span class="nc bnc" id="L1895" title="All 2 branches missed.">            if (we.getWheelRotation() &lt; 0) {</span>
                //Zoom Out: The processMouseClick method uses absolute
                // positions within the minimap to determine what the click
                // does.  These parameters should activate the zoom-out features
<span class="nc" id="L1899">                processMouseClick(getSize().width - 12, getSize().height - 12, we);</span>
            } else {
                //Zoom In: The processMouseClick method uses absolute
                // positions within the minimap to determine what the click
                // does.  These parameters should activate the zoom-in features
<span class="nc" id="L1904">                processMouseClick(0, getSize().height - 12, we);</span>
            }
<span class="nc" id="L1906">        }</span>
    };

<span class="nc" id="L1909">    ComponentListener componentListener = new ComponentAdapter() {</span>
        @Override
        public void componentShown(ComponentEvent ce) {
<span class="nc" id="L1912">            drawMap();</span>
<span class="nc" id="L1913">        }</span>

        @Override
        public void componentResized(ComponentEvent ce) {
            // if (!minimized) initializeMap();
<span class="nc" id="L1918">        }</span>
    };

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>