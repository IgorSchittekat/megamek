<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonSettingsDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">CommonSettingsDialog.java</span></div><h1>CommonSettingsDialog.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

package megamek.client.ui.swing;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionAdapter;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.File;
import java.io.FilenameFilter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.DefaultListModel;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JSeparator;
import javax.swing.JSlider;
import javax.swing.JTabbedPane;
import javax.swing.JTextField;
import javax.swing.ListSelectionModel;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.ToolTipManager;
import javax.swing.UIManager;
import javax.swing.UIManager.LookAndFeelInfo;
import javax.swing.border.EmptyBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.MouseInputAdapter;

import megamek.client.ui.Messages;
import megamek.client.ui.swing.StatusBarPhaseDisplay.PhaseCommand;
import megamek.client.ui.swing.util.KeyCommandBind;
import megamek.client.ui.swing.widget.SkinXMLHandler;
import megamek.common.Configuration;
import megamek.common.Entity;
import megamek.common.IGame;
import megamek.common.KeyBindParser;
import megamek.common.preference.IClientPreferences;
import megamek.common.preference.PreferenceManager;

public class CommonSettingsDialog extends ClientDialog implements
        ActionListener, ItemListener, FocusListener, ListSelectionListener,
        ChangeListener {

    /**
     * A class for storing information about an GUIPreferences advanced option.
     *
     * @author arlith
     *
     */
    private class AdvancedOptionData implements Comparable&lt;AdvancedOptionData&gt; {

        public String option;

<span class="nc" id="L101">        public AdvancedOptionData(String option) {</span>
<span class="nc" id="L102">            this.option = option;</span>
<span class="nc" id="L103">        }</span>

        /**
         * Returns true if this option has tooltip text.
         *
         * @return
         */
        public boolean hasTooltipText() {
<span class="nc" id="L111">            return Messages.keyExists(&quot;AdvancedOptions.&quot; + option + &quot;.tooltip&quot;);</span>
        }

        /**
         * Returns the tooltip text for this option.
         *
         * @return
         */
        public String getTooltipText() {
<span class="nc" id="L120">            return Messages.getString(&quot;AdvancedOptions.&quot; + option + &quot;.tooltip&quot;);</span>
        }

        /**
         * Returns a human-readable name for this advanced option.
         *
         */
        public String toString() {
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (Messages.keyExists(&quot;AdvancedOptions.&quot; + option + &quot;.name&quot;)) {</span>
<span class="nc" id="L129">                return Messages.getString(&quot;AdvancedOptions.&quot; + option + &quot;.name&quot;);</span>
            } else {
<span class="nc" id="L131">                return option;</span>
            }
        }

        @Override
        public int compareTo(AdvancedOptionData other) {
<span class="nc" id="L137">            return this.toString().compareTo(other.toString());</span>
        }
    }

<span class="nc" id="L141">    private class PhaseCommandListMouseAdapter extends MouseInputAdapter {</span>
<span class="nc" id="L142">        private boolean mouseDragging = false;</span>
        private int dragSourceIndex;

        @Override
        public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (SwingUtilities.isLeftMouseButton(e)) {</span>
<span class="nc" id="L148">                Object src = e.getSource();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                if (src instanceof JList) {</span>
<span class="nc" id="L150">                    dragSourceIndex = ((JList&lt;?&gt;) src).getSelectedIndex();</span>
<span class="nc" id="L151">                    mouseDragging = true;</span>
                }                
            }
<span class="nc" id="L154">        }</span>

        @Override
        public void mouseReleased(MouseEvent e) {
<span class="nc" id="L158">            mouseDragging = false;</span>
<span class="nc" id="L159">        }</span>

        @Override
        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L163">            Object src = e.getSource();</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">            if (mouseDragging &amp;&amp; (src instanceof JList)) {</span>
<span class="nc" id="L165">                JList&lt;?&gt; srcList = (JList&lt;?&gt;) src;</span>
<span class="nc" id="L166">                DefaultListModel&lt;?&gt; srcModel = (DefaultListModel&lt;?&gt;) srcList.getModel();</span>
<span class="nc" id="L167">                int currentIndex = srcList.locationToIndex(e.getPoint());</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                if (currentIndex != dragSourceIndex) {</span>
<span class="nc" id="L169">                    int dragTargetIndex = srcList.getSelectedIndex();</span>
<span class="nc" id="L170">                    moveElement(srcModel, dragSourceIndex, dragTargetIndex);</span>
<span class="nc" id="L171">                    dragSourceIndex = currentIndex;</span>
                }
            }
<span class="nc" id="L174">        }</span>

        private &lt;T&gt; void moveElement(DefaultListModel&lt;T&gt; srcModel, int srcIndex, int trgIndex) {
<span class="nc" id="L177">            T dragElement = srcModel.get(srcIndex);</span>
<span class="nc" id="L178">            srcModel.remove(srcIndex);</span>
<span class="nc" id="L179">            srcModel.add(trgIndex, dragElement);</span>
<span class="nc" id="L180">        }</span>

    }
    
    /**
     *
     */
    private static final long serialVersionUID = 1535370193846895473L;

    private JCheckBox autoEndFiring;
    private JCheckBox autoDeclareSearchlight;
    private JCheckBox nagForMASC;
    private JCheckBox nagForPSR;
    private JCheckBox nagForWiGELanding;
    private JCheckBox nagForNoAction;
    private JCheckBox animateMove;
    private JCheckBox showWrecks;
    private JCheckBox soundMute;
    private JCheckBox showWpsinTT;
    private JCheckBox showArmorMiniVisTT;
    private JCheckBox showPilotPortraitTT;
    private JCheckBox chkAntiAliasing;
    private JComboBox&lt;String&gt; defaultWeaponSortOrder;
    private JTextField tooltipDelay;
    private JTextField tooltipDismissDelay;
    private JTextField tooltipDistSupression;
    private JComboBox&lt;String&gt; unitStartChar;
    private JTextField maxPathfinderTime;
    private JCheckBox getFocus;

    private JCheckBox keepGameLog;
    private JTextField gameLogFilename;
    // private JTextField gameLogMaxSize;
    private JCheckBox stampFilenames;
    private JTextField stampFormat;
    private JCheckBox defaultAutoejectDisabled;
    private JCheckBox useAverageSkills;
    private JCheckBox generateNames;
    private JCheckBox showUnitId;
    private JComboBox&lt;String&gt; displayLocale;
    private JCheckBox showIPAddressesInChat;

    private JCheckBox showDamageLevel;
    private JCheckBox showDamageDecal;
    private JCheckBox showMapsheets;
    private JCheckBox aOHexShadows;
    private JCheckBox floatingIso;
    private JCheckBox mmSymbol;
    private JCheckBox entityOwnerColor;
    private JCheckBox teamColoring;
    private JCheckBox useSoftCenter;
    private JCheckBox levelhighlight;
    private JCheckBox shadowMap;
    private JCheckBox hexInclines;
    private JCheckBox mouseWheelZoom;
    private JCheckBox mouseWheelZoomFlip;

    // Tactical Overlay Options
    private JCheckBox fovInsideEnabled;
    private JSlider fovHighlightAlpha;
    private JCheckBox fovOutsideEnabled;
    private JSlider fovDarkenAlpha;
    private JSlider numStripesSlider;
    private JCheckBox fovGrayscaleEnabled;
    private JTextField fovHighlightRingsRadii;
    private JTextField fovHighlightRingsColors;
    
    // Labels (there to make it possible to disable them)
    private JLabel darkenAlphaLabel;
    private JLabel numStripesLabel;
    private JLabel fovHighlightRingsColorsLabel;
    private JLabel fovHighlightRingsRadiiLabel;
    private JLabel highlightAlphaLabel;
    
    private JLabel stampFormatLabel;
    private JLabel gameLogFilenameLabel;

    private JCheckBox gameSummaryBV;
    private JCheckBox gameSummaryMM;

    private JComboBox&lt;String&gt; skinFiles;

    private JComboBox&lt;UITheme&gt; uiThemes;

    // Avanced Settings
    private JList&lt;AdvancedOptionData&gt; advancedKeys;
<span class="nc" id="L266">    private int advancedKeyIndex = 0;</span>
    private JTextField advancedValue;

    // Button order
    private DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt; movePhaseCommands;
    private DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt; deployPhaseCommands;
    private DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt; firingPhaseCommands;
    private DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt; physicalPhaseCommands;
    private DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt; targetingPhaseCommands;
<span class="nc" id="L275">    private StatusBarPhaseDisplay.CommandComparator cmdComp = new StatusBarPhaseDisplay.CommandComparator(); </span>
<span class="nc" id="L276">    private PhaseCommandListMouseAdapter cmdMouseAdaptor = new PhaseCommandListMouseAdapter();</span>
    
    private JComboBox&lt;String&gt; tileSetChoice;
    private List&lt;File&gt; tileSets;

    /**
     * A Map that maps command strings to a JTextField for updating the modifier
     * for the command.
     */
    private Map&lt;String, JTextField&gt; cmdModifierMap;

    /**
     * A Map that maps command strings to a Integer for updating the key
     * for the command.
     */
    private Map&lt;String, Integer&gt; cmdKeyMap;

    /**
     * A Map that maps command strings to a JCheckBox for updating the
     * isRepeatable flag.
     */
    private Map&lt;String, JCheckBox&gt; cmdRepeatableMap;
    
<span class="nc" id="L299">    private ClientGUI clientgui = null;</span>

    private static final String CANCEL = &quot;CANCEL&quot;; //$NON-NLS-1$
    private static final String UPDATE = &quot;UPDATE&quot;; //$NON-NLS-1$

<span class="nc" id="L304">    private static final String[] LOCALE_CHOICES = { &quot;en&quot;, &quot;de&quot;, &quot;ru&quot; }; //$NON-NLS-1$</span>
    
<span class="nc" id="L306">    private static final Dimension LABEL_SPACER = new Dimension(5,0);</span>
<span class="nc" id="L307">    private static final Dimension DEPENDENT_INSET = new Dimension(25,0);</span>
    
    // Save some values to restore them when the dialog is canceled
    private boolean savedFovHighlight;
    private boolean savedFovDarken;
    private boolean savedFovGrayscale;
    private boolean savedAOHexShadows;
    private boolean savedShadowMap;
    private boolean savedHexInclines;
    private boolean savedLevelhighlight;
    private boolean savedFloatingIso;
    private boolean savedMmSymbol;
    private boolean savedTeamColoring;
    private boolean savedUnitLabelBorder;
    private boolean savedShowDamageDecal;
    private boolean savedShowDamageLabel;
    private String savedFovHighlightRingsRadii;
    private String savedFovHighlightRingsColors;
    private int savedFovHighlightAlpha;
    private int savedFovDarkenAlpha;
    private int savedNumStripesSlider;
<span class="nc" id="L328">    HashMap&lt;String, String&gt; savedAdvancedOpt = new HashMap&lt;&gt;();</span>

    /**
     * Standard constructor. There is no default constructor for this class.
     *
     * @param owner - the &lt;code&gt;Frame&lt;/code&gt; that owns this dialog.
     */
    public CommonSettingsDialog(JFrame owner, ClientGUI cg) {
<span class="nc" id="L336">        this(owner);</span>
<span class="nc" id="L337">        clientgui = cg;</span>
<span class="nc" id="L338">    }</span>
    
    /**
     * Standard constructor. There is no default constructor for this class.
     *
     * @param owner - the &lt;code&gt;Frame&lt;/code&gt; that owns this dialog.
     */
    public CommonSettingsDialog(JFrame owner) {
<span class="nc" id="L346">        super(owner, Messages.getString(&quot;CommonSettingsDialog.title&quot;), true);</span>

<span class="nc" id="L348">        JTabbedPane panTabs = new JTabbedPane();</span>
<span class="nc" id="L349">        setLayout(new BorderLayout());</span>
<span class="nc" id="L350">        getContentPane().add(panTabs, BorderLayout.CENTER);</span>
<span class="nc" id="L351">        getContentPane().add(getButtonsPanel(), BorderLayout.PAGE_END);</span>
        // Close this dialog when the window manager says to.
<span class="nc" id="L353">        addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L356">                cancel();</span>
<span class="nc" id="L357">            }</span>
        });

        // Add the tabs
<span class="nc" id="L361">        JPanel settingsPanel = getSettingsPanel();</span>
<span class="nc" id="L362">        JScrollPane settingsPane = new JScrollPane(getSettingsPanel());</span>
<span class="nc" id="L363">        settingsPane.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L364">        panTabs.add(&quot;Main&quot;, settingsPane);</span>
        
<span class="nc" id="L366">        JScrollPane graphicsPane = new JScrollPane(getGraphicsPanel());</span>
<span class="nc" id="L367">        graphicsPane.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L368">        panTabs.add(&quot;Graphics&quot;, graphicsPane);</span>

<span class="nc" id="L370">        JScrollPane keyBindPane = new JScrollPane(getKeyBindPanel());</span>
<span class="nc" id="L371">        keyBindPane.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L372">        panTabs.add(&quot;Key Binds&quot;, keyBindPane);</span>

<span class="nc" id="L374">        panTabs.add(&quot;Button Order&quot;, getButtonOrderPanel());</span>
        
<span class="nc" id="L376">        JScrollPane advancedSettingsPane = new JScrollPane(getAdvancedSettingsPanel());</span>
<span class="nc" id="L377">        advancedSettingsPane.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L378">        panTabs.add(&quot;Advanced&quot;, advancedSettingsPane);</span>

<span class="nc" id="L380">        pack();</span>
<span class="nc" id="L381">        setLocationAndSize(getPreferredSize().width, settingsPanel.getPreferredSize().height);</span>
<span class="nc" id="L382">    }</span>

    private JPanel getButtonsPanel() {
        // Add the dialog controls.
<span class="nc" id="L386">        JPanel buttons = new JPanel();</span>
<span class="nc" id="L387">        buttons.setLayout(new GridLayout(1, 0, 20, 5));</span>
<span class="nc" id="L388">        JButton update = new JButton(Messages.getString(&quot;CommonSettingsDialog.Update&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L389">        update.setActionCommand(UPDATE);</span>
<span class="nc" id="L390">        update.addActionListener(this);</span>
<span class="nc" id="L391">        buttons.add(update);</span>
<span class="nc" id="L392">        JButton cancel = new JButton(Messages.getString(&quot;Cancel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L393">        cancel.setActionCommand(CANCEL);</span>
<span class="nc" id="L394">        cancel.addActionListener(this);</span>
<span class="nc" id="L395">        buttons.add(cancel);</span>

<span class="nc" id="L397">        return buttons;</span>
    }

    private JPanel getSettingsPanel() {

<span class="nc" id="L402">        ArrayList&lt;ArrayList&lt;Component&gt;&gt; comps = new ArrayList&lt;ArrayList&lt;Component&gt;&gt;();</span>
        ArrayList&lt;Component&gt; row;

        // displayLocale settings
<span class="nc" id="L406">        JLabel displayLocaleLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.locale&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L407">        displayLocale = new JComboBox&lt;String&gt;();</span>
<span class="nc" id="L408">        displayLocale.addItem(Messages.getString(&quot;CommonSettingsDialog.locale.English&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L409">        displayLocale.addItem(Messages.getString(&quot;CommonSettingsDialog.locale.Deutsch&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L410">        displayLocale.addItem(Messages.getString(&quot;CommonSettingsDialog.locale.Russian&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L411">        displayLocale.setMaximumSize(new Dimension(150,40));</span>
<span class="nc" id="L412">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L413">        row.add(displayLocaleLabel);</span>
<span class="nc" id="L414">        row.add(displayLocale);</span>
<span class="nc" id="L415">        comps.add(row);</span>
        
        // Horizontal Line and Spacer
<span class="nc" id="L418">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L419">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L420">        comps.add(row);</span>

<span class="nc" id="L422">        JSeparator Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L423">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L424">        row.add(Sep);</span>
<span class="nc" id="L425">        comps.add(row);</span>
        
<span class="nc" id="L427">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L428">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L429">        comps.add(row);</span>
        // --------------        

<span class="nc" id="L432">        showDamageLevel = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showDamageLevel&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L433">        showDamageLevel.addItemListener(this);</span>
<span class="nc" id="L434">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L435">        row.add(showDamageLevel);</span>
<span class="nc" id="L436">        comps.add(row);</span>
        
<span class="nc" id="L438">        showDamageDecal = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showDamageDecal&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L439">        showDamageDecal.addItemListener(this);</span>
<span class="nc" id="L440">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L441">        row.add(showDamageDecal);</span>
<span class="nc" id="L442">        comps.add(row);</span>
        
<span class="nc" id="L444">        showUnitId = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showUnitId&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L445">        showUnitId.addItemListener(this);</span>
<span class="nc" id="L446">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L447">        row.add(showUnitId);</span>
<span class="nc" id="L448">        comps.add(row);</span>

<span class="nc" id="L450">        entityOwnerColor = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.entityOwnerColor&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L451">        entityOwnerColor.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.entityOwnerColorTip&quot;));</span>
<span class="nc" id="L452">        entityOwnerColor.addItemListener(this);</span>
<span class="nc" id="L453">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L454">        row.add(entityOwnerColor);</span>
<span class="nc" id="L455">        comps.add(row);</span>
        
<span class="nc" id="L457">        teamColoring = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.teamColoring&quot;));</span>
<span class="nc" id="L458">        teamColoring.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.teamColoringTip&quot;));</span>
<span class="nc" id="L459">        teamColoring.addItemListener(this);</span>
<span class="nc" id="L460">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L461">        row.add(teamColoring);</span>
<span class="nc" id="L462">        comps.add(row);</span>
        
<span class="nc" id="L464">        useSoftCenter = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.useSoftCenter&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L465">        useSoftCenter.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.useSoftCenterTip&quot;));</span>
<span class="nc" id="L466">        useSoftCenter.addItemListener(this);</span>
<span class="nc" id="L467">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L468">        row.add(useSoftCenter);</span>
<span class="nc" id="L469">        comps.add(row);</span>
        
        // Horizontal Line and Spacer
<span class="nc" id="L472">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L473">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L474">        comps.add(row);</span>

<span class="nc" id="L476">        Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L477">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L478">        row.add(Sep);</span>
<span class="nc" id="L479">        comps.add(row);</span>
        
<span class="nc" id="L481">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L482">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L483">        comps.add(row);</span>
        // --------------        

        // Tooltip Stuff
        //
        // Popup Delay and Dismiss Delay
<span class="nc" id="L489">        tooltipDelay = new JTextField(4);</span>
<span class="nc" id="L490">        tooltipDelay.setMaximumSize(new Dimension(150,40));</span>
<span class="nc" id="L491">        JLabel tooltipDelayLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.tooltipDelay&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L492">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L493">        row.add(tooltipDelayLabel);</span>
<span class="nc" id="L494">        row.add(tooltipDelay);</span>
<span class="nc" id="L495">        comps.add(row);</span>

<span class="nc" id="L497">        tooltipDismissDelay = new JTextField(4);</span>
<span class="nc" id="L498">        tooltipDismissDelay.setMaximumSize(new Dimension(150,40));</span>
<span class="nc" id="L499">        tooltipDismissDelay.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.tooltipDismissDelayTooltip&quot;));</span>
<span class="nc" id="L500">        JLabel tooltipDismissDelayLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.tooltipDismissDelay&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L501">        tooltipDismissDelayLabel.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.tooltipDismissDelayTooltip&quot;));</span>
<span class="nc" id="L502">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L503">        row.add(tooltipDismissDelayLabel);</span>
<span class="nc" id="L504">        row.add(tooltipDismissDelay);</span>
<span class="nc" id="L505">        comps.add(row);</span>
        
<span class="nc" id="L507">        tooltipDistSupression = new JTextField(4);</span>
<span class="nc" id="L508">        tooltipDistSupression.setMaximumSize(new Dimension(150,40));</span>
<span class="nc" id="L509">        tooltipDistSupression.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.tooltipDistSuppressionTooltip&quot;));</span>
<span class="nc" id="L510">        JLabel tooltipDistSupressionLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.tooltipDistSuppression&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L511">        tooltipDistSupressionLabel.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.tooltipDistSuppressionTooltip&quot;));</span>
<span class="nc" id="L512">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L513">        row.add(tooltipDistSupressionLabel);</span>
<span class="nc" id="L514">        row.add(tooltipDistSupression);</span>
<span class="nc" id="L515">        comps.add(row);</span>

<span class="nc" id="L517">        showWpsinTT = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showWpsinTT&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L518">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L519">        row.add(showWpsinTT);</span>
<span class="nc" id="L520">        comps.add(row);</span>

        // copied from showWpsinTT, kept comment as it looks like a relevant compiler/editor flag?
<span class="nc" id="L523">        showArmorMiniVisTT = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showArmorMiniVisTT&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L524">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L525">        row.add(showArmorMiniVisTT);</span>
<span class="nc" id="L526">        comps.add(row);</span>
        
<span class="nc" id="L528">        showPilotPortraitTT = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showPilotPortraitTT&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L529">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L530">        row.add(showPilotPortraitTT);</span>
<span class="nc" id="L531">        comps.add(row);</span>
        
        // Horizontal Line and Spacer
<span class="nc" id="L534">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L535">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L536">        comps.add(row);</span>

<span class="nc" id="L538">        Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L539">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L540">        row.add(Sep);</span>
<span class="nc" id="L541">        comps.add(row);</span>
        
<span class="nc" id="L543">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L544">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L545">        comps.add(row);</span>
        // --------------        
        
<span class="nc" id="L548">        soundMute = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.soundMute&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L549">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L550">        row.add(soundMute);</span>
<span class="nc" id="L551">        comps.add(row);</span>
        
<span class="nc" id="L553">        JLabel maxPathfinderTimeLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.pathFiderTimeLimit&quot;));</span>
<span class="nc" id="L554">        maxPathfinderTime = new JTextField(5);</span>
<span class="nc" id="L555">        maxPathfinderTime.setMaximumSize(new Dimension(150,40));</span>
<span class="nc" id="L556">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L557">        row.add(maxPathfinderTimeLabel);</span>
<span class="nc" id="L558">        row.add(maxPathfinderTime);</span>
<span class="nc" id="L559">        comps.add(row);</span>

        // Horizontal Line and Spacer
<span class="nc" id="L562">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L563">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L564">        comps.add(row);</span>

<span class="nc" id="L566">        Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L567">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L568">        row.add(Sep);</span>
<span class="nc" id="L569">        comps.add(row);</span>
        
<span class="nc" id="L571">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L572">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L573">        comps.add(row);</span>
        // --------------
        
<span class="nc" id="L576">        nagForMASC = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.nagForMASC&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L577">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L578">        row.add(nagForMASC);</span>
<span class="nc" id="L579">        comps.add(row);</span>

<span class="nc" id="L581">        nagForPSR = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.nagForPSR&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L582">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L583">        row.add(nagForPSR);</span>
<span class="nc" id="L584">        comps.add(row);</span>

<span class="nc" id="L586">        nagForWiGELanding = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.nagForWiGELanding&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L587">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L588">        row.add(nagForWiGELanding);</span>
<span class="nc" id="L589">        comps.add(row);</span>

<span class="nc" id="L591">        nagForNoAction = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.nagForNoAction&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L592">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L593">        row.add(nagForNoAction);</span>
<span class="nc" id="L594">        comps.add(row);</span>
        
<span class="nc" id="L596">        getFocus = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.getFocus&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L597">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L598">        row.add(getFocus);</span>
<span class="nc" id="L599">        comps.add(row);</span>
<span class="nc" id="L600">        mouseWheelZoom = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.mouseWheelZoom&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L601">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L602">        row.add(mouseWheelZoom);</span>
<span class="nc" id="L603">        comps.add(row);</span>

<span class="nc" id="L605">        mouseWheelZoomFlip = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.mouseWheelZoomFlip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L606">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L607">        row.add(mouseWheelZoomFlip);</span>
<span class="nc" id="L608">        comps.add(row);</span>

<span class="nc" id="L610">        autoEndFiring = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.autoEndFiring&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L611">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L612">        row.add(autoEndFiring);</span>
<span class="nc" id="L613">        comps.add(row);</span>

<span class="nc" id="L615">        autoDeclareSearchlight = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.autoDeclareSearchlight&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L616">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L617">        row.add(autoDeclareSearchlight);</span>
<span class="nc" id="L618">        comps.add(row);</span>
        
<span class="nc" id="L620">        JLabel defaultSortOrderLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.defaultWeaponSortOrder&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L621">        String toolTip = Messages</span>
<span class="nc" id="L622">                .getString(&quot;CommonSettingsDialog.defaultWeaponSortOrderTooltip&quot;);</span>
<span class="nc" id="L623">        defaultSortOrderLabel.setToolTipText(toolTip);</span>
<span class="nc" id="L624">        defaultWeaponSortOrder = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L625">        defaultWeaponSortOrder.setToolTipText(toolTip);</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">        for (Entity.WeaponSortOrder s : Entity.WeaponSortOrder.values()) {</span>
            // Skip custom: it doesn't make sense as a default.
<span class="nc bnc" id="L628" title="All 2 branches missed.">            if (s.equals(Entity.WeaponSortOrder.CUSTOM)) {</span>
<span class="nc" id="L629">                continue;</span>
            }
<span class="nc" id="L631">            String entry = &quot;MechDisplay.WeaponSortOrder.&quot; + s.i18nEntry;</span>
<span class="nc" id="L632">            defaultWeaponSortOrder.addItem(Messages.getString(entry));</span>
        }
<span class="nc" id="L634">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L635">        row.add(defaultSortOrderLabel);</span>
<span class="nc" id="L636">        row.add(defaultWeaponSortOrder);</span>
<span class="nc" id="L637">        comps.add(row);</span>

        // Horizontal Line and Spacer
<span class="nc" id="L640">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L641">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L642">        comps.add(row);</span>

<span class="nc" id="L644">        Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L645">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L646">        row.add(Sep);</span>
<span class="nc" id="L647">        comps.add(row);</span>
        
<span class="nc" id="L649">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L650">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L651">        comps.add(row);</span>
        // --------------        

<span class="nc" id="L654">        JLabel unitStartCharLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.protoMechUnitCodes&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L655">        unitStartChar = new JComboBox&lt;String&gt;();</span>
        // Add option for &quot;A, B, C, D...&quot;
<span class="nc" id="L657">        unitStartChar.addItem(&quot;\u0041, \u0042, \u0043, \u0044...&quot;); //$NON-NLS-1$</span>
        // Add option for &quot;ALPHA, BETA, GAMMA, DELTA...&quot;
<span class="nc" id="L659">        unitStartChar.addItem(&quot;\u0391, \u0392, \u0393, \u0394...&quot;); //$NON-NLS-1$</span>
        // Add option for &quot;alpha, beta, gamma, delta...&quot;
<span class="nc" id="L661">        unitStartChar.addItem(&quot;\u03B1, \u03B2, \u03B3, \u03B4...&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L662">        unitStartChar.setMaximumSize(new Dimension(150,40));</span>
<span class="nc" id="L663">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L664">        row.add(unitStartCharLabel);</span>
<span class="nc" id="L665">        row.add(unitStartChar);</span>
<span class="nc" id="L666">        comps.add(row);</span>

        // player-specific settings
<span class="nc" id="L669">        defaultAutoejectDisabled = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.defaultAutoejectDisabled&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L670">        defaultAutoejectDisabled.addItemListener(this);</span>
<span class="nc" id="L671">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L672">        row.add(defaultAutoejectDisabled);</span>
<span class="nc" id="L673">        comps.add(row);</span>

<span class="nc" id="L675">        useAverageSkills = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.useAverageSkills&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L676">        useAverageSkills.addItemListener(this);</span>
<span class="nc" id="L677">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L678">        row.add(useAverageSkills);</span>
<span class="nc" id="L679">        comps.add(row);</span>

<span class="nc" id="L681">        generateNames = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.generateNames&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L682">        generateNames.addItemListener(this);</span>
<span class="nc" id="L683">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L684">        row.add(generateNames);</span>
<span class="nc" id="L685">        comps.add(row);</span>
        
        // Horizontal Line and Spacer
<span class="nc" id="L688">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L689">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L690">        comps.add(row);</span>

<span class="nc" id="L692">        Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L693">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L694">        row.add(Sep);</span>
<span class="nc" id="L695">        comps.add(row);</span>
        
<span class="nc" id="L697">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L698">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L699">        comps.add(row);</span>
        // --------------  

        // client-side gameLog settings
<span class="nc" id="L703">        keepGameLog = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.keepGameLog&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L704">        keepGameLog.addItemListener(this);</span>
<span class="nc" id="L705">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L706">        row.add(keepGameLog);</span>
<span class="nc" id="L707">        comps.add(row);</span>

<span class="nc" id="L709">        gameLogFilenameLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.logFileName&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L710">        gameLogFilename = new JTextField(15);</span>
<span class="nc" id="L711">        gameLogFilename.setMaximumSize(new Dimension(250,40));</span>
<span class="nc" id="L712">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L713">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L714">        row.add(gameLogFilenameLabel);</span>
<span class="nc" id="L715">        row.add(gameLogFilename);</span>
<span class="nc" id="L716">        comps.add(row);</span>
        
<span class="nc" id="L718">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L719">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L720">        comps.add(row);</span>

<span class="nc" id="L722">        stampFilenames = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.stampFilenames&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L723">        stampFilenames.addItemListener(this);</span>
<span class="nc" id="L724">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L725">        row.add(stampFilenames);</span>
<span class="nc" id="L726">        comps.add(row);</span>

<span class="nc" id="L728">        stampFormatLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.stampFormat&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L729">        stampFormat = new JTextField(15);</span>
<span class="nc" id="L730">        stampFormat.setMaximumSize(new Dimension(15*13,40));</span>
<span class="nc" id="L731">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L732">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L733">        row.add(stampFormatLabel);</span>
<span class="nc" id="L734">        row.add(stampFormat);</span>
<span class="nc" id="L735">        comps.add(row);</span>

        // Horizontal Line and Spacer
<span class="nc" id="L738">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L739">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L740">        comps.add(row);</span>

<span class="nc" id="L742">        Sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L743">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L744">        row.add(Sep);</span>
<span class="nc" id="L745">        comps.add(row);</span>
        
<span class="nc" id="L747">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L748">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L749">        comps.add(row);</span>
        // -------------- 

<span class="nc" id="L752">        showIPAddressesInChat = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showIPAddressesInChat&quot;));</span>
<span class="nc" id="L753">        showIPAddressesInChat.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.showIPAddressesInChat.tooltip&quot;));</span>
<span class="nc" id="L754">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L755">        row.add(showIPAddressesInChat);</span>
<span class="nc" id="L756">        comps.add(row);</span>

<span class="nc" id="L758">        return createSettingsPanel(comps);</span>
    }

    /**
     * Display the current settings in this dialog. &lt;p/&gt; Overrides
     * &lt;code&gt;Dialog#setVisible(boolean)&lt;/code&gt;.
     */
    @Override
    public void setVisible(boolean visible) {
        // Initialize the dialog when it's being shown
<span class="nc bnc" id="L768" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L769">            GUIPreferences gs = GUIPreferences.getInstance();</span>
<span class="nc" id="L770">            IClientPreferences cs = PreferenceManager.getClientPreferences();</span>

<span class="nc" id="L772">            autoEndFiring.setSelected(gs.getAutoEndFiring());</span>
<span class="nc" id="L773">            autoDeclareSearchlight.setSelected(gs.getAutoDeclareSearchlight());</span>
<span class="nc" id="L774">            nagForMASC.setSelected(gs.getNagForMASC());</span>
<span class="nc" id="L775">            nagForPSR.setSelected(gs.getNagForPSR());</span>
<span class="nc" id="L776">            nagForWiGELanding.setSelected(gs.getNagForWiGELanding());</span>
<span class="nc" id="L777">            nagForNoAction.setSelected(gs.getNagForNoAction());</span>
<span class="nc" id="L778">            animateMove.setSelected(gs.getShowMoveStep());</span>
<span class="nc" id="L779">            showWrecks.setSelected(gs.getShowWrecks());</span>
<span class="nc" id="L780">            soundMute.setSelected(gs.getSoundMute());</span>
<span class="nc" id="L781">            tooltipDelay.setText(Integer.toString(gs.getTooltipDelay()));</span>
<span class="nc" id="L782">            tooltipDismissDelay.setText(Integer.toString(gs.getTooltipDismissDelay()));</span>
<span class="nc" id="L783">            tooltipDistSupression.setText(Integer.toString(gs.getTooltipDistSuppression()));</span>
<span class="nc" id="L784">            showWpsinTT.setSelected(gs.getShowWpsinTT());</span>
<span class="nc" id="L785">            showArmorMiniVisTT.setSelected(gs.getshowArmorMiniVisTT());</span>
<span class="nc" id="L786">            showPilotPortraitTT.setSelected(gs.getshowPilotPortraitTT());</span>

<span class="nc" id="L788">            defaultWeaponSortOrder.setSelectedIndex(gs.getDefaultWeaponSortOrder());</span>
            
<span class="nc" id="L790">            mouseWheelZoom.setSelected(gs.getMouseWheelZoom());</span>
<span class="nc" id="L791">            mouseWheelZoomFlip.setSelected(gs.getMouseWheelZoomFlip());</span>

            // Select the correct char set (give a nice default to start).
<span class="nc" id="L794">            unitStartChar.setSelectedIndex(0);</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">            for (int loop = 0; loop &lt; unitStartChar.getItemCount(); loop++) {</span>
<span class="nc" id="L796">                if (unitStartChar.getItemAt(loop).charAt(0) == PreferenceManager</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                        .getClientPreferences().getUnitStartChar()) {</span>
<span class="nc" id="L798">                    unitStartChar.setSelectedIndex(loop);</span>
<span class="nc" id="L799">                    break;</span>
                }
            }

<span class="nc" id="L803">            maxPathfinderTime.setText(Integer.toString(cs.getMaxPathfinderTime()));</span>

<span class="nc" id="L805">            keepGameLog.setSelected(cs.keepGameLog());</span>
<span class="nc" id="L806">            gameLogFilename.setEnabled(keepGameLog.isSelected());</span>
<span class="nc" id="L807">            gameLogFilename.setText(cs.getGameLogFilename());</span>
            // gameLogMaxSize.setEnabled(keepGameLog.isSelected());
            // gameLogMaxSize.setText( Integer.toString(cs.getGameLogMaxSize()) );
<span class="nc" id="L810">            stampFilenames.setSelected(cs.stampFilenames());</span>
<span class="nc" id="L811">            stampFormat.setEnabled(stampFilenames.isSelected());</span>
<span class="nc" id="L812">            stampFormat.setText(cs.getStampFormat());</span>
<span class="nc" id="L813">            showIPAddressesInChat.setSelected(cs.getShowIPAddressesInChat());</span>

<span class="nc" id="L815">            defaultAutoejectDisabled.setSelected(cs.defaultAutoejectDisabled());</span>
<span class="nc" id="L816">            useAverageSkills.setSelected(cs.useAverageSkills());</span>
<span class="nc" id="L817">            generateNames.setSelected(cs.generateNames());</span>
<span class="nc" id="L818">            showUnitId.setSelected(cs.getShowUnitId());</span>

<span class="nc" id="L820">            int index = 0;</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">            if (cs.getLocaleString().startsWith(&quot;de&quot;)) {</span>
<span class="nc" id="L822">                index = 1;</span>
            }
<span class="nc bnc" id="L824" title="All 2 branches missed.">            if (cs.getLocaleString().startsWith(&quot;ru&quot;)) {</span>
<span class="nc" id="L825">                index = 2;</span>
            }
<span class="nc" id="L827">            displayLocale.setSelectedIndex(index);</span>

<span class="nc" id="L829">            showMapsheets.setSelected(gs.getShowMapsheets());</span>
<span class="nc" id="L830">            chkAntiAliasing.setSelected(gs.getAntiAliasing());</span>
<span class="nc" id="L831">            showDamageLevel.setSelected(gs.getShowDamageLevel());</span>
<span class="nc" id="L832">            showDamageDecal.setSelected(gs.getShowDamageDecal());</span>
<span class="nc" id="L833">            aOHexShadows.setSelected(gs.getAOHexShadows());</span>
<span class="nc" id="L834">            floatingIso.setSelected(gs.getFloatingIso());</span>
<span class="nc" id="L835">            mmSymbol.setSelected(gs.getMmSymbol());</span>
<span class="nc" id="L836">            levelhighlight.setSelected(gs.getLevelHighlight());</span>
<span class="nc" id="L837">            shadowMap.setSelected(gs.getShadowMap());</span>
<span class="nc" id="L838">            hexInclines.setSelected(gs.getHexInclines());</span>
<span class="nc" id="L839">            useSoftCenter.setSelected(gs.getBoolean(&quot;SOFTCENTER&quot;));</span>
<span class="nc" id="L840">            entityOwnerColor.setSelected(gs.getUnitLabelBorder());</span>
<span class="nc" id="L841">            teamColoring.setSelected(gs.getTeamColoring());</span>

<span class="nc" id="L843">            File dir = Configuration.hexesDir();</span>
<span class="nc" id="L844">            tileSets = new ArrayList&lt;&gt;(Arrays.asList(dir.listFiles(new FilenameFilter() {</span>
                public boolean accept(File direc, String name) {
<span class="nc" id="L846">                    return name.endsWith(&quot;.tileset&quot;);</span>
                }
            })));
<span class="nc" id="L849">            dir = new File(Configuration.userdataDir(),</span>
<span class="nc" id="L850">                    Configuration.hexesDir().toString());</span>
<span class="nc" id="L851">            File[] userDataTilesets = dir.listFiles(new FilenameFilter() {</span>
                public boolean accept(File direc, String name) {
<span class="nc" id="L853">                    return name.endsWith(&quot;.tileset&quot;);</span>
                }
            });
<span class="nc bnc" id="L856" title="All 2 branches missed.">            if (userDataTilesets != null) {</span>
<span class="nc" id="L857">                tileSets.addAll(Arrays.asList(userDataTilesets));</span>
            }
<span class="nc" id="L859">            tileSetChoice.removeAllItems();</span>
<span class="nc bnc" id="L860" title="All 4 branches missed.">            for (int i = 0; (tileSets != null) &amp;&amp; i &lt; tileSets.size(); i++) {</span>
<span class="nc" id="L861">                String name = tileSets.get(i).getName();</span>
<span class="nc" id="L862">                tileSetChoice.addItem(name.substring(0, name.length() - 8));</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">                if (name.equals(cs.getMapTileset())) {</span>
<span class="nc" id="L864">                    tileSetChoice.setSelectedIndex(i);</span>
                }
            }

<span class="nc" id="L868">	        gameSummaryBV.setSelected(gs.getGameSummaryBoardView());</span>
<span class="nc" id="L869">	        gameSummaryMM.setSelected(gs.getGameSummaryMiniMap());</span>

<span class="nc" id="L871">            skinFiles.removeAllItems();</span>
<span class="nc" id="L872">            List&lt;String&gt; xmlFiles = new ArrayList&lt;&gt;(Arrays</span>
<span class="nc" id="L873">                    .asList(Configuration.skinsDir().list(new FilenameFilter() {</span>
                        public boolean accept(File directory, String fileName) {
<span class="nc" id="L875">                            return fileName.endsWith(&quot;.xml&quot;);</span>
                        }
                    })));
<span class="nc" id="L878">            String[] files = new File(Configuration.userdataDir(), Configuration.skinsDir().toString())</span>
<span class="nc" id="L879">                    .list(new FilenameFilter() {</span>
                        public boolean accept(File directory, String fileName) {
<span class="nc" id="L881">                            return fileName.endsWith(&quot;.xml&quot;);</span>
                        }
                    });
<span class="nc bnc" id="L884" title="All 2 branches missed.">            if (files != null) {</span>
<span class="nc" id="L885">                xmlFiles.addAll(Arrays.asList(files));</span>

            }
<span class="nc" id="L888">            Collections.sort(xmlFiles);</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">            for (String file : xmlFiles) {</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">                if (SkinXMLHandler.validSkinSpecFile(file)) {</span>
<span class="nc" id="L891">                    skinFiles.addItem(file);</span>
                }
<span class="nc" id="L893">            }</span>
            // Select the default file first
<span class="nc" id="L895">            skinFiles.setSelectedItem(SkinXMLHandler.defaultSkinXML);</span>
            // If this select fials, the default skin will be selected
<span class="nc" id="L897">            skinFiles.setSelectedItem(GUIPreferences.getInstance().getSkinFile());</span>

<span class="nc" id="L899">            uiThemes.removeAllItems();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">            for (LookAndFeelInfo lafInfo : UIManager.getInstalledLookAndFeels()) {</span>
<span class="nc" id="L901">                uiThemes.addItem(new UITheme(lafInfo.getClassName(), lafInfo.getName()));</span>
            }
<span class="nc" id="L903">            uiThemes.setSelectedItem(new UITheme(GUIPreferences.getInstance().getUITheme()));</span>

<span class="nc" id="L905">            fovInsideEnabled.setSelected(gs.getFovHighlight());</span>
<span class="nc" id="L906">            fovHighlightAlpha.setValue(gs.getFovHighlightAlpha());</span>
<span class="nc" id="L907">            fovHighlightRingsRadii.setText( gs.getFovHighlightRingsRadii());</span>
<span class="nc" id="L908">            fovHighlightRingsColors.setText( gs.getFovHighlightRingsColorsHsb() );</span>
<span class="nc" id="L909">            fovOutsideEnabled.setSelected(gs.getFovDarken());</span>
<span class="nc" id="L910">            fovDarkenAlpha.setValue(gs.getFovDarkenAlpha());</span>
<span class="nc" id="L911">            numStripesSlider.setValue(gs.getFovStripes());</span>
<span class="nc" id="L912">            fovGrayscaleEnabled.setSelected(gs.getFovGrayscale());</span>

<span class="nc" id="L914">            fovHighlightAlpha.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L915">            fovHighlightRingsRadii.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L916">            fovHighlightRingsColors.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L917">            fovDarkenAlpha.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L918">            numStripesSlider.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L919">            fovGrayscaleEnabled.setEnabled(fovOutsideEnabled.isSelected());</span>

<span class="nc" id="L921">            darkenAlphaLabel.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L922">            numStripesLabel.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L923">            fovHighlightRingsColorsLabel.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L924">            fovHighlightRingsRadiiLabel.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L925">            highlightAlphaLabel.setEnabled(fovInsideEnabled.isSelected());</span>

<span class="nc" id="L927">            stampFormatLabel.setEnabled(stampFilenames.isSelected());</span>
<span class="nc" id="L928">            gameLogFilenameLabel.setEnabled(keepGameLog.isSelected());</span>

<span class="nc" id="L930">            getFocus.setSelected(gs.getFocus());</span>
            
<span class="nc" id="L932">            savedFovHighlight = gs.getFovHighlight();</span>
<span class="nc" id="L933">            savedFovDarken = gs.getFovDarken();</span>
<span class="nc" id="L934">            savedFovGrayscale = gs.getFovGrayscale();</span>
<span class="nc" id="L935">            savedAOHexShadows = gs.getAOHexShadows();</span>
<span class="nc" id="L936">            savedShadowMap = gs.getShadowMap();</span>
<span class="nc" id="L937">            savedHexInclines = gs.getHexInclines();</span>
<span class="nc" id="L938">            savedLevelhighlight = gs.getLevelHighlight();</span>
<span class="nc" id="L939">            savedFloatingIso = gs.getFloatingIso();</span>
<span class="nc" id="L940">            savedMmSymbol = gs.getMmSymbol();</span>
<span class="nc" id="L941">            savedTeamColoring = gs.getTeamColoring();</span>
<span class="nc" id="L942">            savedUnitLabelBorder = gs.getUnitLabelBorder();</span>
<span class="nc" id="L943">            savedShowDamageDecal = gs.getShowDamageDecal();</span>
<span class="nc" id="L944">            savedShowDamageLabel = gs.getShowDamageLevel();</span>
<span class="nc" id="L945">            savedFovHighlightRingsRadii = gs.getFovHighlightRingsRadii();</span>
<span class="nc" id="L946">            savedFovHighlightRingsColors = gs.getFovHighlightRingsColorsHsb();</span>
<span class="nc" id="L947">            savedFovHighlightAlpha = gs.getFovHighlightAlpha();</span>
<span class="nc" id="L948">            savedFovDarkenAlpha = gs.getFovDarkenAlpha();</span>
<span class="nc" id="L949">            savedNumStripesSlider = gs.getFovStripes();</span>
<span class="nc" id="L950">            savedAdvancedOpt.clear();</span>
            
<span class="nc" id="L952">            advancedKeys.clearSelection();</span>
            
        }   
<span class="nc" id="L955">        super.setVisible(visible);</span>
<span class="nc" id="L956">    }       </span>
            
    /** Cancel any updates made in this dialog and close it.  */     
    void cancel() {
        // Restore values that are immediately updated by player clicks
<span class="nc" id="L961">        GUIPreferences guip = GUIPreferences.getInstance();</span>
<span class="nc" id="L962">        guip.setFovHighlight(savedFovHighlight);</span>
<span class="nc" id="L963">        guip.setFovDarken(savedFovDarken);</span>
<span class="nc" id="L964">        guip.setFovGrayscale(savedFovGrayscale);</span>
<span class="nc" id="L965">        guip.setAOHexShadows(savedAOHexShadows);</span>
<span class="nc" id="L966">        guip.setShadowMap(savedShadowMap);</span>
<span class="nc" id="L967">        guip.setHexInclines(savedHexInclines);</span>
<span class="nc" id="L968">        guip.setLevelHighlight(savedLevelhighlight);</span>
<span class="nc" id="L969">        guip.setFloatingIso(savedFloatingIso);</span>
<span class="nc" id="L970">        guip.setMmSymbol(savedMmSymbol);</span>
<span class="nc" id="L971">        guip.setTeamColoring(savedTeamColoring);</span>
<span class="nc" id="L972">        guip.setUnitLabelBorder(savedUnitLabelBorder);</span>
<span class="nc" id="L973">        guip.setShowDamageDecal(savedShowDamageDecal);</span>
<span class="nc" id="L974">        guip.setShowDamageLevel(savedShowDamageLabel);</span>
<span class="nc" id="L975">        guip.setFovHighlightRingsRadii(savedFovHighlightRingsRadii);</span>
<span class="nc" id="L976">        guip.setFovHighlightRingsColorsHsb(savedFovHighlightRingsColors);</span>
<span class="nc" id="L977">        guip.setFovHighlightAlpha(savedFovHighlightAlpha);</span>
<span class="nc" id="L978">        guip.setFovDarkenAlpha(savedFovDarkenAlpha);</span>
<span class="nc" id="L979">        guip.setFovStripes(savedNumStripesSlider);</span>
         
<span class="nc bnc" id="L981" title="All 2 branches missed.">        for (String option: savedAdvancedOpt.keySet()) {</span>
<span class="nc" id="L982">            GUIPreferences.getInstance().setValue(option, savedAdvancedOpt.get(option));</span>
<span class="nc" id="L983">        }</span>

<span class="nc" id="L985">        setVisible(false);</span>
<span class="nc" id="L986">    }</span>

    /**
     * Update the settings from this dialog's values, then closes it.
     */
    private void update() {
<span class="nc" id="L992">        GUIPreferences gs = GUIPreferences.getInstance();</span>
<span class="nc" id="L993">        IClientPreferences cs = PreferenceManager.getClientPreferences();</span>

<span class="nc" id="L995">        gs.setShowDamageLevel(showDamageLevel.isSelected());</span>
<span class="nc" id="L996">        gs.setShowDamageDecal(showDamageDecal.isSelected());</span>
<span class="nc" id="L997">        gs.setUnitLabelBorder(entityOwnerColor.isSelected());</span>
<span class="nc" id="L998">        gs.setTeamColoring(teamColoring.isSelected());</span>
<span class="nc" id="L999">        gs.setAutoEndFiring(autoEndFiring.isSelected());</span>
<span class="nc" id="L1000">        gs.setAutoDeclareSearchlight(autoDeclareSearchlight.isSelected());</span>
<span class="nc" id="L1001">        gs.setDefaultWeaponSortOrder(defaultWeaponSortOrder.getSelectedIndex());</span>
<span class="nc" id="L1002">        gs.setNagForMASC(nagForMASC.isSelected());</span>
<span class="nc" id="L1003">        gs.setNagForPSR(nagForPSR.isSelected());</span>
<span class="nc" id="L1004">        gs.setNagForWiGELanding(nagForWiGELanding.isSelected());</span>
<span class="nc" id="L1005">        gs.setNagForNoAction(nagForNoAction.isSelected());</span>
<span class="nc" id="L1006">        gs.setShowMoveStep(animateMove.isSelected());</span>
<span class="nc" id="L1007">        gs.setShowWrecks(showWrecks.isSelected());</span>
<span class="nc" id="L1008">        gs.setSoundMute(soundMute.isSelected());</span>
<span class="nc" id="L1009">        gs.setShowWpsinTT(showWpsinTT.isSelected());</span>
<span class="nc" id="L1010">        gs.setshowArmorMiniVisTT(showArmorMiniVisTT.isSelected());</span>
<span class="nc" id="L1011">        gs.setshowPilotPortraitTT(showPilotPortraitTT.isSelected());</span>
<span class="nc" id="L1012">        gs.setTooltipDelay(Integer.parseInt(tooltipDelay.getText()));</span>
<span class="nc" id="L1013">        gs.setTooltipDismissDelay(Integer.parseInt(tooltipDismissDelay.getText()));</span>
<span class="nc" id="L1014">        gs.setTooltipDistSuppression(Integer.parseInt(tooltipDistSupression.getText()));</span>
<span class="nc" id="L1015">        cs.setUnitStartChar(((String) unitStartChar.getSelectedItem())</span>
<span class="nc" id="L1016">                .charAt(0));</span>
        
<span class="nc" id="L1018">        gs.setMouseWheelZoom(mouseWheelZoom.isSelected());</span>
<span class="nc" id="L1019">        gs.setMouseWheelZoomFlip(mouseWheelZoomFlip.isSelected());</span>

<span class="nc" id="L1021">        cs.setMaxPathfinderTime(Integer.parseInt(maxPathfinderTime.getText()));</span>

<span class="nc" id="L1023">        gs.setGetFocus(getFocus.isSelected());</span>

<span class="nc" id="L1025">        cs.setKeepGameLog(keepGameLog.isSelected());</span>
<span class="nc" id="L1026">        cs.setGameLogFilename(gameLogFilename.getText());</span>
        // cs.setGameLogMaxSize(Integer.parseInt(gameLogMaxSize.getText()));
<span class="nc" id="L1028">        cs.setStampFilenames(stampFilenames.isSelected());</span>
<span class="nc" id="L1029">        cs.setStampFormat(stampFormat.getText());</span>
<span class="nc" id="L1030">        cs.setShowIPAddressesInChat(showIPAddressesInChat.isSelected());</span>

<span class="nc" id="L1032">        cs.setDefaultAutoejectDisabled(defaultAutoejectDisabled.isSelected());</span>
<span class="nc" id="L1033">        cs.setUseAverageSkills(useAverageSkills.isSelected());</span>
<span class="nc" id="L1034">        cs.setGenerateNames(generateNames.isSelected());</span>
<span class="nc" id="L1035">        cs.setShowUnitId(showUnitId.isSelected());</span>
<span class="nc bnc" id="L1036" title="All 4 branches missed.">        if ((clientgui != null) &amp;&amp; (clientgui.bv != null)) {</span>
<span class="nc" id="L1037">            clientgui.bv.updateEntityLabels();</span>
        }

<span class="nc" id="L1040">        cs.setLocale(CommonSettingsDialog.LOCALE_CHOICES[displayLocale</span>
<span class="nc" id="L1041">                .getSelectedIndex()]);</span>

<span class="nc" id="L1043">        gs.setShowMapsheets(showMapsheets.isSelected());</span>
<span class="nc" id="L1044">        gs.setAOHexShadows(aOHexShadows.isSelected());</span>
<span class="nc" id="L1045">        gs.setFloatingIso(floatingIso.isSelected());</span>
<span class="nc" id="L1046">        gs.setMmSymbol(mmSymbol.isSelected());</span>
<span class="nc" id="L1047">        gs.setLevelHighlight(levelhighlight.isSelected());</span>
<span class="nc" id="L1048">        gs.setShadowMap(shadowMap.isSelected());</span>
<span class="nc" id="L1049">        gs.setHexInclines(hexInclines.isSelected());</span>
<span class="nc" id="L1050">        gs.setValue(&quot;SOFTCENTER&quot;, useSoftCenter.isSelected());</span>

<span class="nc bnc" id="L1052" title="All 6 branches missed.">        if ((gs.getAntiAliasing() != chkAntiAliasing.isSelected()) &amp;&amp;</span>
                ((clientgui != null) &amp;&amp; (clientgui.bv != null))) {            
<span class="nc" id="L1054">            clientgui.bv.clearHexImageCache();</span>
<span class="nc" id="L1055">            clientgui.bv.repaint();</span>
        }

<span class="nc" id="L1058">        gs.setAntiAliasing(chkAntiAliasing.isSelected());</span>

<span class="nc" id="L1060">        gs.setGameSummaryBoardView(gameSummaryBV.isSelected());</span>
<span class="nc" id="L1061">        gs.setGameSummaryMiniMap(gameSummaryMM.isSelected());</span>

<span class="nc" id="L1063">        UITheme newUITheme = (UITheme)uiThemes.getSelectedItem();</span>
<span class="nc" id="L1064">        String oldUITheme = gs.getUITheme();</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">        if (!oldUITheme.equals(newUITheme.getClassName())) {</span>
<span class="nc" id="L1066">            gs.setUITheme(newUITheme.getClassName());</span>
        }

<span class="nc" id="L1069">        String newSkinFile = (String)skinFiles.getSelectedItem();</span>
<span class="nc" id="L1070">        String oldSkinFile = gs.getSkinFile();</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">        if (!oldSkinFile.equals(newSkinFile)) {</span>
<span class="nc" id="L1072">            boolean success = SkinXMLHandler.initSkinXMLHandler(newSkinFile);</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">            if (!success) {</span>
<span class="nc" id="L1074">                SkinXMLHandler.initSkinXMLHandler(oldSkinFile);</span>
<span class="nc" id="L1075">                String title = Messages</span>
<span class="nc" id="L1076">                        .getString(&quot;CommonSettingsDialog.skinFileFail.title&quot;);</span>
<span class="nc" id="L1077">                String msg = Messages</span>
<span class="nc" id="L1078">                        .getString(&quot;CommonSettingsDialog.skinFileFail.msg&quot;);</span>
<span class="nc" id="L1079">                JOptionPane.showMessageDialog(owner, msg, title,</span>
                        JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1081">            } else {</span>
<span class="nc" id="L1082">                gs.setSkinFile(newSkinFile);</span>
            }            
        }

<span class="nc bnc" id="L1086" title="All 2 branches missed.">        if (tileSetChoice.getSelectedIndex() &gt;= 0) {</span>
<span class="nc" id="L1087">            String tileSetFileName = tileSets.get(tileSetChoice.getSelectedIndex()).getName();</span>
<span class="nc bnc" id="L1088" title="All 6 branches missed.">            if (!cs.getMapTileset().equals(tileSetFileName) &amp;&amp;</span>
                    (clientgui != null) &amp;&amp; (clientgui.bv != null))  {
<span class="nc" id="L1090">                clientgui.bv.clearShadowMap();</span>
            }
<span class="nc" id="L1092">            cs.setMapTileset(tileSetFileName);</span>
        }

<span class="nc" id="L1095">        ToolTipManager.sharedInstance().setInitialDelay(gs.getTooltipDelay());</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">        if (gs.getTooltipDismissDelay() &gt; 0) {</span>
<span class="nc" id="L1097">            ToolTipManager.sharedInstance().setDismissDelay(gs.getTooltipDismissDelay());</span>
        }

        // Lets iterate through all of the KeyCommandBinds and see if they've
        //  changed
<span class="nc" id="L1102">        boolean bindsChanged = false;</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">        for (KeyCommandBind kcb : KeyCommandBind.values()){</span>
<span class="nc" id="L1104">            JTextField txtModifiers = cmdModifierMap.get(kcb.cmd);</span>
<span class="nc" id="L1105">            JCheckBox repeatable = cmdRepeatableMap.get(kcb.cmd);</span>
<span class="nc" id="L1106">            Integer keyCode = cmdKeyMap.get(kcb.cmd);</span>
            // This shouldn't happen, but just to be safe...
<span class="nc bnc" id="L1108" title="All 6 branches missed.">            if (txtModifiers == null || keyCode == null || repeatable == null){</span>
<span class="nc" id="L1109">                continue;</span>
            }
<span class="nc" id="L1111">            int modifiers = 0;</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if (txtModifiers.getText().contains(</span>
<span class="nc" id="L1113">                    KeyEvent.getKeyModifiersText(KeyEvent.SHIFT_MASK))){</span>
<span class="nc" id="L1114">                modifiers |= KeyEvent.SHIFT_MASK;</span>
            }
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            if (txtModifiers.getText().contains(</span>
<span class="nc" id="L1117">                    KeyEvent.getKeyModifiersText(KeyEvent.ALT_MASK))){</span>
<span class="nc" id="L1118">                modifiers |= KeyEvent.ALT_MASK;</span>
            }
<span class="nc bnc" id="L1120" title="All 2 branches missed.">            if (txtModifiers.getText().contains(</span>
<span class="nc" id="L1121">                    KeyEvent.getKeyModifiersText(KeyEvent.CTRL_MASK))){</span>
<span class="nc" id="L1122">                modifiers |= KeyEvent.CTRL_MASK;</span>
            }

<span class="nc bnc" id="L1125" title="All 2 branches missed.">            if (kcb.modifiers != modifiers){</span>
<span class="nc" id="L1126">                bindsChanged = true;</span>
<span class="nc" id="L1127">                kcb.modifiers = modifiers;</span>
            }

<span class="nc bnc" id="L1130" title="All 2 branches missed.">            if (kcb.key != keyCode){</span>
<span class="nc" id="L1131">                bindsChanged = true;</span>
<span class="nc" id="L1132">                kcb.key = keyCode;</span>
            }

<span class="nc bnc" id="L1135" title="All 2 branches missed.">            if (kcb.isRepeatable != repeatable.isSelected()){</span>
<span class="nc" id="L1136">                bindsChanged = true;</span>
<span class="nc" id="L1137">                kcb.isRepeatable = repeatable.isSelected();</span>
            }
        }

<span class="nc bnc" id="L1141" title="All 2 branches missed.">        if (bindsChanged){</span>
<span class="nc" id="L1142">            KeyBindParser.writeKeyBindings();</span>
        }
        
        // Button Order
        // Movement
<span class="nc" id="L1147">        ButtonOrderPreferences bop = ButtonOrderPreferences.getInstance();</span>
<span class="nc" id="L1148">        boolean buttonOrderChanged = false;</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        for (int i = 0; i &lt; movePhaseCommands.getSize(); i++) {</span>
<span class="nc" id="L1150">            StatusBarPhaseDisplay.PhaseCommand cmd = movePhaseCommands.get(i);</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">            if (cmd.getPriority() != i) {</span>
<span class="nc" id="L1152">                cmd.setPriority(i);</span>
<span class="nc" id="L1153">                bop.setValue(cmd.getCmd(), i);</span>
<span class="nc" id="L1154">                buttonOrderChanged = true;</span>
            }
        }
        
        // Need to do stuff if the order changes.
<span class="nc bnc" id="L1159" title="All 4 branches missed.">        if (buttonOrderChanged &amp;&amp; (clientgui != null)) {</span>
<span class="nc" id="L1160">            clientgui.updateButtonPanel(IGame.Phase.PHASE_MOVEMENT);</span>
        }
        
        // Deploy
<span class="nc" id="L1164">        buttonOrderChanged = false;</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">        for (int i = 0; i &lt; deployPhaseCommands.getSize(); i++) {</span>
<span class="nc" id="L1166">            StatusBarPhaseDisplay.PhaseCommand cmd = deployPhaseCommands.get(i);</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">            if (cmd.getPriority() != i) {</span>
<span class="nc" id="L1168">                cmd.setPriority(i);</span>
<span class="nc" id="L1169">                bop.setValue(cmd.getCmd(), i);</span>
<span class="nc" id="L1170">                buttonOrderChanged = true;</span>
            }
        }
        
        // Need to do stuff if the order changes.
<span class="nc bnc" id="L1175" title="All 4 branches missed.">        if (buttonOrderChanged &amp;&amp; (clientgui != null)) {</span>
<span class="nc" id="L1176">            clientgui.updateButtonPanel(IGame.Phase.PHASE_DEPLOYMENT);</span>
        }        
        
        // Firing
<span class="nc" id="L1180">        buttonOrderChanged = false;</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">        for (int i = 0; i &lt; firingPhaseCommands.getSize(); i++) {</span>
<span class="nc" id="L1182">            StatusBarPhaseDisplay.PhaseCommand cmd = firingPhaseCommands.get(i);</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">            if (cmd.getPriority() != i) {</span>
<span class="nc" id="L1184">                cmd.setPriority(i);</span>
<span class="nc" id="L1185">                bop.setValue(cmd.getCmd(), i);</span>
<span class="nc" id="L1186">                buttonOrderChanged = true;</span>
            }
        }
        
        // Need to do stuff if the order changes.
<span class="nc bnc" id="L1191" title="All 4 branches missed.">        if (buttonOrderChanged &amp;&amp; (clientgui != null)) {</span>
<span class="nc" id="L1192">            clientgui.updateButtonPanel(IGame.Phase.PHASE_FIRING);</span>
        }
        
        // Physical
<span class="nc" id="L1196">        buttonOrderChanged = false;</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">        for (int i = 0; i &lt; physicalPhaseCommands.getSize(); i++) {</span>
<span class="nc" id="L1198">            StatusBarPhaseDisplay.PhaseCommand cmd = physicalPhaseCommands.get(i);</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">            if (cmd.getPriority() != i) {</span>
<span class="nc" id="L1200">                cmd.setPriority(i);</span>
<span class="nc" id="L1201">                bop.setValue(cmd.getCmd(), i);</span>
<span class="nc" id="L1202">                buttonOrderChanged = true;</span>
            }
        }
        
        // Need to do stuff if the order changes.
<span class="nc bnc" id="L1207" title="All 4 branches missed.">        if (buttonOrderChanged &amp;&amp; (clientgui != null)) {</span>
<span class="nc" id="L1208">            clientgui.updateButtonPanel(IGame.Phase.PHASE_PHYSICAL);</span>
        }
        
        // Targeting
<span class="nc" id="L1212">        buttonOrderChanged = false;</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">        for (int i = 0; i &lt; targetingPhaseCommands.getSize(); i++) {</span>
<span class="nc" id="L1214">            StatusBarPhaseDisplay.PhaseCommand cmd = targetingPhaseCommands.get(i);</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">            if (cmd.getPriority() != i) {</span>
<span class="nc" id="L1216">                cmd.setPriority(i);</span>
<span class="nc" id="L1217">                bop.setValue(cmd.getCmd(), i);</span>
<span class="nc" id="L1218">                buttonOrderChanged = true;</span>
            }
        }
        
        // Need to do stuff if the order changes.
<span class="nc bnc" id="L1223" title="All 4 branches missed.">        if (buttonOrderChanged &amp;&amp; (clientgui != null)) {</span>
<span class="nc" id="L1224">            clientgui.updateButtonPanel(IGame.Phase.PHASE_TARGETING);</span>
        }

<span class="nc" id="L1227">        setVisible(false);</span>
<span class="nc" id="L1228">    }</span>

    /**
     * Handle the player pressing the action buttons. &lt;p/&gt; Implements the
     * &lt;code&gt;ActionListener&lt;/code&gt; interface.
     *
     * @param event - the &lt;code&gt;ActionEvent&lt;/code&gt; that initiated this call.
     */
    public void actionPerformed(ActionEvent event) {
<span class="nc" id="L1237">        String command = event.getActionCommand();</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">        if (command.equals(UPDATE)) {</span>
<span class="nc" id="L1239">            update();</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">        } else if (command.equals(CANCEL)) {</span>
<span class="nc" id="L1241">            cancel();</span>
        }
<span class="nc" id="L1243">    }</span>

    /** Handle some setting changes that directly update e.g. the board. */
    public void itemStateChanged(ItemEvent event) {
<span class="nc" id="L1247">        Object source = event.getItemSelectable();</span>
<span class="nc" id="L1248">        GUIPreferences guip = GUIPreferences.getInstance();</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">        if (source.equals(keepGameLog)) {</span>
<span class="nc" id="L1250">            gameLogFilename.setEnabled(keepGameLog.isSelected());</span>
<span class="nc" id="L1251">            stampFormatLabel.setEnabled(stampFilenames.isSelected());</span>
<span class="nc" id="L1252">            gameLogFilenameLabel.setEnabled(keepGameLog.isSelected());</span>
            // gameLogMaxSize.setEnabled(keepGameLog.isSelected());
<span class="nc bnc" id="L1254" title="All 2 branches missed.">        } else if (source.equals(stampFilenames)) {</span>
<span class="nc" id="L1255">            stampFormat.setEnabled(stampFilenames.isSelected());</span>
<span class="nc" id="L1256">            stampFormatLabel.setEnabled(stampFilenames.isSelected());</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">        } else if (source.equals(fovInsideEnabled)) {</span>
<span class="nc" id="L1258">            guip.setFovHighlight(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L1259">            fovHighlightAlpha.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L1260">            fovHighlightRingsRadii.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L1261">            fovHighlightRingsColors.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L1262">            fovHighlightRingsColorsLabel.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L1263">            fovHighlightRingsRadiiLabel.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc" id="L1264">            highlightAlphaLabel.setEnabled(fovInsideEnabled.isSelected());</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">        } else if (source.equals(fovOutsideEnabled)) {</span>
<span class="nc" id="L1266">            guip.setFovDarken(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L1267">            fovDarkenAlpha.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L1268">            numStripesSlider.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L1269">            darkenAlphaLabel.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L1270">            numStripesLabel.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc" id="L1271">            fovGrayscaleEnabled.setEnabled(fovOutsideEnabled.isSelected());</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">        } else if (source.equals(fovGrayscaleEnabled)) {</span>
<span class="nc" id="L1273">            guip.setFovGrayscale(fovGrayscaleEnabled.isSelected());</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">        } else if (source.equals(aOHexShadows)) {</span>
<span class="nc" id="L1275">            guip.setAOHexShadows(aOHexShadows.isSelected());</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">        } else if (source.equals(shadowMap)) {</span>
<span class="nc" id="L1277">            guip.setShadowMap(shadowMap.isSelected());</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">        } else if (source.equals(hexInclines)) {</span>
<span class="nc" id="L1279">            guip.setHexInclines(hexInclines.isSelected());</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">        } else if (source.equals(levelhighlight)) {</span>
<span class="nc" id="L1281">            guip.setLevelHighlight(levelhighlight.isSelected());</span>
<span class="nc bnc" id="L1282" title="All 2 branches missed.">        } else if (source.equals(floatingIso)) {</span>
<span class="nc" id="L1283">            guip.setFloatingIso(floatingIso.isSelected());</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">        } else if (source.equals(mmSymbol)) {</span>
<span class="nc" id="L1285">            guip.setMmSymbol(mmSymbol.isSelected());</span>
<span class="nc bnc" id="L1286" title="All 4 branches missed.">            if ((clientgui != null) &amp;&amp; (clientgui.minimap != null)) {</span>
<span class="nc" id="L1287">                clientgui.minimap.drawMap();</span>
            }

<span class="nc bnc" id="L1290" title="All 2 branches missed.">        } else if (source.equals(teamColoring)) {</span>
<span class="nc" id="L1291">            guip.setTeamColoring(teamColoring.isSelected());</span>
<span class="nc bnc" id="L1292" title="All 4 branches missed.">            if ((clientgui != null) &amp;&amp; (clientgui.minimap != null)) {</span>
<span class="nc" id="L1293">                clientgui.minimap.drawMap();</span>
            }

<span class="nc bnc" id="L1296" title="All 2 branches missed.">        } else if (source.equals(entityOwnerColor)) {</span>
<span class="nc" id="L1297">            guip.setUnitLabelBorder(entityOwnerColor.isSelected());</span>
            
<span class="nc bnc" id="L1299" title="All 2 branches missed.">        } else if (source.equals(showDamageDecal)) {</span>
<span class="nc" id="L1300">            guip.setShowDamageDecal(showDamageDecal.isSelected());</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">        } else if (source.equals(showDamageLevel)) {</span>
<span class="nc" id="L1302">            guip.setShowDamageLevel(showDamageLevel.isSelected());</span>
        }
<span class="nc" id="L1304">    }</span>

<span class="nc" id="L1306">    public void focusGained(FocusEvent e) { }</span>

    public void focusLost(FocusEvent e) {
<span class="nc" id="L1309">        Object src = e.getSource();</span>
<span class="nc" id="L1310">        GUIPreferences guip = GUIPreferences.getInstance();          </span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (src.equals(fovHighlightRingsRadii)) {</span>
<span class="nc" id="L1312">            guip.setFovHighlightRingsRadii(fovHighlightRingsRadii.getText());</span>
<span class="nc" id="L1313">            return;</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">        } else if (src.equals(fovHighlightRingsColors)) {</span>
<span class="nc" id="L1315">            guip.setFovHighlightRingsColorsHsb(fovHighlightRingsColors.getText());</span>
<span class="nc" id="L1316">            return;</span>
        } 
        // For Advanced options
<span class="nc" id="L1319">        String option = &quot;Advanced&quot; + advancedKeys.getModel().getElementAt(advancedKeyIndex).option;</span>
<span class="nc" id="L1320">        savedAdvancedOpt.put(option, guip.getString(option));        </span>
<span class="nc" id="L1321">        guip.setValue(option, advancedValue.getText());</span>
<span class="nc" id="L1322">    }</span>

    /** 
     * The Graphics Tab
     */
    private JPanel getGraphicsPanel() {

<span class="nc" id="L1329">        ArrayList&lt;ArrayList&lt;Component&gt;&gt; comps = new ArrayList&lt;ArrayList&lt;Component&gt;&gt;();</span>
        ArrayList&lt;Component&gt; row;
        
        // Anti-Aliasing
<span class="nc" id="L1333">        chkAntiAliasing = new JCheckBox(Messages.getString(</span>
                &quot;CommonSettingsDialog.antiAliasing&quot;)); //$NON-NLS-1$
<span class="nc" id="L1335">        chkAntiAliasing.setToolTipText(Messages.getString(</span>
                &quot;CommonSettingsDialog.antiAliasingToolTip&quot;));
<span class="nc" id="L1337">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1338">        row.add(chkAntiAliasing);</span>
<span class="nc" id="L1339">        comps.add(row);</span>
        
        // Animate Moves
<span class="nc" id="L1342">        animateMove = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.animateMove&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1343">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1344">        row.add(animateMove);</span>
<span class="nc" id="L1345">        comps.add(row);</span>

        // Show Wrecks
<span class="nc" id="L1348">        showWrecks = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showWrecks&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1349">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1350">        row.add(showWrecks);</span>
<span class="nc" id="L1351">        comps.add(row);     </span>
        
        // Show Mapsheet borders
<span class="nc" id="L1354">        showMapsheets = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.showMapsheets&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1355">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1356">        row.add(showMapsheets);</span>
<span class="nc" id="L1357">        comps.add(row);</span>

        // Hill Base AO Shadows
<span class="nc" id="L1360">        aOHexShadows = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.AOHexSHadows&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1361">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1362">        aOHexShadows.addItemListener(this);</span>
<span class="nc" id="L1363">        row.add(aOHexShadows);</span>
<span class="nc" id="L1364">        comps.add(row);</span>
        
        // Shadow Map = Terrain and Building shadows
<span class="nc" id="L1367">        shadowMap = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.useShadowMap&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1368">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1369">        shadowMap.addItemListener(this);</span>
<span class="nc" id="L1370">        row.add(shadowMap);</span>
<span class="nc" id="L1371">        comps.add(row);</span>
        
        // Use Incline graphics (hex border highlights/shadows)
<span class="nc" id="L1374">        hexInclines = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.useInclines&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1375">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1376">        hexInclines.addItemListener(this);</span>
<span class="nc" id="L1377">        row.add(hexInclines);</span>
<span class="nc" id="L1378">        comps.add(row);</span>
        
        // Level Highlight = borders around level changes
<span class="nc" id="L1381">        levelhighlight = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.levelHighlight&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1382">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1383">        levelhighlight.addItemListener(this);</span>
<span class="nc" id="L1384">        row.add(levelhighlight);</span>
<span class="nc" id="L1385">        comps.add(row);</span>
        
        // Floating Isometric = do not draw hex sides
<span class="nc" id="L1388">        floatingIso = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.floatingIso&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1389">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1390">        floatingIso.addItemListener(this);</span>
<span class="nc" id="L1391">        row.add(floatingIso);</span>
<span class="nc" id="L1392">        comps.add(row);</span>

        // Type of symbol used on the minimap 
<span class="nc" id="L1395">        mmSymbol = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.mmSymbol&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1396">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1397">        mmSymbol.addItemListener(this);</span>
<span class="nc" id="L1398">        row.add(mmSymbol);</span>
<span class="nc" id="L1399">        comps.add(row);</span>

        // Game Summary - BoardView
<span class="nc" id="L1402">        gameSummaryBV = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.gameSummaryBV.name&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1403">        gameSummaryBV.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.gameSummaryBV.tooltip&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1404">                new Object[] { Configuration.gameSummaryImagesBVDir() }));</span>
<span class="nc" id="L1405">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1406">        gameSummaryBV.addItemListener(this);</span>
<span class="nc" id="L1407">        row.add(gameSummaryBV);</span>
<span class="nc" id="L1408">        comps.add(row);</span>

        // Game Summary - Mini-map
<span class="nc" id="L1411">        gameSummaryMM = new JCheckBox(Messages.getString(&quot;CommonSettingsDialog.gameSummaryMM.name&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1412">        gameSummaryMM.setToolTipText(Messages.getString(&quot;CommonSettingsDialog.gameSummaryMM.tooltip&quot;, //$NON-NLS-1$</span>
<span class="nc" id="L1413">                new Object[] { Configuration.gameSummaryImagesMMDir() }));</span>
<span class="nc" id="L1414">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1415">        gameSummaryMM.addItemListener(this);</span>
<span class="nc" id="L1416">        row.add(gameSummaryMM);</span>
<span class="nc" id="L1417">        comps.add(row);</span>

        // UI Theme
<span class="nc" id="L1420">        uiThemes = new JComboBox&lt;UITheme&gt;();</span>
<span class="nc" id="L1421">        uiThemes.setMaximumSize(new Dimension(400,uiThemes.getMaximumSize().height));</span>
<span class="nc" id="L1422">        JLabel uiThemesLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.uiTheme&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1423">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1424">        row.add(uiThemesLabel);</span>
<span class="nc" id="L1425">        row.add(uiThemes);</span>
<span class="nc" id="L1426">        comps.add(row);   </span>
        
        // Spacer
<span class="nc" id="L1429">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1430">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L1431">        comps.add(row);</span>

        // Skin
<span class="nc" id="L1434">        skinFiles = new JComboBox&lt;String&gt;();</span>
<span class="nc" id="L1435">        skinFiles.setMaximumSize(new Dimension(400,skinFiles.getMaximumSize().height));</span>
<span class="nc" id="L1436">        JLabel skinFileLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.skinFile&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1437">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1438">        row.add(skinFileLabel);</span>
<span class="nc" id="L1439">        row.add(skinFiles);</span>
<span class="nc" id="L1440">        comps.add(row);   </span>
        
        // Spacer
<span class="nc" id="L1443">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1444">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L1445">        comps.add(row);</span>

        // Tileset
<span class="nc" id="L1448">        JLabel tileSetChoiceLabel = new JLabel(Messages.getString(&quot;CommonSettingsDialog.tileset&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1449">        tileSetChoice = new JComboBox&lt;String&gt;(); //$NON-NLS-1$</span>
<span class="nc" id="L1450">        tileSetChoice.setMaximumSize(new Dimension(400,tileSetChoice.getMaximumSize().height));</span>
<span class="nc" id="L1451">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1452">        row.add(tileSetChoiceLabel);</span>
<span class="nc" id="L1453">        row.add(Box.createHorizontalStrut(15));</span>
<span class="nc" id="L1454">        row.add(tileSetChoice);</span>
<span class="nc" id="L1455">        comps.add(row);</span>
        
        // Horizontal Line and Spacer
<span class="nc" id="L1458">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1459">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L1460">        comps.add(row);</span>

<span class="nc" id="L1462">        JSeparator highlightSep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L1463">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1464">        row.add(highlightSep);</span>
<span class="nc" id="L1465">        comps.add(row);</span>
        
<span class="nc" id="L1467">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1468">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L1469">        comps.add(row);</span>
        
        // Highlighting Radius inside FoV
        //
        // Highlight inside Check box
<span class="nc" id="L1474">        fovInsideEnabled = new JCheckBox(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovInsideEnabled&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1475">        fovInsideEnabled.addItemListener(this);</span>
<span class="nc" id="L1476">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1477">        row.add(fovInsideEnabled);</span>
<span class="nc" id="L1478">        comps.add(row);</span>

        // Add some vertical spacing
<span class="nc" id="L1481">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1482">        row.add(Box.createVerticalStrut(2));</span>
<span class="nc" id="L1483">        comps.add(row);</span>

        // Inside Opaqueness slider
<span class="nc" id="L1486">        fovHighlightAlpha = new JSlider(0, 255);</span>
<span class="nc" id="L1487">        fovHighlightAlpha.setMajorTickSpacing(25);</span>
<span class="nc" id="L1488">        fovHighlightAlpha.setMinorTickSpacing(5);</span>
<span class="nc" id="L1489">        fovHighlightAlpha.setPaintTicks(true);</span>
<span class="nc" id="L1490">        fovHighlightAlpha.setPaintLabels(true);</span>
<span class="nc" id="L1491">        fovHighlightAlpha.setMaximumSize(new Dimension(400, 100));</span>
<span class="nc" id="L1492">        fovHighlightAlpha.addChangeListener(this);</span>
<span class="nc" id="L1493">        fovHighlightAlpha.setToolTipText(Messages.getString(&quot;TacticalOverlaySettingsDialog.AlphaTooltip&quot;));</span>
        // Label
<span class="nc" id="L1495">        highlightAlphaLabel = new JLabel(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovHighlightAlpha&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1496">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1497">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1498">        row.add(highlightAlphaLabel);</span>
<span class="nc" id="L1499">        comps.add(row);</span>
        
        // Add some vertical spacing
<span class="nc" id="L1502">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1503">        row.add(Box.createVerticalStrut(1));</span>
<span class="nc" id="L1504">        comps.add(row);</span>
        
<span class="nc" id="L1506">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1507">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1508">        row.add(fovHighlightAlpha);</span>
<span class="nc" id="L1509">        comps.add(row);</span>
        
        // Add some vertical spacing
<span class="nc" id="L1512">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1513">        row.add(Box.createVerticalStrut(3));</span>
<span class="nc" id="L1514">        comps.add(row);</span>

<span class="nc" id="L1516">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1517">        fovHighlightRingsRadiiLabel = new JLabel(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovHighlightRingsRadii&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1518">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1519">        row.add(fovHighlightRingsRadiiLabel);</span>
<span class="nc" id="L1520">        comps.add(row);</span>
        
        // Add some vertical spacing
<span class="nc" id="L1523">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1524">        row.add(Box.createVerticalStrut(2));</span>
<span class="nc" id="L1525">        comps.add(row);</span>
        
<span class="nc" id="L1527">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1528">        fovHighlightRingsRadii= new JTextField((2+1)*7);</span>
<span class="nc" id="L1529">        fovHighlightRingsRadii.addFocusListener(this);</span>
<span class="nc" id="L1530">        fovHighlightRingsRadii.setMaximumSize(new Dimension(100,fovHighlightRingsRadii.getPreferredSize().height) );</span>
<span class="nc" id="L1531">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1532">        row.add(fovHighlightRingsRadii);</span>
<span class="nc" id="L1533">        comps.add(row);</span>

        // Add some vertical spacing
<span class="nc" id="L1536">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1537">        row.add(Box.createVerticalStrut(2));</span>
<span class="nc" id="L1538">        comps.add(row);</span>
        
<span class="nc" id="L1540">        row= new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1541">        fovHighlightRingsColorsLabel = new JLabel(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovHighlightRingsColors&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1542">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1543">        row.add(fovHighlightRingsColorsLabel);</span>
<span class="nc" id="L1544">        comps.add(row);</span>
                
        // Add some vertical spacing
<span class="nc" id="L1547">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1548">        row.add(Box.createVerticalStrut(2));</span>
<span class="nc" id="L1549">        comps.add(row);</span>
        
<span class="nc" id="L1551">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1552">        fovHighlightRingsColors= new JTextField(50);//      ((3+1)*3+1)*7);</span>
<span class="nc" id="L1553">        fovHighlightRingsColors.addFocusListener(this);</span>
<span class="nc" id="L1554">        fovHighlightRingsColors.setMaximumSize(new Dimension(200,fovHighlightRingsColors.getPreferredSize().height) );</span>
<span class="nc" id="L1555">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1556">        row.add(fovHighlightRingsColors);</span>
<span class="nc" id="L1557">        row.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L1558">        comps.add(row);</span>

        // Horizontal Line and Spacer
<span class="nc" id="L1561">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1562">        row.add(Box.createRigidArea(new Dimension(0, 10)));</span>
<span class="nc" id="L1563">        comps.add(row);</span>

<span class="nc" id="L1565">        JSeparator OutSideSep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L1566">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1567">        row.add(OutSideSep);</span>
<span class="nc" id="L1568">        comps.add(row);</span>
        
<span class="nc" id="L1570">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1571">        row.add(Box.createRigidArea(new Dimension(0, 5)));</span>
<span class="nc" id="L1572">        comps.add(row);</span>
        
        // Outside FoV Darkening
        //
        // Activation Checkbox
<span class="nc" id="L1577">        fovOutsideEnabled = new JCheckBox(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovOutsideEnabled&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1578">        fovOutsideEnabled.addItemListener(this);</span>
<span class="nc" id="L1579">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1580">        row.add(fovOutsideEnabled);</span>
<span class="nc" id="L1581">        comps.add(row);</span>
        
        // Add some vertical spacing
<span class="nc" id="L1584">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1585">        row.add(Box.createVerticalStrut(1));</span>
<span class="nc" id="L1586">        comps.add(row);</span>

<span class="nc" id="L1588">        fovDarkenAlpha = new JSlider(0, 255);</span>
<span class="nc" id="L1589">        fovDarkenAlpha.setMajorTickSpacing(25);</span>
<span class="nc" id="L1590">        fovDarkenAlpha.setMinorTickSpacing(5);</span>
<span class="nc" id="L1591">        fovDarkenAlpha.setPaintTicks(true);</span>
<span class="nc" id="L1592">        fovDarkenAlpha.setPaintLabels(true);</span>
<span class="nc" id="L1593">        fovDarkenAlpha.setMaximumSize(new Dimension(400, 100));</span>
<span class="nc" id="L1594">        fovDarkenAlpha.addChangeListener(this);</span>
<span class="nc" id="L1595">        fovDarkenAlpha.setToolTipText(Messages.getString(&quot;TacticalOverlaySettingsDialog.AlphaTooltip&quot;));</span>
<span class="nc" id="L1596">        darkenAlphaLabel = new JLabel(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovDarkenAlpha&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1597">        darkenAlphaLabel.setToolTipText(Messages.getString(&quot;TacticalOverlaySettingsDialog.AlphaTooltip&quot;));</span>
<span class="nc" id="L1598">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1599">        row.add(Box.createRigidArea(new Dimension(4,0)));</span>
<span class="nc" id="L1600">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1601">        row.add(darkenAlphaLabel);</span>
<span class="nc" id="L1602">        comps.add(row);</span>
        
        // Add some vertical spacing
<span class="nc" id="L1605">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1606">        row.add(Box.createVerticalStrut(2));</span>
<span class="nc" id="L1607">        comps.add(row);</span>
        
<span class="nc" id="L1609">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1610">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1611">        row.add(fovDarkenAlpha);</span>
<span class="nc" id="L1612">        comps.add(row);</span>
        
        // Add some vertical spacing
<span class="nc" id="L1615">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1616">        row.add(Box.createVerticalStrut(4));</span>
<span class="nc" id="L1617">        comps.add(row);</span>
        
<span class="nc" id="L1619">        numStripesSlider = new JSlider(0, 50);</span>
<span class="nc" id="L1620">        numStripesSlider.setMajorTickSpacing(10);</span>
<span class="nc" id="L1621">        numStripesSlider.setMinorTickSpacing(5);</span>
<span class="nc" id="L1622">        numStripesSlider.setPaintTicks(true);</span>
<span class="nc" id="L1623">        numStripesSlider.setPaintLabels(true);</span>
<span class="nc" id="L1624">        numStripesSlider.setMaximumSize(new Dimension(250, 100));</span>
<span class="nc" id="L1625">        numStripesSlider.addChangeListener(this);</span>
<span class="nc" id="L1626">        numStripesSlider.setToolTipText(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovStripesTooltip&quot;));</span>
<span class="nc" id="L1627">        numStripesLabel = new JLabel(</span>
<span class="nc" id="L1628">                Messages.getString(&quot;TacticalOverlaySettingsDialog.FovStripes&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1629">        numStripesLabel.setToolTipText(Messages.getString(&quot;TacticalOverlaySettingsDialog.FovStripesTooltip&quot;));</span>
<span class="nc" id="L1630">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1631">        row.add(Box.createRigidArea(new Dimension(4,0)));</span>
<span class="nc" id="L1632">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1633">        row.add(numStripesLabel);</span>
<span class="nc" id="L1634">        comps.add(row);</span>
        
<span class="nc" id="L1636">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1637">        row.add(Box.createVerticalStrut(1));</span>
<span class="nc" id="L1638">        comps.add(row);</span>
        
<span class="nc" id="L1640">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1641">        row.add(Box.createRigidArea(new Dimension(4,0)));</span>
<span class="nc" id="L1642">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1643">        row.add(numStripesSlider);</span>
<span class="nc" id="L1644">        comps.add(row);</span>
        
<span class="nc" id="L1646">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1647">        row.add(Box.createVerticalStrut(3));</span>
<span class="nc" id="L1648">        comps.add(row);</span>
        
<span class="nc" id="L1650">        row = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1651">        fovGrayscaleEnabled = new JCheckBox(</span>
<span class="nc" id="L1652">                Messages.getString(&quot;TacticalOverlaySettingsDialog.FovGrayscale&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1653">        fovGrayscaleEnabled.addItemListener(this);</span>
<span class="nc" id="L1654">        row.add(Box.createRigidArea(new Dimension(4,0)));</span>
<span class="nc" id="L1655">        row.add(Box.createRigidArea(DEPENDENT_INSET));</span>
<span class="nc" id="L1656">        row.add(fovGrayscaleEnabled);</span>
<span class="nc" id="L1657">        comps.add(row);   </span>
        
<span class="nc" id="L1659">        return createSettingsPanel(comps);</span>
    }
    
    /**
     * Creates a panel with a box for all of the commands that can be bound to
     * keys.
     *
     * @return
     */
    private JPanel getKeyBindPanel() {
        // Create the panel to hold all the components
        // We will have an N x 43 grid, the first column is for labels, the
        //  second column will hold text fields for modifiers, the third
        //  column holds text fields for keys, and the fourth has a checkbox for
        //  isRepeatable.
<span class="nc" id="L1674">        JPanel outer = new JPanel();</span>
<span class="nc" id="L1675">        outer.setLayout(new FlowLayout(FlowLayout.LEFT));</span>
        
<span class="nc" id="L1677">        JPanel keyBinds = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L1678">        outer.add(keyBinds);</span>
<span class="nc" id="L1679">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L1680">        gbc.gridx = gbc.gridy = 0;</span>
<span class="nc" id="L1681">        gbc.insets = new Insets(0,10,5,10);</span>
        
        // Create header: labels for describing what each column does
<span class="nc" id="L1684">        JLabel headers = new JLabel(&quot;Name&quot;);</span>
<span class="nc" id="L1685">        headers.setToolTipText(&quot;The name of the action&quot;);</span>
<span class="nc" id="L1686">        keyBinds.add(headers, gbc);</span>
<span class="nc" id="L1687">        gbc.gridx++;</span>
<span class="nc" id="L1688">        headers = new JLabel(&quot;Modifier&quot;);</span>
<span class="nc" id="L1689">        headers.setToolTipText(&quot;The modifier key, like shift, ctrl, alt&quot;);</span>
<span class="nc" id="L1690">        keyBinds.add(headers, gbc);</span>
<span class="nc" id="L1691">        gbc.gridx++;</span>
<span class="nc" id="L1692">        headers = new JLabel(&quot;Key&quot;);</span>
<span class="nc" id="L1693">        headers.setToolTipText(&quot;The key&quot;);</span>
<span class="nc" id="L1694">        keyBinds.add(headers, gbc);</span>
<span class="nc" id="L1695">        gbc.gridx++;</span>
<span class="nc" id="L1696">        headers = new JLabel(&quot;Repeatable?&quot;);</span>
<span class="nc" id="L1697">        headers.setToolTipText(&quot;Should this action repeat rapidly &quot; +</span>
                &quot;when the key is held down?&quot;);
<span class="nc" id="L1699">        keyBinds.add(headers, gbc);</span>
<span class="nc" id="L1700">        gbc.gridy++;</span>
<span class="nc" id="L1701">        gbc.gridx = 0;</span>
<span class="nc" id="L1702">        gbc.gridwidth = 4;</span>
        
<span class="nc" id="L1704">        gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L1705">        JSeparator sep = new JSeparator(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L1706">        keyBinds.add(sep,gbc);</span>
        
<span class="nc" id="L1708">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L1709">        gbc.gridy++;</span>
<span class="nc" id="L1710">        gbc.gridwidth = 1;</span>
        

        // Create maps to retrieve the text fields for saving
<span class="nc" id="L1714">        int numBinds = KeyCommandBind.values().length;</span>
<span class="nc" id="L1715">        cmdModifierMap = new HashMap&lt;String,JTextField&gt;((int)(numBinds*1.26));</span>
<span class="nc" id="L1716">        cmdKeyMap = new HashMap&lt;String,Integer&gt;((int)(numBinds*1.26));</span>
<span class="nc" id="L1717">        cmdRepeatableMap = new HashMap&lt;String,JCheckBox&gt;((int)(numBinds*1.26));</span>

        // For each keyCommandBind, create a label and two text fields
<span class="nc bnc" id="L1720" title="All 2 branches missed.">        for (KeyCommandBind kcb : KeyCommandBind.values()){</span>
<span class="nc" id="L1721">            JLabel name = new JLabel(</span>
<span class="nc" id="L1722">                    Messages.getString(&quot;KeyBinds.cmdNames.&quot; + kcb.cmd));</span>
<span class="nc" id="L1723">            name.setToolTipText(</span>
<span class="nc" id="L1724">                    Messages.getString(&quot;KeyBinds.cmdDesc.&quot; + kcb.cmd));</span>
<span class="nc" id="L1725">            gbc.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L1726">            keyBinds.add(name, gbc);</span>
<span class="nc" id="L1727">            gbc.gridx++;</span>
<span class="nc" id="L1728">            gbc.anchor = GridBagConstraints.CENTER;</span>

<span class="nc" id="L1730">            final JTextField modifiers = new JTextField(10);</span>
<span class="nc" id="L1731">            modifiers.setText(KeyEvent.getKeyModifiersText(kcb.modifiers));</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">            for (KeyListener kl : modifiers.getKeyListeners()){</span>
<span class="nc" id="L1733">                modifiers.removeKeyListener(kl);</span>
            }
            // Update how typing in the text field works
<span class="nc" id="L1736">            modifiers.addKeyListener(new KeyListener(){</span>

                @Override
                public void keyPressed(KeyEvent evt) {
<span class="nc" id="L1740">                    modifiers.setText(</span>
<span class="nc" id="L1741">                            KeyEvent.getKeyModifiersText(evt.getModifiers()));</span>
<span class="nc" id="L1742">                    evt.consume();</span>
<span class="nc" id="L1743">                }</span>

                @Override
                public void keyReleased(KeyEvent evt) {
<span class="nc" id="L1747">                }</span>

                @Override
                public void keyTyped(KeyEvent evt) {
                    // This might be a bit hackish, but we want to deal with
                    //  the key code, so the code to update the text is in
                    //  keyPressed.  We've already done what we want with the
                    //  typed key, and we don't want anything else acting upon
                    //  the key typed event, so we consume it here.
<span class="nc" id="L1756">                    evt.consume();</span>
<span class="nc" id="L1757">                }</span>

            });
<span class="nc" id="L1760">            keyBinds.add(modifiers, gbc);</span>
<span class="nc" id="L1761">            gbc.gridx++;</span>
<span class="nc" id="L1762">            cmdModifierMap.put(kcb.cmd, modifiers);</span>
<span class="nc" id="L1763">            final JTextField key  = new JTextField(10);</span>
<span class="nc" id="L1764">            key.setName(kcb.cmd);</span>
<span class="nc" id="L1765">            key.setText(KeyEvent.getKeyText(kcb.key));</span>
            // Update how typing in the text field works
<span class="nc" id="L1767">            final String cmd = kcb.cmd;</span>
<span class="nc" id="L1768">            cmdKeyMap.put(cmd, kcb.key);</span>
<span class="nc" id="L1769">            key.addKeyListener(new KeyListener(){</span>

                @Override
                public void keyPressed(KeyEvent evt) {
<span class="nc" id="L1773">                    key.setText(KeyEvent.getKeyText(evt.getKeyCode()));</span>
<span class="nc" id="L1774">                    cmdKeyMap.put(cmd, evt.getKeyCode());</span>
<span class="nc" id="L1775">                    evt.consume();</span>
<span class="nc" id="L1776">                }</span>

                @Override
                public void keyReleased(KeyEvent evt) {
<span class="nc" id="L1780">                }</span>

                @Override
                public void keyTyped(KeyEvent evt) {
                    // This might be a bit hackish, but we want to deal with
                    //  the key code, so the code to update the text is in
                    //  keyPressed.  We've already done what we want with the
                    //  typed key, and we don't want anything else acting upon
                    //  the key typed event, so we consume it here.
<span class="nc" id="L1789">                    evt.consume();</span>
<span class="nc" id="L1790">                }</span>

            });
<span class="nc" id="L1793">            keyBinds.add(key, gbc);</span>
<span class="nc" id="L1794">            gbc.gridx++;</span>

<span class="nc" id="L1796">            JCheckBox repeatable = new JCheckBox(&quot;Repeatable?&quot;);</span>
<span class="nc" id="L1797">            repeatable.setSelected(kcb.isRepeatable);</span>
<span class="nc" id="L1798">            cmdRepeatableMap.put(kcb.cmd,repeatable);</span>
<span class="nc" id="L1799">            keyBinds.add(repeatable, gbc);</span>
<span class="nc" id="L1800">            gbc.gridx = 0;</span>
<span class="nc" id="L1801">            gbc.gridy++;</span>
            
            // deactivate TABbing through fields here so TAB can be caught as a keybind
<span class="nc" id="L1804">            modifiers.setFocusTraversalKeysEnabled(false);</span>
<span class="nc" id="L1805">            key.setFocusTraversalKeysEnabled(false);</span>
<span class="nc" id="L1806">            repeatable.setFocusTraversalKeysEnabled(false);</span>
        }
<span class="nc" id="L1808">        return outer;</span>
    }
    
    /**
     * Creates a panel with a list boxes that allow the button order to be 
     * changed.
     *
     * @return
     */
    private JPanel getButtonOrderPanel(){
<span class="nc" id="L1818">        JPanel buttonOrderPanel = new JPanel();</span>
<span class="nc" id="L1819">        buttonOrderPanel.setLayout(new BoxLayout(buttonOrderPanel, BoxLayout.Y_AXIS));</span>
<span class="nc" id="L1820">        JTabbedPane phasePane = new JTabbedPane();</span>
<span class="nc" id="L1821">        buttonOrderPanel.add(phasePane);</span>
        
        // MovementPhaseDisplay        
<span class="nc" id="L1824">        movePhaseCommands = new DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt;();</span>
<span class="nc" id="L1825">        phasePane.add(&quot;Movement&quot;, getButtonOrderPane(movePhaseCommands,</span>
<span class="nc" id="L1826">                MovementDisplay.MoveCommand.values()));</span>
        
        // DeploymentPhaseDisplay
<span class="nc" id="L1829">        deployPhaseCommands = new DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt;();</span>
<span class="nc" id="L1830">        phasePane.add(&quot;Deployment&quot;, getButtonOrderPane(deployPhaseCommands,</span>
<span class="nc" id="L1831">                DeploymentDisplay.DeployCommand.values()));</span>
        
        // FiringPhaseDisplay
<span class="nc" id="L1834">        firingPhaseCommands = new DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt;();</span>
<span class="nc" id="L1835">        phasePane.add(&quot;Firing&quot;, getButtonOrderPane(firingPhaseCommands,</span>
<span class="nc" id="L1836">                FiringDisplay.FiringCommand.values()));</span>
        
        // PhysicalPhaseDisplay
<span class="nc" id="L1839">        physicalPhaseCommands = new DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt;();</span>
<span class="nc" id="L1840">        phasePane.add(&quot;Physical&quot;, getButtonOrderPane(physicalPhaseCommands,</span>
<span class="nc" id="L1841">                PhysicalDisplay.PhysicalCommand.values()));          </span>
        
        // TargetingPhaseDisplay
<span class="nc" id="L1844">        targetingPhaseCommands = new DefaultListModel&lt;StatusBarPhaseDisplay.PhaseCommand&gt;();</span>
<span class="nc" id="L1845">        phasePane.add(&quot;Targeting&quot;, getButtonOrderPane(targetingPhaseCommands,</span>
<span class="nc" id="L1846">                TargetingPhaseDisplay.TargetingCommand.values()));</span>
        
<span class="nc" id="L1848">        return buttonOrderPanel;</span>
    }

    /** Constructs the button ordering panel for one phase. */ 
    private JScrollPane getButtonOrderPane(DefaultListModel&lt;PhaseCommand&gt; list, 
            StatusBarPhaseDisplay.PhaseCommand[] commands) {
<span class="nc" id="L1854">        JPanel panel = new JPanel();</span>
<span class="nc" id="L1855">        Arrays.sort(commands, cmdComp);        </span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">        for (StatusBarPhaseDisplay.PhaseCommand cmd : commands) {</span>
<span class="nc" id="L1857">            list.addElement(cmd);</span>
        }
<span class="nc" id="L1859">        JList&lt;StatusBarPhaseDisplay.PhaseCommand&gt; jlist = new JList&lt;&gt;(list);</span>
<span class="nc" id="L1860">        jlist.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1861">        jlist.addMouseListener(cmdMouseAdaptor);</span>
<span class="nc" id="L1862">        jlist.addMouseMotionListener(cmdMouseAdaptor);</span>
<span class="nc" id="L1863">        panel.add(jlist);</span>
<span class="nc" id="L1864">        JScrollPane scrollPane = new JScrollPane(panel);</span>
<span class="nc" id="L1865">        scrollPane.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L1866">        return scrollPane;</span>
    }

    private JPanel createSettingsPanel(ArrayList&lt;ArrayList&lt;Component&gt;&gt; comps) {
<span class="nc" id="L1870">        JPanel panel = new JPanel();</span>
<span class="nc" id="L1871">        panel.setLayout(new BorderLayout());</span>
<span class="nc" id="L1872">        Box innerpanel = new Box(BoxLayout.PAGE_AXIS);</span>
<span class="nc bnc" id="L1873" title="All 2 branches missed.">        for (ArrayList&lt;Component&gt; cs : comps) {</span>
<span class="nc" id="L1874">            Box subPanel = new Box(BoxLayout.LINE_AXIS);</span>
<span class="nc bnc" id="L1875" title="All 2 branches missed.">            for (Component c : cs) {</span>
<span class="nc bnc" id="L1876" title="All 2 branches missed.">                if (c instanceof JLabel) {</span>
<span class="nc" id="L1877">                    subPanel.add(Box.createRigidArea(LABEL_SPACER));</span>
<span class="nc" id="L1878">                    subPanel.add(c);</span>
<span class="nc" id="L1879">                    subPanel.add(Box.createRigidArea(LABEL_SPACER));</span>
                } else {
<span class="nc" id="L1881">                    subPanel.add(c);    </span>
                }
<span class="nc" id="L1883">            }</span>
<span class="nc" id="L1884">            subPanel.setAlignmentX(Component.LEFT_ALIGNMENT);</span>
<span class="nc" id="L1885">            innerpanel.add(subPanel);</span>
<span class="nc" id="L1886">        }</span>
<span class="nc" id="L1887">        innerpanel.add(Box.createVerticalGlue());</span>
<span class="nc" id="L1888">        innerpanel.setBorder(new EmptyBorder(10,10,10,10));</span>
<span class="nc" id="L1889">        panel.add(innerpanel,BorderLayout.PAGE_START);</span>
<span class="nc" id="L1890">        return panel;</span>
    }

    private JPanel getAdvancedSettingsPanel() {
<span class="nc" id="L1894">        JPanel p = new JPanel();</span>

<span class="nc" id="L1896">        String[] s = GUIPreferences.getInstance().getAdvancedProperties();</span>
<span class="nc" id="L1897">        AdvancedOptionData[] opts = new AdvancedOptionData[s.length];</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">        for (int i = 0; i &lt; s.length; i++) {</span>
<span class="nc" id="L1899">            s[i] = s[i].substring(s[i].indexOf(&quot;Advanced&quot;) + 8, s[i].length());</span>
<span class="nc" id="L1900">            opts[i] = new AdvancedOptionData(s[i]);</span>
        }
<span class="nc" id="L1902">        Arrays.sort(opts);</span>
<span class="nc" id="L1903">        advancedKeys = new JList&lt;&gt;(opts);</span>
<span class="nc" id="L1904">        advancedKeys.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1905">        advancedKeys.addListSelectionListener(this);</span>
<span class="nc" id="L1906">        advancedKeys.addMouseMotionListener(new MouseMotionAdapter() {</span>
            @Override
            public void mouseMoved(MouseEvent e) {
<span class="nc" id="L1909">                int index = advancedKeys.locationToIndex(e.getPoint());</span>
<span class="nc bnc" id="L1910" title="All 2 branches missed.">                if (index &gt; -1) {</span>
<span class="nc" id="L1911">                    AdvancedOptionData dat = advancedKeys.getModel().getElementAt(index);</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">                    if (dat.hasTooltipText()) {</span>
<span class="nc" id="L1913">                        advancedKeys.setToolTipText(dat.getTooltipText());</span>
                    } else {
<span class="nc" id="L1915">                        advancedKeys.setToolTipText(null);</span>
                    }
                }
<span class="nc" id="L1918">            }</span>
        });
<span class="nc" id="L1920">        p.add(advancedKeys);</span>

<span class="nc" id="L1922">        advancedValue = new JTextField(10);</span>
<span class="nc" id="L1923">        advancedValue.setFont(new Font(Font.SANS_SERIF, Font.PLAIN, 16));</span>
<span class="nc" id="L1924">        advancedValue.addFocusListener(this);</span>
<span class="nc" id="L1925">        p.add(advancedValue);</span>

<span class="nc" id="L1927">        return p;</span>
    }

    /** Used to note which advanced setting is currently clicked. */  
    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L1932" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L1933">            return;</span>
        }
<span class="nc bnc" id="L1935" title="All 2 branches missed.">        if (event.getSource().equals(advancedKeys)) {</span>
<span class="nc" id="L1936">            advancedValue.setText(GUIPreferences.getInstance().getString(</span>
<span class="nc" id="L1937">                    &quot;Advanced&quot; + advancedKeys.getSelectedValue().option));</span>
<span class="nc" id="L1938">            advancedKeyIndex = advancedKeys.getSelectedIndex();</span>
        }
<span class="nc" id="L1940">    }</span>

    @Override
    public void stateChanged(ChangeEvent evt) {
<span class="nc" id="L1944">        GUIPreferences guip = GUIPreferences.getInstance();</span>
<span class="nc bnc" id="L1945" title="All 2 branches missed.">        if (evt.getSource().equals(fovHighlightAlpha)) {</span>
<span class="nc" id="L1946">            guip.setFovHighlightAlpha(Math.max(0, Math.min(255, (int) fovHighlightAlpha.getValue())));</span>
<span class="nc bnc" id="L1947" title="All 2 branches missed.">        } else if (evt.getSource().equals(fovDarkenAlpha)) {</span>
<span class="nc" id="L1948">            guip.setFovDarkenAlpha(Math.max(0, Math.min(255, (int) fovDarkenAlpha.getValue())));</span>
<span class="nc bnc" id="L1949" title="All 2 branches missed.">        } else if (evt.getSource().equals(numStripesSlider)) {</span>
<span class="nc" id="L1950">            guip.setFovStripes(numStripesSlider.getValue());</span>
        }
<span class="nc" id="L1952">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>