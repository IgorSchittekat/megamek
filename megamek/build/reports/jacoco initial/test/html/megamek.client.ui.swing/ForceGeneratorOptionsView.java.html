<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ForceGeneratorOptionsView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">ForceGeneratorOptionsView.java</span></div><h1>ForceGeneratorOptionsView.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package megamek.client.ui.swing;

import java.awt.Component;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.concurrent.ExecutionException;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.stream.Collectors;

import javax.swing.BorderFactory;
import javax.swing.DefaultListCellRenderer;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.JTextField;
import javax.swing.JTree;
import javax.swing.ProgressMonitor;
import javax.swing.SwingWorker;
import javax.swing.UIManager;
import javax.swing.event.TreeModelListener;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.TreeModel;
import javax.swing.tree.TreePath;

import megamek.MegaMek;
import megamek.client.ratgenerator.AbstractUnitRecord;
import megamek.client.ratgenerator.CrewDescriptor;
import megamek.client.ratgenerator.FactionRecord;
import megamek.client.ratgenerator.ForceDescriptor;
import megamek.client.ratgenerator.ForceNode;
import megamek.client.ratgenerator.MissionRole;
import megamek.client.ratgenerator.RATGenerator;
import megamek.client.ratgenerator.Ruleset;
import megamek.client.ratgenerator.TOCNode;
import megamek.client.ratgenerator.ValueNode;
import megamek.client.ui.Messages;
import megamek.common.Entity;
import megamek.common.EntityWeightClass;
import megamek.common.Game;
import megamek.common.Player;
import megamek.common.UnitType;
import megamek.common.options.OptionsConstants;

/**
 * Controls to set options for force generator.
 * 
 * @author Neoancient
 *
 */


public class ForceGeneratorOptionsView extends JPanel implements FocusListener, ActionListener {

    private static final long serialVersionUID = 5269823128861856001L;

    private int currentYear;
<span class="nc" id="L75">    private Consumer&lt;ForceDescriptor&gt; onGenerate = null;</span>

<span class="nc" id="L77">    private ForceDescriptor forceDesc = new ForceDescriptor();</span>

    private JTextField txtYear;
    private JComboBox&lt;FactionRecord&gt; cbFaction;
    private JComboBox&lt;FactionRecord&gt; cbSubfaction;
    private JComboBox&lt;Integer&gt; cbUnitType;	
    private JComboBox&lt;String&gt; cbFormation;
    private JComboBox&lt;String&gt; cbRating;
    private JComboBox&lt;String&gt; cbFlags;

    private JComboBox&lt;String&gt; cbExperience;
    private JComboBox&lt;Integer&gt; cbWeightClass;
    private JCheckBox chkAttachments;

<span class="nc" id="L91">    private DefaultListCellRenderer factionRenderer = new CBRenderer&lt;FactionRecord&gt;</span>
<span class="nc" id="L92">    (Messages.getString(&quot;ForceGeneratorDialog.general&quot;),</span>
<span class="nc" id="L93">            fRec -&gt; fRec.getName(currentYear));</span>

<span class="nc" id="L95">    private HashMap&lt;String,String&gt; ratingDisplayNames = new HashMap&lt;&gt;();</span>
<span class="nc" id="L96">    private HashMap&lt;String,String&gt; formationDisplayNames = new HashMap&lt;&gt;();</span>
<span class="nc" id="L97">    private HashMap&lt;String,String&gt; flagDisplayNames = new HashMap&lt;&gt;();</span>

    private JPanel panGroundRole;
    private JPanel panInfRole;
    private JPanel panAirRole;

    private JCheckBox chkRoleRecon;
    private JCheckBox chkRoleFireSupport;
    private JCheckBox chkRoleUrban;
    private JCheckBox chkRoleInfantrySupport;
    private JCheckBox chkRoleCavalry;
    private JCheckBox chkRoleRaider;
    private JCheckBox chkRoleIncindiary;
    private JCheckBox chkRoleAntiAircraft;
    private JCheckBox chkRoleAntiInfantry;	
    private JCheckBox chkRoleArtillery;
    private JCheckBox chkRoleMissileArtillery;
    private JCheckBox chkRoleTransport;
    private JCheckBox chkRoleEngineer;

    private JCheckBox chkRoleFieldGun;
    private JCheckBox chkRoleFieldArtillery;
    private JCheckBox chkRoleFieldMissileArtillery;

    private JCheckBox chkRoleAirRecon;
    private JCheckBox chkRoleGroundSupport;
    private JCheckBox chkRoleInterceptor;
    private JCheckBox chkRoleEscort;
    private JCheckBox chkRoleBomber;
    private JCheckBox chkRoleAssault;
    private JCheckBox chkRoleAirTransport;

    private JTextField txtDropshipPct;
    private JTextField txtJumpshipPct;
    private JTextField txtCargo;

    private JButton btnGenerate;
    private JButton btnExportMUL;
    private JButton btnClear;

    private ClientGUI clientGui;

<span class="nc" id="L139">    public ForceGeneratorOptionsView(ClientGUI gui, Consumer&lt;ForceDescriptor&gt; onGenerate) {</span>
<span class="nc" id="L140">        clientGui = gui;</span>
<span class="nc" id="L141">        this.onGenerate = onGenerate;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!Ruleset.isInitialized()) {</span>
<span class="nc" id="L143">            Ruleset.loadData();</span>
        }
<span class="nc" id="L145">        initUi();</span>
<span class="nc" id="L146">    }</span>

    private void initUi() {
<span class="nc" id="L149">        currentYear = clientGui.getClient().getGame().getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</span>
<span class="nc" id="L150">        forceDesc.setYear(currentYear);</span>
<span class="nc" id="L151">        RATGenerator rg = RATGenerator.getInstance();</span>
<span class="nc" id="L152">        rg.loadYear(currentYear);</span>

<span class="nc" id="L154">        setLayout(new GridBagLayout());</span>
<span class="nc" id="L155">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L156">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>
<span class="nc" id="L157">        gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L158">        gbc.insets = new Insets(5, 5, 5, 5);</span>

<span class="nc" id="L160">        int y = 0;</span>

<span class="nc" id="L162">        gbc.gridx = 0;</span>
<span class="nc" id="L163">        gbc.gridy = y;</span>
<span class="nc" id="L164">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.year&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L165">        txtYear = new JTextField();</span>
<span class="nc" id="L166">        txtYear.setEditable(true);</span>
<span class="nc" id="L167">        txtYear.setText(Integer.toString(currentYear));</span>
<span class="nc" id="L168">        txtYear.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.year.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L169">        gbc.gridx = 1;</span>
<span class="nc" id="L170">        gbc.gridy = y++;</span>
<span class="nc" id="L171">        add(txtYear, gbc);</span>
<span class="nc" id="L172">        txtYear.addFocusListener(this);</span>
<span class="nc" id="L173">        gbc.gridx = 0;</span>
<span class="nc" id="L174">        gbc.gridy = y;</span>
<span class="nc" id="L175">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.faction&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L176">        cbFaction = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L177">        cbFaction.setRenderer(factionRenderer);</span>
<span class="nc" id="L178">        gbc.gridx = 1;</span>
<span class="nc" id="L179">        gbc.gridy = y;</span>
<span class="nc" id="L180">        add(cbFaction, gbc);</span>
<span class="nc" id="L181">        cbFaction.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.faction.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L182">        cbFaction.addActionListener(this);</span>

<span class="nc" id="L184">        gbc.gridx = 2;</span>
<span class="nc" id="L185">        gbc.gridy = y;</span>
<span class="nc" id="L186">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.subfaction&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L187">        cbSubfaction = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L188">        cbSubfaction.setRenderer(factionRenderer);</span>
<span class="nc" id="L189">        gbc.gridx = 3;</span>
<span class="nc" id="L190">        gbc.gridy = y++;</span>
<span class="nc" id="L191">        add(cbSubfaction, gbc);</span>
<span class="nc" id="L192">        cbSubfaction.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.subfaction.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L193">        cbSubfaction.addActionListener(this);</span>

<span class="nc" id="L195">        gbc.gridx = 0;</span>
<span class="nc" id="L196">        gbc.gridy = y;</span>
<span class="nc" id="L197">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.unitType&quot;)), gbc);</span>
<span class="nc" id="L198">        cbUnitType = new JComboBox&lt;Integer&gt;();</span>
<span class="nc" id="L199">        cbUnitType.setRenderer(new CBRenderer&lt;Integer&gt;(Messages.getString(&quot;ForceGeneratorDialog.combined&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L200">                ut -&gt; UnitType.getTypeName(ut)));</span>
<span class="nc" id="L201">        gbc.gridx = 1;</span>
<span class="nc" id="L202">        gbc.gridy = y;</span>
<span class="nc" id="L203">        add(cbUnitType, gbc);</span>
<span class="nc" id="L204">        cbUnitType.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.unitType.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L205">        cbUnitType.addActionListener(this);</span>

<span class="nc" id="L207">        gbc.gridx = 2;</span>
<span class="nc" id="L208">        gbc.gridy = y;</span>
<span class="nc" id="L209">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.formation&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L210">        cbFormation = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L211">        cbFormation.setRenderer(new CBRenderer&lt;String&gt;(Messages.getString(&quot;ForceGeneratorDialog.random&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L212">                f -&gt; formationDisplayNames.get(f)));</span>
<span class="nc" id="L213">        gbc.gridx = 3;</span>
<span class="nc" id="L214">        gbc.gridy = y++;</span>
<span class="nc" id="L215">        add(cbFormation, gbc);</span>
<span class="nc" id="L216">        cbFormation.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.formation.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L217">        cbFormation.addActionListener(this);</span>

<span class="nc" id="L219">        gbc.gridx = 0;</span>
<span class="nc" id="L220">        gbc.gridy = y;</span>
<span class="nc" id="L221">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.rating&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L222">        cbRating = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L223">        cbRating.setRenderer(new CBRenderer&lt;String&gt;(Messages.getString(&quot;ForceGeneratorDialog.random&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L224">                r -&gt; ratingDisplayNames.get(r)));</span>
<span class="nc" id="L225">        gbc.gridx = 1;</span>
<span class="nc" id="L226">        gbc.gridy = y;</span>
<span class="nc" id="L227">        add(cbRating, gbc);</span>
<span class="nc" id="L228">        cbRating.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.rating.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L229">        cbRating.addActionListener(this);</span>

<span class="nc" id="L231">        gbc.gridx = 2;</span>
<span class="nc" id="L232">        gbc.gridy = y;</span>
<span class="nc" id="L233">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.weight&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L234">        cbWeightClass = new JComboBox&lt;Integer&gt;();</span>
<span class="nc" id="L235">        cbWeightClass.setRenderer(new CBRenderer&lt;Integer&gt;(Messages.getString(&quot;ForceGeneratorDialog.random&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L236">                wc -&gt; EntityWeightClass.getClassName(wc)));</span>
<span class="nc" id="L237">        cbWeightClass.addItem(null);</span>
<span class="nc" id="L238">        cbWeightClass.addItem(EntityWeightClass.WEIGHT_LIGHT);</span>
<span class="nc" id="L239">        cbWeightClass.addItem(EntityWeightClass.WEIGHT_MEDIUM);</span>
<span class="nc" id="L240">        cbWeightClass.addItem(EntityWeightClass.WEIGHT_HEAVY);</span>
<span class="nc" id="L241">        cbWeightClass.addItem(EntityWeightClass.WEIGHT_ASSAULT);</span>
<span class="nc" id="L242">        gbc.gridx = 3;</span>
<span class="nc" id="L243">        gbc.gridy = y++;</span>
<span class="nc" id="L244">        add(cbWeightClass, gbc);</span>
<span class="nc" id="L245">        cbWeightClass.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.weight.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L246">        cbWeightClass.addActionListener(this);</span>

<span class="nc" id="L248">        gbc.gridx = 0;</span>
<span class="nc" id="L249">        gbc.gridy = y;</span>
<span class="nc" id="L250">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.other&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L251">        cbFlags = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L252">        cbFlags.setRenderer(new CBRenderer&lt;String&gt;(&quot;---&quot;,</span>
<span class="nc" id="L253">                f -&gt; flagDisplayNames.get(f)));</span>
<span class="nc" id="L254">        gbc.gridx = 1;</span>
<span class="nc" id="L255">        gbc.gridy = y;</span>
<span class="nc" id="L256">        add(cbFlags, gbc);</span>
<span class="nc" id="L257">        cbFlags.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.other.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L258">        cbFlags.addActionListener(this);</span>

<span class="nc" id="L260">        gbc.gridx = 2;</span>
<span class="nc" id="L261">        gbc.gridy = y;</span>
<span class="nc" id="L262">        add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.experience&quot;)), gbc); //$NON-NLS-1$</span>
<span class="nc" id="L263">        cbExperience = new JComboBox&lt;String&gt;();</span>
<span class="nc" id="L264">        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.random&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L265">        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.green&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L266">        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.regular&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L267">        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.veteran&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L268">        cbExperience.addItem(Messages.getString(&quot;ForceGeneratorDialog.elite&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L269">        gbc.gridx = 3;</span>
<span class="nc" id="L270">        gbc.gridy = y++;</span>
<span class="nc" id="L271">        add(cbExperience, gbc);</span>
<span class="nc" id="L272">        cbExperience.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.experience.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L273">        cbExperience.addActionListener(this);</span>

<span class="nc" id="L275">        gbc.gridx = 0;</span>
<span class="nc" id="L276">        gbc.gridy = y++;</span>
<span class="nc" id="L277">        gbc.gridwidth = 2;</span>
<span class="nc" id="L278">        chkAttachments = new JCheckBox(Messages.getString(&quot;ForceGeneratorDialog.includeSupportForces&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L279">        chkAttachments.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.includeSupportForces.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L280">        chkAttachments.setSelected(true);</span>
<span class="nc" id="L281">        add(chkAttachments, gbc);</span>

<span class="nc" id="L283">        gbc.gridwidth = 4;</span>
<span class="nc" id="L284">        panGroundRole = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L285">        gbc.gridx = 0;</span>
<span class="nc" id="L286">        gbc.gridy = y++;</span>
<span class="nc" id="L287">        add(panGroundRole, gbc);</span>

<span class="nc" id="L289">        panInfRole = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L290">        gbc.gridx = 0;</span>
<span class="nc" id="L291">        gbc.gridy = y++;</span>
<span class="nc" id="L292">        add(panInfRole, gbc);</span>
<span class="nc" id="L293">        panInfRole.setVisible(false);</span>

<span class="nc" id="L295">        panAirRole = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L296">        gbc.gridx = 0;</span>
<span class="nc" id="L297">        gbc.gridy = y++;</span>
<span class="nc" id="L298">        add(panAirRole, gbc);</span>
<span class="nc" id="L299">        panAirRole.setVisible(false);</span>

<span class="nc" id="L301">        gbc.gridx = 0;</span>
<span class="nc" id="L302">        gbc.gridy = y++;</span>

<span class="nc" id="L304">        JPanel panTransport = new JPanel(new GridLayout(3, 2));</span>
<span class="nc" id="L305">        txtDropshipPct = new JTextField(&quot;0&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L306">        txtDropshipPct.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.dropshipPercentage.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L307">        txtJumpshipPct = new JTextField(&quot;0&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L308">        txtJumpshipPct.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.jumpshipPercentage.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L309">        txtCargo = new JTextField(&quot;0&quot;);</span>
<span class="nc" id="L310">        panTransport.add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.dropshipPercentage&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L311">        panTransport.add(txtDropshipPct, gbc);</span>
<span class="nc" id="L312">        panTransport.add(new JLabel(Messages.getString(&quot;ForceGeneratorDialog.jumpshipPercentage&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L313">        panTransport.add(txtJumpshipPct, gbc);</span>
        // Cargo needs more work to select cargo dropships.
        //        panTransport.add(new JLabel(&quot;Cargo Tonnage:&quot;));
        //        panTransport.add(txtCargo, gbc);
<span class="nc" id="L317">        gbc.gridx = 0;</span>
<span class="nc" id="L318">        gbc.gridy = y++;</span>
<span class="nc" id="L319">        gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L320">        panTransport.setBorder(BorderFactory.createTitledBorder(Messages.getString(&quot;ForceGeneratorDialog.transport&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L321">        add(panTransport, gbc);</span>

<span class="nc" id="L323">        btnGenerate = new JButton(Messages.getString(&quot;ForceGeneratorDialog.generate&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L324">        btnGenerate.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.generate.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L325">        gbc.gridx = 0;</span>
<span class="nc" id="L326">        gbc.gridy = y;</span>
<span class="nc" id="L327">        gbc.gridwidth = 1;</span>
<span class="nc" id="L328">        gbc.weighty = 1.0;</span>
<span class="nc" id="L329">        add(btnGenerate, gbc);</span>
<span class="nc" id="L330">        btnGenerate.addActionListener(this);</span>

<span class="nc" id="L332">        btnExportMUL = new JButton(Messages.getString(&quot;ForceGeneratorDialog.exportMUL&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L333">        btnExportMUL.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.exportMUL.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L334">        gbc.gridx = 1;</span>
<span class="nc" id="L335">        gbc.gridy = y;</span>
<span class="nc" id="L336">        add(btnExportMUL, gbc);</span>
<span class="nc" id="L337">        btnExportMUL.addActionListener(this);</span>
<span class="nc" id="L338">        btnExportMUL.setEnabled(false);</span>

<span class="nc" id="L340">        btnClear = new JButton(Messages.getString(&quot;ForceGeneratorDialog.clear&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L341">        btnClear.setToolTipText(Messages.getString(&quot;ForceGeneratorDialog.clear.tooltip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L342">        gbc.gridx = 2;</span>
<span class="nc" id="L343">        gbc.gridy = y;</span>
<span class="nc" id="L344">        gbc.weighty = 1.0;</span>
<span class="nc" id="L345">        add(btnClear, gbc);</span>
<span class="nc" id="L346">        btnClear.addActionListener(this);</span>
<span class="nc" id="L347">        btnClear.setEnabled(false);</span>

<span class="nc" id="L349">        gbc = new GridBagConstraints();</span>
<span class="nc" id="L350">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>

<span class="nc" id="L352">        chkRoleRecon = createMissionRoleCheck(MissionRole.RECON);</span>
<span class="nc" id="L353">        gbc.gridx = 0;</span>
<span class="nc" id="L354">        gbc.gridy = 0;</span>
<span class="nc" id="L355">        panGroundRole.add(chkRoleRecon, gbc);</span>

<span class="nc" id="L357">        chkRoleFireSupport = createMissionRoleCheck(MissionRole.FIRE_SUPPORT);</span>
<span class="nc" id="L358">        gbc.gridx = 1;</span>
<span class="nc" id="L359">        gbc.gridy = 0;</span>
<span class="nc" id="L360">        panGroundRole.add(chkRoleFireSupport, gbc);</span>

<span class="nc" id="L362">        chkRoleUrban = createMissionRoleCheck(MissionRole.URBAN);</span>
<span class="nc" id="L363">        gbc.gridx = 2;</span>
<span class="nc" id="L364">        gbc.gridy = 0;</span>
<span class="nc" id="L365">        panGroundRole.add(chkRoleUrban, gbc);</span>

<span class="nc" id="L367">        chkRoleCavalry = createMissionRoleCheck(MissionRole.CAVALRY);</span>
<span class="nc" id="L368">        gbc.gridx = 3;</span>
<span class="nc" id="L369">        gbc.gridy = 0;</span>
<span class="nc" id="L370">        panGroundRole.add(chkRoleCavalry, gbc);</span>

<span class="nc" id="L372">        chkRoleRaider = createMissionRoleCheck(MissionRole.RAIDER);</span>
<span class="nc" id="L373">        gbc.gridx = 0;</span>
<span class="nc" id="L374">        gbc.gridy = 1;</span>
<span class="nc" id="L375">        panGroundRole.add(chkRoleRaider, gbc);</span>

<span class="nc" id="L377">        chkRoleIncindiary = createMissionRoleCheck(MissionRole.INCENDIARY);</span>
<span class="nc" id="L378">        gbc.gridx = 1;</span>
<span class="nc" id="L379">        gbc.gridy = 1;</span>
<span class="nc" id="L380">        panGroundRole.add(chkRoleIncindiary, gbc);</span>

<span class="nc" id="L382">        chkRoleAntiAircraft = createMissionRoleCheck(MissionRole.ANTI_AIRCRAFT);</span>
<span class="nc" id="L383">        gbc.gridx = 2;</span>
<span class="nc" id="L384">        gbc.gridy = 1;</span>
<span class="nc" id="L385">        panGroundRole.add(chkRoleAntiAircraft, gbc);</span>

<span class="nc" id="L387">        chkRoleAntiInfantry = createMissionRoleCheck(MissionRole.ANTI_INFANTRY);</span>
<span class="nc" id="L388">        gbc.gridx = 3;</span>
<span class="nc" id="L389">        gbc.gridy = 1;</span>
<span class="nc" id="L390">        panGroundRole.add(chkRoleAntiInfantry, gbc);</span>

<span class="nc" id="L392">        chkRoleArtillery = createMissionRoleCheck(MissionRole.ARTILLERY);</span>
<span class="nc" id="L393">        gbc.gridx = 0;</span>
<span class="nc" id="L394">        gbc.gridy = 2;</span>
<span class="nc" id="L395">        panGroundRole.add(chkRoleArtillery, gbc);</span>

<span class="nc" id="L397">        chkRoleMissileArtillery = createMissionRoleCheck(MissionRole.MISSILE_ARTILLERY);</span>
<span class="nc" id="L398">        gbc.gridx = 1;</span>
<span class="nc" id="L399">        gbc.gridy = 2;</span>
<span class="nc" id="L400">        panGroundRole.add(chkRoleMissileArtillery, gbc);</span>

<span class="nc" id="L402">        chkRoleInfantrySupport = createMissionRoleCheck(MissionRole.INF_SUPPORT);</span>
<span class="nc" id="L403">        gbc.gridx = 2;</span>
<span class="nc" id="L404">        gbc.gridy = 2;</span>
<span class="nc" id="L405">        panGroundRole.add(chkRoleInfantrySupport, gbc);</span>

<span class="nc" id="L407">        chkRoleTransport = createMissionRoleCheck(MissionRole.CARGO);</span>
<span class="nc" id="L408">        gbc.gridx = 0;</span>
<span class="nc" id="L409">        gbc.gridy = 3;</span>
<span class="nc" id="L410">        panGroundRole.add(chkRoleTransport, gbc);</span>

<span class="nc" id="L412">        chkRoleEngineer = createMissionRoleCheck(MissionRole.ENGINEER);</span>
<span class="nc" id="L413">        gbc.gridx = 1;</span>
<span class="nc" id="L414">        gbc.gridy = 3;</span>
<span class="nc" id="L415">        panGroundRole.add(chkRoleEngineer, gbc);</span>

<span class="nc" id="L417">        gbc = new GridBagConstraints();</span>
<span class="nc" id="L418">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>

<span class="nc" id="L420">        chkRoleFieldGun = createMissionRoleCheck(MissionRole.FIELD_GUN);</span>
<span class="nc" id="L421">        gbc.gridx = 0;</span>
<span class="nc" id="L422">        gbc.gridy = 0;</span>
<span class="nc" id="L423">        panInfRole.add(chkRoleFieldGun, gbc);</span>

<span class="nc" id="L425">        chkRoleFieldArtillery = createMissionRoleCheck(MissionRole.ARTILLERY);</span>
<span class="nc" id="L426">        gbc.gridx = 1;</span>
<span class="nc" id="L427">        gbc.gridy = 0;</span>
<span class="nc" id="L428">        panInfRole.add(chkRoleFieldArtillery, gbc);</span>

<span class="nc" id="L430">        chkRoleFieldMissileArtillery = createMissionRoleCheck(MissionRole.MISSILE_ARTILLERY);</span>
<span class="nc" id="L431">        gbc.gridx = 2;</span>
<span class="nc" id="L432">        gbc.gridy = 0;</span>
<span class="nc" id="L433">        panInfRole.add(chkRoleFieldMissileArtillery, gbc);</span>

<span class="nc" id="L435">        gbc = new GridBagConstraints();</span>
<span class="nc" id="L436">        gbc.anchor = GridBagConstraints.NORTHWEST;</span>

<span class="nc" id="L438">        chkRoleAirRecon = createMissionRoleCheck(MissionRole.RECON);</span>
<span class="nc" id="L439">        gbc.gridx = 0;</span>
<span class="nc" id="L440">        gbc.gridy = 0;</span>
<span class="nc" id="L441">        panAirRole.add(chkRoleAirRecon, gbc);</span>

<span class="nc" id="L443">        chkRoleGroundSupport = createMissionRoleCheck(MissionRole.GROUND_SUPPORT);</span>
<span class="nc" id="L444">        gbc.gridx = 1;</span>
<span class="nc" id="L445">        gbc.gridy = 0;</span>
<span class="nc" id="L446">        panAirRole.add(chkRoleGroundSupport, gbc);</span>

<span class="nc" id="L448">        chkRoleInterceptor = createMissionRoleCheck(MissionRole.INTERCEPTOR);</span>
<span class="nc" id="L449">        gbc.gridx = 2;</span>
<span class="nc" id="L450">        gbc.gridy = 0;</span>
<span class="nc" id="L451">        panAirRole.add(chkRoleInterceptor, gbc);</span>

<span class="nc" id="L453">        chkRoleEscort = createMissionRoleCheck(MissionRole.ESCORT);</span>
<span class="nc" id="L454">        gbc.gridx = 0;</span>
<span class="nc" id="L455">        gbc.gridy = 1;</span>
<span class="nc" id="L456">        panAirRole.add(chkRoleEscort, gbc);</span>

<span class="nc" id="L458">        chkRoleBomber = createMissionRoleCheck(MissionRole.BOMBER);</span>
<span class="nc" id="L459">        gbc.gridx = 1;</span>
<span class="nc" id="L460">        gbc.gridy = 1;</span>
<span class="nc" id="L461">        panAirRole.add(chkRoleBomber, gbc);</span>

<span class="nc" id="L463">        chkRoleAssault = createMissionRoleCheck(MissionRole.ASSAULT);</span>
<span class="nc" id="L464">        gbc.gridx = 0;</span>
<span class="nc" id="L465">        gbc.gridy = 2;</span>
<span class="nc" id="L466">        panAirRole.add(chkRoleAssault, gbc);</span>

<span class="nc" id="L468">        chkRoleAirTransport = createMissionRoleCheck(MissionRole.CARGO);</span>
<span class="nc" id="L469">        gbc.gridx = 1;</span>
<span class="nc" id="L470">        gbc.gridy = 2;</span>
<span class="nc" id="L471">        panAirRole.add(chkRoleAirTransport, gbc);</span>

<span class="nc" id="L473">        refreshFactions();</span>
<span class="nc" id="L474">    }</span>

    private JCheckBox createMissionRoleCheck(MissionRole role) {
<span class="nc" id="L477">        String key = &quot;MissionRole.&quot; + role.toString().toLowerCase();</span>
<span class="nc" id="L478">        JCheckBox chk = new JCheckBox(Messages.getString(key));</span>
<span class="nc" id="L479">        chk.setToolTipText(Messages.getString(key + &quot;.tooltip&quot;));</span>
<span class="nc" id="L480">        return chk;</span>
    }

    private void generateForce() {
<span class="nc" id="L484">        ForceDescriptor fd = new ForceDescriptor();</span>
<span class="nc" id="L485">        fd.setTopLevel(true);</span>
<span class="nc" id="L486">        fd.setYear(forceDesc.getYear());</span>
<span class="nc" id="L487">        fd.setFaction(forceDesc.getFaction());</span>
<span class="nc" id="L488">        fd.setUnitType(forceDesc.getUnitType());</span>
<span class="nc" id="L489">        fd.setEschelon(forceDesc.getEschelon());</span>
<span class="nc" id="L490">        fd.setAugmented(forceDesc.isAugmented());</span>
<span class="nc" id="L491">        fd.setSizeMod(forceDesc.getSizeMod());</span>
<span class="nc" id="L492">        fd.getFlags().addAll(forceDesc.getFlags());</span>
<span class="nc" id="L493">        fd.setRating(forceDesc.getRating());</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">        if (forceDesc.getExperience() != null) {</span>
<span class="nc" id="L495">            fd.setExperience(forceDesc.getExperience());</span>
        } else {
<span class="nc" id="L497">            fd.setExperience(CrewDescriptor.randomExperienceLevel());</span>
        }
<span class="nc" id="L499">        fd.setWeightClass(forceDesc.getWeightClass());</span>
<span class="nc" id="L500">        fd.setAttachments(chkAttachments.isSelected());</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (forceDesc.getUnitType() != null) {</span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">            switch (forceDesc.getUnitType()) {</span>
            case UnitType.MEK:case UnitType.TANK:
<span class="nc bnc" id="L504" title="All 2 branches missed.">                if (chkRoleRecon.isSelected()) {</span>
<span class="nc" id="L505">                    fd.getRoles().add(MissionRole.RECON);</span>
                }
<span class="nc bnc" id="L507" title="All 2 branches missed.">                if (chkRoleFireSupport.isSelected()) {</span>
<span class="nc" id="L508">                    fd.getRoles().add(MissionRole.FIRE_SUPPORT);</span>
                }
<span class="nc bnc" id="L510" title="All 2 branches missed.">                if (chkRoleUrban.isSelected()) {</span>
<span class="nc" id="L511">                    fd.getRoles().add(MissionRole.URBAN);</span>
                }
<span class="nc bnc" id="L513" title="All 2 branches missed.">                if (chkRoleInfantrySupport.isSelected()) {</span>
<span class="nc" id="L514">                    fd.getRoles().add(MissionRole.INF_SUPPORT);</span>
                }
<span class="nc bnc" id="L516" title="All 2 branches missed.">                if (chkRoleCavalry.isSelected()) {</span>
<span class="nc" id="L517">                    fd.getRoles().add(MissionRole.CAVALRY);</span>
                }
<span class="nc bnc" id="L519" title="All 2 branches missed.">                if (chkRoleRaider.isSelected()) {</span>
<span class="nc" id="L520">                    fd.getRoles().add(MissionRole.RAIDER);</span>
                }
<span class="nc bnc" id="L522" title="All 2 branches missed.">                if (chkRoleIncindiary.isSelected()) {</span>
<span class="nc" id="L523">                    fd.getRoles().add(MissionRole.INCENDIARY);</span>
                }
<span class="nc bnc" id="L525" title="All 2 branches missed.">                if (chkRoleAntiAircraft.isSelected()) {</span>
<span class="nc" id="L526">                    fd.getRoles().add(MissionRole.ANTI_AIRCRAFT);</span>
                }
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if (chkRoleAntiInfantry.isSelected()) {</span>
<span class="nc" id="L529">                    fd.getRoles().add(MissionRole.ANTI_INFANTRY);</span>
                }			
<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (chkRoleArtillery.isSelected()) {</span>
<span class="nc" id="L532">                    fd.getRoles().add(MissionRole.ARTILLERY);</span>
                }
<span class="nc bnc" id="L534" title="All 2 branches missed.">                if (chkRoleMissileArtillery.isSelected()) {</span>
<span class="nc" id="L535">                    fd.getRoles().add(MissionRole.MISSILE_ARTILLERY);</span>
                }
<span class="nc bnc" id="L537" title="All 2 branches missed.">                if (chkRoleTransport.isSelected()) {</span>
<span class="nc" id="L538">                    fd.getRoles().add(MissionRole.CARGO);</span>
                }
<span class="nc bnc" id="L540" title="All 2 branches missed.">                if (chkRoleEngineer.isSelected()) {</span>
<span class="nc" id="L541">                    fd.getRoles().add(MissionRole.ENGINEER);</span>
                }
                break;
            case UnitType.INFANTRY:
            case UnitType.BATTLE_ARMOR:
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (chkRoleFieldGun.isSelected()) {</span>
<span class="nc" id="L547">                    fd.getRoles().add(MissionRole.FIELD_GUN);</span>
                }
<span class="nc bnc" id="L549" title="All 2 branches missed.">                if (chkRoleFieldArtillery.isSelected()) {</span>
<span class="nc" id="L550">                    fd.getRoles().add(MissionRole.ARTILLERY);</span>
                }
<span class="nc bnc" id="L552" title="All 2 branches missed.">                if (chkRoleFieldMissileArtillery.isSelected()) {</span>
<span class="nc" id="L553">                    fd.getRoles().add(MissionRole.MISSILE_ARTILLERY);</span>
                }
                break;
            case UnitType.AERO:
<span class="nc bnc" id="L557" title="All 2 branches missed.">                if (chkRoleAirRecon.isSelected()) {</span>
<span class="nc" id="L558">                    fd.getRoles().add(MissionRole.RECON);</span>
                }
<span class="nc bnc" id="L560" title="All 2 branches missed.">                if (chkRoleGroundSupport.isSelected()) {</span>
<span class="nc" id="L561">                    fd.getRoles().add(MissionRole.GROUND_SUPPORT);</span>
                }
<span class="nc bnc" id="L563" title="All 2 branches missed.">                if (chkRoleInterceptor.isSelected()) {</span>
<span class="nc" id="L564">                    fd.getRoles().add(MissionRole.INTERCEPTOR);</span>
                }
<span class="nc bnc" id="L566" title="All 2 branches missed.">                if (chkRoleAssault.isSelected()) {</span>
<span class="nc" id="L567">                    fd.getRoles().add(MissionRole.ASSAULT);</span>
                }
<span class="nc bnc" id="L569" title="All 2 branches missed.">                if (chkRoleAirTransport.isSelected()) {</span>
<span class="nc" id="L570">                    fd.getRoles().add(MissionRole.CARGO);</span>
                }
            }
        }
        try {
<span class="nc" id="L575">            fd.setDropshipPct(Double.parseDouble(txtDropshipPct.getText()) * 0.01);</span>
<span class="nc" id="L576">        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L577">            fd.setDropshipPct(0.0);</span>
<span class="nc" id="L578">            txtDropshipPct.setText(&quot;0&quot;);</span>
<span class="nc" id="L579">        }</span>
        try {
<span class="nc" id="L581">            fd.setJumpshipPct(Double.parseDouble(txtJumpshipPct.getText()) * 0.01);</span>
<span class="nc" id="L582">        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L583">            fd.setJumpshipPct(0.0);</span>
<span class="nc" id="L584">            txtJumpshipPct.setText(&quot;0&quot;);</span>
<span class="nc" id="L585">        }</span>
        try {
<span class="nc" id="L587">            fd.setCargo(Double.parseDouble(txtCargo.getText()));</span>
<span class="nc" id="L588">        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L589">            fd.setCargo(0.0);</span>
<span class="nc" id="L590">            txtCargo.setText(&quot;0&quot;);</span>
<span class="nc" id="L591">        }</span>

<span class="nc" id="L593">        ProgressMonitor monitor = new ProgressMonitor(this, Messages.getString(&quot;ForceGeneratorDialog.generateFormation&quot;), &quot;&quot;, 0, 100);</span>
<span class="nc" id="L594">        monitor.setProgress(0);</span>
<span class="nc" id="L595">        GenerateTask task = new GenerateTask(fd);</span>
<span class="nc" id="L596">        task.addPropertyChangeListener(e -&gt; {</span>
<span class="nc" id="L597">            monitor.setProgress(task.getProgress());</span>
<span class="nc" id="L598">            monitor.setNote(task.getMessage());</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">            if (monitor.isCanceled()) {</span>
<span class="nc" id="L600">                task.cancel(true);</span>
            }
<span class="nc" id="L602">        });</span>
<span class="nc" id="L603">        task.execute();</span>
<span class="nc" id="L604">    }</span>

    private void clearForce() {
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (null != onGenerate) {</span>
<span class="nc" id="L608">            onGenerate.accept(null);</span>
        }
<span class="nc" id="L610">    }</span>

    private void refreshFactions() {
<span class="nc" id="L613">        FactionRecord oldFaction = (FactionRecord)cbFaction.getSelectedItem();</span>
<span class="nc" id="L614">        cbFaction.removeActionListener(this);</span>
<span class="nc" id="L615">        cbFaction.removeAllItems();</span>
<span class="nc" id="L616">        List&lt;FactionRecord&gt; sorted = RATGenerator.getInstance().getFactionList()</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">                .stream().filter(fr -&gt; !fr.getKey().contains(&quot;.&quot;) &amp;&amp; fr.isActiveInYear(currentYear))</span>
<span class="nc" id="L618">                .collect(Collectors.toList());</span>
<span class="nc" id="L619">        sorted.sort((fr1, fr2) -&gt; fr1.getName(currentYear).compareTo(fr2.getName(currentYear)));</span>
<span class="nc" id="L620">        sorted.forEach(fr -&gt; cbFaction.addItem(fr));</span>
<span class="nc" id="L621">        cbFaction.setSelectedItem(oldFaction);</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (cbFaction.getSelectedItem() == null ||</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                !cbFaction.getSelectedItem().toString().equals(oldFaction.toString())) {</span>
<span class="nc" id="L624">            cbFaction.setSelectedItem(RATGenerator.getInstance().getFaction(&quot;IS&quot;));</span>
        }
<span class="nc" id="L626">        forceDesc.setFaction(cbFaction.getSelectedItem().toString());</span>
<span class="nc" id="L627">        refreshSubfactions();</span>
<span class="nc" id="L628">        cbFaction.addActionListener(this);</span>
<span class="nc" id="L629">    }</span>

    private void refreshSubfactions() {
<span class="nc" id="L632">        FactionRecord oldFaction = (FactionRecord)cbSubfaction.getSelectedItem();</span>
<span class="nc" id="L633">        cbSubfaction.removeActionListener(this);</span>
<span class="nc" id="L634">        cbSubfaction.removeAllItems();</span>
<span class="nc" id="L635">        String currentFaction = ((FactionRecord)cbFaction.getSelectedItem()).getKey();</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (currentFaction != null) {</span>
<span class="nc" id="L637">            List&lt;FactionRecord&gt; sorted = RATGenerator.getInstance().getFactionList().stream()</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                    .filter(fr -&gt; fr.getKey().startsWith(currentFaction + &quot;.&quot;)</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                            &amp;&amp; fr.isActiveInYear(currentYear))</span>
<span class="nc" id="L640">                    .collect(Collectors.toList());</span>
<span class="nc" id="L641">            sorted.sort((fr1, fr2) -&gt; fr1.getName(currentYear).compareTo(fr2.getName(currentYear)));</span>
<span class="nc" id="L642">            cbSubfaction.addItem(null);</span>
<span class="nc" id="L643">            sorted.forEach(fr -&gt; cbSubfaction.addItem(fr));</span>
        }
<span class="nc" id="L645">        cbSubfaction.setSelectedItem(oldFaction);</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (cbSubfaction.getSelectedItem() == null) {</span>
<span class="nc" id="L647">            forceDesc.setFaction(cbFaction.getSelectedItem().toString());</span>
        } else {
<span class="nc" id="L649">            forceDesc.setFaction(cbSubfaction.getSelectedItem().toString());</span>
        }
<span class="nc" id="L651">        refreshUnitTypes();</span>
<span class="nc" id="L652">        cbSubfaction.addActionListener(this);</span>
<span class="nc" id="L653">    }</span>

    private void refreshUnitTypes() {
<span class="nc" id="L656">        cbUnitType.removeActionListener(this);</span>
<span class="nc" id="L657">        TOCNode tocNode = findTOCNode();</span>
<span class="nc" id="L658">        Integer currentType = forceDesc.getUnitType();</span>
<span class="nc" id="L659">        boolean hasCurrent = false;</span>
<span class="nc" id="L660">        cbUnitType.removeAllItems();</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">        if (tocNode != null) {</span>
<span class="nc" id="L662">            ValueNode n = tocNode.findUnitTypes(forceDesc);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">            if (n != null) {</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                for (String unitType : n.getContent().split(&quot;,&quot;)) {</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">                    if (unitType.equals(&quot;null&quot;)) {</span>
<span class="nc" id="L666">                        cbUnitType.addItem(null);</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">                        if (currentType == null) {</span>
<span class="nc" id="L668">                            hasCurrent = true;</span>
                        }
                    } else {
<span class="nc" id="L671">                        cbUnitType.addItem(AbstractUnitRecord.parseUnitType(unitType));</span>
<span class="nc bnc" id="L672" title="All 4 branches missed.">                        if (currentType != null &amp;&amp; UnitType.getTypeDisplayableName(currentType).equals(unitType)) {</span>
<span class="nc" id="L673">                            hasCurrent = true;</span>
                        }
                    }
                }
            } else {
<span class="nc" id="L678">                MegaMek.getLogger().warning(&quot;No unit type node found.&quot;);</span>
<span class="nc" id="L679">                cbUnitType.addItem(null);</span>
            }
<span class="nc" id="L681">        } else {</span>
<span class="nc" id="L682">            cbUnitType.addItem(null);</span>
        }

<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (hasCurrent) {</span>
<span class="nc" id="L686">            cbUnitType.setSelectedItem(currentType);</span>
        } else {
<span class="nc" id="L688">            Ruleset rs = Ruleset.findRuleset(forceDesc.getFaction());</span>
<span class="nc" id="L689">            Integer unitType = rs.getDefaultUnitType(forceDesc);</span>
<span class="nc bnc" id="L690" title="All 4 branches missed.">            if (unitType == null &amp;&amp; cbUnitType.getItemCount() &gt; 0) {</span>
<span class="nc" id="L691">                unitType = (Integer)cbUnitType.getItemAt(0);</span>
            }
<span class="nc" id="L693">            cbUnitType.setSelectedItem(unitType);</span>
<span class="nc" id="L694">            forceDesc.setUnitType(unitType);</span>
        }
<span class="nc" id="L696">        refreshFormations();</span>
<span class="nc" id="L697">        cbUnitType.addActionListener(this);</span>
<span class="nc" id="L698">    }</span>

    private void refreshFormations() {
<span class="nc" id="L701">        cbFormation.removeActionListener(this);</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (cbUnitType.getSelectedItem() != null) {</span>
<span class="nc" id="L703">            Integer unitType = (Integer)cbUnitType.getSelectedItem();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">            if (unitType != null) {</span>
<span class="nc bnc" id="L705" title="All 4 branches missed.">                panGroundRole.setVisible(unitType == UnitType.MEK || unitType == UnitType.TANK);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                panInfRole.setVisible(unitType == UnitType.INFANTRY</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                        || unitType == UnitType.BATTLE_ARMOR);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                panAirRole.setVisible(unitType == UnitType.AERO</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                        || unitType == UnitType.CONV_FIGHTER);</span>
            }
        }

<span class="nc" id="L713">        TOCNode tocNode = findTOCNode();</span>
<span class="nc" id="L714">        String currentFormation = (String)cbFormation.getSelectedItem();</span>
<span class="nc" id="L715">        boolean hasCurrent = false;</span>
<span class="nc" id="L716">        Ruleset ruleset = Ruleset.findRuleset(forceDesc);</span>
<span class="nc" id="L717">        cbFormation.removeAllItems();</span>

<span class="nc bnc" id="L719" title="All 2 branches missed.">        if (tocNode != null) {</span>
<span class="nc" id="L720">            ValueNode n = tocNode.findEschelons(forceDesc);</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">            if (n != null) {</span>
<span class="nc" id="L722">                formationDisplayNames.clear();</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                for (String formation : n.getContent().split(&quot;,&quot;)) {</span>
<span class="nc" id="L724">                    Ruleset rs = ruleset;</span>
<span class="nc" id="L725">                    ForceNode fn = null;</span>
                    do {
<span class="nc" id="L727">                        fn = rs.findForceNode(forceDesc,</span>
<span class="nc" id="L728">                                Integer.parseInt(formation.replaceAll(&quot;[^0-9]&quot;, &quot;&quot;)),</span>
<span class="nc" id="L729">                                formation.endsWith(&quot;^&quot;));</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">                        if (fn == null) {</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">                            if (rs.getParent() != null) {</span>
<span class="nc" id="L732">                                rs = Ruleset.findRuleset(rs.getParent());</span>
                            } else {
<span class="nc" id="L734">                                rs = null;</span>
                            }
                        }
<span class="nc bnc" id="L737" title="All 4 branches missed.">                    } while (fn == null &amp;&amp; rs != null);</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">                    String formName = (fn != null)?fn.getEschelonName() : formation;</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">                    if (formation.endsWith(&quot;+&quot;)) {</span>
<span class="nc" id="L740">                        formName = Messages.getString(&quot;ForceGeneratorDialog.reinforced&quot;) + formName;</span>
                    }
<span class="nc bnc" id="L742" title="All 2 branches missed.">                    if (formation.endsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L743">                        formName = Messages.getString(&quot;ForceGeneratorDialog.understrength&quot;) + formName;</span>
                    }
<span class="nc" id="L745">                    formationDisplayNames.put(formation, formName);</span>
<span class="nc" id="L746">                    cbFormation.addItem(formation);</span>
<span class="nc bnc" id="L747" title="All 4 branches missed.">                    if (currentFormation != null &amp;&amp; currentFormation.equals(formation)) {</span>
<span class="nc" id="L748">                        hasCurrent = true;</span>
                    }
                }
            }
<span class="nc" id="L752">        } else {</span>
<span class="nc" id="L753">            MegaMek.getLogger().warning(&quot;No eschelon node found.&quot;);</span>
        }

<span class="nc bnc" id="L756" title="All 2 branches missed.">        if (hasCurrent) {</span>
<span class="nc" id="L757">            cbFormation.setSelectedItem(currentFormation);</span>
        } else {
<span class="nc" id="L759">            Ruleset rs = Ruleset.findRuleset(forceDesc.getFaction());</span>
<span class="nc" id="L760">            String esch = rs.getDefaultEschelon(forceDesc);</span>
<span class="nc bnc" id="L761" title="All 4 branches missed.">            if ((esch == null || !formationDisplayNames.containsKey(esch)</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                    &amp;&amp; cbFormation.getItemCount() &gt; 0)) {</span>
<span class="nc" id="L763">                esch = (String)cbFormation.getItemAt(0);</span>
            }
<span class="nc bnc" id="L765" title="All 2 branches missed.">            if (esch != null) {</span>
<span class="nc" id="L766">                cbFormation.setSelectedItem(esch);</span>
<span class="nc" id="L767">                setFormation(esch);</span>
            }
        }

<span class="nc" id="L771">        refreshRatings();</span>
<span class="nc" id="L772">        cbFormation.addActionListener(this);</span>
<span class="nc" id="L773">    }</span>

    private void refreshRatings() {
<span class="nc" id="L776">        cbRating.removeActionListener(this);</span>
<span class="nc" id="L777">        TOCNode tocNode = findTOCNode();</span>
<span class="nc" id="L778">        String currentRating = forceDesc.getRating();</span>
<span class="nc" id="L779">        boolean hasCurrent = false;</span>
<span class="nc" id="L780">        cbRating.removeAllItems();</span>
<span class="nc" id="L781">        ratingDisplayNames.clear();</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">        if (tocNode != null) {</span>
<span class="nc" id="L783">            ValueNode n = tocNode.findRatings(forceDesc);</span>
<span class="nc bnc" id="L784" title="All 4 branches missed.">            if (n != null &amp;&amp; n.getContent() != null) {</span>
<span class="nc" id="L785">                cbRating.addItem(null);</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">                for (String rating : n.getContent().split(&quot;,&quot;)) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                    if (rating.contains(&quot;:&quot;)) {</span>
<span class="nc" id="L788">                        String[] fields = rating.split(&quot;:&quot;);</span>
<span class="nc" id="L789">                        cbRating.addItem(fields[0]);</span>
<span class="nc" id="L790">                        ratingDisplayNames.put(fields[0], fields[1]);</span>
<span class="nc" id="L791">                    } else {</span>
<span class="nc" id="L792">                        cbRating.addItem(rating);</span>
<span class="nc" id="L793">                        ratingDisplayNames.put(rating, rating);</span>
                    }
                }
            } else {
<span class="nc" id="L797">                MegaMek.getLogger().warning(&quot;No rating found.&quot;);</span>
            }
        }

<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (hasCurrent) {</span>
<span class="nc" id="L802">            cbRating.setSelectedItem(currentRating);</span>
        } else {
<span class="nc" id="L804">            Ruleset rs = Ruleset.findRuleset(forceDesc.getFaction());</span>
<span class="nc" id="L805">            String rating = rs.getDefaultRating(forceDesc);</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">            if (rating == null &amp;&amp; cbRating.getItemCount() &gt; 0) {</span>
<span class="nc" id="L807">                rating = cbRating.getItemAt(0);</span>
            }
<span class="nc bnc" id="L809" title="All 2 branches missed.">            if (rating != null) {</span>
<span class="nc" id="L810">                cbRating.setSelectedItem(rating);</span>
<span class="nc" id="L811">                forceDesc.setRating(rating);</span>
            }
        }
<span class="nc" id="L814">        refreshFlags();</span>
<span class="nc" id="L815">        cbRating.addActionListener(this);</span>
<span class="nc" id="L816">    }</span>

    private void refreshFlags() {
<span class="nc" id="L819">        cbFlags.removeActionListener(this);</span>
<span class="nc" id="L820">        TOCNode tocNode = findTOCNode();</span>
<span class="nc" id="L821">        String currentFlag = (String)cbFlags.getSelectedItem();</span>
<span class="nc" id="L822">        boolean hasCurrent = false;</span>
<span class="nc" id="L823">        cbFlags.removeAllItems();</span>
<span class="nc" id="L824">        cbFlags.addItem(null);</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">        if (tocNode != null) {</span>
<span class="nc" id="L826">            ValueNode n = tocNode.findFlags(forceDesc);</span>
<span class="nc bnc" id="L827" title="All 4 branches missed.">            if (n != null &amp;&amp; n.getContent() != null) {</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">                for (String flag : n.getContent().split(&quot;,&quot;)) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                    if (flag.contains(&quot;:&quot;)) {</span>
<span class="nc" id="L830">                        String[] fields = flag.split(&quot;:&quot;);</span>
<span class="nc" id="L831">                        flagDisplayNames.put(fields[0], fields[1]);</span>
<span class="nc" id="L832">                        cbFlags.addItem(fields[0]);</span>
<span class="nc" id="L833">                    } else {</span>
<span class="nc" id="L834">                        flagDisplayNames.put(flag, flag);</span>
<span class="nc" id="L835">                        cbFlags.addItem(flag);</span>
                    }
                }
            }
        }

<span class="nc bnc" id="L841" title="All 2 branches missed.">        if (hasCurrent) {</span>
<span class="nc" id="L842">            cbFlags.setSelectedItem(currentFlag);</span>
        } else {
<span class="nc" id="L844">            cbFlags.setSelectedIndex(0);</span>
        }
<span class="nc" id="L846">        forceDesc.getFlags().clear();</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">        if (cbFlags.getSelectedItem() != null) {</span>
<span class="nc" id="L848">            forceDesc.getFlags().add((String)cbFlags.getSelectedItem());</span>
        }
<span class="nc" id="L850">        cbFlags.addActionListener(this);</span>
<span class="nc" id="L851">    }</span>

    private TOCNode findTOCNode() {
<span class="nc" id="L854">        Ruleset rs = Ruleset.findRuleset(forceDesc);</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">        if (null == rs) {</span>
<span class="nc" id="L856">            return null;</span>
        }
<span class="nc" id="L858">        TOCNode toc = null;</span>
        do {
<span class="nc" id="L860">            toc = rs.getTOCNode();</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">            if (toc == null) {</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">                if (rs.getParent() == null) {</span>
<span class="nc" id="L863">                    rs = null;</span>
                } else {
<span class="nc" id="L865">                    rs = Ruleset.findRuleset(rs.getParent());</span>
                }				
            }
<span class="nc bnc" id="L868" title="All 4 branches missed.">        } while (rs != null &amp;&amp; toc == null);</span>
<span class="nc" id="L869">        return toc;</span>
    }

    @Override
    public void actionPerformed(ActionEvent ev) {
<span class="nc bnc" id="L874" title="All 2 branches missed.">        if (ev.getSource() == cbFaction) {</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">            if (cbFaction.getSelectedItem() != null) {</span>
<span class="nc" id="L876">                forceDesc.setFaction(((FactionRecord)cbFaction.getSelectedItem()).getKey());</span>
            }
<span class="nc" id="L878">            refreshSubfactions();</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">        } else if (ev.getSource() == cbSubfaction) {</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">            if (cbSubfaction.getSelectedItem() != null) {</span>
<span class="nc" id="L881">                forceDesc.setFaction(((FactionRecord)cbSubfaction.getSelectedItem()).getKey());</span>
            } else {
<span class="nc" id="L883">                forceDesc.setFaction(((FactionRecord)cbFaction.getSelectedItem()).getKey());</span>
            }
<span class="nc" id="L885">            refreshUnitTypes();</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">        } else if (ev.getSource() == cbUnitType) {</span>
<span class="nc" id="L887">            forceDesc.setUnitType((Integer)cbUnitType.getSelectedItem());</span>
<span class="nc" id="L888">            refreshFormations();</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">        } else if (ev.getSource() == cbFormation) {</span>
<span class="nc" id="L890">            String esch = (String)cbFormation.getSelectedItem();</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">            if (esch != null) {</span>
<span class="nc" id="L892">                setFormation(esch);</span>
            }
<span class="nc" id="L894">            refreshRatings();</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">        } else if (ev.getSource() == cbRating) {</span>
<span class="nc" id="L896">            forceDesc.setRating((String)cbRating.getSelectedItem());</span>
<span class="nc" id="L897">            refreshFlags();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">        } else if (ev.getSource() == cbExperience) {</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">            if (cbExperience.getSelectedIndex() == 0) {</span>
<span class="nc" id="L900">                forceDesc.setExperience(null);</span>
            } else {
<span class="nc" id="L902">                forceDesc.setExperience(cbExperience.getSelectedIndex() - 1);</span>
            }
<span class="nc" id="L904">            refreshFlags();</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">        } else if (ev.getSource() == cbFlags) {</span>
<span class="nc" id="L906">            forceDesc.getFlags().clear();</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">            if (cbFlags.getSelectedItem() != null) {</span>
<span class="nc" id="L908">                forceDesc.getFlags().add((String)cbFlags.getSelectedItem());</span>
            }
<span class="nc bnc" id="L910" title="All 2 branches missed.">        } else if (ev.getSource() == cbWeightClass) {</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">            if (cbWeightClass.getSelectedIndex() &lt; 1) {</span>
<span class="nc" id="L912">                forceDesc.setWeightClass(null);</span>
            } else {
<span class="nc" id="L914">                forceDesc.setWeightClass(cbWeightClass.getSelectedIndex());</span>
            }
<span class="nc bnc" id="L916" title="All 2 branches missed.">        } else if (ev.getSource() == btnGenerate) {</span>
<span class="nc" id="L917">            generateForce();</span>
<span class="nc" id="L918">            btnExportMUL.setEnabled(true);</span>
<span class="nc" id="L919">            btnClear.setEnabled(true);</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">        } else if (ev.getSource() == btnExportMUL) {</span>
<span class="nc" id="L921">            exportMUL(forceDesc);</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">        } else if (ev.getSource() == btnClear) {</span>
<span class="nc" id="L923">            clearForce();</span>
<span class="nc" id="L924">            btnExportMUL.setEnabled(false);</span>
<span class="nc" id="L925">            btnClear.setEnabled(false);</span>
        }
<span class="nc" id="L927">    }</span>

    void exportMUL(ForceDescriptor fd) {
<span class="nc" id="L930">        ArrayList&lt;Entity&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L931">        fd.addAllEntities(list);</span>
        //Create a fake game so we can write the entities to a file without adding them to the real game.
<span class="nc" id="L933">        Game game = new Game();</span>
        //Add a player to prevent complaining in the log file
<span class="nc" id="L935">        Player p = new Player(1, &quot;Observer&quot;);</span>
<span class="nc" id="L936">        game.addPlayer(1, p);</span>
<span class="nc" id="L937">        game.setOptions(clientGui.getClient().getGame().getOptions());</span>
<span class="nc" id="L938">        list.stream().forEach(en -&gt; {</span>
<span class="nc" id="L939">            en.setOwner(p);</span>
            // If we don't set the id, the first unit will be left at -1, which in most cases is interpreted
            // as no entity
<span class="nc" id="L942">            en.setId(game.getNextEntityId());</span>
<span class="nc" id="L943">            game.addEntity(en);</span>
<span class="nc" id="L944">        });</span>
<span class="nc" id="L945">        configureNetworks(fd);</span>
<span class="nc" id="L946">        clientGui.saveListFile(list, clientGui.getClient().getLocalPlayer().getName());</span>
<span class="nc" id="L947">    }</span>

    /**
     * Searches recursively for nodes that are flagged with C3 networks and configures them.
     * 
     * @param fd
     */
    private void configureNetworks(ForceDescriptor fd) {
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (fd.getFlags().contains(&quot;c3&quot;)) {</span>
<span class="nc" id="L956">            Entity master = fd.getSubforces().stream().map(ForceDescriptor::getEntity)</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                    .filter(en -&gt; (null != en)</span>
<span class="nc bnc" id="L958" title="All 4 branches missed.">                            &amp;&amp; (en.hasC3M() || en.hasC3MM()))</span>
<span class="nc" id="L959">                    .findFirst().orElse(null);</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">            if (null != master) {</span>
<span class="nc" id="L961">                int c3s = 0;</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">                for (ForceDescriptor sf : fd.getSubforces()) {</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">                    if ((null != sf.getEntity())</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">                            &amp;&amp; (sf.getEntity().getId() != master.getId())</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">                            &amp;&amp; sf.getEntity().hasC3S()) {</span>
<span class="nc" id="L966">                        sf.getEntity().setC3Master(master, false);</span>
<span class="nc" id="L967">                        c3s++;</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">                        if (c3s == 3) {</span>
<span class="nc" id="L969">                            break;</span>
                        }
                    }
<span class="nc" id="L972">                }</span>
            }
<span class="nc" id="L974">        } else {</span>
            // Even if we haven't reworked this into a full C3i network, we can still connect
            // any C3i units that happen to be present.
<span class="nc" id="L977">            Entity first = null;</span>
<span class="nc" id="L978">            int nodes = 0;</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">            for (ForceDescriptor sf : fd.getSubforces()) {</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">                if ((null != sf.getEntity())</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">                        &amp;&amp; sf.getEntity().hasC3i()) {</span>
<span class="nc" id="L982">                    sf.getEntity().setC3UUID();</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">                    if (null == first) {</span>
<span class="nc" id="L984">                        sf.getEntity().setC3NetIdSelf();</span>
<span class="nc" id="L985">                        first = sf.getEntity();</span>
<span class="nc" id="L986">                        nodes++;</span>
                    } else {
<span class="nc" id="L988">                        sf.getEntity().setC3NetId(first);</span>
<span class="nc" id="L989">                        nodes++;</span>
                    }
                }
<span class="nc bnc" id="L992" title="All 2 branches missed.">                if (nodes &gt;= Entity.MAX_C3i_NODES) {</span>
<span class="nc" id="L993">                    break;</span>
                }
<span class="nc" id="L995">            }</span>
        }
<span class="nc" id="L997">        fd.getSubforces().forEach(sf -&gt; configureNetworks(sf));</span>
<span class="nc" id="L998">        fd.getAttached().forEach(sf -&gt; configureNetworks(sf));</span>
<span class="nc" id="L999">    }</span>

    private void setFormation(String esch) {
<span class="nc" id="L1002">        forceDesc.setEschelon(Integer.parseInt(esch.replaceAll(&quot;[^0-9]&quot;, &quot;&quot;)));</span>
<span class="nc" id="L1003">        forceDesc.setAugmented(esch.contains(&quot;^&quot;));</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (esch.endsWith(&quot;+&quot;)) {</span>
<span class="nc" id="L1005">            forceDesc.setSizeMod(1);</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">        } else if (esch.endsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L1007">            forceDesc.setSizeMod(-1);</span>
        } else {
<span class="nc" id="L1009">            forceDesc.setSizeMod(0);</span>
        }
<span class="nc" id="L1011">    }		</span>

    public void setCurrentYear(int year) {
<span class="nc" id="L1014">        currentYear = year;</span>
<span class="nc" id="L1015">        yearUpdated();	    </span>
<span class="nc" id="L1016">    }</span>

    /**
     * Worker function that updates various things that need to be updated when the year is changed.
     */
    private void yearUpdated() {
<span class="nc" id="L1022">        txtYear.setText(String.valueOf(currentYear));</span>
<span class="nc" id="L1023">        RATGenerator.getInstance().loadYear(currentYear);</span>
<span class="nc" id="L1024">        forceDesc.setYear(currentYear);</span>
<span class="nc" id="L1025">        refreshFactions();</span>
<span class="nc" id="L1026">    }</span>

    @Override
    public void focusGained(FocusEvent arg0) {
        //Do nothing
<span class="nc" id="L1031">    }</span>

    @Override
    public void focusLost(FocusEvent arg0) {
        try {
<span class="nc" id="L1036">            currentYear = Integer.parseInt(txtYear.getText());</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">            if (currentYear &lt; RATGenerator.getInstance().getEraSet().first()) {</span>
<span class="nc" id="L1038">                currentYear = RATGenerator.getInstance().getEraSet().first();</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">            } else if (currentYear &gt; RATGenerator.getInstance().getEraSet().last()) {</span>
<span class="nc" id="L1040">                currentYear = RATGenerator.getInstance().getEraSet().last();</span>
            }
<span class="nc" id="L1042">        } catch (NumberFormatException ex) {</span>
            //ignore and restore to previous value
<span class="nc" id="L1044">        }</span>
<span class="nc" id="L1045">        yearUpdated();</span>
<span class="nc" id="L1046">    }</span>

    static class CBRenderer&lt;T&gt; extends DefaultListCellRenderer {

        private static final long serialVersionUID = 4895258839502183158L;

<span class="nc" id="L1052">        private String nullVal = Messages.getString(&quot;ForceGeneratorDialog.default&quot;);</span>
        private Function&lt;T,String&gt; toString;

        public CBRenderer(String nullVal) {
<span class="nc" id="L1056">            this(nullVal, null);</span>
<span class="nc" id="L1057">        }</span>

<span class="nc" id="L1059">        public CBRenderer(String nullVal, Function&lt;T,String&gt; strConverter) {</span>
<span class="nc" id="L1060">            this.nullVal = nullVal;</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">            if (strConverter == null) {</span>
<span class="nc" id="L1062">                toString = obj -&gt; obj.toString();</span>
            } else {
<span class="nc" id="L1064">                toString = strConverter;</span>
            }
<span class="nc" id="L1066">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public Component getListCellRendererComponent(JList&lt;? extends Object&gt; list, Object entry,
                int position, boolean arg3, boolean arg4) {
<span class="nc bnc" id="L1072" title="All 2 branches missed.">            if (entry == null) {</span>
<span class="nc" id="L1073">                setText(nullVal);</span>
            } else {
<span class="nc" id="L1075">                setText(toString.apply((T)entry));</span>
            }
<span class="nc" id="L1077">            return this;</span>
        }
    };

    static class ForceTreeModel implements TreeModel {

        private ForceDescriptor root;
        private ArrayList&lt;TreeModelListener&gt; listeners;

<span class="nc" id="L1086">        public ForceTreeModel(ForceDescriptor root) {</span>
<span class="nc" id="L1087">            this.root = root;</span>
<span class="nc" id="L1088">            listeners = new ArrayList&lt;TreeModelListener&gt;();		</span>
<span class="nc" id="L1089">        }</span>

        @Override
        public void addTreeModelListener(TreeModelListener listener) {
<span class="nc bnc" id="L1093" title="All 4 branches missed.">            if (null != listener &amp;&amp; !listeners.contains(listener)) {</span>
<span class="nc" id="L1094">                listeners.add(listener);</span>
            }
<span class="nc" id="L1096">        }</span>

        @Override
        public Object getChild(Object parent, int index) {
<span class="nc bnc" id="L1100" title="All 2 branches missed.">            if (parent instanceof ForceDescriptor) {</span>
<span class="nc" id="L1101">                return ((ForceDescriptor)parent).getAllChildren().get(index);</span>
            }
<span class="nc" id="L1103">            return null;</span>
        }

        @Override
        public int getChildCount(Object parent) {
<span class="nc bnc" id="L1108" title="All 2 branches missed.">            if (parent instanceof ForceDescriptor) {</span>
<span class="nc" id="L1109">                return ((ForceDescriptor)parent).getAllChildren().size();</span>
            }
<span class="nc" id="L1111">            return 0;</span>
        }

        @Override
        public int getIndexOfChild(Object parent, Object child) {
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            if (parent instanceof ForceDescriptor) {</span>
<span class="nc" id="L1117">                return ((ForceDescriptor)parent).getAllChildren().indexOf(child);</span>
            }
<span class="nc" id="L1119">            return 0;</span>
        }

        @Override
        public Object getRoot() {
<span class="nc" id="L1124">            return root;</span>
        }

        @Override
        public boolean isLeaf(Object node) {
<span class="nc bnc" id="L1129" title="All 4 branches missed.">            return ((ForceDescriptor)node).getEschelon() == 0</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">                    || (node instanceof ForceDescriptor &amp;&amp; getChildCount(node) == 0);</span>
        }

        @Override
        public void removeTreeModelListener(TreeModelListener listener) {
<span class="nc bnc" id="L1135" title="All 2 branches missed.">            if (null != listener) {</span>
<span class="nc" id="L1136">                listeners.remove(listener);</span>
            }
<span class="nc" id="L1138">        }</span>

        @Override
        public void valueForPathChanged(TreePath arg0, Object arg1) {
            // TODO Auto-generated method stub

<span class="nc" id="L1144">        }</span>

    }

    static class UnitRenderer extends DefaultTreeCellRenderer {
        private static final long serialVersionUID = -5915350078441133119L;

<span class="nc" id="L1151">        public UnitRenderer() {</span>

<span class="nc" id="L1153">        }</span>

        @Override
        public Component getTreeCellRendererComponent(JTree tree, Object value,
                boolean sel, boolean expanded, boolean leaf, int row, boolean hasFocus) {

<span class="nc" id="L1159">            super.getTreeCellRendererComponent(</span>
                    tree, value, sel,
                    expanded, leaf, row,
                    hasFocus);
<span class="nc" id="L1163">            setBackground(UIManager.getColor(&quot;Tree.textBackground&quot;));</span>
<span class="nc" id="L1164">            setForeground(UIManager.getColor(&quot;Tree.textForeground&quot;));</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if(sel) {</span>
<span class="nc" id="L1166">                setBackground(UIManager.getColor(&quot;Tree.selectionBackground&quot;));</span>
<span class="nc" id="L1167">                setForeground(UIManager.getColor(&quot;Tree.selectionForeground&quot;));</span>
            }

<span class="nc" id="L1170">            ForceDescriptor fd = (ForceDescriptor)value;</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">            if (fd.isElement()) {</span>
<span class="nc" id="L1172">                StringBuilder name = new StringBuilder();</span>
<span class="nc" id="L1173">                String uname = &quot;&quot;;</span>
<span class="nc bnc" id="L1174" title="All 2 branches missed.">                if (fd.getCo() == null) {</span>
<span class="nc" id="L1175">                    name.append(&quot;&lt;font color='red'&gt;&quot;)</span>
<span class="nc" id="L1176">                    .append(Messages.getString(&quot;ForceGeneratorDialog.noCrew&quot;))</span>
<span class="nc" id="L1177">                    .append(&quot;&lt;/font&gt;&quot;);</span>
                } else {
<span class="nc" id="L1179">                    name.append(fd.getCo().getName());</span>
<span class="nc" id="L1180">                    name.append(&quot; (&quot;).append(fd.getCo().getGunnery()).append(&quot;/&quot;).append(fd.getCo().getPiloting()).append(&quot;)&quot;);</span>
                }
<span class="nc" id="L1182">                uname = &quot;&lt;i&gt;&quot; + fd.getModelName() + &quot;&lt;/i&gt;&quot;;</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">                if (fd.getFluffName() != null) {</span>
<span class="nc" id="L1184">                    uname += &quot;&lt;br /&gt;&lt;i&gt;&quot; + fd.getFluffName() + &quot;&lt;/i&gt;&quot;;</span>
                }
<span class="nc" id="L1186">                setText(&quot;&lt;html&gt;&quot; + name.toString() + &quot;, &quot; + uname + &quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L1187">            } else {</span>
<span class="nc" id="L1188">                StringBuilder desc = new StringBuilder(&quot;&lt;html&gt;&quot;);</span>
<span class="nc" id="L1189">                desc.append(fd.parseName()).append(&quot;&lt;br /&gt;&quot;).append(fd.getDescription());</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">                if (fd.getCo() != null) {</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">                    desc.append(&quot;&lt;br /&gt;&quot;).append(fd.getCo().getTitle() == null?&quot;CO&quot;:fd.getCo().getTitle());</span>
<span class="nc" id="L1192">                    desc.append(fd.getCo().getName());</span>
                }
<span class="nc bnc" id="L1194" title="All 2 branches missed.">                if (fd.getXo() != null) {</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                    desc.append(&quot;&lt;br /&gt;&quot;).append(fd.getXo().getTitle() == null?&quot;XO&quot;:fd.getXo().getTitle());</span>
<span class="nc" id="L1196">                    desc.append(fd.getXo().getName());</span>
                }
<span class="nc" id="L1198">                setText(desc.append(&quot;&lt;/html&gt;&quot;).toString());</span>
            }
<span class="nc" id="L1200">            return this;</span>
        }
    }

    private class GenerateTask extends SwingWorker&lt;ForceDescriptor,Double&gt; implements Ruleset.ProgressListener {

        private ForceDescriptor fd;

<span class="nc" id="L1208">        private final Object progressLock = new Object();</span>
<span class="nc" id="L1209">        private double progress = 0;</span>
<span class="nc" id="L1210">        private String message = &quot;&quot;;</span>

<span class="nc" id="L1212">        GenerateTask(ForceDescriptor fd) {</span>
<span class="nc" id="L1213">            this.fd = fd;</span>
<span class="nc" id="L1214">        }</span>

        @Override
        protected ForceDescriptor doInBackground() throws Exception {
<span class="nc" id="L1218">            btnGenerate.setEnabled(false);</span>
<span class="nc" id="L1219">            Ruleset.findRuleset(fd).processRoot(fd, this);</span>
<span class="nc" id="L1220">            return fd;</span>
        }

        @Override
        protected void done() {
            try {
<span class="nc" id="L1226">                forceDesc = get();</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">                if (onGenerate != null) {</span>
<span class="nc" id="L1228">                    onGenerate.accept(forceDesc);</span>
                }
<span class="nc" id="L1230">            } catch (InterruptedException ex) {</span>
                //Ignore
<span class="nc" id="L1232">            } catch (ExecutionException e) {</span>
<span class="nc" id="L1233">                e.getCause().printStackTrace();</span>
            } finally {
<span class="nc" id="L1235">                btnGenerate.setEnabled(true);</span>
            }
<span class="nc" id="L1237">        }</span>

        @Override
        public void updateProgress(double progress, String message) {
            int progressPercent;
<span class="nc" id="L1242">            synchronized (progressLock) {</span>
<span class="nc" id="L1243">                this.progress += progress;</span>
<span class="nc" id="L1244">                this.message = message;</span>

<span class="nc" id="L1246">                progressPercent = Math.min((int)Math.round(this.progress * 100.0), 100);</span>
<span class="nc" id="L1247">            }</span>

<span class="nc" id="L1249">            setProgress(progressPercent);</span>
<span class="nc" id="L1250">        }</span>

        public String getMessage() {
<span class="nc" id="L1253">            synchronized (progressLock) {</span>
<span class="nc" id="L1254">                return message;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>