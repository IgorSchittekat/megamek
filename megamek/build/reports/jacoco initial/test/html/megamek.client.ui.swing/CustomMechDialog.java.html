<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomMechDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">CustomMechDialog.java</span></div><h1>CustomMechDialog.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000,2001,2002,2003,2004 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

/*
 * CustomMechDialog.java
 *
 * Created on March 18, 2002, 2:56 PM
 */

package megamek.client.ui.swing;

import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.List;
import java.util.TreeSet;

import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTabbedPane;
import javax.swing.JTextField;
import javax.swing.SwingConstants;

import megamek.client.Client;
import megamek.client.ui.GBC;
import megamek.client.ui.Messages;
import megamek.common.Aero;
import megamek.common.BattleArmor;
import megamek.common.Board;
import megamek.common.Configuration;
import megamek.common.Crew;
import megamek.common.Dropship;
import megamek.common.Entity;
import megamek.common.EntityMovementMode;
import megamek.common.EquipmentType;
import megamek.common.GunEmplacement;
import megamek.common.IAero;
import megamek.common.IGame;
import megamek.common.IPlayer;
import megamek.common.Infantry;
import megamek.common.Jumpship;
import megamek.common.LAMPilot;
import megamek.common.LandAirMech;
import megamek.common.Mech;
import megamek.common.MiscType;
import megamek.common.Mounted;
import megamek.common.OffBoardDirection;
import megamek.common.Protomech;
import megamek.common.QuadVee;
import megamek.common.SmallCraft;
import megamek.common.Tank;
import megamek.common.TechConstants;
import megamek.common.WeaponType;
import megamek.common.enums.Gender;
import megamek.common.options.IOption;
import megamek.common.options.IOptionGroup;
import megamek.common.options.OptionsConstants;
import megamek.common.options.PartialRepairs;
import megamek.common.options.PilotOptions;
import megamek.common.options.Quirks;
import megamek.common.options.WeaponQuirks;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.verifier.EntityVerifier;
import megamek.common.verifier.TestAero;
import megamek.common.verifier.TestBattleArmor;
import megamek.common.verifier.TestEntity;
import megamek.common.verifier.TestInfantry;
import megamek.common.verifier.TestMech;
import megamek.common.verifier.TestSupportVehicle;
import megamek.common.verifier.TestTank;
import megamek.common.weapons.bayweapons.ArtilleryBayWeapon;
import megamek.common.weapons.bayweapons.CapitalMissileBayWeapon;

/**
 * A dialog that a player can use to customize his mech before battle.
 * Currently, changing pilots, setting up C3 networks, changing ammunition,
 * deploying artillery offboard, setting MGs to rapidfire, setting auto-eject is
 * supported.
 *
 * @author Ben
 */
public class CustomMechDialog extends ClientDialog implements ActionListener,
        DialogOptionListener, ItemListener {

    /**
     *
     */
    private static final long serialVersionUID = -6809436986445582731L;

<span class="nc" id="L117">    public static int DONE = 0;</span>
<span class="nc" id="L118">    public static int NEXT = 1;</span>
<span class="nc" id="L119">    public static int PREV = 2;</span>

    private CustomPilotView[] panCrewMember;
    private JPanel panDeploy;
    private QuirksPanel panQuirks;
    private JPanel panPartReps;

    private JPanel panOptions;
    // private JScrollPane scrOptions;

    private JTabbedPane tabAll;

<span class="nc" id="L131">    private final JTextField fldFatigue = new JTextField(3);</span>
<span class="nc" id="L132">    private JTextField fldInit = new JTextField(3);</span>
<span class="nc" id="L133">    private JTextField fldCommandInit = new JTextField(3);</span>
<span class="nc" id="L134">    private JCheckBox chCommander = new JCheckBox();</span>

<span class="nc" id="L136">    private JLabel labDeploymentRound = new JLabel(</span>
<span class="nc" id="L137">            Messages.getString(&quot;CustomMechDialog.labDeployment&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L139">    private JLabel labDeploymentZone = new JLabel(</span>
<span class="nc" id="L140">            Messages.getString(&quot;CustomMechDialog.labDeploymentZone&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L142">    private JComboBox&lt;String&gt; choDeploymentRound = new JComboBox&lt;String&gt;();</span>
    
<span class="nc" id="L144">    private JComboBox&lt;String&gt; choDeploymentZone = new JComboBox&lt;String&gt;();</span>

<span class="nc" id="L146">    private JLabel labDeployShutdown = new JLabel(</span>
<span class="nc" id="L147">            Messages.getString(&quot;CustomMechDialog.labDeployShutdown&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L149">    private JCheckBox chDeployShutdown = new JCheckBox();</span>

<span class="nc" id="L151">    private JLabel labDeployProne = new JLabel(</span>
<span class="nc" id="L152">            Messages.getString(&quot;CustomMechDialog.labDeployProne&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L154">    private JCheckBox chDeployProne = new JCheckBox();</span>

<span class="nc" id="L156">    private JLabel labDeployHullDown = new JLabel(</span>
<span class="nc" id="L157">            Messages.getString(&quot;CustomMechDialog.labDeployHullDown&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L159">    private JCheckBox chDeployHullDown = new JCheckBox();</span>

<span class="nc" id="L161">    private JLabel labHidden = new JLabel(</span>
<span class="nc" id="L162">            Messages.getString(&quot;CustomMechDialog.labHidden&quot;), //$NON-NLS-1$</span>
            SwingConstants.RIGHT);

<span class="nc" id="L165">    private JCheckBox chHidden = new JCheckBox();</span>

<span class="nc" id="L167">    private JLabel labOffBoard = new JLabel(</span>
<span class="nc" id="L168">            Messages.getString(&quot;CustomMechDialog.labOffBoard&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L170">    private JCheckBox chOffBoard = new JCheckBox();</span>

<span class="nc" id="L172">    private JLabel labOffBoardDirection = new JLabel(</span>
<span class="nc" id="L173">            Messages.getString(&quot;CustomMechDialog.labOffBoardDirection&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L175">    private JComboBox&lt;String&gt; choOffBoardDirection = new JComboBox&lt;String&gt;();</span>

<span class="nc" id="L177">    private JLabel labOffBoardDistance = new JLabel(</span>
<span class="nc" id="L178">            Messages.getString(&quot;CustomMechDialog.labOffBoardDistance&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L180">    private JTextField fldOffBoardDistance = new JTextField(4);</span>

<span class="nc" id="L182">    private JButton butOffBoardDistance = new JButton(&quot;0&quot;);</span>
    
<span class="nc" id="L184">    private JLabel labStartingMode = new JLabel(</span>
<span class="nc" id="L185">            Messages.getString(&quot;CustomMechDialog.labStartingMode&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>
    
<span class="nc" id="L187">    private JComboBox&lt;String&gt; choStartingMode = new JComboBox&lt;&gt;();</span>
       
<span class="nc" id="L189">    private JLabel labCurrentFuel = new JLabel(</span>
<span class="nc" id="L190">            Messages.getString(&quot;CustomMechDialog.labCurrentFuel&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>
    
<span class="nc" id="L192">    private JTextField fldCurrentFuel = new JTextField(7);</span>

<span class="nc" id="L194">    private JLabel labStartVelocity = new JLabel(</span>
<span class="nc" id="L195">            Messages.getString(&quot;CustomMechDialog.labStartVelocity&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L197">    private JTextField fldStartVelocity = new JTextField(3);</span>

<span class="nc" id="L199">    private JLabel labStartAltitude = new JLabel(</span>
<span class="nc" id="L200">            Messages.getString(&quot;CustomMechDialog.labStartAltitude&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L202">    private JTextField fldStartAltitude = new JTextField(3);</span>

<span class="nc" id="L204">    private JLabel labStartHeight = new JLabel(</span>
<span class="nc" id="L205">            Messages.getString(&quot;CustomMechDialog.labStartHeight&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>

<span class="nc" id="L207">    private JTextField fldStartHeight = new JTextField(3);</span>
    
<span class="nc" id="L209">    private JCheckBox chDeployAirborne = new JCheckBox();</span>

<span class="nc" id="L211">    private JPanel panButtons = new JPanel();</span>

<span class="nc" id="L213">    private JButton butOkay = new JButton(Messages.getString(&quot;Okay&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L215">    private JButton butCancel = new JButton(Messages.getString(&quot;Cancel&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L217">    private JButton butNext = new JButton(Messages.getString(&quot;Next&quot;));</span>

<span class="nc" id="L219">    private JButton butPrev = new JButton(Messages.getString(&quot;Previous&quot;));</span>

    private EquipChoicePanel m_equip;

<span class="nc" id="L223">    private JPanel panEquip = new JPanel();</span>

    private List&lt;Entity&gt; entities;

    private boolean okay;

<span class="nc" id="L229">    private int status = CustomMechDialog.DONE;</span>

    ClientGUI clientgui;

    Client client;

    private PilotOptions options;
    private Quirks quirks;
    private PartialRepairs partReps;
<span class="nc" id="L238">    private HashMap&lt;Integer, WeaponQuirks&gt; h_wpnQuirks = new HashMap&lt;Integer, WeaponQuirks&gt;();</span>

<span class="nc" id="L240">    private ArrayList&lt;DialogOptionComponent&gt; optionComps = new ArrayList&lt;DialogOptionComponent&gt;();</span>
    // private ArrayList&lt;DialogOptionComponent&gt; quirkComps = new
    // ArrayList&lt;DialogOptionComponent&gt;();
<span class="nc" id="L243">    private ArrayList&lt;DialogOptionComponent&gt; partRepsComps = new ArrayList&lt;DialogOptionComponent&gt;();</span>
    // private HashMap&lt;Integer, ArrayList&lt;DialogOptionComponent&gt;&gt;
    // h_wpnQuirkComps = new HashMap&lt;Integer,
    // ArrayList&lt;DialogOptionComponent&gt;&gt;();

    private boolean editable;

<span class="nc" id="L250">    private OffBoardDirection direction = OffBoardDirection.NONE;</span>

<span class="nc" id="L252">    private int distance = 17;</span>
    
<span class="nc" id="L254">    private int fuel = 0;</span>

    /**
     * Creates new CustomMechDialog
     */
    public CustomMechDialog(ClientGUI clientgui, Client client, List&lt;Entity&gt; entities,
            boolean editable) {
<span class="nc" id="L261">        super(clientgui.frame,</span>
<span class="nc" id="L262">                Messages.getString(&quot;CustomMechDialog.title&quot;), true); //$NON-NLS-1$</span>

<span class="nc" id="L264">        this.entities = entities;</span>
<span class="nc" id="L265">        this.clientgui = clientgui;</span>
<span class="nc" id="L266">        this.client = client;</span>

        // Ensure we have at least one passed entity
        //  Anything less makes no sense
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (entities.size() &lt; 1) {</span>
<span class="nc" id="L271">            throw new IllegalStateException(&quot;Must pass at least one Entity!&quot;);</span>
        }

<span class="nc bnc" id="L274" title="All 2 branches missed.">        boolean multipleEntities = entities.size() &gt; 1;</span>
<span class="nc" id="L275">        boolean quirksEnabled = clientgui.getClient().getGame().getOptions()</span>
<span class="nc" id="L276">                .booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS);</span>
<span class="nc" id="L277">        boolean partialRepairsEnabled = clientgui.getClient().getGame()</span>
<span class="nc" id="L278">                .getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_PARTIALREPAIRS);</span>
<span class="nc" id="L279">        final Entity entity = entities.get(0);</span>
<span class="nc" id="L280">        boolean isAero = true;</span>
<span class="nc" id="L281">        boolean isMech = true;</span>
<span class="nc" id="L282">        boolean isShip = true;</span>
<span class="nc" id="L283">        boolean isVTOL = true;</span>
<span class="nc" id="L284">        boolean isWiGE = true;</span>
<span class="nc" id="L285">        boolean isQuadVee = true;</span>
<span class="nc" id="L286">        boolean isLAM = true;</span>
<span class="nc" id="L287">        boolean isGlider = true;</span>
<span class="nc" id="L288">        boolean eligibleForOffBoard = true;</span>
        
<span class="nc bnc" id="L290" title="All 2 branches missed.">        for (Entity e : entities) {</span>
<span class="nc bnc" id="L291" title="All 6 branches missed.">            isAero &amp;= (e instanceof Aero) &amp;&amp; !((e instanceof SmallCraft) || (e instanceof Jumpship));</span>
<span class="nc" id="L292">            isMech &amp;= (e instanceof Mech);</span>
<span class="nc bnc" id="L293" title="All 4 branches missed.">            isShip &amp;= (e instanceof SmallCraft) || (e instanceof Jumpship);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            isVTOL &amp;= (e.getMovementMode() == EntityMovementMode.VTOL);</span>
<span class="nc bnc" id="L295" title="All 4 branches missed.">            isWiGE &amp;= (e instanceof Tank) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc" id="L296">            isQuadVee &amp;= (e instanceof QuadVee);</span>
<span class="nc" id="L297">            isLAM &amp;= (e instanceof LandAirMech);</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">            isGlider &amp;= (e instanceof Protomech) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc" id="L299">            boolean entityEligibleForOffBoard = false;</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            boolean space = clientgui.getClient().getMapSettings().getMedium() == Board.T_SPACE;</span>
            //TODO: This check is good for now, but at some point we want atmospheric flying droppers to be able to lob
            // offboard missiles and we could use it in space for extreme range bearings-only fights, plus Ortillery. 
<span class="nc bnc" id="L303" title="All 4 branches missed.">            if (!space &amp;&amp; e.getAltitude() == 0) {</span>
                // No need to bother checking weapons if the map and entity don't meet criteria for offboard units
<span class="nc bnc" id="L305" title="All 2 branches missed.">                for (Mounted mounted : e.getWeaponList()) {</span>
<span class="nc" id="L306">                    WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L307" title="All 4 branches missed.">                    if (wtype.hasFlag(WeaponType.F_ARTILLERY)</span>
                            || wtype instanceof CapitalMissileBayWeapon) {
<span class="nc" id="L309">                        entityEligibleForOffBoard = true;</span>
<span class="nc" id="L310">                        break;</span>
                    }
<span class="nc" id="L312">                }</span>
            }
<span class="nc" id="L314">            eligibleForOffBoard &amp;= entityEligibleForOffBoard;</span>
<span class="nc" id="L315">        }</span>

        // set up the panels
<span class="nc" id="L318">        JPanel mainPanel = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L319">        tabAll = new JTabbedPane();</span>
        
<span class="nc" id="L321">        JPanel panCrew = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L322">        panCrewMember = new CustomPilotView[entity.getCrew().getSlotCount()];</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        for (int i = 0; i &lt; panCrewMember.length; i++) {</span>
<span class="nc" id="L324">            panCrewMember[i] = new CustomPilotView(this, entity, i, editable);</span>
        }
<span class="nc" id="L326">        panDeploy = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L327">        quirks = entity.getQuirks();</span>
<span class="nc" id="L328">        panQuirks = new QuirksPanel(entity, quirks, editable, this, h_wpnQuirks);</span>
<span class="nc" id="L329">        panPartReps = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L330">        setupEquip();</span>
        
<span class="nc" id="L332">        mainPanel.add(tabAll,</span>
<span class="nc" id="L333">                GBC.eol().fill(GridBagConstraints.BOTH).insets(5, 5, 5, 5));</span>
<span class="nc" id="L334">        mainPanel.add(panButtons, GBC.eol().anchor(GridBagConstraints.CENTER));</span>

<span class="nc" id="L336">        JScrollPane scrEquip = new JScrollPane(panEquip);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (!multipleEntities) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (panCrewMember.length &gt; 1) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                for (int i = 0; i &lt; panCrewMember.length; i++) {</span>
<span class="nc" id="L340">                    tabAll.addTab(entity.getCrew().getCrewType().getRoleName(i),</span>
                            new JScrollPane(panCrewMember[i]));
                }
<span class="nc" id="L343">                tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabCrew&quot;), new JScrollPane(panCrew));</span>
            } else {
<span class="nc" id="L345">                panCrew.add(panCrewMember[0], GBC.eop());</span>
<span class="nc" id="L346">                tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabPilot&quot;), new JScrollPane(panCrew));</span>
            }
<span class="nc" id="L348">            tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabEquipment&quot;),</span>
                    scrEquip);
        }
<span class="nc" id="L351">        tabAll.addTab(Messages.getString(&quot;CustomMechDialog.tabDeployment&quot;),</span>
                new JScrollPane(panDeploy));
<span class="nc bnc" id="L353" title="All 4 branches missed.">        if (quirksEnabled &amp;&amp; !multipleEntities) {</span>
<span class="nc" id="L354">            JScrollPane scrQuirks = new JScrollPane(panQuirks);</span>
<span class="nc" id="L355">            scrQuirks.setPreferredSize(scrEquip.getPreferredSize());</span>
<span class="nc" id="L356">            tabAll.addTab(&quot;Quirks&quot;, scrQuirks);</span>
        }
<span class="nc bnc" id="L358" title="All 4 branches missed.">        if (partialRepairsEnabled &amp;&amp; !multipleEntities) {</span>
<span class="nc" id="L359">            tabAll.addTab(</span>
<span class="nc" id="L360">                    Messages.getString(&quot;CustomMechDialog.tabPartialRepairs&quot;),</span>
                    new JScrollPane(panPartReps));
        }
<span class="nc" id="L363">        getContentPane().add(mainPanel);</span>

<span class="nc" id="L365">        options = entity.getCrew().getOptions();</span>
<span class="nc" id="L366">        partReps = entity.getPartialRepairs();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        for (Mounted m : entity.getWeaponList()) {</span>
<span class="nc" id="L368">            h_wpnQuirks.put(entity.getEquipmentNum(m), m.getQuirks());</span>
<span class="nc" id="L369">        }</span>
        // Also need to consider melee weapons
<span class="nc bnc" id="L371" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_CLUB)) {</span>
<span class="nc" id="L373">                h_wpnQuirks.put(entity.getEquipmentNum(m), m.getQuirks());</span>
            }
<span class="nc" id="L375">        }</span>
<span class="nc" id="L376">        this.editable = editable;</span>
        
        // **CREW TAB**//
<span class="nc bnc" id="L379" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FATIGUE)) {</span>
<span class="nc" id="L380">            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labFatigue&quot;), SwingConstants.RIGHT),</span>
<span class="nc" id="L381">                    GBC.std()); //$NON-NLS-1$</span>
<span class="nc" id="L382">            panCrew.add(fldFatigue, GBC.eop());</span>
<span class="nc" id="L383">            fldFatigue.setToolTipText(Messages.getString(&quot;CustomMechDialog.labFatigueToolTip&quot;));</span>
        }
<span class="nc" id="L385">        fldFatigue.setText(Integer.toString(entity.getCrew().getFatigue()));</span>

<span class="nc" id="L387">        if (clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                .booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L389">            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labInit&quot;), SwingConstants.RIGHT),</span>
<span class="nc" id="L390">                    GBC.std()); //$NON-NLS-1$</span>
<span class="nc" id="L391">            panCrew.add(fldInit, GBC.eop());</span>
        }
<span class="nc" id="L393">        fldInit.setText(Integer.toString(entity.getCrew().getInitBonus()));</span>

<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_COMMAND_INIT)) {</span>
<span class="nc" id="L396">            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labCommandInit&quot;), SwingConstants.RIGHT),</span>
<span class="nc" id="L397">                    GBC.std()); //$NON-NLS-1$</span>
<span class="nc" id="L398">            panCrew.add(fldCommandInit, GBC.eop());</span>
        }
<span class="nc" id="L400">        fldCommandInit.setText(Integer.toString(entity.getCrew()</span>
<span class="nc" id="L401">                .getCommandBonus()));</span>

        // Set up commanders for commander killed victory condition
<span class="nc" id="L404">        if (clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                .booleanOption(OptionsConstants.VICTORY_COMMANDER_KILLED)) { //$NON-NLS-1$</span>
<span class="nc" id="L406">            panCrew.add(new JLabel(Messages.getString(&quot;CustomMechDialog.labCommander&quot;), SwingConstants.RIGHT),</span>
<span class="nc" id="L407">                    GBC.std()); //$NON-NLS-1$</span>
<span class="nc" id="L408">            panCrew.add(chCommander, GBC.eol());</span>
<span class="nc" id="L409">            chCommander.setSelected(entity.isCommander());</span>
        }
<span class="nc" id="L411">        panOptions = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L412">        panCrew.add(panOptions, GBC.eop());</span>

        // **DEPLOYMENT TAB**//
        
<span class="nc bnc" id="L416" title="All 4 branches missed.">        if (isQuadVee || isLAM) {</span>
<span class="nc" id="L417">            panDeploy.add(labStartingMode, GBC.std());</span>
<span class="nc" id="L418">            panDeploy.add(choStartingMode, GBC.eol());</span>
<span class="nc" id="L419">            choStartingMode.addItemListener(this);</span>
<span class="nc" id="L420">            labStartingMode.setToolTipText(Messages</span>
<span class="nc" id="L421">                    .getString(&quot;CustomMechDialog.startingModeToolTip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L422">            choStartingMode.setToolTipText(Messages</span>
<span class="nc" id="L423">                    .getString(&quot;CustomMechDialog.startingModeToolTip&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L424">            refreshDeployment();</span>
            // Disable conversions for loaded units so we don't get fighter LAMs in mech bays and vice-versa
<span class="nc bnc" id="L426" title="All 2 branches missed.">            choStartingMode.setEnabled(entities.get(0).getTransportId() == Entity.NONE);</span>
        }
<span class="nc bnc" id="L428" title="All 6 branches missed.">        if (isVTOL || isLAM || isGlider) {</span>
<span class="nc" id="L429">            panDeploy.add(labStartHeight, GBC.std());</span>
<span class="nc" id="L430">            panDeploy.add(fldStartHeight, GBC.eol());</span>
        }
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (isWiGE) {</span>
<span class="nc" id="L433">            panDeploy.add(new JLabel(Messages.getString(</span>
<span class="nc" id="L434">                    &quot;CustomMechDialog.labDeployAirborne&quot;), SwingConstants.RIGHT), GBC.std()); //$NON-NLS-1$</span>
<span class="nc" id="L435">            panDeploy.add(chDeployAirborne, GBC.eol());</span>
        }
<span class="nc bnc" id="L437" title="All 6 branches missed.">        if (isAero || isLAM || isShip) {</span>
<span class="nc" id="L438">            panDeploy.add(labStartVelocity, GBC.std());</span>
<span class="nc" id="L439">            panDeploy.add(fldStartVelocity, GBC.eol());</span>

<span class="nc" id="L441">            panDeploy.add(labStartAltitude, GBC.std());</span>
<span class="nc" id="L442">            panDeploy.add(fldStartAltitude, GBC.eol());</span>
                        
<span class="nc" id="L444">            panDeploy.add(labCurrentFuel, GBC.std());</span>
<span class="nc" id="L445">            panDeploy.add(fldCurrentFuel, GBC.eol());</span>
        }

<span class="nc" id="L448">        choDeploymentRound.addItemListener(this);</span>

<span class="nc" id="L450">        panDeploy.add(labDeploymentRound, GBC.std());</span>
<span class="nc" id="L451">        panDeploy.add(choDeploymentRound, GBC.eol());</span>
<span class="nc" id="L452">        panDeploy.add(labDeploymentZone, GBC.std());</span>
<span class="nc" id="L453">        panDeploy.add(choDeploymentZone, GBC.eol());</span>
<span class="nc" id="L454">        if (clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L455" title="All 6 branches missed.">                .booleanOption(OptionsConstants.RPG_BEGIN_SHUTDOWN)</span>
                &amp;&amp; !(entity instanceof Infantry)
                &amp;&amp; !(entity instanceof GunEmplacement)) {
<span class="nc" id="L458">            panDeploy.add(labDeployShutdown, GBC.std());</span>
<span class="nc" id="L459">            panDeploy.add(chDeployShutdown, GBC.eol());</span>
<span class="nc" id="L460">            chDeployShutdown.setSelected(entity.isManualShutdown());</span>
        }

<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (isMech) {</span>
<span class="nc" id="L464">            panDeploy.add(labDeployHullDown, GBC.std());</span>
<span class="nc" id="L465">            panDeploy.add(chDeployHullDown, GBC.eol());</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            chDeployHullDown.setSelected(entity.isHullDown()</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                    &amp;&amp; !entity.isProne());</span>
<span class="nc" id="L468">            chDeployHullDown.addItemListener(this);</span>

<span class="nc" id="L470">            panDeploy.add(labDeployProne, GBC.std());</span>
<span class="nc" id="L471">            panDeploy.add(chDeployProne, GBC.eol());</span>
<span class="nc bnc" id="L472" title="All 4 branches missed.">            chDeployProne.setSelected(entity.isProne() &amp;&amp; !entity.isHullDown());</span>
<span class="nc" id="L473">            chDeployProne.addItemListener(this);</span>
        }

<span class="nc" id="L476">        refreshDeployment();</span>

<span class="nc" id="L478">        if (clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc" id="L480">            panDeploy.add(labHidden, GBC.std());</span>
<span class="nc" id="L481">            panDeploy.add(chHidden, GBC.eol());</span>
<span class="nc" id="L482">            chHidden.setSelected(entity.isHidden());</span>
        }
        
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (eligibleForOffBoard) {</span>
<span class="nc" id="L486">            panDeploy.add(labOffBoard, GBC.std());</span>
<span class="nc" id="L487">            panDeploy.add(chOffBoard, GBC.eol());</span>
<span class="nc" id="L488">            chOffBoard.setSelected(entity.isOffBoard());</span>

<span class="nc" id="L490">            panDeploy.add(labOffBoardDirection, GBC.std());</span>

<span class="nc" id="L492">            choOffBoardDirection.addItem(Messages</span>
<span class="nc" id="L493">                    .getString(&quot;CustomMechDialog.North&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L494">            choOffBoardDirection.addItem(Messages</span>
<span class="nc" id="L495">                    .getString(&quot;CustomMechDialog.South&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L496">            choOffBoardDirection.addItem(Messages</span>
<span class="nc" id="L497">                    .getString(&quot;CustomMechDialog.East&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L498">            choOffBoardDirection.addItem(Messages</span>
<span class="nc" id="L499">                    .getString(&quot;CustomMechDialog.West&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L500">            direction = entity.getOffBoardDirection();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">            if (OffBoardDirection.NONE == direction) {</span>
<span class="nc" id="L502">                direction = OffBoardDirection.NORTH;</span>
            }
<span class="nc" id="L504">            choOffBoardDirection.setSelectedIndex(direction.getValue());</span>
<span class="nc" id="L505">            panDeploy.add(choOffBoardDirection, GBC.eol());</span>

<span class="nc" id="L507">            panDeploy.add(labOffBoardDistance, GBC.std());</span>

<span class="nc" id="L509">            butOffBoardDistance.addActionListener(this);</span>
<span class="nc" id="L510">            butOffBoardDistance.setText(Integer.toString(distance));</span>
<span class="nc" id="L511">            panDeploy.add(butOffBoardDistance, GBC.eol());</span>
        }

<span class="nc" id="L514">        setupButtons();</span>

<span class="nc bnc" id="L516" title="All 6 branches missed.">        if (isAero || isLAM || isShip) {</span>
<span class="nc" id="L517">            IAero a = (IAero) entity;</span>
<span class="nc" id="L518">            fldStartVelocity.setText(Integer.valueOf(a.getCurrentVelocity())</span>
<span class="nc" id="L519">                    .toString());</span>
<span class="nc" id="L520">            fldStartVelocity.addActionListener(this);</span>

<span class="nc" id="L522">            fldStartAltitude.setText(Integer.valueOf(entity.getAltitude()).toString());</span>
<span class="nc" id="L523">            fldStartAltitude.addActionListener(this);</span>
            
<span class="nc" id="L525">            fuel = a.getFuel();</span>
<span class="nc" id="L526">            fldCurrentFuel.setText(Integer.valueOf(a.getCurrentFuel())</span>
<span class="nc" id="L527">                    .toString());</span>
<span class="nc" id="L528">            fldCurrentFuel.addActionListener(this);</span>
        }

<span class="nc bnc" id="L531" title="All 6 branches missed.">        if (isVTOL || isLAM || isGlider) {</span>
<span class="nc" id="L532">            fldStartHeight.setText(Integer.valueOf(entity.getElevation()).toString());</span>
<span class="nc" id="L533">            fldStartHeight.addActionListener(this);</span>
        }
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (isWiGE) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">            chDeployAirborne.setSelected(entity.getElevation() &gt; 0);</span>
        }

<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (!editable) {</span>
<span class="nc" id="L540">            fldFatigue.setEnabled(false);</span>
<span class="nc" id="L541">            fldInit.setEnabled(false);</span>
<span class="nc" id="L542">            fldCommandInit.setEnabled(false);</span>
<span class="nc" id="L543">            chCommander.setEnabled(false);</span>
<span class="nc" id="L544">            choDeploymentRound.setEnabled(false);</span>
<span class="nc" id="L545">            chDeployShutdown.setEnabled(false);</span>
<span class="nc" id="L546">            chDeployProne.setEnabled(false);</span>
<span class="nc" id="L547">            chDeployHullDown.setEnabled(false);</span>
<span class="nc" id="L548">            chCommander.setEnabled(false);</span>
<span class="nc" id="L549">            chHidden.setEnabled(false);</span>
<span class="nc" id="L550">            chOffBoard.setEnabled(false);</span>
<span class="nc" id="L551">            choOffBoardDirection.setEnabled(false);</span>
<span class="nc" id="L552">            fldOffBoardDistance.setEnabled(false);</span>
<span class="nc" id="L553">            fldStartVelocity.setEnabled(false);</span>
<span class="nc" id="L554">            fldStartAltitude.setEnabled(false);</span>
<span class="nc" id="L555">            fldCurrentFuel.setEnabled(false);</span>
<span class="nc" id="L556">            fldStartHeight.setEnabled(false);</span>
<span class="nc" id="L557">            chDeployAirborne.setEnabled(false);</span>
<span class="nc" id="L558">            m_equip.initialize();</span>
        }

<span class="nc" id="L561">        addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L564">                setVisible(false);</span>
<span class="nc" id="L565">            }</span>
        });

<span class="nc" id="L568">        pack();</span>
<span class="nc" id="L569">        mainPanel.setSize(mainPanel.getSize().width,</span>
<span class="nc" id="L570">                Math.min(mainPanel.getSize().height, 400));</span>
<span class="nc" id="L571">        setResizable(true);</span>
<span class="nc" id="L572">        setLocationRelativeTo(clientgui);</span>
<span class="nc" id="L573">    }</span>

    public String getSelectedTab() {
<span class="nc" id="L576">        return tabAll.getTitleAt(tabAll.getSelectedIndex());</span>
    }

    public void setSelectedTab(int idx) {
<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (idx &lt; tabAll.getTabCount()) {</span>
<span class="nc" id="L581">            tabAll.setSelectedIndex(idx);</span>
        }
<span class="nc" id="L583">    }</span>
    
    public void setSelectedTab(String tabName) {
<span class="nc bnc" id="L586" title="All 2 branches missed.">        for (int i = 0; i &lt; tabAll.getTabCount(); i++) {</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">            if (tabAll.getTitleAt(i).equals(tabName)) {</span>
<span class="nc" id="L588">                tabAll.setSelectedIndex(i);</span>
            }
        }
<span class="nc" id="L591">    }</span>

    public ClientGUI getClientGUI() {
<span class="nc" id="L594">        return clientgui;</span>
    }

    private void setupButtons() {
<span class="nc" id="L598">        butOkay.addActionListener(this);</span>
<span class="nc" id="L599">        butCancel.addActionListener(this);</span>
<span class="nc" id="L600">        butNext.addActionListener(this);</span>
<span class="nc" id="L601">        butPrev.addActionListener(this);</span>

        // layout
<span class="nc" id="L604">        panButtons.setLayout(new GridLayout(1, 4, 10, 0));</span>
<span class="nc" id="L605">        panButtons.add(butPrev);</span>
<span class="nc" id="L606">        panButtons.add(butOkay);</span>
<span class="nc" id="L607">        panButtons.add(butCancel);</span>
<span class="nc" id="L608">        panButtons.add(butNext);</span>

<span class="nc bnc" id="L610" title="All 2 branches missed.">        butNext.setEnabled(getNextEntity(true) != null);</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        butPrev.setEnabled(getNextEntity(false) != null);</span>
<span class="nc" id="L612">    }</span>

    private void setOptions() {
<span class="nc" id="L615">        Entity entity = entities.get(0);</span>
        IOption option;
<span class="nc bnc" id="L617" title="All 2 branches missed.">        for (final Object newVar : optionComps) {</span>
<span class="nc" id="L618">            DialogOptionComponent comp = (DialogOptionComponent) newVar;</span>
<span class="nc" id="L619">            option = comp.getOption();</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">            if ((comp.getValue() == Messages.getString(&quot;CustomMechDialog.None&quot;))) { // NON-NLS-$1</span>
<span class="nc" id="L621">                entity.getCrew().getOptions().getOption(option.getName())</span>
<span class="nc" id="L622">                        .setValue(&quot;None&quot;); // NON-NLS-$1</span>
            } else {
<span class="nc" id="L624">                entity.getCrew().getOptions().getOption(option.getName())</span>
<span class="nc" id="L625">                        .setValue(comp.getValue());</span>
            }
<span class="nc" id="L627">        }</span>
<span class="nc" id="L628">    }</span>

    public void refreshOptions() {
<span class="nc" id="L631">        panOptions.removeAll();</span>
<span class="nc" id="L632">        optionComps = new ArrayList&lt;DialogOptionComponent&gt;();</span>

<span class="nc" id="L634">        GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L635">        GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L636">        panOptions.setLayout(gridbag);</span>

<span class="nc" id="L638">        c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L639">        c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L640">        c.insets = new Insets(0, 0, 0, 0);</span>
<span class="nc" id="L641">        c.ipadx = 0;</span>
<span class="nc" id="L642">        c.ipady = 0;</span>

<span class="nc" id="L644">        for (Enumeration&lt;IOptionGroup&gt; i = options.getGroups(); i</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">                .hasMoreElements();) {</span>
<span class="nc" id="L646">            IOptionGroup group = i.nextElement();</span>

<span class="nc bnc" id="L648" title="All 2 branches missed.">            if (group.getKey().equalsIgnoreCase(PilotOptions.LVL3_ADVANTAGES)</span>
<span class="nc" id="L649">                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.RPG_PILOT_ADVANTAGES)) {</span>
<span class="nc" id="L651">                continue;</span>
            }

<span class="nc bnc" id="L654" title="All 2 branches missed.">            if (group.getKey().equalsIgnoreCase(PilotOptions.EDGE_ADVANTAGES)</span>
<span class="nc" id="L655">                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.EDGE)) {</span>
<span class="nc" id="L657">                continue;</span>
            }

<span class="nc bnc" id="L660" title="All 2 branches missed.">            if (group.getKey().equalsIgnoreCase(PilotOptions.MD_ADVANTAGES)</span>
<span class="nc" id="L661">                    &amp;&amp; !clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.RPG_MANEI_DOMINI)) {</span>
<span class="nc" id="L663">                continue;</span>
            }

<span class="nc" id="L666">            addGroup(group, gridbag, c);</span>

<span class="nc" id="L668">            Entity entity = entities.get(0);</span>
<span class="nc" id="L669">            for (Enumeration&lt;IOption&gt; j = group.getOptions(); j</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                    .hasMoreElements();) {</span>
<span class="nc" id="L671">                IOption option = j.nextElement();</span>

<span class="nc bnc" id="L673" title="All 2 branches missed.">                if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L674">                    continue;</span>
                }

                // a bunch of stuff should get disabled for conv infantry
<span class="nc bnc" id="L678" title="All 2 branches missed.">                if (entity.isConventionalInfantry()</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                        &amp;&amp; (option.getName().equals(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                        || option.getName().equals(OptionsConstants.MD_BVDNI))) {</span>
<span class="nc" id="L681">                    continue;</span>
                }

                // a bunch of stuff should get disabled for all but conventional infantry
<span class="nc bnc" id="L685" title="All 2 branches missed.">                if (!entity.isConventionalInfantry()</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">                        &amp;&amp; (option.getName().equals(OptionsConstants.MD_PL_ENHANCED)</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                        || option.getName().equals(OptionsConstants.MD_PL_MASC)</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">                        || option.getName().equals(OptionsConstants.MD_CYBER_IMP_AUDIO)</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">                        || option.getName().equals(OptionsConstants.MD_CYBER_IMP_VISUAL))) {</span>
<span class="nc" id="L690">                    continue;</span>
                }

<span class="nc" id="L693">                addOption(option, gridbag, c, editable);</span>
<span class="nc" id="L694">            }</span>
<span class="nc" id="L695">        }</span>

<span class="nc" id="L697">        validate();</span>
<span class="nc" id="L698">    }</span>

    private void setPartReps() {
<span class="nc" id="L701">        Entity entity = entities.get(0);</span>
        IOption option;
<span class="nc bnc" id="L703" title="All 2 branches missed.">        for (final Object newVar : partRepsComps) {</span>
<span class="nc" id="L704">            DialogOptionComponent comp = (DialogOptionComponent) newVar;</span>
<span class="nc" id="L705">            option = comp.getOption();</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if ((comp.getValue() == Messages.getString(&quot;CustomMechDialog.None&quot;))) { // NON-NLS-$1</span>
<span class="nc" id="L707">                entity.getPartialRepairs().getOption(option.getName())</span>
<span class="nc" id="L708">                        .setValue(&quot;None&quot;); // NON-NLS-$1</span>
            } else {
<span class="nc" id="L710">                entity.getPartialRepairs().getOption(option.getName())</span>
<span class="nc" id="L711">                        .setValue(comp.getValue());</span>
            }
<span class="nc" id="L713">        }</span>

<span class="nc" id="L715">    }</span>

    private void setQuirks() {
<span class="nc" id="L718">        panQuirks.setQuirks();</span>
<span class="nc" id="L719">    }</span>

    public void refreshPartReps() {
<span class="nc" id="L722">        Entity entity = entities.get(0);</span>
<span class="nc" id="L723">        panPartReps.removeAll();</span>
<span class="nc" id="L724">        partRepsComps = new ArrayList&lt;DialogOptionComponent&gt;();</span>
<span class="nc" id="L725">        for (Enumeration&lt;IOptionGroup&gt; i = partReps.getGroups(); i</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                .hasMoreElements();) {</span>
<span class="nc" id="L727">            IOptionGroup group = i.nextElement();</span>
<span class="nc" id="L728">            panPartReps.add(new JLabel(group.getDisplayableName()), GBC.eol());</span>

<span class="nc" id="L730">            for (Enumeration&lt;IOption&gt; j = group.getSortedOptions(); j</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">                    .hasMoreElements();) {</span>
<span class="nc" id="L732">                IOption option = j.nextElement();</span>

<span class="nc bnc" id="L734" title="All 2 branches missed.">                if (!PartialRepairs.isPartRepLegalFor(option, entity)) {</span>
<span class="nc" id="L735">                    continue;</span>
                }

<span class="nc" id="L738">                addPartRep(option, editable);</span>
<span class="nc" id="L739">            }</span>
<span class="nc" id="L740">        }</span>
<span class="nc" id="L741">        validate();</span>
<span class="nc" id="L742">    }</span>

    public void refreshQuirks() {
<span class="nc" id="L745">        panQuirks.refreshQuirks();</span>
<span class="nc" id="L746">    }</span>

    private void addGroup(IOptionGroup group, GridBagLayout gridbag,
            GridBagConstraints c) {
<span class="nc" id="L750">        JLabel groupLabel = new JLabel(group.getDisplayableName());</span>

<span class="nc" id="L752">        gridbag.setConstraints(groupLabel, c);</span>
<span class="nc" id="L753">        panOptions.add(groupLabel);</span>
<span class="nc" id="L754">    }</span>

    private void addOption(IOption option, GridBagLayout gridbag, GridBagConstraints c, boolean editable) {
<span class="nc" id="L757">        Entity entity = entities.get(0);</span>
<span class="nc" id="L758">        DialogOptionComponent optionComp = new DialogOptionComponent(this, option, editable);</span>

<span class="nc bnc" id="L760" title="All 2 branches missed.">        if ((OptionsConstants.GUNNERY_WEAPON_SPECIALIST).equals(option.getName())) { // $NON-NLS-1$</span>
<span class="nc" id="L761">            optionComp.addValue(Messages.getString(&quot;CustomMechDialog.None&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L762">            TreeSet&lt;String&gt; uniqueWeapons = new TreeSet&lt;String&gt;();</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getWeaponList().size(); i++) {</span>
<span class="nc" id="L764">                Mounted m = entity.getWeaponList().get(i);</span>
<span class="nc" id="L765">                uniqueWeapons.add(m.getName());</span>
            }
<span class="nc bnc" id="L767" title="All 2 branches missed.">            for (String name : uniqueWeapons) {</span>
<span class="nc" id="L768">                optionComp.addValue(name);</span>
<span class="nc" id="L769">            }</span>
<span class="nc" id="L770">            optionComp.setSelected(option.stringValue());</span>
        }
        
<span class="nc bnc" id="L773" title="All 2 branches missed.">        if ((OptionsConstants.GUNNERY_SANDBLASTER).equals(option.getName())) { // $NON-NLS-1$</span>
<span class="nc" id="L774">            optionComp.addValue(Messages.getString(&quot;CustomMechDialog.None&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L775">            TreeSet&lt;String&gt; uniqueWeapons = new TreeSet&lt;String&gt;();</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getWeaponList().size(); i++) {</span>
<span class="nc" id="L777">                Mounted m = entity.getWeaponList().get(i);</span>
<span class="nc" id="L778">                uniqueWeapons.add(m.getName());</span>
            }
<span class="nc bnc" id="L780" title="All 2 branches missed.">            for (String name : uniqueWeapons) {</span>
<span class="nc" id="L781">                optionComp.addValue(name);</span>
<span class="nc" id="L782">            }</span>
<span class="nc" id="L783">            optionComp.setSelected(option.stringValue());</span>
        }

<span class="nc" id="L786">        if (OptionsConstants.GUNNERY_SPECIALIST               </span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                .equals(option.getName())) { //$NON-NLS-1$</span>
<span class="nc" id="L788">            optionComp.addValue(Crew.SPECIAL_NONE);</span>
<span class="nc" id="L789">            optionComp.addValue(Crew.SPECIAL_ENERGY);</span>
<span class="nc" id="L790">            optionComp.addValue(Crew.SPECIAL_BALLISTIC);</span>
<span class="nc" id="L791">            optionComp.addValue(Crew.SPECIAL_MISSILE);</span>
<span class="nc" id="L792">            optionComp.setSelected(option.stringValue());</span>
        }

<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (OptionsConstants.GUNNERY_RANGE_MASTER.equals(option.getName())) { //$NON-NLS-1$</span>
<span class="nc" id="L796">            optionComp.addValue(Crew.RANGEMASTER_NONE);</span>
<span class="nc" id="L797">            optionComp.addValue(Crew.RANGEMASTER_MEDIUM);</span>
<span class="nc" id="L798">            optionComp.addValue(Crew.RANGEMASTER_LONG);</span>
<span class="nc" id="L799">            optionComp.addValue(Crew.RANGEMASTER_EXTREME);</span>
<span class="nc" id="L800">            optionComp.setSelected(option.stringValue());</span>
        }

<span class="nc bnc" id="L803" title="All 2 branches missed.">        if (OptionsConstants.MISC_HUMAN_TRO.equals(option.getName())) { //$NON-NLS-1$</span>
<span class="nc" id="L804">            optionComp.addValue(Crew.HUMANTRO_NONE);</span>
<span class="nc" id="L805">            optionComp.addValue(Crew.HUMANTRO_MECH);</span>
<span class="nc" id="L806">            optionComp.addValue(Crew.HUMANTRO_AERO);</span>
<span class="nc" id="L807">            optionComp.addValue(Crew.HUMANTRO_VEE);</span>
<span class="nc" id="L808">            optionComp.addValue(Crew.HUMANTRO_BA);</span>
<span class="nc" id="L809">            optionComp.setSelected(option.stringValue());</span>
        }

<span class="nc" id="L812">        gridbag.setConstraints(optionComp, c);</span>
<span class="nc" id="L813">        panOptions.add(optionComp);</span>

<span class="nc" id="L815">        optionComps.add(optionComp);</span>
<span class="nc" id="L816">    }</span>

    private void addPartRep(IOption option, boolean editable) {
<span class="nc" id="L819">        DialogOptionComponent optionComp = new DialogOptionComponent(this,</span>
                option, editable);
<span class="nc" id="L821">        panPartReps.add(optionComp, GBC.eol());</span>
<span class="nc" id="L822">        partRepsComps.add(optionComp);</span>
<span class="nc" id="L823">    }</span>

    public void optionClicked(DialogOptionComponent comp, IOption option,
            boolean state) {
<span class="nc" id="L827">    }</span>

    public boolean isOkay() {
<span class="nc" id="L830">        return okay;</span>
    }

    public int getStatus() {
<span class="nc" id="L834">        return status;</span>
    }

    private void refreshDeployment() {
<span class="nc" id="L838">        Entity entity = entities.get(0);</span>
        
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (entity instanceof QuadVee) {</span>
<span class="nc" id="L841">            choStartingMode.removeItemListener(this);</span>
<span class="nc" id="L842">            choStartingMode.removeAllItems();</span>
<span class="nc" id="L843">            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeQuad&quot;));</span>
<span class="nc" id="L844">            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeVehicle&quot;));</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">            if (entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
<span class="nc" id="L846">                choStartingMode.setSelectedIndex(1);</span>
            }
<span class="nc" id="L848">            updateStartingModeOptions();</span>
<span class="nc" id="L849">            choStartingMode.addItemListener(this);</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">        } else if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L851">            choStartingMode.removeItemListener(this);</span>
<span class="nc" id="L852">            choStartingMode.removeAllItems();</span>
<span class="nc" id="L853">            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeBiped&quot;));</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">            if (((LandAirMech)entity).getLAMType() != LandAirMech.LAM_BIMODAL) {</span>
<span class="nc" id="L855">                choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeAirMech&quot;));</span>
            }
<span class="nc" id="L857">            choStartingMode.addItem(Messages.getString(&quot;CustomMechDialog.ModeFighter&quot;));</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">            if (entity.getConversionMode() == LandAirMech.CONV_MODE_AIRMECH) {</span>
<span class="nc" id="L859">                choStartingMode.setSelectedIndex(1);</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">            } else if (entity.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER) {</span>
<span class="nc" id="L861">                choStartingMode.setSelectedIndex(choStartingMode.getItemCount() - 1);</span>
            }
<span class="nc" id="L863">            updateStartingModeOptions();</span>
<span class="nc" id="L864">            choStartingMode.addItemListener(this);</span>
        }
        
<span class="nc" id="L867">        choDeploymentRound.removeItemListener(this);</span>
        
<span class="nc" id="L869">        choDeploymentRound.removeAllItems();</span>
<span class="nc" id="L870">        choDeploymentRound.addItem(Messages</span>
<span class="nc" id="L871">                .getString(&quot;CustomMechDialog.StartOfGame&quot;)); //$NON-NLS-1$</span>

<span class="nc bnc" id="L873" title="All 2 branches missed.">        if (entity.getDeployRound() &lt; 1) {</span>
<span class="nc" id="L874">            choDeploymentRound.setSelectedIndex(0);</span>
        }

<span class="nc bnc" id="L877" title="All 2 branches missed.">        for (int i = 1; i &lt;= 40; i++) {</span>
<span class="nc" id="L878">            choDeploymentRound.addItem(Messages</span>
<span class="nc" id="L879">                    .getString(&quot;CustomMechDialog.AfterRound&quot;) + i); //$NON-NLS-1$</span>

<span class="nc bnc" id="L881" title="All 2 branches missed.">            if (entity.getDeployRound() == i) {</span>
<span class="nc" id="L882">                choDeploymentRound.setSelectedIndex(i);</span>
            }
        }
<span class="nc bnc" id="L885" title="All 2 branches missed.">        if (entity.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L886">            choDeploymentRound.setEnabled(false);</span>
        }
        
<span class="nc" id="L889">        choDeploymentZone.removeAllItems();</span>
<span class="nc" id="L890">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L891">                .getString(&quot;CustomMechDialog.useOwners&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L892">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L893">                .getString(&quot;CustomMechDialog.deployAny&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L894">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L895">                .getString(&quot;CustomMechDialog.deployNW&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L896">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L897">                .getString(&quot;CustomMechDialog.deployN&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L898">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L899">                .getString(&quot;CustomMechDialog.deployNE&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L900">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L901">                .getString(&quot;CustomMechDialog.deployE&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L902">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L903">                .getString(&quot;CustomMechDialog.deploySE&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L904">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L905">                .getString(&quot;CustomMechDialog.deployS&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L906">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L907">                .getString(&quot;CustomMechDialog.deploySW&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L908">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L909">                .getString(&quot;CustomMechDialog.deployW&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L910">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L911">                .getString(&quot;CustomMechDialog.deployEdge&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L912">        choDeploymentZone.addItem(Messages</span>
<span class="nc" id="L913">                .getString(&quot;CustomMechDialog.deployCenter&quot;)); //$NON-NLS-1$</span>
        
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (entity.getDeployRound() == 0) {</span>
<span class="nc" id="L916">            choDeploymentZone.setEnabled(false);</span>
        } else {
<span class="nc" id="L918">            choDeploymentZone.setEnabled(true);</span>
        }
<span class="nc" id="L920">        choDeploymentZone.setSelectedIndex(entity.getStartingPos(false) + 1);</span>
        
<span class="nc" id="L922">        choDeploymentRound.addItemListener(this);</span>

<span class="nc" id="L924">        chHidden.removeActionListener(this);</span>
<span class="nc" id="L925">        boolean enableHidden = true;</span>
        // Airborne units can't be hidden
<span class="nc bnc" id="L927" title="All 4 branches missed.">        if (entity.isAirborne() || entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L928">            enableHidden = false;</span>
        }
        // Landed dropships can't be hidden
<span class="nc bnc" id="L931" title="All 2 branches missed.">        if ((entity instanceof Dropship)) {</span>
<span class="nc" id="L932">            enableHidden = false;</span>
        }
<span class="nc" id="L934">        labHidden.setEnabled(enableHidden);</span>
<span class="nc" id="L935">        chHidden.setEnabled(enableHidden);</span>
<span class="nc" id="L936">        chHidden.addActionListener(this);</span>
<span class="nc" id="L937">    }</span>

    public void actionPerformed(ActionEvent actionEvent) {

<span class="nc bnc" id="L941" title="All 2 branches missed.">        if (actionEvent.getSource().equals(butOffBoardDistance)) {</span>
            // We'll allow the player to deploy at the maximum possible
            // effective range, even if many of the unit's weapons would be out of range
<span class="nc" id="L944">            int maxDistance = 0;</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            for (Entity entity : entities) {</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">                for (Mounted wep : entity.getWeaponList()) {</span>
<span class="nc" id="L947">                    EquipmentType e = wep.getType();</span>
<span class="nc" id="L948">                    WeaponType w = (WeaponType) e;</span>
<span class="nc" id="L949">                    int nDistance = 0;</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">                    if (w.hasFlag(WeaponType.F_ARTILLERY)) {</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">                        if (w instanceof ArtilleryBayWeapon) {</span>
                            // Artillery bays can mix and match, so limit the bay
                            // to the shortest range of the weapons in it
<span class="nc" id="L954">                            int bayShortestRange = 150; // Cruise missile/120</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                            for (int wId : wep.getBayWeapons()) {</span>
<span class="nc" id="L956">                                Mounted bweap = entity.getEquipment(wId);</span>
<span class="nc" id="L957">                                WeaponType bwtype = (WeaponType) bweap.getType();</span>
                                // Max TO range in mapsheets - 1 for the actual play area
<span class="nc" id="L959">                                int currentDistance = (bwtype.getLongRange() - 1);</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">                                if (currentDistance &lt; bayShortestRange) {</span>
<span class="nc" id="L961">                                    bayShortestRange = currentDistance;</span>
                                }
<span class="nc" id="L963">                            }</span>
<span class="nc" id="L964">                            nDistance = bayShortestRange;</span>
<span class="nc" id="L965">                        } else {</span>
                            // Max TO range in mapsheets - 1 for the actual play area
<span class="nc" id="L967">                            nDistance = (w.getLongRange() - 1);</span>
                        }
<span class="nc bnc" id="L969" title="All 4 branches missed.">                    } else if (w.isCapital() || w.isSubCapital()) {</span>
                        // Capital weapons use their maximum space hex range as the mapsheet range
<span class="nc bnc" id="L971" title="All 2 branches missed.">                        if (w.getMaxRange(wep) == WeaponType.RANGE_EXT) {</span>
<span class="nc" id="L972">                            nDistance = 50;</span>
                        }
<span class="nc bnc" id="L974" title="All 2 branches missed.">                        if (w.getMaxRange(wep) == WeaponType.RANGE_LONG) {</span>
<span class="nc" id="L975">                            nDistance = 40;</span>
                        }
<span class="nc bnc" id="L977" title="All 2 branches missed.">                        if (w.getMaxRange(wep) == WeaponType.RANGE_MED) {</span>
<span class="nc" id="L978">                            nDistance = 24;</span>
                        }
<span class="nc bnc" id="L980" title="All 2 branches missed.">                        if (w.getMaxRange(wep) == WeaponType.RANGE_SHORT) {</span>
<span class="nc" id="L981">                            nDistance = 12;</span>
                        }
                    }
                    // Now, convert to mapsheets
<span class="nc" id="L985">                    nDistance = nDistance * Board.DEFAULT_BOARD_HEIGHT;</span>
                    // And set our maximum slider hex distance based on the calculations
<span class="nc bnc" id="L987" title="All 2 branches missed.">                    if (nDistance &gt; maxDistance) {</span>
<span class="nc" id="L988">                        maxDistance = nDistance;</span>
                    }
<span class="nc" id="L990">                }</span>
                
<span class="nc" id="L992">            }</span>
<span class="nc" id="L993">            Slider sl = new Slider(</span>
                    clientgui.frame,
<span class="nc" id="L995">                    Messages.getString(&quot;CustomMechDialog.offboardDistanceTitle&quot;),</span>
<span class="nc" id="L996">                    Messages.getString(&quot;CustomMechDialog.offboardDistanceQuestion&quot;),</span>
<span class="nc" id="L997">                    Math.min(</span>
<span class="nc" id="L998">                            Math.max(entities.get(0).getOffBoardDistance(), 17),</span>
                            maxDistance), 17, maxDistance);
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (!sl.showDialog()) {</span>
<span class="nc" id="L1001">                return;</span>
            }
<span class="nc" id="L1003">            distance = sl.getValue();</span>
<span class="nc" id="L1004">            butOffBoardDistance.setText(Integer.toString(distance));</span>
<span class="nc" id="L1005">            return;</span>
        }
        
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        if (actionEvent.getSource().equals(butCancel)) {</span>
<span class="nc" id="L1009">            setVisible(false);</span>
<span class="nc" id="L1010">            return;</span>
        }
        
<span class="nc bnc" id="L1013" title="All 2 branches missed.">        if (actionEvent.getSource().equals(chHidden)) {</span>
<span class="nc" id="L1014">            return;</span>
        }
        
<span class="nc bnc" id="L1017" title="All 2 branches missed.">        if (actionEvent.getActionCommand().equals(&quot;missing&quot;)) {</span>
            //If we're down to a single crew member, do not allow any more to be removed.
<span class="nc bnc" id="L1019" title="All 2 branches missed.">            final long remaining = Arrays.stream(panCrewMember).filter(p -&gt; !p.getMissing()).count();</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            for (CustomPilotView v : panCrewMember) {</span>
<span class="nc bnc" id="L1021" title="All 4 branches missed.">                v.enableMissing(remaining &gt; 1 || v.getMissing());</span>
            }
<span class="nc" id="L1023">            return;</span>
        }

        // Set instanceof flags
        String msg, title;
<span class="nc" id="L1028">        boolean isAero = true;</span>
<span class="nc" id="L1029">        boolean isShip = true;</span>
<span class="nc" id="L1030">        boolean isVTOL = true;</span>
<span class="nc" id="L1031">        boolean isWiGE = true;</span>
<span class="nc" id="L1032">        boolean isQuadVee = true;</span>
<span class="nc" id="L1033">        boolean isLAM = true;</span>
<span class="nc" id="L1034">        boolean isAirMech = true;</span>
<span class="nc" id="L1035">        boolean isGlider = true;         </span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">        for (Entity e : entities) {</span>
<span class="nc bnc" id="L1037" title="All 8 branches missed.">            isAero &amp;= ((e instanceof Aero) &amp;&amp; !((e instanceof SmallCraft) || (e instanceof Jumpship)))</span>
                    || ((e instanceof LandAirMech)
<span class="nc bnc" id="L1039" title="All 2 branches missed.">                        &amp;&amp; (choStartingMode.getSelectedIndex() == 2</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">                            || ((LandAirMech)e).getLAMType() == LandAirMech.LAM_BIMODAL</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                                &amp;&amp; choStartingMode.getSelectedIndex() == 1));</span>
<span class="nc bnc" id="L1042" title="All 4 branches missed.">            isShip &amp;= (e instanceof SmallCraft) || (e instanceof Jumpship);</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">            isVTOL &amp;= (e.getMovementMode() == EntityMovementMode.VTOL);</span>
<span class="nc bnc" id="L1044" title="All 4 branches missed.">            isWiGE &amp;= (e instanceof Tank) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc" id="L1045">            isQuadVee &amp;= (e instanceof QuadVee);</span>
<span class="nc" id="L1046">            isLAM &amp;= (e instanceof LandAirMech);</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">            isAirMech &amp;= (e instanceof LandAirMech)</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">                    &amp;&amp; (((LandAirMech)e).getLAMType() == LandAirMech.LAM_STANDARD)</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                    &amp;&amp; (choStartingMode.getSelectedIndex() == 1);</span>
<span class="nc bnc" id="L1050" title="All 4 branches missed.">            isGlider &amp;= (e instanceof Protomech) &amp;&amp; (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc" id="L1051">        }</span>

        // get values
<span class="nc" id="L1054">        int fatigue = 0;</span>
<span class="nc" id="L1055">        int init = 0;</span>
<span class="nc" id="L1056">        int command = 0;</span>
<span class="nc" id="L1057">        int velocity = 0;</span>
<span class="nc" id="L1058">        int altitude = 0;</span>
<span class="nc" id="L1059">        int currentfuel = 0;</span>
<span class="nc" id="L1060">        int height = 0;</span>
        int offBoardDistance;
        try {
<span class="nc" id="L1063">            init = Integer.parseInt(fldInit.getText());</span>
<span class="nc" id="L1064">            fatigue = Integer.parseInt(fldFatigue.getText());</span>
<span class="nc" id="L1065">            command = Integer.parseInt(fldCommandInit.getText());</span>
<span class="nc bnc" id="L1066" title="All 4 branches missed.">            if (isAero || isShip) {</span>
<span class="nc" id="L1067">                velocity = Integer.parseInt(fldStartVelocity.getText());</span>
<span class="nc" id="L1068">                altitude = Integer.parseInt(fldStartAltitude.getText());</span>
<span class="nc" id="L1069">                currentfuel = Integer.parseInt(fldCurrentFuel.getText());</span>
            }
<span class="nc bnc" id="L1071" title="All 4 branches missed.">            if (isVTOL || isAirMech) {</span>
<span class="nc" id="L1072">                height = Integer.parseInt(fldStartHeight.getText());</span>
            }
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            if (isWiGE) {</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                height = chDeployAirborne.isSelected()? 1 : 0;</span>
            }
<span class="nc" id="L1077">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L1078">            msg = Messages.getString(&quot;CustomMechDialog.EnterValidSkills&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1079">            title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1080">            JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                    JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1082">            return;</span>
<span class="nc" id="L1083">        }</span>
        
<span class="nc bnc" id="L1085" title="All 4 branches missed.">        if (isAero || isShip) {</span>
<span class="nc bnc" id="L1086" title="All 4 branches missed.">            if ((velocity &gt; (2 * entities.get(0).getWalkMP()))</span>
                    || (velocity &lt; 0)) {
<span class="nc" id="L1088">                msg = Messages</span>
<span class="nc" id="L1089">                        .getString(&quot;CustomMechDialog.EnterCorrectVelocity&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1090">                title = Messages</span>
<span class="nc" id="L1091">                        .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1092">                JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                        JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1094">                return;</span>
            }
<span class="nc bnc" id="L1096" title="All 4 branches missed.">            if ((altitude &lt; 0) || (altitude &gt; 10)) {</span>
<span class="nc" id="L1097">                msg = Messages</span>
<span class="nc" id="L1098">                        .getString(&quot;CustomMechDialog.EnterCorrectAltitude&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1099">                title = Messages</span>
<span class="nc" id="L1100">                        .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1101">                JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                        JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1103">                return;</span>
            }
            
<span class="nc bnc" id="L1106" title="All 4 branches missed.">            if ((currentfuel &lt; 0) || (currentfuel &gt; fuel)) {</span>
<span class="nc" id="L1107">            	msg = (Messages</span>
<span class="nc" id="L1108">            			 .getString(&quot;CustomMechDialog.EnterCorrectFuel&quot;) + fuel + &quot;.&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1109">            	title = Messages</span>
<span class="nc" id="L1110">            			.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1111">            	JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
            			JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1113">            	return;</span>
            }
        }

<span class="nc bnc" id="L1117" title="All 12 branches missed.">        if ((isVTOL &amp;&amp; height &gt; 50)</span>
                || (isAirMech &amp;&amp; height &gt; 25)
                || (isGlider &amp;&amp; height &gt; 12)) {
<span class="nc" id="L1120">            msg = Messages.getString(&quot;CustomMechDialog.EnterCorrectHeight&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1121">            title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1122">            JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                    JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1124">            return;</span>
        }
        // Apply single-entity settings
<span class="nc bnc" id="L1127" title="All 2 branches missed.">        if (entities.size() == 1) {</span>
<span class="nc" id="L1128">            Entity entity = entities.get(0);</span>

<span class="nc bnc" id="L1130" title="All 2 branches missed.">            for (int i = 0; i &lt; entities.get(0).getCrew().getSlotCount(); i++) {</span>
<span class="nc" id="L1131">                String name = panCrewMember[i].getPilotName();</span>
<span class="nc" id="L1132">                String nick = panCrewMember[i].getNickname();</span>
<span class="nc" id="L1133">                Gender gender = panCrewMember[i].getGender();</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">                if (gender == Gender.RANDOMIZE) {</span>
<span class="nc" id="L1135">                    gender = entities.get(0).getCrew().getGender(i);</span>
                }
<span class="nc" id="L1137">                boolean missing = panCrewMember[i].getMissing();</span>
                int gunnery;
                int gunneryL;
                int gunneryM;
                int gunneryB;
                int artillery;
                int piloting;
                int gunneryAero;
                int gunneryAeroL;
                int gunneryAeroM;
                int gunneryAeroB;
                int pilotingAero;
<span class="nc" id="L1149">                int tough = 0;</span>
<span class="nc" id="L1150">                int backup = panCrewMember[i].getBackup();</span>
                try {
<span class="nc" id="L1152">                    gunnery = panCrewMember[i].getGunnery();</span>
<span class="nc" id="L1153">                    gunneryL = panCrewMember[i].getGunneryL();</span>
<span class="nc" id="L1154">                    gunneryM = panCrewMember[i].getGunneryM();</span>
<span class="nc" id="L1155">                    gunneryB = panCrewMember[i].getGunneryB();</span>
<span class="nc" id="L1156">                    piloting = panCrewMember[i].getPiloting();</span>
<span class="nc" id="L1157">                    gunneryAero = panCrewMember[i].getGunneryAero();</span>
<span class="nc" id="L1158">                    gunneryAeroL = panCrewMember[i].getGunneryAeroL();</span>
<span class="nc" id="L1159">                    gunneryAeroM = panCrewMember[i].getGunneryAeroM();</span>
<span class="nc" id="L1160">                    gunneryAeroB = panCrewMember[i].getGunneryAeroB();</span>
<span class="nc" id="L1161">                    pilotingAero = panCrewMember[i].getPilotingAero();</span>
<span class="nc" id="L1162">                    artillery = panCrewMember[i].getArtillery();</span>
<span class="nc" id="L1163">                    tough = panCrewMember[i].getToughness();</span>
<span class="nc" id="L1164">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L1165">                    msg = Messages.getString(&quot;CustomMechDialog.EnterValidSkills&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1166">                    title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1167">                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                            JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1169">                    return;</span>
<span class="nc" id="L1170">                }</span>
        
                // keep these reasonable, please
<span class="nc bnc" id="L1173" title="All 44 branches missed.">                if ((gunnery &lt; 0) || (gunnery &gt; 8) || (piloting &lt; 0) || (piloting &gt; 8)</span>
                        || (gunneryL &lt; 0) || (gunneryL &gt; 8) || (gunneryM &lt; 0)
                        || (gunneryM &gt; 8) || (gunneryB &lt; 0) || (gunneryB &gt; 8)
                        || (gunneryAero &lt; 0) || (gunneryAero &gt; 8) || (pilotingAero &lt; 0) || (pilotingAero &gt; 8)
                        || (gunneryAeroL &lt; 0) || (gunneryAeroL &gt; 8) || (gunneryAeroM &lt; 0)
                        || (gunneryAeroM &gt; 8) || (gunneryAeroB &lt; 0) || (gunneryAeroB &gt; 8)                        
                        || (artillery &lt; 0) || (artillery &gt; 8)) {
<span class="nc" id="L1180">                    msg = Messages.getString(&quot;CustomMechDialog.EnterSkillsBetween0_8&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1181">                    title = Messages.getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1182">                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                            JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1184">                    return;</span>
                }

<span class="nc bnc" id="L1187" title="All 2 branches missed.">                if (entity.getCrew() instanceof LAMPilot) {</span>
<span class="nc" id="L1188">                    LAMPilot pilot = (LAMPilot)entity.getCrew();</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                    if (client.getGame().getOptions().booleanOption(OptionsConstants.RPG_RPG_GUNNERY)) {</span>
<span class="nc" id="L1190">                        pilot.setGunneryMechL(gunneryL);</span>
<span class="nc" id="L1191">                        pilot.setGunneryMechB(gunneryB);</span>
<span class="nc" id="L1192">                        pilot.setGunneryMechM(gunneryM);</span>
<span class="nc" id="L1193">                        pilot.setGunneryMech((int) Math.round((gunneryL + gunneryB + gunneryM) / 3.0));</span>
<span class="nc" id="L1194">                        pilot.setGunneryAeroL(gunneryAeroL);</span>
<span class="nc" id="L1195">                        pilot.setGunneryAeroB(gunneryAeroB);</span>
<span class="nc" id="L1196">                        pilot.setGunneryAeroM(gunneryAeroM);</span>
<span class="nc" id="L1197">                        pilot.setGunneryAero((int) Math.round((gunneryAeroL + gunneryAeroB + gunneryAeroM) / 3.0));</span>
                    } else {
<span class="nc" id="L1199">                        pilot.setGunneryMechL(gunnery);</span>
<span class="nc" id="L1200">                        pilot.setGunneryMechB(gunnery);</span>
<span class="nc" id="L1201">                        pilot.setGunneryMechM(gunnery);</span>
<span class="nc" id="L1202">                        pilot.setGunneryMech(gunnery);</span>
<span class="nc" id="L1203">                        pilot.setGunneryAeroL(gunneryAero);</span>
<span class="nc" id="L1204">                        pilot.setGunneryAeroB(gunneryAero);</span>
<span class="nc" id="L1205">                        pilot.setGunneryAeroM(gunneryAero);</span>
<span class="nc" id="L1206">                        pilot.setGunneryAero(gunneryAero);</span>
                    }
<span class="nc" id="L1208">                    pilot.setPilotingMech(piloting);</span>
<span class="nc" id="L1209">                    pilot.setPilotingAero(pilotingAero);</span>
<span class="nc" id="L1210">                } else {</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">                    if (client.getGame().getOptions().booleanOption(OptionsConstants.RPG_RPG_GUNNERY)) {</span>
<span class="nc" id="L1212">                        entity.getCrew().setGunneryL(gunneryL, i);</span>
<span class="nc" id="L1213">                        entity.getCrew().setGunneryB(gunneryB, i);</span>
<span class="nc" id="L1214">                        entity.getCrew().setGunneryM(gunneryM, i);</span>
<span class="nc" id="L1215">                        entity.getCrew().setGunnery((int) Math.round((gunneryL + gunneryB + gunneryM) / 3.0), i);</span>
                    } else {
<span class="nc" id="L1217">                        entity.getCrew().setGunnery(gunnery, i);</span>
<span class="nc" id="L1218">                        entity.getCrew().setGunneryL(gunnery, i);</span>
<span class="nc" id="L1219">                        entity.getCrew().setGunneryB(gunnery, i);</span>
<span class="nc" id="L1220">                        entity.getCrew().setGunneryM(gunnery, i);</span>
                    }
<span class="nc" id="L1222">                    entity.getCrew().setPiloting(piloting, i);</span>
                }
<span class="nc bnc" id="L1224" title="All 2 branches missed.">                if (clientgui.getClient().getGame().getOptions().booleanOption(OptionsConstants.RPG_ARTILLERY_SKILL)) {</span>
<span class="nc" id="L1225">                    entity.getCrew().setArtillery(artillery, i);</span>
                } else {
<span class="nc" id="L1227">                    entity.getCrew().setArtillery(entity.getCrew().getGunnery(i), i);</span>
                }
<span class="nc" id="L1229">                entity.getCrew().setMissing(missing, i);</span>
<span class="nc" id="L1230">                entity.getCrew().setToughness(tough, i);</span>
<span class="nc" id="L1231">                entity.getCrew().setName(name, i);</span>
<span class="nc" id="L1232">                entity.getCrew().setNickname(nick, i);</span>
<span class="nc" id="L1233">                entity.getCrew().setGender(gender, i);</span>
<span class="nc" id="L1234">                entity.getCrew().setPortraitCategory(panCrewMember[i].getPortraitCategory(), i);</span>
<span class="nc" id="L1235">                entity.getCrew().setPortraitFileName(panCrewMember[i].getPortraitFilename(), i);</span>
<span class="nc bnc" id="L1236" title="All 2 branches missed.">                if (backup &gt;= 0) {</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">                    if (i == entity.getCrew().getCrewType().getPilotPos()) {</span>
<span class="nc" id="L1238">                        entity.getCrew().setBackupPilotPos(backup);</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">                    } else if (i == entity.getCrew().getCrewType().getGunnerPos()) {</span>
<span class="nc" id="L1240">                        entity.getCrew().setBackupGunnerPos(backup);</span>
                    }
                }

                // If the player wants to swap unit numbers, update both
                // entities and send an update packet for the other entity.
<span class="nc" id="L1246">                Entity other = panCrewMember[i].getEntityUnitNumSwap();</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                if (null != other) {</span>
<span class="nc" id="L1248">                    short temp = entity.getUnitNumber();</span>
<span class="nc" id="L1249">                    entity.setUnitNumber(other.getUnitNumber());</span>
<span class="nc" id="L1250">                    other.setUnitNumber(temp);</span>
<span class="nc" id="L1251">                    client.sendUpdateEntity(other);</span>
                }
            }
<span class="nc" id="L1254">            entity.getCrew().setFatigue(fatigue);</span>
<span class="nc" id="L1255">            entity.getCrew().setInitBonus(init);</span>
<span class="nc" id="L1256">            entity.getCrew().setCommandBonus(command);</span>

            // update commander status
<span class="nc" id="L1259">            entity.setCommander(chCommander.isSelected());</span>

<span class="nc" id="L1261">            setOptions();</span>
<span class="nc" id="L1262">            setQuirks();</span>
<span class="nc" id="L1263">            setPartReps();</span>
<span class="nc" id="L1264">            m_equip.applyChoices();</span>

<span class="nc bnc" id="L1266" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // have to reset internals because of dermal armor option
<span class="nc bnc" id="L1268" title="All 2 branches missed.">                if (entity.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L1269">                    ((BattleArmor) entity).setInternal(2);</span>
                } else {
<span class="nc" id="L1271">                    ((BattleArmor) entity).setInternal(1);</span>
                }
            }
        }

        // Apply multiple-entity settings
<span class="nc bnc" id="L1277" title="All 2 branches missed.">        for (Entity entity : entities) {</span>
<span class="nc" id="L1278">            entity.setHidden(chHidden.isSelected());</span>

<span class="nc bnc" id="L1280" title="All 2 branches missed.">            if (chOffBoard.isSelected()) {</span>
                try {
<span class="nc" id="L1282">                    offBoardDistance = distance;</span>
<span class="nc" id="L1283">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L1284">                    msg = Messages</span>
<span class="nc" id="L1285">                            .getString(&quot;CustomMechDialog.EnterValidSkills&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1286">                    title = Messages</span>
<span class="nc" id="L1287">                            .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1288">                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                            JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1290">                    return;</span>
<span class="nc" id="L1291">                }</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">                if (offBoardDistance &lt; 17) {</span>
<span class="nc" id="L1293">                    msg = Messages</span>
<span class="nc" id="L1294">                            .getString(&quot;CustomMechDialog.OffboardDistance&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1295">                    title = Messages</span>
<span class="nc" id="L1296">                            .getString(&quot;CustomMechDialog.NumberFormatError&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1297">                    JOptionPane.showMessageDialog(clientgui.frame, msg, title,</span>
                            JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1299">                    return;</span>
                }
<span class="nc" id="L1301">                entity.setOffBoard(offBoardDistance, OffBoardDirection</span>
<span class="nc" id="L1302">                        .getDirection(choOffBoardDirection.getSelectedIndex()));</span>
            } else {
<span class="nc" id="L1304">                entity.setOffBoard(0, OffBoardDirection.NONE);</span>
            }

<span class="nc bnc" id="L1307" title="All 4 branches missed.">            if (isAero || isShip) {</span>
<span class="nc" id="L1308">                IAero a = (IAero) entity;</span>
<span class="nc" id="L1309">                a.setCurrentVelocity(velocity);</span>
<span class="nc" id="L1310">                a.setNextVelocity(velocity);</span>
<span class="nc" id="L1311">                a.setCurrentFuel(currentfuel);</span>
                // we need to determine whether this aero is airborne or not in
                // order for prohibited terrain and stacking to work right in
                // the
                // deployment phase this is very tricky because in atmosphere,
                // zero
                // altitude does not necessarily mean grounded
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                if (altitude &lt;= 0) {</span>
<span class="nc" id="L1319">                    a.land();</span>
                } else {
<span class="nc" id="L1321">                    a.liftOff(altitude);</span>
                }
            }
            
<span class="nc bnc" id="L1325" title="All 8 branches missed.">            if (isVTOL || isWiGE || isAirMech || isGlider) {</span>
<span class="nc" id="L1326">                entity.setElevation(height);</span>
            }
            
            //Set the entity's starting mode
<span class="nc bnc" id="L1330" title="All 2 branches missed.">            if (isQuadVee) {</span>
<span class="nc" id="L1331">                entity.setConversionMode(choStartingMode.getSelectedIndex());</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed.">            } else if (isLAM) {</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">                if (choStartingMode.getSelectedIndex() == 2) {</span>
<span class="nc" id="L1334">                    entity.setConversionMode(LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">                } else if (choStartingMode.getSelectedIndex() == 1) {</span>
<span class="nc" id="L1336">                    entity.setConversionMode(LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">                    entity.setConversionMode(((LandAirMech)entity).getLAMType() == LandAirMech.LAM_BIMODAL?</span>
<span class="nc" id="L1338">                            LandAirMech.CONV_MODE_FIGHTER : LandAirMech.CONV_MODE_AIRMECH);</span>
                } else {
<span class="nc" id="L1340">                    entity.setConversionMode(LandAirMech.CONV_MODE_MECH);</span>
                }
            }

            // Set the entity's deployment position and round.
<span class="nc" id="L1345">            entity.setStartingPos(choDeploymentZone.getSelectedIndex() - 1);</span>
<span class="nc" id="L1346">            entity.setDeployRound(choDeploymentRound.getSelectedIndex());</span>

            // Should the entity begin the game shutdown?
<span class="nc bnc" id="L1349" title="All 2 branches missed.">            if (chDeployShutdown.isSelected()</span>
<span class="nc" id="L1350">                    &amp;&amp; clientgui.getClient().getGame().getOptions()</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.RPG_BEGIN_SHUTDOWN)) {</span>
<span class="nc" id="L1352">                entity.performManualShutdown();</span>
            } else { // We need to else this in case someone turned the option
                     // on, set their units, and then turned the option off.
<span class="nc" id="L1355">                entity.performManualStartup();</span>
            }

            // LAMs in fighter mode or airborne AirMechs ignore the prone and hull down selections.
<span class="nc bnc" id="L1359" title="All 6 branches missed.">            if (!isLAM || (!isAero &amp;&amp; entity.getElevation() == 0)) {</span>
                // Should the entity begin the game prone?
<span class="nc" id="L1361">                entity.setProne(chDeployProne.isSelected());</span>
    
                // Should the entity begin the game prone?
<span class="nc" id="L1364">                entity.setHullDown(chDeployHullDown.isSelected());</span>
            }
<span class="nc" id="L1366">        }</span>

<span class="nc" id="L1368">        okay = true;</span>
<span class="nc" id="L1369">        status = DONE;</span>
<span class="nc" id="L1370">        clientgui.chatlounge.refreshEntities();</span>

        // Check validity of units after customization
<span class="nc bnc" id="L1373" title="All 2 branches missed.">        for (Entity entity : entities) {</span>
<span class="nc" id="L1374">            EntityVerifier verifier = EntityVerifier.getInstance(new MegaMekFile(</span>
<span class="nc" id="L1375">                    Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</span>
<span class="nc" id="L1376">            TestEntity testEntity = null;</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L1378">                testEntity = new TestMech((Mech) entity, verifier.mechOption,</span>
                        null);
<span class="nc bnc" id="L1380" title="All 4 branches missed.">            } else if ((entity instanceof Tank)</span>
                    &amp;&amp; !(entity instanceof GunEmplacement)) {
<span class="nc bnc" id="L1382" title="All 2 branches missed.">                if (entity.isSupportVehicle()) {</span>
<span class="nc" id="L1383">                    testEntity = new TestSupportVehicle((Tank) entity,</span>
                            verifier.tankOption, null);
                } else {
<span class="nc" id="L1386">                    testEntity = new TestTank((Tank) entity,</span>
                            verifier.tankOption, null);
                }
<span class="nc bnc" id="L1389" title="All 2 branches missed.">            } else if (entity.getEntityType() == Entity.ETYPE_AERO</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_DROPSHIP</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_SMALL_CRAFT</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_FIGHTER_SQUADRON</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_JUMPSHIP</span>
<span class="nc bnc" id="L1394" title="All 2 branches missed.">                    &amp;&amp; entity.getEntityType() != Entity.ETYPE_SPACE_STATION) {</span>
<span class="nc" id="L1395">                testEntity = new TestAero((Aero) entity, verifier.mechOption,</span>
                        null);
<span class="nc bnc" id="L1397" title="All 2 branches missed.">            } else if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L1398">                testEntity = new TestBattleArmor((BattleArmor) entity,</span>
                        verifier.baOption, null);
<span class="nc bnc" id="L1400" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
<span class="nc" id="L1401">                testEntity = new TestInfantry((Infantry) entity,</span>
                        verifier.infOption, null);
            }
<span class="nc" id="L1404">            int gameTL = TechConstants.getGameTechLevel(client.getGame(),</span>
<span class="nc" id="L1405">                    entity.isClan());</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            if ((testEntity != null)</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">                    &amp;&amp; !testEntity.correctEntity(new StringBuffer(), gameTL)) {</span>
<span class="nc" id="L1408">                entity.setDesignValid(false);</span>
            } else {
<span class="nc" id="L1410">                entity.setDesignValid(true);</span>
            }
<span class="nc" id="L1412">        }</span>

<span class="nc bnc" id="L1414" title="All 2 branches missed.">        if (actionEvent.getSource().equals(butPrev)) {</span>
<span class="nc" id="L1415">            status = PREV;</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">        } else if (actionEvent.getSource().equals(butNext)) {</span>
<span class="nc" id="L1417">            status = NEXT;</span>
        }
<span class="nc" id="L1419">        setVisible(false);</span>
<span class="nc" id="L1420">    }</span>

    public void itemStateChanged(ItemEvent itemEvent) {
<span class="nc bnc" id="L1423" title="All 2 branches missed.">        if (itemEvent.getSource().equals(choStartingMode)) {</span>
<span class="nc" id="L1424">            updateStartingModeOptions();</span>
        }
<span class="nc bnc" id="L1426" title="All 2 branches missed.">        if (itemEvent.getSource().equals(chDeployProne)) {</span>
<span class="nc" id="L1427">            chDeployHullDown.setSelected(false);</span>
<span class="nc" id="L1428">            return;</span>
        }
<span class="nc bnc" id="L1430" title="All 2 branches missed.">        if (itemEvent.getSource().equals(chDeployHullDown)) {</span>
<span class="nc" id="L1431">            chDeployProne.setSelected(false);</span>
<span class="nc" id="L1432">            return;</span>
        }
<span class="nc bnc" id="L1434" title="All 2 branches missed.">        if (itemEvent.getSource().equals(choDeploymentRound)) {</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">            if (choDeploymentRound.getSelectedIndex() == 0) {</span>
<span class="nc" id="L1436">                choDeploymentZone.setEnabled(false);</span>
<span class="nc" id="L1437">                choDeploymentZone.setSelectedIndex(0);</span>
            } else {
<span class="nc" id="L1439">                choDeploymentZone.setEnabled(true);</span>
            }
        }
<span class="nc" id="L1442">    }</span>

    private void updateStartingModeOptions() {
<span class="nc" id="L1445">        final int index = choStartingMode.getSelectedIndex();</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">        if (entities.get(0) instanceof QuadVee) {</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">            labDeployProne.setEnabled(index == 0);</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            chDeployProne.setEnabled(index == 0);</span>
<span class="nc bnc" id="L1449" title="All 2 branches missed.">        } else if (entities.get(0) instanceof LandAirMech) {</span>
<span class="nc" id="L1450">            int mode = index;</span>
<span class="nc bnc" id="L1451" title="All 4 branches missed.">            if (((LandAirMech)entities.get(0)).getLAMType() == LandAirMech.LAM_BIMODAL</span>
                    &amp;&amp; mode == LandAirMech.CONV_MODE_AIRMECH) {
<span class="nc" id="L1453">                mode = LandAirMech.CONV_MODE_FIGHTER;</span>
            }
<span class="nc bnc" id="L1455" title="All 2 branches missed.">            labDeployProne.setEnabled(mode &lt; LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">            chDeployProne.setEnabled(mode &lt; LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1457" title="All 2 branches missed.">            labDeployHullDown.setEnabled(mode == LandAirMech.CONV_MODE_MECH);</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">            chDeployHullDown.setEnabled(mode == LandAirMech.CONV_MODE_MECH);</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">            labStartHeight.setEnabled(mode == LandAirMech.CONV_MODE_AIRMECH);</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">            fldStartHeight.setEnabled(mode == LandAirMech.CONV_MODE_AIRMECH);</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">            labStartVelocity.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1462" title="All 2 branches missed.">            fldStartVelocity.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">            labStartAltitude.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">            fldStartAltitude.setEnabled(mode == LandAirMech.CONV_MODE_FIGHTER);</span>
        }
<span class="nc" id="L1466">    }</span>

    public Entity getNextEntity(boolean forward) {
<span class="nc" id="L1469">        IGame game = client.getGame();</span>
<span class="nc" id="L1470">        boolean bd = game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP); //$NON-NLS-1$</span>
<span class="nc" id="L1471">        boolean rbd = game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP); //$NON-NLS-1$</span>
<span class="nc" id="L1472">        IPlayer p = client.getLocalPlayer();</span>

        Entity nextOne;
        Entity entity;
<span class="nc bnc" id="L1476" title="All 2 branches missed.">        if (forward) {</span>
<span class="nc" id="L1477">            entity = entities.get(entities.size() - 1);</span>
<span class="nc" id="L1478">            nextOne = game.getNextEntityFromList(entity);</span>
        } else {
<span class="nc" id="L1480">            entity = entities.get(0);</span>
<span class="nc" id="L1481">            nextOne = game.getPreviousEntityFromList(entity);</span>
        }
<span class="nc bnc" id="L1483" title="All 4 branches missed.">        while ((nextOne != null) &amp;&amp; !entities.contains(nextOne)) {</span>
<span class="nc bnc" id="L1484" title="All 6 branches missed.">            if (nextOne.getOwner().equals(p)</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">                    || (!(bd || rbd) &amp;&amp; nextOne.getOwner().equals(</span>
<span class="nc" id="L1486">                            entity.getOwner()))) {</span>
<span class="nc" id="L1487">                return nextOne;</span>
            }
<span class="nc bnc" id="L1489" title="All 2 branches missed.">            if (forward) {</span>
<span class="nc" id="L1490">                nextOne = game.getNextEntityFromList(nextOne);</span>
            } else {
<span class="nc" id="L1492">                nextOne = game.getPreviousEntityFromList(nextOne);</span>
            }
        }
<span class="nc" id="L1495">        return null;</span>
    }

    private void setupEquip() {
<span class="nc" id="L1499">        Entity entity = entities.get(0);</span>
<span class="nc" id="L1500">        GridBagLayout gbl = new GridBagLayout();</span>
<span class="nc" id="L1501">        panEquip.setLayout(gbl);</span>

<span class="nc" id="L1503">        m_equip = new EquipChoicePanel(entity, clientgui, client);</span>
<span class="nc" id="L1504">        panEquip.add(m_equip, GBC.std());</span>
<span class="nc" id="L1505">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>