<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PointblankShotDisplay.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">PointblankShotDisplay.java</span></div><h1>PointblankShotDisplay.java</h1><pre class="source lang-java linenums">/*
 * MegaMek -
 * Copyright (C) 2000,2001,2002,2003,2004,2005 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

package megamek.client.ui.swing;

import java.awt.event.ActionEvent;
import java.awt.event.InputEvent;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Vector;

import javax.swing.AbstractAction;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

import megamek.client.event.BoardViewEvent;
import megamek.client.ui.Messages;
import megamek.client.ui.swing.util.CommandAction;
import megamek.client.ui.swing.util.KeyCommandBind;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.client.ui.swing.widget.MegamekButton;
import megamek.common.AmmoType;
import megamek.common.Compute;
import megamek.common.Coords;
import megamek.common.Entity;
import megamek.common.HexTarget;
import megamek.common.IAimingModes;
import megamek.common.IBoard;
import megamek.common.IGame;
import megamek.common.Mounted;
import megamek.common.TargetRoll;
import megamek.common.Targetable;
import megamek.common.ToHitData;
import megamek.common.WeaponType;
import megamek.common.actions.ArtilleryAttackAction;
import megamek.common.actions.EntityAction;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GameTurnChangeEvent;
import megamek.common.options.OptionsConstants;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.capitalweapons.CapitalMissileWeapon;

/**
 * This display is used for when hidden units are taking pointblank shots.
 * 
 * @author arlith
 *
 */
public class PointblankShotDisplay extends FiringDisplay implements
        ItemListener, ListSelectionListener {

    /**
     * 
     */
    private static final long serialVersionUID = -58785096133753153L;

    /**
     * This enumeration lists all of the possible ActionCommands that can be
     * carried out during the pointblank phase.  Each command has a string for
     * the command plus a flag that determines what unit type it is
     * appropriate for.
     *
     * @author arlith
     */
<span class="nc" id="L82">    public static enum FiringCommand implements PhaseCommand {</span>
<span class="nc" id="L83">        FIRE_TWIST(&quot;fireTwist&quot;),</span>
<span class="nc" id="L84">        FIRE_FIRE(&quot;fireFire&quot;),</span>
<span class="nc" id="L85">        FIRE_SKIP(&quot;fireSkip&quot;),</span>
<span class="nc" id="L86">        FIRE_MODE(&quot;fireMode&quot;),</span>
<span class="nc" id="L87">        FIRE_FLIP_ARMS(&quot;fireFlipArms&quot;),</span>
<span class="nc" id="L88">        FIRE_SEARCHLIGHT(&quot;fireSearchlight&quot;),</span>
<span class="nc" id="L89">        FIRE_CALLED(&quot;fireCalled&quot;),</span>
<span class="nc" id="L90">        FIRE_CANCEL(&quot;fireCancel&quot;),</span>
<span class="nc" id="L91">        FIRE_MORE(&quot;fireMore&quot;);</span>

        String cmd;

        /**
         * Priority that determines this buttons order
         */
        public int priority;

<span class="nc" id="L100">        private FiringCommand(String c) {</span>
<span class="nc" id="L101">            cmd = c;</span>
<span class="nc" id="L102">        }</span>

        public String getCmd() {
<span class="nc" id="L105">            return cmd;</span>
        }

        public int getPriority() {
<span class="nc" id="L109">            return priority;</span>
        }

        public void setPriority(int p) {
<span class="nc" id="L113">            priority = p;</span>
<span class="nc" id="L114">        }</span>

        public String toString() {
<span class="nc" id="L117">            return Messages.getString(&quot;FiringDisplay.&quot; + getCmd());</span>
        }
    }

    // buttons
    protected Map&lt;FiringCommand, MegamekButton&gt; buttons;

    /**
     * Creates and lays out a new pointblank phase display for the specified
     * clientgui.getClient().
     */
    public PointblankShotDisplay(final ClientGUI clientgui) {
<span class="nc" id="L129">        super(clientgui);</span>

<span class="nc" id="L131">        buttons = new HashMap&lt;FiringCommand, MegamekButton&gt;(</span>
<span class="nc" id="L132">                (int) (FiringCommand.values().length * 1.25 + 0.5));</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        for (FiringCommand cmd : FiringCommand.values()) {</span>
<span class="nc" id="L134">            String title = Messages.getString(&quot;FiringDisplay.&quot; //$NON-NLS-1$</span>
<span class="nc" id="L135">                    + cmd.getCmd());</span>
<span class="nc" id="L136">            MegamekButton newButton = new MegamekButton(title,</span>
                    &quot;PhaseDisplayButton&quot;); //$NON-NLS-1$
<span class="nc" id="L138">            String ttKey = &quot;FiringDisplay.&quot; + cmd.getCmd() + &quot;.tooltip&quot;;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (Messages.keyExists(ttKey)) {</span>
<span class="nc" id="L140">                newButton.setToolTipText(Messages.getString(ttKey));</span>
            }
<span class="nc" id="L142">            newButton.addActionListener(this);</span>
<span class="nc" id="L143">            newButton.setActionCommand(cmd.getCmd());</span>
<span class="nc" id="L144">            newButton.setEnabled(false);</span>
<span class="nc" id="L145">            buttons.put(cmd, newButton);</span>
        }
<span class="nc" id="L147">        numButtonGroups =</span>
<span class="nc" id="L148">                (int) Math.ceil((buttons.size() + 0.0) / buttonsPerGroup);</span>

<span class="nc" id="L150">        setupButtonPanel();</span>

<span class="nc" id="L152">        butDone.addActionListener(new AbstractAction() {</span>
            private static final long serialVersionUID = -5034474968902280850L;

            public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (isIgnoringEvents()) {</span>
<span class="nc" id="L157">                    return;</span>
                }
<span class="nc bnc" id="L159" title="All 2 branches missed.">                if (clientgui.isProcessingPointblankShot()) {</span>
<span class="nc" id="L160">                    ready();</span>
                    // When the turn is ended, we could miss a key release event
                    // This will ensure no repeating keys are stuck down
<span class="nc" id="L163">                    clientgui.controller.stopAllRepeating();</span>
                }
<span class="nc" id="L165">            }</span>
        });

<span class="nc" id="L168">    }</span>

    /**
     * Register all of the &lt;code&gt;CommandAction&lt;/code&gt;s for this panel display.
     */
    protected void registerKeyCommands() {
<span class="nc" id="L174">        MegaMekController controller = clientgui.controller;</span>
<span class="nc" id="L175">        final StatusBarPhaseDisplay display = this;</span>

        // Register the action for DONE
<span class="nc" id="L178">        clientgui.controller.registerCommandAction(KeyCommandBind.DONE.cmd,</span>
<span class="nc" id="L179">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L183" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                                || !butDone.isEnabled()) {</span>
<span class="nc" id="L188">                            return false;</span>
                        } else {
<span class="nc" id="L190">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L196">                        ready();</span>
<span class="nc" id="L197">                    }</span>
                });

        // Register the action for UNDO
<span class="nc" id="L201">        controller.registerCommandAction(KeyCommandBind.UNDO.cmd,</span>
<span class="nc" id="L202">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L206" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L210">                            return false;</span>
                        } else {
<span class="nc" id="L212">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L218">                        removeLastFiring();</span>
<span class="nc" id="L219">                    }</span>
                });

        // Register the action for TWIST_LEFT
<span class="nc" id="L223">        controller.registerCommandAction(KeyCommandBind.TWIST_LEFT.cmd,</span>
<span class="nc" id="L224">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L228" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L232">                            return false;</span>
                        } else {
<span class="nc" id="L234">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L240">                        updateFlipArms(false);</span>
<span class="nc" id="L241">                        torsoTwist(0);</span>
<span class="nc" id="L242">                    }</span>
                });

        // Register the action for TWIST_RIGHT
<span class="nc" id="L246">        controller.registerCommandAction(KeyCommandBind.TWIST_RIGHT.cmd,</span>
<span class="nc" id="L247">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L251" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L255">                            return false;</span>
                        } else {
<span class="nc" id="L257">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L263">                        updateFlipArms(false);</span>
<span class="nc" id="L264">                        torsoTwist(1);</span>
<span class="nc" id="L265">                    }</span>
                });

        // Register the action for FIRE
<span class="nc" id="L269">        controller.registerCommandAction(KeyCommandBind.FIRE.cmd,</span>
<span class="nc" id="L270">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L274" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc" id="L278">                                || !buttons.get(FiringCommand.FIRE_FIRE)</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                                        .isEnabled()) {</span>
<span class="nc" id="L280">                            return false;</span>
                        } else {
<span class="nc" id="L282">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L288">                        fire();</span>
<span class="nc" id="L289">                    }</span>
                });

        // Register the action for NEXT_WEAPON
<span class="nc" id="L293">        controller.registerCommandAction(KeyCommandBind.NEXT_WEAPON.cmd,</span>
<span class="nc" id="L294">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L298" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L302">                            return false;</span>
                        } else {
<span class="nc" id="L304">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L310">                        nextWeapon();</span>
<span class="nc" id="L311">                    }</span>
                });

        // Register the action for PREV_WEAPON
<span class="nc" id="L315">        controller.registerCommandAction(KeyCommandBind.PREV_WEAPON.cmd,</span>
<span class="nc" id="L316">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L320" title="All 2 branches missed.">                        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L324">                            return false;</span>
                        } else {
<span class="nc" id="L326">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L332">                        prevWeapon();</span>
<span class="nc" id="L333">                    }</span>
                });

        // Register the action for NEXT_MODE
<span class="nc" id="L337">        controller.registerCommandAction(KeyCommandBind.NEXT_MODE.cmd,</span>
<span class="nc" id="L338">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L342" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L346">                            return false;</span>
                        } else {
<span class="nc" id="L348">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L354">                        changeMode(true);</span>
<span class="nc" id="L355">                    }</span>
                });

        // Register the action for PREV_MODE
<span class="nc" id="L359">        controller.registerCommandAction(KeyCommandBind.PREV_MODE.cmd,</span>
<span class="nc" id="L360">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L364" title="All 2 branches missed.">                        if (!clientgui.getClient().isMyTurn()</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                                || clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                                || display.isIgnoringEvents()</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                                || !display.isVisible()) {</span>
<span class="nc" id="L368">                            return false;</span>
                        } else {
<span class="nc" id="L370">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L376">                        changeMode(false);</span>
<span class="nc" id="L377">                    }</span>
                });

        // Register the action for CLEAR
<span class="nc" id="L381">        controller.registerCommandAction(KeyCommandBind.CANCEL.cmd,</span>
<span class="nc" id="L382">                new CommandAction() {</span>

                    @Override
                    public boolean shouldPerformAction() {
<span class="nc bnc" id="L386" title="All 2 branches missed.">                        if (clientgui.bv.getChatterBoxActive()</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                                || !display.isVisible()</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                                || display.isIgnoringEvents()) {</span>
<span class="nc" id="L389">                            return false;</span>
                        } else {
<span class="nc" id="L391">                            return true;</span>
                        }
                    }

                    @Override
                    public void performAction() {
<span class="nc" id="L397">                        clear();</span>
<span class="nc" id="L398">                    }</span>
                });

<span class="nc" id="L401">    }</span>

    protected ArrayList&lt;MegamekButton&gt; getButtonList() {
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (buttons == null) {</span>
<span class="nc" id="L405">            return new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L407">        ArrayList&lt;MegamekButton&gt; buttonList = new ArrayList&lt;MegamekButton&gt;();</span>
<span class="nc" id="L408">        int i = 0;</span>
<span class="nc" id="L409">        FiringCommand commands[] = FiringCommand.values();</span>
<span class="nc" id="L410">        CommandComparator comparator = new CommandComparator();</span>
<span class="nc" id="L411">        Arrays.sort(commands, comparator);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">        for (FiringCommand cmd : commands) {</span>
<span class="nc bnc" id="L413" title="All 4 branches missed.">            if (cmd == FiringCommand.FIRE_MORE</span>
                    || cmd == FiringCommand.FIRE_CANCEL) {
<span class="nc" id="L415">                continue;</span>
            }

<span class="nc" id="L418">            buttonList.add(buttons.get(cmd));</span>
<span class="nc" id="L419">            i++;</span>

<span class="nc bnc" id="L421" title="All 2 branches missed.">            if ((i + 1) % buttonsPerGroup == 0) {</span>
<span class="nc" id="L422">                buttonList.add(buttons.get(FiringCommand.FIRE_MORE));</span>
<span class="nc" id="L423">                i++;</span>
            }
        }
<span class="nc" id="L426">        if (!buttonList.get(i - 1).getActionCommand()</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                .equals(FiringCommand.FIRE_MORE.getCmd())) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            while ((i + 1) % buttonsPerGroup != 0) {</span>
<span class="nc" id="L429">                buttonList.add(null);</span>
<span class="nc" id="L430">                i++;</span>
            }
<span class="nc" id="L432">            buttonList.add(buttons.get(FiringCommand.FIRE_MORE));</span>
        }
<span class="nc" id="L434">        return buttonList;</span>
    }


    /**
     * Selects an entity, by number, for firing.
     */
    public void selectEntity(int en) {
        // clear any previously considered attacks
<span class="nc" id="L443">        clearAttacks();</span>
<span class="nc" id="L444">        refreshAll();</span>

<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (clientgui.getClient().getGame().getEntity(en) != null) {</span>
<span class="nc" id="L447">            cen = en;</span>
<span class="nc" id="L448">            clientgui.setSelectedEntityNum(en);</span>
<span class="nc" id="L449">            clientgui.mechD.displayEntity(ce());</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">            if (!ce().isOffBoard()) {</span>
<span class="nc" id="L452">                clientgui.getBoardView().highlight(ce().getPosition());</span>
            }
<span class="nc" id="L454">            clientgui.getBoardView().select(null);</span>
<span class="nc" id="L455">            clientgui.getBoardView().cursor(null);</span>

<span class="nc" id="L457">            refreshAll();</span>

<span class="nc" id="L459">            clientgui.bv.centerOnHex(ce().getPosition());</span>

            // Update the menu bar.
<span class="nc" id="L462">            clientgui.getMenuBar().setEntity(ce());</span>

            // only twist if crew conscious
<span class="nc bnc" id="L465" title="All 2 branches missed.">            setTwistEnabled(ce().canChangeSecondaryFacing()</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">                            &amp;&amp; ce().getCrew().isActive());</span>

<span class="nc" id="L468">            setFlipArmsEnabled(ce().canFlipArms());</span>
<span class="nc" id="L469">            updateSearchlight();</span>
        } else {
<span class="nc" id="L471">            System.err.println(&quot;FiringDisplay: tried to &quot; + //$NON-NLS-1$</span>
                    &quot;select non-existant entity: &quot; + en); //$NON-NLS-1$
        }

<span class="nc" id="L475">        clientgui.getBoardView().clearFiringSolutionData();</span>
<span class="nc" id="L476">    }</span>

    /**
     * Does turn start stuff
     */
    public void beginMyTurn() {
<span class="nc" id="L482">        clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L483">        clientgui.bv.clearFieldofF();</span>

<span class="nc" id="L485">        butDone.setEnabled(true);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (numButtonGroups &gt; 1)</span>
<span class="nc" id="L487">            buttons.get(FiringCommand.FIRE_MORE).setEnabled(true);</span>
<span class="nc" id="L488">        setFireCalledEnabled(clientgui.getClient().getGame().getOptions()</span>
<span class="nc" id="L489">                .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CALLED_SHOTS));</span>
<span class="nc" id="L490">        setStatusBarText(Messages</span>
<span class="nc" id="L491">                .getString(&quot;StatusBarPhaseDisplay.pointblankShot&quot;));</span>
<span class="nc" id="L492">    }</span>

    /**
     * Does end turn stuff.
     */
    protected void endMyTurn() {
        // end my turn, then.
<span class="nc" id="L499">        IGame game = clientgui.getClient().getGame();</span>
<span class="nc" id="L500">        Entity next = game.getNextEntity(game.getTurnIndex());</span>
<span class="nc bnc" id="L501" title="All 4 branches missed.">        if ((game.getPhase() == IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">            &amp;&amp; (next != null) &amp;&amp; (ce() != null)</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">            &amp;&amp; (next.getOwnerId() != ce().getOwnerId())) {</span>
<span class="nc" id="L504">            clientgui.setDisplayVisible(false);</span>
        }
<span class="nc" id="L506">        cen = Entity.NONE;</span>
<span class="nc" id="L507">        target(null);</span>
<span class="nc" id="L508">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L509">        clientgui.getBoardView().highlight(null);</span>
<span class="nc" id="L510">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L511">        clientgui.bv.clearMovementData();</span>
<span class="nc" id="L512">        clientgui.bv.clearFiringSolutionData();</span>
<span class="nc" id="L513">        clientgui.bv.clearStrafingCoords();</span>
<span class="nc" id="L514">        clientgui.bv.clearFieldofF();</span>
<span class="nc" id="L515">        clientgui.setSelectedEntityNum(Entity.NONE);</span>
<span class="nc" id="L516">        disableButtons();</span>
        // Return back to the movement phase display
<span class="nc" id="L518">        clientgui.switchPanel(IGame.Phase.PHASE_MOVEMENT);</span>
<span class="nc" id="L519">    }</span>

    /**
     * Disables all buttons in the interface
     */
    protected void disableButtons() {
<span class="nc" id="L525">        setFireEnabled(false);</span>
<span class="nc" id="L526">        setSkipEnabled(false);</span>
<span class="nc" id="L527">        setTwistEnabled(false);</span>
<span class="nc" id="L528">        buttons.get(FiringCommand.FIRE_MORE).setEnabled(false);</span>
<span class="nc" id="L529">        butDone.setEnabled(false);</span>
<span class="nc" id="L530">        setFlipArmsEnabled(false);</span>
<span class="nc" id="L531">        setFireModeEnabled(false);</span>
<span class="nc" id="L532">        setFireCalledEnabled(false);</span>
<span class="nc" id="L533">    }</span>

    /**
     * Called when the current entity is done firing. Send out our attack queue
     * to the server.
     */
    @Override
    public void ready() {
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (attacks.isEmpty()</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                &amp;&amp; GUIPreferences.getInstance().getNagForNoAction()) {</span>
            // comfirm this action
<span class="nc" id="L544">            String title = Messages</span>
<span class="nc" id="L545">                    .getString(&quot;FiringDisplay.DontFireDialog.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L546">            String body = Messages</span>
<span class="nc" id="L547">                    .getString(&quot;FiringDisplay.DontFireDialog.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L548">            ConfirmDialog response = clientgui.doYesNoBotherDialog(title, body);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (!response.getShowAgain()) {</span>
<span class="nc" id="L550">                GUIPreferences.getInstance().setNagForNoAction(false);</span>
            }
<span class="nc bnc" id="L552" title="All 2 branches missed.">            if (!response.getAnswer()) {</span>
<span class="nc" id="L553">                return;</span>
            }
        }

        // We need to nag for overheat on capital fighters
<span class="nc bnc" id="L558" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isCapitalFighter()</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getNagForOverheat()) {</span>
<span class="nc" id="L560">            int totalheat = 0;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">            for (EntityAction action : attacks) {</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">                if (action instanceof WeaponAttackAction) {</span>
<span class="nc" id="L563">                    Mounted weapon = ce().getEquipment(</span>
<span class="nc" id="L564">                            ((WeaponAttackAction) action).getWeaponId());</span>
<span class="nc" id="L565">                    totalheat += weapon.getCurrentHeat();</span>
                }
<span class="nc" id="L567">            }</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">            if (totalheat &gt; ce().getHeatCapacity()) {</span>
                // comfirm this action
<span class="nc" id="L570">                String title = Messages</span>
<span class="nc" id="L571">                        .getString(&quot;FiringDisplay.OverheatNag.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L572">                String body = Messages</span>
<span class="nc" id="L573">                        .getString(&quot;FiringDisplay.OverheatNag.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L574">                ConfirmDialog response = clientgui.doYesNoBotherDialog(title,</span>
                        body);
<span class="nc bnc" id="L576" title="All 2 branches missed.">                if (!response.getShowAgain()) {</span>
<span class="nc" id="L577">                    GUIPreferences.getInstance().setNagForOverheat(false);</span>
                }
<span class="nc bnc" id="L579" title="All 2 branches missed.">                if (!response.getAnswer()) {</span>
<span class="nc" id="L580">                    return;</span>
                }
            }
        }

        // stop further input (hopefully)
<span class="nc" id="L586">        disableButtons();</span>

        // remove temporary attacks from game &amp; board
<span class="nc" id="L589">        removeTempAttacks();</span>

        // For bug 1002223
        // Re-compute the to-hit numbers by adding in correct order.
<span class="nc" id="L593">        Vector&lt;EntityAction&gt; newAttacks = new Vector&lt;EntityAction&gt;();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">        for (EntityAction o : attacks) {</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">            if (o instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L596">                newAttacks.addElement(o);</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">            } else if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L598">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L599">                Entity attacker = waa</span>
<span class="nc" id="L600">                        .getEntity(clientgui.getClient().getGame());</span>
<span class="nc" id="L601">                Targetable target1 = waa.getTarget(clientgui.getClient()</span>
<span class="nc" id="L602">                        .getGame());</span>
<span class="nc" id="L603">                boolean curInFrontArc = Compute.isInArc(attacker.getPosition(),</span>
<span class="nc" id="L604">                        attacker.getSecondaryFacing(), target1,</span>
<span class="nc" id="L605">                        attacker.getForwardArc());</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                if (curInFrontArc) {</span>
<span class="nc" id="L607">                    WeaponAttackAction waa2 = new WeaponAttackAction(</span>
<span class="nc" id="L608">                            waa.getEntityId(), waa.getTargetType(),</span>
<span class="nc" id="L609">                            waa.getTargetId(), waa.getWeaponId());</span>
<span class="nc" id="L610">                    waa2.setAimedLocation(waa.getAimedLocation());</span>
<span class="nc" id="L611">                    waa2.setAimingMode(waa.getAimingMode());</span>
<span class="nc" id="L612">                    waa2.setOtherAttackInfo(waa.getOtherAttackInfo());</span>
<span class="nc" id="L613">                    waa2.setAmmoId(waa.getAmmoId());</span>
<span class="nc" id="L614">                    waa2.setAmmoCarrier(waa.getAmmoCarrier());</span>
<span class="nc" id="L615">                    waa2.setBombPayload(waa.getBombPayload());</span>
<span class="nc" id="L616">                    waa2.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L617">                    waa2.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L618">                    waa2.setPointblankShot(waa.isPointblankShot());</span>
<span class="nc" id="L619">                    newAttacks.addElement(waa2);</span>
                }
<span class="nc" id="L621">            } else {</span>
<span class="nc" id="L622">                newAttacks.addElement(o);</span>
            }
<span class="nc" id="L624">        }</span>
        // now add the attacks in rear/arm arcs
<span class="nc bnc" id="L626" title="All 2 branches missed.">        for (EntityAction o : attacks) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">            if (o instanceof ArtilleryAttackAction) {</span>
                // newAttacks.addElement(o);
<span class="nc" id="L629">                continue;</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">            } else if (o instanceof WeaponAttackAction) {</span>
<span class="nc" id="L631">                WeaponAttackAction waa = (WeaponAttackAction) o;</span>
<span class="nc" id="L632">                Entity attacker = waa</span>
<span class="nc" id="L633">                        .getEntity(clientgui.getClient().getGame());</span>
<span class="nc" id="L634">                Targetable target1 = waa.getTarget(clientgui.getClient()</span>
<span class="nc" id="L635">                        .getGame());</span>
<span class="nc" id="L636">                boolean curInFrontArc = Compute.isInArc(attacker.getPosition(),</span>
<span class="nc" id="L637">                        attacker.getSecondaryFacing(), target1,</span>
<span class="nc" id="L638">                        attacker.getForwardArc());</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                if (!curInFrontArc) {</span>
<span class="nc" id="L640">                    WeaponAttackAction waa2 = new WeaponAttackAction(</span>
<span class="nc" id="L641">                            waa.getEntityId(), waa.getTargetType(),</span>
<span class="nc" id="L642">                            waa.getTargetId(), waa.getWeaponId());</span>
<span class="nc" id="L643">                    waa2.setAimedLocation(waa.getAimedLocation());</span>
<span class="nc" id="L644">                    waa2.setAimingMode(waa.getAimingMode());</span>
<span class="nc" id="L645">                    waa2.setOtherAttackInfo(waa.getOtherAttackInfo());</span>
<span class="nc" id="L646">                    waa2.setAmmoId(waa.getAmmoId());</span>
<span class="nc" id="L647">                    waa2.setAmmoCarrier(waa.getAmmoCarrier());</span>
<span class="nc" id="L648">                    waa2.setBombPayload(waa.getBombPayload());</span>
<span class="nc" id="L649">                    waa2.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L650">                    waa2.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L651">                    waa2.setPointblankShot(waa.isPointblankShot());</span>
<span class="nc" id="L652">                    newAttacks.addElement(waa2);</span>
                }
            }
<span class="nc" id="L655">        }</span>
        
        // If the user picked a hex along the flight path, server needs to know
<span class="nc bnc" id="L658" title="All 4 branches missed.">        if ((target instanceof Entity) &amp;&amp; Compute.isGroundToAir(ce(), target)) {</span>
<span class="nc" id="L659">            Coords targetPos = ((Entity)target).getPlayerPickedPassThrough(cen);</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">            if (targetPos != null) {</span>
<span class="nc" id="L661">                clientgui.getClient().sendPlayerPickedPassThrough(</span>
<span class="nc" id="L662">                        ((Entity) target).getId(), cen, targetPos);</span>
            }
        }

        // send out attacks
<span class="nc" id="L667">        clientgui.getClient().sendHiddenPBSCFRResponse(newAttacks);</span>
<span class="nc" id="L668">        clientgui.setPointblankEID(Entity.NONE);</span>

        // clear queue
<span class="nc" id="L671">        attacks.removeAllElements();</span>

        // Clear the menu bar.
<span class="nc" id="L674">        clientgui.getMenuBar().setEntity(null);</span>

        // close aimed shot display, if any
<span class="nc" id="L677">        ash.closeDialog();</span>

<span class="nc bnc" id="L679" title="All 4 branches missed.">        if ((ce() != null) &amp;&amp; ce().isWeapOrderChanged()) {</span>
<span class="nc" id="L680">            clientgui.getClient().sendEntityWeaponOrderUpdate(ce());</span>
        }
<span class="nc" id="L682">        endMyTurn();</span>
<span class="nc" id="L683">    }</span>

    /**
     * Adds a weapon attack with the currently selected weapon to the attack
     * queue.
     */
    void fire() {
<span class="nc" id="L690">        final IGame game = clientgui.getClient().getGame();</span>
        // get the selected weaponnum
<span class="nc" id="L692">        final int weaponNum = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L693">        Mounted mounted = ce().getEquipment(weaponNum);</span>

        // validate
<span class="nc bnc" id="L696" title="All 4 branches missed.">        if ((ce() == null)</span>
                || (mounted == null)
<span class="nc bnc" id="L698" title="All 2 branches missed.">                || !(mounted.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L699">            throw new IllegalArgumentException(</span>
                    &quot;current fire parameters are invalid&quot;); //$NON-NLS-1$
        }

        // declare searchlight, if possible
<span class="nc bnc" id="L704" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getAutoDeclareSearchlight()</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">            &amp;&amp; ce().isUsingSpotlight()) {</span>
<span class="nc" id="L706">            doSearchlight();</span>
        }

        WeaponAttackAction waa;
<span class="nc bnc" id="L710" title="All 2 branches missed.">        if (!(mounted.getType().hasFlag(WeaponType.F_ARTILLERY)</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">                || (mounted.getType() instanceof CapitalMissileWeapon</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                        &amp;&amp; Compute.isGroundToGround(ce(), target)))) {</span>
<span class="nc" id="L713">            waa = new WeaponAttackAction(cen, target.getTargetType(),</span>
<span class="nc" id="L714">                    target.getTargetId(), weaponNum);</span>
        } else {
<span class="nc" id="L716">            waa = new ArtilleryAttackAction(cen, target.getTargetType(),</span>
<span class="nc" id="L717">                    target.getTargetId(), weaponNum, game);</span>
        }

<span class="nc bnc" id="L720" title="All 2 branches missed.">        if ((mounted.getLinked() != null)</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">                &amp;&amp; (((WeaponType) mounted.getType()).getAmmoType() != AmmoType.T_NA)</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">                &amp;&amp; (mounted.getLinked().getType() instanceof AmmoType)) {</span>
<span class="nc" id="L723">            Mounted ammoMount = mounted.getLinked();</span>
<span class="nc" id="L724">            AmmoType ammoType = (AmmoType) ammoMount.getType();</span>
<span class="nc" id="L725">            waa.setAmmoId(ammoMount.getEntity().getEquipmentNum(ammoMount));</span>
<span class="nc" id="L726">            waa.setAmmoCarrier(ammoMount.getEntity().getId());</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">            if (((ammoType.getMunitionType() == AmmoType.M_THUNDER_VIBRABOMB) </span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">                    &amp;&amp; ((ammoType.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                            || (ammoType.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">                            || (ammoType.getAmmoType() == AmmoType.T_MML)))</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">                    || (ammoType.getMunitionType() == AmmoType.M_VIBRABOMB_IV)) {</span>
<span class="nc" id="L732">                VibrabombSettingDialog vsd = new VibrabombSettingDialog(</span>
                        clientgui.frame);
<span class="nc" id="L734">                vsd.setVisible(true);</span>
<span class="nc" id="L735">                waa.setOtherAttackInfo(vsd.getSetting());</span>
<span class="nc bnc" id="L736" title="All 4 branches missed.">                waa.setHomingShot(ammoType.getMunitionType() == AmmoType.M_HOMING &amp;&amp; ammoMount.curMode().equals(&quot;Homing&quot;));</span>
            }
        }

<span class="nc bnc" id="L740" title="All 4 branches missed.">        if (ash.allowAimedShotWith(mounted) &amp;&amp; ash.inAimingMode()</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">                &amp;&amp; ash.isAimingAtLocation()) {</span>
<span class="nc" id="L742">            waa.setAimedLocation(ash.getAimingAt());</span>
<span class="nc" id="L743">            waa.setAimingMode(ash.getAimingMode());</span>
        } else {
<span class="nc" id="L745">            waa.setAimedLocation(Entity.LOC_NONE);</span>
<span class="nc" id="L746">            waa.setAimingMode(IAimingModes.AIM_MODE_NONE);</span>
        }
<span class="nc" id="L748">        waa.setPointblankShot(true);</span>

        // add the attack to our temporary queue
<span class="nc" id="L751">        attacks.addElement(waa);</span>

        // and add it into the game, temporarily
<span class="nc" id="L754">        game.addAction(waa);</span>
        
<span class="nc" id="L756">        clientgui.minimap.drawMap();</span>

        // set the weapon as used
<span class="nc" id="L759">        mounted.setUsedThisRound(true);</span>

        // find the next available weapon
<span class="nc" id="L762">        int nextWeapon = clientgui.mechD.wPan.getNextWeaponNum();</span>

        // check; if there are no ready weapons, you're done.
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if ((nextWeapon == -1)</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">            &amp;&amp; GUIPreferences.getInstance().getAutoEndFiring()) {</span>
<span class="nc" id="L767">            ready();</span>
<span class="nc" id="L768">            return;</span>
        }

        // otherwise, display firing info for the next weapon
<span class="nc" id="L772">        clientgui.mechD.wPan.displayMech(ce());</span>
<span class="nc" id="L773">        Mounted nextMounted = ce().getEquipment(nextWeapon);</span>
<span class="nc bnc" id="L774" title="All 4 branches missed.">        if (!mounted.getType().hasFlag(WeaponType.F_VGL)</span>
                &amp;&amp; (nextMounted != null)
<span class="nc bnc" id="L776" title="All 2 branches missed.">                &amp;&amp; nextMounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L777">            clientgui.mechD.wPan.setPrevTarget(target);</span>
        }
<span class="nc" id="L779">        clientgui.mechD.wPan.selectWeapon(nextWeapon);</span>
<span class="nc" id="L780">        updateTarget();</span>

<span class="nc" id="L782">    }</span>

    /**
     * Targets something
     */
    public void target(Targetable t) {
<span class="nc bnc" id="L788" title="All 2 branches missed.">        if (ce() == null) {</span>
<span class="nc" id="L789">            return;</span>
        }
<span class="nc" id="L791">        final int weaponId = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc" id="L792">        Mounted weapon = ce().getEquipment(weaponId); </span>
        // Some weapons pick an automatic target
<span class="nc bnc" id="L794" title="All 4 branches missed.">        if ((weapon != null) &amp;&amp; weapon.getType().hasFlag(WeaponType.F_VGL)) {</span>
            int facing;
<span class="nc bnc" id="L796" title="All 2 branches missed.">            if (ce().isSecondaryArcWeapon(weaponId)) {</span>
<span class="nc" id="L797">                facing = ce().getSecondaryFacing();</span>
            } else {
<span class="nc" id="L799">                facing = ce().getFacing();</span>
            }
<span class="nc" id="L801">            facing = (facing + weapon.getFacing()) % 6;</span>
<span class="nc" id="L802">            Coords c = ce().getPosition().translated(facing);</span>
<span class="nc" id="L803">            IBoard board = clientgui.getClient().getGame().getBoard();</span>
<span class="nc" id="L804">            Targetable hexTarget = </span>
                    new HexTarget(c, board, Targetable.TYPE_HEX_CLEAR);
            // Ignore events that will be generated by the select/cursor calls
<span class="nc" id="L807">            setIgnoringEvents(true);</span>
<span class="nc" id="L808">            clientgui.getBoardView().select(c);</span>
<span class="nc" id="L809">            setIgnoringEvents(false);</span>
<span class="nc" id="L810">            target = hexTarget;</span>
<span class="nc" id="L811">        } else {</span>
<span class="nc" id="L812">            target = t;</span>
        }
<span class="nc bnc" id="L814" title="All 4 branches missed.">        if ((target instanceof Entity) &amp;&amp; Compute.isGroundToAir(ce(), target)) {</span>
<span class="nc" id="L815">            Coords targetPos = Compute.getClosestFlightPath(cen, ce()</span>
<span class="nc" id="L816">                    .getPosition(), (Entity) target);</span>
<span class="nc" id="L817">            clientgui.getBoardView().cursor(targetPos);</span>
        }
<span class="nc" id="L819">        ash.setAimingMode();</span>
<span class="nc" id="L820">        updateTarget();</span>
<span class="nc" id="L821">        ash.showDialog();</span>
<span class="nc" id="L822">    }</span>

    /**
     * Targets something
     */
    public void updateTarget() {
<span class="nc" id="L828">        setFireEnabled(false);</span>
<span class="nc" id="L829">        IGame game = clientgui.getClient().getGame();</span>

        // update target panel
<span class="nc" id="L832">        final int weaponId = clientgui.mechD.wPan.getSelectedWeaponNum();</span>
<span class="nc bnc" id="L833" title="All 6 branches missed.">        if ((target != null) &amp;&amp; (target.getPosition() != null)</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">            &amp;&amp; (weaponId != -1) &amp;&amp; (ce() != null)) {</span>
            ToHitData toHit;
<span class="nc bnc" id="L836" title="All 2 branches missed.">            if (ash.inAimingMode()) {</span>
<span class="nc" id="L837">                Mounted weapon = ce().getEquipment(weaponId);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                boolean aiming = ash.isAimingAtLocation()</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                        &amp;&amp; ash.allowAimedShotWith(weapon);</span>
<span class="nc" id="L840">                ash.setEnableAll(aiming);</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">                if (aiming) {</span>
<span class="nc" id="L842">                    toHit = WeaponAttackAction.toHit(game, cen, target,</span>
<span class="nc" id="L843">                            weaponId, ash.getAimingAt(), ash.getAimingMode(),</span>
                            false, false, null, null, false, true);
<span class="nc" id="L845">                    clientgui.mechD.wPan.wTargetR.setText(target</span>
<span class="nc" id="L846">                            .getDisplayName()</span>
<span class="nc" id="L847">                            + &quot; (&quot; + ash.getAimingLocation() + &quot;)&quot;); //$NON-NLS-1$ // $NON-NLS-2$</span>
                } else {
<span class="nc" id="L849">                    toHit = WeaponAttackAction.toHit(game, cen, target,</span>
                            weaponId, Entity.LOC_NONE,
                            IAimingModes.AIM_MODE_NONE, false, false, null,
                            null, false, true);
<span class="nc" id="L853">                    clientgui.mechD.wPan.wTargetR.setText(target</span>
<span class="nc" id="L854">                            .getDisplayName());</span>
                }
<span class="nc" id="L856">                ash.setPartialCover(toHit.getCover());</span>
<span class="nc" id="L857">            } else {</span>
<span class="nc" id="L858">                toHit = WeaponAttackAction.toHit(game, cen, target, weaponId,</span>
                        Entity.LOC_NONE, IAimingModes.AIM_MODE_NONE, false,
                        false, null, null, false, true);
<span class="nc" id="L861">                clientgui.mechD.wPan.wTargetR.setText(target.getDisplayName());</span>
            }
<span class="nc" id="L863">            int effectiveDistance = Compute.effectiveDistance(</span>
<span class="nc" id="L864">                    game, ce(), target);</span>
<span class="nc" id="L865">            clientgui.mechD.wPan.wRangeR.setText(&quot;&quot; + effectiveDistance); //$NON-NLS-1$</span>
<span class="nc" id="L866">            Mounted m = ce().getEquipment(weaponId);</span>
            // If we have a Centurion Weapon System selected, we may need to
            //  update ranges.
<span class="nc bnc" id="L869" title="All 2 branches missed.">            if (m.getType().hasFlag(WeaponType.F_CWS)) {</span>
<span class="nc" id="L870">                clientgui.mechD.wPan.selectWeapon(weaponId);</span>
            }
<span class="nc bnc" id="L872" title="All 2 branches missed.">            if (m.isUsedThisRound()) {</span>
<span class="nc" id="L873">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L874">                        .getString(&quot;FiringDisplay.alreadyFired&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L875">                setFireEnabled(false);</span>
<span class="nc bnc" id="L876" title="All 4 branches missed.">            } else if ((m.getType().hasFlag(WeaponType.F_AUTO_TARGET) &amp;&amp; !m.curMode().equals(Weapon.MODE_AMS_MANUAL))) {</span>
<span class="nc" id="L877">                clientgui.mechD.wPan.wToHitR.setText(Messages</span>
<span class="nc" id="L878">                        .getString(&quot;FiringDisplay.autoFiringWeapon&quot;));</span>
                //$NON-NLS-1$
<span class="nc" id="L880">                setFireEnabled(false);</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">            } else if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L882">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString());</span>
<span class="nc" id="L883">                setFireEnabled(false);</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">            } else if (toHit.getValue() == TargetRoll.AUTOMATIC_FAIL) {</span>
<span class="nc" id="L885">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString());</span>
<span class="nc" id="L886">                setFireEnabled(true);</span>
            } else {
<span class="nc" id="L888">                boolean natAptGunnery = ce().hasAbility(OptionsConstants.PILOT_APTITUDE_GUNNERY);</span>
<span class="nc" id="L889">                clientgui.mechD.wPan.wToHitR.setText(toHit.getValueAsString()</span>
                        + &quot; (&quot;
<span class="nc" id="L891">                        + Compute.oddsAbove(toHit.getValue(), natAptGunnery)</span>
                        + &quot;%)&quot;); //$NON-NLS-1$
                // $NON-NLS-2$
<span class="nc" id="L894">                setFireEnabled(true);</span>
            }
<span class="nc" id="L896">            clientgui.mechD.wPan.toHitText.setText(toHit.getDesc());</span>
<span class="nc" id="L897">            setSkipEnabled(true);</span>
<span class="nc" id="L898">        } else {</span>
<span class="nc" id="L899">            clientgui.mechD.wPan.wTargetR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L900">            clientgui.mechD.wPan.wRangeR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L901">            clientgui.mechD.wPan.wToHitR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L902">            clientgui.mechD.wPan.toHitText.setText(&quot;&quot;); //$NON-NLS-1$</span>
        }

<span class="nc bnc" id="L905" title="All 4 branches missed.">        if ((weaponId != -1) &amp;&amp; (ce() != null)) {</span>
<span class="nc" id="L906">            Mounted m = ce().getEquipment(weaponId);</span>
<span class="nc" id="L907">            setFireModeEnabled(m.isModeSwitchable());</span>
        }

<span class="nc" id="L910">        updateSearchlight();</span>
<span class="nc" id="L911">    }</span>

    //
    // BoardListener
    //
    @Override
    public void hexMoused(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L920" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L921">            return;</span>
        }

        // ignore buttons other than 1
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (!clientgui.isProcessingPointblankShot()</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.BUTTON1_MASK) == 0)) {</span>
<span class="nc" id="L927">            return;</span>
        }
        // control pressed means a line of sight check.
        // added ALT_MASK by kenn
<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (((b.getModifiers() &amp; InputEvent.CTRL_MASK) != 0)</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">            || ((b.getModifiers() &amp; InputEvent.ALT_MASK) != 0)) {</span>
<span class="nc" id="L933">            return;</span>
        }
        // check for shifty goodness
<span class="nc bnc" id="L936" title="All 4 branches missed.">        if (shiftheld != ((b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0)) {</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">            shiftheld = (b.getModifiers() &amp; InputEvent.SHIFT_MASK) != 0;</span>
        }

<span class="nc bnc" id="L940" title="All 2 branches missed.">        if (b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) {</span>
<span class="nc bnc" id="L941" title="All 4 branches missed.">            if (shiftheld || twisting) {</span>
<span class="nc" id="L942">                updateFlipArms(false);</span>
<span class="nc" id="L943">                torsoTwist(b.getCoords());</span>
            }
<span class="nc" id="L945">            clientgui.getBoardView().cursor(b.getCoords());</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">        } else if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</span>
<span class="nc" id="L947">            twisting = false;</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">            if (!shiftheld) {</span>
<span class="nc" id="L949">                clientgui.getBoardView().select(b.getCoords());</span>
            }
        }
<span class="nc" id="L952">    }</span>

    @Override
    public void hexSelected(BoardViewEvent b) {

        // Are we ignoring events?
<span class="nc bnc" id="L958" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L959">            return;</span>
        }

<span class="nc" id="L962">        Coords evtCoords = b.getCoords();</span>
<span class="nc bnc" id="L963" title="All 4 branches missed.">        if (clientgui.isProcessingPointblankShot() &amp;&amp; (evtCoords != null)</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">            &amp;&amp; (ce() != null)) {</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">            if (!evtCoords.equals(ce().getPosition())){</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">                if (shiftheld) {</span>
<span class="nc" id="L967">                    updateFlipArms(false);</span>
<span class="nc" id="L968">                    torsoTwist(b.getCoords());</span>
                }
            }
        }
<span class="nc" id="L972">    }</span>

    //
    // GameListener
    //
    @Override
    public void gameTurnChange(GameTurnChangeEvent e) {
<span class="nc" id="L979">    }</span>

    @Override
    public void gamePhaseChange(GamePhaseChangeEvent e) {
<span class="nc" id="L983">    }</span>

    //
    // ActionListener
    //
    public void actionPerformed(ActionEvent ev) {
        // Are we ignoring events?
<span class="nc bnc" id="L990" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L991">            return;</span>
        }

<span class="nc bnc" id="L994" title="All 2 branches missed.">        if (statusBarActionPerformed(ev, clientgui.getClient())) {</span>
<span class="nc" id="L995">            return;</span>
        }

<span class="nc bnc" id="L998" title="All 2 branches missed.">        if (!clientgui.isProcessingPointblankShot()) {</span>
<span class="nc" id="L999">            return;</span>
        }

<span class="nc bnc" id="L1002" title="All 2 branches missed.">        if (ev.getActionCommand().equals(FiringCommand.FIRE_FIRE.getCmd())) {</span>
<span class="nc" id="L1003">            fire();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_SKIP.getCmd())) {</span>
<span class="nc" id="L1005">            nextWeapon();</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_TWIST.getCmd())) {</span>
<span class="nc" id="L1007">            twisting = true;</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_MORE.getCmd())) {</span>
<span class="nc" id="L1009">            currentButtonGroup++;</span>
<span class="nc" id="L1010">            currentButtonGroup %= numButtonGroups;</span>
<span class="nc" id="L1011">            setupButtonPanel();</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_FLIP_ARMS.getCmd())) {</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">            updateFlipArms(!ce().getArmsFlipped());</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_MODE.getCmd())) {</span>
<span class="nc" id="L1015">            changeMode(true);</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">        } else if (ev.getActionCommand().equals(FiringCommand.FIRE_CALLED.getCmd())) {</span>
<span class="nc" id="L1017">            changeCalled();</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">        } else if ((&quot;changeSinks&quot;.equalsIgnoreCase(ev.getActionCommand()))</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">                   || (ev.getActionCommand().equals(FiringCommand.FIRE_CANCEL.getCmd()))) {</span>
<span class="nc" id="L1020">            clear();</span>
        }
<span class="nc" id="L1022">    }</span>

    protected void setFireEnabled(boolean enabled) {
<span class="nc" id="L1025">        buttons.get(FiringCommand.FIRE_FIRE).setEnabled(enabled);</span>
<span class="nc" id="L1026">        clientgui.getMenuBar().setFireFireEnabled(enabled);</span>
<span class="nc" id="L1027">    }</span>

    protected void setTwistEnabled(boolean enabled) {
<span class="nc" id="L1030">        buttons.get(FiringCommand.FIRE_TWIST).setEnabled(enabled);</span>
<span class="nc" id="L1031">        clientgui.getMenuBar().setFireTwistEnabled(enabled);</span>
<span class="nc" id="L1032">    }</span>

    protected void setSkipEnabled(boolean enabled) {
<span class="nc" id="L1035">        buttons.get(FiringCommand.FIRE_SKIP).setEnabled(enabled);</span>
<span class="nc" id="L1036">        clientgui.getMenuBar().setFireSkipEnabled(enabled);</span>
<span class="nc" id="L1037">    }</span>

    protected void setFlipArmsEnabled(boolean enabled) {
<span class="nc" id="L1040">        buttons.get(FiringCommand.FIRE_FLIP_ARMS).setEnabled(enabled);</span>
<span class="nc" id="L1041">        clientgui.getMenuBar().setFireFlipArmsEnabled(enabled);</span>
<span class="nc" id="L1042">    }</span>

    protected void setSearchlightEnabled(boolean enabled) {
<span class="nc" id="L1045">        buttons.get(FiringCommand.FIRE_SEARCHLIGHT).setEnabled(enabled);</span>
<span class="nc" id="L1046">        clientgui.getMenuBar().setFireSearchlightEnabled(enabled);</span>
<span class="nc" id="L1047">    }</span>

    protected void setFireModeEnabled(boolean enabled) {
<span class="nc" id="L1050">        buttons.get(FiringCommand.FIRE_MODE).setEnabled(enabled);</span>
<span class="nc" id="L1051">        clientgui.getMenuBar().setFireModeEnabled(enabled);</span>
<span class="nc" id="L1052">    }</span>

    protected void setFireCalledEnabled(boolean enabled) {
<span class="nc" id="L1055">        buttons.get(FiringCommand.FIRE_CALLED).setEnabled(enabled);</span>
<span class="nc" id="L1056">        clientgui.getMenuBar().setFireCalledEnabled(enabled);</span>
<span class="nc" id="L1057">    }</span>

    @Override
    public void clear() {
<span class="nc bnc" id="L1061" title="All 2 branches missed.">        if ((target instanceof Entity) </span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">                &amp;&amp; Compute.isGroundToAir(ce(), target)) {</span>
<span class="nc" id="L1063">            ((Entity)target).setPlayerPickedPassThrough(cen, null);</span>
        }
<span class="nc" id="L1065">        clearAttacks();        </span>
<span class="nc" id="L1066">        clientgui.getBoardView().select(null);</span>
<span class="nc" id="L1067">        clientgui.getBoardView().cursor(null);</span>
<span class="nc" id="L1068">        refreshAll();</span>
<span class="nc" id="L1069">    }</span>

    //
    // ItemListener
    //
    public void itemStateChanged(ItemEvent ev) {

        // Are we ignoring events?
<span class="nc bnc" id="L1077" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1078">            return;</span>
        }
<span class="nc" id="L1080">    }</span>

    // board view listener
    @Override
    public void finishedMovingUnits(BoardViewEvent b) {
        // Are we ignoring events?
<span class="nc bnc" id="L1086" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1087">            return;</span>
        }

<span class="nc bnc" id="L1090" title="All 4 branches missed.">        if (clientgui.isProcessingPointblankShot() &amp;&amp; (ce() != null)) {</span>
<span class="nc" id="L1091">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L1092">            clientgui.bv.centerOnHex(ce().getPosition());</span>
        }
<span class="nc" id="L1094">    }</span>

    @Override
    public void unitSelected(BoardViewEvent b) {
        // Are we ignoring events?
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        if (isIgnoringEvents()) {</span>
<span class="nc" id="L1100">            return;</span>
        }

<span class="nc" id="L1103">        Entity e = clientgui.getClient().getGame().getEntity(b.getEntityId());</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">        if (clientgui.getPointblankEID() == e.getId()) {</span>
<span class="nc" id="L1105">            selectEntity(e.getId());</span>
        } else {
<span class="nc" id="L1107">            clientgui.setDisplayVisible(true);</span>
<span class="nc" id="L1108">            clientgui.mechD.displayEntity(e);</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">            if (e.isDeployed()) {</span>
<span class="nc" id="L1110">                clientgui.bv.centerOnHex(e.getPosition());</span>
            }
        }
<span class="nc" id="L1113">    }</span>

    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L1117">            return;</span>
        }
<span class="nc bnc" id="L1119" title="All 2 branches missed.">        if (event.getSource().equals(clientgui.mechD.wPan.weaponList)) {</span>
            // update target data in weapon display
<span class="nc" id="L1121">            updateTarget();</span>
        }
<span class="nc" id="L1123">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>