<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Tank.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">megamek</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Tank.java</span></div><h1>Tank.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000-2003 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */
package megamek.common;

import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.Vector;

import megamek.MegaMek;
import megamek.common.options.OptionsConstants;
import megamek.common.verifier.SupportVeeStructure;
import megamek.common.verifier.TestEntity;
import megamek.common.weapons.flamers.VehicleFlamerWeapon;
import megamek.common.weapons.lasers.CLChemicalLaserWeapon;

/**
 * You know what tanks are, silly.
 */
<span class="nc" id="L36">public class Tank extends Entity {</span>
    private static final long serialVersionUID = -857210851169206264L;
<span class="nc" id="L38">    protected boolean m_bHasNoTurret = false;</span>
<span class="nc" id="L39">    protected boolean m_bTurretLocked = false;</span>
<span class="nc" id="L40">    protected boolean m_bTurretJammed = false;</span>
<span class="nc" id="L41">    protected boolean m_bTurretEverJammed = false;</span>
<span class="nc" id="L42">    protected boolean m_bHasNoDualTurret = false;</span>
<span class="nc" id="L43">    protected boolean m_bDualTurretLocked = false;</span>
<span class="nc" id="L44">    protected boolean m_bDualTurretJammed = false;</span>
<span class="nc" id="L45">    protected boolean m_bDualTurretEverJammed = false;</span>
<span class="nc" id="L46">    private int m_nTurretOffset = 0;</span>
<span class="nc" id="L47">    private int m_nDualTurretOffset = 0;</span>
<span class="nc" id="L48">    private int m_nStunnedTurns = 0;</span>
<span class="nc" id="L49">    private boolean m_bImmobile = false;</span>
<span class="nc" id="L50">    private boolean m_bImmobileHit = false;</span>
<span class="nc" id="L51">    private int burningLocations = 0;</span>
<span class="nc" id="L52">    private boolean m_bBackedIntoHullDown = false;</span>
<span class="nc" id="L53">    protected int motivePenalty = 0;</span>
<span class="nc" id="L54">    protected int motiveDamage = 0;</span>
<span class="nc" id="L55">    private boolean minorMovementDamage = false;</span>
<span class="nc" id="L56">    private boolean moderateMovementDamage = false;</span>
<span class="nc" id="L57">    private boolean heavyMovementDamage = false;</span>
<span class="nc" id="L58">    private boolean infernoFire = false;</span>
<span class="nc" id="L59">    private ArrayList&lt;Mounted&gt; jammedWeapons = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L60">    protected boolean engineHit = false;</span>

    // locations
    public static final int LOC_BODY = 0;
    public static final int LOC_FRONT = 1;
    public static final int LOC_RIGHT = 2;
    public static final int LOC_LEFT = 3;
    public static final int LOC_REAR = 4;
    /** for dual turret tanks, this is the rear turret **/
    public static final int LOC_TURRET = 5;
    /** for dual turret tanks, this is the front turret **/
    public static final int LOC_TURRET_2 = 6;

    // critical hits
    public static final int CRIT_NONE = -1;
    public static final int CRIT_DRIVER = 0;
    public static final int CRIT_WEAPON_JAM = 1;
    public static final int CRIT_WEAPON_DESTROYED = 2;
    public static final int CRIT_STABILIZER = 3;
    public static final int CRIT_SENSOR = 4;
    public static final int CRIT_COMMANDER = 5;
    public static final int CRIT_CREW_KILLED = 6;
    public static final int CRIT_CREW_STUNNED = 7;
    public static final int CRIT_CARGO = 8;
    public static final int CRIT_ENGINE = 9;
    public static final int CRIT_FUEL_TANK = 10;
    public static final int CRIT_AMMO = 11;
    public static final int CRIT_TURRET_JAM = 12;
    public static final int CRIT_TURRET_LOCK = 13;
    public static final int CRIT_TURRET_DESTROYED = 14;

    // tanks have no critical slot limitations
<span class="fc" id="L92">    private static final int[] NUM_OF_SLOTS = { 25, 25, 25, 25, 25, 25, 25 };</span>

<span class="fc" id="L94">    private static String[] LOCATION_ABBRS = { &quot;BD&quot;, &quot;FR&quot;, &quot;RS&quot;, &quot;LS&quot;, &quot;RR&quot;,</span>
            &quot;TU&quot;, &quot;FT&quot; };
<span class="fc" id="L96">    private static String[] LOCATION_NAMES = { &quot;Body&quot;, &quot;Front&quot;, &quot;Right&quot;,</span>
            &quot;Left&quot;, &quot;Rear&quot;, &quot;Turret&quot; };

<span class="fc" id="L99">    private static String[] LOCATION_NAMES_DUAL_TURRET = { &quot;Body&quot;, &quot;Front&quot;,</span>
            &quot;Right&quot;, &quot;Left&quot;, &quot;Rear&quot;, &quot;Rear Turret&quot;, &quot;Front Turret&quot; };

    @Override
    public int getUnitType() {
<span class="nc" id="L104">        EntityMovementMode mm = getMovementMode();</span>
<span class="nc bnc" id="L105" title="All 6 branches missed.">        return (mm == EntityMovementMode.NAVAL) || (mm == EntityMovementMode.HYDROFOIL) || (mm == EntityMovementMode.SUBMARINE)</span>
<span class="nc" id="L106">             ? UnitType.NAVAL</span>
<span class="nc" id="L107">             : UnitType.TANK;</span>
    }

    @Override
    public String[] getLocationAbbrs() {
<span class="nc" id="L112">        return LOCATION_ABBRS;</span>
    }

    @Override
    public String[] getLocationNames() {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L118">            return LOCATION_NAMES_DUAL_TURRET;</span>
        }
<span class="nc" id="L120">        return LOCATION_NAMES;</span>
    }

    public int getLocTurret() {
<span class="nc" id="L124">        return LOC_TURRET;</span>
    }

    public int getLocTurret2() {
<span class="nc" id="L128">        return LOC_TURRET_2;</span>
    }

<span class="nc" id="L131">    private int sensorHits = 0;</span>
<span class="nc" id="L132">    private int stabiliserHits = 0;</span>
<span class="nc" id="L133">    private boolean driverHit = false;</span>
<span class="nc" id="L134">    private boolean commanderHit = false;</span>
    //If there is a cockpit command console, the tank does not suffer the effects of the first commander critical,
    //but the command console benefits are lost as the backup has to take command.
<span class="nc" id="L137">    private boolean usingConsoleCommander = false;</span>
    /** Vehicles can be constructed with seating for additional crew. This has no effect on play */
<span class="nc" id="L139">    private int extraCrewSeats = 0;</span>

    // set up some vars for what the critical effects would be
<span class="nc" id="L142">    private int potCrit = CRIT_NONE;</span>
<span class="nc" id="L143">    private boolean overThresh = false;</span>

    // pain-shunted units can take two driver and commander hits and two hits
    // before being killed
<span class="nc" id="L147">    private boolean driverHitPS = false;</span>
<span class="nc" id="L148">    private boolean commanderHitPS = false;</span>
<span class="nc" id="L149">    private boolean crewHitPS = false;</span>

    /**
     * Keeps track of the base weight of the turret for omni tanks.
     */
    public static final int BASE_CHASSIS_TURRET_WT_UNASSIGNED = -1;
<span class="nc" id="L155">    private double baseChassisTurretWeight = BASE_CHASSIS_TURRET_WT_UNASSIGNED;</span>
<span class="nc" id="L156">    private double baseChassisTurret2Weight = BASE_CHASSIS_TURRET_WT_UNASSIGNED;</span>
<span class="nc" id="L157">    private double baseChassisSponsonPintleWeight = BASE_CHASSIS_TURRET_WT_UNASSIGNED;</span>

    /**
     * Flag to indicate unit is constructed as a trailer. Trailers do not require
     * control systems or engines unless they are intended for independent operation.
     */
<span class="nc" id="L163">    private boolean trailer = false;</span>
    /**
     * Keeps track of whether this vehicle has control systems.  Trailers aren't
     * required to have control systems.
     */
<span class="nc" id="L168">    private boolean hasNoControlSystems = false;</span>

    /**
     * Alternate fuel for ICEs that affects operating range
     */
<span class="nc" id="L173">    private FuelType fuelType = FuelType.PETROCHEMICALS;</span>

    public CrewType defaultCrewType() {
<span class="nc" id="L176">        return CrewType.CREW;</span>
    }

    public int getPotCrit() {
<span class="nc" id="L180">        return potCrit;</span>
    }

    public void setPotCrit(int crit) {
<span class="nc" id="L184">        potCrit = crit;</span>
<span class="nc" id="L185">    }</span>

    public boolean getOverThresh() {
<span class="nc" id="L188">        return overThresh;</span>
    }

    public void setOverThresh(boolean tf) {
<span class="nc" id="L192">        overThresh = tf;</span>
<span class="nc" id="L193">    }</span>

    public boolean hasNoTurret() {
<span class="nc" id="L196">        return m_bHasNoTurret;</span>
    }

    public boolean hasNoDualTurret() {
<span class="nc" id="L200">        return m_bHasNoDualTurret;</span>
    }

    public void setHasNoTurret(boolean b) {
<span class="nc" id="L204">        m_bHasNoTurret = b;</span>
<span class="nc" id="L205">    }</span>

    public void setHasNoDualTurret(boolean b) {
<span class="nc" id="L208">        m_bHasNoDualTurret = b;</span>
<span class="nc" id="L209">    }</span>

    public int getMotiveDamage() {
<span class="nc" id="L212">        return motiveDamage;</span>
    }

    public void setMotiveDamage(int d) {
<span class="nc" id="L216">        motiveDamage = d;</span>
<span class="nc" id="L217">    }</span>

    public int getMotivePenalty() {
<span class="nc" id="L220">        return motivePenalty;</span>
    }

    public void setMotivePenalty(int p) {
<span class="nc" id="L224">        motivePenalty = p;</span>
<span class="nc" id="L225">    }</span>
    
<span class="fc" id="L227">    private static final TechAdvancement TA_COMBAT_VEHICLE = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="fc" id="L228">            .setAdvancement(DATE_NONE, 2470, 2490).setProductionFactions(F_TH)</span>
<span class="fc" id="L229">            .setTechRating(RATING_E).setAvailability(RATING_C, RATING_C, RATING_C, RATING_B)</span>
<span class="fc" id="L230">            .setStaticTechLevel(SimpleTechLevel.INTRO);</span>
    
    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="nc" id="L234">        return TA_COMBAT_VEHICLE;</span>
    }
    
    //Advanced turrets
    public static TechAdvancement getDualTurretTA() {
<span class="nc" id="L239">        return new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L240">                .setAdvancement(DATE_PS, 3080, 3080).setApproximate(false, true, false)</span>
<span class="nc" id="L241">                .setTechRating(RATING_B).setAvailability(RATING_F, RATING_F, RATING_F, RATING_E)</span>
<span class="nc" id="L242">                .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL);</span>
    }

    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<span class="nc" id="L246">        super.addSystemTechAdvancement(ctl);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L248">            ctl.addComponent(getDualTurretTA());</span>
        }
<span class="nc" id="L250">    }</span>
    
    /**
     * Returns this entity's walking/cruising mp, factored for heat, extreme
     * temperatures, and gravity.
     */
    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat) {
<span class="nc" id="L258">        return getWalkMP(gravity, ignoreheat, false);</span>
    }

    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc" id="L264">        int j = getOriginalWalkMP();</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">        if (engineHit || isImmobile()) {</span>
<span class="nc" id="L266">            return 0;</span>
        }
<span class="nc" id="L268">        j = Math.max(0, j - motiveDamage);</span>
<span class="nc" id="L269">        j = Math.max(0, j - getCargoMpReduction(this));</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L271">            int weatherMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L272">                    .getMovementMods(this);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L274">                j = Math.max(j + weatherMod, 0);</span>
            }
        }

<span class="nc bnc" id="L278" title="All 4 branches missed.">        if (!ignoremodulararmor &amp;&amp; hasModularArmor()) {</span>
<span class="nc" id="L279">            j--;</span>
        }
<span class="nc bnc" id="L281" title="All 4 branches missed.">        if (hasWorkingMisc(MiscType.F_DUNE_BUGGY) &amp;&amp; (game != null)) {</span>
<span class="nc" id="L282">            j--;</span>
        }

<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L286">            j = applyGravityEffectsOnMP(j);</span>
        }
        
        //If the unit is towing trailers, adjust its walkMP, TW p205
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (!getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L291">            double trainWeight = getWeight();</span>
<span class="nc" id="L292">            int lowestSuspensionFactor = getSuspensionFactor();</span>
            //Add up the trailers
<span class="nc bnc" id="L294" title="All 2 branches missed.">            for (int id : getAllTowedUnits()) {</span>
<span class="nc" id="L295">                Entity tr = game.getEntity(id);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (tr == null) {</span>
                    //this isn't supposed to happen, but it can in rare cases when tr is destroyed
<span class="nc" id="L298">                    continue;</span>
                }
<span class="nc bnc" id="L300" title="All 2 branches missed.">                if (tr instanceof Tank) {</span>
<span class="nc" id="L301">                    Tank trailer = (Tank) tr;</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                    if (trailer.getSuspensionFactor() &lt; lowestSuspensionFactor) {</span>
<span class="nc" id="L303">                        lowestSuspensionFactor = trailer.getSuspensionFactor();</span>
                    }
                }
<span class="nc" id="L306">                trainWeight += tr.getWeight();</span>
<span class="nc" id="L307">            }</span>
<span class="nc" id="L308">            j = (int) ((getEngine().getRating() + lowestSuspensionFactor) / trainWeight);</span>
        }

<span class="nc" id="L311">        return j;</span>

    }
    
    @Override
    public boolean isEligibleForPavementBonus() {
<span class="nc bnc" id="L317" title="All 4 branches missed.">        return movementMode == EntityMovementMode.TRACKED || movementMode == EntityMovementMode.WHEELED;</span>
    }

    public boolean isTurretLocked(int turret) {
<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc bnc" id="L322" title="All 4 branches missed.">            return m_bTurretLocked || m_bTurretJammed;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc bnc" id="L324" title="All 4 branches missed.">            return m_bDualTurretLocked || m_bDualTurretJammed;</span>
        }
<span class="nc" id="L326">        return false;</span>
    }

    public boolean isTurretJammed(int turret) {
        // this is rather a hack but the only idea I came up with.
        // for the first time this is checked. If this is a partially repaired
        // turret it will be jammed.
        // so just set it to jammed and change the partial repair value to
        // false.

<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (getPartialRepairs().booleanOption(&quot;veh_locked_turret&quot;)) {</span>
<span class="nc" id="L337">            m_bTurretJammed = true;</span>
<span class="nc" id="L338">            m_bDualTurretJammed = true;</span>
<span class="nc" id="L339">            getPartialRepairs().getOption(&quot;veh_locked_turret&quot;).setValue(false);</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L342">            return m_bTurretJammed;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L344">            return m_bDualTurretJammed;</span>
        }
<span class="nc" id="L346">        return false;</span>
    }

    /**
     * Returns the number of locations in the entity
     */
    @Override
    public int locations() {
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (m_bHasNoDualTurret) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            return m_bHasNoTurret ? 5 : 6;</span>
        }
<span class="nc" id="L357">        return 7;</span>
    }
    
    @Override
    public int getBodyLocation() {
<span class="nc" id="L362">        return LOC_BODY;</span>
    }

    @Override
    public boolean canChangeSecondaryFacing() {
<span class="nc bnc" id="L367" title="All 4 branches missed.">        return !m_bHasNoTurret &amp;&amp; !isTurretLocked(getLocTurret());</span>
    }

    @Override
    public boolean isValidSecondaryFacing(int n) {
<span class="nc bnc" id="L372" title="All 2 branches missed.">        return !isTurretLocked(getLocTurret());</span>
    }

    @Override
    public int clipSecondaryFacing(int n) {
<span class="nc" id="L377">        return n;</span>
    }

    @Override
    public void setSecondaryFacing(int sec_facing) {
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (!isTurretLocked(getLocTurret())) {</span>
<span class="nc" id="L383">            super.setSecondaryFacing(sec_facing);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            if (!m_bHasNoTurret) {</span>
<span class="nc" id="L385">                m_nTurretOffset = sec_facing - getFacing();</span>
            }
        }
<span class="nc" id="L388">    }</span>

    @Override
    public void setFacing(int facing) {
<span class="nc" id="L392">        super.setFacing(facing);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if (isTurretLocked(getLocTurret())) {</span>
<span class="nc" id="L394">            int nTurretFacing = (facing + m_nTurretOffset + 6) % 6;</span>
<span class="nc" id="L395">            super.setSecondaryFacing(nTurretFacing);</span>
        }
<span class="nc" id="L397">    }</span>

    public int getDualTurretFacing() {
<span class="nc" id="L400">        return (facing + m_nDualTurretOffset + 6) % 6;</span>
    }

    public void setDualTurretOffset(int offset) {
<span class="nc" id="L404">        m_nDualTurretOffset = offset;</span>
<span class="nc" id="L405">    }</span>

    public boolean isStabiliserHit(int loc) {
<span class="nc bnc" id="L408" title="All 2 branches missed.">        return (stabiliserHits &amp; (1 &lt;&lt; loc)) == (1 &lt;&lt; loc);</span>
    }

    public void setStabiliserHit(int loc) {
<span class="nc" id="L412">        stabiliserHits |= (1 &lt;&lt; loc);</span>
<span class="nc" id="L413">    }</span>

    public void clearStabiliserHit(int loc) {
<span class="nc" id="L416">        stabiliserHits &amp;= ~(1 &lt;&lt; loc);</span>
<span class="nc" id="L417">    }</span>

    public int getSensorHits() {
<span class="nc" id="L420">        return sensorHits;</span>
    }

    public void setSensorHits(int hits) {
<span class="nc" id="L424">        sensorHits = hits;</span>
<span class="nc" id="L425">    }</span>

    public boolean isDriverHit() {
<span class="nc" id="L428">        return driverHit;</span>
    }

    public void setDriverHit(boolean hit) {
<span class="nc" id="L432">        driverHit = hit;</span>
<span class="nc" id="L433">    }</span>

    public boolean isCommanderHit() {
<span class="nc" id="L436">        return commanderHit;</span>
    }

    public void setCommanderHit(boolean hit) {
<span class="nc" id="L440">        commanderHit = hit;</span>
<span class="nc" id="L441">    }</span>
    
    public boolean isUsingConsoleCommander() {
<span class="nc" id="L444">        return usingConsoleCommander;</span>
    }
    
    public void setUsingConsoleCommander(boolean b) {
<span class="nc" id="L448">        usingConsoleCommander = b;</span>
<span class="nc" id="L449">    }</span>

    /**
     * @return Additional seats beyond the minimum crew requirements
     */
    public int getExtraCrewSeats() {
<span class="nc" id="L455">        return extraCrewSeats;</span>
    }

    public void setExtraCrewSeats(int seats) {
<span class="nc" id="L459">        this.extraCrewSeats = seats;</span>
<span class="nc" id="L460">    }</span>

    public boolean isDriverHitPS() {
<span class="nc" id="L463">        return driverHitPS;</span>
    }

    public void setDriverHitPS(boolean hit) {
<span class="nc" id="L467">        driverHitPS = hit;</span>
<span class="nc" id="L468">    }</span>

    public boolean isCommanderHitPS() {
<span class="nc" id="L471">        return commanderHitPS;</span>
    }

    public void setCommanderHitPS(boolean hit) {
<span class="nc" id="L475">        commanderHitPS = hit;</span>
<span class="nc" id="L476">    }</span>

    public boolean isCrewHitPS() {
<span class="nc" id="L479">        return crewHitPS;</span>
    }

    public void setCrewHitPS(boolean hit) {
<span class="nc" id="L483">        crewHitPS = hit;</span>
<span class="nc" id="L484">    }</span>

    public boolean isMovementHit() {
<span class="nc" id="L487">        return m_bImmobile;</span>
    }

    public boolean isMovementHitPending() {
<span class="nc" id="L491">        return m_bImmobileHit;</span>
    }

    /**
     * Marks this tank for immobilization, most likely from a related motive
     * system hit. To &lt;em&gt;actually&lt;/em&gt; immobilize it, {@link #applyDamage()}
     * must also be invoked; until then, {@link #isMovementHitPending()} will
     * return true after this but neither {@link #isMovementHit()} nor
     * {@link #isImmobile()} will have been updated yet (because the tank is
     * technically not immobile just &lt;em&gt;yet&lt;/em&gt; until damage is actually
     * resolved).
     */
    public void immobilize() {
<span class="nc" id="L504">        m_bImmobileHit = true;</span>
<span class="nc" id="L505">    }</span>

    @Override
    public boolean isImmobile(boolean checkCrew) {
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if ((game != null)</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_IMMOBILE_VEHICLES)) {</span>
<span class="nc" id="L511">            return super.isImmobile(checkCrew);</span>
        }
        //Towed trailers need to reference the tractor, or they return Immobile due to 0 MP...
        //We do run into some double-blind entityList differences though, so include a null check
<span class="nc bnc" id="L515" title="All 4 branches missed.">        if (isTrailer() &amp;&amp; (getTractor() != Entity.NONE)) {</span>
<span class="nc bnc" id="L516" title="All 6 branches missed.">            return (game.getEntity(getTractor()) != null ? game.getEntity(getTractor()).isImmobile(checkCrew) : super.isImmobile(checkCrew) || m_bImmobile);</span>
        }
<span class="nc bnc" id="L518" title="All 4 branches missed.">        return m_bImmobile || super.isImmobile(checkCrew);</span>
    }
    
    /**
     * Whether this unit is irreversibly immobilized for the rest of the game.
     * Tanks have some additional criteria.
     */
    @Override
    public boolean isPermanentlyImmobilized(boolean checkCrew) {
<span class="nc bnc" id="L527" title="All 4 branches missed.">        return super.isPermanentlyImmobilized(checkCrew) || isMovementHit();</span>
    }
    
    @Override
    public boolean hasCommandConsoleBonus() {
<span class="nc bnc" id="L532" title="All 6 branches missed.">        if (!hasWorkingMisc(MiscType.F_COMMAND_CONSOLE) || isCommanderHit() || isUsingConsoleCommander()) {</span>
<span class="nc" id="L533">            return false;</span>
        }
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">            return getWeightClass() &gt;= EntityWeightClass.WEIGHT_LARGE_SUPPORT</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                    &amp;&amp; hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL);</span>
        } else {
<span class="nc bnc" id="L539" title="All 2 branches missed.">            return getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY;</span>
        }
    }


    /**
     * Tanks have all sorts of prohibited terrain.
     */
    @Override
    public boolean isLocationProhibited(Coords c, int currElevation) {
<span class="nc" id="L549">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.IMPASSABLE)) {</span>
<span class="nc" id="L551">            return true;</span>
        }

<span class="nc bnc" id="L554" title="All 4 branches missed.">        if (hex.containsTerrain(Terrains.SPACE) &amp;&amp; doomedInSpace()) {</span>
<span class="nc" id="L555">            return true;</span>
        }

        // Additional restrictions for hidden units
<span class="nc bnc" id="L559" title="All 2 branches missed.">        if (isHidden()) {</span>
            // Can't deploy in paved hexes
<span class="nc bnc" id="L561" title="All 2 branches missed.">            if ((hex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.ROAD))</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">                    &amp;&amp; (!hex.containsTerrain(Terrains.BUILDING)</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">                            &amp;&amp; !hex.containsTerrain(Terrains.RUBBLE))){</span>
<span class="nc" id="L565">                return true;</span>
            }
            // Can't deploy on a bridge
<span class="nc bnc" id="L568" title="All 2 branches missed.">            if ((hex.terrainLevel(Terrains.BRIDGE_ELEV) == currElevation)</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    &amp;&amp; hex.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L570">                return true;</span>
            }
            // Can't deploy on the surface of water
<span class="nc bnc" id="L573" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WATER) &amp;&amp; (currElevation == 0)) {</span>
<span class="nc" id="L574">                return true;</span>
            }
        }

<span class="nc" id="L578">        boolean hasFlotationHull = hasWorkingMisc(MiscType.F_FLOTATION_HULL);</span>
<span class="nc" id="L579">        boolean isAmphibious = hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS);</span>
<span class="nc" id="L580">        boolean hexHasRoad =  hex.containsTerrain(Terrains.ROAD);</span>

        // roads allow movement through hexes that you normally couldn't go through
<span class="nc bnc" id="L583" title="All 7 branches missed.">        switch (movementMode) {</span>
            case TRACKED:
<span class="nc bnc" id="L585" title="All 2 branches missed.">                if (!isSuperHeavy()) {</span>
<span class="nc bnc" id="L586" title="All 4 branches missed.">                    return ((hex.terrainLevel(Terrains.WOODS) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L588" title="All 6 branches missed.">                                    &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                                    &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L590" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1)</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.ROUGH) &gt; 1)</span>
<span class="nc bnc" id="L593" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.RUBBLE) &gt; 5) &amp;&amp; !hexHasRoad);</span>
                } else {
<span class="nc bnc" id="L595" title="All 4 branches missed.">                    return ((hex.terrainLevel(Terrains.WOODS) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L597" title="All 6 branches missed.">                                    &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                                    &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L599" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1);</span>
                }
            case WHEELED:
<span class="nc bnc" id="L603" title="All 2 branches missed.">                if (!isSuperHeavy()) {</span>
<span class="nc bnc" id="L604" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L605" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.ROUGH) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L607" title="All 6 branches missed.">                                    &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                                    &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L609" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.RUBBLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                            || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L612" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.SNOW) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.GEYSER) == 2);</span>
                } else {
<span class="nc bnc" id="L615" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L616" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.ROUGH) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                            || ((hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L618" title="All 6 branches missed.">                                    &amp;&amp; !hex.containsTerrain(Terrains.ICE)</span>
                                    &amp;&amp; !hasFlotationHull &amp;&amp; !isAmphibious)
<span class="nc bnc" id="L620" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.RUBBLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">                            || hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L622" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.GEYSER) == 2);</span>
                }
            case HOVER:
<span class="nc bnc" id="L626" title="All 2 branches missed.">                if (!isSuperHeavy()) {</span>
<span class="nc bnc" id="L627" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L628" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1)</span>
<span class="nc bnc" id="L630" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.ROUGH) &gt; 1) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L631" title="All 4 branches missed.">                            || ((hex.terrainLevel(Terrains.RUBBLE) &gt; 5) &amp;&amp; !hexHasRoad);</span>
                } else {
<span class="nc bnc" id="L633" title="All 4 branches missed.">                    return (hex.containsTerrain(Terrains.WOODS) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L634" title="All 4 branches missed.">                            || (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; !hexHasRoad)</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">                            || (hex.terrainLevel(Terrains.MAGMA) &gt; 1);</span>
                }

            case NAVAL:
            case HYDROFOIL:
                // Can only deploy under a bridge if there is sufficient clearance.
<span class="nc bnc" id="L641" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                        &amp;&amp; (getHeight() &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV) - hex.surface())) {</span>
<span class="nc" id="L643">                    return true;</span>
                }
<span class="nc bnc" id="L645" title="All 2 branches missed.">                return (hex.terrainLevel(Terrains.WATER) &lt;= 0)</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">                        || hex.containsTerrain(Terrains.ICE);</span>
            case SUBMARINE:
                // Submarines get extra clearance equal to the depth of water.
<span class="nc bnc" id="L649" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                        &amp;&amp; (getHeight() &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV) - hex.floor())) {</span>
<span class="nc" id="L651">                    return true;</span>
                }
<span class="nc bnc" id="L653" title="All 2 branches missed.">                return (hex.terrainLevel(Terrains.WATER) &lt;= 0);</span>
            case WIGE:
<span class="nc bnc" id="L655" title="All 2 branches missed.">                return (hex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                        || hex.containsTerrain(Terrains.JUNGLE))</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                        &amp;&amp; hex.ceiling() &gt; currElevation;</span>
            default:
<span class="nc" id="L659">                return false;</span>
        }
    }

    public void lockTurret(int turret) {
<span class="nc bnc" id="L664" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L665">            m_bTurretLocked = true;</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L667">            m_bDualTurretLocked = true;</span>
        }

<span class="nc" id="L670">    }</span>

    public void jamTurret(int turret) {
<span class="nc bnc" id="L673" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L674">            m_bTurretEverJammed = true;</span>
<span class="nc" id="L675">            m_bTurretJammed = true;</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L677">            m_bDualTurretEverJammed = true;</span>
<span class="nc" id="L678">            m_bDualTurretJammed = true;</span>
        }

<span class="nc" id="L681">    }</span>

    public void unjamTurret(int turret) {
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L685">            m_bTurretJammed = false;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L687">            m_bDualTurretJammed = false;</span>
        }
<span class="nc" id="L689">    }</span>

    public boolean isTurretEverJammed(int turret) {
<span class="nc bnc" id="L692" title="All 2 branches missed.">        if (turret == getLocTurret()) {</span>
<span class="nc" id="L693">            return m_bTurretEverJammed;</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        } else if (turret == getLocTurret2()) {</span>
<span class="nc" id="L695">            return m_bDualTurretEverJammed;</span>
        }
<span class="nc" id="L697">        return false;</span>
    }

    public int getStunnedTurns() {
<span class="nc" id="L701">        return m_nStunnedTurns;</span>
    }

    public void setStunnedTurns(int turns) {
<span class="nc" id="L705">        m_nStunnedTurns = turns;</span>
<span class="nc" id="L706">    }</span>

    public void stunCrew() {
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if (m_nStunnedTurns == 0) {</span>
<span class="nc" id="L710">            m_nStunnedTurns = 2;</span>
        } else {
<span class="nc" id="L712">            m_nStunnedTurns++;</span>
        }
<span class="nc" id="L714">    }</span>

    @Override
    public void applyDamage() {
<span class="nc" id="L718">        applyMovementDamage();</span>

<span class="nc" id="L720">        super.applyDamage();</span>
<span class="nc" id="L721">    }</span>

    /**
     * Applies movement damage to the Tank.
     */
    public void applyMovementDamage() {
<span class="nc" id="L727">        m_bImmobile |= m_bImmobileHit;</span>

        // Towed trailers need to use the values of the tractor, or they return Immobile due to 0 MP...
<span class="nc bnc" id="L730" title="All 6 branches missed.">        if (isTrailer() &amp;&amp; (getTractor() != Entity.NONE) &amp;&amp; game.getEntity(getTractor()).hasETypeFlag(Entity.ETYPE_TANK)) {</span>
<span class="nc" id="L731">            Tank Tractor = (Tank) game.getEntity(getTractor());</span>
<span class="nc" id="L732">            m_bImmobile = Tractor.m_bImmobile;</span>
<span class="nc" id="L733">            m_bImmobileHit = Tractor.m_bImmobileHit;</span>
        }
<span class="nc" id="L735">    }</span>

    @Override
    public void newRound(int roundNumber) {
<span class="nc" id="L739">        super.newRound(roundNumber);</span>

        // If MASC was used last turn, increment the counter,
        // otherwise decrement. Then, clear the counter
<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (usedMASC) {</span>
<span class="nc" id="L744">            nMASCLevel++;</span>
<span class="nc" id="L745">            bMASCWentUp = true;</span>
        } else {
<span class="nc" id="L747">            nMASCLevel = Math.max(0, nMASCLevel - 1);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">            if (bMASCWentUp) {</span>
<span class="nc" id="L749">                nMASCLevel = Math.max(0, nMASCLevel - 1);</span>
<span class="nc" id="L750">                bMASCWentUp = false;</span>
            }
        }

        // Clear the MASC flag
<span class="nc" id="L755">        usedMASC = false;</span>

        // check for crew stun
<span class="nc bnc" id="L758" title="All 2 branches missed.">        if (m_nStunnedTurns &gt; 0) {</span>
<span class="nc" id="L759">            m_nStunnedTurns--;</span>
        }

        // reset turret facing, if not jammed
<span class="nc bnc" id="L763" title="All 2 branches missed.">        if (!m_bTurretLocked) {</span>
<span class="nc" id="L764">            setSecondaryFacing(getFacing());</span>
        }
<span class="nc" id="L766">    }</span>

    /**
     * Returns the name of the type of movement used. This is tank-specific.
     */
    @Override
    public String getMovementString(EntityMovementType mtype) {
<span class="nc bnc" id="L773" title="All 7 branches missed.">        switch (mtype) {</span>
            case MOVE_SKID:
<span class="nc" id="L775">                return &quot;Skidded&quot;;</span>
            case MOVE_NONE:
<span class="nc" id="L777">                return &quot;None&quot;;</span>
            case MOVE_WALK:
            case MOVE_VTOL_WALK:
<span class="nc" id="L780">                return &quot;Cruised&quot;;</span>
            case MOVE_RUN:
            case MOVE_VTOL_RUN:
<span class="nc" id="L783">                return &quot;Flanked&quot;;</span>
            case MOVE_SPRINT:
            case MOVE_VTOL_SPRINT:
<span class="nc" id="L786">                return &quot;Sprinted&quot;;</span>
            case MOVE_JUMP:
<span class="nc" id="L788">                return &quot;Jumped&quot;;</span>
            default:
<span class="nc" id="L790">                return &quot;Unknown!&quot;;</span>
        }
    }

    /**
     * Returns the name of the type of movement used. This is tank-specific.
     */
    @Override
    public String getMovementAbbr(EntityMovementType mtype) {
<span class="nc bnc" id="L799" title="All 7 branches missed.">        switch (mtype) {</span>
            case MOVE_SKID:
<span class="nc" id="L801">                return &quot;S&quot;;</span>
            case MOVE_NONE:
<span class="nc" id="L803">                return &quot;N&quot;;</span>
            case MOVE_WALK:
            case MOVE_VTOL_WALK:
<span class="nc" id="L806">                return &quot;C&quot;;</span>
            case MOVE_RUN:
            case MOVE_VTOL_RUN:
<span class="nc" id="L809">                return &quot;F&quot;;</span>
            case MOVE_SPRINT:
            case MOVE_VTOL_SPRINT:
<span class="nc" id="L812">                return &quot;O&quot;;</span>
            case MOVE_JUMP:
<span class="nc" id="L814">                return &quot;J&quot;;</span>
            default:
<span class="nc" id="L816">                return &quot;?&quot;;</span>
        }
    }

    @Override
    public boolean hasRearArmor(int loc) {
<span class="nc" id="L822">        return false;</span>
    }
    
    @Override
    public int firstArmorIndex() {
<span class="nc" id="L827">        return LOC_FRONT;</span>
    }

    /**
     * Returns the Compute.ARC that the weapon fires into.
     */
    @Override
    public int getWeaponArc(int wn) {
<span class="nc" id="L835">        final Mounted mounted = getEquipment(wn);</span>

        // B-Pods need to be special-cased, the have 360 firing arc
<span class="nc bnc" id="L838" title="All 2 branches missed.">        if ((mounted.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L840">            return Compute.ARC_360;</span>
        }
        // VGLs base arc on their facing
<span class="nc bnc" id="L843" title="All 2 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L844">            return Compute.firingArcFromVGLFacing(mounted.getFacing());</span>
        }
<span class="nc bnc" id="L846" title="All 7 branches missed.">        switch (mounted.getLocation()) {</span>
            case LOC_BODY:
                // Body mounted C3Ms fire into the front arc,
                // per
                // http://forums.classicbattletech.com/index.php/topic,9400.0.html
            case LOC_FRONT:
<span class="nc bnc" id="L852" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L853">                    return Compute.ARC_PINTLE_TURRET_FRONT;</span>
                }
<span class="nc bnc" id="L855" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L856">                    return Compute.ARC_NOSE;</span>
                }
            case LOC_TURRET:
<span class="nc bnc" id="L859" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L860">                    return Compute.ARC_TURRET;</span>
                }
<span class="nc" id="L862">                return Compute.ARC_FORWARD;</span>
            case LOC_TURRET_2:
                // Doubles as chin turret location for VTOLs, for which
                // Tank.LOC_TURRET == magic number 5 == VTOL.LOC_ROTOR.
<span class="nc bnc" id="L866" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L867">                    return Compute.ARC_TURRET;</span>
                }
<span class="nc" id="L869">                return Compute.ARC_FORWARD;</span>
            case LOC_RIGHT:
<span class="nc bnc" id="L871" title="All 2 branches missed.">                if (mounted.isSponsonTurretMounted()) {</span>
<span class="nc" id="L872">                    return Compute.ARC_SPONSON_TURRET_RIGHT;</span>
                }
<span class="nc bnc" id="L874" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L875">                    return Compute.ARC_PINTLE_TURRET_RIGHT;</span>
                }
<span class="nc bnc" id="L877" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L878">                    return Compute.ARC_RIGHT_BROADSIDE;</span>
                }
<span class="nc" id="L880">                return Compute.ARC_RIGHTSIDE;</span>
            case LOC_LEFT:
<span class="nc bnc" id="L882" title="All 2 branches missed.">                if (mounted.isSponsonTurretMounted()) {</span>
<span class="nc" id="L883">                    return Compute.ARC_SPONSON_TURRET_LEFT;</span>
                }
<span class="nc bnc" id="L885" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L886">                    return Compute.ARC_PINTLE_TURRET_LEFT;</span>
                }
<span class="nc bnc" id="L888" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L889">                    return Compute.ARC_LEFT_BROADSIDE;</span>
                }
<span class="nc" id="L891">                return Compute.ARC_LEFTSIDE;</span>
            case LOC_REAR:
<span class="nc bnc" id="L893" title="All 2 branches missed.">                if (mounted.isPintleTurretMounted()) {</span>
<span class="nc" id="L894">                    return Compute.ARC_PINTLE_TURRET_REAR;</span>
                }
<span class="nc bnc" id="L896" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L897">                    return Compute.ARC_AFT;</span>
                }
<span class="nc" id="L899">                return Compute.ARC_REAR;</span>
            default:
<span class="nc" id="L901">                return Compute.ARC_360;</span>
        }
    }

    /**
     * Returns true if this weapon fires into the secondary facing arc. If
     * false, assume it fires into the primary.
     */
    @Override
    public boolean isSecondaryArcWeapon(int weaponId) {
<span class="nc bnc" id="L911" title="All 2 branches missed.">        if (getEquipment(weaponId).getLocation() == getLocTurret()) {</span>
<span class="nc" id="L912">            return true;</span>
        }
<span class="nc" id="L914">        return false;</span>
    }

    /**
     * Rolls up a hit location
     */
    @Override
    public HitData rollHitLocation(int table, int side, int aimedLocation,
            int aimingMode, int cover) {
<span class="nc" id="L923">        int nArmorLoc = LOC_FRONT;</span>
<span class="nc" id="L924">        boolean bSide = false;</span>
<span class="nc" id="L925">        boolean bRear = false;</span>
<span class="nc bnc" id="L926" title="All 4 branches missed.">        boolean ignoreTurret = m_bHasNoTurret</span>
                || (table == ToHitData.HIT_UNDERWATER);
<span class="nc" id="L928">        int motiveMod = getMotiveSideMod(side);</span>
<span class="nc" id="L929">        setPotCrit(HitData.EFFECT_NONE);</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">        if (isHullDown()) {</span>
            // which direction a tank moved in before going hull down is
            // important
            int moveInDirection;
<span class="nc bnc" id="L934" title="All 2 branches missed.">            if (!m_bBackedIntoHullDown) {</span>
<span class="nc" id="L935">                moveInDirection = ToHitData.SIDE_FRONT;</span>
            } else {
<span class="nc" id="L937">                moveInDirection = ToHitData.SIDE_REAR;</span>
            }
<span class="nc bnc" id="L939" title="All 6 branches missed.">            if ((side == moveInDirection) || (side == ToHitData.SIDE_LEFT)</span>
                    || (side == ToHitData.SIDE_RIGHT)) {
<span class="nc bnc" id="L941" title="All 2 branches missed.">                if (!ignoreTurret) {</span>
                    // on a hull down vee, all hits expect for those that come
                    // from the opposite direction to which it entered the hex
                    // it
                    // went Hull Down in go to turret if one exists.
<span class="nc bnc" id="L946" title="All 2 branches missed.">                    if (!hasNoDualTurret()) {</span>
<span class="nc" id="L947">                        int roll = Compute.d6() - 2;</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">                        if (roll &lt;= 3) {</span>
<span class="nc" id="L949">                            nArmorLoc = getLocTurret2();</span>
                        } else {
<span class="nc" id="L951">                            nArmorLoc = getLocTurret();</span>
                        }
<span class="nc" id="L953">                    } else {</span>
<span class="nc" id="L954">                        nArmorLoc = getLocTurret();</span>
                    }
                }
                // If the tank doesn't have turret all hits that don't come from
                // the opposite direction to which it entered the hex it went
                // Hull Down in hit side they come in from
                else {
<span class="nc" id="L961">                    nArmorLoc = side;</span>
                }
                // Hull Down tanks don't make hit location rolls
<span class="nc" id="L964">                return new HitData(nArmorLoc);</span>
            }
        }
<span class="nc bnc" id="L967" title="All 2 branches missed.">        if (side == ToHitData.SIDE_LEFT) {</span>
<span class="nc" id="L968">            nArmorLoc = LOC_LEFT;</span>
<span class="nc" id="L969">            bSide = true;</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_RIGHT) {</span>
<span class="nc" id="L971">            nArmorLoc = LOC_RIGHT;</span>
<span class="nc" id="L972">            bSide = true;</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">        } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L974">            nArmorLoc = LOC_REAR;</span>
<span class="nc" id="L975">            bRear = true;</span>
        }
<span class="nc" id="L977">        HitData rv = new HitData(nArmorLoc);</span>
<span class="nc" id="L978">        boolean bHitAimed = false;</span>
<span class="nc bnc" id="L979" title="All 4 branches missed.">        if ((aimedLocation != LOC_NONE)</span>
                &amp;&amp; (aimingMode != IAimingModes.AIM_MODE_NONE)) {

<span class="nc" id="L982">            int roll = Compute.d6(2);</span>

<span class="nc bnc" id="L984" title="All 4 branches missed.">            if ((5 &lt; roll) &amp;&amp; (roll &lt; 9)) {</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">                rv = new HitData(aimedLocation, side == ToHitData.SIDE_REAR,</span>
                        true);
<span class="nc" id="L987">                bHitAimed = true;</span>
            }
        }
<span class="nc bnc" id="L990" title="All 2 branches missed.">        if (!bHitAimed) {</span>
<span class="nc bnc" id="L991" title="All 11 branches missed.">            switch (Compute.d6(2)) {</span>
                case 2:
<span class="nc bnc" id="L993" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {</span>
<span class="nc" id="L994">                        setPotCrit(HitData.EFFECT_CRITICAL);</span>
                    } else {
<span class="nc" id="L996">                        rv.setEffect(HitData.EFFECT_CRITICAL);</span>
                    }
<span class="nc" id="L998">                    break;</span>
                case 3:
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {</span>
<span class="nc" id="L1001">                        setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
                    } else {
<span class="nc" id="L1003">                        rv.setEffect(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
                    }
<span class="nc" id="L1005">                    rv.setMotiveMod(motiveMod);</span>
<span class="nc" id="L1006">                    break;</span>
                case 4:
<span class="nc bnc" id="L1008" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {</span>
<span class="nc" id="L1009">                        setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
                    } else {
<span class="nc" id="L1011">                        rv.setEffect(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
                    }
<span class="nc" id="L1013">                    rv.setMotiveMod(motiveMod);</span>
<span class="nc" id="L1014">                    break;</span>
                case 5:
<span class="nc bnc" id="L1016" title="All 2 branches missed.">                    if (bSide) {</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1019">                            setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1020">                            rv = new HitData(LOC_FRONT);</span>
                        } else {
<span class="nc" id="L1022">                            rv = new HitData(LOC_FRONT, false,</span>
                                    HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                        }
<span class="nc bnc" id="L1025" title="All 2 branches missed.">                    } else if (bRear) {</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1028">                            setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1029">                            rv = new HitData(LOC_LEFT);</span>
                        } else {
<span class="nc" id="L1031">                            rv = new HitData(LOC_LEFT, false,</span>
                                    HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                        }
                    } else {
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1037">                            setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1038">                            rv = new HitData(LOC_LEFT);</span>
                        } else {
<span class="nc" id="L1040">                            rv = new HitData(LOC_LEFT, false,</span>
                                    HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                        }
                    }
<span class="nc" id="L1044">                    rv.setMotiveMod(motiveMod);</span>
<span class="nc" id="L1045">                    break;</span>
                case 6:
                case 7:
<span class="nc" id="L1048">                    break;</span>
                case 8:
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                    if (bSide</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">                            &amp;&amp; !game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)) {
<span class="nc bnc" id="L1053" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1055">                            setPotCrit(HitData.EFFECT_CRITICAL);</span>
                        } else {
<span class="nc" id="L1057">                            rv.setEffect(HitData.EFFECT_CRITICAL);</span>
                        }
                    }
                    break;
                case 9:
<span class="nc bnc" id="L1062" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)) {
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                        if (bSide) {</span>
<span class="nc" id="L1065">                            rv = new HitData(LOC_REAR);</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">                        } else if (bRear) {</span>
<span class="nc" id="L1067">                            rv = new HitData(LOC_RIGHT);</span>
                        } else {
<span class="nc" id="L1069">                            rv = new HitData(LOC_LEFT);</span>
                        }
                    } else {
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                        if (bSide) {</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1075">                                setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1076">                                rv = new HitData(LOC_REAR);</span>
                            } else {
<span class="nc" id="L1078">                                rv = new HitData(LOC_REAR, false,</span>
                                        HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                            }
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                        } else if (bRear) {</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1084">                                setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1085">                                rv = new HitData(LOC_RIGHT);</span>
                            } else {
<span class="nc" id="L1087">                                rv = new HitData(LOC_RIGHT, false,</span>
                                        HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                            }
                        } else {
<span class="nc bnc" id="L1091" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1093">                                setPotCrit(HitData.EFFECT_VEHICLE_MOVE_DAMAGED);</span>
<span class="nc" id="L1094">                                rv = new HitData(LOC_LEFT);</span>
                            } else {
<span class="nc" id="L1096">                                rv = new HitData(LOC_LEFT, false,</span>
                                        HitData.EFFECT_VEHICLE_MOVE_DAMAGED);
                            }
                        }
<span class="nc" id="L1100">                        rv.setMotiveMod(motiveMod);</span>
                    }
<span class="nc" id="L1102">                    break;</span>
                case 10:
<span class="nc bnc" id="L1104" title="All 2 branches missed.">                    if (!ignoreTurret) {</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">                        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L1106">                            int roll = Compute.d6();</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                            if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc" id="L1108">                                roll -= 2;</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">                            } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L1110">                                roll += 2;</span>
                            }
<span class="nc bnc" id="L1112" title="All 2 branches missed.">                            if (roll &lt;= 3) {</span>
<span class="nc" id="L1113">                                rv = new HitData(LOC_TURRET_2);</span>
                            } else {
<span class="nc" id="L1115">                                rv = new HitData(LOC_TURRET);</span>
                            }
<span class="nc" id="L1117">                        } else {</span>
<span class="nc" id="L1118">                            rv = new HitData(LOC_TURRET);</span>
                        }
                    }
                    break;
                case 11:
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                    if (!ignoreTurret) {</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L1125">                            int roll = Compute.d6();</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">                            if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc" id="L1127">                                roll -= 2;</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">                            } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L1129">                                roll += 2;</span>
                            }
<span class="nc bnc" id="L1131" title="All 2 branches missed.">                            if (roll &lt;= 3) {</span>
<span class="nc" id="L1132">                                rv = new HitData(LOC_TURRET_2);</span>
                            } else {
<span class="nc" id="L1134">                                rv = new HitData(LOC_TURRET);</span>
                            }
<span class="nc" id="L1136">                        } else {</span>
<span class="nc" id="L1137">                            rv = new HitData(LOC_TURRET);</span>
                        }
                    }
                    break;
                case 12:
<span class="nc bnc" id="L1142" title="All 2 branches missed.">                    if (ignoreTurret) {</span>
<span class="nc bnc" id="L1143" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1145">                            setPotCrit(HitData.EFFECT_CRITICAL);</span>
                        } else {
<span class="nc" id="L1147">                            rv.setEffect(HitData.EFFECT_CRITICAL);</span>
                        }
                    } else {
<span class="nc bnc" id="L1150" title="All 2 branches missed.">                        if (!hasNoDualTurret()) {</span>
<span class="nc" id="L1151">                            int roll = Compute.d6();</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                            if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc" id="L1153">                                roll -= 2;</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">                            } else if (side == ToHitData.SIDE_REAR) {</span>
<span class="nc" id="L1155">                                roll += 2;</span>
                            }
<span class="nc bnc" id="L1157" title="All 2 branches missed.">                            if (roll &lt;= 3) {</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">                                if (game.getOptions().booleanOption(</span>
                                        OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1160">                                    setPotCrit(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1161">                                    rv = new HitData(LOC_TURRET_2);</span>
                                } else {
<span class="nc" id="L1163">                                    rv = new HitData(LOC_TURRET_2, false,</span>
                                            HitData.EFFECT_CRITICAL);
                                }
                            } else {
<span class="nc bnc" id="L1167" title="All 2 branches missed.">                                if (game.getOptions().booleanOption(</span>
                                        OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1169">                                    setPotCrit(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1170">                                    rv = new HitData(LOC_TURRET);</span>
                                } else {
<span class="nc" id="L1172">                                    rv = new HitData(LOC_TURRET, false,</span>
                                            HitData.EFFECT_CRITICAL);
                                }
                            }
<span class="nc" id="L1176">                        } else {</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)) {
<span class="nc" id="L1179">                                setPotCrit(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1180">                                rv = new HitData(LOC_TURRET);</span>
                            } else {
<span class="nc" id="L1182">                                rv = new HitData(LOC_TURRET, false,</span>
                                        HitData.EFFECT_CRITICAL);
                            }
                        }
                    }
            }
        }
<span class="nc bnc" id="L1189" title="All 2 branches missed.">        if (table == ToHitData.HIT_SWARM) {</span>
<span class="nc" id="L1190">            rv.setEffect(rv.getEffect() | HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L1191">            setPotCrit(HitData.EFFECT_CRITICAL);</span>
        }
<span class="nc" id="L1193">        return rv;</span>
    }

    @Override
    public HitData rollHitLocation(int table, int side) {
<span class="nc" id="L1198">        return rollHitLocation(table, side, LOC_NONE,</span>
                IAimingModes.AIM_MODE_NONE, LosEffects.COVER_NONE);
    }

    /**
     * Gets the location that excess damage transfers to
     */
    @Override
    public HitData getTransferLocation(HitData hit) {
<span class="nc" id="L1207">        return new HitData(LOC_DESTROYED);</span>
    }

    /**
     * Gets the location that is destroyed recursively
     */
    @Override
    public int getDependentLocation(int loc) {
<span class="nc" id="L1215">        return LOC_NONE;</span>
    }

    /**
     * Calculates the battle value of this mech
     */
    @Override
    public int calculateBattleValue() {
<span class="nc bnc" id="L1223" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L1224">            return manualBV;</span>
        }

<span class="nc" id="L1227">        return calculateBattleValue(false, false);</span>
    }

    /**
     * Calculates the battle value of this tank
     */
    @Override
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L1235" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L1236">            return manualBV;</span>
        }
<span class="nc bnc" id="L1238" title="All 4 branches missed.">        if (isCarcass() &amp;&amp; !ignorePilot) {</span>
<span class="nc" id="L1239">            return 0;</span>
        }
<span class="nc" id="L1241">        bvText = new StringBuffer(</span>
                &quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Battle Value Calculations For &quot;);

<span class="nc" id="L1244">        bvText.append(getChassis());</span>
<span class="nc" id="L1245">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L1246">        bvText.append(getModel());</span>
<span class="nc" id="L1247">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L1248">        bvText.append(nl);</span>

<span class="nc" id="L1250">        bvText.append(&quot;&lt;b&gt;Defensive Battle Rating Calculation:&lt;/b&gt;&quot;);</span>
<span class="nc" id="L1251">        bvText.append(nl);</span>

<span class="nc" id="L1253">        double dbv = 0; // defensive battle value</span>
<span class="nc" id="L1254">        double obv = 0; // offensive bv</span>

<span class="nc" id="L1256">        boolean blueShield = false;</span>
        // a blueshield system means a +0.2 on the armor and internal modifier,
        // like for mechs
<span class="nc bnc" id="L1259" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L1260">            blueShield = true;</span>
        }

<span class="nc" id="L1263">        bvText.append(startTable);</span>
<span class="nc" id="L1264">        double armorMultiplier = 1.0;</span>

<span class="nc bnc" id="L1266" title="All 2 branches missed.">        for (int loc = 1; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L1267">            int modularArmor = 0;</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">            for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">                        &amp;&amp; mounted.getType().hasFlag(MiscType.F_MODULAR_ARMOR)</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">                        &amp;&amp; (mounted.getLocation() == loc)) {</span>
<span class="nc" id="L1272">                    modularArmor += mounted.getBaseDamageCapacity()</span>
<span class="nc" id="L1273">                            - mounted.getDamageTaken();</span>
                }
<span class="nc" id="L1275">            }</span>
            // total armor points

<span class="nc bnc" id="L1278" title="All 5 branches missed.">            switch (getArmorType(loc)) {</span>
                case EquipmentType.T_ARMOR_COMMERCIAL:
<span class="nc" id="L1280">                    armorMultiplier = 0.5;</span>
<span class="nc" id="L1281">                    break;</span>
                case EquipmentType.T_ARMOR_HARDENED:
<span class="nc" id="L1283">                    armorMultiplier = 2.0;</span>
<span class="nc" id="L1284">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L1288">                    armorMultiplier = 1.5;</span>
<span class="nc" id="L1289">                    break;</span>
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
<span class="nc" id="L1292">                    armorMultiplier = 1.2;</span>
<span class="nc" id="L1293">                    break;</span>
                default:
<span class="nc" id="L1295">                    armorMultiplier = 1.0;</span>
                    break;
            }

<span class="nc bnc" id="L1299" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L1300">                armorMultiplier += 0.2;</span>
            }
<span class="nc" id="L1302">            bvText.append(startRow);</span>
<span class="nc" id="L1303">            bvText.append(startColumn);</span>

<span class="nc" id="L1305">            int armor = getArmor(loc) + modularArmor;</span>
<span class="nc" id="L1306">            bvText.append(&quot;Total Armor &quot; + this.getLocationAbbr(loc) + &quot; (&quot;</span>
                    + armor + &quot;) x &quot;);
<span class="nc" id="L1308">            bvText.append(armorMultiplier);</span>
<span class="nc" id="L1309">            bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L1310">            bvText.append(getBARRating(loc));</span>
<span class="nc" id="L1311">            bvText.append(&quot;/10&quot;);</span>
<span class="nc" id="L1312">            bvText.append(endColumn);</span>
<span class="nc" id="L1313">            bvText.append(startColumn);</span>
<span class="nc" id="L1314">            bvText.append(endColumn);</span>
<span class="nc" id="L1315">            bvText.append(startColumn);</span>
<span class="nc" id="L1316">            double armorBV = (getArmor(loc) + modularArmor) * armorMultiplier * (getBARRating(loc) / 10.0);</span>
<span class="nc" id="L1317">            bvText.append(armorBV);</span>
<span class="nc" id="L1318">            dbv += armorBV;</span>
<span class="nc" id="L1319">            bvText.append(endColumn);</span>
        }
<span class="nc" id="L1321">        bvText.append(startRow);</span>
<span class="nc" id="L1322">        bvText.append(startColumn);</span>
<span class="nc" id="L1323">        bvText.append(&quot;Total modified armor BV x 2.5 &quot;);</span>
<span class="nc" id="L1324">        bvText.append(endColumn);</span>
<span class="nc" id="L1325">        bvText.append(startColumn);</span>
<span class="nc" id="L1326">        bvText.append(endColumn);</span>
<span class="nc" id="L1327">        bvText.append(startColumn);</span>
<span class="nc" id="L1328">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1329">        dbv *= 2.5;</span>
<span class="nc" id="L1330">        bvText.append(dbv);</span>
<span class="nc" id="L1331">        bvText.append(endColumn);</span>
<span class="nc" id="L1332">        bvText.append(endRow);</span>
<span class="nc" id="L1333">        bvText.append(startRow);</span>
<span class="nc" id="L1334">        bvText.append(startColumn);</span>
<span class="nc" id="L1335">        bvText.append(&quot;Total I.S. Points x 1.5 x Blue Shield Multipler&quot;);</span>
<span class="nc" id="L1336">        bvText.append(endColumn);</span>
<span class="nc" id="L1337">        bvText.append(startColumn);</span>
<span class="nc" id="L1338">        bvText.append(getTotalInternal());</span>
<span class="nc" id="L1339">        bvText.append(&quot; x 1.5 x &quot;);</span>
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        bvText.append((blueShield ? 1.2 : 1));</span>
<span class="nc" id="L1341">        bvText.append(endColumn);</span>
<span class="nc" id="L1342">        bvText.append(startColumn);</span>
<span class="nc" id="L1343">        bvText.append(&quot;= &quot;);</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">        bvText.append(getTotalInternal() * 1.5 * (blueShield ? 1.2 : 1));</span>
<span class="nc" id="L1345">        bvText.append(endColumn);</span>
<span class="nc" id="L1346">        bvText.append(endRow);</span>
        // total internal structure
<span class="nc bnc" id="L1348" title="All 2 branches missed.">        dbv += getTotalInternal() * 1.5 * (blueShield ? 1.2 : 1);</span>

<span class="nc" id="L1350">        bvText.append(startRow);</span>
<span class="nc" id="L1351">        bvText.append(startColumn);</span>
<span class="nc" id="L1352">        bvText.append(endColumn);</span>
<span class="nc" id="L1353">        bvText.append(startColumn);</span>
<span class="nc" id="L1354">        bvText.append(endColumn);</span>
<span class="nc" id="L1355">        bvText.append(startColumn);</span>
<span class="nc" id="L1356">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1357">        bvText.append(endColumn);</span>
<span class="nc" id="L1358">        bvText.append(endRow);</span>

<span class="nc" id="L1360">        bvText.append(startRow);</span>
<span class="nc" id="L1361">        bvText.append(startColumn);</span>
<span class="nc" id="L1362">        bvText.append(&quot;Defensive Equipment&quot;);</span>
<span class="nc" id="L1363">        bvText.append(endColumn);</span>
<span class="nc" id="L1364">        bvText.append(endRow);</span>
<span class="nc" id="L1365">        bvText.append(startRow);</span>
<span class="nc" id="L1366">        bvText.append(startColumn);</span>
<span class="nc" id="L1367">        bvText.append(endColumn);</span>
<span class="nc" id="L1368">        double amsAmmoBV = 0;</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L1370">            AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L1371" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_AMS) || (atype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L1372">                amsAmmoBV += atype.getBV(this);</span>
            }
<span class="nc" id="L1374">        }</span>
<span class="nc" id="L1375">        double amsBV = 0;</span>
        // add defensive equipment
<span class="nc" id="L1377">        double dEquipmentBV = 0;</span>
<span class="nc bnc" id="L1378" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc" id="L1379">            EquipmentType etype = mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1382" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1383">                continue;</span>
            }

<span class="nc bnc" id="L1386" title="All 2 branches missed.">            if (((etype instanceof WeaponType) &amp;&amp; (etype</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">                    .hasFlag(WeaponType.F_AMS) || etype</span>
<span class="nc bnc" id="L1388" title="All 4 branches missed.">                    .hasFlag(WeaponType.F_B_POD) || etype.hasFlag(WeaponType.F_M_POD)))) {</span>
<span class="nc" id="L1389">                bvText.append(startRow);</span>
<span class="nc" id="L1390">                bvText.append(startColumn);</span>
<span class="nc" id="L1391">                bvText.append(etype.getName());</span>
<span class="nc" id="L1392">                bvText.append(endColumn);</span>
<span class="nc" id="L1393">                bvText.append(startColumn);</span>
<span class="nc" id="L1394">                bvText.append(etype.getBV(this));</span>
<span class="nc" id="L1395">                bvText.append(endColumn);</span>
<span class="nc" id="L1396">                bvText.append(endRow);</span>
<span class="nc" id="L1397">                dEquipmentBV += etype.getBV(this);</span>
<span class="nc" id="L1398">                WeaponType wtype = (WeaponType) etype;</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                if ((wtype.hasFlag(WeaponType.F_AMS)</span>
<span class="nc bnc" id="L1400" title="All 4 branches missed.">                        &amp;&amp; (wtype.getAmmoType() == AmmoType.T_AMS)) || (wtype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L1401">                    amsBV += etype.getBV(this);</span>
                }
<span class="nc bnc" id="L1403" title="All 2 branches missed.">            } else if (((etype instanceof MiscType) &amp;&amp; (etype</span>
<span class="nc bnc" id="L1404" title="All 2 branches missed.">                    .hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_AP_POD)</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_BULLDOZER)</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_CHAFF_POD) || etype</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">                        .hasFlag(MiscType.F_BAP)))</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">                    || etype.hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L1413">                MiscType mtype = (MiscType) etype;</span>
<span class="nc" id="L1414">                double bv = mtype.getBV(this, mounted.getLocation());</span>
<span class="nc" id="L1415">                bvText.append(startColumn);</span>
<span class="nc" id="L1416">                bvText.append(mounted.getName());</span>
<span class="nc" id="L1417">                bvText.append(endColumn);</span>
<span class="nc" id="L1418">                bvText.append(startColumn);</span>
<span class="nc" id="L1419">                bvText.append(bv);</span>
<span class="nc" id="L1420">                dEquipmentBV += bv;</span>
<span class="nc" id="L1421">                bvText.append(endColumn);</span>
<span class="nc" id="L1422">                bvText.append(endRow);</span>
            }
<span class="nc" id="L1424">        }</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">        if (amsAmmoBV &gt; 0) {</span>
<span class="nc" id="L1426">            bvText.append(startRow);</span>
<span class="nc" id="L1427">            bvText.append(startColumn);</span>

<span class="nc" id="L1429">            bvText.append(&quot;AMS Ammo (to a maximum of AMS BV)&quot;);</span>
<span class="nc" id="L1430">            bvText.append(endColumn);</span>
<span class="nc" id="L1431">            bvText.append(startColumn);</span>
<span class="nc" id="L1432">            bvText.append(endColumn);</span>
<span class="nc" id="L1433">            bvText.append(startColumn);</span>
<span class="nc" id="L1434">            bvText.append(&quot;+&quot;);</span>
<span class="nc" id="L1435">            bvText.append(Math.min(amsBV, amsAmmoBV));</span>
<span class="nc" id="L1436">            bvText.append(endColumn);</span>
<span class="nc" id="L1437">            bvText.append(endRow);</span>
<span class="nc" id="L1438">            dEquipmentBV += Math.min(amsBV, amsAmmoBV);</span>
        }
<span class="nc" id="L1440">        bvText.append(endRow);</span>
<span class="nc" id="L1441">        bvText.append(startRow);</span>
<span class="nc" id="L1442">        bvText.append(startColumn);</span>
<span class="nc" id="L1443">        bvText.append(endColumn);</span>
<span class="nc" id="L1444">        bvText.append(startColumn);</span>
<span class="nc" id="L1445">        bvText.append(endColumn);</span>
<span class="nc" id="L1446">        bvText.append(startColumn);</span>
<span class="nc" id="L1447">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1448">        bvText.append(dEquipmentBV);</span>
<span class="nc" id="L1449">        bvText.append(endColumn);</span>
<span class="nc" id="L1450">        bvText.append(endRow);</span>
<span class="nc" id="L1451">        bvText.append(startRow);</span>

<span class="nc" id="L1453">        dbv += dEquipmentBV;</span>

<span class="nc" id="L1455">        bvText.append(startRow);</span>
<span class="nc" id="L1456">        bvText.append(startColumn);</span>
<span class="nc" id="L1457">        bvText.append(endColumn);</span>
<span class="nc" id="L1458">        bvText.append(startColumn);</span>
<span class="nc" id="L1459">        bvText.append(endColumn);</span>
<span class="nc" id="L1460">        bvText.append(startColumn);</span>
<span class="nc" id="L1461">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1462">        bvText.append(endColumn);</span>
<span class="nc" id="L1463">        bvText.append(endRow);</span>

        double typeModifier;
<span class="nc bnc" id="L1466" title="All 5 branches missed.">        switch (getMovementMode()) {</span>
            case TRACKED:
<span class="nc" id="L1468">                typeModifier = 0.9;</span>
<span class="nc" id="L1469">                break;</span>
            case WHEELED:
<span class="nc" id="L1471">                typeModifier = 0.8;</span>
<span class="nc" id="L1472">                break;</span>
            case HOVER:
            case VTOL:
            case WIGE:
<span class="nc" id="L1476">                typeModifier = 0.7;</span>
<span class="nc" id="L1477">                break;</span>
            case NAVAL:
            case RAIL:
<span class="nc" id="L1480">                typeModifier = 0.6;</span>
<span class="nc" id="L1481">                break;</span>
            default:
<span class="nc" id="L1483">                typeModifier = 0.6;</span>
        }

<span class="nc bnc" id="L1486" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L1489">                    typeModifier += 0.2;</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">                } else if (m.getType().hasFlag(MiscType.F_LIMITED_AMPHIBIOUS)</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_DUNE_BUGGY)</span>
<span class="nc bnc" id="L1492" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_FLOTATION_HULL)</span>
<span class="nc bnc" id="L1493" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">                        || m.getType().hasFlag(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L1495">                    typeModifier += 0.1;</span>
                }
<span class="nc" id="L1497">            }</span>
        }
<span class="nc" id="L1499">        typeModifier = Math.round(typeModifier * 10.0) / 10.0;</span>
<span class="nc" id="L1500">        bvText.append(startColumn);</span>
<span class="nc" id="L1501">        bvText.append(&quot;x Body Type Modifier&quot;);</span>
<span class="nc" id="L1502">        bvText.append(endColumn);</span>
<span class="nc" id="L1503">        bvText.append(startColumn);</span>
<span class="nc" id="L1504">        bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L1505">        bvText.append(typeModifier);</span>
<span class="nc" id="L1506">        bvText.append(endColumn);</span>
<span class="nc" id="L1507">        bvText.append(startColumn);</span>
<span class="nc" id="L1508">        bvText.append(endColumn);</span>

<span class="nc" id="L1510">        dbv *= typeModifier;</span>

<span class="nc" id="L1512">        bvText.append(endRow);</span>
<span class="nc" id="L1513">        bvText.append(startRow);</span>
<span class="nc" id="L1514">        bvText.append(startColumn);</span>
<span class="nc" id="L1515">        bvText.append(&quot;x Target Movement modifier&quot;);</span>
<span class="nc" id="L1516">        bvText.append(endColumn);</span>
        // adjust for target movement modifier
<span class="nc" id="L1518">        double tmmRan = Compute.getTargetMovementModifier(</span>
<span class="nc" id="L1519">                getRunMP(false, true, true), this instanceof VTOL,</span>
<span class="nc" id="L1520">                this instanceof VTOL, game).getValue();</span>
        // for the future, when we implement jumping tanks
<span class="nc bnc" id="L1522" title="All 2 branches missed.">        double tmmJumped = (getJumpMP() &gt; 0) ? Compute.</span>
<span class="nc" id="L1523">                getTargetMovementModifier(getJumpMP(), true, false, game).</span>
<span class="nc" id="L1524">                getValue() : 0;</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">        if (hasStealth()) {</span>
<span class="nc" id="L1526">            tmmRan += 2;</span>
<span class="nc" id="L1527">            tmmJumped += 2;</span>
        }
<span class="nc bnc" id="L1529" title="All 2 branches missed.">        if (getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L1530">            tmmRan += 1;</span>
<span class="nc" id="L1531">            tmmJumped += 1;</span>
        }
<span class="nc" id="L1533">        double tmmFactor = 1 + (Math.max(tmmRan, tmmJumped) / 10);</span>
<span class="nc" id="L1534">        dbv *= tmmFactor;</span>
        // Deal with floating point errors
<span class="nc" id="L1536">        dbv = Math.round(dbv * 100000.0) / 100000.0;</span>

<span class="nc" id="L1538">        bvText.append(startColumn);</span>
<span class="nc" id="L1539">        bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L1540">        bvText.append(tmmFactor);</span>
<span class="nc" id="L1541">        bvText.append(endColumn);</span>
<span class="nc" id="L1542">        bvText.append(endRow);</span>

<span class="nc" id="L1544">        bvText.append(startRow);</span>
<span class="nc" id="L1545">        bvText.append(startColumn);</span>
<span class="nc" id="L1546">        bvText.append(endColumn);</span>
<span class="nc" id="L1547">        bvText.append(startColumn);</span>
<span class="nc" id="L1548">        bvText.append(endColumn);</span>
<span class="nc" id="L1549">        bvText.append(startColumn);</span>
<span class="nc" id="L1550">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1551">        bvText.append(endColumn);</span>
<span class="nc" id="L1552">        bvText.append(endRow);</span>
<span class="nc" id="L1553">        bvText.append(startRow);</span>
<span class="nc" id="L1554">        bvText.append(startColumn);</span>
<span class="nc" id="L1555">        bvText.append(endColumn);</span>
<span class="nc" id="L1556">        bvText.append(startColumn);</span>
<span class="nc" id="L1557">        bvText.append(endColumn);</span>
<span class="nc" id="L1558">        bvText.append(startColumn);</span>
<span class="nc" id="L1559">        bvText.append(dbv);</span>
<span class="nc" id="L1560">        bvText.append(endColumn);</span>
<span class="nc" id="L1561">        bvText.append(endRow);</span>

<span class="nc" id="L1563">        double weaponBV = 0;</span>

        // figure out base weapon bv
<span class="nc" id="L1566">        double weaponsBVFront = 0;</span>
<span class="nc" id="L1567">        double weaponsBVRear = 0;</span>
<span class="nc" id="L1568">        boolean hasTargComp = hasTargComp();</span>
<span class="nc" id="L1569">        double targetingSystemBVMod = 1.0;</span>

<span class="nc bnc" id="L1571" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc bnc" id="L1572" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL)) {</span>
<span class="nc" id="L1573">                targetingSystemBVMod = 1.0;</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">            } else if (hasWorkingMisc(MiscType.F_BASIC_FIRECONTROL)) {</span>
<span class="nc" id="L1575">                targetingSystemBVMod = .9;</span>
            } else {
<span class="nc" id="L1577">                targetingSystemBVMod = .8;</span>
            }
        }

<span class="nc" id="L1581">        bvText.append(startRow);</span>
<span class="nc" id="L1582">        bvText.append(startColumn);</span>
<span class="nc" id="L1583">        bvText.append(&quot;Weapons&quot;);</span>
<span class="nc" id="L1584">        bvText.append(endColumn);</span>
<span class="nc" id="L1585">        bvText.append(startColumn);</span>
<span class="nc" id="L1586">        bvText.append(endColumn);</span>
<span class="nc" id="L1587">        bvText.append(endRow);</span>

<span class="nc" id="L1589">        bvText.append(startRow);</span>
<span class="nc" id="L1590">        bvText.append(startColumn);</span>
        // and add up BVs for ammo-using weapon types for excessive ammo rule
<span class="nc" id="L1592">        Map&lt;String, Double&gt; weaponsForExcessiveAmmo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc bnc" id="L1593" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc" id="L1594">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L1595">            double dBV = wtype.getBV(this);</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1598" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1599">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L1603" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L1604">                continue;</span>
            }
<span class="nc bnc" id="L1606" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L1607">                continue;</span>
            }
<span class="nc bnc" id="L1609" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_M_POD)) {</span>
<span class="nc" id="L1610">                continue;</span>
            }
<span class="nc" id="L1612">            String weaponName = wtype.getName();</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">            if (mounted.getLinkedBy() != null) {</span>
                // check to see if the weapon is a PPC and has a Capacitor
                // attached to it
<span class="nc bnc" id="L1616" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_PPC)) {</span>
<span class="nc" id="L1617">                    dBV += ((MiscType) mounted.getLinkedBy().getType()).getBV(</span>
                            this, mounted);
<span class="nc" id="L1619">                    weaponName = weaponName.concat(&quot; with Capacitor&quot;);</span>
                }
            }


            // calc MG Array here:
<span class="nc bnc" id="L1625" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA)) {</span>
<span class="nc" id="L1626">                double mgBV = 0;</span>
<span class="nc bnc" id="L1627" title="All 2 branches missed.">                for (int eqNum : mounted.getBayWeapons()) {</span>
<span class="nc" id="L1628">                    Mounted mg = getEquipment(eqNum);</span>
<span class="nc bnc" id="L1629" title="All 4 branches missed.">                    if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</span>
<span class="nc" id="L1630">                        mgBV += mg.getType().getBV(this);</span>
                    }
<span class="nc" id="L1632">                }</span>
<span class="nc" id="L1633">                dBV = mgBV * 0.67;</span>
            }

<span class="nc" id="L1636">            bvText.append(weaponName);</span>
<span class="nc" id="L1637">            bvText.append(&quot; &quot;);</span>
<span class="nc" id="L1638">            bvText.append(dBV);</span>

            // artemis bumps up the value
<span class="nc bnc" id="L1641" title="All 2 branches missed.">            if (mounted.getLinkedBy() != null) {</span>
<span class="nc" id="L1642">                Mounted mLinker = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</span>
<span class="nc" id="L1645">                    dBV *= 1.2;</span>
<span class="nc" id="L1646">                    bvText.append(&quot; x 1.2 Artemis IV&quot;);</span>
                }
<span class="nc bnc" id="L1648" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1649" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_PROTO)) {</span>
<span class="nc" id="L1650">                    dBV *= 1.1;</span>
<span class="nc" id="L1651">                    bvText.append(&quot; x 1.1 Artemis IV Prototype&quot;);</span>
                }
<span class="nc bnc" id="L1653" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</span>
<span class="nc" id="L1655">                    dBV *= 1.3;</span>
<span class="nc" id="L1656">                    bvText.append(&quot; x 1.3 Artemis V&quot;);</span>
                }
<span class="nc bnc" id="L1658" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1659" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</span>
<span class="nc" id="L1660">                    dBV *= 1.15;</span>
<span class="nc" id="L1661">                    bvText.append(&quot; x 1.15 Apollo&quot;);</span>
                }
<span class="nc bnc" id="L1663" title="All 2 branches missed.">                if ((mLinker.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1664" title="All 2 branches missed.">                        &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L1665">                    dBV *= 1.15;</span>
<span class="nc" id="L1666">                    bvText.append(&quot; x 1.15 RISC Laser Pulse Module&quot;);</span>
                }
            }
<span class="nc bnc" id="L1669" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L1670">                dBV *= 0.8;</span>
<span class="nc" id="L1671">                bvText.append(&quot; x 0.8 Drone OS&quot;);</span>
            }


            // and we'll add the tcomp here too
<span class="nc bnc" id="L1676" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; hasTargComp) {</span>
<span class="nc" id="L1677">                dBV *= 1.25;</span>
<span class="nc" id="L1678">                bvText.append(&quot; x 1.25 Direct Fire and TC&quot;);</span>
<span class="nc bnc" id="L1679" title="All 4 branches missed.">            } else if (isSupportVehicle() &amp;&amp; !wtype.hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L1680">                dBV *= targetingSystemBVMod;</span>
<span class="nc" id="L1681">                bvText.append(&quot; x &quot;);</span>
<span class="nc" id="L1682">                bvText.append(targetingSystemBVMod);</span>
<span class="nc" id="L1683">                bvText.append(&quot; Targeting System&quot;);</span>
            }
<span class="nc" id="L1685">            bvText.append(endColumn);</span>
<span class="nc" id="L1686">            bvText.append(startColumn);</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">            if (mounted.getLocation() == (this instanceof SuperHeavyTank ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">                    : this instanceof LargeSupportTank ? LargeSupportTank.LOC_REAR</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">                            : LOC_REAR)) {</span>
<span class="nc" id="L1690">                weaponsBVRear += dBV;</span>
<span class="nc" id="L1691">                bvText.append(&quot; Rear&quot;);</span>
<span class="nc bnc" id="L1692" title="All 2 branches missed.">            } else if (mounted.getLocation() == LOC_FRONT) {</span>
<span class="nc" id="L1693">                weaponsBVFront += dBV;</span>
<span class="nc" id="L1694">                bvText.append(&quot; Front&quot;);</span>
            } else {
<span class="nc" id="L1696">                weaponBV += dBV;</span>
<span class="nc" id="L1697">                bvText.append(&quot; Side/Turret&quot;);</span>
            }
            // add up BV of ammo-using weapons for each type of weapon,
            // to compare with ammo BV later for excessive ammo BV rule
<span class="nc bnc" id="L1701" title="All 4 branches missed.">            if (!((wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !((wtype.getAmmoType() == AmmoType.T_PLASMA)</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L1703" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_HEAVY_FLAMER) || (wtype</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">                    .getAmmoType() == AmmoType.T_CHEMICAL_LASER)))</span>
<span class="nc bnc" id="L1705" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L1706" title="All 2 branches missed.">                    || wtype.hasFlag(WeaponType.F_INFANTRY) || (wtype</span>
<span class="nc bnc" id="L1707" title="All 2 branches missed.">                        .getAmmoType() == AmmoType.T_NA))) {</span>
<span class="nc" id="L1708">                String key = wtype.getAmmoType() + &quot;:&quot; + wtype.getRackSize();</span>
<span class="nc bnc" id="L1709" title="All 2 branches missed.">                if (!weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L1710">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this));</span>
                } else {
<span class="nc" id="L1712">                    weaponsForExcessiveAmmo.put(key, wtype.getBV(this)</span>
<span class="nc" id="L1713">                            + weaponsForExcessiveAmmo.get(key));</span>
                }
            }
<span class="nc" id="L1716">            bvText.append(endColumn);</span>
<span class="nc" id="L1717">            bvText.append(startColumn);</span>
<span class="nc" id="L1718">            bvText.append(dBV);</span>
<span class="nc" id="L1719">            bvText.append(endColumn);</span>

<span class="nc" id="L1721">            bvText.append(endRow);</span>

<span class="nc" id="L1723">            bvText.append(startRow);</span>
<span class="nc" id="L1724">            bvText.append(startColumn);</span>
<span class="nc" id="L1725">        }</span>

<span class="nc" id="L1727">        bvText.append(endColumn);</span>
<span class="nc" id="L1728">        bvText.append(endRow);</span>
<span class="nc" id="L1729">        bvText.append(startRow);</span>
<span class="nc" id="L1730">        bvText.append(startColumn);</span>
<span class="nc" id="L1731">        bvText.append(endColumn);</span>
<span class="nc" id="L1732">        bvText.append(startColumn);</span>
<span class="nc" id="L1733">        bvText.append(endColumn);</span>

<span class="nc bnc" id="L1735" title="All 2 branches missed.">        if (weaponsBVFront &gt; weaponsBVRear) {</span>
<span class="nc" id="L1736">            weaponBV += weaponsBVFront;</span>
<span class="nc" id="L1737">            weaponBV += (weaponsBVRear * 0.5);</span>
        } else {
<span class="nc" id="L1739">            weaponBV += weaponsBVRear;</span>
<span class="nc" id="L1740">            weaponBV += (weaponsBVFront * 0.5);</span>
        }

<span class="nc" id="L1743">        bvText.append(startColumn);</span>
<span class="nc" id="L1744">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1745">        bvText.append(weaponBV);</span>
<span class="nc" id="L1746">        bvText.append(endColumn);</span>
<span class="nc" id="L1747">        bvText.append(endRow);</span>

<span class="nc" id="L1749">        bvText.append(startRow);</span>
<span class="nc" id="L1750">        bvText.append(startColumn);</span>
<span class="nc" id="L1751">        bvText.append(endColumn);</span>
<span class="nc" id="L1752">        bvText.append(startColumn);</span>
<span class="nc" id="L1753">        bvText.append(endColumn);</span>
<span class="nc" id="L1754">        bvText.append(startColumn);</span>
<span class="nc" id="L1755">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1756">        bvText.append(endColumn);</span>
<span class="nc" id="L1757">        bvText.append(endRow);</span>

<span class="nc" id="L1759">        bvText.append(startRow);</span>

<span class="nc" id="L1761">        bvText.append(&quot;Ammo BV&quot;);</span>
<span class="nc" id="L1762">        bvText.append(endRow);</span>

<span class="nc" id="L1764">        bvText.append(startRow);</span>
<span class="nc" id="L1765">        bvText.append(startColumn);</span>
<span class="nc" id="L1766">        bvText.append(endColumn);</span>
<span class="nc" id="L1767">        bvText.append(startColumn);</span>
        // add ammo bv
<span class="nc" id="L1769">        double ammoBV = 0;</span>
        // extra BV for when we have semiguided LRMs and someone else has TAG on
        // our team
<span class="nc" id="L1772">        double tagBV = 0;</span>
<span class="nc" id="L1773">        Map&lt;String, Double&gt; ammo = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L1774">        ArrayList&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">        for (Mounted mounted : getAmmo()) {</span>
<span class="nc" id="L1776">            AmmoType atype = (AmmoType) mounted.getType();</span>

            // don't count depleted ammo
<span class="nc bnc" id="L1779" title="All 2 branches missed.">            if (mounted.getUsableShotsLeft() == 0) {</span>
<span class="nc" id="L1780">                continue;</span>
            }

            // don't count AMS, it's defensive
<span class="nc bnc" id="L1784" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_AMS) || (atype.getAmmoType() == AmmoType.T_APDS)) {</span>
<span class="nc" id="L1785">                continue;</span>
            }

            // don't count oneshot ammo, it's considered part of the launcher.
<span class="nc bnc" id="L1789" title="All 2 branches missed.">            if (mounted.getLocation() == Entity.LOC_NONE) {</span>
                // assumption: ammo without a location is for a oneshot weapon
<span class="nc" id="L1791">                continue;</span>
            }

<span class="nc" id="L1794">            bvText.append(atype.getName());</span>
<span class="nc" id="L1795">            bvText.append(endColumn);</span>
<span class="nc" id="L1796">            bvText.append(startColumn);</span>

            // semiguided or homing ammo might count double
<span class="nc bnc" id="L1799" title="All 2 branches missed.">            if ((atype.getMunitionType() == AmmoType.M_SEMIGUIDED)</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">                    || (atype.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L1801">                IPlayer tmpP = getOwner();</span>
                // Okay, actually check for friendly TAG.
<span class="nc bnc" id="L1803" title="All 2 branches missed.">                if (tmpP != null) {</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">                    if (tmpP.hasTAG()) {</span>
<span class="nc" id="L1805">                        tagBV += atype.getBV(this);</span>
<span class="nc bnc" id="L1806" title="All 4 branches missed.">                    } else if ((tmpP.getTeam() != IPlayer.TEAM_NONE)</span>
                            &amp;&amp; (game != null)) {
<span class="nc" id="L1808">                        for (Enumeration&lt;Team&gt; e = game.getTeams(); e</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">                                .hasMoreElements();) {</span>
<span class="nc" id="L1810">                            Team m = e.nextElement();</span>
<span class="nc bnc" id="L1811" title="All 2 branches missed.">                            if (m.getId() == tmpP.getTeam()) {</span>
<span class="nc bnc" id="L1812" title="All 2 branches missed.">                                if (m.hasTAG(game)) {</span>
<span class="nc" id="L1813">                                    tagBV += atype.getBV(this);</span>
<span class="nc" id="L1814">                                    bvText.append(&quot;Tag: &quot;);</span>
<span class="nc" id="L1815">                                    bvText.append(atype.getBV(this));</span>
                                }
                                // A player can't be on two teams.
                                // If we check his team and don't give the
                                // penalty, that's it.
                                break;
                            }
<span class="nc" id="L1822">                        }</span>
                    }
                }
            }
<span class="nc" id="L1826">            String key = atype.getAmmoType() + &quot;:&quot; + atype.getRackSize();</span>
<span class="nc bnc" id="L1827" title="All 2 branches missed.">            if (!keys.contains(key)) {</span>
<span class="nc" id="L1828">                keys.add(key);</span>
            }
<span class="nc bnc" id="L1830" title="All 2 branches missed.">            if (!ammo.containsKey(key)) {</span>
<span class="nc" id="L1831">                ammo.put(key, atype.getBV(this));</span>
            } else {
<span class="nc" id="L1833">                ammo.put(key, atype.getBV(this) + ammo.get(key));</span>
            }
<span class="nc" id="L1835">            bvText.append(&quot;BV: &quot;);</span>
<span class="nc" id="L1836">            bvText.append(atype.getBV(this));</span>
<span class="nc" id="L1837">            bvText.append(endColumn);</span>
<span class="nc" id="L1838">            bvText.append(endRow);</span>
<span class="nc" id="L1839">            bvText.append(startRow);</span>
<span class="nc" id="L1840">            bvText.append(startColumn);</span>
<span class="nc" id="L1841">            bvText.append(endColumn);</span>
<span class="nc" id="L1842">            bvText.append(startColumn);</span>
<span class="nc" id="L1843">        }</span>
<span class="nc" id="L1844">        bvText.append(endColumn);</span>
<span class="nc" id="L1845">        bvText.append(endRow);</span>
        // excessive ammo rule:
        // only count BV for ammo for a weapontype until the BV of all weapons
        // of that
        // type on the mech is reached
<span class="nc bnc" id="L1850" title="All 2 branches missed.">        for (String key : keys) {</span>
            // They dont exist in either hash then dont bother adding nulls.
<span class="nc bnc" id="L1852" title="All 2 branches missed.">            if (!ammo.containsKey(key)</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">                    || !weaponsForExcessiveAmmo.containsKey(key)) {</span>
<span class="nc" id="L1854">                continue;</span>
            }
<span class="nc bnc" id="L1856" title="All 2 branches missed.">            if (ammo.get(key) &gt; weaponsForExcessiveAmmo.get(key)) {</span>
<span class="nc" id="L1857">                ammoBV += weaponsForExcessiveAmmo.get(key);</span>
            } else {
<span class="nc" id="L1859">                ammoBV += ammo.get(key);</span>
            }
<span class="nc" id="L1861">        }</span>
<span class="nc" id="L1862">        ammoBV *= targetingSystemBVMod;</span>

<span class="nc" id="L1864">        bvText.append(startRow);</span>
<span class="nc" id="L1865">        bvText.append(startColumn);</span>
<span class="nc" id="L1866">        bvText.append(endColumn);</span>
<span class="nc" id="L1867">        bvText.append(startColumn);</span>
<span class="nc" id="L1868">        bvText.append(endColumn);</span>
<span class="nc" id="L1869">        bvText.append(startColumn);</span>
<span class="nc" id="L1870">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1871">        bvText.append(ammoBV);</span>
<span class="nc" id="L1872">        bvText.append(endColumn);</span>
<span class="nc" id="L1873">        bvText.append(endRow);</span>

<span class="nc" id="L1875">        weaponBV += ammoBV;</span>

<span class="nc" id="L1877">        bvText.append(startRow);</span>
<span class="nc" id="L1878">        bvText.append(startColumn);</span>
<span class="nc" id="L1879">        bvText.append(endColumn);</span>
<span class="nc" id="L1880">        bvText.append(startColumn);</span>
<span class="nc" id="L1881">        bvText.append(endColumn);</span>
<span class="nc" id="L1882">        bvText.append(startColumn);</span>
<span class="nc" id="L1883">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1884">        bvText.append(endColumn);</span>
<span class="nc" id="L1885">        bvText.append(endRow);</span>

        // add offensive misc. equipment BV (everything except AMS, A-Pod, ECM -
        // BMR p152)
<span class="nc" id="L1889">        bvText.append(startRow);</span>
<span class="nc" id="L1890">        bvText.append(startColumn);</span>
<span class="nc" id="L1891">        bvText.append(&quot;Offensive Equipment&quot;);</span>
<span class="nc" id="L1892">        bvText.append(endColumn);</span>
<span class="nc" id="L1893">        bvText.append(endRow);</span>
<span class="nc" id="L1894">        bvText.append(startRow);</span>
<span class="nc" id="L1895">        bvText.append(startColumn);</span>
<span class="nc" id="L1896">        bvText.append(endColumn);</span>
<span class="nc" id="L1897">        bvText.append(startColumn);</span>

<span class="nc" id="L1899">        double oEquipmentBV = 0;</span>
<span class="nc bnc" id="L1900" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L1901">            MiscType mtype = (MiscType) mounted.getType();</span>

            // don't count destroyed equipment
<span class="nc bnc" id="L1904" title="All 2 branches missed.">            if (mounted.isDestroyed()) {</span>
<span class="nc" id="L1905">                continue;</span>
            }

<span class="nc bnc" id="L1908" title="All 2 branches missed.">            if ((mtype.hasFlag(MiscType.F_ECM) &amp;&amp; !mtype</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">                    .hasFlag(MiscType.F_WATCHDOG))</span>
<span class="nc bnc" id="L1910" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_AP_POD)</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_CHAFF_POD)</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L1916" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_BULLDOZER)</span>
<span class="nc bnc" id="L1917" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_TARGCOMP)</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">                    || mtype.hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L1919">                continue;</span>
            }
<span class="nc" id="L1921">            double bv = mtype.getBV(this, mounted.getLocation());</span>
            // we need to special case watchdog, because it has both offensive
            // and defensive BV
<span class="nc bnc" id="L1924" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_WATCHDOG)) {</span>
<span class="nc" id="L1925">                bv = 7;</span>
            }
<span class="nc" id="L1927">            oEquipmentBV += bv;</span>
<span class="nc" id="L1928">            bvText.append(mounted.getName());</span>
<span class="nc" id="L1929">            bvText.append(endColumn);</span>
<span class="nc" id="L1930">            bvText.append(startColumn);</span>
<span class="nc" id="L1931">            bvText.append(bv);</span>
<span class="nc" id="L1932">            bvText.append(endColumn);</span>
<span class="nc" id="L1933">            bvText.append(endRow);</span>
<span class="nc" id="L1934">            bvText.append(startRow);</span>
<span class="nc" id="L1935">            bvText.append(startColumn);</span>
<span class="nc" id="L1936">            bvText.append(endColumn);</span>
<span class="nc" id="L1937">            bvText.append(startColumn);</span>
<span class="nc" id="L1938">        }</span>

<span class="nc" id="L1940">        bvText.append(endRow);</span>
<span class="nc" id="L1941">        bvText.append(startRow);</span>
<span class="nc" id="L1942">        bvText.append(startColumn);</span>
<span class="nc" id="L1943">        bvText.append(endColumn);</span>
<span class="nc" id="L1944">        bvText.append(startColumn);</span>
<span class="nc" id="L1945">        bvText.append(endColumn);</span>
<span class="nc" id="L1946">        bvText.append(startColumn);</span>
<span class="nc" id="L1947">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1948">        bvText.append(oEquipmentBV);</span>
<span class="nc" id="L1949">        bvText.append(endColumn);</span>
<span class="nc" id="L1950">        bvText.append(endRow);</span>

<span class="nc" id="L1952">        weaponBV += oEquipmentBV;</span>

<span class="nc" id="L1954">        bvText.append(startRow);</span>
<span class="nc" id="L1955">        bvText.append(startColumn);</span>
<span class="nc" id="L1956">        bvText.append(endColumn);</span>
<span class="nc" id="L1957">        bvText.append(startColumn);</span>
<span class="nc" id="L1958">        bvText.append(endColumn);</span>
<span class="nc" id="L1959">        bvText.append(startColumn);</span>
<span class="nc" id="L1960">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L1961">        bvText.append(endColumn);</span>
<span class="nc" id="L1962">        bvText.append(endRow);</span>

<span class="nc" id="L1964">        bvText.append(startRow);</span>
<span class="nc" id="L1965">        bvText.append(startColumn);</span>
<span class="nc" id="L1966">        bvText.append(&quot;+ weight / 2&quot;);</span>
<span class="nc" id="L1967">        bvText.append(endColumn);</span>
<span class="nc" id="L1968">        bvText.append(startColumn);</span>
<span class="nc" id="L1969">        bvText.append(getWeight());</span>
<span class="nc" id="L1970">        bvText.append(&quot; / 2 &quot;);</span>
<span class="nc" id="L1971">        bvText.append(endColumn);</span>
<span class="nc" id="L1972">        bvText.append(startColumn);</span>
<span class="nc" id="L1973">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L1974">        bvText.append(getWeight() / 2);</span>
<span class="nc" id="L1975">        bvText.append(endColumn);</span>
<span class="nc" id="L1976">        bvText.append(endRow);</span>

<span class="nc" id="L1978">        weaponBV += getWeight() / 2;</span>

        // adjust further for speed factor
<span class="nc" id="L1981">        double runMP = getRunMP(false, true, true);</span>

        // Trains use cruise instead of flank MP for speed factor
<span class="nc bnc" id="L1984" title="All 4 branches missed.">        if (getMovementMode().equals(EntityMovementMode.RAIL) || getMovementMode().equals(EntityMovementMode.MAGLEV)) {</span>
<span class="nc" id="L1985">            runMP = getWalkMP(false, true, true);</span>
        }
        // trailers have original run MP of 0, but should count at 1 for speed
        // factor calculation
<span class="nc bnc" id="L1989" title="All 2 branches missed.">        if (getOriginalRunMP() == 0) {</span>
<span class="nc" id="L1990">            runMP = 1;</span>
        }
<span class="nc" id="L1992">        double speedFactor = Math</span>
<span class="nc" id="L1993">                .pow(1 + (((runMP + (Math.round(getJumpMP(false) / 2.0))) - 5)</span>
                 / 10), 1.2);
<span class="nc" id="L1995">        speedFactor = Math.round(speedFactor * 100) / 100.0;</span>

<span class="nc" id="L1997">        obv = weaponBV * speedFactor;</span>

<span class="nc" id="L1999">        bvText.append(startRow);</span>
<span class="nc" id="L2000">        bvText.append(startColumn);</span>
<span class="nc" id="L2001">        bvText.append(&quot;+ weapons bv * speed factor&quot;);</span>
<span class="nc" id="L2002">        bvText.append(endColumn);</span>
<span class="nc" id="L2003">        bvText.append(startColumn);</span>
<span class="nc" id="L2004">        bvText.append(weaponBV);</span>
<span class="nc" id="L2005">        bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L2006">        bvText.append(speedFactor);</span>
<span class="nc" id="L2007">        bvText.append(endColumn);</span>
<span class="nc" id="L2008">        bvText.append(startColumn);</span>
<span class="nc" id="L2009">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L2010">        bvText.append(obv);</span>
<span class="nc" id="L2011">        bvText.append(endColumn);</span>
<span class="nc" id="L2012">        bvText.append(endRow);</span>

<span class="nc" id="L2014">        bvText.append(startRow);</span>
<span class="nc" id="L2015">        bvText.append(startColumn);</span>
<span class="nc" id="L2016">        bvText.append(endColumn);</span>
<span class="nc" id="L2017">        bvText.append(startColumn);</span>
<span class="nc" id="L2018">        bvText.append(endColumn);</span>
<span class="nc" id="L2019">        bvText.append(startColumn);</span>
<span class="nc" id="L2020">        bvText.append(&quot;--------------&quot;);</span>
<span class="nc" id="L2021">        bvText.append(endColumn);</span>
<span class="nc" id="L2022">        bvText.append(endRow);</span>

        double finalBV;
<span class="nc bnc" id="L2025" title="All 2 branches missed.">        if (useGeometricMeanBV()) {</span>
<span class="nc" id="L2026">            finalBV = 2 * Math.sqrt(obv * dbv);</span>
<span class="nc bnc" id="L2027" title="All 2 branches missed.">            if (finalBV == 0) {</span>
<span class="nc" id="L2028">                finalBV = dbv + obv;</span>
            }
        } else {
<span class="nc" id="L2031">            finalBV = dbv + obv;</span>
        }
<span class="nc" id="L2033">        double totalBV = finalBV;</span>

<span class="nc bnc" id="L2035" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L2036">            finalBV *= 0.95;</span>
<span class="nc" id="L2037">            finalBV = Math.round(finalBV);</span>
<span class="nc" id="L2038">            bvText.append(startRow);</span>
<span class="nc" id="L2039">            bvText.append(startColumn);</span>
<span class="nc" id="L2040">            bvText.append(&quot;Total BV * Drone Operating System Modifier&quot;);</span>
<span class="nc" id="L2041">            bvText.append(endColumn);</span>
<span class="nc" id="L2042">            bvText.append(startColumn);</span>
<span class="nc" id="L2043">            bvText.append(totalBV);</span>
<span class="nc" id="L2044">            bvText.append(&quot; * &quot;);</span>
<span class="nc" id="L2045">            bvText.append(&quot;0.95&quot;);</span>
<span class="nc" id="L2046">            bvText.append(endColumn);</span>
<span class="nc" id="L2047">            bvText.append(startColumn);</span>
<span class="nc" id="L2048">            bvText.append(&quot; = &quot;);</span>
<span class="nc" id="L2049">            bvText.append(finalBV);</span>
<span class="nc" id="L2050">            bvText.append(endColumn);</span>
<span class="nc" id="L2051">            bvText.append(endRow);</span>

<span class="nc" id="L2053">            bvText.append(startRow);</span>
<span class="nc" id="L2054">            bvText.append(startColumn);</span>
<span class="nc" id="L2055">            bvText.append(endColumn);</span>
<span class="nc" id="L2056">            bvText.append(startColumn);</span>
<span class="nc" id="L2057">            bvText.append(endColumn);</span>
<span class="nc" id="L2058">            bvText.append(startColumn);</span>

<span class="nc" id="L2060">            bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2061">            bvText.append(endColumn);</span>
<span class="nc" id="L2062">            bvText.append(endRow);</span>
        }

<span class="nc" id="L2065">        bvText.append(startRow);</span>
<span class="nc" id="L2066">        bvText.append(startColumn);</span>
<span class="nc" id="L2067">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L2068">        bvText.append(endColumn);</span>
<span class="nc" id="L2069">        bvText.append(startColumn);</span>
<span class="nc" id="L2070">        bvText.append(endColumn);</span>
<span class="nc" id="L2071">        bvText.append(startColumn);</span>

<span class="nc" id="L2073">        bvText.append(finalBV);</span>
<span class="nc" id="L2074">        bvText.append(endColumn);</span>
<span class="nc" id="L2075">        bvText.append(endRow);</span>

        // we get extra bv from some stuff
<span class="nc" id="L2078">        double xbv = 0.0;</span>
        // extra BV for semi-guided lrm when TAG in our team
<span class="nc" id="L2080">        xbv += tagBV;</span>
<span class="nc bnc" id="L2081" title="All 2 branches missed.">        if (!ignoreC3) {</span>
<span class="nc" id="L2082">            xbv += getExtraC3BV((int) Math.round(finalBV));</span>
        }

<span class="nc" id="L2085">        finalBV = Math.round(finalBV + xbv);</span>

        // and then factor in pilot
<span class="nc" id="L2088">        double pilotFactor = 1;</span>
<span class="nc bnc" id="L2089" title="All 4 branches missed.">        if (!ignorePilot &amp;&amp; (null != getCrew())) {</span>
<span class="nc" id="L2090">            pilotFactor = getCrew().getBVSkillMultiplier(game);</span>
        }

<span class="nc" id="L2093">        int retVal = (int) Math.round((finalBV) * pilotFactor);</span>

<span class="nc" id="L2095">        bvText.append(startRow);</span>
<span class="nc" id="L2096">        bvText.append(startColumn);</span>
<span class="nc" id="L2097">        bvText.append(&quot;Final BV&quot;);</span>
<span class="nc" id="L2098">        bvText.append(endColumn);</span>
<span class="nc" id="L2099">        bvText.append(startColumn);</span>
<span class="nc" id="L2100">        bvText.append(endColumn);</span>
<span class="nc" id="L2101">        bvText.append(startColumn);</span>
<span class="nc" id="L2102">        bvText.append(&quot;= &quot;);</span>
<span class="nc" id="L2103">        bvText.append(retVal);</span>
<span class="nc" id="L2104">        bvText.append(endColumn);</span>
<span class="nc" id="L2105">        bvText.append(endRow);</span>

<span class="nc" id="L2107">        return retVal;</span>
    }

    @Override
    public PilotingRollData addEntityBonuses(PilotingRollData prd) {
<span class="nc bnc" id="L2112" title="All 2 branches missed.">        if (motivePenalty &gt; 0) {</span>
<span class="nc" id="L2113">            prd.addModifier(motivePenalty, &quot;Steering Damage&quot;);</span>
        }
<span class="nc bnc" id="L2115" title="All 2 branches missed.">        if (commanderHit) {</span>
<span class="nc" id="L2116">            prd.addModifier(1, &quot;commander injured&quot;);</span>
        }
<span class="nc bnc" id="L2118" title="All 2 branches missed.">        if (driverHit) {</span>
<span class="nc" id="L2119">            prd.addModifier(2, &quot;driver injured&quot;);</span>
        }

        // are we wheeled and in light snow?
<span class="nc" id="L2123">        IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L2124" title="All 4 branches missed.">        if ((null != hex) &amp;&amp; (getMovementMode() == EntityMovementMode.WHEELED)</span>
<span class="nc bnc" id="L2125" title="All 2 branches missed.">                &amp;&amp; (hex.terrainLevel(Terrains.SNOW) == 1)) {</span>
<span class="nc" id="L2126">            prd.addModifier(1, &quot;thin snow&quot;);</span>
        }

        // VDNI bonus?
<span class="nc bnc" id="L2130" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L2131" title="All 2 branches missed.">                &amp;&amp; !hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L2132">            prd.addModifier(-1, &quot;VDNI&quot;);</span>
        }

<span class="nc bnc" id="L2135" title="All 2 branches missed.">        if (hasModularArmor()) {</span>
<span class="nc" id="L2136">            prd.addModifier(1, &quot;Modular Armor&quot;);</span>
        }

<span class="nc" id="L2139">        return prd;</span>
    }
    
    @Override
    public boolean usesTurnMode() {
<span class="nc bnc" id="L2144" title="All 4 branches missed.">        return game != null &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TURN_MODE);</span>
    }

    @Override
    public Vector&lt;Report&gt; victoryReport() {
<span class="nc" id="L2149">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>

<span class="nc" id="L2151">        Report r = new Report(7025);</span>
<span class="nc" id="L2152">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L2153">        r.addDesc(this);</span>
<span class="nc" id="L2154">        vDesc.addElement(r);</span>

<span class="nc" id="L2156">        r = new Report(7035);</span>
<span class="nc" id="L2157">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L2158">        r.newlines = 0;</span>
<span class="nc" id="L2159">        vDesc.addElement(r);</span>
<span class="nc" id="L2160">        vDesc.addAll(getCrew().getDescVector(false));</span>
<span class="nc" id="L2161">        r = new Report(7070, Report.PUBLIC);</span>
<span class="nc" id="L2162">        r.add(getKillNumber());</span>
<span class="nc" id="L2163">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L2165" title="All 2 branches missed.">        if (isDestroyed()) {</span>
<span class="nc" id="L2166">            Entity killer = game.getEntity(killerId);</span>
<span class="nc bnc" id="L2167" title="All 2 branches missed.">            if (killer == null) {</span>
<span class="nc" id="L2168">                killer = game.getOutOfGameEntity(killerId);</span>
            }
<span class="nc bnc" id="L2170" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L2171">                r = new Report(7072, Report.PUBLIC);</span>
<span class="nc" id="L2172">                r.addDesc(killer);</span>
            } else {
<span class="nc" id="L2174">                r = new Report(7073, Report.PUBLIC);</span>
            }
<span class="nc" id="L2176">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L2177" title="All 2 branches missed.">        } else if (getCrew().isEjected()) {</span>
<span class="nc" id="L2178">            r = new Report(7071, Report.PUBLIC);</span>
<span class="nc" id="L2179">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L2181">        r.newlines = 2;</span>

<span class="nc" id="L2183">        return vDesc;</span>
    }

    @Override
    public int[] getNoOfSlots() {
<span class="nc" id="L2188">        return NUM_OF_SLOTS;</span>
    }

    /**
     * Tanks don't have MASC
     */
    @Override
    public int getRunMPwithoutMASC(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc" id="L2197">        return super.getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getRunMP(boolean, boolean, boolean)
     */
    @Override
    public int getRunMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc bnc" id="L2208" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L2209">            return (getWalkMP(gravity, ignoreheat, ignoremodulararmor) * 2);</span>
        }
<span class="nc" id="L2211">        return getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMP()
     */
    @Override
    public int getSprintMP() {
        // Overdrive
<span class="nc bnc" id="L2222" title="All 2 branches missed.">        if (game != null</span>
<span class="nc bnc" id="L2223" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2224">            return getSprintMP(true, false, false);</span>
        }
<span class="nc" id="L2226">        return getSprintMP(true, false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMP(boolean, boolean, boolean)
     */
    @Override
    public int getSprintMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc bnc" id="L2237" title="All 2 branches missed.">        if (game != null &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L2238" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">            if (hasArmedMASC()) {</span>
<span class="nc" id="L2240">                return (int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                        ignoremodulararmor) * 2.5);
            } else {
<span class="nc" id="L2243">                return getSprintMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
            }
        } else {
<span class="nc" id="L2246">            return getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
        }
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMPwithoutMASC(boolean, boolean)
     */
    @Override
    public int getSprintMPwithoutMASC() {
<span class="nc" id="L2257">        return getSprintMPwithoutMASC(true, false, false);</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getSprintMPwithoutMASC(boolean, boolean,
     * boolean)
     */
    @Override
    public int getSprintMPwithoutMASC(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc bnc" id="L2269" title="All 2 branches missed.">        if (game != null &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L2270" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2271">            return (int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                    ignoremodulararmor) * 2.0);
        } else {
<span class="nc" id="L2274">            return getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
        }
    }

    public int getOriginalSprintMPwithoutMASC() {
<span class="nc bnc" id="L2279" title="All 2 branches missed.">        if (game != null &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L2280" title="All 2 branches missed.">                .booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2281">            return (int) Math.ceil(getOriginalWalkMP() * 2.0);</span>
        } else {
<span class="nc" id="L2283">            return getOriginalRunMP();</span>
        }
    }

    /**
     * Returns this entity's Sprint mp as a string.
     */
    @Override
    public String getSprintMPasString() {
<span class="nc bnc" id="L2292" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L2293">            return getRunMPwithoutMASC() + &quot;(&quot; + getSprintMP() + &quot;)&quot;;</span>
        }
<span class="nc" id="L2295">        return Integer.toString(getSprintMP());</span>
    }

    @Override
    public int getRunningGravityLimit() {
<span class="nc bnc" id="L2300" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ADVANCED_MANEUVERS)) {</span>
<span class="nc" id="L2301">            return getSprintMP(false, false, false);</span>
        }
<span class="nc" id="L2303">        return getRunMP(false, false, false);</span>
    }

    @Override
    public int getHeatCapacity(boolean radicalHeatSinks) {
<span class="nc" id="L2308">        return DOES_NOT_TRACK_HEAT;</span>
    }

    @Override
    public int getHeatCapacityWithWater() {
<span class="nc" id="L2313">        return getHeatCapacity();</span>
    }

    @Override
    public int getEngineCritHeat() {
<span class="nc" id="L2318">        return 0;</span>
    }

    @Override
    public void autoSetInternal() {
<span class="nc" id="L2323">        int nInternal = (int) Math.ceil(weight / 10.0);</span>

        // No internals in the body location.
<span class="nc" id="L2326">        initializeInternal(IArmorState.ARMOR_NA, LOC_BODY);</span>

<span class="nc bnc" id="L2328" title="All 2 branches missed.">        for (int x = 1; x &lt; locations(); x++) {</span>
<span class="nc" id="L2329">            initializeInternal(nInternal, x);</span>
        }
<span class="nc" id="L2331">    }</span>

    @Override
    public int getMaxElevationChange() {
<span class="nc" id="L2335">        return 1;</span>
    }

    @Override
    public int getMaxElevationDown(int currElevation) {
        // WIGEs can go down as far as they want
        // 50 is a pretty arbitrary max amount, but that's also the
        // highest elevation for VTOLs, so I'll just use that
<span class="nc bnc" id="L2343" title="All 2 branches missed.">        if ((currElevation &gt; 0)</span>
<span class="nc bnc" id="L2344" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() == EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L2345">            return 50;</span>
        }
<span class="nc" id="L2347">        return super.getMaxElevationDown(currElevation);</span>
    }

    /**
     * Determine if the unit can be repaired, or only harvested for spares.
     *
     * @return A &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit can
     *         be repaired (given enough time and parts); if this value is
     *         &lt;code&gt;false&lt;/code&gt;, the unit is only a source of spares.
     * @see Entity#isSalvage()
     */
    @Override
    public boolean isRepairable() {
        // A tank is repairable if it is salvageable,
        // and none of its body internals are gone.
<span class="nc" id="L2362">        boolean retval = isSalvage();</span>
<span class="nc" id="L2363">        int loc = Tank.LOC_FRONT;</span>
<span class="nc bnc" id="L2364" title="All 4 branches missed.">        while (retval &amp;&amp; (loc &lt; getLocTurret())) {</span>
<span class="nc" id="L2365">            int loc_is = this.getInternal(loc);</span>
<span class="nc" id="L2366">            loc++;</span>
<span class="nc bnc" id="L2367" title="All 4 branches missed.">            retval = (loc_is != IArmorState.ARMOR_DOOMED)</span>
                    &amp;&amp; (loc_is != IArmorState.ARMOR_DESTROYED);
<span class="nc" id="L2369">        }</span>
<span class="nc" id="L2370">        return retval;</span>
    }

    @Override
    public boolean canCharge() {
        // Tanks can charge, except Hovers when the option is set, and WIGEs
<span class="nc bnc" id="L2376" title="All 2 branches missed.">        return super.canCharge()</span>
<span class="nc bnc" id="L2377" title="All 2 branches missed.">                &amp;&amp; !(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_HOVER_CHARGE)</span>
<span class="nc bnc" id="L2378" title="All 2 branches missed.">                        &amp;&amp; (EntityMovementMode.HOVER == getMovementMode()))</span>
<span class="nc bnc" id="L2379" title="All 4 branches missed.">                &amp;&amp; !(EntityMovementMode.WIGE == getMovementMode()) &amp;&amp; !(getStunnedTurns() &gt; 0);</span>
    }

    @Override
    public boolean canDFA() {
        // Tanks can't DFA
<span class="nc" id="L2385">        return false;</span>
    }

    /**
     * @return suspension factor of vehicle
     */
    public int getSuspensionFactor() {
<span class="nc" id="L2392">        return getSuspensionFactor(getMovementMode(), weight);</span>
    }
    
    /**
     * Static method to calculate suspension factor without needing a vehicle
     */
    public static int getSuspensionFactor(EntityMovementMode movementMode, double weight) {
<span class="nc bnc" id="L2399" title="All 8 branches missed.">        switch (movementMode) {</span>
            case HOVER:
<span class="nc bnc" id="L2401" title="All 2 branches missed.">                if (weight &lt;= 10) {</span>
<span class="nc" id="L2402">                    return 40;</span>
                }
<span class="nc bnc" id="L2404" title="All 2 branches missed.">                if (weight &lt;= 20) {</span>
<span class="nc" id="L2405">                    return 85;</span>
                }
<span class="nc bnc" id="L2407" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2408">                    return 130;</span>
                }
<span class="nc bnc" id="L2410" title="All 2 branches missed.">                if (weight &lt;= 40) {</span>
<span class="nc" id="L2411">                    return 175;</span>
                }
<span class="nc bnc" id="L2413" title="All 2 branches missed.">                if (weight &lt;= 50) {</span>
<span class="nc" id="L2414">                    return 235;</span>
                } else {
<span class="nc" id="L2416">                    return 235 + (45 * (int) Math.ceil((weight - 50) / 25f));</span>
                }
            case HYDROFOIL:
<span class="nc bnc" id="L2419" title="All 2 branches missed.">                if (weight &lt;= 10) {</span>
<span class="nc" id="L2420">                    return 60;</span>
                }
<span class="nc bnc" id="L2422" title="All 2 branches missed.">                if (weight &lt;= 20) {</span>
<span class="nc" id="L2423">                    return 105;</span>
                }
<span class="nc bnc" id="L2425" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2426">                    return 150;</span>
                }
<span class="nc bnc" id="L2428" title="All 2 branches missed.">                if (weight &lt;= 40) {</span>
<span class="nc" id="L2429">                    return 195;</span>
                }
<span class="nc bnc" id="L2431" title="All 2 branches missed.">                if (weight &lt;= 50) {</span>
<span class="nc" id="L2432">                    return 255;</span>
                }
<span class="nc bnc" id="L2434" title="All 2 branches missed.">                if (weight &lt;= 60) {</span>
<span class="nc" id="L2435">                    return 300;</span>
                }
<span class="nc bnc" id="L2437" title="All 2 branches missed.">                if (weight &lt;= 70) {</span>
<span class="nc" id="L2438">                    return 345;</span>
                }
<span class="nc bnc" id="L2440" title="All 2 branches missed.">                if (weight &lt;= 80) {</span>
<span class="nc" id="L2441">                    return 390;</span>
                }
<span class="nc bnc" id="L2443" title="All 2 branches missed.">                if (weight &lt;= 90) {</span>
<span class="nc" id="L2444">                    return 435;</span>
                }
<span class="nc" id="L2446">                return 480;</span>
            case NAVAL:
            case SUBMARINE:
<span class="nc bnc" id="L2449" title="All 2 branches missed.">                if (weight &lt;= 300) {</span>
<span class="nc" id="L2450">                    return 30;</span>
                } else {
<span class="nc" id="L2452">                    int factor = (int) Math.ceil(weight / 10);</span>
<span class="nc" id="L2453">                    factor += factor % 5;</span>
<span class="nc" id="L2454">                    return factor;</span>
                }

            case TRACKED:
<span class="nc" id="L2458">                return 0;</span>
            case WHEELED:
<span class="nc bnc" id="L2460" title="All 2 branches missed.">                if (weight &lt;= 80) {</span>
<span class="nc" id="L2461">                    return 20;</span>
                } else {
<span class="nc" id="L2463">                    return 40;</span>
                }
            case VTOL:
<span class="nc bnc" id="L2466" title="All 2 branches missed.">                if (weight &lt;= 10) {</span>
<span class="nc" id="L2467">                    return 50;</span>
                }
<span class="nc bnc" id="L2469" title="All 2 branches missed.">                if (weight &lt;= 20) {</span>
<span class="nc" id="L2470">                    return 95;</span>
                }
<span class="nc bnc" id="L2472" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2473">                    return 140;</span>
                } else {
<span class="nc" id="L2475">                    return 140 + (45 * (int) Math.ceil((weight - 30) / 20f));</span>
                }

            case WIGE:
<span class="nc bnc" id="L2479" title="All 2 branches missed.">                if (weight &lt;= 15) {</span>
<span class="nc" id="L2480">                    return 45;</span>
                }
<span class="nc bnc" id="L2482" title="All 2 branches missed.">                if (weight &lt;= 30) {</span>
<span class="nc" id="L2483">                    return 80;</span>
                }
<span class="nc bnc" id="L2485" title="All 2 branches missed.">                if (weight &lt;= 45) {</span>
<span class="nc" id="L2486">                    return 115;</span>
                }
<span class="nc bnc" id="L2488" title="All 2 branches missed.">                if (weight &lt;= 80) {</span>
<span class="nc" id="L2489">                    return 140;</span>
                } else {
<span class="nc" id="L2491">                    return 140 + (35 * (int) Math.ceil((weight - 80) / 30f));</span>
                }
            default:
<span class="nc" id="L2494">                return 0;</span>
        }
    }

    private void addCostDetails(double cost, double[] costs) {
<span class="nc" id="L2499">        bvText = new StringBuffer();</span>
<span class="nc" id="L2500">        ArrayList&lt;String&gt; left = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L2502" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2503">            left.add(&quot;Chassis&quot;);</span>
        }
<span class="nc" id="L2505">        left.add(&quot;Engine&quot;);</span>
<span class="nc" id="L2506">        left.add(&quot;Armor&quot;);</span>
<span class="nc bnc" id="L2507" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2508">            left.add(&quot;Final Structural Cost&quot;);</span>
        } else {
<span class="nc" id="L2510">            left.add(&quot;Internal Structure&quot;);</span>
<span class="nc" id="L2511">            left.add(&quot;Control Systems&quot;);</span>
        }
<span class="nc" id="L2513">        left.add(&quot;Power Amplifiers&quot;);</span>
<span class="nc" id="L2514">        left.add(&quot;Heat Sinks&quot;);</span>
<span class="nc" id="L2515">        left.add(&quot;Turret&quot;);</span>
<span class="nc" id="L2516">        left.add(&quot;Equipment&quot;);</span>
<span class="nc bnc" id="L2517" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc" id="L2518">            left.add(&quot;Lift Equipment&quot;);</span>
        }
<span class="nc" id="L2520">        left.add(&quot;Omni Multiplier&quot;);</span>
<span class="nc" id="L2521">        left.add(&quot;Tonnage Multiplier&quot;);</span>
<span class="nc bnc" id="L2522" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>

<span class="nc" id="L2524">            left.add(&quot;Flotation Hull/Environmental Sealing multiplier&quot;);</span>
<span class="nc" id="L2525">            left.add(&quot;Off-Road Multiplier&quot;);</span>
        }

<span class="nc" id="L2528">        NumberFormat commafy = NumberFormat.getInstance();</span>

<span class="nc" id="L2530">        bvText.append(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Cost Calculations For &quot;);</span>
<span class="nc" id="L2531">        bvText.append(getChassis());</span>
<span class="nc" id="L2532">        bvText.append(&quot; &quot;);</span>
<span class="nc" id="L2533">        bvText.append(getModel());</span>
<span class="nc" id="L2534">        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</span>
<span class="nc" id="L2535">        bvText.append(nl);</span>

<span class="nc" id="L2537">        bvText.append(startTable);</span>
        // find the maximum length of the columns.
<span class="nc bnc" id="L2539" title="All 2 branches missed.">        for (int l = 0; l &lt; left.size(); l++) {</span>

<span class="nc bnc" id="L2541" title="All 2 branches missed.">            if (l == 7) {</span>
<span class="nc" id="L2542">                getWeaponsAndEquipmentCost(true);</span>
            }else {
<span class="nc bnc" id="L2544" title="All 2 branches missed.">                if (left.get(l).equals(&quot;Final Structural Cost&quot;)) {</span>
<span class="nc" id="L2545">                    bvText.append(startRow);</span>
<span class="nc" id="L2546">                    bvText.append(startColumn);</span>
<span class="nc" id="L2547">                    bvText.append(endColumn);</span>
<span class="nc" id="L2548">                    bvText.append(startColumn);</span>
<span class="nc" id="L2549">                    bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2550">                    bvText.append(endColumn);</span>
<span class="nc" id="L2551">                    bvText.append(endRow);</span>
                }
<span class="nc" id="L2553">                bvText.append(startRow);</span>
<span class="nc" id="L2554">                bvText.append(startColumn);</span>
<span class="nc" id="L2555">                bvText.append(left.get(l));</span>
<span class="nc" id="L2556">                bvText.append(endColumn);</span>
<span class="nc" id="L2557">                bvText.append(startColumn);</span>

<span class="nc bnc" id="L2559" title="All 2 branches missed.">                if (costs[l] == 0) {</span>
<span class="nc" id="L2560">                    bvText.append(&quot;N/A&quot;);</span>
<span class="nc bnc" id="L2561" title="All 2 branches missed.">                } else if (costs[l] &lt; 0) {</span>
<span class="nc" id="L2562">                    bvText.append(&quot;x &quot;);</span>
<span class="nc" id="L2563">                    bvText.append(commafy.format(-costs[l]));</span>
                } else {
<span class="nc" id="L2565">                    bvText.append(commafy.format(costs[l]));</span>

                }
<span class="nc" id="L2568">                bvText.append(endColumn);</span>
<span class="nc" id="L2569">                bvText.append(endRow);</span>
            }
        }
<span class="nc" id="L2572">        bvText.append(startRow);</span>
<span class="nc" id="L2573">        bvText.append(startColumn);</span>
<span class="nc" id="L2574">        bvText.append(endColumn);</span>
<span class="nc" id="L2575">        bvText.append(startColumn);</span>
<span class="nc" id="L2576">        bvText.append(&quot;-------------&quot;);</span>
<span class="nc" id="L2577">        bvText.append(endColumn);</span>
<span class="nc" id="L2578">        bvText.append(endRow);</span>

<span class="nc" id="L2580">        bvText.append(startRow);</span>
<span class="nc" id="L2581">        bvText.append(startColumn);</span>
<span class="nc" id="L2582">        bvText.append(&quot;Total Cost:&quot;);</span>
<span class="nc" id="L2583">        bvText.append(endColumn);</span>
<span class="nc" id="L2584">        bvText.append(startColumn);</span>
<span class="nc" id="L2585">        bvText.append(commafy.format(cost));</span>
<span class="nc" id="L2586">        bvText.append(endColumn);</span>
<span class="nc" id="L2587">        bvText.append(endRow);</span>

<span class="nc" id="L2589">        bvText.append(endTable);</span>
<span class="nc" id="L2590">        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</span>
<span class="nc" id="L2591">    }</span>

    @Override
    public double getCost(boolean ignoreAmmo) {
<span class="nc" id="L2595">        double[] costs = new double[13 + locations()];</span>
<span class="nc" id="L2596">        int i = 0;</span>
        // Chassis cost for Support Vehicles
<span class="nc bnc" id="L2598" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2599">            double chassisCost = 2500 * SupportVeeStructure.getWeightStructure(this);</span>
<span class="nc bnc" id="L2600" title="All 2 branches missed.">            if (hasMisc(MiscType.F_AMPHIBIOUS)) {</span>
<span class="nc" id="L2601">                chassisCost *= 1.25;</span>
            }
<span class="nc bnc" id="L2603" title="All 2 branches missed.">            if (hasMisc(MiscType.F_ARMORED_CHASSIS)) {</span>
<span class="nc" id="L2604">                chassisCost *= 2.0;</span>
            }
<span class="nc bnc" id="L2606" title="All 2 branches missed.">            if (hasMisc(MiscType.F_BICYCLE)) {</span>
<span class="nc" id="L2607">                chassisCost *= 0.75;</span>
            }
<span class="nc bnc" id="L2609" title="All 2 branches missed.">            if (hasMisc(MiscType.F_CONVERTIBLE)) {</span>
<span class="nc" id="L2610">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2612" title="All 2 branches missed.">            if (hasMisc(MiscType.F_DUNE_BUGGY)) {</span>
<span class="nc" id="L2613">                chassisCost *= 1.25;</span>
            }
<span class="nc bnc" id="L2615" title="All 2 branches missed.">            if (hasMisc(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L2616">                chassisCost *= 1.75;</span>
            }
<span class="nc bnc" id="L2618" title="All 2 branches missed.">            if (hasMisc(MiscType.F_EXTERNAL_POWER_PICKUP)) {</span>
<span class="nc" id="L2619">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2621" title="All 2 branches missed.">            if (hasMisc(MiscType.F_HYDROFOIL)) {</span>
<span class="nc" id="L2622">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2624" title="All 2 branches missed.">            if (hasMisc(MiscType.F_MONOCYCLE)) {</span>
<span class="nc" id="L2625">                chassisCost *= 1.3;</span>
            }
<span class="nc bnc" id="L2627" title="All 2 branches missed.">            if (hasMisc(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L2628">                chassisCost *= 1.2;</span>
            }
<span class="nc bnc" id="L2630" title="All 2 branches missed.">            if (hasMisc(MiscType.F_PROP)) {</span>
<span class="nc" id="L2631">                chassisCost *= 0.75;</span>
            }
<span class="nc bnc" id="L2633" title="All 2 branches missed.">            if (hasMisc(MiscType.F_SNOWMOBILE)) {</span>
<span class="nc" id="L2634">                chassisCost *= 1.3;</span>
            }
<span class="nc bnc" id="L2636" title="All 2 branches missed.">            if (hasMisc(MiscType.F_STOL_CHASSIS)) {</span>
<span class="nc" id="L2637">                chassisCost *= 1.5;</span>
            }
<span class="nc bnc" id="L2639" title="All 2 branches missed.">            if (hasMisc(MiscType.F_SUBMERSIBLE)) {</span>
<span class="nc" id="L2640">                chassisCost *= 3.5;</span>
            }
<span class="nc bnc" id="L2642" title="All 2 branches missed.">            if (hasMisc(MiscType.F_TRACTOR_MODIFICATION)) {</span>
<span class="nc" id="L2643">                chassisCost *= 1.1;</span>
            }
<span class="nc bnc" id="L2645" title="All 2 branches missed.">            if (hasMisc(MiscType.F_TRAILER_MODIFICATION)) {</span>
<span class="nc" id="L2646">                chassisCost *= 0.75;</span>
            }
<span class="nc bnc" id="L2648" title="All 2 branches missed.">            if (hasMisc(MiscType.F_ULTRA_LIGHT)) {</span>
<span class="nc" id="L2649">                chassisCost *= 1.5;</span>
            }
<span class="nc bnc" id="L2651" title="All 2 branches missed.">            if (hasMisc(MiscType.F_VSTOL_CHASSIS)) {</span>
<span class="nc" id="L2652">                chassisCost *= 2;</span>
            }
<span class="nc" id="L2654">            costs[i++] = chassisCost;</span>
        }

        // Engine Costs
<span class="nc" id="L2658">        double engineCost = 0.0;</span>
<span class="nc bnc" id="L2659" title="All 2 branches missed.">        if(hasEngine()) {</span>
<span class="nc bnc" id="L2660" title="All 2 branches missed.">            if (isSupportVehicle()) {</span>
<span class="nc" id="L2661">                engineCost = 5000 * getEngine().getWeightEngine(this)</span>
<span class="nc" id="L2662">                        * Engine.getSVCostMultiplier(getEngine().getEngineType());</span>
            } else {
<span class="nc" id="L2664">                engineCost = (getEngine().getBaseCost() *</span>
<span class="nc" id="L2665">                        getEngine().getRating() * weight) / 75.0;</span>
            }
        }
<span class="nc" id="L2668">        costs[i++] = engineCost;</span>

        // armor
<span class="nc bnc" id="L2671" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2672">            int totalArmorPoints = 0;</span>
<span class="nc bnc" id="L2673" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L2674">                totalArmorPoints += getOArmor(loc);</span>
            }
<span class="nc" id="L2676">            costs[i++] = totalArmorPoints</span>
<span class="nc" id="L2677">                    * EquipmentType.getSupportVehicleArmorCostPerPoint(getBARRating(firstArmorIndex()));</span>
<span class="nc" id="L2678">        } else {</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">            if (hasPatchworkArmor()) {</span>
<span class="nc bnc" id="L2680" title="All 2 branches missed.">                for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L2681">                    costs[i++] = getArmorWeight(loc)</span>
<span class="nc" id="L2682">                            * EquipmentType.getArmorCost(armorType[loc]);</span>
                }

            } else {
<span class="nc" id="L2686">                costs[i++] = getArmorWeight()</span>
<span class="nc" id="L2687">                        * EquipmentType.getArmorCost(armorType[0]);</span>
            }
        }

        // Compute final structural cost
<span class="nc" id="L2692">        int structCostIdx = 0;</span>
<span class="nc bnc" id="L2693" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L2694">            structCostIdx = i++;</span>
<span class="nc" id="L2695">            costs[structCostIdx] = 0;</span>
<span class="nc bnc" id="L2696" title="All 2 branches missed.">            for (int c = 0; c &lt; structCostIdx; c++) {</span>
<span class="nc" id="L2697">                costs[structCostIdx] += costs[c];</span>
            }
<span class="nc" id="L2699">            double techRatingMultiplier = 0.5 + (getStructuralTechRating() * 0.25);</span>
<span class="nc" id="L2700">            costs[structCostIdx] *= techRatingMultiplier;</span>
<span class="nc" id="L2701">        } else {</span>
            // IS has no variations, no Endo etc., but non-naval superheavies have heavier structure
<span class="nc bnc" id="L2703" title="All 4 branches missed.">            if (!isSuperHeavy() || getMovementMode().equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2704" title="All 2 branches missed.">                    || getMovementMode().equals(EntityMovementMode.SUBMARINE)) { // There are no superheavy hydrofoils</span>
<span class="nc" id="L2705">                costs[i++] = RoundWeight.nextHalfTon(weight / 10.0) * 10000;</span>
            } else {
<span class="nc" id="L2707">                costs[i++] = RoundWeight.nextHalfTon(weight / 5.0) * 10000;</span>
            }
<span class="nc bnc" id="L2709" title="All 2 branches missed.">            double controlWeight = hasNoControlSystems() ? 0.0 : RoundWeight.nextHalfTon(weight * 0.05); // ?</span>
            // should be rounded up to nearest half-ton
<span class="nc" id="L2711">            costs[i++] = 10000 * controlWeight;</span>
        }

<span class="nc bnc" id="L2714" title="All 2 branches missed.">        double freeHeatSinks = (hasEngine() ? getEngine().getWeightFreeEngineHeatSinks() : 0);</span>
<span class="nc" id="L2715">        int sinks = TestEntity.calcHeatNeutralHSRequirement(this);</span>
<span class="nc" id="L2716">        double turretWeight = 0;</span>
<span class="nc" id="L2717">        double paWeight = getPowerAmplifierWeight();</span>
<span class="nc bnc" id="L2718" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L2719" title="All 4 branches missed.">            if ((m.getLocation() == getLocTurret()) || (m.getLocation() == getLocTurret2())) {</span>
<span class="nc" id="L2720">                turretWeight += m.getTonnage() / 10.0;</span>
<span class="nc bnc" id="L2721" title="All 4 branches missed.">                if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof MiscType)</span>
<span class="nc bnc" id="L2722" title="All 2 branches missed.">                        &amp;&amp; m.getLinkedBy().getType().hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc" id="L2723">                    turretWeight += m.getLinkedBy().getTonnage() / 10.0;</span>
                }
            }
<span class="nc" id="L2726">        }</span>
<span class="nc" id="L2727">        turretWeight = RoundWeight.standard(turretWeight, this);</span>
<span class="nc" id="L2728">        costs[i++] = 20000 * paWeight;</span>
<span class="nc" id="L2729">        costs[i++] = 2000 * Math.max(0, sinks - freeHeatSinks);</span>
<span class="nc" id="L2730">        costs[i++] = turretWeight * 5000;</span>

<span class="nc" id="L2732">        costs[i++] = getWeaponsAndEquipmentCost(ignoreAmmo) + getExtraCrewSeats() * 100;</span>

<span class="nc bnc" id="L2734" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
            double diveTonnage;
<span class="nc bnc" id="L2736" title="All 2 branches missed.">            switch (movementMode) {</span>
            case HOVER:
            case HYDROFOIL:
            case VTOL:
            case SUBMARINE:
            case WIGE:
<span class="nc" id="L2742">                diveTonnage = Math.ceil(weight / 5.0) / 2.0;</span>
<span class="nc" id="L2743">                break;</span>
            default:
<span class="nc" id="L2745">                diveTonnage = 0.0;</span>
                break;
            }
<span class="nc bnc" id="L2748" title="All 2 branches missed.">            if (movementMode != EntityMovementMode.VTOL) {</span>
<span class="nc" id="L2749">                costs[i++] = diveTonnage * 20000;</span>
            } else {
<span class="nc" id="L2751">                costs[i++] = diveTonnage * 40000;</span>
            }
        }

<span class="nc" id="L2755">        double cost = 0; // calculate the total</span>
<span class="nc bnc" id="L2756" title="All 2 branches missed.">        for (int x = structCostIdx; x &lt; i; x++) {</span>
<span class="nc" id="L2757">            cost += costs[x];</span>
        }

        // TODO Decouple cost calculation from addCostDetails and eliminate duplicate code in getPriceMultiplier
<span class="nc bnc" id="L2761" title="All 2 branches missed.">        if (isOmni()) { // Omni conversion cost goes here.</span>
<span class="nc" id="L2762">            cost *= 1.25;</span>
<span class="nc" id="L2763">            costs[i++] = -1.25;</span>
        } else {
<span class="nc" id="L2765">            costs[i++] = 0;</span>
        }


<span class="nc" id="L2769">        double multiplier = 1.0;</span>
<span class="nc bnc" id="L2770" title="All 2 branches missed.">        if (isSupportVehicle()</span>
<span class="nc bnc" id="L2771" title="All 2 branches missed.">            &amp;&amp; (movementMode.equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2772" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2773" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.SUBMARINE))) {</span>
<span class="nc" id="L2774">            multiplier += weight / 100000.0;</span>
        } else {
<span class="nc bnc" id="L2776" title="All 8 branches missed.">            switch (movementMode) {</span>
                case HOVER:
                case SUBMARINE:
<span class="nc" id="L2779">                    multiplier += weight / 50.0;</span>
<span class="nc" id="L2780">                    break;</span>
                case HYDROFOIL:
<span class="nc" id="L2782">                    multiplier += weight / 75.0;</span>
<span class="nc" id="L2783">                    break;</span>
                case NAVAL:
                case WHEELED:
<span class="nc" id="L2786">                    multiplier += weight / 200.0;</span>
<span class="nc" id="L2787">                    break;</span>
                case TRACKED:
<span class="nc" id="L2789">                    multiplier += weight / 100.0;</span>
<span class="nc" id="L2790">                    break;</span>
                case VTOL:
<span class="nc" id="L2792">                    multiplier += weight / 30.0;</span>
<span class="nc" id="L2793">                    break;</span>
                case WIGE:
<span class="nc" id="L2795">                    multiplier += weight / 25.0;</span>
<span class="nc" id="L2796">                    break;</span>
                case RAIL:
                case MAGLEV:
<span class="nc" id="L2799">                    multiplier += weight / 250.0;</span>
                    break;
            }
        }
<span class="nc" id="L2803">        cost *= multiplier;</span>
<span class="nc" id="L2804">        costs[i++] = -multiplier;</span>

<span class="nc bnc" id="L2806" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc bnc" id="L2807" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_FLOTATION_HULL)</span>
<span class="nc bnc" id="L2808" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L2809">                cost *= 1.25;</span>
<span class="nc" id="L2810">                costs[i++] = -1.25;</span>

            }
<span class="nc bnc" id="L2813" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L2814">                cost *= 1.2;</span>
<span class="nc" id="L2815">                costs[i++] = -1.2;</span>
            }
        }


<span class="nc" id="L2820">        addCostDetails(cost, costs);</span>
<span class="nc" id="L2821">        return Math.round(cost);</span>
    }

    @Override
    public double getPriceMultiplier() {
<span class="nc" id="L2826">        double priceMultiplier = 1.0;</span>
<span class="nc bnc" id="L2827" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L2828">            priceMultiplier *= 1.25;</span>
        }
<span class="nc bnc" id="L2830" title="All 2 branches missed.">        if (isSupportVehicle()</span>
<span class="nc bnc" id="L2831" title="All 2 branches missed.">                &amp;&amp; (movementMode.equals(EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2832" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2833" title="All 2 branches missed.">                || movementMode.equals(EntityMovementMode.SUBMARINE))) {</span>
<span class="nc" id="L2834">            priceMultiplier *= weight / 100000.0;</span>
        } else {
<span class="nc bnc" id="L2836" title="All 8 branches missed.">            switch (movementMode) {</span>
                case HOVER:
                case SUBMARINE:
<span class="nc" id="L2839">                    priceMultiplier *= weight / 50.0;</span>
<span class="nc" id="L2840">                    break;</span>
                case HYDROFOIL:
<span class="nc" id="L2842">                    priceMultiplier *= weight / 75.0;</span>
<span class="nc" id="L2843">                    break;</span>
                case NAVAL:
                case WHEELED:
<span class="nc" id="L2846">                    priceMultiplier *= weight / 200.0;</span>
<span class="nc" id="L2847">                    break;</span>
                case TRACKED:
<span class="nc" id="L2849">                    priceMultiplier *= weight / 100.0;</span>
<span class="nc" id="L2850">                    break;</span>
                case VTOL:
<span class="nc" id="L2852">                    priceMultiplier *= weight / 30.0;</span>
<span class="nc" id="L2853">                    break;</span>
                case WIGE:
<span class="nc" id="L2855">                    priceMultiplier *= weight / 25.0;</span>
<span class="nc" id="L2856">                    break;</span>
                case RAIL:
                case MAGLEV:
<span class="nc" id="L2859">                    priceMultiplier *= weight / 250.0;</span>
                    break;
            }
        }
<span class="nc bnc" id="L2863" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc bnc" id="L2864" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_FLOTATION_HULL)</span>
<span class="nc bnc" id="L2865" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_VACUUM_PROTECTION)</span>
<span class="nc bnc" id="L2866" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L2867">                priceMultiplier *= 1.25;</span>

            }
<span class="nc bnc" id="L2870" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L2871">                priceMultiplier *= 1.2;</span>
            }
        }
<span class="nc" id="L2874">        return priceMultiplier;</span>
    }

    @Override
    protected int implicitClanCASE() {
<span class="nc bnc" id="L2879" title="All 2 branches missed.">        if (!isClan()) {</span>
<span class="nc" id="L2880">            return 0;</span>
        }
<span class="nc" id="L2882">        int explicit = 0;</span>
<span class="nc" id="L2883">        Set&lt;Integer&gt; caseLocations = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L2885" title="All 4 branches missed.">            if ((m.getType() instanceof MiscType) &amp;&amp; (m.getType().hasFlag(MiscType.F_CASE))) {</span>
<span class="nc" id="L2886">                explicit++;</span>
<span class="nc bnc" id="L2887" title="All 2 branches missed.">            } else if (m.getType().isExplosive(m)) {</span>
<span class="nc" id="L2888">                caseLocations.add(m.getLocation());</span>
<span class="nc bnc" id="L2889" title="All 2 branches missed.">                if (m.getSecondLocation() &gt;= 0) {</span>
<span class="nc" id="L2890">                    caseLocations.add(m.getSecondLocation());</span>
                }
            }
<span class="nc" id="L2893">        }</span>
<span class="nc" id="L2894">        return Math.max(0, caseLocations.size() - explicit);</span>
    }

    @Override
    public boolean doomedInExtremeTemp() {
<span class="nc" id="L2899">        return false;</span>
    }

    @Override
    public boolean doomedInVacuum() {
<span class="nc bnc" id="L2904" title="All 6 branches missed.">        if (hasEngine() &amp;&amp; (getEngine().isFusion() || getEngine().getEngineType() == Engine.FISSION</span>
<span class="nc bnc" id="L2905" title="All 2 branches missed.">                || getEngine().getEngineType() == Engine.FUEL_CELL)) {</span>
<span class="nc bnc" id="L2906" title="All 2 branches missed.">            return !hasEnvironmentalSealing();</span>
        }
<span class="nc" id="L2908">        return true;</span>
    }

    @Override
    public boolean hasEnvironmentalSealing() {
<span class="nc bnc" id="L2913" title="All 2 branches missed.">        return getMovementMode().equals(EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L2914" title="All 2 branches missed.">                || super.hasEnvironmentalSealing();</span>
    }

    @Override
    public boolean doomedOnGround() {
<span class="nc" id="L2919">        return false;</span>
    }

    @Override
    public boolean doomedInAtmosphere() {
<span class="nc" id="L2924">        return true;</span>
    }

    @Override
    public boolean doomedInSpace() {
<span class="nc" id="L2929">        return true;</span>
    }

    @Override
    /**
     * Checks to see if a Tank is capable of going hull-down.  This is true if
     * hull-down rules are enabled and the Tank is in a fortified hex.
     *
     *  @return True if hull-down is enabled and the Tank is in a fortified hex.
     */
    public boolean canGoHullDown() {
        // MoveStep line 2179 performs this same check
        // performing it here will allow us to disable the Hulldown button
        // if the movement is illegal
<span class="nc" id="L2943">        IHex occupiedHex = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L2944" title="All 2 branches missed.">        return occupiedHex.containsTerrain(Terrains.FORTIFIED)</span>
<span class="nc bnc" id="L2945" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_HULL_DOWN);</span>
    }

    public void setOnFire(boolean inferno) {
<span class="nc" id="L2949">        infernoFire |= inferno;</span>
<span class="nc" id="L2950">        burningLocations = (1 &lt;&lt; locations()) - 1;</span>
<span class="nc" id="L2951">        extinguishLocation(LOC_BODY);</span>
<span class="nc" id="L2952">    }</span>

    public boolean isOnFire() {
<span class="nc bnc" id="L2955" title="All 4 branches missed.">        return (burningLocations != 0) || infernos.isStillBurning();</span>
    }

    public boolean isInfernoFire() {
<span class="nc" id="L2959">        return infernoFire;</span>
    }

    public boolean isLocationBurning(int location) {
<span class="nc" id="L2963">        int flag = (1 &lt;&lt; location);</span>
<span class="nc bnc" id="L2964" title="All 2 branches missed.">        return (burningLocations &amp; flag) == flag;</span>
    }

    public void extinguishLocation(int location) {
<span class="nc" id="L2968">        int flag = ~(1 &lt;&lt; location);</span>
<span class="nc" id="L2969">        burningLocations &amp;= flag;</span>
<span class="nc" id="L2970">    }</span>

    /**
     * extinguish all inferno fire on this Tank
     */
    public void extinguishAll() {
<span class="nc" id="L2976">        burningLocations = 0;</span>
<span class="nc" id="L2977">        infernoFire = false;</span>
<span class="nc" id="L2978">        infernos.clear();</span>
<span class="nc" id="L2979">    }</span>

    /**
     * adds minor, moderate or heavy movement system damage
     *
     * @param level
     *            a &lt;code&gt;int&lt;/code&gt; representing minor damage (1), moderate
     *            damage (2), heavy damage (3), or immobilized (4)
     */
    public void addMovementDamage(int level) {
<span class="nc bnc" id="L2989" title="All 5 branches missed.">        switch (level) {</span>
            case 1:
<span class="nc bnc" id="L2991" title="All 2 branches missed.">                if (!minorMovementDamage) {</span>
<span class="nc" id="L2992">                    minorMovementDamage = true;</span>
<span class="nc" id="L2993">                    motivePenalty += level;</span>
                }
                break;
            case 2:
<span class="nc bnc" id="L2997" title="All 2 branches missed.">                if (!moderateMovementDamage) {</span>
<span class="nc" id="L2998">                    moderateMovementDamage = true;</span>
<span class="nc" id="L2999">                    motivePenalty += level;</span>
                }
<span class="nc" id="L3001">                motiveDamage++;</span>
<span class="nc" id="L3002">                break;</span>
            case 3:
<span class="nc bnc" id="L3004" title="All 2 branches missed.">                if (!heavyMovementDamage) {</span>
<span class="nc" id="L3005">                    heavyMovementDamage = true;</span>
<span class="nc" id="L3006">                    motivePenalty += level;</span>
                }
<span class="nc" id="L3008">                int nMP = getOriginalWalkMP() - motiveDamage;</span>
<span class="nc bnc" id="L3009" title="All 2 branches missed.">                if (nMP &gt; 0) {</span>
<span class="nc" id="L3010">                    motiveDamage = getOriginalWalkMP()</span>
<span class="nc" id="L3011">                            - (int) Math.ceil(nMP / 2.0);</span>
                }
                break;
            case 4:
<span class="nc" id="L3015">                motiveDamage = getOriginalWalkMP();</span>
<span class="nc" id="L3016">                immobilize();</span>
        }
<span class="nc" id="L3018">    }</span>

    public boolean hasMinorMovementDamage() {
<span class="nc" id="L3021">        return minorMovementDamage;</span>
    }

    public boolean hasModerateMovementDamage() {
<span class="nc" id="L3025">        return moderateMovementDamage;</span>
    }

    public boolean hasHeavyMovementDamage() {
<span class="nc" id="L3029">        return heavyMovementDamage;</span>
    }

    @Override
    public boolean isNuclearHardened() {
<span class="nc" id="L3034">        return true;</span>
    }

    @Override
    public void addEquipment(Mounted mounted, int loc, boolean rearMounted)
            throws LocationFullException {
<span class="nc bnc" id="L3040" title="All 2 branches missed.">        if (getEquipmentNum(mounted) == -1) {</span>
<span class="nc" id="L3041">            super.addEquipment(mounted, loc, rearMounted);</span>
        }
        // Add the piece equipment to our slots.
<span class="nc" id="L3044">        addCritical(loc, new CriticalSlot(mounted));</span>
<span class="nc bnc" id="L3045" title="All 2 branches missed.">        if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(MiscType.F_JUMP_JET)) {</span>
<span class="nc" id="L3047">            setOriginalJumpMP(getOriginalJumpMP() + 1);</span>
        }
<span class="nc" id="L3049">    }</span>

    /**
     * get the type of critical caused by a critical roll, taking account of
     * existing damage
     *
     * @param roll the final dice roll
     * @param loc the hit location
     * @param damagedByFire whether or not the critical was caused by fire,
     *      which is distinct from damage for unofficial thresholding purposes.
     * @return a critical type
     */
    public int getCriticalEffect(int roll, int loc, boolean damagedByFire) {
<span class="nc bnc" id="L3062" title="All 2 branches missed.">        if (roll &gt; 12) {</span>
<span class="nc" id="L3063">            roll = 12;</span>
        }
<span class="nc bnc" id="L3065" title="All 2 branches missed.">        if ((roll &lt; 6)</span>
<span class="nc bnc" id="L3066" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
<span class="nc bnc" id="L3067" title="All 4 branches missed.">                        &amp;&amp; !getOverThresh() &amp;&amp; !damagedByFire)) {</span>
<span class="nc" id="L3068">            return CRIT_NONE;</span>
        }
<span class="nc bnc" id="L3070" title="All 2 branches missed.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc bnc" id="L3071" title="All 2 branches missed.">            if (i &gt; 0) {</span>
<span class="nc" id="L3072">                roll = 6;</span>
            }
<span class="nc bnc" id="L3074" title="All 2 branches missed.">            if (loc == LOC_FRONT) {</span>
<span class="nc bnc" id="L3075" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3077" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc bnc" id="L3078" title="All 2 branches missed.">                            if (!isDriverHit()) {</span>
<span class="nc" id="L3079">                                return CRIT_DRIVER;</span>
<span class="nc bnc" id="L3080" title="All 2 branches missed.">                            } else if (!isCommanderHit()) {</span>
<span class="nc" id="L3081">                                return CRIT_CREW_STUNNED;</span>
                            } else {
<span class="nc" id="L3083">                                return CRIT_CREW_KILLED;</span>
                            }
                        }
                    case 7:
<span class="nc bnc" id="L3087" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3088" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3089" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3090" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3091">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3093">                        }</span>
                    case 8:
<span class="nc bnc" id="L3095" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3096" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3097" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3098">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3100">                            }</span>
                        }
                    case 9:
<span class="nc bnc" id="L3103" title="All 2 branches missed.">                        if (getSensorHits() &lt; 4) {</span>
<span class="nc" id="L3104">                            return CRIT_SENSOR;</span>
                        }
                    case 10:
<span class="nc bnc" id="L3107" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc bnc" id="L3108" title="All 2 branches missed.">                            if (!isCommanderHit()) {</span>
<span class="nc" id="L3109">                                return CRIT_COMMANDER;</span>
<span class="nc bnc" id="L3110" title="All 2 branches missed.">                            } else if (!isDriverHit()) {</span>
<span class="nc" id="L3111">                                return CRIT_CREW_STUNNED;</span>
                            } else {
<span class="nc" id="L3113">                                return CRIT_CREW_KILLED;</span>
                            }
                        }
                    case 11:
<span class="nc bnc" id="L3117" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3118" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3119" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3120">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3122">                        }</span>
                    case 12:
<span class="nc bnc" id="L3124" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc" id="L3125">                            return CRIT_CREW_KILLED;</span>
                        }
                }
<span class="nc bnc" id="L3128" title="All 2 branches missed.">            } else if (loc == LOC_REAR) {</span>
<span class="nc bnc" id="L3129" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3131" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3132" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3133" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3134" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3135">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3137">                        }</span>
                    case 7:
<span class="nc bnc" id="L3139" title="All 2 branches missed.">                        if (getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L3140">                            return CRIT_CARGO;</span>
                        }
                    case 8:
<span class="nc bnc" id="L3143" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3144" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3145" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3146">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3148">                            }</span>
                        }
                    case 9:
<span class="nc bnc" id="L3151" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3152" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3153" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3154">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3156">                        }</span>
                    case 10:
<span class="nc bnc" id="L3158" title="All 2 branches missed.">                        if (!engineHit) {</span>
<span class="nc bnc" id="L3159" title="All 2 branches missed.">                            return (hasEngine() ? CRIT_ENGINE : CRIT_NONE);</span>
                        }
                    case 11:
<span class="nc bnc" id="L3162" title="All 2 branches missed.">                        for (Mounted m : getAmmo()) {</span>
<span class="nc bnc" id="L3163" title="All 4 branches missed.">                            if (!m.isDestroyed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3164" title="All 2 branches missed.">                                    &amp;&amp; (m.getLocation() != Entity.LOC_NONE)) {</span>
<span class="nc" id="L3165">                                return CRIT_AMMO;</span>
                            }
<span class="nc" id="L3167">                        }</span>
                    case 12:
<span class="nc bnc" id="L3169" title="All 2 branches missed.">                        if(hasEngine()) {</span>
<span class="nc bnc" id="L3170" title="All 4 branches missed.">                            if (getEngine().isFusion() &amp;&amp; !engineHit) {</span>
<span class="nc" id="L3171">                                return CRIT_ENGINE;</span>
<span class="nc bnc" id="L3172" title="All 2 branches missed.">                            } else if (!getEngine().isFusion()) {</span>
<span class="nc" id="L3173">                                return CRIT_FUEL_TANK;</span>
                            }
                        } else {
<span class="nc" id="L3176">                            return CRIT_NONE;</span>
                        }
                }
<span class="nc bnc" id="L3179" title="All 4 branches missed.">            } else if ((loc == getLocTurret()) || (loc == getLocTurret2())) {</span>
<span class="nc bnc" id="L3180" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3182" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3183" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3184" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3185">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3187">                            }</span>
                        }
                    case 7:
<span class="nc bnc" id="L3190" title="All 2 branches missed.">                        if (!isTurretLocked(loc)) {</span>
<span class="nc" id="L3191">                            return CRIT_TURRET_JAM;</span>
                        }
                    case 8:
<span class="nc bnc" id="L3194" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3195" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3196" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3197" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3198">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3200">                        }</span>
                    case 9:
<span class="nc bnc" id="L3202" title="All 2 branches missed.">                        if (!isTurretLocked(loc)) {</span>
<span class="nc" id="L3203">                            return CRIT_TURRET_LOCK;</span>
                        }
                    case 10:
<span class="nc bnc" id="L3206" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3207" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3208" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3209">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3211">                        }</span>
                    case 11:
<span class="nc bnc" id="L3213" title="All 2 branches missed.">                        for (Mounted m : getAmmo()) {</span>
<span class="nc bnc" id="L3214" title="All 4 branches missed.">                            if (!m.isDestroyed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3215" title="All 2 branches missed.">                                    &amp;&amp; (m.getLocation() != Entity.LOC_NONE)) {</span>
<span class="nc" id="L3216">                                return CRIT_AMMO;</span>
                            }
<span class="nc" id="L3218">                        }</span>
                    case 12:
<span class="nc" id="L3220">                        return CRIT_TURRET_DESTROYED;</span>
                }
            } else {
<span class="nc bnc" id="L3223" title="All 8 branches missed.">                switch (roll) {</span>
                    case 6:
<span class="nc bnc" id="L3225" title="All 2 branches missed.">                        if (getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L3226">                            return CRIT_CARGO;</span>
                        }
                    case 7:
<span class="nc bnc" id="L3229" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3230" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3231" title="All 4 branches missed.">                                    &amp;&amp; !m.isJammed() &amp;&amp; !m.isHit()</span>
<span class="nc bnc" id="L3232" title="All 2 branches missed.">                                    &amp;&amp; !m.jammedThisPhase()) {</span>
<span class="nc" id="L3233">                                return CRIT_WEAPON_JAM;</span>
                            }
<span class="nc" id="L3235">                        }</span>
                    case 8:
<span class="nc bnc" id="L3237" title="All 4 branches missed.">                        if (!getCrew().isDead() &amp;&amp; !getCrew().isDoomed()) {</span>
<span class="nc bnc" id="L3238" title="All 4 branches missed.">                            if (isCommanderHit() &amp;&amp; isDriverHit()) {</span>
<span class="nc" id="L3239">                                return CRIT_CREW_KILLED;</span>
                            }
<span class="nc" id="L3241">                            return CRIT_CREW_STUNNED;</span>
                        }
                    case 9:
<span class="nc bnc" id="L3244" title="All 2 branches missed.">                        if (!isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L3245" title="All 2 branches missed.">                            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3246" title="All 2 branches missed.">                                if (m.getLocation() == loc) {</span>
<span class="nc" id="L3247">                                    return CRIT_STABILIZER;</span>
                                }
<span class="nc" id="L3249">                            }</span>
                        }
                    case 10:
<span class="nc bnc" id="L3252" title="All 2 branches missed.">                        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L3253" title="All 4 branches missed.">                            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L3254" title="All 2 branches missed.">                                    &amp;&amp; !m.isHit()) {</span>
<span class="nc" id="L3255">                                return CRIT_WEAPON_DESTROYED;</span>
                            }
<span class="nc" id="L3257">                        }</span>
                    case 11:
<span class="nc bnc" id="L3259" title="All 2 branches missed.">                        if (!engineHit) {</span>
<span class="nc bnc" id="L3260" title="All 2 branches missed.">                            return (hasEngine() ? CRIT_ENGINE : CRIT_NONE);</span>
                        }
                    case 12:
<span class="nc bnc" id="L3263" title="All 2 branches missed.">                        if(hasEngine()) {</span>
<span class="nc bnc" id="L3264" title="All 4 branches missed.">                            if (getEngine().isFusion() &amp;&amp; !engineHit) {</span>
<span class="nc" id="L3265">                                return CRIT_ENGINE;</span>
<span class="nc bnc" id="L3266" title="All 2 branches missed.">                            } else if (!getEngine().isFusion()) {</span>
<span class="nc" id="L3267">                                return CRIT_FUEL_TANK;</span>
                            }
                        } else {
<span class="nc" id="L3270">                            return CRIT_NONE;</span>
                        }
                }
            }
        }
<span class="nc" id="L3275">        return CRIT_NONE;</span>
    }

    /**
     * OmniVehicles have handles for Battle Armor squads to latch onto. Please
     * note, this method should only be called during this Tank's construction.
     * &lt;p/&gt;
     * Overrides &lt;code&gt;Entity#setOmni(boolean)&lt;/code&gt;
     */
    @Override
    public void setOmni(boolean omni) {

        // Perform the superclass' action.
<span class="nc" id="L3288">        super.setOmni(omni);</span>

        // Add BattleArmorHandles to OmniMechs.
<span class="nc bnc" id="L3291" title="All 4 branches missed.">        if (omni &amp;&amp; !hasBattleArmorHandles()) {</span>
<span class="nc" id="L3292">            addTransporter(new BattleArmorHandlesTank());</span>
        }
<span class="nc" id="L3294">    }</span>

    // Set whether a non-omni should have BA Grab Bars.
    public void setBAGrabBars() {
<span class="nc bnc" id="L3298" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L3299">            return;</span>
        }
        // TODO: I really hate this optional rule - what if some units are
        // already loaded?
        // if ba_grab_bars is on, then we need to add battlearmor handles,
        // otherwise clamp mounts
        // but first clear out whatever we have
<span class="nc" id="L3306">        Vector&lt;Transporter&gt; et = new Vector&lt;Transporter&gt;(getTransports());</span>
<span class="nc bnc" id="L3307" title="All 2 branches missed.">        for (Transporter t : et) {</span>
<span class="nc bnc" id="L3308" title="All 2 branches missed.">            if (t instanceof BattleArmorHandlesTank) {</span>
<span class="nc" id="L3309">                removeTransporter(t);</span>
            }
<span class="nc" id="L3311">        }</span>
<span class="nc bnc" id="L3312" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_BA_GRAB_BARS)) {</span>
<span class="nc" id="L3313">            addTransporter(new BattleArmorHandlesTank());</span>
        } else {
<span class="nc" id="L3315">            addTransporter(new ClampMountTank());</span>
        }
<span class="nc" id="L3317">    }</span>
    
    /**
     * Add a transporter for each trailer hitch the unit is equipped with, with a maximum of
     * one each in the front and the rear. Any tractor that does not have an explicit hitch
     * installed as equipment will get a rear-facing transporter.
     */
    public void setTrailerHitches() {
<span class="nc bnc" id="L3325" title="All 4 branches missed.">        if (isTractor() &amp;&amp; !hasTrailerHitchTransporter()) {</span>
            // look for explicit installed trailer hitches and note location
<span class="nc" id="L3327">            boolean front = false;</span>
<span class="nc" id="L3328">            boolean rear = false;</span>
<span class="nc bnc" id="L3329" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L3330" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_HITCH)) {</span>
<span class="nc bnc" id="L3331" title="All 4 branches missed.">                    if (m.getLocation() == Tank.LOC_FRONT &amp;&amp; !isTrailer()) {</span>
<span class="nc" id="L3332">                        front = true;</span>
                    } else {
<span class="nc" id="L3334">                        rear = true;</span>
                    }
                }
<span class="nc" id="L3337">            }</span>
            // Install a transporter anywhere there is an explicit hitch. If no hitch is found,
            // put it in the back.
<span class="nc bnc" id="L3340" title="All 2 branches missed.">            if (front) {</span>
<span class="nc" id="L3341">                addTransporter(new TankTrailerHitch(false));</span>
            }
<span class="nc bnc" id="L3343" title="All 4 branches missed.">            if (rear || !front) {</span>
<span class="nc" id="L3344">                addTransporter(new TankTrailerHitch(true));</span>
            }
        }
<span class="nc" id="L3347">    }</span>
    
    /**
     * Check to see if the unit has a trailer hitch transporter already
     * We need this to prevent duplicate transporters being created
     */
    protected boolean hasTrailerHitchTransporter() {
<span class="nc bnc" id="L3354" title="All 2 branches missed.">        for (Transporter t : getTransports()) {</span>
<span class="nc bnc" id="L3355" title="All 2 branches missed.">            if (t instanceof TankTrailerHitch) {</span>
<span class="nc" id="L3356">                return true;</span>
            }
<span class="nc" id="L3358">        }</span>
<span class="nc" id="L3359">        return false;</span>
    }

    /**
     * Tanks can't spot when stunned.
     */
    @Override
    public boolean canSpot() {
<span class="nc bnc" id="L3367" title="All 4 branches missed.">        return super.canSpot() &amp;&amp; (getStunnedTurns() == 0);</span>
    }
    
    /**
     * Convenience function that determines if this tank can issue an &quot;unjam weapon&quot; command.
     * @return True if there are any jammed weapons and the crew isn't stunned
     */
    public boolean canUnjamWeapon() {
<span class="nc bnc" id="L3375" title="All 4 branches missed.">        return getJammedWeapons().size() &gt; 0 &amp;&amp; getStunnedTurns() &lt;= 0;</span>
    }
    
    /** 
     * Convenience function that determines if this tank can issue a &quot;clear turret&quot; command.
     * @return True if there are any jammed turrets and the crew isn't stunned
     */
    public boolean canClearTurret() {
<span class="nc bnc" id="L3383" title="All 6 branches missed.">        return (m_bTurretJammed || m_bDualTurretJammed) &amp;&amp; getStunnedTurns() &lt;= 0;</span>
    }

    public void addJammedWeapon(Mounted weapon) {
<span class="nc" id="L3387">        jammedWeapons.add(weapon);</span>
<span class="nc" id="L3388">    }</span>

    public ArrayList&lt;Mounted&gt; getJammedWeapons() {
<span class="nc" id="L3391">        return jammedWeapons;</span>
    }

    public void resetJammedWeapons() {
<span class="nc" id="L3395">        jammedWeapons = new ArrayList&lt;Mounted&gt;();</span>
<span class="nc" id="L3396">    }</span>

    /**
     * apply the effects of an &quot;engine hit&quot; crit
     */
    public void engineHit() {
<span class="nc" id="L3402">        engineHit = true;</span>
<span class="nc" id="L3403">        immobilize();</span>
<span class="nc" id="L3404">        lockTurret(getLocTurret());</span>
<span class="nc" id="L3405">        lockTurret(getLocTurret2());</span>
<span class="nc bnc" id="L3406" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc" id="L3407">            WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L3408" title="All 6 branches missed.">            if (wtype.hasFlag(WeaponType.F_ENERGY)</span>
            // Chemical lasers still work even after an engine hit.
                    &amp;&amp; !(wtype instanceof CLChemicalLaserWeapon)
                    // And presumably vehicle flamers should, too; we can always
                    // remove this again if ruled otherwise.
                    &amp;&amp; !(wtype instanceof VehicleFlamerWeapon)) {
<span class="nc" id="L3414">                m.setBreached(true); // not destroyed, just unpowered</span>
            }
<span class="nc" id="L3416">        }</span>
<span class="nc" id="L3417">    }</span>

    public void engineFix() {
<span class="nc" id="L3420">        engineHit = false;</span>
<span class="nc" id="L3421">        unlockTurret();</span>
<span class="nc bnc" id="L3422" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc" id="L3423">            WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L3424" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc" id="L3425">                m.setBreached(false); // not destroyed, just</span>
                // unpowered
            }
<span class="nc" id="L3428">        }</span>
<span class="nc" id="L3429">    }</span>

    public boolean isEngineHit() {
<span class="nc" id="L3432">        return engineHit;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getTotalCommGearTons()
     */
    @Override
    public int getTotalCommGearTons() {
<span class="nc" id="L3442">        return 1 + getExtraCommGearTons();</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getIniBonus()
     */
    @Override
    public int getHQIniBonus() {
<span class="nc" id="L3452">        int bonus = super.getHQIniBonus();</span>
<span class="nc bnc" id="L3453" title="All 6 branches missed.">        if (((stabiliserHits &gt; 0) &amp;&amp; (mpUsedLastRound &gt; 0)) || commanderHit) {</span>
<span class="nc" id="L3454">            return 0;</span>
        }
<span class="nc" id="L3456">        return bonus;</span>
    }

    @Override
    public boolean hasArmoredEngine() {
<span class="nc bnc" id="L3461" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(LOC_BODY); slot++) {</span>
<span class="nc" id="L3462">            CriticalSlot cs = getCritical(LOC_BODY, slot);</span>
<span class="nc bnc" id="L3463" title="All 4 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L3464" title="All 2 branches missed.">                    &amp;&amp; (cs.getIndex() == Mech.SYSTEM_ENGINE)) {</span>
<span class="nc" id="L3465">                return cs.isArmored();</span>
            }
        }
<span class="nc" id="L3468">        return false;</span>
    }

    /**
     * see {@link Entity#getForwardArc()}
     */
    @Override
    public int getForwardArc() {
<span class="nc bnc" id="L3476" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L3477">            return Compute.ARC_NOSE;</span>
        }
<span class="nc" id="L3479">        return super.getForwardArc();</span>
    }

    /**
     * see {@link Entity#getRearArc()}
     */
    @Override
    public int getRearArc() {
<span class="nc bnc" id="L3487" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_ARCS)) {</span>
<span class="nc" id="L3488">            return Compute.ARC_AFT;</span>
        }
<span class="nc" id="L3490">        return super.getRearArc();</span>
    }

    public boolean hasMovementDamage() {
<span class="nc bnc" id="L3494" title="All 2 branches missed.">        return motivePenalty &gt; 0;</span>
    }

    public void resetMovementDamage() {
<span class="nc" id="L3498">        motivePenalty = 0;</span>
<span class="nc" id="L3499">        motiveDamage = 0;</span>
<span class="nc" id="L3500">        minorMovementDamage = false;</span>
<span class="nc" id="L3501">        moderateMovementDamage = false;</span>
<span class="nc" id="L3502">        heavyMovementDamage = false;</span>
<span class="nc" id="L3503">        m_bImmobileHit = false;</span>
<span class="nc" id="L3504">        m_bImmobile = false;</span>
<span class="nc" id="L3505">    }</span>

    public void unlockTurret() {
<span class="nc" id="L3508">        m_bTurretLocked = false;</span>
<span class="nc" id="L3509">    }</span>

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthActive() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L3524" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L3525">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L3526" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>

<span class="nc bnc" id="L3528" title="All 4 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;) &amp;&amp; hasActiveECM()) {</span>
                    // Return true if the mode is &quot;On&quot; and ECM is working
<span class="nc" id="L3530">                    return true;</span>
                }
            }
<span class="nc" id="L3533">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L3535">        return false;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system. (stealth
     * can be active and not working when under ECCM)
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthOn() {
        // Try to find a Mek Stealth system.
<span class="nc bnc" id="L3551" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L3552">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L3553" title="All 2 branches missed.">            if (mtype.hasFlag(MiscType.F_STEALTH)) {</span>
<span class="nc bnc" id="L3554" title="All 2 branches missed.">                if (mEquip.curMode().equals(&quot;On&quot;)) {</span>
                    // Return true if the mode is &quot;On&quot;
<span class="nc" id="L3556">                    return true;</span>
                }
            }
<span class="nc" id="L3559">        }</span>
        // No Mek Stealth or system inactive. Return false.
<span class="nc" id="L3561">        return false;</span>
    }

    /**
     * get the total amount of item slots available for this tank
     *
     * @return
     */
    public int getTotalSlots() {
<span class="nc" id="L3570">        return 5 + (int) Math.floor(getWeight() / 5);</span>
    }

    /**
     * get the free item slots for this tank
     *
     * @return
     */
    public int getFreeSlots() {
<span class="nc" id="L3579">        int availableSlots = getTotalSlots();</span>
<span class="nc" id="L3580">        int usedSlots = 0;</span>
<span class="nc" id="L3581">        boolean addedCargo = false;</span>
<span class="nc bnc" id="L3582" title="All 2 branches missed.">        for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L3583" title="All 2 branches missed.">            if ((mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3584" title="All 2 branches missed.">                    &amp;&amp; mount.getType().hasFlag(MiscType.F_CARGO)) {</span>
<span class="nc bnc" id="L3585" title="All 2 branches missed.">                if (!addedCargo) {</span>
<span class="nc" id="L3586">                    usedSlots += mount.getType().getTankSlots(this);</span>
<span class="nc" id="L3587">                    addedCargo = true;</span>
<span class="nc" id="L3588">                    continue;</span>
                } else {
                    continue;
                }
            }
<span class="nc bnc" id="L3593" title="All 2 branches missed.">            if ((mount.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3594" title="All 2 branches missed.">                    &amp;&amp; (mount.getType().hasFlag(MiscType.F_JUMP_JET)</span>
<span class="nc bnc" id="L3595" title="All 2 branches missed.">                        || mount.getType().hasFlag(MiscType.F_FUEL))) {</span>
                // Only one slot each for all jump jets or fuel tanks, added later.
<span class="nc" id="L3597">                continue;</span>
            }
<span class="nc bnc" id="L3599" title="All 2 branches missed.">            if (!((mount.getType() instanceof AmmoType) || Arrays.asList(</span>
<span class="nc bnc" id="L3600" title="All 2 branches missed.">                    EquipmentType.armorNames).contains(</span>
<span class="nc" id="L3601">                    mount.getType().getName()))) {</span>
<span class="nc" id="L3602">                usedSlots += mount.getType().getTankSlots(this);</span>
            }
<span class="nc" id="L3604">        }</span>
        // JJs take just 1 slot
<span class="nc bnc" id="L3606" title="All 2 branches missed.">        if (this.getJumpMP(false) &gt; 0) {</span>
<span class="nc" id="L3607">            usedSlots++;</span>
        }
        // So do fuel tanks
<span class="nc bnc" id="L3610" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_FUEL)) {</span>
<span class="nc" id="L3611">            usedSlots++;</span>
        }
        // different engines take different amounts of slots
<span class="nc bnc" id="L3614" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().isFusion()) {</span>
<span class="nc bnc" id="L3615" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.LIGHT_ENGINE) {</span>
<span class="nc" id="L3616">                usedSlots++;</span>
            }
<span class="nc bnc" id="L3618" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.XL_ENGINE) {</span>
<span class="nc bnc" id="L3619" title="All 2 branches missed.">                if (getEngine().hasFlag(Engine.CLAN_ENGINE)) {</span>
<span class="nc" id="L3620">                    usedSlots++;</span>
                } else {
<span class="nc" id="L3622">                    usedSlots += 2;</span>
                }
            }
<span class="nc bnc" id="L3625" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.XXL_ENGINE) {</span>
<span class="nc bnc" id="L3626" title="All 2 branches missed.">                if (getEngine().hasFlag(Engine.CLAN_ENGINE)) {</span>
<span class="nc" id="L3627">                    usedSlots += 2;</span>
                } else {
<span class="nc" id="L3629">                    usedSlots += 4;</span>
                }
            }
        }
<span class="nc bnc" id="L3633" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().hasFlag(Engine.LARGE_ENGINE)) {</span>
<span class="nc" id="L3634">            usedSlots++;</span>
        }
<span class="nc bnc" id="L3636" title="All 4 branches missed.">        if (hasEngine() &amp;&amp; getEngine().getEngineType() == Engine.COMPACT_ENGINE) {</span>
<span class="nc" id="L3637">            usedSlots--;</span>
        }
        // for ammo, each type of ammo takes one slots, regardless of
        // submunition type
<span class="nc" id="L3641">        Set&lt;String&gt; foundAmmo = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3642" title="All 2 branches missed.">        for (Mounted ammo : getAmmo()) {</span>
            // don't count oneshot ammo
<span class="nc bnc" id="L3644" title="All 2 branches missed.">            if (ammo.isOneShotAmmo()) {</span>
<span class="nc" id="L3645">                continue;</span>
            }
<span class="nc" id="L3647">            AmmoType at = (AmmoType) ammo.getType();</span>
<span class="nc bnc" id="L3648" title="All 2 branches missed.">            if (!foundAmmo.contains(at.getAmmoType() + &quot;:&quot; + at.getRackSize())) {</span>
<span class="nc" id="L3649">                usedSlots++;</span>
<span class="nc" id="L3650">                foundAmmo.add(at.getAmmoType() + &quot;:&quot; + at.getRackSize());</span>
            }
<span class="nc" id="L3652">        }</span>
        // if a tank has an infantry bay, add 1 slots (multiple bays take 1 slot
        // total)
<span class="nc" id="L3655">        boolean infantryBayCounted = false;</span>
<span class="nc bnc" id="L3656" title="All 2 branches missed.">        for (Transporter transport : getTransports()) {</span>
<span class="nc bnc" id="L3657" title="All 2 branches missed.">            if (transport instanceof TroopSpace) {</span>
<span class="nc" id="L3658">                usedSlots++;</span>
<span class="nc" id="L3659">                infantryBayCounted = true;</span>
<span class="nc" id="L3660">                break;</span>
            }
<span class="nc" id="L3662">        }</span>
        // unit transport bays take 1 slot each
<span class="nc bnc" id="L3664" title="All 2 branches missed.">        for (Bay bay : getTransportBays()) {</span>
<span class="nc bnc" id="L3665" title="All 6 branches missed.">            if (((bay instanceof BattleArmorBay) || (bay instanceof InfantryBay))</span>
                    &amp;&amp; !infantryBayCounted) {
<span class="nc" id="L3667">                usedSlots++;</span>
<span class="nc" id="L3668">                infantryBayCounted = true;</span>
            } else {
<span class="nc" id="L3670">                usedSlots++;</span>
            }
<span class="nc" id="L3672">        }</span>
<span class="nc" id="L3673">        usedSlots += extraCrewSeats;</span>
        // different armor types take different amount of slots
<span class="nc bnc" id="L3675" title="All 2 branches missed.">        if (!hasPatchworkArmor()) {</span>
<span class="nc" id="L3676">            int type = getArmorType(1);</span>
<span class="nc bnc" id="L3677" title="All 6 branches missed.">            switch (type) {</span>
                case EquipmentType.T_ARMOR_FERRO_FIBROUS:
<span class="nc bnc" id="L3679" title="All 2 branches missed.">                    if (TechConstants.isClan(getArmorTechLevel(1))) {</span>
<span class="nc" id="L3680">                        usedSlots++;</span>
                    } else {
<span class="nc" id="L3682">                        usedSlots += 2;</span>
                    }
<span class="nc" id="L3684">                    break;</span>
                case EquipmentType.T_ARMOR_HEAVY_FERRO:
<span class="nc" id="L3686">                    usedSlots += 3;</span>
<span class="nc" id="L3687">                    break;</span>
                case EquipmentType.T_ARMOR_LIGHT_FERRO:
                case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                case EquipmentType.T_ARMOR_REFLECTIVE:
                case EquipmentType.T_ARMOR_HARDENED:
                case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
                case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L3694">                    usedSlots++;</span>
<span class="nc" id="L3695">                    break;</span>
                case EquipmentType.T_ARMOR_STEALTH_VEHICLE:
<span class="nc" id="L3697">                    usedSlots += 2;</span>
<span class="nc" id="L3698">                    break;</span>
                case EquipmentType.T_ARMOR_REACTIVE:
<span class="nc bnc" id="L3700" title="All 2 branches missed.">                    if (TechConstants.isClan(getArmorTechLevel(1))) {</span>
<span class="nc" id="L3701">                        usedSlots++;</span>
                    } else {
<span class="nc" id="L3703">                        usedSlots += 2;</span>
                    }
<span class="nc" id="L3705">                    break;</span>
                default:
                    break;
            }
<span class="nc" id="L3709">        } else {</span>
<span class="nc bnc" id="L3710" title="All 2 branches missed.">            for (int loc = 1; loc &lt; locations(); loc++) {</span>
<span class="nc bnc" id="L3711" title="All 3 branches missed.">                switch (getArmorType(loc)) {</span>
                    case EquipmentType.T_ARMOR_HEAVY_FERRO:
<span class="nc" id="L3713">                        usedSlots += 2;</span>
<span class="nc" id="L3714">                        break;</span>
                    case EquipmentType.T_ARMOR_FERRO_FIBROUS:
                    case EquipmentType.T_ARMOR_LIGHT_FERRO:
                    case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
                    case EquipmentType.T_ARMOR_REFLECTIVE:
                    case EquipmentType.T_ARMOR_STEALTH_VEHICLE:
                    case EquipmentType.T_ARMOR_REACTIVE:
                    case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
                    case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L3723">                        usedSlots++;</span>
<span class="nc" id="L3724">                        break;</span>
                    default:
                        break;
                }
            }
        }
<span class="nc" id="L3730">        return availableSlots - usedSlots;</span>
    }

    @Override
    public void setArmorType(int armType) {
<span class="nc" id="L3735">        setArmorType(armType, true);</span>
<span class="nc" id="L3736">    }</span>

    public void setArmorType(int armType, boolean addMount) {
<span class="nc" id="L3739">        super.setArmorType(armType);</span>
<span class="nc bnc" id="L3740" title="All 4 branches missed.">        if ((armType == EquipmentType.T_ARMOR_STEALTH_VEHICLE) &amp;&amp; addMount) {</span>
            try {
<span class="nc" id="L3742">                this.addEquipment(EquipmentType.get(EquipmentType</span>
<span class="nc" id="L3743">                        .getArmorTypeName(</span>
                                EquipmentType.T_ARMOR_STEALTH_VEHICLE, false)),
                        LOC_BODY);
<span class="nc" id="L3746">            } catch (LocationFullException e) {</span>
                // this should never happen
<span class="nc" id="L3748">            }</span>
        }
<span class="nc" id="L3750">    }</span>

    /**
     * Checks if a mech has an armed MASC system. Note that the mech will have
     * to exceed its normal run to actually engage the MASC system
     */
    public boolean hasArmedMASC() {
<span class="nc bnc" id="L3757" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L3758" title="All 2 branches missed.">            if (!m.isDestroyed()</span>
<span class="nc bnc" id="L3759" title="All 2 branches missed.">                    &amp;&amp; !m.isBreached()</span>
<span class="nc bnc" id="L3760" title="All 2 branches missed.">                    &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L3761" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(MiscType.F_MASC)</span>
<span class="nc bnc" id="L3762" title="All 4 branches missed.">                    &amp;&amp; (m.curMode().equals(&quot;Armed&quot;) || m.getType().hasSubType(</span>
                            MiscType.S_JETBOOSTER))) {
<span class="nc" id="L3764">                return true;</span>
            }
<span class="nc" id="L3766">        }</span>
<span class="nc" id="L3767">        return false;</span>
    }

    /**
     * Returns this entity's running/flank mp as a string.
     */
    @Override
    public String getRunMPasString() {
<span class="nc bnc" id="L3775" title="All 2 branches missed.">        if (hasArmedMASC()) {</span>
<span class="nc" id="L3776">            return getRunMPwithoutMASC() + &quot;(&quot; + getRunMP() + &quot;)&quot;;</span>
        }
<span class="nc" id="L3778">        return Integer.toString(getRunMP());</span>
    }

    /**
     * Determine the stealth modifier for firing at this unit from the given
     * range. If the value supplied for &lt;code&gt;range&lt;/code&gt; is not one of the
     * &lt;code&gt;Entity&lt;/code&gt; class range constants, an
     * &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @param range
     *            - an &lt;code&gt;int&lt;/code&gt; value that must match one of the
     *            &lt;code&gt;Compute&lt;/code&gt; class range constants.
     * @param ae
     *            - entity making the attack
     * @return a &lt;code&gt;TargetRoll&lt;/code&gt; value that contains the stealth
     *         modifier for the given range.
     */
    @Override
    public TargetRoll getStealthModifier(int range, Entity ae) {
<span class="nc" id="L3799">        TargetRoll result = null;</span>

        // Stealth or null sig must be active.
<span class="nc bnc" id="L3802" title="All 2 branches missed.">        if (!isStealthActive()) {</span>
<span class="nc" id="L3803">            result = new TargetRoll(0, &quot;stealth not active&quot;);</span>
        }
        // Determine the modifier based upon the range.
        else {
<span class="nc bnc" id="L3807" title="All 5 branches missed.">            switch (range) {</span>
                case RangeType.RANGE_MINIMUM:
                case RangeType.RANGE_SHORT:
<span class="nc bnc" id="L3810" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3811">                        result = new TargetRoll(0, &quot;stealth&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L3814">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L3816">                    break;</span>
                case RangeType.RANGE_MEDIUM:
<span class="nc bnc" id="L3818" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3819">                        result = new TargetRoll(1, &quot;stealth&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L3822">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L3824">                    break;</span>
                case RangeType.RANGE_LONG:
                case RangeType.RANGE_EXTREME:
                case RangeType.RANGE_LOS:
<span class="nc bnc" id="L3828" title="All 4 branches missed.">                    if (isStealthActive() &amp;&amp; !ae.isConventionalInfantry()) {</span>
<span class="nc" id="L3829">                        result = new TargetRoll(2, &quot;stealth&quot;);</span>
                    } else {
                        // must be infantry
<span class="nc" id="L3832">                        result = new TargetRoll(0, &quot;infantry ignore stealth&quot;);</span>
                    }
<span class="nc" id="L3834">                    break;</span>
                case RangeType.RANGE_OUT:
<span class="nc" id="L3836">                    break;</span>
                default:
<span class="nc" id="L3838">                    throw new IllegalArgumentException(&quot;Unknown range constant: &quot; + range);</span>
            }
        }

        // Return the result.
<span class="nc" id="L3843">        return result;</span>
    } // End public TargetRoll getStealthModifier( char )
    
    @Override
    public double getBaseBattleForceMovement() {
<span class="nc" id="L3848">        double move = getOriginalWalkMP();</span>

<span class="nc" id="L3850">        if (getMisc().stream().filter(m -&gt; m.getType().hasFlag(MiscType.F_MASC))</span>
<span class="nc" id="L3851">        		.map(m -&gt; m.getType().getSubType())</span>
<span class="nc bnc" id="L3852" title="All 4 branches missed.">        		.anyMatch(st -&gt; st == MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L3853">            move *= 1.25;</span>
        }

<span class="nc" id="L3856">        return move;</span>
    }
    
    @Override
    /**
     * returns the battle force structure points for a vehicle.
     * Composite and Reinforced structures are Mech only, so we don't need to worry
     */
    public int getBattleForceStructurePoints() {
<span class="nc" id="L3865">        int struct = 0;</span>
<span class="nc bnc" id="L3866" title="All 2 branches missed.">        for (int i = 0; i &lt; getLocationNames().length; i++) {</span>
<span class="nc" id="L3867">            struct += this.getInternal(i);</span>
        }
<span class="nc" id="L3869">        return (int) Math.ceil(struct / 10.0);</span>
    }
    
    /**
     * Separate turret weapons from body-mounted
     */
    @Override
    public int getNumBattleForceWeaponsLocations() {
<span class="nc bnc" id="L3877" title="All 2 branches missed.">        if (m_bHasNoTurret) {</span>
<span class="nc" id="L3878">            return 2;</span>
<span class="nc bnc" id="L3879" title="All 2 branches missed.">        } else if  (m_bHasNoDualTurret) {</span>
<span class="nc" id="L3880">            return 3;</span>
        } else {
<span class="nc" id="L3882">            return 4;</span>
        }
    }
    
    @Override
    public String getBattleForceLocationName(int index) {
<span class="nc bnc" id="L3888" title="All 2 branches missed.">        if (index == 1) {</span>
<span class="nc" id="L3889">            return &quot;REAR&quot;;</span>
        }
<span class="nc bnc" id="L3891" title="All 2 branches missed.">        if (index &gt; 1) {</span>
<span class="nc bnc" id="L3892" title="All 2 branches missed.">            if (m_bHasNoDualTurret) {</span>
<span class="nc" id="L3893">                return &quot;TUR&quot;;</span>
            } else {
<span class="nc" id="L3895">                return &quot;TUR&quot; + index;</span>
            }
        } else {
<span class="nc" id="L3898">            return &quot;&quot;;</span>
        }
    }

    /**
     * index 0 (Front, Left, Right)
     * index 1+ (Turret(s))
     */
    @Override
    public double getBattleForceLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc bnc" id="L3908" title="All 5 branches missed.">        switch (index) {</span>
        case 0:
<span class="nc bnc" id="L3910" title="All 4 branches missed.">            if (location &gt; LOC_BODY &amp;&amp; location &lt; LOC_TURRET) {</span>
<span class="nc" id="L3911">                return 1.0;</span>
            }
            break;
        case 1:
<span class="nc bnc" id="L3915" title="All 2 branches missed.">            if (location == LOC_REAR) {</span>
<span class="nc" id="L3916">                return 1.0;</span>
            }
            break;
        case 2:
<span class="nc bnc" id="L3920" title="All 2 branches missed.">            if (location == LOC_TURRET) {</span>
<span class="nc" id="L3921">                return 1.0;</span>
            }
            break;
        case 3:
<span class="nc bnc" id="L3925" title="All 2 branches missed.">            if (location == LOC_TURRET_2) {</span>
<span class="nc" id="L3926">                return 1.0;</span>
            }
            break;
        }
<span class="nc" id="L3930">        return 0; </span>
    }

    /**
     * AlphaStrike combines turrets with the overall (front) damage values.
     */
    @Override
    public double getAlphaStrikeLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc bnc" id="L3938" title="All 2 branches missed.">    	if (index == 0) {</span>
<span class="nc bnc" id="L3939" title="All 2 branches missed.">    		return location &gt; LOC_BODY? 1.0 : 0.0;</span>
    	}
<span class="nc" id="L3941">    	return getBattleForceLocationMultiplier(index, location, rearMounted);</span>
    }
    
    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA,Integer&gt; specialAbilities) {
<span class="nc" id="L3945">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc bnc" id="L3946" title="All 2 branches missed.">        if (!isSupportVehicle()) {</span>
<span class="nc" id="L3947">            specialAbilities.put(BattleForceSPA.SRCH, null);</span>
        }
<span class="nc bnc" id="L3949" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L3950" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ADVANCED_FIRECONTROL)) {</span>
<span class="nc" id="L3951">                specialAbilities.put(BattleForceSPA.AFC, null);</span>
<span class="nc bnc" id="L3952" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_BASIC_FIRECONTROL)) {</span>
<span class="nc" id="L3953">                specialAbilities.put(BattleForceSPA.BFC, null);</span>
<span class="nc bnc" id="L3954" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_AMPHIBIOUS)) {</span>
<span class="nc" id="L3955">                specialAbilities.put(BattleForceSPA.AMP, null);</span>
<span class="nc bnc" id="L3956" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L3957">                specialAbilities.put(BattleForceSPA.ARS, null);</span>
<span class="nc bnc" id="L3958" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L3959">                specialAbilities.put(BattleForceSPA.SEAL, null);</span>
<span class="nc bnc" id="L3960" title="All 4 branches missed.">                if (hasEngine() &amp;&amp; getEngine().getEngineType() != Engine.COMBUSTION_ENGINE</span>
<span class="nc bnc" id="L3961" title="All 2 branches missed.">                        &amp;&amp; getEngine().getEngineType() != Engine.STEAM) {</span>
<span class="nc" id="L3962">                    specialAbilities.put(BattleForceSPA.SOA, null);</span>
                }
<span class="nc bnc" id="L3964" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_VEHICLE_MINE_DISPENSER)) { </span>
<span class="nc" id="L3965">                specialAbilities.merge(BattleForceSPA.MDS, 1, Integer::sum);</span>
<span class="nc bnc" id="L3966" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MINESWEEPER)) {</span>
<span class="nc" id="L3967">                specialAbilities.put(BattleForceSPA.MSW, null);</span>
<span class="nc bnc" id="L3968" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MASH)) {</span>
<span class="nc" id="L3969">                specialAbilities.merge(BattleForceSPA.MASH, (int) m.getSize(), Integer::sum);</span>
<span class="nc bnc" id="L3970" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MOBILE_FIELD_BASE)) {</span>
<span class="nc" id="L3971">                specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L3972" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_COMMAND_CONSOLE)) {</span>
<span class="nc" id="L3973">                specialAbilities.merge(BattleForceSPA.MHQ, 1, Integer::sum);</span>
<span class="nc bnc" id="L3974" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_OFF_ROAD)) {</span>
<span class="nc" id="L3975">                specialAbilities.put(BattleForceSPA.ORO, null);</span>
<span class="nc bnc" id="L3976" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_DUNE_BUGGY)) {</span>
<span class="nc" id="L3977">                specialAbilities.put(BattleForceSPA.DUN, null);</span>
<span class="nc bnc" id="L3978" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_TRACTOR_MODIFICATION)</span>
<span class="nc bnc" id="L3979" title="All 2 branches missed.">                    || m.getType().hasFlag(MiscType.F_TRAILER_MODIFICATION)) {</span>
<span class="nc" id="L3980">                specialAbilities.put(BattleForceSPA.HTC, null);</span>
            }
            //TODO: Fire-resistant chassis mod
<span class="nc" id="L3983">        }</span>
<span class="nc" id="L3984">    }</span>
    
    @Override
    public boolean isBattleForceTurretLocation(int index) {
<span class="nc bnc" id="L3988" title="All 2 branches missed.">        return index &gt; 1;</span>
    }

    @Override
    public boolean isBattleForceRearLocation(int index) {
<span class="nc bnc" id="L3993" title="All 2 branches missed.">        return index == 1;</span>
    }

    @Override
    public int getEngineHits() {
<span class="nc bnc" id="L3998" title="All 2 branches missed.">        if (isEngineHit()) {</span>
<span class="nc" id="L3999">            return 1;</span>
        } else {
<span class="nc" id="L4001">            return 0;</span>
        }
    }

    @Override
    public String getLocationDamage(int loc) {
<span class="nc" id="L4007">        String toReturn = &quot;&quot;;</span>
<span class="nc" id="L4008">        boolean first = true;</span>
<span class="nc bnc" id="L4009" title="All 2 branches missed.">        if (getLocationStatus(loc) == ILocationExposureStatus.BREACHED) {</span>
<span class="nc" id="L4010">            toReturn += &quot;BREACH&quot;;</span>
<span class="nc" id="L4011">            first = false;</span>
        }
<span class="nc bnc" id="L4013" title="All 2 branches missed.">        if (isTurretLocked(loc)) {</span>
<span class="nc bnc" id="L4014" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L4015">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L4017">            toReturn += &quot;Locked&quot;;</span>
<span class="nc" id="L4018">            first = false;</span>
        }
<span class="nc bnc" id="L4020" title="All 2 branches missed.">        if (isStabiliserHit(loc)) {</span>
<span class="nc bnc" id="L4021" title="All 2 branches missed.">            if (!first) {</span>
<span class="nc" id="L4022">                toReturn += &quot;, &quot;;</span>
            }
<span class="nc" id="L4024">            toReturn += &quot;Stabilizer hit&quot;;</span>
<span class="nc" id="L4025">            first = false;</span>
        }
<span class="nc" id="L4027">        return toReturn;</span>
    }

    @Override
    public boolean isCrippled() {
<span class="nc" id="L4032">        return isCrippled(true);</span>
    }

    @Override
    public boolean isCrippled(boolean checkCrew) {
<span class="nc bnc" id="L4037" title="All 4 branches missed.">        if ((getArmor(LOC_FRONT) &lt; 1) &amp;&amp; (getOArmor(LOC_FRONT) &gt; 0)) {</span>
<span class="nc" id="L4038">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Front armor destroyed.&quot;);</span>
<span class="nc" id="L4039">            return true;</span>
<span class="nc bnc" id="L4040" title="All 4 branches missed.">        } else if ((getArmor(LOC_RIGHT) &lt; 1) &amp;&amp; (getOArmor(LOC_RIGHT) &gt; 0)) {</span>
<span class="nc" id="L4041">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Right armor destroyed.&quot;);</span>
<span class="nc" id="L4042">            return true;</span>
<span class="nc bnc" id="L4043" title="All 4 branches missed.">        } else if ((getArmor(LOC_LEFT) &lt; 1) &amp;&amp; (getOArmor(LOC_LEFT) &gt; 0)) {</span>
<span class="nc" id="L4044">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Left armor destroyed.&quot;);</span>
<span class="nc" id="L4045">            return true;</span>
<span class="nc bnc" id="L4046" title="All 6 branches missed.">        } else if (!hasNoTurret() &amp;&amp; ((getArmor(getLocTurret()) &lt; 1) &amp;&amp; (getOArmor(getLocTurret()) &gt; 0))) {</span>
<span class="nc" id="L4047">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Turret destroyed.&quot;);</span>
<span class="nc" id="L4048">            return true;</span>
<span class="nc bnc" id="L4049" title="All 6 branches missed.">        } else if (!hasNoDualTurret() &amp;&amp; ((getArmor(getLocTurret2()) &lt; 1) &amp;&amp; (getOArmor(getLocTurret2()) &gt; 0))) {</span>
<span class="nc" id="L4050">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Front Turret destroyed.&quot;);</span>
<span class="nc" id="L4051">            return true;</span>
<span class="nc bnc" id="L4052" title="All 4 branches missed.">        } else if ((getArmor(LOC_REAR) &lt; 1) &amp;&amp; (getOArmor(LOC_REAR) &gt; 0)) {</span>
<span class="nc" id="L4053">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Rear armor destroyed.&quot;);</span>
<span class="nc" id="L4054">            return true;</span>
<span class="nc bnc" id="L4055" title="All 2 branches missed.">        } else if (isPermanentlyImmobilized(checkCrew)) {</span>
<span class="nc" id="L4056">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Immobilized.&quot;);</span>
<span class="nc" id="L4057">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4062" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4063">            return false;</span>
        }

        // no weapons can fire anymore, can cause no more than 5 points of
        // combined weapons damage,
        // or has no weapons with range greater than 5 hexes
<span class="nc bnc" id="L4069" title="All 2 branches missed.">        if (!hasViableWeapons()) {</span>
<span class="nc" id="L4070">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: has no more viable weapons.&quot;);</span>
<span class="nc" id="L4071">            return true;</span>
        }
<span class="nc" id="L4073">        return false;</span>
    }

    @Override
    public boolean isDmgHeavy() {
        // when checking if MP has been reduced, we want to ignore non-damage effects such as weather/gravity
<span class="nc bnc" id="L4079" title="All 2 branches missed.">        if (((double) getMotiveDamage() / getOriginalWalkMP()) &gt;= 0.5) {</span>
<span class="nc" id="L4080">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot; Lightly Damaged: Walk MP less than or equal to half the original Walk MP&quot;);
<span class="nc" id="L4082">            return true;</span>
<span class="nc bnc" id="L4083" title="All 4 branches missed.">        } else if ((getArmorRemainingPercent() &lt;= 0.33) &amp;&amp; (getArmorRemainingPercent() != IArmorState.ARMOR_NA)) {</span>
<span class="nc" id="L4084">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4085">                    + &quot; Heavily Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.33.&quot;);
<span class="nc" id="L4087">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4092" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4093">            return false;</span>
        }

<span class="nc" id="L4096">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4097">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4098" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4099" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4100">                totalInoperable++;</span>
            }
<span class="nc" id="L4102">        }</span>
<span class="nc bnc" id="L4103" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.75;</span>
    }

    @Override
    public boolean isDmgModerate() {
<span class="nc bnc" id="L4108" title="All 4 branches missed.">        if ((getArmorRemainingPercent() &lt;= 0.67) &amp;&amp; (getArmorRemainingPercent() != IArmorState.ARMOR_NA)) {</span>
<span class="nc" id="L4109">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4110">                    + &quot; Moderately Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.67.&quot;);
<span class="nc" id="L4112">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4117" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4118">            return false;</span>
        }

<span class="nc" id="L4121">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4122">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4123" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4124" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4125">                totalInoperable++;</span>
            }
<span class="nc" id="L4127">        }</span>

<span class="nc bnc" id="L4129" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.5;</span>
    }

    @Override
    public boolean isDmgLight() {
        // when checking if MP has been reduced, we want to ignore non-damage effects such as weather/gravity
<span class="nc bnc" id="L4135" title="All 2 branches missed.">        if (getMotiveDamage() &gt; 0) {</span>
<span class="nc" id="L4136">            MegaMek.getLogger().debug(getDisplayName()</span>
                    + &quot; Lightly Damaged: Walk MP less than the original Walk MP&quot;);
<span class="nc" id="L4138">            return true;</span>
<span class="nc bnc" id="L4139" title="All 4 branches missed.">        } else if ((getArmorRemainingPercent() &lt;= 0.8) &amp;&amp; (getArmorRemainingPercent() != IArmorState.ARMOR_NA)) {</span>
<span class="nc" id="L4140">            MegaMek.getLogger().debug(getDisplayName()</span>
<span class="nc" id="L4141">                    + &quot; Lightly Damaged: Armour Remaining percent of &quot; + getArmorRemainingPercent()</span>
                    + &quot; is less than or equal to 0.8.&quot;);
<span class="nc" id="L4143">            return true;</span>
        }

        // If this is not a military vehicle, we don't need to do a weapon
        // check.
<span class="nc bnc" id="L4148" title="All 2 branches missed.">        if (!isMilitary()) {</span>
<span class="nc" id="L4149">            return false;</span>
        }

<span class="nc" id="L4152">        int totalWeapons = getTotalWeaponList().size();</span>
<span class="nc" id="L4153">        int totalInoperable = 0;</span>
<span class="nc bnc" id="L4154" title="All 2 branches missed.">        for (Mounted weap : getTotalWeaponList()) {</span>
<span class="nc bnc" id="L4155" title="All 2 branches missed.">            if (weap.isCrippled()) {</span>
<span class="nc" id="L4156">                totalInoperable++;</span>
            }
<span class="nc" id="L4158">        }</span>

<span class="nc bnc" id="L4160" title="All 2 branches missed.">        return ((double) totalInoperable / totalWeapons) &gt;= 0.25;</span>
    }

    /**
     * Returns the mass of the fuel, which is used for calculating operating range.
     * For combat vehicles this is considered part of the engine weight. For support vehicles it is in
     * addition to the engine weight.
     *
     * @return fuel tonnage
     */
    public double getFuelTonnage() {
<span class="nc bnc" id="L4171" title="All 2 branches missed.">        if (hasEngine()) {</span>
            // For combat vehicles the fuel tonnage is 10% of the engine.
<span class="nc" id="L4173">            return getEngine().getWeightEngine(this) * 0.1;</span>
        }
<span class="nc" id="L4175">        return 0.0;</span>
    }

    /**
     * Sets the fuel mass for support vehicles. Has no effect on combat vehicles.
     *
     * @param fuel The mass of the fuel in tons
     */
    public void setFuelTonnage(double fuel) {
        // do nothing
<span class="nc" id="L4185">    }</span>

    /**
     * Calculates the operating range of the vehicle based on engine type and fuel mass.
     * Vehicles that do not require fuel report an operating range of {@code Integer.MAX_VALUE}.
     *
     * @return The vehicle's operating range in km
     */
    public int operatingRange() {
<span class="nc bnc" id="L4194" title="All 2 branches missed.">        if (getFuelTonnage() &lt;= 0) {</span>
<span class="nc" id="L4195">            return 0;</span>
        }
<span class="nc" id="L4197">        double fuelUnit = fuelTonnagePer100km();</span>
<span class="nc bnc" id="L4198" title="All 2 branches missed.">        if (fuelUnit &gt; 0) {</span>
<span class="nc" id="L4199">            int range = (int) (getFuelTonnage() / fuelUnit * 100);</span>
<span class="nc" id="L4200">            int fuelTanks = countWorkingMisc(MiscType.F_FUEL);</span>
<span class="nc bnc" id="L4201" title="All 2 branches missed.">            if (getEngine().getEngineType() == Engine.COMBUSTION_ENGINE) {</span>
<span class="nc" id="L4202">                range += fuelTanks * 600;</span>
<span class="nc bnc" id="L4203" title="All 2 branches missed.">            } else if (getEngine().getEngineType() == Engine.FUEL_CELL) {</span>
<span class="nc" id="L4204">                range += fuelTanks * 450;</span>
            }
<span class="nc" id="L4206">            return range;</span>
        }
<span class="nc" id="L4208">        return Integer.MAX_VALUE;</span>
    }

    /**
     * Calculates fuel mass based on engine type and mass. Engines that do not require allocating
     * fuel mass return a value of 0.0.
     *
     * @return The fuel mass required for every 100 km of vehicle range.
     */
    public double fuelTonnagePer100km() {
<span class="nc bnc" id="L4218" title="All 2 branches missed.">        if (!hasEngine()) {</span>
<span class="nc" id="L4219">            return 0.0;</span>
        }
<span class="nc bnc" id="L4221" title="All 5 branches missed.">        switch (getEngine().getEngineType()) {</span>
            case Engine.STEAM:
<span class="nc" id="L4223">                return getEngine().getWeightEngine(this) * 0.03;</span>
            case Engine.COMBUSTION_ENGINE:
<span class="nc bnc" id="L4225" title="All 2 branches missed.">                if (getICEFuelType() == FuelType.PETROCHEMICALS) {</span>
<span class="nc" id="L4226">                    return getEngine().getWeightEngine(this) * 0.01;</span>
                } else {
<span class="nc" id="L4228">                    return getEngine().getWeightEngine(this) * 0.0125;</span>
                }
            case Engine.BATTERY:
<span class="nc" id="L4231">                return getEngine().getWeightEngine(this) * 0.05;</span>
            case Engine.FUEL_CELL:
<span class="nc" id="L4233">                return getEngine().getWeightEngine(this) * 0.015;</span>
            default:
<span class="nc" id="L4235">                return 0.0;</span>
        }
    }

    /**
     * The type of fuel for internal combustion engines. This has no meaning for
     * other engine types.
     *
     * @return The ICE fuel type
     */
    public FuelType getICEFuelType() {
<span class="nc" id="L4246">        return fuelType;</span>
    }

    public void setICEFuelType(FuelType fuelType) {
<span class="nc" id="L4250">        this.fuelType = fuelType;</span>
<span class="nc" id="L4251">    }</span>

    /**
     * Tanks go Hull Down slightly differently, this method accounts for this
     *
     * @see megamek.common.Entity#setHullDown(boolean)
     */
    @Override
    public void setHullDown(boolean down) {
<span class="nc" id="L4260">        super.setHullDown(down);</span>
<span class="nc bnc" id="L4261" title="All 4 branches missed.">        if ((getMovedBackwards() == true) &amp;&amp; (down == true)) {</span>
<span class="nc" id="L4262">            m_bBackedIntoHullDown = true;</span>
<span class="nc bnc" id="L4263" title="All 4 branches missed.">        } else if ((getMovedBackwards() == false) &amp;&amp; (down == true)) {</span>
<span class="nc" id="L4264">            m_bBackedIntoHullDown = false;</span>
<span class="nc bnc" id="L4265" title="All 2 branches missed.">        } else if (down == false) {</span>
<span class="nc" id="L4266">            m_bBackedIntoHullDown = false;</span>
        }
<span class="nc" id="L4268">    }</span>

    /**
     * Returns True if this tank moved backwards before going Hull Down
     *
     * @return
     */
    public boolean isBackedIntoHullDown() {
<span class="nc" id="L4276">        return m_bBackedIntoHullDown;</span>
    }

    @Override
    public long getEntityType() {
<span class="nc" id="L4281">        return Entity.ETYPE_TANK;</span>
    }

    @Override
    public boolean isEjectionPossible() {
<span class="nc bnc" id="L4286" title="All 2 branches missed.">        return game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT)</span>
<span class="nc bnc" id="L4287" title="All 2 branches missed.">                &amp;&amp; getCrew().isActive()</span>
<span class="nc bnc" id="L4288" title="All 2 branches missed.">                &amp;&amp; !hasQuirk(OptionsConstants.QUIRK_NEG_NO_EJECT);</span>
    }

    /**
     * Used for omni vehicles, which must set the weight of turrets
     * the base chassis, limiting the amount of pod space in the turret.
     *
     * @return The weight of the primary turret
     */
    public double getBaseChassisTurretWeight() {
<span class="nc" id="L4298">        return baseChassisTurretWeight;</span>
    }

    /**
     * Sets the fixed weight of the primary turret on a dual-turret omnivehicle.
     *
     * @param baseChassisTurretWeight The weight of the turret
     */
    public void setBaseChassisTurretWeight(double baseChassisTurretWeight) {
<span class="nc" id="L4307">        this.baseChassisTurretWeight = baseChassisTurretWeight;</span>
<span class="nc" id="L4308">    }</span>

    /**
     * Used for omni vehicles, which must set the weight of turrets
     * the base chassis, limiting the amount of pod space in the turret.
     *
     * @return The weight of the second turret
     */
    public double getBaseChassisTurret2Weight() {
<span class="nc" id="L4317">        return baseChassisTurret2Weight;</span>
    }

    /**
     * Sets the fixed weight of the second turret on a dual-turret omnivehicle.
     *
     * @param baseChassisTurret2Weight The weight of the turret
     */
    public void setBaseChassisTurret2Weight(double baseChassisTurret2Weight) {
<span class="nc" id="L4326">        this.baseChassisTurret2Weight = baseChassisTurret2Weight;</span>
<span class="nc" id="L4327">    }</span>

    /**
     * Used for omni vehicles, which must set the weight of sponson or pintle mounts in
     * the base chassis, limiting the amount of pod space in the turret(s).
     *
     * @return The weight of any pintle mounts (small support vee) or sponson mounts
     *         (combat vee and M/L support vee)
     */
    public double getBaseChassisSponsonPintleWeight() {
<span class="nc" id="L4337">        return baseChassisSponsonPintleWeight;</span>
    }

    /**
     * Sets the fixed weight of any pintle (small SV) or sponson (CV, M/L SV) turrets
     * on an omnivehicle.
     *
     * @param baseChassisSponsonPintleWeight The weight of the sponson/pintle turrets.
     */
    public void setBaseChassisSponsonPintleWeight(double baseChassisSponsonPintleWeight) {
<span class="nc" id="L4347">        this.baseChassisSponsonPintleWeight = baseChassisSponsonPintleWeight;</span>
<span class="nc" id="L4348">    }</span>

    public boolean hasNoControlSystems() {
<span class="nc" id="L4351">        return hasNoControlSystems;</span>
    }

    public void setHasNoControlSystems(boolean hasNoControlSystems) {
<span class="nc" id="L4355">        this.hasNoControlSystems = hasNoControlSystems;</span>
<span class="nc" id="L4356">    }</span>

    /**
     * Used to determine the draw priority of different Entity subclasses.
     * This allows different unit types to always be draw above/below other
     * types.
     *
     * @return
     */
    public int getSpriteDrawPriority() {
<span class="nc" id="L4366">        return 4;</span>
    }
    
    //Specific road/rail train rules
    
    /**
     * Used to determine if this vehicle can be towed by a tractor
     * 
     * @return Whether the unit is constructed as a trailer
     */
    @Override
    public boolean isTrailer() {
<span class="nc" id="L4378">        return trailer;</span>
    }

    /**
     * Marks whether the tank is constructed as a trailer. This has no effect on
     * support vehicles, which determine trailer status by the trailer chassis modification.
     *
     * @param trailer Whether the tank is constructed as a trailer.
     */
    public void setTrailer(boolean trailer) {
<span class="nc" id="L4388">        this.trailer = trailer;</span>
<span class="nc" id="L4389">    }</span>
    
    /**
     * Used to determine if this vehicle can be the engine/tractor 
     * for a bunch of trailers
     * 
     * @return
     */
    @Override
    public boolean isTractor() {
<span class="nc bnc" id="L4399" title="All 2 branches missed.">        if (getMovementMode().equals(EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L4400" title="All 2 branches missed.">                || getMovementMode().equals(EntityMovementMode.WHEELED)) {</span>
            // Any tracked or wheeled combat vehicle can be used as a tractor
            // if it is capable of independent operations or it is equipped with
            // a hitch (making it a trailer that is part of a train).
<span class="nc bnc" id="L4404" title="All 4 branches missed.">            return (hasEngine() &amp;&amp; !hasNoControlSystems())</span>
<span class="nc bnc" id="L4405" title="All 2 branches missed.">                    || hasWorkingMisc(MiscType.F_HITCH);</span>
        }
<span class="nc" id="L4407">        return false;</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>